<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>åŸºäºRocketMQåˆ†å¸ƒå¼äº‹åŠ¡ - å®Œæ•´ç¤ºä¾‹ | æå®¢å¿«è¨Š</title><meta property="og:title" content="åŸºäºRocketMQåˆ†å¸ƒå¼äº‹åŠ¡ - å®Œæ•´ç¤ºä¾‹ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="http://p1.pstatp.com/large/pgc-image/388a9665bf45413eb391e47c6d10ca12"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e6%b8%b8%e6%88%8f/3ff1309.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e6%b8%b8%e6%88%8f/3ff1309.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e6%b8%b8%e6%88%8f/3ff1309.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e6%b8%b8%e6%88%8f/3ff1309.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e6%b8%b8%e6%88%8f/3ff1309.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e6%b8%b8%e6%88%8f/3ff1309.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e6%b8%b8%e6%88%8f/3ff1309.html><link rel=canonical href=https://geekbank.cf/tw/%e6%b8%b8%e6%88%8f/3ff1309.html><meta property="article:published_time" content="2020-10-29T20:46:29+08:00"><meta property="article:modified_time" content="2020-10-29T20:46:29+08:00"><meta name=Keywords content><meta name=description content="åŸºäºRocketMQåˆ†å¸ƒå¼äº‹åŠ¡ - å®Œæ•´ç¤ºä¾‹"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E6%B8%B8%E6%88%8F/3ff1309.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>åŸºäºRocketMQåˆ†å¸ƒå¼äº‹åŠ¡ - å®Œæ•´ç¤ºä¾‹</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E6%B8%B8%E6%88%8F.html>æ¸¸æˆ</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>å‰è¨€</h1><p>ä¹‹å‰æˆ‘ä»¬è¯´åˆ°ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä¸€ä¸ªå¤æ‚çš„æŠ€æœ¯é—®é¢˜ã€‚æ²¡æœ‰é€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿç¼ºä¹ç®€å•é«˜æ•ˆçš„æ‰‹æ®µã€‚</p><p>ä¸è¿‡ï¼Œå¦‚æœæˆ‘ä»¬çš„ç³»ç»Ÿä¸è¿½æ±‚å¼ºä¸€è‡´æ€§ï¼Œé‚£ä¹ˆæœ€å¸¸ç”¨çš„è¿˜æ˜¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±åŸºäº RocketMQæ¥å®ç°æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆçš„åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p><p>æœ¬æ–‡ä»£ç ä¸åªæ˜¯ç®€å•çš„demoï¼Œè€ƒè™‘åˆ°ä¸€äº›å¼‚å¸¸æƒ…å†µã€å¹‚ç­‰æ€§æ¶ˆè´¹å’Œæ­»ä¿¡é˜Ÿåˆ—ç­‰æƒ…å†µï¼Œå°½é‡å‘å¯é ä¸šåŠ¡åœºæ™¯é æ‹¢ã€‚</p><p>å¦å¤–ï¼Œåœ¨æœ€åè¿˜æœ‰ã€ŠRocketMQæŠ€æœ¯å†…å¹•ã€‹ä¸€ä¹¦ä¸­ï¼Œå…³äºåˆ†å¸ƒå¼äº‹åŠ¡ç¤ºä¾‹ä»£ç çš„é”™è¯¯æµç¨‹åˆ†æï¼Œæ‰€ä»¥ç¯‡å¹…è¾ƒé•¿ï¼Œå¸Œæœ›å¤§å®¶è€å¿ƒè§‚çœ‹ã€‚</p><h1 class=pgc-h-arrow-right>ä¸€ã€äº‹åŠ¡æ¶ˆæ¯</h1><p>åœ¨è¿™é‡Œï¼Œç¬”è€…ä¸æƒ³ä½¿ç”¨å¤§é‡çš„æ–‡å­—èµ˜è¿° RocketMQäº‹åŠ¡æ¶ˆæ¯çš„åŸç†ï¼Œæˆ‘ä»¬åªéœ€è¦ææ˜ç™½ä¸¤ä¸ªæ¦‚å¿µã€‚</p><ul><li>Half Messageï¼ŒåŠæ¶ˆæ¯</li></ul><p>æš‚æ—¶ä¸èƒ½è¢« Consumeræ¶ˆè´¹çš„æ¶ˆæ¯ã€‚Producerå·²ç»æŠŠæ¶ˆæ¯å‘é€åˆ° Brokerç«¯ï¼Œä½†æ˜¯æ­¤æ¶ˆæ¯çš„çŠ¶æ€è¢«æ ‡è®°ä¸ºä¸èƒ½æŠ•é€’ï¼Œå¤„äºè¿™ç§çŠ¶æ€ä¸‹çš„æ¶ˆæ¯ç§°ä¸ºåŠæ¶ˆæ¯ã€‚äº‹å®ä¸Šï¼Œè¯¥çŠ¶æ€ä¸‹çš„æ¶ˆæ¯ä¼šè¢«æ”¾åœ¨ä¸€ä¸ªå«åš RMQ_SYS_TRANS_HALF_TOPICçš„ä¸»é¢˜ä¸‹ã€‚</p><p>å½“ Producerç«¯å¯¹å®ƒäºŒæ¬¡ç¡®è®¤åï¼Œä¹Ÿå°±æ˜¯ Commitä¹‹åï¼ŒConsumerç«¯æ‰å¯ä»¥æ¶ˆè´¹åˆ°ï¼›é‚£ä¹ˆå¦‚æœæ˜¯Rollbackï¼Œè¯¥æ¶ˆæ¯åˆ™ä¼šè¢«åˆ é™¤ï¼Œæ°¸è¿œä¸ä¼šè¢«æ¶ˆè´¹åˆ°ã€‚</p><ul><li>äº‹åŠ¡çŠ¶æ€å›æŸ¥</li></ul><p>æˆ‘ä»¬æƒ³ï¼Œå¯èƒ½ä¼šå› ä¸ºç½‘ç»œåŸå› ã€åº”ç”¨é—®é¢˜ç­‰ï¼Œå¯¼è‡´Producerç«¯ä¸€ç›´æ²¡æœ‰å¯¹è¿™ä¸ªåŠæ¶ˆæ¯è¿›è¡Œç¡®è®¤ï¼Œé‚£ä¹ˆè¿™æ—¶å€™ BrokeræœåŠ¡å™¨ä¼šå®šæ—¶æ‰«æè¿™äº›åŠæ¶ˆæ¯ï¼Œä¸»åŠ¨æ‰¾Producerç«¯æŸ¥è¯¢è¯¥æ¶ˆæ¯çš„çŠ¶æ€ã€‚</p><p>å½“ç„¶ï¼Œä»€ä¹ˆæ—¶å€™å»æ‰«æï¼ŒåŒ…å«æ‰«æå‡ æ¬¡ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é…ç½®ï¼Œåœ¨åæ–‡æˆ‘ä»¬å†ç»†è¯´ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼ŒRocketMQäº‹åŠ¡æ¶ˆæ¯çš„å®ç°åŸç†å°±æ˜¯åŸºäºä¸¤é˜¶æ®µæäº¤å’Œäº‹åŠ¡çŠ¶æ€å›æŸ¥ï¼Œæ¥å†³å®šæ¶ˆæ¯æœ€ç»ˆæ˜¯æäº¤è¿˜æ˜¯å›æ»šçš„ã€‚</p><p>åœ¨æœ¬æ–‡ï¼Œæˆ‘ä»¬çš„ä»£ç å°±ä»¥ è®¢å•æœåŠ¡ã€ç§¯åˆ†æœåŠ¡ ä¸ºä¾‹ã€‚ç»“åˆä¸Šæ–‡æ¥çœ‹ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><p><br></p><div class=pgc-img><img alt="åŸºäºRocketMQåˆ†å¸ƒå¼äº‹åŠ¡ - å®Œæ•´ç¤ºä¾‹" onerror=errorimg.call(this); src=http://p1.pstatp.com/large/pgc-image/388a9665bf45413eb391e47c6d10ca12><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right>äºŒã€è®¢å•æœåŠ¡</h1><p>åœ¨è®¢å•æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬æ¥æ”¶å‰ç«¯çš„è¯·æ±‚åˆ›å»ºè®¢å•ï¼Œä¿å­˜ç›¸å…³æ•°æ®åˆ°æœ¬åœ°æ•°æ®åº“ã€‚</p><h1 class=pgc-h-arrow-right>1ã€äº‹åŠ¡æ—¥å¿—è¡¨</h1><p>åœ¨è®¢å•æœåŠ¡ä¸­ï¼Œé™¤äº†æœ‰ä¸€å¼ è®¢å•è¡¨ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ªäº‹åŠ¡æ—¥å¿—è¡¨ã€‚ å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>CREATE TABLE `transaction_log` (  `id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL COMMENT 'äº‹åŠ¡ID',  `business` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL COMMENT 'ä¸šåŠ¡æ ‡è¯†',  `foreign_key` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL COMMENT 'å¯¹åº”ä¸šåŠ¡è¡¨ä¸­çš„ä¸»é”®',  PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;</code></pre><p>è¿™å¼ è¡¨ä¸“é—¨ä½œç”¨äºäº‹åŠ¡çŠ¶æ€å›æŸ¥ã€‚å½“æäº¤ä¸šåŠ¡æ•°æ®æ—¶ï¼Œæ­¤è¡¨ä¹Ÿæ’å…¥ä¸€æ¡æ•°æ®ï¼Œå®ƒä»¬å…±å¤„ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­ã€‚é€šè¿‡äº‹åŠ¡IDæŸ¥è¯¢è¯¥è¡¨ï¼Œå¦‚æœè¿”å›è®°å½•ï¼Œåˆ™è¯æ˜æœ¬åœ°äº‹åŠ¡å·²æäº¤ï¼›å¦‚æœæœªè¿”å›è®°å½•ï¼Œåˆ™æœ¬åœ°äº‹åŠ¡å¯èƒ½æ˜¯æœªçŸ¥çŠ¶æ€æˆ–è€…æ˜¯å›æ»šçŠ¶æ€ã€‚</p><h1 class=pgc-h-arrow-right>2ã€TransactionMQProducer</h1><p>æˆ‘ä»¬çŸ¥é“ï¼Œé€šè¿‡ RocketMQå‘é€æ¶ˆæ¯ï¼Œéœ€å…ˆåˆ›å»ºä¸€ä¸ªæ¶ˆæ¯å‘é€è€…ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çš„åˆ›å»ºçš„å®ä¾‹å¿…é¡»æ˜¯ TransactionMQProducerã€‚</p><pre><code>@Componentpublic class TransactionProducer {	    private String producerGroup = "order_trans_group";    private TransactionMQProducer producer;    //ç”¨äºæ‰§è¡Œæœ¬åœ°äº‹åŠ¡å’Œäº‹åŠ¡çŠ¶æ€å›æŸ¥çš„ç›‘å¬å™¨    @Autowired    OrderTransactionListener orderTransactionListener;    //æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ±     ThreadPoolExecutor executor = new ThreadPoolExecutor(5, 10, 60,            TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(50));                @PostConstruct    public void init(){        producer = new TransactionMQProducer(producerGroup);        producer.setNamesrvAddr("127.0.0.1:9876");        producer.setSendMsgTimeout(Integer.MAX_VALUE);        producer.setExecutorService(executor);        producer.setTransactionListener(orderTransactionListener);        this.start();    }    private void start(){        try {            this.producer.start();        } catch (MQClientException e) {            e.printStackTrace();        }    }    //äº‹åŠ¡æ¶ˆæ¯å‘é€     public TransactionSendResult send(String data, String topic) throws MQClientException {        Message message = new Message(topic,data.getBytes());        return this.producer.sendMessageInTransaction(message, null);    }}</code></pre><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä¸»è¦å°±æ˜¯åˆ›å»ºäº‹åŠ¡æ¶ˆæ¯çš„å‘é€è€…ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ OrderTransactionListenerï¼Œå®ƒè´Ÿè´£æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å’Œäº‹åŠ¡çŠ¶æ€å›æŸ¥ã€‚</p><h1 class=pgc-h-arrow-right>3ã€OrderTransactionListener</h1><pre><code>@Componentpublic class OrderTransactionListener implements TransactionListener {    @Autowired    OrderService orderService;    @Autowired    TransactionLogService transactionLogService;    Logger logger = LoggerFactory.getLogger(this.getClass());    @Override    public LocalTransactionState executeLocalTransaction(Message message, Object o) {        logger.info("å¼€å§‹æ‰§è¡Œæœ¬åœ°äº‹åŠ¡....");        LocalTransactionState state;        try{            String body = new String(message.getBody());            OrderDTO order = JSONObject.parseObject(body, OrderDTO.class);            orderService.createOrder(order,message.getTransactionId());            state = LocalTransactionState.COMMIT_MESSAGE;            logger.info("æœ¬åœ°äº‹åŠ¡å·²æäº¤ã€‚{}",message.getTransactionId());        }catch (Exception e){            logger.info("æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¤±è´¥ã€‚{}",e);            state = LocalTransactionState.ROLLBACK_MESSAGE;        }        return state;    }    @Override    public LocalTransactionState checkLocalTransaction(MessageExt messageExt) {        logger.info("å¼€å§‹å›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ã€‚{}",messageExt.getTransactionId());        LocalTransactionState state;        String transactionId = messageExt.getTransactionId();        if (transactionLogService.get(transactionId)&gt;0){            state = LocalTransactionState.COMMIT_MESSAGE;        }else {            state = LocalTransactionState.UNKNOW;        }        logger.info("ç»“æŸæœ¬åœ°äº‹åŠ¡çŠ¶æ€æŸ¥è¯¢ï¼š{}",state);        return state;    }}</code></pre><p>åœ¨é€šè¿‡ producer.sendMessageInTransactionå‘é€äº‹åŠ¡æ¶ˆæ¯åï¼Œå¦‚æœæ¶ˆæ¯å‘é€æˆåŠŸï¼Œå°±ä¼šè°ƒç”¨åˆ°è¿™é‡Œçš„executeLocalTransactionæ–¹æ³•ï¼Œæ¥æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ã€‚åœ¨è¿™é‡Œï¼Œå®ƒä¼šå®Œæˆè®¢å•æ•°æ®å’Œäº‹åŠ¡æ—¥å¿—çš„æ’å…¥ã€‚</p><p>è¯¥æ–¹æ³•è¿”å›å€¼ LocalTransactionState ä»£è¡¨æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œå®ƒæ˜¯ä¸€ä¸ªæšä¸¾ç±»ã€‚</p><pre><code>public enum LocalTransactionState {    //æäº¤äº‹åŠ¡æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å¯ä»¥çœ‹åˆ°æ­¤æ¶ˆæ¯    COMMIT_MESSAGE,    //å›æ»šäº‹åŠ¡æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä¸ä¼šçœ‹åˆ°æ­¤æ¶ˆæ¯    ROLLBACK_MESSAGE,    //äº‹åŠ¡æœªçŸ¥çŠ¶æ€ï¼Œéœ€è¦è°ƒç”¨äº‹åŠ¡çŠ¶æ€å›æŸ¥ï¼Œç¡®å®šæ­¤æ¶ˆæ¯æ˜¯æäº¤è¿˜æ˜¯å›æ»š    UNKNOW;}</code></pre><p>é‚£ä¹ˆï¼Œ checkLocalTransaction æ–¹æ³•å°±æ˜¯ç”¨äºäº‹åŠ¡çŠ¶æ€æŸ¥è¯¢ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡äº‹åŠ¡IDæŸ¥è¯¢transaction_logè¿™å¼ è¡¨ï¼Œå¦‚æœå¯ä»¥æŸ¥è¯¢åˆ°ç»“æœï¼Œå°±æäº¤äº‹åŠ¡æ¶ˆæ¯ï¼›å¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°ï¼Œå°±è¿”å›æœªçŸ¥çŠ¶æ€ã€‚</p><p>æ³¨æ„ï¼Œè¿™é‡Œè¿˜æ¶‰åŠåˆ°å¦å¤–ä¸€ä¸ªé—®é¢˜ã€‚å¦‚æœæ˜¯è¿”å›æœªçŸ¥çŠ¶æ€ï¼ŒRocketMQ BrokeræœåŠ¡å™¨ä¼šä»¥1åˆ†é’Ÿçš„é—´éš”æ—¶é—´ä¸æ–­å›æŸ¥ï¼Œç›´è‡³è¾¾åˆ°äº‹åŠ¡å›æŸ¥æœ€å¤§æ£€æµ‹æ•°ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—è¿˜æœªæŸ¥è¯¢åˆ°äº‹åŠ¡çŠ¶æ€ï¼Œåˆ™å›æ»šæ­¤æ¶ˆæ¯ã€‚</p><p>å½“ç„¶ï¼Œäº‹åŠ¡å›æŸ¥çš„é¢‘ç‡å’Œæœ€å¤§æ¬¡æ•°ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é…ç½®ã€‚åœ¨ Broker ç«¯ï¼Œå¯ä»¥é€šè¿‡è¿™æ ·æ¥é…ç½®å®ƒï¼š</p><pre><code>brokerConfig.setTransactionCheckInterval(10000); //å›æŸ¥é¢‘ç‡10ç§’ä¸€æ¬¡brokerConfig.setTransactionCheckMax(3);  //æœ€å¤§æ£€æµ‹æ¬¡æ•°ä¸º3</code></pre><h1 class=pgc-h-arrow-right>4ã€ä¸šåŠ¡å®ç°ç±»</h1><pre><code>@Servicepublic class OrderServiceImpl implements OrderService {    @Autowired    OrderMapper orderMapper;    @Autowired    TransactionLogMapper transactionLogMapper;    @Autowired    TransactionProducer producer;    Snowflake snowflake = new Snowflake(1,1);    Logger logger = LoggerFactory.getLogger(this.getClass());    //æ‰§è¡Œæœ¬åœ°äº‹åŠ¡æ—¶è°ƒç”¨ï¼Œå°†è®¢å•æ•°æ®å’Œäº‹åŠ¡æ—¥å¿—å†™å…¥æœ¬åœ°æ•°æ®åº“    @Transactional    @Override    public void createOrder(OrderDTO orderDTO,String transactionId){        //1.åˆ›å»ºè®¢å•        Order order = new Order();        BeanUtils.copyProperties(orderDTO,order);        orderMapper.createOrder(order);        //2.å†™å…¥äº‹åŠ¡æ—¥å¿—        TransactionLog log = new TransactionLog();        log.setId(transactionId);        log.setBusiness("order");        log.setForeignKey(String.valueOf(order.getId()));        transactionLogMapper.insert(log);        logger.info("è®¢å•åˆ›å»ºå®Œæˆã€‚{}",orderDTO);    }    //å‰ç«¯è°ƒç”¨ï¼Œåªç”¨äºå‘RocketMQå‘é€äº‹åŠ¡æ¶ˆæ¯    @Override    public void createOrder(OrderDTO order) throws MQClientException {        order.setId(snowflake.nextId());        order.setOrderNo(snowflake.nextIdStr());        producer.send(JSON.toJSONString(order),"order");    }}</code></pre><p>åœ¨è®¢å•ä¸šåŠ¡æœåŠ¡ç±»ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–¹æ³•ã€‚ä¸€ä¸ªç”¨äºå‘RocketMQå‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œä¸€ä¸ªç”¨äºçœŸæ­£çš„ä¸šåŠ¡æ•°æ®è½åº“ã€‚</p><p>è‡³äºä¸ºä»€ä¹ˆè¿™æ ·åšï¼Œå…¶å®æœ‰ä¸€äº›åŸå› çš„ï¼Œæˆ‘ä»¬åé¢å†è¯´ã€‚</p><h1 class=pgc-h-arrow-right>5ã€è°ƒç”¨</h1><pre><code>@RestControllerpublic class OrderController {    @Autowired    OrderService orderService;    Logger logger = LoggerFactory.getLogger(this.getClass());    @PostMapping("/create_order")    public void createOrder(@RequestBody OrderDTO order) throws MQClientException {        logger.info("æ¥æ”¶åˆ°è®¢å•æ•°æ®ï¼š{}",order.getCommodityCode());        orderService.createOrder(order);    }}</code></pre><h1 class=pgc-h-arrow-right>6ã€æ€»ç»“</h1><p>ç›®å‰å·²ç»å®Œæˆäº†è®¢å•æœåŠ¡çš„ä¸šåŠ¡é€»è¾‘ã€‚æˆ‘ä»¬æ€»ç»“æµç¨‹å¦‚ä¸‹ï¼š</p><p><br></p><div class=pgc-img><img alt="åŸºäºRocketMQåˆ†å¸ƒå¼äº‹åŠ¡ - å®Œæ•´ç¤ºä¾‹" onerror=errorimg.call(this); src=http://p9.pstatp.com/large/pgc-image/b3b5d78bc2924cbd8d410df5f6827807><p class=pgc-img-caption></p></div><p><br></p><p>è€ƒè™‘åˆ°å¼‚å¸¸æƒ…å†µï¼Œè¿™é‡Œçš„è¦ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡è°ƒç”¨createOrderï¼Œå‘é€äº‹åŠ¡æ¶ˆæ¯ã€‚å¦‚æœå‘é€å¤±è´¥ï¼Œå¯¼è‡´æŠ¥é”™ï¼Œåˆ™å°†å¼‚å¸¸è¿”å›ï¼Œæ­¤æ—¶ä¸ä¼šæ¶‰åŠåˆ°ä»»ä½•æ•°æ®å®‰å…¨ã€‚</li><li>å¦‚æœäº‹åŠ¡æ¶ˆæ¯å‘é€æˆåŠŸï¼Œä½†åœ¨æ‰§è¡Œæœ¬åœ°äº‹åŠ¡æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆè®¢å•æ•°æ®å’Œäº‹åŠ¡æ—¥å¿—éƒ½ä¸ä¼šè¢«ä¿å­˜ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­ã€‚</li><li>å¦‚æœæ‰§è¡Œå®Œæœ¬åœ°äº‹åŠ¡ï¼Œä½†æœªèƒ½åŠæ—¶çš„è¿”å›æœ¬åœ°äº‹åŠ¡çŠ¶æ€æˆ–è€…è¿”å›äº†æœªçŸ¥çŠ¶æ€ã€‚é‚£ä¹ˆï¼Œä¼šç”±Brokerå®šæ—¶å›æŸ¥äº‹åŠ¡çŠ¶æ€ï¼Œç„¶åæ ¹æ®äº‹åŠ¡æ—¥å¿—è¡¨ï¼Œå°±å¯ä»¥åˆ¤æ–­è®¢å•æ˜¯å¦å·²å®Œæˆï¼Œå¹¶å†™å…¥åˆ°æ•°æ®åº“ã€‚</li></ul><p>åŸºäºè¿™äº›è¦ç´ ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ï¼Œå·²ç»ä¿è¯äº†è®¢å•æœåŠ¡å’Œäº‹åŠ¡æ¶ˆæ¯çš„ä¸€è‡´æ€§ã€‚é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç§¯åˆ†æœåŠ¡å¦‚ä½•æ­£ç¡®çš„æ¶ˆè´¹è®¢å•æ•°æ®å¹¶å®Œæˆç›¸åº”çš„ä¸šåŠ¡æ“ä½œã€‚</p><h1 class=pgc-h-arrow-right>ä¸‰ã€ç§¯åˆ†æœåŠ¡</h1><p>åœ¨ç§¯åˆ†æœåŠ¡ä¸­ï¼Œä¸»è¦å°±æ˜¯æ¶ˆè´¹è®¢å•æ•°æ®ï¼Œç„¶åæ ¹æ®è®¢å•å†…å®¹ï¼Œç»™ç›¸åº”ç”¨æˆ·å¢åŠ ç§¯åˆ†ã€‚</p><h1 class=pgc-h-arrow-right>1ã€ç§¯åˆ†è®°å½•è¡¨</h1><pre><code>CREATE TABLE `t_points` (  `id` bigint(16) NOT NULL COMMENT 'ä¸»é”®',  `user_id` bigint(16) NOT NULL COMMENT 'ç”¨æˆ·id',  `order_no` bigint(16) NOT NULL COMMENT 'è®¢å•ç¼–å·',  `points` int(4) NOT NULL COMMENT 'ç§¯åˆ†',  `remarks` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL COMMENT 'å¤‡æ³¨',  PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨order_noå­—æ®µï¼Œå®ƒæ˜¯å®ç°å¹‚ç­‰æ¶ˆè´¹çš„ä¸€ç§é€‰æ‹©ã€‚</p><h1 class=pgc-h-arrow-right>2ã€æ¶ˆè´¹è€…å¯åŠ¨</h1><pre><code>@Componentpublic class Consumer {    String consumerGroup = "consumer-group";    DefaultMQPushConsumer consumer;    @Autowired    OrderListener orderListener;        @PostConstruct    public void init() throws MQClientException {        consumer = new DefaultMQPushConsumer(consumerGroup);        consumer.setNamesrvAddr("127.0.0.1:9876");        consumer.subscribe("order","*");        consumer.registerMessageListener(orderListener);        consumer.start();    }}</code></pre><p>å¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹è€…æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬æŒ‡å®šè¦æ¶ˆè´¹çš„ topic å’Œç›‘å¬å™¨å°±å¥½äº†ã€‚</p><h1 class=pgc-h-arrow-right>3ã€æ¶ˆè´¹è€…ç›‘å¬å™¨</h1><pre><code>@Componentpublic class OrderListener implements MessageListenerConcurrently {    @Autowired    PointsService pointsService;    Logger logger = LoggerFactory.getLogger(this.getClass());    @Override    public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; list, ConsumeConcurrentlyContext context) {        logger.info("æ¶ˆè´¹è€…çº¿ç¨‹ç›‘å¬åˆ°æ¶ˆæ¯ã€‚");        try{            for (MessageExt message:list) {                logger.info("å¼€å§‹å¤„ç†è®¢å•æ•°æ®ï¼Œå‡†å¤‡å¢åŠ ç§¯åˆ†....");                OrderDTO order  = JSONObject.parseObject(message.getBody(), OrderDTO.class);                pointsService.increasePoints(order);            }            return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;        }catch (Exception e){            logger.error("å¤„ç†æ¶ˆè´¹è€…æ•°æ®å‘ç”Ÿå¼‚å¸¸ã€‚{}",e);            return ConsumeConcurrentlyStatus.RECONSUME_LATER;        }    }}</code></pre><p>ç›‘å¬åˆ°æ¶ˆæ¯ä¹‹åï¼Œè°ƒç”¨ä¸šåŠ¡æœåŠ¡ç±»å¤„ç†å³å¯ã€‚å¤„ç†å®Œæˆåˆ™è¿”å›CONSUME_SUCCESSä»¥æäº¤ï¼Œå¤„ç†å¤±è´¥åˆ™è¿”å›RECONSUME_LATERæ¥é‡è¯•ã€‚</p><h1 class=pgc-h-arrow-right>4ã€å¢åŠ ç§¯åˆ†</h1><p>åœ¨è¿™é‡Œï¼Œä¸»è¦å°±æ˜¯å¯¹ç§¯åˆ†æ•°æ®å…¥åº“ã€‚ä½†æ³¨æ„ï¼Œå…¥åº“ä¹‹å‰éœ€è¦å…ˆåšåˆ¤æ–­ï¼Œæ¥è¾¾åˆ°å¹‚ç­‰æ€§æ¶ˆè´¹ã€‚</p><pre><code>@Servicepublic class PointsServiceImpl implements PointsService {    @Autowired    PointsMapper pointsMapper;    Snowflake snowflake = new Snowflake(1,1);    Logger logger = LoggerFactory.getLogger(this.getClass());    @Override    public void increasePoints(OrderDTO order) {		        //å…¥åº“ä¹‹å‰å…ˆæŸ¥è¯¢ï¼Œå®ç°å¹‚ç­‰        if (pointsMapper.getByOrderNo(order.getOrderNo())&gt;0){            logger.info("ç§¯åˆ†æ·»åŠ å®Œæˆï¼Œè®¢å•å·²å¤„ç†ã€‚{}",order.getOrderNo());        }else{            Points points = new Points();            points.setId(snowflake.nextId());            points.setUserId(order.getUserId());            points.setOrderNo(order.getOrderNo());            Double amount = order.getAmount();            points.setPoints(amount.intValue()*10);            points.setRemarks("å•†å“æ¶ˆè´¹å…±ã€"+order.getAmount()+"ã€‘å…ƒï¼Œè·å¾—ç§¯åˆ†"+points.getPoints());            pointsMapper.insert(points);            logger.info("å·²ä¸ºè®¢å•å·ç {}å¢åŠ ç§¯åˆ†ã€‚",points.getOrderNo());        }    }}</code></pre><h1 class=pgc-h-arrow-right>5ã€å¹‚ç­‰æ€§æ¶ˆè´¹</h1><p>å®ç°å¹‚ç­‰æ€§æ¶ˆè´¹çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œå…·ä½“æ€ä¹ˆåšï¼Œæ ¹æ®è‡ªå·±çš„æƒ…å†µæ¥çœ‹ã€‚</p><p>æ¯”å¦‚ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥å°†è®¢å•å·å’Œç§¯åˆ†è®°å½•ç»‘å®šåœ¨åŒä¸€ä¸ªè¡¨ä¸­ï¼Œåœ¨å¢åŠ ç§¯åˆ†ä¹‹å‰ï¼Œå°±å¯ä»¥å…ˆæŸ¥è¯¢æ­¤è®¢å•æ˜¯å¦å·²å¤„ç†è¿‡ã€‚</p><p>æˆ–è€…ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é¢å¤–åˆ›å»ºä¸€å¼ è¡¨ï¼Œæ¥è®°å½•è®¢å•çš„å¤„ç†æƒ…å†µã€‚</p><p>å†è€…ï¼Œä¹Ÿå¯ä»¥å°†è¿™äº›ä¿¡æ¯ç›´æ¥æ”¾åˆ°redisç¼“å­˜é‡Œï¼Œåœ¨å…¥åº“ä¹‹å‰å…ˆæŸ¥è¯¢ç¼“å­˜ã€‚</p><p>ä¸ç®¡ä»¥å“ªç§æ–¹å¼æ¥åšï¼Œæ€»çš„æ€è·¯å°±æ˜¯åœ¨æ‰§è¡Œä¸šåŠ¡å‰ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢è¯¥æ¶ˆæ¯æ˜¯å¦è¢«å¤„ç†è¿‡ã€‚é‚£ä¹ˆè¿™é‡Œå°±æ¶‰åŠåˆ°ä¸€ä¸ªæ•°æ®ä¸»é”®é—®é¢˜ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä»¥è®¢å•å·ä¸ºä¸»é”®ï¼Œä¹Ÿå¯ä»¥ç”¨äº‹åŠ¡IDä½œä¸»é”®ï¼Œå¦‚æœæ˜¯æ™®é€šæ¶ˆæ¯çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºå”¯ä¸€çš„æ¶ˆæ¯IDä½œä¸ºä¸»é”®ã€‚</p><h1 class=pgc-h-arrow-right>6ã€æ¶ˆè´¹å¼‚å¸¸</h1><p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“æ¶ˆè´¹è€…å¤„ç†å¤±è´¥åä¼šè¿”å› RECONSUME_LATER ï¼Œè®©æ¶ˆæ¯æ¥é‡è¯•ï¼Œé»˜è®¤æœ€å¤šé‡è¯•16æ¬¡ã€‚</p><p>é‚£ï¼Œå¦‚æœçœŸçš„ç”±äºç‰¹æ®ŠåŸå› ï¼Œæ¶ˆæ¯ä¸€ç›´ä¸èƒ½è¢«æ­£ç¡®å¤„ç†ï¼Œé‚£æ€ä¹ˆåŠ ï¼Ÿ</p><p>æˆ‘ä»¬è€ƒè™‘ä¸¤ç§æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>ç¬¬ä¸€ï¼Œåœ¨ä»£ç ä¸­è®¾ç½®æ¶ˆæ¯é‡è¯•æ¬¡æ•°ï¼Œå¦‚æœè¾¾åˆ°æŒ‡å®šæ¬¡æ•°ï¼Œå°±å‘é‚®ä»¶æˆ–è€…çŸ­ä¿¡é€šçŸ¥ä¸šåŠ¡æ–¹äººå·¥ä»‹å…¥å¤„ç†ã€‚</p><pre><code>@Componentpublic class OrderListener implements MessageListenerConcurrently {    Logger logger = LoggerFactory.getLogger(this.getClass());    @Override    public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; list, ConsumeConcurrentlyContext context) {        logger.info("æ¶ˆè´¹è€…çº¿ç¨‹ç›‘å¬åˆ°æ¶ˆæ¯ã€‚");        for (MessageExt message:list) {            if (!processor(message)){                return ConsumeConcurrentlyStatus.RECONSUME_LATER;            }        }        return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;    }    /**     * æ¶ˆæ¯å¤„ç†ï¼Œç¬¬3æ¬¡å¤„ç†å¤±è´¥åï¼Œå‘é€é‚®ä»¶é€šçŸ¥äººå·¥ä»‹å…¥     * @param message     * @return     */    private boolean processor(MessageExt message){        String body = new String(message.getBody());        try {            logger.info("æ¶ˆæ¯å¤„ç†....{}",body);            int k = 1/0;            return true;        }catch (Exception e){            if(message.getReconsumeTimes()&gt;=3){                logger.error("æ¶ˆæ¯é‡è¯•å·²è¾¾æœ€å¤§æ¬¡æ•°ï¼Œå°†é€šçŸ¥ä¸šåŠ¡äººå‘˜æ’æŸ¥é—®é¢˜ã€‚{}",message.getMsgId());                sendMail(message);                return true;            }            return false;        }    }}</code></pre><p>ç¬¬äºŒï¼Œç­‰å¾…æ¶ˆæ¯é‡è¯•æœ€å¤§æ¬¡æ•°åï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚</p><p>æ¶ˆæ¯é‡è¯•æœ€å¤§æ¬¡æ•°é»˜è®¤æ˜¯16æ¬¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ¶ˆè´¹è€…ç«¯è®¾ç½®è¿™ä¸ªæ¬¡æ•°ã€‚</p><pre><code>consumer.setMaxReconsumeTimes(3);//è®¾ç½®æ¶ˆæ¯é‡è¯•æœ€å¤§æ¬¡æ•°</code></pre><p>æ­»ä¿¡é˜Ÿåˆ—çš„ä¸»é¢˜åç§°æ˜¯ %DLQ% + æ¶ˆè´¹è€…ç»„åç§°ï¼Œæ¯”å¦‚åœ¨è®¢å•æ•°æ®ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†æ¶ˆè´¹è€…ç»„åï¼š</p><p>String consumerGroup = "order-consumer-group";</p><p>é‚£ä¹ˆè¿™ä¸ªæ¶ˆè´¹è€…ï¼Œå¯¹åº”çš„æ­»ä¿¡é˜Ÿåˆ—ä¸»é¢˜åç§°å°±æ˜¯%DLQ%order-consumer-group</p><p><br></p><div class=pgc-img><img alt="åŸºäºRocketMQåˆ†å¸ƒå¼äº‹åŠ¡ - å®Œæ•´ç¤ºä¾‹" onerror=errorimg.call(this); src=http://p3.pstatp.com/large/pgc-image/4fe687e23ea642e2b6a43ccc5513ef89><p class=pgc-img-caption></p></div><p><br></p><p>å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç‚¹å‡»TOPICé…ç½®ï¼Œæ¥ä¿®æ”¹é‡Œé¢çš„ perm å±æ€§ï¼Œæ”¹ä¸º 6 å³å¯ã€‚</p><p><br></p><div class=pgc-img><img alt="åŸºäºRocketMQåˆ†å¸ƒå¼äº‹åŠ¡ - å®Œæ•´ç¤ºä¾‹" onerror=errorimg.call(this); src=http://p1.pstatp.com/large/pgc-image/5ae23a50311f4aee807e009315c46e30><p class=pgc-img-caption></p></div><p><br></p><p>æœ€åå°±å¯ä»¥é€šè¿‡ç¨‹åºä»£ç ç›‘å¬è¿™ä¸ªä¸»é¢˜ï¼Œæ¥é€šçŸ¥äººå·¥ä»‹å…¥å¤„ç†æˆ–è€…ç›´æ¥åœ¨æ§åˆ¶å°æŸ¥çœ‹å¤„ç†äº†ã€‚é€šè¿‡å¹‚ç­‰æ€§æ¶ˆè´¹å’Œå¯¹æ­»ä¿¡æ¶ˆæ¯çš„å¤„ç†ï¼ŒåŸºæœ¬ä¸Šå°±èƒ½ä¿è¯æ¶ˆæ¯ä¸€å®šä¼šè¢«å¤„ç†ã€‚</p><h1 class=pgc-h-arrow-right>å››ã€ã€ŠRocketMQæŠ€æœ¯å†…å¹•ã€‹ä¸­çš„ä»£ç ç¤ºä¾‹</h1><p>ç¬”è€…æ‰‹é‡Œæœ‰ä¸€æœ¬ä¹¦ã€ŠRocketMQæŠ€æœ¯å†…å¹•ã€‹ï¼Œåœ¨ 9.4 ç« èŠ‚æœ‰ä¸€æ®µåˆ†å¸ƒå¼äº‹åŠ¡çš„ä»£ç ã€‚</p><p>ä¸è¿‡ï¼Œç¬”è€…åœ¨çœ‹äº†ä¹‹åï¼Œæ„Ÿè§‰å®ƒé‡Œé¢çš„æµç¨‹æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¼šé€ æˆæœ¬åœ°äº‹åŠ¡çš„ä¸ä¸€è‡´ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹ã€‚</p><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯å…³æ³¨ä¹¦ä¸­è®¢å•ä¸šåŠ¡æœåŠ¡ç±»å’Œäº‹åŠ¡ç›‘å¬å™¨çš„æµç¨‹ã€‚</p><p>åœ¨ä¹¦ä¸­ï¼Œè®¢å•ä¸‹å•ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><pre><code>public Map createOrder(){    Map result = new HashMap();    //æ‰§è¡Œä¸‹è®¢å•ç›¸å…³çš„ä¸šåŠ¡æµç¨‹ï¼Œä¾‹å¦‚æ“ä½œæœ¬åœ°æ•°æ®åº“è½åº“ç›¸å…³ä»£ç     //ç”Ÿæˆäº‹åŠ¡æ¶ˆæ¯å”¯ä¸€ä¸šåŠ¡æ ‡è¯†ï¼Œå°†è¯¥ä¸šåŠ¡æ ‡è¯†ç»„è£…åˆ°å¾…å‘é€çš„æ¶ˆæ¯ä½“ä¸­ï¼Œæ–¹ä¾¿æ¶ˆæ¯ç«¯è¿›è¡Œå¹‚ç­‰æ¶ˆè´¹ã€‚    //è°ƒç”¨æ¶ˆæ¯å®¢æˆ·ç«¯APIï¼Œå‘é€äº‹åŠ¡prepareæ¶ˆæ¯ã€‚    //è¿”å›ç»“æœï¼Œæäº¤äº‹åŠ¡    return result;}</code></pre><p>ä¸Šè¿°æ˜¯ç¬¬ä¸€æ­¥ï¼Œå‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œæ¥ä¸‹æ¥éœ€è¦å®ç°TransactionListenerï¼Œå®ç°æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ä¸æœ¬åœ°äº‹åŠ¡å›æŸ¥ã€‚</p><pre><code>public class OrderTransactionListenerImpl implements TransactionListener {    @Override    public LocalTransactionState executeLocalTransaction(Message message, Object o) {        //ä»æ¶ˆæ¯ä½“ä¸­è·å–ä¸šåŠ¡å”¯ä¸€ID        String bizUniNo = message.getUserProperty("bizUniNo");        //å°†bizUniNoå…¥åº“ï¼Œè¡¨åï¼št_message_transactionï¼Œè¡¨ç»“æ„ bizUniNoï¼ˆä¸»é”®ï¼‰ï¼Œä¸šåŠ¡ç±»å‹ã€‚        return LocalTransactionState.UNKNOW;    }    @Override    public LocalTransactionState checkLocalTransaction(MessageExt message) {        //ä»æ¶ˆæ¯ä½“ä¸­è·å–ä¸šåŠ¡å”¯ä¸€ID        String bizUniNo = message.getUserProperty("bizUniNo");        //å¦‚æœæœ¬åœ°äº‹åŠ¡è¡¨(t_message_transaction)å­˜åœ¨è®°å½•ï¼Œåˆ™è®¤ä¸ºæäº¤ï¼›å¦‚æœä¸å­˜åœ¨è¿”å›æœªçŸ¥ã€‚        //å¦‚æœå¤šæ¬¡å›æŸ¥è¿˜æ˜¯æœªæŸ¥åˆ°æ¶ˆæ¯ï¼Œåˆ™å›æ»šã€‚        if (query(bizUniNo)&gt;0){            return LocalTransactionState.COMMIT_MESSAGE;        }else{            return LocalTransactionState.UNKNOW;        }    }    //æŸ¥è¯¢æ•°æ®åº“æ˜¯å¦å­˜åœ¨è®°å½•    public int query(String bizUniNo){        //select count(1) from t_message_transaction where biz_uni_no = #{bizUniNo}        return 1;    }}</code></pre><p>ä¸Šé¢çš„ä»£ç æ˜¯ç¬”è€…åœ¨è¿™æœ¬ä¹¦é‡Œï¼ŒæŠ„å½•å‡ºæ¥çš„ï¼Œå¦‚æœæ˜¯æŒ‰ç…§è¿™ç§åšæ³•ï¼Œ å®é™…ä¸Šæ˜¯æœ‰é—®é¢˜çš„ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ã€‚</p><h1 class=pgc-h-arrow-right>1ã€ä¸‹å•å¼‚å¸¸</h1><p>æˆ‘ä»¬çœ‹ä¸Šé¢çš„è®¢å•ä¸‹å•çš„ä¼ªä»£ç ï¼Œé‡Œé¢åŒ…å«ä¸¤ä¸ªæ“ä½œï¼šè®¢å•å…¥åº“å’Œäº‹åŠ¡æ¶ˆæ¯å‘é€ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ç»§ç»­æ€è€ƒï¼š</p><ul><li>å¦‚æœè®¢å•å…¥åº“çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼Œè¿™ä¸ªæ²¡é—®é¢˜ï¼Œå› ä¸ºäº‹åŠ¡æ¶ˆæ¯ä¹Ÿä¸ä¼šå‘é€ï¼›</li><li>å¦‚æœè®¢å•å…¥åº“æ‰§è¡Œå®Œæ¯•ï¼Œä½†å‘é€äº‹åŠ¡æ¶ˆæ¯æŠ¥é”™ã€‚è¿™ä¸ªä¹Ÿæ²¡é—®é¢˜ï¼Œè®¢å•æ•°æ®ä¼šå›æ»šï¼›</li><li>å¦‚æœè®¢å•å…¥åº“æ‰§è¡Œå®Œæ¯•ï¼Œå‘é€äº‹åŠ¡æ¶ˆæ¯ä¹Ÿæ²¡æœ‰æŠ¥é”™ã€‚ä½†è¿”å›çš„ä¸æ˜¯SEND_OKçŠ¶æ€ï¼Œè¿™ä¸ªæ˜¯æœ‰é—®é¢˜çš„ã€‚</li></ul><p>å› ä¸ºåªæœ‰å‘é€äº‹åŠ¡æ¶ˆæ¯æˆåŠŸï¼Œå¹¶ä¸”å‘é€çŠ¶æ€ä¸ºSEND_OKï¼Œæ‰ä¼šæ‰§è¡Œç›‘å¬å™¨ä¸­çš„æœ¬åœ°äº‹åŠ¡ï¼Œå‘t_message_transactionè¡¨å†™å…¥äº‹åŠ¡æ—¥å¿—ã€‚</p><p>é‚£ä¹ˆå°±ä¼šé€ æˆä¸€ä¸ªç°åœºï¼šæœ¬åœ°è®¢å•æ•°æ®å·²ç»å…¥åº“ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰è¿”å›SEND_OKçŠ¶æ€ï¼Œå¯¼è‡´ä¸ä¼šæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ä¸­çš„äº‹åŠ¡æ—¥å¿—ã€‚é‚£ä¹ˆè¿™æ¡äº‹åŠ¡æ¶ˆæ¯æ—©æ™šä¼šè¢«å›æ»šï¼Œæœ€åçš„é—®é¢˜å°±æ˜¯ç”¨æˆ·ä¸‹å•æˆåŠŸï¼Œä½†æ²¡æœ‰å¢åŠ ç§¯åˆ†ã€‚</p><h1 class=pgc-h-arrow-right>2ã€æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå¼‚å¸¸</h1><p>äº‹å®ä¸Šï¼Œç¬¬ä¸€ä¸ªé—®é¢˜ä¹Ÿå¯ä»¥è§„é¿ã€‚é‚£å°±æ˜¯åœ¨å‘é€å®Œäº‹åŠ¡æ¶ˆæ¯åï¼Œå†åˆ¤æ–­ä¸‹å‘é€çŠ¶æ€æ˜¯ä¸æ˜¯SEND_OKï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œå°±é€šè¿‡æŠ›å¼‚å¸¸çš„æ–¹å¼æ¥å›æ»šè®¢å•æ•°æ®ã€‚</p><p>ä½†æ˜¯ï¼Œè¿˜æœ‰ç¬¬äºŒä¸ªé—®é¢˜ï¼š</p><p>å¦‚æœè®¢å•æ•°æ®å’Œäº‹åŠ¡æ¶ˆæ¯å‘é€éƒ½æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæœ¬åœ°äº‹åŠ¡æ—¶ï¼Œå†™å…¥äº‹åŠ¡æ—¥å¿—æ—¶å‘ç”Ÿå¼‚å¸¸æ€ä¹ˆåŠ ï¼Ÿ</p><p>å¦‚æœæ˜¯è¿™æ ·ï¼Œä¹Ÿä¼šå¯¼è‡´æœ¬åœ°è®¢å•æ•°æ®å·²ç»å…¥åº“ï¼Œä½†æ˜¯äº‹åŠ¡æ—¥å¿—æ²¡æœ‰å†™å…¥ï¼Œåœ¨äº‹åŠ¡çŠ¶æ€å›æŸ¥çš„æ—¶å€™ä¸€ç›´æŸ¥è¯¢ä¸åˆ°æ­¤è®°å½•ï¼Œæœ€ååªèƒ½å›æ»šäº‹åŠ¡æ¶ˆæ¯ã€‚æœ€åçš„ç°è±¡åŒæ ·æ˜¯ç”¨æˆ·ä¸‹å•æˆåŠŸï¼Œä½†æ²¡æœ‰å¢åŠ ç§¯åˆ†ã€‚</p><p>ä½†æ˜¯åœ¨ä¹¦ä¸­ï¼Œä½œè€…æœ‰è¿™æ ·ä¸€æ®µè¯ï¼š</p><blockquote><p>executeLocalTransactionï¼Œè¯¥æ–¹æ³•ä¸»è¦è®¾ç½®æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œä¸ä¸šåŠ¡ä»£ç åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚ä¾‹å¦‚åœ¨OrderService#createOrderä¸­ï¼Œåªè¦æœ¬åœ°äº‹åŠ¡æäº¤æˆåŠŸï¼Œè¯¥æ–¹æ³•ä¹Ÿä¼šæäº¤æˆåŠŸã€‚æ•…åœ¨è¿™é‡Œï¼Œä¸»è¦æ˜¯å‘t_message_transactionæ·»åŠ ä¸€æ¡è®°å½•ï¼Œåœ¨äº‹åŠ¡å›æŸ¥æ—¶ï¼Œå¦‚æœå­˜åœ¨è®°å½•ï¼Œå°±è®¤ä¸ºè¯¥æ¶ˆæ¯éœ€è¦æäº¤ã€‚</p></blockquote><p>ä½œè€…è¿™æ®µè¯çš„æ„æ€ï¼Œæˆ‘ç†è§£æ˜¯è¯´ä»–ä»¬éƒ½å¤„äºä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­ã€‚å¦‚æœcreateOrderæ–¹æ³•æ‰§è¡ŒæˆåŠŸï¼Œåˆ™executeLocalTransactionæ–¹æ³•ä¹Ÿä¼šæ‰§è¡ŒæˆåŠŸï¼›å¦‚æœä»»ä½•ä¸€æ–¹å‡ºé”™ï¼Œéƒ½ä¼šå›æ»šäº‹åŠ¡ã€‚</p><p>ä½†æ˜¯ï¼Œæˆ‘ä»¬ä»æºç ä¸­åˆ†æçš„è¯ï¼Œå¦‚æœæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæŠ¥é”™ï¼Œè®¢å•æ•°æ®æ˜¯ä¸ä¼šå›æ»šçš„ã€‚</p><h1 class=pgc-h-arrow-right>3ã€æºç åˆ†æ</h1><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦çŸ¥é“ï¼ŒexecuteLocalTransactionæ–¹æ³•å’ŒcreateOrderæ–¹æ³•ç¡®å®åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œã€‚</p><p>è¿™æ˜¯å› ä¸ºexecuteLocalTransactionæ–¹æ³•ï¼Œæ˜¯åœ¨å‘é€äº‹åŠ¡æ¶ˆæ¯ä¹‹åï¼ŒåŒæ­¥è°ƒç”¨åˆ°çš„ï¼Œæ‰€ä»¥å®ƒä»¬åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œã€‚</p><p>æˆ‘ä»¬æ¥çœ‹æºç ä¸­ï¼Œäº‹åŠ¡æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ï¼š</p><pre><code>public TransactionSendResult sendMessageInTransaction(Message msg,                         LocalTransactionExecuter localTransactionExecuter,                         Object arg)throws MQClientException {	    //å‘é€äº‹åŠ¡æ¶ˆæ¯è¿”å›ç»“æœ    SendResult sendResult = null;    //å¦‚æœå‘é€æ¶ˆæ¯å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸    try {    	sendResult = this.send(msg);    } catch (Exception var11) {    	throw new MQClientException("send message Exception", var11);    }    //åˆå§‹åŒ–æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼šæœªçŸ¥çŠ¶æ€    LocalTransactionState localTransactionState = LocalTransactionState.UNKNOW;    Throwable localException = null;    switch(sendResult.getSendStatus()) {    //å¦‚æœå‘é€äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ä¸ºsend_ok    case SEND_OK:        try {            //æ‰§è¡Œæœ¬åœ°äº‹åŠ¡æ–¹æ³•            if (transactionListener != null) {                this.log.debug("Used new transaction API");                localTransactionState = transactionListener.executeLocalTransaction(msg, arg);            }        } catch (Throwable var10) {            this.log.info("executeLocalTransactionBranch exception", var10);            this.log.info(msg.toString());            localException = var10;        }        break;	//å¦‚æœå‘é€äº‹åŠ¡çŠ¶æ€ä¸æ˜¯send_ok,è¯¥äº‹åŠ¡æ¶ˆæ¯ä¼šè¢«å›æ»š	case FLUSH_DISK_TIMEOUT:	case FLUSH_SLAVE_TIMEOUT:	case SLAVE_NOT_AVAILABLE:	    localTransactionState = LocalTransactionState.ROLLBACK_MESSAGE;	}	//ç»“æŸäº‹åŠ¡ï¼Œå°±æ˜¯æ ¹æ®æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œæ‰§è¡Œæäº¤ã€å›æ»šæˆ–æš‚ä¸å¤„ç†äº‹åŠ¡	try {	    this.endTransaction(sendResult, localTransactionState, localException);	} catch (Exception var9) {	    this.log.warn("", var9);	}    TransactionSendResult transactionSendResult = new TransactionSendResult();    transactionSendResult.setSendStatus(sendResult.getSendStatus());    transactionSendResult.setMessageQueue(sendResult.getMessageQueue());    transactionSendResult.setMsgId(sendResult.getMsgId());    transactionSendResult.setQueueOffset(sendResult.getQueueOffset());    transactionSendResult.setTransactionId(sendResult.getTransactionId());    transactionSendResult.setLocalTransactionState(localTransactionState);    return transactionSendResult;}</code></pre><p>ä¸Šé¢çš„ä»£ç ï¼Œå°±æ˜¯å‘é€äº‹åŠ¡æ¶ˆæ¯çš„è¿‡ç¨‹ã€‚æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ï¼Œå¦‚æœäº‹åŠ¡æ¶ˆæ¯å‘é€æˆåŠŸï¼Œå¹¶ä¸”è¿”å›çŠ¶æ€ä¸ºSEND_OKï¼Œé‚£ä¹ˆå°±å»æ‰§è¡Œç›‘å¬å™¨ä¸­çš„executeLocalTransactionæ–¹æ³•ï¼Œè¿™è¯´æ˜å®ƒä»¬åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå®ƒæ‰‹åŠ¨æ•è·äº† Throwable å¼‚å¸¸ã€‚è¿™å°±è¯´æ˜ï¼Œå³ä¾¿æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¤±è´¥ï¼Œä¹Ÿä¸ä¼šè§¦å‘å›æ»šçš„ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»éå¸¸æ˜ç¡®äº†ï¼Œå¦‚æœæŒ‰ç…§ä¹¦é‡Œçš„æµç¨‹æ¥å†™ä»£ç ï¼Œè¿™å—å°±ä¼šæˆä¸ºä¸€ä¸ªéšæ‚£ç‚¹ã€‚</p><p>å¦‚æœæƒ³è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åªèƒ½ä¿®æ”¹rocket-clientä¸­çš„ä»£ç ï¼Œæ¯”å¦‚ï¼š</p><pre><code>try {    //æ‰§è¡Œæœ¬åœ°äº‹åŠ¡æ–¹æ³•    if (transactionListener != null) {        this.log.debug("Used new transaction API");        localTransactionState = transactionListener.executeLocalTransaction(msg, arg);    }} catch (Throwable var10) {    this.log.info("executeLocalTransactionBranch exception", var10);    this.log.info(msg.toString());    localException = var10;    throw new MQClientException(e.getMessage(),e);}   </code></pre><p>ç¬”è€…é€šè¿‡ä¿®æ”¹æºç ï¼Œå¹¶æµ‹è¯•äº†ä¸€ä¸‹ï¼Œé€šè¿‡è¿™ç§æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸çš„æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚è¿™æ ·çš„è¯å¦‚æœæ‰§è¡Œæœ¬åœ°äº‹åŠ¡çš„æ—¶å€™å‡ºé”™ï¼Œä¹Ÿä¼šå›æ»šè®¢å•æ•°æ®ã€‚</p><p>åˆ°è¿™é‡Œï¼Œå°±èƒ½å›ç­”ç¬”è€…æœ¬æ–‡2.4ç« èŠ‚é‡Œçš„ä¸€ä¸ªé—®é¢˜ï¼š</p><p>ä¸ºä»€ä¹ˆåœ¨è®¢å•ä¸šåŠ¡æœåŠ¡ç±»ä¸­ï¼Œéœ€è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ã€‚ä¸€ä¸ªç”¨äºå‘RocketMQå‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œä¸€ä¸ªç”¨äºçœŸæ­£çš„ä¸šåŠ¡æ•°æ®è½åº“ã€‚</p><h1 class=pgc-h-arrow-right>æ€»ç»“</h1><p>æœ¬æ–‡é‡ç‚¹é˜è¿°äº†åŸºäºRocketMQæ¥å®ç°æœ€ç»ˆä¸€è‡´æ€§çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡ˆä¾‹ã€‚</p><p>å¦å¤–ï¼Œä¹Ÿåˆ†äº«äº†å…³äºã€ŠRocketMQæŠ€æœ¯å†…å¹•ã€‹ä¸€ä¹¦ä¸­ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ç¤ºä¾‹ä»£ç ï¼Œå¯èƒ½å‡ºç°çš„å¼‚å¸¸é—®é¢˜ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œä¹Ÿå¸Œæœ›æœ‹å‹ä»¬å¦‚æœæœ‰ä¸åŒçœ‹æ³•ï¼Œç§¯æç•™è¨€ï¼Œå…±åŒäº¤æµã€‚</p><p class=pgc-end-literature><br>ä½œè€…ï¼šæ¸…å¹½ä¹‹åœ°<br>é“¾æ¥ï¼šhttps://juejin.im/post/5e737d155188254943200ed0<br></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ç¤ºä¾‹','RocketMQ','äº‹åŠ¡'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>