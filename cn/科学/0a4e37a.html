<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>「数学基础」简单易懂的张量求导和计算图讲解 | 极客快訊</title><meta property="og:title" content="「数学基础」简单易懂的张量求导和计算图讲解 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/e7e49571c34c48f585b79c3126db7467"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/0a4e37a.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/0a4e37a.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/0a4e37a.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/0a4e37a.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/0a4e37a.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/0a4e37a.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/0a4e37a.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/0a4e37a.html><meta property="article:published_time" content="2020-10-29T21:01:39+08:00"><meta property="article:modified_time" content="2020-10-29T21:01:39+08:00"><meta name=Keywords content><meta name=description content="「数学基础」简单易懂的张量求导和计算图讲解"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E5%AD%A6/0a4e37a.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>「数学基础」简单易懂的张量求导和计算图讲解</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E5%AD%A6.html>科学</a></span></div><div class=post-content><p>以下文章来源于王的机器 ，作者王圣元</p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e7e49571c34c48f585b79c3126db7467><p class=pgc-img-caption></p></div><p><strong>王的机器</strong></p><p>Machine Learning -- 机器学习 Financial Engineering -- 金融工程 Quantitative Investing -- 量化投资</p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b28469730c1f495ab830dfae34368429><p class=pgc-img-caption></p></div><p><br></p><p>引言</p><p><strong>情景 1</strong></p><p><br></p><p style=text-align:justify>斯蒂文买了一股京东，当京东变动 1 美元，斯蒂文的组合变动 1 美元。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f6d2fd63fadf41e28dae8ec820530871><p class=pgc-img-caption></p></div><p><br></p><p>这是“标量对标量”求导数。</p><p><br></p><p><strong>情景 2</strong></p><p><br></p><p>斯蒂文买了一股京东，两股百度，三股脸书</p><p><br></p><ul><li>当京东变动 1 美元，斯蒂文的组合变动 1 美元</li><li>当百度变动 1 美元，斯蒂文的组合变动 2 美元</li><li>当脸书变动 1 美元，斯蒂文的组合变动 3 美元</li></ul><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8f4ce5a081a845ffbe0cd7638c8898d2><p class=pgc-img-caption></p></div><p><br></p><p>如果令将三只股票整合成列向量，<strong>股票</strong> = [京东 百度 脸书]，那么</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/385458c7372e4d2ba336aa7a76965daf><p class=pgc-img-caption></p></div><p><br></p><p>如果令将三只股票整合成行向量，<strong>股票</strong> = [京东 百度 脸书]T，那么</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6fd2d7434fcf4484bd35ee8af19fbf9f><p class=pgc-img-caption></p></div><p><br></p><p>这是“标量对向量”求导数，行向量或列向量都不重要，向量只是一组标量的表现形式，重要的是导数“d组合/d<strong>股票</strong>”的“<strong>股票</strong>”的向量类型一致 (要不就是行向量，要不就是列向量)。</p><p><br></p><p><strong>情景 3</strong></p><p><br></p><p>斯蒂文买了一股京东，雪莉买了四股京东。当京东变动 1 美元，斯蒂文的组合 A 变动 1 美元，雪莉的组合 B 变动 4 美元。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e60ff1cd19d3414480d352d5179d73ed><p class=pgc-img-caption></p></div><p><br></p><p>如果令将两个组合整合成列向量，<strong>组合</strong> = [组合A 组合B]，那么</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ec9b0c33c12043f1bc538b220ef1bc40><p class=pgc-img-caption></p></div><p><br></p><p>如果令将两个组合整合成行向量，<strong>组合</strong> = [组合A 组合B]T，那么</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1d54b05122884c03ba761b8c9b979a59><p class=pgc-img-caption></p></div><p><br></p><p>这是“向量对标量”求导数，行向量或列向量都不重要，向量只是一组标量的表现形式，重要的是导数“d<strong>组合</strong>/d京东”的“<strong>组合</strong>”的向量类型一致 (要不就是行向量，要不就是列向量)。</p><p><br></p><p><strong>情景 4</strong></p><p><br></p><p style=text-align:justify>斯蒂文买了一股京东，两股百度，三股脸书；雪莉买了四股京东，五股百度，六股脸书，则</p><p style=text-align:justify><br></p><ul><li>当京东变动 1 美元，斯蒂文的组合 A 变动 1 美元，雪莉的组合 B 变动 4 美元</li><li>当百度变动 1 美元，斯蒂文的组合 A 变动 2 美元，雪莉的组合 B 变动 5 美元</li><li>当脸书变动 1 美元，斯蒂文的组合 A 变动 3 美元，雪莉的组合 B 变动 6 美元</li></ul><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cdca1ba738854ebcb1c63a124283a574><p class=pgc-img-caption></p></div><p><br></p><p>如果令将两个组合和三只股票整合成向量 (行或列)，<strong>组合</strong> = [组合A 组合B]，那么</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/07011e29e8e148c18f8f0455978e97c2><p class=pgc-img-caption></p></div><p style=text-align:justify><br></p><p style=text-align:justify>这是“向量对向量”求导数，上面四种情况乍一看眼花缭乱，实际上就是先将“d<strong>组合</strong>/d<strong>股票</strong>”写成和“<strong>组合</strong>”一样大小的向量，再根据“<strong>股票</strong>”的大小，把<strong>组合</strong>向量里每个元素展开。这样</p><p style=text-align:justify><br></p><ul><li>情况 1 - 当<strong>组合</strong>和<strong>股票</strong>都是行向量，“d<strong>组合</strong>/d<strong>股票</strong>”是一个更长的行向量</li><li>情况 2 - 当<strong>组合</strong>是行向量，<strong>股票</strong>是列向量，“d<strong>组合</strong>/d<strong>股票</strong>”是一个矩阵</li><li>情况 3 - 当<strong>组合</strong>是列向量，<strong>股票</strong>是行向量，“d<strong>组合</strong>/d<strong>股票</strong>”是一个矩阵</li><li>情况 4 - 当<strong>组合</strong>和<strong>股票</strong>都是列向量，“d<strong>组合</strong>/d<strong>股票</strong>”是一个更高的列向量</li></ul><p style=text-align:justify><br></p><p style=text-align:justify>通常使用情况 3 的形式来表示导数。</p><p style=text-align:justify><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/eaed8e46f24241d5a03ffae71d66050c><p class=pgc-img-caption></p></div><p style=text-align:justify><br></p><p style=text-align:justify>但是这只是一种惯例表示，具体表示要看具体问题，没有最好的表示，只有最方便的表示。</p><p style=text-align:justify><br></p><p><strong>情景 5</strong></p><p><br></p><p style=text-align:justify>现在有四家基金，分别在组合 A 和 B 上投资 20% 和 80%，50% 和 50%，70% 和 30%，90% 和 10%，写成矩阵形式为<strong>F</strong> = <strong>U</strong>·<strong>P</strong> = <strong>U</strong>·(<strong>W</strong>·<strong>S</strong>)</p><p style=text-align:justify><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d0cae23fa0594a8b884be9df21571741><p class=pgc-img-caption></p></div><p style=text-align:justify><br></p><p style=text-align:justify>现在来看看所有基金对所有股票的敏感度，即推导“d<strong>基金</strong>/d<strong>股票</strong>”，根据上面的惯例得知应该是个 4×2 的矩阵。</p><p style=text-align:justify><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9a81f2aed681471b829a05106dc35dbe><p class=pgc-img-caption></p></div><p style=text-align:justify><br></p><p style=text-align:justify>注意力只放在红色的 3.4 上，它的计算过程是</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9dfe1f9572584a5ca0208992475966cd><p class=pgc-img-caption></p></div><p><br></p><p style=text-align:justify>矩阵其他每个结果都可以用同样方法算出。上面矩阵可进一步表示成</p><p style=text-align:justify><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d0e0d823f2fe43f6b0ed450592a57dd9><p class=pgc-img-caption></p></div><p style=text-align:justify><br></p><p style=text-align:justify>这个就是向量求导的链式法则。</p><p style=text-align:justify><br></p><hr><p style=text-align:justify>在深度学习中求解中，两个问题最重要</p><p style=text-align:justify><br></p><ol start=1><li>怎样有效的推导出损失函数对所有函数的偏导数？</li><li>怎样有效的计算它们？</li></ol><p style=text-align:justify><br></p><p style=text-align:justify>解决问题 1 需要了解张量求导 (第一节)，解决问题 2 需要了解计算图(第二节)。要理解张量请参考《<strong>张量 101</strong>》。</p><p><br></p><p>本帖目录如下：</p><p><strong>目录</strong></p><p><strong>第一章 - 张量求导</strong></p><p><br></p><p>1.1 类型一 ∂y/∂x</p><p>1.2 类型二 ∂y/∂x</p><p>1.3 类型三 ∂y/∂x</p><p>1.4 神经网络应用</p><p><br></p><p><strong>第二章 - 计算图</strong></p><p><br></p><p>2.1 数学符号</p><p>2.2 神经网络 I</p><p>2.3 神经网络 II</p><p>2.4 神经网络 III</p><p><br></p><p><strong>总结</strong></p><p><strong>参考资料</strong></p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/07c8597ec1bc4125ab2eb3fcf9ff3662><p class=pgc-img-caption></p></div><p><br></p><p>1</p><p>张量求导</p><p>从高层次来看，张量求导 ∂y/∂x 可分为三大类型：</p><li><strong>类型一</strong>：y 或 x 中有一个是标量</li><ul><li><strong>类型二</strong>：y 和 x 中都不是标量</li><li><strong>类型三</strong>：y 作用在元素层面作用上</li></ul><p><br></p><p>1.1</p><p><strong>类型一 ∂y/∂x</strong></p><p><br></p><p>求类型一的偏导数，只需记住下面的形状规则。</p><p><br></p><p><strong>规则 0 (形状规则)</strong>：只要 y 或 x 中有一个是标量，那么导数 ∂y/∂x<strong> </strong>的形状和非标量的形状一致。</p><p><br></p><p>读起来有点绕口，看下面的数学表达式更为直观。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/68c5b7a1744b42e7bdd6412b3aad45ea><p class=pgc-img-caption></p></div><p><br></p><p>上面形状 (D1, D2, …, Dn) 代表的是 n 个维度，第一个维度有 D1 个元素，第二个维度有 D2 个元素，…，第 n 个维度有 Dn 个元素。比如</p><li>标量的形状为 ()</li><ul><li>8 个元素的向量的形状为 (8,)</li><li>3×5 的矩阵的形状为 (3, 5)</li><li>4×2×5×3 的高维张量的形状为 (4, 2, 5, 3)</li></ul><p><br></p><p>类型一再往下细分有 5 类</p><p><br></p><ol start=1><li>∂标量/∂标量</li><li>∂标量/∂向量</li><li>∂标量/∂矩阵</li><li>∂向量/∂标量</li><li>∂矩阵/∂标量</li></ol><p><br></p><p>每一类只需用<strong>形状规则</strong>就可以写出其偏导数，下面来看看这五个具体实例。</p><p><br></p><p>∂标量/∂标量</p><p><br></p><p>当 y 和 x 都是标量。该求导类型在单变量微积分里面已学过，通俗的讲，就是求“y 的变化和 x 的变化”的比率，用符号 ∂y/∂x 来表示。严格来说，单变量导数应写成 dy/dx，但为了和后面偏导数符号一致，就用偏导 ∂ 符号。</p><p><br></p><p>注：“∂标量/∂标量”是张量求导基础，所有困难的求导都可以先从“∂标量/∂标量”开始，摸清规律后再推广到“∂张量/∂张量”。</p><p><br></p><p>∂标量/∂向量</p><p><br></p><p>当 y 是标量，<strong>x </strong>是含有 n 个元素的向量。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/99ed193c93b0426baf2fbfea23ce505e><p class=pgc-img-caption></p></div><p><br></p><p>该导数是 y 对 <strong>x </strong>中的每个元素 (一共 n 个元素) 求导，然后按 <strong>x </strong>的形状排列出来 (<strong>形状规则</strong>)，即，<strong>x </strong>是行 (列) 向量，∂y/∂<strong>x</strong> 就是行 (列) 向量。</p><p><br></p><p>注：神经网络的误差函数是 l 一个标量，在求参数最优解时，我们需要计算 l 对向量偏置 <strong>b</strong> 的偏导数 ∂l/∂<strong>b</strong> (∂标量/∂向量)。</p><p><br></p><p>∂标量/∂矩阵</p><p><br></p><p>当 y 是标量，<strong>x </strong>是大小为 m×n 的矩阵。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/46a79e888d164afdb3bca22925feb630><p class=pgc-img-caption></p></div><p><br></p><p>该导数是 y 对 <strong>x </strong>中的每个元素 (一共 mn 个元素) 求导，然后按 <strong>x </strong>的形状排列出来 (<strong>形状规则</strong>)。</p><p>注：神经网络的误差函数是 l 一个标量，在求参数最优解时，我们需要计算 l 对矩阵权重 <strong>W</strong> 的偏导数 ∂l/∂<strong>W</strong> (∂标量/∂矩阵)。</p><p><br></p><p>∂向量/∂标量</p><p><br></p><p>当 <strong>y </strong>是含有 m 个元素的向量，x 是标量。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/580952a0860846ef8d0a689cefeffc69><p class=pgc-img-caption></p></div><p><br></p><p>该导数是 <strong>y</strong> 中的每个元素 (一共 m 个元素) 对 x 求导，然后按 <strong>y </strong>的形状排列出来 (<strong>形状规则</strong>)，即，<strong>y </strong>是行 (列) 向量，∂<strong>y</strong>/∂x 就是行 (列) 向量。</p><p><br></p><p>注：此类偏导数比较少见，通常我们研究的是单变量输出对多变量输入，而不是反过来的。</p><p><br></p><p>∂矩阵/∂标量</p><p><br></p><p>当 <strong>y </strong>是大小为 m×n 的矩阵，x 是标量。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/05e8912d13b2412d8f255c546600b7ee><p class=pgc-img-caption></p></div><p><br></p><p>该导数是 <strong>y </strong>中的每个元素 (一共 mn 个元素) 对 x 求导，然后按 <strong>y </strong>的形状排列出来 (<strong>形状规则</strong>)。</p><p><br></p><p>注：此类偏导数比较少见，通常我们研究的是单变量输出对多变量输入，而不是反过来的。</p><p><br></p><p>1.2</p><p><strong>类型二 ∂y/∂x</strong></p><p><br></p><p>∂向量/∂向量</p><p><br></p><p>当 <strong>y </strong>是含有 m 个元素的向量，<strong>x </strong>是含有 n 个元素的向量。无论 <strong>y </strong>和 <strong>x </strong>是列向量还是行向量，通常偏导数 ∂<strong>y</strong>/∂<strong>x </strong>写成矩阵形式，而且喜欢把 <strong>y </strong>放在矩阵的行上，而 <strong>x </strong>放在矩阵的列上 [<strong>1</strong>]。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ff9948ab37f043d1803d746214b6232a><p class=pgc-img-caption></p></div><p><br></p><p>该矩阵的大小是 m×n，称为雅克比 (Jacobian) 矩阵。看个简单的具体例子：</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/77ff1ca5b4e8495a8196f5e4194f4255><p class=pgc-img-caption></p></div><p><br></p><p>在神经网络中，<strong>y </strong>和 <strong>x </strong>有两种线性关系用的最多，如下：</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a062698f77f84614b819b0fd0ed36868><p class=pgc-img-caption></p></div><p><br></p><p>根据具体问题，<strong>y </strong>和 <strong>x </strong>会写成列向量或行向量。套用上面介绍的雅克比矩阵可以给出通解 [<strong>2</strong>]。</p><p><br></p><p><strong>情况一</strong>：列向量 <strong>y</strong> 对 <strong>x</strong> 求导，其中 <strong>y</strong> = <strong>Wx</strong></p><p><br></p><p>我们知道 ∂<strong>y</strong>/∂<strong>x </strong>的结果是个矩阵，但是一次性写出它比较困难，不如来看看它第 i 行第 j 列的元素长成什么样，即求 ∂yi/∂xj<strong></strong></p><p></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ffd0a9ac7cc9482a9f4b3a01543bdf47><p class=pgc-img-caption></p></div><p><br></p><p>看到 ∂yi/∂xj = Wij 应该可以秒推出 ∂<strong>y</strong>/∂<strong>x = W </strong>了吧，不信验证下。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c376a3fdcbe04fba93dd1244c7f24591><p class=pgc-img-caption></p></div><p><br></p><p><strong>情况二</strong>：行向量 <strong>y</strong> 对 <strong>x</strong> 求导，其中 <strong>y </strong>=<strong> xW</strong></p><p><br></p><p>我们知道 ∂<strong>y</strong>/∂<strong>x </strong>的结果是个矩阵，但是一次性写出它比较困难，不如来看看它第 i 行第 j 列的元素长成什么样，即求 ∂yi/∂xj<strong></strong></p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/664688863df246019cf4ff5baeee22e6><p class=pgc-img-caption></p></div><p><br></p><p>看到 ∂yi/∂xj = Wji 应该可以秒推出 ∂<strong>y</strong>/∂<strong>x = W</strong>T 了吧，不信验证下。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/604b961730114676b261e987b9dc9be8><p class=pgc-img-caption></p></div><p><br></p><p><strong>规则 1：</strong>当 <strong>y</strong>,<strong> x </strong>都是列向量且 <strong>y</strong> = <strong>Wx</strong>，有 ∂<strong>y</strong>/∂<strong>x </strong>=<strong> W</strong>。</p><p><br></p><p><strong>规则 2：</strong>当 <strong>y, x </strong>都是行向量且 <strong>y</strong> = <strong>xW</strong>，有 ∂<strong>y</strong>/∂<strong>x </strong>=<strong> W</strong>T。</p><p><br></p><p>∂向量/∂矩阵</p><p><br></p><p>规则 1 和 2 是向量对向量求导，现在关注向量对矩阵求导 (当然困难一些)。接着上面 <strong>y </strong>和 <strong>x </strong>的关系，</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/70c7621b940b4d2896085b7045727ce8><p class=pgc-img-caption></p></div><p><br></p><p><strong>情况一</strong>：列向量 <strong>y</strong> 对矩阵 <strong>W</strong> 求导，其中 <strong>y</strong> = <strong>Wx</strong></p><p><br></p><p>根据向量 <strong>y </strong>(n×1) 和矩阵 <strong>W </strong>(n×m) 的大小，∂<strong>y</strong>/∂<strong>W</strong> 是个三维张量，大小为 n×(n×m)。类比于“向量对向量”的雅克比矩阵，∂<strong>y</strong>/∂<strong>W </strong>是个雅克比张量，形式如下：</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d5bb47f901dd4a2bb193c5305a1c36c1><p class=pgc-img-caption></p></div><p><br></p><p>显然一次性写出上面这个三维张量很困难，我们按照 ∂yi/∂Wij<strong> </strong>⇨ ∂yi/∂<strong>W </strong>⇨ ∂<strong>y</strong>/∂<strong>W</strong>层层推导</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/203d1ef5a8af4c2ea0900bf516abf5ec><p class=pgc-img-caption></p></div><p><br></p><p><strong>情况二</strong>：行向量 <strong>y</strong> 对矩阵 <strong>W</strong> 求导，其中 <strong>y</strong> = <strong>xW</strong></p><p><br></p><p>根据向量 <strong>y </strong>(1×n) 和矩阵 <strong>W </strong>(m×n) 的大小，∂<strong>y</strong>/∂<strong>W</strong> 是个三维张量，大小为 n×(m×n)。类比于“向量对向量”的雅克比矩阵，∂<strong>y</strong>/∂<strong>W </strong>是个雅克比张量，形式如下：</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/70dbfbf0037543b68bca28400aa50467><p class=pgc-img-caption></p></div><p><br></p><p>显然一次性写出上面这个三维张量很困难，我们按照 ∂yj/∂Wij<strong> </strong>⇨ ∂yj/∂<strong>W </strong>⇨ ∂<strong>y</strong>/∂<strong>W</strong>层层推导</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8ca8486aefd24406bc422e4a7385a1a1><p class=pgc-img-caption></p></div><p><br></p><p>注：实践中一般不会显性的把“向量对矩阵”的偏导数写出来，维度太高 (因为向量是一维张量，矩阵是二维张量，因此向量对矩阵的偏导是个三维张量)，空间太费。我们只是把它当做中间产出来用。</p><p><br></p><p>对于误差函数 l ，它是 <strong>y </strong>的标量函数。比起求 ∂<strong>y</strong>/∂<strong>W</strong>，我们更有兴趣求 ∂l/∂<strong>W </strong>(比如想知道变动权重 <strong>W</strong> 对误差函数l的影响有多大)。∂l/∂<strong>W </strong>是和 <strong>W </strong>一样大小的矩阵 (<strong>形状规则</strong>)。</p><p><br></p><p>接着上面讨论的两种情况，</p><p><br></p><p><strong>情况一</strong>：<strong>x </strong>和 <strong>y </strong>是列向量，按照 ∂l/∂Wij<strong> </strong>⇨ ∂l/∂<strong>W </strong>层层推导</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/a73f257b6cf143a38c88b383613daa9e><p class=pgc-img-caption></p></div><p><br></p><p><strong>情况二</strong>：<strong>y </strong>和 <strong>x </strong>是列向量，按照 ∂l/∂Wij<strong> </strong>⇨ ∂l/∂<strong>W </strong>层层推导</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1b7c7725cd5843a3846e055cab2170da><p class=pgc-img-caption></p></div><p><br></p><p><strong>规则 3：</strong>当 <strong>y</strong>, <strong>x </strong>都是列向量且 <strong>y</strong> = <strong>Wx</strong>，l 是 <strong>y </strong>的标量函数，有 ∂l/∂<strong>W </strong>= ∂l/∂<strong>y </strong>·<strong> x</strong>T。</p><p><br></p><p><strong>规则 4</strong>：当<strong> y</strong>, <strong>x</strong> 都是行向量且 <strong>y</strong> = <strong>xW</strong>，l 是 <strong>y</strong> 的标量函数，有 ∂l/∂<strong>W </strong>=<strong> x</strong>T · ∂l/∂<strong>y</strong>。</p><p><br></p><p>∂矩阵/∂向量</p><p><br></p><p>本节的“矩阵对向量”和上节的“向量对矩阵”都是下节的“矩阵对矩阵”的特殊形式，因此研究最通用的“矩阵对矩阵”就足够了。</p><p><br></p><p>∂矩阵/∂矩阵</p><p><br></p><p>假设 <strong>X </strong>是 d×m 的矩阵，<strong>W </strong>是 n×d 的矩阵，而 <strong>Y </strong>=<strong> WX </strong>是 n×m 的矩阵。在下面特殊例子里，d= 3, m = 2, n = 2 (以下推出的结果对一般的 d, m, n 也适用)。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f334717b85374016816a1514038ae3a2><p class=pgc-img-caption></p></div><p><br></p><p>和“向量对矩阵”的道理一样，实践中不会像下面显性的把“矩阵对矩阵”的偏导数 (四维张量，矩阵里面套矩阵) 写出来。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fca12dd89b01413b8ce27cc7857f1e53><p class=pgc-img-caption></p></div><p><br></p><p>我们只是把它们当做中间产出来用。比如误差函数 l 是 <strong>Y </strong>的标量函数，比起求 ∂<strong>Y</strong>/∂<strong>W</strong>和 ∂<strong>Y</strong>/∂<strong>X</strong>，我们更有兴趣求 ∂l/∂<strong>W </strong>和 ∂l/∂<strong>X</strong>。根据矩阵链式法则，我们有</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/197020bd47c24d0cb2662060e67c3837><p class=pgc-img-caption></p></div><p><br></p><p>注：上面矩阵链式法则的表达式这样写可能不严谨，因为我们并不知道矩阵和四维张量之间的乘法是如何定义的。比如根据<strong>形状规则</strong>可推出 ∂l/∂<strong>Y</strong>, ∂l/∂<strong>X </strong>和 ∂l/∂<strong>W </strong>的大小，如下表所示：</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9dcb55d12ef048918af8de8f0d08c0a5><p class=pgc-img-caption></p></div><p><br></p><p>但是我们不知道</p><p><br></p><ul><li>2×2 的 ∂l/∂<strong>Y</strong> 和 2×2×3×2 的 ∂<strong>Y</strong>/∂<strong>X </strong>相乘如何等于 3×2 的 ∂l/∂<strong>X</strong></li><li>2×2 的 ∂l/∂<strong>Y</strong> 和 2×2×2×3 的 ∂<strong>Y</strong>/∂<strong>W </strong>相乘如何等于2×3 的 ∂l/∂<strong>W</strong></li></ul><p><br></p><p>因此要推导出矩阵链式法则还需回到基本的标量链式法则。</p><p><br></p><p>首先关注 ∂l/∂<strong>X</strong>，一个个元素来看</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/52698ec6288740e7a31447b3a2117808><p class=pgc-img-caption></p></div><p><br></p><p>注：点乘“<strong>A</strong>⊙<strong>B</strong>”代表将 <strong>A</strong> 和 <strong>B</strong> 里所有元素相乘再加总成一个标量。</p><p><br></p><p>将 ∂yij/∂x11写成矩阵形式，后面是点乘！类比上式可写出</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9c683de23f874206b542e742f0e6ade5><p class=pgc-img-caption></p></div><p><br></p><p>将这六项带入矩阵 ∂l/∂<strong>X </strong>整理得到</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/100cb0e7b77340a08bc96153e772ded9><p class=pgc-img-caption></p></div><p><br></p><p>同理得到 ∂l/∂<strong>W</strong></p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/38f524b2a55340f3aa3a66e146222d33><p class=pgc-img-caption></p></div><p><br></p><p><strong>规则 5：Y</strong>, <strong>X </strong>是矩阵且 <strong>Y</strong> = <strong>WX</strong>，l 是 <strong>Y </strong>的标量函数，有 ∂l/∂<strong>W </strong>= ∂l/∂<strong>Y </strong>·<strong> X</strong>T。</p><p><strong>规则 6：Y</strong>, <strong>X</strong> 是矩阵且 <strong>Y</strong> = <strong>WX</strong>，l 是 <strong>Y</strong> 的标量函数，有 ∂l/∂<strong>X </strong>=<strong> W</strong>T · ∂l/∂<strong>Y</strong>。</p><p>1.3 <strong>类型三 ∂y/∂x</strong></p><p style=text-align:justify>这一类型的 y = f(x) 都是作用在元素层面上，比如一些基本函数 y = exp(x) 和 y = sin(x)，还有神经网络用的函数 y = sigmoid(x) 和 y = relu(x)，它们都是</p><li>标量进标量出</li><ul><li>向量进向量出 (常见)</li><li>矩阵进矩阵出 (常见)</li><li>张量进张量出</li></ul><p>拿 <strong>y</strong> = sin(<strong>x</strong>) 举例，整个推导还是可以用“∂向量/∂向量”那一套，但由于 <strong>y</strong> 和 <strong>x</strong> 一一对应，因此</p><li><strong>y </strong>和 <strong>x </strong>是一样的形状</li><ul><li>y1 只和 x1 有关，因为 ∂y1/∂xi = 0 当 i ≠ 1</li></ul><p>首先写出雅可比矩阵</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/72adb55199f24af69518b9903e8e3d58><p class=pgc-img-caption></p></div><p><br></p><p>这种元素层面的函数求得的偏导数都是对角矩阵 (diagonal matrix)。</p><p><br></p><p>再次把误差函数 l 请出来 (l 是 <strong>y </strong>的标量函数)，通常更感兴趣的是求 ∂l/∂<strong>x</strong>。对某个 xi，根据链式法则得到</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/386863246c294ef38fe7e460ba3c39c7><p class=pgc-img-caption></p></div><p><br></p><p>将上面 n 项整理成向量得到 (发现这种情况下“向量版链式法则”成立)</p><p><br></p><p>但在实操上，我们更喜欢用“元素层面操作”来描述上式，通常用 ◯ 加符号来表示，比如</p><p><br></p><ul><li>⊗：元素层面相乘</li><li>⊘：元素层面相除</li></ul><p><br></p><p>用此惯例，上式可写成</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/57d8e091ca184c58b5676d99a31075e8><p class=pgc-img-caption></p></div><p><br></p><p><strong>规则 7</strong>：当函数 y = f(<strong>x</strong>) 是在元素层面操作，l 是 <strong>y</strong> 的标量函数，有 ∂l/∂<strong>x </strong>=<strong> </strong>∂l/∂<strong>y </strong>⊗ f'(<strong>x</strong>)。</p><p><br></p><p>1.4 <strong>神经网络应用</strong></p><p><br></p><p>神经网络里有两大类函数需要特别留意：</p><p><br></p><ul><li>层与层之间的转换函数 (类型三求导)</li><li>输出结果和标签之间的误差函数 (类型一求导)</li></ul><p><br></p><p>转换函数</p><p><br></p><p>转换函数是将神经网络上一层输出转换成下一层输入的函数，常用的转换函数见下表。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/adf718e20e56445082417dc2a44d522d><p class=pgc-img-caption></p></div><p><br></p><p>其中 identity 函数是线性的，可用于回归问题的输出层，其他三个是非线性的，sigmoid 可用于二分类的输出层，而 tanh 和 relu 比较多用在隐藏层。此外多分类问题的输出层用到的函数是 softmax，其函数和导数如下：</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b7ef113821a24d6083317fb5860b7d1a><p class=pgc-img-caption></p></div><p><br></p><p>关于 softmax 的偏导数用“向量对向量”的方法可以轻松推出来。</p><p><br></p><p>误差函数</p><p><br></p><p>回归问题的均方误差 (mean square error, MSE) 函数，和二分类、多分类问题的交叉熵 (cross entropy, CE) 函数。对 m 个数据点，假设真实值为 <strong>Y</strong>，预测值为 <strong>A</strong>，这三种误差函数的具体形式如下：</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b0bee27a050c4f0e8384e3fd307e1c53><p class=pgc-img-caption></p></div><p><br></p><p>其中上标 (i) 代表第 i 个数据。</p><p><br></p><p>注意多分类问题 CE 函数中 Y 和 A 有下标 k，代表着是第 k 类输出。以数字分类为例，最后数字“零到九”一共有 10 类，因此 K = 10，而通常用独热编码 (one-hot encoding) 来表示“零到九”。具体来说，用 10×1 的向量代表数字 i，而该向量第 i 个元素是 1，其它元素为 0。如下图所示：</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/32259b39a74a4f06adae64cbf5d8ec43><p class=pgc-img-caption></p></div><p><br></p><p>再回到求导这来，在神经网络里，误差函数的预测值 <strong>A </strong>就是最后输出层的产出，通过某个转换函数而得到。具体来说，</p><p><br></p><ul><li>回归问题的 <strong>A </strong>由 identity 转换函数 f(<strong>x</strong>) 算出</li><li>二分类问题的 <strong>A </strong>由 sigmoid 转换函数 f(<strong>x</strong>) 算出</li><li>多分类问题的 <strong>A </strong>由 softmax 转换函数 f(<strong>x</strong>) 算出</li></ul><p><br></p><p>那么标量 l 对 <strong>x </strong>的偏导数可先由下面“不怎么严谨”的链式法则表示出来</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/a9c16b93c3484a6f9f42b9e881c1a1f6><p class=pgc-img-caption></p></div><p><br></p><ul><li>对第一项 ∂l/∂<strong>A</strong>，因为 l 是标量，<strong>A </strong>是向量，由<strong>规则 0</strong> (<strong>形状规则</strong>) 可知 ∂l/∂<strong>A </strong>和 <strong>A </strong>的形状一样。</li><li>对第二项 ∂f(<strong>x</strong>)/∂<strong>x</strong>，由<strong>规则 7</strong> 可知，∂f(<strong>x</strong>)/∂<strong>x </strong>和 ∂l/∂<strong>A </strong>的形状一样。</li></ul><p></p><p style=text-align:justify>上面两项形状相同，因此 ∂l/∂<strong>x</strong> 就是将它们在元素层面相乘得到的结果，因此上面“不怎么严谨”的链式法则可严谨写成</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fde3563ab3024543ac8f0997cf549fce><p class=pgc-img-caption></p></div><p><br></p><p>但上面这种形式只对回归问题和二分类问题适用，多分类问题需要更细致的处理。下面一一来分析。</p><p><br></p><hr><p style=text-align:center><strong>回归问题</strong></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1384c87a8d124d29912a3f8654edaa79><p class=pgc-img-caption></p></div><p><br></p><hr><p style=text-align:center><strong>二分类问题</strong></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a2e5d8d4bb6a44acaae803ba7f1c392f><p class=pgc-img-caption></p></div><p><br></p><hr><p style=text-align:center><strong>多分类问题</strong></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1beca5f081214d1c9f0c036eca34f61f><p class=pgc-img-caption></p></div><p><br></p><p>咋一看这两项形状不一样，不能像回归问题和二分类问题那样在元素层面操作了，而只能张量点乘了。</p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3c5890b408d24de8815864ae4a62fc3b><p class=pgc-img-caption></p></div><p><br></p><p>上面公式太复杂，我们把注意力先只放在第 i 个数据上。但细想一下 Y(i) 的元素，它是个 K×1 的向量，只有一个元素为 1 (假设第 j 个) 其余为 0，因此</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/591d217359e64d96862eec6ebdb6842b><p class=pgc-img-caption></p></div><p><br></p><p>其中下标 :,j 表示矩阵 <strong>S</strong>(i)<strong> </strong>的第 j 列。合并起来得</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8e1aabe1fe574ef0baf6904e12f3a7e1><p class=pgc-img-caption></p></div><p><br></p><p>其中 n1, n2, …, nm 是标签 Y(1), Y(2), …, Y(m) 中元素为 1 的索引。比如 Y(1) 第 3 个元素为 1，Y(2) 第 6 个元素为 1，Y(m) 第 10 个元素为 1，那么 [n1, n2, …, nm] = [3 6 10]。</p><p><br></p><p>2计算图</p><p>2.1 <strong>数学符号</strong></p><p>以下数学符号务必认真看！惯例是用小括号 (i) 上标表示第 i 个数据，用中括号 [L] 上标表示神经网络的第 L 层。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/84d9e182a91f4c8c96487528d6f0da48><p class=pgc-img-caption></p></div><p><br></p><p>本节只用两层神经网络来说明一些核心问题，比如正向传播、反向传播、计算图等等。我们由易到难的讨论以下三种情况：</p><p><br></p><ol start=1><li>一个数据点，单特征输入 x 和输出 y 都是标量 (以回归问题举例)</li><li>一个数据点，多特征输入 <strong>x </strong>是向量，输出 y<strong> </strong>是表量 (以二分类问题举例)</li><li>m 个数据点，输入 <strong>X </strong>和输出 <strong>Y </strong>都是矩阵 (以多分类问题举例)</li></ol><p><br></p><p>关于神经网络结构里面基本元素的介绍，请参考《<strong>人工神经网络</strong>》和《<strong>正向传播和反向传播</strong>》。</p><p><br></p><p><strong>注：情况一和情况二只有一个数据点，现实中几乎不会出现这样的神经网络。这样设计的情况就是为了能由易到难层层深入来解释正向传播和反向传播。</strong></p><p><br></p><p>2.2<strong>神经网络 I</strong></p><p>该神经网络只有单数据点(x, y)，每个输入 x 只有单特征，只有单个输出 y。在下图中，所有 x, w[1], b[1], z[1], a[1], w[2], b[2], z[2], a[2], y 都是标量。下图用正向传播一步步计算出 a[2]。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5254d2a629f1498493c9c407cdaf6f39><p class=pgc-img-caption></p></div><p><br></p><p>以回归问题为例，单个数据点的误差为</p><p style=text-align:center><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/799762345c574b73ae8d287bc2beae8e><p class=pgc-img-caption></p></div><p><br></p><p>神经网络里面 w[1], b[1], w[2] 和 b[2] 都是标量型参数，通过链式法则以反向传播的方式解出它们</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/28fb57a7786e476eb06007e364730bfa><p class=pgc-img-caption></p></div><p><br></p><p>在反向传播过程中</p><p><br></p><ul><li>所有彩色的偏导数，∂l/∂a[2], ∂l/∂z[2], ∂l/∂a[1], ∂l/∂z[1]，都可以重复使用，称为中间梯度 (intermediate gradient)，格式为“∂损失/∂中间变量”</li></ul><p><br></p><ul><li>所有黑色的偏导数，∂a[2]/∂z[2], ∂z[2]/∂w[2], ∂z[2]/∂b[2], ∂a[1]/∂z[1], ∂z[1]/∂w[1], ∂z[1]/∂b[1]，称为局部梯度 (local gradient)，格式为“∂中间变量/∂中间变量”或“∂中间变量/∂参数”</li></ul><p><br></p><ul><li>所有带方框的偏导数，∂l/∂w[2], ∂l/∂b[2], ∂l/∂w[1], ∂l/∂b[1]，是最终需要的，称为最终梯度 (final gradient)，格式为“∂损失/∂参数”</li></ul><p><br></p><p>整个反向传播的精髓就是使用局部梯度来计算中间梯度，再尽多不重复的用中间梯度计算最终梯度。</p><p><br></p><p>最终梯度 = 中间梯度 × 局部梯度</p><p><br></p><p>为了能更精确地描述反向传播算法，使用更精确的计算图 (computational graph) 是很有帮助的。</p><p><br></p><p>计算图就是将计算形式化图形的方法，由<strong>输入结点</strong>、<strong>输出结点</strong>、<strong>函数 </strong>(从输入到输出的)三部分组成。</p><p><br></p><ul><li>每个一节点来表示一个变量，可以是标量、向量、矩阵或张量。</li><li>每个函数表示一个操作，可以作用在单个变量上，也可以作用在多个变量上。</li></ul><p><br></p><p>计算图的实例如下：</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/12e85cfb1a46435792bbbcc4e391cd51><p class=pgc-img-caption></p></div><p><br></p><p>上图中</p><p><br></p><ul><li>x, w[1], b[1], w[2], b[2], y 是输入节点，l 是输出节点，它们都是标量。</li><li>绿色圆框里面的函数 +, ×, f1, f2, J 都可看做操作，比如 +, ×, J 作用在两个变量上，而 f1, f2 作用在单变量上。</li></ul><p><br></p><p>反向传播顾名思义就是从最后输出节点的梯度“∂l /∂l = 1”开始，沿着反方向计算梯度。核心基础就是</p><p><br></p><ol start=1><li>利用“上一个已算好的中间梯度”</li><li>根据绿色圆框的函数得到“局部梯度”</li><li>再用链式法则得到“下一个中间梯度”</li><li>把这个过程反向传播下去</li></ol><p></p><p>四个步骤如下图：</p><p style=text-align:center><strong>步骤 1</strong></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d47263b3ab464aa58a8999fca8ae020a><p class=pgc-img-caption></p></div><p style=text-align:center><strong>步骤 2</strong></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/a55efbffa5974e4ca93ec2f1e683ced6><p class=pgc-img-caption></p></div><p style=text-align:center><strong>步骤 3</strong></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/50a1a75c30e2446391d95a0c1105dc8a><p class=pgc-img-caption></p></div><p style=text-align:center><strong>步骤 4</strong></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/69b0040a2d1648948bc1ea215ed36be1><p class=pgc-img-caption></p></div><p><br></p><p>上面四个步骤图看懂之后，结合本节的神经网络实例，再理解下面六张图的解释就容易了 (点击看大图)。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/99a8dd3686434fe0ade8ebe50dff41b0><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3b76ceab2e604b69b75036b1c7e72b15><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/45b77558d3fb47689a210c4d281c4017><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cd0c1cd5558647fab08f890e53cee107><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8fd10708bf7b445489b4420261a92aa8><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/722e243e988c4ac2a8576744a2161eab><p class=pgc-img-caption></p></div><p><br></p><p>2.3<strong>神经网络 II</strong></p><p>该神经网络只有单数据点 (<strong>x</strong>, y)，每个输入 <strong>x </strong>有多特征，还是单个输出 y。在下图中，<strong>W</strong>[1], <strong>W</strong>[2] 是矩阵，<strong>x</strong>, <strong>z</strong>[1], <strong>a</strong>[1], <strong>b</strong>[1] 是向量，b[2], z[2], a[2], y 是标量。下图用正向传播一步步计算出 a[2]。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4a175b6830a047f585117d06635775ca><p class=pgc-img-caption></p></div><p><br></p><p>整个正向传播计算的变量之间的形状是匹配的，验证如下：</p><p style=text-align:center><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/74494af311c54a6a87a0129650893772><p class=pgc-img-caption></p></div><p><br></p><p>在上式中</p><li>输入层的神经元的个数 = 特征个数，n[0] = nx，这样看 <strong>W</strong>[1]<strong>x </strong>的形状完全匹配</li><ul><li>输出层的神经元的个数 = 单输出，n[2] = ny = 1，这样看 a[2] 是个标量</li></ul><p><br></p><p>以二分类问题为例，单个数据点的误差为 (y = 0 或 1)</p><p style=text-align:center><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/16898a5f432a41228ea0544ecf3cf429><p class=pgc-img-caption></p></div><p style=text-align:center><br></p><p>神经网络里面 <strong>W</strong>[1] 和 <strong>W</strong>[2] 是矩阵型参数，<strong>b</strong>[1] 是向量型参数，b[2] 是标量型参数，通过链式法则以反向传播的方式解出它们</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a876ed70d994416198a35c36e8168a66><p class=pgc-img-caption></p></div><p><br></p><p>根据第一章的张量求导规则，计算上表的偏导数不能更简单：</p><p><br></p><ul><li>计算 ∂l/∂a[2]，规则 0</li><li>计算 ∂l/∂z[2]，标量链式法则</li><li>计算 ∂l/∂<strong>W</strong>[2]，规则 5</li><li>计算 ∂l/∂b[2]，标量链式法则</li><li>计算 ∂l/∂<strong>a</strong>[1]，规则 6</li><li>计算 ∂l/∂<strong>z</strong>[1]，规则 7</li><li>计算 ∂l/∂<strong>W</strong>[1]，规则 5</li><li>计算 ∂l/∂b[1]，规则 6</li></ul><p><br></p><p>计算完上面偏导数之后可用<strong>规则 0</strong> (<strong>形状规则</strong>) 来检查左右两边的形状是否吻合。</p><p><br></p><p>计算图对于非标量也适用，大致结构和上节的非常类似。需要注意的是有时“向量或矩阵版链式法则”不能自然以连乘的方式写出来，因为我们其显示表达式写出来了。如下图 (点击看大图)，</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153c34e5abde49d296d46faf0ecbfd58><p class=pgc-img-caption></p></div><p><br></p><p>2.4 <strong>神经网络 III</strong></p><p>该神经网络考虑 m 个数据点 (<strong>X</strong>, <strong>Y</strong>)，每个输入 <strong>X </strong>有多特征，每个输出 <strong>Y </strong>有多类值 (可以想成是 MNIST 手写数字分类问题，其中有 50000 个训练数据，<strong>X </strong>有 784 个像素特征，<strong>Y </strong>是数字零到九的 10 类)。在下图中，<strong>X</strong>, <strong>W</strong>[1], <strong>Z</strong>[1], <strong>A</strong>[1], <strong>W</strong>[2], <strong>Z</strong>[2], <strong>A</strong>[2], <strong>Y </strong>都是矩阵，<strong>b</strong>[1] 和 <strong>b</strong>[2] 是向量。下图用正向传播一步步计算出 <strong>A</strong>[2]。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a783579b2ae14464af4b0a110c738e03><p class=pgc-img-caption></p></div><p><br></p><p>整个正向传播计算的变量之间的形状是匹配的，验证如下：</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a798ad06f7a9471fa5779a1fdee45097><p class=pgc-img-caption></p></div><p><br></p><p>在上式中</p><p><br></p><ul><li>输入层的神经元的个数 = 特征个数，n[0] = nx，这样看 <strong>W</strong>[1]<strong>X </strong>的形状完全匹配</li><li>输出层的神经元的个数 = 10 类输出，n[2] = ny = 10</li><li>为了能达到广播机制一样的效果，在相应的 <strong>b </strong>前面加入全部元素都为 1 的向量 <strong>1</strong>m</li></ul><p><br></p><p>多分类问题下的误差函数为</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/39a596296ad945fb84237063ce995a51><p class=pgc-img-caption></p></div><p><br></p><p>其中 Y 是真实值，A 是神经网络的预测值 (具体说明见小节 1.4)。</p><p><br></p><p>神经网络里面 <strong>W</strong>[1] 和 <strong>W</strong>[2] 是矩阵型参数，<strong>b</strong>[1] 和 <strong>b</strong>[2] 是向量型参数，通过链式法则以反向传播的方式解出它们。</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/eb8051cb24774b4182beb8b57ff7f594><p class=pgc-img-caption></p></div><p><br></p><p>根据第一章的张量求导规则，计算上表的偏导数不能更简单：</p><p><br></p><ul><li>计算 ∂l/∂<strong>A</strong>[2]，规则 0</li><li>计算 ∂l/∂<strong>Z</strong>[2]，见小节 1.4</li><li>计算 ∂l/∂<strong>W</strong>[2]，规则 5</li><li>计算 ∂l/∂<strong>b</strong>[2]，规则 5</li><li>计算 ∂l/∂<strong>A</strong>[1]，规则 6</li><li>计算 ∂l/∂<strong>Z</strong>[1]，规则 7</li><li>计算 ∂l/∂<strong>W</strong>[1]，规则 5</li><li>计算 ∂l/∂<strong>b</strong>[1]，规则 5</li></ul><p><br></p><p>计算完上面偏导数之后可用<strong>规则 0</strong> (<strong>形状规则</strong>) 来检查左右两边的形状是否吻合。</p><p><br></p><p>计算图对于非标量也适用，大致结构和上节的非常类似。需要注意的是有时“矩阵版链式法则”不能自然以连乘的方式写出来，因为我们其显示表达式写出来了。如下图 (点击看大图)，</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2cf95f1e1a4448de995fdf8e4f092055><p class=pgc-img-caption></p></div><p><br></p><p>3 总结</p><p>本帖除了文中参考的资料 [<strong>1</strong>] 和[<strong>2</strong>]，还参考了 [<strong>3</strong>], [<strong>4</strong>], [<strong>5</strong>]。</p><p><br></p><p>深度学习可以不严谨的认为是各类架构神经网络，神经网络的正向传播就是张量计算，既一连串操作在张量上。做优化第一步是要求出损失函数对所有参数的导数 (张量形式)。我知道</p><p><br></p><ul><li>写出张量导数表达式难，就精简出 8 条规则</li><li>串联张量导数在一起难，就用计算图来理解</li></ul><p><br></p><p>这两点都会了，你会发现反向传播就是张量版链式法则。</p><p><br></p><p>8 条规则</p><p><br></p><p>注：l 是<strong> y </strong>或<strong> Y </strong>的标量函数</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f531835869fe46d1badbf749f726d5c9><p class=pgc-img-caption></p></div><p><br></p><p>在这 8 条规则中</p><p><br></p><ul><li>规则 0 (形状规则) 最重要，很多时候你只要检查各个张量的形状就知道公式推导的是否正确。</li><li>规则 1 和 2 是基础，做法就是每次对标量求导，再按照雅克比矩阵一个个填满就得到了答案。</li><li>有些人喜欢把 <strong>x </strong>写成列向量，有些人喜欢把 <strong>x </strong>写成行向量，规则 4 和 5 根据这些喜好给出相应的偏导数。</li><li>现实中 <strong>X</strong> 通常是个二维矩阵，一个维度是特征数，一个维度是数据数，因此规则 5 和 6 最普适，是规则 3 和 4 的推广。</li></ul><p><br></p><p>计算图核心</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/30cf4840dee94f24aed86eca9300a691><p class=pgc-img-caption></p></div><p><br></p><p>注意我把“中间梯度×局部梯度”该成 dot(中间梯度, 局部梯度)，这个函数实际上是 numpy 里面张量点乘的操作。</p><p><br></p><p>本帖内容吃透，终于可以放手来研究深度学习中的各种网络结构了，最重要的是，再也不用悚各种反向传播推导了。你可以自信的说，不就是链式法则么，带张量的？Stay Tuned！</p><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/116010296ef1461baeadf2a46d36d2bc><p class=pgc-img-caption></p></div><p><strong>参考资料</strong></p><p style=text-align:center><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d2d9f68d31504e0dbaa16e388dbd0f85><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「数学基础」简单易懂的张量求导和计算图讲解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1b79e86427114fa695611bc9b9ca999c><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'数学','基础','简单'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>