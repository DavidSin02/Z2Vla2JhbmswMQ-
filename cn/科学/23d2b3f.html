<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>驱动调试技巧点滴分享 | 极客快訊</title><meta property="og:title" content="驱动调试技巧点滴分享 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/dfic-imagehandler/78bcd9cd-9179-4319-9652-34ee815c845d"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/23d2b3f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/23d2b3f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/23d2b3f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/23d2b3f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/23d2b3f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/23d2b3f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/23d2b3f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/23d2b3f.html><meta property="article:published_time" content="2020-10-29T21:02:12+08:00"><meta property="article:modified_time" content="2020-10-29T21:02:12+08:00"><meta name=Keywords content><meta name=description content="驱动调试技巧点滴分享"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E5%AD%A6/23d2b3f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>驱动调试技巧点滴分享</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E5%AD%A6.html>科学</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right><span style="color:#4d4d4d;--tt-darkmode-color: #999999">引言</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">作为一个算是合格的驱动工程师，总是有很多话想说。代码看的多了总是有些小感悟。可能是吧。那就总结一下自己看的代码的一些感悟和技巧。如何利用你看的这些代码？如何体现在工作的调试中？</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">作为驱动工程师，主要的工作就是移植各种驱动，接触各种硬件。接触最多的就是dts、中断、gpio、sysfs、proc fs。如何利用sysfs、proc fs及内核提供的接口为我们降低调试难度，快速解决问题呢？</span></p><blockquote class=pgc-blockquote-abstract><p><span style="color:#999;--tt-darkmode-color: #999999">注：部分代码分析举例基于linux-4.15。</span></p></blockquote><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999"><strong>如何利用dts？</strong></span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">首先我们关注的主要是两点，gpio和irq。其他的选择忽略。先展示一下我期望的gpio和irq的使用方法。dts如下:</span></p><pre><code>device {    rst-gpio = &lt;&amp;gpioc_ctl 10 OF_GPIO_ACTIVE_LOW&gt;;    irq-gpio = &lt;&amp;gpioc_ctl 11 0&gt;;    interrupts-extended = &lt;&amp;vic 11 IRQF_TRIGGER_RISING&gt;; };}</code></pre><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">对于以上的dts你应该再熟悉不过，当然这里不是教你如何使用dts，而是关注gpio和irq最后一个数字可以如何利用。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">例如rst-gpio的OF_GPIO_ACTIVE_LOW代表什么意思呢？可以理解为低有效。什么意思呢？举个例子，正常情况下，我们需要一个gpio口控制灯，我们认为灯打开就是active状态。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">对于一个程序员来说，我们可以封装一个函数，写1就是打开灯，写0就是关灯。但是对于硬件来说，变化的是gpio口的电平状态。如果gpio输出高电平灯亮，那么这就是高有效。如果硬件设计是gpio输出低电平灯亮，那么就是低有效。对于一个软件工程师来说，我们的期望是写1就是亮灯，写0就是关灯。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">我可不管硬件工程师是怎么设计的。我们可以认为dts是描述具体的硬件。因此对于驱动来说，硬件的这种变化，只需要修改dts即可。软件不用任何修改。软件可以如下实现：</span></p><pre><code>int device_probe(struct platform_device *pdev){    rst_gpio = of_get_named_gpio_flags(np, "rst-gpio", 0, &amp;flags);    if (flags &amp; OF_GPIO_ACTIVE_LOW) {        struct gpio_desc *desc;        desc = gpio_to_desc(rst_gpio);        set_bit(FLAG_ACTIVE_LOW, &amp;desc-&gt;flags);    }    irq = of_irq_get(np, 0);    trigger_type = irq_get_trigger_type(irq);    request_threaded_irq(irq, NULL, irq_handler, trigger_type, "irq", NULL);}</code></pre><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">驱动按照以上代码实现的话，如果修改中断触发类型或者电平有效状态只需要修改dts即可。例如不同的IC复位电平是不一样的，有的IC是高电平复位，有的IC却是低电平复位。其实这就是一个电平有效状态的例子。</span></p><p><br></p><div class=pgc-img><img alt=驱动调试技巧点滴分享 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/78bcd9cd-9179-4319-9652-34ee815c845d><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><span style="color:#4d4d4d;--tt-darkmode-color: #999999">如何调试gpio？</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">移植驱动阶段或者调试阶段的工程中，难免想知道当前gpio的电平状态。当然很easy。万用表戳上去不就行了。是啊！硬件工程师的思维。作为软件工程师自然是要软件的方法。下面介绍两个api接口。自己摸索使用吧。点到为止。</span></p><pre><code>static inline int gpio_export(unsigned gpio, bool direction_may_change);static inline int gpio_export_link(struct device *dev, const char *name, unsigned gpio);</code></pre><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">在你的driver中调用以上api后，编译下载。去/sys/class/gpio目录看看有什么发现。</span></p><p><br></p><h1 class=pgc-h-arrow-right><span style="color:#4d4d4d;--tt-darkmode-color: #999999">如何调试irq？</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">调试的时候也难免会确定硬件是否产生中断。我们该怎么办呢？也很easy。</span></p><pre><code>cat /proc/interrupts</code></pre><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">输出信息不想多余的介绍。看代码去。根据输出的irq num，假设是irq_num。请进入以下目录。看看下面都有什么文件。摸索这些文件可以为你调试带来哪些方便。</span></p><pre><code>cd /proc/irq/irq_num</code></pre><p><br></p><div class=pgc-img><img alt=驱动调试技巧点滴分享 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/dfic-imagehandler/8a57e45e-06c3-4667-8482-bc30e0e6833f><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><span style="color:#4d4d4d;--tt-darkmode-color: #999999">dts和sysfs有什么关联 ？</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">曾经写过一篇dts解析的文章http://www.wowotech.net/device_model/dt-code-file-struct-parse.html。最后一节其实说了一个很有意思的东西。但是仅仅是寥寥结尾。并没有展开。因为他不关乎我写的文章的的主题。但是，他却和调试息息相关。</span></p><pre><code>cd /sys/firmware/devicetree/base</code></pre><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">该目录的信息就是整个dts。将整个dts的节点以及属性全部展现在sysfs中。他对我们的调试有什么用呢？Let me tell you。如果你的项目非常的复杂，例如一套代码兼容多种硬件配置。这些硬件配置的差异信息主要是依靠dts进行区分。当编译kernel的时候，你发现你很难确定就是你用的是哪个dts。可能你就会凭借自己多年的工作经验去猜测。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">是的，你的经验很厉害。但是，如何确定你的dts信息是否添加到kernel使用的dts呢？我觉得你应该got it。就到这个目录去查找是否包含你添加的ndoe和property。dts中有status属性可以设置某个devicec是否使能。当你发现你的driver的probe没有执行的时候，我觉得你就需要确定一遍status是不是“ok”、“okay”或者没有这个属性。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">远不止我所说的这个功能，还可以判断当前的硬件是匹配哪个dts文件。你还不去探索一波源码的设计与实现吗？节点为什么出现在某些目录？为什么有些节点的属性cat却是乱码？就是乱码，你没看错。至于为什么。点到为止。</span></p><p><br></p><h1 class=pgc-h-arrow-right><span style="color:#4d4d4d;--tt-darkmode-color: #999999">sysfs可以看出什么猫腻？</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">sysfs有什么用？sysfs可以看出device是否注册成功、存在哪些device、driver是否注册、device和driver是都匹配、device匹配的driver是哪个等等。先说第一项技能。deivce是否注册。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">就以i2c设备为例说明。/sys/bus/i2c/devices该目录下面全是i2c总线下面的devices。如何确定自己的device是否注册呢？首先你需要确定自己的device挂接的总线是哪个i2c（i2c0, i2c1…）。假设设备挂接i2c3，从地址假设0x55。那么devices目录只需要查看是否有3-0055目录即可。</span></p><p><br></p><h1 class=pgc-h-arrow-right><span style="color:#4d4d4d;--tt-darkmode-color: #999999">如何确定device是否匹配了驱动？</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">进入3-0055目录，其实你可以看到driver的符号链接。如果没有，那么就是没有driver。driver是否注册如何确定呢？方法类似。/sys/bus/i2c/drivers目录就是所有注册的i2c driver。方法如上。不再列举。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">你以为就这些简单的功能了吗？其实不是，还有很多待你探讨。主要是各种目录之间的关系，device注册会出现什么目录？那么driver呢？各种符号链接会在哪些目录？等等。</span></p><p><br></p><div class=pgc-img><img alt=驱动调试技巧点滴分享 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/cc5d6511-a603-4d6f-be65-d7c8f7c57e62><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><span style="color:#4d4d4d;--tt-darkmode-color: #999999">如何排查driver的probe没有执行问题？</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">我想这类问题是移植过程中极容易出现的第一个拦路虎。这里需要声明一点。可能有些驱动工程师认为probe没有执行就是driver没有注册成功。其实这两个没有半毛钱关系。probe是否执行只和device和driver的是否匹配成功有关。我们有什么思路排查这类问题呢？主要排查方法可以如下。</span></p><ol start=1><li><span style="color:#4d4d4d;--tt-darkmode-color: #999999">通过sysfs确定对应的device是否注册成功。</span></li><li><span style="color:#4d4d4d;--tt-darkmode-color: #999999">通过sysfs确定对应的driver是否注册成功。</span></li><li><span style="color:#4d4d4d;--tt-darkmode-color: #999999">通过sysfs中dts的展开信息得到compatible属性的值，然后和driver的compatible进行对比。</span></li></ol><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">如果发现device没有注册，如何确定问题。首先通过sysfs中dts展开文件查看是否有你添加的device信息。如果没有的话，没有device注册就是正常的，去找到正确的dts添加正确的device信息。如果发现sysfs有device的dts信息。那么就看看status属性的值是不是ok的。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">如果也是ok的。那么就非常奇怪了。这种情况一般出现在kernel的device注册路径出错了。曾经就有一个小伙伴提出问题，现象就是这样。最后我帮他确定问题原因是dts章reg属性的地址是0xc0。这是一个大于0x7f的值。在i2c总线注册驱动的时候会解析当前总线下的所有device。然后注册所有的从设备。就是这里的地址检查出了问题，因此这个device没有注册上。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">如果发现driver没有注册，那么去看看对应的Makefile是否参与编译。如果参与了编译，就查看log信息，是不是驱动注册的时候有错误信息。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">最后一点的compatible属性的值只需要cat一下，然后compare即可, 不多说。</span></p><p><br></p><h1 class=pgc-h-arrow-right><span style="color:#4d4d4d;--tt-darkmode-color: #999999">后记</span></h1><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">sysfs还有很多的其他的调试信息可以查看。因此，我建议驱动工程师都应该掌握sysfs的使用和原理。看看代码实现。我始终坚信只有更好地掌握技术的原理才能更好地利用技术。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">文章内容不想展开。我告诉你的结果，你永远记忆不深刻，而且我说的也不一定对。还是需要自己专研。我只是给你指条明路，剩下的就需要自己去走。最后说一句，代码不会骗你，还会告诉你别人不能告诉你的。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">-完-</span></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'驱动','调试','点滴'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>