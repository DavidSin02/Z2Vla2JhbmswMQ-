<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>操作系统 - 操作系统的调试 | 极客快訊</title><meta property="og:title" content="操作系统 - 操作系统的调试 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/b0c1b20accf448409c81b82f7bcc4bdc"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/43a8cb7.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/43a8cb7.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/43a8cb7.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/43a8cb7.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/43a8cb7.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/43a8cb7.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/43a8cb7.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/43a8cb7.html><meta property="article:published_time" content="2020-10-29T21:02:12+08:00"><meta property="article:modified_time" content="2020-10-29T21:02:12+08:00"><meta name=Keywords content><meta name=description content="操作系统 - 操作系统的调试"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E5%AD%A6/43a8cb7.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>操作系统 - 操作系统的调试</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E5%AD%A6.html>科学</a></span></div><div class=post-content><p>我们总是时不时的提起调试。现在我们就好好看看这玩意儿。宽泛点说，<strong>调试</strong>就是在系统中发现和修复问题的行为，包括硬件和软件。性能问题也认为是bug，所以调试也包括<strong>性能调优</strong>，也就是寻求通过去除处理过程中的瓶颈来改善性能。接下来，我们会提到调试的过程、内核错误以及性能问题。暂时不涉及硬件调试。</p><h1 class=pgc-h-arrow-right>错误分析</h1><p>如果一个进程发生了错误，大多数的操作系统会把错误信息写进日志文件从来警告管理员或用户有问题发生了。操作系统也会用<strong>core dump(核心转储)</strong>，是进程地址空间的内容以及有关进程状态的其他信息写出的一个磁盘文件，用来之后分析。运行的程序和core dump可以通过调试器探测到，这可以让程序员检查代码并且查看失败时进程地址空间到底发生了什么。</p><p>调试用户级别的进程代码是一个挑战。因为内核的大小和复杂度，操作系统的内核调试更是复杂，它既控制着硬件，有缺少用户级别的调试工具。当crash发生时，错误信息会被保存到日志文件中，内存状态信息会被保存到<strong>crash dump</strong>。</p><p>操作系统的调试和进程调试，因为这两个任务天生的不同而通常使用不同的工具和技术。考虑到文件系统代码中的内核故障会导致内核在重启之前尝试将其状态保存到下文件系统上的文件中的风险，一种常见的技术是将内核的内存状态保存到为此保留的一部分磁盘中，该部分不包含文件系统。如果内存检测到不可回复的错误，则会将内存的全部内容，或至少是系统内存中内核拥有的部分，写入该磁盘区域。当系统重启时，将运行一个进程从该区域收集数据并将其写入文件系统中的crash dump文件中以进行分析。显然，这样的策略对于调试普通的用户进程是没有必要的。</p><h1 class=pgc-h-arrow-right>性能监测和调优</h1><p>我们之前性能调优就是提过通过去除处理过程中瓶颈来寻求改善性能。为了识别瓶颈，我们必须能够监测系统性能呢个。因此，操作系统必须有一些方式用来计算和展示系统的行为。根据是按每个进程或整个系统的观测角度的不同，每个工具都有自己的特征。为了达成这些观测，工具会使用这两个方法中的一个 --- counters计数或追踪tracing。下面，我们会探究一下这俩玩意儿。</p><hr><h1 class=pgc-h-arrow-right>计数器</h1><p>操作系统通过一系列的计数器保持对系统行为的追踪，比如系统调用的次数或是对网络设备或磁盘的操作次数。下面是Liunx用作计数器的工具：</p><ul><li>进城级</li><ul><li>ps - 报告对单个或选中进程的信息</li><li>top - 报告当前进程们的实时统计信息</li></ul><li>系统级</li><ul><li>vmstat - 报告内存使用的统计</li><li>netstat - 报告网络接口门的统计信息</li><li>iostat - 包括对磁盘的I/O使用情况</li></ul></ul><p><br></p><p>在Linux中大多数基于计数的工具都是从/proc文件系统里读取统计信息的。/proc是一个假的文件系统，它只存在于内核的内存中，并且主要被用来查寻各个进程和内核的统计信息。/ proc文件系统组织为目录层次结构，每个进程（分配给每个进程的唯一整数值）显示为/ proc下的子目录。例如，目录条目/ proc / 2155将包含ID为2155的进程的每个进程统计信息。/proc这也有各种条目，用于各种内核统计信息，如下图：</p><div class=pgc-img><img alt="操作系统 - 操作系统的调试" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b0c1b20accf448409c81b82f7bcc4bdc><p class=pgc-img-caption></p></div><p>Unbuntu中也提供了一个系统监测应用，一个包含进程进程，系统资源，和文件系统信息的工具。截图如下：</p><div class=pgc-img><img alt="操作系统 - 操作系统的调试" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c618e19c25f6473d8ef3a8402516a7f0><p class=pgc-img-caption>Ubuntu中的系统监测工具</p></div><h1 class=pgc-h-arrow-right>追踪</h1><p>尽管基于计数的工具只是简单的查询内核维护的某些统计信息中的当前值，但追踪工具则收集一些特殊时间的数据，诸如系统调用中包含的每一步。</p><p>下面是Linux中追踪事件工具的示例：</p><ul><li>进程级</li><ul><li>strace - 追踪单个进程的系统调用</li><li>gdb - 一个源代码级的调试器</li></ul><li>系统级</li><ul><li>perf - Linux性能收集工具</li><li>tcpdump - 采集网络包</li></ul></ul><blockquote class=pgc-blockquote-abstract><p>柯林汉定律 (Kernighan's Law)</p><p>调试在一开始就比编写程序困难一倍。因此，按照定义，如果你的代码写得非常巧妙，那么你就没有足够的能力来调试它。</p></blockquote><p>使操作系统在运行时更易于理解，调试和调优是研究和实践的活跃领域。新一代支持内核的性能分析工具在实现此目标的方式上有了重大改进。接下来，我们讨论BCC，一个动态Linux内核追踪工具包。</p><hr><h1 class=pgc-h-arrow-right>BCC</h1><p>如果没有能够理解两组代码并能够检测它们之间的交互作用的工具集，几乎不可能调试用户级代码与内核代码之间的交互。为了使该工具集真正有用，它必须能够调试系统的任何区域，包括未考虑调试的部分，并且在不影响系统可靠性的情况下进行调试。该工具集还必须对性能产生最小的影响-理想情况下，它在不使用时不受影响，而在使用中的影响是不成比例。 BCC工具箱满足了这些要求，并提供了动态，安全，低影响的调试环境。</p><p><strong>BBC</strong>（<strong>BPF</strong> Compiler Collection）是个丰富的工具包，用于提供对Linux系统的追踪。BCC是e BPF（extended <strong>Berkeley Packet Filter</strong>，扩展的Berkeley数据包过滤器）工具的前端接口。 BPF技术是在1990年代初开发的，用于过滤计算机网络中的流量。 “extened扩展的” BPF（e BPF）为BPF添加了各种功能。 BPF程序是用C的子集编写的，并被编译成e BPF指令，这些指令可以动态地插入正在运行的Linux系统中。 e BPF指令可用于捕获特定事件（例如正在调用的某个系统调用）或监视系统性能（例如执行磁盘I / O所需的时间）。为了确保BPF指令的行为良好，在插入运行Linux内核之前，它们会通过<strong>verifier验证者</strong>传入。验证者会进行检查以确保说明不会影响系统性能或安全性。</p><p>尽管e BPF为Linux内核中的跟踪提供了丰富的功能集，但是从传统上来说，使用其C接口开发程序非常困难。开发BCC的目的是通过在Python中提供一个前端接口来简化使用e BPF编写工具的过程。 BCC工具是用Python编写的，它嵌入了与e BPF工具接口的C代码，后者又与内核接口。 BCC工具还将C程序编译为e BPF指令，并使用<strong>探测</strong>或将其<strong>跟踪点</strong>插入内核中，这是两种允许在Linux内核中跟踪事件的技术。</p><p>编写自定义BCC工具的细节不在讨论范围之内，但是BCC软件包提供了许多现有工具，用于监视正在运行的Linux内核中多个活动区域。</p><p>ubuntu下的安装命令如下：</p><pre><code>sudo apt-get install bpfcc-tools linux-headers-$(uname -r)</code></pre><p>其他系统可参考https://github.com/iovisor/bcc/blob/master/INSTALL.md</p><p>使BCC特别强大的是，它的工具可以在运行关键应用程序的实时生产系统上使用，而不会对系统造成损害。这对于必须监视系统性能以识别可能的瓶颈或安全漏洞的系统管理员特别有用。下图说明了BCC和e BPF当前提供的各种工具，以及它们跟踪Linux操作系统的几乎任何区域的能力。 BCC是一种快速变化的技术，不断地被添加新功能。</p><div class=pgc-img><img alt="操作系统 - 操作系统的调试" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/6fa74d1005cc425fbd84bdd5e73ee4d2><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'系统','调试','操作'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>