<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ | æå®¢å¿«è¨Š</title><meta property="og:title" content="è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/95b6a9a43785468fb3b24d2617951bf7"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/44160f37.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/44160f37.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/44160f37.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/44160f37.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/44160f37.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/44160f37.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/44160f37.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/44160f37.html><meta property="article:published_time" content="2020-11-14T20:53:57+08:00"><meta property="article:modified_time" content="2020-11-14T20:53:57+08:00"><meta name=Keywords content><meta name=description content="è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E5%AD%A6/44160f37.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E5%AD%A6.html>ç§‘å­¦</a></span></div><div class=post-content><div><blockquote><p><strong>ç§ä¿¡æˆ‘æˆ–å…³æ³¨å¾®ä¿¡å·ï¼šç‹®èŒƒå„¿ï¼Œå›å¤ï¼šå­¦ä¹ ï¼Œè·å–å…è´¹å­¦ä¹ èµ„æºåŒ…ã€‚</strong></p></blockquote><p><em>1</em></p><p>æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä¼˜åŒ–å†…å­˜</p><p class=ql-align-justify><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/95b6a9a43785468fb3b24d2617951bf7><p class=pgc-img-caption></p></div><p>åœ¨ Android ä¸­æˆ‘ä»¬å†™çš„ .java æ–‡ä»¶ï¼Œæœ€ç»ˆä¼šç¼–è¯‘æˆ .class æ–‡ä»¶, class åˆç”±ç±»è£…è½½å™¨åŠ è½½åï¼Œåœ¨ JVM ä¸­ä¼šå½¢æˆä¸€ä»½æè¿° class ç»“æ„çš„å…ƒä¿¡æ¯å¯¹è±¡ï¼Œé€šè¿‡è¯¥å…ƒä¿¡æ¯å¯¹è±¡å¯ä»¥çŸ¥é“ class çš„ç»“æ„ä¿¡æ¯ (æ„é€ å‡½æ•°ã€å±æ€§ã€æ–¹æ³•)ç­‰ã€‚</p><p>JVM ä¼šæŠŠæè¿°ç±»çš„æ•°æ®ä» class æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼ŒJava æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç®¡ç†å†…å­˜çš„æœºåˆ¶ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶ GC ã€‚</p><p>ä¸ºä»€ä¹ˆ Java éƒ½ç»™æˆ‘ä»¬æä¾›äº†åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œç¨‹åºæœ‰æ—¶è¿˜ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå†…å­˜æº¢å‡º OOMï¼Œç”šè‡³å¯¼è‡´ç¨‹åº Crash ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯¹å®é™…å¼€å‘ä¸­å‡ºç°çš„è¿™äº›å†…å­˜é—®é¢˜ï¼Œæ¥è¿›è¡Œä¼˜åŒ–ã€‚</p><p><em>2</em></p><p>Java è™šæ‹Ÿæœº</p><p class=ql-align-justify><br></p><p>æˆ‘ä»¬å…ˆæ¥å¤§æ¦‚äº†è§£ä¸€ä¸‹ Java è™šæ‹Ÿæœºé‡Œé¢è¿è¡Œæ—¶çš„æ•°æ®åŒºåŸŸæœ‰å“ªäº›ã€‚</p><p class=ql-align-justify><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/921a50916b5647ddbc213d6c8b54a64b><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p><strong>çº¿ç¨‹ç‹¬å åŒº</strong></p><p><strong>ç¨‹åºè®¡æ•°å™¨</strong></p><ul><li class=ql-align-justify>ç›¸å½“äºä¸€ä¸ªæ‰§è¡Œä»£ç çš„æŒ‡ç¤ºå™¨ï¼Œç”¨æ¥ç¡®è®¤ä¸‹ä¸€è¡Œæ‰§è¡Œçš„åœ°å€</li><li class=ql-align-justify>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª</li><li class=ql-align-justify>æ²¡æœ‰ OOM çš„åŒº</li></ul><p><strong>è™šæ‹Ÿæœºæ ˆ</strong></p><ul><li class=ql-align-justify>æˆ‘ä»¬å¹³æ—¶è¯´çš„æ ˆå°±æ˜¯è¿™å—åŒºåŸŸ</li><li class=ql-align-justify>java è™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰äº† OutOfMemeory , stackoverflow å¼‚å¸¸</li></ul><p><strong>æœ¬åœ°æ–¹æ³•æ ˆ</strong></p><ul><li class=ql-align-justify>java è™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰äº† OutOfMemory ï¼Œstackoverflow å¼‚å¸¸</li></ul><p><strong>æ³¨æ„</strong></p><ul><li class=ql-align-justify>åœ¨ hotspotVM ä¸­æŠŠè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆåˆä¸ºäº†ä¸€ä¸ªæ ˆåŒº</li></ul><p><strong>çº¿ç¨‹å…±äº«åŒº</strong></p><p><strong>æ–¹æ³•åŒº</strong></p><ul><li class=ql-align-justify>ClassLoader åŠ è½½ç±»ä¿¡æ¯</li><li class=ql-align-justify>å¸¸é‡ã€é™æ€å˜é‡</li><li class=ql-align-justify>ç¼–è¯‘åçš„ä»£ç </li><li class=ql-align-justify>ä¼šå‡ºç° OOM</li><li class=ql-align-justify>è¿è¡Œæ—¶å¸¸é‡æ± </li><li class="ql-align-justify ql-indent-1">public static final</li><li class="ql-align-justify ql-indent-1">ç¬¦å·å¼•ç”¨ç±»ã€æ¥å£å…¨åã€æ–¹æ³•å</li></ul><p><strong>java å † (æœ¬æ¬¡éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹)</strong></p><ul><li class=ql-align-justify>è™šæ‹Ÿæœºèƒ½ç®¡ç†çš„æœ€å¤§çš„ä¸€å—å†…å­˜ GC ä¸»æˆ˜åœº</li><li class=ql-align-justify>ä¼šå‡ºç° OOM</li><li class=ql-align-justify>å¯¹è±¡å®ä¾‹</li><li class=ql-align-justify>æ•°æ®çš„å†…å®¹</li></ul><p><em>3</em></p><p>JAVA GC å¦‚ä½•ç¡®å®šå†…å­˜å›æ”¶</p><p class=ql-align-justify><br></p><p>éšç€ç¨‹åºçš„è¿è¡Œï¼Œå†…å­˜ä¸­çš„å®ä¾‹å¯¹è±¡ã€å˜é‡ç­‰å æ®çš„å†…å­˜è¶Šæ¥è¶Šå¤šï¼Œå¦‚æœä¸åŠæ—¶è¿›è¡Œå›æ”¶ï¼Œä¼šé™ä½ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œç”šè‡³å¼•å‘ç³»ç»Ÿå¼‚å¸¸ã€‚</p><p>ç›®å‰è™šæ‹ŸæœºåŸºæœ¬éƒ½æ˜¯é‡‡ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•ï¼Œä¸ºä»€ä¹ˆä¸é‡‡ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•å‘¢ï¼Ÿä¸‹é¢å°±è¯´è¯´å¼•ç”¨è®¡æ•°æ³•æ˜¯å¦‚æœç»Ÿè®¡æ‰€æœ‰å¯¹è±¡çš„å¼•ç”¨è®¡æ•°çš„ï¼Œå†å¯¹æ¯”å¯è¾¾æ€§åˆ†æç®—æ³•æ˜¯å¦‚ä½•è§£å†³å¼•ç”¨è®¡æ•°ç®—æ³•çš„ä¸è¶³ã€‚ä¸‹é¢å°±æ¥çœ‹ä¸‹è¿™ 2 ä¸ªç®—æ³•ï¼š</p><p><strong>å¼•ç”¨è®¡æ•°ç®—æ³•</strong></p><p>æ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå½“å¯¹è±¡è¢«å¼•ç”¨ä¸€æ¬¡åˆ™è®¡æ•°å™¨åŠ ä¸€ï¼Œå½“å¯¹è±¡å¼•ç”¨ä¸€æ¬¡å¤±æ•ˆä¸€æ¬¡åˆ™è®¡æ•°å™¨å‡ä¸€ï¼Œå¯¹äºè®¡æ•°å™¨ä¸º 0 çš„æ—¶å€™å°±æ„å‘³ç€æ˜¯åƒåœ¾äº†ï¼Œå¯ä»¥è¢« GC å›æ”¶ã€‚</p><p>ä¸‹é¢é€šè¿‡ä¸€æ®µä»£ç æ¥å®é™…çœ‹ä¸‹</p><pre>public class GCTest { private Object instace = null; public static void onGCtest() { //step 1 GCTest gcTest1 = new GCTest(); //step 2 GCTest gcTest2 = new GCTest(); //step 3 gcTest1.instace = gcTest2; //step 4 gcTest2.instace = gcTest1; //step 5 gcTest1 = null; //step 6 gcTest2 = null; } public static void main(String[] arg) { onGCtest(); }}</pre><p>åˆ†æä»£ç </p><pre>//step 1 gcTest1 å¼•ç”¨ + 1 = 1//step 2 gcTest2 å¼•ç”¨ + 1 = 1//step 3 gcTest1 å¼•ç”¨ + 1 = 2//step 4 gcTest2 å¼•ç”¨ + 1 = 2//step 5 gcTest1 å¼•ç”¨ - 1 = 1//step 6 gcTest2 å¼•ç”¨ - 1 = 1</pre><p>å¾ˆæ˜æ˜¾ç°åœ¨ 2 ä¸ªå¯¹è±¡éƒ½ä¸èƒ½ç”¨äº†éƒ½ä¸º null äº†ï¼Œä½†æ˜¯ GC ç¡®ä¸èƒ½å›æ”¶å®ƒä»¬ï¼Œå› ä¸ºå®ƒä»¬æœ¬èº«çš„å¼•ç”¨è®¡æ•°ä¸ä¸º 0 ã€‚ä¸èƒ½æ»¡è¶³è¢«å›æ”¶çš„æ¡ä»¶ï¼Œå°½ç®¡è°ƒç”¨ System.gc() ä¹Ÿè¿˜æ˜¯ä¸èƒ½å¾—åˆ°å›æ”¶, è¿™å°±é€ æˆäº† å†…å­˜æ³„æ¼ ã€‚å½“ç„¶ï¼Œç°åœ¨è™šæ‹ŸæœºåŸºæœ¬ä¸Šéƒ½ä¸é‡‡ç”¨æ­¤æ–¹å¼ã€‚</p><p><strong>å¯è¾¾æ€§åˆ†æç®—æ³•</strong></p><p class=ql-align-justify><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/49cff1bab43b4b029723f9d52d1f4b6b><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p>ä» GC Roots ä½œä¸ºèµ·ç‚¹å¼€å§‹æœç´¢ï¼Œé‚£ä¹ˆæ•´ä¸ªè¿é€šå›¾ä¸­é¢å¯¹è±¡è¾¹éƒ½æ˜¯æ´»å¯¹è±¡ï¼Œå¯¹äº GC Roots æ— æ³•åˆ°è¾¾çš„å¯¹è±¡ä¾¿æˆäº†åƒåœ¾å›æ”¶çš„å¯¹è±¡ï¼Œéšæ—¶å¯èƒ½è¢« GC å›æ”¶ã€‚</p><p><strong>å¯ä»¥ä½œä¸º GC Roots çš„å¯¹è±¡</strong></p><ul><li class=ql-align-justify>è™šæ‹Ÿæœºæ ˆæ­£åœ¨è¿è¡Œä½¿ç”¨çš„å¼•ç”¨</li><li class=ql-align-justify>é™æ€å±æ€§ å¸¸é‡</li><li class=ql-align-justify>JNI å¼•ç”¨çš„å¯¹è±¡</li></ul><p>GC æ˜¯éœ€è¦ 2 æ¬¡æ‰«ææ‰å›æ”¶å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ finalize å»æ•‘æ´»ä¸¢å¤±çš„å¼•ç”¨</p><p>@Override</p><p>protected void finalize() throws Throwable {</p><p>super.finalize();</p><p>instace = this;</p><p>}</p><p><strong>åˆ°äº†è¿™é‡Œï¼Œç›¸ä¿¡å¤§å®¶å·²ç»èƒ½å¤Ÿå¼„æ˜ç™½è¿™ 2 ä¸ªç®—æ³•çš„åŒºåˆ«äº†å§ï¼Ÿåæ­£å¯¹äºå¯¹è±¡ä¹‹é—´å¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼Œå¼•ç”¨è®¡æ•°ç®—æ³•æ— æ³•å›æ”¶è¿™ 2 ä¸ªå¯¹è±¡ï¼Œè€Œå¯è¾¾æ€§æ˜¯ä» GC Roots å¼€å§‹æœç´¢ï¼Œæ‰€ä»¥èƒ½å¤Ÿæ­£ç¡®çš„å›æ”¶ã€‚</strong></p><p><strong>ä¸åŒå¼•ç”¨ç±»å‹çš„å›æ”¶çŠ¶æ€</strong></p><p><strong>å¼ºå¼•ç”¨</strong></p><pre>Object strongReference = new Object()</pre><p>å¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨ï¼Œé‚£åƒåœ¾å›æ”¶å™¨ç»ä¸ä¼šå›æ”¶å®ƒï¼Œå½“å†…å­˜ç©ºé—´ä¸è¶³ï¼Œ Java è™šæ‹Ÿæœºå®æ„¿æŠ›å‡º OOM é”™è¯¯ï¼Œä½¿ç¨‹åºå¼‚å¸¸ Crash ,ä¹Ÿä¸ä¼šé éšæ„å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡æ¥è§£å†³å†…å­˜ä¸è¶³çš„é—®é¢˜.å¦‚æœå¼ºå¼•ç”¨å¯¹è±¡ä¸å†ä½¿ç”¨æ—¶ï¼Œéœ€è¦å¼±åŒ–ä»è€Œä½¿ GC èƒ½å¤Ÿå›æ”¶ï¼Œéœ€è¦ï¼š</p><pre>strongReference = null; //ç­‰ GC æ¥å›æ”¶</pre><p>è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå¦‚æœï¼š</p><p>public void onStrongReference(){</p><p>Object strongReference = new Object()</p><p>}</p><p>åœ¨ onStrongReference() å†…éƒ¨æœ‰ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨ä¿å­˜åœ¨ java æ ˆ ä¸­ï¼Œè€ŒçœŸæ­£çš„å¼•ç”¨å†…å®¹ ï¼ˆObjectï¼‰ä¿å­˜åœ¨ java å †ä¸­ã€‚å½“è¿™ä¸ªæ–¹æ³•è¿è¡Œå®Œæˆåï¼Œå°±ä¼šé€€å‡ºæ–¹æ³•æ ˆï¼Œåˆ™å¼•ç”¨å¯¹è±¡çš„å¼•ç”¨æ•°ä¸º 0 ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè¢«å›æ”¶ã€‚</p><p>ä½†æ˜¯å¦‚æœ mStrongReference å¼•ç”¨æ˜¯å…¨å±€æ—¶ï¼Œå°±éœ€è¦åœ¨ä¸ç”¨è¿™ä¸ªå¯¹è±¡æ—¶èµ‹å€¼ä¸º null ,å› ä¸º å¼ºå¼•ç”¨ ä¸ä¼šè¢« GC å›æ”¶ã€‚</p><p><strong>è½¯å¼•ç”¨ (SoftReference)</strong></p><p>å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰è½¯å¼•ç”¨ï¼Œåˆ™å†…å­˜ç©ºé—´è¶³å¤Ÿï¼Œåƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šå›æ”¶å®ƒï¼›å¦‚æœå†…å­˜ç©ºé—´ä¸è¶³äº†ï¼Œå°±ä¼šå›æ”¶è¿™äº›å¯¹è±¡çš„å†…å­˜ï¼Œåªè¦åƒåœ¾å›æ”¶å™¨æ²¡æœ‰å›æ”¶å®ƒï¼Œè¯¥å¯¹è±¡å°±å¯ä»¥è¢«ç¨‹åºä½¿ç”¨ã€‚è½¯å¼•ç”¨å¯ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„é«˜é€Ÿç¼“å­˜ã€‚</p><p>è½¯å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ï¼Œå¦‚æœè½¯å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œ java è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªè½¯å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚</p><p class=ql-align-justify><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/988e68428d6a46db9ec92ebd4dfec843><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p>æ³¨æ„: è½¯å¼•ç”¨å¯¹è±¡æ˜¯åœ¨ jvm å†…å­˜ä¸å¤Ÿçš„æ—¶å€™æ‰ä¼šè¢«å›æ”¶ï¼Œæˆ‘ä»¬è°ƒç”¨ System.gc() æ–¹æ³•åªæ˜¯èµ·é€šçŸ¥ä½œç”¨ï¼Œ JVM ä»€ä¹ˆæ—¶å€™æ‰«æå›æ”¶å¯¹è±¡æ˜¯ JVM è‡ªå·±çš„çŠ¶æ€å†³å®šçš„ã€‚å°±ç®—æ‰«æåˆ°äº† str è¿™ä¸ªå¯¹è±¡ä¹Ÿä¸ä¼šå›æ”¶ï¼Œåªæœ‰å†…å­˜ä¸è¶³æ‰ä¼šå›æ”¶ã€‚</p><p><strong>å¼±å¼•ç”¨ (WeakReference)</strong></p><p>å¼±å¼•ç”¨ä¸è½¯å¼•ç”¨çš„åŒºåˆ«åœ¨äº: åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒæ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ä¸è¿‡ç”±äºåƒåœ¾å›æ”¶å™¨æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆä½çš„çº¿ç¨‹ï¼Œå› æ­¤ä¸ä¸€å®šä¼šå¾ˆå¿«å‘ç°é‚£äº›åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚</p><p>å¼±å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—è”åˆä½¿ç”¨ï¼Œå¦‚æœå¼±å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ŒJava è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªå¼±å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚</p><p class=ql-align-justify><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9e84492935954e3981607752273b090e><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p>å¯è§ weakReference å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåŸºæœ¬ç”± GC å†³å®šï¼Œä¸€æ—¦ GC çº¿ç¨‹å‘ç°äº†å¼±å¼•ç”¨å°±æ ‡è®°ä¸‹æ¥ï¼Œç¬¬äºŒæ¬¡æ‰«æåˆ°å°±ç›´æ¥å›æ”¶äº†ã€‚</p><p>æ³¨æ„è¿™é‡Œçš„ referenceQueuee æ˜¯è£…çš„è¢«å›æ”¶çš„å¯¹è±¡ã€‚</p><p><strong>è™šå¼•ç”¨ (PhantomReference)</strong></p><pre> @Test public void onPhantomReference()throws InterruptedException{ String str = new String("123456"); ReferenceQueue queue = new ReferenceQueue(); // åˆ›å»ºè™šå¼•ç”¨ï¼Œè¦æ±‚å¿…é¡»ä¸ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—å…³è” PhantomReference pr = new PhantomReference(str, queue); System.out.println("PhantomReference:" + pr.get()); System.out.printf("ReferenceQueue:" + queue.poll()); }</pre><p>è™šå¼•ç”¨é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å½¢åŒè™šè®¾ï¼Œä¸å…¶ä»–å‡ ç§å¼•ç”¨éƒ½ä¸åŒï¼Œè™šå¼•ç”¨å¹¶ä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</p><p>è™šå¼•ç”¨ä¸»è¦ç”¨æ¥è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶çš„æ´»åŠ¨ã€‚è™šå¼•ç”¨ä¸è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„ä¸€ä¸ªåŒºåˆ«åœ¨äº: è™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ— (ReferenceQueue) è”åˆä½¿ç”¨ã€‚å½“åƒåœ¾å›æ”¶å™¨å‡†å¤‡å›æ”¶ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœå‘ç°å®ƒè¿˜æœ‰è™šå¼•ç”¨ï¼Œå°±ä¼šåœ¨å›æ”¶å¯¹è±¡çš„å†…å­˜ä¹‹å‰ï¼ŒæŠŠè¿™ä¸ªè™šå¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚</p><p><strong>æ€»ç»“</strong></p><p>å¼•ç”¨ç±»å‹è°ƒç”¨æ–¹å¼GCæ˜¯å¦å†…å­˜æ³„æ¼å¼ºå¼•ç”¨ç›´æ¥è°ƒç”¨ä¸å›æ”¶æ˜¯è½¯å¼•ç”¨.get()è§†å†…å­˜æƒ…å†µå›æ”¶å¦å¼±å¼•ç”¨.get()å›æ”¶ä¸å¯èƒ½è™šå¼•ç”¨nullä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«å›æ”¶ï¼Œç›¸å½“äºæ²¡æœ‰å¼•ç”¨ä¸€æ ·å¦</p><p><em>4</em></p><p>åˆ†æå†…å­˜å¸¸ç”¨å·¥å…·</p><p>å·¥å…·å¾ˆå¤šï¼ŒæŒæ¡åŸç†æ–¹æ³•ï¼Œå·¥å…·éšæ„æŒ‘é€‰ä½¿ç”¨ã€‚</p><ul><li class=ql-align-justify>top/procrank</li><li class=ql-align-justify>meinfo</li><li class=ql-align-justify>Procstats</li><li class=ql-align-justify>DDMS</li><li class=ql-align-justify>MAT</li><li class=ql-align-justify>Finder - Activity</li><li class=ql-align-justify>LeakCanary</li><li class=ql-align-justify>LeakInspector</li></ul><p><em>5</em></p><p>å†…å­˜æ³„éœ²</p><p class=ql-align-justify><br></p><p>äº§ç”Ÿçš„åŸå› : ä¸€ä¸ªé•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æŒæœ‰ä¸€ä¸ªçŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„å¼•ç”¨ï¼Œé€šä¿—ç‚¹è®²å°±æ˜¯è¯¥å›æ”¶çš„å¯¹è±¡ï¼Œå› ä¸ºå¼•ç”¨é—®é¢˜æ²¡æœ‰è¢«å›æ”¶ï¼Œæœ€ç»ˆä¼šäº§ç”Ÿ OOMã€‚</p><p><strong>ä¸‹é¢æˆ‘ä»¬æ¥åˆ©ç”¨ Profile æ¥æ£€æŸ¥é¡¹ç›®æ˜¯å¦æœ‰å†…å­˜æ³„æ¼</strong></p><p>æ€ä¹ˆåˆ©ç”¨ profile æ¥æŸ¥çœ‹é¡¹ç›®ä¸­æ˜¯å¦æœ‰å†…å­˜æ³„æ¼</p><p>1. åœ¨ AS ä¸­é¡¹ç›®ä»¥ profile è¿è¡Œ</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a926242dca6e4c0cab955ece7eeb6de0><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>2.åœ¨ MEMORY ç•Œé¢ä¸­é€‰æ‹©è¦åˆ†æçš„ä¸€æ®µå†…å­˜ï¼Œå³é”® export</p><p class=ql-align-justify><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f15ed99d32374774baad73b684563959><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p>Allocations: åŠ¨æ€åˆ†é…å¯¹è±¡ä¸ªæ•°</p><p>Deallocation: è§£é™¤åˆ†é…çš„å¯¹è±¡ä¸ªæ•°</p><p>Total count: å¯¹è±¡çš„æ€»æ•°</p><p>Shalow Size: å¯¹è±¡æœ¬èº«å ç”¨çš„å†…å­˜å¤§å°</p><p>Retained Size: GC å›æ”¶èƒ½æ”¶èµ°çš„å†…å­˜å¤§å°</p><p>3. è½¬æ¢ profile æ–‡ä»¶æ ¼å¼</p><p>å°† export å¯¼å‡ºçš„ dprof æ–‡ä»¶è½¬æ¢ä¸º Mat çš„ dprof æ–‡ä»¶</p><p>cd /d è¿›å…¥åˆ° Android sdk/platform-tools/hprof-conv.exe</p><pre>//è½¬æ¢å‘½ä»¤ hprof-conv -z src desD:\Android\AndroidDeveloper-sdk\android-sdk-windows\platform-tools&gt;hprof-conv -z D:\temp_\temp_6.hprof D:\temp_\memory6.hprod</pre><p>4. ä¸‹è½½ Mat å·¥å…·</p><p><em>https://www.eclipse.org/mat/downloads.php</em></p><p>5. æ‰“å¼€ MemoryAnalyzer.exe ç‚¹å‡»å·¦ä¸Šè§’ File èœå•ä¸­çš„ Open Heap Dump</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/eb9faeb0af954249b71c7b8e17227692><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>6. æŸ¥çœ‹å†…å­˜æ³„æ¼ä¸­çš„ GC Roots å¼ºå¼•ç”¨</p><p class=ql-align-justify><br></p><p class=ql-align-center><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/28b5ea127fc946e892ea3028eb476c79><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><p>è¿™é‡Œæˆ‘ä»¬å¾—çŸ¥æ˜¯ä¸€ä¸ª ilsLoginListener å¼•ç”¨äº† LoginView,æˆ‘ä»¬æ¥çœ‹ä¸‹ä»£ç æœ€åæ€ä¹ˆè§£å†³çš„ã€‚</p><p class=ql-align-justify><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/45ec2cd1606f42dca02a6b93ac79a2dc><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p>ä»£ç ä¸­æˆ‘ä»¬æ‰¾åˆ°äº† LoginView è¿™ä¸ªç±»ï¼Œå‘ç°æ˜¯ä¸€ä¸ªå•ä¾‹ä¸­çš„å›è°ƒå¼•èµ·çš„å†…å­˜æ³„æ¼ï¼Œä¸‹é¢æ€ä¹ˆè§£å†³å‹’ï¼Œè¯·çœ‹ç¬¬ä¸ƒå°ç‚¹ã€‚</p><p><strong>2ç§è§£å†³å•ä¾‹ä¸­çš„å†…å­˜æ³„æ¼</strong></p><p>a. å°†å¼•ç”¨ç½®ä¸º null</p><pre>/** * é”€æ¯ç›‘å¬ */public void unRemoveRegisterListener(){ mMessageController.unBindListener();}public void unBindListener(){ if (listener != null){ listener = null; }}</pre><p>b. ä½¿ç”¨å¼±å¼•ç”¨</p><pre>//å°†ç›‘å¬å™¨æ”¾å…¥å¼±å¼•ç”¨ä¸­WeakReference&lt;IBinderServiceListener&gt; listenerWeakReference = new WeakReference&lt;&gt;(listener);//ä»å¼±å¼•ç”¨ä¸­å–å‡ºå›è°ƒlistenerWeakReference.get()ï¼›</pre><p>é€šè¿‡ç¬¬ä¸ƒå°ç‚¹å°±èƒ½å®Œç¾çš„è§£å†³å•ä¾‹ä¸­å›è°ƒå¼•èµ·çš„å†…å­˜æ³„æ¼ã€‚</p><p><strong>Android ä¸­å¸¸è§çš„å†…å­˜æ³„æ¼ç»å…¸æ¡ˆä¾‹åŠè§£å†³æ–¹æ³•</strong></p><p><strong>å•ä¾‹</strong></p><p>ç¤ºä¾‹ :</p><pre>public class AppManager { private static AppManager sInstance; private CallBack mCallBack; private Context mContext; private AppManager(Context context) { this.mContext = context; } public static AppManager getInstance(Context context) { if (sInstance == null) { sInstance = new AppManager(context); } return sInstance; } public void addCallBack(CallBack call){ mCallBack = callï¼› }}</pre><p class=ql-align-justify>1. é€šè¿‡ä¸Šé¢çš„å•åˆ—ï¼Œå¦‚æœ context ä¼ å…¥çš„æ˜¯ Activity , Service çš„ thisï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p class=ql-align-justify>ä»¥ Activity ä¸ºä¾‹ï¼Œå½“ Activity è°ƒç”¨ getInstance ä¼ å…¥ this ï¼Œé‚£ä¹ˆ sInstance å°±ä¼šæŒæœ‰ Activity çš„å¼•ç”¨ï¼Œå½“ Activity éœ€è¦å…³é—­çš„æ—¶å€™éœ€è¦ å›æ”¶çš„æ—¶å€™ï¼Œå‘ç° sInstance è¿˜æŒæœ‰ æ²¡æœ‰ç”¨çš„ Activity å¼•ç”¨ï¼Œå¯¼è‡´ Activity æ— æ³•è¢« GC å›æ”¶ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼</p><p class=ql-align-justify>2. addCallBack(CallBack call) è¿™æ ·å†™çœ‹èµ·æ¥æ˜¯æ²¡æœ‰æ¯›ç—…çš„ã€‚ä½†æ˜¯å½“è¿™æ ·è°ƒç”¨åœ¨çœ‹ä¸€ä¸‹å‹’ã€‚</p><pre>//åœ¨ Activity ä¸­å®ç°å•ä¾‹çš„å›è°ƒAppManager.getInstance(getAppcationContext()).addCallBack(new CallBack(){ @Override public void onStart(){ }})ï¼›</pre><p class=ql-align-justify>è¿™é‡Œçš„ new CallBack() åŒ¿åå†…éƒ¨ç±» é»˜è®¤æŒæœ‰å¤–éƒ¨çš„å¼•ç”¨ï¼Œé€ æˆ CallBack é‡Šæ”¾ä¸äº†ï¼Œé‚£ä¹ˆæ€ä¹ˆè§£å†³äº†ï¼Œè¯·çœ‹ä¸‹é¢è§£å†³æ–¹æ³•ã€‚</p><p class=ql-align-justify><strong>è§£å†³æ–¹æ³•:</strong></p><p class=ql-align-justify>1. getInstance(Context context) context éƒ½ä¼ å…¥ Appcation çº§åˆ«çš„ Context,æˆ–è€…å®åœ¨æ˜¯éœ€è¦ä¼ å…¥ Activity çš„å¼•ç”¨å°±ç”¨ WeakReference è¿™ç§å½¢å¼ã€‚</p><p class=ql-align-justify>2. åŒ¿åå†…éƒ¨ç±»å»ºè®®å¤§å®¶å•ç‹¬å†™ä¸€ä¸ªæ–‡ä»¶æˆ–è€…</p><pre>public void addCallBack(CallBack call){ WeakReference&lt;CallBack&gt; mCallBack= new WeakReference&lt;CallBack&gt;(call)ï¼› }</pre><p><strong>Handler</strong></p><p>ç¤ºä¾‹:</p><p>//åœ¨ Activity ä¸­å®ç° Handler</p><p>class MyHandler extends Handler{</p><p>private Activity m;</p><p>public MyHandler(Activity activity){</p><p>m=activity;</p><p>}</p><p>// class.....</p><p>}</p><p>è¿™é‡Œçš„ MyHandler æŒæœ‰ activity çš„å¼•ç”¨ï¼Œå½“ Activity é”€æ¯çš„æ—¶å€™ï¼Œå¯¼è‡´ GC ä¸ä¼šå›æ”¶é€ æˆ å†…å­˜æ³„æ¼ã€‚</p><p>è§£å†³æ–¹æ³•:</p><p>1.ä½¿ç”¨é™æ€å†…éƒ¨ç±» + å¼±å¼•ç”¨</p><p>2.åœ¨ Activity onDestoty() ä¸­å¤„ç† removeCallbacksAndMessages()</p><p>@Override</p><p>protected void onDestroy() {</p><p>super.onDestroy();</p><p>if(null != handler){</p><p>handler.removeCallbacksAndMessages(null);</p><p>handler = null;</p><p>}</p><p>}</p><p><strong>é™æ€å˜é‡</strong></p><p>ç¤ºä¾‹:</p><pre>public class MainActivity extends AppCompatActivity { private static Police sPolice; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); if (sPolice != null) { sPolice = new Police(this); } }}class Police { public Police(Activity activity) { }}</pre><p>è¿™é‡Œ Police æŒæœ‰ activity çš„å¼•ç”¨ï¼Œä¼šé€ æˆ activity å¾—ä¸åˆ°é‡Šæ”¾ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p>è§£å†³æ–¹æ³•:</p><pre>//1. sPolice åœ¨ onDestoryï¼ˆï¼‰ä¸­ sPolice = null;//2. åœ¨ Police æ„é€ å‡½æ•°ä¸­ å°†å¼ºå¼•ç”¨ to å¼±å¼•ç”¨ï¼›</pre><p><strong>éé™æ€å†…éƒ¨ç±»</strong></p><p>å‚è€ƒ ç¬¬äºŒç‚¹ Handler çš„å¤„ç†æ–¹å¼</p><p><strong>åŒ¿åå†…éƒ¨ç±»</strong></p><p>ç¤ºä¾‹:</p><p>public class MainActivity extends AppCompatActivity {</p><p>@Override</p><p>protected void onCreate(Bundle savedInstanceState) {</p><p>super.onCreate(savedInstanceState);</p><p>setContentView(R.layout.activity_main);</p><p>new Thread(){</p><p>@Override</p><p>public void run() {</p><p>super.run();</p><p>}</p><p>};</p><p>}</p><p>}</p><p>å¾ˆå¤šåˆå­¦è€…éƒ½ä¼šåƒä¸Šé¢è¿™æ ·æ–°å»ºçº¿ç¨‹å’Œå¼‚æ­¥ä»»åŠ¡ï¼Œæ®Šä¸çŸ¥è¿™æ ·çš„å†™æ³•éå¸¸åœ°ä¸å‹å¥½ï¼Œè¿™ç§æ–¹å¼æ–°å»ºçš„å­çº¿ç¨‹Threadå’ŒAsyncTaskéƒ½æ˜¯åŒ¿åå†…éƒ¨ç±»å¯¹è±¡ï¼Œé»˜è®¤å°±éšå¼çš„æŒæœ‰å¤–éƒ¨Activityçš„å¼•ç”¨ï¼Œå¯¼è‡´Activityå†…å­˜æ³„éœ²ã€‚</p><p>è§£å†³æ–¹æ³•:</p><pre>//é™æ€å†…éƒ¨ç±» + å¼±å¼•ç”¨//å•ç‹¬å†™ä¸€ä¸ªæ–‡ä»¶ + onDestory = null;</pre><p><strong>æœªå–æ¶ˆæ³¨å†Œæˆ–å›è°ƒ</strong></p><p>ç¤ºä¾‹:</p><pre>public class MainActivity extends AppCompatActivity { @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); registerReceiver(mReceiver, new IntentFilter()); } private BroadcastReceiver mReceiver = new BroadcastReceiver() { @Override public void onReceive(Context context, Intent intent) { // TODO ------ } };}</pre><p>åœ¨æ³¨å†Œè§‚å¯Ÿåˆ™æ¨¡å¼çš„æ—¶å€™ï¼Œå¦‚æœä¸åŠæ—¶å–æ¶ˆä¹Ÿä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚æ¯”å¦‚ä½¿ç”¨Retrofit + RxJavaæ³¨å†Œç½‘ç»œè¯·æ±‚çš„è§‚å¯Ÿè€…å›è°ƒï¼ŒåŒæ ·ä½œä¸ºåŒ¿åå†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨å¼•ç”¨ï¼Œæ‰€ä»¥éœ€è¦è®°å¾—åœ¨ä¸ç”¨æˆ–è€…é”€æ¯çš„æ—¶å€™å–æ¶ˆæ³¨å†Œã€‚</p><p>è§£å†³æ–¹æ³•:</p><pre>//Activity ä¸­å®ç° onDestoryï¼ˆï¼‰åæ³¨å†Œå¹¿æ’­å¾—åˆ°é‡Šæ”¾ @Override protected void onDestroy() { super.onDestroy(); this.unregisterReceiver(mReceiver); }</pre><p><strong>å®šæ—¶ä»»åŠ¡</strong></p><p>ç¤ºä¾‹:</p><pre>public class MainActivity extends AppCompatActivity { /**æ¨¡æ‹Ÿè®¡æ•°*/ private int mCount = 1; private Timer mTimer; private TimerTask mTimerTask; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); init(); mTimer.schedule(mTimerTask, 1000, 1000); } private void init() { mTimer = new Timer(); mTimerTask = new TimerTask() { @Override public void run() { MainActivity.this.runOnUiThread(new Runnable() { @Override public void run() { addCount(); } }); } }; } private void addCount() { mCount += 1; }}</pre><p>å½“æˆ‘ä»¬Activityé”€æ¯çš„æ—¶ï¼Œæœ‰å¯èƒ½Timerè¿˜åœ¨ç»§ç»­ç­‰å¾…æ‰§è¡ŒTimerTaskï¼Œå®ƒæŒæœ‰Activity çš„å¼•ç”¨ä¸èƒ½è¢« GC å›æ”¶ï¼Œå› æ­¤å½“æˆ‘ä»¬ Activity é”€æ¯çš„æ—¶å€™è¦ç«‹å³cancelæ‰Timerå’ŒTimerTaskï¼Œä»¥é¿å…å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚</p><p>è§£å†³æ–¹æ³•:</p><pre>//å½“ Activity å…³é—­çš„æ—¶å€™ï¼Œåœæ­¢ä¸€åˆ‡æ­£åœ¨è¿›è¡Œä¸­çš„å®šæ—¶ä»»åŠ¡ï¼Œé¿å…é€ æˆå†…å­˜æ³„æ¼ã€‚ private void stopTimer() { if (mTimer != null) { mTimer.cancel(); mTimer = null; } if (mTimerTask != null) { mTimerTask.cancel(); mTimerTask = null; } } @Override protected void onDestroy() { super.onDestroy(); stopTimer(); }</pre><p><strong>èµ„æºæœªå…³é—­</strong></p><p>ç¤ºä¾‹:</p><p>ArrayList,HashMap,IO,File,SqLite,Cursor ç­‰èµ„æºç”¨å®Œä¸€å®šè¦è®°å¾— clear remove ç­‰å…³é—­ä¸€ç³»åˆ—å¯¹èµ„æºçš„æ“ä½œã€‚</p><p>è§£å†³æ–¹æ³•:</p><p>ç”¨å®Œå³åˆ»é”€æ¯</p><p><strong>å±æ€§åŠ¨ç”»</strong></p><p>ç¤ºä¾‹:</p><pre>åŠ¨ç”»åŒæ ·æ˜¯ä¸€ä¸ªè€—æ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚åœ¨ Activity ä¸­å¯åŠ¨äº†å±æ€§åŠ¨ç”» (ObjectAnimator) ï¼Œä½†æ˜¯åœ¨é”€æ¯çš„æ—¶å€™ï¼Œæ²¡æœ‰è°ƒç”¨ cancle æ–¹æ³•ï¼Œè™½ç„¶æˆ‘ä»¬çœ‹ä¸åˆ°åŠ¨ç”»äº†ï¼Œä½†æ˜¯è¿™ä¸ªåŠ¨ç”»ä¾ç„¶ä¼šä¸æ–­åœ°æ’­æ”¾ä¸‹å»ï¼ŒåŠ¨ç”»å¼•ç”¨æ‰€åœ¨çš„æ§ä»¶ï¼Œæ‰€åœ¨çš„æ§ä»¶å¼•ç”¨ Activity ï¼Œè¿™å°±é€ æˆ Activity æ— æ³•æ­£å¸¸é‡Šæ”¾ã€‚å› æ­¤åŒæ ·è¦åœ¨Activity é”€æ¯çš„æ—¶å€™ cancel æ‰å±æ€§åŠ¨ç”»ï¼Œé¿å…å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚</pre><p>è§£å†³æ–¹æ³•:</p><pre>@Overrideprotected void onDestroy() { super.onDestroy(); //å½“å…³é—­ Activity çš„æ—¶å€™è®°å¾—å…³é—­åŠ¨ç”»çš„æ“ä½œ mAnimator.cancel();}</pre><p><em>6</em></p><p>å†…å­˜æŠ–åŠ¨</p><p class=ql-align-justify><br></p><p><strong>ä»€ä¹ˆæ˜¯å†…å­˜æŠ–åŠ¨</strong></p><p>å†…å­˜é¢‘ç¹çš„åˆ†é…ä¸å›æ”¶,(åˆ†é…é€Ÿåº¦å¤§äºå›æ”¶é€Ÿåº¦æ—¶) æœ€ç»ˆäº§ç”Ÿ OOM ã€‚</p><p><strong>ä¹Ÿè®¸ä¸‹é¢çš„å½•å±æ›´èƒ½è§£é‡Šä»€ä¹ˆæ˜¯å†…å­˜æŠ–åŠ¨</strong></p><p class=ql-align-justify><br></p><p class=ql-align-center><br></p><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a830a5b3e6d44fa497a09b720cb8e34f><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><p>å¯ä»¥çœ‹å‡ºå½“æˆ‘ç‚¹å‡»äº†ä¸€ä¸‹ Button å†…å­˜å°±é¢‘ç¹çš„åˆ›å»ºå¹¶å›æ”¶ï¼ˆæ³¨æ„çœ‹åƒåœ¾æ¡¶ï¼‰ã€‚</p><p><strong>é‚£ä¹ˆæˆ‘ä»¬æ‰¾å‡ºä»£ç ä¸­å…·ä½“é‚£ä¸€å—å‡ºç°é—®é¢˜äº†å‹’ï¼Œè¯·çœ‹ä¸‹é¢ä¸€æ®µå½•å±</strong></p><pre>mButton.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { imPrettySureSortingIsFree(); } });/** *â€ƒæ’åºåæ‰“å°äºŒç»´æ•°ç»„ï¼Œä¸€è¡Œè¡Œæ‰“å° */ public void imPrettySureSortingIsFree() { int dimension = 300; int[][] lotsOfInts = new int[dimension][dimension]; Random randomGenerator = new Random(); for (int i = 0; i &lt; lotsOfInts.length; i++) { for (int j = 0; j &lt; lotsOfInts[i].length; j++) { lotsOfInts[i][j] = randomGenerator.nextInt(); } } for (int i = 0; i &lt; lotsOfInts.length; i++) { String rowAsStr = ""; //æ’åº int[] sorted = getSorted(lotsOfInts[i]); //æ‹¼æ¥æ‰“å° for (int j = 0; j &lt; lotsOfInts[i].length; j++) { rowAsStr += sorted[j]; if (j &lt; (lotsOfInts[i].length - 1)) { rowAsStr += ", "; } } Log.i("ricky", "Row " + i + ": " + rowAsStr); } }</pre><div class=pgc-img><img alt=è€ç”Ÿå¸¸è°ˆçš„å†…å­˜é—®é¢˜ä½ è¿˜æ˜¯å†æ¥çœ‹çœ‹å§ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4cb6f0fe696e4ffaa387fa97a7a9a24b><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p>æœ€åæˆ‘ä»¬ä¹‹åæ˜¯ onClick ä¸­çš„ imPrettySureSortingIsFree() å‡½æ•°é‡Œé¢çš„ rowAsStr += sorted[j]; å­—ç¬¦ä¸²æ‹¼æ¥é€ æˆçš„ å†…å­˜æŠ–åŠ¨ ï¼Œå› ä¸ºæ¯æ¬¡æ‹¼æ¥ä¸€ä¸ª String éƒ½ä¼šç”³è¯·ä¸€å—æ–°çš„å †å†…å­˜ï¼Œé‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™ä¸ªé¢‘ç¹å¼€è¾Ÿå†…å­˜çš„é—®é¢˜äº†ã€‚</p><p>å…¶å®åœ¨ Java ä¸­æœ‰ 2 ä¸ªæ›´å¥½çš„ API å¯¹ String çš„æ“ä½œå¾ˆå‹å¥½ï¼Œç›¸ä¿¡åº”è¯¥æœ‰äººçŒœåˆ°äº†å§ã€‚æ²¡é”™å°±æ˜¯å°† æ­¤å¤„çš„ String æ¢æˆ StringBuffer æˆ–è€… StringBuilderï¼Œå°±èƒ½å¾ˆå®Œç¾çš„è§£å†³å­—ç¬¦ä¸²æ‹¼æ¥é€ æˆçš„å†…å­˜æŠ–åŠ¨é—®é¢˜ã€‚</p><p>ä¿®æ”¹å</p><pre>/** *â€ƒæ‰“å°äºŒç»´æ•°ç»„ï¼Œä¸€è¡Œè¡Œæ‰“å° */public void imPrettySureSortingIsFree() { int dimension = 300; int[][] lotsOfInts = new int[dimension][dimension]; Random randomGenerator = new Random(); for(int i = 0; i &lt; lotsOfInts.length; i++) { for (int j = 0; j &lt; lotsOfInts[i].length; j++) { lotsOfInts[i][j] = randomGenerator.nextInt(); } } // ä½¿ç”¨StringBuilderå®Œæˆè¾“å‡ºï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å³å¯ï¼Œ ä¸éœ€è¦æµªè´¹è¿‡å¤šçš„å†…å­˜ StringBuilder sb = new StringBuilder(); String rowAsStr = ""; for(int i = 0; i &lt; lotsOfInts.length; i++) { // æ¸…é™¤ä¸Šä¸€è¡Œ sb.delete(0, rowAsStr.length()); //æ’åº int[] sorted = getSorted(lotsOfInts[i]); //æ‹¼æ¥æ‰“å° for (int j = 0; j &lt; lotsOfInts[i].length; j++) { sb.append(sorted[j]); if(j &lt; (lotsOfInts[i].length - 1)){ sb.append(", "); } } rowAsStr = sb.toString(); Log.i("jason", "Row " + i + ": " + rowAsStr); }}</pre><p>æ³¨æ„: å®é™…å¼€å‘ä¸­å¦‚æœåœ¨ LogCat ä¸­å‘ç°æœ‰è¿™äº› Log è¯´æ˜ä¹Ÿå‘ç”Ÿäº† å†…å­˜æŠ–åŠ¨ (Log ä¸­å‡ºç° concurrent copying GC freed ....)</p><p><em>7</em></p><p>æ€»ç»“</p><p class=ql-align-justify><br></p><p>åªè¦å…»æˆè¿™æ ·çš„ä¹ æƒ¯ï¼Œè‡³å°‘å¯ä»¥é¿å… 90 % ä»¥ä¸Šä¸ä¼šé€ æˆå†…å­˜å¼‚å¸¸</p><p><strong>1. æ•°æ®ç±»å‹: ä¸è¦ä½¿ç”¨æ¯”éœ€æ±‚æ›´å ç”¨ç©ºé—´çš„åŸºæœ¬æ•°æ®ç±»å‹</strong></p><p><strong>2. å¾ªç¯å°½é‡ç”¨ foreach ,å°‘ç”¨ iterator, è‡ªåŠ¨è£…ç®±ä¹Ÿå°½é‡å°‘ç”¨</strong></p><p><strong>3. æ•°æ®ç»“æ„ä¸ç®—æ³•çš„è§£åº¦å¤„ç† (æ•°ç»„ï¼Œé“¾è¡¨ï¼Œæ ˆæ ‘ï¼Œæ ‘ï¼Œå›¾)</strong></p><p>æ•°æ®é‡åƒçº§ä»¥å†…å¯ä»¥ä½¿ç”¨ Sparse æ•°ç»„ (Keyä¸ºæ•´æ•°)ï¼ŒArrayMap (Key ä¸ºå¯¹è±¡) è™½ç„¶æ€§èƒ½ä¸å¦‚ HashMap ï¼Œä½†èŠ‚çº¦å†…å­˜ã€‚</p><p><strong>4. æšä¸¾ä¼˜åŒ–</strong></p><p class=ql-align-justify>ç¼ºç‚¹:</p><p class=ql-align-justify>æ¯ä¸€ä¸ªæšä¸¾å€¼éƒ½æ˜¯ä¸€ä¸ªå•ä¾‹å¯¹è±¡,åœ¨ä½¿ç”¨å®ƒæ—¶ä¼šå¢åŠ é¢å¤–çš„å†…å­˜æ¶ˆè€—,æ‰€ä»¥æšä¸¾ç›¸æ¯”ä¸ Integer å’Œ String ä¼šå ç”¨æ›´å¤šçš„å†…å­˜.</p><p class=ql-align-justify>è¾ƒå¤šçš„ä½¿ç”¨ Enum ä¼šå¢åŠ  DEX æ–‡ä»¶çš„å¤§å°,ä¼šé€ æˆè¿è¡Œæ—¶æ›´å¤šçš„ IO å¼€é”€,ä½¿æˆ‘ä»¬çš„åº”ç”¨éœ€è¦æ›´å¤šçš„ç©ºé—´</p><p class=ql-align-justify>ç‰¹åˆ«æ˜¯åˆ† Dex å¤šçš„å¤§å‹ APPï¼Œæšä¸¾çš„åˆå§‹åŒ–å¾ˆå®¹æ˜“å¯¼è‡´ ANR.</p><p class=ql-align-justify>ä¼˜åŒ–åçš„ä»£ç :å¯ä»¥ç›´æ¥é™å®šä¼ å…¥çš„å‚æ•°ä¸ªæ•°:</p><pre>public class SHAPE { public static final int TYPE_0=0; public static final int TYPE_1=1; public static final int TYPE_2=2; public static final int TYPE_3=3; @IntDef(flag=true,value={TYPE_0,TYPE_1,TYPE_2,TYPE_3}) @Target({ElementType.PARAMETER,ElementType.METHOD,ElementType.FIELD}) @Retention(RetentionPolicy.SOURCE) public @interface Model{ } private @Model int value=TYPE_0; public void setShape(@Model int value){ this.value=value; } @Model public int getShape(){ return this.value; }}</pre><p class=ql-align-justify><br></p><p><strong>5. static , static final çš„é—®é¢˜</strong></p><p>åŸºæœ¬æ•°æ®ç±»å‹çš„æˆå‘˜ï¼Œå¯ä»¥å…¨å†™æˆ static final</p><p>static ä¼šç”±ç¼–è¯‘å™¨è°ƒç”¨ clinit æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–</p><p>static final ä¸éœ€è¦è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œæ‰“åŒ…åœ¨ dex æ–‡ä»¶ä¸­å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œå¹¶ä¸ä¼šåœ¨ç±»åˆå§‹åŒ–ç”³è¯·å†…å­˜</p><p><strong>6. å­—ç¬¦ä¸²çš„æ‹¼æ¥å°½é‡å°‘ç”¨ +=</strong></p><p><strong>7. é‡å¤ç”³è¯·å†…å­˜é—®é¢˜</strong></p><p>åŒä¸€ä¸ªæ–¹æ³•å¤šæ¬¡è°ƒç”¨ï¼Œå¦‚é€’å½’å‡½æ•° ï¼Œå›è°ƒå‡½æ•°ä¸­ new å¯¹è±¡</p><p>ä¸è¦åœ¨ onMeause() onLayout() ,onDraw() ä¸­å»åˆ·æ–°UIï¼ˆrequestLayoutï¼‰</p><p><strong>8. é¿å… GC å›æ”¶å°†æ¥è¦é‡æ–°ä½¿ç”¨çš„å¯¹è±¡ (å†…å­˜è®¾è®¡æ¨¡å¼å¯¹è±¡æ±  + LRU ç®—æ³•)</strong></p><p><strong>9. Activity ç»„ä»¶æ³„æ¼</strong></p><ul><li class=ql-align-justify>å¦‚æœå¼€å¯çš„çº¿ç¨‹éœ€è¦ä¼ å…¥å‚æ•°ï¼Œç”¨å¼±å¼•æ¥æ”¶å¯è§£å†³é—®é¢˜</li><li class=ql-align-justify>handler è®°å¾—æ¸…é™¤ removeCallbacksAndMessages(null)</li><li class=ql-align-justify>éä¸šåŠ¡éœ€è¦ä¸è¦æŠŠ activity çš„ä¸Šä¸‹æ–‡åšå‚æ•°ä¼ é€’ï¼Œå¯ä»¥ä¼ é€’ application çš„ä¸Šä¸‹æ–‡</li><li class=ql-align-justify>éé™æ€å†…éƒ¨ç±»å’ŒåŒ¿åå†…éƒ¨å†…ä¼šæŒæœ‰ activity å¼•ç”¨ï¼ˆé™æ€å†…éƒ¨ç±» æˆ–è€… å•ç‹¬å†™æ–‡ä»¶ï¼‰</li><li class=ql-align-justify>å•ä¾‹æ¨¡å¼ä¸­å›è°ƒæŒæœ‰ activity å¼•ç”¨ï¼ˆå¼±å¼•ç”¨ï¼‰</li><li class=ql-align-justify>handler.postDelayed() é—®é¢˜</li></ul><p><strong>10. Service è€—æ—¶æ“ä½œå°½é‡ä½¿ç”¨ IntentService,è€Œä¸æ˜¯ Service</strong></p><p>æ¥æºç½‘ç»œï¼Œä¾µæƒè”ç³»åˆ é™¤</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'å¸¸è°ˆ','å†…å­˜','é—®é¢˜'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>