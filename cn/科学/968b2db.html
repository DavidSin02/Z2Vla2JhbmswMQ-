<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一文概括6种负载均衡技术的实现方式！ | 极客快訊</title><meta property="og:title" content="一文概括6种负载均衡技术的实现方式！ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/ae7de60d61ec4dc0881a5bfb71c5a850"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/968b2db.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/968b2db.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/968b2db.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/968b2db.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/968b2db.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/968b2db.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/968b2db.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/968b2db.html><meta property="article:published_time" content="2020-10-29T21:03:57+08:00"><meta property="article:modified_time" content="2020-10-29T21:03:57+08:00"><meta name=Keywords content><meta name=description content="一文概括6种负载均衡技术的实现方式！"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E5%AD%A6/968b2db.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一文概括6种负载均衡技术的实现方式！</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E5%AD%A6.html>科学</a></span></div><div class=post-content><div><p class=ql-align-justify>本文作者将通过图文并茂的方式，来描述出每一种负载均衡策略的完整样貌。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae7de60d61ec4dc0881a5bfb71c5a850><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><p class=ql-align-justify>我们都对高可用有一个基本的认识，其中负载均衡是高可用的核心工作。本文将通过如下几个方面，让你妥妥的吃透“”负载均衡”。</p><ul><li class=ql-align-justify>负载均衡是什么</li><li class=ql-align-justify>常用负载均衡策略图解</li><li class=ql-align-justify>常用负载均衡策略优缺点和适用场景</li><li class=ql-align-justify>用健康探测来保障高可用</li><li class=ql-align-justify>结语</li></ul><p class=ql-align-justify><br></p><p class=ql-align-justify><strong>负载均衡是什么</strong></p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/93c35a77b8634d65ac376c5b67e08e0b><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><p class=ql-align-justify>正如上图所示的这样，由一个独立的统一入口来收敛流量，再做二次分发的过程就是负载均衡，它的本质和分布式系统一样，是分治。</p><p class=ql-align-justify>如果大家习惯了开车的时候用一些导航软件，我们会发现，导航软件的推荐路线方案会有一个数量的上限，比如 3 条、5 条。</p><p class=ql-align-justify>因此，其实本质上它也起到了一个类似负载均衡的作用，因为如果只能取 Top3 的通畅路线，自然拥堵严重的路线就无法推荐给你了，使得车流的压力被分摊到了相对空闲的路线上。</p><p class=ql-align-justify>在软件系统中也是一样的道理，为了避免流量分摊不均，造成局部节点负载过大（如 CPU 吃紧等），所以引入一个独立的统一入口来做类似上面的“导航”的工作。</p><p class=ql-align-justify>但是，软件系统中的负载均衡与导航的不同在于：导航是一个柔性策略，最终还是需要使用者做选择，而前者则不同。</p><p class=ql-align-justify>怎么均衡的背后是策略在起作用，而策略的背后是由某些算法或者说逻辑来组成的。</p><p class=ql-align-justify>比如，导航中的算法属于路径规划范畴，在这个范畴内又细分为静态路径规划和动态路径规划，并且，在不同的分支下还有各种具体计算的算法实现，如 Dijikstra、A* 等。</p><p class=ql-align-justify>同样的，在软件系统中的负载均衡，也有很多算法或者说逻辑在支撑着这些策略，巧的是也有静态和动态之分。</p><p class=ql-align-justify><strong>常用负载均衡策略图解</strong></p><p class=ql-align-justify>下面来罗列一下日常工作中最常见的 5 种策略。</p><p class=ql-align-justify><strong>轮询</strong></p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/18cbfc5447c4447bae0e53d90a4bf573><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify>这是最常用也最简单策略，平均分配，人人都有、一人一次。大致的代码如下：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3ca51a0548b946179680d2d3754e4976><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><p class=ql-align-justify><strong>加权轮询</strong></p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3ca51a0548b946179680d2d3754e4976><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify>在轮询的基础上，增加了一个权重的概念。权重是一个泛化后的概念，可以用任意方式来体现，本质上是一个能者多劳思想。</p><p class=ql-align-justify>比如，可以根据宿主的性能差异配置不同的权重。大致的代码如下：</p><pre class=ql-align-justify>int matchedIndex = -1;int total = 0;for (int i = 0; i &lt; servers.Length; i++){ servers[i].cur_weight += servers[i].weight;//①每次循环的时候做自增（步长=权重值） total += servers[i].weight;//②将每个节点的权重值累加到汇总值中 if (matchedIndex == -1 || servers[matchedIndex].cur_weight &lt; servers[i].cur_weight) //③如果 当前节点的自增数 &gt; 当前待返回节点的自增数，则覆盖。 { matchedIndex = i; }}servers[matchedIndex].cur_weight -= total;//④被选取的节点减去②的汇总值，以降低下一次被选举时的初始权重值。return servers[matchedIndex];</pre><p class=ql-align-justify><br></p><p class=ql-align-justify>这段代码的过程如下图的表格。"()"中的数字就是自增数，即代码中的 cur_weight。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8e34058945c64e3a86f83636aa4bab00><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><p class=ql-align-justify>值得注意的是，加权轮询本身还有不同的实现方式，虽说最终的比例都是 2：1：2。</p><p class=ql-align-justify>但是在请求送达的先后顺序上可以有所不同。比如「5-4，3，2-1」和上面的案例相比，最终比例是一样的，但是效果不同。</p><p class=ql-align-justify>「5-4，3，2-1」更容易产生并发问题，导致服务端拥塞，且这个问题随着权重数字越大越严重。</p><p class=ql-align-justify>例子：10：5：3 的结果是「18-17-16-15-14-13-12-11-10-9，8-7-6-5-4，3-2-1」</p><p class=ql-align-justify><strong>最少连接数</strong></p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3ca51a0548b946179680d2d3754e4976><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify>这是一种根据实时的负载情况，进行动态负载均衡的方式。维护好活动中的连接数量，然后取最小的返回即可。大致的代码如下：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/40b1be78909344e7bf736fa32eecd49e><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><p class=ql-align-justify><strong>最快响应</strong></p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3d950c35f2b34843b898e80eb9fca3ab><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify>这也是一种动态负载均衡策略，它的本质是根据每个节点对过去一段时间内的响应情况来分配，响应越快分配的越多。</p><p class=ql-align-justify>具体的运作方式也有很多，上图的这种可以理解为，将最近一段时间的请求耗时的平均值记录下来，结合前面的加权轮询来处理，所以等价于 2：1：3 的加权轮询。</p><p class=ql-align-justify>题外话：一般来说，同机房下的延迟基本没什么差异，响应时间的差异主要在服务的处理能力上。</p><p class=ql-align-justify>如果在跨地域（例：浙江->上海，还是浙江->北京）的一些请求处理中运用，大多数情况会使用定时「Ping」的方式来获取延迟情况，因为是 OSI 的 L3 转发，数据更干净，准确性更高。</p><p class=ql-align-justify><strong>Hash 法</strong></p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/55cdbf9bc5cc46a4836e951829cb5000><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify>Hash 法的负载均衡与之前的几种不同在于，它的结果是由客户端决定的。通过客户端带来的某个标识经过一个标准化的散列函数进行打散分摊。上图中的散列函数运用的是最简单粗暴的取余法。</p><p class=ql-align-justify>题外话：散列函数除了取余之外，还有诸如变基、折叠、平方取中法等等，此处不做展开，有兴趣的小伙伴可自行查阅资料。</p><p class=ql-align-justify>另外，被求余的参数其实可以是任意的，只要最终转化成一个整数参与运算即可。</p><p class=ql-align-justify>最常用的应该是用来源 IP 地址作为参数，这样可以确保相同的客户端请求尽可能落在同一台服务器上。</p><p class=ql-align-justify><strong>常用负载均衡策略优缺点和适用场景</strong></p><p class=ql-align-justify>我们知道，没有完美的事物，负载均衡策略也是一样。上面列举的这些最常用的策略也有各自的优缺点和适用场景，我稍作了整理，如下。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3ca51a0548b946179680d2d3754e4976><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><p class=ql-align-justify>这些负载均衡算法之所以常用也是因为简单，想要更优的效果，必然就需要更高的复杂度。</p><p class=ql-align-justify>比如，可以将简单的策略组合使用、或者通过更多维度的数据采样来综合评估、甚至是基于进行数据挖掘后的预测算法来做。</p><p class=ql-align-justify><strong>用健康探测来保障高可用</strong></p><p class=ql-align-justify>不管是什么样的策略，难免会遇到机器故障或者程序故障的情况。所以要确保负载均衡能更好的起到效果，还需要结合一些健康探测机制。定时的去探测服务端是不是还能连上，响应是不是超出预期的慢。</p><p class=ql-align-justify>如果节点属于“不可用”的状态的话，需要将这个节点临时从待选取列表中移除，以提高可用性。一般常用的健康探测方式有 3 种。</p><p class=ql-align-justify><strong>HTTP 探测</strong></p><p class=ql-align-justify>使用 Get/Post 的方式请求服务端的某个固定的 URL，判断返回的内容是否符合预期。一般使用 HTTP 状态码、Response 中的内容来判断。</p><p class=ql-align-justify><strong>TCP 探测</strong></p><p class=ql-align-justify>基于 TCP 的三次握手机制来探测指定的 IP + 端口。最佳实践可以借鉴阿里云的 SLB 机制，如下图：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3ca51a0548b946179680d2d3754e4976><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><p class=ql-align-center>▲图片来源于阿里云，版权归原作者所有</p><p class=ql-align-justify><br></p><p class=ql-align-justify>值得注意的是，为了尽早释放连接，在三次握手结束后立马跟上 RST 来中断 TCP 连接。</p><p class=ql-align-justify><strong>UDP 探测</strong></p><p class=ql-align-justify>可能有部分应用使用的是 UDP 协议。在此协议下可以通过报文来进行探测指定的 IP + 端口。最佳实践同样可以借鉴阿里云的 SLB 机制，如下图：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文概括6种负载均衡技术的实现方式！ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8e47b414082d48de94224a549001caf4><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>▲图片来源于阿里云，版权归原作者所有</p><p class=ql-align-justify><br></p><p class=ql-align-justify>结果的判定方式是：在服务端没有返回任何信息的情况下，默认是正常状态。否则会返回一个 ICMP 的报错信息。</p><p class=ql-align-justify><strong>结语</strong></p><p class=ql-align-justify>用一句话来概括负载均衡的本质是：将请求或者说流量，以期望的规则分摊到多个操作单元上进行执行。</p><p class=ql-align-justify>通过它可以实现横向扩展（scale out），将冗余的作用发挥为高可用。另外，还可以物尽其用，提升资源使用率。</p><blockquote>作者：张帆（Zachary）原创：跨界架构师</blockquote><p><strong>天下数据</strong>是国内屈指可数的拥有多处海外自建机房的新型IDC服务商，被业界公认为“中国IDC行业首选品牌”。</p><p><strong>天下数据</strong>与全球近120多个国家顶级机房直接合作，提供包括香港、美国、韩国、日本、台湾、新加坡、荷兰、法国、英国、德国、埃及、南非、巴西、印度、越南等国家和地区的服务器、云服务器的租用服务，需要的请联系<strong>天下数据</strong>客服！</p><p class=ql-align-justify>除提供传统的IDC产品外，<strong>天下数据</strong>的主要职责是为大中型企业提供更精细、安全、满足个性需求的定制化服务器解决方案，特别是在直销、金融、视频、流媒体、游戏、电子商务、区块链、快消、物联网、大数据等诸多行业，为广大客户解决服务器租用中遇到的各种问题。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'种负载','技术','实现'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>