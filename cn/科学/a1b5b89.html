<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>java脚本引擎的设计原理浅析 | 极客快訊</title><meta property="og:title" content="java脚本引擎的设计原理浅析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/1a656528bc904cc6849ed9b4387e28dc"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/a1b5b89.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/a1b5b89.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/a1b5b89.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/a1b5b89.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/a1b5b89.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/a1b5b89.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/a1b5b89.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/a1b5b89.html><meta property="article:published_time" content="2020-10-29T20:55:16+08:00"><meta property="article:modified_time" content="2020-10-29T20:55:16+08:00"><meta name=Keywords content><meta name=description content="java脚本引擎的设计原理浅析"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E5%AD%A6/a1b5b89.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>java脚本引擎的设计原理浅析</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E5%AD%A6.html>科学</a></span></div><div class=post-content><div><p>QLExpress是一个脚本引擎工具，类似Groovy，JRuby等，是为了解决当时电商规则动态编译、表达式高精度计算、复杂布尔运算、自定义函数和操作符号、语法树生成等需求而设计的。QLExpress项目开源自2012年，截至目前已经迭代了60多个版本，（在阿里的专有开源社区 index - Taocode ）后在社区和集团内部却意外获得非常好的反响。</p><div class=pgc-img><img alt=java脚本引擎的设计原理浅析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1a656528bc904cc6849ed9b4387e28dc><p class=pgc-img-caption></p></div><p>然而，我要很不客气的讲，在众多优秀的脚本引擎工具list中，QLExpress还很不完美。本篇结合自己的工作和技术研究，列举其中一些比较有意思的。</p><p>一、分类标准</p><p>1、编译型 vs 解析性</p><p>如果能够产生一个独立的class文件则属于前者，例如：fel，simpleEl，groovy</p><p>否则通过编译成自定义的内存指令就属于后者，例如：QLExpress，aviator，JEXL</p><p>2、java语法 vs 表达式语言(EL expression language) vs 脚本(script)</p><p>如果语法和java保持一致，不做任何扩展，就是属于第一种：</p><p>如果语法大量简化（比如去掉显示类、方法、变量声明，异常处理，逻辑跳转循环等等），只支持简单的数学公式、对象方法成员变量调用， 就属于第二种：fel，simpleEl，aviator</p><p>介于两者之间，即提供很好的语法糖，又支持大部分java语法：for循环，if判断，函数定义，就属于第三种：groovy，QLExpress</p><p>3、静态类型 vs 动态类型 vs 强类型 vs 弱类型</p><p>区别看这里： 弱类型、强类型、动态类型、静态类型语言的区别是什么？</p><p>假设两个都很成熟的脚本引擎，强类型可以比弱类型提高一个数量级的运算效率，但是带来业务的灵活性也就差很多。比如fel、simpleEl比Groovy、QLExpress效率肯定要高一个量级，因此，Groovy也提供了静态类型的模式牺牲部分灵活性来提高性能。</p><p>二、设计思路</p><pre>思路一：通过文本替换成java源码文件。</pre><p>编译时，使用 jdk工具（ javax.tools.JavaCompiler ）或者 eclipse工具 动态编译成class文件</p><p>运行时，取出class文件放入jvm直接运行</p><pre>思路二：通过 antlr 等 语法解析器 把文本流解析成抽象语法树（AST）。</pre><p>编译时，把AST的节点重新编排成class文件或者指令集。</p><p>运行时，把其中的操作符映射成自定义的执行器。</p><p>三、看一些案例</p><p>1、simpleEL</p><p>作者：温绍锦(高铁@alibaba) https://github.com/alibaba/simpleel</p><p>demo代码：</p><pre>DefaultExpressEvalService service = new DefaultExpressEvalService();service.regsiterVariant(Integer.class,”a”,"b");//注册数据类型service.setAllowMultiStatement(true); //设置支持多行语句Map&lt;String, Object&gt; ctx = new HashMap();ctx.put("a", 2);ctx.put("b", 1);String dsl = "if (@a &gt; @b) { return @a - @b; } else {return @b - @a; }";Object result = service.eval(ctx, dsl);//return 1</pre><p>内部原理剖析：</p><pre>if (@a &gt; @b) { return @a - @b; } else { return @b - @a;}</pre><p>通过@标识变量，直接转化为一下的java源码，然后再转化为class文件</p><p>生成的class文件反编译后的源码：</p><div class=pgc-img><img alt=java脚本引擎的设计原理浅析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6c036b9825584185bf2f868f0300ce12><p class=pgc-img-caption></p></div><p>再比如：</p><pre>DefaultExpressEvalService service = new DefaultExpressEvalService();service.regsiterVariant(MyBean.class,"bean");Map&lt;String, Object&gt; ctx = new HashMap();ctx.put("bean", new com.taobao.el.MyBean());String dsl = "@bean.getId() + ':' + @bean.getName()"Object result = service.eval(ctx, dsl);</pre><p>生成的class文件反编译后的源码：</p><div class=pgc-img><img alt=java脚本引擎的设计原理浅析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/812e623f82c44960a4346aeb38fcdd8b><p class=pgc-img-caption></p></div><p>特点:</p><p>简单如其名，最最simple的EL，源码实现也极其简单。</p><p>依赖变量标识和强类型注册，不借助任何语法解析工具，就实现了非常高效简单的EL计算。</p><p>因为太简单，所以后续功能开发停滞了，2014-9-17后停止更新。</p><p>2、fel</p><p>作者：未知 https://code.google.com/archive/p/fast-el/</p><p>demo代码</p><pre>FelEngine fel = new FelEngineImpl();FelContext ctx = fel.getContext();ctx.set("首重价格", 10.5); ctx.set("续重价格", 2.5);ctx.set(“首重",5); ctx.set("总重量", 15);String dsl = "首重价格*首重+续重价格*(总重量-首重)";Expression exp = fel.compile(dsl, ctx);//必须变量全部注入后，才能编译通过Object result = exp.eval(ctx);System.out.println(result);</pre><p>内部原理剖析：</p><pre>首重价格*数量+续费价格*(首重-数量)</pre><p>使用antlr 对文本流进行语法分析，转化为AST之后生成简单的java源码</p><p>生成的class文件反编译后的源码：</p><div class=pgc-img><img alt=java脚本引擎的设计原理浅析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e486b60f4ef9481eb056ebdfac691f0c><p class=pgc-img-caption></p></div><p>特点：</p><p>和simpleEL相比，这是一个非常追求极致效率的作品，它能识别重复变量，开提供function注册、SourceBuilder等编译后期优化，基本可以保持到和java源码静态编译后只低一个数量级的效率。</p><p>静态类型，不支持多行表达式，new对象等，2013-3-26后停止更新</p><p>3、Groovy</p><p>大名鼎鼎的开源项目： The Apache Groovy programming language</p><p>demo:</p><pre>GroovyClassLoader groovyLoader = new GroovyClassLoader();Class&lt;Script&gt; groovyClass = (Class&lt;Script&gt;) groovyLoader.parseClass("a+b*c");Script script = groovyClass.newInstance();Binding bind = new Binding();bind.setVariable("a", 1);bind.setVariable("b", 2);bind.setVariable("c", 3);script.setBinding(bind);Object result = script.run();//return 7</pre><p>特点：</p><p>由于大规模的使用和发展历史悠久，groovy功能强大到无与伦比，本身和java源码文件无缝兼容，又提供一大堆的语法糖和功能库。</p><p>4、QLExpress</p><p>作者:强辉、包行杰 alibaba/QLExpress</p><pre>ExpressRunner runner = new ExpressRunner();DefaultContext&lt;String, Object&gt; context = new DefaultContext&lt;String, Object&gt;();context.put("a",1);context.put("b",2);context.put("c",3);Object result = runner.execute("a+b*c",context,null,true,false);</pre><p>特点：</p><p>从阿里巴巴的电商业务土壤中开始发展，融合了众多奇葩却又非常普遍的业务特性。</p><p>从2012年2.0版本开始开源，到现在一直在不断的迭代功能和新特性。</p><p>弱类型动态类型，高精度数值计算，复杂逻辑运算定制，函数、操作符的重载、覆盖，对象方法的拦截重定义，语法树、变量、函数定义输出等等。</p><p>脚本本身具备线程安全，高性能高并发的特性。</p><p>和同类型的groovy相比：</p><pre>1、groovy比qlExpress更兼容java语法</pre><p>相对功能复杂处理过程的大段java脚本，groovy可以直接拷贝过来运行，</p><p>而qlexpress的语法很轻量，对原始的java代码有一定的兼容性问题，一般需要把数据的类型声明全部去掉，同时不支持异常处理、for循环的集合写法 等</p><pre>2、qlExpress比groovy更强调功能扩展</pre><p>因为qlExpress就是诞生于阿里的电商系统，定制了很多特别的常用功能需求（宏定义，语法解析，公式计算，布尔逻辑处理，操作符函数的内置替换），可读性和功能更贴合业务需要，详细看qlExpress的扩展能力部分</p><pre>3、qlExpress比groovy实现更简洁，操作系统以及应用领域更广</pre><p>目前我们的qlExpress因为所有的语法解析、运算执行都自己编码实现，依赖实现极其简单，在阿里的新零售领域，在大量的低版本android系统的pos机上都有大规模使用，稳定性非常好。</p><pre>4、qlExpress和groovy性能相当</pre><p>qlExpress和groovy同属弱类型语法，比如a+b，可以在运行时支持字符串，数字等多种计算模式，相比fel，simpleExpress 等强类型语言性能会差一个数量级。</p><p>他们都支持编译期做了缓存功能，qlExpress转化为InstructSet，groovy转化为一个特殊的groovyclass子类</p><p>文章总结</p><p>限于篇幅，本文没有再枚举更多的脚本引擎，对groovy和QLExpress也没有充分展开原理介绍，最后只表述本人的对这个行业的一些看法。</p><p>1、如何自己造轮子：基于jvm的java语言的脚本引擎本身门槛并不高。</p><p>我见过好几个case：开发能力比较强的团队在了解 jdk字节码生成工具，antlr语法生成工具，深入阅读一些编译原理文章之后，都可以在1-2月内开发出一个脚本引擎，满足业务述求。</p><p>但是，往往会因为与业务系统耦合、功能太少、通用性太差、不具备开放性等原因逐渐消亡，无法大范围推广。</p><p>2、如何选轮子：性能、稳定性、语法灵活性综合考虑</p><p>某种角度来说，脚本引擎因为可以动态解析执行，往往成为业务配置化的一部分。</p><p>业务控制逻辑越复杂，越需要流程引擎，规则引擎，脚本引擎一类的东西来编排业务。</p><p>作为业务架构师，底层一定要选择一个靠谱好用的脚本引擎工具。</p><p>性能上:</p><pre> 大众化工具&gt;小众化工具(内部工具实现上有很多可以优化的点) 强类型 &gt; 弱类型（在两者都很成熟稳定的情况下） </pre><p>稳定性上:</p><pre> 简单的设计原理&gt;强大的开源社区&gt;小众化工具引擎</pre><p>语法的灵活性:</p><pre> 代码越多、越复杂的实现方式功能会涵盖越多，语法糖、容错性、兼容性</pre></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'java','脚本','设计'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>