<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ä¹‹é«˜çº§I/Oå‡½æ•°è¯¦è§£ï¼ˆå«å®ä¾‹ä»£ç ï¼‰ | æå®¢å¿«è¨Š</title><meta property="og:title" content="Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ä¹‹é«˜çº§I/Oå‡½æ•°è¯¦è§£ï¼ˆå«å®ä¾‹ä»£ç ï¼‰ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/a2cc0f57fdec4d4bae7110590a705e39"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/ca430d03.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/ca430d03.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/ca430d03.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/ca430d03.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/ca430d03.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/ca430d03.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/ca430d03.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/ca430d03.html><meta property="article:published_time" content="2020-10-29T21:13:10+08:00"><meta property="article:modified_time" content="2020-10-29T21:13:10+08:00"><meta name=Keywords content><meta name=description content="Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ä¹‹é«˜çº§I/Oå‡½æ•°è¯¦è§£ï¼ˆå«å®ä¾‹ä»£ç ï¼‰"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E5%AD%A6/ca430d03.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ä¹‹é«˜çº§I/Oå‡½æ•°è¯¦è§£ï¼ˆå«å®ä¾‹ä»£ç ï¼‰</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E5%AD%A6.html>ç§‘å­¦</a></span></div><div class=post-content><p><strong>ä¸€ã€é‡å®šå‘dupå’Œdup2å‡½æ•°</strong></p><pre><code>#include &lt;unistd.h&gt;int dup(int file_descriptor);int dup2(int file_descriptor_one, int file_descriptor_two);</code></pre><ul><li>dupåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ æ­¤æè¿°ç¬¦å’ŒåŸæœ‰çš„file_descriptoræŒ‡å‘ç›¸åŒçš„æ–‡ä»¶ã€ç®¡é“æˆ–è€…ç½‘ç»œè¿æ¥ã€‚</li><li>dupè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦æ€»æ˜¯å–ç³»ç»Ÿå½“å‰å¯ç”¨çš„æœ€å°æ•´æ•°å€¼ã€‚</li></ul><p>dup2å‡½æ•°é€šè¿‡ä½¿ç”¨å‚æ•°file_descriptor_twoæŒ‡å®šæ–°æè¿°ç¬¦æ•°å€¼ï¼Œå¦‚æœfile_descriptor_twoå·²ç»æ‰“å¼€ï¼Œåˆ™å…ˆå…³é—­ã€‚è‹¥file_descriptor_one = file_descriptor_twoï¼Œè€Œä¸å…³é—­ã€‚</p><p>ä¸¤è€…è°ƒç”¨å¤±è´¥å‡è¿”å›-1, å¹¶è®¾ç½®errnoã€‚</p><pre><code>//åˆ©ç”¨dupæ¨¡æ‹Ÿå®ç°ä¸€ä¸ªåŸºæœ¬çš„CGIæœåŠ¡å™¨#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;unistd.h&gt;#include &lt;string.h&gt;#include &lt;errno.h&gt;#include &lt;sys/socket.h&gt;#include &lt;arpa/inet.h&gt;#include &lt;netinet/in.h&gt;#include &lt;assert.h&gt; int main(int argc, char **argv){	if (argc ï¼= 3) {	     fprintf(stderr, "Usage: %s id port\n", basename(argv[0]));	     return 1;	}		const char *ip = argv[1];	int port = atoi(argv[2]);		struct sockaddr_in address;	bzero(&amp;address, sizeof(address));	address.sin_family = AF_INET;	address.sin_port = htons(port);	inet_pton(AF_INET, ip, &amp;address.sin_addr);		int sock = socket(PF_INET, SOCK_STREAM, 0);	assert(sock &gt;= 0);		int ret = bind(sock, (struct sockaddr*)&amp;address, sizeof(address));	assert(ret != -1);		ret = listen(sock, 5);	assert(ret != -1);		struct sockaddr_in client;	socklen_t client_addrlength = sizeof(client);	int connfd = accept(sock, (struct sockaddr*)&amp;client, &amp;client_addrlength);	if (connfd &lt; 0) {		printf("error: %s\n", strerror(errno));	}	else {		close(STDOUT_FILENO); //å…³é—­æ ‡å‡†è¾“å‡º		dup(connfd);          //é‡å®šå‘1åˆ°connfdï¼Œè¿™æ ·æœåŠ¡å™¨çš„æ ‡å‡†è¾“å‡ºå†…å®¹ä¼šç›´æ¥å‘é€åˆ°å®¢æˆ·ç«¯socketï¼Œè¿™å°±æ˜¯CGIçš„åŸºæœ¬åŸç†				printf("abc. close stdout_fileno test... dup to client\n"); //printfä¼šç›´æ¥è¾“å‡ºä¼šå‘é€åˆ°å®¢æˆ·ç«¯				close(connfd);	}		close(sock);		return 0;}</code></pre><p><strong>æ³¨ï¼šéœ€è¦C/C++ Linuxé«˜çº§æœåŠ¡å™¨æ¶æ„å¸ˆå­¦ä¹ èµ„æ–™ç§ä¿¡â€œèµ„æ–™â€ï¼ˆèµ„æ–™åŒ…æ‹¬C/C++ï¼ŒLinuxï¼ŒgolangæŠ€æœ¯ï¼ŒNginxï¼ŒZeroMQï¼ŒMySQLï¼ŒRedisï¼Œfastdfsï¼ŒMongoDBï¼ŒZKï¼Œæµåª’ä½“ï¼ŒCDNï¼ŒP2Pï¼ŒK8Sï¼ŒDockerï¼ŒTCP/IPï¼Œåç¨‹ï¼ŒDPDKï¼Œffmpegç­‰ï¼‰ï¼Œå…è´¹åˆ†äº«</strong></p><div class=pgc-img><img alt=Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ä¹‹é«˜çº§I/Oå‡½æ•°è¯¦è§£ï¼ˆå«å®ä¾‹ä»£ç ï¼‰ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/a2cc0f57fdec4d4bae7110590a705e39><p class=pgc-img-caption></p></div><p><strong>äºŒã€åˆ†æ•£è¯»readvå’Œé›†ä¸­å†™writevå‡½æ•°</strong></p><p>readvå°†æ•°æ®ä»æ–‡ä»¶æè¿°ç¬¦è¯»åˆ°åˆ†æ•£çš„å†…å­˜å—ä¸­ï¼Œå³åˆ†æ•£è¯»ã€‚</p><p>writevå°†å¤šå—åˆ†æ•£çš„å†…å­˜ä¸€å¹¶å†™å…¥æ–‡ä»¶æè¿°ç¬¦ä¸­ï¼Œå³é›†ä¸­å†™ã€‚</p><pre><code>#include &lt;sys/uio.h&gt;ssize_t readv(int fd, const struct iovec *vector, int count);ssize_t writev(int fd, const struct iovec *vector, int count);</code></pre><p>fdå‚æ•°æ˜¯è¢«æ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>vectorå‚æ•°æ˜¯iovecç»“æ„ä½“ï¼š</p><pre><code>#include &lt;sys/uio.h&gt;struct iovec{    void *iov_base;  //æŒ‡å‘ä¸€ä¸ªç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºæ˜¯å­˜æ”¾readvæ‰€æ¥æ”¶çš„æ•°æ®æˆ–æ˜¯writevå°†è¦å‘é€çš„æ•°æ®    size_t iov_len;  //æ¥æ”¶çš„é•¿åº¦ä»¥åŠå®é™…å†™å…¥çš„é•¿åº¦};</code></pre><p>countå‚æ•°æ˜¯vectoræ•°ç»„çš„é•¿åº¦ï¼Œå³æœ‰å¤šå°‘å—å†…å­˜æ•°æ®éœ€è¦ä»fdè¯»å‡ºæˆ–å†™åˆ°fdã€‚</p><p>ä¸¤è€…è°ƒç”¨æˆåŠŸæ˜¯è¿”å›è¯»å‡º/å†™å…¥fdçš„å­—èŠ‚æ•°ï¼Œå¤±è´¥è¿”å›-1,å¹¶è®¾ç½®errnoã€‚ç±»ä¼¼äºç®€åŒ–ç‰ˆçš„recvmsgå’Œsendmsgã€‚</p><p>ä»¥ä¸‹ç®€é™‹çš„æ¨¡æ‹ŸWEBæœåŠ¡å™¨ï¼Œé‡‡ç”¨é›†ä¸­å†™çš„æ–¹å¼ã€‚çœç•¥äº†HTTPè¯·æ±‚çš„æ¥æ”¶åŠè§£æï¼Œ ç›´æ¥å°†ç›®æ ‡æ–‡ä»¶ä½œä¸ºç¬¬3ä¸ªå‚æ•°ä¼ é€’ç»™æœåŠ¡ç«¯ç¨‹åºï¼Œå®¢æˆ·ç«¯telnetåˆ°æœåŠ¡ç«¯å³å¯è·å¾—è¯¥æ–‡ä»¶ã€‚</p><pre><code>#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;unistd.h&gt;#include &lt;assert.h&gt;#include &lt;sys/socket.h&gt;#include &lt;netinet/in.h&gt;#include &lt;arpa/inet.h&gt;#include &lt;errno.h&gt;#include &lt;sys/stat.h&gt;#include &lt;sys/types.h&gt;#include &lt;fcntl.h&gt; #define BUFFER_SIZE 1024 //å®šä¹‰ä¸¤ç§HTTPçŠ¶æ€ç å’ŒçŠ¶æ€ä¿¡æ¯static const char *status_line[2] = {"200 OK", "500 Internal server error"};  int main(int argc, char **argv){	if(argc != 4) {		fprintf(stderr, "Usage: %s ip port filename\n", basename(argv[0]));		return 1;	}		const char *ip = argv[1];	int port = atoi(argv[2]);	const char *file_name = argv[3];    //å°†ç›®æ ‡æ–‡ä»¶ä½œä¸ºç¨‹åºçš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥		struct sockaddr_in address;	bzero(&amp;address, sizeof(address));	address.sin_family = AF_INET;	address.sin_port = htons(port);	inet_pton(AF_INET, ip, &amp;address.sin_addr);		int sock = socket(PF_INET, SOCK_STREAM, 0);	assert(sock &gt;= 0);	printf("create socket success\n");		int reuse = 1;	setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &amp;reuse, sizeof(reuse));		int ret = bind(sock, (struct sockaddr*)&amp;address, sizeof(address));	assert(ret != -1);	fprintf(stderr, "bind address success\n");		ret = listen(sock, 5);	assert(ret != -1);	fprintf(stderr, "listen success\n");		struct sockaddr_in client;	socklen_t client_addrlength = sizeof(client);		fprintf(stderr, "start accept...\n");		int connfd = accept(sock, (struct sockaddr*)&amp;client, &amp;client_addrlength);	if(connfd &lt; 0) {		printf("error: %s\n", strerror(errno));	}	else {		char header_buf[BUFFER_SIZE];             //ç”¨äºä¿å­˜HTTPåº”ç­”çš„çŠ¶æ€è¡Œã€å¤´éƒ¨å­—æ®µå’Œä¸€ä¸ªç©ºçš„ç¼“å†²åŒº		memset(header_buf, '\0', BUFFER_SIZE);				char *file_buf = NULL;                    //ç”¨äºå­˜æ”¾ç›®æ ‡æ–‡ä»¶å†…å®¹çš„ç¼“å­˜		struct stat file_stat;                    //ç”¨äºè·å–ç›®æ ‡æ–‡ä»¶çš„å±æ€§		bool valid = true;                        //ç›®æ ‡æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ		int len = 0;                              //è®°å½•header_bufå½“å‰å·²ä½¿ç”¨çš„å­—èŠ‚ç©ºé—´				if(stat(file_name, &amp;file_stat) &lt; 0) {     //ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨			valid = false;		}		else {			if(S_ISDIR(file_stat.st_mode)) {  //ç›®æ ‡æ–‡ä»¶æ˜¯ç›®å½•				valid = false;			}			else if (file_stat.st_mode &amp; S_IROTH) {               //å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰è¯»æƒé™ï¼Œç›¸å¯¹äºç›®æ ‡æ–‡ä»¶				int fd = open(file_name, O_RDONLY);				file_buf = new char[file_stat.st_size + 1];				memset(file_buf, '\0', file_stat.st_size + 1);								fprintf(stderr, "reading %s file...", file_name);								if (read(fd, file_buf, file_stat.st_size) &lt; 0) {						valid = false;				}			}			else {				valid = false;			}		}		 		if (valid) {   //ç›®æ ‡æ–‡ä»¶æœ‰æ•ˆ				ret = snprintf(header_buf, BUFFER_SIZE-1,								"%s %s\r\n",								"HTTP/1.1", status_line[0]);												len += ret;				ret = snprintf(header_buf+len, BUFFER_SIZE-1-len,								"content-Length: %ld\r\n",								file_stat.st_size);												len += ret;				ret = snprintf(header_buf+len, BUFFER_SIZE-1-len,								"%s", "\r\n");				                                //å°†header_bufå’Œfile_bufçš„å†…å®¹ä¸€å¹¶å†™å‡º								struct iovec iv[2];				iv[0].iov_base = header_buf;				iv[0].iov_len = strlen(header_buf);				iv[1].iov_base = file_buf;				iv[1].iov_len = file_stat.st_size;								fprintf(stderr, "read %s success\nsending %s file to client...\n", file_name, file_name);								ret = writev(connfd, iv, 2);   //é›†ä¸­å†™						}		else {     //ç›®æ ‡æ–‡ä»¶æ— æ•ˆ			ret = snprintf(header_buf, BUFFER_SIZE-1,							"%s %s\r\n",							"HTTP/1.1", status_line[1]);						len += ret;			ret = snprintf(header_buf+len, BUFFER_SIZE-1-len,							"%s", "\r\n");						fprintf(stderr, "read %s failed\nsending error message to client...\n", file_name);							send(connfd, header_buf, strlen(header_buf), 0);		}				close(connfd);				if (file_buf != NULL) {			delete[] file_buf;			file_buf = NULL;		}	}		close(sock);			return 0;}</code></pre><p><strong>ä¸‰ã€sendfileå‡½æ•°</strong></p><p>sendfileåœ¨ä¸¤ä¸ªæ–‡ä»¶ææœ¯ç¬¦ä¹‹é—´ç›´æ¥ä¼ é€’æ•°æ®ï¼Œå®Œå…¨åœ¨å†…æ ¸ä¸­æ“ä½œï¼Œä»è€Œé¿å…äº†å†…æ ¸ç¼“å†²åŒºåˆ°ç”¨æˆ·ç¼“å†²åŒºçš„æ‹·è´ï¼Œå› æ­¤æ•ˆç‡å¾ˆé«˜ï¼Œç§°ä¸ºé›¶æ‹·è´ã€‚</p><pre><code>#include &lt;sys/sendfile.h&gt;ssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count);</code></pre><p>out_fdå‚æ•°æ˜¯å¾…å†™å…¥å†…å®¹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>in_fdå‚æ•°æ˜¯å¾…è¯»å‡ºå†…å®¹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>offsetå‚æ•°æŒ‡å®šä»è¯»å…¥æ–‡ä»¶æµçš„å“ªä¸ªä½ç½®å¼€å§‹è¯»ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä»æ–‡ä»¶æµçš„é»˜è®¤èµ·å§‹ä½ç½®è¯»å…¥ã€‚</p><p>countå‚æ•°æŒ‡å®šä¼ è¾“çš„å­—èŠ‚æ•°ã€‚</p><p>è°ƒç”¨æˆåŠŸæ—¶è¿”å›ä¼ è¾“çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥åˆ™ä¸º-1ï¼Œå¹¶è®¾ç½®errno</p><p>æ³¨ï¼š manæ‰‹å†ŒæŒ‡å‡ºï¼Œin_fdå¿…é¡»æ˜¯ä¸€ä¸ªæ”¯æŒç±»ä¼¼mmapå‡½æ•°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå³å®ƒå¿…é¡»æŒ‡å‘çœŸå®çš„æ–‡ä»¶ï¼Œä¸èƒ½æ˜¯socketå’Œç®¡é“ï¼›è€Œout_fdå¿…é¡»æ˜¯ä¸€ä¸ªsocketã€‚å¯è§ï¼Œsendfileä¸“ä¸ºç½‘ç»œä¼ è¾“æ–‡ä»¶è€Œç”Ÿã€‚</p><pre><code>//ç”¨sendfileå‡½æ•°ä¼ è¾“æ–‡ä»¶#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;unistd.h&gt;#include &lt;string.h&gt;#include &lt;assert.h&gt;#include &lt;errno.h&gt;#include &lt;sys/socket.h&gt;#include &lt;netinet/in.h&gt;#include &lt;arpa/inet.h&gt;#include &lt;sys/types.h&gt;#include &lt;sys/stat.h&gt;#include &lt;sys/sendfile.h&gt;#include &lt;fcntl.h&gt;  int main(int argc, char **argv){	if (argc &lt;= 3) {		fprintf(stderr, "Usage: %s ip port filename\n", basename(argv[0]));		return 1;	}		const char *ip = argv[1];	int port = atoi(argv[2]);	const char *file_name = argv[3];		int filefd = open(file_name, O_RDONLY);	assert(filefd &gt; 0);		struct stat stat_buf;	fstat(filefd, &amp;stat_buf);		struct sockaddr_in address;	bzero(&amp;address, sizeof(address));	address.sin_family = AF_INET;	address.sin_port = htons(port);	inet_pton(AF_INET, ip, &amp;address.sin_addr);		int sock = socket(PF_INET, SOCK_STREAM, 0);	assert(sock &gt;= 0);		int ret = bind(sock, (struct sockaddr*)&amp;address, sizeof(address));	assert(ret != -1);		ret = listen(sock, 5);	assert(ret != -1);		struct sockaddr_in client;	socklen_t client_addrlength = sizeof(client);		int connfd = accept(sock, (struct sockaddr*)&amp;client, &amp;client_addrlength);	if (connfd &lt; 0) {		fprintf(stderr, "errno is: %s\n", strerror(errno));	}	else {		sendfile(connfd, filefd, NULL, stat_buf.st_size);		close(connfd);	}		close(sock);			return 0;}</code></pre><p><strong>spliceå‡½æ•°</strong></p><p>spliceç”¨äºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç§»åŠ¨æ•°æ®ï¼Œ ä¹Ÿæ˜¯é›¶æ‹·è´ã€‚</p><pre><code>#include &lt;fcntl.h&gt;ssize_t splice(int fd_in, loff_t *off_in, int fd_out, loff_t *off_out, size_t len, unsigned int flags);</code></pre><p>fd_inå‚æ•°æ˜¯å¾…è¾“å…¥æè¿°ç¬¦ã€‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ™off_inå¿…é¡»è®¾ç½®ä¸ºNULLï¼›å¦åˆ™off_inè¡¨ç¤ºä»è¾“å…¥æ•°æ®æµçš„ä½•å¤„å¼€å§‹è¯»å–ï¼Œæ­¤æ—¶è‹¥ä¸ºNULLï¼Œåˆ™ä»è¾“å…¥æ•°æ®æµçš„å½“å‰åç§»ä½ç½®è¯»å…¥ã€‚</p><p>fd_out/off_outä¸ä¸Šè¿°ç›¸åŒï¼Œä¸è¿‡æ˜¯ç”¨äºè¾“å‡ºã€‚</p><p>lenå‚æ•°æŒ‡å®šç§»åŠ¨æ•°æ®çš„é•¿åº¦ã€‚</p><p>flagså‚æ•°åˆ™æ§åˆ¶æ•°æ®å¦‚ä½•ç§»åŠ¨ï¼š</p><ul><li>SPLICE_F_NONBLOCKï¼šéé˜»å¡çš„splice æ“ä½œï¼Œä½†å®é™…æ•ˆæœè¿˜ä¼šå—æ–‡ä»¶æè¿°ç¬¦æœ¬èº«çš„é˜»å¡çŠ¶æ€çš„å½±å“ã€‚</li><li>SPLICE_F_MOREï¼šç»™å†…æ ¸ä¸€ä¸ªæç¤ºï¼šåç»­çš„ splice ç³»ç»Ÿè°ƒç”¨å°†ä¼šæœ‰æ›´å¤šçš„æ•°æ®ä¼ ã€‚</li><li>SPLICE_F_MOVEï¼šå¦‚æœåˆé€‚çš„è¯ï¼ŒæŒ‰æ•´é¡µå†…å­˜ç§»åŠ¨æ•°æ®ã€‚è¿™åªæ˜¯ç»™å†…æ ¸çš„ä¸€ä¸ªæç¤ºã€‚ä¸è¿‡ï¼Œå› ä¸ºå®ƒçš„å®ç°å­˜åœ¨BUGï¼Œæ‰€ä»¥è‡ªå†…æ ¸2.6.21åï¼Œå®ƒå®é™…ä¸Šæ²¡æœ‰ä»»ä½•æ•ˆæœã€‚</li></ul><p>æ³¨æ„ï¼šä½¿ç”¨spliceæ—¶ï¼Œ fd_inå’Œfd_outä¸­å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ç®¡é“æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>è°ƒç”¨æˆåŠŸæ—¶è¿”å›ç§»åŠ¨çš„å­—èŠ‚æ•°é‡ï¼›å®ƒå¯èƒ½è¿”å›0,è¡¨ç¤ºæ²¡æœ‰æ•°æ®éœ€è¦ç§»åŠ¨ï¼Œè¿™é€šå¸¸å‘ç”Ÿåœ¨ä»ç®¡é“ä¸­è¯»æ•°æ®æ—¶è€Œè¯¥ç®¡é“æ²¡æœ‰è¢«å†™å…¥çš„æ—¶å€™ã€‚</p><p>å¤±è´¥æ—¶è¿”å›-1ï¼Œå¹¶è®¾ç½®errnoã€‚</p><p style=text-align:center>spliceå‡½æ•°å¯èƒ½äº§ç”Ÿçš„errnoåŠå…¶å«ä¹‰</p><div class=pgc-img><img alt=Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ä¹‹é«˜çº§I/Oå‡½æ•°è¯¦è§£ï¼ˆå«å®ä¾‹ä»£ç ï¼‰ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5cb636f55ca24d9ebd51fc59329a6fce><p class=pgc-img-caption></p></div><p>ä¸‹é¢ä»£ç ï¼šé€šè¿‡spliceå°†å®¢æˆ·ç«¯çš„å†…å®¹è¯»å…¥åˆ°ç®¡é“ä¸­ï¼Œ å†ä»ç®¡é“ä¸­è¯»å‡ºåˆ°å®¢æˆ·ç«¯ï¼Œä»è€Œå®ç°é«˜æ•ˆç®€å•çš„å›æ˜¾æœåŠ¡ã€‚æ•´ä¸ªè¿‡ç¨‹æœªæ‰§è¡Œrecv/sendï¼Œå› æ­¤ä¹Ÿæœªæ¶‰åŠç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ç©ºé—´çš„æ•°æ®æ‹·è´ã€‚</p><pre><code>//ä½¿ç”¨spliceå®ç°çš„å›æ˜¾æœåŠ¡å™¨#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;unistd.h&gt;#include &lt;sys/socket.h&gt;#include &lt;netinet/in.h&gt;#include &lt;arpa/inet.h&gt;#include &lt;assert.h&gt;#include &lt;errno.h&gt;#include &lt;string.h&gt;#include &lt;fcntl.h&gt;  int main(int argc, char **argv){ 	if (argc &lt;= 2) {		printf("usage: %s ip port\n", basename(argv[0]));		return 1;	}		const char *ip = argv[1];	int port = atoi(argv[2]); 	struct sockaddr_in address;	bzero(&amp;address, sizeof(address));	address.sin_family = AF_INET;	address.sin_port = htons(port);	inet_pton(AF_INET, ip, &amp;address.sin_addr); 	int sock = socket(PF_INET, SOCK_STREAM, 0);	assert(sock &gt;= 0);		int reuse = 1;	setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &amp;reuse, sizeof(reuse)); 	int ret = bind(sock, (struct sockaddr*)&amp;address, sizeof(address));	assert(ret != -1); 	ret = listen(sock, 5);	assert(ret != -1);		struct sockaddr_in client;	socklen_t client_addrlength = sizeof(client);		int connfd = accept(sock, (struct sockaddr*)&amp;client, &amp;client_addrlength);	if (connfd &lt; 0) {		printf("errno is: %s\n", strerror(errno));	}	else {		int pipefd[2];						ret = pipe(pipefd);  //åˆ›å»ºç®¡é“		assert(ret != -1);		                //å°†connfdä¸Šçš„å®¢æˆ·ç«¯æ•°æ®å®šå‘åˆ°ç®¡é“ä¸­		ret = splice(connfd, NULL, pipefd[1], NULL,						32768, SPLICE_F_MORE | SPLICE_F_MOVE);		assert(ret != -1);		                //å°†ç®¡é“çš„è¾“å‡ºå®šå‘åˆ°connfdä¸Š		ret = splice(pipefd[0], NULL, connfd, NULL,						32768, SPLICE_F_MORE | SPLICE_F_MOVE);		assert(ret != -1);								close(connfd);	} 		close(sock);    	return 0;}</code></pre><p><strong>teeå‡½æ•°</strong></p><p>teeåœ¨ä¸¤ä¸ªç®¡é“æ–‡ä»¶æè¿°ä¹‹é—´å¤åˆ¶æ•°æ®ï¼Œä¹Ÿæ˜¯é›¶æ‹·è´æ“ä½œã€‚</p><pre><code>#include &lt;fcntl.h&gt;ssize_t tee(int fd_in, int fd_out, size_t len, unsigned int flags);</code></pre><p>å®ƒçš„å‚æ•°ä¸spliceç›¸åŒï¼Œä½†fd_inå’Œfd_outéƒ½å¿…é¡»æ˜¯ç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼Œè°ƒç”¨æˆåŠŸæ—¶è¿”å›å¤åˆ¶çš„å­—èŠ‚æ•°ã€‚è¿”å›0è¡¨ç¤ºæ²¡æœ‰å¤åˆ¶ä»»åŠ¡æ•°æ®ã€‚å¤±è´¥æ—¶è¿”å›-1ï¼Œå¹¶è®¾ç½®errnoã€‚</p><p>ç”¨teeå’Œspliceå®ç°ä»æ ‡å‡†è¾“å…¥åˆ°ç»ˆç«¯å’Œæ–‡ä»¶çš„ç¨‹åºï¼š</p><pre><code>#include &lt;stdio.h&gt;#include &lt;unistd.h&gt;#include &lt;string.h&gt;#include &lt;errno.h&gt;#include &lt;fcntl.h&gt;#include &lt;assert.h&gt; int main(int argc, char **argv){	if (argc != 2) {		fprintf(stderr, "Usage: %s &lt;file&gt;\n", argv[0]);		return 1;	}		uid_t uid = getuid();	uid_t euid = geteuid();	printf("userid: %d, effective userid: %d\n", uid, euid);		int filefd = open(argv[1], O_CREAT | O_WRONLY | O_TRUNC, 0666);	assert(filefd &gt; 0);		int pipefd_stdout[2];	int ret = pipe(pipefd_stdout);	assert(ret != -1);		int pipefd_file[2];	ret = pipe(pipefd_file);	assert(ret != -1);	        //å°†æ ‡å‡†è¾“å…¥çš„å†…å®¹è¾“å‡ºåˆ°ç®¡é“	ret = splice(STDOUT_FILENO, NULL, pipefd_stdout[1], NULL,					32768, SPLICE_F_MORE | SPLICE_F_MOVE);	assert(ret != -1);	        //å°†ç®¡é“pipefd_stdoutçš„è¾“å‡ºå¤åˆ¶åˆ°ç®¡ç†pipefd_fileçš„è¾“å…¥ç«¯	ret = tee(pipefd_stdout[0], pipefd_file[1],				32768, SPLICE_F_NONBLOCK);	assert(ret != -1);	        //å°†ç®¡é“pipefd_fileçš„è¾“å‡ºå®šå‘åˆ°æ–‡ä»¶æè¿°ç¬¦filefdä¸Šï¼Œå†™å…¥æ–‡ä»¶	ret = splice(pipefd_file[0], NULL, filefd, NULL,					32768, SPLICE_F_MORE | SPLICE_F_MOVE);	assert(ret != -1);	        //å°†ç®¡é“pipefd_stdoutçš„è¾“å‡ºå®šå‘åˆ°æ ‡å‡†å‡ºï¼Œ å…¶å†…å®¹å’Œå†™å…¥æ–‡ä»¶çš„å†…å®¹ä¸€è‡´	ret = splice(pipefd_stdout[0], NULL, STDOUT_FILENO, NULL,					32768, SPLICE_F_MORE | SPLICE_F_MOVE);	assert(ret != -1);		close(filefd);	close(pipefd_file[0]);	close(pipefd_file[1]);	close(pipefd_stdout[0]);	close(pipefd_stdout[1]);		return 0;}</code></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Linux','æœåŠ¡å™¨','ç¼–ç¨‹'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>