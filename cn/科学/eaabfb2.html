<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>超详细深度学习debug指南，国外小哥手把手教你如何调试模型 | 极客快訊</title><meta property="og:title" content="超详细深度学习debug指南，国外小哥手把手教你如何调试模型 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/3b39452383fc4068b749c02acef8d7fa"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/eaabfb2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/eaabfb2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/eaabfb2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/eaabfb2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/eaabfb2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/eaabfb2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%a6/eaabfb2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%a6/eaabfb2.html><meta property="article:published_time" content="2020-10-29T21:02:12+08:00"><meta property="article:modified_time" content="2020-10-29T21:02:12+08:00"><meta name=Keywords content><meta name=description content="超详细深度学习debug指南，国外小哥手把手教你如何调试模型"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E5%AD%A6/eaabfb2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>超详细深度学习debug指南，国外小哥手把手教你如何调试模型</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E5%AD%A6.html>科学</a></span></div><div class=post-content><div><blockquote><p>晓查 发自 凹非寺</p><p>量子位 出品 | 公众号 QbitAI</p></blockquote><p>已经学会深度学习，但你搭建的模型为什么还跑不动，到底哪里出了问题？</p><p>看懂了教材，一到编程调试就跪，为了寻找bug的你是否曾经手足无措？</p><p>虽然网络上深度学习的教材很多，但是手把手教你调试的技巧却不常见。</p><p>最近有人雪中送炭啦！一位来自伯克利的小哥Josh Robin分享了他的深度学习debug心得，从最简单模型开始一步步深入到复杂模型，希望能给刚上手的你一点帮助。</p><p>Josh在读博期间曾被debug折磨得很痛苦，他说自己花了大部分时间调试而不是在“有趣”的事情上。有一次，仅仅因为标签错误，Josh就整整花了一天才排查出来。</p><p>构思和写代码可能只花费10%~20%的时间，而debug和调试要消耗掉80%~90%的时间！所以这份秘籍可能比教材更常伴随着你。</p><h1><strong>为什么你的模型效果这么差？</strong></h1><p>由于深度学习模型的复杂性，按照书本知识来搭建模型，往往“理想很丰满，现实很骨感”。别人的模型都能快速达到较低的错误率，而你的模型错误率却居高不下。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/3b39452383fc4068b749c02acef8d7fa><p class=pgc-img-caption>△ 别人的曲线vs你的曲线</p></div><p class=ql-align-right><br></p><p>造出这种现象的原因可以分为4大类：</p><p>1、模型实现中的bug：比如前面说过的标签错误的问题。</p><p>2、超参数选择不合适：模型对超参数很敏感，学习率太高或太低都不行。</p><p class=ql-align-justify><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/20939aaaac3345cc8bf302ea4467a148><p class=pgc-img-caption>△ 合适的学习率才能保证较低的错误率</p></div><p class=ql-align-justify><br></p><p class=ql-align-right><br></p><p>3、数据模型不适配：比如你要训练一个自动驾驶图像识别的模型，用ImageNet数据集来训练就不合适。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9586fe2cb1a642f7857e883b04aa665f><p class=pgc-img-caption>△ ImageNet中的图片vs自动驾驶汽车拍摄的图片</p></div><p class=ql-align-right><br></p><p>4、数据集的构造问题：没有足够数据、分类不均衡、有噪声的标签、训练集合测试集分布不同。</p><h1><strong>深度学习debug的流程策略</strong></h1><p>针对上面的问题，小哥总结出调试深度学习模型的第一要义——<strong>悲观主义</strong>。</p><p>既然消除模型中的错误很难，我们不如先从简单模型入手，然后逐渐增加模型的复杂度。</p><p>他把这个过程分为5个步骤：</p><ol><li class=ql-align-justify>从最简单模型入手；</li><li class=ql-align-justify>成功搭建模型，重现结果；</li><li class=ql-align-justify>分解偏差各项，逐步拟合数据；</li><li class=ql-align-justify>用由粗到细随机搜索优化超参数；</li><li class=ql-align-justify>如果欠拟合，就增大模型；如果过拟合，就添加数据或调整。</li></ol><p><strong>从简单模型开始</strong></p><p>在这一步之前，Josh假定你已经有了初始的测试集、需要改进的单一指标、基于某种标准的模型目标性能。</p><p>首先，选择一个简单的架构。比如，你的输入是图片就选择类似LeNet的架构，输入是语言序列就选择有一个隐藏层的LSTM。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cbeccc013dcd494b9e1c16f0e22e53f6><p class=pgc-img-caption>△ 多输入模型</p></div><p class=ql-align-right><br></p><p>为了简化问题，我们从一个只有1万样本的数据集开始训练，数据的特点包括：固定数量的目标、分类、更小的图片尺寸。由此创建一个简单的合成训练集。</p><p><strong>开始搭建深度学习模型</strong></p><p>在搭建模型之前，Josh总结了实现（Implement）的5种最常见的bug：</p><p>错误的张量形状；预处理输入错误；损失函数错误输入；忘记设置正确的训练模型；错误的数据类型。</p><p>为了防止这些错误发生，Josh给出的建议是：尽可能减少代码的行数，使用现成的组件，然后再构建复杂的数据pipeline。</p><p>运行模型后，你可能会遇到形状不匹配、数据类型错误、内存不足等等问题。</p><p>对于第一个问题，可以在调试器中逐步完成模型创建和推理。数据类型错误是由于没有把其他类型数据<span>转化成</span>float32，内存不足是因为张量或者数据集太大。</p><p><strong>评估</strong></p><p>下面我们开始用错误率评估模型的性能。</p><p><strong>测试集错误率 = 错误率下限 + 偏移 + 方差 + 分布偏差 + 验证集过拟合</strong></p><p>为了处理训练集和测试集分布的偏差，我们使用两个验证数据集，一个样本来自训练集，一个样本来自测试集。</p><p class=ql-align-justify><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f4177070d90e49198646cd2cbef51861><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p><strong>改进模型和数据</strong></p><p>上一步中粗略搭建的模型错误率仍然相当高，我们应该如何改进？</p><p>让我们先用以下方法解决欠拟合的问题：</p><p><strong>让模型更大</strong>（比如加入更多的层，每层中使用更多的单元）；<strong>减少正规化</strong>；<strong>错误分析</strong>；<strong>选择另一种性能更好的模型架构</strong>；<strong>调节超参数</strong>；<strong>加入更多特征</strong>。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/81f0dabd20b8413591c0f4d4418bcbde><p class=pgc-img-caption>△ 解决欠拟合问题</p></div><p class=ql-align-right><br></p><p>首先，我们给模型加入更多的层，转换到ResNet-101，调节学习率，使训练集错误率降低到0.8%。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ad96c1bcde1347ebb5e5608fe1ce8019><p class=pgc-img-caption>△ 把训练集错误率降低到目标值以内</p></div><p class=ql-align-right><br></p><p>在出现过拟合后，我们可以增加训练集的样本量解决这个问题，把图片数量扩大到25万张。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e1f9a1067d6d402fa88ef50de4767ae3><p class=pgc-img-caption>△ 解决过拟合问题</p></div><p class=ql-align-right><br></p><p>经历过优化参数、权重衰减、数据增强等一系列操作后，我们终于把测试错误率降低到目标值。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/513a554f21394a0e899240f7e46d101f><p class=pgc-img-caption>△ 目标错误率</p></div><p class=ql-align-right><br></p><p>接下来我们着手解决训练集和测试集的分布偏差问题。</p><p>分析测试验证集错误率，收集或者合成更多训练数据弥补二者的偏差。比如下面的自动驾驶目标识别模型，训练完成后，让它判断图片里有没有人，常常发生错误。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4b57756364864260a451b5cc66e23f74><p class=pgc-img-caption>△ 分析自动驾驶数据集的分布偏差</p></div><p class=ql-align-right><br></p><p>经过分析得出，训练集缺乏夜晚场景、反光等情况。后续将在训练集中加入此类数据纠正偏差。</p><p>另一种修正错误率的方法称为领域适配，这是一种使用未标记或有限标记数据进行训练的技术。它能在源分布上进行训练，并将其推广到另一个“目标”。</p><p><strong>超参数优化</strong></p><p>这是调试的最后一步，我们需要选取那些更敏感的超参数，下图是模型对不同超参数的敏感性：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4843d7e8cbf140f7a63f88d91c05a51d><p class=pgc-img-caption>△ 模型对不同超参数的敏感性</p></div><p class=ql-align-right><br></p><p>常用的超参数优化方法有：手动优化、网格搜索、随机搜索、由粗到细、贝叶斯优化。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=超详细深度学习debug指南，国外小哥手把手教你如何调试模型 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/cde86cc504914ca8b9da4847e5fb3f7c><p class=pgc-img-caption>△ 由粗到细的随机搜索</p></div><p class=ql-align-right><br></p><p>你可以手动优化超参数，但是耗时而且需要理解算法的细节。Josh推荐的方法是<strong>由粗到细的随机搜索</strong>、<strong>贝叶斯优化</strong>。</p><p>由粗到细的随机搜索可以缩小超高性能参数的范围，缺点是由一些手动的操作。贝叶斯优化是优化超参数最有效一种无需手动干涉的方式，具体操作请参考：</p><p>https://towardsdatascience.com/a-conceptual-explanation-of-bayesian-model-based-hyperparameter-optimization-for-machine-learning-b8172278050f</p><p>最后附上本文提到的所有资源。</p><h1><strong>资源汇总</strong></h1><p>下载地址（需科学前往）：</p><p>http://josh-tobin.com/assets/pdf/troubleshooting-deep-neural-networks-01-19.pdf</p><p>或者在我们的公众号中回复<strong>debug</strong>获取。</p><p>Josh在教程最后推荐了吴恩达的《Machine Learning Yearning》，这本书能帮你诊断机器学习系统中的错误：</p><p>http://www.mlyearning.org</p><p>另外杨百翰大学也有一篇搭建和调试深度学习模型的博客：</p><p>https://pcc.cs.byu.edu/2017/10/02/practical-advice-for-building-deep-neural-networks/</p><p>— <strong>完</strong> —</p><p><strong>诚挚招聘</strong></p><p>量子位正在招募编辑/记者，工作地点在北京中关村。期待有才气、有热情的同学加入我们！相关细节，请在量子位公众号(QbitAI)对话界面，回复“招聘”两个字。</p><p><strong>量子位 </strong>QbitAI · 头条号签约作者</p><p>վ'ᴗ' ի 追踪AI技术和产品新动态</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'超详细','学习','debug'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>