<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>云原生时代｜分布式系统设计知识图谱（内含22个知识点） | 极客快訊</title><meta property="og:title" content="云原生时代｜分布式系统设计知识图谱（内含22个知识点） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/4bb0cbf6ee294a2c8fbe4e046c504798"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/00125706.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/00125706.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/00125706.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/00125706.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/00125706.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/00125706.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/00125706.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/00125706.html><meta property="article:published_time" content="2020-11-14T21:04:37+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:37+08:00"><meta name=Keywords content><meta name=description content="云原生时代｜分布式系统设计知识图谱（内含22个知识点）"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/00125706.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>云原生时代｜分布式系统设计知识图谱（内含22个知识点）</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>我们身处于一个充斥着分布式系统解决方案的计算机时代，无论是支付宝、微信这样顶级流量产品、还是区块链、IOT等热门概念、抑或如火如荼的容器生态技术如Kubernetes，其背后的技术架构核心都离不开分布式系统。</p><h1><strong>为什么要懂分布式架构</strong></h1><p>系统学习分布式架构设计对于技术人的成长非常关键，对于云原生开发者而言如何设计出符合云原生设计哲学的应用往往离不开分布式系统知识与方法论的运用。如何设计出高弹性、可配置、可分布、高性能、高容错、更安全、更韧性、快交付的原生应用往往是衡量开发者水准的重要参考。</p><p>然后而分布式系统是一个很大的概念，从架构设计、研发流程、运维部署、工程效率等多个角度均有很深的知识可以挖掘，学习成本和难道相对较大。近期整理了过去阅读过的一些和分布式相关书刊和文章，加上自己做分布式开发的一些的心得分享给大家，本文作为开篇，总体上给出知识概览，后续将分篇结合代码实践来进行阐述。起草仓促，水平有限，欢迎大家一起学习指正。</p><p>分布式系统大图</p><div class=pgc-img><img alt=云原生时代｜分布式系统设计知识图谱（内含22个知识点） onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/4bb0cbf6ee294a2c8fbe4e046c504798><p class=pgc-img-caption></p></div><p>一、设计</p><p>网关模式，Gateway</p><p>功能</p><ul><li>请求路由，客户端直接调用 Gateway，Gateway 负责路由转发到注册服务上</li><li>服务注册，后端服务将 API 注册，Gateway 负责路由</li><li>负载均衡，支持多种负载策略</li><li class=ql-indent-1>round robin</li><li class=ql-indent-1>随机均衡算法</li><li class=ql-indent-1>多权重负载</li><li class=ql-indent-1>session 粘连</li><li class=ql-indent-1>其它</li><li>安全特性，支持 HTTPS，账户鉴权，及其它安全特性支持</li><li>灰度发布，可以针对服务版本或者租户等特性做灰度发布</li><li>API 聚合，将多个后端接口聚合，减少客户端调用次数</li><li>API 编排，通过编排来串接多个 API 完成特定业务</li></ul><p>设计要点</p><ul><li>可用性，必须保证高可用</li><li>扩展性，可以灵活扩展以支持特定业务比如特定业务流控</li><li>高性能，通常使用异步 IO 模型框架实现，比如 Java netty，Go Channel</li><li>安全，如加密通信，鉴权，DDOS 防御等</li><li>运维</li><li class=ql-indent-1>应用监控，包括容量，性能，异常检测等</li><li class=ql-indent-1>弹性伸缩，具备高弹性能力，以低成本应对高峰值</li><li>架构</li><li class=ql-indent-1>与业务解耦合，提供扩展扩展机制比如 Plugin，Serverless 的思路支持后端业务</li><li class=ql-indent-1>服务隔离，可以按照后端服务划分网关，做到不同服务使用不同网关</li><li class=ql-indent-1>网关部署靠近后端，保证网络损耗最小，性能最佳</li></ul><p>边车模式，Sidecar</p><p>价值</p><ul><li>分离控制与逻辑，分离业务逻辑与路由，流控，熔断，幂等，服务发现，鉴权等控制组件</li><li>适用场景</li><li class=ql-indent-1>老系统改造扩展，Sidebar 进程与服务进程部署在同一个节点，通过网络协议通讯</li><li class=ql-indent-1>多语言混合分布式系统扩展</li><li class=ql-indent-1>应用程序由多方提供</li></ul><p>设计要点</p><ul><li>标准服务协议，Sidebar 到 Service，Sidebar 到 Sidebar 协议尽可能与语言解耦</li><li>聚合控制逻辑比如流控，熔断，幂等，重试，减少业务逻辑</li><li>不要使用对服务侵入的方式进行进程间通讯如信号量，共享内存，优先使用本地网络通讯的方式比如 TPCP 或者 HTTP</li></ul><p>服务网格，Service Mesh</p><p>新一代微服务架构，本质是服务间通信的基础设施层。</p><div class=pgc-img><img alt=云原生时代｜分布式系统设计知识图谱（内含22个知识点） onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/0c10062ef2ea49f5bf824935f3009992><p class=pgc-img-caption></p></div><p>架构图</p><p>特点</p><ul><li>应用间通讯中间层</li><li>轻量级网络代理</li><li>解耦应用程序</li><li>应用程序无感知</li></ul><p>主流框架</p><ul><li>Istio</li><li>Linkerd</li></ul><p>分布式锁</p><p>解决方案</p><ul><li>Redis分布式锁，SETNX key value PX expiretime</li><li class=ql-indent-1>value 生成，最好全局唯一比如TraceID，可以使用/dev/urandom生成</li><li class=ql-indent-1>expiretime单位是毫秒，过期锁自动释放 ，锁持有者保证过期时间内争抢资源完成计算</li><li>悲观锁，先获取锁，再进行操作，吞吐量底</li><li>乐观锁，使用版本号方式实现，吞吐量高，可能出现锁异常，适用于多读情况</li><li>CAS，修改共享数据源的场景可以代替分布式锁</li></ul><p>设计要点</p><ul><li>排他性，任意条件只有一个client可以获取锁</li><li>锁有自动释放方式，比如超时释放</li><li>锁必须高可用，且持久化</li><li>锁必须非阻塞且可重入</li><li>避免死锁，client最终一定可以获取锁，不存在异常情况锁无法释放的情况</li><li>集群容错性，集群部分机器故障，锁操作仍然可用</li></ul><p>配置中心</p><ul><li>静态配置，环境及软件启动配置</li><li>动态配置，运行时动态调整的配置如流控开关，熔断开关等</li></ul><p>异步通讯</p><ul><li>请求响应式，发送方直接向接收方发送请求</li><li class=ql-indent-1>发送方主动轮询</li><li class=ql-indent-1>发送方注册一个回调函数，接收方处理完成后回调发送方</li><li>事件驱动设计（EDA）</li><li class=ql-indent-1>消息订阅，发送方发布消息，接收方订阅并消费消息</li><li class=ql-indent-1>Broker 中间人，发送方向Broker发布消息，接收方向Broker订阅消息，彼此解耦,比如中间件RocketMQ</li><li>事情驱动设计优势</li><li class=ql-indent-2>服务间依赖解除</li><li class=ql-indent-1>服务隔离程度高</li></ul><p>幂等性</p><ul><li>本质是一个操作，无论执行多少次，执行结果总是一致的</li><li>幂等核心是全局唯一ID，链路依据全局ID做幂等，依据业务复杂度可以选取多种实现方式</li><li class=ql-indent-1>数据库自增长ID</li><li class=ql-indent-1>本地生成uuid</li><li class=ql-indent-1>Redis生产id</li><li class=ql-indent-1>Twitter开源算法 Snowflake</li><li>HTTP幂等性，除POST外，HEAD，GET，OPTIONS，DELETE，PUT均满足幂等</li></ul><p>二、性能</p><p>分布式缓存</p><ul><li>缓存更新模式</li><li class=ql-indent-1>Cache Aside，常用模式，应用要维护缓存的失效，命中，更新等动作</li><li class=ql-indent-1>Read/Write Through，缓存代理更新数据库操作，应用视角只有一份存储</li><li class=ql-indent-1>Write Behind Cache，IO加速方式之一，更新操作只在内测完成，异步进行批量更新数据库</li></ul><p>异步处理</p><ul><li>Push模型，中心调度，复杂度高</li><li>Pull模型，无中心调度，复杂度底</li><li>Push+Pull模型</li></ul><p>数据库扩展</p><ul><li>数据库分片</li><li>垂直分片</li><li class=ql-indent-1>字段拆分，将变化频率不同的字段拆分到不同表</li><li>水平分片</li><li class=ql-indent-2>哈希算法来分，数据离散度高，降低热点可能性</li><li class=ql-indent-2>通过时间范围分片，保证数据连续性</li><li class=ql-indent-1>按照业务种类划分，比如数据分类，租户分离等</li><li>分片设计要点</li><li class=ql-indent-2>分片要预留足够空间，避免重新分片</li><li class=ql-indent-2>分片聚合要并行去做</li><li class=ql-indent-1>业务尽可能不去做跨分片的事务</li></ul><p>三、容错</p><p>系统可用性</p><ul><li>MTTF, Mean Time To Failure，系统平均运行多长时间才发生故障，越长越好</li><li>MTTR,Mean Time To Recover, 故障平均修复时间，越短越好</li><li>可用性计算公式， Availability= MTTF /（MTTF+MTTR）</li></ul><p>服务降级</p><ul><li>降低一致性</li><li class=ql-indent-1>强一致性，将所有的同步一致性，切换为最终一致性，提高吞吐量</li><li class=ql-indent-1>弱一致性，必要时候牺牲一致性换取服务整体可靠性</li><li>关闭次要服务</li><li class=ql-indent-1>不同应用，关闭次要应用，释放物理资源</li><li class=ql-indent-1>相同应用，关闭应用次要功能，更多资源给到核心功能</li><li>简化服务功能</li><li class=ql-indent-1>如简化业务流程，减少通讯数据等</li></ul><p>服务限流</p><ul><li>限流目的</li><li class=ql-indent-1>SLA保证方式之一</li><li class=ql-indent-1>应对突发峰刺流量，一定程度节约容量规划成本</li><li class=ql-indent-1>租户隔离策略之一，避免某些用户占用其它用户的资源，导致服务大范围不可用</li><li>限流方式</li><li class=ql-indent-1>服务降级</li><li class=ql-indent-1>服务拒绝</li><li>解决方案</li><li class=ql-indent-1>服务权重划分，多租户环境将资源按权重划分，保证重要客户的资源</li><li class=ql-indent-1>服务延时处理，加入服务缓冲队列延缓服务压力，用于削峰</li><li class=ql-indent-1>服务弹性伸缩，依赖服务监控，弹性伸缩容</li><li>流控算法</li><li>计数器</li><li class=ql-indent-1>单机或者集群保存某用户某时间段请求数，达到阈值则触发流控</li><li>队列算法</li><li>FIFO队列</li><li class=ql-indent-2>请求速度波动，消费速度均匀，队列满则流控</li><li>权重队列</li><li class=ql-indent-2>按服务划分优先级队列，不同队列权重不同</li><li>队列算法设计关键：队列长度的预设非常关键</li><li class=ql-indent-3>队列太长，流控未生效，服务已经被打死</li><li class=ql-indent-1>队列太短，流控被频繁触发，体验差</li><li>漏斗算法</li><li class=ql-indent-2>本质上是队列+限流器实现，限流器保证消费速度均匀类TCP sync backlog</li><li class=ql-indent-1>转发速度均匀</li><li>令牌桶</li><li class=ql-indent-2>中间人已恒定速率向桶里发放令牌，服务请求拿到token则开始服务，否则不处理</li><li class=ql-indent-1>转发速度不均匀，流量小时积累，流量大时消费</li><li>动态流控</li><li class=ql-indent-1>实时计算服务能力如QPS，对比服务RT如果RT过大，则减少QPS</li><li>设计要点</li><li class=ql-indent-1>手动开关，主动运维和应急使用</li><li class=ql-indent-1>监控通知，限流发生时干系人要清楚</li><li class=ql-indent-1>用户感知，如返回特定错误信息（错误code/错误提示）</li><li class=ql-indent-1>链路标识，RPC链路加入限流标识方便上下游业务识别限流场景做不同处理</li></ul><p>熔断设计</p><ul><li>场景</li><li class=ql-indent-1>过载保护，系统负载过高情况为防止故障产生，而采取的一种保护措施</li><li class=ql-indent-1>防止应用程序不断尝试可能会失败的操作</li><li>三个状态</li><li class=ql-indent-1>Closed，闭合状态，正常状态，系统需要一个基于时间线到错误计数器，如果错误累计达到阈值则切换至Open状态</li><li class=ql-indent-1>Open，断开状态，所有对服务对请求立即返回错误，不用调用后端服务进行计算</li><li class=ql-indent-1>Half-Open，半开状态，允许部分请求流量进入并处理，如果请求成功则按照某种策略切换到Closed状态</li><li>设计要点</li><li class=ql-indent-1>定义触发熔断的错误类型</li><li class=ql-indent-1>所有触发熔断的错误请求必须要有统一的日志输出</li><li class=ql-indent-1>熔断机制必须有服务诊断及自动恢复能力</li><li class=ql-indent-1>最好为熔断机制设置手动开关用于三种状态的切换</li><li class=ql-indent-1>熔断要切分业务，做到业务隔离熔断</li></ul><p>补偿事务</p><ul><li>CAP</li><li class=ql-indent-1>一致性(Consistence)、可用性(Availability)、分区容忍性(Partition Tolerance)</li><li>BASE</li><li class=ql-indent-1>Basic Availabillity，基本可用</li><li class=ql-indent-1>Soft State，软状态</li><li class=ql-indent-1>Eventual Consistency，最终一致性</li><li>Design For Failure</li><li>Exponential Blackoff，指数级退避</li></ul><p>四、DevOps</p><p>部署</p><ul><li>基础设施</li><li>云</li><li class=ql-indent-2>公有云</li><li class=ql-indent-2>私有云</li><li class=ql-indent-1>混合云</li><li>容器技术</li><li class=ql-indent-2>Docker</li><li class=ql-indent-1>Kubernetes</li><li>部署策略</li><li class=ql-indent-1>停机部署</li><li class=ql-indent-1>滚动部署</li><li class=ql-indent-1>蓝绿部署</li><li class=ql-indent-1>灰度部署</li><li class=ql-indent-1>A/B 测试</li></ul><p>配置管理</p><ul><li>Ansible</li><li>Puppet</li><li>Shippable</li></ul><p>监控</p><ul><li>Nagios</li><li>DynaTrace</li></ul><p>CI与CD</p><p>五、工程效率</p><p>敏捷管理</p><ul><li>Scrum</li></ul><p>持续集成</p><ul><li>Jenkins</li><li>CodeShip</li></ul><p>持续交付</p><p>写在最后</p><p>分布式系统在阿里巴巴经济有着广泛的应用，以笔者所在的弹性技术团队为例，当业务足够规模化后，最终面临的技术问题都是通过践行分布式系统架构的设计理念和方法轮得以解决，可以说分布式系统架构的知识与方法论是当前互联网应用规模化后的通用解决方案。</p><p>学习分布式系统设计也不是一蹴而就，需要不断汲取理论知识，然后将理论不断付诸实践，最终通过一次次的调优来将知识的价值最大化。笔者最后的建议是先理论、后实践、重实践、不妥协，所谓纸上得来终觉浅，绝知此事要躬行，与君共勉。</p><p>作者：一绿舟</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'时代','系统','设计'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>