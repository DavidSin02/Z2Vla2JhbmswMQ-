<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>JVM 垃圾收集器细节补充 | 极客快訊</title><meta property="og:title" content="JVM 垃圾收集器细节补充 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/97bc94b0a276433a809abd99b14bd724"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/030e9343.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/030e9343.html><meta property="article:published_time" content="2020-10-29T21:10:13+08:00"><meta property="article:modified_time" content="2020-10-29T21:10:13+08:00"><meta name=Keywords content><meta name=description content="JVM 垃圾收集器细节补充"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/030e9343.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>JVM 垃圾收集器细节补充</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>禁用 System.gc()</h1><p>System.gc() 会显式直接触发 Full GC，同时对老年代和新生代进行回收。JVM 的内存回收都是自动的，一般情况下不需要我们手动触发 GC。因此如果要在程序中禁用，可以通过-XX:+DisableExplicitGC禁用。当程序中使用了System.gc()，就相当于调用了一个空函数。</p><h1>对象何时进入老年代</h1><p>一般情况下，新创建的对象会出现在新生代的 Eden区。对于存活时间长的对象，进入老年代的情况有以下2种：</p><ul><li>普通对象晋升老年代</li></ul><p>JVM 中提供了 -XX:MaxTenuringThreshold=15 这个参数来指定，普通对象晋升老年代经历的GC的最大次数。这个参数值默认是15，当然对象往往不到15次GC就已经进入了老年代。</p><p>晋升中还有一个比较重要的参数，-XX:TargetSurvivorRatio=50。它用来指定suvivor区的使用率达到50%时（默认值），触发晋升老年代。</p><ul><li>大对象直接进入老年代</li></ul><p>通常来说，我们对于Java项目的堆分配，老年代会占到一大半的容量。所以当新生代（Eden/Survivor）容量不足时，新创建的大对象会直接进入老年代。</p><p>我们可以通过 -XX:PretenureSizeThreshold （单位字节）来指定直接晋升老年代的对象大小。但是在测试时往往会出现以下情况，对象达到设置大小并未进入老年代。这是因为JVM在使用内存空间时，会优先使用一块TLAB的区域。</p><p>TLAB（Thread Local Allocation Buffer）是线程本地分配缓存。它占用了 Eden区的空间，JVM 会为每一个Java线程分配一块 TLAB空间。启用参数是：-XX:+UseTLAB （JVM默认开启）。</p><h1>对象分配简要流程</h1><p>我们所熟知的是对象是在对上分配的，但是对象的分配大致会经历以下几个流程。首先会尝试在栈上分配，栈上分配的对象会随着方法块的执行结束，而自动被回收。如果失败了，则会尝试TLAB分配。如果再失败了，则会检查是否满足直接进入老年代的条件，满足则在老年代分配。如果不满足，则在Eden区分配。简要流程如下所示：</p><div class=pgc-img><img alt="JVM 垃圾收集器细节补充" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/97bc94b0a276433a809abd99b14bd724><p class=pgc-img-caption>对象分配简要流程</p></div><h1>finalize() 对 GC 的影响</h1><p>finalize() 方法类似于C++中的析构函数，它在对象即将被GC回收器回收的时候执行1次。但是尽量不要使用finalize()对资源进行释放，尽量不要重写该方法，原因如下：</p><ul><li>finalize() 可能会造成对象复活</li><li>执行时间是没有保障的，它完全由 GC线程决定。极端情况下，如果不发生GC，finalize() 将不会执行</li><li>如写的不好，则有可能严重影响 GC 性能</li></ul><p>finalize() 是由 FinalizerThread 线程处理的。每个即将被回收的并且包含有finalize()方法的对象，都会被在正式回收前加入 FinalizerThread 的执行队列（为 ReferenceQueue 引用队列）。</p><p>FinalizerThread 的工作过程和FinalizerThread执行队列关系如下所示：</p><div class=pgc-img><img alt="JVM 垃圾收集器细节补充" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cc277b9da55c4f699fbfc3aeae7fd09f><p class=pgc-img-caption>FinalizerThread 的工作过程</p></div><h1>​​​​​​​常用 GC 参数整理</h1><p><strong>串行收集器相关</strong></p><ul><li>-XX:+UseSerialGC：在新生代和老年代使用串行收集器。</li><li>-XX:SurvivorRatio：设置Eden区和Survivor区的比例。设置为8，则两个Survivor区与一个Eden区的比值为2:8，一个Survivor区占整个年轻代的1/10。</li><li>-XX:PretenureSizeThreshold：设置大对象进入老年代的阀值（单位字节）。</li><li>-XX:MaxTenuringThreshold：设置进入老年代年龄的最大值，每一次新生代GC都会加1（默认15）。</li></ul><p><strong>并行 GC 相关</strong></p><ul><li>-XX:+UseParNewGC：新生代使用并行收集器。</li><li>-XX:+UseParallelOldGC：老年代使用并行回收。</li><li>-XX:ParallelGCThreads：设置用户GC的线程数。通常情况下可以和CPU个数相同，但CPU较多的情况下，可以相对设置小一些。</li><li>-XX:MaxGCPauseMillis：设置GC最大停顿时间。</li><li>-XX:GCTimeRatio：设置吞吐量大小。取值0-100之间的整数。如设置为n，则系统花费不超过1/(n+1)的时间用于GC。</li><li>-XX:+UseAdaptiveSizePolicy：打开自适应GC策略。这种模式下，JVM的各个参数都将会被动态调整，以达到堆大小、吞吐量和停顿时间的平衡。</li></ul><p><strong>CMS 相关</strong></p><ul><li>-XX:+UseConcMarkSweepGC：新生代使用并行回收器，老年代使用CMS+串行回收。</li><li>-XX:ParallelCMSThreads：设定CMS的线程数量。</li><li>-XX:CMSInitiatingOccupancyFraction：设置CMS收集器在老年代使用多少后触发GC，默认68%。</li><li>-XX:+UseCMSCompactAtFullCollection：设置CMS收集器在完成垃圾收集后，是否要进行一次碎片整理。</li><li>-XX:CMSFullGCsBeforeCompaction：设定进行多少次CMS回收后，进行一次内存压缩。</li><li>-XX:+CMSClassUnloadingEnabled：允许对元数据区进行回收。</li><li>-XX:CMSInitiatingPermOccupancyFraction：当永久区使用率达到这一百分比时，启动CMS回收。（前提是CMSClassUnloadingEnabled开启）</li><li>-XX:UseCMSInitiatingOccupancyOnly：表示只在达到阀值的时候才进行CMS回收。</li><li>-XX:+CMSIncrementalMode：使用增量模式，比较适合单CPU。JDK8中废弃，JDK9中已移除。</li></ul><p><strong>G1 相关</strong></p><ul><li>-XX:+UseG1GC：使用G1收集器。</li><li>-XX:MaxGCPauseMillis：设置最大停顿时间。</li><li>-XX:GCPauseIntervalMillis：设置停顿间隔时间。</li></ul><p><strong>TLAB 相关</strong></p><ul><li>-XX:+UseTLAB：开启TLAB分配。</li><li>-XX:+PrintTLAB：打印TLAB相关分配信息。</li><li>-XX:TLABSize：设置TLAB大小。</li><li>-XX:+ResizeTLAB：自动调整TLAB大小。</li></ul><p><strong>其他</strong></p><ul><li>-XX:+DisableExplicitGC：禁用显示GC。</li><li>-XX:+ExplicitGCInvokesConcurrent：使用并发的方式处理显示GC。</li></ul><hr><p>参考：《实战Java虚拟机》</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'收集器','JVM','细节'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>