<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>这可能是最通俗易懂的方式讲解ARM中断原理以及中断嵌套 | 极客快訊</title><meta property="og:title" content="这可能是最通俗易懂的方式讲解ARM中断原理以及中断嵌套 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/dfic-imagehandler/0544061d-fcb9-479e-9805-221cc8270f14"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0354fcc9.html><meta property="article:published_time" content="2020-10-29T21:09:37+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:37+08:00"><meta name=Keywords content><meta name=description content="这可能是最通俗易懂的方式讲解ARM中断原理以及中断嵌套"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/0354fcc9.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>这可能是最通俗易懂的方式讲解ARM中断原理以及中断嵌套</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>几天前一个学生问我ARM中断嵌套的问题，我才发现原来在我心中理所当然的事对学生来说理解实属不易。</p><p>ARM有七种模式，我们这里只讨论SVC、IRQ和FIQ模式。<br></p><div class=pgc-img><img alt=这可能是最通俗易懂的方式讲解ARM中断原理以及中断嵌套 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/0544061d-fcb9-479e-9805-221cc8270f14><p class=pgc-img-caption></p></div><p><br>我们可以假设ARM核心有两根中断引脚（实际上是看不见的），一根叫 irq pin, 一根叫fiq pin。在ARM的cpsr中，有一个I位和一个F位，分别用来禁止IRQ和FIQ。</p><p>当I位和F位为0时，irq pin上有中断信号过来时，就会打断arm的当前工作，并且切换到IRQ模式下，跳到相应的异常向量表（vector)位置去执行代码。这个过程是自动的，但是返回到被中断打断的地方就得您亲自动手。</p><p>当你跳到异常向量表，处于IRQ的模式的时候，此时如果irq pin上面又来中断信号，此时ARM是不会理你的，irq pin就像秘书，ARM核心就像老板，老板本来在做事，然后来了一个客户，秘书打断它，让客户进去。而此时再来一个客户，要么秘书不断去敲门问，要么客户走人。老板第一个客户没有会见完，不会理你。<br>但是有一种情况例外，当ARM处在IRQ模式，这个时候fiq pin来了一个中断信号，fiq pin是什么？快速中断，好比公安局的来查刑事案件，才不管老板是不是在会见客户，直接打断，进入到fiq模式，跳到相应的fiq的异常向量表处去执行代码。那如果当ARM处理FIQ模式，fiq pin又来中断信号，也就是又一批公安来了，那没戏，都是执法人员，你打不断我。如果此时irq pin来了呢？来了也不理，正在办案，还敢来妨碍公务。</p><p><br></p><div class=pgc-img><img alt=这可能是最通俗易懂的方式讲解ARM中断原理以及中断嵌套 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/abc3015a-dba4-4777-9edd-312b7c111040><p class=pgc-img-caption></p></div><p><br>所以得出一个结论： <strong>IRQ模式只能被FIQ模式打断，FIQ模式下谁也打不断</strong>。<br>在打不断的情况下，irq pin 或fiq pin随便你怎么发中断信号，都是白发。<br>所以<strong>除了fiq能打断irq以外，根本没有所谓中断嵌套的情况</strong>。<br>但是再怎么说irq pin 和fiq pin加起来也就2根引脚，这么多中断源，怎么办呢？不可能谁来了都直接敲门吧。<br>接下来该说谁来给irq pin或者 fiq pin发信号。从上文可以看到，可能是老板客户，也可能是公安。在ARM中，这个事情由中断控制器管理。<br>拿最简单的2410/2440的中断控制器举例，中断控制器加一个子中断控制器，还有一个外部中断控制器管理了50多个中断资源，说穿了有50多个脚。这些脚除了外部中断都是规定了功能的，比如WDT、LCD、DMA等，这个功能不能改，因为2410/2440内部硬件连线已经决定了。<br>当WDT和DMA中断都到来时，会被送到SRCPND寄存器中，两个中断都在里面，到底把哪一个送给ARM呢？这个时候先看INTMOD，也就是中断模式寄存器：哪个中断被设置成快速中断，哪个就被送上去；如果两个都被设置为快速中断呢？这不可能，因为<strong>同一时间只能有一个中断可以被设成快速中断</strong>。所以，如果有快速中断，这个时候直接给fiq pin发中断信号，打断ARM。<br>要是没有快速中断呢，这个时候就看INTMSK，看WDT和DMA有没有被屏蔽，如果DMA在INTMSK被屏蔽，只有WDT继续向上送，如果都没有屏蔽，那么他们两个同时进入优先级寄存器PRIORITY，在这里根据优先级设置，一定会分出一个高一个低的优先级出来，优先级高的那个被送到INTPND寄存器，所以INTPND随时随地有且只有一个中断在里面。只要INTPND里面有中断，irq pin就不会一直不断给ARM发中断信号，当第一次发的时候，中断了ARM，这个时候ARM进入相应的异常向量并处于IRQ模式。</p><p>此时，INTPND仍然不断的通过irq pin向ARM发中断信号，但是此时ARM已经处于IRQ模式，不会理睬你。当你中断处理完，要退出IRQ模式，这个时候要小心，如果退出IRQ模式之前不清除INTPND里面的中断位，刚退出IRQ模式，又会被中断，因为INTPND一直在发中断信号。所以在退出IRQ模式前一定要清除INTPND里面的中断位<strong>。</strong></p><p><br></p><div class=pgc-img><img alt=这可能是最通俗易懂的方式讲解ARM中断原理以及中断嵌套 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/dfic-imagehandler/2d3f38c7-5e25-4bdf-ab73-e3049ee76cbd><p class=pgc-img-caption></p></div><p><br></p><p>光清除INTPND里面的位还不行，因为SRCPND里面WDT和DMA的中断在，当你刚清除完INTPND，结果SRCPND里面又选了一个中断出来送到INTPND里面。所以正确的处理方法是<strong>退出IRQ模式之前，先清除SRCPND里相应的中断位，再清除INTPND里相应的位。</strong>请注意，SRCPND里面可能有多个位，所以清除你已处理过的中断就行，而INTPND里面只可能有一位，直接清掉即可。</p><p>再说说Linux的情况。<strong>Linux不用FIQ，只用到了IRQ</strong>。但是我们有时候一个中断需要处理很长时间，我们需要占用IRQ模式那么长的时间吗？不需要，linux在IRQ模式下只是简单的记录是什么中断，马上切换回SVC模式，换句话说，<strong>linux的中断处理都是在SVC模式下处理的。</strong></p><p>那么中断号是怎么来的呢？它在ARM上固定死了，相应的中断号只有一个办法得到：查询irqs.h 。先用一个中断号注册一个中断处理程序，当中断发生的时候，Linux怎么知道是我这个中断号发生的中断呢？在处理中断的时候，先读取INTPND，根据需要再读取EINTPEND或SUBSRCPND计算出一个中断号，相应的处理算法在get_irq_nr_base这个宏中。irqs.h中的中断号就是根据这个算法把每个中断号算出来的。</p><p><br><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6848454170815496716/?group_id=6848454170815496716" rel="noopener noreferrer" target=_blank>「基础知识普及」ARM与X86 CPU架构区别</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6848158330179813899/?group_id=6848158330179813899" rel="noopener noreferrer" target=_blank>ARM指令adr adrl ldr mov简单科普</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/c/user/66995122454/#mid=1576400294145038" rel="noopener noreferrer" target=_blank>了解更多</a></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'中断','讲解','ARM'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>