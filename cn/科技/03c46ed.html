<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>PostgreSQL 关于字段类型的修改 谣言与止谣 | 极客快訊</title><meta property="og:title" content="PostgreSQL  关于字段类型的修改 谣言与止谣 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/06567b130c4848f3949956e81e5c5b65"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/03c46ed.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/03c46ed.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/03c46ed.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/03c46ed.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/03c46ed.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/03c46ed.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/03c46ed.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/03c46ed.html><meta property="article:published_time" content="2020-10-29T20:59:31+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:31+08:00"><meta name=Keywords content><meta name=description content="PostgreSQL  关于字段类型的修改 谣言与止谣"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/03c46ed.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>PostgreSQL 关于字段类型的修改 谣言与止谣</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>​</p><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/06567b130c4848f3949956e81e5c5b65><p class=pgc-img-caption></p></div><p>PostgreSQL 在9.2 之前是要面临一个指责，就是在更改字段类型的时候带来的不堪，假象你有100万行的数据，其中一个字段是varchar(20) ,你想将其更改为 varhcar(30), 这可能就要造成一个灾难，熟悉postgresql 原理的人们，马上就想到，可能要生成一个“新表”了。导致Postgres重写表的每一行，这可能是一个非常昂贵的操作(就磁盘I/O和挂钟时间而言），MYSQL 早期的版本也没有好到哪里去，可是这对难兄难弟，都会成长。</p><p>PostgreSQL 在9.2 之后修改字段的大小，例如 varchar(20) ---> varchar(30) 返回修改仅仅是一瞬间的事情。</p><p><br></p><p>所以现在如果还有人说，PG修改字段的大小太差劲，那我到是觉得活在上世纪的 someone 可以清理一下内存了，终归新的东西是要不断学习的，你去看看现在的MYSQL 8 如果你的知识还保留在 MYSQL 5.5 ，那你一定也需要更新了。</p><p><br></p><p>那问题1 如果你还在使用PG 9.2 之前的版本，并继续受到这个问题的缠绕，怎么办</p><p><br></p><p>1 升级数据库版本 （当然这个说法估计支持的声音不少，但实际上做的人不多，因为牵扯的资源和人太多，没有人愿意在没有占有这个数据库系统的开发或者第三方开发商的支持下去做这个事情）</p><p><br></p><p>2 建议将字段更换为text字段，（或者经常需要变动的文字的字段），</p><pre><code>ALTER TABLE test ALTER COLUMN puzzle TYPE text;ALTER TABLE test ADD CONSTRAINT checksum_lengthCHECK (LENGTH(puzzle) &lt;= 32);我们先看看这个方法合适吗,这个方法当然合适，字段的扩充可以换个思路，我们可以给的无限，然后后面通过约束限制一下，这样DBA 和开发其实都开心</code></pre><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/40cd4680eb0048a88f3254cfe389db76><p class=pgc-img-caption></p></div><p>当然也有人说，你加完约束，系统的性能会受到影响，来来来我们做一个测试，插入1百万的数据，仅仅需要6秒多.</p><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/719e8ab828914223850bd449190d39fa><p class=pgc-img-caption></p></div><p>当然这并不是本期主要的话题，本期的主要话题是</p><p><br></p><p>这里要澄清的是，不是所有的PG 的 Alter Column type 操作都要进行重建表的操作（这里先不牵扯索引的事情）</p><p><br></p><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/04c1c6d8948c4acb826b61a62e8af5e0><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/86ff1a759007405e9711a08240c6cedf><p class=pgc-img-caption></p></div><p>这就是今天要进行测试的表，PG的版本 PG 12.2</p><p>测试如下</p><p>1 name 的类型从 char 变为 varchar 在变成 text</p><p><br></p><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0b23742d911c463d91068cbebf11a03b><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0034985a89254200a0dd036eec8a0229><p class=pgc-img-caption></p></div><p>2 将上面的变化在变回来</p><p>将整形从小变大 从大变小，将日期类型进行变化</p><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c41b3550fad5438090a71532f14813d5><p class=pgc-img-caption></p></div><p>这些都是需要重写的</p><p><br></p><p>说完这些可能还有些人有疑问</p><p>1 添加一个字段呢，添加一个带默认值的字段呢</p><p>2 删除一个字段呢</p><p>3 更改一个字段的名字呢</p><p><br></p><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dc94dc00cdfb4ee8bd7ccda2cafe0dfd><p class=pgc-img-caption></p></div><p><br></p><p>结果是这些都不需要重写，另外在PG11 已经解决了关于 默认值的问题，这个问题，其实在有的商业数据库到很新的版本还是一个问题。</p><p><br></p><p>最后是关于索引的问题，这里PG 建立索引尽量要使用</p><p><br></p><p>CREATE INDEX CONCURRENTLY idx_add_c on type_change (add_c);</p><p>根据PG 的原理来说，我们在建立索引如果不使用 concurrently 参数则建立索引时表要 获取一个 access exclusive 的锁，而如果我们使用了 concurrently 则我们会获得一个 share update exclusive 的锁。所以使用了concurrently 则会允许在索引建立的同时继续读取数据和写入数据，当然也有一些副作用，今天就不说了，这个 concurrently 其实也可以找一期说一下，也是有点意思。</p><p><br></p><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b803244978154d4dbfc9f44a361e92cb><p class=pgc-img-caption></p></div><p></p><div class=pgc-img><img alt="PostgreSQL  关于字段类型的修改 谣言与止谣" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cf56530d77ec41f488340e65a196c784><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'PostgreSQL','关于字','类型'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>