<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ä½¿ç”¨ ZeroMQ æ¶ˆæ¯åº“åœ¨ C å’Œ Python é—´å…±äº«æ•°æ® | Linux ä¸­å›½ | æå®¢å¿«è¨Š</title><meta property="og:title" content="ä½¿ç”¨ ZeroMQ æ¶ˆæ¯åº“åœ¨ C å’Œ Python é—´å…±äº«æ•°æ® | Linux ä¸­å›½ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/e00533e8a53343e3ba562f759fdcebdd"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0502e19.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0502e19.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0502e19.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0502e19.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0502e19.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0502e19.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0502e19.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0502e19.html><meta property="article:published_time" content="2020-10-29T21:04:29+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:29+08:00"><meta name=Keywords content><meta name=description content="ä½¿ç”¨ ZeroMQ æ¶ˆæ¯åº“åœ¨ C å’Œ Python é—´å…±äº«æ•°æ® | Linux ä¸­å›½"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/0502e19.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ä½¿ç”¨ ZeroMQ æ¶ˆæ¯åº“åœ¨ C å’Œ Python é—´å…±äº«æ•°æ® | Linux ä¸­å›½</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div class=pgc-img><img alt="ä½¿ç”¨ ZeroMQ æ¶ˆæ¯åº“åœ¨ C å’Œ Python é—´å…±äº«æ•°æ® | Linux ä¸­å›½" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e00533e8a53343e3ba562f759fdcebdd><p class=pgc-img-caption></p></div><blockquote><p>ZeroMQ æ˜¯ä¸€ä¸ªå¿«é€Ÿçµæ´»çš„æ¶ˆæ¯åº“ï¼Œç”¨äºæ•°æ®æ”¶é›†å’Œä¸åŒç¼–ç¨‹è¯­è¨€é—´çš„æ•°æ®å…±äº«ã€‚</p></blockquote><p style=text-align:start>â€¢ æ¥æºï¼šlinux.cn â€¢ ä½œè€…ï¼šCristiano L. Fontana â€¢ è¯‘è€…ï¼šSilentDawn â€¢</p><p style=text-align:start>ï¼ˆæœ¬æ–‡å­—æ•°ï¼š12873ï¼Œé˜…è¯»æ—¶é•¿å¤§çº¦ï¼š15 åˆ†é’Ÿï¼‰</p><p style=text-align:start><br></p><p style=text-align:start>ä½œä¸ºè½¯ä»¶å·¥ç¨‹å¸ˆï¼Œæˆ‘æœ‰å¤šæ¬¡åœ¨è¦æ±‚å®ŒæˆæŒ‡å®šä»»åŠ¡æ—¶æ„Ÿåˆ°æµ‘èº«ä¸€å†·çš„ç»å†ã€‚å…¶ä¸­æœ‰ä¸€æ¬¡ï¼Œæˆ‘å¿…é¡»åœ¨ä¸€äº›æ–°çš„ç¡¬ä»¶åŸºç¡€è®¾æ–½å’Œäº‘åŸºç¡€è®¾æ–½ä¹‹é—´å†™ä¸€ä¸ªæ¥å£ï¼Œè¿™äº›ç¡¬ä»¶éœ€è¦ C è¯­è¨€ï¼Œè€Œäº‘åŸºç¡€è®¾æ–½ä¸»è¦æ˜¯ç”¨ Pythonã€‚</p><p style=text-align:start>å®ç°çš„æ–¹å¼ä¹‹ä¸€æ˜¯ ç”¨ C å†™æ‰©å±•æ¨¡å— ï¼ŒPython æ”¯æŒ C æ‰©å±•çš„è°ƒç”¨ã€‚å¿«é€Ÿæµè§ˆæ–‡æ¡£åå‘ç°ï¼Œè¿™éœ€è¦ç¼–å†™å¤§é‡çš„ C ä»£ç ã€‚è¿™æ ·åšçš„è¯ï¼Œåœ¨æœ‰äº›æƒ…å†µä¸‹æ•ˆæœè¿˜ä¸é”™ï¼Œä½†ä¸æ˜¯æˆ‘å–œæ¬¢çš„æ–¹å¼ã€‚å¦ä¸€ç§æ–¹å¼å°±æ˜¯å°†ä¸¤ä¸ªä»»åŠ¡æ”¾åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œå¹¶ä½¿ç”¨ ZeroMQ æ¶ˆæ¯åº“ åœ¨ä¸¤è€…ä¹‹é—´äº¤æ¢æ¶ˆæ¯ã€‚</p><p style=text-align:start>åœ¨å‘ç° ZeroMQ ä¹‹å‰ï¼Œé‡åˆ°è¿™ç§ç±»å‹çš„æƒ…å†µæ—¶ï¼Œæˆ‘é€‰æ‹©äº†ç¼–å†™æ‰©å±•çš„æ–¹å¼ã€‚è¿™ç§æ–¹å¼ä¸ç®—å¤ªå·®ï¼Œä½†éå¸¸è´¹æ—¶è´¹åŠ›ã€‚å¦‚ä»Šï¼Œä¸ºäº†é¿å…é‚£äº›é—®é¢˜ï¼Œæˆ‘å°†ä¸€ä¸ªç³»ç»Ÿç»†åˆ†ä¸ºç‹¬ç«‹çš„è¿›ç¨‹ï¼Œé€šè¿‡ é€šä¿¡å¥—æ¥å­— å‘é€æ¶ˆæ¯æ¥äº¤æ¢ä¿¡æ¯ã€‚è¿™æ ·ï¼Œä¸åŒçš„ç¼–ç¨‹è¯­è¨€å¯ä»¥å…±å­˜ï¼Œæ¯ä¸ªè¿›ç¨‹ä¹Ÿå˜ç®€å•äº†ï¼ŒåŒæ—¶ä¹Ÿå®¹æ˜“è°ƒè¯•ã€‚</p><p style=text-align:start>ZeroMQ æä¾›äº†ä¸€ä¸ªæ›´ç®€å•çš„è¿‡ç¨‹ï¼š</p><ol start=1><li>ç¼–å†™ä¸€å°æ®µ C ä»£ç ï¼Œä»ç¡¬ä»¶è¯»å–æ•°æ®ï¼Œç„¶åæŠŠå‘ç°çš„ä¸œè¥¿ä½œä¸ºæ¶ˆæ¯å‘é€å‡ºå»ã€‚</li><li>ä½¿ç”¨ Python ç¼–å†™æ¥å£ï¼Œå®ç°æ–°æ—§åŸºç¡€è®¾æ–½ä¹‹é—´çš„å¯¹æ¥ã€‚</li></ol><p style=text-align:start>Pieter Hintjens æ˜¯ ZeroMQ é¡¹ç›®å‘èµ·è€…ä¹‹ä¸€ï¼Œä»–æ˜¯ä¸ªæ‹¥æœ‰ æœ‰è¶£è§†è§’å’Œä½œå“ çš„éå‡¡äººç‰©ã€‚</p><h1 class=pgc-h-arrow-right>å‡†å¤‡</h1><p style=text-align:start>æœ¬æ•™ç¨‹ä¸­ï¼Œéœ€è¦ï¼š</p><ul><li>ä¸€ä¸ª C ç¼–è¯‘å™¨ï¼ˆä¾‹å¦‚ GCC æˆ– Clang ï¼‰</li><li>libzmq åº“</li><li>Python 3</li><li>ZeroMQ çš„ Python å°è£…</li></ul><p style=text-align:start>Fedora ç³»ç»Ÿä¸Šçš„å®‰è£…æ–¹æ³•ï¼š</p><pre><code>$ dnf install clang zeromq zeromq-devel python3 python3-zmq</code></pre><p style=text-align:start>Debian å’Œ Ubuntu ç³»ç»Ÿä¸Šçš„å®‰è£…æ–¹æ³•ï¼š</p><pre><code>$ apt-get install clang libzmq5 libzmq3-dev python3 python3-zmq</code></pre><p style=text-align:start>å¦‚æœæœ‰é—®é¢˜ï¼Œå‚è€ƒå¯¹åº”é¡¹ç›®çš„å®‰è£…æŒ‡å—ï¼ˆä¸Šé¢é™„æœ‰é“¾æ¥ï¼‰ã€‚</p><h1 class=pgc-h-arrow-right>ç¼–å†™ç¡¬ä»¶æ¥å£åº“</h1><p style=text-align:start>å› ä¸ºè¿™é‡Œé’ˆå¯¹çš„æ˜¯ä¸ªè®¾æƒ³çš„åœºæ™¯ï¼Œæœ¬æ•™ç¨‹è™šæ„äº†åŒ…å«ä¸¤ä¸ªå‡½æ•°çš„æ“ä½œåº“ï¼š</p><ul><li>fancyhw_init() ç”¨æ¥åˆå§‹åŒ–ï¼ˆè®¾æƒ³çš„ï¼‰ç¡¬ä»¶</li><li>fancyhw_read_val() ç”¨äºè¿”å›ä»ç¡¬ä»¶è¯»å–çš„æ•°æ®</li></ul><p style=text-align:start>å°†åº“çš„å®Œæ•´ä»£ç ä¿å­˜åˆ°æ–‡ä»¶ libfancyhw.h ä¸­:</p><pre><code>#ifndef LIBFANCYHW_H#define LIBFANCYHW_H#include &lt;stdlib.h&gt;#include &lt;stdint.h&gt;// This is the fictitious hardware interfacing libraryvoid fancyhw_init(unsigned int init_param){Â Â Â Â srand(init_param);}int16_t fancyhw_read_val(void){Â Â Â Â return (int16_t)rand();}#endif</code></pre><p style=text-align:start>è¿™ä¸ªåº“å¯ä»¥æ¨¡æ‹Ÿä½ è¦åœ¨ä¸åŒè¯­è¨€å®ç°çš„ç»„ä»¶é—´äº¤æ¢çš„æ•°æ®ï¼Œä¸­é—´æœ‰ä¸ªéšæœºæ•°å‘ç”Ÿå™¨ã€‚</p><h1 class=pgc-h-arrow-right>è®¾è®¡ C æ¥å£</h1><p style=text-align:start>ä¸‹é¢ä»åŒ…å«ç®¡ç†æ•°æ®ä¼ è¾“çš„åº“å¼€å§‹ï¼Œé€æ­¥å®ç° C æ¥å£ã€‚</p><p><strong>éœ€è¦çš„åº“</strong></p><p style=text-align:start>å¼€å§‹å…ˆåŠ è½½å¿…è¦çš„åº“ï¼ˆæ¯ä¸ªåº“çš„ä½œç”¨è§ä»£ç æ³¨é‡Šï¼‰ï¼š</p><pre><code>// For printf()#include &lt;stdio.h&gt;// For EXIT_*#include &lt;stdlib.h&gt;// For memcpy()#include &lt;string.h&gt;// For sleep()#include &lt;unistd.h&gt;#include &lt;zmq.h&gt;#include "libfancyhw.h"</code></pre><p><strong>å¿…è¦çš„å‚æ•°</strong></p><p style=text-align:start>å®šä¹‰ main å‡½æ•°å’Œåç»­è¿‡ç¨‹ä¸­å¿…è¦çš„å‚æ•°ï¼š</p><pre><code>int main(void){Â  Â  const unsigned int INIT_PARAM = 12345;Â  Â  const unsigned int REPETITIONS = 10;Â  Â  const unsigned int PACKET_SIZE = 16;Â  Â  const char *TOPIC = "fancyhw_data";Â  Â  ...</code></pre><p><strong>åˆå§‹åŒ–</strong></p><p style=text-align:start>æ‰€æœ‰çš„åº“éƒ½éœ€è¦åˆå§‹åŒ–ã€‚è™šæ„çš„é‚£ä¸ªåªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼š</p><pre><code>fancyhw_init(INIT_PARAM);</code></pre><p style=text-align:start>ZeroMQ åº“éœ€è¦å®æ‰“å®çš„åˆå§‹åŒ–ã€‚é¦–å…ˆï¼Œå®šä¹‰å¯¹è±¡ contextï¼Œå®ƒæ˜¯ç”¨æ¥ç®¡ç†å…¨éƒ¨çš„å¥—æ¥å­—çš„ï¼š</p><pre><code>void *context = zmq_ctx_new();if (!context){Â Â Â Â printf("ERROR: ZeroMQ error occurred during zmq_ctx_new(): %s\n", zmq_strerror(errno));Â Â Â Â return EXIT_FAILURE;}</code></pre><p style=text-align:start>ä¹‹åå®šä¹‰ç”¨æ¥å‘é€æ•°æ®çš„å¥—æ¥å­—ã€‚ZeroMQ æ”¯æŒè‹¥å¹²ç§å¥—æ¥å­—ï¼Œå„æœ‰å…¶ç”¨ã€‚ä½¿ç”¨ publish å¥—æ¥å­—ï¼ˆä¹Ÿå« PUB å¥—æ¥å­—ï¼‰ï¼Œå¯ä»¥å¤åˆ¶æ¶ˆæ¯å¹¶åˆ†å‘åˆ°å¤šä¸ªæ¥æ”¶ç«¯ã€‚è¿™ä½¿å¾—ä½ å¯ä»¥è®©å¤šä¸ªæ¥æ”¶ç«¯æ¥æ”¶åŒä¸€ä¸ªæ¶ˆæ¯ã€‚æ²¡æœ‰æ¥æ”¶è€…çš„æ¶ˆæ¯å°†è¢«ä¸¢å¼ƒï¼ˆå³ä¸ä¼šå…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚ç”¨æ³•å¦‚ä¸‹ï¼š</p><pre><code>void *data_socket = zmq_socket(context, ZMQ_PUB);</code></pre><p style=text-align:start>å¥—æ¥å­—éœ€è¦ç»‘å®šåˆ°ä¸€ä¸ªå…·ä½“çš„åœ°å€ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±çŸ¥é“è¦è¿æ¥å“ªé‡Œäº†ã€‚æœ¬ä¾‹ä¸­ï¼Œä½¿ç”¨äº† TCP ä¼ è¾“å±‚ ï¼ˆå½“ç„¶ä¹Ÿæœ‰ å…¶å®ƒé€‰é¡¹ ï¼Œä½† TCP æ˜¯ä¸é”™çš„é»˜è®¤é€‰æ‹©ï¼‰ï¼š</p><pre><code>const int rb = zmq_bind(data_socket, "tcp://*:5555");if (rb != 0){Â Â Â Â printf("ERROR: ZeroMQ error occurred during zmq_ctx_new(): %s\n", zmq_strerror(errno));Â Â Â Â return EXIT_FAILURE;}</code></pre><p style=text-align:start>ä¸‹ä¸€æ­¥, è®¡ç®—ä¸€äº›åç»­è¦ç”¨åˆ°çš„å€¼ã€‚ æ³¨æ„ä¸‹é¢ä»£ç ä¸­çš„ TOPICï¼Œå› ä¸º PUB å¥—æ¥å­—å‘é€çš„æ¶ˆæ¯éœ€è¦ç»‘å®šä¸€ä¸ªä¸»é¢˜ã€‚ä¸»é¢˜ç”¨äºä¾›æ¥æ”¶è€…è¿‡æ»¤æ¶ˆæ¯ï¼š</p><pre><code>const size_t topic_size = strlen(TOPIC);const size_t envelope_size = topic_size + 1 + PACKET_SIZE * sizeof(int16_t);printf("Topic: %s; topic size: %zu; Envelope size: %zu\n", TOPIC, topic_size, envelope_size);</code></pre><p><strong>å‘é€æ¶ˆæ¯</strong></p><p style=text-align:start>å¯åŠ¨ä¸€ä¸ªå‘é€æ¶ˆæ¯çš„å¾ªç¯ï¼Œå¾ªç¯ REPETITIONS æ¬¡ï¼š</p><pre><code>for (unsigned int i = 0; i &lt; REPETITIONS; i++){Â Â Â Â ...</code></pre><p style=text-align:start>å‘é€æ¶ˆæ¯å‰ï¼Œå…ˆå¡«å……ä¸€ä¸ªé•¿åº¦ä¸º PACKET_SIZE çš„ç¼“å†²åŒºã€‚æœ¬åº“æä¾›çš„æ˜¯ 16 ä¸ªä½çš„æœ‰ç¬¦å·æ•´æ•°ã€‚å› ä¸º C è¯­è¨€ä¸­ int ç±»å‹å ç”¨ç©ºé—´å¤§å°ä¸å¹³å°ç›¸å…³ï¼Œä¸æ˜¯ç¡®å®šçš„å€¼ï¼Œæ‰€ä»¥è¦ä½¿ç”¨æŒ‡å®šå®½åº¦çš„ int å˜é‡ï¼š</p><pre><code>int16_t buffer[PACKET_SIZE];for (unsigned int j = 0; j &lt; PACKET_SIZE; j++){Â Â Â Â buffer[j] = fancyhw_read_val();}printf("Read %u data values\n", PACKET_SIZE);</code></pre><p style=text-align:start>æ¶ˆæ¯çš„å‡†å¤‡å’Œå‘é€çš„ç¬¬ä¸€æ­¥æ˜¯åˆ›å»º ZeroMQ æ¶ˆæ¯ï¼Œä¸ºæ¶ˆæ¯åˆ†é…å¿…è¦çš„å†…å­˜ç©ºé—´ã€‚ç©ºç™½çš„æ¶ˆæ¯æ˜¯ç”¨äºå°è£…è¦å‘é€çš„æ•°æ®çš„ï¼š</p><pre><code>zmq_msg_t envelope;const int rmi = zmq_msg_init_size(&amp;envelope, envelope_size);if (rmi != 0){Â Â Â Â printf("ERROR: ZeroMQ error occurred during zmq_msg_init_size(): %s\n", zmq_strerror(errno));Â Â Â Â zmq_msg_close(&amp;envelope);Â Â Â Â break;}</code></pre><p style=text-align:start>ç°åœ¨å†…å­˜ç©ºé—´å·²åˆ†é…ï¼Œæ•°æ®ä¿å­˜åœ¨ ZeroMQ æ¶ˆæ¯ â€œä¿¡å°â€ä¸­ã€‚å‡½æ•° zmq_msg_data() è¿”å›ä¸€ä¸ªæŒ‡å‘å°è£…æ•°æ®ç¼“å­˜åŒºé¡¶ç«¯çš„æŒ‡é’ˆã€‚ç¬¬ä¸€éƒ¨åˆ†æ˜¯ä¸»é¢˜ï¼Œä¹‹åæ˜¯ä¸€ä¸ªç©ºæ ¼ï¼Œæœ€åæ˜¯äºŒè¿›åˆ¶æ•°ã€‚ä¸»é¢˜å’ŒäºŒè¿›åˆ¶æ•°æ®ä¹‹é—´çš„åˆ†éš”ç¬¦é‡‡ç”¨ç©ºæ ¼å­—ç¬¦ã€‚éœ€è¦éå†ç¼“å­˜åŒºçš„è¯ï¼Œä½¿ç”¨ç±»å‹è½¬æ¢å’Œ æŒ‡é’ˆç®—æ³• ã€‚ï¼ˆæ„Ÿè°¢ C è¯­è¨€ï¼Œè®©äº‹æƒ…å˜å¾—ç›´æˆªäº†å½“ã€‚ï¼‰åšæ³•å¦‚ä¸‹ï¼š</p><pre><code>memcpy(zmq_msg_data(&amp;envelope), TOPIC, topic_size);memcpy((void*)((char*)zmq_msg_data(&amp;envelope) + topic_size), " ", 1);memcpy((void*)((char*)zmq_msg_data(&amp;envelope) + 1 + topic_size), buffer, PACKET_SIZE * sizeof(int16_t))</code></pre><p style=text-align:start>é€šè¿‡ data_socket å‘é€æ¶ˆæ¯ï¼š</p><pre><code>const size_t rs = zmq_msg_send(&amp;envelope, data_socket, 0);if (rs != envelope_size){Â Â Â Â printf("ERROR: ZeroMQ error occurred during zmq_msg_send(): %s\n", zmq_strerror(errno));Â Â Â Â zmq_msg_close(&amp;envelope);Â Â Â Â break;}</code></pre><p style=text-align:start>ä½¿ç”¨æ•°æ®ä¹‹å‰è¦å…ˆè§£é™¤å°è£…ï¼š</p><pre><code>zmq_msg_close(&amp;envelope);printf("Message sent; i: %u, topic: %s\n", i, TOPIC);</code></pre><p><strong>æ¸…ç†</strong></p><p style=text-align:start>C è¯­è¨€ä¸æä¾› åƒåœ¾æ”¶é›† åŠŸèƒ½ï¼Œç”¨å®Œä¹‹åè®°å¾—è¦è‡ªå·±æ‰«å°¾ã€‚å‘é€æ¶ˆæ¯ä¹‹åç»“æŸç¨‹åºä¹‹å‰ï¼Œéœ€è¦è¿è¡Œæ‰«å°¾ä»£ç ï¼Œé‡Šæ”¾åˆ†é…çš„å†…å­˜:</p><pre><code>const int rc = zmq_close(data_socket);if (rc != 0){Â Â Â Â printf("ERROR: ZeroMQ error occurred during zmq_close(): %s\n", zmq_strerror(errno));Â Â Â Â return EXIT_FAILURE;}const int rd = zmq_ctx_destroy(context);if (rd != 0){Â Â Â Â printf("Error occurred during zmq_ctx_destroy(): %s\n", zmq_strerror(errno));Â Â Â Â return EXIT_FAILURE;}return EXIT_SUCCESS;</code></pre><p><strong>å®Œæ•´ C ä»£ç </strong></p><p style=text-align:start>ä¿å­˜ä¸‹é¢å®Œæ•´çš„æ¥å£ä»£ç åˆ°æœ¬åœ°åä¸º hw_interface.c çš„æ–‡ä»¶ï¼š</p><pre><code>// For printf()#include &lt;stdio.h&gt;// For EXIT_*#include &lt;stdlib.h&gt;// For memcpy()#include &lt;string.h&gt;// For sleep()#include &lt;unistd.h&gt;#include &lt;zmq.h&gt;#include "libfancyhw.h"int main(void){Â Â Â Â const unsigned int INIT_PARAM = 12345;Â Â Â Â const unsigned int REPETITIONS = 10;Â Â Â Â const unsigned int PACKET_SIZE = 16;Â Â Â Â const char *TOPIC = "fancyhw_data";Â Â Â Â fancyhw_init(INIT_PARAM);Â Â Â Â void *context = zmq_ctx_new();Â Â Â Â if (!context)Â Â Â Â {Â Â Â Â Â Â Â Â printf("ERROR: ZeroMQ error occurred during zmq_ctx_new(): %s\n", zmq_strerror(errno));Â Â Â Â Â Â Â Â return EXIT_FAILURE;Â Â Â Â }Â Â Â Â void *data_socket = zmq_socket(context, ZMQ_PUB);Â Â Â Â const int rb = zmq_bind(data_socket, "tcp://*:5555");Â Â Â Â if (rb != 0)Â Â Â Â {Â Â Â Â Â Â Â Â printf("ERROR: ZeroMQ error occurred during zmq_ctx_new(): %s\n", zmq_strerror(errno));Â Â Â Â Â Â Â Â return EXIT_FAILURE;Â Â Â Â }Â Â Â Â const size_t topic_size = strlen(TOPIC);Â Â Â Â const size_t envelope_size = topic_size + 1 + PACKET_SIZE * sizeof(int16_t);Â Â Â Â printf("Topic: %s; topic size: %zu; Envelope size: %zu\n", TOPIC, topic_size, envelope_size);Â Â Â Â for (unsigned int i = 0; i &lt; REPETITIONS; i++)Â Â Â Â {Â Â Â Â Â Â Â Â int16_t buffer[PACKET_SIZE];Â Â Â Â Â Â Â Â for (unsigned int j = 0; j &lt; PACKET_SIZE; j++)Â Â Â Â Â Â Â Â {Â Â Â Â Â Â Â Â Â Â Â Â buffer[j] = fancyhw_read_val();Â Â Â Â Â Â Â Â }Â Â Â Â Â Â Â Â printf("Read %u data values\n", PACKET_SIZE);Â Â Â Â Â Â Â Â zmq_msg_t envelope;Â Â  Â Â Â Â Â Â Â Â const int rmi = zmq_msg_init_size(&amp;envelope, envelope_size);Â Â Â Â Â Â Â Â if (rmi != 0)Â Â Â Â Â Â Â Â {Â Â Â Â Â Â Â Â Â Â Â Â printf("ERROR: ZeroMQ error occurred during zmq_msg_init_size(): %s\n", zmq_strerror(errno));Â Â  Â Â Â Â Â Â Â Â Â Â Â Â zmq_msg_close(&amp;envelope);Â Â  Â Â Â Â Â Â Â Â Â Â Â Â break;Â Â Â Â Â Â Â Â }Â Â Â Â Â Â  Â Â Â Â Â Â Â Â memcpy(zmq_msg_data(&amp;envelope), TOPIC, topic_size);Â Â Â Â Â Â Â Â memcpy((void*)((char*)zmq_msg_data(&amp;envelope) + topic_size), " ", 1);Â Â Â Â Â Â Â Â memcpy((void*)((char*)zmq_msg_data(&amp;envelope) + 1 + topic_size), buffer, PACKET_SIZE * sizeof(int16_t));Â Â  Â Â Â Â Â Â Â Â const size_t rs = zmq_msg_send(&amp;envelope, data_socket, 0);Â Â Â Â Â Â Â Â if (rs != envelope_size)Â Â Â Â Â Â Â Â {Â Â Â Â Â Â Â Â Â Â Â Â printf("ERROR: ZeroMQ error occurred during zmq_msg_send(): %s\n", zmq_strerror(errno));Â Â  Â Â Â Â Â Â Â Â Â Â Â Â zmq_msg_close(&amp;envelope);Â Â  Â Â Â Â Â Â Â Â Â Â Â Â break;Â Â Â Â Â Â Â Â }Â Â  Â Â Â Â Â Â Â Â zmq_msg_close(&amp;envelope);Â Â Â Â Â Â Â Â printf("Message sent; i: %u, topic: %s\n", i, TOPIC);Â Â Â Â Â Â Â Â sleep(1);Â Â Â Â }Â Â Â Â const int rc = zmq_close(data_socket);Â Â Â Â if (rc != 0)Â Â Â Â {Â Â Â Â Â Â Â Â printf("ERROR: ZeroMQ error occurred during zmq_close(): %s\n", zmq_strerror(errno));Â Â Â Â Â Â Â Â return EXIT_FAILURE;Â Â Â Â }Â Â Â Â const int rd = zmq_ctx_destroy(context);Â Â Â Â if (rd != 0)Â Â Â Â {Â Â Â Â Â Â Â Â printf("Error occurred during zmq_ctx_destroy(): %s\n", zmq_strerror(errno));Â Â Â Â Â Â Â Â return EXIT_FAILURE;Â Â Â Â }Â Â Â Â return EXIT_SUCCESS;}</code></pre><p style=text-align:start>ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘ï¼š</p><pre><code>$ clang -std=c99 -I. hw_interface.c -lzmq -o hw_interface</code></pre><p style=text-align:start>å¦‚æœæ²¡æœ‰ç¼–è¯‘é”™è¯¯ï¼Œä½ å°±å¯ä»¥è¿è¡Œè¿™ä¸ªæ¥å£äº†ã€‚è´´å¿ƒçš„æ˜¯ï¼ŒZeroMQ PUB å¥—æ¥å­—å¯ä»¥åœ¨æ²¡æœ‰ä»»ä½•åº”ç”¨å‘é€æˆ–æ¥å—æ•°æ®çš„çŠ¶æ€ä¸‹è¿è¡Œï¼Œè¿™ç®€åŒ–äº†ä½¿ç”¨å¤æ‚åº¦ï¼Œå› ä¸ºè¿™æ ·ä¸é™åˆ¶è¿›ç¨‹å¯åŠ¨çš„æ¬¡åºã€‚</p><p style=text-align:start>è¿è¡Œè¯¥æ¥å£ï¼š</p><pre><code>$ ./hw_interfaceTopic: fancyhw_data; topic size: 12; Envelope size: 45Read 16 data valuesMessage sent; i: 0, topic: fancyhw_dataRead 16 data valuesMessage sent; i: 1, topic: fancyhw_dataRead 16 data values......</code></pre><p style=text-align:start>è¾“å‡ºæ˜¾ç¤ºæ•°æ®å·²ç»é€šè¿‡ ZeroMQ å®Œæˆå‘é€ï¼Œç°åœ¨è¦åšçš„æ˜¯è®©ä¸€ä¸ªç¨‹åºå»è¯»æ•°æ®ã€‚</p><h1 class=pgc-h-arrow-right>ç¼–å†™ Python æ•°æ®å¤„ç†å™¨</h1><p style=text-align:start>ç°åœ¨å·²ç»å‡†å¤‡å¥½ä» C ç¨‹åºå‘ Python åº”ç”¨ä¼ é€æ•°æ®äº†ã€‚</p><p><strong>åº“</strong></p><p style=text-align:start>éœ€è¦ä¸¤ä¸ªåº“å¸®åŠ©å®ç°æ•°æ®ä¼ è¾“ã€‚é¦–å…ˆæ˜¯ ZeroMQ çš„ Python å°è£…ï¼š</p><pre><code>$ python3 -m pip install zmq</code></pre><p style=text-align:start>å¦ä¸€ä¸ªå°±æ˜¯ struct åº“ ï¼Œç”¨äºè§£ç äºŒè¿›åˆ¶æ•°æ®ã€‚è¿™ä¸ªåº“æ˜¯ Python æ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨ pip å‘½ä»¤å®‰è£…ã€‚</p><p style=text-align:start>Python ç¨‹åºçš„ç¬¬ä¸€éƒ¨åˆ†æ˜¯å¯¼å…¥è¿™äº›åº“ï¼š</p><pre><code>import zmqimport struct</code></pre><p><strong>é‡è¦å‚æ•°</strong></p><p style=text-align:start>ä½¿ç”¨ ZeroMQ æ—¶ï¼Œåªèƒ½å‘å¸¸é‡ TOPIC å®šä¹‰ç›¸åŒçš„æ¥æ”¶ç«¯å‘é€æ¶ˆæ¯ï¼š</p><pre><code>topic = "fancyhw_data".encode('ascii')print("Reading messages with topic: {}".format(topic))</code></pre><p><strong>åˆå§‹åŒ–</strong></p><p style=text-align:start>ä¸‹ä¸€æ­¥ï¼Œåˆå§‹åŒ–ä¸Šä¸‹æ–‡å’Œå¥—æ¥å­—ã€‚ä½¿ç”¨ subscribe å¥—æ¥å­—ï¼ˆä¹Ÿç§°ä¸º SUB å¥—æ¥å­—ï¼‰ï¼Œå®ƒæ˜¯ PUB å¥—æ¥å­—çš„å¤©ç”Ÿä¼´ä¾£ã€‚è¿™ä¸ªå¥—æ¥å­—å‘é€æ—¶ä¹Ÿéœ€è¦åŒ¹é…ä¸»é¢˜ã€‚</p><pre><code>with zmq.Context() as context:Â  Â  socket = context.socket(zmq.SUB)Â  Â  socket.connect("tcp://127.0.0.1:5555")Â  Â  socket.setsockopt(zmq.SUBSCRIBE, topic)Â  Â  i = 0Â  Â  ...</code></pre><p><strong>æ¥æ”¶æ¶ˆæ¯</strong></p><p style=text-align:start>å¯åŠ¨ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œç­‰å¾…æ¥æ”¶å‘é€åˆ° SUB å¥—æ¥å­—çš„æ–°æ¶ˆæ¯ã€‚è¿™ä¸ªå¾ªç¯ä¼šåœ¨ä½ æŒ‰ä¸‹ Ctrl+C ç»„åˆé”®æˆ–è€…å†…éƒ¨å‘ç”Ÿé”™è¯¯æ—¶ç»ˆæ­¢ï¼š</p><pre><code>Â  Â  try:Â  Â  Â  Â  while True:Â  Â  Â  Â  Â  Â  ... # we will fill this in nextÂ  Â  except KeyboardInterrupt:Â  Â  Â  Â  socket.close()Â  Â  except Exception as error:Â  Â  Â  Â  print("ERROR: {}".format(error))Â  Â  Â  Â  socket.close()</code></pre><p style=text-align:start>è¿™ä¸ªå¾ªç¯ç­‰å¾… recv() æ–¹æ³•è·å–çš„æ–°æ¶ˆæ¯ï¼Œç„¶åå°†æ¥æ”¶åˆ°çš„å†…å®¹ä»ç¬¬ä¸€ä¸ªç©ºæ ¼å­—ç¬¦å¤„åˆ†å‰²å¼€ï¼Œä»è€Œå¾—åˆ°ä¸»é¢˜ï¼š</p><pre><code>binary_topic, data_buffer = socket.recv().split(b' ', 1)</code></pre><p><strong>è§£ç æ¶ˆæ¯</strong></p><p style=text-align:start>Python æ­¤æ—¶å°šä¸çŸ¥é“ä¸»é¢˜æ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œä½¿ç”¨æ ‡å‡† ASCII ç¼–è§£ç å™¨è¿›è¡Œè§£ç ï¼š</p><pre><code>topic = binary_topic.decode(encoding = 'ascii')print("Message {:d}:".format(i))print("\ttopic: '{}'".format(topic))</code></pre><p style=text-align:start>ä¸‹ä¸€æ­¥å°±æ˜¯ä½¿ç”¨ struct åº“è¯»å–äºŒè¿›åˆ¶æ•°æ®ï¼Œå®ƒå¯ä»¥å°†äºŒè¿›åˆ¶æ•°æ®æ®µè½¬æ¢ä¸ºæ˜ç¡®çš„æ•°å€¼ã€‚é¦–å…ˆï¼Œè®¡ç®—æ•°æ®åŒ…ä¸­æ•°å€¼çš„ç»„æ•°ã€‚æœ¬ä¾‹ä¸­ä½¿ç”¨çš„ 16 ä¸ªä½çš„æœ‰ç¬¦å·æ•´æ•°å¯¹åº”çš„æ˜¯ struct æ ¼å¼å­—ç¬¦ ä¸­çš„ hï¼š</p><pre><code>packet_size = len(data_buffer) // struct.calcsize("h")print("\tpacket size: {:d}".format(packet_size))</code></pre><p style=text-align:start>çŸ¥é“æ•°æ®åŒ…ä¸­æœ‰å¤šå°‘ç»„æ•°æ®åï¼Œå°±å¯ä»¥é€šè¿‡æ„å»ºä¸€ä¸ªåŒ…å«æ•°æ®ç»„æ•°å’Œæ•°æ®ç±»å‹çš„å­—ç¬¦ä¸²ï¼Œæ¥å®šä¹‰æ ¼å¼äº†ï¼ˆæ¯”å¦‚â€œ16hâ€ï¼‰ï¼š</p><pre><code>struct_format = "{:d}h".format(packet_size)</code></pre><p style=text-align:start>å°†äºŒè¿›åˆ¶æ•°æ®ä¸²è½¬æ¢ä¸ºå¯ç›´æ¥æ‰“å°çš„ä¸€ç³»åˆ—æ•°å­—ï¼š</p><pre><code>data = struct.unpack(struct_format, data_buffer)print("\tdata: {}".format(data))</code></pre><p><strong>å®Œæ•´ Python ä»£ç </strong></p><p style=text-align:start>ä¸‹é¢æ˜¯ Python å®ç°çš„å®Œæ•´çš„æ¥æ”¶ç«¯ï¼š</p><pre><code>#! /usr/bin/env python3import zmqimport structtopic = "fancyhw_data".encode('ascii')print("Reading messages with topic: {}".format(topic))with zmq.Context() as context:Â Â Â Â socket = context.socket(zmq.SUB)Â Â Â Â socket.connect("tcp://127.0.0.1:5555")Â Â Â Â socket.setsockopt(zmq.SUBSCRIBE, topic)Â Â Â Â i = 0Â Â Â Â try:Â Â Â Â Â Â Â Â while True:Â Â Â Â Â Â Â Â Â Â Â Â binary_topic, data_buffer = socket.recv().split(b' ', 1)Â Â Â Â Â Â Â Â Â Â Â Â topic = binary_topic.decode(encoding = 'ascii')Â Â Â Â Â Â Â Â Â Â Â Â print("Message {:d}:".format(i))Â Â Â Â Â Â Â Â Â Â Â Â print("\ttopic: '{}'".format(topic))Â Â Â Â Â Â Â Â Â Â Â Â packet_size = len(data_buffer) // struct.calcsize("h")Â Â Â Â Â Â Â Â Â Â Â Â print("\tpacket size: {:d}".format(packet_size))Â Â Â Â Â Â Â Â Â Â Â Â struct_format = "{:d}h".format(packet_size)Â Â Â Â Â Â Â Â Â Â Â Â data = struct.unpack(struct_format, data_buffer)Â Â Â Â Â Â Â Â Â Â Â Â print("\tdata: {}".format(data))Â Â Â Â Â Â Â Â Â Â Â Â i += 1Â Â Â Â except KeyboardInterrupt:Â Â Â Â Â Â Â Â socket.close()Â Â Â Â except Exception as error:Â Â Â Â Â Â Â Â print("ERROR: {}".format(error))Â Â Â Â Â Â Â Â socket.close()</code></pre><p style=text-align:start>å°†ä¸Šé¢çš„å†…å®¹ä¿å­˜åˆ°åä¸º online_analysis.py çš„æ–‡ä»¶ã€‚Python ä»£ç ä¸éœ€è¦ç¼–è¯‘ï¼Œä½ å¯ä»¥ç›´æ¥è¿è¡Œå®ƒã€‚</p><p style=text-align:start>è¿è¡Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><pre><code>$ ./online_analysis.pyReading messages with topic: b'fancyhw_data'Message 0:Â  Â  Â  Â  topic: 'fancyhw_data'Â  Â  Â  Â  packet size: 16Â  Â  Â  Â  data: (20946, -23616, 9865, 31416, -15911, -10845, -5332, 25662, 10955, -32501, -18717, -24490, -16511, -28861, 24205, 26568)Message 1:Â  Â  Â  Â  topic: 'fancyhw_data'Â  Â  Â  Â  packet size: 16Â  Â  Â  Â  data: (12505, 31355, 14083, -19654, -9141, 14532, -25591, 31203, 10428, -25564, -732, -7979, 9529, -27982, 29610, 30475)......</code></pre><h1 class=pgc-h-arrow-right>å°ç»“</h1><p style=text-align:start>æœ¬æ•™ç¨‹ä»‹ç»äº†ä¸€ç§æ–°æ–¹å¼ï¼Œå®ç°ä»åŸºäº C çš„ç¡¬ä»¶æ¥å£æ”¶é›†æ•°æ®ï¼Œå¹¶åˆ†å‘åˆ°åŸºäº Python çš„åŸºç¡€è®¾æ–½çš„åŠŸèƒ½ã€‚å€Ÿæ­¤å¯ä»¥è·å–æ•°æ®ä¾›åç»­åˆ†æï¼Œæˆ–è€…è½¬é€åˆ°ä»»æ„æ•°é‡çš„æ¥æ”¶ç«¯å»ã€‚å®ƒé‡‡ç”¨äº†ä¸€ä¸ªæ¶ˆæ¯åº“å®ç°æ•°æ®åœ¨å‘é€è€…å’Œå¤„ç†è€…ä¹‹é—´çš„ä¼ é€ï¼Œæ¥å–ä»£åŒæ ·åŠŸèƒ½è§„æ¨¡åºå¤§çš„è½¯ä»¶ã€‚</p><p style=text-align:start>æœ¬æ•™ç¨‹è¿˜å¼•å‡ºäº†æˆ‘ç§°ä¹‹ä¸ºâ€œè½¯ä»¶ç²’åº¦â€çš„æ¦‚å¿µï¼Œæ¢è¨€ä¹‹ï¼Œå°±æ˜¯å°†è½¯ä»¶ç»†åˆ†ä¸ºæ›´å°çš„éƒ¨åˆ†ã€‚è¿™ç§åšæ³•çš„ä¼˜ç‚¹ä¹‹ä¸€å°±æ˜¯ï¼Œä½¿å¾—åŒæ—¶é‡‡ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å®ç°æœ€ç®€æ¥å£ä½œä¸ºä¸åŒéƒ¨åˆ†ä¹‹é—´æ²Ÿé€šçš„ç»„ä»¶æˆä¸ºå¯èƒ½ã€‚</p><p style=text-align:start>å®è·µä¸­ï¼Œè¿™ç§è®¾è®¡ä½¿å¾—è½¯ä»¶å·¥ç¨‹å¸ˆèƒ½ä»¥æ›´ç‹¬ç«‹ã€åˆä½œæ›´é«˜æ•ˆçš„æ–¹å¼åšäº‹ã€‚ä¸åŒçš„å›¢é˜Ÿå¯ä»¥ä¸“æ³¨äºæ•°æ®åˆ†æçš„ä¸åŒæ–¹é¢ï¼Œå¯ä»¥é€‰æ‹©è‡ªå·±ä¸­æ„çš„å®ç°å·¥å…·ã€‚è¿™ç§åšæ³•çš„å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯å®ç°äº†é›¶ä»£ä»·çš„å¹¶è¡Œï¼Œå› ä¸ºæ‰€æœ‰çš„è¿›ç¨‹éƒ½å¯ä»¥å¹¶è¡Œè¿è¡Œã€‚ ZeroMQ æ¶ˆæ¯åº“ æ˜¯ä¸ªä»¤äººèµå¹çš„è½¯ä»¶ï¼Œä½¿ç”¨å®ƒå¯ä»¥è®©å·¥ä½œå¤§å¤§ç®€åŒ–ã€‚</p><hr><p style=text-align:start>via: opensource.com</p><p style=text-align:start>ä½œè€…ï¼š Cristiano L. Fontana é€‰é¢˜ï¼š lujun9972 è¯‘è€…ï¼š silentdawn-zz æ ¡å¯¹ï¼š wxy</p><p style=text-align:start>æœ¬æ–‡ç”± LCTT åŸåˆ›ç¼–è¯‘ï¼Œ Linuxä¸­å›½ è£èª‰æ¨å‡º</p><h1 class=pgc-h-arrow-right>ç‚¹å‡»â€œäº†è§£æ›´å¤šâ€å¯è®¿é—®æ–‡å†…é“¾æ¥</h1></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ZeroMQ','Python','æ•°æ®'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>