<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>轻松学会 React 钩子：以 useEffect() 为例 | 极客快訊</title><meta property="og:title" content="轻松学会 React 钩子：以 useEffect() 为例 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/SAeE5m89B94hKl"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0832a47.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0832a47.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0832a47.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0832a47.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0832a47.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0832a47.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0832a47.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0832a47.html><meta property="article:published_time" content="2020-10-29T20:59:18+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:18+08:00"><meta name=Keywords content><meta name=description content="轻松学会 React 钩子：以 useEffect() 为例"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/0832a47.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>轻松学会 React 钩子：以 useEffect() 为例</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>五年多前，我写过 React 系列教程[1]。不用说，内容已经有些过时了。</p><img alt="轻松学会 React 钩子：以 useEffect() 为例" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/SAeE5m89B94hKl><p>我本来不想碰它们了，觉得框架一直在升级，教程写出来就会过时。</p><img alt="轻松学会 React 钩子：以 useEffect() 为例" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/SAeE5ml2DUn3hy><p>但是，最近我逐渐体会到 React 钩子（hooks）非常好用，重新认识了 React 这个框架，觉得应该补上关于钩子的部分。</p><img alt="轻松学会 React 钩子：以 useEffect() 为例" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/SAeE5n7J5ShF3o><p>下面就来谈谈，怎样正确理解钩子，并且深入剖析最重要的钩子之一的<code>useEffect</code>。内容会尽量通俗，让不熟悉 React 的朋友也能看懂。欢迎大家参考我以前写的《React 框架入门》[2]和《React 最常用的四个钩子》[3]。</p><blockquote><p>本文得到了 开课吧 的支持，结尾有 React 视频学习资料。希望通过视频来系统学习 React 的同学，可以关注。</p></blockquote><p></p><h1 toutiao-origin=h2>一、React 的两套 API</h1><p>以前，React API 只有一套，现在有两套：类（class）API 和基于函数的钩子（hooks） API。</p><img alt="轻松学会 React 钩子：以 useEffect() 为例" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/SAeE5np58XhVId><p>任何一个组件，可以用类来写，也可以用钩子来写。下面是类的写法。</p><pre><code>class Welcome extends React.Component {<br>render {<br>return &lt;h1&gt;Hello, {this.props.name}&lt;/h1&gt;;<br>}<br>}<br></code></pre><p>再来看钩子的写法，也就是函数。</p><pre><code>function Welcome(props) {<br>return &lt;h1&gt;Hello, {props.name}&lt;/h1&gt;;<br>}<br></code></pre><p>这两种写法，作用完全一样。初学者自然会问：“我应该使用哪一套 API？”</p><p>官方推荐[4]使用钩子（函数），而不是类。因为钩子更简洁，代码量少，用起来比较“轻”，而类比较“重”。而且，钩子是函数，更符合 React 函数式的本质。</p><p>下面是类组件（左边）和函数组件（右边）代码量的比较。对于复杂的组件，差的就更多。</p><img alt="轻松学会 React 钩子：以 useEffect() 为例" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/SAeE5oCGscZvrP><p>但是，钩子的灵活性太大，初学者不太容易理解。很多人一知半解，很容易写出混乱不堪、无法维护的代码。那就不如使用类了。因为类有很多强制的语法约束，不容易搞乱。</p><p></p><h1 toutiao-origin=h2>二、类和函数的差异</h1><p>严格地说，类组件和函数组件是有差异的。不同的写法，代表了不同的编程方法论。</p><p>类（class）是数据和逻辑的封装。 也就是说，组件的状态和操作方法是封装在一起的。如果选择了类的写法，就应该把相关的数据和操作，都写在同一个 class 里面。</p><img alt="轻松学会 React 钩子：以 useEffect() 为例" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/SAeE6Q4kkf28V><p>函数一般来说，只应该做一件事，就是返回一个值。 如果你有多个操作，每个操作应该写成一个单独的函数。而且，数据的状态应该与操作方法分离。根据这种理念，React 的函数组件只应该做一件事情：返回组件的 HTML 代码，而没有其他的功能。</p><img alt="轻松学会 React 钩子：以 useEffect() 为例" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/SAeE6QX4ji9CfW><p>还是以上面的函数组件为例。</p><pre><code>function Welcome(props) {<br>return &lt;h1&gt;Hello, {props.name}&lt;/h1&gt;;<br>}<br></code></pre><p>这个函数只做一件事，就是根据输入的参数，返回组件的 HTML 代码。这种只进行单纯的数据计算（换算）的函数，在函数式编程里面称为 “纯函数”（pure function）。</p><p></p><h1 toutiao-origin=h2>三、副效应是什么？</h1><p>看到这里，你可能会产生一个疑问：如果纯函数只能进行数据计算，那些不涉及计算的操作（比如生成日志、储存数据、改变应用状态等等）应该写在哪里呢？</p><p>函数式编程将那些跟数据计算无关的操作，都称为 “副效应” （side effect） 。如果函数内部直接包含产生副效应的操作，就不再是纯函数了，我们称之为不纯的函数。</p><img alt="轻松学会 React 钩子：以 useEffect() 为例" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/SAeE6QwCHzmtYf><p>纯函数内部只有通过间接的手段（即通过其他函数调用），才能包含副效应。</p><p></p><h1 toutiao-origin=h2>四、钩子（hook）的作用</h1><p>说了半天，那么钩子到底是什么？</p><p>一句话，钩子（hook）就是 React 函数组件的副效应解决方案，用来为函数组件引入副效应。 函数组件的主体只应该用来返回组件的 HTML 代码，所有的其他操作（副效应）都必须通过钩子引入。</p><p>由于副效应非常多，所以钩子有许多种。React 为许多常见的操作（副效应），都提供了专用的钩子。</p><ul><li><p><code>useState</code>：保存状态</p></li><li><p><code>useContext</code>：保存上下文</p></li><li><p><code>useRef</code>：保存引用</p></li><li><p>……</p></li></ul><p>上面这些钩子，都是引入某种特定的副效应，而 <code>useEffect</code>是通用的副效应钩子。找不到对应的钩子时，就可以用它。其实，从名字也可以看出来，它跟副效应（side effect）直接相关。</p><img alt="轻松学会 React 钩子：以 useEffect() 为例" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/SAeE6RVBYuH9Rp><p></p><h1 toutiao-origin=h2>五、useEffect 的用法</h1><p><code>useEffect</code>本身是一个函数，由 React 框架提供，在函数组件内部调用即可。</p><p>举例来说，我们希望组件加载以后，网页标题（<code>document.title</code>）会随之改变。那么，改变网页标题这个操作，就是组件的副效应，必须通过<code>useEffect</code>来实现。</p><pre><code>import React, { useEffect } from 'react';<br><br>function Welcome(props) {<br>useEffect( =&gt; {<br>document.title = '加载完成';<br>});<br>return &lt;h1&gt;Hello, {props.name}&lt;/h1&gt;;<br>}<br></code></pre><p>上面例子中，<code>useEffect</code>的参数是一个函数，它就是所要完成的副效应（改变网页标题）。组件加载以后，React 就会执行这个函数。（查看运行结果[5]）</p><p><code>useEffect</code>的作用就是指定一个副效应函数，组件每渲染一次，该函数就自动执行一次。组件首次在网页 DOM 加载后，副效应函数也会执行。</p><p></p><h1 toutiao-origin=h2>六、useEffect 的第二个参数</h1><p>有时候，我们不希望<code>useEffect</code>每次渲染都执行，这时可以使用它的第二个参数，使用一个数组指定副效应函数的依赖项，只有依赖项发生变化，才会重新渲染。</p><pre><code>function Welcome(props) {<br>useEffect( =&gt; {<br>document.title = `Hello, ${props.name}`;<br>}, [props.name]);<br>return &lt;h1&gt;Hello, {props.name}&lt;/h1&gt;;<br>}<br></code></pre><p>上面例子中，<code>useEffect</code>的第二个参数是一个数组，指定了第一个参数（副效应函数）的依赖项（<code>props.name</code>）。只有该变量发生变化时，副效应函数才会执行。</p><p>如果第二个参数是一个空数组，就表明副效应参数没有任何依赖项。因此，副效应函数这时只会在组件加载进入 DOM 后执行一次，后面组件重新渲染，就不会再次执行。这很合理，由于副效应不依赖任何变量，所以那些变量无论怎么变，副效应函数的执行结果都不会改变，所以运行一次就够了。</p><p></p><h1 toutiao-origin=h2>七、useEffect 的用途</h1><p>只要是副效应，都可以使用<code>useEffect</code>引入。它的常见用途有下面几种。</p><ul><li><p>获取数据（data fetching）</p></li><li><p>事件监听或订阅（setting up a subscription）</p></li><li><p>改变 DOM（changing the DOM）</p></li><li><p>输出日志（logging）</p></li></ul><p>下面是从远程服务器获取数据的例子。（查看运行结果[6]）</p><pre><code>import React, { useState, useEffect } from 'react';<br>import axios from 'axios';<br><br>function App {<br>const [data, setData] = useState({ hits: [] });<br><br>useEffect( =&gt; {<br>const fetchData = async  =&gt; {<br>const result = await axios(<br>'https://hn.algolia.com/api/v1/search?query=redux',<br>);<br><br>setData(result.data);<br>};<br><br>fetchData;<br>}, );<br><br>return (<br>&lt;ul&gt;<br>{data.hits.map(item =&gt; (<br>&lt;li key={item.objectID}&gt;<br>&lt;a href={item.url}&gt;{item.title}&lt;/a&gt;<br>&lt;/li&gt;<br>))}<br>&lt;/ul&gt;<br>);<br>}<br><br>export default App;<br></code></pre><p>上面例子中，<code>useState</code>用来生成一个状态变量（<code>data</code>），保存获取的数据；<code>useEffect</code>的副效应函数内部有一个 async 函数，用来从服务器异步获取数据。拿到数据以后，再用<code>setData</code>触发组件的重新渲染。</p><p>由于获取数据只需要执行一次，所以上例的<code>useEffect</code>的第二个参数为一个空数组。</p><p></p><h1 toutiao-origin=h2>八、useEffect 的返回值</h1><p>副效应是随着组件加载而发生的，那么组件卸载时，可能需要清理这些副效应。</p><p><code>useEffect</code>允许返回一个函数，在组件卸载时，执行该函数，清理副效应。如果不需要清理副效应，<code>useEffect</code>就不用返回任何值。</p><pre><code>useEffect( =&gt; {<br>const subscription = props.source.subscribe;<br>return  =&gt; {<br>subscription.unsubscribe;<br>};<br>}, [props.source]);<br></code></pre><p>上面例子中，<code>useEffect</code>在组件加载时订阅了一个事件，并且返回一个清理函数，在组件卸载时取消订阅。</p><p>实际使用中，由于副效应函数默认是每次渲染都会执行，所以清理函数不仅会在组件卸载时执行一次，组件每次重新渲染之前，也会执行一次，用来清理上一次渲染的副效应。</p><p></p><h1 toutiao-origin=h2>九、useEffect 的注意点</h1><p>使用<code>useEffect</code>时，有一点需要注意。如果有多个副效应，应该调用多个<code>useEffect</code>，而不应该合并写在一起。</p><pre><code>function App {<br>const [varA, setVarA] = useState(0);<br>const [varB, setVarB] = useState(0);<br>useEffect( =&gt; {<br>const timeoutA = setTimeout( =&gt; setVarA(varA + 1), 1000);<br>const timeoutB = setTimeout( =&gt; setVarB(varB + 2), 2000);<br><br>return  =&gt; {<br>clearTimeout(timeoutA);<br>clearTimeout(timeoutB);<br>};<br>}, [varA, varB]);<br><br>return &lt;span&gt;{varA}, {varB}&lt;/span&gt;;<br>}<br></code></pre><p>上面的例子是错误的写法，副效应函数里面有两个定时器，它们之间并没有关系，其实是两个不相关的副效应，不应该写在一起。正确的写法是将它们分开写成两个<code>useEffect</code>。</p><pre><code>function App {<br>const [varA, setVarA] = useState(0);<br>const [varB, setVarB] = useState(0);<br><br>useEffect( =&gt; {<br>const timeout = setTimeout( =&gt; setVarA(varA + 1), 1000);<br>return  =&gt; clearTimeout(timeout);<br>}, [varA]);<br><br>useEffect( =&gt; {<br>const timeout = setTimeout( =&gt; setVarB(varB + 2), 2000);<br><br>return  =&gt; clearTimeout(timeout);<br>}, [varB]);<br><br>return &lt;span&gt;{varA}, {varB}&lt;/span&gt;;<br>}<br></code></pre><p></p><h1 toutiao-origin=h2>十、参考链接</h1><ul><li><p>React useEffect: 4 Tips Every Developer Should Know[7], Helder Esteves</p></li><li><p>Using the Effect Hook[8], React</p></li><li><p>How to fetch data with React Hooks?[9], Robin Wieruch</p></li></ul><p>（正文完）</p><p></p><h1 toutiao-origin=h2>React 系统视频</h1><p>对于每个想进大厂的前端开发者来说，React 是绕不过的坎，面试肯定会问到，业务也很可能会用。不懂一点 React 技术栈，大大降低了个人竞争力。</p><p>退一步说，即使你用不到 React，但是它的很多思想已经影响到了整个业界，比如虚拟 DOM、JSX、函数式编程、immutable 的状态、单向数据流等等。懂了 React，面对其他轮子时，你也能得心应手。</p><p>但是，大家都知道 React 学习曲线比较陡峭，不少人抱怨：苦苦学了1个多月却进展缓慢怎么办？</p><p>别着急，这里有一份开课吧的 《React 原理剖析 + 组件化》 系统视频。不仅讲解了原理，还包括了综合性的实战项目，里面用到了 react-router、redux、react-redux、antd 等 React 全家桶。</p><img alt="轻松学会 React 钩子：以 useEffect() 为例" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/S9a43BC3ecTjsX><p>（完）</p><p>[1]</p><p>React 系列教程:<em>http://www.ruanyifeng.com/blog/2016/09/react-technology-stack.html</em></p><p>[2]</p><p>《React 框架入门》:<em>http://www.ruanyifeng.com/blog/2015/03/react.html</em></p><p>[3]</p><p>《React 最常用的四个钩子》:<em>http://www.ruanyifeng.com/blog/2019/09/react-hooks.html</em></p><p>[4]</p><p>推荐:<em>https://reactjs.org/docs/hooks-faq.html#should-i-use-hooks-classes-or-a-mix-of-both</em></p><p>[5]</p><p>查看运行结果:<em>https://codesandbox.io/s/interesting-dubinsky-dx6oq?file=/src/index.js</em></p><p>[6]</p><p>查看运行结果:<em>https://codesandbox.io/s/intelligent-yonath-olihz?file=/src/index.js</em></p><p>[7]</p><p>React useEffect: 4 Tips Every Developer Should Know:<em>https://medium.com/swlh/useeffect-4-tips-every-developer-should-know-54b188b14d9c</em></p><p>[8]</p><p>Using the Effect Hook:<em>https://reactjs.org/docs/hooks-effect.html</em></p><p>[9]</p><p>How to fetch data with React Hooks?:<em>https://www.robinwieruch.de/react-hooks-fetch-data</em></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'React','钩子','useEffect'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>