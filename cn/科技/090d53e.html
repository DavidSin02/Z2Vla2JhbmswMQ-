<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>智能合约中的签名重放漏洞 | 极客快訊</title><meta property="og:title" content="智能合约中的签名重放漏洞 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/090d53e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/090d53e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/090d53e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/090d53e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/090d53e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/090d53e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/090d53e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/090d53e.html><meta property="article:published_time" content="2020-10-29T21:04:28+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:28+08:00"><meta name=Keywords content><meta name=description content="智能合约中的签名重放漏洞"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/090d53e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>智能合约中的签名重放漏洞</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>密码学签名是区块链系统中的基本模块。使用对应的私钥对交易进行签名能够将交易发起人与特定帐户联系起来。如果没有此功能，区块链的记帐工作将无法正常进行。</p><p>许多在以太坊上部署的智能合约也有直接验证数字签名的功能，以使得一个或多个验证者可以通过提交离线创建的签名（甚至是由另一个智能合约生成的签名）来授权操作。这项验证通常被用于多重签名冷钱包或者投票合同，以便一起提交各种签名或委托授权。</p><p>此类实现中的常见漏洞是签名重放攻击。在 Cryptonics 对一个重要项目的智能合约审计中，我们遇到了这个问题的一个有趣例子。在本文中，我们将使用此示例来说明智能合约中签名验证是如何出错的。</p><p>与签名验证相关的漏洞通常是由于误解了底层的密码学原理和签名的目的而引起的。因此，在详细了解此特定漏洞之前，我们先快速了解一下密码学签名的工作原理。</p><p><h2><strong>密码学签名</strong></h2></p><p>大多数的密码学签名体系都基于公私钥对。私钥能够对数据进行签名，而且此签名能够被对应的公钥所验证。就像它的名字所暗示的一样，一个用户的公钥是公开的，而私钥则一定要保密。</p><p>对数据进行加密签名可实现两个重要属性：</p><ul><li>数据签名者可识别性，这是通过恢复签名者的公钥来实现的。</li><li>数据完整的可验证性，意思是签名可以用于证明自签名以来数据未被修改。</li></ul><p>虽然这些是非常强大的属性，但是需要重点注意的是签过名的数据本身不提供额外的保障。<strong>签名不能保证一条消息的唯一性，也不能保证签名人就是发信人本身。</strong>当然，加密签名可以被用于确认相关事实，但是应用程序也须执行必要的检查。我们可以在以太坊智能合约中调查以上事实。</p><p><h2><strong>以太坊中的签名验证</strong></h2></p><p>以太坊和比特币一样，采用椭圆曲线数字签名算法（ECDSA）和 secp256k1 曲线。智能合约可以通过系统方法 ecrecover 访问内置的 ECDSA 签名验证算法。以下示例展示了这个函数的用法：</p><pre>address signer = ecrecover(msgHash, v, r, s);</pre><p>这个方法的输入参数是签名值 v，r 和 s，以及签名数据的 keccak256 哈希值。它可以校验数据的完整性，即确认数字签名与数据的哈希值相对应，并且可以从签名中恢复签名者的以太坊地址（以太坊地址乃是从公钥中推导出来的）。</p><p><strong>任何额外的检查，不论是检查签名地址是否为正确地址，还是检查被签名的消息是否唯一，都必须被手动添加进智能合约中</strong>。</p><p>经常有人误解了 ecrecover 的功能，然后搞出了安全漏洞。</p><p><h2><strong>签名重放漏洞</strong></h2><h3><strong>代码示例</strong></h3>让我们来看一下我们在最近的合约审计中发现的漏洞：</p><pre>function unlock(  address _to,  uint256 _amount,  uint8[] _v,  bytes32[] _r,  bytes32[] _s)  external{  require(_v.length &gt;= 5);  bytes32 hashData = keccak256(_to, _amount);  for (uint i = 0; i &lt; _v.length; i++) {    address recAddr = ecrecover(hashData, _v[i], _r[i], _s[i]);    require(_isValidator(recAddr));  }  to.transfer(_amount);}</pre><p>以上代码是我们所审计的代码的简化版本，为使代码变得简短易懂，它只保留了最基础的信息。但是其中的漏洞被完整地保留了下来。</p><p>被审计的合约是跨链桥接器的一部分，它能让数字资产从一个区块链转移到另一个上。以太币在以太坊智能合约中被锁定之时，另一条链上会创建出对应的资产。当资产在另一条链上被锁定或销毁时， unlock 函数可以释放先前被锁定的以太币。要实现这个效果时，跨链中继者可以提交一系列的验证者签名、一个解锁的数额以及一个目标地址。这个函数要求至少五个签名来解锁需要的数额并将资金传给接收方。而内部的 _isValidator 函数（为了简化，省略掉了具体实现）会检查一个地址具不具备验证者身份。</p><p><h3><strong>攻击情景</strong></h3>以上代码的问题在于被验证者用 ECDSA 算法签过名的消息中。这个消息只包含接收者的地址以及需要解锁的数量。<strong>在这个消息中，并没有什么内容能防止相同的签名被多次重复使用</strong>。想象如下的情景：</p><ul><li>Bob 在与以太坊连接的另一条链上有等价于 10ETH 的资产被他通过桥接器传回了以太坊链上。</li><li>Alice 是一个处理跨链交易的中继者。她收集了必需的验证者签名，在所连接的链上锁定了相对应的资产数量，并且调用 unlock 函数将 10ETH 从合约中释放给 Bob。</li><li>包含一系列签名值的交易能够在区块链上公开读取。</li><li>Bob 现在可以复制这个签名值的序列并且自己提交一个一模一样的解锁函数调用请求。这个解锁的操作能够再一次成功，导致又一个 10ETH 被发送给Bob。</li><li>Bob 能够重复这个过程直到智能合约中的以太坊被耗尽。</li></ul><p><h3><strong>改进手段</strong></h3>以上情形被称为签名重放攻击。这种攻击能成功是由于我们无法验证所签名消息的唯一性，也不知道它之前是否被用过。</p><p>一个防止此类攻击的简单方法是在被签名数据中包含一个消息序列号或者 <strong>nonce。</strong>以上代码的修正版如下：</p><pre>public uint256 nonce;function unlock(  address _to,  uint256 _amount,   uint256 _nonce,  uint8[] _v,  bytes32[] _r,  bytes32[] _s)  external{  require(_v.length &gt;= 5);  require(_nonce == nonce++);  bytes32 hashData = keccak256(_to, _amount, _nonce);  for (uint i = 0; i &lt; _v.length; i++) {    address recAddr = ecrecover(hashData, _v[i], _r[i], _s[i]);    require(_isValidator(recAddr));  }  to.transfer(_amount);}</pre><p>这段代码现在要求每一个成功的解锁调用都包含一个序列号。因为消息中得包含一个独一无二的数字，所以每次成功调用所要求的签名都是独一无二的。这表示之前观测到的消息对攻击者来说没用了，因为重放会失败。</p><p><h2>签名验证的最佳模式</h2></p><p>上述例子只是其中一个示例，演示了不能保证唯一型的签名如何被重放。在大部分情景中，确保签名能够与每一次调用形成唯一的匹配对预防重放攻击是非常重要的。</p><p>但是，这段代码并不完美。它并没有遵循签名验证的最佳实践。原因是它没有检查<strong>可塑性签名，</strong>我们应检查作为已接受签名一部分的 s 值是否在较低范围内。使用 ecrecover 函数的推荐流程可以在 Open Zeppelin 的 excellent ECDSA 库中找到。事实上，在社区审计过的代码，比如 Open Zeppelin 上进行开发，总是一个好主意。</p><p><strong>原文链接:</strong></p><p>https://medium.com/cryptronics/signature-replay-vulnerabilities-in-smart-contracts-3b6f7596df57</p><p><strong>作者:</strong>Stefan Beyer</p><p><strong>翻译&校对:</strong>TrumanW & 阿剑</p><p><em>本文由作者授权 EthFans 翻译及再出版。</em></p><p>（本文来源于以太坊爱好者 EthFans，未经作者许可严禁转载，违者法律必究）</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'合约','签名','重放'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>