<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>æ‰‹å†™AOPå®ç°è¿‡ç¨‹ | æå®¢å¿«è¨Š</title><meta property="og:title" content="æ‰‹å†™AOPå®ç°è¿‡ç¨‹ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/6ac9667b9b064f57903047a4156004fd"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0be61162.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0be61162.html><meta property="article:published_time" content="2020-11-14T21:04:29+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:29+08:00"><meta name=Keywords content><meta name=description content="æ‰‹å†™AOPå®ç°è¿‡ç¨‹"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/0be61162.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>æ‰‹å†™AOPå®ç°è¿‡ç¨‹</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right><strong>ä¸€.æ‰‹å†™Aopå‰åŸºç¡€çŸ¥è¯†</strong></h1><p style=text-align:start><strong>1.aopæ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p style=text-align:start>é¢å‘åˆ‡é¢ç¼–ç¨‹(AOP)ï¼šæ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œæä¾›ä»å¦ä¸€ä¸ªè§’åº¦æ¥è€ƒè™‘ç¨‹åºç»“æ„ä»è€Œå®Œå–„é¢å‘å¯¹è±¡ç¼–ç¨‹(OOP)ã€‚</p><pre><code>åœ¨è¿›è¡ŒOOPå¼€å‘æ—¶ï¼Œéƒ½æ˜¯åŸºäºå¯¹ç»„ä»¶ï¼ˆæ¯”å¦‚ç±»ï¼‰è¿›è¡Œå¼€å‘ï¼Œç„¶åå¯¹ç»„ä»¶è¿›è¡Œç»„åˆï¼ŒOOPæœ€å¤§é—®é¢˜å°±æ˜¯æ— æ³•è§£è€¦ç»„ä»¶è¿›è¡Œå¼€å‘ï¼Œè€ŒAOPå°±æ˜¯ä¸ºäº†å…‹æœè¿™ä¸ªé—®é¢˜è€Œå‡ºç°çš„ï¼Œå®ƒæ¥è¿›è¡Œè¿™ç§è€¦åˆçš„åˆ†ç¦»ã€‚</code></pre><p style=text-align:start>AOPä¸ºå¼€å‘è€…æä¾›ä¸€ç§è¿›è¡Œæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆæ¯”å¦‚æ—¥å¿—å…³æ³¨ç‚¹æ¨ªåˆ‡äº†æ”¯ä»˜å…³æ³¨ç‚¹ï¼‰åˆ†ç¦»å¹¶ç»‡å…¥çš„æœºåˆ¶ï¼ŒæŠŠæ¨ªåˆ‡å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œç„¶åé€šè¿‡æŸç§æŠ€æœ¯ç»‡å…¥åˆ°ç³»ç»Ÿä¸­ï¼Œä»è€Œæ— è€¦åˆçš„å®Œæˆäº†æˆ‘ä»¬çš„åŠŸèƒ½ã€‚</p><p style=text-align:start><strong>2.aopèƒ½å¹²ä»€ä¹ˆï¼Ÿ</strong></p><p style=text-align:start>AOPä¸»è¦ç”¨äºæ¨ªåˆ‡å…³æ³¨ç‚¹å’Œç»‡å…¥ï¼Œå› æ­¤éœ€è¦ç†è§£æ¨ªåˆ‡å…³æ³¨ç‚¹å’Œç»‡å…¥ï¼š</p><ul><li><strong>å…³æ³¨ç‚¹ï¼š</strong>å¯ä»¥è®¤ä¸ºæ˜¯æ‰€å…³æ³¨çš„ä»»ä½•ä¸œè¥¿ï¼Œæ¯”å¦‚ä¸Šè¾¹çš„æ”¯ä»˜ç»„ä»¶ï¼›</li><li><strong>å…³æ³¨ç‚¹åˆ†ç¦»ï¼š</strong>å°†é—®é¢˜ç»†åŒ–ä»è€Œå•ç‹¬éƒ¨åˆ†ï¼Œå³å¯ä»¥ç†è§£ä¸ºä¸å¯å†åˆ†å‰²çš„ç»„ä»¶ï¼Œå¦‚ä¸Šè¾¹çš„æ—¥å¿—ç»„ä»¶å’Œæ”¯ä»˜ç»„ä»¶ï¼›</li><li><strong>æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼š</strong>ä¸€ä¸ªç»„ä»¶æ— æ³•å®Œæˆéœ€è¦çš„åŠŸèƒ½ï¼Œéœ€è¦å…¶ä»–ç»„ä»¶åä½œå®Œæˆï¼Œå¦‚æ—¥å¿—ç»„ä»¶æ¨ªåˆ‡äºæ”¯ä»˜ç»„ä»¶ï¼›</li><li><strong>ç»‡å…¥ï¼š</strong>æ¨ªåˆ‡å…³æ³¨ç‚¹åˆ†ç¦»åï¼Œéœ€è¦é€šè¿‡æŸç§æŠ€æœ¯å°†æ¨ªåˆ‡å…³æ³¨ç‚¹èåˆåˆ°ç³»ç»Ÿä¸­ä»è€Œå®Œæˆéœ€è¦çš„åŠŸèƒ½ï¼Œå› æ­¤éœ€è¦ç»‡å…¥ï¼Œ<strong>ç»‡å…¥å¯èƒ½åœ¨ç¼–è¯‘æœŸã€åŠ è½½æœŸã€è¿è¡ŒæœŸ</strong>ç­‰è¿›è¡Œã€‚</li></ul><p style=text-align:start>æ¨ªåˆ‡å…³æ³¨ç‚¹å¯èƒ½åŒ…å«å¾ˆå¤šï¼Œæ¯”å¦‚éä¸šåŠ¡çš„ï¼šæ—¥å¿—ã€äº‹åŠ¡å¤„ç†ã€ç¼“å­˜ã€æ€§èƒ½ç»Ÿè®¡ã€æƒé™æ§åˆ¶ç­‰ç­‰è¿™äº›éä¸šåŠ¡çš„åŸºç¡€åŠŸèƒ½ï¼›è¿˜å¯èƒ½æ˜¯ä¸šåŠ¡çš„ï¼šå¦‚æŸä¸ªä¸šåŠ¡ç»„ä»¶æ¨ªåˆ‡äºå¤šä¸ªæ¨¡å—ã€‚</p><div class=pgc-img><img alt=æ‰‹å†™AOPå®ç°è¿‡ç¨‹ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6ac9667b9b064f57903047a4156004fd><p class=pgc-img-caption></p></div><p style=text-align:start>é¢å‘åˆ‡é¢æ–¹å¼ï¼Œå…ˆå°†æ¨ªåˆ‡å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œå†å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ç»‡å…¥åˆ°æ”¯ä»˜ç³»ç»Ÿä¸­ï¼š</p><div class=pgc-img><img alt=æ‰‹å†™AOPå®ç°è¿‡ç¨‹ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/557f8b6c787540898eed0d182bf51a02><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=æ‰‹å†™AOPå®ç°è¿‡ç¨‹ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0be8633c1b704eefba4009b5115ee1d9><p class=pgc-img-caption></p></div><p style=text-align:start><strong>3.aopçš„ä¼˜ç‚¹ï¼Ÿ</strong></p><ul><li>å®Œå–„OOPï¼›</li><li>é™ä½ç»„ä»¶å’Œæ¨¡å—ä¹‹é—´çš„è€¦åˆæ€§ï¼›</li><li>ä½¿ç³»ç»Ÿå®¹æ˜“æ‰©å±•ï¼›</li><li>è€Œä¸”ç”±äºå…³æ³¨ç‚¹åˆ†ç¦»ä»è€Œå¯ä»¥è·å¾—ç»„ä»¶çš„æ›´å¥½å¤ç”¨ã€‚</li></ul><h1 class=pgc-h-arrow-right><strong>äºŒ.aopåº•å±‚å®ç°åŸç†ï¼šä»£ç†æ¨¡å¼</strong></h1><p style=text-align:start>å…³äºé™æ€ä»£ç†æ¨¡å¼ï¼Œè¯¦æƒ…è¯·å‚é˜…æˆ‘å¦ä¸€ç‰‡åšå®¢ï¼š</p><p style=text-align:start>https://www.cnblogs.com/tc971121/p/13474638.html</p><h1 class=pgc-h-arrow-right><strong>ä¸‰.æ‰‹å†™aopä¸»è¦å®ç°è¿‡ç¨‹</strong></h1><p style=text-align:start><strong>1.å®šä¹‰é…ç½®æ ‡è®°</strong></p><p style=text-align:start>@Aspectï¼šé…ç½®æ ‡è®°æ¨ªåˆ‡å¯¹è±¡ï¼ˆæ–¹æ³•ï¼‰çš„åœ°å€</p><p style=text-align:start>@Orderï¼šé…ç½®æ ‡è®°æ¨ªåˆ‡çš„é¡ºåº</p><p style=text-align:start>@Aspect/@Order</p><pre><code>@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)public @interface Aspect {    String pointcut();}</code></pre><pre><code>@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)public @interface Order {    /**     * æ§åˆ¶ç±»çš„æ‰§è¡Œé¡ºåºï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜     */    int value();}</code></pre><p style=text-align:start><strong>2.å®šä¹‰é»˜è®¤åˆ‡é¢ç±»</strong></p><pre><code>package org.simplespring.aop.aspect;import java.lang.reflect.Method;/** * å®šä¹‰é»˜è®¤åˆ‡é¢ç±» */public abstract class DefaultAspect {    /**     * äº‹å‰æ‹¦æˆª     * @param targetClass è¢«ä»£ç†çš„ç›®æ ‡ç±»     * @param method è¢«ä»£ç†çš„ç›®æ ‡æ–¹æ³•     * @param args è¢«ä»£ç†çš„ç›®æ ‡æ–¹æ³•å¯¹åº”çš„å‚æ•°åˆ—è¡¨     * @throws Throwable     */    public void before(Class&lt;?&gt; targetClass, Method method, Object[] args) throws Throwable{    }    /**     * äº‹åæ‹¦æˆª     * @param targetClass è¢«ä»£ç†çš„ç›®æ ‡ç±»     * @param method è¢«ä»£ç†çš„ç›®æ ‡æ–¹æ³•     * @param args è¢«ä»£ç†çš„ç›®æ ‡æ–¹æ³•å¯¹åº”çš„å‚æ•°åˆ—è¡¨     * @param returnValue è¢«ä»£ç†çš„ç›®æ ‡æ–¹æ³•æ‰§è¡Œåçš„è¿”å›å€¼     * @throws Throwable     */    public Object afterReturning(Class&lt;?&gt; targetClass, Method method, Object[] args, Object returnValue) throws Throwable{        return returnValue;    }    /**     *     * @param targetClass è¢«ä»£ç†çš„ç›®æ ‡ç±»     * @param method è¢«ä»£ç†çš„ç›®æ ‡æ–¹æ³•     * @param args è¢«ä»£ç†çš„ç›®æ ‡æ–¹æ³•å¯¹åº”çš„å‚æ•°åˆ—è¡¨     * @param e è¢«ä»£ç†çš„ç›®æ ‡æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸     * @throws Throwable     */    public void afterThrowing(Class&lt;?&gt; targetClass, Method method, Object[] args,  Throwable e) throws Throwable{    }}</code></pre><p style=text-align:start><strong>3.å®šä¹‰åˆ‡é¢ç»‡å…¥å™¨</strong></p><p style=text-align:start><strong>æ ¸å¿ƒæµç¨‹ï¼š</strong></p><p style=text-align:start>1.è·å–æ‰€æœ‰çš„åˆ‡é¢ç±»</p><p style=text-align:start>2.éå†å®¹å™¨ç®¡ç†çš„ç±»3.ç­›é€‰å‡ºåŒ¹é…å®¹å™¨ç®¡ç†ç±»çš„åˆ‡é¢aspectlist4.å°è¯•è¿›è¡ŒAspectçš„ç»‡å…¥ ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡ å¹¶æ›¿æ¢beancontainerä¸­åŸå…ˆclasså¯¹åº”æ‰€å¯¹åº”çš„å®ä¾‹å¯¹è±¡</p><pre><code>package org.simplespring.aop;import org.simplespring.aop.annotation.Aspect;import org.simplespring.aop.annotation.Order;import org.simplespring.aop.aspect.AspectInfo;import org.simplespring.aop.aspect.DefaultAspect;import org.simplespring.core.BeanContainer;import org.simplespring.util.ValidationUtil;import java.util.ArrayList;import java.util.List;import java.util.Set;/** * @Classname AspectWeaver * @Description åˆ‡é¢ç»‡å…¥å™¨ * @Date 2020/8/8 19:43 * @Created by zhangtianci */public class AspectWeaver {    /**     * æ‹¥æœ‰ä¸€ä¸ªbeanå®¹å™¨     */    private BeanContainer beanContainer;    public AspectWeaver(){        beanContainer = BeanContainer.getInstance();    }    /**     * 1.è·å–æ‰€æœ‰çš„åˆ‡é¢ç±»     * 2.éå†å®¹å™¨é‡Œçš„ç±»     * 3.ç­›é€‰å‡ºåŒ¹é…ç±»çš„åˆ‡é¢aspect     * 4.å°è¯•è¿›è¡ŒAspectçš„ç»‡å…¥ ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡     */    public void doAop() {        //1.è·å–æ‰€æœ‰çš„åˆ‡é¢ç±»        Set&lt;Class&lt;?&gt;&gt; aspectSet = beanContainer.getClassesByAnnotation(Aspect.class);        if(ValidationUtil.isEmpty(aspectSet)){return;}        //2.æ‹¼è£…AspectInfoList        List&lt;AspectInfo&gt; aspectInfoList = packAspectInfoList(aspectSet);        //3.éå†å®¹å™¨é‡Œçš„ç±»        Set&lt;Class&lt;?&gt;&gt; classSet = beanContainer.getClasses();        for (Class&lt;?&gt; targetClass: classSet) {            //æ’é™¤AspectClassè‡ªèº«            if(targetClass.isAnnotationPresent(Aspect.class)){                continue;            }            //4.ç²—ç­›ç¬¦åˆæ¡ä»¶çš„Aspect            List&lt;AspectInfo&gt; roughMatchedAspectList  = collectRoughMatchedAspectListForSpecificClass(aspectInfoList, targetClass);            //5.å°è¯•è¿›è¡ŒAspectçš„ç»‡å…¥            wrapIfNecessary(roughMatchedAspectList,targetClass);        }    }    private void wrapIfNecessary(List&lt;AspectInfo&gt; roughMatchedAspectList, Class&lt;?&gt; targetClass) {        if(ValidationUtil.isEmpty(roughMatchedAspectList)){return;}        //åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡        AspectListExecutor aspectListExecutor = new AspectListExecutor(targetClass, roughMatchedAspectList);        Object proxyBean = ProxyCreator.createProxy(targetClass, aspectListExecutor);        beanContainer.addBean(targetClass, proxyBean);    }    private List&lt;AspectInfo&gt; collectRoughMatchedAspectListForSpecificClass(List&lt;AspectInfo&gt; aspectInfoList, Class&lt;?&gt; targetClass) {        List&lt;AspectInfo&gt; roughMatchedAspectList = new ArrayList&lt;&gt;();        for(AspectInfo aspectInfo : aspectInfoList){            //ç²—ç­›            if(aspectInfo.getPointcutLocator().roughMatches(targetClass)){                roughMatchedAspectList.add(aspectInfo);            }        }        return roughMatchedAspectList;    }    private List&lt;AspectInfo&gt; packAspectInfoList(Set&lt;Class&lt;?&gt;&gt; aspectSet) {        List&lt;AspectInfo&gt; aspectInfoList = new ArrayList&lt;&gt;();        for(Class&lt;?&gt; aspectClass : aspectSet){            if (verifyAspect(aspectClass)){                Order orderTag = aspectClass.getAnnotation(Order.class);                Aspect aspectTag = aspectClass.getAnnotation(Aspect.class);                DefaultAspect defaultAspect = (DefaultAspect) beanContainer.getBean(aspectClass);                //åˆå§‹åŒ–è¡¨è¾¾å¼å®šä½å™¨                PointcutLocator pointcutLocator = new PointcutLocator(aspectTag.pointcut());                AspectInfo aspectInfo = new AspectInfo(orderTag.value(), defaultAspect, pointcutLocator);                aspectInfoList.add(aspectInfo);            } else {                //ä¸éµå®ˆè§„èŒƒåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸                throw new RuntimeException("@Aspect and @Order must be added to the Aspect class, and Aspect class must extend from DefaultAspect");            }        }        return aspectInfoList;    }    //æ¡†æ¶ä¸­ä¸€å®šè¦éµå®ˆç»™Aspectç±»æ·»åŠ @Aspectå’Œ@Orderæ ‡ç­¾çš„è§„èŒƒï¼ŒåŒæ—¶ï¼Œå¿…é¡»ç»§æ‰¿è‡ªDefaultAspect.class    //æ­¤å¤–ï¼Œ@Aspectçš„å±æ€§å€¼ä¸èƒ½æ˜¯å®ƒæœ¬èº«    private boolean verifyAspect(Class&lt;?&gt; aspectClass) {        return aspectClass.isAnnotationPresent(Aspect.class) &amp;&amp;                aspectClass.isAnnotationPresent(Order.class) &amp;&amp;                DefaultAspect.class.isAssignableFrom(aspectClass);    }}</code></pre><p style=text-align:start>åˆ‡é¢ä¿¡æ¯åŒ…è£…ç±»ï¼ˆå¢å¼ºçš„åŠ¨ä½œ/å¢å¼ºå¯¹è±¡åœ°å€/æ¨ªåˆ‡é¡ºåºï¼‰</p><pre><code>package org.simplespring.aop.aspect;import lombok.AllArgsConstructor;import lombok.Getter;import org.simplespring.aop.PointcutLocator;@AllArgsConstructor@Getterpublic class AspectInfo {    private int orderIndex;    private DefaultAspect aspectObject;    private PointcutLocator pointcutLocator;}</code></pre><p style=text-align:start>é‡‡ç”¨cglibåŠ¨æ€çš„å®ç°æ–¹å¼ï¼š</p><p style=text-align:start>å®ç°net.sf.cglib.proxy.MethodInterceptoræ¥å£ï¼Œå®šä¹‰ä»£ç†åæ–¹æ³•çš„åŠ¨ä½œï¼ˆç›¸å½“äºå®ç°jdkåŠ¨æ€ä»£ç†ä¸­çš„InvocationHandleræ¥å£ï¼‰</p><pre><code>package org.simplespring.aop;import lombok.Getter;import net.sf.cglib.proxy.MethodInterceptor;import net.sf.cglib.proxy.MethodProxy;import org.simplespring.aop.aspect.AspectInfo;import org.simplespring.util.ValidationUtil;import java.lang.reflect.Method;import java.util.Collections;import java.util.Comparator;import java.util.Iterator;import java.util.List;public class AspectListExecutor implements MethodInterceptor {    //è¢«ä»£ç†çš„ç±»    private Class&lt;?&gt; targetClass;    //æ’å¥½åºçš„Aspectåˆ—è¡¨    @Getter    private List&lt;AspectInfo&gt;sortedAspectInfoList;    public AspectListExecutor(Class&lt;?&gt; targetClass, List&lt;AspectInfo&gt; aspectInfoList){        this.targetClass = targetClass;        this.sortedAspectInfoList = sortAspectInfoList(aspectInfoList);    }    /**     * æŒ‰ç…§orderçš„å€¼è¿›è¡Œå‡åºæ’åºï¼Œç¡®ä¿orderå€¼å°çš„aspectå…ˆè¢«ç»‡å…¥     *     * @param aspectInfoList     * @return     */    private List&lt;AspectInfo&gt; sortAspectInfoList(List&lt;AspectInfo&gt; aspectInfoList) {        Collections.sort(aspectInfoList, new Comparator&lt;AspectInfo&gt;() {            @Override            public int compare(AspectInfo o1, AspectInfo o2) {                //æŒ‰ç…§å€¼çš„å¤§å°è¿›è¡Œå‡åºæ’åº                return o1.getOrderIndex() - o2.getOrderIndex();            }        });        return aspectInfoList;    }    @Override    public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable {        Object returnValue = null;        collectAccurateMatchedAspectList(method);        if(ValidationUtil.isEmpty(sortedAspectInfoList)){            returnValue = methodProxy.invokeSuper(proxy, args);            return returnValue;        }        //1.æŒ‰ç…§orderçš„é¡ºåºå‡åºæ‰§è¡Œå®Œæ‰€æœ‰Aspectçš„beforeæ–¹æ³•        invokeBeforeAdvices(method, args);        try{            //2.æ‰§è¡Œè¢«ä»£ç†ç±»çš„æ–¹æ³•            returnValue = methodProxy.invokeSuper(proxy, args);            //3.å¦‚æœè¢«ä»£ç†æ–¹æ³•æ­£å¸¸è¿”å›ï¼Œåˆ™æŒ‰ç…§orderçš„é¡ºåºé™åºæ‰§è¡Œå®Œæ‰€æœ‰Aspectçš„afterReturningæ–¹æ³•            returnValue = invokeAfterReturningAdvices(method, args, returnValue);        } catch (Exception e){            //4.å¦‚æœè¢«ä»£ç†æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™æŒ‰ç…§orderçš„é¡ºåºé™åºæ‰§è¡Œå®Œæ‰€æœ‰Aspectçš„afterThrowingæ–¹æ³•            invokeAfterThrowingAdvides(method, args, e);        }        return returnValue;    }    private void collectAccurateMatchedAspectList(Method method) {        if(ValidationUtil.isEmpty(sortedAspectInfoList)){return;}        Iterator&lt;AspectInfo&gt; it = sortedAspectInfoList.iterator();        while (it.hasNext()){            AspectInfo aspectInfo = it.next();            if(!aspectInfo.getPointcutLocator().accurateMatches(method)){                it.remove();            }        }    }    //4.å¦‚æœè¢«ä»£ç†æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™æŒ‰ç…§orderçš„é¡ºåºé™åºæ‰§è¡Œå®Œæ‰€æœ‰Aspectçš„afterThrowingæ–¹æ³•    private void invokeAfterThrowingAdvides(Method method, Object[] args, Exception e) throws Throwable {        for (int i =  sortedAspectInfoList.size() - 1; i &gt;=0 ; i--){            sortedAspectInfoList.get(i).getAspectObject().afterThrowing(targetClass, method, args, e);        }    }    //3.å¦‚æœè¢«ä»£ç†æ–¹æ³•æ­£å¸¸è¿”å›ï¼Œåˆ™æŒ‰ç…§orderçš„é¡ºåºé™åºæ‰§è¡Œå®Œæ‰€æœ‰Aspectçš„afterReturningæ–¹æ³•    private Object invokeAfterReturningAdvices(Method method, Object[] args, Object returnValue) throws Throwable {        Object result = null;        for (int i =  sortedAspectInfoList.size() - 1; i &gt;=0 ; i--){            result = sortedAspectInfoList.get(i).getAspectObject().afterReturning(targetClass, method, args, returnValue);        }        return result;    }    //1.æŒ‰ç…§orderçš„é¡ºåºå‡åºæ‰§è¡Œå®Œæ‰€æœ‰Aspectçš„beforeæ–¹æ³•    private void invokeBeforeAdvices(Method method, Object[] args) throws Throwable {        for(AspectInfo aspectInfo : sortedAspectInfoList){            aspectInfo.getAspectObject().before(targetClass, method, args);        }    }}</code></pre><p style=text-align:start>åˆ›å»ºä»£ç†ç±»ï¼š</p><pre><code>package org.simplespring.aop;import net.sf.cglib.proxy.Enhancer;import net.sf.cglib.proxy.MethodInterceptor;public class ProxyCreator {    /**     * åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡å¹¶è¿”å›     * @param targetClass è¢«ä»£ç†çš„Classå¯¹è±¡     * @param methodInterceptor æ–¹æ³•æ‹¦æˆªå™¨     * @return     */    public static Object createProxy(Class&lt;?&gt; targetClass, MethodInterceptor methodInterceptor){        return Enhancer.create(targetClass, methodInterceptor);    }}</code></pre><p style=text-align:start>è§£æAspectè¡¨è¾¾å¼å¹¶ä¸”å®šä½è¢«ç»‡å…¥çš„ç›®æ ‡å·¥å…·ç±»ï¼š</p><pre><code>package org.simplespring.aop;import org.aspectj.weaver.tools.PointcutExpression;import org.aspectj.weaver.tools.PointcutParser;import org.aspectj.weaver.tools.ShadowMatch;import java.lang.reflect.Method;/** * è§£æAspectè¡¨è¾¾å¼å¹¶ä¸”å®šä½è¢«ç»‡å…¥çš„ç›®æ ‡ */public class PointcutLocator {    /**     * Pointcutè§£æå™¨ï¼Œç›´æ¥ç»™å®ƒèµ‹å€¼ä¸ŠAspectjçš„æ‰€æœ‰è¡¨è¾¾å¼ï¼Œä»¥ä¾¿æ”¯æŒå¯¹ä¼—å¤šè¡¨è¾¾å¼çš„è§£æ     */    private PointcutParser pointcutParser= PointcutParser.getPointcutParserSupportingSpecifiedPrimitivesAndUsingContextClassloaderForResolution(            PointcutParser.getAllSupportedPointcutPrimitives()    );    /**     * è¡¨è¾¾å¼è§£æå™¨     */    private PointcutExpression pointcutExpression;    public PointcutLocator(String expression){        this.pointcutExpression = pointcutParser.parsePointcutExpression(expression);    }    /**     * åˆ¤æ–­ä¼ å…¥çš„Classå¯¹è±¡æ˜¯å¦æ˜¯Aspectçš„ç›®æ ‡ä»£ç†ç±»ï¼Œå³åŒ¹é…Pointcutè¡¨è¾¾å¼(åˆç­›)     *     * @param targetClass ç›®æ ‡ç±»     * @return æ˜¯å¦åŒ¹é…     */    public boolean roughMatches(Class&lt;?&gt; targetClass){        //couldMatchJoinPointsInTypeæ¯”è¾ƒå‘ï¼Œåªèƒ½æ ¡éªŒwithin        //ä¸èƒ½æ ¡éªŒ (execution(ç²¾ç¡®åˆ°æŸä¸ªç±»é™¤å¤–), call, get, set)ï¼Œé¢å¯¹æ— æ³•æ ¡éªŒçš„è¡¨è¾¾å¼ï¼Œç›´æ¥è¿”å›true        return pointcutExpression.couldMatchJoinPointsInType(targetClass);    }    /**     * åˆ¤æ–­ä¼ å…¥çš„Methodå¯¹è±¡æ˜¯å¦æ˜¯Aspectçš„ç›®æ ‡ä»£ç†æ–¹æ³•ï¼Œå³åŒ¹é…Pointcutè¡¨è¾¾å¼(ç²¾ç­›)     * @param method     * @return     */    public boolean accurateMatches(Method method){        ShadowMatch shadowMatch = pointcutExpression.matchesMethodExecution(method);        if(shadowMatch.alwaysMatches()){            return true;        } else{            return false;        }    }}</code></pre><p style=text-align:start>æ€»ç»“å®ç°aopçš„ä¸»è¦æµç¨‹ï¼š</p><p style=text-align:start><strong>1.å®šä¹‰é…ç½®æ ‡è®°</strong></p><p style=text-align:start><strong>2.å®šä¹‰é»˜è®¤åˆ‡é¢ç±»</strong></p><p style=text-align:start><strong>3.å®šä¹‰åˆ‡é¢ç»‡å…¥å™¨</strong></p><p style=text-align:start><strong>æ ¸å¿ƒæµç¨‹ï¼š</strong></p><p style=text-align:start>1.è·å–æ‰€æœ‰çš„åˆ‡é¢ç±»</p><p style=text-align:start>2.éå†å®¹å™¨ç®¡ç†çš„ç±»3.ç­›é€‰å‡ºåŒ¹é…å®¹å™¨ç®¡ç†ç±»çš„åˆ‡é¢aspectlist4.å°è¯•è¿›è¡ŒAspectçš„ç»‡å…¥ ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡ å¹¶æ›¿æ¢beancontainerä¸­åŸå…ˆclasså¯¹åº”æ‰€å¯¹åº”çš„å®ä¾‹å¯¹è±¡</p><p style=text-align:start><strong>4.å…¶ä»–ç±»ï¼šåˆ‡é¢ä¿¡æ¯åŒ…è£…ç±»/InvocationHandlerå®ç°ç±»/åˆ›å»ºä»£ç†å®ä¾‹ç±»/è§£æAspectè¡¨è¾¾å¼å·¥å…·ç±»ç­‰ã€‚</strong></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'æ‰‹å†™','AOP','å®ç°'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>