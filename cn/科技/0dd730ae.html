<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>使用Oauth2实现微服务的安全保护 | 极客快訊</title><meta property="og:title" content="使用Oauth2实现微服务的安全保护 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/6681021783c347c1be319363de838822"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0dd730ae.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0dd730ae.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0dd730ae.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0dd730ae.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0dd730ae.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0dd730ae.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0dd730ae.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0dd730ae.html><meta property="article:published_time" content="2020-11-14T21:00:29+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:29+08:00"><meta name=Keywords content><meta name=description content="使用Oauth2实现微服务的安全保护"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/0dd730ae.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>使用Oauth2实现微服务的安全保护</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>序言</h1><p>安全性是暴露由许多微服务组成的公共访问API时要考虑的最重要的一个方面。Spring有一些有趣的功能和框架，使我们的微服务安全配置更容易。在本文中，我将向您展示如何使用Spring Cloud和Oauth2在API网关后面提供令牌访问安全性。</p><h1>理论知识</h1><p>OAuth2标准目前被所有主要网站使用并且允许通过共享API访问其资源。它是一种开放式授权标准，允许用户将存储在一个页面中的私有资源共享到另一个页面，而无需进入其凭据服务。这些是与oauth2相关的基本术语。</p><ul><li class=ql-align-justify>Resource Owner – 处理对资源的访问</li><li class=ql-align-justify>Resource Server – 存储可以使用特殊令牌共享的所有者资源的服务器</li><li class=ql-align-justify>Authorization Server – 管理密钥，令牌和其他临时资源访问代码的分配。它还必须确保授予相关人员访问权限</li><li class=ql-align-justify>Access Token – 允许访问资源的密钥</li><li class=ql-align-justify>Authorization Grant – 授予访问权限。有多种方法可以确认访问权限：授权代码，隐式，资源所有者密码凭据和客户端凭据</li></ul><p>您可以在此处以及在digitalocean文章中阅读有关此标准的更多信息。该协议的流程主要有三个步骤。首先，我们将授权请求发送给资源所有者。在资源所有者响应后，我们向授权服务器发送授权请求并接收访问令牌。最后，我们将此访问令牌发送到资源服务器，如果它有效，则API将资源提供给应用程序。</p><h1>方案</h1><p>下图显示了我们案例的架构。我们用API网关（Zuul）代理我们对授权服务器的请求和两个帐户微服务实例。授权服务器是某种提供outh2安全机制的基础结构服务。我们还有发现服务（Eureka），我们所有的微服务都已注册。</p><div class=pgc-img><img alt=使用Oauth2实现微服务的安全保护 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6681021783c347c1be319363de838822><p class=pgc-img-caption></p></div><h1>网关</h1><p>对于我们的示例，我们不会在API网关上提供任何安全性。它只需要将客户端的请求代理到授权服务器和帐户微服务。在下面可见的Zuul的网关配置中，我们将sensitiveHeaders属性设为空值以启用授权HTTP头转发。默认情况下，Zuul在将我们的请求转发到目标API时切断了该头，这是不正确的，因为网关后面的服务需要基本授权。</p><div class=pgc-img><img alt=使用Oauth2实现微服务的安全保护 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cdeb5d9695ce439c8465c87d587bd894><p class=pgc-img-caption></p></div><p>网关源代码中的主类非常简单。它只需要启用Zuul代理功能和发现客户端来收集Eureka注册表中的服务。</p><div class=pgc-img><img alt=使用Oauth2实现微服务的安全保护 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/63fb4a5629b34e209053f9075abe44e2><p class=pgc-img-caption></p></div><h1>授权服务器</h1><p>gaOur授权服务器内的主类也很简单。它基于默认的Spring安全配置。客户端授权详细信息存储在内存存储库中。当然在生产模式中，您也可以使用其他实现而不是内存存储库，如JDBC数据源和令牌存储。您可以在Spring Security Reference和Spring Boot Security中阅读有关Spring授权机制的更多信息。这是application.yml的配置片段。我们为/ token端点提供了用户基本身份验证数据和基本安全凭证：client-id和client-secret。用户凭据是普通的Spring Security用户详细信息。</p><div class=pgc-img><img alt=使用Oauth2实现微服务的安全保护 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a800bff45f02417a9e4eacb31447074b><p class=pgc-img-caption></p></div><p>这是用@EnableAuthorizationServer实现身份验证服务器的主要类。我们公开一个REST端点验证帐户服务的用户身份详情，并为客户端启用了Eureka注册和发现。</p><div class=pgc-img><img alt=使用Oauth2实现微服务的安全保护 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/739683e476e0449fa9255547114a0881><p class=pgc-img-caption></p></div><h1>Application-账户微服务</h1><p>我们的示例微服务只有一个@GET请求的端点，它始终返回相同的帐户。在主类中，资源服务和Eureka发现都已启用。服务配置很简单。 GitHub上提供了示例应用程序源代码。</p><div class=pgc-img><img alt=使用Oauth2实现微服务的安全保护 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c8120c42ff704d58ac0a6a9e01655b88><p class=pgc-img-caption></p></div><h1>测试</h1><p>我们只需要Web浏览器和REST客户端（例如Chrome Advanced REST客户端）来测试我们的解决方案。从向资源所有者发送授权请求开始测试。我们可以通过Web浏览器中的Zuul网关调用oauth2授权端点。</p><p>http://localhost:8765/uaa/oauth/authorize?response_type=token&client_id=acme&redirect_uri=http://example.com&scope=openid&state=48532</p><p>发送请求后，我们应该看到下面的页面。选择“Approve”，然后单击“Authorize”,从授权服务器请求访问令牌。如果应用程序标识已通过身份验证且授权授予有效，则应在HTTP响应中返回应用程序的访问标记。</p><div class=pgc-img><img alt=使用Oauth2实现微服务的安全保护 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5c036f408c4c4d87804b2651f10db341><p class=pgc-img-caption></p></div><p>http://example.com/#access_token=b1acaa35-1ebd-4995-987d-56ee1c0619e5&token_type=bearer&state=48532&expires_in=43199</p><p>最后一步是使用访问令牌调用帐户端点。我们不得不将其作为承载令牌放入Authorization标头中。在示例应用程序中，安全操作的日志记录级别设置为TRACE，因此您可以轻松找出问题发生时的情况。</p><div class=pgc-img><img alt=使用Oauth2实现微服务的安全保护 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/58d5ccca0b854fabb55377c7cc93c1bb><p class=pgc-img-caption></p></div><h1>结束语</h1><p>说实话，我不太熟悉应用程序中的安全问题。所以对我来说一个非常重要的是使用的安全解决方案的简单性。在Spring Security中，我们几乎所有需要的机制都是开箱即用的。它还提供可轻松扩展的组件，以满足更高级的要求。您应该将本文视为使用Spring Cloud和Spring Security项目的更高级解决方案的简要介绍。</p><blockquote><p>原文链接：https://piotrminkowski.wordpress.com/2017/02/22/microservices-security-with-oauth2/</p><p>作者：Piotr Mińkowski</p><p>译者：Emma</p></blockquote></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Oauth2','实现','保护'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>