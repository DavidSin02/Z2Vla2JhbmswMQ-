<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>「硬见小百科」趣味SPI总线解析 | 极客快訊</title><meta property="og:title" content="「硬见小百科」趣味SPI总线解析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/c808a0034be14b05a76c2de46d6f86da"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0e4731f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0e4731f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0e4731f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0e4731f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0e4731f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0e4731f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0e4731f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0e4731f.html><meta property="article:published_time" content="2020-10-29T21:04:05+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:05+08:00"><meta name=Keywords content><meta name=description content="「硬见小百科」趣味SPI总线解析"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/0e4731f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>「硬见小百科」趣味SPI总线解析</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>SPI全称是串行外设接口（Serial Peripheral Interface），是由Motorola提出的一种全双工（全双工指可以同时（瞬时）进行信号的双向传输（A→B且B→A））同步串行通信接口，通信波特率可以高达5Mbps，但具体速度大小取决于SPI硬件。</p><p>SPI总线只需四条线就可以完成MCU与各种外围器件的通讯。</p><p>1）MOSI（SDI） – Master数据输出,Slave数据输入</p><p>2）MISO (SDO) – Master数据输入,Slave数据输出</p><p>3）SClK – 时钟信号,由Master产生</p><p>4）/CS – Slave使能信号,由Master控制。</p><div class=pgc-img><img alt=「硬见小百科」趣味SPI总线解析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c808a0034be14b05a76c2de46d6f86da><p class=pgc-img-caption></p></div><p>Msater为主模式，Slave从模式。SPI通信就是采用这样的主从模式（Master-Slave）架构，一般为一个Master和多个Slave的应用模式。切记，谁为主，谁提供SCLK时钟信号。</p><div class=pgc-img><img alt=「硬见小百科」趣味SPI总线解析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f1c57b703f6243579b2e97edc7454803><p class=pgc-img-caption></p></div><p>在以上四根线中，CS是控制芯片是否被选中的，只有选信号为预先规定的使能信号时，对此芯片的操作才有效。这就允许主模式在同一总线上连接多个SPI设备成为可能。接下来再连接通讯的3根线就可以了。</p><div class=pgc-img><img alt=「硬见小百科」趣味SPI总线解析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/792d21344c1e408a97abf6c175223140><p class=pgc-img-caption></p></div><p>SPI如何实现通讯</p><p>SPI也是串行通讯协议，是说数据是一位一位传输的。这是SCLK时钟线存在的原因，由SCLK提供时钟脉冲，SDI，SDO则基于此脉冲完成数据传输。操作时序很简单，如下：</p><div class=pgc-img><img alt=「硬见小百科」趣味SPI总线解析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/85d485f3721e4a47aadba8dea2ca6de4><p class=pgc-img-caption></p></div><p>看见时序图了，就知道怎么通讯了。SPI接口在Master控制下产生的从器件使能信号和时钟信号，两个双向移位寄存器按位传输进行数据交换，传输数据高位在前，低位在后（MSB first）。在SCK的下降沿上数据改变，上升沿一位数据被存入移位寄存器。</p><p>换个说法，SPI是一个环形总线结构，主要是在sck的控制下，两个双向移位寄存器进行数据交换。对于主机来说，上升沿发送、下降沿接收、高位先发送。</p><p>上升沿到来的时候，sdi上的电平将被发送到从设备的寄存器中。从M_Sbuff寄存器的7位，发送到S_Sbuff寄存器的0位;</p><div class=pgc-img><img alt=「硬见小百科」趣味SPI总线解析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/82a44a43f0d34112aa22ff65f707f08f><p class=pgc-img-caption></p></div><p>下降沿到来的时候，sdi上的电平将被接收到主设备的寄存器中。从S_Sbuff寄存器的7位，发送到M_Sbuff寄存器的0位;</p><p>一个完整的传送周期是16位，即两个字节，因为，首先主机要发送命令过去，然后从机根据主机的命令准备数据，主机在下一个8位时钟周期才把数据读回来。</p><p>SPI总线比IIC总线传输数据省事。之前用过的IIC通讯，又有起始位，又有停止位的。SPI比较豪爽，对于主机来说，有上升沿就写一位，有下降沿就读一位。因为这样，SPI能够不等8位数据都传完就停止。没有了主机发出的SCLK脉冲，就不再有数据交换了。需要注意的是：我们的主设备能够控制时钟，因为我们的SPI通信并不像UART或者IIC通信那样有专门的通信周期，有专门的通信起始信号，有专门的通信结束信号；所以我们的SPI协议能够通过控制时钟信号线，当没有数据交流的时候我们的时钟线要么是保持高电平要么是保持低电平。</p><div class=pgc-img><img alt=「硬见小百科」趣味SPI总线解析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/792d21344c1e408a97abf6c175223140><p class=pgc-img-caption></p></div><p>SPI注意事项与实现</p><p>SPI总线有四种工作方式(SPI0, SPI1, SPI2, SPI3)，其中使用的最为广泛的是SPI0和SPI3方式。</p><p>时钟极性CPOL是用来配置SCLK的电平出于哪种状态时是空闲态或者有效态，时钟相位CPHA 是用来配置数据采样是在第几个边沿：</p><p>CPOL=0，表示当SCLK=0时处于空闲态，所以有效状态就是SCLK处于高电平时；</p><p>CPOL=1，表示当SCLK=1时处于空闲态，所以有效状态就是SCLK处于低电平时；</p><p>CPHA=0，表示数据采样是在第1个边沿，数据发送在第2个边沿；</p><p>CPHA=1，表示数据采样是在第2个边沿，数据发送在第1个边沿。</p><div class=pgc-img><img alt=「硬见小百科」趣味SPI总线解析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/587a69cf791442688b0bd299a7eba1e3><p class=pgc-img-caption></p></div><p>如上图，乃SPI四种模式的时序图。</p><p>CPOL=0，CPHA=0：此时空闲态时，SCLK处于低电平，数据采样是在第1个边沿，也就是SCLK由低电平到高电平的跳变，所以数据采样是在上升沿，数据发送是在下降沿。</p><p>CPOL=0，CPHA=1：此时空闲态时，SCLK处于低电平，数据发送是在第1个边沿，也就是SCLK由低电平到高电平的跳变，所以数据采样是在下降沿，数据发送是在上升沿。</p><p>CPOL=1，CPHA=0：此时空闲态时，SCLK处于高电平，数据采集是在第1个边沿，也就是SCLK由高电平到低电平的跳变，所以数据采集是在下降沿，数据发送是在上升沿。</p><p>CPOL=1，CPHA=1：此时空闲态时，SCLK处于高电平，数据发送是在第1个边沿，也就是SCLK由高电平到低电平的跳变，所以数据采集是在上升沿，数据发送是在下降沿。</p><p><strong>如果要实现连接通讯，确定单片机（Master MCU1）为主模式，单片机（Slave MCU1）为从模式。各自也配置好了SLCK，MOSI，MISO和SCK的io引脚。选择了默认的SPI0模式。原理图如下：</strong></p><div class=pgc-img><img alt=「硬见小百科」趣味SPI总线解析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ef22f6a5c25042d790e2c059b00a4f73><p class=pgc-img-caption></p></div><p><strong>按图连接好后，Master MCU1单片机发送1—10的数字给Slave MCU1单片机；Slave MCU1收到后，用流水灯作为回应。程序如下：</strong></p><p>①：数据发送程序(主机仅发送)</p><p>#define uchar unsigned char</p><p>#define uint unsigned int</p><p>#define ulong unsigned long</p><p>//---------------------------</p><p>#include &lt;REG52.H></p><p>#include&lt;STDIO.H></p><p>//---------------------------</p><p>sbit SPICLK = P1^0; //时钟信号</p><p>sbit MOSI = P1^1; //主器件数据输出，从器件数据输入</p><p>sbit MISO = P1^2; //主器件数据输入，从器件数据输出</p><p>sbit SS = P1^3; //从器件使能信号</p><p>void Dat_Transmit(uchar dat) //发送数据程序</p><p>{</p><p>uchar i,datbuf; //主机数据暂存寄存器</p><p>datbuf=dat;</p><p>SS=1;</p><p>while(SS){;}</p><p>for(i=0;i&lt;8;i++) //</p><p>{</p><p>while(SPICLK){;}</p><p>if(datbuf&0x80)</p><p>MISO=1;</p><p>else</p><p>MISO=0;</p><p>datbuf=(datbuf&lt;&lt;1);</p><p>while(~SPICLK){;}</p><p>}</p><p>}</p><p>void main(void)</p><p>{</p><p>uchar i;</p><p>while(1)</p><p>{</p><p>for(i=0;i&lt;10;i++)</p><p>{</p><p>Dat_Transmit(i);</p><p>}</p><p>}</p><p>}</p><p>②：数据接收程序（从机仅接收）</p><p>#define uchar unsigned char</p><p>#define uint unsigned int</p><p>#define ulong unsigned long</p><p>//---------------------------</p><p>#include &lt;REG52.H></p><p>#include&lt;STDIO.H></p><p>//---------------------------</p><p>sbit SPICLK = P1^0; //时钟信号</p><p>sbit MOSI = P1^1; //主器件数据输出，从器件数据输入</p><p>sbit MISO = P1^2; //主器件数据输入，从器件数据输出</p><p>sbit SS = P1^3; //从器件使能信号</p><p>//---------------------------</p><p>void Nop(void)</p><p>{</p><p>;</p><p>}</p><p>void Delay(uchar t)</p><p>{</p><p>while(t--){;}</p><p>}</p><p>uchar Data_Receive(void) //数据接收程序</p><p>{</p><p>uchar i,dat=0,temp;</p><p>bit bt;</p><p>SPICLK=1;</p><p>MISO=1;</p><p>SS=0; //选中器件</p><p>Nop();</p><p>Nop();</p><p>for(i=0;i&lt;8;i++)</p><p>{</p><p>SPICLK=1;</p><p>Nop();</p><p>Nop();</p><p>Nop();</p><p>SPICLK=0;</p><p>Nop();</p><p>Nop();</p><p>bt=MISO;</p><p>if(bt)</p><p>temp=0x01;</p><p>else temp=0x00;</p><p>dat=(dat&lt;&lt;1);</p><p>dat=(dat|temp);</p><p>}</p><p>SS=1;</p><p>SPICLK=1;</p><p>return dat;</p><p>}</p><p>void main(void)</p><p>{</p><p>uchar exdat;</p><p>uchar i=0;</p><p>uchar code table[10]={0x3F,0x06,0x5B,0x4F,0x66,0x6D,0x7D,0x07,</p><p>0x7F,0x6F};</p><p>P2=0;</p><p>while(1)</p><p>{</p><p>exdat=Data_Receive();</p><p>P0=table[exdat];</p><p>for(i=0;i&lt;200;i++)</p><p>Delay(200);</p><p>}</p><p>}</p><p><strong>SPI总线注意点</strong></p><p>1. Master配置SPI接口时钟的时候一定要考虑从设备的操作时序要求，因为Master这边的时钟极性和相位都是以Slave为基准的。因此在时钟极性的配置上一定要确定Slave是在SCK的下降沿还是上升沿输出数据，是在SCK的上升沿还是下降沿接收数据。</p><p>2. 当Slave时钟频率小于Master时钟频率时，如果Master的SCK的速率太快，会出现Slave接收到的数据不正确，而SPI接口又没有应答机制确认Slave是否接收到数据从而导致通信传输数据错误。</p><p>3. SPI总线系统是一种同步串行外设接口，它可以使MCU与各种外围设备以串行方式进行通信以交换信息。除了MCU,还有FLASHRAM、网络控制器、LCD显示驱动器和A/D转换器等外围设置。</p><p>4. 上面的代码所用指令是STC 89C51单片机所用如需用其它芯片请另行更改。</p><p>以上所有信息仅作为学习交流使用，不作为任何学习和商业标准。</p><p>若您对文中任何信息有异议，欢迎随时提出，谢谢！</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'硬见','SPI','总线'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>