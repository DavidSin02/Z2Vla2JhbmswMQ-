<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>å†™ä¸ªæ—¥å¿—è¯·æ±‚åˆ‡é¢ï¼Œå‰åç«¯ç”©é”…æ›´æ–¹ä¾¿ | æå®¢å¿«è¨Š</title><meta property="og:title" content="å†™ä¸ªæ—¥å¿—è¯·æ±‚åˆ‡é¢ï¼Œå‰åç«¯ç”©é”…æ›´æ–¹ä¾¿ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/dfic-imagehandler/9ee016d0-a9b0-43a8-95a8-2d6d7b5e7e21"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0f8e9216.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0f8e9216.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0f8e9216.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0f8e9216.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0f8e9216.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0f8e9216.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0f8e9216.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0f8e9216.html><meta property="article:published_time" content="2020-11-14T21:04:29+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:29+08:00"><meta name=Keywords content><meta name=description content="å†™ä¸ªæ—¥å¿—è¯·æ±‚åˆ‡é¢ï¼Œå‰åç«¯ç”©é”…æ›´æ–¹ä¾¿"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/0f8e9216.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>å†™ä¸ªæ—¥å¿—è¯·æ±‚åˆ‡é¢ï¼Œå‰åç«¯ç”©é”…æ›´æ–¹ä¾¿</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><ul><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6742300535308698126/?group_id=6742300535308698126" rel="noopener noreferrer" target=_blank>ç§‹æ‹›Javaé¢è¯•å¤§çº²ï¼šJava+å¹¶å‘+spring+æ•°æ®åº“+Redis+JVM+Nettyç­‰</a></strong><br></li><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6752861414169248260/?group_id=6752861414169248260" rel="noopener noreferrer" target=_blank>é˜¿é‡Œä¸€çº¿æ¶æ„å¸ˆåˆ†äº«çš„æŠ€æœ¯å›¾è°±ï¼Œè¿›é˜¶åŠ è–ªå…¨é å®ƒ</a></strong><br></li><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6751939760798843406/?group_id=6751939760798843406" rel="noopener noreferrer" target=_blank>Springå…¨å®¶æ¡¶ç¬”è®°ï¼šSpring+Spring Boot+Spring Cloud+Spring MVC</a></strong><br></li><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6799229488912663052/?group_id=6799229488912663052" rel="noopener noreferrer" target=_blank>æœ€æ–°å‡ºç‚‰ï¼Œå¤´æ¡ä¸‰é¢æŠ€æœ¯å››é¢HRï¼Œçœ‹æˆ‘å¦‚ä½•ä¸€æ­¥ä¸€æ­¥æ”»å…‹é¢è¯•å®˜ï¼Ÿ</a></strong><br></li></ul><h1 class=pgc-h-arrow-right>å†™åœ¨å‰é¢</h1><p>æœ¬ç¯‡æ–‡ç« æ˜¯å®æˆ˜æ€§çš„ï¼Œå¯¹äºåˆ‡é¢çš„åŸç†ä¸ä¼šè®²è§£ï¼Œåªä¼šç®€å•ä»‹ç»ä¸€ä¸‹åˆ‡é¢çš„çŸ¥è¯†ç‚¹</p><div class=pgc-img><img alt=å†™ä¸ªæ—¥å¿—è¯·æ±‚åˆ‡é¢ï¼Œå‰åç«¯ç”©é”…æ›´æ–¹ä¾¿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/9ee016d0-a9b0-43a8-95a8-2d6d7b5e7e21><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>åˆ‡é¢ä»‹ç»</h1><p>é¢å‘åˆ‡é¢ç¼–ç¨‹æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œå®ƒä½œä¸ºOOPé¢å‘å¯¹è±¡ç¼–ç¨‹çš„ä¸€ç§è¡¥å……ï¼Œç”¨äºå¤„ç†ç³»ç»Ÿä¸­åˆ†å¸ƒäºå„ä¸ªæ¨¡å—çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œæ¯”å¦‚<strong>äº‹åŠ¡ç®¡ç†</strong>ã€<strong>æƒé™æ§åˆ¶</strong>ã€<strong>ç¼“å­˜æ§åˆ¶</strong>ã€<strong>æ—¥å¿—æ‰“å°</strong>ç­‰ç­‰ã€‚ AOPæŠŠè½¯ä»¶çš„åŠŸèƒ½æ¨¡å—åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šæ ¸å¿ƒå…³æ³¨ç‚¹å’Œæ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚ä¸šåŠ¡å¤„ç†çš„ä¸»è¦åŠŸèƒ½ä¸ºæ ¸å¿ƒå…³æ³¨ç‚¹ï¼Œè€Œéæ ¸å¿ƒã€éœ€è¦æ‹“å±•çš„åŠŸèƒ½ä¸ºæ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚AOPçš„ä½œç”¨åœ¨äºåˆ†ç¦»ç³»ç»Ÿä¸­çš„å„ç§å…³æ³¨ç‚¹ï¼Œå°†æ ¸å¿ƒå…³æ³¨ç‚¹å’Œæ¨ªåˆ‡å…³æ³¨ç‚¹è¿›è¡Œåˆ†ç¦»ï¼Œä½¿ç”¨åˆ‡é¢æœ‰ä»¥ä¸‹å¥½å¤„ï¼š</p><ul><li>é›†ä¸­å¤„ç†æŸä¸€å…³æ³¨ç‚¹/æ¨ªåˆ‡é€»è¾‘</li><li>å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ·»åŠ /åˆ é™¤å…³æ³¨ç‚¹</li><li>ä¾µå…¥æ€§å°‘ï¼Œå¢å¼ºä»£ç å¯è¯»æ€§åŠå¯ç»´æŠ¤æ€§ å› æ­¤å½“æƒ³æ‰“å°è¯·æ±‚æ—¥å¿—æ—¶å¾ˆå®¹æ˜“æƒ³åˆ°åˆ‡é¢ï¼Œå¯¹æ§åˆ¶å±‚ä»£ç 0ä¾µå…¥</li></ul><h1 class=pgc-h-arrow-right>åˆ‡é¢çš„ä½¿ç”¨ã€åŸºäºæ³¨è§£ã€‘</h1><ul><li>@Aspect => å£°æ˜è¯¥ç±»ä¸ºä¸€ä¸ªæ³¨è§£ç±»</li></ul><p><strong>åˆ‡ç‚¹æ³¨è§£ï¼š</strong></p><ul><li>@Pointcut => å®šä¹‰ä¸€ä¸ªåˆ‡ç‚¹ï¼Œå¯ä»¥ç®€åŒ–ä»£ç </li></ul><p><strong>é€šçŸ¥æ³¨è§£ï¼š</strong></p><ul><li>@Before => åœ¨åˆ‡ç‚¹ä¹‹å‰æ‰§è¡Œä»£ç </li><li>@After => åœ¨åˆ‡ç‚¹ä¹‹åæ‰§è¡Œä»£ç </li><li>@AfterReturning => åˆ‡ç‚¹è¿”å›å†…å®¹åæ‰§è¡Œä»£ç ï¼Œå¯ä»¥å¯¹åˆ‡ç‚¹çš„è¿”å›å€¼è¿›è¡Œå°è£…</li><li>@AfterThrowing => åˆ‡ç‚¹æŠ›å‡ºå¼‚å¸¸åæ‰§è¡Œ</li><li>@Around => ç¯ç»•ï¼Œåœ¨åˆ‡ç‚¹å‰åæ‰§è¡Œä»£ç </li></ul><h1 class=pgc-h-arrow-right>åŠ¨æ‰‹å†™ä¸€ä¸ªè¯·æ±‚æ—¥å¿—åˆ‡é¢</h1><ul><li>ä½¿ç”¨@Pointcutå®šä¹‰åˆ‡ç‚¹</li></ul><pre><code>@Pointcut("execution(* your_package.controller..*(..))")public void requestServer() {}</code></pre><p>@Pointcutå®šä¹‰äº†ä¸€ä¸ªåˆ‡ç‚¹ï¼Œå› ä¸ºæ˜¯è¯·æ±‚æ—¥å¿—åˆ‡è¾¹ï¼Œå› æ­¤åˆ‡ç‚¹å®šä¹‰çš„æ˜¯ControlleråŒ…ä¸‹çš„æ‰€æœ‰ç±»ä¸‹çš„æ–¹æ³•ã€‚å®šä¹‰åˆ‡ç‚¹ä»¥ååœ¨é€šçŸ¥æ³¨è§£ä¸­ç›´æ¥ä½¿ç”¨requestServeræ–¹æ³•åå°±å¯ä»¥äº†</p><ul><li>ä½¿ç”¨@Beforeå†åˆ‡ç‚¹å‰æ‰§è¡Œ</li></ul><pre><code>@Before("requestServer()")public void doBefore(JoinPoint joinPoint) {    ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();    HttpServletRequest request = attributes.getRequest();    LOGGER.info("===============================Start========================");    LOGGER.info("IP                 : {}", request.getRemoteAddr());    LOGGER.info("URL                : {}", request.getRequestURL().toString());    LOGGER.info("HTTP Method        : {}", request.getMethod());    LOGGER.info("Class Method       : {}.{}", joinPoint.getSignature().getDeclaringTypeName(), joinPoint.getSignature().getName());}</code></pre><p>åœ¨è¿›å…¥Controlleræ–¹æ³•å‰ï¼Œæ‰“å°å‡ºè°ƒç”¨æ–¹IPã€è¯·æ±‚URLã€HTTPè¯·æ±‚ç±»å‹ã€è°ƒç”¨çš„æ–¹æ³•å</p><ul><li>ä½¿ç”¨@Aroundæ‰“å°è¿›å…¥æ§åˆ¶å±‚çš„å…¥å‚</li></ul><pre><code>@Around("requestServer()")public Object doAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {    long start = System.currentTimeMillis();    Object result = proceedingJoinPoint.proceed();    LOGGER.info("Request Params       : {}", getRequestParams(proceedingJoinPoint));    LOGGER.info("Result               : {}", result);    LOGGER.info("Time Cost            : {} ms", System.currentTimeMillis() - start);    return result;}</code></pre><p>é€šè¿‡ @PathVariableä»¥åŠ@RequestParamæ³¨è§£ä¼ é€’çš„å‚æ•°æ— æ³•æ‰“å°å‡ºå‚æ•°åï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨æ‹¼æ¥ä¸€ä¸‹å‚æ•°åï¼ŒåŒæ—¶å¯¹æ–‡ä»¶å¯¹è±¡è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼Œåªéœ€è·å–æ–‡ä»¶åå³å¯</p><p>æ‰“å°äº†å…¥å‚ã€ç»“æœä»¥åŠè€—æ—¶</p><ul><li>getRquestParamsæ–¹æ³•</li></ul><pre><code>private Map&lt;String, Object&gt; getRequestParams(ProceedingJoinPoint proceedingJoinPoint) {     Map&lt;String, Object&gt; requestParams = new HashMap&lt;&gt;();      //å‚æ•°å     String[] paramNames = ((MethodSignature)proceedingJoinPoint.getSignature()).getParameterNames();     //å‚æ•°å€¼     Object[] paramValues = proceedingJoinPoint.getArgs();     for (int i = 0; i &lt; paramNames.length; i++) {         Object value = paramValues[i];         //å¦‚æœæ˜¯æ–‡ä»¶å¯¹è±¡         if (value instanceof MultipartFile) {             MultipartFile file = (MultipartFile) value;             value = file.getOriginalFilename();  //è·å–æ–‡ä»¶å         }         requestParams.put(paramNames[i], value);     }     return requestParams; }</code></pre><p>é€šè¿‡ @PathVariableä»¥åŠ@RequestParamæ³¨è§£ä¼ é€’çš„å‚æ•°æ— æ³•æ‰“å°å‡ºå‚æ•°åï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨æ‹¼æ¥ä¸€ä¸‹å‚æ•°åï¼ŒåŒæ—¶å¯¹æ–‡ä»¶å¯¹è±¡è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼Œåªéœ€è·å–æ–‡ä»¶åå³å¯</p><ul><li>@Afteræ–¹æ³•è°ƒç”¨åæ‰§è¡Œ</li></ul><pre><code>@After("requestServer()")public void doAfter(JoinPoint joinPoint) {    LOGGER.info("===============================End========================");}</code></pre><p>æ²¡æœ‰ä¸šåŠ¡é€»è¾‘åªæ˜¯æ‰“å°äº†End</p><ul><li>å®Œæ•´åˆ‡é¢ä»£ç </li></ul><pre><code>@Component@Aspectpublic class RequestLogAspect {    private final static Logger LOGGER = LoggerFactory.getLogger(RequestLogAspect.class);    @Pointcut("execution(* your_package.controller..*(..))")    public void requestServer() {    }    @Before("requestServer()")    public void doBefore(JoinPoint joinPoint) {        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();        HttpServletRequest request = attributes.getRequest();        LOGGER.info("===============================Start========================");        LOGGER.info("IP                 : {}", request.getRemoteAddr());        LOGGER.info("URL                : {}", request.getRequestURL().toString());        LOGGER.info("HTTP Method        : {}", request.getMethod());        LOGGER.info("Class Method       : {}.{}", joinPoint.getSignature().getDeclaringTypeName(),  joinPoint.getSignature().getName());    }    @Around("requestServer()")    public Object doAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {        long start = System.currentTimeMillis();        Object result = proceedingJoinPoint.proceed();        LOGGER.info("Request Params     : {}", getRequestParams(proceedingJoinPoint));        LOGGER.info("Result               : {}", result);        LOGGER.info("Time Cost            : {} ms", System.currentTimeMillis() - start);        return result;    }    @After("requestServer()")    public void doAfter(JoinPoint joinPoint) {        LOGGER.info("===============================End========================");    }    /**     * è·å–å…¥å‚     * @param proceedingJoinPoint     *     * @return     * */    private Map&lt;String, Object&gt; getRequestParams(ProceedingJoinPoint proceedingJoinPoint) {        Map&lt;String, Object&gt; requestParams = new HashMap&lt;&gt;();        //å‚æ•°å        String[] paramNames = ((MethodSignature)proceedingJoinPoint.getSignature()).getParameterNames();        //å‚æ•°å€¼        Object[] paramValues = proceedingJoinPoint.getArgs();        for (int i = 0; i &lt; paramNames.length; i++) {            Object value = paramValues[i];            //å¦‚æœæ˜¯æ–‡ä»¶å¯¹è±¡            if (value instanceof MultipartFile) {                MultipartFile file = (MultipartFile) value;                value = file.getOriginalFilename();  //è·å–æ–‡ä»¶å            }            requestParams.put(paramNames[i], value);        }        return requestParams;    }}</code></pre><h1 class=pgc-h-arrow-right>é«˜å¹¶å‘ä¸‹è¯·æ±‚æ—¥å¿—åˆ‡é¢</h1><p>å†™å®Œä»¥åå¯¹è‡ªå·±çš„ä»£ç å¾ˆæ»¡æ„ï¼Œä½†æ˜¯æƒ³ç€å¯èƒ½è¿˜æœ‰å®Œå–„çš„åœ°æ–¹å°±å’Œæœ‹å‹äº¤æµäº†ä¸€ä¸‹ã€‚emmmm</p><div class=pgc-img><img alt=å†™ä¸ªæ—¥å¿—è¯·æ±‚åˆ‡é¢ï¼Œå‰åç«¯ç”©é”…æ›´æ–¹ä¾¿ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/afebcebb0d30444e9368ac34e7871f83><p class=pgc-img-caption></p></div><p><br></p><p>æœç„¶è¿˜æœ‰ç»§ç»­ä¼˜åŒ–çš„åœ°æ–¹ æ¯ä¸ªä¿¡æ¯éƒ½æ‰“å°ä¸€è¡Œï¼Œåœ¨é«˜å¹¶å‘è¯·æ±‚ä¸‹ç¡®å®ä¼šå‡ºç°è¯·æ±‚ä¹‹é—´æ‰“å°æ—¥å¿—ä¸²è¡Œçš„é—®é¢˜ï¼Œå› ä¸ºæµ‹è¯•é˜¶æ®µè¯·æ±‚æ•°é‡è¾ƒå°‘æ²¡æœ‰å‡ºç°ä¸²è¡Œçš„æƒ…å†µï¼Œæœç„¶ç”Ÿäº§ç¯å¢ƒæ‰æ˜¯ç¬¬ä¸€å‘å±•åŠ›ï¼Œèƒ½å¤Ÿé‡åˆ°æ›´å¤šbugï¼Œå†™æ›´å¥å£®çš„ä»£ç  è§£å†³æ—¥å¿—ä¸²è¡Œçš„é—®é¢˜åªè¦å°†å¤šè¡Œæ‰“å°ä¿¡æ¯åˆå¹¶ä¸ºä¸€è¡Œå°±å¯ä»¥äº†ï¼Œå› æ­¤æ„é€ ä¸€ä¸ªå¯¹è±¡</p><ul><li>RequestInfo.java</li></ul><pre><code>@Datapublic class RequestInfo {    private String ip;    private String url;    private String httpMethod;    private String classMethod;    private Object requestParams;    private Object result;    private Long timeCost;}</code></pre><ul><li>ç¯ç»•é€šçŸ¥æ–¹æ³•ä½“</li></ul><pre><code>@Around("requestServer()")public Object doAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {    long start = System.currentTimeMillis();    ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();    HttpServletRequest request = attributes.getRequest();    Object result = proceedingJoinPoint.proceed();    RequestInfo requestInfo = new RequestInfo();            requestInfo.setIp(request.getRemoteAddr());    requestInfo.setUrl(request.getRequestURL().toString());    requestInfo.setHttpMethod(request.getMethod());    requestInfo.setClassMethod(String.format("%s.%s", proceedingJoinPoint.getSignature().getDeclaringTypeName(),            proceedingJoinPoint.getSignature().getName()));    requestInfo.setRequestParams(getRequestParamsByProceedingJoinPoint(proceedingJoinPoint));    requestInfo.setResult(result);    requestInfo.setTimeCost(System.currentTimeMillis() - start);    LOGGER.info("Request Info      : {}", JSON.toJSONString(requestInfo));    return result;}</code></pre><p>å°†urlã€http requestè¿™äº›ä¿¡æ¯ç»„è£…æˆRequestInfoå¯¹è±¡ï¼Œå†åºåˆ—åŒ–æ‰“å°å¯¹è±¡ æ‰“å°<strong>åºåˆ—åŒ–</strong>å¯¹è±¡ç»“æœè€Œä¸æ˜¯ç›´æ¥æ‰“å°å¯¹è±¡æ˜¯å› ä¸ºåºåˆ—åŒ–æœ‰æ›´ç›´è§‚ã€æ›´æ¸…æ™°ï¼ŒåŒæ—¶å¯ä»¥å€ŸåŠ©åœ¨çº¿è§£æå·¥å…·å¯¹ç»“æœè¿›è¡Œè§£æ</p><div class=pgc-img><img alt=å†™ä¸ªæ—¥å¿—è¯·æ±‚åˆ‡é¢ï¼Œå‰åç«¯ç”©é”…æ›´æ–¹ä¾¿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3c44ec4834b54e19b05548c8c0ac4123><p class=pgc-img-caption></p></div><p>æ˜¯ä¸æ˜¯è¿˜ä¸é”™<br>åœ¨è§£å†³é«˜å¹¶å‘ä¸‹è¯·æ±‚ä¸²è¡Œé—®é¢˜çš„åŒæ—¶æ·»åŠ äº†å¯¹<strong>å¼‚å¸¸è¯·æ±‚ä¿¡æ¯çš„æ‰“å°</strong>ï¼Œé€šè¿‡ä½¿ç”¨ @AfterThrowingæ³¨è§£å¯¹æŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•è¿›è¡Œå¤„ç†</p><ul><li>RequestErrorInfo.java</li></ul><pre><code>@Datapublic class RequestErrorInfo {    private String ip;    private String url;    private String httpMethod;    private String classMethod;    private Object requestParams;    private RuntimeException exception;}</code></pre><ul><li>å¼‚å¸¸é€šçŸ¥ç¯ç»•ä½“</li></ul><pre><code>@AfterThrowing(pointcut = "requestServer()", throwing = "e")public void doAfterThrow(JoinPoint joinPoint, RuntimeException e) {    ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();    HttpServletRequest request = attributes.getRequest();    RequestErrorInfo requestErrorInfo = new RequestErrorInfo();    requestErrorInfo.setIp(request.getRemoteAddr());    requestErrorInfo.setUrl(request.getRequestURL().toString());    requestErrorInfo.setHttpMethod(request.getMethod());    requestErrorInfo.setClassMethod(String.format("%s.%s", joinPoint.getSignature().getDeclaringTypeName(),            joinPoint.getSignature().getName()));    requestErrorInfo.setRequestParams(getRequestParamsByJoinPoint(joinPoint));    requestErrorInfo.setException(e);    LOGGER.info("Error Request Info      : {}", JSON.toJSONString(requestErrorInfo));}</code></pre><p>å¯¹äºå¼‚å¸¸ï¼Œè€—æ—¶æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› æ­¤ä¸ç»Ÿè®¡è€—æ—¶ï¼Œè€Œæ˜¯æ·»åŠ äº†å¼‚å¸¸çš„æ‰“å°</p><p>æœ€åæ”¾ä¸€ä¸‹å®Œæ•´æ—¥å¿—è¯·æ±‚åˆ‡é¢ä»£ç ï¼š</p><pre><code>@Component@Aspectpublic class RequestLogAspect {    private final static Logger LOGGER = LoggerFactory.getLogger(RequestLogAspect.class);    @Pointcut("execution(* your_package.controller..*(..))")    public void requestServer() {    }    @Around("requestServer()")    public Object doAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {        long start = System.currentTimeMillis();        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();        HttpServletRequest request = attributes.getRequest();        Object result = proceedingJoinPoint.proceed();        RequestInfo requestInfo = new RequestInfo();                requestInfo.setIp(request.getRemoteAddr());        requestInfo.setUrl(request.getRequestURL().toString());        requestInfo.setHttpMethod(request.getMethod());        requestInfo.setClassMethod(String.format("%s.%s", proceedingJoinPoint.getSignature().getDeclaringTypeName(),                proceedingJoinPoint.getSignature().getName()));        requestInfo.setRequestParams(getRequestParamsByProceedingJoinPoint(proceedingJoinPoint));        requestInfo.setResult(result);        requestInfo.setTimeCost(System.currentTimeMillis() - start);        LOGGER.info("Request Info      : {}", JSON.toJSONString(requestInfo));        return result;    }    @AfterThrowing(pointcut = "requestServer()", throwing = "e")    public void doAfterThrow(JoinPoint joinPoint, RuntimeException e) {        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();        HttpServletRequest request = attributes.getRequest();        RequestErrorInfo requestErrorInfo = new RequestErrorInfo();        requestErrorInfo.setIp(request.getRemoteAddr());        requestErrorInfo.setUrl(request.getRequestURL().toString());        requestErrorInfo.setHttpMethod(request.getMethod());        requestErrorInfo.setClassMethod(String.format("%s.%s", joinPoint.getSignature().getDeclaringTypeName(),                joinPoint.getSignature().getName()));        requestErrorInfo.setRequestParams(getRequestParamsByJoinPoint(joinPoint));        requestErrorInfo.setException(e);        LOGGER.info("Error Request Info      : {}", JSON.toJSONString(requestErrorInfo));    }    /**     * è·å–å…¥å‚     * @param proceedingJoinPoint     *     * @return     * */    private Map&lt;String, Object&gt; getRequestParamsByProceedingJoinPoint(ProceedingJoinPoint proceedingJoinPoint) {        //å‚æ•°å        String[] paramNames = ((MethodSignature)proceedingJoinPoint.getSignature()).getParameterNames();        //å‚æ•°å€¼        Object[] paramValues = proceedingJoinPoint.getArgs();        return buildRequestParam(paramNames, paramValues);    }    private Map&lt;String, Object&gt; getRequestParamsByJoinPoint(JoinPoint joinPoint) {        //å‚æ•°å        String[] paramNames = ((MethodSignature)joinPoint.getSignature()).getParameterNames();        //å‚æ•°å€¼        Object[] paramValues = joinPoint.getArgs();        return buildRequestParam(paramNames, paramValues);    }    private Map&lt;String, Object&gt; buildRequestParam(String[] paramNames, Object[] paramValues) {        Map&lt;String, Object&gt; requestParams = new HashMap&lt;&gt;();        for (int i = 0; i &lt; paramNames.length; i++) {            Object value = paramValues[i];            //å¦‚æœæ˜¯æ–‡ä»¶å¯¹è±¡            if (value instanceof MultipartFile) {                MultipartFile file = (MultipartFile) value;                value = file.getOriginalFilename();  //è·å–æ–‡ä»¶å            }            requestParams.put(paramNames[i], value);        }        return requestParams;    }    @Data    public class RequestInfo {        private String ip;        private String url;        private String httpMethod;        private String classMethod;        private Object requestParams;        private Object result;        private Long timeCost;    }    @Data    public class RequestErrorInfo {        private String ip;        private String url;        private String httpMethod;        private String classMethod;        private Object requestParams;        private RuntimeException exception;    }}</code></pre><p>èµ¶ç´§ç»™ä½ ä»¬çš„åº”ç”¨åŠ ä¸Šå§ã€å¦‚æœæ²¡åŠ çš„è¯ã€‘ï¼Œæ²¡æœ‰æ—¥å¿—çš„è¯ï¼Œæ€»æ€€ç–‘ä¸Šå±‚å‡ºé”™ï¼Œä½†æ˜¯å´æ‹¿ä¸å‡ºè¯æ®</p><blockquote><p>ä½œè€…ï¼šä½•ç”œç”œåœ¨å—<br>åŸæ–‡é“¾æ¥ï¼šhttps://juejin.im/post/5e69d5b5e51d45183840b351</p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'å†™ä¸ª','æ—¥å¿—','è¯·æ±‚'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>