<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>STM32CubeMX + HAL库学习「附工程源码」 | 极客快訊</title><meta property="og:title" content="STM32CubeMX + HAL库学习「附工程源码」 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/e620008aa2cb428bb9e7bdf9c2bb9f0d"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0fba10f.html><meta property="article:published_time" content="2020-10-29T20:50:02+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:02+08:00"><meta name=Keywords content><meta name=description content="STM32CubeMX + HAL库学习「附工程源码」"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/0fba10f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>STM32CubeMX + HAL库学习「附工程源码」</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">STM32CubeMX + HAL</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">- 一些说明</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- 底层配置</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- Cube基本使用</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- HAL库函数</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- 中断回调函数</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- 外设对应时钟</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">- 配置示例</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- 小编有话说</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- RTC</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- SDIO + FATFS</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- SDRAM</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- LTDC + DMA2D</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- 待补充...</span></p><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">STM32CubeMX + HAL</span></strong></h1><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">一些说明</span></strong></h1><h1 class=pgc-h-arrow-right><span style="color:#34495e;--tt-darkmode-color: #809CB9">底层配置</span></h1><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">使用</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">STM32CubeMX</span></span>代码生成工具，不用关注底层配置的细节，真舒服。</p><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">使用教程：</span></p><pre><code>https://sxf1024.lanzoui.com/b09rf2dwj 密码:bgvi</code></pre><p style=text-align:start><em><span style="color:#34495e;--tt-darkmode-color: #809CB9">虽然</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Cube+HAL</span></span>很舒服，但新手不建议用。最好还是先去学一下标准库怎么用，有个大致概念后，再来学这一套。</em></p><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Cube基本使用</span></strong></h1><ol start=0><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">新建工程</span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">选择芯片</span></li><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，选择</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">RCC(HSE：Crystal/Ceramic Resonator)</span></span>、<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SYS(Debug：Serial Wiire)</span></span></li><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，配置时钟树</span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e620008aa2cb428bb9e7bdf9c2bb9f0d><p class=pgc-img-caption></p></div><ol start=5><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Project Manager</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，配置工程输出项</span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3b4d456040fb433bb89101bdeab99f7d><p class=pgc-img-caption></p></div><ol start=6><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，选择功能(若是选</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">GPIO</span></span>相关，可以直接在<strong>Pinout view</strong>选择；若是其他功能，可以在左边<strong>Categories</strong>打开，会自动配置引脚)、设置<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Parameter Settings/NVIC</span></span>等</li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cb8f0a363942488f9b379317018c253b><p class=pgc-img-caption></p></div><ol start=7><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">GENERATE CODE</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，生成工程，用KEIL打开编辑</span></li></ol><hr><h1 class=pgc-h-arrow-right><span style="color:#34495e;--tt-darkmode-color: #809CB9">HAL库函数</span></h1><ul><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">函数形式：均以</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL_</span></span>开头</li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">寻找过程：在驱动文件</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">stm32f4xx_hal_XXX.c</span></span>或其<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">.h</span></span>文件中找函数定义，一般在靠后位置</li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">其他说明：</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL</span></span>库并没有把所有的操作都封装成凼数。对于底层的<strong>寄存器操作</strong>(如读取捕获/比较寄存器)，还有修改外设的某个<strong>配置参数</strong>(如改变输入捕获的极性)，<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL</span></span>库会使用<strong>宏定义</strong>来实现。而且会用<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">__HAL_</span></span>作为这类宏定义的<strong>前缀</strong>。<strong>获取</strong>某个参数，宏定义中一般会有<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">_GET</span></span>；而<strong>设置</strong>某个参数的，宏定义中就会有<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">_SET</span></span>。在开发过程中，如果遇到<strong>寄存器</strong>级别或者<strong>更小范围</strong>的操作时，可以到该外设的<strong>头文件</strong>中查找，一般都能找到相应的宏定义。<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL</span></span>库函数<strong>第一个参数</strong>一般都是<strong>句柄</strong>(一个包含了当前对象绝大部分状态的结构体)，虽然增加了开销，但是用起来便捷了非常多。</li></ul><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">中断回调函数</span></strong></h1><ul><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">函数形式：</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL_XXX_XXXCallback()</span></span>。</li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">寻找过程：中断文件</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">stm32f4xx_it.c</span></span> - > 中断函数<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">XXX_IRQHandler(void)</span></span> -> HAL库中断函数<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL_XXX_IRQHandler(GPIO_PIN_13)</span></span> -> 回调函数<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL_XXX_XXXCallback()</span></span></li></ul><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">外设对应时钟</span></strong></h1><ol start=0><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">随便进入一个</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">外设初始化函数</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，如</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">MX_GPIO_Init()</span></span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">随便进入一个</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">时钟</span></strong><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">使能</span></strong><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">函数</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，如</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">__HAL_RCC_GPIOC_CLK_ENABLE()</span></span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">随便进入一个</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">RCC宏定义</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，如</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">RCC_AHB1ENR_GPIOCEN</span></span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">或者直接进入</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">stm32f429xx.h</span></span>文件</li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">里面有所有</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">外设与时钟</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">对应关系，如</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">RCC_AHB1ENR_DMA1EN</span></span></li></ol><p style=text-align:start><br></p><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">配置示例</span></strong></h1><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">小编有话说</span></strong></h1><ul><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">例子源码：https://sxf1024.lanzoui.com/b09rf535a 密码:bf5q</span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">如果配置过程中，参数不知道怎么设置，可以去标准库例程(如野火、正点原子)中看对应的参数是什么</span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">Cube软件只是帮你配置了底层，一些初始化代码还是需要自己手动加的，如SDRAM充电初始化、读写函数等</span></li></ul><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">RTC</span></strong></h1><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8c51381268564547a14271bfeb1fc985><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4e5792bac9524ea086b1c962b14a981f><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6f63b569bfce47539e8d1f5d49db8c22><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5066cd85e6d94c039e575f6bf6f5777f><p class=pgc-img-caption></p></div><pre><code> RTC_DateTypeDef sDate; RTC_TimeTypeDef sTime;   uint8_t second_tmp = 0;  HAL_RTC_GetTime(&amp;hrtc, &amp;sTime, RTC_FORMAT_BIN); // 读取时间 HAL_RTC_GetDate(&amp;hrtc, &amp;sDate, RTC_FORMAT_BIN); // 读取日期 if(second_tmp != sTime.Seconds) { // 读取秒     second_tmp = sTime.Seconds;     printf("20%d%d-%d%d-%d%d\r\n",             sDate.Year/10%10, sDate.Year%10,             sDate.Month/10%10, sDate.Month%10,             sDate.Date/10%10, sDate.Date%10);     printf("%d%d:%d%d:%d%d\r\n",             sTime.Hours/10%10, sTime.Hours%10,             sTime.Minutes/10%10, sTime.Minutes%10,             sTime.Seconds/10%10, sTime.Seconds%10); }</code></pre><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">SDIO + FATFS</span></strong></h1><ol start=0><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">选择SDIO功能，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Connectivity -> SDIO -> Mode: SD 4bit Wide bus -> 勾选NVIC</span></span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5a8674331b2a4dc7a21885eaf1e447c7><p class=pgc-img-caption></p></div><ol start=2><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">配置SDIO时钟，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，SDIO模块输入要求为</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">48MHz</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，系统提示可以自动设置时钟问题，选择</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Yes</span></span>。SDIO时钟分频系数<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">CLKDIV</span></span>，计算公式为<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDIO_CK=48MHz/(CLKDIV+2)</span></span>也可手动修改时钟配置。</li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cbdc16dbfb5f423686d919ca51f440cc><p class=pgc-img-caption></p></div><ol start=3><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">启用文件系统中间件</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Middleware -> FATFS</span></span>，模式选择SD卡，配置文件系统：如果要支持中文文件名，则配置<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">CODE_PAGE</span></span>为<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Simplified Chinese</span></span>如果要支持长文件名，则要使能<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">USE_LEN</span></span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/356246528f8c49af90e28433f3d6120c><p class=pgc-img-caption></p></div><ol start=4><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">继续上面界面，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Advanced Settings</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">勾选</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Use dma template</span></span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c67a989a4c2e4b67a84f225ca2647cdc><p class=pgc-img-caption></p></div><ol start=5><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">设置DMA传输，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Connectivity -> SDIO-> DMA Settings</span></span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d902def23f294bc48cbcc5a048ad7cab><p class=pgc-img-caption></p></div><ol start=6><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">配置NVIC，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">System Core -> NVIC</span></span>。</li></ol><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">注意，SDIO</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">中断</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">优先级</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">必须高于</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">DMA2 stream3和DMA2 stream6的</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">中断</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">优先级</span></p><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/f6592e62676d4926a8efa7baac8d3957><p class=pgc-img-caption></p></div><ol start=7><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">堆栈设置，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Progect Manager -> Project -> Linker Settings</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，加大堆栈大小（注意：由于刚才设置长文件名动态缓存存储在堆中，故需要增大堆大小，如果不修改则程序运行时</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">堆</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">会生成溢出，程序进入硬件错误中断(HardFault)，死循环）。</span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fa3828a8a3c94e319c56af3d945aaf4c><p class=pgc-img-caption></p></div><ol start=8><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">生成工程，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">GENERATE CODE</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9"> ，用KEIL打开</span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/17e994632de64271abade2ba84b4ad28><p class=pgc-img-caption></p></div><pre><code> UINT bw; retSD = f_mount(&amp;SDFatFS, SDPath, 0); if(retSD != FR_OK) {     printf("Mount Error :%d\r\n", retSD); } retSD = f_open(&amp;SDFile, "0:/test.txt", FA_CREATE_ALWAYS | FA_WRITE); if(retSD != FR_OK){     printf("Open Error :%d\r\n", retSD); } retSD = f_write(&amp;SDFile, "abcde", 5, &amp;bw); if(retSD != FR_OK){     printf("Write Error :%d\r\n", retSD); } f_close(&amp;SDFile); retSD = f_open(&amp;SDFile, "0:/test.txt", FA_READ); char buff[10] = {0}; retSD = f_read(&amp;SDFile, buff, 5, &amp;bw); if(retSD == FR_OK){     printf("%s\r\n", buff); } f_close(&amp;SDFile);</code></pre><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">SDRAM</span></strong></h1><ol start=0><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">开启FMC功能，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9"> ，</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Connectivity -> FMC -> SDRAM2</span></span><strong>SDRAM1</strong>的起始地址为<strong>0XC0000000</strong>，<strong>SDRAM2</strong>的起始地址为<strong>0XD0000000</strong>。一般SDRAM都含有<strong>4</strong>个bank。<strong>Configuration</strong>中的参数可从SDRAM的<strong>数据手册</strong>上找到。</li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4faecbd80de042f98b97b61267f8aa5a><p class=pgc-img-caption></p></div><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">各个选项的配置(只做解释，不对应上图)：</span></p><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Clock and chip enable</span></span>：<strong>FMC_SDCKE0</strong> 和<strong>FMC_SDCLK0</strong>对应的存储区域1 的地址范围是<strong>0xC000 0000-0xCFFF FFFF</strong>；而<strong>FMC_SDCKE1</strong> 和<strong>FMC_SDCLK1</strong> 对应的存储区域2 的地址范围是<strong>0xD000 0000- 0xDFFF FFFF</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Bank</span></span>由硬件连接决定需要选择<strong>SDRAM bank 2</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Column bit number</span></span>表示列数，<strong>8位</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Row bit number</span></span>表示行数，<strong>12位</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">CAS latency</span></span>表示CAS潜伏期，即上面说的CL，该配置需要与之后的SDRAM模式寄存器的配置相同，这里先配置为<strong>2 memory clock cycles</strong>(对于SDRAM时钟超过133MHz的，则需要配置为3 memory clock cycles)</li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Write protection</span></span> 表示写保护，一般配置为<strong>Disabled</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM common clock</span></span>为SDRAM 时钟配置，可选HCLK的2分频\3分频\不使能SDCLK时钟。前面主频配置为216MHz，SDRAM common clock设置为<strong>2分频</strong>，那SDCLK时钟为108MHz，每个时钟周期为9.25ns</li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM common burst read</span></span> 表示突发读，这里选择使能</li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM common read pipe delay</span></span> 表示CAS潜伏期后延迟多少个时钟在进行读数据，这里选择<strong>0 HCLK clock cycle</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Load mode register to active delay</span></span> 加载模式寄存器命令和激活或刷新命令之间的延迟，按存储器时钟周期计</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/311f286bfb0b4ef5b59faa67802953e5><p class=pgc-img-caption></p></div><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Exit self-refresh delay</span></span>从发出自刷新命令到发出激活命令之间的延迟，按存储器时钟周期数计查数据手册知道其最小值为70ns，由于我们每个时钟周期为9.25ns，所以设为<strong>8</strong> (70÷9.25，向上取整)</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c62ed21dc6e64f9cb0098b8d2f849d29><p class=pgc-img-caption></p></div><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM common row cycle delay</span></span>刷新命令和激活命令之间的延迟，以及两个相邻刷新命令之间的延迟， 以存储器时钟周期数表示查数据手册知道其最小值为63ns，由于我们每个时钟周期为9.25ns，所以设为<strong>7</strong> (63÷9.25，向上取整)</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/94cf33a34b3c44caae104b664814af37><p class=pgc-img-caption></p></div><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Write recovery time</span></span>写命令和预充电命令之间的延迟，按存储器时钟周期数计</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/31ee9a90a7f04a3d9418b3607429e9ed><p class=pgc-img-caption></p></div><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM common row precharge delay</span></span>预充电命令与其它命令之间的延迟，按存储器时钟周期数计查数据手册知道其最小值为15ns，由于我们每个时钟周期为9.25ns，所以设为<strong>2</strong> (15÷9.25，向上取整)</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b60e4fa85ad742bfb16ac0a53b34978f><p class=pgc-img-caption></p></div><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Row to column delay</span></span>激活命令与读/写命令之间的延迟，按存储器时钟周期数计查数据手册知道其最小值为15ns，由于我们每个时钟周期为9.25ns，所以这里本应该设为<strong>2</strong> (15÷9.25，向上取整)但要注意，时序必须满足以下式子：TWR ≥ TRAS - TRCDTWR ≥ TRC - TRCD - TRP其中：TWR = <strong>Write recovery</strong> <strong>time</strong> = 2TRAS = <strong>Self refresh time</strong> = 5TRC = <strong>SDRAM common row cycle delay</strong> = 7TRP = <strong>SDRAM common row precharge delay</strong> = 2TRCD = <strong>Row to column delay</strong>所以这里<strong>Row to column delay</strong>应该取3</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a67f890d1d064719b78baadbc8f6019a><p class=pgc-img-caption></p></div><ol start=2><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">生成代码，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">GENERATE CODE</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">， 用KEIL打开</span></li></ol><pre><code> uint8_t temp[100]__attribute__((at(0xD0000000)));    for(int i=0;i&lt;100;i++){     temp[i] = i; } for(int i=0;i&lt;100;i++){     printf("%d  ", temp[i]); }</code></pre><ol start=3><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">到这里只是借助Cube完成了引脚配置，还需要SDRAM初始化操作和读写函数，可从官方例程里获取，路径：C:\Users\10617\STM32Cube\Repository\STM32Cube_FW_F4_V1.25.0\Drivers\BSP\STM32F429I-Discovery\XXX</span></li></ol><pre><code> /*****************************SDRAM使能函数******************************/  /**   * @brief  对SDRAM芯片进行初始化配置   * @param  None.    * @retval None.   */ static void USER_SDRAM_ENABLE(void) {     FMC_SDRAM_CommandTypeDef Command;        __IO uint32_t tmpmrd =0;      /* Step 1:  Configure a clock configuration enable command */   Command.CommandMode             = FMC_SDRAM_CMD_CLK_ENABLE;   Command.CommandTarget           = FMC_SDRAM_CMD_TARGET_BANK2;   Command.AutoRefreshNumber       = 1;   Command.ModeRegisterDefinition  = 0;    /* Send the command */   HAL_SDRAM_SendCommand(&amp;hsdram1, &amp;Command, SDRAM_TIMEOUT);    /* Step 2: Insert 100 us minimum delay */    /* Inserted delay is equal to 1 ms due to systick time base unit (ms) */   HAL_Delay(1);    /* Step 3: Configure a PALL (precharge all) command */    Command.CommandMode             = FMC_SDRAM_CMD_PALL;   Command.CommandTarget           = FMC_SDRAM_CMD_TARGET_BANK2;   Command.AutoRefreshNumber       = 1;   Command.ModeRegisterDefinition  = 0;    /* Send the command */   HAL_SDRAM_SendCommand(&amp;hsdram1, &amp;Command, SDRAM_TIMEOUT);        /* Step 4: Configure an Auto Refresh command */    Command.CommandMode             = FMC_SDRAM_CMD_AUTOREFRESH_MODE;   Command.CommandTarget           = FMC_SDRAM_CMD_TARGET_BANK2;   Command.AutoRefreshNumber       = 4;   Command.ModeRegisterDefinition  = 0;    /* Send the command */   HAL_SDRAM_SendCommand(&amp;hsdram1, &amp;Command, SDRAM_TIMEOUT);      /* Step 5: Program the external memory mode register */   tmpmrd = (uint32_t)SDRAM_MODEREG_BURST_LENGTH_2          |                      SDRAM_MODEREG_BURST_TYPE_SEQUENTIAL   |                      SDRAM_MODEREG_CAS_LATENCY_3           |                      SDRAM_MODEREG_OPERATING_MODE_STANDARD |                      SDRAM_MODEREG_WRITEBURST_MODE_SINGLE;      Command.CommandMode             = FMC_SDRAM_CMD_LOAD_MODE;   Command.CommandTarget           = FMC_SDRAM_CMD_TARGET_BANK2;   Command.AutoRefreshNumber       = 1;   Command.ModeRegisterDefinition  = tmpmrd;    /* Send the command */   HAL_SDRAM_SendCommand(&amp;hsdram1, &amp;Command, SDRAM_TIMEOUT);      /* Step 6: Set the refresh rate counter */   /* Set the device refresh rate */   HAL_SDRAM_ProgramRefreshRate(&amp;hsdram1, REFRESH_COUNT);  } /*****************************使能函数结束******************************/</code></pre><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">或者以我的野火</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">STM32F429IGT6</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">的版本SDRAM为</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">8M</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，源码链接：</span></p><pre><code>https://sxf1024.lanzoui.com/b09rf535a 密码:bf5q</code></pre><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">添加到工程</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Core</span></span>路径下，然后在KEIL中初始化操作：</p><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">(注意这个</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM_InitSequence();</span></span><strong>不能</strong>加在<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL_SDRAM_MspInit()</span></span>后面!!! 因为它这里还没FMC初始化完成!!!! 加在这里是<strong>没有用的</strong>！！！)</p><pre><code> #include "bsp_sdram.h" MX_FMC_Init(); SDRAM_InitSequence();  SDRAM_Test();</code></pre><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">LTDC + DMA2D</span></strong></h1><p style=text-align:start><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">务必在上面SDRAM配置成功后，再来搞这个！！！</span></strong></p><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">详细教程看这个：</span></p><pre><code>https://zzttzz.gitee.io/blog/posts/7109b92c</code></pre><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">但他给的源码还</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">有点问题</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，运行处理没效果。</span></p><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">我提供的源码链接：</span></p><pre><code>https://sxf1024.lanzoui.com/b09rf535a 密码:bf5q</code></pre><p style=text-align:start><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">注意：</span></strong></p><ul><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">我跟他的配置有点不一样，我的是：Pixel Clock Plparity：Normal InputDMA2D要开一下中断，等级可以不用很高。如果不开的话，有可能会传图时候卡住。LCD-TFT时钟：25MHz</span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">层 1 = layer 0，层 2 = layer 1</span></li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/4cd9cb716d6a41cdb194e0547976b32c><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/222e401254c74aa696c8ec3595dfe16a><p class=pgc-img-caption></p></div><p style=text-align:start><br></p><h1 class=pgc-h-arrow-right><span style="color:#34495e;--tt-darkmode-color: #809CB9">更多待补充...</span></h1><div class=pgc-img><img alt="STM32CubeMX + HAL库学习「附工程源码」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2b54e7a6e55b4b428089851e6c6cda9e><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'STM32CubeMX','HAL','库学习'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>