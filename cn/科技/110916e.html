<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>PostgreSQL之系统对象介绍 | 极客快訊</title><meta property="og:title" content="PostgreSQL之系统对象介绍 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/414da47fee1940c5b8ce7ca1749f15e6"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/110916e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/110916e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/110916e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/110916e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/110916e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/110916e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/110916e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/110916e.html><meta property="article:published_time" content="2020-10-29T20:58:34+08:00"><meta property="article:modified_time" content="2020-10-29T20:58:34+08:00"><meta name=Keywords content><meta name=description content="PostgreSQL之系统对象介绍"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/110916e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>PostgreSQL之系统对象介绍</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><div class=pgc-img><img alt=PostgreSQL之系统对象介绍 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/414da47fee1940c5b8ce7ca1749f15e6><p class=pgc-img-caption></p></div><p><strong>王硕</strong></p><p><strong>中国PG分会认证专家</strong></p><p><strong>PostgreSQL资深内核研发工程师，他为完整数据库加密，Oracle兼容功能，PostgreSQL监控工具，PostgreSQL即时编译等做了很多工作。</strong></p><p><strong>1前言</strong></p><p>最近和很多人（阿里的，腾讯的......）聊PostgreSQL，发现大家对于PG最大的认同点是他的词法分析和语法分析做的非常好，认为是替代Oracle的最佳方案。本人最开始接触PostgreSQL开发，便是做的兼容。经过多年的学习，比较认同新手接触PostgreSQL可以先通过系统函数、语法等方式入手。讨论了许多，正好将自己对于这方面的了解整理一下，也算对自己当年有个交代。产品的兼容代码由于是商业秘密，在这里无法公开，这里会以PG已有内容或开源代码进行介绍实现方式。</p><p>按照惯例，先上一张思维导图，以下是本文所讲述内容的概述：</p><div class=pgc-img><img alt=PostgreSQL之系统对象介绍 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/625f165a46394e1fb788bddaf741ebf2><p class=pgc-img-caption></p></div><p>本文首先对兼容做一下阐述，然后对PostgreSQL的系统对象进行介绍，在这里将系统对象拆分为对象、语法以及共享组件。</p><p><strong>2为什么要做兼容</strong></p><p>PostgreSQL本身就有很完善的SQL体系，为什么要做兼容？尤其是为什么要做Oracle的兼容？最主要的原因我认为是Oracle经过多年的市场耕耘，造就了一大批基于Oracle的开发人员。目前市场上很多应用都是基于Oracle开发的。这就对数据库迁移产生了非常大的阻碍。国内这几年一直在喊去IOE，但是效果了了。从亚马逊完成Oracle迁移后，进行庆功就很能说明其难度之大。迁移的不仅仅是数据库，而是整个数据库生态。从应用端开发，到数据库管理，都需要做出改变。同时，在这里不得不说一下Oracle确确实实在数据库生态方面做了非常多的工作，其他数据库难以望其项背。为什么要做兼容？尤其是Oracle兼容？因为目前PostgreSQL在国内的推广程度较小，酒香其实也怕巷子深。可以通过兼容Oracle扩大市场，推广PG。其次，Oracle成功有他的道理，他的生态是非常的完善，学习也是值得去做的。如果完成了Oracle兼容，那么我们可以做到：</p><ol start=1><li>更快、更好地应用迁移；</li><li>完成部分机构的数据库要求；</li><li>减少新语法的学习成本；</li><li>完成数据库生态。</li></ol><p><strong>3兼容级别</strong></p><p>那么如果我们要做兼容，那么应该怎么做？兼容也不一定是一味的完全一模一样，重复造轮子是没有价值的。我将兼容级别划分为三类：</p><ol start=1><li>完全相同，使用方法和功能完全一致，最终达到用户不需要改动任何应用程序，即可使用；</li><li>部分相同，使用方法一致，但实现的功能有部分不同，可以针对用户需求完成功能，减少时间消耗；</li><li>完全不同，实际解决的问题相同，但使用方法不相同，Oracle有很多功能是基于其整体架构的，所以如果想这部分内容，成本非常大，但不如找到根本问题，通过其他方法解决。</li></ol><p>这三种级别也不是完全独立的，我们可以有选择性地对兼容内容进行不同级别的兼容开发。比如系统函数我们就可以做的一模一样，而部分类型可以选择部分兼容。</p><p><strong>4兼容开发方式</strong></p><p>我们有以下2种方式开发兼容功能：一是完全开发，组织团队，根据需求或者Oracle官方文档（这里吐槽一下，实际使用可能存在比文档展示的方法更多）一一对比，完全实现。二是部分开发，基于开源组件二次开发（比如Orafce），或者购买EDB动态库或者兼容代码（资金雄厚的尽可能选择此类）。</p><p><strong>5系统对象</strong></p><p><strong>对象</strong></p><p>系统对象主要为下图内容，这些内容基本上已经在orafce中包含了：</p><div class=pgc-img><img alt=PostgreSQL之系统对象介绍 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bde8cc1b50e2400caf63582597307322><p class=pgc-img-caption></p></div><p><strong>系统表</strong></p><p>需要增加table.h和table.dat。</p><ul class=list-paddingleft-2><li>头文件是表定义以及宏定义，可参看src/include/catalog/pg_class.h。</li><li>dat文件为表内容，这部分可以使用dat初始化赋值或者SQL语句赋值，可参看src/include/catalog/pg_class.dat。</li></ul><p><strong>系统视图</strong></p><p>可参看src/backend/catalog/system_views.sql：</p><p><strong>内部函数</strong></p><p>内部C语言函数实现：以gram_checker为例，此函数可以对参数进行SQL解析，每次执行1条SQL，成功则返回空，出现错误则提示详细错误信息。src/backend/utils/adt/gram_checker.c：</p><p>src/include/catalog/pg_proc.dat：</p><p>内部SQL函数实现：</p><p>SQL函数实现（可参考：postgresql.org/docs/cur）：</p><p>其他语言函数实现：plpgsql（可参考：postgresql.org/docs/cur）：</p><p>plv8（可参考：pgxn.org/dist/plv8/doc/）：</p><p><strong>操作符</strong></p><p>C语言实现：src/include/catalog/pg_operator.dat：</p><p>SQL实现（可参考：postgresql.org/docs/12/）：</p><p><strong>类型</strong></p><p>C语言定义 src/include/catalog/pg_type.dat：</p><p>SQL定义（可参考 postgresql.org/docs/12/）：</p><p>Domain实现（可参考 postgresql.org/docs/cur）：</p><p>语法映射 src/backend/parser/gram.y：</p><p>内部逻辑修改：将numeric变为int4或int8：</p><p><strong>隐式转换</strong></p><p>C语言实现 src/include/catalog/pg_cast.dat：</p><p>SQL定义（参考 postgresql.org/docs/cur）：</p><p><strong>package</strong></p><p>参考：github.com/orafce/orafc：</p><p><strong>6共享组件</strong></p><p>共享组件提供一系列的工具共数据库管理使用，旨在提高数据库管理便宜性。比如AWR（Automatic Workload Repository），能够提供更多的数据库监控信息，供DBA使用，快速定位、解决数据库问题。迁移工具：完成数据结构、数据迁移以及存储过程、函数转换。此类内容对于数据库迁移或者应用开发影响甚小，其作用主要在于便于数据库迁移、管理。内容非常多，这里就不一一列举了。</p><p><strong>7语法</strong></p><div class=pgc-img><img alt=PostgreSQL之系统对象介绍 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/20a64cf00c93402cba239207c76af7b3><p class=pgc-img-caption></p></div><p>语法，也就是我们常说的SQL，主要涉及到的内容是编译原理。PostgreSQL使用Flex和Bison两个工具完成的语法实现。Flex和Bison是Linux下两个用来生成程序的工具，可以处理结构化输入，它们生成的程序分别叫做词法分析器和语法分析器，他们一般结合使用来处理复杂的文件解析工作，在PostgreSQL中主要是用来生成SQL语句的词法和语法分析器。</p><p>Flex & Bison</p><p>Flex（快速词法分析器生成器）是lex的免费开源软件替代品。它是生成词法分析器（也称为“扫描器”或“词法分析器”）的计算机程序。它可以利用正则表达式来生成匹配相应字符串的C语言代码，其语法格式基本同Lex相同。经常连同Yacc或GNU Bison一起使用。Postgresql 中的Flex 文件为scan.l，通过Flex编译为scan.c。</p><p>Bison是一种通用解析器生成器，它将带注释的上下文无关文法转换为使用LALR（1）解析器表的确定性LR或广义LR（GLR）解析器 。作为一项实验性功能，Bison还可以生成IELR（1）或规范的LR（1）解析器表。一旦您精通Bison，就可以使用它来开发各种语言解析器，从用于简单台式计算器的语言解析器到复杂的编程语言。Bison与Yacc向上兼容：所有正确编写的Yacc语法都应与Bison一起使用，而无需进行任何更改。熟悉Yacc的任何人都应该可以轻松使用Bison。您需要精通C或C ++编程才能使用Bison。还支持将Java作为实验功能。Postgresql 中的Bison 文件为gram.y，通过Bison编译生成gram.h，gram.c。</p><p>Flex</p><p>Flex由三部分组成</p><ul class=list-paddingleft-2><li>定义部分</li><li>%%</li><li>规则部分</li><li>%%</li><li>用户附加的C语言部分</li></ul><p>请参看：https://zhuanlan.zhihu.com/p/89473441（王硕知乎专栏：Flex介绍）</p><p>Bison</p><p>Bison由三部分组成</p><ul class=list-paddingleft-2><li>定义部分</li><li>%%</li><li>规则部分</li><li>%%</li><li>用户附加的C语言部分</li></ul><p>请参看：https://zhuanlan.zhihu.com/p/89479111（王硕知乎专栏：Bison介绍）</p><p>PostgreSQL中语法工作各个文件之间的调用关系：</p><div class=pgc-img><img alt=PostgreSQL之系统对象介绍 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cf87467ad5db4cee925f3261a64da5eb><p class=pgc-img-caption></p></div><ul class=list-paddingleft-2><li>scan.l：词法分析器在文件，定义词法结构，编译生成scan.c</li><li>gram.y：语法分析器在文件，定义语法结构，编译生成gram.c和gram.h；</li><li>parser.c：raw_parser函数，主要通过调用生成的base_yyparse函数来实现词法分析和语法分析的工作。</li><li>kwlist.h：SQL关键字定义，注意：关键字名要小写，按照字符串值顺序定义</li><li>kwlookup.h：定义结构体ScanKeyword；</li><li>kwlookup.c：使用kwlist.h初始化关键字数组ScanKeywords，提供ScanKeywordLookup函数</li><li>scanup.c：提供几个词法分析时常用的函数。</li></ul><p>下面以SQL，select oid,relname from pg_class where relname='pg_class';为例，说明一下语法解析过程：首先看一下SQL，</p><p>我们将SQL转化为语法分析树：</p><div class=pgc-img><img alt=PostgreSQL之系统对象介绍 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/74cf1589c41e470597831e8d8509eff8><p class=pgc-img-caption></p></div><ol start=1><li>scanner发现起始位置为‘select’，并确认为关键字SELECT，返回token值与数值；</li><li>parser接收到scanner的返回值，将‘select’移进，发现属于stmtblock->stmtmulti->stmt->SelectStmt->select_no_parens->simple_select；</li><li>scanner发现oid,relname</li><ol start=1><li>符合移进条件opt_target_list；</li><li>符合移进条件target_list；</li><li>其中oid在simple_select符合移进条件target_list->target_el->a_expr->c_expr->columnref->Colld->IDENT，即移进，这时发现符合归约条件target_el，即归约，返回target_el=oid；</li><li>其中relname在simple_select符合移进条件target_list->target_el->a_expr->c_expr->columnref->Colld->IDENT，即移进，这时发现符合归约条件target_el，即归约，返回target_el=relname；</li><li>target_el=oid，target_el=relname归约符合target_list，即归约；</li><li>target_list符合归约条件opt_target_list，也进行归约。</li></ol><li>scanner发现from，移进from未符合归约条件，继续移进pg_class，符合from_list->table_ref->relation_expr->qualified_name->ColId->IDENT，符合归约条件，则返回from_list；</li><li>scanner发现where</li><ol start=1><li>符合移进条件where_clause，移进where未符合归约条件，继续移进，发现符合移进条件a_expr；</li><li>发现符合移进条件a_expr '=' a_expr；</li><li>继续移进relname，符合a_expr->c_expr->columnref->Colld->IDENT，符合归约条件，则返回a_expr；</li><li>继续移进‘pg_class’，符合a_expr->c_expr->AexprConst->Sconst->SCONST，符合归约条件，则返回a_expr；</li><li>符合归约条件，返回where_clause；</li></ol><li>发现符合归约条件，返回simple_select；</li><li>发现符合归约条件，返回select_no_parens，SelectStmt，stmt，stmtmulti，stmtblock。</li></ol><p><strong>8语法能做什么</strong></p><p><strong>语法增删改</strong></p><p>我们可以在原有的语法体系上增删改语法，增加兼容语法。甚至可以增加多个语法解析器来对不同的数据库进行兼容。</p><p><strong>语法模块化</strong></p><p>可以考虑将SQL解析器从PostgreSQL代码中单独摘出来作为工具或者库文件，这样可以使用其进行迁移语法检测、异构数据库语法转化、SQL转发。甚至可以基于此进行完成异构数据库语法兼容。</p><p>Grammar_checker</p><p>最近完成了一个语法检测工具，Grammar_checker：</p><p>JIT</p><p>利用LLVM对SQL查询计划进行优化。随着现在存储技术的发展，尤其是内存、ssd硬件的发展，以及存储结构，如列存，如分布式，I/O瓶颈逐渐的在降低，而带来的影响就是cpu的瓶颈来了。很多人可能会问cpu有什么瓶颈？现代数据库为了完成更多的用户操作，有很多的冗余操作。比如我们即便向数据库输入一个常量，数据库还是首先以字符串的形式拿过来，进行处理，经过很多步骤后，确认是常量，然后放入相应位置。这中间就出现了很多人工就能减少的步骤，而数据库或者计算机是不得而知的。Llvm是一款编译器后端。他能将程序语言转化为自己的中间语言，然后进行优化。它主要的作用就是减少cpu的指令数量，以及提高cpu cache利用率。如何理解llvm，如果大家了解java的话，可能就对JIT不陌生了。我们的Java之所以能够一次编程，处处运行，就是因为我们的JDK就是一个解释器。所有的java程序，都经过编译，编译为class文件。这个可以理解为java语言与机器语言的中间语言。而jdk可以将这中间语言重新解释，并优化为机器码，从而进行执行。pg现有的JIT技术也是相同的方式进行的。不同点在于，这里使用的是llvm作为中间语言的编译和解释、优化再执行。</p><p>大体步骤如图所示：</p><div class=pgc-img><img alt=PostgreSQL之系统对象介绍 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bcd45c48600d477fa57f26a07d0a63ae><p class=pgc-img-caption></p></div><p>其优化原理以及位置如下：</p><div class=pgc-img><img alt=PostgreSQL之系统对象介绍 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/69324f876a654c51a072ebfc4d66d303><p class=pgc-img-caption></p></div><p>它是通过LLVM将查询计划转化为LLVM中间语言，然后对中间语言进行优化，减少冗余的指令集并提高cpu Cache的利用率。</p><p><strong>9写在最后</strong></p><p>以上就是我最初工作的知识总结，希望对初学PostgreSQL的人有所帮助。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'PostgreSQL','之系统','对象'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>