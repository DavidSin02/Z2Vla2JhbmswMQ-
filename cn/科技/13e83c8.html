<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>错误码如何设计才合理？ | 极客快訊</title><meta property="og:title" content="错误码如何设计才合理？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/43a4af2caa5240a6947c05613d3d3b9d"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/13e83c8.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/13e83c8.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/13e83c8.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/13e83c8.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/13e83c8.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/13e83c8.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/13e83c8.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/13e83c8.html><meta property="article:published_time" content="2020-10-29T21:04:54+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:54+08:00"><meta name=Keywords content><meta name=description content="错误码如何设计才合理？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/13e83c8.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>错误码如何设计才合理？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div class=pgc-img><img alt=错误码如何设计才合理？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/43a4af2caa5240a6947c05613d3d3b9d><p class=pgc-img-caption></p></div><h1 class=pgc-h-decimal data-index=01>一 前言</h1><p>在工作中，接触过不少外部接口，其中包括：支付宝，微信支付，微博开发平台，阿里云等等。每家公司错误码风格都不尽相同，有使用纯数字的，有使用纯英文的，也有使用字母和数字组合的。也接触过很多内部系统，错误码设计也不尽相同。</p><h1 class=pgc-h-decimal data-index=02>错误码的输出路径</h1><p><strong>面向日志输出</strong></p><ul><li>服务内传递，最终是输出到日志。</li><li>域内服务间，比如同时大麦电商之间的系统，最终目的是输出到日志。</li></ul><p><strong>面向外部传递</strong></p><ul><li>域内向域外</li><li>服务端传递到前端</li><li>OpenAPI 错误码</li><li>内部不同域之间</li></ul><h1 class=pgc-h-decimal data-index=03>错误码使用场景</h1><ul><li>通过错误码配置监控大盘。</li><li>通过日志进行问题排查，快速定位问题。</li><li>后端服务之间错误码传递。</li><li>前端展示的错误提示/OpenAPI。</li></ul><p>本文希望从错误码使用的不同场景讨论得到一个合理的错误码规约，得到一个面向日志错误码标准和一个面向外部传递的错误码标准。</p><p>PS：本文引用全部引自阿里巴巴《Java 开发手册》，下称《手册》。</p><h1 class=pgc-h-decimal data-index=04>二 什么是错误码</h1><p>错误码要回答的最根本的问题是，谁的错？错在哪？</p><p>那么一个错误能表示出谁的错和错在哪里就是一个好的错误码吗？答案显然是否定的，这个标准太基础了。</p><ul><li>好的错误码必须能够快速知晓错误来源。</li><li>好的错误码必须易于记忆和对比。</li><li>好的错误码必须能够脱离文档和系统平台达到线下轻量沟通的目的（这个要求比较高）。</li></ul><p>引自《手册》- 异常日志-错误码</p><blockquote><p>错误码的制定原则：快速溯源、简单易记、沟通标准化。</p></blockquote><p>说明：错误码想得过于完美和复杂，就像康熙字典中的生僻字一样，用词似乎精准，但是字典不容易随身携带并且简单易懂。正例：错误码回答的问题是谁的错？错在哪？1）错误码必须能够快速知晓错误来源，可快速判断是谁的问题。2）错误码易于记忆和比对（代码中容易 equals）。3）错误码能够脱离文档和系统平台达到线下轻量化地自由沟通的目的。</p><p>这个原则写在异常日志-错误码这个章节，我认为同样适用在面向用户的错误码。</p><div class=pgc-img><img alt=错误码如何设计才合理？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a157e59e08b240b9913b8f09d55b83ee><p class=pgc-img-caption></p></div><h1 class=pgc-h-decimal data-index=05>三 错误码规范</h1><h1 class=pgc-h-decimal data-index=06>错误码定义要有字母也要有数字</h1><p><strong>纯数字错误码</strong></p><blockquote><p>错误码即人性，感性认知+口口相传，使用纯数字来进行错误码编排不利于感性记忆和分类。</p></blockquote><p>说明：数字是一个整体，每位数字的地位和含义是相同的。反例：一个五位数字 12345，第1位是错误等级，第 2 位是错误来源，345 是编号，人的大脑不会主动地分辨每位数字的不同含义。</p><p>《手册》说明了纯数字错误码存在的问题。</p><p><strong>纯字母错误码</strong></p><p>那么纯字母错误码不香吗？有两个问题：</p><ul><li>对于使用汉语的我们用英语去准确描述一个错误有时是比较困难的。</li><li>纯英文字母的错误码不利于排序。</li></ul><p>错误码尽量有利于不同文化背景的开发者进行交流与代码协作。</p><blockquote><p>说明：英文单词形式的错误码不利于非英语母语国家（如阿拉伯语、希伯来语、俄罗斯语等）之间的开发者互相协作。</p></blockquote><h1 class=pgc-h-decimal data-index=07>快速溯源 | 简单易记 | 沟通标准化</h1><p>什么是快速溯源？就是一眼看上去就知道哪里出了什么问题。</p><p>李雷负责 A 服务，韩梅梅负责 B 服务。韩梅梅发现服务 B 出现了一个错误码，韩梅梅能够快速定位这是服务 A 的内部业务异常造成的问题，这个时候韩梅梅就可以拿着错误码找到李雷说，"hi，Li Lei，How old are you。(李雷，怎么老是你)"。李雷拿过来错误码一看，内心万马奔腾，一下就能知道这是上游 Polly 负责的应用阿尔法出了错。</p><p>怎么能达到这个效果呢？</p><ul><li>首先要有一套标准并且在域内各个业务都在用同样的标准。</li><li>其次要求错误码有自我解释的能力是有信息含量的有意义。</li><li>最后在域内要传递错误码。</li></ul><h1 class=pgc-h-decimal data-index=08>错误码标准的意义</h1><p>开宗明义借用了《手册》对于错误码定义的原则作为错误码规范能够给我们带来的收益。我想再次强调并且试着从反面阐述没有错误码标准会带来的成本。</p><p>错误码是用来做沟通的：系统与系统间的沟通，人与人间的沟通，人与系统间的沟通。</p><p>试想下面这个场景：</p><p>韩梅梅看到一个异常日志其中一个纯数字的错误码。</p><p>韩梅梅需要理解这串数字代表的是什么，它到底是不是一个错误码，经过几秒钟确定下来这是一个错误码，但她不能确定这是不是本系统中错误码，因为在她负责的系统是由韩梅梅、Lucy 和 Lily 三个人共同维护的，每个人都按照自己的理解定义了一套错误码。</p><p>韩梅梅去系统源码中查找这个错误码，但是发现这个错误码并不是本系统的错误码。</p><p>然后再前翻两页后翻两页从日志上下文中确定这是李雷负责系统的错误码，“Li Lie，how old are you？”。</p><p>韩梅梅把错误码甩到李雷脸上，李雷一脸懵逼，这是我的系统的错误码吗？</p><p>李雷也不确定，因为李雷负责的系统是由李雷、林涛和 Jim 维护的，也是三人共同维护的。</p><p>李雷只好打开源码，还真是！</p><p>上边的场景经过了发现-初判断-判断来源-确定来源-沟通-二次判断-二次确认七个步骤。</p><p>希望上边的场景描述能够说明没有统一标准的错误所带来的成本。</p><h1 class=pgc-h-decimal data-index=09>四 面向日志的错误码</h1><p>输出到日志的错误码有两个用途：</p><ul><li>用来快速溯源找到问题。</li><li>用来形成监控大盘。</li></ul><h1 class=pgc-h-decimal data-index=10>错误码设计</h1><p>《手册》对于错误码的建议有非常多的可取参考的地方：</p><blockquote><p>错误码不体现版本号和错误等级信息。</p></blockquote><p>说明：错误码以不断追加的方式进行兼容。错误等级由日志和错误码本身的释义来决定。</p><blockquote><p>错误码为字符串类型，共 5 位，分成两个部分：错误产生来源+四位数字编号。</p></blockquote><blockquote><p>错误码不能直接输出给用户作为提示信息使用。</p></blockquote><p>说明：堆栈（stack_trace）、错误信息(error_message)、错误码（error_code）、提示信息（user_tip）是一个有效关联并互相转义的和谐整体，但是请勿互相越俎代庖。</p><blockquote><p>在获取第三方服务错误码时，向上抛出允许本系统转义，由 C 转为 B，并且在错误信息上带上原有的第三方错误码。</p><p>结合错误码设计原则、错误码用途、规约建议，面向服务端日志的错误码应该是如下形式。</p><p>错误码分为一级宏观错误码、二级宏观错误码、三级宏观错误码。</p></blockquote><p>错误码即人性，感性认知+口口相传，使用纯数字来进行错误码编排不利于感性记忆和分类。说明：数字是一个整体，每位数字的地位和含义是相同的。</p><p>反例：一个五位数字 12345，第 1 位是错误等级，第 2 位是错误来源，345 是编号，人的大脑不会主动地分辨每位数字的不同含义。</p><p>按照《手册》的建议设计出的面向日志的错误码定义共十三位（十位有意义，三位连接符），并且应该具有如下分类：</p><ul><li>应用标识，表示错误属于哪个应用，三位数字。</li><li>功能域标识，表示错误属于应用中的哪个功能模块，三位数字。</li><li>错误类型，表示错误属于那种类型，一位字母。</li><li>错误编码，错误类型下的具体错误，三位数字。</li></ul><div class=pgc-img><img alt=错误码如何设计才合理？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/40a7c144fcf4452cba99875d1d03ef3e><p class=pgc-img-caption></p></div><p>《手册》还有一条是规定错误码应该如何定义：</p><blockquote><p>错误码为字符串类型，共 5 位，分成两个部分：错误产生来源+四位数字编号。</p></blockquote><p>说明：错误产生来源分为 A/B/C，A 表示错误来源于用户，比如参数错误，用户安装版本过低，用户支付超时等问题；B 表示错误来源于当前系统，往往是业务逻辑出错，或程序健壮性差等问题；C 表示错误来源于第三方服务，比如 CDN 服务出错，消息投递超时等问题；四位数字编号从 0001 到 9999，大类之间的步长间距预留 100。</p><p>五位错误码的好处是易记，但是对于面向日志的错误码场景利用错误码制作需要分类的业务监控大盘将变得比较困难，比如统计应用 A 的功能 B 的错误出现次数。</p><p>同样在系统间传递这个类型的错误码非常有可能发生错误码冲突。</p><p>当然对于分为四段的错误码同样尤其不好的一面，应用标识和功能域标识需要有专人去管理或者开发一个错误码管理工具，否则时间一长很容易产生定义的混乱形成破窗。</p><p>《手册》对于错误码定义我认为非常适合面向外部传递的错误码。简单、易记、是大家熟悉的错误码样式，并且透出的错误码数量是非常有限的。</p><h1 class=pgc-h-decimal data-index=11>不用枚举定义错误码</h1><p>国际化支持是一个不使用枚举定义错误码很重要的理由。</p><p>我们通过 i18n 的支持可以做到错误码、错误状态、错误描述的管理。</p><h1 class=pgc-h-decimal data-index=12>五 面向外部传递的错误码</h1><p>面向外部传递的错误码是为了把域内的错误信息传递出去。</p><p>可以让域外系统通过错误码进行错误码进行后续的动作或是中断操作或是记录日志继续执行。</p><p>可以让前端通过错误码给出用户准确的错误提示或者忽略错误进行重试。</p><h1 class=pgc-h-decimal data-index=13>错误码设计</h1><p>根据《手册》给出的错误码定义建议设计出的面向外部传递的错误码共五位，并且有如下分类：</p><ul><li>错误类型，表示错误来源，一位字母。</li><li>错误编码，表示具体错误，四位数字。</li></ul><div class=pgc-img><img alt=错误码如何设计才合理？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7c7f878181b2416d8ab8c1d347d93220><p class=pgc-img-caption></p></div><blockquote><p>错误码的后三位编号与 HTTP 状态码没有任何关系。</p></blockquote><blockquote><p>错误码即人性，感性认知+口口相传，使用纯数字来进行错误码编排不利于感性记忆和分类。</p></blockquote><p>说明：数字是一个整体，每位数字的地位和含义是相同的。反例：一个五位数字 12345，第1位是错误等级，第 2 位是错误来源，345 是编号，人的大脑不会主动地分辨每位数字的不同含义。</p><p>下图是《手册》给出的错误码示例：</p><div class=pgc-img><img alt=错误码如何设计才合理？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b6259fcb325d47778633d982ee7706d1><p class=pgc-img-caption></p></div><h1 class=pgc-h-decimal data-index=14>他山之石</h1><p>他山之石不一定能攻玉。</p><p><strong>谷歌 API 错误码定义</strong></p><p>谷歌 API 的错误码定义与 HTTP 状态码有着非常强的联系，并且是一个全数字错误码定义。</p><p>没有明显的错误分类，快速识别和自解释能力比较弱。</p><div class=pgc-img><img alt=错误码如何设计才合理？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/e622064ca4604d19adf1a86c05ab37af><p class=pgc-img-caption></p></div><p><strong>腾讯 OpenAPI（文智）错误码定义</strong></p><p>这也是一个全数字的错误码，没有明确的分类字段，纯数字的某一位已看不出明显的分类。</p><p>不利于进行感性记忆。</p><div class=pgc-img><img alt=错误码如何设计才合理？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ede9879cf5614805a8028394c673f78b><p class=pgc-img-caption></p></div><p><strong>微博 API 错误码定义</strong></p><p>同样是全数字的错误码定义：</p><div class=pgc-img><img alt=错误码如何设计才合理？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4761db923fbe43d39fd581599ba33cce><p class=pgc-img-caption></p></div><h1 class=pgc-h-decimal data-index=15>其他建议</h1><p>《手册》中有一条建议：</p><blockquote><p>全部正常，但不得不填充错误码时返回五个零：00000。</p></blockquote><p>这也是在其他家 API 错误码中能够看到的定义。</p><blockquote><p>参考</p></blockquote><p>《阿里巴巴java开发手册》</p><p>《Google API Design Guide （https://www.bookstack.cn/books/API-design-guide）</p><p>《阿里云-文件存储-错误码》（https://help.aliyun.com/document_detail/62603.html）</p><p>《微博开放平台-API-错误码》（https://open.weibo.com/wiki/Help/error）</p><p>《腾讯开放平台-错误》(https://wiki.open.qq.com/wiki/%E9%94%99%E8%AF%AF%E7%A0%81）</p><p class=pgc-end-literature><br></p><p class=pgc-end-literature>稿件来源：阿里云开发者社区</p><p class=pgc-end-literature>原文作者：茶什i</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'错误','设计','合理'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>