<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹åŠ¡æ¶ˆæ¯æºç ä»‹ç»(å¹²è´§) | æå®¢å¿«è¨Š</title><meta property="og:title" content="ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹åŠ¡æ¶ˆæ¯æºç ä»‹ç»(å¹²è´§) - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/9893da5524c1439f8a11cb24322c57a9"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/15b0178.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0178.html><meta property="article:published_time" content="2020-10-29T20:50:42+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:42+08:00"><meta name=Keywords content><meta name=description content="ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹åŠ¡æ¶ˆæ¯æºç ä»‹ç»(å¹²è´§)"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/15b0178.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹åŠ¡æ¶ˆæ¯æºç ä»‹ç»(å¹²è´§)</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><h1><strong>å‰è¨€</strong></h1><p>å¾—ç›ŠäºMQå‰Šå³°å¡«è°·ï¼Œç³»ç»Ÿè§£è€¦ï¼Œæ“ä½œå¼‚æ­¥ç­‰åŠŸèƒ½ç‰¹æ€§ï¼Œåœ¨äº’è”ç½‘è¡Œä¸šï¼Œå¯ä»¥è¯´æœ‰åˆ†å¸ƒå¼æœåŠ¡çš„åœ°æ–¹ï¼ŒMQéƒ½å¾€å¾€ä¸ä¼šç¼ºå¸­ã€‚ç”±é˜¿é‡Œè‡ªç ”çš„RocketMQæ›´æ˜¯ç»å†äº†å¤šå¹´çš„åŒåä¸€é«˜å¹¶å‘æŒ‘æˆ˜ï¼Œå…¶ä¸­4.3.0ç‰ˆæœ¬æ¨å‡ºäº†äº‹åŠ¡æ¶ˆæ¯çš„æ–°ç‰¹æ€§ï¼Œæœ¬æ–‡å¯¹RocketMQ 4.5.0ç‰ˆæœ¬äº‹åŠ¡æ¶ˆæ¯ç›¸å…³çš„æºç è·Ÿè¸ªä»‹ç»ï¼Œé€šè¿‡é˜…è¯»è¯»è€…å¯ä»¥çŸ¥é“ï¼š</p><ul><li>äº‹åŠ¡æ¶ˆæ¯è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜</li><li>äº‹åŠ¡æ¶ˆæ¯çš„å®ç°åŸç†åŠå…¶è®¾è®¡äº®ç‚¹</li></ul><div class=pgc-img><img alt=ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹åŠ¡æ¶ˆæ¯æºç ä»‹ç»(å¹²è´§) onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9893da5524c1439f8a11cb24322c57a9><p class=pgc-img-caption>RocketMQ</p></div><h1><strong>è§£å†³ä»€ä¹ˆé—®é¢˜</strong></h1><p>å‡è®¾æˆ‘æ‰€åœ¨çš„ç³»ç»Ÿç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š</p><p>æœ¬åœ°å¼€å¯æ•°æ®åº“äº‹åŠ¡è¿›è¡Œæ‰£æ¬¾æ“ä½œï¼ŒæˆåŠŸåå‘é€MQæ¶ˆæ¯ç»™åº“å­˜ä¸­å¿ƒè¿›è¡Œå‘è´§ã€‚</p><p>æœ‰äººä¼šæƒ³åˆ°å¼€å¯mybatisäº‹åŠ¡å®ç°ï¼ŒæŠŠæœ¬åœ°äº‹åŠ¡å’ŒMQæ¶ˆæ¯æ”¾åœ¨ä¸€èµ·ä¸å°±è¡Œäº†å—ï¼Ÿå¦‚æœMQå‘é€æˆåŠŸï¼Œå°±æäº¤äº‹åŠ¡ï¼Œå‘é€å¤±è´¥å°±å›æ»šäº‹åŠ¡ï¼Œæ•´å¥—æ“ä½œä¸€æ°”å‘µæˆã€‚</p><pre>transaction{ æ‰£æ¬¾(); boolean success = å‘é€MQ();	if(success){ commit(); }else{ rollBack(); }}</pre><p>çœ‹ä¼¼æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯<strong>ç½‘ç»œæ˜¯ä¸å¯é </strong>çš„ã€‚å‡è®¾MQè¿”å›è¿‡æ¥çš„å“åº”å› ä¸ºç½‘ç»œåŸå› è¿Ÿè¿Ÿæ²¡æœ‰æ”¶åˆ°ï¼Œæ‰€ä»¥åœ¨é¢å¯¹ä¸ç¡®å®šçš„MQè¿”å›ç»“æœåªå¥½è¿›è¡Œå›æ»šã€‚ä½†æ˜¯MQ æœåŠ¡å™¨åˆç¡®å®æ˜¯æ”¶åˆ°äº†è¿™æ¡æ¶ˆæ¯çš„ï¼Œåªæ˜¯ç»™å®¢æˆ·ç«¯çš„å“åº”ä¸¢å¤±äº†ï¼Œæ‰€ä»¥å¯¼è‡´çš„ç»“æœå°±æ˜¯æ‰£æ¬¾å¤±è´¥ï¼ŒæˆåŠŸå‘è´§ã€‚</p><div class=pgc-img><img alt=ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹åŠ¡æ¶ˆæ¯æºç ä»‹ç»(å¹²è´§) onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9e038ea88e9648df9dbeb07dbf872fdb><p class=pgc-img-caption></p></div><p>æ—¢ç„¶MQæ¶ˆæ¯çš„å‘é€ä¸èƒ½å’Œæœ¬åœ°äº‹åŠ¡å†™åœ¨ä¸€èµ·ï¼Œé‚£å¦‚ä½•æ¥ä¿è¯å…¶æ•´ä½“å…·æœ‰åŸå­æ€§çš„éœ€æ±‚å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ä»Šå¤©æˆ‘ä»¬ä»‹ç»çš„ä¸»è§’ï¼š<strong>äº‹åŠ¡æ¶ˆæ¯</strong>ã€‚</p><h1><strong>æ¦‚è§ˆ</strong></h1><div class=pgc-img><img alt=ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹åŠ¡æ¶ˆæ¯æºç ä»‹ç»(å¹²è´§) onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3a59f4ec00334086aa34d4af730812c9><p class=pgc-img-caption></p></div><p>æ€»ä½“è€Œè¨€RocketMQäº‹åŠ¡æ¶ˆæ¯åˆ†ä¸ºä¸¤æ¡ä¸»çº¿</p><ol><li><strong>å®šæ—¶ä»»åŠ¡å‘é€æµç¨‹</strong>ï¼šå‘é€half message(åŠæ¶ˆæ¯)ï¼Œæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œå‘é€äº‹åŠ¡æ‰§è¡Œç»“æœ</li><li><strong>å®šæ—¶ä»»åŠ¡å›æŸ¥æµç¨‹</strong>ï¼šMQæœåŠ¡å™¨å›æŸ¥æœ¬åœ°äº‹åŠ¡ï¼Œå‘é€äº‹åŠ¡æ‰§è¡Œç»“æœ</li></ol><p>å› æ­¤æœ¬æ–‡ä¹Ÿé€šè¿‡è¿™ä¸¤æ¡ä¸»çº¿å¯¹æºç è¿›è¡Œåˆ†æ</p><h1><strong>æºç åˆ†æ</strong></h1><p><strong>åŠæ¶ˆæ¯å‘é€æµç¨‹</strong></p><p><strong>æœ¬åœ°åº”ç”¨(client)</strong></p><p>åœ¨æœ¬åœ°åº”ç”¨å‘é€äº‹åŠ¡æ¶ˆæ¯çš„æ ¸å¿ƒç±»æ˜¯TransactionMQProducerï¼Œè¯¥ç±»é€šè¿‡ç»§æ‰¿DefaultMQProduceræ¥å¤ç”¨å¤§éƒ¨åˆ†å‘é€æ¶ˆæ¯ç›¸å…³çš„é€»è¾‘ï¼Œè¿™ä¸ªç±»çš„ä»£ç é‡éå¸¸å°‘åªæœ‰100æ¥è¡Œï¼Œä¸‹é¢æ˜¯è¿™ä¸ªç±»çš„sendMessageTransactionæ–¹æ³•</p><pre>@Overridepublic TransactionSendResult sendMessageInTransaction(final Message msg, final Object arg) throws MQClientException { if (null == this.transactionListener) { throw new MQClientException("TransactionListener is null", null); } return this.defaultMQProducerImpl.sendMessageInTransaction(msg, null, arg);}</pre><p>è¿™ä¸ªæ–¹æ³•åšäº†ä¸¤ä»¶äº‹ï¼Œ</p><ol><li>æ£€æŸ¥transactionListeneræ˜¯å¦å­˜åœ¨</li><li>è°ƒç”¨çˆ¶ç±»æ‰§è¡Œäº‹åŠ¡æ¶ˆæ¯å‘é€</li></ol><p>TransactionListeneråœ¨äº‹åŠ¡æ¶ˆæ¯æµç¨‹ä¸­èµ·åˆ°è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œä¸€èµ·çœ‹çœ‹è¿™ä¸ªæ¥å£</p><pre>public interface TransactionListener { /** * When send transactional prepare(half) message succeed, this method will be invoked to execute local transaction. * * @param msg Half(prepare) message * @param arg Custom business parameter * @return Transaction state */ LocalTransactionState executeLocalTransaction(final Message msg, final Object arg); /** * When no response to prepare(half) message. broker will send check message to check the transaction status, and this * method will be invoked to get local transaction status. * * @param msg Check message * @return Transaction state */ LocalTransactionState checkLocalTransaction(final MessageExt msg);}</pre><p>æ¥å£æ³¨é‡Šè¯´çš„å¾ˆæ˜ç™½ï¼Œé…åˆä¸Šé¢çš„æ¦‚è§ˆå›¾æ¥çœ‹å°±æ˜¯ï¼ŒexecuteLocalTransactionæ–¹æ³•å¯¹åº”çš„å°±æ˜¯<strong>æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</strong>æ“ä½œï¼ŒcheckLocalTransactionå¯¹åº”çš„å°±æ˜¯<strong>å›æŸ¥æœ¬åœ°äº‹åŠ¡</strong>æ“ä½œã€‚ä¸‹é¢æ˜¯DefaultMQProducerç±»çš„sendMessageInTransactionæ–¹æ³•æºç </p><pre>public TransactionSendResult sendMessageInTransaction(final Message msg, final LocalTransactionExecuter localTransactionExecuter, final Object arg) throws MQClientException { ... SendResult sendResult = null; MessageAccessor.putProperty(msg, MessageConst.PROPERTY_TRANSACTION_PREPARED, "true"); MessageAccessor.putProperty(msg, MessageConst.PROPERTY_PRODUCER_GROUP, this.defaultMQProducer.getProducerGroup()); 						... sendResult = this.send(msg); 						... switch (sendResult.getSendStatus()) { case SEND_OK: { 		... localTransactionState = transactionListener.executeLocalTransaction(msg, arg); ... break; case FLUSH_DISK_TIMEOUT: case FLUSH_SLAVE_TIMEOUT: case SLAVE_NOT_AVAILABLE: localTransactionState = LocalTransactionState.ROLLBACK_MESSAGE; break; default: break; } 						... this.endTransaction(sendResult, localTransactionState, localException);								...}</pre><p>ä¸ºäº†ä½¿æºç çš„é€»è¾‘æ›´åŠ ç›´è§‚ï¼Œç¬”è€…ç²¾ç®€äº†æ ¸å¿ƒä»£ç ã€‚sendMessageInTransactionæ–¹æ³•ä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…</p><ol><li>ç»™æ¶ˆæ¯æ‰“ä¸Šäº‹åŠ¡æ¶ˆæ¯ç›¸å…³çš„æ ‡è®°ï¼Œç”¨äºMQæœåŠ¡ç«¯åŒºåˆ†æ™®é€šæ¶ˆæ¯å’Œäº‹åŠ¡æ¶ˆæ¯</li><li>å‘é€åŠæ¶ˆæ¯(half message)</li><li>å‘é€æˆåŠŸåˆ™ç”±transactionListeneræ‰§è¡Œæœ¬åœ°äº‹åŠ¡</li><li>æ‰§è¡ŒendTransactionæ–¹æ³•ï¼Œå¦‚æœ<strong>åŠæ¶ˆæ¯å‘é€å¤±è´¥</strong>æˆ–<strong>æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå¤±è´¥</strong>å‘Šè¯‰æœåŠ¡ç«¯æ˜¯åˆ é™¤åŠæ¶ˆæ¯ï¼Œ<strong>åŠæ¶ˆæ¯å‘é€æˆåŠŸ</strong>ä¸”<strong>æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸ</strong>åˆ™å‘Šè¯‰æœåŠ¡ç«¯ç”Ÿæ•ˆåŠæ¶ˆæ¯ã€‚</li></ol><p>å‘é€åŠæ¶ˆæ¯æµç¨‹ï¼ŒClientç«¯ä»£ç åˆ°è¿™é‡Œå·®ä¸å¤šå°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹RocketMQ Serverç«¯æ˜¯å¦‚ä½•å¤„ç†çš„</p><p><strong>RocketMQ Server</strong></p><p>Serveråœ¨æ¥æ”¶åˆ°æ¶ˆæ¯è¿‡åä¼šè¿›è¡Œä¸€äº›é¢†åŸŸå¯¹è±¡çš„è½¬åŒ–å’Œæ˜¯å¦æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„æƒé™æ ¡éªŒï¼Œå¯¹ç†è§£äº‹åŠ¡æ¶ˆæ¯ç”¨å¤„ä¸å¤§ï¼Œæ­¤å¤„å°±çœç•¥å¯¹æ—ææœ«èŠ‚çš„ä»‹ç»äº†ã€‚ä¸‹é¢æ˜¯TransactionalMessageBridgeç±»å¤„ç†half messageçš„æºç </p><pre>public PutMessageResult putHalfMessage(MessageExtBrokerInner messageInner) { return store.putMessage(parseHalfMessageInner(messageInner));}private MessageExtBrokerInner parseHalfMessageInner(MessageExtBrokerInner msgInner) { MessageAccessor.putProperty(msgInner, MessageConst.PROPERTY_REAL_TOPIC, msgInner.getTopic()); MessageAccessor.putProperty(msgInner, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msgInner.getQueueId())); msgInner.setSysFlag( MessageSysFlag.resetTransactionValue(msgInner.getSysFlag(), MessageSysFlag.TRANSACTION_NOT_TYPE)); msgInner.setTopic(TransactionalMessageUtil.buildHalfTopic()); msgInner.setQueueId(0); msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgInner.getProperties())); return msgInner;}</pre><p>è¿™ä¸¤ä¸ªæ–¹æ³•ä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p><pre>public class Message implements Serializable { private static final long serialVersionUID = 8445773977080406428L; private String topic; private int flag; private Map&lt;String, String&gt; properties; private byte[] body; private String transactionId;}</pre><ol><li>å°†æ¶ˆæ¯çš„topicï¼ŒqueueIdæ”¾è¿›æ¶ˆæ¯ä½“è‡ªèº«çš„mapé‡Œè¿›è¡Œç¼“å­˜</li><li>å°†æ¶ˆæ¯çš„topic è®¾ç½®ä¸ºâ€œRMQ_SYS_TRANS_OP_HALF_TOPICâ€ï¼ŒqueueIdè®¾ç½®ä¸º0</li><li>å°†æ¶ˆæ¯å†™å…¥ç£ç›˜æŒä¹…åŒ–</li></ol><p>å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„äº‹åŠ¡åŠæ¶ˆæ¯éƒ½ä¼šè¢«æ”¾è¿›åŒä¸€ä¸ªtopicçš„åŒä¸€ä¸ªqueueé‡Œé¢ï¼Œé€šè¿‡å¯¹topicçš„åŒºåˆ†ï¼Œä»è€Œé¿å…äº†åŠæ¶ˆæ¯è¢«consumerç»™æ¶ˆè´¹åˆ°</p><p>Serverå°†åŠæ¶ˆæ¯æŒä¹…åŒ–åç„¶åä¼šå‘é€ç»“æœç»™æˆ‘ä»¬æœ¬åœ°çš„åº”ç”¨ç¨‹åºã€‚åˆ°äº†è¿™é‡ŒServerç«¯å¯¹åŠæ¶ˆæ¯çš„å¤„ç†å°±ç»“æŸäº†ï¼Œç´§æ¥ç€çš„æ˜¯å®šæ—¶ä»»åŠ¡çš„ç™»åœºã€‚</p><p><strong>å®šæ—¶ä»»åŠ¡å›æŸ¥æµç¨‹</strong></p><p><strong>RocketMQ Server</strong></p><p>å®šæ—¶ä»»åŠ¡æ˜¯ä¸€ä¸ªå«TransactionalMessageServiceç±»çš„çº¿ç¨‹ï¼Œä¸‹é¢æ˜¯è¯¥ç±»çš„checkæ–¹æ³•</p><pre>@Overridepublic void check(long transactionTimeout, int transactionCheckMax, AbstractTransactionalMessageCheckListener listener) { ... if (!putBackHalfMsgQueue(msgExt, i)) { continue; } listener.resolveHalfMsg(msgExt); } 									...}</pre><p>checkæ–¹æ³•éå¸¸é•¿ï¼Œçœç•¥çš„ä»£ç å¤§è‡´éƒ½æ˜¯å¯¹åŠæ¶ˆæ¯è¿›è¡Œè¿‡æ»¤(å¦‚è¶…è¿‡72å°æ—¶çš„äº‹åŠ¡æ¶ˆæ¯ï¼Œå°±è¢«ç®—ä½œè¿‡æœŸ)ï¼Œåªä¿ç•™ç¬¦åˆæ¡ä»¶çš„åŠæ¶ˆæ¯å¯¹å…¶è¿›è¡Œå›æŸ¥ã€‚</p><p>å…¶ä¸­å¾ˆæœ‰æ„æ€çš„æ˜¯putBackHalfMsgQueueæ–¹æ³•ï¼Œå› ä¸ºæ¯æ¬¡æŠŠåŠæ¶ˆæ¯ä»ç£ç›˜æ‹‰åˆ°å†…å­˜é‡Œè¿›è¡Œå¤„ç†éƒ½ä¼šå¯¹å…¶å±æ€§è¿›è¡Œæ”¹å˜(ä¾‹å¦‚TRANSACTION_CHECK_TIMESï¼Œè¿™æ˜¯æ˜¯å¦ä¸¢å¼ƒäº‹åŠ¡æ¶ˆæ¯çš„å…³é”®ä¿¡æ¯)ï¼Œæ‰€ä»¥åœ¨å‘é€å›æŸ¥æ¶ˆæ¯ä¹‹å‰éœ€è¦å¯¹åŠæ¶ˆæ¯å†æ¬¡æ”¾è¿›ç£ç›˜ã€‚RocketMQé‡‡å–çš„æ–¹æ³•æ˜¯åŸºäºæœ€æ–°çš„ç‰©ç†åç§»é‡<strong>é‡æ–°å†™å…¥</strong>ï¼Œè€Œä¸æ˜¯å¯¹åŸæœ‰çš„åŠæ¶ˆæ¯è¿›è¡Œ<strong>ä¿®æ”¹</strong>ï¼Œå…¶ä¸­çš„ç›®çš„å°±æ˜¯RocketMQçš„å­˜å‚¨è®¾è®¡é‡‡ç”¨é¡ºåºå†™ï¼Œå¦‚æœå»ä¿®æ”¹æ¶ˆæ¯ ï¼Œæ— æ³•åšåˆ°é«˜æ€§èƒ½ã€‚</p><p>ä¸‹é¢æ˜¯resolveHalfMsgæ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯å¼€å¯ä¸€ä¸ªçº¿ç¨‹ç„¶åå‘é€checkæ¶ˆæ¯ã€‚</p><pre>public void resolveHalfMsg(final MessageExt msgExt) { executorService.execute(new Runnable() { @Override public void run() { try { sendCheckMessage(msgExt); } catch (Exception e) { LOGGER.error("Send check message error!", e); } } });}</pre><p><strong>æœ¬åœ°åº”ç”¨(client)</strong></p><p>ä¸‹é¢æ˜¯DefaultMQProducerImplçš„checkTransactionStateæ–¹æ³•ï¼Œæ˜¯æœ¬åœ°åº”ç”¨å¯¹å›æŸ¥æ¶ˆæ¯çš„å¤„ç†é€»è¾‘</p><pre>@Overridepublic void checkTransactionState(final String addr, final MessageExt msg, final CheckTransactionStateRequestHeader header) { Runnable request = new Runnable() { ... @Override public void run() { ... TransactionListener transactionListener = getCheckListener(); ... localTransactionState = transactionListener.checkLocalTransaction(message); ...  this.processTransactionState( localTransactionState, group, exception);  }  private void processTransactionState( ... DefaultMQProducerImpl.this.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, thisHeader, remark, 3000); ... } }; this.checkExecutor.submit(request);}</pre><p>ç²¾ç®€ä»£ç é€»è¾‘åå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°</p><ul><li>å¼€å¯ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œå›æŸ¥çš„é€»è¾‘</li><li>é€šè¿‡æ‰§è¡ŒtransactionListenerçš„checkLocalTransactionæ–¹æ³•æ¥è·å–æœ¬åœ°äº‹åŠ¡æ‰§è¡Œçš„ç»“æœ</li></ul><p><strong>RocketMQ Server</strong></p><p>RocketMQ æœåŠ¡å™¨åœ¨æ”¶åˆ°Clientå‘è¿‡æ¥çš„Commitæ¶ˆæ¯åä¼š</p><p>è¯»å‡ºåŠæ¶ˆæ¯â€”â€”>æ¢å¤topicç­‰åŸæ¶ˆæ¯ä½“çš„ä¿¡æ¯â€”â€”>å’Œæ™®é€šæ¶ˆæ¯ä¸€æ ·å†æ¬¡å†™å…¥ç£ç›˜â€”â€”>åˆ é™¤ä¹‹å‰çš„åŠæ¶ˆæ¯</p><p>å¦‚æœæ˜¯Rollbackæ¶ˆæ¯åˆ™ç›´æ¥åˆ é™¤ä¹‹å‰çš„åŠæ¶ˆæ¯</p><p>åˆ°æ­¤ï¼Œæ•´æ¡RocketMQ äº‹åŠ¡æ¶ˆæ¯çš„è°ƒç”¨é“¾å°±ç»“æŸäº†</p><h1><strong>æ€è€ƒ</strong></h1><p><strong>1. åˆ†å¸ƒå¼äº‹åŠ¡ç­‰äºäº‹åŠ¡æ¶ˆæ¯å—ï¼Ÿ</strong></p><p>ä¸¤è€…å¹¶æ²¡æœ‰å…³ç³»ï¼Œäº‹åŠ¡æ¶ˆæ¯ä»…ä»…ä¿è¯æœ¬åœ°äº‹åŠ¡å’ŒMQæ¶ˆæ¯å‘é€å½¢æˆæ•´ä½“çš„åŸå­æ€§ï¼Œè€ŒæŠ•é€’åˆ°MQæœåŠ¡å™¨åï¼Œæ¶ˆè´¹è€…æ˜¯å¦èƒ½ä¸€å®šæ¶ˆè´¹æˆåŠŸæ˜¯æ— æ³•ä¿è¯çš„ã€‚</p><p><strong>2. æºç è®¾è®¡ä¸Šæœ‰ä»€ä¹ˆäº®ç‚¹å—ï¼Ÿ</strong></p><p>é€šè¿‡å¯¹æ•´æ¡é“¾è·¯æºç çš„å­¦ä¹ ç†è§£å‘ç°è¿˜æ˜¯æœ‰ä¸å°‘äº®ç‚¹çš„</p><ul><li>serverç«¯å›æŸ¥æ¶ˆæ¯çš„å‘é€ï¼Œclientç«¯å›æŸ¥æ¶ˆæ¯é€»è¾‘çš„å¤„ç†ï¼Œclientç«¯commit/rollbackæ¶ˆæ¯çš„æäº¤éƒ½æ˜¯ç”¨äº†å¼‚æ­¥è¿›è¡Œï¼Œå¯ä»¥è¯´èƒ½å¼‚æ­¥çš„åœ°æ–¹éƒ½ç”¨äº†å¼‚æ­¥ï¼Œé€šè¿‡å¼‚æ­¥+é‡è¯•çš„æ–¹å¼ä¿è¯äº†åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å³ä½¿çŸ­æš‚çš„ç½‘ç»œçŠ¶å†µä¸è‰¯å¥½ï¼Œä¹Ÿä¸ä¼šå½±å“æ•´ä½“é€»è¾‘ã€‚</li><li>å¼•å…¥TransactionListenerï¼ŒçœŸæ­£åšåˆ°äº†å¼€é—­åŸåˆ™ä»¥åŠä¾èµ–å€’ç½®åŸåˆ™ï¼Œé¢å‘æ¥å£ç¼–ç¨‹ã€‚æ•´ä½“æ‰©å±•æ€§åšå¾—éå¸¸å¥½ï¼Œä½¿ç”¨è€…åªéœ€è¦ç¼–å†™è‡ªå·±çš„Listenerå°±å¯ä»¥åšåˆ°äº‹åŠ¡æ¶ˆæ¯çš„å‘é€ï¼Œéå¸¸æ–¹ä¾¿</li><li>TransactionMQProduceré€šè¿‡ç»§æ‰¿DefaultMQProduceræå¤§åœ°å¤ç”¨äº†å…³äºå‘é€æ¶ˆæ¯ç›¸å…³çš„é€»è¾‘</li></ul><p><strong>3. æºç è®¾è®¡ä¸Šæœ‰ä»€ä¹ˆä¸è¶³å—ï¼Ÿ</strong></p><p>RocketMQä½œä¸ºä¸€æ¬¾æå…¶æˆåŠŸçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œè¦å‘ç°ä¸è¶³ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“äº†ï¼Œç¬”è€…è°ˆå‡ ç‚¹çœ‹æ³•</p><ul><li>sendMessageIntransactionç­‰äº‹åŠ¡ç›¸å…³çš„æ–¹æ³•è¢«åˆ’åˆ†åœ¨äº†DefaultMQProduceré‡Œé¢ï¼Œä»å†…èšçš„è§’åº¦æ¥è¯´è¿™æ˜¯è·Ÿäº‹åŠ¡ç›¸å…³çš„å‘é€æ¶ˆæ¯æ–¹æ³•åº”è¯¥è¢«åˆ’åˆ†åœ¨TransactionMQProducerã€‚</li><li>æ‰€æœ‰topicçš„åŠæ¶ˆæ¯éƒ½ä¼šå†™åœ¨topicä¸ºRMQ_SYS_TRANS_OP_HALF_TOPICçš„åŠæ¶ˆæ¯é˜Ÿåˆ—é‡Œï¼Œå¹¶ä¸”æ¯æ¡åŠæ¶ˆæ¯ï¼Œåœ¨æ•´ä¸ªé“¾è·¯é‡Œä¼šè¢«å†™å¤šæ¬¡ï¼Œå¦‚æœå¹¶å‘å¾ˆå¤§ä¸”å¤§éƒ¨åˆ†æ¶ˆæ¯éƒ½æ˜¯äº‹åŠ¡æ¶ˆæ¯çš„è¯ï¼Œå¯é æ€§ä¼šå­˜åœ¨é—®é¢˜ã€‚</li></ul></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'RocketMQ','äº‹åŠ¡','æºç '</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>