<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨ | æå®¢å¿«è¨Š</title><meta property="og:title" content="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/e50eec3cab434183b94071a7987369e4"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0f9f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0f9f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/15b0f9f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0f9f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0f9f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/15b0f9f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/15b0f9f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0f9f.html><meta property="article:published_time" content="2020-10-29T20:52:44+08:00"><meta property="article:modified_time" content="2020-10-29T20:52:44+08:00"><meta name=Keywords content><meta name=description content="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/15b0f9f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p><strong>ä¸€ã€ä»€ä¹ˆæ˜¯WebRTC</strong></p><p>WebRTCæŠ€æœ¯æ˜¯æ¿€çƒˆçš„å¼€æ”¾çš„Webæˆ˜äº‰ä¸­ä¸€å¤§çªç ´-Brendan Eich, inventor of JavaScriptã€‚</p><p>ç®€å•æ¥è¯´ï¼ŒWebRTC æ˜¯ä¸€ä¸ªéŸ³è§†é¢‘å¤„ç†+åŠæ—¶é€šè®¯çš„å¼€æºåº“ã€‚åœ¨å®æ—¶é€šä¿¡ä¸­ï¼ŒéŸ³è§†é¢‘çš„é‡‡é›†å’Œå¤„ç†æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„è¿‡ç¨‹ã€‚æ¯”å¦‚éŸ³è§†é¢‘æµçš„ç¼–è§£ç ã€é™å™ªå’Œå›å£°æ¶ˆé™¤ç­‰ã€‚ç”±Googleå‘èµ·å¼€æºï¼Œå…¶ä¸­åŒ…å«è§†é¢‘éŸ³é¢‘é‡‡é›†ï¼Œç¼–è§£ç ï¼Œæ•°æ®ä¼ è¾“ï¼ŒéŸ³è§†é¢‘å±•ç¤ºç­‰åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ€æœ¯å¿«é€Ÿåœ°æ„å»ºå‡ºä¸€ä¸ªéŸ³è§†é¢‘é€šè®¯åº”ç”¨ã€‚è™½ç„¶å…¶åä¸ºWebRTCï¼Œä½†æ˜¯å®é™…ä¸Šå®ƒä¸åªæ˜¯æ”¯æŒWebä¹‹é—´çš„éŸ³è§†é¢‘é€šè®¯ï¼Œè¿˜æ”¯æŒAndroidä»¥åŠIOSç«¯ï¼Œæ­¤å¤–ç”±äºè¯¥é¡¹ç›®æ˜¯å¼€æºçš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç¼–è¯‘C++ä»£ç ï¼Œä»è€Œè¾¾åˆ°å…¨å¹³å°çš„äº’é€šã€‚</p><p style=text-align:justify>WebRTCçš„æ¶æ„å›¾ä¸ºï¼š</p><p style=text-align:center><br></p><div class=pgc-img><img alt="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e50eec3cab434183b94071a7987369e4><p class=pgc-img-caption></p></div><p style=text-align:center><br></p><p style=text-align:justify>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¨¡å—åŒ–å’Œåˆ†å±‚çš„è®¾è®¡ï¼Œæˆ‘ä»¬æ–‡ç« çš„ç›®çš„æ˜¯æ¼”ç¤ºæµè§ˆå™¨ç«¯å¯¹ç«¯çš„è¿æ¥æµç¨‹ï¼Œç„¦ç‚¹æ˜¯æœåŠ¡ç«¯ä¿¡ä»¤æœåŠ¡å™¨çš„å®ç°æ–¹å¼ï¼Œä½†éœ€è¦æå‰ä»‹ç»ä¸€äº›WebRTCçš„åŸºæœ¬æ¦‚å¿µå’Œè¿æ¥æµç¨‹ã€‚</p><p style=text-align:justify><strong>äºŒã€åŸºç¡€æ¦‚å¿µ</strong></p><p><strong>æµå’Œè½¨</strong></p><ul><li>Track è½¨é“ï¼Œå¯ä»¥ç†è§£æ¯ä¸€è·¯éŸ³é¢‘æˆ–è§†é¢‘ï¼Œä¸ºä¸€ä¸ªè½¨ï¼Œäº’ä¸ç›¸äº¤ï¼Œç±»æ¯”ç«è½¦è½¨é“ã€‚</li><li>MediaStream åª’ä½“æµï¼Œæ¯ä¸ªåª’ä½“æµä¸­åŒ…å«è‹¥å¹²è½¨é“ï¼Œå¯ä»¥å°†éŸ³é¢‘è½¨ï¼Œè§†é¢‘è½¨æ‰“åŒ…åœ¨ä¸€èµ·ã€‚</li></ul><p><strong>ä¸‰ã€å‡ ä¸ªå…³é”®ç±»</strong></p><ul><li>MediaStream åª’ä½“æµç±»ï¼ŒMeidiaStreamç”¨äºå°†å¤šä¸ªMediaStreamTrackå¯¹è±¡æ‰“åŒ…åˆ°ä¸€èµ·ã€‚ä¸€ä¸ªMediaStreamå¯åŒ…å«audio track ä¸video track,å¹¶ä¸”å¯ä»¥æ·»åŠ æˆ–è€…åˆ é™¤ã€‚</li><li>RTCPeerConnection è¿æ¥ç±»ï¼ŒåŒ…å«éå¸¸å¤šé‡è¦åŠŸèƒ½ï¼Œå±è”½å¤æ‚æŠ€æœ¯ç»†èŠ‚ï¼Œä¾¿äºåº”ç”¨å±‚ä½¿ç”¨ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºè¿æ¥ç®¡ç†ï¼ŒP2Pç±»å‹æ£€æµ‹ï¼ŒNATç©¿é€ï¼Œä¸­è½¬ç­‰ã€‚</li><li>RTCDataChannel ééŸ³è§†é¢‘æ•°æ®ä¼ è¾“ç±»ï¼Œè¿™ä¸ªç±»åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ²¡æœ‰æ¶‰åŠåˆ°ã€‚å¯ä»¥ç®€å•ç†è§£ä¸ºå°†åª’ä½“æµä¿¡æ¯æˆ–è€…æ•°æ®ä¿¡æ¯å¡åˆ°è¿æ¥ä¸­ï¼Œè¿›è¡Œä¼ è¾“ã€‚</li></ul><p><strong>å››ã€ç«¯å¯¹ç«¯è¿æ¥æµç¨‹</strong></p><p style=text-align:justify>ä¸¤ä¸ªä¸åŒç½‘ç»œç¯å¢ƒæµè§ˆå™¨ï¼Œè¦å®ç°ç‚¹å¯¹ç‚¹çš„å®æ—¶éŸ³è§†é¢‘å¯¹è¯ï¼Œéœ€è¦å¤„ç†å“ªäº›é—®é¢˜?</p><p style=text-align:justify><strong>åª’ä½“åå•†</strong></p><p style=text-align:justify>åŒæ–¹éœ€è¦çŸ¥é“å¯¹æ–¹æ”¯æŒçš„åª’ä½“æ ¼å¼ï¼ŒSDPï¼ˆSession Description Protocolï¼‰æ˜¯ä¸€ç§ä¼šè¯æè¿°åè®®ï¼Œè§†é¢‘é€šè®¯çš„åŒæ–¹å¿…é¡»å…ˆäº¤æ¢SDPä¿¡æ¯ï¼Œæ‰èƒ½è¿›ä¸€æ­¥äº’ç›¸é€šä¿¡ã€‚</p><p style=text-align:justify><strong>ç½‘ç»œåå•†</strong></p><p style=text-align:justify>åŒæ–¹è¦äº†è§£å¯¹æ–¹çš„ç½‘ç»œæƒ…å†µï¼Œå°è¯•å¯»æ±‚ä¸€ä¸ªå¯ä»¥äº’ç›¸é€šè®¯çš„é“¾è·¯ï¼Œå…¶ä¸­æœ‰å¯»è·¯é€‰æ‹©ï¼Œå¦‚æœç¡®å®æ²¡åŠæ³•å»ºç«‹ç‚¹å¯¹ç‚¹é“¾è·¯ï¼Œä¼šä½¿ç”¨ä¸­ç»§æœåŠ¡å™¨æ¥è¿›è¡Œè½¬å‘ã€‚å¦‚æœæ˜¯å†…ç½‘ï¼Œæˆ–è€…å¤§éƒ¨åˆ†NATç½‘ç»œç¯å¢ƒä¸‹ï¼Œæ˜¯å¯ä»¥å»ºç«‹ç«¯åˆ°ç«¯è¿æ¥ã€‚åœ¨è§£å†³ç½‘ç»œæ‰“é€šé—®é¢˜æ—¶å€™ï¼Œæœ‰å‡ ä¸ªæ¦‚å¿µã€‚</p><ul><li>STUNï¼ˆSession Traversal Utilities for NATï¼ŒNATä¼šè¯ç©¿è¶Šåº”ç”¨ç¨‹åºï¼‰æ˜¯ä¸€ç§ç½‘ç»œåè®®ï¼Œå®ƒå…è®¸ä½äºNATåçš„å®¢æˆ·ç«¯æ‰¾å‡ºè‡ªå·±çš„å…¬ç½‘åœ°å€ï¼ŒæŸ¥å‡ºè‡ªå·±ä½äºå“ªç§ç±»å‹çš„NATä¹‹åä»¥åŠNATåœ¨å…¬ç½‘çš„ç«¯å£æ˜ å°„ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯è¢«ç”¨æ¥åœ¨ä¸¤ç«¯åˆ›å»ºUDPè¿æ¥é€šä¿¡ã€‚</li><li>TURN (Traversal Using Relays around NAT)ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨NATä¹‹åï¼Œ é‚£ä¹ˆåœ¨ä¸€äº›ç½‘ç»œæƒ…æ™¯ä¸‹ï¼Œæœ‰å¯èƒ½å»ºç«‹ç‚¹å¯¹ç‚¹çš„é€šè®¯è¿æ¥ï¼Œè¿™æ—¶å°±éœ€è¦å…¬ç½‘çš„æœåŠ¡å™¨ä½œä¸ºä¸€ä¸ªä¸­ç»§ï¼Œ å¯¹æ•°æ®è¿›è¡Œè½¬å‘ã€‚</li></ul><p>å­¦ä¹ è¿‡ç¨‹ä¸­ï¼ŒSTUNå’ŒTURNæœåŠ¡å™¨æˆ‘ä»¬å¯ä½¿ç”¨coturnå¼€æºé¡¹ç›®æ¥æ­å»ºã€‚</p><p style=text-align:justify><strong>æ•°æ®äº¤æ¢æœåŠ¡-ä¿¡ä»¤æœåŠ¡å™¨</strong></p><p style=text-align:justify>WebRTCå®ç°å¹¶æ²¡æœ‰è§„å®šä¿¡ä»¤æœåŠ¡å™¨çš„å®ç°æ–¹å¼å’Œç›¸å…³åè®®ï¼Œè¿™ç»™äº†ä¸šåŠ¡æ–¹æŠ€æœ¯é€‰å‹æå¤§çš„çµæ´»ã€‚æˆ‘ä»¬ä»Šå¤©å°±æ˜¯ä½¿ç”¨PHP+Swooleåç¨‹å®ç°ä¸€ä¸ªç®€å•ä¿¡ä»¤æœåŠ¡å™¨ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯è¿æ¥çš„æµç¨‹å›¾ï¼Œæ•´ä¸ªæ ¸å¿ƒæµç¨‹é€»è¾‘éƒ½åœ¨å›¾é‡Œé¢ã€‚</p><p style=text-align:center><br></p><div class=pgc-img><img alt="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e89db2df25d842338f3b4a889e2fcc1a><p class=pgc-img-caption></p></div><p style=text-align:center><br></p><p style=text-align:justify><strong>äº”ã€ä½¿ç”¨Swooleå®ç°ä¿¡ä»¤æœåŠ¡å™¨</strong></p><p><strong>å®¢æˆ·ç«¯ä»£ç æ¨¡æ‹Ÿ</strong></p><pre><code>&lt;body&gt;&lt;div style="display: block"&gt;    &lt;button class="btn" onclick="start()"&gt;è¿æ¥&lt;tton&gt;    &lt;button class="btn" onclick="leave()"&gt;ç¦»å¼€&lt;tton&gt;&lt;/div&gt;&lt;div&gt;    &lt;div class="videos"&gt;        &lt;h1&gt;Local&lt;/h1&gt;        &lt;video id="localVideo" autoplay&gt;&lt;ideo&gt;    &lt;/div&gt;    &lt;div class="videos"&gt;        &lt;h1&gt;Remote&lt;/h1&gt;        &lt;video id="remoteVideo" autoplay&gt;&lt;ideo&gt;    &lt;/div&gt;&lt;/div&gt;&lt;script src="assets/js/adapter.js"&gt;&lt;/script&gt;&lt;script type="text/javascript"&gt;    const ws_config = '&lt;?= $signaling_server ?&gt;';    const localVideo = document.getElementById('localVideo');    const remoteVideo = document.getElementById('remoteVideo');    const configuration = {        iceServers: [{            urls: '&lt;?= $stun_server ?&gt;'        }]    };    let room_id = getQueryVariable('room_id');    if (room_id == '' || room_id == null) {        room_id = Math.random().toString(36).slice(-8);        location.href = '?room_id=' + room_id;    }    let subject = 'room-' + room_id;//å½“å‰ä¸»é¢˜    let answer = 0;    let ws = null;    let pc, localStream;    function getMediaStream(stream) {        localVideo.srcObject = localStream;        localStream = stream;    }    function start() {        ws = new WebSocket(ws_config);        ws.onopen = function (e) {            subscribe(subject);            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {                console.error('the getUserMedia is not supported!');                return;            }            navigator.mediaDevices.getUserMedia({                audio: true,                video: true            }).then(function (stream) {                if (localStream) {                    stream.getAudioTracks().forEach((track) =&gt; {                        localStream.addTrack(track);                        stream.removeTrack(track);                    });                } else {                    localStream = stream;                }                localVideo.srcObject = localStream;                publish('call', null);            }).catch(function (e) {                console.error('Failed to get Media Stream!', e);            });        };        ws.onmessage = function (e) {            let package = JSON.parse(e.data);            let data = package.data;            console.log(e);            switch (package.event) {                case 'call':                    icecandidate(localStream);                    pc.createOffer({                        offerToReceiveAudio: 1,                        offerToReceiveVideo: 1                    }).then(function (desc) {                        pc.setLocalDescription(desc).then(                            function () {                                publish('offer', pc.localDescription);                            }                        ).catch(function (e) {                            alert(e);                        });                    }).catch(function (e) {                        alert(e);                    });                    break;                case 'answer':                    pc.setRemoteDescription(new RTCSessionDescription(data),        function () {}, function (e) {                        alert(e);                    });                    break;                case 'offer':                    icecandidate(localStream);                    pc.setRemoteDescription(new RTCSessionDescription(data),                            function () {                        if (!answer) {                            pc.createAnswer(function (desc) {                                    pc.setLocalDescription(desc, function () {                                        publish('answer', pc.localDescription);                                    }, function (e) {                                        alert(e);                                    });                                }                                , function (e) {                                    alert(e);                                });                            answer = 1;                        }                    }, function (e) {                        alert(e);                    });                    break;                case 'candidate':                    pc.addIceCandidate(new RTCIceCandidate(data), function () {                    }, function (e) {                        alert(e);                    });                    break;            }        };    }    function leave() {        pc.close();    }    function icecandidate(localStream) {        pc = new RTCPeerConnection(configuration);        pc.onicecandidate = function (event) {            if (event.candidate) {                publish('candidate', event.candidate);            }        };        try {            pc.addStream(localStream);        } catch (e) {            let tracks = localStream.getTracks();            for (let i = 0; i &lt; tracks.length; i++) {                pc.addTrack(tracks[i], localStream);            }        }        pc.onaddstream = function (e) {            remoteVideo.srcObject = e.stream;        };    }    function publish(event, data) {        let obj = {            cmd: 'publish',            subject: subject,            event: event,            data: data        };        console.log(obj);        ws.send(JSON.stringify(obj));    }    function subscribe(subject) {        let obj = {            cmd: 'subscribe',            subject: subject        };        console.log(obj);        ws.send(JSON.stringify(obj));    }    function getQueryVariable(variable) {        var query = window.location.search.substring(1);        var vars = query.split("&amp;");        for (var i = 0; i &lt; vars.length; i++) {            var pair = vars[i].split("=");            if (pair[0] == variable) {                return pair[1];            }        }        return false;    }&lt;/script&gt;&lt;/body&gt;</code></pre><p><strong>ä¿¡ä»¤æœåŠ¡ç«¯å®ç°</strong></p><pre><code>&lt;?phpuse Swoole\Http\Request;use Swoole\Http\Response;const WEBROOT = __DIR__ . '/web';$connnection_map = array();error_reporting(E_ALL);Co\run(function () {    $server = new Swoole\Coroutine\Http\Server('0.0.0.0', 9509, true);    $server-&gt;set([        'ssl_key_file' =&gt; __DIR__ . '/ssl/ssl.key',        'ssl_cert_file' =&gt; __DIR__ . '/ssl/ssl.crt',    ]);    $server-&gt;handle('/', function (Request $req, Response $resp) {        //websocket        if (isset($req-&gt;header['upgrade']) and $req-&gt;header['upgrade'] == 'websocket') {            $resp-&gt;upgrade();            $resp-&gt;subjects = array();            while (true) {                $frame = $resp-&gt;recv();                if (empty($frame)) {                    break;                }                $data = json_decode($frame-&gt;data, true);                switch ($data['cmd']) {                    case 'subscribe':                        subscribe($data, $resp);                        break;                    case 'publish':                        publish($data, $resp);                        break;                }            }            free_connection($resp);            return;        }        /tp        $path = $req-&gt;server['request_uri'];        if ($path == '/') {            $resp-&gt;end(get_php_file(WEBROOT . '/index.html'));        } else {            $file = realpath(WEBROOT . $path);            if (false === $file) {                $resp-&gt;status(404);                $resp-&gt;end('&lt;h3&gt;404 Not Found&lt;/h3&gt;');                return;            }            if (strpos($file, WEBROOT) !== 0) {                $resp-&gt;status(400);                return;            }            if (\pathinfo($file, PATHINFO_EXTENSION) === 'php') {                $resp-&gt;end(get_php_file($file));                return;            }            if (isset($req-&gt;header['if-modified-since']) and !empty($if_modified_since = $req-&gt;header['if-modified-since'])) {                $info = \stat($file);                $modified_time = $info ? \date('D, d M Y H:i:s', $info['mtime']) . ' ' . \date_default_timezone_get() : '';                if ($modified_time === $if_modified_since) {                    $resp-&gt;status(304);                    $resp-&gt;end();                    return;                }            }            $resp-&gt;sendfile($file);        }    });    $server-&gt;start();});function subscribe($data, $connection){    global $connnection_map;    $subject = $data['subject'];    $connection-&gt;subjects[$subject] = $subject;    $connnection_map[$subject][$connection-&gt;fd] = $connection;}function unsubscribe($subject, $current_conn){    global $connnection_map;    unset($connnection_map[$subject][$current_conn-&gt;fd]);}function publish($data, $current_conn){    global $connnection_map;    $subject = $data['subject'];    $event = $data['event'];    $data = $data['data'];    //å½“å‰ä¸»é¢˜ä¸å­˜åœ¨    if (empty($connnection_map[$subject])) {        return;    }    foreach ($connnection_map[$subject] as $connection) {        //ä¸ç»™å½“å‰è¿æ¥å‘é€æ•°æ®        if ($current_conn == $connection) {            continue;        }        $connection-&gt;push(            json_encode(                array(                    'cmd' =&gt; 'publish',                    'event' =&gt; $event,                    'data' =&gt; $data                )            )        );    }}function free_connection($connection){    foreach ($connection-&gt;subjects as $subject) {        unsubscribe($subject, $connection);    }}function get_php_file($file){    \ob_start();    try {        include $file;    } catch (\Exception $e) {        echo $e;    }    return \ob_get_clean();}</code></pre><p style=text-align:justify>1. æˆ¿é—´å…¥å£</p><p>ä¸‹é¢æ˜¯æœ¬åœ°çš„æ•ˆæœå›¾ï¼Œé¦–é¡µå¯ä»¥è¾“å…¥æˆ¿é—´å·åŠ å…¥ï¼Œå¦‚æœä¸ºç©ºä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦</p><p><br></p><div class=pgc-img><img alt="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7c29c075beca4ff6b3c9f374ffae5f56><p class=pgc-img-caption></p></div><p><br></p><p>2. æˆ¿é—´å†…</p><p>ä¸‹å›¾æˆ‘åœ¨æœ¬åœ°ä½¿ç”¨ä¸¤å°ç¬”è®°æœ¬å®ç°çš„ä¸€ä¸ªæ•ˆæœå›¾ï¼Œä½¿ç”¨è‡ªç­¾çš„è¯ä¹¦ï¼Œè¿™é‡Œç‰¹æ„å±•ç¤ºäº†ä¸¤ä¸ªä¸åŒçš„ç”»é¢æ¥åŒºåˆ†è§†é¢‘åŒæ­¥æ•ˆæœã€‚</p><p><br></p><div class=pgc-img><img alt="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ff6a3cfb52064752a86c73ba85aa1df0><p class=pgc-img-caption></p></div><p><br></p><p style=text-align:justify><strong>è¯·æ±‚æµç¨‹åˆ†æ</strong></p><p>1. åœ¨ä¸€å°ç”µè„‘ä¸Šç‚¹å‡»è¿æ¥æŒ‰é’®ï¼Œé€šè¿‡ç»‘å®šçš„ç‚¹å‡»äº‹ä»¶start()å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œé¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªwebsocketå¯¹è±¡å¹¶å‘èµ·è¿æ¥ï¼Œè¿æ¥æˆåŠŸå,å‘ä¿¡å·æœåŠ¡å™¨æ³¨å†Œè®¾å¤‡ï¼Œå¹¶è·å–å½“å‰è®¾å¤‡çš„æµåª’ä½“ã€‚è·å–æˆåŠŸåï¼Œèµ‹å€¼ç»™æœ¬åœ°å…ƒç´ å¯ä»¥å±•ç¤ºï¼Œå¹¶ä¸”èµ‹å€¼ç»™å…¨å±€å˜é‡localStreamã€‚</p><pre><code>ws.onopen = function (e) {            subscribe(subject);            navigator.mediaDevices.getUserMedia({                audio: true,                video: true            }).then(function (stream) {                localVideo.srcObject = stream;                localStream = stream;                localVideo.addEventListener('loadedmetadata', function(){                    publish('call', null);                })            }).catch(function (e) {                alert(e);            });        };</code></pre><p>2. ä¿¡ä»¤æœåŠ¡ç«¯å™¨åœ¨æ”¶åˆ°subscribeå’Œpublishè¯·æ±‚åï¼Œä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªè¿æ¥æ˜ å°„å…³ç³»ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯å¦‚æœæœ‰å…¶ä»–è¿æ¥è¿›æ¥ï¼Œä¼šè¿›è¡Œå¹¿æ’­é€šçŸ¥ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰å®ç°ä¸€äº›ç»†èŠ‚é€»è¾‘ï¼Œæ¯”å¦‚æˆ¿é—´å†…è¿æ¥æ•°é‡é™åˆ¶ï¼Œæˆ¿é—´æ»¡äº†é€šçŸ¥ï¼Œé€€å‡ºè¿æ¥é€šçŸ¥ç­‰ã€‚</p><p>3. å¦ä¸€ä¸ªå®¢æˆ·ç«¯ç‚¹å‡»è¿æ¥ä¼šé‡å¤ä¸Šä¸€æ­¥éª¤ï¼Œå¯¹ç«¯åœ¨æ”¶åˆ°å…¶ä»–å®¢æˆ·ç«¯åŠ å…¥æˆ¿é—´é€šçŸ¥åã€‚</p><pre><code>case 'call':        icecandidate(localStream);//åˆ›å»ºè¿æ¥ï¼Œå¹¶æ³¨å†Œç½‘ç»œåå•†æˆåŠŸåç»™ä¿¡ä»¤æœåŠ¡å™¨å‘é€ä¿¡æ¯çš„äº‹ä»¶        pc.createOffer({            offerToReceiveAudio: 1,            offerToReceiveVideo: 1        }).then(function (desc) {            pc.setLocalDescription(desc).then(//åˆ›å»ºofferæˆåŠŸåï¼Œè®¾ç½®æœ¬åœ°æè¿°ï¼Œå¹¶æœåŠ¡ç«¯ç»‘å®šç½‘ç»œä¿¡æ¯ï¼ŒæˆåŠŸåç»™ä¿¡ä»¤æœåŠ¡å™¨å‘é€SDP offer                function () {                    publish('offer', pc.localDescription);                }            ).catch(function (e) {                alert(e);            });        }).catch(function (e) {            alert(e);        });        break;</code></pre><p>4. ä¿¡ä»¤æœåŠ¡ç«¯æ”¶åˆ°ä¸€ç«¯offeråä¼šè½¬å‘ç»™å¦ä¸€ç«¯ï¼Œè§¦å‘å®¢æˆ·ç«¯çš„ç›¸åº”é€»è¾‘ï¼ŒåŒæ ·ä¼šåˆ›å»ºè¿æ¥ï¼Œå¹¶æ³¨å†Œç½‘ç»œåå•†æˆåŠŸåç»™ä¿¡ä»¤æœåŠ¡å™¨å‘é€ä¿¡æ¯çš„äº‹ä»¶ï¼ŒåŒæ—¶ä¼šåˆ›å»ºåº”ç­”ï¼ŒæˆåŠŸåä¹Ÿä¼šè®¾ç½®æœ¬åœ°æè¿°ï¼Œå¹¶å‘æœåŠ¡ç«¯å‘é€ç»‘å®šä¿¡æ¯ã€‚åŒæ—¶å‘ä¿¡ä»¤æœåŠ¡ç«¯å‘é€answerä¿¡æ¯,è¿›è¡Œä¸­è½¬åˆ°å¯¹ç«¯ã€‚</p><pre><code>case 'offer':        icecandidate(localStream);        pc.setRemoteDescription(new RTCSessionDescription(data), function () {            if (!answer) {                pc.createAnswer(function (desc) {                        pc.setLocalDescription(desc, function () {                            publish('answer', pc.localDescription);                        }, function (e) {                            alert(e);                        });                    }                    , function (e) {                        alert(e);                    });                answer = 1;            }        }, function (e) {            alert(e);        });        break;</code></pre><p style=text-align:justify>5. å¯¹ç«¯æ”¶åˆ°answerä¿¡æ¯ï¼Œè®¾ç½®è¿œç«¯çš„æè¿°ä¿¡æ¯ã€‚å½“åŒæ–¹éƒ½å®Œæˆoffer,answeræ­¥éª¤åï¼Œæ­¤æ—¶åŒæ–¹çš„åª’ä½“åå•†å·²ç»å®Œæˆã€‚æˆ‘ä»¬å·²ç»ç»‘å®šè¿‡ç½‘ç»œä¿¡æ¯åˆ°æœåŠ¡ç«¯ï¼Œå„ç«¯ä¼šç­‰å¾…æ¥æ”¶å€™é€‰è€…åˆ—è¡¨ã€‚</p><pre><code>case 'answer':    pc.setRemoteDescription(new RTCSessionDescription(data), function () {    }, function (e) {        alert(e);    });    break;</code></pre><p style=text-align:justify>6. æ”¶åˆ°å€™é€‰è€…åˆ—è¡¨åï¼Œéœ€è¦æŠŠå„è‡ªçš„å€™é€‰ä¿¡æ¯é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨ä¸­è½¬åˆ°å¯¹æ–¹ã€‚</p><pre><code>pc.onicecandidate = function (event) {    if (event.candidate) {        publish('candidate', event.candidate);    }};</code></pre><p style=text-align:justify>7. å„ç«¯æ”¶åˆ°å¯¹æ–¹çš„å€™é€‰è€…åˆ—è¡¨åï¼Œä¼šæŠŠå¯¹ç«¯çš„å€™é€‰è€…åŠ å…¥å½“å‰è¿æ¥é€šè·¯çš„å€™é€‰è€…åˆ—è¡¨ä¸­ï¼Œç„¶ååŒæ–¹ä¼šè¿›è¡Œè¿æ¥æ£€æµ‹ç­‰ç­‰ä¸€ç³»åˆ—å¤æ‚çš„æ“ä½œï¼Œå½“æ‰¾åˆ°ä¸€ä¸ªæœ€ä¼˜çš„é“¾è·¯ä¹‹åï¼Œå°±ä¼šå»ºç«‹è¿æ¥,è¿›è¡Œæ•°æ®äº¤äº’ã€‚</p><pre><code>pc.addIceCandidate(new RTCIceCandidate(data), function () {    }, function (e) {        alert(e);    });    break;</code></pre><p style=text-align:justify><strong>ä¿¡ä»¤æœåŠ¡ç«¯</strong></p><p style=text-align:justify>æˆ‘ä»¬ä»‹ç»äº†å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼Œé’ˆå¯¹æœåŠ¡ç«¯ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ä¿¡ä»¤æœåŠ¡å™¨ç«¯çš„ä»£ç å¾ˆå°‘ï¼ŒåŠ ä¸Šhttpçš„æœåŠ¡æ€»è®¡100è¡Œä»£ç å·¦å³ï¼Œæ€æ ·è¾¾åˆ°é€šè¿‡åŒæ­¥ç¼–ç¨‹çš„æ–¹å¼å®ç°å¼‚æ­¥éé˜»å¡IOï¼Œå¹¶ä¸”å¯ä»¥å¾ˆè½»æ¾çš„å®ç°å¹¶å‘ç™¾ä¸‡å‘¢ï¼Ÿ</p><ul><li>é¦–å…ˆé€šè¿‡æ„é€ å‡½æ•°$server = new Swoole\Coroutine\Http\Server('0.0.0.0', 9509, true);ä¼šåˆ›å»ºserverå¯¹è±¡ã€‚</li><li>å½“è°ƒç”¨$server->start();æ–¹æ³•åï¼Œä¼šå¾ªç¯è¿›è¡Œacceptï¼Œacceptè¿æ¥åï¼Œä¼šåˆ›å»ºä¸€ä¸ªåç¨‹ï¼Œè¿™ä¸ªåç¨‹å†…æ‰€æœ‰çš„æ¶ˆæ¯æ”¶å‘ï¼Œéƒ½ä¼šå¼•èµ·åç¨‹è°ƒåº¦ã€‚</li><li>å¯ä»¥ä½æˆæœ¬åˆ›å»ºæˆåƒä¸Šä¸‡åç¨‹ï¼Œå¹¶å‘ç™¾ä¸‡æ²¡é—®é¢˜ï¼Œåº•å±‚ä¼šä¸ºæ¯ä¸ªåç¨‹å¼€è¾Ÿç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œå¹¶åŸºäºå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼ˆLinuxä¸‹ä¸ºEPOLLï¼‰æ¥è¿›è¡Œè°ƒåº¦ã€‚</li></ul><p style=text-align:justify>ä¿¡ä»¤æœåŠ¡å™¨åˆ©ç”¨Swooleåç¨‹æŠ€æœ¯ï¼Œå•è¿›ç¨‹æ”¯æŒå¼‚æ­¥éé˜»å¡IOé«˜å¹¶å‘ï¼Œä½†ç¼–ç¨‹å®Œå…¨æ˜¯åŒæ­¥é˜»å¡çš„æ¨¡å¼ã€‚å¦‚æœæƒ³è¿›ä¸€æ­¥è¦åˆ©ç”¨å¤šæ ¸ï¼Œå¯ä»¥é‡‡ç”¨Process Poolï¼ŒåŠ reuse port(Linux kernel 3.9)æŠ€æœ¯ï¼Œå¼€å¯å¤šä¸ªè¿›ç¨‹åŒæ—¶å¤„ç†,ä»£ç ä»“åº“ä¸­æœ‰ä¸€ä»½server_co_pool.phpçš„ç›¸å…³å®ç°</p><pre><code>$resp-&gt;subjects = array();while (true) {    $frame = $resp-&gt;recv();    if (empty($frame)) {        break;    }    $data = json_decode($frame-&gt;data, true);    switch ($data['cmd']) {        case 'subscribe':            subscribe($data, $resp);//è®¢é˜…            break;        case 'publish':            publish($data, $resp);//å¹¿æ’­é™¤è‡ªå·±ä»¥å¤–çš„è¿æ¥            break;    }}free_connection($resp);</code></pre><p>æœåŠ¡ç«¯å¤„ç†æ ¸å¿ƒé€»è¾‘ä¸ºå°†å½“å‰è¿æ¥åŠ å…¥å†…å­˜mapä¸­ï¼Œä»¥ä¾›æ–°çš„è¿æ¥åˆ°æ¥æŸ¥æ‰¾å¹¿æ’­ï¼Œè¿æ¥å…³é—­æ—¶ï¼Œæ¸…ç†å¯¹åº”çš„ä¸»é¢˜å’Œfdã€‚</p><p style=text-align:justify>åˆ°æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨Swooleåç¨‹å®ç°WebRTCä¿¡ä»¤æœåŠ¡å™¨ç»“æŸã€‚é¡¹ç›®æºç å·²ä¸Šä¼ è‡³<u>https://github.com/shiguangqi/SwooleWebRTC</u>ã€‚</p><p style=text-align:justify>å¤‡æ³¨ï¼šå½“å‰ä¾‹å­è¿è¡Œç¯å¢ƒä¸º</p><ul><li>PHP 7.2.14 (cli)</li><li>Swoole v4.4.16</li><li>Darwin mbp 19.3.0 Darwin Kernel Version 19.3.0 å’Œ 18.04.1-Ubuntu</li></ul><p style=text-align:justify>è°¢è°¢ï¼Œæ¬¢è¿å„ä½è€å¸ˆæ‰¹è¯„æŒ‡æ­£ã€‚</p><p><strong>æˆ‘ä¸ºå¤§å®¶å‡†å¤‡äº†ä¸€ä»½ä¸­é«˜çº§çš„æ•™ç¨‹ç¦åˆ©ï¼åŠ©ä½ é‡‘ä¹é“¶åæ‹¿é«˜è–ªï¼</strong></p><div class=pgc-img><img alt="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/840bab9a77ea4321a33af8c9a593afcb><p class=pgc-img-caption></p></div><p style=text-align:start>ä½œä¸ºwebå¼€å‘çš„ä½¼ä½¼è€…PHPå¹¶ä¸é€Šè‰²å…¶ä»–è¯­è¨€ï¼ŒåŠ ä¸Šswooleåæ›´åŠ æ˜¯å¦‚è™æ·»ç¿¼ï¼è¿›å†›é€šä¿¡ ã€ç‰©è”ç½‘è¡Œä¸šå¼€å‘ç™¾åº¦åœ°å›¾ã€ç™¾åº¦è®¢å•ä¸­å¿ƒç­‰ï¼å¹´åæ›´æ˜¯éœ¸å ç¨‹åºå‘˜æ‹›è˜è¯­è¨€ç¬¬äºŒåï¼Œå¯’å†¬è£å‘˜æœŸè¿‡åæ­£æ˜¯å„å¤§ä¼ä¸šæ‰©å¤§æ‹›äººçš„æ—¶æœŸï¼Œç°åœ¨å¸‚åœºåˆçº§ç¨‹åºå‘˜æ³›æ»¥ï¼Œè¿›é˜¶ä¸­é«˜çº§ç¨‹åºå‘˜ç»å¯¹æ˜¯å„å¤§ä¼ä¸šæ€¥éœ€çš„äººæ‰ï¼Œè¿™å¥—æ•™ç¨‹é€‚åˆé‚£äº›1-6å¹´çš„PHPå¼€å‘è€…è¿›é˜¶ä¸­é«˜çº§æå‡è‡ªå·±ï¼Œåœ¨æ˜¥æ‹›ä¸­æ‰¾åˆ°é«˜è–ªèŒä½ï¼</p><h1 class=pgc-h-arrow-right>é¢†å–æ–¹å¼ï¼šç‚¹èµå…³æ³¨å°ç¼–åç§ä¿¡ã€èµ„æ–™ã€‘è·å–èµ„æ–™é¢†å–æ–¹å¼ï¼</h1><p style=text-align:start><strong>éƒ¨åˆ†èµ„æ–™å±•ç¤ºï¼š</strong></p><div class=pgc-img><img alt="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3a2ba8b852db4e2f9469340ac04a04c2><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f7856dd1858d41918f585a26e7cd9e14><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/553ad5576e0e492c9a29d8561a47752a><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b76200b4eb7442cb89d5671cbce551fa><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="ä½¿ç”¨Swooleåç¨‹å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2d44f35f64c245219c76eced46527ea5><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>é¢†å–æ–¹å¼ï¼šç‚¹èµå…³æ³¨å°ç¼–åç§ä¿¡ã€èµ„æ–™ã€‘è·å–èµ„æ–™é¢†å–æ–¹å¼ï¼</h1></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ä¿¡ä»¤','Swoole','åç¨‹'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>