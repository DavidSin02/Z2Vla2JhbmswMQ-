<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>é«˜å¹¶å‘ä¹‹APIæ¥å£ï¼Œåˆ†å¸ƒå¼ï¼Œé˜²åˆ·é™æµï¼Œå¦‚ä½•åšï¼Ÿ | æå®¢å¿«è¨Š</title><meta property="og:title" content="é«˜å¹¶å‘ä¹‹APIæ¥å£ï¼Œåˆ†å¸ƒå¼ï¼Œé˜²åˆ·é™æµï¼Œå¦‚ä½•åšï¼Ÿ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/72ef0f380abf4c6693d26afc863a1782"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/16e9e712.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/16e9e712.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/16e9e712.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/16e9e712.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/16e9e712.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/16e9e712.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/16e9e712.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/16e9e712.html><meta property="article:published_time" content="2020-11-14T21:04:37+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:37+08:00"><meta name=Keywords content><meta name=description content="é«˜å¹¶å‘ä¹‹APIæ¥å£ï¼Œåˆ†å¸ƒå¼ï¼Œé˜²åˆ·é™æµï¼Œå¦‚ä½•åšï¼Ÿ"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/16e9e712.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>é«˜å¹¶å‘ä¹‹APIæ¥å£ï¼Œåˆ†å¸ƒå¼ï¼Œé˜²åˆ·é™æµï¼Œå¦‚ä½•åšï¼Ÿ</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p>åœ¨å¼€å‘åˆ†å¸ƒå¼é«˜å¹¶å‘ç³»ç»Ÿæ—¶æœ‰ä¸‰æŠŠåˆ©å™¨ç”¨æ¥ä¿æŠ¤ç³»ç»Ÿï¼šç¼“å­˜ã€é™çº§ã€é™æµ</p><h3 class=pgc-h-arrow-right>ç¼“å­˜</h3><p>ç¼“å­˜çš„ç›®çš„æ˜¯æå‡ç³»ç»Ÿè®¿é—®é€Ÿåº¦å’Œå¢å¤§ç³»ç»Ÿå¤„ç†å®¹é‡</p><h3 class=pgc-h-arrow-right>é™çº§</h3><p>é™çº§æ˜¯å½“æœåŠ¡å‡ºç°é—®é¢˜æˆ–è€…å½±å“åˆ°æ ¸å¿ƒæµç¨‹æ—¶ï¼Œéœ€è¦æš‚æ—¶å±è”½æ‰ï¼Œå¾…é«˜å³°æˆ–è€…é—®é¢˜è§£å†³åå†æ‰“å¼€</p><h3 class=pgc-h-arrow-right>é™æµ</h3><p>é™æµçš„ç›®çš„æ˜¯é€šè¿‡å¯¹å¹¶å‘è®¿é—®/è¯·æ±‚è¿›è¡Œé™é€Ÿï¼Œæˆ–è€…å¯¹ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„è¯·æ±‚è¿›è¡Œé™é€Ÿæ¥ä¿æŠ¤ç³»ç»Ÿï¼Œä¸€æ—¦è¾¾åˆ°é™åˆ¶é€Ÿç‡åˆ™å¯ä»¥æ‹’ç»æœåŠ¡ã€æ’é˜Ÿæˆ–ç­‰å¾…ã€é™çº§ç­‰å¤„ç†</p><h3 class=pgc-h-arrow-right>é—®é¢˜æè¿°</h3><p><strong>1ã€</strong>æŸå¤©Aå›çªç„¶å‘ç°è‡ªå·±çš„æ¥å£è¯·æ±‚é‡çªç„¶æ¶¨åˆ°ä¹‹å‰çš„10å€ï¼Œæ²¡å¤šä¹…è¯¥æ¥å£å‡ ä¹ä¸å¯ä½¿ç”¨ï¼Œå¹¶å¼•å‘è¿é”ååº”å¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒã€‚å¦‚ä½•åº”å¯¹è¿™ç§æƒ…å†µå‘¢ï¼Ÿç”Ÿæ´»ç»™äº†æˆ‘ä»¬ç­”æ¡ˆï¼šæ¯”å¦‚è€å¼ç”µé—¸éƒ½å®‰è£…äº†ä¿é™©ä¸ï¼Œä¸€æ—¦æœ‰äººä½¿ç”¨è¶…å¤§åŠŸç‡çš„è®¾å¤‡ï¼Œä¿é™©ä¸å°±ä¼šçƒ§æ–­ä»¥ä¿æŠ¤å„ä¸ªç”µå™¨ä¸è¢«å¼ºç”µæµç»™çƒ§åã€‚åŒç†æˆ‘ä»¬çš„æ¥å£ä¹Ÿéœ€è¦å®‰è£…ä¸Šâ€œä¿é™©ä¸â€ï¼Œä»¥é˜²æ­¢éé¢„æœŸçš„è¯·æ±‚å¯¹ç³»ç»Ÿå‹åŠ›è¿‡å¤§è€Œå¼•èµ·çš„ç³»ç»Ÿç˜«ç—ªï¼Œå½“æµé‡è¿‡å¤§æ—¶ï¼Œå¯ä»¥é‡‡å–æ‹’ç»æˆ–è€…å¼•æµç­‰æœºåˆ¶ã€‚æ•´ç¼–ï¼šå¾®ä¿¡å…¬ä¼—å·ï¼Œæœäº‘åº“æŠ€æœ¯å›¢é˜Ÿï¼ŒIDï¼šsouyunku</p><p><strong>2ã€</strong>ç¼“å­˜çš„ç›®çš„æ˜¯æå‡ç³»ç»Ÿè®¿é—®é€Ÿåº¦å’Œå¢å¤§ç³»ç»Ÿèƒ½å¤„ç†çš„å®¹é‡ï¼Œå¯è°“æ˜¯æŠ—é«˜å¹¶å‘æµé‡çš„é“¶å¼¹ï¼›è€Œé™çº§æ˜¯å½“æœåŠ¡å‡ºé—®é¢˜æˆ–è€…å½±å“åˆ°æ ¸å¿ƒæµç¨‹çš„æ€§èƒ½åˆ™éœ€è¦æš‚æ—¶å±è”½æ‰ï¼Œå¾…é«˜å³°æˆ–è€…é—®é¢˜è§£å†³åå†æ‰“å¼€ï¼›è€Œæœ‰äº›åœºæ™¯å¹¶ä¸èƒ½ç”¨ç¼“å­˜å’Œé™çº§æ¥è§£å†³ï¼Œæ¯”å¦‚ç¨€ç¼ºèµ„æºï¼ˆç§’æ€ã€æŠ¢è´­ï¼‰ã€å†™æœåŠ¡ï¼ˆå¦‚è¯„è®ºã€ä¸‹å•ï¼‰ã€é¢‘ç¹çš„å¤æ‚æŸ¥è¯¢ï¼ˆè¯„è®ºçš„æœ€åå‡ é¡µï¼‰ï¼Œå› æ­¤éœ€æœ‰ä¸€ç§æ‰‹æ®µæ¥é™åˆ¶è¿™äº›åœºæ™¯çš„å¹¶å‘/è¯·æ±‚é‡ï¼Œå³é™æµã€‚</p><p><strong>3ã€</strong>ç³»ç»Ÿåœ¨è®¾è®¡ä¹‹åˆå°±ä¼šæœ‰ä¸€ä¸ªé¢„ä¼°å®¹é‡ï¼Œé•¿æ—¶é—´è¶…è¿‡ç³»ç»Ÿèƒ½æ‰¿å—çš„TPS/QPSé˜ˆå€¼ï¼Œç³»ç»Ÿå¯èƒ½ä¼šè¢«å‹å®ï¼Œæœ€ç»ˆå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¤Ÿç”¨ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹æ¥å£è¯·æ±‚è¿›è¡Œé™æµã€‚</p><p><strong>4ã€</strong>é™æµçš„ç›®çš„æ˜¯é€šè¿‡å¯¹å¹¶å‘è®¿é—®è¯·æ±‚è¿›è¡Œé™é€Ÿæˆ–è€…ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„çš„è¯·æ±‚æ•°é‡è¿›è¡Œé™é€Ÿæ¥ä¿æŠ¤ç³»ç»Ÿï¼Œä¸€æ—¦è¾¾åˆ°é™åˆ¶é€Ÿç‡åˆ™å¯ä»¥æ‹’ç»æœåŠ¡ã€æ’é˜Ÿæˆ–ç­‰å¾…ã€‚</p><p><strong>5ã€</strong>ä¸€èˆ¬å¼€å‘é«˜å¹¶å‘ç³»ç»Ÿå¸¸è§çš„é™æµæ¨¡å¼æœ‰æ§åˆ¶å¹¶å‘å’Œæ§åˆ¶é€Ÿç‡ï¼Œä¸€ä¸ªæ˜¯é™åˆ¶å¹¶å‘çš„æ€»æ•°é‡ï¼ˆæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± ã€çº¿ç¨‹æ± ï¼‰ï¼Œä¸€ä¸ªæ˜¯é™åˆ¶å¹¶å‘è®¿é—®çš„é€Ÿç‡ï¼ˆå¦‚nginxçš„limitconnæ¨¡å—ï¼Œç”¨æ¥é™åˆ¶ç¬æ—¶å¹¶å‘è¿æ¥æ•°ï¼‰ï¼Œå¦å¤–è¿˜å¯ä»¥é™åˆ¶å•ä½æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ•°é‡ï¼ˆå¦‚Guavaçš„RateLimiterã€nginxçš„limitreqæ¨¡å—ï¼Œé™åˆ¶æ¯ç§’çš„å¹³å‡é€Ÿç‡ï¼‰ã€‚å…¶ä»–è¿˜æœ‰å¦‚é™åˆ¶è¿œç¨‹æ¥å£è°ƒç”¨é€Ÿç‡ã€é™åˆ¶MQçš„æ¶ˆè´¹é€Ÿç‡ã€‚å¦å¤–è¿˜å¯ä»¥æ ¹æ®ç½‘ç»œè¿æ¥æ•°ã€ç½‘ç»œæµé‡ã€CPUæˆ–å†…å­˜è´Ÿè½½ç­‰æ¥é™æµã€‚</p><h2 class=pgc-h-arrow-right>ç›¸å…³æ¦‚å¿µï¼š</h2><h3 class=pgc-h-arrow-right>PV:</h3><p>page view é¡µé¢æ€»è®¿é—®é‡ï¼Œæ¯åˆ·æ–°ä¸€æ¬¡è®°å½•ä¸€æ¬¡ã€‚</p><h3 class=pgc-h-arrow-right>UV:</h3><p>unique view å®¢æˆ·ç«¯ä¸»æœºè®¿é—®ï¼ŒæŒ‡ä¸€å¤©å†…ç›¸åŒIPçš„è®¿é—®è®°ä¸º1æ¬¡ã€‚</p><h3 class=pgc-h-arrow-right>QPS:</h3><p>query per second,å³æ¯ç§’è®¿é—®é‡ã€‚qpså¾ˆå¤§ç¨‹åº¦ä¸Šä»£è¡¨äº†ç³»ç»Ÿçš„ç¹å¿™åº¦ï¼Œæ²¡æ¬¡è¯·æ±‚å¯èƒ½å­˜åœ¨å¤šæ¬¡çš„ç£ç›˜ioï¼Œç½‘ç»œè¯·æ±‚ï¼Œå¤šä¸ªcpuæ—¶é—´ç‰‡ï¼Œä¸€æ—¦qpsè¶…è¿‡äº†é¢„å…ˆè®¾ç½®çš„é˜€å€¼ï¼Œå¯ä»¥è€ƒé‡æ‰©å®¹å¢åŠ æœåŠ¡å™¨ï¼Œé¿å…è®¿é—®é‡è¿‡å¤§å¯¼è‡´çš„å®•æœºã€‚æ•´ç¼–ï¼šå¾®ä¿¡å…¬ä¼—å·ï¼Œæœäº‘åº“æŠ€æœ¯å›¢é˜Ÿï¼ŒIDï¼šsouyunku</p><h3 class=pgc-h-arrow-right>RT:</h3><p>response time,æ¯æ¬¡è¯·æ±‚çš„å“åº”æ—¶é—´,ç›´æ¥å†³å®šç”¨æˆ·ä½“éªŒæ€§ã€‚</p><p>æœ¬æ–‡ä¸»è¦ä»‹ç»åº”ç”¨çº§é™æµæ–¹æ³•ï¼Œåˆ†å¸ƒå¼é™æµã€æµé‡å…¥å£é™æµï¼ˆæ¥å…¥å±‚å¦‚NGINX limitconnå’Œlimitreq æ¨¡å—ï¼‰ã€‚</p><h2 class=pgc-h-arrow-right>åº”ç”¨çº§é™æµ</h2><h3 class=pgc-h-arrow-right>ä¸€ã€æ§åˆ¶å¹¶å‘æ•°é‡</h3><p>å±äºä¸€ç§è¾ƒå¸¸è§çš„é™æµæ‰‹æ®µï¼Œåœ¨å®é™…åº”ç”¨ä¸­å¯ä»¥é€šè¿‡ä¿¡å·é‡æœºåˆ¶ï¼ˆå¦‚Javaä¸­çš„Semaphoreï¼‰æ¥å®ç°ã€‚æ“ä½œç³»ç»Ÿçš„ä¿¡å·é‡æ˜¯ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼ŒJava å¹¶å‘åº“ çš„Semaphore å¯ä»¥å¾ˆè½»æ¾å®Œæˆä¿¡å·é‡æ§åˆ¶ï¼ŒSemaphoreå¯ä»¥æ§åˆ¶æŸä¸ªèµ„æºå¯è¢«åŒæ—¶è®¿é—®çš„ä¸ªæ•°ï¼Œé€šè¿‡ acquire() è·å–ä¸€ä¸ªè®¸å¯ï¼Œå¦‚æœæ²¡æœ‰å°±ç­‰å¾…ï¼Œè€Œ release() é‡Šæ”¾ä¸€ä¸ªè®¸å¯ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯¹å¤–æä¾›ä¸€ä¸ªæœåŠ¡æ¥å£ï¼Œå…è®¸æœ€å¤§å¹¶å‘æ•°ä¸º10ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š</p><pre><code>public class DubboService {    private final Semaphore permit = new Semaphore(10, true);    public void process(){        try{            permit.acquire();            //ä¸šåŠ¡é€»è¾‘å¤„ç†        } catch (InterruptedException e) {            e.printStackTrace();        } finally {            permit.release();        }    }}</code></pre><p>åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œè™½ç„¶æœ‰30ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œä½†æ˜¯åªå…è®¸10ä¸ªå¹¶å‘çš„æ‰§è¡Œã€‚Semaphoreçš„æ„é€ æ–¹æ³•Semaphore(int permits) æ¥å—ä¸€ä¸ªæ•´å‹çš„æ•°å­—ï¼Œè¡¨ç¤ºå¯ç”¨çš„è®¸å¯è¯æ•°é‡ã€‚Semaphore(10)è¡¨ç¤ºå…è®¸10ä¸ªçº¿ç¨‹è·å–è®¸å¯è¯ï¼Œä¹Ÿå°±æ˜¯æœ€å¤§å¹¶å‘æ•°æ˜¯10ã€‚Semaphoreçš„ç”¨æ³•ä¹Ÿå¾ˆç®€å•ï¼Œé¦–å…ˆçº¿ç¨‹ä½¿ç”¨Semaphoreçš„acquire()è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œä½¿ç”¨å®Œä¹‹åè°ƒç”¨release()å½’è¿˜è®¸å¯è¯ï¼Œè¿˜å¯ä»¥ç”¨tryAcquire()æ–¹æ³•å°è¯•è·å–è®¸å¯è¯ï¼Œä¿¡å·é‡çš„æœ¬è´¨æ˜¯æ§åˆ¶æŸä¸ªèµ„æºå¯è¢«åŒæ—¶è®¿é—®çš„ä¸ªæ•°ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æ§åˆ¶æŸèµ„æºçš„è®¿é—®é¢‘ç‡ï¼Œä½†ä¸èƒ½ç²¾ç¡®æ§åˆ¶ï¼Œæ§åˆ¶è®¿é—®é¢‘ç‡çš„æ¨¡å¼è§ä¸‹æ–‡æè¿°ã€‚</p><h3 class=pgc-h-arrow-right>äºŒã€æ§åˆ¶è®¿é—®é€Ÿç‡</h3><p>åœ¨å·¥ç¨‹å®è·µä¸­ï¼Œå¸¸è§çš„æ˜¯ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•æ¥å®ç°è¿™ç§æ¨¡å¼ï¼Œå¸¸ç”¨çš„é™æµç®—æ³•æœ‰ä¸¤ç§ï¼šæ¼æ¡¶ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•ã€‚</p><h3 class=pgc-h-arrow-right>æ¼æ¡¶ç®—æ³•</h3><p>æ¼æ¡¶ç®—æ³•æ€è·¯å¾ˆç®€å•ï¼Œæ°´ï¼ˆè¯·æ±‚ï¼‰å…ˆè¿›å…¥åˆ°æ¼æ¡¶é‡Œï¼Œæ¼æ¡¶ä»¥ä¸€å®šçš„é€Ÿåº¦å‡ºæ°´ï¼Œå½“æ°´æµå…¥é€Ÿåº¦è¿‡å¤§ä¼šç›´æ¥æº¢å‡ºï¼Œå¯ä»¥çœ‹å‡ºæ¼æ¡¶ç®—æ³•èƒ½å¼ºè¡Œé™åˆ¶æ•°æ®çš„ä¼ è¾“é€Ÿç‡ã€‚</p><div class=pgc-img><img alt=é«˜å¹¶å‘ä¹‹APIæ¥å£ï¼Œåˆ†å¸ƒå¼ï¼Œé˜²åˆ·é™æµï¼Œå¦‚ä½•åšï¼Ÿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/72ef0f380abf4c6693d26afc863a1782><p class=pgc-img-caption></p></div><p>å¯¹äºå¾ˆå¤šåº”ç”¨åœºæ™¯æ¥è¯´ï¼Œé™¤äº†è¦æ±‚èƒ½å¤Ÿé™åˆ¶æ•°æ®çš„å¹³å‡ä¼ è¾“é€Ÿç‡å¤–ï¼Œè¿˜è¦æ±‚å…è®¸æŸç§ç¨‹åº¦çš„çªå‘ä¼ è¾“ã€‚è¿™æ—¶å€™æ¼æ¡¶ç®—æ³•å¯èƒ½å°±ä¸åˆé€‚äº†ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•æ›´ä¸ºé€‚åˆã€‚</p><h3 class=pgc-h-arrow-right>ä»¤ç‰Œæ¡¶ç®—æ³•</h3><p>å¦‚å›¾æ‰€ç¤ºï¼Œä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸç†æ˜¯ç³»ç»Ÿä¼šä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿåº¦å¾€æ¡¶é‡Œæ”¾å…¥ä»¤ç‰Œï¼Œè€Œå¦‚æœè¯·æ±‚éœ€è¦è¢«å¤„ç†ï¼Œåˆ™éœ€è¦å…ˆä»æ¡¶é‡Œè·å–ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æ¡¶é‡Œæ²¡æœ‰ä»¤ç‰Œå¯å–æ—¶ï¼Œåˆ™æ‹’ç»æœåŠ¡ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•é€šè¿‡å‘æ”¾ä»¤ç‰Œï¼Œæ ¹æ®ä»¤ç‰Œçš„rateé¢‘ç‡åšè¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œå®¹é‡é™åˆ¶ç­‰ã€‚æ•´ç¼–ï¼šå¾®ä¿¡å…¬ä¼—å·ï¼Œæœäº‘åº“æŠ€æœ¯å›¢é˜Ÿï¼ŒIDï¼šsouyunku</p><div class=pgc-img><img alt=é«˜å¹¶å‘ä¹‹APIæ¥å£ï¼Œåˆ†å¸ƒå¼ï¼Œé˜²åˆ·é™æµï¼Œå¦‚ä½•åšï¼Ÿ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/95c698a90b3e44f688b87d29d568efce><p class=pgc-img-caption></p></div><h3 class=pgc-h-arrow-right>åœ¨Wikipediaä¸Šï¼Œä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯è¿™ä¹ˆæè¿°çš„ï¼š</h3><p><strong>1ã€</strong>æ¯è¿‡1/rç§’æ¡¶ä¸­å¢åŠ ä¸€ä¸ªä»¤ç‰Œã€‚</p><p><strong>2ã€</strong>æ¡¶ä¸­æœ€å¤šå­˜æ”¾bä¸ªä»¤ç‰Œï¼Œå¦‚æœæ¡¶æ»¡äº†ï¼Œæ–°æ”¾å…¥çš„ä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒã€‚</p><p><strong>3ã€</strong>å½“ä¸€ä¸ªnå­—èŠ‚çš„æ•°æ®åŒ…åˆ°è¾¾æ—¶ï¼Œæ¶ˆè€—nä¸ªä»¤ç‰Œï¼Œç„¶åå‘é€è¯¥æ•°æ®åŒ…ã€‚</p><p><strong>4ã€</strong>å¦‚æœæ¡¶ä¸­å¯ç”¨ä»¤ç‰Œå°äºnï¼Œåˆ™è¯¥æ•°æ®åŒ…å°†è¢«ç¼“å­˜æˆ–ä¸¢å¼ƒã€‚</p><p>ä»¤ç‰Œæ¡¶æ§åˆ¶çš„æ˜¯ä¸€ä¸ªæ—¶é—´çª—å£å†…é€šè¿‡çš„æ•°æ®é‡ï¼Œåœ¨APIå±‚é¢æˆ‘ä»¬å¸¸è¯´çš„QPSã€TPSï¼Œæ­£å¥½æ˜¯ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„è¯·æ±‚é‡æˆ–è€…äº‹åŠ¡é‡ï¼Œåªä¸è¿‡æ—¶é—´çª—å£é™å®šåœ¨1sç½¢äº†ã€‚ä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿåº¦å¾€æ¡¶é‡Œæ”¾å…¥ä»¤ç‰Œï¼Œè€Œå¦‚æœè¯·æ±‚éœ€è¦è¢«å¤„ç†ï¼Œåˆ™éœ€è¦å…ˆä»æ¡¶é‡Œè·å–ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æ¡¶é‡Œæ²¡æœ‰ä»¤ç‰Œå¯å–æ—¶ï¼Œåˆ™æ‹’ç»æœåŠ¡ã€‚ä»¤ç‰Œæ¡¶çš„å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯å¯ä»¥æ–¹ä¾¿çš„æ”¹å˜é€Ÿåº¦ï¼Œä¸€æ—¦éœ€è¦æé«˜é€Ÿç‡ï¼Œåˆ™æŒ‰éœ€æé«˜æ”¾å…¥æ¡¶ä¸­çš„ä»¤ç‰Œçš„é€Ÿç‡ã€‚</p><p>åœ¨æˆ‘ä»¬çš„å·¥ç¨‹å®è·µä¸­ï¼Œé€šå¸¸ä½¿ç”¨Googleå¼€æºå·¥å…·åŒ…Guavaæä¾›çš„é™æµå·¥å…·ç±»RateLimiteræ¥å®ç°æ§åˆ¶é€Ÿç‡ï¼Œè¯¥ç±»åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•æ¥å®Œæˆé™æµï¼Œéå¸¸æ˜“äºä½¿ç”¨ï¼Œè€Œä¸”éå¸¸é«˜æ•ˆã€‚å¦‚æˆ‘ä»¬ä¸å¸Œæœ›æ¯ç§’çš„ä»»åŠ¡æäº¤è¶…è¿‡1ä¸ª</p><pre><code>public static void main(String[] args) {    String start = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());    RateLimiter limiter = RateLimiter.create(1.0); // è¿™é‡Œçš„1è¡¨ç¤ºæ¯ç§’å…è®¸å¤„ç†çš„é‡ä¸º1ä¸ª    for (int i = 1; i &lt;= 10; i++) {        double waitTime = limiter.acquire(i); // è¯·æ±‚RateLimiter, è¶…è¿‡permitsä¼šè¢«é˜»å¡        System.out.println("cutTime=" + System.currentTimeMillis() + " call execute:" + i + " waitTime:" + waitTime);    }    String end = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());    System.out.println("start time:" + start);    System.out.println("end time:" + end);}</code></pre><p>é¦–å…ˆé€šè¿‡RateLimiter.create(1.0);åˆ›å»ºä¸€ä¸ªé™æµå™¨ï¼Œå‚æ•°ä»£è¡¨æ¯ç§’ç”Ÿæˆçš„ä»¤ç‰Œæ•°ï¼Œé€šè¿‡limiter.acquire(i);æ¥ä»¥é˜»å¡çš„æ–¹å¼è·å–ä»¤ç‰Œï¼Œä»¤ç‰Œæ¡¶ç®—æ³•å…è®¸ä¸€å®šç¨‹åº¦çš„çªå‘ï¼ˆå…è®¸æ¶ˆè´¹æœªæ¥çš„ä»¤ç‰Œï¼‰ï¼Œæ‰€ä»¥å¯ä»¥ä¸€æ¬¡æ€§æ¶ˆè´¹iä¸ªä»¤ç‰Œï¼›å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡tryAcquire(int permits, long timeout, TimeUnit unit)æ¥è®¾ç½®ç­‰å¾…è¶…æ—¶æ—¶é—´çš„æ–¹å¼è·å–ä»¤ç‰Œï¼Œå¦‚æœè¶…timeoutä¸º0ï¼Œåˆ™ä»£è¡¨éé˜»å¡ï¼Œè·å–ä¸åˆ°ç«‹å³è¿”å›ï¼Œæ”¯æŒé˜»å¡æˆ–å¯è¶…æ—¶çš„ä»¤ç‰Œæ¶ˆè´¹ã€‚</p><p>ä»è¾“å‡ºæ¥çœ‹ï¼ŒRateLimiteræ”¯æŒé¢„æ¶ˆè´¹ï¼Œæ¯”å¦‚åœ¨acquire(5)æ—¶ï¼Œç­‰å¾…æ—¶é—´æ˜¯4ç§’ï¼Œæ˜¯ä¸Šä¸€ä¸ªè·å–ä»¤ç‰Œæ—¶é¢„æ¶ˆè´¹äº†3ä¸ªä¸¤æ’ï¼Œå›ºéœ€è¦ç­‰å¾…3*1ç§’ï¼Œç„¶ååˆé¢„æ¶ˆè´¹äº†5ä¸ªä»¤ç‰Œï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p><strong>RateLimiteré€šè¿‡é™åˆ¶åé¢è¯·æ±‚çš„ç­‰å¾…æ—¶é—´ï¼Œæ¥æ”¯æŒä¸€å®šç¨‹åº¦çš„çªå‘è¯·æ±‚(é¢„æ¶ˆè´¹</strong>)ï¼Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„è¿™ä¸€ç‚¹ï¼ŒGuavaæœ‰ä¸¤ç§é™æµæ¨¡å¼ï¼Œä¸€ç§ä¸ºç¨³å®šæ¨¡å¼(SmoothBursty:ä»¤ç‰Œç”Ÿæˆé€Ÿåº¦æ’å®šï¼Œå¹³æ»‘çªå‘é™æµ)ï¼Œä¸€ç§ä¸ºæ¸è¿›æ¨¡å¼(SmoothWarmingUp:ä»¤ç‰Œç”Ÿæˆé€Ÿåº¦ç¼“æ…¢æå‡ç›´åˆ°ç»´æŒåœ¨ä¸€ä¸ªç¨³å®šå€¼ï¼Œå¹³æ»‘é¢„çƒ­é™æµ) ä¸¤ç§æ¨¡å¼å®ç°æ€è·¯ç±»ä¼¼ï¼Œä¸»è¦åŒºåˆ«åœ¨ç­‰å¾…æ—¶é—´çš„è®¡ç®—ä¸Šã€‚</p><h3 class=pgc-h-arrow-right>SmoothBursty æ¨¡å¼ï¼š</h3><p>RateLimiter limiter = RateLimiter.create(5); RateLimiter.create(5)è¡¨ç¤ºæ¡¶å®¹é‡ä¸º5ä¸”æ¯ç§’æ–°å¢5ä¸ªä»¤ç‰Œï¼Œå³æ¯éš”200æ¯«ç§’æ–°å¢ä¸€ä¸ªä»¤ç‰Œï¼›limiter.acquire()è¡¨ç¤ºæ¶ˆè´¹ä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœå½“å‰æ¡¶ä¸­æœ‰è¶³å¤Ÿä»¤ç‰Œåˆ™æˆåŠŸï¼ˆè¿”å›å€¼ä¸º0ï¼‰ï¼Œå¦‚æœæ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œåˆ™æš‚åœä¸€æ®µæ—¶é—´ï¼Œæ¯”å¦‚å‘ä»¤ç‰Œé—´éš”æ˜¯200æ¯«ç§’ï¼Œåˆ™ç­‰å¾…200æ¯«ç§’åå†å»æ¶ˆè´¹ä»¤ç‰Œï¼Œè¿™ç§å®ç°å°†çªå‘è¯·æ±‚é€Ÿç‡å¹³å‡ä¸ºäº†å›ºå®šè¯·æ±‚é€Ÿç‡ã€‚</p><h3 class=pgc-h-arrow-right>SmoothWarmingUpæ¨¡å¼ï¼š</h3><p>RateLimiter limiter = RateLimiter.create(5,1000, TimeUnit.MILLISECONDS);</p><h3 class=pgc-h-arrow-right>åˆ›å»ºæ–¹å¼ï¼š</h3><p><strong>RateLimiter.create(doublepermitsPerSecond, long warmupPeriod, TimeUnit unit)ï¼ŒpermitsPerSecondè¡¨ç¤ºæ¯ç§’æ–°å¢çš„ä»¤ç‰Œæ•°ï¼Œ</strong>warmupPeriodè¡¨ç¤ºåœ¨ä»å†·å¯åŠ¨é€Ÿç‡è¿‡æ¸¡åˆ°å¹³å‡é€Ÿç‡çš„æ—¶é—´é—´éš”ã€‚é€Ÿç‡æ˜¯æ¢¯å½¢ä¸Šå‡é€Ÿç‡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å†·å¯åŠ¨æ—¶ä¼šä»¥ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é€Ÿç‡æ…¢æ…¢åˆ°å¹³å‡é€Ÿç‡ï¼›ç„¶åè¶‹äºå¹³å‡é€Ÿç‡ï¼ˆæ¢¯å½¢ä¸‹é™åˆ°å¹³å‡é€Ÿç‡ï¼‰ã€‚å¯ä»¥é€šè¿‡è°ƒèŠ‚warmupPeriodå‚æ•°å®ç°ä¸€å¼€å§‹å°±æ˜¯å¹³æ»‘å›ºå®šé€Ÿç‡ã€‚æ•´ç¼–ï¼šå¾®ä¿¡å…¬ä¼—å·ï¼Œæœäº‘åº“æŠ€æœ¯å›¢é˜Ÿï¼ŒIDï¼šsouyunku</p><h3 class=pgc-h-arrow-right>æ”¾åœ¨Controllerä¸­ç”¨Jemterå‹æµ‹</h3><div class=pgc-img><img alt=é«˜å¹¶å‘ä¹‹APIæ¥å£ï¼Œåˆ†å¸ƒå¼ï¼Œé˜²åˆ·é™æµï¼Œå¦‚ä½•åšï¼Ÿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/87bc89502ca74351af14886b576b1ae4><p class=pgc-img-caption></p></div><p>æ³¨ï¼šRateLimiteræ§åˆ¶çš„æ˜¯é€Ÿç‡ï¼ŒSamephoreæ§åˆ¶çš„æ˜¯å¹¶å‘é‡ã€‚RateLimiterçš„åŸç†å°±æ˜¯ä»¤ç‰Œæ¡¶ï¼Œå®ƒä¸»è¦ç”±è®¸å¯å‘å‡ºçš„é€Ÿç‡æ¥å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰é¢å¤–çš„é…ç½®ï¼Œè®¸å¯è¯å°†æŒ‰æ¯ç§’è®¸å¯è¯è§„å®šçš„å›ºå®šé€Ÿåº¦åˆ†é…ï¼Œè®¸å¯å°†è¢«å¹³æ»‘åœ°åˆ†å‘ï¼Œè‹¥è¯·æ±‚è¶…è¿‡permitsPerSecondåˆ™RateLimiteræŒ‰ç…§æ¯ç§’ 1/permitsPerSecond çš„é€Ÿç‡é‡Šæ”¾è®¸å¯ã€‚æ³¨æ„:RateLimiteré€‚ç”¨æ–¼å•ä½“åº”ç”¨ï¼Œä¸”RateLimiterä¸ä¿è¯å…¬å¹³æ€§è®¿é—®ã€‚</p><p>ä½¿ç”¨ä¸Šè¿°æ–¹å¼ä½¿ç”¨RateLimiterçš„æ–¹å¼ä¸å¤Ÿä¼˜é›…ï¼Œè‡ªå®šä¹‰æ³¨è§£+AOPçš„æ–¹å¼å®ç°(é€‚ç”¨æ–¼å•ä½“åº”ç”¨)ï¼Œè¯¦ç»†è§ä¸‹é¢ä»£ç ï¼š</p><h3 class=pgc-h-arrow-right>è‡ªå®šä¹‰æ³¨è§£ï¼š</h3><pre><code>import java.lang.annotation.*;/** * è‡ªå®šä¹‰æ³¨è§£å¯ä»¥ä¸åŒ…å«å±æ€§ï¼Œæˆä¸ºä¸€ä¸ªæ ‡è¯†æ³¨è§£ */@Inherited@Documented@Target({ElementType.METHOD, ElementType.FIELD, ElementType.TYPE})@Retention(RetentionPolicy.RUNTIME)public @interface RateLimitAspect {}</code></pre><h3 class=pgc-h-arrow-right>è‡ªå®šä¹‰åˆ‡é¢ç±»</h3><pre><code>import com.google.common.util.concurrent.RateLimiter;import com.test.cn.springbootdemo.util.ResultUtil;import net.sf.json.JSONObject;import org.aspectj.lang.ProceedingJoinPoint;import org.aspectj.lang.annotation.Around;import org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.Pointcut;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Scope;import org.springframework.stereotype.Component;import javax.servlet.ServletOutputStream;import javax.servlet.http.HttpServletResponse;import java.io.IOException;@Component@Scope@Aspectpublic class RateLimitAop {    @Autowired    private HttpServletResponse response;    private RateLimiter rateLimiter = RateLimiter.create(5.0); //æ¯”å¦‚è¯´ï¼Œæˆ‘è¿™é‡Œè®¾ç½®"å¹¶å‘æ•°"ä¸º5    @Pointcut("@annotation(com.test.cn.springbootdemo.aspect.RateLimitAspect)")    public void serviceLimit() {    }    @Around("serviceLimit()")    public Object around(ProceedingJoinPoint joinPoint) {        Boolean flag = rateLimiter.tryAcquire();        Object obj = null;        try {            if (flag) {                obj = joinPoint.proceed();            }else{                String result = JSONObject.fromObject(ResultUtil.success1(100, "failure")).toString();                output(response, result);            }        } catch (Throwable e) {            e.printStackTrace();        }        System.out.println("flag=" + flag + ",obj=" + obj);        return obj;    }    public void output(HttpServletResponse response, String msg) throws IOException {        response.setContentType("application/json;charset=UTF-8");        ServletOutputStream outputStream = null;        try {            outputStream = response.getOutputStream();            outputStream.write(msg.getBytes("UTF-8"));        } catch (IOException e) {            e.printStackTrace();        } finally {            outputStream.flush();            outputStream.close();        }    }}</code></pre><h3 class=pgc-h-arrow-right>æµ‹è¯•controller</h3><pre><code>import com.test.cn.springbootdemo.aspect.RateLimitAspect;import com.test.cn.springbootdemo.util.ResultUtil;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.ResponseBody;@Controllerpublic class TestController {    @ResponseBody    @RateLimitAspect    @RequestMapping("/test")    public String test(){        return ResultUtil.success1(1001, "success").toString();    }</code></pre><h3 class=pgc-h-arrow-right>å‹æµ‹ç»“æœï¼š</h3><div class=pgc-img><img alt=é«˜å¹¶å‘ä¹‹APIæ¥å£ï¼Œåˆ†å¸ƒå¼ï¼Œé˜²åˆ·é™æµï¼Œå¦‚ä½•åšï¼Ÿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/56355c9bd23f4860aa771a1aaff34dfa><p class=pgc-img-caption></p></div><h3 class=pgc-h-arrow-right>ä¸‰ã€æ§åˆ¶å•ä½æ—¶é—´çª—å£å†…è¯·æ±‚æ•°</h3><p>æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬æƒ³é™åˆ¶æŸä¸ªæ¥å£æˆ–æœåŠ¡ æ¯ç§’/æ¯åˆ†é’Ÿ/æ¯å¤© çš„è¯·æ±‚æ¬¡æ•°æˆ–è°ƒç”¨æ¬¡æ•°ã€‚ä¾‹å¦‚é™åˆ¶æœåŠ¡æ¯ç§’çš„è°ƒç”¨æ¬¡æ•°ä¸º50ï¼Œå®ç°å¦‚ä¸‹ï¼š</p><pre><code>private LoadingCache &lt; Long, AtomicLong &gt; counter = CacheBuilder.newBuilder().expireAfterWrite(2, TimeUnit.SECONDS).build(new CacheLoader &lt; Long, AtomicLong &gt; () {@    Override    public AtomicLong load(Long seconds) throws Exception {        return new AtomicLong(0);    }});public static long permit = 50;public ResponseEntity getData() throws ExecutionException {    //å¾—åˆ°å½“å‰ç§’    long currentSeconds = System.currentTimeMillis() / 1000;    if (counter.get(currentSeconds).incrementAndGet() &gt; permit) {        return ResponseEntity.builder().code(404).msg("è®¿é—®é€Ÿç‡è¿‡å¿«").build();    }    //ä¸šåŠ¡å¤„ç†}</code></pre><p>åˆ°æ­¤åº”ç”¨çº§é™æµçš„ä¸€äº›æ–¹æ³•å°±ä»‹ç»å®Œäº†ã€‚å‡è®¾å°†åº”ç”¨éƒ¨ç½²åˆ°å¤šå°æœºå™¨ï¼Œåº”ç”¨çº§é™æµæ–¹å¼åªæ˜¯å•åº”ç”¨å†…çš„è¯·æ±‚é™æµï¼Œä¸èƒ½è¿›è¡Œå…¨å±€é™æµã€‚å› æ­¤æˆ‘ä»¬éœ€è¦åˆ†å¸ƒå¼é™æµå’Œæ¥å…¥å±‚é™æµæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h2 class=pgc-h-arrow-right>åˆ†å¸ƒå¼é™æµ</h2><p><strong>è‡ªå®šä¹‰æ³¨è§£+æ‹¦æˆªå™¨+Rediså®ç°é™æµ (å•ä½“å’Œåˆ†å¸ƒå¼å‡é€‚ç”¨ï¼Œå…¨å±€é™æµ)</strong></p><h3 class=pgc-h-arrow-right>è‡ªå®šä¹‰æ³¨è§£ï¼š</h3><pre><code>@Inherited@Documented@Target({ElementType.FIELD,ElementType.TYPE,ElementType.METHOD})@Retention(RetentionPolicy.RUNTIME)public @interface AccessLimit {    int limit() default 5;      int sec() default 5;}</code></pre><h3 class=pgc-h-arrow-right>æ‹¦æˆªå™¨ï¼š</h3><pre><code>public class AccessLimitInterceptor implements HandlerInterceptor {    @Autowired    private RedisTemplate&lt;String, Integer&gt; redisTemplate;  //ä½¿ç”¨RedisTemplateæ“ä½œredis    @Override    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {        if (handler instanceof HandlerMethod) {            HandlerMethod handlerMethod = (HandlerMethod) handler;            Method method = handlerMethod.getMethod();            if (!method.isAnnotationPresent(AccessLimit.class)) {                return true;            }            AccessLimit accessLimit = method.getAnnotation(AccessLimit.class);            if (accessLimit == null) {                return true;            }            int limit = accessLimit.limit();            int sec = accessLimit.sec();            String key = IPUtil.getIpAddr(request) + request.getRequestURI();            Integer maxLimit = redisTemplate.opsForValue().get(key);            if (maxLimit == null) {                redisTemplate.opsForValue().set(key, 1, sec, TimeUnit.SECONDS);  //setæ—¶ä¸€å®šè¦åŠ è¿‡æœŸæ—¶é—´            } else if (maxLimit &lt; limit) {                redisTemplate.opsForValue().set(key, maxLimit + 1, sec, TimeUnit.SECONDS);            } else {                output(response, "è¯·æ±‚å¤ªé¢‘ç¹!");                return false;            }        }        return true;    }    public void output(HttpServletResponse response, String msg) throws IOException {        response.setContentType("application/json;charset=UTF-8");        ServletOutputStream outputStream = null;        try {            outputStream = response.getOutputStream();            outputStream.write(msg.getBytes("UTF-8"));        } catch (IOException e) {            e.printStackTrace();        } finally {            outputStream.flush();            outputStream.close();        }    }    @Override    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {    }    @Override    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {    }}</code></pre><h3 class=pgc-h-arrow-right>controller:</h3><pre><code>@Controller@RequestMapping("/activity")public class AopController {    @ResponseBody    @RequestMapping("/seckill")    @AccessLimit(limit = 4,sec = 10)  //åŠ ä¸Šè‡ªå®šä¹‰æ³¨è§£å³å¯    public String test (HttpServletRequest request,@RequestParam(value = "username",required = false) String userName){        //TODO somethingsâ€¦â€¦        return   "hello world !";    }}</code></pre><h3 class=pgc-h-arrow-right>é…ç½®æ–‡ä»¶ï¼š</h3><pre><code>/*springmvcçš„é…ç½®æ–‡ä»¶ä¸­åŠ å…¥è‡ªå®šä¹‰æ‹¦æˆªå™¨*/&lt;mvc:interceptors&gt;   &lt;mvc:interceptor&gt;      &lt;mvc:mapping path="/**"/&gt;      &lt;bean class="com.pptv.activityapi.controller.pointsmall.AccessLimitInterceptor"/&gt;   &lt;/mvc:interceptor&gt;&lt;/mvc:interceptors&gt;</code></pre><p>è®¿é—®æ•ˆæœå¦‚ä¸‹ï¼Œ10så†…è®¿é—®æ¥å£è¶…è¿‡4æ¬¡ä»¥ä¸Šå°±è¿‡æ»¤è¯·æ±‚ï¼ŒåŸç†å’Œè®¡æ•°å™¨ç®—æ³•ç±»ä¼¼ï¼š</p><div class=pgc-img><img alt=é«˜å¹¶å‘ä¹‹APIæ¥å£ï¼Œåˆ†å¸ƒå¼ï¼Œé˜²åˆ·é™æµï¼Œå¦‚ä½•åšï¼Ÿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/30a03c505d154a2b981658d94c6523ed><p class=pgc-img-caption></p></div><h2 class=pgc-h-arrow-right>æ¥å…¥å±‚é™æµ</h2><p><strong>ä¸»è¦ä»‹ç»nginx é™æµï¼Œé‡‡ç”¨æ¼æ¡¶ç®—æ³•ã€‚</strong></p><p>é™åˆ¶åŸç†:å¯ä¸€å¥è¯æ¦‚æ‹¬ä¸ºï¼šâ€œæ ¹æ®å®¢æˆ·ç«¯ç‰¹å¾ï¼Œé™åˆ¶å…¶è®¿é—®é¢‘ç‡â€ï¼Œå®¢æˆ·ç«¯ç‰¹å¾ä¸»è¦æŒ‡IPã€UserAgentç­‰ã€‚ä½¿ç”¨IPæ¯”UserAgentæ›´å¯é ï¼Œå› ä¸ºIPæ— æ³•é€ å‡ï¼ŒUserAgentå¯éšæ„ä¼ªé€ ã€‚æ•´ç¼–ï¼šå¾®ä¿¡å…¬ä¼—å·ï¼Œæœäº‘åº“æŠ€æœ¯å›¢é˜Ÿï¼ŒIDï¼šsouyunku</p><p>ç”¨limit_reqæ¨¡å—æ¥é™åˆ¶åŸºäºIPè¯·æ±‚çš„è®¿é—®é¢‘ç‡ï¼š</p><p>http://nginx.org/en/docs/http/ngxhttplimitreqmodule.html</p><p>ä¹Ÿå¯ä»¥ç”¨tengineä¸­çš„å¢å¼ºç‰ˆï¼š</p><p>http://tengine.taobao.org/documentcn/httplimitreqcn.html</p><h3 class=pgc-h-arrow-right>1ã€å¹¶å‘æ•°å’Œè¿æ¥æ•°æ§åˆ¶çš„é…ç½®ï¼š</h3><pre><code>nginx httpé…ç½®ï¼š    #è¯·æ±‚æ•°é‡æ§åˆ¶ï¼Œæ¯ç§’20ä¸ª    limit_req_zone $binary_remote_addr zone=one:10m rate=20r/s;    #å¹¶å‘é™åˆ¶30ä¸ª    limit_conn_zone $binary_remote_addr zone=addr:10m;    serverå—é…ç½®    limit_req zone=one burst=5;    limit_conn addr 30;</code></pre><h3 class=pgc-h-arrow-right>2ã€ngxhttplimitconnmodule å¯ä»¥ç”¨æ¥é™åˆ¶å•ä¸ªIPçš„è¿æ¥æ•°ï¼š</h3><p>ngxhttplimitconnmoduleæ¨¡å—å¯ä»¥æŒ‰ç…§å®šä¹‰çš„é”®é™å®šæ¯ä¸ªé”®å€¼çš„è¿æ¥æ•°ã€‚å¯ä»¥è®¾å®šå•ä¸€ IP æ¥æºçš„è¿æ¥æ•°ã€‚</p><p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„è¿æ¥éƒ½ä¼šè¢«æ¨¡å—è®¡æ•°ï¼›åªæœ‰é‚£äº›æ­£åœ¨è¢«å¤„ç†çš„è¯·æ±‚ï¼ˆè¿™äº›è¯·æ±‚çš„å¤´ä¿¡æ¯å·²è¢«å®Œå…¨è¯»å…¥ï¼‰æ‰€åœ¨çš„è¿æ¥æ‰ä¼šè¢«è®¡æ•°ã€‚</p><pre><code>http {    limit_conn_zone $binary_remote_addr zone=addr:10m;    ...    server {        ...        location /download/ {            limit_conn addr 1;        }</code></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'é™æµ','API','é˜²åˆ·'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>