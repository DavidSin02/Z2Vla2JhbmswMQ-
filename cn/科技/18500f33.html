<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇） | 极客快訊</title><meta property="og:title" content="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/Rzs72cR34YYB3t"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/18500f33.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/18500f33.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/18500f33.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/18500f33.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/18500f33.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/18500f33.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/18500f33.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/18500f33.html><meta property="article:published_time" content="2020-11-14T21:05:04+08:00"><meta property="article:modified_time" content="2020-11-14T21:05:04+08:00"><meta name=Keywords content><meta name=description content="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/18500f33.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>PCIe接口自从被推出以来，已经成为了PC和Server上最重要的接口。为了更高了数据吞吐率，PCI-SIG组织不断刷新接口标准，从PCIe 3.0的8GT/s数据速率，到PCIe 4.0的16GT/s数据速率，再到PCIe 5.0的32GT/x。PCI-SIG组织实现了在速率翻倍的同时，仍能保持使用普通的FR4 板材 和廉价接插件，主要源自两个方面的改进，一是使用128b/130b编码来代替8b/10b编码，使得编码效率大幅提高；另一个是使用动态均衡技术，来代替先前代的静态均衡技术。</p><p>这里聚焦于PCIe 3.0和4.0中的动态均衡技术，介绍其原理、实现及其相关的一致性测试 。这样一种动态均衡技术，在spec中被称作“Link Equalizati on”（链路均衡，简称为LEQ）。本系列文章分上下两篇，本文理论篇主要介绍PCIe 3.0/4.0的链路均衡的工作原理，下一篇实践篇则侧重于链路均衡的测试和调试。</p><p><strong>PCIe 3.0 & 4.0的链路均衡</strong></p><p>在PCIe 3.0和4.0中的链路均衡技术相较于先前代要复杂得多，这样一种动态均衡技术可以分为两个方面进行讨论。</p><ul><li><p>均衡特性方面：从这个方面来说，相对于先前代的均衡来说，3.0和4.0中的均衡技术的硬件性能指标要求更高了。</p></li><li><p>协议方面：为了实现动态地调整均衡设置，需要协议层的配合，这是通过PHY层的LTSSM状态机中的Recovery.EqualizaTI on子状态来实现的。</p></li></ul><p>先来从均衡特性的角度来看看PCIe 3.0和4.0的均衡，如下展示了在PCIe 3.0/4.0中所使用的全部均衡技术，在Tx端有FFE（Feed Forward Equalizer，前馈均衡器）；在Rx端有：CTLE（ConTI nuous TI me Linear Equalizer，连续时间线性均衡器）和DFE（Decision Feedback Equalizer，判决反馈均衡器）。通过FFE和CTLE，可以去除大部分由ISI所引入的抖动；通过DFE可以进一步去除ISI，它还能去除部分的阻抗 失配所造成的反射。通过这些均衡处理，就能够最大程度上地保证在接收端判决输入处将眼图打开。</p><p>除了上述这些均衡特性上的支持外，在协议层（LTSSM）中还规定需要通过协议的方式来动态调整链路上的均衡设定值，这整个过程称作链路均衡（Link EqualizaTI on，LEQ）。在链路均衡过程中：</p><ul><li><p>本地端按照某个初始Tx EQ的设定来发送数据；</p></li><li><p>对端在接收到数据时，会根据误码率或信号质量来判断该Tx EQ是否合适；</p></li><li><p>若不合适，对端会通过协议向本地端请求一个新的Tx EQ值；</p></li><li><p>本地端在接收到这个请求值之后，会改变Tx EQ的值。</p></li></ul><p>通过这一动态过程，就能够保证链路上的Tx EQ为最优值。与此同时，本地端和对端也会同时调整Rx EQ。通过动态地调整Tx EQ和Rx EQ，就能够灵活地适应不同的信道情况。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/Rzs72cR34YYB3t><p>图1 LEQ硬件实现的模块框图</p><p><strong>发送端的均衡：FFE</strong></p><p>在PCIe 3.0 & 4.0中使用的都是3-tap FFE，如图 2a所示。其中，Qn为数字信号，建模时取值为±1；c-1， c0， c+1为FFE的抽头系数；voutn为发送端的模拟信号输出。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/Rzs72dD3dM1O9n><p>（a）FFE的模型框图 （b） FFE的模拟电压输出</p><p>图2 PCIe 3.0 & 4.0发送端所使用的3-tap的FFE</p><p>理想情况下的差分电压幅度有：23÷2=4种可能性，这四个电压幅度在PCIe标准中（如图 2b所示）分别被标记 为Va，Vb，Vc，Vd。</p><p>Va=c0-c+1+c-1×2g</p><p>Vb=c0+c+1+c-1×2g</p><p>Vc=c0+c+1-c-1×2g</p><p>Vd=c0-c+1-c-1×2g</p><p>其中，Vb被称作去加重电压（de-emphasis voltage），Vc被称作预冲电压（preshoot voltage）；Vd被称作最大幅度电压（boost voltage），PCIe标准中没有为Va取一个专门的名字。在此基础上，标准中通过三组比值来完备地描述FFE的性能：</p><p>DEEMPHASIS=20logVbVa=20logc0+c+1+c-1c0-c+1+c-1</p><p>PRESHOOT=20logVcVb=20logc0+c+1-c-1c0+c+1+c-1</p><p>BOOST=20logVdVb=20logc0-c+1-c-1c0+c+1+c-1</p><p>若不加限制的来说，那么c-1， c0， c+1形成的组合有无穷多个。但并不是所有的组合在实际应用中都是合适的。其中一个最重要的约束条件就是：去加重电压Vb不能过小，过小的去加重电压会导致输出信号在接收端的眼高过低。因此通过BOOST比值对去加重地电压幅值进行限制：对于满摆幅的Tx输出，规范要求BOOST≤9.5dB；对于减摆幅的Tx输出，规范要求BOOST≤3.5dB。最终会形成一个如图 3类似的矩阵表，图中系数的粒度为1/24。在实际应用中可以是其他的粒度值，例如1/64；更小的粒度能够使系数空间的取值可能性更多，在LEQ调节时也更精细。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/Rzs72dsELfBnEW><p>图3 发送端均衡的系数空间的矩阵表举例</p><p>鉴于系数空间上的取值可能性较多，PCI-SIG协会在开发协议的过程中，广泛地研究了在不同插入损耗下最优的系数取值组合；最后选定了若干个特定的系数取值组合，并把它们称作预设定值（preset），在实际的LEQ过程中，链路双方就可以先采用预设定值进行粗调；若还认为链路的均衡设置仍然没有达到最优，可以进一步通过系数空间的方式进行细调，最终达到速度和精度的平衡。</p><p><strong>接收端的均衡：CTLE和DFE</strong></p><p>在PCIe 3.0 & 4.0 基础规范中，并没有明确地规定接收端的结构是怎样的；而只是从测量 的角度对接收端性能进行了规定。相反地，在规范中定义了一个行为级CTLE和行为级DFE。这些行为级模型可以作为设计指南；并且为了使得待测对象能够通过规范的要求，一般来说用户所设计的接收端性能至少要等于这些行为级模型的性能，可以强于这些行为级模型，但不能弱于这些行为级模型。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/Rzs72eTHY0aTWz><p>（a） （b）</p><p>图4 行为级CTLE的频响曲线：（a） PCIe 3.0 （b） PCIe 4.0</p><p>发送端的输出在经过一段很长的FR4走线之后，仅仅使用CTLE，可能是不够的。因此在PCIe 3.0 & 4.0中，还使用了DFE的技术。在3.0中，使用1-tap的DFE，而在4.0，由于速率相对于3.0翻倍了；所以使用2-tap的DFE，以便移除更大的ISI。</p><p>与线性均衡器FFE和CTLE相比，DFE为一种非线性均衡器。DFE的基本想法是：若已经正确接收了之前的比特数据的话；那么先前的比特数据对当前比特所产生的影响就是已知的；从而我们就可以通过反馈的方式进行补偿，这样就能够进一步消除抖动和噪声的影响。不难看出这里的非线性体现在：反馈回来的信号是经过判决之后的数字信号；而判决电路是一种非线性电路。显然，反馈通路上的抽头数目越多，那么对抖动和噪声的消除可能就越好；这也就是为什么3.0中使用1-tap的DFE，而在4.0中使用2-tap的DFE。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RzrXdyT8jhkqZP><p>（a） （b）</p><p>图5 行为级DFE的结构：（a） PCIe 3.0 （b） PCIe 4.0</p><p><strong>链路均衡过程</strong></p><p>链路上的两端刚开始建立通信的时候，并不知道整个信道的物理特性是怎样的，例如插入损耗多大，是否有阻抗不连续等。由于PCIe 3.0和4.0的插入损耗允许的变化范围很大，一个静态的均衡设置并不能覆盖所有的情况。这样就需要链路上的双方根据当前物理信道的特性，来动态地调整均衡设置，使得均衡设置对于当前的物理信道来说是最优的。假设Port A和Port B是一个链路上的两端，那么链路均衡过程要做的事情有：</p><ul><li><p>配置Port A和Port B的初始均衡设置；</p></li><li><p>配置从Port A Tx à Port B Rx这一方向的均衡设置；</p></li><li><p>配置从Port B Tx à Port A Rx这一方向的均衡设置；</p></li></ul><p>下面我们以Port A Tx à Port B Rx这一方向来说明链路均衡时如何实现的。如图 6所示，在8GTs/或者16GT/s速率下的链路开始建立通信时，是以初始的未优化的TX EQ在发送TS1/TS2序列，并且Port A在TS1/TS2序列中表明其所用的TX EQ的值。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/Rzs73A59X3Y1jk><p>图6 LEQ：本地端发送未经优化的初始TX EQ</p><p>当Port B Rx在接收到这些TS1/TS2序列时，芯片内部存在一块电路或者一套算法来评估当前的TX EQ是否合适，若认为不合适，就会如图7所示，发送TS1序列来请求一个新的TX EQ。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/Rzs73AkHzqLyYy><p>图7 LEQ：对端请求一个新的TX EQ</p><p>随后，Port A会接收到请求设置TX EQ的TS1序列，如图8所示，调整其TX端的FFE的设置。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/Rzs73BN3q75mJp><p>图8 LEQ：本地正确地接收到了对端的请求，设置新的TX EQ</p><p>Port A在调整完Tx FFE的设置之后，如图9所示，会将新的TX EQ设置值更新到TS1/TS2的序列之中，发送到Port B端。若Port B仍然觉得这个时候的TX EQ不是最优，那么仍然会重复图中的2~4步骤，直到达到最优的TX EQ。当然上述过程并不能无限进行下去，必须要在大概32ms的范围进行完。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/Rzs73CC4KZMrIP><p>图9 LEQ：本地端告知对端已成功设置新的TX EQ</p><p>在上述2~4步骤的同时，Port B的RX端也在不停地调整其RX EQ，如图 10所示。如图6~图10中所讨论的，LEQ是基于请求-响应机制来完成动态均衡的。在PCIe的规范中，LEQ总共包含四个阶段：Phase 0、Phase1、Phase 2、Phase 3。其中上行端口包含全部四个过程；而下行端口不包含Phase 0。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/Rzs73D4CPskDxp><p>图10 LEQ：整个过程中同时调整RX EQ</p><p>通过图11不难看出，在LEQ过程中，上行端口和下行端口的行为是有区别的。以上描述的是在LEQ过程中链路上的双方如何调整Tx EQ。而对于Rx EQ，根据Base规范中的说明，在整个LEQ的过程、以及在后续正常工作的过程中，链路双方都可以一直调整Rx EQ。</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/Rzs73qo7msFBAa><p>图11 LEQ的状态跳转示意图</p><p>来源：泰克科技</p><p>作者：李煜</p><img alt="PCIe Gen3/Gen4接收端链路均衡测试（上篇：理论篇）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/R693gZV7RzkjoS><p><strong>免责声明：</strong>本文由作者原创，文章内容系作者个人观点，电子发烧友网转载仅作为传达一种不同的观点，不代表电子发烧友网对该观点的赞同或支持，如有异议，欢迎联系电子发烧友网。</p><ul><li><p>TDDI芯片血战，未来的王牌可能掌握在中国公司手中？！</p></li><li><p>华为轮值CEO郭平：强烈反对美国出口新管制规则 华为永不言弃</p></li><li><p>存储冰火两重天，国产芯片加速布局！</p></li><li><p>避过IoT设备那些“坑”，超低功耗Wi-Fi有多重要？</p></li><li><p>彪悍的国产电源芯片！资本入局，技术攻坚！</p></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'接收端','PCIe','Gen3'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../cn/%E7%A7%91%E6%8A%80/8063d86e.html alt="PCIe Gen3/Gen4接收端链路均衡测试—实践篇" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e5732dbbfafc4fbda49be57da81e07d8 style=border-radius:25px></a>
<a href=../../cn/%E7%A7%91%E6%8A%80/8063d86e.html title="PCIe Gen3/Gen4接收端链路均衡测试—实践篇">PCIe Gen3/Gen4接收端链路均衡测试—实践篇</a></li><hr><li><a href=../../cn/%E7%A7%91%E6%8A%80/244e73df.html alt="PCIe Gen3/Gen4接收端链路均衡测试—理论篇" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/deea7ea0ffcd4a4e9985f2106a9f6cf5 style=border-radius:25px></a>
<a href=../../cn/%E7%A7%91%E6%8A%80/244e73df.html title="PCIe Gen3/Gen4接收端链路均衡测试—理论篇">PCIe Gen3/Gen4接收端链路均衡测试—理论篇</a></li><hr><li><a href=../../cn/%E7%A7%91%E6%8A%80/bb7db633.html alt="PCIe Gen3/Gen4接收端链路均衡测试（下篇：实践篇）" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RzxxF1A1CuI2xT style=border-radius:25px></a>
<a href=../../cn/%E7%A7%91%E6%8A%80/bb7db633.html title="PCIe Gen3/Gen4接收端链路均衡测试（下篇：实践篇）">PCIe Gen3/Gen4接收端链路均衡测试（下篇：实践篇）</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>