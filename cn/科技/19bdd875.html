<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ | æå®¢å¿«è¨Š</title><meta property="og:title" content="é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/97eb0a9833ce4ebabaa2e7f72db4c46f"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/19bdd875.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/19bdd875.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/19bdd875.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/19bdd875.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/19bdd875.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/19bdd875.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/19bdd875.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/19bdd875.html><meta property="article:published_time" content="2020-11-14T21:04:37+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:37+08:00"><meta name=Keywords content><meta name=description content="é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/19bdd875.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><h1>ä¸€ã€ä»€ä¹ˆæ˜¯Zookeeperï¼Ÿ</h1><p>Zookeeperï¼ˆä¸šç•Œç®€ç§°zkï¼‰æ˜¯ä¸€ç§æä¾›é…ç½®ç®¡ç†ã€åˆ†å¸ƒå¼ååŒä»¥åŠå‘½åçš„ä¸­å¿ƒåŒ–æœåŠ¡ï¼Œè¿™äº›æä¾›çš„åŠŸèƒ½éƒ½æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸åº•å±‚ä¸”å¿…ä¸å¯å°‘çš„åŸºæœ¬åŠŸèƒ½ï¼Œä½†æ˜¯å¦‚æœè‡ªå·±å®ç°è¿™äº›åŠŸèƒ½è€Œä¸”è¦è¾¾åˆ°é«˜ååã€ä½å»¶è¿ŸåŒæ—¶è¿˜è¦ä¿æŒä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Œå®é™…ä¸Šéå¸¸å›°éš¾ã€‚å› æ­¤zookeeperæä¾›äº†è¿™äº›åŠŸèƒ½ï¼Œå¼€å‘è€…åœ¨zookeeperä¹‹ä¸Šæ„å»ºè‡ªå·±çš„å„ç§åˆ†å¸ƒå¼ç³»ç»Ÿã€‚</p><p>è™½ç„¶zookeeperçš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯å®ƒæä¾›çš„æ¨¡å‹æŠ½è±¡å´æ˜¯éå¸¸ç®€å•çš„ã€‚Zookeeperæä¾›ä¸€ä¸ªå¤šå±‚çº§çš„èŠ‚ç‚¹å‘½åç©ºé—´ï¼ˆèŠ‚ç‚¹ç§°ä¸ºznodeï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ç”¨ä¸€ä¸ªä»¥æ–œæ ï¼ˆ/ï¼‰åˆ†éš”çš„è·¯å¾„è¡¨ç¤ºï¼Œè€Œä¸”æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰çˆ¶èŠ‚ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹é™¤å¤–ï¼‰ï¼Œ<strong>éå¸¸ç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿ</strong>ã€‚ä¾‹å¦‚ï¼Œ/zookeeper/configè¡¨ç¤ºä¸€ä¸ªznodeï¼Œå®ƒçš„çˆ¶èŠ‚ç‚¹ä¸º/zookeeperï¼Œçˆ¶çˆ¶èŠ‚ç‚¹è¦ä¸ºæ ¹èŠ‚ç‚¹/ï¼Œæ ¹èŠ‚ç‚¹/æ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼Œé€šè¿‡åœ¨zkClientæ‰§è¡Œlså‘½ä»¤å¯ä»¥æŸ¥çœ‹å…¶å†…å­˜ç›®å½•ç»“æ„ï¼š</p><pre>[zk: localhost:2181(CONNECTED) 18] ls /[lock, zookeeper][zk: localhost:2181(CONNECTED) 19] ls /zookeeper[config, quota][zk: localhost:2181(CONNECTED) 20] ls /zookeeper/config[][zk: localhost:2181(CONNECTED) 21] get /zookeeper/config</pre><div class=pgc-img><img alt=é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/97eb0a9833ce4ebabaa2e7f72db4c46f><p class=pgc-img-caption></p></div><p>Zookeeperå†…å­˜ç›®å½•ç»“æ„ä¸æ–‡ä»¶ç³»ç»Ÿä¸åŒçš„æ˜¯ï¼Œ<strong>è¿™äº›èŠ‚ç‚¹éƒ½å¯ä»¥è®¾ç½®å…³è”çš„æ•°æ®</strong>ï¼Œå¯ä»¥é€šè¿‡getå‘½ä»¤è·å–å…¶å…³è”çš„æ•°æ®ï¼Œè€Œæ–‡ä»¶ç³»ç»Ÿä¸­åªæœ‰æ–‡ä»¶èŠ‚ç‚¹å¯ä»¥å­˜æ”¾æ•°æ®è€Œç›®å½•èŠ‚ç‚¹ä¸è¡Œã€‚Zookeeperä¸ºäº†ä¿è¯é«˜ååå’Œä½å»¶è¿Ÿï¼Œåœ¨å†…å­˜ä¸­ç»´æŠ¤äº†è¿™ä¸ªæ ‘çŠ¶çš„ç›®å½•ç»“æ„ï¼Œè¿™ç§ç‰¹æ€§ä½¿å¾—<strong>Zookeeperä¸èƒ½ç”¨äºå­˜æ”¾å¤§é‡çš„æ•°æ®ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„å­˜æ”¾æ•°æ®ä¸Šé™ä¸º1M</strong>ã€‚</p><p>è€Œä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œzookeeperéœ€è¦ä»¥é›†ç¾¤å½¢æ€æ¥éƒ¨ç½²ï¼Œè¿™æ ·åªè¦é›†ç¾¤ä¸­å¤§éƒ¨åˆ†æœºå™¨æ˜¯å¯ç”¨çš„ï¼ˆèƒ½å¤Ÿå®¹å¿ä¸€å®šçš„æœºå™¨æ•…éšœï¼‰ï¼Œé‚£ä¹ˆzookeeperæœ¬èº«ä»ç„¶æ˜¯å¯ç”¨çš„ã€‚å®¢æˆ·ç«¯åœ¨ä½¿ç”¨zookeeperæ—¶ï¼Œéœ€è¦çŸ¥é“é›†ç¾¤æœºå™¨åˆ—è¡¨ï¼Œé€šè¿‡ä¸é›†ç¾¤ä¸­çš„æŸä¸€å°æœºå™¨å»ºç«‹TCPè¿æ¥æ¥ä½¿ç”¨æœåŠ¡ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨è¿™ä¸ªTCPé“¾æ¥æ¥å‘é€è¯·æ±‚ã€è·å–ç»“æœã€è·å–ç›‘å¬äº‹ä»¶ä»¥åŠå‘é€å¿ƒè·³åŒ…ã€‚å¦‚æœè¿™ä¸ªè¿æ¥å¼‚å¸¸æ–­å¼€äº†ï¼Œå®¢æˆ·ç«¯å¯ä»¥è¿æ¥åˆ°å¦å¤–çš„æœºå™¨ä¸Šã€‚</p><p><strong>æ¶æ„ç®€å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p><div class=pgc-img><img alt=é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4028fb26dd074aeeb4a02f62ee56133e><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/97eb0a9833ce4ebabaa2e7f72db4c46f><p class=pgc-img-caption></p></div><p>â€‹</p><p>å®¢æˆ·ç«¯çš„è¯»è¯·æ±‚å¯ä»¥è¢«é›†ç¾¤ä¸­çš„ä»»æ„ä¸€å°æœºå™¨å¤„ç†ï¼Œå¦‚æœè¯»è¯·æ±‚åœ¨èŠ‚ç‚¹ä¸Šæ³¨å†Œäº†ç›‘å¬å™¨ï¼Œè¿™ä¸ªç›‘å¬å™¨ä¹Ÿæ˜¯ç”±æ‰€è¿æ¥çš„zookeeperæœºå™¨æ¥å¤„ç†ã€‚å¯¹äºå†™è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚ä¼šåŒæ—¶å‘ç»™å…¶ä»–zookeeperæœºå™¨å¹¶ä¸”è¾¾æˆä¸€è‡´åï¼Œè¯·æ±‚æ‰ä¼šè¿”å›æˆåŠŸã€‚å› æ­¤ï¼Œ<strong>éšç€zookeeperçš„é›†ç¾¤æœºå™¨å¢å¤šï¼Œè¯»è¯·æ±‚çš„ååä¼šæé«˜ä½†æ˜¯å†™è¯·æ±‚çš„ååä¼šä¸‹é™</strong>ã€‚</p><p><strong>æœ‰åºæ€§</strong>æ˜¯zookeeperä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç‰¹æ€§ï¼Œæ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯å…¨å±€æœ‰åºçš„ï¼Œæ¯ä¸ªæ›´æ–°éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ—¶é—´æˆ³ç§°ä¸ºzxidï¼ˆZookeeper Transaction Idï¼‰ã€‚è€Œè¯»è¯·æ±‚åªä¼šç›¸å¯¹äºæ›´æ–°æœ‰åºï¼Œä¹Ÿå°±æ˜¯è¯»è¯·æ±‚çš„è¿”å›ç»“æœä¸­ä¼šå¸¦æœ‰è¿™ä¸ªzookeeperæœ€æ–°çš„zxidã€‚</p><p>å¦‚ä½•ä½¿ç”¨zookeeperå®ç°åˆ†å¸ƒå¼é”ï¼Ÿ</p><p>åœ¨æè¿°ç®—æ³•æµç¨‹ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹zookeeperä¸­å‡ ä¸ªå…³äºèŠ‚ç‚¹çš„æœ‰è¶£çš„æ€§è´¨ï¼š</p><ul><li><strong>æœ‰åºèŠ‚ç‚¹</strong>ï¼šå‡å¦‚å½“å‰æœ‰ä¸€ä¸ªçˆ¶èŠ‚ç‚¹ä¸º/lockï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªçˆ¶èŠ‚ç‚¹ä¸‹é¢åˆ›å»ºå­èŠ‚ç‚¹ï¼›zookeeperæä¾›äº†ä¸€ä¸ªå¯é€‰çš„æœ‰åºç‰¹æ€§ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºå­èŠ‚ç‚¹â€œ/lock/node-â€å¹¶ä¸”æŒ‡æ˜æœ‰åºï¼Œé‚£ä¹ˆzookeeperåœ¨ç”Ÿæˆå­èŠ‚ç‚¹æ—¶ä¼šæ ¹æ®å½“å‰çš„å­èŠ‚ç‚¹æ•°é‡è‡ªåŠ¨æ·»åŠ æ•´æ•°åºå·ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªåˆ›å»ºçš„å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç”Ÿæˆçš„å­èŠ‚ç‚¹ä¸º/lock/node-0000000000ï¼Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹åˆ™ä¸º/lock/node-0000000001ï¼Œä¾æ¬¡ç±»æ¨ã€‚</li><li><strong>ä¸´æ—¶èŠ‚ç‚¹</strong>ï¼šå®¢æˆ·ç«¯å¯ä»¥å»ºç«‹ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼Œåœ¨ä¼šè¯ç»“æŸæˆ–è€…ä¼šè¯è¶…æ—¶åï¼Œzookeeperä¼šè‡ªåŠ¨åˆ é™¤è¯¥èŠ‚ç‚¹ã€‚</li><li><strong>äº‹ä»¶ç›‘å¬</strong>ï¼šåœ¨è¯»å–æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶å¯¹èŠ‚ç‚¹è®¾ç½®äº‹ä»¶ç›‘å¬ï¼Œå½“èŠ‚ç‚¹æ•°æ®æˆ–ç»“æ„å˜åŒ–æ—¶ï¼Œzookeeperä¼šé€šçŸ¥å®¢æˆ·ç«¯ã€‚å½“å‰zookeeperæœ‰å¦‚ä¸‹å››ç§äº‹ä»¶ï¼š1ï¼‰èŠ‚ç‚¹åˆ›å»ºï¼›2ï¼‰èŠ‚ç‚¹åˆ é™¤ï¼›3ï¼‰èŠ‚ç‚¹æ•°æ®ä¿®æ”¹ï¼›4ï¼‰å­èŠ‚ç‚¹å˜æ›´ã€‚</li></ul><h1><br></h1><h1><strong>äºŒã€åˆ†å¸ƒå¼é”</strong></h1><p>åˆ†å¸ƒå¼é”ï¼Œè¿™ä¸ªä¸»è¦å¾—ç›Šäº ZooKeeper ä¸ºæˆ‘ä»¬ä¿è¯äº†æ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚é”æœåŠ¡å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯ <strong>ä¿æŒç‹¬å </strong>ï¼Œå¦ä¸€ä¸ªæ˜¯ <strong>æ§åˆ¶æ—¶åº</strong>ã€‚</p><p>1. <strong>ä¿æŒç‹¬å </strong>ï¼Œå°±æ˜¯æ‰€æœ‰è¯•å›¾æ¥è·å–è¿™ä¸ªé”çš„å®¢æˆ·ç«¯ï¼Œæœ€ç»ˆåªæœ‰ä¸€ä¸ªå¯ä»¥æˆåŠŸè·å¾—è¿™æŠŠé”ã€‚é€šå¸¸çš„åšæ³•æ˜¯æŠŠ zk ä¸Šçš„ä¸€ä¸ª znode çœ‹ä½œæ˜¯ä¸€æŠŠé”ï¼Œé€šè¿‡ create znode çš„æ–¹å¼æ¥å®ç°ã€‚æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å»åˆ›å»º /lock/xxxxx èŠ‚ç‚¹ï¼Œæœ€ç»ˆæˆåŠŸåˆ›å»ºçš„é‚£ä¸ªå®¢æˆ·ç«¯å°±å¯ä»¥è®¤ä¸ºæˆåŠŸçš„æ‹¥æœ‰äº†è¿™æŠŠé”ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œåé¢çš„ä¸šåŠ¡é€»è¾‘ï¼Œåˆ›å»ºä¸æˆåŠŸçš„èŠ‚ç‚¹ä¼šæ”¶åˆ°å¼‚å¸¸çš„æç¤ºã€‚</p><p>æˆåŠŸè·å–é”çš„èŠ‚ç‚¹ç»§ç»­æ‰§è¡Œåç»­çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸è¿‡å¯èƒ½å‘ç”Ÿçš„æƒ…å†µæ˜¯è¯¥æœåŠ¡æ­£åœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘æ—¶æŒ‚æ‰äº†ï¼Œå¦‚æœåŠ¡å™¨æ‰ç”µäº†ï¼Œè¿™ä¸ªæ—¶å€™è¯¥æœåŠ¡å°±ä¸èƒ½å¤Ÿæ­£å¸¸çš„ä»Zookeeperåˆ é™¤å…¶åˆ›å»ºçš„é”èŠ‚ç‚¹ï¼Œä¸ºäº†é¿å…æ­»é”çš„å‘ç”Ÿï¼Œåˆ›å»ºç‹¬å é”æ—¶æŒ‡å®šçš„èŠ‚ç‚¹ç±»å‹ä¸ºä¸´æ—¶èŠ‚ç‚¹ï¼ŒZookeeperä¼šç›‘æ§è¯¥æœåŠ¡åˆ›å»ºçš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹ï¼Œå¦‚æœè¯¥æœåŠ¡ä¸Zookeeperçš„Sessionæ–­å¼€äº†ï¼Œåˆ™æ‰€æœ‰çš„ä¸´æ—¶èŠ‚ç‚¹éƒ½ä¼šè¢«åˆ é™¤æ‰ï¼Œä»è€Œé¿å…äº†æ­»é”çš„å‘ç”Ÿã€‚</p><p>2. <strong>æ§åˆ¶æ—¶åº</strong>ï¼Œå°±æ˜¯æ‰€æœ‰è§†å›¾æ¥è·å–è¿™ä¸ªé”çš„å®¢æˆ·ç«¯ï¼Œæœ€ç»ˆéƒ½æ˜¯ä¼šè¢«å®‰æ’æ‰§è¡Œï¼Œåªæ˜¯æœ‰ä¸ªå…¨å±€æ—¶åºæ§åˆ¶å…¶æ‰§è¡Œçš„é¡ºåºã€‚åšæ³•å’Œä¸Šé¢åŸºæœ¬ç±»ä¼¼ï¼Œåªæ˜¯è¿™é‡Œ /lock å·²ç»é¢„å…ˆå­˜åœ¨ï¼Œå®¢æˆ·ç«¯åœ¨å®ƒä¸‹é¢åˆ›å»ºä¸´æ—¶æœ‰åºèŠ‚ç‚¹ï¼ˆè¿™ä¸ªå¯ä»¥é€šè¿‡èŠ‚ç‚¹çš„CreateModeå±æ€§æ§åˆ¶ï¼ŒæŒ‡å®šå…¶å€¼ä¸ºCreateMode.EPHEMERALSEQUENTIAL å³è¡¨ç¤ºä¸ºæ—¶æœ‰åºèŠ‚ç‚¹ï¼‰ã€‚Zk çš„çˆ¶èŠ‚ç‚¹ï¼ˆ/lockï¼‰ç»´æŒä¸€ä»½ sequence, ä¿è¯å­èŠ‚ç‚¹åˆ›å»ºçš„æ—¶åºæ€§ï¼Œä»è€Œä¹Ÿå½¢æˆäº†æ¯ä¸ªå®¢æˆ·ç«¯çš„å…¨å±€æ—¶åºã€‚</p><p>æ—¶åºèŠ‚ç‚¹åˆ†å¸ƒå¼é”ç®—æ³•æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å®¢æˆ·ç«¯è¿æ¥zookeeperï¼Œå¹¶åœ¨/lockä¸‹åˆ›å»ºä¸´æ—¶çš„ä¸”æœ‰åºçš„å­èŠ‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹åº”çš„å­èŠ‚ç‚¹ä¸º/lock/lock-0000000000ï¼Œç¬¬äºŒä¸ªä¸º/lock/lock-0000000001ï¼Œä»¥æ­¤ç±»æ¨ï¼›</li><li>å®¢æˆ·ç«¯è·å–/lockä¸‹çš„å­èŠ‚ç‚¹åˆ—è¡¨ï¼Œåˆ¤æ–­è‡ªå·±åˆ›å»ºçš„å­èŠ‚ç‚¹æ˜¯å¦ä¸ºå½“å‰å­èŠ‚ç‚¹åˆ—è¡¨ä¸­åºå·æœ€å°çš„å­èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™è®¤ä¸ºè·å¾—é”ï¼Œå¦åˆ™ç›‘å¬åˆšå¥½åœ¨è‡ªå·±ä¹‹å‰ä¸€ä½çš„å­èŠ‚ç‚¹åˆ é™¤æ¶ˆæ¯ï¼Œè·å¾—å­èŠ‚ç‚¹å˜æ›´é€šçŸ¥åé‡å¤æ­¤æ­¥éª¤ç›´è‡³è·å¾—é”ï¼›</li><li>æ‰§è¡Œä¸šåŠ¡ä»£ç ï¼›</li><li>å®Œæˆä¸šåŠ¡æµç¨‹åï¼Œåˆ é™¤å¯¹åº”çš„å­èŠ‚ç‚¹é‡Šæ”¾é”ã€‚</li></ul><h1><br></h1><h1>ä¸‰ã€å®ç°åˆ†å¸ƒå¼æ§åˆ¶çš„Javaå®ç°</h1><p>1ã€Curatorä»‹ç»</p><p>Apache Curatoræ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œå–„çš„ZooKeeperå®¢æˆ·ç«¯æ¡†æ¶ï¼Œæ˜¯Netflixå…¬å¸å¼€æºçš„ä¸€ä¸ªZooKeeperå®¢æˆ·ç«¯å°è£…ï¼Œé€šè¿‡å°è£…çš„ä¸€å¥—é«˜çº§API ç®€åŒ–äº†ZooKeeperçš„æ“ä½œã€‚é€šè¿‡æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œå¯ä»¥å‘ç°Curatorä¸»è¦è§£å†³äº†ä¸‰ç±»é—®é¢˜ï¼š</p><ul><li>å°è£…ZooKeeper clientä¸ZooKeeper serverä¹‹é—´çš„è¿æ¥å¤„ç†</li><li>æä¾›äº†ä¸€å¥—Fluenté£æ ¼çš„æ“ä½œAPI</li><li>æä¾›ZooKeeperå„ç§åº”ç”¨åœºæ™¯(recipeï¼Œ æ¯”å¦‚ï¼šåˆ†å¸ƒå¼é”æœåŠ¡ã€é›†ç¾¤é¢†å¯¼é€‰ä¸¾ã€å…±äº«è®¡æ•°å™¨ã€ç¼“å­˜æœºåˆ¶ã€åˆ†å¸ƒå¼é˜Ÿåˆ—ç­‰)çš„æŠ½è±¡å°è£…</li></ul><p>Curatorä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢é™ä½äº†zkä½¿ç”¨çš„å¤æ‚æ€§ï¼š</p><ul><li>é‡è¯•æœºåˆ¶:æä¾›å¯æ’æ‹”çš„é‡è¯•æœºåˆ¶, å®ƒå°†ç»™æ•è·æ‰€æœ‰å¯æ¢å¤çš„å¼‚å¸¸é…ç½®ä¸€ä¸ªé‡è¯•ç­–ç•¥ï¼Œå¹¶ä¸”å†…éƒ¨ä¹Ÿæä¾›äº†å‡ ç§æ ‡å‡†çš„é‡è¯•ç­–ç•¥(æ¯”å¦‚æŒ‡æ•°è¡¥å¿)</li><li>è¿æ¥çŠ¶æ€ç›‘æ§: Curatoråˆå§‹åŒ–ä¹‹åä¼šä¸€ç›´å¯¹zkè¿æ¥è¿›è¡Œç›‘å¬ï¼Œä¸€æ—¦å‘ç°è¿æ¥çŠ¶æ€å‘ç”Ÿå˜åŒ–å°†ä¼šä½œå‡ºç›¸åº”çš„å¤„ç†</li><li>zkå®¢æˆ·ç«¯å®ä¾‹ç®¡ç†:Curatorä¼šå¯¹zkå®¢æˆ·ç«¯åˆ°serveré›†ç¾¤çš„è¿æ¥è¿›è¡Œç®¡ç†ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™é‡å»ºzkå®ä¾‹ï¼Œä¿è¯ä¸zké›†ç¾¤è¿æ¥çš„å¯é æ€§</li><li>å„ç§ä½¿ç”¨åœºæ™¯æ”¯æŒ:Curatorå®ç°äº†zkæ”¯æŒçš„å¤§éƒ¨åˆ†ä½¿ç”¨åœºæ™¯ï¼ˆç”šè‡³åŒ…æ‹¬zkè‡ªèº«ä¸æ”¯æŒçš„åœºæ™¯ï¼‰ï¼Œè¿™äº›å®ç°éƒ½éµå¾ªäº†zkçš„æœ€ä½³å®è·µï¼Œå¹¶è€ƒè™‘äº†å„ç§æç«¯æƒ…å†µ</li></ul><p><strong>2ã€Curatorä¸Springçš„æ•´åˆ</strong></p><p>1ï¼‰POMä¾èµ–</p><pre> &lt;dependency&gt; &lt;groupId&gt;org.apache.curator&lt;/groupId&gt; &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt; &lt;version&gt;4.2.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.curator&lt;/groupId&gt; &lt;artifactId&gt;curator-framework&lt;/artifactId&gt; &lt;version&gt;4.2.0&lt;/version&gt; &lt;/dependency&gt;</pre><div class=pgc-img><img alt=é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/97eb0a9833ce4ebabaa2e7f72db4c46f><p class=pgc-img-caption></p></div><p>2ï¼‰Springåˆä½¿åŒ–é…ç½®æ–‡ä»¶ï¼Œå¦‚applicationContext-zookeeper.xml</p><pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context" xmlns:jee="http://www.springframework.org/schema/jee" xmlns:jdbc="http://www.springframework.org/schema/jdbc" xmlns:tx="http://www.springframework.org/schema/tx" xmlns:util="http://www.springframework.org/schema/util" xmlns:aop="http://www.springframework.org/schema/aop" xmlns:p="http://www.springframework.org/schema/p" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-4.3.xsd http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-4.3.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.3.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.3.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.3.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd"&gt; &lt;description&gt;ZKä¸Springæ•´åˆï¼Œå¯åŠ¨é¡¹ç›®æ—¶å»ºç«‹ä¸ZKçš„è¿æ¥&lt;/description&gt; &lt;!--ZKé‡è¯•ç­–ç•¥--&gt; &lt;bean id="retryPolicy" class="org.apache.curator.retry.RetryNTimes"&gt; &lt;!--é‡è¯•æ¬¡æ•°--&gt; &lt;constructor-arg index="0" value="10"/&gt; &lt;!--æ¯æ¬¡é—´éš”ms--&gt; &lt;constructor-arg index="1" value="5000"/&gt; &lt;/bean&gt; &lt;!--ZKå®¢æˆ·ç«¯--&gt; &lt;bean id="curatorFramework" class="org.apache.curator.framework.CuratorFrameworkFactory"  factory-method="newClient" init-method="start"&gt; &lt;!--ZKæœåŠ¡åœ°å€ï¼Œé›†ç¾¤ä½¿ç”¨é€—å·åˆ†éš”--&gt; &lt;constructor-arg index="0" value="127.0.0.1"/&gt; &lt;!--session timeoutä¼šè¯è¶…æ—¶æ—¶é—´--&gt; &lt;constructor-arg index="1" value="10000"/&gt; &lt;!--ConnectionTimeoutMsåˆ›å»ºè¿æ¥è¶…æ—¶æ—¶é—´--&gt; &lt;constructor-arg index="2" value="5000"/&gt; &lt;!--é‡è¯•ç­–ç•¥--&gt; &lt;constructor-arg index="3" ref="retryPolicy"/&gt; &lt;/bean&gt;&lt;/beans&gt;</pre><div class=pgc-img><img alt=é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/97eb0a9833ce4ebabaa2e7f72db4c46f><p class=pgc-img-caption></p></div><p>3ï¼‰åˆ›å»ºZookeeper Curatorçš„å·¥å…·ç±»ï¼ˆå¯ä»¥æœ‰ä¹Ÿå¯ä»¥æ²¡æœ‰ï¼‰</p><pre>import javax.annotation.PostConstruct;import javax.annotation.Resource;import org.apache.curator.framework.CuratorFramework;import org.apache.curator.framework.imps.CuratorFrameworkState;import org.apache.zookeeper.ZooKeeper;import org.springframework.stereotype.Service;import lombok.extern.slf4j.Slf4j;/** *  * @author fenglibin * */@Service@Slf4jpublic class ZKCuratorUtil { // ZKå®¢æˆ·ç«¯ @Resource(name = "curatorFramework") private CuratorFramework curatorFramework; public ZKCuratorUtil(CuratorFramework curatorFramework) { this.curatorFramework = curatorFramework; } /** * åˆå§‹åŒ–æ“ä½œ */ @PostConstruct public void init() { log.info("Use zookeeper as the zookeeper's name space."); // ä½¿ç”¨å‘½åç©ºé—´ curatorFramework = curatorFramework.usingNamespace("zookeeper"); } /** * è·å–Zookeeperå®¢æˆ·ç«¯è¿æ¥ *  * @return */ public CuratorFramework getCuratorFramework() { return curatorFramework; }  public ZooKeeper getZooKeeper() throws Exception { return getCuratorFramework().getZookeeperClient().getZooKeeper(); } /** * åˆ¤æ–­ZKæ˜¯å¦è¿æ¥ *  * @return */ public boolean isStarted() { return curatorFramework != null  &amp;&amp; (curatorFramework.getState() == CuratorFrameworkState.STARTED); } /** * åˆ¤æ–­æ˜¯å¦å·²ç»åœæ­¢ *  * @return */ public boolean isStoped() { return curatorFramework == null  || (curatorFramework.getState() == CuratorFrameworkState.STOPPED); }}</pre><div class=pgc-img><img alt=é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/97eb0a9833ce4ebabaa2e7f72db4c46f><p class=pgc-img-caption></p></div><p>4ï¼‰å•å…ƒæµ‹è¯•ç±»</p><p>è¯¥å•å…ƒæµ‹è¯•å®ç°çš„æ˜¯ä¸€ä¸ªç‹¬å é”ï¼Œä»¥ç¡®ä¿äº¤æ˜“ç³»ç»Ÿä¸­å¹‚ç­‰å®ç°é€»è¾‘ã€‚</p><div class=pgc-img><img alt=é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/eecafcde64ce442a9fcd52d96cb17ee1><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/28f752d42d754ceca71bde7dfb259472><p class=pgc-img-caption></p></div><p>â€‹ä¸šåŠ¡æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><pre>@Resourceprivate RedisTemplate&lt;String, String&gt; redisTemplate;@Resourceprivate ZKCuratorUtil zkCuratorUtil;//è¯¥è·¯å¾„å¿…é¡»å…ˆåœ¨zookeeperä¸­åˆ›å»ºï¼Œå¦åˆ™ä¼šæŠ¥é”™private String lockPath = "/lock/";@Testpublic void testZookeeperLock() { // ç”¨äºåˆ¤æ–­äº¤æ˜“å”¯ä¸€æ€§å’Œåˆæ³•æ€§çš„Tokenï¼Œåœ¨äº¤æ˜“æ‰§è¡Œä¹‹å‰å…ˆä¿å­˜åœ¨æœåŠ¡ç«¯ï¼Œ // å¹¶ä¸”ä¸‹å‘ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¼šåœ¨æ‰§è¡Œäº¤æ˜“ä¹‹å‰æŠŠTokenå¸¦ä¸Šï¼Œæ²¡å¸¦Tokençš„ // è¯·æ±‚ã€Tokenä¸å­˜åœ¨çš„æœåŠ¡ç«¯çš„è¯·æ±‚ã€Tokenä¸æ­£ç¡®çš„è¯·æ±‚éƒ½è§†ä¸ºéæ³•è¯·æ±‚ String token = "..."; String key = MD5Util.md5Of32(token); String currentLockPath = new StringBuilder(lockPath).append(key).toString(); boolean isGetLock = false; boolean handleSuccess = false; try { isGetLock = isGetLock(currentLockPath); if (!isGetLock) { log.warn("å½“å‰äº¤æ˜“æ­£åœ¨è¢«å¤„ç†ä¸­"); return; } log.info("å¤„ç†äº¤æ˜“å¼€å§‹"); String storedToken = redisTemplate.opsForValue().get(key); // åˆ¤æ–­Tokenæ˜¯å¦å­˜åœ¨ä¸”åˆæ³• if (!token.equals(storedToken)) { log.warn("æŒ‡å®šçš„Tokenä¸å­˜åœ¨."); return; } handleSuccess = true; log.info("å¤„ç†äº¤æ˜“ç»“æŸ"); } catch (Exception e) { log.info("å¤„ç†å‘ç”Ÿå¼‚å¸¸", e); } finally { if (handleSuccess) { // é™åˆ¶äº†å•ä¸ªTokenåªèƒ½å¤Ÿæ‰§è¡Œä¸€ç¬”è®°äº¤æ˜“ï¼Œå› è€Œæ‰§è¡ŒæˆåŠŸåå°†å…¶åˆ é™¤ List&lt;String&gt; keys = new ArrayList&lt;String&gt;(); keys.add(key);// é™åˆ¶äº†å•ä¸ªTokenåªèƒ½å¤Ÿæ‰§è¡Œä¸€ç¬”è®°äº¤æ˜“ï¼Œå› è€Œæ‰§è¡ŒæˆåŠŸåå°†å…¶åˆ é™¤ } if (isGetLock) { // ä»Zookeeperåˆ é™¤ç”¨äºé”å®šçš„key try { zkCuratorUtil.getZooKeeper().delete(currentLockPath, -1); } catch (Exception e) { log.error("Delete zookeeper path:" + currentLockPath + " failed.", e); } } }}/** * ä½¿ç”¨åœ¨Zookeeperåˆ›å»ºä¸´æ—¶èŠ‚ç‚¹çš„æœºåˆ¶ï¼Œå¦‚æœåˆ›å»ºæˆåŠŸï¼Œåˆ™è®¤ä¸ºå…¶è·å–é”æˆåŠŸï¼Œ * å¦‚æœåˆ›å»ºèŠ‚ç‚¹å¤±è´¥ï¼Œåˆ™è®¤ä¸ºé”è·å–å¤±è´¥ã€‚ * @param currentLockPath å¾…åˆ›å»ºçš„é”èŠ‚ç‚¹ * @return */public boolean isGetLock(String currentLockPath) { String nowDate = String.valueOf(System.currentTimeMillis()); try { //åœ¨Zookeeperåˆ›å»ºæŒ‡å®šçš„ä¸´æ—¶èŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹å·²ç»å­˜åœ¨äº†ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ zkCuratorUtil.getZooKeeper().create(currentLockPath, nowDate.getBytes(),  Ids.READ_ACL_UNSAFE, CreateMode.EPHEMERAL); } catch (Exception e) { return false; } return true;}</pre><div class=pgc-img><img alt=é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ§åˆ¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/97eb0a9833ce4ebabaa2e7f72db4c46f><p class=pgc-img-caption></p></div><p>å‚è€ƒï¼š</p><p>https://blog.csdn.net/qiangcuo6087/article/details/79067136</p><p>https://www.cnblogs.com/toov5/p/9899489.html</p><p>https://www.zifangsky.cn/1166.html</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ç¯å¢ƒ','Zookeeper','å®ç°'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>