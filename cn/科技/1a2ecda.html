<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MySQL 规约（初稿） | 极客快訊</title><meta property="og:title" content="MySQL 规约（初稿） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1a2ecda.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1a2ecda.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1a2ecda.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1a2ecda.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1a2ecda.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1a2ecda.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1a2ecda.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1a2ecda.html><meta property="article:published_time" content="2020-10-29T21:01:26+08:00"><meta property="article:modified_time" content="2020-10-29T21:01:26+08:00"><meta name=Keywords content><meta name=description content="MySQL 规约（初稿）"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/1a2ecda.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MySQL 规约（初稿）</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h2 class=pgc-h-arrow-right>备注：阿里数据库规约 + 58数据库规约 + 个人整理（欢迎指正）</h2><h2 class=pgc-h-arrow-right>0）前言</h2><h3 class=pgc-h-arrow-right>a. 基本规约</h3><p>【强制】表存储引擎必须使用InnoDB（针对主库一般是强制要求的）</p><p>【强制】表字符集默认使用utf8，必要时候使用utf8mb4（个人踩坑：emoji表情存储问题）</p><ul><li>说明：通用，无乱码风险，汉字3字节，英文1字节utf8mb4是utf8的超集，有存储4字节例如表情符号时，使用它</li></ul><p>【强制】禁止使用存储过程，视图，触发器，Event</p><ul><li>说明对数据库性能影响较大，互联网业务，能让站点层和服务层干的事情，不要交到数据库层调试，排错，迁移都比较困难，扩展性较差</li></ul><p>【强制】禁止在数据库中存储大文件，例如照片，可以将大文件存储在对象存储系统，数据库中存储路径</p><p>【强制】禁止在线上环境做数据库压力测试</p><p>【强制】测试，开发，线上数据库环境必须隔离</p><h3 class=pgc-h-arrow-right>b. <strong>命名规范</strong></h3><p>【强制】库名，表名，列名必须用小写，采用下划线分隔</p><ul><li>说明：abc，Abc，ABC都是给自己埋坑</li></ul><p>【推荐】库名，表名，列名必须见名知义，长度不要超过32字符</p><ul><li>说明：tmp，wushan谁TM知道这些库是干嘛的</li></ul><p>【推荐】库备份必须以bak为前缀，以日期为后缀</p><p>【推荐】从库必须以-s为后缀</p><p>【推荐】备库必须以-ss为后缀</p><h2 class=pgc-h-arrow-right>1）建表规约</h2><p>【强制】单实例表个数必须控制在2000个以内</p><p>【强制】单表分表个数必须控制在1024个以内</p><p>【强制】表必须有主键，推荐使用UNSIGNED整数为主键</p><ul><li>说明：潜在坑：删除无主键的表，如果是row模式的主从架构，从库会挂住</li></ul><p>【强制】禁止使用外键，如果要保证完整性，应由应用程式实现</p><ul><li>说明：外键使得表之间相互耦合，影响update/delete等SQL性能，有可能造成死锁，高并发情况下容易成为数据库瓶颈</li></ul><p>【推荐】建议将大字段，访问频度低的字段拆分到单独的表中存储，分离冷热数据</p><p>【推荐】根据业务区分使用tinyint/int/bigint，分别会占用1/4/8字节</p><p>【推荐】根据业务区分使用char/varchar</p><ul><li>说明：字段长度固定，或者长度近似的业务场景，适合使用char，能够减少碎片，查询性能高字段长度相差较大，或者更新较少的业务场景，适合使用varchar，能够减少空间</li></ul><p>【推荐】根据业务区分使用datetime/timestamp</p><ul><li>说明：前者占用5个字节，后者占用4个字节，存储年使用YEAR，存储日期使用DATE，存储时间使用datetime</li></ul><p>【强制】必须把字段定义为NOT NULL并设默认值</p><ul><li>说明：NULL的列使用索引，索引统计，值都更加复杂，MySQL更难优化NULL需要更多的存储空间NULL只能采用IS NULL或者IS NOT NULL，而在=/!=/in/not in时有大坑</li></ul><p>【强制】使用INT UNSIGNED存储IPv4，不要用char(15)</p><p>【强制】使用varchar(20)存储手机号，不要使用整数</p><ul><li>说明：牵扯到国家代号，可能出现+/-/()等字符，例如+86手机号不会用来做数学运算varchar可以模糊查询，例如like ‘138%’</li></ul><p>【强制】使用TINYINT来代替ENUM</p><ul><li>说明：ENUM增加新值要进行DDL操作</li></ul><p>【强制】表达是与否概念的字段，必须使用 is_xxx 的方式命名，数据类型是 unsigned tinyint ( 1表示是，0表示否)。</p><ul><li>说明:任何字段如果为非负数，必须是 unsigned。</li><li>正例:表达逻辑删除的字段名 is_deleted，1 表示删除，0 表示未删除。</li></ul><p>【强制】表名、字段名必须使用小写字母或数字，禁止出现数字开头，禁止两个下划线中间只 出现数字。数据库字段名的修改代价很大，因为无法进行预发布，所以字段名称需要慎重考虑。</p><ul><li>说明:MySQL 在 Windows 下不区分大小写，但在 Linux 下默认是区分大小写。因此，数据库 名、表名、字段名，都不允许出现任何大写字母，避免节外生枝。</li><li>正例:aliyun_admin，rdc_config，level3_name</li><li>反例:AliyunAdmin，rdcConfig，level_3_name</li></ul><p>【强制】表名不使用复数名词。</p><ul><li>说明:表名应该仅仅表示表里面的实体内容，不应该表示实体数量，对应于 DO 类名也是单数 形式，符合表达习惯。</li></ul><p>【强制】禁用保留字，如 desc、range、match、delayed 等，请参考 MySQL 官方保留字。</p><p>【强制】主键索引名为 pk_字段名;唯一索引名为 uk_字段名;普通索引名则为 idx_字段名。</p><ul><li>说明:pk_ 即 primary key;uk_ 即 unique key;idx_ 即 index 的简称。</li></ul><p>【推荐】小数类型为 decimal，禁止使用 float 和 double。</p><ul><li>说明:float 和 double 在存储的时候，存在精度损失的问题，很可能在值的比较时，得到不 正确的结果。如果存储的数据范围超过 decimal 的范围，建议将数据拆成整数和小数分开存储。</li></ul><p>【强制】如果存储的字符串长度几乎相等，使用 char 定长字符串类型。</p><p>【强制】varchar 是可变长字符串，不预先分配存储空间，长度不要超过 5000，如果存储长 度大于此值，定义字段类型为 text，独立出来一张表，用主键来对应，避免影响其它字段索 引效率。</p><p>【强制】表必备三字段:id, gmt_create, gmt_modified。</p><ul><li>说明:其中id必为主键，类型为unsigned bigint、单表时自增、步长为1。gmt_create, gmt_modified 的类型均为 date_time 类型，前者现在时表示主动创建，后者过去分词表示被 动更新。</li></ul><p>【推荐】表的命名最好是加上“业务名称_表的作用”。</p><ul><li>正例:alipay_task / force_project / trade_config</li></ul><p>【推荐】库名与应用名称尽量一致。</p><p>【推荐】如果修改字段含义或对字段表示的状态追加时，需要及时更新字段注释。</p><p>【推荐】字段允许适当冗余，以提高查询性能，但必须考虑数据一致。冗余字段应遵循: 1)不是频繁修改的字段。 2)不是 varchar 超长字段，更不能是 text 字段。</p><ul><li>正例:商品类目名称使用频率高，字段长度短，名称基本一成不变，可在相关联的表中冗余存 储类目名称，避免关联查询。</li></ul><p>【推荐】单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表。</p><ul><li>说明:如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。</li></ul><p>【参考】合适的字符存储长度，不但节约数据库表空间、节约索引存储，更重要的是提升检 索速度。</p><ul><li>正例:如下表，其中无符号值可以避免误存负数，且扩大了表示范围。</li></ul><p><strong>对象</strong></p><p><strong>年龄区间</strong></p><p><strong>类型</strong></p><p><strong>字节</strong></p><p><strong>表示范围</strong></p><p>人</p><p>150 岁之内</p><p>unsigned tinyint</p><p>1</p><p>无符号值:0 到 255</p><p>龟</p><p>数百岁</p><p>unsigned smallint</p><p>2</p><p>无符号值:0 到 65535</p><p>恐龙化石</p><p>数千万年</p><p>unsigned int</p><p>4</p><p>无符号值:0 到约 42.9 亿</p><p>太阳</p><p>约 50 亿年</p><p>unsigned bigint</p><p>8</p><p>无符号值:0 到约 10 的 19 次方</p><p><br></p><h2 class=pgc-h-arrow-right>2）索引规约</h2><p>【推荐】唯一索引使用uniq_[字段名]来命名</p><p>【推荐】非唯一索引使用idx_[字段名]来命名</p><p>【推荐】单张表索引数量建议控制在5个以内</p><ul><li>说明：互联网高并发业务，太多索引会影响写性能生成执行计划时，如果索引太多，会降低性能，并可能导致MySQL选择不到最优索引异常复杂的查询需求，可以选择ES等更为适合的方式存储</li></ul><p>【推荐】组合索引字段数不建议超过5个</p><ul><li>说明：如果5个字段还不能极大缩小row范围，八成是设计有问题</li></ul><p>【推荐】不建议在频繁更新的字段上建立索引</p><p>【推荐】非必要不要进行JOIN查询，如果要进行JOIN查询，被JOIN的字段必须类型相同，并建立索引</p><ul><li>说明：踩过因为JOIN字段类型不一致，而导致全表扫描的坑么？</li></ul><p>【推荐】理解组合索引最左前缀原则，避免重复建设索引，如果建立了(a,b,c)，相当于建立了(a), (a,b), (a,b,c)</p><p>【强制】业务上具有唯一特性的字段，即使是多个字段的组合，也必须建成唯一索引。</p><ul><li>说明:不要以为唯一索引影响了 insert 速度，这个速度损耗可以忽略，但提高查找速度是明 显的;另外，即使在应用层做了非常完善的校验控制，只要没有唯一索引，根据墨菲定律，必 然有脏数据产生。</li></ul><p>【强制】超过三个表禁止 join。需要 join 的字段，数据类型必须绝对一致;多表关联查询时， 保证被关联的字段需要有索引。</p><ul><li>说明:即使双表 join 也要注意表索引、SQL 性能。</li></ul><p>【强制】在 varchar 字段上建立索引时，必须指定索引长度，没必要对全字段建立索引，根据 实际文本区分度决定索引长度即可。</p><ul><li>说明:索引的长度与区分度是一对矛盾体，一般对字符串类型数据，长度为 20 的索引，区分度会高达 90%以上，可以使用 count(distinct left(列名, 索引长度))/count(*)的区分度来确定。</li></ul><p>【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决。</p><ul><li>说明:索引文件具有 B-Tree 的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索 引。</li></ul><p>【推荐】如果有 order by 的场景，请注意利用索引的有序性。order by 最后的字段是组合 索引的一部分，并且放在索引组合顺序的最后，避免出现 file_sort 的情况，影响查询性能。</p><ul><li>正例:where a=? and b=? order by c; 索引:a_b_c</li><li>反例:索引中有范围查找，那么索引有序性无法利用，如:WHERE a>10 ORDER BY b; 索引 a_b 无法排序。</li></ul><p>【推荐】利用覆盖索引来进行查询操作，避免回表。</p><ul><li>说明:如果一本书需要知道第 11 章是什么标题，会翻开第 11 章对应的那一页吗?目录浏览 一下就好，这个目录就是起到覆盖索引的作用。 正例:能够建立索引的种类:主键索引、唯一索引、普通索引，而覆盖索引是一种查询的一种 效果，用explain的结果，extra列会出现:using index。</li></ul><p>【推荐】利用延迟关联或者子查询优化超多分页场景。</p><ul><li>说明:MySQL 并不是跳过 offset 行，而是取 offset+N 行，然后返回放弃前 offset 行，返回 N 行，那当 offset 特别大的时候，效率就非常的低下，要么控制返回的总页数，要么对超过 特定阈值的页数进行 SQL 改写。</li><li>正例:先快速定位需要获取的 id 段，然后再关联: SELECT a.* FROM 表 1 a, (select id from 表 1 where 条件 LIMIT 100000,20 ) b where a.id=b.id</li></ul><p>【推荐】SQL 性能优化的目标:至少要达到 range 级别，要求是 ref 级别，如果可以是 consts 最好。</p><ul><li>说明:consts 单表中最多只有一个匹配行(主键或者唯一索引)，在优化阶段即可读取到数据。ref 指的是使用普通的索引(normal index)。range 对索引进行范围检索。</li><li>反例:explain 表的结果，type=index，索引物理文件全扫描，速度非常慢，这个 index 级 别比较 range 还低，与全表扫描是小巫见大巫。</li></ul><p>【推荐】建组合索引的时候，区分度最高的在最左边。</p><ul><li>正例:如果 where a=? and b=? ，a 列的几乎接近于唯一值，那么只需要单建 idx_a 索引即 可。</li><li>说明:存在非等号和等号混合判断条件时，在建索引时，请把等号条件的列前置。如:where a>? and b=? 那么即使 a 的区分度更高，也必须把 b 放在索引的最前列。</li></ul><p>【推荐】防止因字段类型不同造成的隐式转换，导致索引失效。</p><p>【参考】创建索引时避免有如下极端误解:</p><ol start=1><li>宁滥勿缺。认为一个查询就需要建一个索引。</li><li>宁缺勿滥。认为索引会消耗空间、严重拖慢更新和新增速度。</li><li>抵制惟一索引。认为业务的惟一性一律需要在应用层通过“先查后插”方式解决。</li></ol><h2 class=pgc-h-arrow-right>3）查询规约</h2><p>【强制】禁止使用select *，只获取必要字段</p><ul><li>说明：select *会增加cpu/io/内存/带宽的消耗指定字段能有效利用索引覆盖指定字段查询，在表结构变更时，能保证对应用程序无影响</li></ul><p>【推荐】insert必须指定字段，禁止使用insert into T values()</p><ul><li>说明：指定字段插入，在表结构变更时，能保证对应用程序无影响</li></ul><p>【强制】隐式类型转换会使索引失效，导致全表扫描</p><p>【强制】禁止在where条件列使用函数或者表达式</p><ul><li>说明：导致不能命中索引，全表扫描</li></ul><p>【强制】禁止负向查询以及%开头的模糊查询</p><ul><li>说明：导致不能命中索引，全表扫描</li></ul><p>【强制】禁止大表JOIN和子查询（非离线大数据库）</p><p>【推荐】同一个字段上的OR必须改写问IN，IN的值必须少于50个</p><p>【推荐】应用程序必须捕获SQL异常</p><ul><li>说明：方便定位线上问题</li></ul><p>【强制】不要使用 count(列名)或 count(常量)来替代 count(*)，count(*)是 SQL92 定义的 标准统计行数的语法，跟数据库无关，跟 NULL 和非 NULL 无关。</p><ul><li>说明:count(*)会统计值为 NULL 的行，而 count(列名)不会统计此列为 NULL 值的行。</li></ul><p>【强制】count(distinct col) 计算该列除 NULL 之外的不重复行数，注意 count(distinct col1, col2) 如果其中一列全为NULL，那么即使另一列有不同的值，也返回为0。</p><p>【强制】当某一列的值全是 NULL 时，count(col)的返回结果为 0，但 sum(col)的返回结果为 NULL，因此使用 sum()时需注意 NPE 问题。</p><ul><li>正例:可以使用如下方式来避免sum的NPE问题:SELECT IF(ISNULL(SUM(g)),0,SUM(g)) FROM table;</li></ul><p>【强制】使用 ISNULL()来判断是否为 NULL 值。</p><ul><li>说明:NULL 与任何值的直接比较都为 NULL。</li><li>NULL&lt;>NULL的返回结果是NULL，而不是false。</li><li>NULL=NULL的返回结果是NULL，而不是true。</li><li>NULL&lt;>1的返回结果是NULL，而不是true。</li></ul><p>【强制】 在代码中写分页查询逻辑时，若 count 为 0 应直接返回，避免执行后面的分页语句。</p><p>【强制】不得使用外键与级联，一切外键概念必须在应用层解决。</p><ul><li>说明:以学生和成绩的关系为例，学生表中的 student_id 是主键，那么成绩表中的 student_id 则为外键。如果更新学生表中的 student_id，同时触发成绩表中的 student_id 更新，即为 级联更新。外键与级联更新适用於单机低并发，不适合分布式、高并发集群;级联更新是强阻 塞，存在数据库更新风暴的风险;外键影响数据库的插入速度。</li></ul><p>【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。</p><p>【强制】数据订正时，删除和修改记录时，要先 select，避免出现误删除，确认无误才能执 行更新语句。</p><p>【推荐】in 操作能避免则避免，若实在避免不了，需要仔细评估 in 后边的集合元素数量，控制在 1000 个之内。</p><p>【参考】如果有全球化需要，所有的字符存储与表示，均以 utf-8 编码，注意字符统计函数 的区别。</p><ul><li>说明:SELECT LENGTH("轻松工作"); 返回为12SELECT CHARACTER_LENGTH("轻松工作"); 返回为4 如果需要存储表情，那么选择 utfmb4 来进行存储，注意它与 utf-8 编码的区别。</li></ul><p>【参考】TRUNCATE TABLE 比 DELETE 速度快，且使用的系统和事务日志资源少，但 TRUNCATE 无事务且不触发 trigger，有可能造成事故，故不建议在开发代码中使用此语句。</p><ul><li>说明:TRUNCATE TABLE 在功能上与不带 WHERE 子句的 DELETE 语句相同。</li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'MySQL','规约','初稿'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>