<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一次Linux系统被攻击的分析过程 | 极客快訊</title><meta property="og:title" content="一次Linux系统被攻击的分析过程 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/58901796bd164bfaa0e816d40803910c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1a7b782b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1a7b782b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1a7b782b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1a7b782b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1a7b782b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1a7b782b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1a7b782b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1a7b782b.html><meta property="article:published_time" content="2020-10-29T21:09:18+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:18+08:00"><meta name=Keywords content><meta name=description content="一次Linux系统被攻击的分析过程"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/1a7b782b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一次Linux系统被攻击的分析过程</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>点击上方 "程序员小乐"关注, 星标或置顶一起成长</p><p>每天凌晨00点00分, 第一时间与你相约</p><p><br></p><p>每日英文</p><p>I may not be perfect, but I’m always me. Be yourself, don't change for anyone. If they don't like me at my worst, then they don't deserve me at my best.</p><p>我也许不完美，但我一直在做自己。如果他们不能接受最差的我，也就不配拥有最好的我。</p><p><br></p><p>每日掏心话</p><p>随和，是一种能力、素质、文化和心态。随和，是淡泊名利时的超然，是曾经沧海后的井然，是狂风 暴雨中的坦然。</p><p><br></p><p>来自：南非蚂蚁 | 责编：乐乐</p><p>链接：blog.51cto.com/ixdba/1431305</p><p><div class="pgc-image pgc-card-fixWidth"><div class="pgc-img-wrapper ttcore-relative"><img alt=一次Linux系统被攻击的分析过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/58901796bd164bfaa0e816d40803910c></div></div></p><p>程序员小乐(ID:study_tech)第 888 次推文 图源：百度</p><p><br></p><p>往日回顾：用漫画了解 Linux 内核到底长啥样！</p><p><br></p><p>正文</p><p><br></p><p>T行业发展到现在，安全问题已经变得至关重要，从最近的“棱镜门”事件中，折射出了很多安全问题，信息安全问题已变得刻不容缓，而做为运维人员，就必须了解一些安全运维准则，同时，要保护自己所负责的业务，首先要站在攻击者的角度思考问题，修补任何潜在的威胁和漏洞。</p><p><br></p><p>一次Linux被入侵后的分析</p><p><br></p><p>下面通过一个案例介绍下当一个服务器被rootkit入侵后的处理思路和处理过程，rootkit攻击是Linux系统下最常见的攻击手段和攻击方式。</p><p><br></p><p>1、受攻击现象<br></p><p><br></p><p>这是一台客户的门户网站服务器，托管在电信机房，客户接到电信的通知：由于此服务器持续对外发送数据包，导致100M带宽耗尽，于是电信就切断了此服务器的网络。此服务器是Centos5.5版本，对外开放了80、22端口。从客户那里了解到，网站的访问量并不大，所以带宽占用也不会太高，而耗尽100M的带宽是绝对不可能的，那么极有可能是服务器遭受了流量攻击，于是登录服务器做详细的检测。</p><p><br></p><p>2、初步分析</p><p><br></p><p>在电信人员的配合下通过交换机对该服务器的网络流量进行了检测，发现该主机确实存在对外80端口的扫描流量，于是登录系统通过“netstat –an”命令对系统开启的端口进行检查，可奇怪的是，没有发现任何与80端口相关的网络连接。接着使用“ps –ef”、“top”等命令也没有发现任何可疑的进程。于是怀疑系统是否被植入了rootkit。为了证明系统是否被植入了rootkit，我们将网站服务器下的ps、top等命令与之前备份的同版本可信操作系统命令做了md5sum校验，结果发现网站服务器下的这两个命令确实被修改过，由此断定，此服务器已经被入侵并且安装了rootkit级别的后门程序。</p><p><br></p><p>3、断网分析系统</p><p><br></p><p>由于服务器不停向外发包，因此，首先要做的就是将此服务器断开网络，然后分析系统日志，寻找攻击源。但是系统命令已经被替换掉了，如果继续在该系统上执行操作将变得不可信，这里可以通过两种方法来避免这种情况，第一种方法是将此服务器的硬盘取下来挂载到另外一台安全的主机上进行分析，另一种方式就是从一个同版本可信操作系统下拷贝所有命令到这个入侵服务器下某个路径，然后在执行命令的时候指定此命令的完整路径即可，这里采用第二种方法。</p><p><br></p><p>我们首先查看了系统的登录日志，查看是否有可疑登录信息，执行如下命令：</p><p><br></p><p>more /var/log/secure |grep Accepted<br></p><p><br></p><p>通过对命令输出的查看，有一条日志引起了我们的怀疑：</p><p><br></p><p>Oct 3 03:10:25 webserver sshd[20701]: Accepted password for mail from 62.17.163.186 port 53349 ssh2<br></p><p><br></p><p>这条日志显示在10月3号的凌晨3点10分，有个mail帐号从62.17.163.186这个IP成功登录了系统，mail是系统的内置帐号，默认情况下是无法执行登录操作的，而62.17.163.186这个IP，经过查证，是来自爱尔兰的一个地址。从mail帐号登录的时间来看，早于此网站服务器遭受攻击的时间。接着查看一下系统密码文件/etc/shadow，又发现可疑信息：</p><p><br></p><p>mail:$1$kCEd3yD6$W1evaY5BMPQIqfTwTVJiX1:15400:0:99999:7:::<br></p><p><br></p><p>很明显，mail帐号已经被设置了密码，并且被修改为可远程登录，之所以使用mail帐号，猜想可能是因为入侵者想留下一个隐蔽的帐号，以方便日后再次登录系统。然后继续查看其他系统日志，</p><p>如/var/log/messages、/var/log/wtmp均为空文件，可见，入侵者已经清理了系统日志文件，至于为何没有清空/var/log/secure文件，就不得而知了。</p><p><br></p><p>4、寻找攻击源</p><p><br></p><p>到目前为止，我们所知道的情况是，有个mail帐号曾经登录过系统，但是为何会导致此网站服务器持续对外发送数据包呢？必须要找到对应的攻击源，通过替换到此服务器上的ps命令查看系统目前运行的进程，又发现了新的可疑：</p><p><br></p><p>nobody 22765 1 6 Sep29 ? 4-00:11:58 .t<br></p><p><br></p><p>这个.t程序是什么呢，继续执行top命令，结果如下：</p><p><br></p><p>PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND<br>22765 nobody 15 0 1740m 1362m 1228 S 98.3 91.5 2892:19 .t</p><p><br></p><p>从输出可知，这个t程序已经运行了4天左右，运行这个程序的是nobody用户，并且这个t程序消耗了大量的内存和cpu，这也是之前客户反映的网站服务器异常缓慢的原因，从这个输出，我们得到了t程序的进程PID为22765，接下来根据PID查找下执行程序的路径在哪里：进入内存目录，查看对应PID目录下exe文件的信息：</p><p><br></p><p>[root@webserver ~]# /mnt/bin/ls -al /proc/22765/exe<br>lrwxrwxrwx 1 root root 0 Sep 29 22:09 /proc/22765/exe -> /var/tmp/…/apa/t</p><p><br></p><p>这样就找到了进程对应的完整程序执行路径，这个路径很隐蔽，由于/var/tmp目录默认情况下任何用户可读性，而入侵者就是利用这个漏洞在/var/tmp目录下创建了一个“…”的目录，而在这个目录下隐藏着攻击的程序源，进入/var/tmp/…/目录，发现了一些列入侵者放置的rootkit文件，列表如下：</p><p><br></p><p>[root@webserver ...]#/mnt/bin/ls -al<br>drwxr-xr-x 2 nobody nobody 4096 Sep 29 22:09 apa<br>-rw-r--r-- 1 nobody nobody 0 Sep 29 22:09 apa.tgz<br>drwxr-xr-x 2 nobody nobody 4096 Sep 29 22:09 caca<br>drwxr-xr-x 2 nobody nobody 4096 Sep 29 22:09 haha<br>-rw-r--r-- 1 nobody nobody 0Sep 29 22:10 kk.tar.gz<br>-rwxr-xr-x 1 nobody nobody 0 Sep 29 22:10 login<br>-rw-r--r-- 1 nobody nobody 0 Sep 29 22:10 login.tgz<br>-rwxr-xr-x 1 nobody nobody 0 Sep 29 22:10 z</p><p><br></p><p>通过对这些文件的分析，基本判断这就是我们要找的程序攻击源，其中：</p><p>1）、z程序是用来清除系统日志等相关信息的，例如执行：</p><p><br></p><p>./z 62.17.163.186<br></p><p><br></p><p>这条命令执行后，系统中所有与62.17.163.186有关的日志将全部被清除掉。</p><p><br></p><p>2）、在apa目录下有个后门程序t，这个就是之前在系统中看到的，运行此程序后，此程序会自动去读apa目录下的ip这个文件，而ip这个文件记录了各种ip地址信息，猜想这个t程序应该是去扫描ip文件中记录的所有ip信息，进而获取远程主机的权限，可见这个网站服务器已经是入侵者的一个肉鸡了。</p><p><br></p><p>3）、haha目录里面放置的就是用来替换系统相关命令的程序，也就是这个目录下的程序使我们无法看到操作系统的异常情况。</p><p><br></p><p>4）、login程序就是用来替换系统登录程序的木马程序，此程序还可以记录登录帐号和密码。</p><p><br></p><p>5、查找攻击原因</p><p><br></p><p>到这里为止，服务器上遭受的攻击已经基本清晰了，但是入侵者是如何侵入这台服务器的呢？这个问题很重要，一定要找到入侵的根源，才能从根本上封堵漏洞。为了弄清楚入侵者是如何进入服务器的，需要了解下此服务器的软件环境，这台服务器是一个基于java的web服务器，安装的软件有apache2.0.63、tomcat5.5，apache和tomcat</p><p>之间通过mod_jk模块进行集成，apache对外开放80端口，由于tomcat没有对外开放端口，所以将问题集中到apache上面。通过查看apache的配置发现，apache仅仅处理些静态资源请求，而网页也以静态页面居多，所以通过网页方式入侵系统可能性不大，既然漏洞可能来自于apache，那么尝试查看apache日志，也许能发现一些可疑的访问痕迹，通过查看access.log文件，发现了如下信息：</p><p><br></p><p>62.17.163.186 - - [29/Sep/2013:22:17:06 +0800] "GET http://www.xxx.com/cgi-bin/awstats.pl?configdir=|echo;echo;ps+-aux%00 HTTP/1.0" 200 12333 "-" "Mozilla/5.0 (Windows; U; Windows NT 5.1; pt-BR; rv:1.8.1) Gecko/20121010 Firefox/2.0"<br>62.17.163.186 - - [29/Sep/213:22:17:35 +0800] "GET http://www.xxx.com/cgi-bin/awstats.pl?configdir=|echo;echo;cd+/var/tmp/.../haha;ls+-a%00 HTTP/1.0" 200 1626 "-" "Mozilla/5.0 (Windows; U; Windows NT 5.1; pt-BR; rv:1.8.1) Gecko/20121010 Firefox/2.0"</p><p><br></p><p>至此，发现了漏洞的根源，原来是awstats.pl脚本中configdir的一个漏洞，通过了解此服务器的应用，客户确实是通过一个Awstats的开源插件来做网页访问统计，通过这个漏洞，攻击者可以直接在浏览器上操作服务器，例如查看进程、创建目录等。通过上面第二条日志可以看出，攻击者正常浏览器执行切换到/var/tmp/.../haha目录的操作。这个脚本漏洞挺可怕的，不过在Awstats官网也早已给出了修补的方法，对于这个漏洞，修复方法很简单，打开awstats.pl文件，找到如下信息：</p><p><br></p><p>if ($QueryString =~ /configdir=([^&]+)/i)<br>{<br>$DirConfig=&DecodeEncodedString("$1");<br>}<br>修改为如下即可：<br>if ($QueryString =~ /configdir=([^&]+)/i)<br>{<br>$DirConfig=&DecodeEncodedString("$1");<br>$DirConfig=~tr/a-z0-9_\-\/\./a-z0-9_\-\/\./cd;<br>}</p><p><br></p><p>6、揭开谜团</p><p><br></p><p>通过上面逐步分析和介绍，此服务遭受入侵的原因和过程已经非常清楚了，大致过程如下：</p><p><br></p><p>（1）攻击者通过Awstats脚本awstats.pl文件的漏洞进入了系统，在/var/tmp目录下创建了隐藏目录，然后将rootkit后门文件传到这个路径下。</p><p>（2）攻击者通过植入后门程序，获取了系统超级用户权限，进而控制了这台服务器，通过这台服务器向外发包。</p><p>（3）攻击者的IP地址62.17.163.186可能是通过代理过来的，也可能是攻击者控制的其他肉鸡服务器。</p><p>（4）攻击者为了永久控制这台机器，修改了系统默认帐号mail的信息，将mail帐号变为可登录，并且设置了mail帐号的密码。</p><p>（5）攻击者在完成攻击后，通过后门程序自动清理了系统访问日志，毁灭了证据。</p><p><br></p><p>通过对这个入侵过程的分析，发现入侵者的手段还是非常简单和普遍的，虽然入侵者删除了系统的一些日志，但是还是留下了很多可查的踪迹，其实还可以查看用户下的.bash_history文件，这个文件是用户操作命令的历史记录。</p><p><br></p><p>7、如何恢复网站</p><p><br></p><p>由于系统已经文件被更改和替换，此系统已经变得完全不可信，因此建议备份网站数据，重新安装系统，基本步骤如下：</p><p><br></p><p>（1）安装稳定版本的操作系统，删除系统默认的并且不需要的用户。</p><p>（2）系统登录方式改为公钥认证方式，避开密码认证的缺陷。</p><p>（3）安装更高版本的apache和最新稳定版本的Awstats程序。</p><p>（4）使用Linux下的Tcp_Wrappers防火墙，限制ssh登录的源地址。</p><p><br></p><p>欢迎在留言区留下你的观点，一起讨论提高。如果今天的文章让你有新的启发，学习能力的提升上有新的认识，欢迎转发分享给更多人。</p><p><br></p><p>猜你还想看</p><p><br></p><p>阿里、腾讯、百度、华为、京东最新面试题汇集</p><p>基础原理系列：服务端 TCP 连接的 TIME_WAIT 问题<br></p><p>JAVA 泛型中的通配符 T，E，K，V，？<br></p><p>SpringBoot 源码分析之 SpringBoot 可执行文件解析<br></p><p><br></p><p>关注订阅号「程序员小乐」，收看更多精彩内容<br>嘿，你在看吗？</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Linux','系统','攻击'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../cn/%E7%A7%91%E6%8A%80/b63bc904.html alt="【安全】一次 Linux 系统被攻击的分析过程" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c457db82bc1345858b769d5bd0db522d style=border-radius:25px></a>
<a href=../../cn/%E7%A7%91%E6%8A%80/b63bc904.html title="【安全】一次 Linux 系统被攻击的分析过程">【安全】一次 Linux 系统被攻击的分析过程</a></li><hr><li><a href=../../cn/%E7%A7%91%E6%8A%80/88ede700.html alt="一次 Linux 系统被攻击的分析过程" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../cn/%E7%A7%91%E6%8A%80/88ede700.html title="一次 Linux 系统被攻击的分析过程">一次 Linux 系统被攻击的分析过程</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>