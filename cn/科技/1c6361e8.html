<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>JavaWeb中文编码问题全面解析 | 极客快訊</title><meta property="og:title" content="JavaWeb中文编码问题全面解析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/15356769126428630e07a7b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1c6361e8.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1c6361e8.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1c6361e8.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1c6361e8.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1c6361e8.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1c6361e8.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1c6361e8.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1c6361e8.html><meta property="article:published_time" content="2020-10-29T21:09:08+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:08+08:00"><meta name=Keywords content><meta name=description content="JavaWeb中文编码问题全面解析"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/1c6361e8.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>JavaWeb中文编码问题全面解析</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>需要编码的原因</h1><ul><li>计算机中存储的最小单元是一个字节，即8bit，所以能表示的字符范围是0~255个。</li><li>人类要表示的符号太多，无法用一个字节来完全表示。</li><li>要解决这个矛盾必须要有一个新的数据结构char，从char到byte必须编码。</li></ul><h1>编码格式</h1><ol><li><strong>ASCII</strong></li></ol><ul><li class=ql-indent-1>ASCII码共有128个，用一个字节的低7位表示，0~31是控制字符，如换行、回车、删除等；32~126是打印字符，可以通过键盘输入并能够显示出来。</li></ul><ol><li><strong>ISO-8859-1</strong></li></ol><ul><li class=ql-indent-1>128个字符显然是不够用的，ISO组织在ASCII码的基础上又制定了一系列标准用来扩展ASCII编码，他们是ISO-8859-1~ISO-8859-15，其中ISO-8859-1涵盖了大多数西欧语言字符，所以应用最广泛。ISO-8859-1任然是单字节编码，它总共能表示256个字符。</li></ul><ol><li><strong>GB2312</strong></li></ol><ul><li class=ql-indent-1>它的全称是《信息交换用汉字编码字符集基本集》，它是双字节编码，总的编码范围是A1~F7，其中从A1~A9是符号区，总共包含682个字符。从B0~F7是汉字区，包含6763个汉字。</li></ul><ol><li><strong>GBK</strong></li></ol><ul><li class=ql-indent-1>全称《汉字内码扩展规范》，为了扩展GB2312加入了更多的汉字，它的编码是和GB2312是兼容的，也就是说GB2312编码的汉字可以用GBK来解码，并且不会有乱码。</li></ul><ol><li><strong>GB18030</strong></li></ol><ul><li class=ql-indent-1>是我国强制标准，它可能是单字节、双字节、或者四字节编码，与GB2312兼容，应用并不广泛。</li></ul><ol><li><strong>UTF-16</strong></li></ol><ul><li class=ql-indent-1>用两个字节来表示Unicode转化格式，它是定长的表示方法，不论什么字符都可以用两个字节表示，两个字节是16bit，所以叫UTF-16。每两个字节表示一个字符，这就大大简化了字符串的操作，这也是java以UTF-16作为内存字符存储格式的一个很重要的原因。</li></ul><ol><li><strong>UTF-8</strong></li></ol><ul><li class=ql-indent-1>UTF-16同意采用两个字符表示一个字节，但是很大一部分字符用一个字节就可以表示现在却要用两个字符表示，存储空间放大了一倍，而现在网络带宽还非常有限，这样会增大网络传输的流量，而且也没必要。而UTF-8采用了一种变长的技术，每个编码区域有不同的字码长度。不同类型的字符可以由1~6个字节组成。</li></ul><h1>java中需要编码的场景</h1><h1><strong>I/O操作中存在的编码</strong></h1><ul><li>涉及编码的地方一般在字符到字节或者字节带字符的转换上，二需要这种转换的场景主要是I/O。</li><li>Reader类是java的i/o中读字符的父类，而inputstream类是读字节的父类，inputstreamreader类就是关联字节到字符的桥梁，它负责在I/O过程中处理读取字节到字符的转换，而具体字节到字符的解码又委托streamdecoder去做，在streamdecoder解码过程中必须有用户指定charset编码格式，如果没有指定charset，将使用本地环境中的默认字符集。</li></ul><div class=pgc-img><img alt=JavaWeb中文编码问题全面解析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15356769126428630e07a7b><p class=pgc-img-caption></p></div><ul><li><br></li><li>写的情况也类似，字符的父类是writer，字节的父类是outputstream，通过outputstreamwriter转换字符到字节。StreamEncoder类负责将字符编码成字节，编码格式和默认编码规则与解码是一致的。</li><li><strong>强烈建议不要使用操作系统的默认编码，因为这样你的应用程序的编码格式就和运行环境绑定起来了，在跨环境是很可能出现乱码。</strong></li></ul><h1><strong>内存操作中的乱码</strong></h1><ul><li>内存中进行字符到字节的转换也很常见。</li></ul><pre>String s = "这是一段中文字符";byte[] b = s.getBytes("utf-8");String n = new String(b,"utf-8");Charset charset = Charset.forName("utf-8");ByteBuffer byteBuffer = charset.encode(string);CharBuffer charBuffer = charset.decode(byteBuffer);</pre><h1><strong>Java中如何编解码</strong></h1><ul><li>以字符串“I am 君山”为例。</li><li><strong>按照ISO-8859-1编码</strong></li></ul><div class=pgc-img><img alt=JavaWeb中文编码问题全面解析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1535676914173eb1c7d70aa><p class=pgc-img-caption></p></div><ul><li><br></li><li class=ql-indent-1>ISO-8859-1是单字节编码，中文“君山”被转化成值是3f的byte，3f也就是“?”字符。所以经常会出现中文变成“?”，很可能就是错误地使用了ISO-8859-1编码导致的。</li><li><strong>按照GB2312编码</strong></li></ul><div class=pgc-img><img alt=JavaWeb中文编码问题全面解析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1535676915022d535b6f3f1><p class=pgc-img-caption></p></div><ul><li><br></li><li class=ql-indent-1>GB2312字符集有一个char到byte的码表，不同的字符编码就查这个码表找到与每个字符的对应字节，然后拼装成byte数组。</li><li><strong>按照GBK编码</strong></li><li class=ql-indent-1>GBK与GB2312编码结果是一样的；</li><li class=ql-indent-1>由此可以看出来GBK编码是兼容GB2312编码的，他们的编码算法是一样的。</li><li class=ql-indent-1>不同的是它们的码表长度不一样，GBK包含的汉字字符更多，所以只要是经过GB2312编码的汉字都可以用GBK进行解码，反之则不然。</li><li><strong>按照utf-16编码</strong></li></ul><div class=pgc-img><img alt=JavaWeb中文编码问题全面解析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153567691238209f7641b3b><p class=pgc-img-caption></p></div><ul><li><br></li><li class=ql-indent-1>用utf-16编码将char数组放大了一倍，单字节范围内的字符在高位补0变成两个字节，中文字符也变两个字节。</li><li class=ql-indent-1>编码效率非常高，规则很简单。</li><li><strong>按照utf-8编码</strong></li></ul><div class=pgc-img><img alt=JavaWeb中文编码问题全面解析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15356769150614dc8a2554e><p class=pgc-img-caption></p></div><ul><li><br></li><li class=ql-indent-1>UTF-16采用顺序编码，不能对单个字符的编码值进行校验，如果中间的一个字符码值损坏，后面所有的码值都将受到影响。</li><li class=ql-indent-1>而UTF-8不存在这些问题，UTF-8对单字节范围内字符任然用一个字节表示，对汉字采用三个字节表示。</li><li class=ql-indent-1>UTF-8编码与GBK和GB2312不同，不用查码表，所以在编码效率上UTF-8的效率会更好，所以在存储中文字符时UTF-8编码比较理想。</li><li><strong>几种编码格式的比较</strong></li><li class=ql-indent-1>GB2312与GBK的编码规则类似，但是GBK范围更大，所以GB2312与GBK比较，应该选择GBK；</li><li class=ql-indent-1>utf-16与utf-8都是处理Unicode编码，编码规则不太相同，相对来说utf-16编码效率最高，字符到字节相互转换更简单，进行字符操作也更好，它适合本地磁盘和内存之间使用，可以进行字符和字节中间的快速切换，java内存编码就采用utf-16编码；</li><li class=ql-indent-1>但是UTF-16不适合网络之间的传输，因为网络传输容易损坏字节流，一旦字节流损坏就很难恢复，相比较而言，utf-8更适合网络传输，单个字符的损坏不会影响后面其他字符，编码效率介于GBK和UTF-16之间；</li><li class=ql-indent-1>UTF-8在编码效率上和安全性上做了平衡，是理想的中文编码方式。</li></ul><h1>Java Web中涉及的编解码</h1><ul><li><strong>URL的编解码</strong></li><li>浏览器编码URL将非ASCII字符按照某种编码格式编码成16进制数字后在每个16进制表示的字节前加上“%”，所以就出现了如下情况：</li></ul><pre class=ql-indent-1>http://tanqingbo.com/2016/05/11/%E5%A4%8F%E4%BB%A4%E8%90%A5%E6%B1%87%E6%80%BB/</pre><ul><li><strong>http Header的编码</strong></li><li class=ql-indent-1>header中传递参数，如：Cookie、redirectPath等，这些用户设置的值可能存在编码问题。</li><li class=ql-indent-1>对header进行解码实在调用request.getHeader时进行的，这个方法将byte到char的转化使用的是ISO-8859-1，不能手动设置Header的其他解码格式，如果有非ASCII字符肯定会有乱码；</li><li class=ql-indent-1>不要在header中传递非ASCII字符，如果一定要出传递，可以先将这些字符用org.apache.catalina.util.URLEncoder编码，然后再添加到header中。</li><li>访问数据库都是通过客户端JDBC驱动来完成的，用JDBC来存取数据要和数据的内置编码保持一致，可以通过设置JDBC URL来指定，如：MySQL：</li></ul><pre>jdbcUrl="jdbc:mysql://localhost:3306/boke?characterEncoding=utf-8"</pre><h1>JS中的编码问题</h1><ul><li><strong>外部引入JS文件</strong></li></ul><div class=pgc-img><img alt=JavaWeb中文编码问题全面解析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153567691293951d0a6c713><p class=pgc-img-caption></p></div><ul><li><br></li><li class=ql-indent-1>如果script没有设置charset，浏览器就会以当前这个页面的默认字符集解析这个JS文件，如果外部的JS文件的编码格式与当前页面的编码格式一致，那么可以不设置这个charset，但是如果script.js文件的编码格式与当前页面不一致，上面的那段中文输入就会变成乱码。</li><li><strong>JS的URL编码</strong></li><li class=ql-indent-1>实际上JS中处理URL编码有三个函数，只要掌握了这三个函数，基本上就能正确处理JS的URL乱码问题了；</li></ul><ol><li>escape()</li></ol><ul><li class=ql-indent-2>这个函数是将非ascii字符转化成Unicode编码值，并且在编码值前加上“%u”；</li></ul><ol><li class=ql-indent-2>解码通过unescape()函数；</li><li class=ql-indent-1>通过将特殊字符换成Unicode编码值可以避免因为编码的字符集的不兼容而出现的信息丢失问题，在服务端通过解码参数就可以避免乱码的问题。</li></ol><ul><li>encodeURL()</li><li class=ql-indent-2>与escape()相比，encodeURL()是真正的JS用来对URL编码的函数，它可以将整个URL中的字符(除了一些特殊字符，如：符号、数字、字母)进行UTF-8编码，在每个值之前加上“%”；</li><li class=ql-indent-1>解码通过encodeURL函数。</li><li>encodeURLComponent()</li><li class=ql-indent-2>encodeURLComponent()这个函数比encodeURL()编码还要彻底；</li><li class=ql-indent-1>通常用于将一个URL当做参数放在另一个URL中；</li><li>其他需要编码的地方</li><li>XML文件可以通过设置投来制定编码格式：</li></ul><pre class=ql-indent-2>&lt;?xml version"1.0" encoding="UTF-8"&gt;</pre><ul><li>Velocity(基于Java的模板引擎)设置编码格式：</li></ul><pre class=ql-indent-2>services.VelocityService.input.encoding=uft-8</pre><ul><li>Jsp设置编码格式：</li></ul><pre>&lt;%@page contentType="text/html; charset=utf-8"&gt;</pre><h1>常见问题分析</h1><ul><li><strong>中文变成了看不懂的字符</strong></li></ul><div class=pgc-img><img alt=JavaWeb中文编码问题全面解析 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/15356774216680a42670802><p class=pgc-img-caption></p></div><ul><li><strong>一个汉字变成一个问号</strong></li></ul><div class=pgc-img><img alt=JavaWeb中文编码问题全面解析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15356774065582501c15586><p class=pgc-img-caption></p></div><ul><li><strong>一个汉字变成两个问号</strong></li></ul><div class=pgc-img><img alt=JavaWeb中文编码问题全面解析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/153567738060802c967526b><p class=pgc-img-caption></p></div><ul><li><strong>一种不正常的正确编码</strong></li><li>我们通过request.getParameter获取参数值时，直接调用：</li></ul><pre class=ql-indent-1>String value = request.getParameter(name);</pre><ul><li>会出现乱码，但是用如下方式：</li></ul><pre class=ql-indent-1>String value = new String(request.getParameter(name).getBytes("ISO-8859-1"),"GBK");</pre><ul><li class=ql-indent-1>解析时取得的value会是正确的汉字字符。</li></ul></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'JavaWeb','编码','问题'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>