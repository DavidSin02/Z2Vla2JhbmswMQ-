<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ä¸€èµ·æ¥è°ˆè°ˆThreadLocal åŸç†å§ï¼ä½ éœ€è¦äº†è§£ï¼ | æå®¢å¿«è¨Š</title><meta property="og:title" content="ä¸€èµ·æ¥è°ˆè°ˆThreadLocal åŸç†å§ï¼ä½ éœ€è¦äº†è§£ï¼ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/499a403f2b63464db8e3e12298c1a3e5"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1c9afde0.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1c9afde0.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1c9afde0.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1c9afde0.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1c9afde0.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1c9afde0.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/1c9afde0.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/1c9afde0.html><meta property="article:published_time" content="2020-11-14T21:07:43+08:00"><meta property="article:modified_time" content="2020-11-14T21:07:43+08:00"><meta name=Keywords content><meta name=description content="ä¸€èµ·æ¥è°ˆè°ˆThreadLocal åŸç†å§ï¼ä½ éœ€è¦äº†è§£ï¼"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/1c9afde0.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ä¸€èµ·æ¥è°ˆè°ˆThreadLocal åŸç†å§ï¼ä½ éœ€è¦äº†è§£ï¼</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p><strong>æˆ‘ä»¬éƒ½çŸ¥é“å½“å¤šçº¿ç¨‹è®¿é—®å…±äº«å¯å˜æ•°æ®æ—¶ï¼Œæ¶‰åŠåˆ°çº¿ç¨‹é—´åŒæ­¥çš„é—®é¢˜ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æ—¶å€™ï¼Œéƒ½è¦ç”¨åˆ°å…±äº«æ•°æ®ï¼Œæ‰€ä»¥å°±éœ€è¦çº¿ç¨‹å°é—­å‡ºåœºäº†ã€‚</strong></p><p>æ•°æ®éƒ½è¢«å°é—­åœ¨å„è‡ªçš„çº¿ç¨‹ä¹‹ä¸­ï¼Œå°±ä¸éœ€è¦åŒæ­¥ï¼Œè¿™ç§é€šè¿‡å°†æ•°æ®å°é—­åœ¨çº¿ç¨‹ä¸­è€Œé¿å…ä½¿ç”¨åŒæ­¥çš„æŠ€æœ¯ç§°ä¸º<strong>ã€Œçº¿ç¨‹å°é—­ã€</strong>ã€‚</p><p>æœ¬æ–‡ä¸»è¦ä»‹ç»çº¿ç¨‹å°é—­ä¸­çš„å…¶ä¸­ä¸€ç§ä½“ç°ï¼šThreadLocalï¼Œå°†ä¼šä»‹ç»ä»€ä¹ˆæ˜¯ ThreadLocalï¼›ä» ThreadLocal æºç è§’åº¦åˆ†æï¼Œæœ€åä»‹ç» ThreadLocal çš„åº”ç”¨åœºæ™¯ã€‚</p><h2 class=pgc-h-arrow-right>ä»€ä¹ˆæ˜¯ ThreadLocalï¼Ÿ</h2><p>ThreadLocal æ˜¯ Java é‡Œä¸€ç§ç‰¹æ®Šå˜é‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªçº¿ç¨‹çº§åˆ«å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª ThreadLocal å°±æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰äº†è‡ªå·±ç‹¬ç«‹çš„ä¸€ä¸ªå˜é‡ï¼Œç«æ€æ¡ä»¶è¢«å½»åº•æ¶ˆé™¤äº†ï¼Œåœ¨å¹¶å‘æ¨¡å¼ä¸‹æ˜¯ç»å¯¹å®‰å…¨çš„å˜é‡ã€‚</p><p>å¯ä»¥é€šè¿‡ ThreadLocal value = new ThreadLocal(); æ¥ä½¿ç”¨ã€‚</p><p>ä¼šè‡ªåŠ¨åœ¨æ¯ä¸€ä¸ªçº¿ç¨‹ä¸Šåˆ›å»ºä¸€ä¸ª T çš„å‰¯æœ¬ï¼Œå‰¯æœ¬ä¹‹é—´å½¼æ­¤ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ï¼Œå¯ä»¥ç”¨ ThreadLocal å­˜å‚¨ä¸€äº›å‚æ•°ï¼Œä»¥ä¾¿åœ¨çº¿ç¨‹ä¸­å¤šä¸ªæ–¹æ³•ä¸­ä½¿ç”¨ï¼Œç”¨ä»¥ä»£æ›¿æ–¹æ³•ä¼ å‚çš„åšæ³•ã€‚</p><p>ä¸‹é¢é€šè¿‡ä¾‹å­æ¥äº†è§£ä¸‹ ThreadLocalï¼š</p><pre><code>public class ThreadLocalDemo {	/**	 * ThreadLocalå˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œäº’ä¸å¹²æ‰°	 */	public static final ThreadLocal&lt;String&gt; THREAD_LOCAL = new ThreadLocal&lt;&gt;();	public static void main( String[] args ) throws Exception	{		new ThreadLocalDemo().threadLocalTest();	}	public void threadLocalTest() throws Exception	{		/* ä¸»çº¿ç¨‹è®¾ç½®å€¼ */		THREAD_LOCAL.set( "wupx" );		String v = THREAD_LOCAL.get();		System.out.println( "Thread-0çº¿ç¨‹æ‰§è¡Œä¹‹å‰ï¼Œ" + Thread.currentThread().getName() + "çº¿ç¨‹å–åˆ°çš„å€¼ï¼š" + v );		new Thread( new Runnable()			    {				    @Override				    public void run()				    {					    String v = THREAD_LOCAL.get();					    System.out.println( Thread.currentThread().getName() + "çº¿ç¨‹å–åˆ°çš„å€¼ï¼š" + v );		                            /* è®¾ç½® threadLocal */					    THREAD_LOCAL.set( "huxy" );					    v = THREAD_LOCAL.get();					    System.out.println( "é‡æ–°è®¾ç½®ä¹‹åï¼Œ" + Thread.currentThread().getName() + "çº¿ç¨‹å–åˆ°çš„å€¼ä¸ºï¼š" + v );					    System.out.println( Thread.currentThread().getName() + "çº¿ç¨‹æ‰§è¡Œç»“æŸ" );				    }			    } ).start();		/* ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œç»“æŸ */		Thread.sleep( 3000L );		v = THREAD_LOCAL.get();		System.out.println( "Thread-0çº¿ç¨‹æ‰§è¡Œä¹‹åï¼Œ" + Thread.currentThread().getName() + "çº¿ç¨‹å–åˆ°çš„å€¼ï¼š" + v );	}}</code></pre><p>é¦–å…ˆé€šè¿‡ static final å®šä¹‰äº†ä¸€ä¸ª THREAD_LOCAL å˜é‡ï¼Œå…¶ä¸­ static æ˜¯ä¸ºäº†ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªä¿å­˜ String å¯¹è±¡çš„ ThreadLocal å®ä¾‹ï¼›final ç¡®ä¿ ThreadLocal çš„å®ä¾‹ä¸å¯æ›´æ”¹ï¼Œé˜²æ­¢è¢«æ„å¤–æ”¹å˜ï¼Œå¯¼è‡´æ”¾å…¥çš„å€¼å’Œå–å‡ºæ¥çš„ä¸ä¸€è‡´ï¼Œå¦å¤–è¿˜èƒ½é˜²æ­¢ ThreadLocal çš„å†…å­˜æ³„æ¼ã€‚ä¸Šé¢çš„ä¾‹å­æ˜¯æ¼”ç¤ºåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è·å–å®ƒä¼šå¾—åˆ°ä¸åŒçš„ç»“æœï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code>Thread-0çº¿ç¨‹æ‰§è¡Œä¹‹å‰ï¼Œmainçº¿ç¨‹å–åˆ°çš„å€¼ï¼šwupxThread-0çº¿ç¨‹å–åˆ°çš„å€¼ï¼šnullé‡æ–°è®¾ç½®ä¹‹åThread-0çº¿ç¨‹å–åˆ°çš„å€¼ä¸ºï¼šhuxyThread-0çº¿ç¨‹æ‰§è¡Œç»“æŸThread-0çº¿ç¨‹æ‰§è¡Œä¹‹åï¼Œmainçº¿ç¨‹å–åˆ°çš„å€¼ï¼šwupx</code></pre><p>é¦–å…ˆåœ¨ Thread-0 çº¿ç¨‹æ‰§è¡Œä¹‹å‰ï¼Œå…ˆç»™ THREAD_LOCAL è®¾ç½®ä¸º wupxï¼Œç„¶åå¯ä»¥å–åˆ°è¿™ä¸ªå€¼ï¼Œç„¶åé€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ä»¥åå»å–è¿™ä¸ªå€¼ï¼Œå‘ç°æ–°çº¿ç¨‹å–åˆ°çš„ä¸º nullï¼Œæ„å¤–ç€è¿™ä¸ªå˜é‡åœ¨ä¸åŒçº¿ç¨‹ä¸­å–åˆ°çš„å€¼æ˜¯ä¸åŒçš„ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´å¯¹äº ThreadLocal ä¼šæœ‰å¯¹åº”çš„å‰¯æœ¬ï¼Œæ¥ç€åœ¨çº¿ç¨‹ Thread-0 ä¸­æ‰§è¡Œå¯¹ THREAD_LOCAL çš„ä¿®æ”¹ï¼Œå°†å€¼æ”¹ä¸º huxyï¼Œå¯ä»¥å‘ç°çº¿ç¨‹ Thread-0 è·å–çš„å€¼å˜ä¸ºäº† huxyï¼Œä¸»çº¿ç¨‹ä¾ç„¶ä¼šè¯»å–åˆ°å±äºå®ƒçš„å‰¯æœ¬æ•°æ® wupxï¼Œè¿™å°±æ˜¯çº¿ç¨‹çš„å°é—­ã€‚</p><p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ç›¸ä¿¡å¤§å®¶ä¸€å®šä¼šå¥½å¥‡ ThreadLocal æ˜¯å¦‚ä½•åšåˆ°å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€å¯¹è±¡ set æ“ä½œï¼Œä½†æ˜¯ get è·å–çš„å€¼è¿˜éƒ½æ˜¯æ¯ä¸ªçº¿ç¨‹ set çš„å€¼å‘¢ï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬è¿›å…¥æºç è§£æç¯èŠ‚ï¼š</p><h2 class=pgc-h-arrow-right>ThreadLocal æºç è§£æ</h2><p>é¦–å…ˆçœ‹ä¸‹ ThreadLocal éƒ½æœ‰å“ªäº›é‡è¦å±æ€§ï¼š</p><pre><code>// å½“å‰ ThreadLocal çš„ hashCodeï¼Œç”± nextHashCode() è®¡ç®—è€Œæ¥ï¼Œç”¨äºè®¡ç®—å½“å‰ ThreadLocal åœ¨ ThreadLocalMap ä¸­çš„ç´¢å¼•ä½ç½®private final int threadLocalHashCode = nextHashCode();// å“ˆå¸Œé­”æ•°ï¼Œä¸»è¦ä¸æ–æ³¢é‚£å¥‘æ•£åˆ—æ³•ä»¥åŠé»„é‡‘åˆ†å‰²æœ‰å…³private static final int HASH_INCREMENT = 0x61c88647;// è¿”å›è®¡ç®—å‡ºçš„ä¸‹ä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œå…¶å€¼ä¸º i * HASH_INCREMENTï¼Œå…¶ä¸­ i ä»£è¡¨è°ƒç”¨æ¬¡æ•°private static int nextHashCode() {    return nextHashCode.getAndAdd(HASH_INCREMENT);}// ä¿è¯äº†åœ¨ä¸€å°æœºå™¨ä¸­æ¯ä¸ª ThreadLocal çš„ threadLocalHashCode æ˜¯å”¯ä¸€çš„private static AtomicInteger nextHashCode = new AtomicInteger();</code></pre><p>å…¶ä¸­çš„ HASH_INCREMENT ä¹Ÿä¸æ˜¯éšä¾¿å–çš„ï¼Œå®ƒè½¬åŒ–ä¸ºåè¿›åˆ¶æ˜¯ 1640531527ï¼Œ2654435769 è½¬æ¢æˆ int ç±»å‹å°±æ˜¯ -1640531527ï¼Œ2654435769 ç­‰äº (âˆš5-1)/2 ä¹˜ä»¥ 2 çš„ 32 æ¬¡æ–¹ã€‚(âˆš5-1)/2 å°±æ˜¯é»„é‡‘åˆ†å‰²æ•°ï¼Œè¿‘ä¼¼ä¸º 0.618ï¼Œä¹Ÿå°±æ˜¯è¯´ 0x61c88647 ç†è§£ä¸ºä¸€ä¸ªé»„é‡‘åˆ†å‰²æ•°ä¹˜ä»¥ 2 çš„ 32 æ¬¡æ–¹ï¼Œå®ƒå¯ä»¥ä¿è¯ nextHashCode ç”Ÿæˆçš„å“ˆå¸Œå€¼ï¼Œå‡åŒ€çš„åˆ†å¸ƒåœ¨ 2 çš„å¹‚æ¬¡æ–¹ä¸Šï¼Œä¸”å°äº 2 çš„ 32 æ¬¡æ–¹ã€‚</p><p>ä¸‹é¢æ˜¯ javaspecialists ä¸­ä¸€ç¯‡æ–‡ç« å¯¹å®ƒçš„ä»‹ç»ï¼š</p><blockquote class=article-blockquote><p>â</p><p>This number represents the golden ratio (sqrt(5)-1) times two to the power of 31 ((sqrt(5)-1) * (2^31)). The result is then a golden number, either 2654435769 or -1640531527.</p><p>â</p></blockquote><p>ä¸‹é¢ç”¨ä¾‹å­æ¥è¯æ˜ä¸‹ï¼š</p><pre><code>private static final int HASH_INCREMENT = 0x61c88647;public static void main(String[] args) throws Exception {    int n = 5;    int max = 2 &lt;&lt; (n - 1);    for (int i = 0; i &lt; max; i++) {        System.out.print(i * HASH_INCREMENT &amp; (max - 1));        System.out.print(" ");    }}</code></pre><p>è¿è¡Œç»“æœä¸ºï¼š0 7 14 21 28 3 10 17 24 31 6 13 20 27 2 9 16 23 30 5 12 19 26 1 8 15 22 29 4 11 18 25</p><p>å¯ä»¥å‘ç°å…ƒç´ ç´¢å¼•å€¼å®Œç¾çš„æ•£åˆ—åœ¨æ•°ç»„å½“ä¸­ï¼Œå¹¶æ²¡æœ‰å‡ºç°å†²çªã€‚</p><h3 class=pgc-h-arrow-right>ThreadLocalMap</h3><p>é™¤äº†ä¸Šè¿°å±æ€§å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„å±æ€§ ThreadLocalMapï¼ŒThreadLocalMap æ˜¯ ThreadLocal çš„é™æ€å†…éƒ¨ç±»ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æœ‰å¤šä¸ª ThreadLocal æ—¶ï¼Œéœ€è¦ä¸€ä¸ªå®¹å™¨æ¥ç®¡ç†å¤šä¸ª ThreadLocalï¼ŒThreadLocalMap çš„ä½œç”¨å°±æ˜¯ç®¡ç†çº¿ç¨‹ä¸­å¤šä¸ª ThreadLocalï¼Œæºç å¦‚ä¸‹ï¼š</p><pre><code>static class ThreadLocalMap {	/**	 * é”®å€¼å¯¹å®ä½“çš„å­˜å‚¨ç»“æ„	 */	static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; {		// å½“å‰çº¿ç¨‹å…³è”çš„ valueï¼Œè¿™ä¸ª value å¹¶æ²¡æœ‰ç”¨å¼±å¼•ç”¨è¿½è¸ª		Object value;		/**		 * æ„é€ é”®å€¼å¯¹		 *		 * @param k k ä½œ key,ä½œä¸º key çš„ ThreadLocal ä¼šè¢«åŒ…è£…ä¸ºä¸€ä¸ªå¼±å¼•ç”¨		 * @param v v ä½œ value		 */		Entry(ThreadLocal&lt;?&gt; k, Object v) {			super(k);			value = v;		}	}	// åˆå§‹å®¹é‡ï¼Œå¿…é¡»ä¸º 2 çš„å¹‚	private static final int INITIAL_CAPACITY = 16;	// å­˜å‚¨ ThreadLocal çš„é”®å€¼å¯¹å®ä½“æ•°ç»„ï¼Œé•¿åº¦å¿…é¡»ä¸º 2 çš„å¹‚	private Entry[] table;	// ThreadLocalMap å…ƒç´ æ•°é‡	private int size = 0;	// æ‰©å®¹çš„é˜ˆå€¼ï¼Œé»˜è®¤æ˜¯æ•°ç»„å¤§å°çš„ä¸‰åˆ†ä¹‹äºŒ	private int threshold;}</code></pre><p>ä»æºç ä¸­çœ‹åˆ° ThreadLocalMap å…¶å®å°±æ˜¯ä¸€ä¸ªç®€å•çš„ Map ç»“æ„ï¼Œåº•å±‚æ˜¯æ•°ç»„ï¼Œæœ‰åˆå§‹åŒ–å¤§å°ï¼Œä¹Ÿæœ‰æ‰©å®¹é˜ˆå€¼å¤§å°ï¼Œæ•°ç»„çš„å…ƒç´ æ˜¯ Entryï¼Œ<strong>ã€ŒEntry çš„ key å°±æ˜¯ ThreadLocal çš„å¼•ç”¨ï¼Œvalue æ˜¯ ThreadLocal çš„å€¼ã€</strong>ã€‚ThreadLocalMap è§£å†³ hash å†²çªçš„æ–¹å¼é‡‡ç”¨çš„æ˜¯<strong>ã€Œçº¿æ€§æ¢æµ‹æ³•ã€</strong>ï¼Œå¦‚æœå‘ç”Ÿå†²çªä¼šç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ªç©ºçš„ä½ç½®ã€‚</p><p>è¿™æ ·çš„å°±æœ‰å¯èƒ½ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œä¸‹é¢è®©æˆ‘ä»¬è¿›è¡Œåˆ†æï¼š</p><h3 class=pgc-h-arrow-right>ThreadLocal å†…å­˜æ³„æ¼</h3><p>ThreadLocal åœ¨æ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨æ—¶ï¼Œå‘ç”Ÿ GC æ—¶ä¼šè¢«å›æ”¶ï¼Œé‚£ä¹ˆ ThreadLocalMap ä¸­ä¿å­˜çš„ key å€¼å°±å˜æˆäº† nullï¼Œè€Œ Entry åˆè¢« threadLocalMap å¯¹è±¡å¼•ç”¨ï¼ŒthreadLocalMap å¯¹è±¡åˆè¢« Thread å¯¹è±¡æ‰€å¼•ç”¨ï¼Œé‚£ä¹ˆå½“ Thread ä¸€ç›´ä¸ç»ˆç»“çš„è¯ï¼Œvalue å¯¹è±¡å°±ä¼šä¸€ç›´å­˜åœ¨äºå†…å­˜ä¸­ï¼Œä¹Ÿå°±å¯¼è‡´äº†å†…å­˜æ³„æ¼ï¼Œç›´è‡³ Thread è¢«é”€æ¯åï¼Œæ‰ä¼šè¢«å›æ”¶ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•é¿å…å†…å­˜æ³„æ¼å‘¢ï¼Ÿ</p><p>åœ¨ä½¿ç”¨å®Œ ThreadLocal å˜é‡åï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ remove æ‰ï¼Œé˜²æ­¢ ThreadLocalMap ä¸­ Entry ä¸€ç›´ä¿æŒå¯¹ value çš„å¼ºå¼•ç”¨ï¼Œå¯¼è‡´ value ä¸èƒ½è¢«å›æ”¶ï¼Œå…¶ä¸­ remove æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>/** * æ¸…ç†å½“å‰ ThreadLocal å¯¹è±¡å…³è”çš„é”®å€¼å¯¹ */public void remove() {	// è¿”å›å½“å‰çº¿ç¨‹æŒæœ‰çš„ map	ThreadLocalMap m = getMap(Thread.currentThread());	if (m != null) {		// ä» map ä¸­æ¸…ç†å½“å‰ ThreadLocal å¯¹è±¡å…³è”çš„é”®å€¼å¯¹		m.remove(this);	}}</code></pre><p>remove æ–¹æ³•çš„æ—¶åºå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt="ä¸€èµ·æ¥è°ˆè°ˆThreadLocal åŸç†å§ï¼ä½ éœ€è¦äº†è§£ï¼" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/499a403f2b63464db8e3e12298c1a3e5><p class=pgc-img-caption></p></div><p>remove æ–¹æ³•æ˜¯å…ˆè·å–åˆ°å½“å‰çº¿ç¨‹çš„ ThreadLocalMapï¼Œå¹¶ä¸”è°ƒç”¨äº†å®ƒçš„ remove æ–¹æ³•ï¼Œä» map ä¸­æ¸…ç†å½“å‰ ThreadLocal å¯¹è±¡å…³è”çš„é”®å€¼å¯¹ï¼Œè¿™æ · value å°±å¯ä»¥è¢« GC å›æ”¶äº†ã€‚</p><p>é‚£ä¹ˆ ThreadLocal æ˜¯å¦‚ä½•å®ç°çº¿ç¨‹éš”ç¦»çš„å‘¢ï¼Ÿ</p><h3 class=pgc-h-arrow-right>ThreadLocal çš„ set æ–¹æ³•</h3><p>æˆ‘ä»¬å…ˆå»çœ‹ä¸‹ ThreadLocal çš„ set æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p><pre><code>/** * ä¸ºå½“å‰ ThreadLocal å¯¹è±¡å…³è” value å€¼ * * @param value è¦å­˜å‚¨åœ¨æ­¤çº¿ç¨‹çš„çº¿ç¨‹å‰¯æœ¬çš„å€¼ */public void set(T value) {	// è¿”å›å½“å‰ThreadLocalæ‰€åœ¨çš„çº¿ç¨‹	Thread t = Thread.currentThread();	// è¿”å›å½“å‰çº¿ç¨‹æŒæœ‰çš„map	ThreadLocalMap map = getMap(t);	if (map != null) {		// å¦‚æœ ThreadLocalMap ä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥å­˜å‚¨&lt;ThreadLocal, T&gt;é”®å€¼å¯¹		map.set(this, value);	} else {		// å¦åˆ™ï¼Œéœ€è¦ä¸ºå½“å‰çº¿ç¨‹åˆå§‹åŒ– ThreadLocalMapï¼Œå¹¶å­˜å‚¨é”®å€¼å¯¹ &lt;this, firstValue&gt;		createMap(t, value);	}}</code></pre><p>set æ–¹æ³•çš„ä½œç”¨æ˜¯æŠŠæˆ‘ä»¬æƒ³è¦å­˜å‚¨çš„ value ç»™ä¿å­˜è¿›å»ã€‚set æ–¹æ³•çš„æµç¨‹ä¸»è¦æ˜¯ï¼š</p><ul><li>å…ˆè·å–åˆ°å½“å‰çº¿ç¨‹çš„å¼•ç”¨</li><li>åˆ©ç”¨è¿™ä¸ªå¼•ç”¨æ¥è·å–åˆ° ThreadLocalMap</li><li>å¦‚æœ map ä¸ºç©ºï¼Œåˆ™å»åˆ›å»ºä¸€ä¸ª ThreadLocalMap</li><li>å¦‚æœ map ä¸ä¸ºç©ºï¼Œå°±åˆ©ç”¨ ThreadLocalMap çš„ set æ–¹æ³•å°† value æ·»åŠ åˆ° map ä¸­</li></ul><p>set æ–¹æ³•çš„æ—¶åºå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt="ä¸€èµ·æ¥è°ˆè°ˆThreadLocal åŸç†å§ï¼ä½ éœ€è¦äº†è§£ï¼" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/db077816974a47b284549ab35e1e4800><p class=pgc-img-caption></p></div><p>å…¶ä¸­ map å°±æ˜¯æˆ‘ä»¬ä¸Šé¢è®²åˆ°çš„ ThreadLocalMapï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯é€šè¿‡å½“å‰çº¿ç¨‹å¯¹è±¡è·å–åˆ°çš„ ThreadLocalMapï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ getMapæ–¹æ³•çš„æºä»£ç ï¼š</p><pre><code>/** * è¿”å›å½“å‰çº¿ç¨‹ thread æŒæœ‰çš„ ThreadLocalMap * * @param t å½“å‰çº¿ç¨‹ * @return ThreadLocalMap */ThreadLocalMap getMap(Thread t) {	return t.threadLocals;}</code></pre><p>getMap æ–¹æ³•çš„ä½œç”¨ä¸»è¦æ˜¯è·å–å½“å‰çº¿ç¨‹å†…çš„ ThreadLocalMap å¯¹è±¡ï¼ŒåŸæ¥è¿™ä¸ª ThreadLocalMap æ˜¯çº¿ç¨‹çš„ä¸€ä¸ªå±æ€§ï¼Œä¸‹é¢è®©æˆ‘ä»¬çœ‹çœ‹ Thread ä¸­çš„ç›¸å…³ä»£ç ï¼š</p><pre><code>/** * ThreadLocal çš„ ThreadLocalMap æ˜¯çº¿ç¨‹çš„ä¸€ä¸ªå±æ€§ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ threadLocals æ˜¯çº¿ç¨‹å®‰å…¨çš„ */ThreadLocal.ThreadLocalMap threadLocals = null;</code></pre><p>å¯ä»¥çœ‹å‡ºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ ThreadLocalMap å¯¹è±¡ï¼Œè¢«å‘½åä¸º threadLocalsï¼Œé»˜è®¤ä¸º nullï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹çš„ ThreadLocals éƒ½æ˜¯éš”ç¦»ç‹¬äº«çš„ã€‚</p><p>è°ƒç”¨ ThreadLocalMap.set() æ—¶ï¼Œä¼šæŠŠå½“å‰ threadLocal å¯¹è±¡ä½œä¸º keyï¼Œæƒ³è¦ä¿å­˜çš„å¯¹è±¡ä½œä¸º valueï¼Œå­˜å…¥ mapã€‚</p><p>å…¶ä¸­ ThreadLocalMap.set() çš„æºç å¦‚ä¸‹ï¼š</p><pre><code>/** * åœ¨ map ä¸­å­˜å‚¨é”®å€¼å¯¹&lt;key, value&gt; * * @param key   threadLocal * @param value è¦è®¾ç½®çš„ value å€¼ */private void set(ThreadLocal&lt;?&gt; key, Object value) {	Entry[] tab = table;	int len = tab.length;	// è®¡ç®— key åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡	int i = key.threadLocalHashCode &amp; (len - 1);	// éå†ä¸€æ®µè¿ç»­çš„å…ƒç´ ï¼Œä»¥æŸ¥æ‰¾åŒ¹é…çš„ ThreadLocal å¯¹è±¡	for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) {		// è·å–è¯¥å“ˆå¸Œå€¼å¤„çš„ThreadLocalå¯¹è±¡		ThreadLocal&lt;?&gt; k = e.get();		// é”®å€¼ThreadLocalåŒ¹é…ï¼Œç›´æ¥æ›´æ”¹mapä¸­çš„value		if (k == key) {			e.value = value;			return;		}		// è‹¥ key æ˜¯ nullï¼Œè¯´æ˜ ThreadLocal è¢«æ¸…ç†äº†ï¼Œç›´æ¥æ›¿æ¢æ‰		if (k == null) {			replaceStaleEntry(key, value, i);			return;		}	}	// ç›´åˆ°é‡è§äº†ç©ºæ§½ä¹Ÿæ²¡æ‰¾åˆ°åŒ¹é…çš„ThreadLocalå¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨æ­¤ç©ºæ§½å¤„å®‰æ’ThreadLocalå¯¹è±¡å’Œç¼“å­˜çš„value	tab[i] = new Entry(key, value);	int sz = ++size;	// å¦‚æœæ²¡æœ‰å…ƒç´ è¢«æ¸…ç†ï¼Œé‚£ä¹ˆå°±è¦æ£€æŸ¥å½“å‰å…ƒç´ æ•°é‡æ˜¯å¦è¶…è¿‡äº†å®¹é‡é˜™å€¼(æ•°ç»„å¤§å°çš„ä¸‰åˆ†ä¹‹äºŒ)ï¼Œä»¥ä¾¿å†³å®šæ˜¯å¦æ‰©å®¹	if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold) {		// æ‰©å®¹çš„è¿‡ç¨‹ä¹Ÿæ˜¯å¯¹æ‰€æœ‰çš„ key é‡æ–°å“ˆå¸Œçš„è¿‡ç¨‹		rehash();	}}</code></pre><p>ç›¸ä¿¡åˆ°è¿™é‡Œï¼Œå¤§å®¶åº”è¯¥å¯¹ Threadã€ThreadLocal ä»¥åŠ ThreadLocalMap çš„å…³ç³»æœ‰äº†è¿›ä¸€æ­¥çš„ç†è§£ï¼Œä¸‹å›¾ä¸ºä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼š</p><div class=pgc-img><img alt="ä¸€èµ·æ¥è°ˆè°ˆThreadLocal åŸç†å§ï¼ä½ éœ€è¦äº†è§£ï¼" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4131172641b649859790c628511d2240><p class=pgc-img-caption></p></div><h3 class=pgc-h-arrow-right>ThreadLocal çš„ get æ–¹æ³•</h3><p>äº†è§£å®Œ set æ–¹æ³•åï¼Œè®©æˆ‘ä»¬çœ‹ä¸‹ get æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p><pre><code>/** * è¿”å›å½“å‰ ThreadLocal å¯¹è±¡å…³è”çš„å€¼ * * @return */public T get() {	// è¿”å›å½“å‰ ThreadLocal æ‰€åœ¨çš„çº¿ç¨‹	Thread t = Thread.currentThread();	// ä»çº¿ç¨‹ä¸­æ‹¿åˆ° ThreadLocalMap	ThreadLocalMap map = getMap(t);	if (map != null) {		// ä» map ä¸­æ‹¿åˆ° entry		ThreadLocalMap.Entry e = map.getEntry(this);		// å¦‚æœä¸ä¸ºç©ºï¼Œè¯»å–å½“å‰ ThreadLocal ä¸­ä¿å­˜çš„å€¼		if (e != null) {			@SuppressWarnings("unchecked")			T result = (T) e.value;			return result;		}	}	// è‹¥ map ä¸ºç©ºï¼Œåˆ™å¯¹å½“å‰çº¿ç¨‹çš„ ThreadLocal è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€åè¿”å›å½“å‰çš„ ThreadLocal å¯¹è±¡å…³è”çš„åˆå€¼ï¼Œå³ value	return setInitialValue();}</code></pre><p>get æ–¹æ³•çš„ä¸»è¦æµç¨‹ä¸ºï¼š</p><ul><li>å…ˆè·å–åˆ°å½“å‰çº¿ç¨‹çš„å¼•ç”¨</li><li>è·å–å½“å‰çº¿ç¨‹å†…éƒ¨çš„ ThreadLocalMap</li><li>å¦‚æœ map å­˜åœ¨ï¼Œåˆ™è·å–å½“å‰ ThreadLocal å¯¹åº”çš„ value å€¼</li><li>å¦‚æœ map ä¸å­˜åœ¨æˆ–è€…æ‰¾ä¸åˆ° value å€¼ï¼Œåˆ™è°ƒç”¨ setInitialValue() è¿›è¡Œåˆå§‹åŒ–</li></ul><p>get æ–¹æ³•çš„æ—¶åºå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt="ä¸€èµ·æ¥è°ˆè°ˆThreadLocal åŸç†å§ï¼ä½ éœ€è¦äº†è§£ï¼" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0106664e046945fea9d8491fedf8b509><p class=pgc-img-caption></p></div><p>å…¶ä¸­æ¯ä¸ª Thread çš„ ThreadLocalMap ä»¥ threadLocal ä½œä¸º keyï¼Œä¿å­˜è‡ªå·±çº¿ç¨‹çš„ value å‰¯æœ¬ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰ä¿å­˜åœ¨ ThreadLocal å¯¹è±¡ä¸­ã€‚</p><p>å…¶ä¸­ ThreadLocalMap.getEntry() æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š</p><pre><code>/** * è¿”å› key å…³è”çš„é”®å€¼å¯¹å®ä½“ * * @param key threadLocal * @return */private Entry getEntry(ThreadLocal&lt;?&gt; key) {	int i = key.threadLocalHashCode &amp; (table.length - 1);	Entry e = table[i];	// è‹¥ e ä¸ä¸ºç©ºï¼Œå¹¶ä¸” e çš„ ThreadLocal çš„å†…å­˜åœ°å€å’Œ key ç›¸åŒï¼Œç›´æ¥è¿”å›	if (e != null &amp;&amp; e.get() == key) {		return e;	} else {		// ä» i å¼€å§‹å‘åéå†æ‰¾åˆ°é”®å€¼å¯¹å®ä½“		return getEntryAfterMiss(key, i, e);	}}</code></pre><h3 class=pgc-h-arrow-right>ThreadLocalMap çš„ resize æ–¹æ³•</h3><p>å½“ ThreadLocalMap ä¸­çš„ ThreadLocal çš„ä¸ªæ•°è¶…è¿‡å®¹é‡é˜ˆå€¼æ—¶ï¼ŒThreadLocalMap å°±è¦å¼€å§‹æ‰©å®¹äº†ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹ resize çš„æºä»£ç ï¼š</p><pre><code>/** * æ‰©å®¹ï¼Œé‡æ–°è®¡ç®—ç´¢å¼•ï¼Œæ ‡è®°åƒåœ¾å€¼ï¼Œæ–¹ä¾¿ GC å›æ”¶ */private void resize() {	Entry[] oldTab = table;	int oldLen = oldTab.length;	int newLen = oldLen * 2;	// æ–°å»ºä¸€ä¸ªæ•°ç»„ï¼ŒæŒ‰ç…§2å€é•¿åº¦æ‰©å®¹	Entry[] newTab = new Entry[newLen];	int count = 0;	// å°†æ—§æ•°ç»„çš„å€¼æ‹·è´åˆ°æ–°æ•°ç»„ä¸Š	for (int j = 0; j &lt; oldLen; ++j) {		Entry e = oldTab[j];		if (e != null) {			ThreadLocal&lt;?&gt; k = e.get();			// è‹¥æœ‰åƒåœ¾å€¼ï¼Œåˆ™æ ‡è®°æ¸…ç†è¯¥å…ƒç´ çš„å¼•ç”¨ï¼Œä»¥ä¾¿GCå›æ”¶			if (k == null) {				e.value = null;			} else {				// è®¡ç®— ThreadLocal åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®				int h = k.threadLocalHashCode &amp; (newLen - 1);				// å¦‚æœå‘ç”Ÿå†²çªï¼Œä½¿ç”¨çº¿æ€§æ¢æµ‹å¾€åå¯»æ‰¾åˆé€‚çš„ä½ç½®				while (newTab[h] != null) {					h = nextIndex(h, newLen);				}				newTab[h] = e;				count++;			}		}	}	// è®¾ç½®æ–°çš„æ‰©å®¹é˜ˆå€¼ï¼Œä¸ºæ•°ç»„é•¿åº¦çš„ä¸‰åˆ†ä¹‹äºŒ	setThreshold(newLen);	size = count;	table = newTab;}</code></pre><p>resize æ–¹æ³•ä¸»è¦æ˜¯è¿›è¡Œæ‰©å®¹ï¼ŒåŒæ—¶ä¼šå°†åƒåœ¾å€¼æ ‡è®°æ–¹ä¾¿ GC å›æ”¶ï¼Œæ‰©å®¹åæ•°ç»„å¤§å°æ˜¯åŸæ¥æ•°ç»„çš„ä¸¤å€ã€‚</p><h2 class=pgc-h-arrow-right>ThreadLocal åº”ç”¨åœºæ™¯</h2><p>ThreadLocal çš„ç‰¹æ€§ä¹Ÿå¯¼è‡´äº†åº”ç”¨åœºæ™¯æ¯”è¾ƒå¹¿æ³›ï¼Œä¸»è¦çš„åº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š</p><ul><li>çº¿ç¨‹é—´æ•°æ®éš”ç¦»ï¼Œå„çº¿ç¨‹çš„ ThreadLocal äº’ä¸å½±å“</li><li>æ–¹ä¾¿åŒä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨æŸä¸€å¯¹è±¡ï¼Œé¿å…ä¸å¿…è¦çš„å‚æ•°ä¼ é€’</li><li>å…¨é“¾è·¯è¿½è¸ªä¸­çš„ traceId æˆ–è€…æµç¨‹å¼•æ“ä¸­ä¸Šä¸‹æ–‡çš„ä¼ é€’ä¸€èˆ¬é‡‡ç”¨ ThreadLocal</li><li>Spring äº‹åŠ¡ç®¡ç†å™¨é‡‡ç”¨äº† ThreadLocal</li><li>Spring MVC çš„ RequestContextHolder çš„å®ç°ä½¿ç”¨äº† ThreadLocal</li></ul><h1 class=pgc-h-arrow-right>æ€»ç»“</h1><p>æœ¬æ–‡ä¸»è¦ä»æºç çš„è§’åº¦è§£æäº† ThreadLocalï¼Œå¹¶åˆ†æäº†å‘ç”Ÿå†…å­˜æ³„æ¼çš„åŸå› ï¼Œæœ€åå¯¹å®ƒçš„åº”ç”¨åœºæ™¯è¿›è¡Œäº†ç®€å•ä»‹ç»ã€‚</p><p>æ¬¢è¿ç•™è¨€äº¤æµè®¨è®ºï¼ŒåŸåˆ›ä¸æ˜“ï¼Œè§‰å¾—æ–‡ç« ä¸é”™ï¼Œè¯·åœ¨çœ‹è½¬å‘æ”¯æŒä¸€ä¸‹ã€‚</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'è°ˆè°ˆ','ThreadLocal','åŸç†'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>