<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>详解全链路监控架构--目标、功能模块、Dapper和方案比较 | 极客快訊</title><meta property="og:title" content="详解全链路监控架构--目标、功能模块、Dapper和方案比较 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/0b9522caad164be69c095a59cd295572"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/205fd96b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/205fd96b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/205fd96b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/205fd96b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/205fd96b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/205fd96b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/205fd96b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/205fd96b.html><meta property="article:published_time" content="2020-11-14T21:06:12+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:12+08:00"><meta name=Keywords content><meta name=description content="详解全链路监控架构--目标、功能模块、Dapper和方案比较"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/205fd96b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>详解全链路监控架构--目标、功能模块、Dapper和方案比较</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>概述</h1><p>随着微服务架构的流行，服务按照不同的维度进行拆分，一次请求往往需要涉及到多个服务。互联网应用构建在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发、可能使用不同的编程语言来实现、有可能布在了几千台服务器，横跨多个不同的数据中心。因此，就需要一些可以帮助理解系统行为、用于分析性能问题的工具，以便发生故障的时候，能够快速定位和解决问题。</p><p>全链路监控组件就在这样的问题背景下产生了。最出名的是谷歌公开的论文提到的 Google Dapper。想要在这个上下文中理解分布式系统的行为，就需要监控那些横跨了不同的应用、不同的服务器之间的关联动作。</p><hr><h1>分布式服务调用链路</h1><p>在复杂的微服务架构系统中，几乎每一个前端请求都会形成一个复杂的分布式服务调用链路。一个请求完整调用链可能如下图所示：</p><div class=pgc-img><img alt=详解全链路监控架构--目标、功能模块、Dapper和方案比较 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0b9522caad164be69c095a59cd295572><p class=pgc-img-caption>一个请求完整调用链</p></div><p>那么在业务规模不断增大、服务不断增多以及频繁变更的情况下，面对复杂的调用链路就带来一系列问题：</p><ul><li>如何快速发现问题？</li><li>如何判断故障影响范围？</li><li>如何梳理服务依赖以及依赖的合理性？</li><li>如何分析链路性能问题以及实时容量规划？</li></ul><p>同时需要关注在请求处理期间各个调用的各项性能指标，比如：吞吐量（TPS）、响应时间及错误记录等。</p><ul><li>吞吐量，根据拓扑可计算相应组件、平台、物理设备的实时吞吐量。</li><li>响应时间，包括整体调用的响应时间和各个服务的响应时间等。</li><li>错误记录，根据服务返回统计单位时间异常次数。</li></ul><p>全链路性能监控 从整体维度到局部维度展示各项指标，将跨应用的所有调用链性能信息集中展现，可方便度量整体和局部性能，并且方便找到故障产生的源头，生产上可极大缩短故障排除时间。</p><p>有了全链路监控工具，能够达到：</p><ul><li>请求链路追踪，故障快速定位：可以通过调用链结合业务日志快速定位错误信息。</li><li>可视化： 各个阶段耗时，进行性能分析。</li><li>依赖优化：各个调用环节的可用性、梳理服务依赖关系以及优化。</li><li>数据分析，优化链路：可以得到用户的行为路径，汇总分析应用在很多业务场景。</li></ul><hr><h1>1、全链路监控目标</h1><p>如上所述，那么我们选择全链路监控组件有哪些目标要求呢？Google Dapper中也提到了，总结如下：</p><ol><li><strong>探针的性能消耗</strong></li><li>APM组件服务的影响应该做到足够小。<strong>服务调用埋点本身会带来性能损耗，这就需要调用跟踪的低损耗，实际中还会通过配置采样率的方式，选择一部分请求去分析请求路径</strong>。在一些高度优化过的服务，即使一点点损耗也会很容易察觉到，而且有可能迫使在线服务的部署团队不得不将跟踪系统关停。</li><li><strong>代码的侵入性</strong></li><li><strong>即也作为业务组件，应当尽可能少入侵或者无入侵其他业务系统，对于使用方透明，减少开发人员的负担</strong>。</li><li>对于应用的程序员来说，是不需要知道有跟踪系统这回事的。如果一个跟踪系统想生效，就必须需要依赖应用的开发者主动配合，那么这个跟踪系统也太脆弱了，往往由于跟踪系统在应用中植入代码的bug或疏忽导致应用出问题，这样才是无法满足对跟踪系统“无所不在的部署”这个需求。</li><li><strong>可扩展性</strong></li><li><strong>一个优秀的调用跟踪系统必须支持分布式部署，具备良好的可扩展性。能够支持的组件越多当然越好</strong>。或者提供便捷的插件开发API，对于一些没有监控到的组件，应用开发者也可以自行扩展。</li><li><strong>数据的分析</strong></li><li><strong>数据的分析要快 ，分析的维度尽可能多</strong>。跟踪系统能提供足够快的信息反馈，就可以对生产环境下的异常状况做出快速反应。<strong>分析的全面，能够避免二次开发</strong>。</li></ol><hr><h1>2、全链路监控功能模块</h1><p>一般的全链路监控系统，大致可分为四大功能模块：</p><p><strong>1、埋点与生成日志</strong></p><p>埋点即系统在当前节点的上下文信息，可以分为 客户端埋点、服务端埋点，以及客户端和服务端双向型埋点。埋点日志通常要包含以下内容traceId、spanId、调用的开始时间，协议类型、调用方ip和端口，请求的服务名、调用耗时，调用结果，异常信息等，同时预留可扩展字段，为下一步扩展做准备；</p><p><strong>2、收集和存储日志</strong></p><p>主要支持分布式日志采集的方案，同时增加MQ作为缓冲；</p><ul><li class=ql-indent-1>每个机器上有一个 deamon 做日志收集，业务进程把自己的Trace发到daemon，daemon把收集Trace往上一级发送；</li><li class=ql-indent-1>多级的collector，类似pub/sub架构，可以负载均衡；</li><li class=ql-indent-1>对聚合的数据进行 实时分析和离线存储；</li><li class=ql-indent-1>离线分析 需要将同一条调用链的日志汇总在一起；</li></ul><p><strong>3、分析和统计调用链路数据，以及时效性</strong></p><p>调用链跟踪分析：把同一TraceID的Span收集起来，按时间排序就是timeline。把ParentID串起来就是调用栈。</p><p>抛异常或者超时，在日志里打印TraceID。利用TraceID查询调用链情况，定位问题。</p><p>依赖度量：</p><ul><li class=ql-indent-1>强依赖：调用失败会直接中断主流程</li><li class=ql-indent-1>高度依赖：一次链路中调用某个依赖的机率高</li><li class=ql-indent-1>频繁依赖：一次链路调用同一个依赖的次数多</li></ul><p>离线分析：按TraceID汇总，通过Span的ID和ParentID还原调用关系，分析链路形态。</p><p>实时分析：对单条日志直接分析，不做汇总，重组。得到当前QPS，延迟。</p><p><strong>4、展现以及决策支持</strong></p><hr><h1>3、Google Dapper</h1><p><strong>3.1 Span</strong></p><p>基本工作单元，一次链路调用（可以是RPC，DB等没有特定的限制）创建一个span，通过一个64位ID标识它，uuid较为方便，span中还有其他的数据，例如描述信息，时间戳，key-value对的（Annotation）tag信息，parent_id等,其中parent-id可以表示span调用链路来源。</p><div class=pgc-img><img alt=详解全链路监控架构--目标、功能模块、Dapper和方案比较 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1db21bc751724c58aaa48cdf66630780><p class=pgc-img-caption>Span</p></div><p>上图说明了span在一次大的跟踪过程中是什么样的。Dapper记录了span名称，以及每个span的ID和父ID，以重建在一次追踪过程中不同span之间的关系。如果一个span没有父ID被称为root span。所有span都挂在一个特定的跟踪上，也共用一个跟踪id。</p><p><strong>3.2 TRACE</strong></p><p>类似于 <strong>树结构的Span集合</strong>，表示一次完整的跟踪，从请求到服务器开始，服务器返回response结束，跟踪每次rpc调用的耗时，存在唯一标识trace_id。比如：你运行的分布式大数据存储一次Trace就由你的一次请求组成。</p><div class=pgc-img><img alt=详解全链路监控架构--目标、功能模块、Dapper和方案比较 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2939a3222b1141f4bb87b33c39767a24><p class=pgc-img-caption>Trace</p></div><p>每种颜色的note标注了一个span，一条链路通过TraceId唯一标识，Span标识发起的请求信息。<strong>树节点是整个架构的基本单元，而每一个节点又是对span的引用</strong>。节点之间的连线表示的span和它的父span直接的关系。虽然span在日志文件中只是简单的代表span的开始和结束时间，他们在整个树形结构中却是相对独立的。</p><p><strong>3.3 Annotation</strong></p><p>注解，用来记录请求特定事件相关信息（例如时间），一个span中会有多个annotation注解描述。通常包含四个注解信息：</p><blockquote><p>(1) <strong>cs</strong>：Client Start，表示客户端发起请求</p><p>(2) <strong>sr</strong>：Server Receive，表示服务端收到请求</p><p>(3) <strong>ss</strong>：Server Send，表示服务端完成处理，并将结果发送给客户端</p><p>(4) <strong>cr</strong>：Client Received，表示客户端获取到服务端返回信息</p></blockquote><hr><h1>4、 方案比较</h1><p>市面上的全链路监控理论模型大多都是借鉴Google Dapper论文，主要是以下三种APM组件：</p><ul><li><strong>Zipkin</strong>：由Twitter公司开源，开放源代码分布式的跟踪系统，用于收集服务的定时数据，以解决微服务架构中的延迟问题，包括：数据的收集、存储、查找和展现。</li><li><strong>Pinpoint</strong>：一款对Java编写的大规模分布式系统的APM工具，由韩国人开源的分布式跟踪组件。</li><li><strong>Skywalking</strong>：国产的优秀APM组件，是一个对JAVA分布式应用程序集群的业务运行情况进行追踪、告警和分析的系统。</li></ul><p>相比之下，Pinpoint 具有压倒性的优势：<strong>无需对项目代码进行任何改动就可以部署探针、追踪数据细粒化到方法调用级别、功能强大的用户界面以及几乎比较全面的 Java 框架支持</strong>。</p><hr><p>后面会分享更多devops和DBA方面的内容，感兴趣的朋友可以关注一下~</p><div class=pgc-img><img alt=详解全链路监控架构--目标、功能模块、Dapper和方案比较 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/72f5e40a130349e999847c1f82baa182><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'详解','全链','路监'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>