<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>还在用Zipkin分布式服务链路追踪？来试试这个吧 | 极客快訊</title><meta property="og:title" content="还在用Zipkin分布式服务链路追踪？来试试这个吧 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/297b94665d5249589e96e7c427acc207"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/228f3c3d.html><meta property="article:published_time" content="2020-11-14T21:06:12+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:12+08:00"><meta name=Keywords content><meta name=description content="还在用Zipkin分布式服务链路追踪？来试试这个吧"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/228f3c3d.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>还在用Zipkin分布式服务链路追踪？来试试这个吧</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>自SpringCloud问世以来，微服务以席卷之势风靡全球，企业架构都在从传统SOA向微服务转型。然而微服务这把双刃剑在带来各种优势的同时，也给运维、性能监控、错误的排查带来的极大的困难。</p><p style=text-align:start>在大型项目中，服务架构会包含数十乃至上百个服务节点。往往一次请求会设计到多个微服务，想要排查一次请求链路中经过了哪些节点，每个节点的执行情况如何，就成为了亟待解决的问题。于是分布式系统的APM管理系统应运而生。</p><h1 class=pgc-h-arrow-right><strong>什么是APM系统？</strong></h1><p style=text-align:start>APM系统可以帮助理解系统行为、用于分析性能问题的工具，以便发生故障的时候，能够快速定位和解决问题，这就是APM系统，全称是（<strong>A</strong>pplication <strong>P</strong>erformance <strong>M</strong>onitor）。</p><p style=text-align:start>谷歌公开的论文提到的Google Dapper可以说是最早的APM系统了，给google的开发者和运维团队帮了大忙，所以谷歌公开论文分享了Dapper。</p><p style=text-align:start>而后，很多的技术公司基于这篇论文的原理，设计开发了很多出色的APM框架，例如Pinpoint、SkyWalking等。</p><p style=text-align:start>而SpringCloud官网也集成了一套这样的系统：Spring Cloud Sleuth，结合Zipkin。</p><p style=text-align:start>APM的基本原理</p><p style=text-align:start>目前大部分的APM系统都是基于Google的Dapper原理实现，我们简单来看看Dapper中的概念和实现原理。</p><p style=text-align:start>先来看一次请求调用示例：</p><ol start=1><li>服务集群中包括：前端（A），两个中间层（B和C），以及两个后端（D和E）</li><li>当用户发起一个请求时，首先到达前端A服务，然后A分别对B服务和C服务进行RPC调用；</li><li>B服务处理完给A做出响应，但是C服务还需要和后端的D服务和E服务交互之后再返还给A服务，最后由A服务来响应用户的请求；</li></ol><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/297b94665d5249589e96e7c427acc207><p class=pgc-img-caption></p></div><p style=text-align:start>如何才能实现跟踪呢？</p><p style=text-align:start>Google的Dapper设计了下面的几个概念用来记录请求链路：</p><pre><code>Span：请求中的基本工作单元，每一次链路调用（RPC、Rest、数据库调用）都会创建一个Span。大概结构如下：type Span struct { TraceID int64 // 用于标示一次完整的请求id Name string // 单元名称 ID int64 // 当前这次调用span_id ParentID int64 // 上层服务的span_id,最上层服务parent_id为null，代表根服务 Annotation []Annotation // 注释，用于记录调用中的详细信息，例如时间}</code></pre><ul><li>Trace：一次完整的调用链路，包含多个Span的树状结构，具有唯一的TraceID</li></ul><p style=text-align:start>一次请求的每个链路，通过spanId、parentId就能串联起来：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15b0f233c8d74295816fec1dd879e3dc><p class=pgc-img-caption></p></div><p style=text-align:start>当然，从请求到服务器开始，服务器返回response结束，每个span存在相同的唯一标识trace_id。</p><h1 class=pgc-h-arrow-right><strong>APM的筛选标准</strong></h1><p style=text-align:start>目前主流的APM框架都会包含下列几个组件来完成链路信息的收集和展示：</p><ul><li>探针（Agent）：负责在客户端程序运行时搜索服务调用链路信息，发送给收集器</li><li>收集器（Collector）：负责将数据格式化，保存到存储器</li><li>存储器（Storage）：保存数据</li><li>UI界面（WebUI）：统计并展示收集到的信息</li></ul><p style=text-align:start>因此，要筛选一款合格的APM框架，就是对比各个组件的使用差异，主要对比项：</p><ul><li><strong>探针的性能</strong></li></ul><p style=text-align:start>主要是agent对服务的吞吐量、CPU和内存的影响。如果探针在收集微服务运行数据时，对微服务的运行产生了比较大的性能影响，相信没什么人愿意使用。</p><ul><li><strong>collector的可扩展性</strong></li></ul><p style=text-align:start>能够水平扩展以便支持大规模服务器集群，保证收集器的高可用特性。</p><ul><li><strong>全面的调用链路数据分析</strong></li></ul><p style=text-align:start>数据的分析要<strong>快</strong> ，分析的维度尽可能<strong>多</strong>。跟踪系统能提供足够快的信息反馈，就可以对生产环境下的异常状况做出快速反应，最好提供代码级别的可见性以便轻松定位失败点和瓶颈。</p><ul><li><strong>对于开发透明，容易开关</strong></li></ul><p style=text-align:start>即也作为业务组件，应当尽可能少入侵或者无入侵其他业务系统，对于使用方透明，减少开发人员的负担。</p><ul><li><strong>完整的调用链应用拓扑</strong></li></ul><p style=text-align:start>自动检测应用拓扑，帮助你搞清楚应用的架构</p><p style=text-align:start>接下来，我们就对比下目前比较常见的三种APM框架的各项指标，分别是：</p><ul><li>ZIPkin：由Twitter公司开源，开放源代码分布式的跟踪系统，用于收集服务的定时数据，以解决微服务架构中的延迟问题，包括：数据的收集、存储、查找和展现。</li><li>Pinpoint：一款对Java编写的大规模分布式系统的APM工具，由韩国人开源的分布式跟踪组件。</li><li>Skywalking：国产的优秀APM组件，是一个对JAVA分布式应用程序集群的业务运行情况进行追踪、告警和分析的系统。现在是Apache的顶级项目之一</li></ul><p style=text-align:start>三者对比如下：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3eeda4c399884cfc8c10759dea30d9e3><p class=pgc-img-caption></p></div><p style=text-align:start>可见，zipkin的探针性能、开发透明性、数据分析能力都不占优，实在是下下之选。</p><p style=text-align:start>而pinpoint在数据分析能力、开发透明性上有较大的优势,不过Pinpoint的部署相对比较复杂，需要的硬件资源较高。</p><p style=text-align:start>Skywalking的探针性能和开发透明性上具有较大优势，数据分析能力上也还不错，重要的是其部署比较方便灵活，比起Pinpoint更适合中小型企业使用。</p><p style=text-align:start>因此，本文会带着大家学习Skywalking的使用。</p><h1 class=pgc-h-arrow-right><strong>Skywalking介绍</strong></h1><p style=text-align:start><strong>SkyWalking</strong> 创建于2015年，提供分布式追踪功能。从5.x开始，项目进化为一个完成功能的Application Performance Management系统。 他被用于追踪、监控和诊断分布式系统，特别是使用微服务架构，云原生或容积技术。提供以下主要功能：</p><ul><li>分布式追踪和上下文传输</li><li>应用、实例、服务性能指标分析</li><li>根源分析</li><li>应用拓扑分析</li><li>应用和服务依赖分析</li><li>慢服务检测</li><li>性能优化</li></ul><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0dde17a79ce3440b9f81fa24a2dec7bc><p class=pgc-img-caption></p></div><p style=text-align:start>主要的特征：</p><ul><li>多语言探针或类库</li><ul><li>Java自动探针，追踪和监控程序时，不需要修改源码。</li><li>社区提供的其他多语言探针</li><ul><li>.NET Core</li><li>Node.js</li></ul></ul><li>多种后端存储： ElasticSearch， H2</li><li>支持<br>OpenTracing</li><ul><li>Java自动探针支持和OpenTracing API协同工作</li></ul><li>轻量级、完善功能的后端聚合和分析</li><li>现代化Web UI</li><li>日志集成</li><li>应用、实例和服务的告警</li></ul><h1 class=pgc-h-arrow-right><strong>Skywalking的安装</strong></h1><p style=text-align:start>先来看下Skywalking的官方给出的结构图：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15d06efdf7bb4ac5b8a692e25347d898><p class=pgc-img-caption></p></div><p style=text-align:start>大致分四个部分：</p><ul><li>skywalking-oap-server：就是<strong>O</strong>bservability <strong>A</strong>nalysis <strong>P</strong>latformd的服务，用来收集和处理探针发来的数据</li><li>skywalking-UI：就是skywalking提供的Web UI 服务，图形化方式展示服务链路、拓扑图、trace、性能监控等</li><li>agent：探针，获取服务调用的链路信息、性能信息，发送到skywalking的OAP服务</li><li>Storage：存储，一般选择elasticsearch</li></ul><p style=text-align:start>Skywalking支持windows或者Linux环境部署。这里我们选择在Linux下安装Skywalking，大家要<strong>先确保自己的Linux环境中有elasticsearch在启动中</strong>。</p><p style=text-align:start>接下来的安装分为三步：</p><ul><li>下载安装包</li><li>安装Skywalking的OAP服务和WebUI</li><li>在服务中部署探针</li></ul><h1 class=pgc-h-arrow-right><strong>下载安装包</strong></h1><p style=text-align:start>安装包可以在Skywalking的官网下载，</p><p style=text-align:start>目前最新版本是8.0.1版本：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/270cdf368fa944d1a1b2d4a93f53372e><p class=pgc-img-caption></p></div><p style=text-align:start>下载好的安装包：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/68e66eda628844808370e3ddeda9ad2a><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>安装OAP服务和WebUI</strong></h1><h1 class=pgc-h-arrow-right><strong>安装</strong></h1><p style=text-align:start>将下载好的安装包解压到Linux的某个目录下：</p><pre><code>tar xvf apache-skywalking-apm-es7-8.0.1.tar.gz</code></pre><p style=text-align:start>然后对解压好的文件夹重命名：</p><pre><code>mv apache-skywalking-apm-es7 skywalking</code></pre><p style=text-align:start>进入解压好的目录：</p><pre><code>cd skywalking</code></pre><p style=text-align:start>查看目录结构：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/93bad577a191492b93f7f6936541f4d7><p class=pgc-img-caption></p></div><p style=text-align:start>几个关键的目录：</p><ul><li>agent：探针</li><li>bin：启动脚本</li><li>config：配置文件</li><li>logs：日志</li><li>oap-libs：依赖</li><li>webapp：WebUI</li></ul><p style=text-align:start>这里要修改config目录中的application.yml文件，详细配置见官网。</p><h1 class=pgc-h-arrow-right><strong>配置</strong></h1><p style=text-align:start>进入config目录，修改application.yml，主要是把存储方案从h2改为elasticsearch</p><p style=text-align:start>可以直接使用下面的配置：</p><pre><code>cluster:  selector: ${SW_CLUSTER:standalone}  standalone:core:  selector: ${SW_CORE:default}  default:    role: ${SW_CORE_ROLE:Mixed} # Mixed/Receiver/Aggregator    restHost: ${SW_CORE_REST_HOST:0.0.0.0}    restPort: ${SW_CORE_REST_PORT:12800}    restContextPath: ${SW_CORE_REST_CONTEXT_PATH:/}    gRPCHost: ${SW_CORE_GRPC_HOST:0.0.0.0}    gRPCPort: ${SW_CORE_GRPC_PORT:11800}    gRPCSslEnabled: ${SW_CORE_GRPC_SSL_ENABLED:false}    gRPCSslKeyPath: ${SW_CORE_GRPC_SSL_KEY_PATH:""}    gRPCSslCertChainPath: ${SW_CORE_GRPC_SSL_CERT_CHAIN_PATH:""}    gRPCSslTrustedCAPath: ${SW_CORE_GRPC_SSL_TRUSTED_CA_PATH:""}    downsampling:      - Hour      - Day      - Month    # Set a timeout on metrics data. After the timeout has expired, the metrics data will automatically be deleted.    enableDataKeeperExecutor: ${SW_CORE_ENABLE_DATA_KEEPER_EXECUTOR:true} # Turn it off then automatically metrics data delete will be close.    dataKeeperExecutePeriod: ${SW_CORE_DATA_KEEPER_EXECUTE_PERIOD:5} # How often the data keeper executor runs periodically, unit is minute    recordDataTTL: ${SW_CORE_RECORD_DATA_TTL:3} # Unit is day    metricsDataTTL: ${SW_CORE_RECORD_DATA_TTL:7} # Unit is day    # Cache metric data for 1 minute to reduce database queries, and if the OAP cluster changes within that minute,    # the metrics may not be accurate within that minute.    enableDatabaseSession: ${SW_CORE_ENABLE_DATABASE_SESSION:true}    topNReportPeriod: ${SW_CORE_TOPN_REPORT_PERIOD:10} # top_n record worker report cycle, unit is minute    # Extra model column are the column defined by in the codes, These columns of model are not required logically in aggregation or further query,    # and it will cause more load for memory, network of OAP and storage.    # But, being activated, user could see the name in the storage entities, which make users easier to use 3rd party tool, such as Kibana-&gt;ES, to query the data by themselves.    activeExtraModelColumns: ${SW_CORE_ACTIVE_EXTRA_MODEL_COLUMNS:false}    # The max length of service + instance names should be less than 200    serviceNameMaxLength: ${SW_SERVICE_NAME_MAX_LENGTH:70}    instanceNameMaxLength: ${SW_INSTANCE_NAME_MAX_LENGTH:70}    # The max length of service + endpoint names should be less than 240    endpointNameMaxLength: ${SW_ENDPOINT_NAME_MAX_LENGTH:150}storage:  selector: ${SW_STORAGE:elasticsearch7}  elasticsearch7:    nameSpace: ${SW_NAMESPACE:""}    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:localhost:9200}    protocol: ${SW_STORAGE_ES_HTTP_PROTOCOL:"http"}    trustStorePath: ${SW_STORAGE_ES_SSL_JKS_PATH:""}    trustStorePass: ${SW_STORAGE_ES_SSL_JKS_PASS:""}    dayStep: ${SW_STORAGE_DAY_STEP:1} # Represent the number of days in the one minute/hour/day index.    user: ${SW_ES_USER:""}    password: ${SW_ES_PASSWORD:""}    secretsManagementFile: ${SW_ES_SECRETS_MANAGEMENT_FILE:""} # Secrets management file in the properties format includes the username, password, which are managed by 3rd party tool.    indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS_NUMBER:1} # The index shards number is for store metrics data rather than basic segment record    superDatasetIndexShardsFactor: ${SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR:5} # Super data set has been defined in the codes, such as trace segments. This factor provides more shards for the super data set, shards number = indexShardsNumber * superDatasetIndexShardsFactor. Also, this factor effects Zipkin and Jaeger traces.    indexReplicasNumber: ${SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:0}    # Batch process setting, refer to https://www.elastic.co/guide/en/elasticsearch/client/java-api/5.5/java-docs-bulk-processor.html    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:1000} # Execute the bulk every 1000 requests    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:10} # flush the bulk every 10 seconds whatever the number of requests    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:2} # the number of concurrent requests    resultWindowMaxSize: ${SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000}    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:5000}    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}    profileTaskQueryMaxSize: ${SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200}    advanced: ${SW_STORAGE_ES_ADVANCED:""}  h2:    driver: ${SW_STORAGE_H2_DRIVER:org.h2.jdbcx.JdbcDataSource}    url: ${SW_STORAGE_H2_URL:jdbc:h2:mem:skywalking-oap-db}    user: ${SW_STORAGE_H2_USER:sa}    metadataQueryMaxSize: ${SW_STORAGE_H2_QUERY_MAX_SIZE:5000}receiver-sharing-server:  selector: ${SW_RECEIVER_SHARING_SERVER:default}  default:    authentication: ${SW_AUTHENTICATION:""}receiver-register:  selector: ${SW_RECEIVER_REGISTER:default}  default:receiver-trace:  selector: ${SW_RECEIVER_TRACE:default}  default:    sampleRate: ${SW_TRACE_SAMPLE_RATE:10000} # The sample rate precision is 1/10000. 10000 means 100% sample in default.    slowDBAccessThreshold: ${SW_SLOW_DB_THRESHOLD:default:200,mongodb:100} # The slow database access thresholds. Unit ms.​receiver-jvm:  selector: ${SW_RECEIVER_JVM:default}  default:​receiver-clr:  selector: ${SW_RECEIVER_CLR:default}  default:​receiver-profile:  selector: ${SW_RECEIVER_PROFILE:default}  default:​service-mesh:  selector: ${SW_SERVICE_MESH:default}  default:​istio-telemetry:  selector: ${SW_ISTIO_TELEMETRY:default}  default:​envoy-metric:  selector: ${SW_ENVOY_METRIC:default}  default:    acceptMetricsService: ${SW_ENVOY_METRIC_SERVICE:true}    alsHTTPAnalysis: ${SW_ENVOY_METRIC_ALS_HTTP_ANALYSIS:""}​prometheus-fetcher:  selector: ${SW_PROMETHEUS_FETCHER:default}  default:    active: ${SW_PROMETHEUS_FETCHER_ACTIVE:false}​receiver_zipkin:  selector: ${SW_RECEIVER_ZIPKIN:-}  default:    host: ${SW_RECEIVER_ZIPKIN_HOST:0.0.0.0}    port: ${SW_RECEIVER_ZIPKIN_PORT:9411}    contextPath: ${SW_RECEIVER_ZIPKIN_CONTEXT_PATH:/}​receiver_jaeger:  selector: ${SW_RECEIVER_JAEGER:-}  default:    gRPCHost: ${SW_RECEIVER_JAEGER_HOST:0.0.0.0}    gRPCPort: ${SW_RECEIVER_JAEGER_PORT:14250}​query:  selector: ${SW_QUERY:graphql}  graphql:    path: ${SW_QUERY_GRAPHQL_PATH:/graphql}​alarm:  selector: ${SW_ALARM:default}  default:​telemetry:  selector: ${SW_TELEMETRY:none}  none:  prometheus:    host: ${SW_TELEMETRY_PROMETHEUS_HOST:0.0.0.0}    port: ${SW_TELEMETRY_PROMETHEUS_PORT:1234}​configuration:  selector: ${SW_CONFIGURATION:none}  none:  grpc:    host: ${SW_DCS_SERVER_HOST:""}    port: ${SW_DCS_SERVER_PORT:80}    clusterName: ${SW_DCS_CLUSTER_NAME:SkyWalking}    period: ${SW_DCS_PERIOD:20}  apollo:    apolloMeta: ${SW_CONFIG_APOLLO:http://106.12.25.204:8080}    apolloCluster: ${SW_CONFIG_APOLLO_CLUSTER:default}    apolloEnv: ${SW_CONFIG_APOLLO_ENV:""}    appId: ${SW_CONFIG_APOLLO_APP_ID:skywalking}    period: ${SW_CONFIG_APOLLO_PERIOD:5}  zookeeper:    period: ${SW_CONFIG_ZK_PERIOD:60} # Unit seconds, sync period. Default fetch every 60 seconds.    nameSpace: ${SW_CONFIG_ZK_NAMESPACE:/default}    hostPort: ${SW_CONFIG_ZK_HOST_PORT:localhost:2181}    # Retry Policy    baseSleepTimeMs: ${SW_CONFIG_ZK_BASE_SLEEP_TIME_MS:1000} # initial amount of time to wait between retries    maxRetries: ${SW_CONFIG_ZK_MAX_RETRIES:3} # max number of times to retry  etcd:    period: ${SW_CONFIG_ETCD_PERIOD:60} # Unit seconds, sync period. Default fetch every 60 seconds.    group: ${SW_CONFIG_ETCD_GROUP:skywalking}    serverAddr: ${SW_CONFIG_ETCD_SERVER_ADDR:localhost:2379}    clusterName: ${SW_CONFIG_ETCD_CLUSTER_NAME:default}  consul:    # Consul host and ports, separated by comma, e.g. 1.2.3.4:8500,2.3.4.5:8500    hostAndPorts: ${SW_CONFIG_CONSUL_HOST_AND_PORTS:1.2.3.4:8500}    # Sync period in seconds. Defaults to 60 seconds.    period: ${SW_CONFIG_CONSUL_PERIOD:1}    # Consul aclToken    aclToken: ${SW_CONFIG_CONSUL_ACL_TOKEN:""}​exporter:  selector: ${SW_EXPORTER:-}  grpc:    targetHost: ${SW_EXPORTER_GRPC_HOST:127.0.0.1}    targetPort: ${SW_EXPORTER_GRPC_PORT:9870}​</code></pre><p style=text-align:start><br></p><h1 class=pgc-h-arrow-right><strong>启动</strong></h1><p style=text-align:start>要确保已经启动了elasticsearch，并且防火墙开放8080、11800、12800端口。</p><p style=text-align:start>进入bin目录，执行命令即可运行：</p><pre><code>./startup.sh</code></pre><p style=text-align:start>默认的UI端口是8080</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7e2843bafa9d4261a1f5ab500f86552b><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>部署微服务探针</strong></h1><p style=text-align:start>现在，Skywalking的服务端已经启动完成，我们还需要在微服务中加入服务探针，来收集数据。</p><h1 class=pgc-h-arrow-right><strong>解压</strong></h1><p style=text-align:start>首先，将课前资料给的压缩包解压：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/bde980cd851d4faf8af0b364ffa2db83><p class=pgc-img-caption></p></div><p style=text-align:start>将其中的agent解压到某个目录，不要出现中文，可以看到其结构如下：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fe5578fff9964df581421a37f06d5656><p class=pgc-img-caption></p></div><p style=text-align:start>其中有一个skywalking-agent.jar就是一我们要用的探针。</p><h1 class=pgc-h-arrow-right><strong>配置</strong></h1><p style=text-align:start>如果是运行一个jar包，可以在运行时输入参数来指定探针：</p><pre><code>java -jar xxx.jar -javaagent:C:/lesson/skywalking-agent/skywalking-agent.jar -Dskywalking.agent.service_name=ly-registry -Dskywalking.collector.backend_service=192.168.150.101:11800</code></pre><p style=text-align:start>本例中，我们用开发工具来运行和配置。</p><p style=text-align:start>使用IDEA开发工具打开一个你的项目，在IDEA工具中，选择要修改的启动项，点击右键，选择Edit Configuration：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6e491af19d014b408dee0782b58bcf90><p class=pgc-img-caption></p></div><p style=text-align:start>然后在弹出的窗口中，点击Environment，选择VM options后面对应的展开按钮：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a46019ea2a9a45f996011ad2ca7139f4><p class=pgc-img-caption></p></div><p style=text-align:start>在展开的输入框中，输入下面的配置：</p><pre><code>-javaagent:C:/lesson/skywalking-agent/skywalking-agent.jar-Dskywalking.agent.service_name=ly-registry-Dskywalking.collector.backend_service=192.168.150.101:11800</code></pre><p style=text-align:start>注意：</p><ul><li>-javaagent:C:/lesson/skywalking-agent/skywalking-agent.jar：配置的是skywalking-agent.jar这个包的位置，要修改成你自己存放的目录</li><li>-Dskywalking.agent.service_name=ly-registry：是当前项目的名称，需要分别修改为ly-registry、ly-gateway、ly-item-service</li><li>-Dskywalking.collector.backend_service=192.168.150.101:11800：是Skywalking的OPA服务地址，采用的是GRPC通信，因此端口是11800，不是8080</li></ul><h1 class=pgc-h-arrow-right><strong>启动</strong></h1><p style=text-align:start>Skywalking的探针会在项目启动前对class文件进行修改，完成探针植入，对业务代码<strong>零侵入</strong>，所以我们只需要启动项目，即可生效了。</p><p style=text-align:start>启动项目，然后对项目中的的业务接口访问，探针就开始工作了。</p><h1 class=pgc-h-arrow-right><strong>WebUI界面</strong></h1><p style=text-align:start>访问：192.168.150.101:8080可以看到统计数据已经出来了：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f63c4896bc9b4a60a5c714bf537ea8fe><p class=pgc-img-caption></p></div><p style=text-align:start>服务实例的性能监控：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/63de56bf28734aeca858c557bbfc0788><p class=pgc-img-caption></p></div><p style=text-align:start>服务拓扑图：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/87d1f0999fca42508f66510c379f25cf><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/889bc84e0d614579ac3c74f3a557d83f><p class=pgc-img-caption></p></div><p style=text-align:start>某次请求的链路追踪信息：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/cc03466c5dba49f5a29464b9fd70d7fd><p class=pgc-img-caption></p></div><p style=text-align:start>表格视图：</p><div class=pgc-img><img alt=还在用Zipkin分布式服务链路追踪？来试试这个吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8fcf8a58c8de4628b9a143b0aba412d3><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'还在','Zipkin','服务链'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>