<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† | æå®¢å¿«è¨Š</title><meta property="og:title" content="åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/15396016389479731877f40"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2555281.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2555281.html><meta property="article:published_time" content="2020-10-29T21:08:06+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:06+08:00"><meta name=Keywords content><meta name=description content="åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç†"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/2555281.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç†</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p>ç©ºé—´æœç´¢ï¼ŒåˆåSpatial Searchï¼ŒåŸºäºç©ºé—´æœç´¢æŠ€æœ¯ï¼Œå¯ä»¥åšåˆ°ï¼š</p><p>1ï¼‰å¯¹Pointï¼ˆç»çº¬åº¦ï¼‰å’Œå…¶ä»–çš„å‡ ä½•å›¾å½¢å»ºç´¢å¼•</p><p>2ï¼‰æ ¹æ®è·ç¦»æ’åº</p><p>3ï¼‰æ ¹æ®çŸ©å½¢ï¼Œåœ†å½¢æˆ–è€…å…¶ä»–çš„å‡ ä½•å½¢çŠ¶è¿‡æ»¤æœç´¢ç»“æœ</p><p>åœ¨Solrä¸­ï¼Œç©ºé—´æœç´¢ä¸»è¦åŸºäºGeoHashå’ŒCartesian Tiers 2ä¸ªæ¦‚å¿µæ¥å®ç°ï¼š</p><p>GeoHashç®—æ³•</p><p>é€šè¿‡GeoHashç®—æ³•ï¼Œå¯ä»¥å°†ç»çº¬åº¦çš„äºŒç»´åº§æ ‡å˜æˆä¸€ä¸ªå¯æ’åºã€å¯æ¯”è¾ƒçš„çš„å­—ç¬¦ä¸²ç¼–ç ã€‚</p><p>åœ¨ç¼–ç ä¸­çš„æ¯ä¸ªå­—ç¬¦ä»£è¡¨ä¸€ä¸ªåŒºåŸŸï¼Œå¹¶ä¸”å‰é¢çš„å­—ç¬¦æ˜¯åé¢å­—ç¬¦çš„çˆ¶åŒºåŸŸã€‚å…¶ç®—æ³•çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><strong>æ ¹æ®ç»çº¬åº¦è®¡ç®—GeoHashäºŒè¿›åˆ¶ç¼–ç </strong></p><p>åœ°çƒçº¬åº¦åŒºé—´æ˜¯[-90,90]ï¼Œ å¦‚æŸçº¬åº¦æ˜¯39.92324ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢ç®—æ³•å¯¹39.92324è¿›è¡Œé€¼è¿‘ç¼–ç :</p><p>1ï¼‰åŒºé—´[-90,90]è¿›è¡ŒäºŒåˆ†ä¸º[-90,0),[0,90]ï¼Œç§°ä¸ºå·¦å³åŒºé—´ï¼Œå¯ä»¥ç¡®å®š39.92324å±äºå³åŒºé—´[0,90]ï¼Œç»™æ ‡è®°ä¸º1ï¼›</p><p>2ï¼‰æ¥ç€å°†åŒºé—´[0,90]è¿›è¡ŒäºŒåˆ†ä¸º [0,45),[45,90]ï¼Œå¯ä»¥ç¡®å®š39.92324å±äºå·¦åŒºé—´ [0,45)ï¼Œç»™æ ‡è®°ä¸º0ï¼›</p><p>3ï¼‰é€’å½’ä¸Šè¿°è¿‡ç¨‹39.92324æ€»æ˜¯å±äºæŸä¸ªåŒºé—´[a,b]ã€‚éšç€æ¯æ¬¡è¿­ä»£åŒºé—´[a,b]æ€»åœ¨ç¼©å°ï¼Œå¹¶è¶Šæ¥è¶Šé€¼è¿‘39.928167ï¼›</p><p>4ï¼‰å¦‚æœç»™å®šçš„çº¬åº¦ï¼ˆ39.92324ï¼‰å±äºå·¦åŒºé—´ï¼Œåˆ™è®°å½•0ï¼Œå¦‚æœå±äºå³åŒºé—´åˆ™è®°å½•1ï¼Œè¿™æ ·éšç€ç®—æ³•çš„è¿›è¡Œä¼šäº§ç”Ÿä¸€ä¸ªåºåˆ—1011 1000 1100 0111 1001ï¼Œåºåˆ—çš„é•¿åº¦è·Ÿç»™å®šçš„åŒºé—´åˆ’åˆ†æ¬¡æ•°æœ‰å…³ã€‚</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15396016389479731877f40><p class=pgc-img-caption></p></div><p>åŒç†ï¼Œåœ°çƒç»åº¦åŒºé—´æ˜¯[-180,180]ï¼Œå¯¹ç»åº¦116.3906è¿›è¡Œç¼–ç çš„è¿‡ç¨‹ä¹Ÿç±»ä¼¼ï¼š</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539601638933be2a0fa47d><p class=pgc-img-caption></p></div><p><strong>ç»„ç </strong></p><p>é€šè¿‡ä¸Šè¿°è®¡ç®—ï¼Œçº¬åº¦äº§ç”Ÿçš„ç¼–ç ä¸º1011 1000 1100 0111 1001ï¼Œç»åº¦äº§ç”Ÿçš„ç¼–ç ä¸º1101 0010 1100 0100 0100ã€‚å¶æ•°ä½æ”¾ç»åº¦ï¼Œå¥‡æ•°ä½æ”¾çº¬åº¦ï¼ŒæŠŠ2ä¸²ç¼–ç ç»„åˆç”Ÿæˆæ–°ä¸²ï¼š11100 11101 00100 01111 00000 01101 01011 00001ã€‚</p><p>æœ€åä½¿ç”¨ç”¨0-9ã€b-zï¼ˆå»æ‰a, i, l, oï¼‰è¿™32ä¸ªå­—æ¯è¿›è¡Œbase32ç¼–ç ï¼Œé¦–å…ˆå°†11100 11101 00100 01111 00000 01101 01011 00001è½¬æˆåè¿›åˆ¶ 28ï¼Œ29ï¼Œ4ï¼Œ15ï¼Œ0ï¼Œ13ï¼Œ11ï¼Œ1ï¼Œåè¿›åˆ¶å¯¹åº”çš„ç¼–ç å°±æ˜¯wx4g0ec1ã€‚åŒç†ï¼Œå°†ç¼–ç è½¬æ¢æˆç»çº¬åº¦çš„è§£ç ç®—æ³•ä¸ä¹‹ç›¸åï¼Œå…·ä½“ä¸å†èµ˜è¿°ã€‚</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1539601638931390bb06fc5><p class=pgc-img-caption></p></div><p>ç”±ä¸Šå¯çŸ¥ï¼Œå­—ç¬¦ä¸²è¶Šé•¿ï¼Œè¡¨ç¤ºçš„èŒƒå›´è¶Šç²¾ç¡®ã€‚å½“GeoHash base32ç¼–ç é•¿åº¦ä¸º8æ—¶ï¼Œç²¾åº¦åœ¨19ç±³å·¦å³ï¼Œè€Œå½“ç¼–ç é•¿åº¦ä¸º9æ—¶ï¼Œç²¾åº¦åœ¨2ç±³å·¦å³ï¼Œç¼–ç é•¿åº¦éœ€è¦æ ¹æ®æ•°æ®æƒ…å†µè¿›è¡Œé€‰æ‹©ã€‚ä¸è¿‡ä»GeoHashçš„ç¼–ç ç®—æ³•ä¸­å¯ä»¥çœ‹å‡ºå®ƒçš„ä¸€ä¸ªç¼ºç‚¹ï¼Œä½äºè¾¹ç•Œä¸¤ä¾§çš„ä¸¤ç‚¹ï¼Œè™½ç„¶ååˆ†æ¥è¿‘ï¼Œä½†ç¼–ç ä¼šå®Œå…¨ä¸åŒã€‚å®é™…åº”ç”¨ä¸­ï¼Œå¯ä»¥åŒæ—¶æœç´¢è¯¥ç‚¹æ‰€åœ¨åŒºåŸŸçš„å…¶ä»–å…«ä¸ªåŒºåŸŸçš„ç‚¹ï¼Œå³å¯è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>Cartesian Tiers ç¬›å¡å°”å±‚</p><p>ç¬›å¡å°”åˆ†å±‚æ¨¡å‹çš„æ€æƒ³æ˜¯å°†ç»çº¬åº¦è½¬æ¢æˆæ›´å¤§ç²’åº¦çš„åˆ†å±‚ç½‘æ ¼ï¼Œè¯¥æ¨¡å‹åˆ›å»ºäº†å¾ˆå¤šçš„åœ°ç†å±‚ï¼Œæ¯ä¸€å±‚åœ¨å‰ä¸€å±‚çš„åŸºç¡€ä¸Šç»†åŒ–åˆ‡åˆ†ç²’åº¦ï¼Œæ¯ä¸€ä¸ªç½‘æ ¼è¢«åˆ†é…ä¸€ä¸ªIDï¼Œä»£è¡¨ä¸€ä¸ªåœ°ç†ä½ç½®ã€‚</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/15396016389231d10231d32><p class=pgc-img-caption></p></div><p>æ¯å±‚ä»¥2çš„å¹³æ–¹é€’å¢ï¼Œæ‰€ä»¥ç¬¬ä¸€å±‚ä¸º4ä¸ªç½‘æ ¼ï¼Œç¬¬äºŒå±‚ä¸º16 ä¸ªï¼Œæ‰€ä»¥æ•´ä¸ªåœ°å›¾çš„ç»çº¬åº¦å°†åœ¨æ¯å±‚çš„ç½‘æ ¼ä¸­ä½“ç°ï¼š</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1539601638875c50a9d0ee4><p class=pgc-img-caption></p></div><p>é‚£ä¹ˆå¦‚ä½•æ„å»ºè¿™æ ·çš„ç´¢å¼•ç»“æ„å‘¢ï¼Œå…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦å¯¹åº”ç¬›å¡å°”å±‚çš„å±‚æ•°æ¥æ„å»ºåŸŸå³å¯,ä¸€ä¸ªåŸŸæˆ–åº§æ ‡å¯¹åº”å¤šä¸ªtierså±‚æ¬¡ã€‚ä¹Ÿå³æ˜¯tiers0->field_0ï¼Œtiers1->field_1,tiers2-field_2,â€¦â€¦ï¼Œtiers19->field_19ã€‚ï¼ˆä¸€èˆ¬20å±‚å³å¯ï¼‰ã€‚æ¯ä¸ªå¯¹åº”ç¬›å¡å°”å±‚æ¬¡çš„åŸŸå°†æ ¹æ®å½“å‰è¿™æ¡è®°å½•çš„ç»çº¬åº¦é€šè¿‡ç¬›å¡å°”ç®—æ³•è®¡ç®—å‡ºå½’å±äºå½“å‰å±‚çš„ç½‘æ ¼ï¼Œç„¶åå°†gridIdï¼ˆç½‘æ ¼å”¯ä¸€æ ‡ç¤ºï¼‰ä»¥termçš„æ–¹å¼å­˜å…¥ç´¢å¼•ã€‚è¿™æ ·æ¯æ¡è®°å½•å…³äºç¬›å¡å°”0-19çš„åŸŸå°†éƒ½ä¼šæœ‰ä¸€ä¸ªgridIdå¯¹åº”èµ·æ¥ã€‚ä½†æ˜¯æŸ¥è¯¢çš„æ—¶å€™ä¸€èˆ¬æ˜¯éœ€è¦æŸ¥å‘¨è¾¹çš„åœ°å€ï¼Œé‚£ä¹ˆå¯èƒ½å‘¨è¾¹çš„èŒƒå›´è¶…è¿‡ä¸€ä¸ªç½‘æ ¼çš„èŒƒå›´ï¼Œé‚£ä¹ˆå®é™…æ“ä½œè¿‡ç¨‹æ˜¯æ ¹æ®ç»çº¬åº¦å’Œä¸€ä¸ªè·ç¦»ç¡®å®šå‡ºéœ€è¦æ¶‰åŠæŸ¥è¯¢çš„ä»19-0ï¼ˆä»é«˜å¾€ä½æŸ¥ï¼‰è‹¥å¹²å±‚å¯¹åº”çš„è‹¥å¹²ç½‘æ ¼çš„æ•°æ®ã€‚é‚£ä¹ˆä¸€ä¸ªç»çº¬åº¦å‘¨è¾¹åœ°å€çš„æŸ¥è¯¢åªéœ€è¦å¦‚ä¸‹å›¾åœ†åœˆå†…çš„æ•°æ®ï¼š</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153960163887294a9094af3><p class=pgc-img-caption></p></div><p>ç”±ä¸Šå¯çŸ¥ï¼ŒåŸºäºCartesian Tierçš„æœç´¢æ­¥éª¤ä¸ºï¼š</p><p>1ã€æ ¹æ®Cartesian Tierå±‚è·å¾—åº§æ ‡ç‚¹çš„åœ°ç†ä½ç½®gridId</p><p>2ã€ä¸ç³»ç»Ÿç´¢å¼•gridIdåŒ¹é…è®¡ç®—</p><p>3ã€è®¡ç®—ç»“æœé›†ä¸ç›®æ ‡åº§æ ‡ç‚¹çš„è·ç¦»è¿”å›ç‰¹å®šèŒƒå›´å†…çš„ç»“æœé›†åˆ</p><p>ä½¿ç”¨ç¬›å¡å°”å±‚ï¼Œèƒ½æœ‰æ•ˆç¼©å‡å°‘è¿‡æ»¤èŒƒå›´ï¼Œå¿«é€Ÿå®šä½åº§æ ‡ç‚¹ã€‚</p><h1>åŸºäºSolrçš„ç©ºé—´æœç´¢å®è·µ</h1><p>åœ¨Solrä¸­ï¼Œé’ˆå¯¹ä¸Šè¿°çš„2ç§åŸç†æä¾›äº†ä¸åŒçš„ç´¢å¼•æ–¹å¼å»å®ç°ï¼Œåˆ†åˆ«æ˜¯GeohashPrefixTreeç±»å’ŒQuadPrefixTreeç±»ï¼Œå…¶ä¸­GeohashPrefixTreeå¯¹åº”GeoHashç®—æ³•(ä¹Ÿé‡‡ç”¨äº†ç¬›å¡å°”å±‚çš„åˆ†å±‚æ€æƒ³)ï¼ŒQuadPrefixTreeå¯¹åº”ç¬›å¡å°”å±‚çš„å®ç°ã€‚</p><p>GeohashPrefixTreeä¸QuadPrefixTreeéƒ½ç»§æ‰¿SpatialPrefixTreeè¿™ä¸ªå‰ç¼€æ ‘åŸºç±»ï¼Œéƒ½ä½¿ç”¨äº†åˆ†å±‚ç­–ç•¥ï¼Œä¸»è¦ç´¢å¼•å’ŒæŸ¥è¯¢é€»è¾‘â¼€æ ·ã€‚ä¸åŒç‚¹åœ¨äºå®ƒä»¬çš„maxLevelsä¸ä¸€æ ·ï¼Œè·å–å­cellçš„æ–¹å¼ä¸ä¸€æ ·ï¼ŒGeohashPrefixTreeæœ‰32ä¸ªå­cell(ç¼–ç ä¸º0-z)ï¼ŒQuadPrefixTree åªæœ‰æœ‰4ä¸ªå­cell(ç¼–ç ä¸ºABCDã€‚Aï¼šå·¦ä¸Šï¼ŒBï¼šå³ä¸Šï¼ŒCï¼šå·¦ä¸‹ï¼ŒDï¼šå³ä¸‹)ã€‚</p><p>è€Œåœ¨Solrä¸­ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨GeohashPrefixTreeçš„æ–¹å¼ï¼Œç´¢å¼•ä¸‹é¢é‡ç‚¹ä»‹ç»geohashçš„æ–¹å¼ã€‚åˆ©ç”¨Solræ¥å®ç°ç©ºé—´æœç´¢ä¸»è¦åˆ†ä¸º2éƒ¨åˆ†ï¼š</p><p>1ï¼‰ç´¢å¼•çš„æ„å»º</p><p>2ï¼‰æŸ¥è¯¢</p><p>ç´¢å¼•æ„å»º</p><p><strong>Step1 å®šä¹‰ç©ºé—´ç´¢å¼•ç±»å‹å’Œå­—æ®µ</strong></p><p>åœ¨Solrä¸­æä¾›äº†scheme.xmlæ–‡ä»¶ç”¨æ¥å®šä¹‰ç´¢å¼•ç±»å‹å’Œå­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre>&lt;fieldType name="location_rpt" class="solr.SpatialRecursivePrefixTreeFieldType" spatialContextFactory="com.spatial4j.core.context.jts.JtsSpatialContextFactory" distErrPct="0.025" maxDistErr="0.000009" units="degrees"/&gt; &lt;field name=â€poi_location_p" type="location_rpt" indexed="true" stored="true" multiValued=â€false"/&gt; </pre><p>å¯¹äºé‡è¦çš„å±æ€§è¯´æ˜å¦‚ä¸‹ï¼š</p><p>SpatialRecursivePrefixTreeFieldType</p><p>ç”¨äºæ·±åº¦éå†å‰ç¼€æ ‘çš„FieldTypeï¼Œä¸»è¦ç”¨äºè·å¾—åŸºäºLuceneä¸­çš„RecursivePrefixTreeStrategyã€‚</p><p>JtsSpatialContextFactory</p><p>å½“æœ‰Polygonå¤šè¾¹å½¢æˆ–è€…linestringsçº¿æ®µæ—¶ï¼Œä¼šä½¿ç”¨jts(éœ€è¦æŠŠjts.jaræ”¾åˆ°solræœåŠ¡çš„libä¸‹)ï¼Œè€ŒåŸºæœ¬å½¢çŠ¶ä½¿ç”¨SpatialContext (spatial4jçš„ç±»)ã€‚</p><p>distErrPct</p><p>å®šä¹‰éPointå›¾å½¢çš„ç²¾åº¦ï¼ŒèŒƒå›´åœ¨0-0.5ä¹‹é—´ã€‚è¯¥å€¼å†³å®šäº†éPointçš„å›¾å½¢ç´¢å¼•æˆ–æŸ¥è¯¢æ—¶çš„level(å¦‚geohashæ¨¡å¼æ—¶å°±æ˜¯geohashç¼–ç çš„é•¿åº¦)ã€‚å½“ä¸º0æ—¶å–maxLevelsï¼Œå³ç²¾åº¦æœ€å¤§,ç²¾åº¦è¶Šå¤§å°†èŠ±è´¹æ›´å¤šçš„ç©ºé—´å’Œæ—¶é—´å»å»ºç´¢å¼•ã€‚</p><p>geo</p><p>é»˜è®¤ä¸ºtrueï¼Œå€¼ä¸ºtrueçš„æƒ…å†µä¸‹åº§æ ‡åŸºäºçƒé¢åº§æ ‡ç³»ï¼Œé‡‡ç”¨Geohashçš„æ–¹å¼ï¼›å€¼ä¸ºfalseçš„æƒ…å†µä¸‹åº§æ ‡åŸºäº2Då¹³é¢çš„åº§æ ‡ç³»ï¼Œé‡‡ç”¨Euclidean/Cartesiançš„æ–¹å¼ã€‚</p><p>worldBounds</p><p>ä¸–ç•Œåº§æ ‡å€¼ï¼šâ€minX minY maxX maxYâ€ã€‚ geo=trueå³geohashæ¨¡å¼æ—¶ï¼Œè¯¥å€¼é»˜è®¤ä¸ºâ€-180 -90 180 90â€ã€‚geo=falseå³quadæ—¶ï¼Œè¯¥å€¼ä¸ºJava doubleç±»å‹çš„æ­£è´Ÿè¾¹ç•Œï¼Œæ­¤æ—¶éœ€è¦æŒ‡å®šè¯¥å€¼ï¼Œè®¾ç½®æˆâ€-180 -90 180 90â€ã€‚</p><p>distCalculator</p><p>è®¾ç½®è·ç¦»è®¡ç®—ç®—æ³•ï¼Œgeo=trueé»˜è®¤æ˜¯haversineï¼Œgeo=falseé»˜è®¤æ˜¯cartesian(ç¬›å¡å°”è®¡ç®—æ–¹å¼)ï¼Œå€¼å¯ä»¥ä¸º"lawOfCosines"(ä½™å¼¦å®šç†), "vincentySphere"(æ–‡æ£®ç‰¹çƒé¢å…¬å¼) æˆ– "cartesian^2"ã€‚</p><p>prefixTree</p><p>Solrå°†åœ°çƒæ˜ å°„ä¸ºç½‘æ ¼ï¼ŒprefixTreeå®šä¹‰äº†ç½‘æ ¼çš„å®ç°æ–¹å¼ï¼Œæ¯ä¸ªç½‘æ ¼åœ¨ä¸‹ä¸€å±‚ä¸­å¯ä»¥åˆ†è§£æˆå¤šä¸ªå­ç½‘æ ¼ï¼Œgeo=true prefixTreeåªèƒ½å–GeoHashï¼Œgeo=false prefixTreeå¯å–quad(quadTreeä¸€ç§å››åˆ†æ ‘åœ°ç†ä½ç½®ç´¢å¼•ï¼Œå¯¹åº”ç¬›å¡å°”åˆ†å±‚ç­–ç•¥)</p><p>maxDistErr/maxLevels</p><p>maxDistErrå®šä¹‰äº†ç´¢å¼•æ•°æ®çš„æœ€é«˜å±‚maxLevelsï¼Œä¸Šè¿°å®šä¹‰ä¸º0.000009ï¼Œæ ¹æ®GeohashUtils.lookupHashLenForWidthHeight(0.000009, 0.000009)ç®—å‡ºç¼–ç é•¿åº¦ä¸º11ä½ï¼Œç²¾åº¦åœ¨1ç±³å·¦å³ï¼Œç›´æ¥å†³å®šäº†Pointç´¢å¼•çš„termæ•°ã€‚</p><p>maxLevelsä¼˜å…ˆçº§é«˜äºmaxDistErr,å³æœ‰maxLevelsçš„è¯maxDistErrå¤±æ•ˆã€‚è¯¦è§SpatialPrefixTreeFactory.init()æ–¹æ³•ã€‚</p><p>ä¸è¿‡ä¸€èˆ¬ä½¿ç”¨maxDistErrã€‚</p><p>units</p><p>å•ä½æ˜¯degreesï¼Œä¸é€‚ç”¨äºgeofilt, bbox, or geodistï¼ˆå•ä½ä¸ºkmï¼‰</p><p><strong>Step2 æ„å»ºç´¢å¼•</strong></p><p>æ„å»ºç´¢å¼•ä»£ç ç¤ºä¾‹ï¼ˆåœ¨ç¾å›¢ä¸»è¦ä½¿ç”¨Pointç±»å‹çš„ç´¢å¼•ï¼‰ï¼š</p><pre>doc.setField(â€poi_location_p", "32.52162,120.31778") //pointç±»å‹æˆ–è€…doc.setField("poi_location_p", "POLYGON((120.35330414772034 31.58268495951037,120.35190939903259 31.57923921490961,120.35330414772034 31.58268495951037))") //å¤šè¾¹å½¢ç±»å‹</pre><p>æ„å»ºæµç¨‹ï¼š</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/153960163909277d6829cfb><p class=pgc-img-caption></p></div><p>ä¸‹é¢ä¸»è¦è¯´æ˜Pointç±»å‹çš„termåˆ›å»ºè¿‡ç¨‹ã€‚</p><p>1ã€å°†ç©ºé—´ç´¢å¼•åŸŸçš„shapeStrè§£ææˆç›¸åº”çš„Shapeï¼ˆè¿™é‡ŒæŒ‡Pointï¼Œå¤æ‚Shapeå¦‚Polygonè¦ä½¿ç”¨JTSä¸­çš„WTKReaderæ¥è§£æï¼‰ã€‚</p><p>2ã€åˆ›å»ºç´¢å¼•åŸŸ,å…·ä½“è¿‡ç¨‹å‚è€ƒorg.apache.lucene.spatial.prefix.RecursivePrefixTreeStrategyä¸­çš„createIndexableFieldsæ–¹æ³•ã€‚</p><p>aã€æ ¹æ®distErrPctå­—æ®µï¼Œè®¡ç®—è·ç¦»çš„è¯¯å·®å€¼ï¼Œå¯¹äºPointæ¥è¯´é»˜è®¤ä¸º0ï¼ˆè€Œå¯¹äºéPointç±»å‹æ¥è¯´ï¼Œæ˜¯é€šè¿‡å¤–åŒ…çŸ©å½¢ä¸­å¿ƒç‚¹åˆ°çŸ©å½¢é¡¶ç‚¹çš„è·ç¦»å†ä¹˜ä»¥distErrPctæ¥è®¡ç®—è¯¯å·®å€¼çš„ï¼‰</p><pre>double distErr = SpatialArgs.calcDistanceFromErrPct(shape, distErrPct, ctx); public static double calcDistanceFromErrPct(Shape shape, double distErrPct, SpatialContext ctx) { if (distErrPct &lt; 0 || distErrPct &gt; 0.5) { throw new IllegalArgumentException("distErrPct " + distErrPct + " must be between [0 to 0.5]"); } if (distErrPct == 0 || shape instanceof Point) { return 0; } Rectangle bbox = shape.getBoundingBox(); //Compute the distance from the center to a corner. Because the distance // to a bottom corner vs a top corner can vary in a geospatial scenario, // take the closest one (greater precision). Point ctr = bbox.getCenter(); double y = (ctr.getY() &gt;= 0 ? bbox.getMaxY() : bbox.getMinY()); double diagonalDist = ctx.getDistCalc().distance(ctr, bbox.getMaxX(), y); return diagonalDist * distErrPct;}</pre><p>bã€æ ¹æ®ä¸Šè¿°è®¡ç®—å‡ºçš„è¯¯å·®å€¼ï¼Œå¾—åˆ°ç´¢å¼•çš„geohashç¼–ç é•¿åº¦ï¼Œå¯¹äºPointç±»å‹æ¥è¯´å€¼ä¸ºmaxLevelsã€‚</p><pre>public int getLevelForDistance(double dist) { if (dist == 0) return maxLevels;//short circuit final int level = GeohashUtils.lookupHashLenForWidthHeight(dist, dist); return Math.max(Math.min(level, maxLevels), 1);}</pre><p>cã€æ ¹æ®ç¼–ç é•¿åº¦å¾—åˆ°æ»¡è¶³æ‰€æœ‰æ¡ä»¶çš„cellsï¼ˆæ¯ä¸ªcellè¡¨ç¤ºä¸€ä¸ªå‰ç¼€å€¼ï¼‰ï¼Œå¹¶å°†Cellséƒ½æ”¾åœ¨CellTokenStreamä¸­ï¼ŒåŒæ—¶æ„å»ºç´¢å¼•åŸŸã€‚Pointç±»å‹æ¯ä¸ªCellè¡¨ç¤ºgeohashçš„ä¸€ä¸ªå‰ç¼€å€¼ã€‚</p><pre>public List&lt;Cell&gt; getCells(Point p, int detailLevel, boolean inclParents){ Cell cell = getCell(p, detailLevel); if (!inclParents) { return Collections.singletonList(cell); }  String endToken = cell.getTokenString(); assert endToken.length() == detailLevel; List&lt;Cell&gt; cells = new ArrayList&lt;Cell&gt;(detailLevel); for (int i = 1; i &lt; detailLevel; i++) { cells.add(getCell(endToken.substring(0, i))); } cells.add(cell); return cells;} Field field = new Field(getFieldName(), new CellTokenStream(cells.iterator()), FIELD_TYPE);</pre><p>3ã€æ„å»ºå­˜å–åŸŸå­˜å‚¨ç´¢å¼•</p><pre>if (field.stored()) { if (shapeStr == null) shapeStr = shapeToString(shape); result.add(new StoredField(field.getName(), shapeStr));}</pre><p>4ã€ç»“æœ</p><p>å¦‚ç»çº¬åº¦41.79452,123.41555ï¼Œå¯¹åº”çš„geohashä¸ºwxrvb2kqexuï¼ˆmaxLevels=11ï¼‰, åˆ™å…¶å¯¹åº”çš„termæœ‰11ä¸ªï¼ˆå¦‚wã€wxã€wxrã€wxrvâ€¦ï¼‰ã€‚</p><p>æŸ¥è¯¢</p><p>æŸ¥è¯¢è¯­æ³•ç¤ºä¾‹ï¼š</p><pre>q={!geofilt pt=45.15,-93.85 sfield=poi_location_p d=5 score=distance}q={!bbox pt=45.15,-93.85 sfield=poi_location_p d=5 score=distance}q=poi_location_p:"Intersects(-74.093 41.042 -69.347 44.558)" //a bounding box (not in WKT) q=poi_location_p:"Intersects(POLYGON((-10 30, -40 40, -10 -20, 40 20, 0 0, -10 30)))" //a WKT example </pre><p>æ¶‰åŠåˆ°çš„å­—æ®µè¯´æ˜ï¼š</p><p><strong>å­—æ®µå«ä¹‰</strong>qæŸ¥è¯¢æ¡ä»¶ï¼Œå¦‚ q=poi_id:134567fqè¿‡æ»¤æ¡ä»¶ï¼Œå¦‚ fq=store_name:å†œä¸šflè¿”å›å­—æ®µï¼Œå¦‚fl=poi_idï¼Œstore_nameptåº§æ ‡ç‚¹ï¼Œå¦‚pt=54.729696,-98.525391dæœç´¢åŠå¾„ï¼Œå¦‚ d=10è¡¨ç¤º10kmèŒƒå›´å†…sfieldæŒ‡å®šåº§æ ‡ç´¢å¼•å­—æ®µï¼Œå¦‚sfield=geodefTypeæŒ‡å®šæŸ¥è¯¢ç±»å‹ å¯ä»¥å– dismaxå’Œedismaxï¼Œedismaxæ”¯æŒbooså‡½æ•°ç›¸ä¹˜ä½œç”¨ï¼Œdismaxæ˜¯é€šè¿‡ç´¯åŠ æ–¹å¼è®¡ç®—æœ€åçš„score.qfæŒ‡å®šæƒé‡å­—æ®µï¼šqf=store_name^10+poi_location_p^5scoreæ’åºå­—æ®µ æ ¹æ®qfå®šä¹‰çš„å­—æ®µdefTypeå®šä¹‰çš„æ–¹å¼è®¡ç®—å¾—åˆ°scoreæ’åºè¾“å‡º</p><p>å…¶ä¸­æœ‰å‡ ç§å¸¸è§çš„Solræ”¯æŒçš„å‡ ä½•æ“ä½œï¼š</p><p>WITHINï¼šåœ¨å†…éƒ¨</p><p>CONTAINSï¼šåŒ…å«å…³ç³»</p><p>DISJOINTï¼šä¸ç›¸äº¤</p><p>Intersectsï¼šç›¸äº¤ï¼ˆå­˜åœ¨äº¤é›†ï¼‰</p><p>åœ¨ç¾å›¢CRMä¸­ï¼Œç©ºé—´æœç´¢æ—¥å¸¸å¸¸è§çš„éœ€æ±‚ä¸»è¦åˆ†ä¸º2ç±»ï¼š</p><p>1. èŒƒå›´æœç´¢ï¼ˆåœ¨ç¾å›¢CRMä¸­å¯¹åº”å‘¨è¾¹å•†å®¶æœç´¢ï¼‰</p><p>èŒƒå›´æœç´¢æ”¯æŒ2ç§èŒƒå›´ç¡®å®šæ–¹å¼ï¼š</p><ul><li>geofiltæ–¹å¼ï¼šæ ¹æ®æœç´¢åŠå¾„è¿‡æ»¤ç»“æœï¼Œè¿”å›ä»¥ptä¸ºåœ†å¿ƒdä¸ºåŠå¾„çš„åœ†å†…æ‰€æœ‰ç‚¹,å¦‚å·¦å›¾æ‰€ç¤ºè¿”å›åœ†å½¢å†…æ‰€æœ‰ç‚¹</li><li>bboxæ–¹å¼ï¼šæ ¹æ®å…·ä½“çš„åŸŸè¿‡æ»¤ç»“æœï¼Œä¸ä»…è¿”å›ä»¥ptä¸ºåœ†å¿ƒdä¸ºåŠå¾„çš„åœ†å†…æ‰€æœ‰ç‚¹ï¼Œè¿˜åŒ…æ‹¬åŸŸå†…å…¶ä»–ç‚¹ï¼Œè¿”å›çŸ©å½¢æ¡†å†…æ‰€æœ‰ç‚¹ï¼Œå¦‚å³å›¾æ‰€ç¤ºï¼š</li></ul><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539601639027a9393bb249><p class=pgc-img-caption></p></div><ul><li></li></ul><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153960163907026d394244d><p class=pgc-img-caption></p></div><ul><li><br></li></ul><p>èŒƒå›´æœç´¢çš„æƒ…å†µå¾ˆå¤šï¼Œä¸‹é¢åˆ—ä¸¾ä¸€äº›å¸¸ç”¨åœºæ™¯çš„æŸ¥è¯¢è¯­æ³•ï¼š</p><ul><li>ä¸éœ€è¦æ’åºçš„åœºæ™¯</li></ul><pre> fq={!geofilt pt=45.15,-93.85 sfield=geo d=5}   fq={!bbox pt=45.15,-93.85 sfield=geo d=5} </pre><ul><li>éœ€è¦æ’åºçš„åœºæ™¯,è¾ƒå¤æ‚</li></ul><p>1) æŒ‰è·ç¦»æ’åºï¼Œè·ç¦»è¶Šè¿‘æ’åè¶Šé«˜ï¼ŒåŠ ä¸Šscore=distanceï¼Œå…¶ä¸­distanceæ˜¯ç´¢å¼•ç‚¹åˆ°åº§æ ‡ç‚¹ä¹‹é—´çš„å¼§åº¦å€¼ï¼Œç³»ç»Ÿæ ¹æ®å¼§åº¦å€¼æ’åºã€‚</p><pre>&amp;fl=*,score&amp;sort=score asc&amp;q={!geofilt score=distance sfield=poi_location_p pt=54.729696,-98.525391 d=10}ã€‚</pre><p>2) æŒ‰è·ç¦»æ’åºï¼Œè·ç¦»è¶Šè¿œæ’åè¶Šé«˜ï¼ŒåŠ ä¸Šscore=reciDistanceï¼Œå…¶ä¸­reciDistance èŒƒå›´æ˜¯0~1 é‡‡ç”¨å€’æ•°çš„æ–¹å¼è®¡ç®—ï¼Œæ•…ä¸distanceçš„æ’åºåˆšå¥½ç›¸å</p><pre>&amp;fl=*,score&amp;sort=score asc&amp;q={!geofilt score=reciDistance sfield=poi_location_p pt=54.729696,-98.525391 d=10} </pre><p>3) è·ç¦»ä»…ä½œæ’åºä¸åšè¿‡æ»¤ï¼Œåœ¨æ¡ä»¶ä¸­è®¾ç½®filter=falseï¼Œå…¶ä¸­dåªæ˜¯ç¡®å®šå½¢çŠ¶çš„ä½œç”¨,ä¸èµ·é™åˆ¶ä½œç”¨ã€‚</p><pre>&amp;fl=*,score&amp;sort=score asc&amp;q={!geofilt score=distance filter=false sfield=poi_location_p pt=54.729696,-98.525391 d=10}</pre><p>4) ç»“åˆå…³é”®è¯æŸ¥è¯¢å’Œè·ç¦»æ’åºï¼Œæ­¤æ—¶å…³é”®å­—åªèƒ½ä½œä¸ºè¿‡æ»¤æ¡ä»¶ï¼ˆfqï¼‰ä¸èƒ½ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼Œä»…ä½œä¸ºè¿‡æ»¤åŸŸã€‚</p><pre>&amp;fl=*,score&amp; fq=store_name:å†œä¸š&amp;sort=score asc&amp;q={!geofilt score=distance sfield=poi_location_p pt=54.729696,-98.525391 d=10}</pre><p>5) å½“å…³é”®å­—å’Œè·ç¦»éƒ½ä½œä¸ºæ’åºæ¡ä»¶æ—¶ï¼Œå¯ä»¥ç”¨qfå‚æ•°è®¾ç½®æƒé‡</p><pre>&amp;fl=*,score&amp; fq=store_name:å†œä¸š&amp;sort=score asc&amp;q={!geofilt score=distance sfield=poi_location_p pt=54.729696,-98.525391 d=10} &amp;defType=dismax&amp;qf=store_name^10+poi_location_p^5</pre><p>2.å›¾å½¢æœç´¢ï¼ˆåœ¨ç¾å›¢CRMä¸­å¯¹åº”åœ°å›¾æ¨¡å¼æœç´¢ï¼‰</p><p>åœ¨ç¾å›¢CRMä¸­ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§åœºæ™¯ï¼š</p><p>1) ç›´çº¿é™„è¿‘1kmå•†å®¶æœç´¢</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15396016391257ac61e5d13><p class=pgc-img-caption></p></div><pre>&amp;fl=*,score&amp;sort=score asc&amp;q=poi_location_p:"Intersects(LINESTRING(116.38263702392578 39.86653357724533,116.4935302734375 39.8578370694061) d=1</pre><p>2) æ­£å¸¸å¤šè¾¹å½¢èŒƒå›´å†…çš„å•†å®¶</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539601639135643145c22e><p class=pgc-img-caption></p></div><pre>&amp;fl=*,score&amp;sort=score asc&amp;q=poi_location_p:"Intersects(POLYGON ((116.37714385986328 39.88392328618825,116.46709442138672 39.86627006289872,116.40392303466797 39.83358644035512,116.33525848388672 39.85124807212413,116.37714385986328 39.88392328618825))) distErrPct=0</pre><p>3ï¼‰å¤æ‚ï¼ˆå¦‚è‡ªç›¸äº¤ï¼‰å¤šè¾¹å½¢èŒƒå›´å†…çš„å•†å®¶</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153960163922739da1cdf95><p class=pgc-img-caption></p></div><p>å¯¹äºè¿™ç§è‡ªç›¸äº¤çš„å¤šè¾¹å½¢ï¼ŒSolré»˜è®¤è®¤ä¸ºæ˜¯éæ³•çš„ï¼Œä¼šæŠ›å‡ºç±»ä¼¼è¿™æ ·çš„å¼‚å¸¸ï¼š</p><p>com.spatial4j.core.exception.InvalidShapeException: Self-intersection at or near point (116.4272689819336 39.875755941712825, NaN)ï¼Œå› æ­¤åœ¨å°†å‚æ•°ä¼ å…¥solrå‰ï¼Œéœ€è¦åŸºäºæ ‡å‡† Douglas-Peucker Algorithm ç®—æ³•å¯¹å¤šè¾¹å½¢è¿›è¡Œå¤„ç†ï¼Œå¤„ç†åèƒ½å»æ‰è‡ªç›¸äº¤çš„éƒ¨åˆ†ï¼Œæ•ˆæœå¦‚ç¤ºæ„å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539601639237bc3ac851aa><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=åŸºäºsolrçš„ç©ºé—´æ£€ç´¢-è¯¦ç»†å®ç°åŸç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539601639234cd77392d98><p class=pgc-img-caption></p></div><p>å¤„ç†åï¼Œè‡ªç›¸äº¤çš„éƒ¨åˆ†å˜ä¸º3å’Œ6ä¸¤ä¸ªç‚¹ã€‚å½“ç„¶ç»è¿‡å¤„ç†åçš„å¤šè¾¹å½¢æ•°æ®ä¼šæŸå¤±ä¸€äº›ç²¾ç¡®åº¦ã€‚</p><p>ç®€åŒ–å‰ï¼š</p><pre>POLYGON((116.4272689819336 39.875755941712825,116.50142669677734 39.84966661865515,116.4059829711914 39.83068633533497,116.48357391357422 39.8873480121113,116.47808074951172 39.827258780634594,116.47773742675781 39.8177661982179,116.41319274902344 39.87048617098581,116.4272689819336 39.875755941712825))</pre><p>ç®€åŒ–åï¼š</p><pre>POLYGON ((116.4272689819336 39.875755941712825,116.45455487823865 39.866156528285366, 116.48357391357422 39.8873480121113, 116.48079281261445 39.85692579689432,116.50142669677734 39.84966661865515,116.47973485573046 39.84535290095104,116.47808074951172 39.827258780634594,116.47773742675781 39.8177661982179,116.45096720829837 39.8396320628827,116.4059829711914 39.83068633533497,116.43551562011505 39.85225289138226,116.41319274902344 39.87048617098581,116.4272689819336 39.875755941712825)ï¼‰</pre><p>ç®€åŒ–åæŸ¥è¯¢è¯­æ³•å˜ä¸ºï¼š</p><pre>&amp;fl=*,score&amp;sort=score asc&amp;q=poi_location_p:"Intersects(POLYGON ((116.4272689819336 39.875755941712825,116.45455487823865 39.866156528285366, 116.48357391357422 39.8873480121113, 116.48079281261445 39.85692579689432,116.50142669677734 39.84966661865515,116.47973485573046 39.84535290095104,116.47808074951172 39.827258780634594,116.47773742675781 39.8177661982179,116.45096720829837 39.8396320628827,116.4059829711914 39.83068633533497,116.43551562011505 39.85225289138226,116.41319274902344 39.87048617098581,116.4272689819336 39.875755941712825)) distErrPct=0</pre><p>æ— è®ºæ˜¯èŒƒå›´æŸ¥è¯¢è¿˜æ˜¯å›¾å½¢æœç´¢ï¼Œä»–ä»¬çš„æŸ¥è¯¢åŸºæœ¬æµç¨‹éƒ½ç±»ä¼¼ï¼Œä¸»è¦åˆ†ä¸ºä¸‹é¢2æ­¥ï¼š</p><p>1ã€è§£ææŸ¥è¯¢ï¼Œç”ŸæˆQueryæ ‘ï¼šè·å¾—ç›¸åº”çš„QParseï¼ˆSpatialFilterQParserï¼‰, å¯¹æŸ¥è¯¢ä¸²è¿›è¡Œè¯­æ³•è§£æï¼Œè·å¾—æŸ¥è¯¢ä¸²çš„å„ä¸ªå‚æ•°ï¼Œå¹¶ä¸”è·å¾—ç›¸åº”çš„æŸ¥è¯¢Queryï¼ˆåŒ…æ‹¬ç›¸åº”çš„Filterï¼‰ï¼Œå…¶ä¸­ä¹Ÿè®¡ç®—äº†æŸ¥è¯¢Shapeçš„ä¸€äº›å±æ€§ï¼Œå¦‚æœ€å¤§ç´¢å¼•é•¿åº¦detailLevelã€‚</p><pre> Query result = null; if (type instanceof SpatialQueryable) { double radius = localParams.getDouble(SpatialParams.SPHERE_RADIUS, DistanceUtils.EARTH_MEAN_RADIUS_KM); SpatialOptions opts = new SpatialOptions(pointStr, dist, sf, measStr, radius); opts.bbox = bbox; result = ((SpatialQueryable)type).createSpatialQuery(this, opts); }</pre><p>2ã€æŸ¥è¯¢ï¼šSolrIndexSearch.search()è¿›è¡Œåˆ›å»ºWeightæ ‘å’ŒScoreæ ‘ï¼Œåˆ©ç”¨ä¸åŒçš„filterå’Œscoreç­–ç•¥å¾—åˆ°ç¬¦åˆæ¡ä»¶çš„docIdSetã€‚è€Œå¯¹äºå‡ ç§ä¸åŒçš„å‡ ä½•å›¾å½¢å…³ç³»ï¼ŒSolræä¾›äº†å‡ ç§ä¸åŒçš„filterç±»æ¥è®¡ç®—ï¼Œè¿™äº›filteréƒ½ç»§æ‰¿AbstractPrefixTreeFilterç±»ï¼Œç®€å•æ¥è¯´å°±æ˜¯è·å–ä¸æŸ¥è¯¢Shapeç›¸äº¤çš„æ‰€æœ‰å­Cellï¼Œç„¶åå†ä¸termè¿›è¡ŒåŒ¹é…çš„è¿‡ç¨‹ã€‚</p><h1>æ€»ç»“</h1><p>æœ¬æ–‡è¯¦ç»†åˆ†æäº†ç©ºé—´æœç´¢çš„åŸç†ä»¥åŠåŸºäºSolrçš„å®è·µï¼Œéšç€ç§»åŠ¨äº’è”ç½‘æ—¶ä»£çš„åˆ°æ¥ä»¥åŠlbsæŠ€æœ¯çš„æ™®åŠï¼Œç©ºé—´æœç´¢æŠ€æœ¯çš„åº”ç”¨åœºæ™¯ä¼šè¶Šæ¥è¶Šå¤šï¼ŒåŒæ—¶éšç€ç¾å›¢çš„ä¸æ–­å‘å±•å£®å¤§ï¼Œè¶Šæ¥è¶Šå¤šçš„å•†å®¶ä¼šåŠ å…¥ç¾å›¢è¿™ä¸ªå¹³å°ï¼Œå¯¹äºç©ºé—´æœç´¢çš„æŒ‘æˆ˜ä¹Ÿå°†è¶Šæ¥è¶Šå¤§ï¼Œæ­¤æ–‡ä»…ä»…ä½œä¸ºæŠ›ç –å¼•ç‰ï¼Œç©ºé—´æœç´¢æŠ€æœ¯è¿˜æœ‰å¾ˆå¤šå€¼å¾—æ·±å…¥æŒ–æ˜çš„åœ°æ–¹ã€‚</p><h1>å‚è€ƒ</h1><p>http://tech.meituan.com/solr-spatial-search.html</p><p>http://ju.outofmemory.cn/entry/94794</p><p>ä¸ªäººä¾‹å­ï¼š</p><p>é¦–å…ˆåœ¨é…ç½®æ–‡ä»¶ db-data-config.xml é‡ŒåŒ…å«ä»¥ä¸‹å­—æ®µ</p><p>concat(Latitude,',',Longitude) as product_pos</p><p>schema.xml</p><pre>&lt;field name="product_pos" type="location" indexed="true" stored="true" multiValued="false" required="false"/&gt;&lt;field name="product_pos_rpt" type="location_rpt" indexed="true" stored="true" multiValued="false" required="false"/&gt;	&lt;copyField source="product_pos" dest="product_pos_rpt"/&gt;&lt;fieldType name="location" class="solr.LatLonType" subFieldSuffix="_coordinate"/&gt; &lt;fieldType name="location_rpt" class="solr.SpatialRecursivePrefixTreeFieldType" geo="true" distErrPct="0.025" maxDistErr="0.001" distanceUnits="kilometers" /&gt;</pre><p>solrj</p><pre>query.addFilterQuery("{!geofilt}"); //è·ç¦»è¿‡æ»¤å‡½æ•°query.set("sfield", "product_pos_rpt"); //ç»çº¬åº¦çš„å­—æ®µquery.set("pt", latitude + "," + longitude); //å½“å‰ç»çº¬åº¦query.set("d", 500); //å°±è¿‘500å…¬é‡Œ//	query.setFields(" distance:geodist() "); //å–distanceä¸ºåˆ«åquery.addField(" distance:geodist() ");query.set("sort", "geodist() asc"); //æ ¹æ®è·ç¦»æ’åº</pre></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'solr','ç©ºé—´','æ£€ç´¢'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>