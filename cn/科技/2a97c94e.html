<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试 | 极客快訊</title><meta property="og:title" content="能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/13af1f0e8f1b498b81eb41b809772f90"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2a97c94e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2a97c94e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2a97c94e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2a97c94e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2a97c94e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2a97c94e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2a97c94e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2a97c94e.html><meta property="article:published_time" content="2020-11-14T21:02:39+08:00"><meta property="article:modified_time" content="2020-11-14T21:02:39+08:00"><meta name=Keywords content><meta name=description content="能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/2a97c94e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>作者：闲鱼技术-灯阳</p><h1>1.背景</h1><p>当前闲鱼在精益开发模式下，整个技术团队面临了诸多的能力落地和挑战，尤其是效能方面的2-1-1的目标(2周需求交付周期，1周需求开发周期，1小时达到发布标准)，具体可见 <a class=pgc-link href=https://mp.weixin.qq.com/s/SbJemkUDTXK8vyWgHOiGGA target=_blank>闲鱼工程师是如何构建持续集成流水线，让研发效率翻倍的</a> ，在这个大目标下，就必须把每个环节都做到极致。自动化的建设是决定CI成败的关键能力，今天分享一下闲鱼Android客户端性能自动化环节的实践。</p><h1>2.面临的问题</h1><p>2.1 主要是两个方面的问题</p><ul><li>工具缺失：</li></ul><p>目前淘宝系，对于线上性能水位的监控有一套完善的体系，但是针对新功能的性能测试，每个业务团队都有对应的性能专项小组，产出的工具都是根据自己业务特点的定制开发的，闲鱼客户端目前使用Flutter做为客户端主开发语言，对于Flutter性能数据的获取及UI自动化测试支撑工具目前是缺失的，同时业界对Flutter自动化和性能相关的实践几乎没有；</p><ul><li>测试工作量翻N倍(N=一个版本周期内的分支数)：</li></ul><p>原先的开发模式是功能测试集成测试一起进行的，所以性能测试只需要针对集成后的包进行测试即可，到现在转变为泳道的开发模式，一个版本内会一般包含十几个左右的泳道分支甚至更多，我们必须确保每个泳道的分支的性能是达标的，如果有性能问题需要第一时间反馈出来，如果遗留到集成阶段，问题的排查(十几个分支中筛查)，问题的解决将会耗费大量的时间，效率很难得到大的提升；</p><p>2.2 问题思考</p><p>体系化解决，要让每个泳道分支都得到有效测试覆盖，测试件能够自动化执行，持续反馈结果</p><div class=pgc-img><img alt=能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/13af1f0e8f1b498b81eb41b809772f90><p class=pgc-img-caption></p></div><h1>3. 解决方案</h1><p>综合上述问题，梳理如下解决方案：</p><ul><li>针对Flutter性能数据的获取(比如，Flutter有自己的SurfaceView，原有Native计算FPS的方式无法直接使用)</li><li>针对Flutter UI自动化的实现(Flutter/Native UI混合栈的处理)</li><li>性能自动化脚本 / 性能数据自动采集、上报 融入CI流程</li><li>性能问题的通知 / 报表展示 / 分析</li></ul><p>3.1 性能数据</p><p>[FPS]</p><p>解析处理 adb shell dumpsys SurfaceFlinger --latency 的数据，详细请见文末参考链接(该方式兼容Flutter及Native的解决方案，已在Android4.x-9.x验证可行)，处理SurfaceFlinger核心代码如下：</p><pre>dumpsys SurfaceFlinger --latency-clear#echo "dumpsys SurfaceFlinger..."if [[ $isflutter = 0 ]];then window=`dumpsys window windows | grep mCurrent | $bb awk '{print $3}'|$bb tr -d '}'` # Get the current window echo $windowfiif [[ $isflutter = 1 ]];then window=`dumpsys SurfaceFlinger --list |grep '^SurfaceView'|$bb awk 'NR==1{print $0}'`if [ -z "$window" ]; then  window="SurfaceView"fiecho $windowfi$bb usleep $sleep_tdumpsys SurfaceFlinger --latency "$window"|$bb awk -v time=$uptime -v target=$target -v kpi=$KPI '{if(NR==1){r=$1/1000000;if(r&lt;0)r=$1/1000;b=0;n=0;w=1}else{if(n&gt;0&amp;&amp;$0=="")O=1;if(NF==3&amp;&amp;$2!=0&amp;&amp;$2!=9223372036854775807){x=($3-$1)/1000000/r;if(b==0){b=$2;n=1;d=0;D=0;if(x&lt;=1)C=r;if(x&gt;1){d+=1;C=int(x)*r;if(x%1&gt;0)C+=r};if(x&gt;2)D+=1;m=r;o=0}else{c=($2-b)/1000000;if(c&gt;1000){O=1}else{n+=1;if(c&gt;=r){C+=c;if(c&gt;kpi)o+=1;if(c&gt;=m)m=c;if(x&gt;1)d+=1;if(x&gt;2)D+=1;b=$2}else{C+=r;b=sprintf("%.0f",b+r*1000000)}}};if(n==1)s=sprintf("%.3f",$2/1000000000)};if(n&gt;0&amp;&amp;O==1){O=0;if(n==1)t=sprintf("%.3f",s+C/1000);else t=sprintf("%.3f",b/1000000000);T=strftime("%F %T",time+t)"."sprintf("%.0f",(time+t)%1*1000);f=sprintf("%.2f",n*1000/C);m=sprintf("%.0f",m);g=f/target;if(g&gt;1)g=1;h=kpi/m;if(h&gt;1)h=1;e=sprintf("%.2f",g*60+h*20+(1-o/n)*20);print s","t","T","f+0","n","d","D","m","o","e","w;n=0;if($0==""){b=0;w+=1}else{b=$2;n=1;d=0;D=0;if(x&lt;=1)C=r;if(x&gt;1){d+=1;C=int(x)*r;if(x%1&gt;0)C+=r};if(x&gt;2)D+=1;m=r;o=0}}}}' &gt;&gt;$file</pre><p>[CPU]</p><p>使用的是top的命令获取(该方式获取性能数据时，数据收集带来的损耗最少)</p><pre>export bb="/data/local/tmp/busybox"$bb top -b -n 1|$bb awk 'NR==4{print NF-1}'</pre><p>[内存]</p><p>解析 dumpsys meminfo $package 拿到 Java Heap,Java Heap Average,Java Heap Peak,Native Heap,Native Heap Average,Native Heap Peak,Graphics,Unknown,Pss 数据</p><pre>do_statistics() { ((COUNT+=1)) isExist="$(echo $OUTPUT | grep "Dalvik Heap")"  if [[ ! -n $isExist ]] ; then old_dumpsys=true else old_dumpsys=false fi if [[ $old_dumpsys = true ]] ; then java_heap="$(echo "$OUTPUT" | grep "Dalvik" | $bb awk '{print $6}' | $bb tr -d '\r')" else java_heap="$(echo "$OUTPUT" | grep "Dalvik Heap[^:]" | $bb awk '{print $8}' | $bb tr -d '\r')" fi echo "1."$JAVA_HEAP_TOTAL "2."$java_heap "3."$JAVA_HEAP_TOTAL ((JAVA_HEAP_TOTAL+=java_heap)) ((JAVA_HEAP_AVG=JAVA_HEAP_TOTAL/COUNT)) if [[ $java_heap -gt $JAVA_HEAP_PEAK ]] ; then JAVA_HEAP_PEAK=$java_heap fi if [[ $old_dumpsys = true ]] ; then native_heap="$(echo "$OUTPUT" | grep "Native" | $bb awk '{print $6}' | $bb tr -d '\r')" else native_heap="$(echo "$OUTPUT" | grep "Native Heap[^:]" | $bb awk '{print $8}' | $bb tr -d '\r' | $bb tr -d '\n')" fi ((NATIVE_HEAP_TOTAL+=native_heap)) ((NATIVE_HEAP_AVG=NATIVE_HEAP_TOTAL/COUNT)) if [[ $native_heap -gt $NATIVE_HEAP_PEAK ]] ; then NATIVE_HEAP_PEAK=$native_heap fi g_Str="Graphics" if [[ $OUTPUT == *$g_Str* ]] ; then echo "Found Graphics..." Graphics="$(echo "$OUTPUT" | grep "Graphics" | $bb awk '{print $2}' | $bb tr -d '\r')" else echo "Not Found Graphics..." Graphics=0 fi Unknown="$(echo "$OUTPUT" | grep "Unknown" | $bb awk '{print $2}' | $bb tr -d '\r')" total="$(echo "$OUTPUT" | grep "TOTAL"|$bb head -1| $bb awk '{print $2}' | $bb tr -d '\r')"}</pre><p>[流量]</p><p>通过 dumpsys package packages 解析出当前待测试包来获取流量信息</p><pre>uid="$(dumpsys package packages|$bb grep -E "Package |userId"|$bb awk -v OFS=" " '{if($1=="Package"){P=substr($2,2,length($2)-2)}else{if(substr($1,1,6)=="userId")print P,substr($1,8,length($1)-7)}}'|grep $package|$bb awk '{print $2}')"echo "Net:"$uidinitreceive=`$bb awk -v OFS=" " 'NR&gt;1{if($2=="wlan0"){wr[$4]+=$6;wt[$4]+=$8}else{if($2=="rmnet0"){rr[$4]+=$6;rt[$4]+=$8}}}END{for(i in wr){print i,wr[i]/1000,wt[i]/1000,"wifi"};for(i in rr){print i,rr[i]/1000,rt[i]/1000,"data"}}' /proc/net/xt_qtaguid/stats | grep $uid|$bb awk '{print $2}'`inittransmit=`$bb awk -v OFS=" " 'NR&gt;1{if($2=="wlan0"){wr[$4]+=$6;wt[$4]+=$8}else{if($2=="rmnet0"){rr[$4]+=$6;rt[$4]+=$8}}}END{for(i in wr){print i,wr[i]/1000,wt[i]/1000,"wifi"};for(i in rr){print i,rr[i]/1000,rt[i]/1000,"data"}}' /proc/net/xt_qtaguid/stats | grep $uid|$bb awk '{print $3}'`echo "initnetarray"$initreceive","$inittransmitgetnet(){ local data_t=`date +%Y/%m/%d" "%H:%M:%S` netdetail=`$bb awk -v OFS=, -v initreceive=$initreceive -v inittransmit=$inittransmit -v datat="$data_t" 'NR&gt;1{if($2=="wlan0"){wr[$4]+=$6;wt[$4]+=$8}else{if($2=="rmnet0"){rr[$4]+=$6;rt[$4]+=$8}}}END{for(i in wr){print datat,i,wr[i]/1000-initreceive,wt[i]/1000-inittransmit,"wifi"};for(i in rr){print datat,i,rr[i]/1000-initreceive,rt[i]/1000-inittransmit,"data"}}' /proc/net/xt_qtaguid/stats | grep $uid` echo $netdetail&gt;&gt;$filenet}</pre><p>3.2 性能自动化脚本</p><ul><li>基于Appium的自动化用例，这个技术业界已经有非常多的实践了，这里我不再累述，如果不了解的同学，可以到Appium官网 <a class=pgc-link href=http://appium.io/ target=_blank>http://appium.io</a></li><li>Flutter和Native页面切换使用App内的Schema跳转</li><li>Flutter页面的文本输入等交互性较强的场景使用基于Flutter框架带的Integration Test来操作</li></ul><blockquote><p>An <em>integration test</em></p><p>Generally, an <em>integration test</em> runs on a real device or an OS emulator, such as iOS Simulator or Android Emulator. The app under test is typically isolated from the test driver code to avoid skewing the results.</p></blockquote><p>Flutter的UI自动化及Flutter/Native混合页面的处理在测试上的应用后续单独开文章介绍，原理相关可以先参考 <a class=pgc-link href=https://mp.weixin.qq.com/s/c8sR5LgnmpbWGRxn4D0Kxw target=_blank>千人千面录制回放技术</a></p><p>3.3 性能自动化CI流程</p><div class=pgc-img><img alt=能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5afe8d003ad140ddb56a347bd3028669><p class=pgc-img-caption></p></div><p>3.4 性能数据报表</p><p>FPS相关</p><div class=pgc-img><img alt=能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/c1f468071ec749f2b1c9bbd01e1e86df><p class=pgc-img-caption></p></div><ul><li>Framediff: 绘制帧的开始时间和结束时间差</li><li>FPS: 每秒展示的帧数</li><li>Frames: 一个刷新周期内所有的帧</li><li>jank: 一帧开始绘制到结束超过16.67ms 就记一次jank，jank非零代表硬件绘制掉帧，和屏幕硬件性能及相关驱 动性能有关</li><li>jank2: 一帧开始绘制到结束超过33.34ms 就记一次jank2</li><li>MFS: 在一个刷新周期内单帧最大耗时（每两行垂直同步的时间差代表两帧绘制的帧间隔）</li><li>OKT: 在一个刷新周期内，帧耗时超过16.67ms的次数</li><li>SS: 流畅度，通过FPS，MFS，OKT计算出来，流畅度 = 实际帧率比目标帧率比值<em>60【目标帧率越高越好】 + 目标时间和两帧时间差比值</em>20【两帧时间差越低越好】 + (1-超过16ms次数/帧数)*20【次数越少越好】</li></ul><p>CPU</p><div class=pgc-img><img alt=能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7127a34c0309433bb62ff29b6f990192><p class=pgc-img-caption></p></div><p>Memory</p><div class=pgc-img><img alt=能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ef874257ddb24a918ef27a3b63e2fd3a><p class=pgc-img-caption></p></div><h1>4. 成果展示</h1><p>4.1 指定泳道分支性能监控</p><p>泳道分支出现了性能问题再报表上一目了然</p><div class=pgc-img><img alt=能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8a2695e48ccd41b18d202d6dde4a24d2><p class=pgc-img-caption></p></div><p>4.2 性能专项支撑</p><p>1、Flutter商品详情页重构 14轮测试</p><div class=pgc-img><img alt=能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/48616e80911a402bbd2b665399b75ccb><p class=pgc-img-caption></p></div><p>2、客户端图片统一资源测试 4轮测试</p><div class=pgc-img><img alt=能用机器完成的，千万别堆工作量|持续集成中的性能自动化测试 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ac9963a94a3d4379aa7e7f032bde4800><p class=pgc-img-caption></p></div><h1>5. 总结</h1><p>性能自动化只是整个CI流程中的一个环节，为了极致效率的大目标，闲鱼质量团队还产出了很多支撑工具，CI平台，遍历测试，AI错误识别，用例自动生成等等，后续也会分享给大家。</p><h1>6. 参考</h1><p><a class=pgc-link href=https://testerhome.com/topics/2232 target=_blank>https://testerhome.com/topics/2232</a></p><p><a class=pgc-link href=https://testerhome.com/topics/4775 target=_blank>https://testerhome.com/topics/4775</a></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'机器','千万别','持续'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>