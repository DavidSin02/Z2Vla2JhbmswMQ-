<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案 | 极客快訊</title><meta property="og:title" content="蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/0d4c2fcaf83d4ac2aca78ef9a857b5e3"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2d041ca.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2d041ca.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2d041ca.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2d041ca.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2d041ca.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2d041ca.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2d041ca.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2d041ca.html><meta property="article:published_time" content="2020-10-29T20:50:41+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:41+08:00"><meta name=Keywords content><meta name=description content="蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/2d041ca.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>推荐阅读</p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6768432742762807815/?group_id=6768432742762807815" target=_blank>2019年末Java面试解析总结：Java+Redis+数据库+解决方案+分布式..</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6766569847846339084/?group_id=6766569847846339084" target=_blank>不想搞Java了，4年经验去面试10分钟结束，现在Java面试为何这么难</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6765108858714063372/?group_id=6765108858714063372" target=_blank>终于有人把tomcat讲清楚了！阿里大牛推荐的tomcat架构解析文档</a></p><p>如果对分布式事务基础还不懂可以看看之前的2篇文章</p><h1 class=pgc-h-arrow-right>基础概念</h1><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6772152082326618636/?group_id=6772152082326618636" target=_blank>BAT分布式事务场景实战（一）：分布式事务基础</a></p><h1 class=pgc-h-arrow-right>分布式事务基础理论</h1><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6772460195365782027/?group_id=6772460195365782027" target=_blank>分布式事务专题（二）：分布式事务基础理论</a></p><h1 class=pgc-h-arrow-right>分布式事务解决方案之2PC(两阶段提交)</h1><p>前面已经学习了分布式事务的基础理论，以理论为基础，针对不同的分布式场景业界常见的解决方案有2PC、TCC、可靠消息最终一致性、最大努力通知这几种。</p><p><strong>3.1.什么是2PC</strong></p><p>2PC即两阶段提交协议，是将整个事务流程分为两个阶段，准备阶段（Prepare phase）、提交阶段（commitphase），2是指两个阶段，P是指准备阶段，C是指提交阶段。</p><p><strong>举例：</strong></p><blockquote><p>张三和李四好久不见，老友约起聚餐，饭店老板要求先买单，才能出票。这时张三和李四分别抱怨近况不如意，囊中羞涩，都不愿意请客，这时只能AA。只有张三和李四都付款，老板才能出票安排就餐。但由于张三和李四都是铁公鸡，<strong>形成了尴尬的一幕：</strong></p><p><strong>准备阶段：</strong>老板要求张三付款，张三付款。老板要求李四付款，李四付款。</p><p><strong>提交阶段：</strong>老板出票，两人拿票纷纷落座就餐。</p></blockquote><p>在计算机中部分关系数据库如Oracle、MySQL支持两阶段提交协议，如下图：</p><p><strong>1. 准备阶段（Prepare phase）：</strong>事务管理器给每个参与者发送Prepare消息，每个数据库参与者在本地执行事务，并写本地的Undo/Redo日志，此时事务没有提交。（Undo日志是记录修改前的数据，用于数据库回滚，Redo日志是记录修改后的数据，用于提交事务后写入数据文件）</p><p><strong>2. 提交阶段（commit phase）：</strong>如果事务管理器收到了参与者的执行失败或者超时消息时，直接给每个参与者发送回滚(Rollback)消息；否则，发送提交(Commit)消息；参与者根据事务管理器的指令执行提交或者回滚操作，并释放事务处理过程中使用的锁资源。注意:必须在最后阶段释放锁资源。</p><p><strong>下图展示了2PC的两个阶段，分成功和失败两个情况说明：</strong></p><p><strong>成功情况：</strong></p><div class=pgc-img><img alt=蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0d4c2fcaf83d4ac2aca78ef9a857b5e3><p class=pgc-img-caption></p></div><p><strong>失败情况：</strong></p><div class=pgc-img><img alt=蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b76c1d0d266c4e8680dba722f4410868><p class=pgc-img-caption></p></div><p><strong>3.2.解决方案</strong></p><p><strong>3.2.1 XA方案</strong></p><p>2PC的传统方案是在数据库层面实现的，如Oracle、MySQL都支持2PC协议，为了统一标准减少行业内不必要的对接成本，需要制定标准化的处理模型及接口标准，国际开放标准组织Open Group定义了分布式事务处理模型<strong>DTP</strong>（Distributed Transaction Processing Reference Model）。</p><p>为了让大家更明确XA方案的内容程，<strong>下面新用户注册送积分为例来说明：</strong></p><div class=pgc-img><img alt=蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/da38fbc1baa54dc58c176a4cb7a3da63><p class=pgc-img-caption></p></div><p><strong>执行流程如下：</strong></p><ol start=1><li>应用程序（AP）持有用户库和积分库两个数据源。</li><li>应用程序（AP）通过TM通知用户库RM新增用户，同时通知积分库RM为该用户新增积分，RM此时并未提交事务，此时用户和积分资源锁定。</li><li>TM收到执行回复，只要有一方失败则分别向其他RM发起回滚事务，回滚完毕，资源锁释放。</li><li>TM收到执行回复，全部成功，此时向所有RM发起提交事务，提交完毕，资源锁释放。</li></ol><p><strong>DTP模型定义如下角色：</strong></p><ul><li>AP(Application Program)：即应用程序，可以理解为使用DTP分布式事务的程序。</li><li>RM(Resource Manager)：即资源管理器，可以理解为事务的参与者，一般情况下是指一个数据库实例，通过资源管理器对该数据库进行控制，资源管理器控制着分支事务。</li><li>TM(Transaction Manager)：事务管理器，负责协调和管理事务，事务管理器控制着全局事务，管理事务生命周期，并协调各个RM。全局事务是指分布式事务处理环境中，需要操作多个数据库共同完成一个工作，这个工作即是一个全局事务。</li><li>DTP模型定义TM和RM之间通讯的接口规范叫XA，简单理解为数据库提供的2PC接口协议，基于数据库的XA协议来实现2PC又称为XA方案。</li></ul><p><strong>以上三个角色之间的交互方式如下：</strong></p><ol start=1><li>TM向AP提供 应用程序编程接口，AP通过TM提交及回滚事务。</li><li>TM交易中间件通过XA接口来通知RM数据库事务的开始、结束以及提交、回滚等。</li></ol><p><strong>总结：</strong></p><p>整个2PC的事务流程涉及到三个角色AP、RM、TM。AP指的是使用2PC分布式事务的应用程序；RM指的是资源管理器，它控制着分支事务；TM指的是事务管理器，它控制着整个全局事务。</p><ol start=1><li>在准备阶段RM执行实际的业务操作，但不提交事务，资源锁定；</li><li>在提交阶段TM会接受RM在准备阶段的执行回复，只要有任一个RM执行失败，TM会通知所有RM执行回滚操作，否则，TM将会通知所有RM提交该事务。提交阶段结束资源锁释放。</li></ol><p><strong>XA方案的问题：</strong></p><p>需要本地数据库支持XA协议。</p><p>资源锁需要等到两个阶段结束才释放，性能较差。</p><p><strong>3.2.2 Seata方案</strong></p><p>Seata是由阿里中间件团队发起的开源项目 Fescar，后更名为Seata，它是一个是开源的分布式事务框架。</p><p>传统2PC的问题在Seata中得到了解决，它通过对本地关系数据库的分支事务的协调来驱动完成全局事务，是工作在应用层的中间件。主要优点是性能较好，且不长时间占用连接资源，它以高效并且对业务0侵入的方式解决微服务场景下面临的分布式事务问题，它目前提供AT模式(即2PC)及TCC模式的分布式事务解决方案。</p><p><strong>Seata的设计思想如下：</strong></p><p>Seata的设计目标其一是对业务无侵入，因此从业务无侵入的2PC方案着手，在<strong>传统2PC</strong>的基础上演进，并解决2PC方案面临的问题。</p><p>Seata把一个分布式事务理解成一个包含了若干<strong>分支事务</strong>的<strong>全局事务</strong>。全局事务的职责是协调其下管辖的分支事务达成一致，要么一起成功提交，要么一起失败回滚。此外，通常分支事务本身就是一个关系数据库的本地事务，<strong>下图是全局事务与分支事务的关系图：</strong></p><div class=pgc-img><img alt=蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c97ab8dd32ea496abe525c55fd4b4d9b><p class=pgc-img-caption></p></div><p><strong>与 传统2PC 的模型类似，Seata定义了3个组件来协议分布式事务的处理过程：</strong></p><div class=pgc-img><img alt=蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/e86b9e2710d8471893252748a83d6531><p class=pgc-img-caption></p></div><ul><li>Transaction Coordinator (TC)： 事务协调器，它是独立的中间件，需要独立部署运行，它维护全局事务的运行状态，接收TM指令发起全局事务的提交与回滚，负责与RM通信协调各各分支事务的提交或回滚。</li><li>Transaction Manager (TM)： 事务管理器，TM需要嵌入应用程序中工作，它负责开启一个全局事务，并最终向TC发起全局提交或全局回滚的指令。</li><li>Resource Manager (RM)： 控制分支事务，负责分支注册、状态汇报，并接收事务协调器TC的指令，驱动分支（本地）事务的提交和回滚。</li></ul><p>还拿<strong>新用户注册送积分</strong>举例Seata的分布式事务过程：</p><div class=pgc-img><img alt=蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0d1d9298156c4dda8e583acc2181e4bd><p class=pgc-img-caption></p></div><p><strong>具体的执行流程如下：</strong></p><ol start=1><li>用户服务的 TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的XID。</li><li>用户服务的 RM 向 TC 注册 分支事务，该分支事务在用户服务执行新增用户逻辑，并将其纳入 XID 对应全局事务的管辖。</li><li>用户服务执行分支事务，向用户表插入一条记录。</li><li>逻辑执行到远程调用积分服务时(XID 在微服务调用链路的上下文中传播)。积分服务的RM 向 TC 注册分支事务，该分支事务执行增加积分的逻辑，并将其纳入 XID 对应全局事务的管辖。</li><li>积分服务执行分支事务，向积分记录表插入一条记录，执行完毕后，返回用户服务。</li><li>用户服务分支事务执行完毕。</li><li>TM 向 TC 发起针对 XID 的全局提交或回滚决议。</li><li>TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求。</li></ol><p><strong>Seata实现2PC与传统2PC的差别</strong>：</p><p>架构层次方面，<strong>传统2PC</strong>方案的 RM 实际上是在数据库层，RM 本质上就是数据库自身，通过 XA 协议实现，而Seata的 RM 是以jar包的形式作为中间件层部署在应用程序这一侧的。</p><p>两阶段提交方面，<strong>传统2PC</strong>无论第二阶段的决议是commit还是rollback，事务性资源的锁都要保持到Phase2完成才释放。而Seata的做法是在Phase1 就将本地事务提交，这样就可以省去Phase2持锁的时间，整体提高效率。</p><p><strong>下次专门会写一篇Seatas实现2PC业务，可以关注我下后续持续阅读，觉得不错的可以帮忙转发下，感谢您的支持！</strong></p><p><strong>学习分享</strong></p><p><strong>平时有记录整理过一份Java学习笔记，这份笔记包括了Spring，JVM,java基础，Java集合，Java并发编程，微服务，网络，Kafka，分布式，Redis，大厂面试解决方案，分布式事务，设计模式，算法，数据结构，MySQL等</strong></p><blockquote class=article-blockquote><p><strong>详细内容有很多，为了不影响阅读，可看整理的《Java架构进阶笔记》，</strong>转发此文关注我私信回复【<strong>资料</strong>】咨询如何获取<strong>《Java架构进阶笔记》</strong>的免费领取方式！</p></blockquote><div class=pgc-img><img alt=蚂蚁金服Java二面：熟悉分布式事务？说说2PC(两阶段提交)解决方案 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/001c8cdd838846eda5b55719efea7dd2><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'蚂蚁','金服','Java'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>