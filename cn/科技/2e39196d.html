<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MySQLè¯­å¥å’Œå‘½ä»¤å¤§å…¨ | æå®¢å¿«è¨Š</title><meta property="og:title" content="MySQLè¯­å¥å’Œå‘½ä»¤å¤§å…¨ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2e39196d.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2e39196d.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2e39196d.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2e39196d.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2e39196d.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2e39196d.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2e39196d.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2e39196d.html><meta property="article:published_time" content="2020-11-14T21:04:12+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:12+08:00"><meta name=Keywords content><meta name=description content="MySQLè¯­å¥å’Œå‘½ä»¤å¤§å…¨"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/2e39196d.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MySQLè¯­å¥å’Œå‘½ä»¤å¤§å…¨</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><h1>ä¸€ã€ç”¨æˆ·è¿æ¥ã€åˆ›å»ºã€æƒé™ã€åˆ é™¤</h1><p>1. è¿æ¥MySQLæ“ä½œ</p><p>mysql -h ä¸»æœºåœ°å€ -u ç”¨æˆ·å -Pç«¯å£å· -p</p><p>ä½¿ç”¨ SSL è¿æ¥</p><p>mysql --ssl-ca=ca.pem --ssl-cert=client-cert.pem --ssl-key=client-key.pem -hä¸»æœºåœ°å€ -uç”¨æˆ·å -p</p><p>2. åˆ›å»ºç”¨æˆ·</p><p>CREATE USER 'username'@'host' IDENTIFIED BY 'password';</p><ul><li>host æŒ‡å®šè¯¥ç”¨æˆ·åœ¨å“ªä¸ªä¸»æœºä¸Šå¯ä»¥ç™»é™†,å¦‚æœæ˜¯æœ¬åœ°ç”¨æˆ·å¯ç”¨localhost, å¦‚æœæƒ³è®©è¯¥ç”¨æˆ·å¯ä»¥ä»ä»»æ„è¿œç¨‹ä¸»æœºç™»é™†,å¯ä»¥ä½¿ç”¨é€šé…ç¬¦%.</li></ul><p>3. æˆæƒ</p><p>GRANT [all privileges/æŸä¸ªæƒé™] ON databasename.tablename TO 'username'@'host';</p><p>å¦‚æœæƒ³è®©è¯¥ç”¨æˆ·å¯ä»¥æˆæƒ,ç”¨ä»¥ä¸‹å‘½ä»¤:</p><p>GRANT all privileges ON databasename.tablename TO 'username'@'host' WITH GRANT OPTION;</p><p>4. é”å®šç”¨æˆ·</p><pre>ALTER USER 'username'@'host' ACCOUNT LOCK;</pre><p><strong>è§£é”</strong></p><pre>ALTER USER 'username'@'host' ACCOUNT UNLOCK;</pre><p><strong>å¸¸è§åœºæ™¯</strong>:</p><p>1 åˆ›å»ºè¯»å†™æƒé™çš„ç”¨æˆ·</p><pre>GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, EXECUTE, CREATE VIEW, SHOW VIEW ONdatabasename.tablename TO 'username'@'host';</pre><p>2 åˆ›å»ºåªè¯»æƒé™ç”¨æˆ·</p><pre>GRANT SELECT,SHOW VIEW ON databasename.tablename TO 'username'@'host';</pre><p>4. è®¾ç½®ä¸æ›´æ”¹ç”¨æˆ·å¯†ç </p><p><strong>æ–¹æ³•ä¸€</strong></p><p>SET PASSWORD FOR 'username'@'host' = PASSWORD('newpassword');</p><p>å¦‚æœæ˜¯å½“å‰ç™»é™†ç”¨æˆ·ç”¨</p><p>SET PASSWORD = PASSWORD("newpassword");</p><p><strong>æ–¹æ³•äºŒ</strong></p><pre>ALTER USER 'root'@'localhost' IDENTIFIED BY 'password';</pre><p>5. æ’¤é”€ç”¨æˆ·æƒé™</p><p>REVOKE [ALL/æŸä¸ªæƒé™] ON databasename.tablename FROM 'username'@'host';</p><p>æŸä¸ªç”¨æˆ·æƒé™å¯ä»¥ç”¨å‘½ä»¤SHOW GRANTS FOR 'username'@'host'; æŸ¥çœ‹.</p><p>5. é‡å‘½åç”¨æˆ·</p><pre>rename user 'old_name'@'host' to 'new_name'@'host';</pre><p>7. åˆ é™¤ç”¨æˆ·</p><pre>DROP USER 'username'@'host';</pre><p>8. è¦æ±‚ä½¿ç”¨sslç™»é™†</p><pre># ä¿®æ”¹å·²å­˜åœ¨ç”¨æˆ· ALTER USER 'username'@'%' REQUIRE SSL;# åˆ›å»ºç”¨æˆ·create user username_ssl@'%' identified by 'password' require ssl;</pre><p>åˆ·æ–°æƒé™è¡¨</p><p>flush privileges;</p><h1>äºŒã€æ•°æ®åº“ä¸è¡¨æ˜¾ç¤ºã€åˆ›å»ºã€åˆ é™¤</h1><p>1. æ•°æ®åº“æŸ¥çœ‹&åˆ›å»º&åˆ é™¤</p><pre>-- æŸ¥çœ‹æ•°æ®åº“show databases; -- åˆ›å»ºåº“create database [IF NOT EXISTS] &lt;åº“å&gt; [character set='utf8'];-- åˆ é™¤åº“drop database &lt;åº“å&gt;; </pre><p>2. è¡¨æŸ¥çœ‹ã€åˆ›å»ºã€åˆ é™¤</p><pre>-- æ˜¾ç¤ºæ•°æ®è¡¨use &lt;åº“å&gt;;show tables;-- åˆ›å»ºè¡¨ï¼šcreate table è¡¨å (å­—æ®µè®¾å®šåˆ—è¡¨) [engine=InnoDB] [charset=utf8mb4];-- æŸ¥çœ‹åˆ›å»ºè¡¨çš„ DDL è¯­å¥show create table &lt;è¡¨å&gt;;-- æ˜¾ç¤ºè¡¨ç»“æ„desc &lt;è¡¨å&gt;;-- åˆ é™¤è¡¨drop table [IF EXISTS] &lt;è¡¨å&gt;; -- ä¸´æ—¶è¡¨CREATE TEMPORARY TABLE &lt;è¡¨å&gt;(&lt;å­—æ®µå®šä¹‰&gt;);</pre><p><strong>e.g.</strong></p><pre>CREATE TABLE USER ( id INT NOT NULL AUTO_INCREMENT, stu_id INT NOT NULL, name VARCHAR(30) NOT NULL, phone VARCHAR(20), address VARCHAR(30) NOT NULL, age INT NOT NULL, PRIMARY KEY (id), UNIQUE KEY `un_stu_id` (stu_id), KEY `idx_name` (`name`) USING BTREE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</pre><p>æ³¨æ„: ä¸º text ç­‰å»ºç«‹ç´¢å¼•æ—¶è¦æŒ‡å®šé•¿åº¦ e.g. KEY idx_text (f_text(64))</p><h1>ä¸‰ã€è¡¨å¤åˆ¶ã€å¤‡ä»½è¿˜åŸåŠæ¸…é™¤</h1><p>1. å¤åˆ¶è¡¨ç»“æ„</p><p><strong>å«æœ‰ä¸»é”®ç­‰ä¿¡æ¯çš„å®Œæ•´è¡¨ç»“æ„:</strong></p><p>CREATE table æ–°è¡¨å LIKE book;</p><p><strong>åªæœ‰è¡¨ç»“æ„ï¼Œæ²¡æœ‰ä¸»é”®ç­‰ä¿¡æ¯:</strong></p><pre>create table æ–°è¡¨å select * from books;æˆ–create table æ–°è¡¨å as(select * from book);æˆ–create table æ–°è¡¨å select * from books where1=2;</pre><p>æ³¨: create table &lt;t> select ... ä¼šé€ æˆç´¢å¼•ä¸¢å¤±</p><p>2. å°†æ—§è¡¨ä¸­çš„æ•°æ®çŒå…¥æ–°è¡¨</p><p>INSERT INTO &lt;æ–°è¡¨> SELECT * FROM &lt;æ—§è¡¨>;</p><p>3. æ˜¾ç¤ºåˆ›å»ºè¡¨çš„DDLè¯­å¥</p><p>show create table &lt;è¡¨å>;</p><p>4. æ¸…ç©ºè¡¨æ•°æ®</p><p>truncate table &lt;è¡¨å>;</p><p>5. å¤‡ä»½æ•°æ®åº“</p><p>å¤‡ä»½å•ä¸ªåº“</p><pre>shell&gt; mysqldump --single-transaction --master-data=2 --default-character-set=utf8 -u root -p &lt;database_name&gt; &gt;database_name.sql</pre><p>å¤‡ä»½ä¸€ä¸ªè¡¨</p><pre>shell&gt; mysqldump --single-transaction --master-data=2 --default-character-set=utf8 -u root -p &lt;database_name&gt; &lt;table_name&gt; &gt; table_name.sql</pre><p>å¤‡ä»½å¤šä¸ªåº“</p><pre>shell&gt; mysqldump --single-transaction --master-data=2 --default-character-set=utf8 -u username -p --databases &lt;dbname1&gt; &lt;dbname2&gt; &gt; Backup.sql</pre><p>å¤‡ä»½æ‰€æœ‰åº“</p><pre>shell&gt; mysqldump --single-transaction --master-data=2 --default-character-set=utf8 -A -u root -p &gt; back.sql</pre><p>å¿½ç•¥æŸäº›åº“è¡¨</p><pre>--ignore-table=performance_schema.* --ignore-table=information_schema.* --ignore-table=sys.* --ignore-table=test.*</pre><p>å¸¦ä¸Šå‹ç¼©</p><pre>shell&gt; mysqldump -A | gzip &gt;&gt; backup.sql.gz</pre><p>6. è¿˜åŸæ•°æ®åº“</p><pre>shell&gt; mysql -u root -p -f [database_name] &lt; backup.sql</pre><p>7. ä»å¤‡ä»½æ–‡ä»¶æŠ½å–æ•°æ®</p><p>æå–æŸä¸ªåº“çš„æ‰€æœ‰æ•°æ®</p><pre>shell&gt; sed -n '/^-- Current Database: `test_restore`/,/^-- Current Database:/p' mysql_back.sql</pre><p>åªæå–å»ºè¡¨è¯­å¥</p><pre>shell&gt; sed -e'/./{H;$!d;}' -e 'x;/CREATE TABLE `test1`/!d;q' mysql_back.sql</pre><p>åªæå–æ•°æ®</p><pre>shell&gt; grep -i 'INSERT INTO `test1`' mysql_back.sql</pre><p>æå–æ‰€æœ‰å»ºåº“è¡¨è¯­å¥</p><pre>shell&gt; grep -iv 'INSERT INTO `' mysql_back.sql</pre><p>8. å¯¼å‡ºæ•°æ®</p><p>&lt;selectè¯­å¥> into outfile "dest_file";</p><p>9. å¯¼å…¥æ•°æ®</p><p>load data infile "&lt;file_name>" into table &lt;table_name>;</p><h1>å››ã€ä¿®æ”¹è¡¨çš„åˆ—ä¸è¡¨å</h1><p>1. ç»™åˆ—æ›´å</p><p>alter table &lt;è¡¨åç§°> change &lt;æ—§å­—æ®µåç§°> &lt;æ–°å­—æ®µåç§°></p><p>2. ç»™è¡¨æ›´å</p><p>alter table &lt;æ—§è¡¨åç§°> rename &lt;æ–°è¡¨åç§°></p><p>3. ä¿®æ”¹æŸä¸ªè¡¨çš„å­—æ®µç±»å‹åŠæŒ‡å®šä¸ºç©ºæˆ–éç©º</p><p>alter table &lt;è¡¨åç§°> change &lt;å­—æ®µåç§°> &lt;å­—æ®µåç§°> &lt;å­—æ®µç±»å‹> [not null];</p><p>alter table &lt;è¡¨åç§°> modify &lt;å­—æ®µåç§°> &lt;å­—æ®µç±»å‹> [not null];</p><p>4. å¢åŠ ä¸€ä¸ªå­—æ®µ(ä¸€åˆ—)</p><p>alter table è¡¨åç§° add column å­—æ®µåç§° å­—æ®µç±»å‹;</p><p>åŠ åœ¨æŸä¸ªå­—æ®µåé¢</p><p>alter table è¡¨åç§° add column å­—æ®µåç§° å­—æ®µç±»å‹ after æŸä¸ªå­—æ®µ;</p><p>åŠ åœ¨æœ€å‰</p><p>alter table è¡¨åç§° add column å­—æ®µåç§° å­—æ®µç±»å‹ first;</p><p>5. æ›´æ”¹ä¸€ä¸ªå­—æ®µåå­—(ä¹Ÿå¯ä»¥æ”¹å˜ç±»å‹å’Œé»˜è®¤å€¼)</p><p>alter table &lt;è¡¨åç§°> change &lt;åŸå­—æ®µåç§°> &lt;æ–°å­—æ®µåç§° å­—æ®µç±»å‹>;</p><p>6. æ”¹å˜ä¸€ä¸ªå­—æ®µçš„é»˜è®¤å€¼</p><p>alter table è¡¨åç§° alter å­—æ®µåç§° set default å€¼;</p><p>è¯¥æ–¹æ³•ä¸ä¼šé”è¡¨</p><p>7. æ”¹å˜ä¸€ä¸ªå­—æ®µçš„æ•°æ®ç±»å‹</p><p>alter table &lt;è¡¨åç§°> change column &lt;å­—æ®µåç§°> &lt;å­—æ®µåç§°> &lt;å­—æ®µç±»å‹>;</p><p>8. åˆ é™¤å­—æ®µ</p><p>alter table &lt;è¡¨åç§°> drop column &lt;åˆ—å>;</p><h1>äº” æŸ¥è¯¢è¡¨</h1><pre>SELECT [DISTINCT] &lt;å­—æ®µåç§°,ç”¨é€—å·éš”å¼€/*&gt;FROM &lt;left_table&gt; [&lt;join_type&gt; JOIN &lt;right_table&gt; ON &lt;è¿æ¥æ¡ä»¶&gt;]WHERE &lt;whereæ¡ä»¶&gt;GROUP BY &lt;åˆ†ç»„å­—æ®µ&gt;HAVING &lt;ç­›é€‰æ¡ä»¶&gt;ORDER BY &lt;æ’åºæ¡ä»¶&gt; [desc/asc]LIMIT n[, m]</pre><p>1. GROUP BY ä¸èšåˆå‡½æ•° ä½¿ç”¨æ³¨æ„ç‚¹</p><p>1 åœ¨ä¸ä½¿ç”¨èšåˆå‡½æ•°çš„æ—¶å€™ï¼Œgroup by å­å¥ä¸­å¿…é¡»åŒ…å«æ‰€æœ‰çš„åˆ—ï¼Œå¦åˆ™ä¼šæŠ¥é”™</p><p>æ­£ç¡®ï¼š select name,age from test group by name,age; //å’Œ select ä¸€æ ·</p><p>2 åœ¨ group by å­å¥ä¸­ä¸è¦åŠ ä¸Šèšåˆå‡½æ•°å¤„çš„åˆ—å</p><p>2. having</p><p>SQL æ ‡å‡†</p><p>è¦æ±‚ having å¿…é¡»å¼•ç”¨ group å­å¥ä¸­çš„åˆ—æˆ–è€…ç”¨èšåˆå‡½æ•°å¤„ç†è¿‡</p><p>åçš„åˆ—ã€‚</p><p>mysql å¯¹è¿™ä¸€æ ‡å‡†è¿›è¡Œäº†ä¸€äº›æ‰©å±•ï¼Œå®ƒå…è®¸ having å¼•</p><p>ç”¨ select ä¸­æ£€ç´¢çš„åˆ—å’Œå¤–éƒ¨æŸ¥è¯¢ä¸­çš„åˆ—ã€‚</p><p>having ä¸­ç”¨åˆ°çš„æ¡ä»¶è¦</p><p>ä¹ˆåœ¨ group by ä¸­å‡ºç°ï¼Œè¦ä¹ˆåœ¨ select çš„åˆ—ä¸­å‡ºç°ï¼Œè¦ä¹ˆåœ¨å¤–æŸ¥</p><p>è¯¢ä¸­å‡ºç°ã€‚</p><p>3. from</p><p>from å­æŸ¥è¯¢æ—¶è¦ç»™æ•°æ®è¡¨æŒ‡å®šä¸€ä¸ªåˆ«åã€‚from (select ..) [as] åˆ«å where...</p><p>4. union</p><p>select è¯­å¥ union [all] select è¯­å¥</p><p>union ä¼šå»é‡</p><p>5. join å¤–è¿æ¥æŸ¥è¯¢</p><p>select * from tableA A [leftã€right] join tableB B on A.id = B.id</p><p>6. join äº¤å‰è¿æ¥</p><p>select * from tableA,tableB</p><p>select * from tableA cross join tableB</p><p>é€—å·ä¸ cross join åŒºåˆ«æ˜¯é€—å·ä¸èƒ½ä½¿ç”¨ on</p><p>ç»“æœä¼šæœ‰ n * n æ¡è®°å½•ï¼ˆç¬›å¡å°”ä¹˜ç§¯ï¼‰</p><p>7. join å†…è¿æ¥</p><p>select * from tableA A inner join tableB B on A.id = B.id</p><p>select * from tableA A inner join tableB B using(id)</p><p>using(å­—æ®µ) å¯ä»¥åˆå¹¶ç›¸åŒå­—æ®µ,å¹¶ä¸”ç¬¦åˆ A.id = B.id</p><p>å†…è¿æ¥åœ¨æ²¡æœ‰æ¡ä»¶æ—¶å’Œäº¤å‰è¿æ¥æ²¡æœ‰åŒºåˆ«ã€‚</p><p>STRAIGHT_JOIN å¯ä»¥æ‰‹åŠ¨æŒ‡å®šé©±åŠ¨è¡¨</p><h1>å…­ ç´¢å¼•çš„åˆ›å»ºã€åˆ é™¤å’ŒæŸ¥çœ‹</h1><p>1. åˆ›å»ºç´¢å¼•</p><p><strong>æ–¹æ³•ä¸€</strong></p><pre>-- æ™®é€šç´¢å¼•ALTER TABLE è¡¨åç§° ADD INDEX index_name (column_list)-- å”¯ä¸€ç´¢å¼•ALTER TABLE è¡¨åç§° ADD UNIQUE (column_list)-- ä¸»é”®ç´¢å¼•ALTER TABLE è¡¨åç§° ADD PRIMARY KEY (column_list)</pre><p><strong>æ–¹æ³•äºŒ</strong></p><pre>CREATE INDEX index_name ON è¡¨åç§° (column_list)CREATE UNIQUE INDEX index_name ON è¡¨åç§° (column_list)</pre><p>column_list æŒ‡å‡ºå¯¹å“ªäº›åˆ—è¿›è¡Œç´¢å¼•ï¼Œå¤šåˆ—æ—¶å„åˆ—ä¹‹é—´ç”¨é€—å·åˆ†éš”ã€‚</p><p>ç´¢å¼•åindex_nameå¯é€‰ï¼Œç¼ºçœæ—¶ï¼ŒMySQLå°†æ ¹æ®ç¬¬ä¸€ä¸ªç´¢å¼•åˆ—èµ‹ä¸€ä¸ªåç§°ã€‚</p><p>å¦å¤–ï¼ŒALTER TABLEå…è®¸åœ¨å•ä¸ªè¯­å¥ä¸­æ›´æ”¹å¤šä¸ªè¡¨ï¼Œå› æ­¤å¯ä»¥åœ¨åŒæ—¶åˆ›å»ºå¤šä¸ªç´¢å¼•ã€‚</p><p>2. åˆ é™¤ç´¢å¼•</p><pre>-- åˆ é™¤ç´¢å¼•DROP INDEX index_name ON è¡¨åç§°;ALTER TABLE è¡¨åç§° DROP INDEX index_name;-- åˆ é™¤ä¸»é”®ALTER TABLE è¡¨åç§° DROP PRIMARY KEY;</pre><p>3. æŸ¥çœ‹ç´¢å¼•</p><pre>show index from è¡¨åç§°;show keys from è¡¨åç§°;</pre><p>4. æ‰‹åŠ¨é€‰æ‹©ç´¢å¼•</p><ul><li>USE INDEX : å‘ä¼˜åŒ–å™¨æç¤ºå¦‚ä½•é€‰æ‹©ç´¢å¼•</li><li>IGNORE INDEX : å¿½ç•¥ç´¢å¼•</li><li>FORCE INDEX : å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•</li></ul><pre>select * from tableA USE INDEX (key1, key2) where key1=1 and key2=2</pre><h1>ä¸ƒ å¤–é”®</h1><p>1. å¢åŠ å¤–é”®</p><p>å»ºè¡¨æ—¶</p><p>constraint å¤–é”®å foreign key(å¤–é”®å­—æ®µ) references å…³è”è¡¨å(å…³è”å­—æ®µ);</p><p>ä¿®æ”¹è¡¨</p><p>alter table è¡¨å add constraint å¤–é”®å foreign key(å¤–é”®å­—æ®µå) references å¤–è¡¨è¡¨å(å¯¹åº”çš„è¡¨çš„ä¸»é”®å­—æ®µå);</p><p>2. åˆ é™¤å¤–é”®</p><p>ALTER TABLE table-name DROP FOREIGN KEY key-id;</p><h1>å…« æµç¨‹æ§åˆ¶&å‡½æ•°</h1><p>1 å†…ç½®å‡½æ•°&æ–¹æ³•</p><p>1.1 if</p><p>IF(expr1,expr2,expr3)</p><p>å¦‚æœ expr1 æ˜¯TRUE (expr1 &lt;> 0 and expr1 &lt;> NULL)ï¼Œåˆ™ IF()çš„è¿”å›å€¼ä¸ºexpr2; å¦åˆ™è¿”å›å€¼åˆ™ä¸º expr3ã€‚</p><p>1.2 CASE when</p><p>SELECT CASE 1 WHEN 1 THEN 'one' WHEN 2 THEN 'two' ELSE 'more' END as testCol</p><p>1.3 IFNULL</p><p>IFNULL(expr1,expr2)</p><p>å‡å¦‚expr1 ä¸ä¸º NULLï¼Œåˆ™ IFNULL() çš„è¿”å›å€¼ä¸º expr1; å¦åˆ™å…¶è¿”å›å€¼ä¸º expr2ã€‚</p><p>2 è‡ªå®šä¹‰å­˜å‚¨è¿‡ç¨‹&å‡½æ•°</p><p>2.1 æŸ¥çœ‹</p><p>æŸ¥è¯¢æ•°æ®åº“ä¸­çš„å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°</p><pre>- å­˜å‚¨è¿‡ç¨‹show procedure status;select `name` from mysql.proc where db = '&lt;dbname&gt;' and `type` = 'PROCEDURE';-- å‡½æ•°show function status;select `name` from mysql.proc where db = '&lt;dbname&gt;' and `type` = 'FUNCTION'</pre><p>æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°çš„åˆ›å»ºä»£ç </p><pre>show create procedure &lt;proc_name&gt;;show create function &lt;func_name&gt;;</pre><h1>ä¹ è§†å›¾</h1><p>1. åˆ›å»º</p><p>create or replace view &lt;è§†å›¾å>(&lt;åˆ—å 1>,&lt;åˆ—å 2>...) as &lt;select è¯­å¥>;</p><p>2. åˆ é™¤</p><p>drop view &lt;è§†å›¾ 1> [ï¼Œè§†å›¾ 2....è§†å›¾ n];</p><h1>å è§¦å‘å™¨</h1><pre>trigger_time: { BEFORE | AFTER } -- äº‹ä»¶ä¹‹å‰è¿˜æ˜¯ä¹‹åè§¦å‘trigger_event: { INSERT | UPDATE | DELETE } -- ä¸‰ä¸ªç±»å‹trigger_order: { FOLLOWS | PRECEDES } other_trigger_name</pre><p>å‡è®¾å®šä¹‰ä¸€ä¸ªè§¦å‘å™¨ï¼Œæ¯æ¬¡æ’å…¥æŠŠ ctime è®¾ä¸ºå½“å‰æ—¶é—´</p><pre>delimiter // -- æ›´æ”¹ç»“æŸç¬¦create trigger &lt;è§¦å‘å™¨åå­—&gt;before insert on &lt;è¡¨å&gt;for each rowbeginset new.ctime=now();end;//delimiter ;</pre><p>å‡è®¾å®šä¹‰ä¸€ä¸ªè§¦å‘å™¨ï¼Œæ¯æ¬¡æ›´æ–°æŠŠ mtime è®¾ä¸ºå½“å‰æ—¶é—´</p><pre>delimiter // -- æ›´æ”¹ç»“æŸç¬¦create trigger &lt;è§¦å‘å™¨åå­—&gt;before update on &lt;è¡¨å&gt;for each rowbeginset new.mtime=now();end;//delimiter ;</pre><h1>åä¸€ æŸ¥çœ‹çŠ¶æ€</h1><pre># æŸ¥çœ‹çŠ¶æ€status;show status;# innodb çŠ¶æ€show innodb status;# æŸ¥çœ‹å‚æ•°show variables like '%å‚æ•°åç§°%';# æŸ¥çœ‹éš”ç¦»çº§åˆ«select @@tx_isolation;+-----------------+| @@tx_isolation |+-----------------+| REPEATABLE-READ |+-----------------+</pre><h1>åäºŒ å¯¼å‡ºå¯¼å…¥</h1><p>1. å¯¼å‡ºåˆ°æ–‡ä»¶</p><pre>select * into outfile æ–‡ä»¶åœ°å€ [æ§åˆ¶æ ¼å¼] form tableA;</pre><p><strong>å¯¼å‡ºåˆ° csvï¼Œå¹¶å‹ç¼©</strong></p><pre>shell&gt; mysql -B -uè´¦å· -p -e "SELECTè¯­å¥" | sed "s/'/\'/;s/\t/\",\"/g;s/^/\"/;s/$/\"/;s/\n//g" | gzip &gt;data.csv.gz</pre><p>æ§åˆ¶æ ¼å¼åŒå¯¼å…¥æ–‡ä»¶</p><p>2. å¯¼å…¥æ–‡ä»¶</p><pre>load data infile æ–‡ä»¶å [replace|ignore] into table è¡¨å [æ§åˆ¶æ ¼å¼]</pre><ul><li>replace å’Œ ignore: è¡¨ç¤ºå¯¹ä¸»é”®é‡å¤çš„æ•°æ®å¤„ç†æ–¹å¼</li><li>æ§åˆ¶æ ¼å¼ fields terminated by '\t' enclosed by '' escaped by '\\'</li></ul><p>e.g.</p><pre>SELECT * INTO OUTFILE '/tmp/data.txt' FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'LINES TERMINATED BY '\n'FROM tableA;</pre><h1>åä¸‰ ç»Ÿè®¡è¯­å¥</h1><p>1. è®¡ç®—æœ€å¤§å¯èƒ½ä½¿ç”¨å†…å­˜</p><p><strong>MySQL >= 8</strong></p><pre>select(@@key_buffer_size + @@query_cache_size + @@tmp_table_size+ @@innodb_buffer_pool_size +@@innodb_additional_mem_pool_size+ @@innodb_log_buffer_size+ @@max_connections * (@@read_buffer_size + @@read_rnd_buffer_size+ @@sort_buffer_size+ @@join_buffer_size+ @@binlog_cache_size + @@thread_stack))/1024/1024/1024 as max_mem_G;</pre><p><strong>MySQL &lt; 8</strong></p><pre>select(@@key_buffer_size + @@query_cache_size + @@tmp_table_size+ @@innodb_buffer_pool_size+ @@innodb_log_buffer_size+ @@max_connections * (@@read_buffer_size + @@read_rnd_buffer_size+ @@sort_buffer_size+ @@join_buffer_size+ @@binlog_cache_size + @@thread_stack))/1024/1024/1024 as max_mem_G;</pre><p>2. æ•°æ®å¤§å°</p><p><strong>æ•°æ®æ€»å¤§å°</strong></p><pre>SELECT ROUND(SUM(DATA_LENGTH)/1024/1024/1024,2) asdata_size_G,ROUND(SUM(INDEX_LENGTH)/1024/1024/1024,2) as index_G,ROUND(SUM(DATA_LENGTH+INDEX_LENGTH)/1024/1024/1024,2) as total_size_G,SUM(TABLE_ROWS) as rows FROMinformation_schema.TABLES;</pre><p><strong>æŸä¸ªåº“å¤§å°</strong></p><pre>SELECT ROUND(SUM(DATA_LENGTH)/1024/1024/1024,2) asdata_size_G,ROUND(SUM(INDEX_LENGTH)/1024/1024/1024,2) as index_G,ROUND(SUM(DATA_LENGTH+INDEX_LENGTH)/1024/1024/1024,2) as total_size_G,SUM(TABLE_ROWS) as rows FROMinformation_schema.TABLES WHERE TABLE_SCHEMA='åº“å';</pre><p><strong>ç»Ÿè®¡æ‰€æœ‰åº“æŒ‰å¤§å°æ’åº</strong></p><pre>SELECT TABLE_SCHEMA, ROUND(SUM(DATA_LENGTH)/1024/1024/1024,2) asdata_size_G,ROUND(SUM(INDEX_LENGTH)/1024/1024/1024,2) as index_G,ROUND(SUM(DATA_LENGTH+INDEX_LENGTH)/1024/1024/1024,2) as total_size_G,SUM(TABLE_ROWS) as rows FROMinformation_schema.TABLES group by TABLE_SCHEMA order by data_size_G desc;</pre><p>3. ç»Ÿè®¡è¿æ¥IP</p><pre>select SUBSTRING_INDEX(host,':',1) as ip , count(*) from information_schema.processlist group by ip;</pre><p>4. æŸ¥çœ‹é”</p><p><strong>mysql5.6</strong></p><pre>SELECT r.trx_id waiting_trx_id, r.trx_mysql_thread_id waiting_thread, r.trx_query waiting_query, b.trx_id blocking_trx_id, b.trx_mysql_thread_id blocking_thread, b.trx_query blocking_queryFROM information_schema.innodb_lock_waits wINNER JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_trx_idINNER JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_trx_id;waiting_trx_id -- è¯·æ±‚çš„äº‹ç‰©IDwaiting_thread -- è¯·æ±‚çš„çº¿ç¨‹IDwaiting_query -- ç­‰å¾…çš„SQLè¯­å¥blocking_trx_id -- é˜»å¡ä¸Šé¢è¯·æ±‚çš„äº‹ç‰©çš„IDblocking_thread -- é˜»å¡çš„çº¿ç¨‹IDblocking_query -- é˜»å¡çš„å½“å‰çš„SQLï¼Œè¿™ä¸ªæ˜¯æ— æ³•çœ‹åˆ°çš„ï¼Œé™¤éSQLè¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼ˆä¸ä¸€å®šæ˜¯è¯¥äº‹ç‰©å½“ä¸­çš„æœ€åä¸€æ¡SQLè¯­å¥ï¼‰</pre><p><strong>mysql5.7</strong></p><pre>select * from sys.innodb_lock_waits;</pre><p>5. æŸ¥çœ‹æ²¡æœ‰ä¸»é”®çš„è¡¨</p><pre>SELECT table_schema, table_nameFROM information_schema.TABLES WHERE table_name NOT IN ( SELECT DISTINCT TABLE_NAME FROM information_schema.COLUMNS WHERE COLUMN_KEY = 'PRI') AND table_schema NOT IN ('mysql' , 'information_schema','sys', 'performance_schema');</pre><p>6. ç´¢å¼•åˆç†æ€§</p><pre>SELECT t.TABLE_SCHEMA,t.TABLE_NAME,INDEX_NAME, CARDINALITY, TABLE_ROWS, CARDINALITY/TABLE_ROWS AS SELECTIVITYFROM information_schema.TABLES t, ( SELECT table_schema, table_name, index_name, cardinality FROM information_schema.STATISTICS WHERE (table_schema,table_name,index_name,seq_in_index) IN ( SELECT table_schema, table_name, index_name, MAX(seq_in_index) FROM information_schema.STATISTICS GROUP BY table_schema , table_name , index_name ) ) sWHERE t.table_schema = s.table_schema AND t.table_name = s.table_name  AND t.table_schema = 'æ•°æ®åº“å' -- æŒ‡å®šæŸä¸€ä¸ªåº“åORDER BY SELECTIVITY;</pre><ul><li>SELECTIVITYè¶Šæ¥è¿‘1ï¼Œè¶Šåˆç†</li><li>å› ä¸ºèšåˆç´¢å¼•ä¼šåœ¨ statistics è¡¨ä¸­äº§ç”Ÿå¤šæ¡æ•°æ®ï¼Œæ‰€ä»¥ MAX(seq_in_index) å¯ä»¥æ‹¿åˆ°å®Œæ•´ç´¢å¼•é‚£æ¡</li></ul><p>7. ç»Ÿè®¡processlistå„ä¸ªçŠ¶æ€æ•°é‡</p><pre>shell&gt; mysql -uroot -p&lt;password&gt; -e 'show processlist \G' | grep 'State:' | sort | uniq -c | sort -rn</pre><h1>åå›› è¿ç»´è¯­å¥&å‘½ä»¤</h1><p>1. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯</p><pre>analyze table &lt;table_name&gt;;</pre><p>2. é‡æ–°æ•´ç†è¡¨</p><pre>optimize table &lt;table_name&gt;;</pre><p>3. æ£€æŸ¥è¡¨(MyISAM)</p><pre>check table &lt;table_name&gt;;</pre><p>4. ä¿®å¤è¡¨(MyISAM)</p><pre>repair table &lt;table_name&gt;;</pre><p>5. æ‰¹é‡æ£€æŸ¥æˆ–ä¿®å¤è¡¨</p><pre># æ£€æŸ¥æ‰€æœ‰è¡¨shell&gt; mysqlcheck -u root -p&lt;password&gt; -A -c # ä¿®å¤æ‰€æœ‰è¡¨shell&gt; mysqlcheck -u root -p&lt;password&gt; -A -c </pre><p>6. ç»Ÿè®¡æ¯ç§’æ…¢æ—¥å¿—</p><pre>shell&gt; awk '/^# Time:/{print $3, $4, c;c=0}/^# User/{c++}' slowquery.log</pre><p>7. æŸ¥çœ‹binlogæ—¥å¿—</p><p><strong>åŸºäºposition</strong></p><pre>mysqlbinlog --no-defaults -v -v --base64-output=DECODE-ROWS --start-position=&lt;start_pos&gt; --stop-position=&lt;stop_pos&gt; &lt;mysql binlogæ–‡ä»¶&gt; &gt; result.sql</pre><p><strong>åŸºäºæ—¶é—´ç‚¹</strong></p><pre>mysqlbinlog --no-defaults -v -v --base64-output=DECODE-ROWS --start-datetime='&lt;å¼€å§‹æ—¶é—´&gt;' --stop-datetime='&lt;ç»“æŸæ—¶é—´&gt;' &lt;mysql binlogæ–‡ä»¶&gt; &gt; result.sql</pre><p><strong>æŸ¥çœ‹æŸä¸ªposçš„æ—¥å¿—</strong></p><pre>mysqlbinlog --no-defaults -v -v --base64-output=DECODE-ROWS &lt;mysql binlogæ–‡ä»¶&gt; | grep -A '20' &lt;pos&gt;</pre><p>8. æ‰“å¼€å¥æŸ„æ•°</p><p><strong>ç»Ÿè®¡å„è¿›ç¨‹æ‰“å¼€å¥æŸ„æ•°ï¼š</strong></p><pre>lsof -n|awk '{print $2}'|sort|uniq -c|sort -nr | head -n 10# æŸä¸ªè¿›ç¨‹lsof -n|awk '$2=="&lt;æŸä¸ªè¿›ç¨‹çš„PID&gt;" {print $2}'|sort|uniq -c|sort -nr | head -n 10</pre><p><strong>ç»Ÿè®¡å„ç”¨æˆ·æ‰“å¼€å¥æŸ„æ•°</strong></p><pre>lsof -n|awk '{print $3}'|sort|uniq -c|sort -nr# mysqlç”¨æˆ·lsof -n|awk '$3 == "mysql" {print $3}'|sort|uniq -c|sort -nr</pre><p><strong>ç»Ÿè®¡å„å‘½ä»¤æ‰“å¼€å¥æŸ„æ•°</strong></p><pre>lsof -n|awk '{print $1}'|sort|uniq -c|sort -nr</pre><p>9. å¯¼å‡ºç”¨æˆ·æƒé™(shellè„šæœ¬)</p><pre>#/bin/bashuser='username'pass='password'sock='socket'expgrants() {  mysql -B -u"${user}" -p"${pass}" -S"${sock}" -N $@ -e "SELECT CONCAT( 'SHOW CREATE USER ''', user, '''@''', host, ''';' ) AS query FROM mysql.user" | \ mysql -u"${user}" -p"${pass}" -S"${sock}" -f $@ | \ sed 's#$#;#g;s/^\(CREATE USER for .*\)/-- \1 /;/--/{x;p;x;}'   mysql -B -u"${user}" -p"${pass}" -S"${sock}" -N $@ -e "SELECT CONCAT( 'SHOW GRANTS FOR ''', user, '''@''', host, ''';' ) AS query FROM mysql.user" | \ mysql -u"${user}" -p"${pass}" -S"${sock}" -f $@ | \ sed 's/\(GRANT .*\)/\1;/;s/^\(Grants for .*\)/-- \1 /;/--/{x;p;x;}' } </pre><p>ç„¶åæ‰§è¡Œè„šæœ¬</p><p>10. æ‰¹é‡æ€è¿æ¥</p><p><strong>æ–¹æ³•ä¸€</strong></p><pre>select concat('KILL ',id,';') from information_schema.processlist where user='æŸä¸ªç”¨æˆ·' into outfile '/tmp/kill.txt';source /tmp/kill.txt;</pre><p><strong>æ–¹æ³•äºŒ</strong></p><pre>mysqladmin -uroot -p processlist|awk -F "|" '{if($3 == "è¦æ€çš„è¿æ¥çš„ç”¨æˆ·")print $2}'|xargs -n 1mysqladmin -uroot -p kill</pre></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'MySQL','è¯­å¥','å¤§å…¨'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>