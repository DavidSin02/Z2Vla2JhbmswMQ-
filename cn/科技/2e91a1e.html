<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>干货教程！第四章：本地存储和图片缓存 | 极客快訊</title><meta property="og:title" content="干货教程！第四章：本地存储和图片缓存 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/1531103917914e2164f0742"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2e91a1e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2e91a1e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2e91a1e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2e91a1e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2e91a1e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2e91a1e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2e91a1e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2e91a1e.html><meta property="article:published_time" content="2020-10-29T21:08:25+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:25+08:00"><meta name=Keywords content><meta name=description content="干货教程！第四章：本地存储和图片缓存"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/2e91a1e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>干货教程！第四章：本地存储和图片缓存</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><div class=pgc-img><img alt=干货教程！第四章：本地存储和图片缓存 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1531103917914e2164f0742><p class=pgc-img-caption></p></div><p>上期APICloud和大家分享了《30天，App开发从0到1》一书中，数据云的用途和特点的相关知识，相信小伙伴们也有了一些收获。这次，小编又带着精彩内容来和大家见面了（请为无私奉献的小编点赞！）</p><p>在第三章中介绍了 APICloud 和后端交互的机制，并将商品列表根据数据进行了显示。本章将学习doT 模板引擎的基本使用、本地存储和图片缓存的使用、以及下拉刷新、上拉加载的实现。</p><p><strong>● 学习目标</strong></p><p>(1)学习 doT 模板引擎的使用。</p><p>(2)学习本地存储和图片缓存。</p><p>(3)下拉刷新、上拉加载的实现。</p><p>(4)理解 APICloud 应用沙箱结构。</p><p>(5)掌握 APICloud 资源访问协议使用。</p><p>(6)学习常用对话窗口的使用。</p><p>(7)学习窗口间的通信机制。</p><p>(8)学习 APICloud 平台的事件机制。</p><p>本期，APICloud和大家重点分享的是第二节：</p><p><strong>本地存储和图片缓存</strong></p><p>数据的本地存储和图片缓存可以极大地提高 app 的用户体验、提高 UI 响应速度、减少网络使用。</p><p><strong>1．uzStorage</strong></p><p>APICloud 提供了 uzStorage来提供类似 localStorage 的功能，但是比 localStorage 更适合混合app 开发。uzStorage 比标准的localStorage 更安全易用。</p><p>举个栗子： localStorage 有大小限制、异步会导致一些安全、不能存储对象等问题，但这些问题均在 uzStorage 中得到了解决。通过下面的 API 控制 uzStorage :</p><p>$api.getStorage("key"); 获取数据 $api.setStorage("key","value");存储数据 $api.rmStorage("key"); 移除保存的数据 $api.clearStorage(); 清空本地存储</p><p><strong>2．偏好设置</strong></p><p>APICloud 提供了针对系统原生偏好设置操作的 API(如 Android 的 preference 和 iOS 的 plist)，使用键值对的方式存储。</p><p><strong>3．文件</strong></p><p>APICloud 提供了标准的文件操作接口，支持同步和异步的调用方式。使用下面的 API 操作文件:</p><p>api.readFile({sync:false,//是否同步，默认 falsepath:"PathToFile"// 文件路径，支持绝对路径和文件路径协议如 fs://、widget:// 等</p><p>}, function(ret,err){</p><p>//ret = {status:true,data:""}</p><p>}); //err = {code:0,msg:""}</p><p>api.writeFile({path:"PathToFile",//文件路径，支持绝对路径和文件路径协议如 fs://、cache:// 等，不支持 widget:// 目录，</p><p>该目录只读data:"data",// 文件内容</p><p>append:false// 是否以追加方式写入数据，默认 false，会清除之前文件内容 }, function(ret,err){</p><p>//ret = {status:true}</p><p>}); //err = {code:0,msg:""}</p><p>如果想获得更多对文件操作的能力请使用“fs”模块:</p><p>var fs = api.require('fs');</p><p>// 创建文件 fs.createFile({</p><p>path:'path/to/file'//文件路径 },function(ret,err){})//ret ={status: true} 是否成功</p><p>// 删除文件 fs.remove({</p><p>path:'path/to/file'//文件路径 },function(ret,err){})//ret ={status: true} 是否成功</p><p>// 获取文件数据的 MD5 值 fs.getMD5({</p><p>path:'path/to/file'//文件路径 },function(req,err){</p><p>//req = {// status:true,是否成功// md5Str:'' 文件数据的MD5值</p><p>}) //}</p><p>“fs”模块还提供了很多操作文件和目录的方法，请参阅相关文档。</p><p><strong>4. database</strong></p><p>使用“db”模块操作数据库，“db”模块封装了手机常用数据库 sqlite 的增删改查语句，可实现数据的本地存储，极大地简化了数据持久化问题，并且支持同步接口。“db”模块的使用如下:</p><p>var db = api.require('db');</p><p>// 打开数据库，若不存在则创建新的数据库 db.openDatabase({</p><p>name: 'name'， //数据库名称</p><p>path:'path' // 数据库所在路径，不传时使用默认创建的路径，可选}, function(ret,err) {</p><p>//ret ={status:true} 是否创建成功 });</p><p>// 关闭数据库 db.closeDatabase({</p><p>name: 'name'//数据库名称 }, function(ret, err) {</p><p>//ret = {//status:true 是否成功</p><p>}); //}</p><p>//执行SQL语句 db.executeSql({</p><p>name: 'name',//数据库名称</p><p>sql: 'CREATE TABLEPersons(Id_P int, LastName varchar(255), FirstName varchar(255), A ddressvarchar(255), City varchar(255))'//要执行的SQL语句</p><p>}, function(ret,err) {//ret = {status:true} 是否执行成功</p><p>});</p><p>// 查询 SQL db.selectSql({</p><p>name: 'name',//数据库名称</p><p>sql: 'SELECT *FROM Persons'//查询SQL字符串 }, function(ret, err) {</p><p>//ret = {//status:true, 是否执行成功// data:[] 查询到的数据</p><p>}); //}</p><p><strong>5. 存储容量</strong></p><p>APICloud 提供了关于存储容量的 API，代码如下:</p><p>api.getFreeDiskSpace({sync:false//执行结果的返回方式。为 false 时通过 callback 返回，为 true 时直接返回，默认false</p><p>},function(ret,err){//ret = {size:1024} 剩余存储空间大小，单位为Byte，数字类型。(-1:无存储设备、-2:正在准备USB存</p><p>储设备、-3 :无法访问存储设备) });</p><p>api.getTotalSpace({sync:false//执行结果的返回方式。为false时通过callback返回，为true时直接返回，默认false</p><p>},function(ret,err){//ret = {size:1024} 总存储空间大小，单位为Byte，数字类型。(-1:无存储设备、-2:正在准备USB存储设备、-3 :无法访问存储设备) });</p><p>api.getCacheSize({sync:false//执行结果的返回方式。为 false 时通过 callback 返回，为 true 时直接返回，默认false},function(ret,err){//ret = {size} 缓存大小，单位为Byte，数字类型。(-1:无存储设备、-2:正在准备USB存储设备、-3:无法访问存储设备)});</p><p>api.clearCache({timeThreshold:10//(可选项)清除多少天前的缓存，默认 0</p><p>},function(ret,err){ }); //清除完成</p><p><strong>6. 沙箱机制</strong></p><p>在 Android 和 iOS 中均采用虚拟沙箱的机制来保障数据存储的安全和独立，app 只能访问自己文件系统的沙箱区域。沙箱位置如下：</p><p>• Android 的默认沙箱位置:sdcard/UZMap/appId。</p><p>• iOS 的默认沙箱位置:Documents/uzfs/appId。</p><p>可以通过修改 config.xml 中的 sandbox 属性来指定 Android 沙箱位置: &lt;widget id="A1234567890123", sandbox="myBox"> 通过以上配置，app 将在 Android 手机的外部存储(如 SD 卡)的根目录中建立名为“myBox” 的目录，并以该目录作为本 app 的沙箱目录，app 运行过程中动态产生的资源文件将存储在该目录及其子目录下，并且这些资源不会随着 app 的卸载而清除。</p><p><strong>7．资源访问协议</strong></p><p>APICloud 资源被存放在 app 安装包(ipa 包或者 apk 包)中或应用沙箱中。沙箱分为 APICloud 应用虚拟沙箱和 Native 应用真实沙箱，真实沙箱是操作系统为 app 在设备内部存储上分配的空间，不可见，只允许 app 本身访问。访问这些位置的资源可以使用如下协议:</p><p>• widget://(访问安装包中的资源，根目录指向你的项目代码根路径，即 widget路径。只读属性);</p><p>•fs:/(/访问APICloud应用虚拟沙箱中资源，可读可写);</p><p>•cache://(访问本地缓存中的资源，存储在该路径下的资源，在调用 api.clearCache 时将 被清除。可读可写);</p><p>•box://(访问应用真实沙箱中的资源，私密数据建议使用本协议操作。可读可写)。 相关路径可以通过如下代码获取:</p><p>api.wgtDir(返回 widget 包根路径);</p><p>api.fsDir(返回 APICloud 应用虚拟沙箱根路径);</p><p>api.cacheDir(返回缓存根路径);</p><p>api.boxDir(返回应用真实沙箱根路径)。</p><p><strong>8. 图片缓存</strong></p><p>对于图片缓存，可使用如下代码:</p><p>var img = $api.byId("myImg");</p><p>api.imageCache({</p><p>url:'http://example.com/dir/file.png'</p><p>},function(ret,err){</p><p>if(ret && ret.status == true){</p><p>} img.src = ret.url;</p><p>else{} //处理错误 });</p><p>上述代码首先在参数中指定了要缓存的远程图片路径(url)，在之后的回调函数中判断是否缓存成功(if(ret && ret.status == true){})，如果成功就可以使用 ret.url 来更新 &lt;img> 标签。ret.url 是图片缓存到本地后的路径。</p><p>这里实现了图片缓存，app 在第一次从指定位置加载图片后会缓存到本地存储上面，下次使用时会直接调用缓存，以此提升加载速度和渲染效率。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'干货','存储','图片'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>