<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>字节跳动8年架构师Nginx调优笔记分享 | 极客快訊</title><meta property="og:title" content="字节跳动8年架构师Nginx调优笔记分享 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/01ec564547454e7dbcf824328664f864"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3218c2ea.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3218c2ea.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3218c2ea.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3218c2ea.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3218c2ea.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3218c2ea.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3218c2ea.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3218c2ea.html><meta property="article:published_time" content="2020-11-14T21:01:36+08:00"><meta property="article:modified_time" content="2020-11-14T21:01:36+08:00"><meta name=Keywords content><meta name=description content="字节跳动8年架构师Nginx调优笔记分享"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/3218c2ea.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>字节跳动8年架构师Nginx调优笔记分享</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><blockquote class=pgc-blockquote-abstract><p>点关注，不迷路！如果本文对你有帮助的话不要忘记点赞支持哦！</p></blockquote><p>大多数的Nginx安装指南告诉你如下基础知识——通过apt-get安装，修改这里或那里的几行配置，好了，你已经有了一个Web服务器了。而且，在大多数情况下，一个常规安装的nginx对你的网站来说已经能很好地工作了。然而，如果你真的想挤压出Nginx的性能，你必须更深入一些。在本指南中，我将解释Nginx的那些设置可以微调，以优化处理大量客户端时的性能。需要注意一点，这不是一个全面的微调指南。这是一个简单的预览——那些可以通过微调来提高性能设置的概述。你的情况可能不同。</p><h1 class=pgc-h-arrow-right>基本的 (优化过的)配置</h1><p>我们将修改的唯一文件是nginx.conf，其中包含Nginx不同模块的所有设置。你应该能够在服务器的/etc/nginx目录中找到nginx.conf。首先，我们将谈论一些全局设置，然后按文件中的模块挨个来，谈一下哪些设置能够让你在大量客户端访问时拥有良好的性能，为什么它们会提高性能。本文的结尾有一个完整的配置文件。</p><h1 class=pgc-h-arrow-right>高层的配置</h1><p>nginx.conf文件中，Nginx中有少数的几个高级配置在模块部分之上。</p><p>user www-data;</p><p>pid /var/run/nginx.pid;</p><p><strong>worker_processes auto;</strong></p><p><strong>worker_rlimit_nofile 100000;</strong></p><p>user和pid应该按默认设置 - 我们不会更改这些内容，因为更改与否没有什么不同。</p><p><strong>worker_processes</strong> 定义了nginx对外提供web服务时的worker进程数。最优值取决于许多因素，包括（但不限于）CPU核的数量、存储数据的硬盘数量及负载模式。不能确定的时候，将其设置为可用的CPU内核数将是一个好的开始（设置为“auto”将尝试自动检测它）。</p><p><strong>worker_rlimit_nofile </strong>更改worker进程的最大打开文件数限制。如果没设置的话，这个值为操作系统的限制。设置后你的操作系统和Nginx可以处理比“ulimit -a”更多的文件，所以把这个值设高，这样nginx就不会有“too many open files”问题了。</p><h1 class=pgc-h-arrow-right>Events模块</h1><p>events模块中包含nginx中所有处理连接的设置。</p><p>events {</p><p><strong>worker_connections 2048;</strong></p><p>multi_accept on;</p><p><strong>use epoll;</strong></p><p>}</p><p><strong>worker_connections </strong>设置可由一个worker进程同时打开的最大连接数。如果设置了上面提到的worker_rlimit_nofile，我们可以将这个值设得很高。</p><p>记住，最大客户数也由系统的可用socket连接数限制（~ 64K），所以设置不切实际的高没什么好处。</p><p><strong>multi_accept </strong>告诉nginx收到一个新连接通知后接受尽可能多的连接。</p><p><strong>use </strong>设置用于复用客户端线程的轮询方法。如果你使用Linux 2.6+，你应该使用epoll。如果你使用*BSD，你应该使用kqueue。</p><p>（值得注意的是如果你不知道Nginx该使用哪种轮询方法的话，它会选择一个最适合你操作系统的）</p><h1 class=pgc-h-arrow-right>HTTP 模块</h1><p>HTTP模块控制着nginx http处理的所有核心特性。因为这里只有很少的配置，所以我们只节选配置的一小部分。所有这些设置都应该在http模块中，甚至你不会特别的注意到这段设置。</p><p>http {</p><p>server_tokens off;</p><p>sendfile on;</p><p>tcp_nopush on;</p><p>tcp_nodelay on;</p><p>...</p><p>}</p><p><strong>server_tokens </strong>并不会让nginx执行的速度更快，但它可以关闭在错误页面中的nginx版本数字，这样对于安全性是有好处的。</p><p><strong>sendfile </strong>可以让sendfile()发挥作用。sendfile()可以在磁盘和TCP socket之间互相拷贝数据(或任意两个文件描述符)。Pre-sendfile是传送数据之前在用户空间申请数据缓冲区。之后用read()将数据从文件拷贝到这个缓冲区，write()将缓冲区数据写入网络。sendfile()是立即将数据从磁盘读到OS缓存。因为这种拷贝是在内核完成的，sendfile()要比组合read()和write()以及打开关闭丢弃缓冲更加有效(更多有关于sendfile)。</p><p><strong>tcp_nopush </strong>告诉nginx在一个数据包里发送所有头文件，而不一个接一个的发送。</p><p><strong>tcp_nodelay </strong>告诉nginx不要缓存数据，而是一段一段的发送--当需要及时发送数据时，就应该给应用设置这个属性，这样发送一小块数据信息时就不能立即得到返回值。</p><p>access_log off;</p><p>error_log /var/log/nginx/error.log crit;</p><p><strong>access_log </strong>设置nginx是否将存储访问日志。关闭这个选项可以让读取磁盘IO操作更快(aka,YOLO)</p><p><strong>error_log </strong>告诉nginx只能记录严重的错误：</p><p>keepalive_timeout 10;</p><p>client_header_timeout 10;</p><p>client_body_timeout 10;</p><p>reset_timedout_connection on;</p><p>send_timeout 10;</p><p><strong>keepalive_timeout</strong> 给客户端分配keep-alive链接超时时间。服务器将在这个超时时间过后关闭链接。我们将它设置低些可以让ngnix持续工作的时间更长。</p><p><strong>client_header_timeout 和client_body_timeout </strong>设置请求头和请求体(各自)的超时时间。我们也可以把这个设置低些。</p><p><strong>reset_timeout_connection </strong>告诉nginx关闭不响应的客户端连接。这将会释放那个客户端所占有的内存空间。</p><p>se<strong>nd_timeout </strong>指定客户端的响应超时时间。这个设置不会用于整个转发器，而是在两次客户端读取操作之间。如果在这段时间内，客户端没有读取任何数据，nginx就会关闭连接。</p><p>limit_conn_zone $binary_remote_addr zone=addr:5m;</p><p>limit_conn addr 100;</p><p><strong>limit_conn_zone </strong>设置用于保存各种key（比如当前连接数）的共享内存的参数。5m就是5兆字节，这个值应该被设置的足够大以存储（32K*5）32byte状态或者（16K*5）64byte状态。</p><p><strong>limit_conn </strong>为给定的key设置最大连接数。这里key是addr，我们设置的值是100，也就是说我们允许每一个IP地址最多同时打开有100个连接。</p><p>include /etc/nginx/mime.types;</p><p>default_type text/html;</p><p>charset UTF-8;</p><p><strong>include</strong> 只是一个在当前文件中包含另一个文件内容的指令。这里我们使用它来加载稍后会用到的一系列的MIME类型。</p><p><strong>default_type </strong>设置文件使用的默认的MIME-type。</p><p><strong>charset </strong>设置我们的头文件中的默认的字符集</p><p>gzip on;</p><p>gzip_disable "msie6";</p><p># gzip_static on;</p><p>gzip_proxied any;</p><p>gzip_min_length 1000;</p><p>gzip_comp_level 4;</p><p>gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</p><p><strong>gzip </strong>是告诉nginx采用gzip压缩的形式发送数据。这将会减少我们发送的数据量。</p><p><strong>gzip_disable </strong>为指定的客户端禁用gzip功能。我们设置成IE6或者更低版本以使我们的方案能够广泛兼容。</p><p><strong>gzip_static</strong> 告诉nginx在压缩资源之前，先查找是否有预先gzip处理过的资源。这要求你预先压缩你的文件（在这个例子中被注释掉了），从而允许你使用最高压缩比，这样nginx就不用再压缩这些文件了（想要更详尽的gzip_static的信息，请点击这里）。</p><p><strong>gzip_proxied </strong>允许或者禁止压缩基于请求和响应的响应流。我们设置为any，意味着将会压缩所有的请求。</p><p><strong>gzip_min_length</strong> 设置对数据启用压缩的最少字节数。如果一个请求小于1000字节，我们最好不要压缩它，因为压缩这些小的数据会降低处理此请求的所有进程的速度。</p><p><strong>gzip_comp_level </strong>设置数据的压缩等级。这个等级可以是1-9之间的任意数值，9是最慢但是压缩比最大的。我们设置为4，这是一个比较折中的设置。</p><p><strong>gzip_type </strong>设置需要压缩的数据格式。上面例子中已经有一些了，你也可以再添加更多的格式。</p><p># cache informations about file descriptors, frequently accessed files</p><p># can boost performance, but you need to test those values</p><p>open_file_cachemax=100000 inactive=20s;</p><p>open_file_cache_valid 30s;</p><p>open_file_cache_min_uses 2;</p><p>open_file_cache_errors on;</p><p>##</p><p># Virtual Host Configs</p><p># aka our settings for specific servers</p><p>##</p><p>include /etc/nginx/conf.d/*.conf;</p><p>include /etc/nginx/sites-enabled/*;</p><p><strong>open_file_cache </strong>打开缓存的同时也指定了缓存最大数目，以及缓存的时间。我们可以设置一个相对高的最大时间，这样我们可以在它们不活动超过20秒后清除掉。</p><p><strong>open_file_cache_valid </strong>在open_file_cache中指定检测正确信息的间隔时间。</p><p><strong>open_file_cache_min_uses </strong>定义了open_file_cache中指令参数不活动时间期间里最小的文件数。</p><p><strong>open_file_cache_errors </strong>指定了当搜索一个文件时是否缓存错误信息，也包括再次给配置中添加文件。我们也包括了服务器模块，这些是在不同文件中定义的。如果你的服务器模块不在这些位置，你就得修改这一行来指定正确的位置。</p><h1 class=pgc-h-arrow-right>一个完整的配置</h1><p>user www-data;</p><p>pid /var/run/nginx.pid;</p><p>worker_processes auto;</p><p>worker_rlimit_nofile 100000;</p><p>events {</p><p>worker_connections 2048;</p><p>multi_accept on;</p><p>use epoll;</p><p>}</p><p>http {</p><p>server_tokens off;</p><p>sendfile on;</p><p>tcp_nopush on;</p><p>tcp_nodelay on;</p><p>access_log off;</p><p>error_log /var/log/nginx/error.log crit;</p><p>keepalive_timeout 10;</p><p>client_header_timeout 10;</p><p>client_body_timeout 10;</p><p>reset_timedout_connection on;</p><p>send_timeout 10;</p><p>limit_conn_zone $binary_remote_addrzone=addr:5m;</p><p>limit_conn addr 100;</p><p>include /etc/nginx/mime.types;</p><p>default_type text/html;</p><p>charset UTF-8;</p><p>gzip on;</p><p>gzip_disable "msie6";</p><p>gzip_proxied any;</p><p>gzip_min_length 1000;</p><p>gzip_comp_level 6;</p><p>gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</p><p>open_file_cachemax=100000 inactive=20s;</p><p>open_file_cache_valid 30s;</p><p>open_file_cache_min_uses 2;</p><p>open_file_cache_errors on;</p><p>include /etc/nginx/conf.d/*.conf;</p><p>include /etc/nginx/sites-enabled/*;</p><p>}</p><p>编辑完配置后，确认重启nginx使设置生效。</p><p><br></p><p>下面这描述也是非常好的：http://blog.csdn.net/xyang81/article/details/51814787</p><p>Nginx的配置是以模块为单位来组织的，每一个模块包含一个或多个指令，指令是配置文件中的最小配置单元，一切配置项皆为指令。如http核心模块中的include、default_type、sendfile指令，都属于http模块。nginx所有模块中的指令见官方文档说明：http://nginx.org/en/docs/dirindex.html</p><p>注意：以下配置中的“上下文”表示指令可以配置在哪些模块中。</p><p>main：顶层配置,约束服务器的行为</p><h1 class=pgc-h-arrow-right>1、服务器级别核心配置</h1><p>指令上下文语法默认值功能描述</p><p>usermainuser nobody nobyd;nobody以哪个用户权限运行工作线程</p><p>daemonmaindaemon yes;yesnginx是否以守护进程运行</p><p>worker_processesmainworker_processes number;1配置工作进程数。传统的web服务器（如apache)都是同步阻塞模型，一请求一进（线）程模式，当进（线）程数增达到一定程度后，更多CPU时间浪费在线程和进程切换当中，性能急剧下降，所以负载率不高。Nginx是基于事件的非阻塞多路复用(epoll或kquene)模型，一个进程在短时间内就可以响应大量的请求。建议将该值设置&lt;=cpu核心数量，一般高于cpu核心数量不会带来好处，反而可能会有进程切换开销的负面影响。</p><p>worker_connectionseventsworker_connections number;1024并发响应能力的关键配置值，表示每个进程允许的最大同时连接数。maxConnection = work_connections * worker_processes；一般一个浏览器会同时开两条连接，如果是反向代理，nginx到后服务器的连接数量也要占用2条连接数，所以，做静态服务器，一般maxConnection = work_connections * worker_processes / 2; 做反代理服务器时maxConnection = work_connections * worker_processes / 4；</p><p>useeventsuse epoll;根据不同的平台，选择最高效的连接处理方法指定处理连接请求的方法。linux内核2.6以上默认使用epoll方法，其它平台请参考：http://nginx.org/en/docs/events.html 备注：要达到超高负载下最好的网络响应能力，还有必要优化与网络相关的linux内核参数</p><p>worker_cpu_affinitymainworker_cpu_affinity cpumask …;无将工作进程绑定到特定的CPU上，减少CPU在进程之间切换的开销。用二进制bit位表示进程绑定在哪个CPU内核。如8内核4进程时的设置方法：worker_cpu_affinity 00000001 00000010 00000100 10000000</p><p>worker_rlimit_nofilemainworker_rlimit_core size;受linux内核文件描述符数量限制设置nginx最大能打开的文件描述符数量。因为Linux对每个进程所能打开的文件描述数量是有限制的，默认一般是1024个，可通过ulimit -n FILECNT或/etc/securit/limits.conf配置修改linux默认能打开的文件句柄数限制。建议值为：系统最大数量/进程数。但进程间工作量并不是平均分配的，所以可以设置在大一些。推荐值为：655350</p><p>error_logmain, http, mail, stream, server, locationerror_log 日志文件路径 日志级别;error_log logs/error.log error;配置错误日志文件的路径和日志级别。日志级别有debug, info, notice, warn, error, crit, alert和emerg几种。nginx的日志使用syslog输出，所以输出的日志格式是有规律的，系统运维人员可以根据日志规则进行查错或统计分析。更多说明请参考官方文档：http://nginx.org/en/docs/ngx_core_module.html#error_log</p><p>pidmainpid 守护进程socket文件路径;pid logs/nginx.pid配置nginx守护进程ID存储文件路径（不是工作进程）</p><p>以上是nginx的顶层配置，管理服务器级别的行为。更多配置请参考官方文档：http://nginx.org/en/docs/ngx_core_module.html#working_directory</p><h1 class=pgc-h-arrow-right>2、HTTP模块核心配置</h1><p>nginx做为一个HTTP反向代理服务器，平时接触得最多的应该是针对http请求的相关配置了，和http模块有关的所有配置都放在http { ... }配置中。</p><p>指令上下文语法功能描述</p><p>typeshttp, server, locationtypes { mime类型 文件后缀；};配置能处理的文件类型。如：text/html html htm shtml;</p><p>includeanyinclude 文件路径;将外部文件的内容做为配置拷贝到nginx.conf文件中。如：include mime.type; 将当前目录下的mime.type配置文件拷贝到nginx配置文件中。文件路径可以是相对路径或绝对路径。文件名可以用*来表示通配符。</p><p>default_typehttp, server, locationdefault_type mime类型;文件名到后缀的映射关系。配置默认的mime类型，当在types指令中找不到请求的文件类型时，就使用default_type指定的类型。默认为text/plain类型。</p><p>access_loghttp, server, location, if in location, limit_exceptaccess_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];</p><p>access_log off;</p><p>关闭或开启访问日志。默认配置为：access_log logs/access.log combined; 表示根据combined定义的日志格式，写入logs/access.log文件中，combined是http模块默认格式。如果定义了buffer和gzip其中一个参数，日志默认会先写入缓存中，当缓存满了之后，通过gzip压缩缓存中的日志并写入文件，启用了gzip压缩必须保证nginx安装的时候添加了gzip模块。缓存大小默认为64K。可以配置gzip的1～9的压缩级别，级别越高压缩效率越大，日志文件占用的空间越小，但要求系统性能也越高。默认值是1。http://nginx.org/en/docs/http/ngx_http_log_module.html#access_log</p><p>log_formathttplog_format 格式名称 日志格式；定义http访问日志的格式，在日志格式中可以访问http模块的内嵌变量，如果变存在的话，会做为日志输出。如：remoteaddr，request等，更多变量请参考：http://nginx.org/en/docs/http/ngx_http_core_module.html#variables</p><p>sendfilehttp, server, location, if in locationsendfile on | off;启用内核复制模式。作为静态服务器可以提高最大的IO访问速度。传统的文件读写采用read和write方式，流程为：硬盘 >> kernel buffer >> user buffer>> kernel socket buffer >>协议栈，采用sendfile文件读写的流程为：硬盘 >> kernel buffer (快速拷贝到kernelsocket buffer) >>协议栈，很明显sendfile这个系统调用减少了内核到用户模式之间的切换和数据拷贝次数，直接从内核缓存的数据拷贝到协议栈，提高了很大的效率。这篇文章介绍比较详细：http://xiaorui.cc/?p=1673</p><p>tcp_nodelayhttp, server, locationoff|on;</p><p>tcp_nopushhttp, server, locationoff|on;tcp_nodelay和tcp_nopush这两个参数是配合使用的，启动这两项配置，会在数据包达到一定大小后再发送数据。这样会减少网络通信次数，降低阻塞概率，但也会影响响应及时性。比较适合于文件下载这类的大数据通信场景。</p><p>keepalive_timeouthttp, server, locationkeepalive_time 65;客户端到服务器建立连接的超时时长，超过指定的时间服务器就会断开连接。默认为75秒。降低每个连接的alive时间可在一定程度上提高可响应连接数量，所以一般可适当降低此值</p><p>gziphttp, server, location, if in locationgzip on | off;开启内容压缩，可以有效降低客户端的访问流量和网络带宽</p><p>gzip_min_lengthhttp, server, locationgzip_min_length length;单位为k，默认为20k。内容超过最少长度后才开启压缩，因为太短的内容压缩效果不佳，且压缩过程还会浪费系统资源。这个压缩长度会作为http响应头Content-Length字段返回给客户端。 建议值：1000</p><p>gzip_comp_levelhttp, server, locationgzip_comp_level 1~9;压缩级别，默认值为1。范围为1～9级，压缩级别越高压缩率越高，但对系统性能要求越高。建议值：4</p><p>gzip_typeshttp, server, locationgzip_types mime-type …;压缩内容类型，默认为text/html;。只压缩html文本，一般我们都会压缩js、css、json之类的，可以把这些常见的文本数据都配上。如：text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</p><p>open_file_cachehttp, server, locationopen_file_cache off; open_file_cache max=N [inactive=time];默认值为off; 设置最大缓存数量，及缓存文件未使用的存活期。建议值：max=655350（和worker_rlimit_nofile参数一致） inactive=20s;</p><p>open_file_</p><p>cache_min_uses</p><p>http, server, locationopen_file_cache_min_uses number;默认为1，有效期内文件最少使有的次数。建议值：2</p><p>open_file</p><p>_cache_valid</p><p>http, server, locationopen_file_cache_valid time;默认为60s，验证缓存有效期时间间隔。 表示每隔60s检查一下缓存的文件当中，有哪些文件在20s以内没有使用超过2次的，就从缓存中删除。采用lru算法。</p><p>serverserver { … }httpHTTP服务器的核心配置，用于配置HTTP服务器的虚拟主机，可以配置多个</p><p>listenlisten ip[:端口]server配置虚拟主机监听的IP地址和端口，默认监听本机IP地址和80或8000端口。如果只设置了IP没设端口，默认使用80端口。如果只设置了端口，没设置IP默认使用本机IP。详细配置请参考：http://nginx.org/en/docs/http/ngx_http_core_module.html#listen</p><p>server_nameserver_name domain_name …;server配置虚拟主机的域名，可以指定多个，用空格分隔。默认为空</p><p>charsethttp, server, location, if in locationcharset charset | off;设置请求编码，和url参数乱码问题有关。</p><p>locationserver, locationlocation [ = | ~ | ~* | ^~ ] uri { … }</p><p>location @name { … }</p><p>http请求中的一个重要配置项，用于配置客户端请求服务器url地址的匹配规则。可以配置多个匹配规则</p><h1 class=pgc-h-arrow-right>3、核心配置优化</h1><p># nginx不同于apache服务器，当进行了大量优化设置后会魔术般的明显性能提升效果# nginx在安装完成后，大部分参数就已经是最优化了，我们需要管理的东西并不多#user nobody;#阻塞和非阻塞网络模型：#同步阻塞模型，一请求一进（线）程，当进（线）程增加到一定程度后#更多CPU时间浪费到切换一，性能急剧下降，所以负载率不高#Nginx基于事件的非阻塞多路复用(epoll或kquene)模型#一个进程在短时间内可以响应大量的请求#建议值 &lt;= cpu核心数量，一般高于cpu数量不会带好处，也许还有进程切换开销的负面影响worker_processes4;#将work process绑定到特定cpu上，避免进程在cpu间切换的开销worker_cpu_affinity0001001001001000#8内核4进程时的设置方法 worker_cpu_affinity 00000001 00000010 00000100 10000000# 每进程最大可打开文件描述符数量(linux上文件描述符比较广义，网络端口、设备、磁盘文件都是)# 文件描述符用完了，新的连接会被拒绝，产生502类错误# linux最大可打开文件数可通过ulimit -n FILECNT或 /etc/security/limits.conf配置# 理论值 系统最大数量 / 进程数。</p><p>但进程间工作量并不是平均分配的，所以可以设置的大一些worker_rlimit_nofile65535;#error_log logs/error.log;#error_log logs/error.log notice;#error_log logs/error.log info;#pid logs/nginx.pid;events {# 并发响应能力的关键配置值# 每个进程允许的最大同时连接数，work_connectins * worker_processes = maxConnection;# 要注意maxConnections不等同于可响应的用户数量，# 因为一般一个浏览器会同时开两条连接，如果反向代理，nginx到后端服务器的连接也要占用连接数# 所以，做静态服务器时，一般 maxClient = work_connectins * worker_processes / 2# 做反向代理服务器时 maxClient = work_connectins * worker_processes / 4# 这个值理论上越大越好，但最多可承受多少请求与配件和网络相关,也可最大可打开文件，最大可用sockets数量（约64K）有关worker_connections65535;# 指明使用epoll 或 kquene (*BSD)use epoll;# 备注：要达到超高负载下最好的网络响应能力，还有必要优化与网络相关的linux内核参数}http { include mime.types; default_type application/octet-stream;#log_format main '$remote_addr - $remote_user [$time_local] "$request" '# '$status $body_bytes_sent "$http_referer" '# '"$http_user_agent" "$http_x_forwarded_for"';# 关闭此项可减少IO开销，但也无法记录访问信息，不利用业务分析，一般运维情况不建议使用access_log off# 只记录更为严重的错误日志，可减少IO压力error_log logs/error.log crit;#access_log logs/access.log main;# 启用内核复制模式，应该保持开启达到最快IO效率sendfileon;# 简单说，启动如下两项配置，会在数据包达到一定大小后再发送数据# 这样会减少网络通信次数，降低阻塞概率，但也会影响响应及时性# 比较适合于文件下载这类的大数据包通信场景#tcp_nopush on; 在 #tcp_nodelay on|off on禁用Nagle算法 #keepalive_timeout 0;# HTTP1.1支持持久连接alive# 降低每个连接的alive时间可在一定程度上提高可响应连接数量，所以一般可适当降低此值keepalive_timeout 30s;# 启动内容压缩，有效降低网络流量gzip on;# 过短的内容压缩效果不佳，压缩过程还会浪费系统资源gzip_min_length1000;# 可选值1~9,压缩级别越高压缩率越高，但对系统性能要求越高gzip_comp_level4;# 压缩的内容类别gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;# 静态文件缓存# 最大缓存数量，文件未使用存活期open_file_cache max=65535inactive=20s;# 验证缓存有效期时间间隔open_file_cache_valid 30s;# 有效期内文件最少使用次数open_file_cache_min_uses2; server { listen80; server_name localhost; charset utf-8;#access_log logs/host.access.log main;location / { root html; index index.html index.htm; }#error_page 404 /404.html;# redirect server error pages to the static page /50x.html#error_page500502503504/50x.html; location = /50x.html { root html; }...}...}</p><p><br></p><p><strong>到此这篇关于文章就结束了！</strong></p><p>点关注，不迷路！如果本文对你有帮助的话不要忘记点赞支持哦！</p><p><br></p><div class=pgc-img><img alt=字节跳动8年架构师Nginx调优笔记分享 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/01ec564547454e7dbcf824328664f864><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=字节跳动8年架构师Nginx调优笔记分享 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c16281d86e7743449d4bf0641939c376><p class=pgc-img-caption></p></div><blockquote class=pgc-blockquote-abstract><p>上述2020阿里面试题集锦&最新2020整理收集的一些面试题（都整理成文档），有需要的可以私信回复：“2020” 即可免费领取。</p></blockquote><p><strong>希望对大家有所帮助，有用的话点赞给我支持！</strong></p><p><br></p><div class=pgc-img><img alt=字节跳动8年架构师Nginx调优笔记分享 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5d91a9706f734155a26f7db051070663><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'字节','跳动','年架'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>