<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Goå‘èµ·HTTP2.0è¯·æ±‚æµç¨‹åˆ†æ(ä¸­ç¯‡)â€”â€”æ•°æ®å¸§&æµæ§åˆ¶ | æå®¢å¿«è¨Š</title><meta property="og:title" content="Goå‘èµ·HTTP2.0è¯·æ±‚æµç¨‹åˆ†æ(ä¸­ç¯‡)â€”â€”æ•°æ®å¸§&æµæ§åˆ¶ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/ca343b56966046c6b646b9debecaf505"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33bf159.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33bf159.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/33bf159.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33bf159.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33bf159.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/33bf159.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/33bf159.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33bf159.html><meta property="article:published_time" content="2020-10-29T21:06:37+08:00"><meta property="article:modified_time" content="2020-10-29T21:06:37+08:00"><meta name=Keywords content><meta name=description content="Goå‘èµ·HTTP2.0è¯·æ±‚æµç¨‹åˆ†æ(ä¸­ç¯‡)â€”â€”æ•°æ®å¸§&æµæ§åˆ¶"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/33bf159.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Goå‘èµ·HTTP2.0è¯·æ±‚æµç¨‹åˆ†æ(ä¸­ç¯‡)â€”â€”æ•°æ®å¸§&æµæ§åˆ¶</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><blockquote class=pgc-blockquote-abstract><p>æ¥è‡ªå…¬ä¼—å·ï¼šæ–°ä¸–ç•Œæ‚è´§é“º</p></blockquote><h1 class=pgc-h-arrow-right>é˜…è¯»å»ºè®®</h1><p style=text-align:start>è¿™æ˜¯HTTP2.0ç³»åˆ—çš„ç¬¬äºŒç¯‡ï¼Œæ‰€ä»¥ç¬”è€…æ¨èé˜…è¯»é¡ºåºå¦‚ä¸‹:</p><ol start=1><li><a class=pgc-link data-content=mp data-source=innerLink href="https://www.toutiao.com/i6882255113369420299/?group_id=6882255113369420299" rel="noopener noreferrer" target=_blank>Goä¸­çš„HTTPè¯·æ±‚ä¹‹â€”â€”HTTP1.1è¯·æ±‚æµç¨‹åˆ†æ</a></li><li><a class=pgc-link data-content=mp data-source=innerLink href="https://www.toutiao.com/i6875967557174559244/?group_id=6875967557174559244" rel="noopener noreferrer" target=_blank>Goå‘èµ·HTTP2.0è¯·æ±‚æµç¨‹åˆ†æ(å‰ç¯‡)</a></li></ol><p style=text-align:start>æœ¬ç¯‡ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šæ•°æ®å¸§ï¼Œæµæ§åˆ¶å™¨ä»¥åŠé€šè¿‡åˆ†ææºç é€æ­¥äº†è§£æµæ§åˆ¶ã€‚</p><p style=text-align:start>æœ¬æœ‰æ„å°†è¿™ä¸‰ä¸ªéƒ¨åˆ†æ‹†æˆä¸‰ç¯‡æ–‡ç« ï¼Œä½†å®ƒä»¬ä¹‹é—´åˆæœ‰è”ç³»ï¼Œæ‰€ä»¥æœ€åä¾æ—§å†³å®šæ”¾åœ¨ä¸€ç¯‡æ–‡ç« é‡Œé¢ã€‚ç”±äºå†…å®¹è¾ƒå¤šï¼Œç¬”è€…è®¤ä¸ºåˆ†ä¸‰æ¬¡åˆ†åˆ«é˜…è¯»ä¸‰ä¸ªéƒ¨åˆ†è¾ƒä½³ã€‚</p><h1 class=pgc-h-arrow-right>æ•°æ®å¸§</h1><p style=text-align:start>HTTP2é€šä¿¡çš„æœ€å°å•ä½æ˜¯æ•°æ®å¸§ï¼Œæ¯ä¸€ä¸ªå¸§éƒ½åŒ…å«ä¸¤éƒ¨åˆ†ï¼š<strong>å¸§å¤´</strong>å’Œ<strong>Payload</strong>ã€‚ä¸åŒæ•°æ®æµçš„å¸§å¯ä»¥äº¤é”™å‘é€(åŒä¸€ä¸ªæ•°æ®æµçš„å¸§å¿…é¡»é¡ºåºå‘é€)ï¼Œç„¶åå†æ ¹æ®æ¯ä¸ªå¸§å¤´çš„æ•°æ®æµæ ‡è¯†ç¬¦é‡æ–°ç»„è£…ã€‚</p><p style=text-align:start>ç”±äºPayloadä¸­ä¸ºæœ‰æ•ˆæ•°æ®ï¼Œæ•…ä»…å¯¹å¸§å¤´è¿›è¡Œåˆ†ææè¿°ã€‚</p><h1 class=pgc-h-arrow-right>å¸§å¤´</h1><p style=text-align:start><strong>å¸§å¤´æ€»é•¿åº¦ä¸º9ä¸ªå­—èŠ‚</strong>ï¼Œå¹·åŒ…å«å››ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ol start=1><li>Payloadçš„é•¿åº¦ï¼Œå ç”¨ä¸‰ä¸ªå­—èŠ‚ã€‚</li><li>æ•°æ®å¸§ç±»å‹ï¼Œå ç”¨ä¸€ä¸ªå­—èŠ‚ã€‚</li><li>æ•°æ®å¸§æ ‡è¯†ç¬¦ï¼Œå ç”¨ä¸€ä¸ªå­—èŠ‚ã€‚</li><li>æ•°æ®æµIDï¼Œå ç”¨å››ä¸ªå­—èŠ‚ã€‚</li></ol><p style=text-align:start>ç”¨å›¾è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><div class=pgc-img><img alt=Goå‘èµ·HTTP2.0è¯·æ±‚æµç¨‹åˆ†æ(ä¸­ç¯‡)â€”â€”æ•°æ®å¸§&æµæ§åˆ¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ca343b56966046c6b646b9debecaf505><p class=pgc-img-caption></p></div><p style=text-align:start>æ•°æ®å¸§çš„æ ¼å¼å’Œå„éƒ¨åˆ†çš„å«ä¹‰å·²ç»æ¸…æ¥šäº†ï¼Œ é‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹ä»£ç ä¸­æ€ä¹ˆè¯»å–ä¸€ä¸ªå¸§å¤´ï¼š</p><pre><code>func http2readFrameHeader(buf []byte, r io.Reader) (http2FrameHeader, error) {	_, err := io.ReadFull(r, buf[:http2frameHeaderLen])	if err != nil {		return http2FrameHeader{}, err	}	return http2FrameHeader{		Length:   (uint32(buf[0])&lt;&lt;16 | uint32(buf[1])&lt;&lt;8 | uint32(buf[2])),		Type:     http2FrameType(buf[3]),		Flags:    http2Flags(buf[4]),		StreamID: binary.BigEndian.Uint32(buf[5:]) &amp; (1&lt;&lt;31 - 1),		valid:    true,	}, nil}</code></pre><p style=text-align:start>åœ¨ä¸Šé¢çš„ä»£ç ä¸­http2frameHeaderLenæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå…¶å€¼ä¸º9ã€‚</p><p style=text-align:start>ä»io.Readerä¸­è¯»å–9ä¸ªå­—èŠ‚åï¼Œå°†å‰ä¸‰ä¸ªå­—èŠ‚å’Œåå››ä¸ªå­—èŠ‚å‡è½¬ä¸ºuint32çš„ç±»å‹ï¼Œä»è€Œå¾—åˆ°Payloadé•¿åº¦å’Œæ•°æ®æµIDã€‚å¦å¤–éœ€è¦ç†è§£çš„æ˜¯å¸§å¤´çš„å‰ä¸‰ä¸ªå­—èŠ‚å’Œåå››ä¸ªå­—èŠ‚å­˜å‚¨æ ¼å¼ä¸ºå¤§ç«¯ï¼ˆå¤§å°ç«¯ç¬”è€…å°±ä¸åœ¨è¿™é‡Œè§£é‡Šäº†ï¼Œè¯·å°šä¸äº†è§£çš„è¯»è€…è‡ªè¡Œç™¾åº¦ï¼‰ã€‚</p><h1 class=pgc-h-arrow-right>æ•°æ®å¸§ç±»å‹</h1><p style=text-align:start>æ ¹æ®http://http2.github.io/http2-spec/#rfc.section.11.2æè¿°ï¼Œæ•°æ®å¸§ç±»å‹æ€»å…±æœ‰10ä¸ªã€‚åœ¨goæºç ä¸­å‡æœ‰ä½“ç°ï¼š</p><pre><code>const (	http2FrameData         http2FrameType = 0x0	http2FrameHeaders      http2FrameType = 0x1	http2FramePriority     http2FrameType = 0x2	http2FrameRSTStream    http2FrameType = 0x3	http2FrameSettings     http2FrameType = 0x4	http2FramePushPromise  http2FrameType = 0x5	http2FramePing         http2FrameType = 0x6	http2FrameGoAway       http2FrameType = 0x7	http2FrameWindowUpdate http2FrameType = 0x8	http2FrameContinuation http2FrameType = 0x9)</code></pre><p style=text-align:start>http2FrameDataï¼šä¸»è¦ç”¨äºå‘é€è¯·æ±‚bodyå’Œæ¥æ”¶å“åº”çš„æ•°æ®å¸§ã€‚</p><p style=text-align:start>http2FrameHeadersï¼šä¸»è¦ç”¨äºå‘é€è¯·æ±‚headerå’Œæ¥æ”¶å“åº”headerçš„æ•°æ®å¸§ã€‚</p><p style=text-align:start>http2FrameSettingsï¼šä¸»è¦ç”¨äºclientå’Œserveräº¤æµè®¾ç½®ç›¸å…³çš„æ•°æ®å¸§ã€‚</p><p style=text-align:start>http2FrameWindowUpdateï¼šä¸»è¦ç”¨äºæµæ§åˆ¶çš„æ•°æ®å¸§ã€‚</p><p style=text-align:start>å…¶ä»–æ•°æ®å¸§ç±»å‹å› ä¸ºæœ¬æ–‡ä¸æ¶‰åŠï¼Œæ•…ä¸åšæè¿°ã€‚</p><h1 class=pgc-h-arrow-right>æ•°æ®å¸§æ ‡è¯†ç¬¦</h1><p style=text-align:start>ç”±äºæ•°æ®å¸§æ ‡è¯†ç¬¦ç§ç±»è¾ƒå¤šï¼Œç¬”è€…åœ¨è¿™é‡Œä»…ä»‹ç»å…¶ä¸­éƒ¨åˆ†æ ‡è¯†ç¬¦ï¼Œå…ˆçœ‹æºç ï¼š</p><pre><code>const (	// Data Frame	http2FlagDataEndStream http2Flags = 0x1    // Headers Frame	http2FlagHeadersEndStream  http2Flags = 0x1    // Settings Frame	http2FlagSettingsAck http2Flags = 0x1	// æ­¤å¤„çœç•¥å®šä¹‰å…¶ä»–æ•°æ®å¸§æ ‡è¯†ç¬¦çš„ä»£ç )</code></pre><p style=text-align:start>http2FlagDataEndStreamï¼šåœ¨å‰ç¯‡ä¸­æåˆ°ï¼Œè°ƒç”¨(*http2ClientConn).newStreamæ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªæ•°æ®æµï¼Œé‚£è¿™ä¸ªæ•°æ®æµä»€ä¹ˆæ—¶å€™ç»“æŸå‘¢ï¼Œè¿™å°±æ˜¯http2FlagDataEndStreamçš„ä½œç”¨ã€‚</p><p style=text-align:start>å½“clientæ”¶åˆ°æœ‰å“åº”bodyçš„å“åº”æ—¶ï¼ˆHEADè¯·æ±‚æ— å“åº”bodyï¼Œ301ï¼Œ302ç­‰å“åº”ä¹Ÿæ— å“åº”bodyï¼‰ï¼Œä¸€ç›´è¯»åˆ°http2FrameDataæ•°æ®å¸§çš„æ ‡è¯†ç¬¦ä¸ºhttp2FlagDataEndStreamåˆ™æ„å‘³ç€æœ¬æ¬¡è¯·æ±‚ç»“æŸå¯ä»¥å…³é—­å½“å‰æ•°æ®æµã€‚</p><p style=text-align:start>http2FlagHeadersEndStreamï¼šå¦‚æœè¯»åˆ°çš„http2FrameHeadersæ•°æ®å¸§æœ‰æ­¤æ ‡è¯†ç¬¦ä¹Ÿæ„å‘³ç€æœ¬æ¬¡è¯·æ±‚ç»“æŸã€‚</p><p style=text-align:start>http2FlagSettingsAckï¼šè¯¥æ ‡ç¤ºç¬¦æ„å‘³ç€å¯¹æ–¹ç¡®è®¤æ”¶åˆ°http2FrameSettingsæ•°æ®å¸§ã€‚</p><h1 class=pgc-h-arrow-right>æµæ§åˆ¶å™¨</h1><p style=text-align:start>æµæ§åˆ¶æ˜¯ä¸€ç§é˜»æ­¢å‘é€æ–¹å‘æ¥æ”¶æ–¹å‘é€å¤§é‡æ•°æ®çš„æœºåˆ¶ï¼Œä»¥å…è¶…å‡ºåè€…çš„éœ€æ±‚æˆ–å¤„ç†èƒ½åŠ›ã€‚Goä¸­HTTP2é€šè¿‡http2flowç»“æ„ä½“è¿›è¡Œæµæ§åˆ¶ï¼š</p><pre><code>type http2flow struct {	// n is the number of DATA bytes we're allowed to send.	// A flow is kept both on a conn and a per-stream.	n int32	// conn points to the shared connection-level flow that is	// shared by all streams on that conn. It is nil for the flow	// that's on the conn directly.	conn *http2flow}</code></pre><p style=text-align:start>å­—æ®µå«ä¹‰è‹±æ–‡æ³¨é‡Šå·²ç»æè¿°çš„å¾ˆæ¸…æ¥šäº†ï¼Œæ‰€ä»¥ç¬”è€…ä¸å†ç¿»è¯‘ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹å’Œæµæ§åˆ¶æœ‰å…³çš„æ–¹æ³•ã€‚</p><h1 class=pgc-h-arrow-right>(*http2flow).available</h1><p style=text-align:start>æ­¤æ–¹æ³•è¿”å›å½“å‰æµæ§åˆ¶å¯å‘é€çš„æœ€å¤§å­—èŠ‚æ•°ï¼š</p><pre><code>func (f *http2flow) available() int32 {	n := f.n	if f.conn != nil &amp;&amp; f.conn.n &lt; n {		n = f.conn.n	}	return n}</code></pre><ul><li>å¦‚æœf.connä¸ºnilåˆ™æ„å‘³ç€æ­¤æ§åˆ¶å™¨çš„æ§åˆ¶çº§åˆ«ä¸ºè¿æ¥ï¼Œé‚£ä¹ˆå¯å‘é€çš„æœ€å¤§å­—èŠ‚æ•°å°±æ˜¯f.nã€‚</li><li>å¦‚æœf.connä¸ä¸ºnilåˆ™æ„å‘³ç€æ­¤æ§åˆ¶å™¨çš„æ§åˆ¶çº§åˆ«ä¸ºæ•°æ®æµï¼Œä¸”å½“å‰æ•°æ®æµå¯å‘é€çš„æœ€å¤§å­—èŠ‚æ•°ä¸èƒ½è¶…è¿‡å½“å‰è¿æ¥å¯å‘é€çš„æœ€å¤§å­—èŠ‚æ•°ã€‚</li></ul><h1 class=pgc-h-arrow-right>(*http2flow).take</h1><p style=text-align:start>æ­¤æ–¹æ³•ç”¨äºæ¶ˆè€—å½“å‰æµæ§åˆ¶å™¨çš„å¯å‘é€å­—èŠ‚æ•°ï¼š</p><pre><code>func (f *http2flow) take(n int32) {	if n &gt; f.available() {		panic("internal error: took too much")	}	f.n -= n	if f.conn != nil {		f.conn.n -= n	}}</code></pre><p style=text-align:start>é€šè¿‡å®é™…éœ€è¦ä¼ é€’ä¸€ä¸ªå‚æ•°ï¼Œå‘ŠçŸ¥å½“å‰æµæ§åˆ¶å™¨æƒ³è¦å‘é€çš„æ•°æ®å¤§å°ã€‚å¦‚æœå‘é€çš„å¤§å°è¶…è¿‡æµæ§åˆ¶å™¨å…è®¸çš„å¤§å°ï¼Œåˆ™panicï¼Œå¦‚æœæœªè¶…è¿‡æµæ§åˆ¶å™¨å…è®¸çš„å¤§å°ï¼Œåˆ™å°†å½“å‰æ•°æ®æµå’Œå½“å‰è¿æ¥çš„å¯å‘é€å­—èŠ‚æ•°-nã€‚</p><h1 class=pgc-h-arrow-right>(*http2flow).add</h1><p style=text-align:start>æœ‰æ¶ˆè€—å°±æœ‰æ–°å¢ï¼Œæ­¤æ–¹æ³•ç”¨äºå¢åŠ æµæ§åˆ¶å™¨å¯å‘é€çš„æœ€å¤§å­—èŠ‚æ•°ï¼š</p><pre><code>func (f *http2flow) add(n int32) bool {	sum := f.n + n	if (sum &gt; n) == (f.n &gt; 0) {		f.n = sum		return true	}	return false}</code></pre><p style=text-align:start>ä¸Šé¢çš„ä»£ç å”¯ä¸€éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œå½“sumè¶…è¿‡int32æ­£æ•°æœ€å¤§å€¼(2^31-1)æ—¶ä¼šè¿”å›falseã€‚</p><p style=text-align:start><strong>å›é¡¾</strong>ï¼šåœ¨å‰ç¯‡ä¸­æåˆ°çš„(*http2Transport).NewClientConnæ–¹æ³•å’Œ(*http2ClientConn).newStreamæ–¹æ³•å‡é€šè¿‡(*http2flow).addåˆå§‹åŒ–å¯å‘é€æ•°æ®çª—å£å¤§å°ã€‚</p><p style=text-align:start>æœ‰äº†å¸§å’Œæµæ§åˆ¶å™¨çš„åŸºæœ¬æ¦‚å¿µï¼Œä¸‹é¢æˆ‘ä»¬ç»“åˆæºç æ¥åˆ†ææ€»ç»“æµæ§åˆ¶çš„å…·ä½“å®ç°ã€‚</p><h1 class=pgc-h-arrow-right>(*http2ClientConn).readLoop</h1><p style=text-align:start>å‰ç¯‡åˆ†æ(*http2Transport).newClientConnæ—¶æ­¢æ­¥äºè¯»å¾ªç¯ï¼Œé‚£ä¹ˆä»Šå¤©æˆ‘ä»¬å°±ä»(*http2ClientConn).readLoopå¼€å§‹ã€‚</p><pre><code>func (cc *http2ClientConn) readLoop() {	rl := &amp;http2clientConnReadLoop{cc: cc}	defer rl.cleanup()	cc.readerErr = rl.run()	if ce, ok := cc.readerErr.(http2ConnectionError); ok {		cc.wmu.Lock()		cc.fr.WriteGoAway(0, http2ErrCode(ce), nil)		cc.wmu.Unlock()	}}</code></pre><p style=text-align:start>ç”±ä¸Šå¯çŸ¥ï¼ŒreadLoopçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå…¶æ ¸å¿ƒé€»è¾‘åœ¨(*http2clientConnReadLoop).runæ–¹æ³•é‡Œã€‚</p><pre><code>func (rl *http2clientConnReadLoop) run() error {	cc := rl.cc	rl.closeWhenIdle = cc.t.disableKeepAlives() || cc.singleUse	gotReply := false // ever saw a HEADERS reply	gotSettings := false	for {		f, err := cc.fr.ReadFrame()    // æ­¤å¤„çœç•¥ä»£ç 		maybeIdle := false // whether frame might transition us to idle		switch f := f.(type) {		case *http2MetaHeadersFrame:			err = rl.processHeaders(f)			maybeIdle = true			gotReply = true		case *http2DataFrame:			err = rl.processData(f)			maybeIdle = true		case *http2GoAwayFrame:			err = rl.processGoAway(f)			maybeIdle = true		case *http2RSTStreamFrame:			err = rl.processResetStream(f)			maybeIdle = true		case *http2SettingsFrame:			err = rl.processSettings(f)		case *http2PushPromiseFrame:			err = rl.processPushPromise(f)		case *http2WindowUpdateFrame:			err = rl.processWindowUpdate(f)		case *http2PingFrame:			err = rl.processPing(f)		default:			cc.logf("Transport: unhandled response frame type %T", f)		}		if err != nil {			if http2VerboseLogs {				cc.vlogf("http2: Transport conn %p received error from processing frame %v: %v", cc, http2summarizeFrame(f), err)			}			return err		}		if rl.closeWhenIdle &amp;&amp; gotReply &amp;&amp; maybeIdle {			cc.closeIfIdle()		}	}}</code></pre><p style=text-align:start>ç”±ä¸Šå¯çŸ¥ï¼Œ(*http2clientConnReadLoop).runçš„æ ¸å¿ƒé€»è¾‘æ˜¯è¯»å–æ•°æ®å¸§ç„¶åå¯¹ä¸åŒçš„æ•°æ®å¸§è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚</p><p style=text-align:start>cc.fr.ReadFrame()ä¼šæ ¹æ®å‰é¢ä»‹ç»çš„æ•°æ®å¸§æ ¼å¼è¯»å‡ºæ•°æ®å¸§ã€‚</p><p style=text-align:start>å‰ç¯‡ä¸­æåˆ°ä½¿ç”¨äº†ä¸€ä¸ªæ”¯æŒh2åè®®çš„å›¾ç‰‡è¿›è¡Œåˆ†æï¼Œæœ¬ç¯‡ç»§ç»­å¤ç”¨è¯¥å›¾ç‰‡å¯¹(*http2clientConnReadLoop).runæ–¹æ³•è¿›è¡Œdebugã€‚</p><h1 class=pgc-h-arrow-right>æ”¶åˆ°http2FrameSettingsæ•°æ®å¸§</h1><p style=text-align:start>è¯»å¾ªç¯ä¼šæœ€å…ˆè¯»åˆ°http2FrameSettingsæ•°æ®å¸§ã€‚è¯»åˆ°è¯¥æ•°æ®å¸§åä¼šè°ƒç”¨(*http2clientConnReadLoop).processSettingsæ–¹æ³•ã€‚(*http2clientConnReadLoop).processSettingsä¸»è¦åŒ…å«3ä¸ªé€»è¾‘ã€‚</p><p style=text-align:start>1ã€åˆ¤æ–­æ˜¯å¦æ˜¯http2FrameSettingsçš„ackä¿¡æ¯ï¼Œå¦‚æœæ˜¯ç›´æ¥è¿”å›ï¼Œå¦åˆ™ç»§ç»­åé¢çš„æ­¥éª¤ã€‚</p><pre><code>if f.IsAck() {  if cc.wantSettingsAck {    cc.wantSettingsAck = false    return nil  }  return http2ConnectionError(http2ErrCodeProtocol)}</code></pre><p style=text-align:start>2ã€å¤„ç†ä¸åŒhttp2FrameSettingsçš„æ•°æ®å¸§ï¼Œå¹¶æ ¹æ®serverä¼ é€’çš„ä¿¡æ¯ï¼Œä¿®æ”¹maxConcurrentStreamsç­‰çš„å€¼ã€‚</p><pre><code>err := f.ForeachSetting(func(s http2Setting) error {  switch s.ID {    case http2SettingMaxFrameSize:    cc.maxFrameSize = s.Val    case http2SettingMaxConcurrentStreams:    cc.maxConcurrentStreams = s.Val    case http2SettingMaxHeaderListSize:    cc.peerMaxHeaderListSize = uint64(s.Val)    case http2SettingInitialWindowSize:    if s.Val &gt; math.MaxInt32 {      return http2ConnectionError(http2ErrCodeFlowControl)    }    delta := int32(s.Val) - int32(cc.initialWindowSize)    for _, cs := range cc.streams {      cs.flow.add(delta)    }    cc.cond.Broadcast()    cc.initialWindowSize = s.Val    default:    // TODO(bradfitz): handle more settings? SETTINGS_HEADER_TABLE_SIZE probably.    cc.vlogf("Unhandled Setting: %v", s)  }  return nil})</code></pre><p style=text-align:start>å½“æ”¶åˆ°IDä¸ºhttp2SettingInitialWindowSizeçš„å¸§æ—¶ï¼Œä¼šè°ƒæ•´å½“å‰è¿æ¥ä¸­æ‰€æœ‰æ•°æ®æµçš„å¯å‘é€æ•°æ®çª—å£å¤§å°ï¼Œå¹¶ä¿®æ”¹å½“å‰è¿æ¥çš„initialWindowSizeï¼ˆæ¯ä¸ªæ–°åˆ›å»ºçš„æ•°æ®æµå‡ä¼šä½¿ç”¨è¯¥å€¼åˆå§‹åŒ–å¯å‘é€æ•°æ®çª—å£å¤§å°ï¼‰ä¸ºs.Valã€‚</p><p style=text-align:start>3ã€å‘é€http2FrameSettingsçš„ackä¿¡æ¯ç»™serverã€‚</p><pre><code>	cc.wmu.Lock()	defer cc.wmu.Unlock()	cc.fr.WriteSettingsAck()	cc.bw.Flush()	return cc.werr</code></pre><h1 class=pgc-h-arrow-right>æ”¶åˆ°http2WindowUpdateFrameæ•°æ®å¸§</h1><p style=text-align:start>åœ¨ç¬”è€…debugçš„è¿‡ç¨‹ä¸­ï¼Œå¤„ç†å®Œhttp2FrameSettingsæ•°æ®å¸§åï¼Œç´§æ¥ç€å°±æ”¶åˆ°äº†http2WindowUpdateFrameæ•°æ®å¸§ã€‚æ”¶åˆ°è¯¥æ•°æ®å¸§åä¼šè°ƒç”¨(*http2clientConnReadLoop).processWindowUpdateæ–¹æ³•ï¼š</p><pre><code>func (rl *http2clientConnReadLoop) processWindowUpdate(f *http2WindowUpdateFrame) error {	cc := rl.cc	cs := cc.streamByID(f.StreamID, false)	if f.StreamID != 0 &amp;&amp; cs == nil {		return nil	}	cc.mu.Lock()	defer cc.mu.Unlock()	fl := &amp;cc.flow	if cs != nil {		fl = &amp;cs.flow	}	if !fl.add(int32(f.Increment)) {		return http2ConnectionError(http2ErrCodeFlowControl)	}	cc.cond.Broadcast()	return nil}</code></pre><p style=text-align:start>ä¸Šé¢çš„é€»è¾‘ä¸»è¦ç”¨äºæ›´æ–°å½“å‰è¿æ¥å’Œæ•°æ®æµçš„å¯å‘é€æ•°æ®çª—å£å¤§å°ã€‚å¦‚æœhttp2WindowUpdateFrameå¸§ä¸­çš„StreamIDä¸º0ï¼Œåˆ™æ›´æ–°å½“å‰è¿æ¥çš„å¯å‘é€æ•°æ®çª—å£å¤§å°ï¼Œå¦åˆ™æ›´æ–°å¯¹åº”æ•°æ®æµå¯å‘é€æ•°æ®çª—å£å¤§å°ã€‚</p><p style=text-align:start><strong>æ³¨æ„</strong>ï¼šåœ¨debugçš„è¿‡ç¨‹ï¼Œæ”¶åˆ°http2WindowUpdateFrameæ•°æ®å¸§åï¼Œåˆæ”¶åˆ°ä¸€æ¬¡http2FrameSettingsï¼Œä¸”è¯¥æ•°æ®å¸§æ ‡è¯†ç¬¦ä¸ºhttp2FlagSettingsAckã€‚</p><p style=text-align:start>ç¬”è€…åœ¨è¿™é‡Œç‰¹æ„æé†’ï¼Œè¿™æ˜¯å› ä¸ºå‰ç¯‡ä¸­æåˆ°çš„(*http2Transport).NewClientConnæ–¹æ³•ï¼Œä¹Ÿå‘serverå‘é€äº†http2FrameSettingsæ•°æ®å¸§å’Œhttp2WindowUpdateFrameæ•°æ®å¸§ã€‚</p><p style=text-align:start>å¦å¤–ï¼Œåœ¨å¤„ç†http2FrameSettingså’Œhttp2WindowUpdateFrameè¿‡ç¨‹ä¸­ï¼Œå‡å‡ºç°äº†cc.cond.Broadcast()è°ƒç”¨ï¼Œè¯¥è°ƒç”¨ä¸»è¦ç”¨äºå”¤é†’å› ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µè€ŒWaitçš„è¯·æ±‚ï¼š</p><ol start=1><li>å› å½“å‰è¿æ¥å¤„ç†çš„æ•°æ®æµå·²ç»è¾¾åˆ°maxConcurrentStreamsçš„ä¸Šé™ï¼ˆè¯¦è§å‰ç¯‡ä¸­(*http2ClientConn).awaitOpenSlotForRequestæ–¹æ³•åˆ†æï¼‰ã€‚</li><li>å› å‘é€æ•°æ®æµå·²è¾¾å¯å‘é€æ•°æ®çª—å£ä¸Šé™è€Œç­‰å¾…å¯å‘é€æ•°æ®çª—å£æ›´æ–°çš„è¯·æ±‚ï¼ˆåç»­ä¼šä»‹ç»ï¼‰ã€‚</li></ol><h1 class=pgc-h-arrow-right>æ”¶åˆ°http2MetaHeadersFrameæ•°æ®å¸§</h1><p style=text-align:start>æ”¶åˆ°æ­¤æ•°æ®å¸§æ„å‘³ç€æŸä¸€ä¸ªè¯·æ±‚å·²ç»å¼€å§‹æ¥æ”¶å“åº”æ•°æ®ã€‚æ­¤æ•°æ®å¸§å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸º(*http2clientConnReadLoop).processHeadersï¼š</p><pre><code>func (rl *http2clientConnReadLoop) processHeaders(f *http2MetaHeadersFrame) error {	cc := rl.cc	cs := cc.streamByID(f.StreamID, false)	// æ­¤å¤„çœç•¥ä»£ç 	res, err := rl.handleResponse(cs, f)	if err != nil {		// æ­¤å¤„çœç•¥ä»£ç 		cs.resc &lt;- http2resAndError{err: err}		return nil // return nil from process* funcs to keep conn alive	}	if res == nil {		// (nil, nil) special case. See handleResponse docs.		return nil	}	cs.resTrailer = &amp;res.Trailer	cs.resc &lt;- http2resAndError{res: res}	return nil}</code></pre><p style=text-align:start>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹cs.resc &lt;- http2resAndError{res: res}è¿™ä¸€è¡Œä»£ç ï¼Œå‘æ•°æ®æµå†™å…¥http2resAndErrorå³æœ¬æ¬¡è¯·æ±‚çš„å“åº”ã€‚åœ¨(*http2ClientConn).roundTripæ–¹æ³•ä¸­æœ‰è¿™æ ·ä¸€è¡Œä»£ç readLoopResCh := cs.rescã€‚</p><p style=text-align:start><strong>å›é¡¾</strong>ï¼šå‰ç¯‡(*http2ClientConn).roundTripæ–¹æ³•çš„ç¬¬7ç‚¹å’Œæœ¬éƒ¨åˆ†å…³è”èµ·æ¥å°±å¯ä»¥å½¢æˆä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚é“¾ã€‚</p><p style=text-align:start>æ¥ä¸‹æ¥æˆ‘ä»¬å¯¹rl.handleResponseæ–¹æ³•å±•å¼€åˆ†æã€‚</p><h1 class=pgc-h-arrow-right>(*http2clientConnReadLoop).handleResponse</h1><p style=text-align:start>(*http2clientConnReadLoop).handleResponseçš„ä¸»è¦ä½œç”¨æ˜¯æ„å»ºä¸€ä¸ªResponseå˜é‡ï¼Œä¸‹é¢å¯¹è¯¥å‡½æ•°çš„å…³é”®æ­¥éª¤è¿›è¡Œæè¿°ã€‚</p><p style=text-align:start>1ã€æ„å»ºä¸€ä¸ªResponseå˜é‡ã€‚</p><pre><code>header := make(Header)res := &amp;Response{  Proto:      "HTTP/2.0",  ProtoMajor: 2,  Header:     header,  StatusCode: statusCode,  Status:     status + " " + StatusText(statusCode),}</code></pre><p style=text-align:start>2ã€æ„å»ºheaderï¼ˆæœ¬ç¯‡ä¸å¯¹headerè¿›è¡Œå±•å¼€åˆ†æï¼‰ã€‚</p><pre><code>for _, hf := range f.RegularFields() {  key := CanonicalHeaderKey(hf.Name)  if key == "Trailer" {    t := res.Trailer    if t == nil {      t = make(Header)      res.Trailer = t    }    http2foreachHeaderElement(hf.Value, func(v string) {      t[CanonicalHeaderKey(v)] = nil    })  } else {    header[key] = append(header[key], hf.Value)  }}</code></pre><p style=text-align:start>3ã€å¤„ç†å“åº”bodyçš„ContentLengthã€‚</p><pre><code>streamEnded := f.StreamEnded()isHead := cs.req.Method == "HEAD"if !streamEnded || isHead {  res.ContentLength = -1  if clens := res.Header["Content-Length"]; len(clens) == 1 {    if clen64, err := strconv.ParseInt(clens[0], 10, 64); err == nil {      res.ContentLength = clen64    } else {      // TODO: care? unlike http/1, it won't mess up our framing, so it's      // more safe smuggling-wise to ignore.    }  } else if len(clens) &gt; 1 {    // TODO: care? unlike http/1, it won't mess up our framing, so it's    // more safe smuggling-wise to ignore.  }}</code></pre><p style=text-align:start>ç”±ä¸Šå¯çŸ¥ï¼Œå½“å‰æ•°æ®æµæ²¡æœ‰ç»“æŸæˆ–è€…æ˜¯HEADè¯·æ±‚æ‰è¯»å–ContentLengthã€‚å¦‚æœheaderä¸­çš„ContentLengthä¸åˆæ³•åˆ™res.ContentLengthçš„å€¼ä¸º <strong>-1</strong>ã€‚</p><p style=text-align:start>4ã€æ„å»ºres.Bodyã€‚</p><pre><code>cs.bufPipe = http2pipe{b: &amp;http2dataBuffer{expected: res.ContentLength}}cs.bytesRemain = res.ContentLengthres.Body = http2transportResponseBody{cs}go cs.awaitRequestCancel(cs.req)if cs.requestedGzip &amp;&amp; res.Header.Get("Content-Encoding") == "gzip" {  res.Header.Del("Content-Encoding")  res.Header.Del("Content-Length")  res.ContentLength = -1  res.Body = &amp;http2gzipReader{body: res.Body}  res.Uncompressed = true}</code></pre><p style=text-align:start>æ ¹æ®Content-Encodingçš„ç¼–ç æ–¹å¼ï¼Œä¼šæ„å»ºä¸¤ç§ä¸åŒçš„Bodyï¼š</p><ol start=1><li>égzipç¼–ç æ—¶ï¼Œæ„é€ çš„res.Bodyç±»å‹ä¸ºhttp2transportResponseBodyã€‚</li><li>gzipç¼–ç æ—¶ï¼Œæ„é€ çš„res.Bodyç±»å‹ä¸ºhttp2gzipReaderã€‚</li></ol><h1 class=pgc-h-arrow-right>æ”¶åˆ°http2DataFrameæ•°æ®å¸§</h1><p style=text-align:start>æ”¶åˆ°æ­¤æ•°æ®å¸§æ„å‘³ç€æˆ‘ä»¬å¼€å§‹æ¥æ”¶çœŸå®çš„å“åº”ï¼Œå³å¹³å¸¸å¼€å‘ä¸­éœ€è¦å¤„ç†çš„ä¸šåŠ¡æ•°æ®ã€‚æ­¤æ•°æ®å¸§å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸º(*http2clientConnReadLoop).processDataã€‚</p><p style=text-align:start>å› ä¸ºserveræ— æ³•åŠæ—¶çŸ¥é“æ•°æ®æµåœ¨clientç«¯çš„çŠ¶æ€ï¼Œæ‰€ä»¥serverå¯èƒ½ä¼šå‘clientä¸­ä¸€ä¸ªå·²ç»ä¸å­˜åœ¨çš„æ•°æ®æµå‘é€æ•°æ®ï¼š</p><pre><code>cc := rl.cccs := cc.streamByID(f.StreamID, f.StreamEnded())data := f.Data()if cs == nil {  cc.mu.Lock()  neverSent := cc.nextStreamID  cc.mu.Unlock() // æ­¤å¤„çœç•¥ä»£ç   if f.Length &gt; 0 {    cc.mu.Lock()    cc.inflow.add(int32(f.Length))    cc.mu.Unlock()    cc.wmu.Lock()    cc.fr.WriteWindowUpdate(0, uint32(f.Length))    cc.bw.Flush()    cc.wmu.Unlock()  }  return nil}</code></pre><p style=text-align:start>æ¥æ”¶åˆ°çš„æ•°æ®å¸§åœ¨clientæ²¡æœ‰å¯¹åº”çš„æ•°æ®æµå¤„ç†æ—¶ï¼Œé€šè¿‡æµæ§åˆ¶å™¨ä¸ºå½“å‰è¿æ¥å¯è¯»çª—å£å¤§å°å¢åŠ f.Lengthï¼Œå¹¶ä¸”é€šè¿‡http2FrameWindowUpdateæ•°æ®å¸§å‘ŠçŸ¥serverå°†å½“å‰è¿æ¥çš„å¯å†™çª—å£å¤§å°å¢åŠ f.Lengthã€‚</p><p style=text-align:start>å¦‚æœclientæœ‰å¯¹åº”çš„æ•°æ®æµä¸”f.Lengthå¤§äº0ï¼š</p><p style=text-align:start>1ã€å¦‚æœæ˜¯headè¯·æ±‚ç»“æŸå½“å‰æ•°æ®æµå¹¶è¿”å›ã€‚</p><pre><code>if cs.req.Method == "HEAD" &amp;&amp; len(data) &gt; 0 {  cc.logf("protocol error: received DATA on a HEAD request")  rl.endStreamError(cs, http2StreamError{    StreamID: f.StreamID,    Code:     http2ErrCodeProtocol,  })  return nil}</code></pre><p style=text-align:start>2ã€æ£€æŸ¥å½“å‰æ•°æ®æµèƒ½å¦å¤„ç†f.Lengthé•¿åº¦çš„æ•°æ®ã€‚</p><pre><code>cc.mu.Lock()if cs.inflow.available() &gt;= int32(f.Length) {  cs.inflow.take(int32(f.Length))} else {  cc.mu.Unlock()  return http2ConnectionError(http2ErrCodeFlowControl)}</code></pre><p style=text-align:start>ç”±ä¸Šå¯çŸ¥å½“å‰æ•°æ®æµå¦‚æœèƒ½å¤Ÿå¤„ç†è¯¥æ•°æ®ï¼Œé€šè¿‡æµæ§åˆ¶å™¨è°ƒç”¨cs.inflow.takeå‡å°å½“å‰æ•°æ®æµå¯æ¥å—çª—å£å¤§å°ã€‚</p><p style=text-align:start>3ã€å½“å‰æ•°æ®æµè¢«é‡ç½®æˆ–è€…è¢«å…³é—­å³cs.didResetä¸ºtrueæ—¶åˆæˆ–è€…æ•°æ®å¸§æœ‰å¡«å……æ•°æ®æ—¶éœ€è¦è°ƒæ•´æµæ§åˆ¶çª—å£ã€‚</p><pre><code>var refund intif pad := int(f.Length) - len(data); pad &gt; 0 {  refund += pad}// Return len(data) now if the stream is already closed,// since data will never be read.didReset := cs.didResetif didReset {  refund += len(data)}if refund &gt; 0 {  cc.inflow.add(int32(refund))  cc.wmu.Lock()  cc.fr.WriteWindowUpdate(0, uint32(refund))  if !didReset {    cs.inflow.add(int32(refund))    cc.fr.WriteWindowUpdate(cs.ID, uint32(refund))  }  cc.bw.Flush()  cc.wmu.Unlock()}cc.mu.Unlock()</code></pre><ul><li>å¦‚æœæ•°æ®å¸§æœ‰å¡«å……æ•°æ®åˆ™è®¡ç®—éœ€è¦è¿”è¿˜çš„å¡«å……æ•°æ®é•¿åº¦ã€‚</li><li>å¦‚æœæ•°æ®æµæ— æ•ˆè¯¥æ•°æ®å¸§çš„é•¿åº¦éœ€è¦å…¨éƒ¨è¿”è¿˜ã€‚</li></ul><p style=text-align:start>æœ€åï¼Œæ ¹æ®è®¡ç®—çš„refundå¢åŠ å½“å‰è¿æ¥æˆ–è€…å½“å‰æ•°æ®æµçš„å¯æ¥å—çª—å£å¤§å°ï¼Œå¹¶ä¸”åŒæ—¶å‘ŠçŸ¥serverå¢åŠ å½“å‰è¿æ¥æˆ–è€…å½“å‰æ•°æ®æµçš„å¯å†™çª—å£å¤§å°ã€‚</p><p style=text-align:start>4ã€æ•°æ®é•¿åº¦å¤§äº0ä¸”æ•°æ®æµæ­£å¸¸åˆ™å°†æ•°æ®å†™å…¥æ•°æ®æµç¼“å†²åŒºã€‚</p><pre><code>if len(data) &gt; 0 &amp;&amp; !didReset {  if _, err := cs.bufPipe.Write(data); err != nil {    rl.endStreamError(cs, err)    return err  }}</code></pre><p style=text-align:start><strong>å›é¡¾</strong>ï¼šå‰é¢çš„(*http2clientConnReadLoop).handleResponseæ–¹æ³•ä¸­æœ‰è¿™æ ·ä¸€è¡Œä»£ç res.Body = http2transportResponseBody{cs}ï¼Œæ‰€ä»¥åœ¨ä¸šåŠ¡å¼€å‘æ—¶èƒ½å¤Ÿé€šè¿‡Responseè¯»å–åˆ°æ•°æ®æµä¸­çš„ç¼“å†²æ•°æ®ã€‚</p><h1 class=pgc-h-arrow-right>(http2transportResponseBody).Read</h1><p style=text-align:start>åœ¨å‰é¢çš„å†…å®¹é‡Œï¼Œå¦‚æœæ•°æ®æµçŠ¶æ€æ­£å¸¸ä¸”æ•°æ®å¸§æ²¡æœ‰å¡«å……æ•°æ®åˆ™æ•°æ®æµå’Œè¿æ¥çš„å¯æ¥æ”¶çª—å£ä¼šä¸€ç›´å˜å°ï¼Œè€Œè¿™éƒ¨åˆ†å†…å®¹å°±æ˜¯å¢åŠ æ•°æ®æµçš„å¯æ¥å—çª—å£å¤§å°ã€‚</p><p style=text-align:start>å› ä¸ºç¯‡å¹…å’Œä¸»æ—¨çš„é—®é¢˜ç¬”è€…ä»…åˆ†ææè¿°è¯¥æ–¹æ³•å†…å’Œæµæ§åˆ¶æœ‰å…³çš„éƒ¨åˆ†ã€‚</p><p style=text-align:start>1ã€è¯»å–å“åº”æ•°æ®åè®¡ç®—å½“å‰è¿æ¥éœ€è¦å¢åŠ çš„å¯æ¥å—çª—å£å¤§å°ã€‚</p><pre><code>cc.mu.Lock()defer cc.mu.Unlock()var connAdd, streamAdd int32// Check the conn-level first, before the stream-level.if v := cc.inflow.available(); v &lt; http2transportDefaultConnFlow/2 {  connAdd = http2transportDefaultConnFlow - v  cc.inflow.add(connAdd)}</code></pre><p style=text-align:start>å¦‚æœå½“å‰è¿æ¥å¯æ¥å—çª—å£çš„å¤§å°å·²ç»å°äºhttp2transportDefaultConnFlowï¼ˆ1Gï¼‰çš„ä¸€åŠï¼Œåˆ™å½“å‰è¿æ¥å¯æ¥æ”¶çª—å£å¤§å°éœ€è¦å¢åŠ http2transportDefaultConnFlow - cc.inflow.available()ã€‚</p><p style=text-align:start><strong>å›é¡¾</strong>ï¼šhttp2transportDefaultConnFlowåœ¨å‰ç¯‡(*http2Transport).NewClientConnæ–¹æ³•éƒ¨åˆ†æœ‰æåˆ°ï¼Œä¸”è¿æ¥åˆšå»ºç«‹æ—¶ä¼šé€šè¿‡http2WindowUpdateFrameæ•°æ®å¸§å‘ŠçŸ¥serverå½“å‰è¿æ¥å¯å‘é€çª—å£å¤§å°å¢åŠ http2transportDefaultConnFlowã€‚</p><p style=text-align:start>2ã€è¯»å–å“åº”æ•°æ®åè®¡ç®—å½“å‰æ•°æ®æµéœ€è¦å¢åŠ çš„å¯æ¥å—çª—å£å¤§å°ã€‚</p><pre><code>if err == nil { // No need to refresh if the stream is over or failed.  // Consider any buffered body data (read from the conn but not  // consumed by the client) when computing flow control for this  // stream.  v := int(cs.inflow.available()) + cs.bufPipe.Len()  if v &lt; http2transportDefaultStreamFlow-http2transportDefaultStreamMinRefresh {    streamAdd = int32(http2transportDefaultStreamFlow - v)    cs.inflow.add(streamAdd)  }}</code></pre><p style=text-align:start>å¦‚æœå½“å‰æ•°æ®æµå¯æ¥å—çª—å£å¤§å°åŠ ä¸Šå½“å‰æ•°æ®æµç¼“å†²åŒºå‰©ä½™æœªè¯»æ•°æ®çš„é•¿åº¦å°äºhttp2transportDefaultStreamFlow-http2transportDefaultStreamMinRefreshï¼ˆ4M-4KBï¼‰ï¼Œåˆ™å½“å‰æ•°æ®æµå¯æ¥å—çª—å£å¤§å°éœ€è¦å¢åŠ http2transportDefaultStreamFlow - vã€‚</p><p style=text-align:start><strong>å›é¡¾</strong>ï¼šhttp2transportDefaultStreamFlowåœ¨å‰ç¯‡(*http2Transport).NewClientConnæ–¹æ³•å’Œ(*http2ClientConn).newStreamæ–¹æ³•ä¸­å‡æœ‰æåˆ°ã€‚</p><p style=text-align:start>è¿æ¥åˆšå»ºç«‹æ—¶ï¼Œå‘é€http2FrameSettingsæ•°æ®å¸§ï¼Œå‘ŠçŸ¥serveræ¯ä¸ªæ•°æ®æµçš„å¯å‘é€çª—å£å¤§å°ä¸ºhttp2transportDefaultStreamFlowã€‚</p><p style=text-align:start>åœ¨newStreamæ—¶ï¼Œæ•°æ®æµé»˜è®¤çš„å¯æ¥æ”¶çª—å£å¤§å°ä¸ºhttp2transportDefaultStreamFlowã€‚</p><p style=text-align:start>3ã€å°†è¿æ¥å’Œæ•°æ®æµåˆ†åˆ«éœ€è¦å¢åŠ çš„çª—å£å¤§å°é€šè¿‡http2WindowUpdateFrameæ•°æ®å¸§å‘ŠçŸ¥serverã€‚</p><pre><code>if connAdd != 0 || streamAdd != 0 {  cc.wmu.Lock()  defer cc.wmu.Unlock()  if connAdd != 0 {    cc.fr.WriteWindowUpdate(0, http2mustUint31(connAdd))  }  if streamAdd != 0 {    cc.fr.WriteWindowUpdate(cs.ID, http2mustUint31(streamAdd))  }  cc.bw.Flush()}</code></pre><p style=text-align:start>ä»¥ä¸Šå°±æ˜¯serverå‘clientå‘é€æ•°æ®çš„æµæ§åˆ¶é€»è¾‘ã€‚</p><h1 class=pgc-h-arrow-right>(*http2clientStream).writeRequestBody</h1><p style=text-align:start>å‰ç¯‡ä¸­(*http2ClientConn).roundTripæœªå¯¹(*http2clientStream).writeRequestBodyè¿›è¡Œåˆ†æï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹è¯¥æ–¹æ³•çš„æºç ï¼š</p><pre><code>func (cs *http2clientStream) writeRequestBody(body io.Reader, bodyCloser io.Closer) (err error) {	cc := cs.cc	sentEnd := false // whether we sent the final DATA frame w/ END_STREAM  // æ­¤å¤„çœç•¥ä»£ç 	req := cs.req	hasTrailers := req.Trailer != nil	remainLen := http2actualContentLength(req)	hasContentLen := remainLen != -1	var sawEOF bool	for !sawEOF {		n, err := body.Read(buf[:len(buf)-1])    // æ­¤å¤„çœç•¥ä»£ç 		remain := buf[:n]		for len(remain) &gt; 0 &amp;&amp; err == nil {			var allowed int32			allowed, err = cs.awaitFlowControl(len(remain))			switch {			case err == http2errStopReqBodyWrite:				return err			case err == http2errStopReqBodyWriteAndCancel:				cc.writeStreamReset(cs.ID, http2ErrCodeCancel, nil)				return err			case err != nil:				return err			}			cc.wmu.Lock()			data := remain[:allowed]			remain = remain[allowed:]			sentEnd = sawEOF &amp;&amp; len(remain) == 0 &amp;&amp; !hasTrailers			err = cc.fr.WriteData(cs.ID, sentEnd, data)			if err == nil {				err = cc.bw.Flush()			}			cc.wmu.Unlock()		}		if err != nil {			return err		}	}  // æ­¤å¤„çœç•¥ä»£ç 	return err}</code></pre><p style=text-align:start>ä¸Šé¢çš„é€»è¾‘å¯ç®€å•æ€»ç»“ä¸ºï¼šä¸åœçš„è¯»å–è¯·æ±‚bodyç„¶åå°†è¯»å–çš„å†…å®¹é€šè¿‡cc.fr.WriteDataè½¬ä¸ºhttp2FrameDataæ•°æ®å¸§å‘é€ç»™serverï¼Œç›´åˆ°è¯·æ±‚bodyè¯»å®Œä¸ºæ­¢ã€‚å…¶ä¸­å’Œæµæ§åˆ¶æœ‰å…³çš„æ–¹æ³•æ˜¯awaitFlowControlï¼Œä¸‹é¢æˆ‘ä»¬å¯¹è¯¥æ–¹æ³•è¿›è¡Œåˆ†æã€‚</p><h1 class=pgc-h-arrow-right>(*http2clientStream).awaitFlowControl</h1><p style=text-align:start>æ­¤æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯ç­‰å¾…å½“å‰æ•°æ®æµå¯å†™çª—å£æœ‰å®¹é‡èƒ½å¤Ÿå†™å…¥æ•°æ®ã€‚</p><pre><code>func (cs *http2clientStream) awaitFlowControl(maxBytes int) (taken int32, err error) {	cc := cs.cc	cc.mu.Lock()	defer cc.mu.Unlock()	for {		if cc.closed {			return 0, http2errClientConnClosed		}		if cs.stopReqBody != nil {			return 0, cs.stopReqBody		}		if err := cs.checkResetOrDone(); err != nil {			return 0, err		}		if a := cs.flow.available(); a &gt; 0 {			take := a			if int(take) &gt; maxBytes {				take = int32(maxBytes) // can't truncate int; take is int32			}			if take &gt; int32(cc.maxFrameSize) {				take = int32(cc.maxFrameSize)			}			cs.flow.take(take)			return take, nil		}		cc.cond.Wait()	}}</code></pre><p style=text-align:start>æ ¹æ®æºç å¯ä»¥çŸ¥é“ï¼Œæ•°æ®æµè¢«å…³é—­æˆ–è€…åœæ­¢å‘é€è¯·æ±‚bodyï¼Œåˆ™å½“å‰æ•°æ®æµæ— æ³•å†™å…¥æ•°æ®ã€‚å½“æ•°æ®æµçŠ¶æ€æ­£å¸¸æ—¶ï¼Œåˆåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ol start=1><li>å½“å‰æ•°æ®æµå¯å†™çª—å£å‰©ä½™å¯å†™æ•°æ®å¤§äº0ï¼Œåˆ™è®¡ç®—å¯å†™å­—èŠ‚æ•°ï¼Œå¹¶å°†å½“å‰æ•°æ®æµå¯å†™çª—å£å¤§å°æ¶ˆè€—takeã€‚</li><li>å½“å‰æ•°æ®æµå¯å†™çª—å£å‰©ä½™å¯å†™æ•°æ®å°äºç­‰äº0ï¼Œåˆ™ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°è¢«å”¤é†’å¹¶è¿›å…¥ä¸‹ä¸€æ¬¡æ£€æŸ¥ã€‚</li></ol><p style=text-align:start>ä¸Šé¢çš„ç¬¬äºŒç§æƒ…å†µåœ¨<strong>æ”¶åˆ°http2WindowUpdateFrameæ•°æ®å¸§</strong>è¿™ä¸€èŠ‚ä¸­æåˆ°è¿‡ã€‚</p><p style=text-align:start>serverè¯»å–å½“å‰æ•°æ®æµçš„æ•°æ®åä¼šå‘clientå¯¹åº”æ•°æ®æµå‘é€http2WindowUpdateFrameæ•°æ®å¸§ï¼Œclientæ”¶åˆ°è¯¥æ•°æ®å¸§åä¼šå¢å¤§å¯¹åº”æ•°æ®æµå¯å†™çª—å£ï¼Œå¹¶æ‰§è¡Œcc.cond.Broadcast()å”¤é†’å› å‘é€æ•°æ®å·²è¾¾æµæ§åˆ¶ä¸Šé™è€Œç­‰å¾…çš„æ•°æ®æµç»§ç»­å‘é€æ•°æ®ã€‚</p><p style=text-align:start>ä»¥ä¸Šå°±æ˜¯clientå‘serverå‘é€æ•°æ®çš„æµæ§åˆ¶é€»è¾‘ã€‚</p><h1 class=pgc-h-arrow-right>æ€»ç»“</h1><ol start=1><li>å¸§å¤´é•¿åº¦ä¸º9ä¸ªå­—èŠ‚ï¼Œå¹·åŒ…å«å››ä¸ªéƒ¨åˆ†ï¼šPayloadçš„é•¿åº¦ã€å¸§ç±»å‹ã€å¸§æ ‡è¯†ç¬¦å’Œæ•°æ®æµIDã€‚</li><li>æµæ§åˆ¶å¯åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼šåˆå§‹æ—¶ï¼Œé€šè¿‡http2FrameSettingsæ•°æ®å¸§å’Œhttp2WindowUpdateFrameæ•°æ®å¸§å‘ŠçŸ¥å¯¹æ–¹å½“å‰è¿æ¥è¯»å†™çª—å£å¤§å°ä»¥åŠè¿æ¥ä¸­æ•°æ®æµè¯»å†™çª—å£å¤§å°ã€‚åœ¨è¯»å†™æ•°æ®è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡å‘é€http2WindowUpdateFrameæ•°æ®å¸§æ§åˆ¶å¦ä¸€ç«¯çš„å†™çª—å£å¤§å°ã€‚</li></ol><h1 class=pgc-h-arrow-right>é¢„å‘Š</h1><p style=text-align:start>å‰ç¯‡å’Œä¸­ç¯‡å·²ç»å®Œæˆï¼Œä¸‹ä¸€æœŸå°†å¯¹<strong>http2.0æ ‡å¤´å‹ç¼©</strong>è¿›è¡Œåˆ†æã€‚</p><p style=text-align:start>æœ€åï¼Œè¡·å¿ƒå¸Œæœ›æœ¬æ–‡èƒ½å¤Ÿå¯¹å„ä½è¯»è€…æœ‰ä¸€å®šçš„å¸®åŠ©ã€‚</p><blockquote><p><span style="color:#6a737d;--tt-darkmode-color: #6A737D">æ³¨ï¼šå†™æœ¬æ–‡æ—¶ï¼Œ ç¬”è€…æ‰€ç”¨goç‰ˆæœ¬ä¸º: go1.14.2</span></p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Go','å‘èµ·','HTTP2.0'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>