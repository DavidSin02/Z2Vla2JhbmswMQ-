<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>关于浏览器缓存你知道多少 | 极客快訊</title><meta property="og:title" content="关于浏览器缓存你知道多少 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/f8dea2db19d749d1b0203de3763c8f6c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33ce90a.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33ce90a.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/33ce90a.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33ce90a.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33ce90a.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/33ce90a.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/33ce90a.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33ce90a.html><meta property="article:published_time" content="2020-10-29T21:08:41+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:41+08:00"><meta name=Keywords content><meta name=description content="关于浏览器缓存你知道多少"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/33ce90a.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>关于浏览器缓存你知道多少</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><br></p><p>分享一些实用或有意思的东西，发现代码之美。专注深度和最佳实践，希望打造的是一个高质量的公众号。</p><div class=pgc-img><img alt=关于浏览器缓存你知道多少 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f8dea2db19d749d1b0203de3763c8f6c><p class=pgc-img-caption></p></div><p>在前端开发中，我们在提到性能优化的时候总会提到一点：合理设置缓存。我们该如何从这方面入手来考虑提高网站性能呢？</p><p><br></p><h1 class=pgc-h-arrow-right><strong>前言</strong></h1><p>我们都知道 HTML5 引入了应用程序缓存，可以在没有网络的情况下进行访问，同时，HTML5 还引入了 storage 本地存储。这些都属于应用缓存。</p><p>本篇文章主要内容是和浏览器缓存相关的，也可以说是 HTTP 缓存。</p><h1 class=pgc-h-arrow-right><strong>什么是浏览器缓存</strong></h1><p>MDN 上是这样解释浏览器缓存的：</p><blockquote><p>A browser cache holds all documents downloaded via HTTP by the user ... without requiring an additional trip to the server.</p></blockquote><p>意思就是，浏览器缓存保存着用户通过 HTTP 获取的所有资源，再下一次请求时可以避免重复向服务器发出多余的请求。</p><p>通俗的说，就是在你访问过一次某个网站之后，这个站点的文字、图片等所有资源都被下载到本地了，下次再访问该网站时判断是否满足缓存条件，如果满足就不用再花费时间去等待资源的获取了。</p><h1 class=pgc-h-arrow-right><strong>浏览器缓存的分类</strong></h1><p>一般来说浏览器缓存可以分为两类：</p><ul><li>强缓存</li><li>协商缓存（对比缓存）</li></ul><p>我们需要知道的是，浏览器在加载资源时，会先判断是否命中<strong>强缓存</strong>再验证是命中<strong>协商缓存</strong>。</p><p>其它的的具体细节，稍后会展开来说。</p><h1 class=pgc-h-arrow-right><strong>强缓存</strong></h1><p>浏览器在加载资源时，会先根据本地缓存资源的 header 中的信息判断是否命中强缓存，如果命中则直接使用缓存中的资源不会再向服务器发送请求。</p><div class=pgc-img><img alt=关于浏览器缓存你知道多少 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/eaeeb7ede2b748958ff526a840e8c159><p class=pgc-img-caption></p></div><p>从图中可以看出，强缓存一般是这样一个流程：</p><ol start=1><li>查看 header 头中的 Expire 和 Cache-control 来判断是否满足规则；</li><li>如果满足规则，就返回缓存的数据；</li><li>如果不满足规则，就向服务器发送请求；</li><li>服务器返回数据；</li><li>将新数据存入缓存。</li></ol><p>所以我们主要就是关注 Expire 和 Cache-control 这两个字段。</p><h1 class=pgc-h-arrow-right><strong>Expire</strong></h1><p>同样地，我们看看MDN中如何解释这个字段：</p><blockquote><p>The Expires header contains the date/time after which the response is considered stale.</p></blockquote><p>这个字段包含了一个时间，过了这个时间，响应将会失效。</p><p>也就是说，Expire 这个字段表示缓存到期时间，我们来打开一个网站并查看 Response Header 看看这个字段：</p><ul><li style=text-align:right;list-style-position:inside><br></li></ul><pre><code>Expires:Fri, 27 Oct 2017 07:55:30 GMT</code></pre><p>可能在你查看这的时候发现时间不对啊，怎么都已经是过去了 ~</p><p>GMT 表示的是格林威治时间，和北京时间相差8小时。</p><p>上面的这个时间表示的是 2017年10月27日15:55:30。</p><p>通过设置 Expire 来设置缓存有一个致命缺点：</p><p>可以看出，这个是个绝对时间，也就是说，如果我修改了客户端的本地时间，是不是就会导致判断缓存失效了呢。</p><h1 class=pgc-h-arrow-right><strong>Cache-Control</strong></h1><p>既然不能设置绝对时间，那我就设置个相对时间呗。</p><p>在 HTTP/1.1 中，增加了一个字段 Cache-Control ，它包含一个 max-age 属性，该字段表示资源缓存的最大有效时间，这就是一个相对时间。</p><ul><li style=text-align:right;list-style-position:inside><br></li></ul><pre><code>Cache-Control:max-age=600</code></pre><p>这个表示的就是最大有效时间是 600s ，对的，它的单位是秒。</p><p>Cache-Control 除了 max-age 属性之外还有一些属性：</p><ul><li>no-cache：需要进行协商缓存，发送请求到服务器确认是否使用缓存。</li><li>no-store：禁止使用缓存，每一次都要重新请求数据。</li><li>public：默认设置。</li><li>private：不能被多用户共享。</li></ul><p>现在基本上都会同时设置 Expire 和 Cache-Control ，Cache-Control 的优先级别更高。</p><h1 class=pgc-h-arrow-right><strong>协商缓存</strong></h1><p>当强缓存没有命中的时候，浏览器会发送一个请求到服务器，服务器根据请求头中的部分信息来判断是否命中缓存。如果命中，则返回 304 ，告诉浏览器资源未更新，可使用本地的缓存。</p><div class=pgc-img><img alt=关于浏览器缓存你知道多少 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/92f03689459849e0897b9ef0fda1111c><p class=pgc-img-caption></p></div><p>从图中可以看出，协商缓存一般是这样一个流程：</p><ol start=1><li>把资源标识，比如 If-Modify-Since 或 Etag 发送到服务器，确认资源是否更新；</li><li>如果资源未更新，请求响应返回的http状态为 304 并且会显示一个 Not Modified 的字符串，告诉浏览器使用本地缓存;</li><li>如果资源已经更新，返回新的数据；</li><li>将新数据存入缓存。</li></ol><h1 class=pgc-h-arrow-right><strong>Last-Modified，If-Modified-Since</strong></h1><p>浏览器第一次请求资源的时候，服务器返回的 header 上会带有一个 Last-Modified 字段，表示资源<strong>最后修改</strong>的时间。</p><ul><li style=text-align:right;list-style-position:inside><br></li></ul><pre><code>Last-Modified: Fri, 27 Oct 2017 07:55:30 GMT</code></pre><p>同样的，这是一个 GMT 的绝对时间。</p><p>当浏览器再次请求该资源时，请求头中会带有一个 If-Modified-Since 字段，这个值是第一次请求返回的 Last-Modified 的值。服务器收到这个请求后，将 If-Modified-Since 和当前的 Last-Modified 进行对比。如果相等，则说明资源未修改，返回 304，浏览器使用本地缓存。</p><p>well，这个方法也是有缺点的：</p><ul><li>最小单位是秒。也就是说如果我短时间内资源发生了改变，Last-Modified 并不会发生变化；</li><li>周期性变化。如果这个资源在一个周期内修改回原来的样子了，我们认为是可以使用缓存的，但是 Last-Modified 可不这样认为。</li></ul><p>所以，后来又引入一个 Etag。</p><h1 class=pgc-h-arrow-right><strong>Etag</strong></h1><p>Etag 一般是由文件内容 hash 生成的，也就是说它可以保证资源的唯一性，资源发生改变就会导致Etag 发生改变。</p><p>同样地，在浏览器第一次请求资源时，服务器会返回一个 Etag 标识。当再次请求该资源时， 会通过If-no-match 字段将 Etag 发送回服务器，然后服务器进行比较，如果相等，则返回 304 表示未修改。</p><p>**Last-Modified 和 Etag 是可以同时设置的，服务器会优先校验 Etag，如果 Etag 相等就会继续比对 Last-Modified，最后才会决定是否返回 304。**</p><h1 class=pgc-h-arrow-right><strong>总结</strong></h1><p>当浏览器再次访问一个已经访问过的资源时，它会这样做：</p><ol start=1><li>看看是否命中强缓存，如果命中，就直接使用缓存了；</li><li>如果没有命中强缓存，就发请求到服务器检查是否命中协商缓存；</li><li>如果命中协商缓存，服务器会返回 304 告诉浏览器使用本地缓存；</li><li>否则，返回最新的资源。</li></ol></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'关于','浏览器','缓存'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>