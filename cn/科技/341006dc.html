<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>SpringBootç³»åˆ—ï¼ˆ14ï¼‰ï¼šSpring AOPè£…é€¼æŒ‡å—ä¹‹å®ç°æ“ä½œæ—¥å¿—è®°å½• | æå®¢å¿«è¨Š</title><meta property="og:title" content="SpringBootç³»åˆ—ï¼ˆ14ï¼‰ï¼šSpring AOPè£…é€¼æŒ‡å—ä¹‹å®ç°æ“ä½œæ—¥å¿—è®°å½• - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/7bc702acb84d4284b4df028da09900db"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/341006dc.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/341006dc.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/341006dc.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/341006dc.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/341006dc.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/341006dc.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/341006dc.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/341006dc.html><meta property="article:published_time" content="2020-11-14T21:04:30+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:30+08:00"><meta name=Keywords content><meta name=description content="SpringBootç³»åˆ—ï¼ˆ14ï¼‰ï¼šSpring AOPè£…é€¼æŒ‡å—ä¹‹å®ç°æ“ä½œæ—¥å¿—è®°å½•"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/341006dc.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>SpringBootç³»åˆ—ï¼ˆ14ï¼‰ï¼šSpring AOPè£…é€¼æŒ‡å—ä¹‹å®ç°æ“ä½œæ—¥å¿—è®°å½•</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1>æ‘˜è¦</h1><p>AOP ï¼Œä¹Ÿç§°ä¸º"é¢å‘åˆ‡é¢ç¼–ç¨‹"ï¼Œå…¶å¤§åæ—©å·²å¦‚é›·è´¯è€³ï¼Œæ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œç›¸ä¿¡å„ä½å°ä¼™ä¼´ä¹Ÿæ—©å·²å¬é—»è¿‡ï¼Œå…¶æœ€æ™®éçš„ç”¨æ³•æ˜¯"è®°å½•åº”ç”¨ç³»ç»Ÿä¸šåŠ¡æ¨¡å—çš„æ“ä½œæ—¥å¿—"ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥åˆ†äº«ä»‹ç»ä¸€ä¸‹å¦‚ä½•åˆ©ç”¨Spring AOPå®ç°ä¸šåŠ¡æ¨¡å—æ“ä½œæ—¥å¿—çš„è®°å½•ã€‚</p><h1>å†…å®¹</h1><p>Spring AOPï¼Œæ˜¯"é¢å‘åˆ‡é¢ç¼–ç¨‹"çš„ç®€ç§°ï¼Œå¯ä»¥èµ·åˆ°"è§£è€¦ä¸šåŠ¡æ¨¡å—"çš„ä½œç”¨ï¼Œæ·±å±‚æ¬¡çš„ä½œç”¨å¯ä»¥åˆ©ç”¨ç½‘ä¸Šä¸€ä½åšä¸»æ‰€è¯´çš„ä¸€å¥è¯è¿›è¡Œæ¦‚æ‹¬ï¼Œå³ï¼š</p><p>"AOP å¯ä»¥å®ç°åœ¨ä¸ä¿®æ”¹æºä»£ç çš„æƒ…å†µä¸‹ç»™ç¨‹åºåŠ¨æ€ç»Ÿä¸€æ·»åŠ åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦ç ´åæŸä¸ªæ“ä½œä¸šåŠ¡æ¨¡å—ä»£ç çš„å®Œæ•´æ€§"</p><p>å¯¹äºSpring AOPï¼Œåœ¨è¿™é‡Œæœ‰å¿…è¦å†å•°å—¦ä¸€ç•ªå…¶æ ¸å¿ƒè¦ç´ ï¼Œ"é¢å‘åˆ‡é¢ç¼–ç¨‹"ï¼Œä¸€å¬å°±çŸ¥é“å…¶æ ¸å¿ƒè¦ç´ æ˜¯"åˆ‡é¢"ï¼Œè€Œ"åˆ‡é¢"å¹¶éåªæ˜¯å•çº¯å­˜åœ¨çš„ç©æ„ï¼Œå®ƒç”±ä¸¤å¤§éƒ¨åˆ†ç»„æˆï¼Œ"åˆ‡ç‚¹PointCut"+"é€šçŸ¥Notice"ï¼Œä¸‹é¢ï¼Œè®©æˆ‘ç”¨"é€šä¿—æ˜“æ‡‚"çš„è¯­å¥è¡¨è¾¾å‡ºæ¥å§ï¼š</p><p>"åˆ‡ç‚¹"ï¼šåœ¨ä»€ä¹ˆåœ°æ–¹è§¦å‘æˆ‘ä»¬è‡ªå®šä¹‰çš„æ“ä½œï¼ˆå®šä¹‰çš„æ˜¯"ä½•å¤„"ï¼‰</p><p>"é€šçŸ¥"ï¼šåœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„æ“ä½œï¼ŒåŒæ—¶å®šä¹‰å¥½"è‡ªå®šä¹‰çš„æ“ä½œ"å…·ä½“æ˜¯ä»€ä¹ˆï¼</p><p>"åˆ‡é¢"ï¼šåˆ‡ç‚¹ + é€šçŸ¥ï¼›å³åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œåœ¨å“ªä¸ªåœ°æ–¹è§¦å‘æ‰§è¡Œä»€ä¹ˆæ ·çš„æ“ä½œï¼</p><p>å¥½äº†ï¼Œè‹¥éœ€è¦å…·ä½“çš„ã€æ·±å±‚æ¬¡çš„å…³äºä¸“ä¸šæœ¯è¯­çš„ä»‹ç»ã€å‰–æï¼Œå¯ä»¥ä¸Šå®˜ç½‘æˆ–è€…åšå®¢æ‰¾æ‰¾ç›¸åº”çš„ä»‹ç»å§ï¼ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥å®é™…çš„ä»£ç å®æˆ˜è¿‡ç¨‹ï¼</p><p>ï¼ˆ1ï¼‰é¦–å…ˆï¼Œæˆ‘ä»¬å½“ç„¶éœ€è¦å»ºç«‹ä¸€ä¸ª"è®°å½•æ—¥å¿—çš„æ•°æ®åº“è¡¨"ï¼Œsys_logï¼Œå…¶DDLå®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre>CREATE TABLE `sys_log` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `username` varchar(50) DEFAULT NULL COMMENT 'ç”¨æˆ·å', `operation` varchar(50) DEFAULT NULL COMMENT 'ç”¨æˆ·æ“ä½œ', `method` varchar(200) DEFAULT NULL COMMENT 'è¯·æ±‚æ–¹æ³•', `params` varchar(5000) DEFAULT NULL COMMENT 'è¯·æ±‚å‚æ•°', `time` bigint(20) NOT NULL COMMENT 'æ‰§è¡Œæ—¶é•¿(æ¯«ç§’)', `ip` varchar(64) DEFAULT NULL COMMENT 'IPåœ°å€', `create_date` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´', PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='ç³»ç»Ÿæ—¥å¿—';</pre><p>ç„¶åï¼Œé‡‡ç”¨Mybatisé€†å‘å·¥ç¨‹ç”Ÿæˆç›¸åº”çš„Entityã€Mapperã€Mapper.xmlï¼Œä¹‹åä¾¿æ˜¯ç­‰å¾…ç€è¢«è°ƒç”¨ï¼</p><p>ï¼ˆ2ï¼‰ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ³¨è§£LogAnnotationï¼Œè¿™ä¸ªæ³¨è§£å°†ç”¨äºåº”ç”¨ç³»ç»Ÿä¸­"æ‰€æœ‰éœ€è¦è§¦å‘è®°å½•æ—¥å¿—"çš„æ“ä½œæ¨¡å—å¯¹åº”çš„æ–¹æ³•ä¹‹ä¸Šï¼Œåœ¨åé¢å¤§å®¶ä¼šå‘ç°ï¼Œæ­£æ˜¯è¿™ç§æ–¹å¼ï¼Œæ‰å®ç°äº†æ‰€è°“çš„"æœåŠ¡æ¨¡å—è§£è€¦"ã€"åœ¨ä¸ä¿®æ”¹æºä»£ç çš„æƒ…å†µä¸‹ç»™ç¨‹åºåŠ¨æ€ç»Ÿä¸€æ·»åŠ åŠŸèƒ½"çš„ä½œç”¨ã€‚å…¶å®Œæ•´æºä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre>@Target(ElementType.METHOD)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface LogAnnotation {	//valueå°†ç”¨äºå­˜å‚¨ â€œå…·ä½“çš„æ“ä½œæ¨¡å—çš„æ“ä½œæè¿°â€ String value() default "";}</pre><p>ï¼ˆ3ï¼‰ç´§æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªé‡é‡çº§çš„ä¸œè¥¿ï¼Œå³"åˆ‡é¢"ï¼Œè¿™ä¸ªåˆ‡é¢æ˜¯åŸºäºAspectJæ³¨è§£å®ç°çš„ç±»LogAspectï¼Œå…¶å®Œæ•´æºä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre>/** * æ—¥å¿—åˆ‡é¢ = åˆ‡ç‚¹+é€šçŸ¥ * @Author:debug (SteadyJack) * @Link: weixin-&gt; debug0868 qq-&gt; 1948831260 * @Date: 2019/11/7 15:18 **/@Aspect@Componentpublic class LogAspect { private static final Logger log= LoggerFactory.getLogger(LogAspect.class); @Autowired private SysLogMapper sysLogMapper; @Autowired private ObjectMapper objectMapper; //å®šä¹‰åˆ‡ç‚¹:å‘ç”Ÿçš„æ—¶æœº - å³ä¸€æ—¦åŠ äº†è¿™ä¸ªæ³¨è§£ï¼Œå°†è§¦å‘æŸäº›äº‹æƒ… @Pointcut("@annotation(com.debug.springboot.server.annotation.LogAnnotation)") public void logPointCut(){} //å®šä¹‰é€šçŸ¥ï¼šç¯ç»•é€šçŸ¥ - æ‰§è¡Œæ ¸å¿ƒä»»åŠ¡ä¹‹å‰ + æ‰§è¡Œå®Œæ ¸å¿ƒä»»åŠ¡ä¹‹å è¯¥åšçš„äº‹æƒ… @Around("logPointCut()") public Object around(ProceedingJoinPoint joinPoint) throws Throwable{ long start=System.currentTimeMillis(); //TODO:æ‰§è¡Œæ ¸å¿ƒä»»åŠ¡ Object object=joinPoint.proceed(); long time=System.currentTimeMillis()-start; saveLog(joinPoint,time); return object; } //TODO:ä¿å­˜æ“ä½œæ—¥å¿— private void saveLog(ProceedingJoinPoint point,Long time) throws Exception{ log.info("å¼€å§‹è§¦å‘-ä¿å­˜æ“ä½œæ—¥å¿—"); MethodSignature signature= (MethodSignature) point.getSignature(); Method method=signature.getMethod(); SysLog entity=new SysLog(); //TODO:è·å–è¯·æ±‚æ“ä½œçš„æè¿°ä¿¡æ¯ LogAnnotation annotation=method.getAnnotation(LogAnnotation.class); if (annotation!=null){ entity.setOperation(annotation.value()); } //TODO:è·å–æ“ä½œæ–¹æ³•å String className=point.getTarget().getClass().getName(); String methodName=signature.getName(); entity.setMethod(className + "." + methodName + "()"); //TODO:è·å–è¯·æ±‚å‚æ•° Object[] args=point.getArgs(); entity.setParams(objectMapper.writeValueAsString(args[0])); //TODO:è·å–å‰©ä½™å‚æ•° entity.setTime(time); entity.setCreateDate(DateTime.now().toDate()); entity.setUsername("debug"); entity.setIp("localhost"); sysLogMapper.insertSelective(entity); }}</pre><p>ï¼ˆ3ï¼‰æœ€åï¼Œæˆ‘ä»¬åœ¨MultipartSourceController ä¸­å†™ä¸ªè¯·æ±‚æ–¹æ³•ï¼Œå¹¶åœ¨è¯¥è¯·æ±‚æ–¹æ³•ä¸ŠåŠ å…¥æ—¥å¿—æ³¨è§£ï¼Œç”¨äºè®°å½•è¯¥è¯·æ±‚æ–¹æ³•åœ¨æ‰§è¡Œå‰ã€åã€æ‰§è¡Œä¸­çš„è½¨è¿¹å’Œç›¸åº”çš„å‚æ•°ã€‚å®Œæ•´çš„æºä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre> @LogAnnotation("å¤šæ•°æ®æºæ—¶-è·¨äº‹åŠ¡-æ—¥å¿—æ“ä½œ") @RequestMapping(value = "update",method = RequestMethod.POST,consumes = MediaType.APPLICATION_JSON_UTF8_VALUE) public BaseResponse update(@RequestBody LogUpdateDto dto) throws Exception{ BaseResponse response=new BaseResponse(StatusCode.Success); User user=new User(); user.setName(dto.getName()); user.setCode(dto.getCode()); userMapper.insertSelective(user); return response; }</pre><p>è€ŒLogUpdateDtoåªæ˜¯ä¸€ä¸ªç®€å•çš„å®ä½“ç±»ï¼š</p><pre>/** * @Author:debug (SteadyJack) * @Link: weixin-&gt; debug0868 qq-&gt; 1948831260 * @Date: 2019/11/7 16:14 **/@Datapublic class LogUpdateDto implements Serializable{ @NotBlank private String name; @NotBlank private String code;}</pre><p>ï¼ˆ4ï¼‰æœ€åï¼Œæˆ‘ä»¬å°†æ•´ä¸ªç³»ç»Ÿè·‘èµ·æ¥ï¼Œç„¶ååœ¨Postmanå‘èµ·ç›¸åº”çš„è¯·æ±‚ï¼Œè¯·æ±‚å®Œæˆåï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®åº“è¡¨sys_logä¸­è®°å½•äº†ç›¸åº”çš„è¯·æ±‚è½¨è¿¹ä»¥åŠç›¸åº”çš„è¯·æ±‚å‚æ•°ç­‰ç­‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt="SpringBootç³»åˆ—ï¼ˆ14ï¼‰ï¼šSpring AOPè£…é€¼æŒ‡å—ä¹‹å®ç°æ“ä½œæ—¥å¿—è®°å½•" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7bc702acb84d4284b4df028da09900db><p class=pgc-img-caption></p></div><p>å¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« æˆ‘ä»¬å°±ä»‹ç»åˆ°è¿™é‡Œäº†ï¼Œå…¶ä»–ç›¸å…³çš„æŠ€æœ¯ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥ç§ä¿¡ã€‚</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'SpringBoot','14','Spring'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>