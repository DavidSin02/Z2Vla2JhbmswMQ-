<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>é¢è¯•å®˜ï¼šé—®ä½ ä¸€ä¸ªï¼ŒSpringäº‹åŠ¡æ˜¯å¦‚ä½•ä¼ æ’­çš„ï¼Ÿ | æå®¢å¿«è¨Š</title><meta property="og:title" content="é¢è¯•å®˜ï¼šé—®ä½ ä¸€ä¸ªï¼ŒSpringäº‹åŠ¡æ˜¯å¦‚ä½•ä¼ æ’­çš„ï¼Ÿ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/6513100097ce4d27b1df49cd347e4d88"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/358ab5f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/358ab5f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/358ab5f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/358ab5f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/358ab5f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/358ab5f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/358ab5f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/358ab5f.html><meta property="article:published_time" content="2020-10-29T20:50:41+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:41+08:00"><meta name=Keywords content><meta name=description content="é¢è¯•å®˜ï¼šé—®ä½ ä¸€ä¸ªï¼ŒSpringäº‹åŠ¡æ˜¯å¦‚ä½•ä¼ æ’­çš„ï¼Ÿ"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/358ab5f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>é¢è¯•å®˜ï¼šé—®ä½ ä¸€ä¸ªï¼ŒSpringäº‹åŠ¡æ˜¯å¦‚ä½•ä¼ æ’­çš„ï¼Ÿ</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>æ¨èå­¦ä¹ </h1><ul><li><a class=pgc-link data-content=mp data-source=innerLink href="https://www.toutiao.com/i6844768153789006339/?group_id=6844768153789006339" rel="noopener noreferrer" target=_blank>è‚äº†åå¤©åŠæœˆï¼ŒçŒ®ä¸Šçº¯æ‰‹ç»˜â€œSpring/Cloud/Boot/MVCâ€å…¨å®¶æ¡¶è„‘å›¾</a></li><li><a class=pgc-link data-content=mp data-source=innerLink href="https://www.toutiao.com/i6876044225012892163/?group_id=6876044225012892163" rel="noopener noreferrer" target=_blank>ç–¯ç‹‚è†œæ‹œï¼é˜¿é‡Œå‡ºå“Spring Securityç‹è€…æ™‹çº§æ–‡æ¡£</a></li><li><a class=pgc-link data-content=mp data-source=innerLink href="https://www.toutiao.com/i6865671837171319299/?group_id=6865671837171319299" rel="noopener noreferrer" target=_blank>çœŸé¦™è­¦å‘Šï¼Alibabaçè—ç‰ˆmybatisæ‰‹å†™æ–‡æ¡£ï¼Œåˆ·èµ·æ¥</a></li></ul><div class=pgc-img><img alt=é¢è¯•å®˜ï¼šé—®ä½ ä¸€ä¸ªï¼ŒSpringäº‹åŠ¡æ˜¯å¦‚ä½•ä¼ æ’­çš„ï¼Ÿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6513100097ce4d27b1df49cd347e4d88><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">å‰è¨€</span></h1><p style=text-align:start>Springäº‹åŠ¡æ˜¯å¦‚ä½•ä¼ æ’­çš„ï¼Ÿ</p><p style=text-align:start>å…¶å®<span style="color:#4d4d4d;--tt-darkmode-color: #999999">ä¹‹å‰æœ‰åˆ†æäº‹åŠ¡æ³¨è§£çš„è§£æè¿‡ç¨‹ï¼Œæœ¬è´¨ä¸Šæ˜¯å°†äº‹åŠ¡å°è£…ä¸ºåˆ‡é¢åŠ å…¥åˆ°AOPçš„æ‰§è¡Œé“¾ä¸­ï¼Œå› æ­¤ä¼šè°ƒç”¨åˆ°MethodInceptorçš„å®ç°ç±»çš„invokeæ–¹æ³•ï¼Œè€Œäº‹åŠ¡åˆ‡é¢çš„Interceptorå°±æ˜¯</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">TransactionInterceptor</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œæ‰€ä»¥æœ¬ç¯‡ç›´æ¥ä»è¯¥ç±»å¼€å§‹ã€‚</span></p><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">äº‹åŠ¡</span><span style="color:#4f4f4f;--tt-darkmode-color: #979797">åˆ‡é¢çš„è°ƒç”¨è¿‡ç¨‹</span></h1><pre><code>	public Object invoke(MethodInvocation invocation) throws Throwable {		// Work out the target class: may be {@code null}.		// The TransactionAttributeSource should be passed the target class		// as well as the method, which may be from an interface.		Class&lt;?&gt; targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null);		// Adapt to TransactionAspectSupport's invokeWithinTransaction...		return invokeWithinTransaction(invocation.getMethod(), targetClass, invocation::proceed);	}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿™ä¸ªæ–¹æ³•æœ¬èº«æ²¡åšä»€ä¹ˆäº‹ï¼Œä¸»è¦æ˜¯è°ƒç”¨äº†çˆ¶ç±»çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">invokeWithinTransaction</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ï¼Œæ³¨æ„æœ€åä¸€ä¸ªå‚æ•°ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ªlambdaè¡¨è¾¾å¼ï¼Œè€Œè¿™ä¸ªè¡¨è¾¾å¼ä¸­çš„è°ƒç”¨çš„æ–¹æ³•åº”è¯¥ä¸é™Œç”Ÿï¼Œåœ¨åˆ†æAOPè°ƒç”¨é“¾æ—¶ï¼Œå°±æ˜¯é€šè¿‡è¿™ä¸ªæ–¹æ³•</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªåˆ‡é¢</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æˆ–æ˜¯</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è°ƒç”¨è¢«ä»£ç†å®ä¾‹çš„æ–¹æ³•</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œå¿˜è®°äº†çš„å¯ä»¥å›å»çœ‹çœ‹ã€‚</span></p><pre><code>	protected Object invokeWithinTransaction(Method method, @Nullable Class&lt;?&gt; targetClass,			final InvocationCallback invocation) throws Throwable {		// If the transaction attribute is null, the method is non-transactional.		//è·å–äº‹åŠ¡å±æ€§ç±» AnnotationTransactionAttributeSource		TransactionAttributeSource tas = getTransactionAttributeSource();		//è·å–æ–¹æ³•ä¸Šé¢æœ‰@Transactionalæ³¨è§£çš„å±æ€§		final TransactionAttribute txAttr = (tas != null ? tas.getTransactionAttribute(method, targetClass) : null);		//è·å–äº‹åŠ¡ç®¡ç†å™¨		final PlatformTransactionManager tm = determineTransactionManager(txAttr);		final String joinpointIdentification = methodIdentification(method, targetClass, txAttr);		if (txAttr == null || !(tm instanceof CallbackPreferringPlatformTransactionManager)) {			TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);			Object retVal = null;			try {				// è°ƒç”¨proceedæ–¹æ³•				retVal = invocation.proceedWithInvocation();			}			catch (Throwable ex) {				// target invocation exception				//äº‹åŠ¡å›æ»š				completeTransactionAfterThrowing(txInfo, ex);				throw ex;			}			finally {				cleanupTransactionInfo(txInfo);			}			//äº‹åŠ¡æäº¤			commitTransactionAfterReturning(txInfo);			return retVal;		}			// çœç•¥äº†else	}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿™ä¸ªæ–¹æ³•é€»è¾‘å¾ˆæ¸…æ™°ï¼Œä¸€ç›®äº†ç„¶ï¼Œifé‡Œé¢å°±æ˜¯å¯¹å£°æ˜å¼äº‹åŠ¡çš„å¤„ç†ï¼Œå…ˆè°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">createTransactionIfNecessary</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•å¼€å¯äº‹åŠ¡ï¼Œç„¶åé€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">invocation.proceedWithInvocation</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è°ƒç”¨ä¸‹ä¸€ä¸ªåˆ‡é¢ï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒåˆ‡é¢äº†ï¼Œå°±æ˜¯è°ƒç”¨è¢«ä»£ç†ç±»çš„æ–¹æ³•ï¼Œå‡ºç°å¼‚å¸¸å°±å›æ»šï¼Œå¦åˆ™æäº¤äº‹åŠ¡ï¼Œè¿™å°±æ˜¯Springäº‹åŠ¡åˆ‡é¢çš„æ‰§è¡Œè¿‡ç¨‹ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸»è¦è¦ææ‡‚çš„å°±æ˜¯åœ¨è¿™äº›æ–¹æ³•ä¸­æ˜¯å¦‚ä½•ç®¡ç†äº‹åŠ¡ä»¥åŠäº‹åŠ¡åœ¨å¤šä¸ªæ–¹æ³•ä¹‹é—´æ˜¯å¦‚ä½•ä¼ æ’­çš„ã€‚</span></p><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">äº‹åŠ¡çš„ä¼ æ’­æ€§æ¦‚å¿µ</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ä¼ æ’­æ€§æ˜¯Springè‡ªå·±æå‡ºæ¥çš„ï¼Œæ•°æ®åº“æ˜¯æ²¡æœ‰çš„ï¼Œå› ä¸ºæ¶‰åŠåˆ°æ–¹æ³•é—´çš„è°ƒç”¨ï¼Œé‚£ä¹ˆå¿…ç„¶å°±éœ€è¦è€ƒè™‘äº‹åŠ¡åœ¨è¿™äº›æ–¹æ³•ä¹‹é—´å¦‚ä½•æµè½¬ï¼Œæ‰€ä»¥Springæä¾›äº†7ä¸ªä¼ æ’­å±æ€§ä¾›é€‰æ‹©ï¼Œå¯ä»¥å°†å…¶çœ‹æˆä¸¤å¤§ç±»ï¼Œå³æ˜¯å¦æ”¯æŒå½“å‰äº‹åŠ¡ï¼š</span></p><ol start=1><li>æ”¯æŒå½“å‰äº‹åŠ¡ï¼ˆåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼‰ï¼š</li></ol><blockquote><p><span style="background-color:#eef0f4;--tt-darkmode-bgcolor: #BDBEC1">PROPAGATION_REQUIREDï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ã€‚PROPAGATION_MANDATORYï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ã€‚PROPAGATION_SUPPORTSï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¸ä½¿ç”¨äº‹åŠ¡ã€‚</span></p></blockquote><ol start=2><li>ä¸æ”¯æŒå½“å‰äº‹åŠ¡ï¼ˆä¸åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼‰ï¼š</li></ol><blockquote><p><span style="background-color:#eef0f4;--tt-darkmode-bgcolor: #BDBEC1">PROPAGATION_NEVERï¼šä»¥éäº‹åŠ¡çš„æ–¹å¼è¿è¡Œï¼Œå¦‚æœæœ‰äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚PROPAGATION_NOT_SUPPORTEDï¼šä»¥éäº‹åŠ¡çš„æ–¹å¼è¿è¡Œï¼Œå¦‚æœæœ‰äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚PROPAGATION_REQUIRES_NEWï¼šæ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœæœ‰äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ï¼ˆä¸¤ä¸ªäº‹åŠ¡ç›¸äº’ç‹¬ç«‹ï¼Œçˆ¶äº‹åŠ¡å›æ»šä¸å½±å“å­äº‹åŠ¡ï¼‰ã€‚PROPAGATION_NESTEDï¼šå¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨ï¼Œåˆ™åµŒå¥—äº‹åŠ¡æ‰§è¡Œï¼ˆæŒ‡å¿…é¡»ä¾å­˜çˆ¶äº‹åŠ¡ï¼Œå­äº‹åŠ¡ä¸èƒ½å•ç‹¬æäº¤ä¸”çˆ¶äº‹åŠ¡å›æ»šåˆ™å­äº‹åŠ¡ä¹Ÿå¿…é¡»å›æ»šï¼Œè€Œå­äº‹åŠ¡è‹¥å›æ»šï¼Œçˆ¶äº‹åŠ¡å¯ä»¥å›æ»šä¹Ÿå¯ä»¥æ•è·å¼‚å¸¸ï¼‰ã€‚å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™è¿›è¡Œä¸PROPAGATION_REQUIREDç±»ä¼¼çš„æ“ä½œã€‚</span></p></blockquote><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">åˆ«çœ‹å±æ€§è¿™ä¹ˆå¤šï¼Œå®é™…ä¸Šæˆ‘ä»¬ä¸»è¦ç”¨çš„æ˜¯</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_REQUIRED</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">é»˜è®¤å±æ€§ï¼Œä¸€äº›ç‰¹æ®Šä¸šåŠ¡ä¸‹å¯èƒ½ä¼šç”¨åˆ°</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_REQUIRES_NEW</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ä»¥åŠ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_NESTED</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ã€‚ä¸‹é¢æˆ‘ä¼šå‡è®¾ä¸€ä¸ªåœºæ™¯ï¼Œå¹¶ä¸»è¦åˆ†æè¿™ä¸‰ä¸ªå±æ€§ã€‚</span></p><pre><code>public class A {		@Autowired	private B b;	@Transactional	public void addA() {		b.addB();	}}public class B {	@Transactional	public void addB() {		// doSomething...	}}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ä¸Šé¢æˆ‘åˆ›å»ºäº†Aã€Bä¸¤ä¸ªç±»ï¼Œæ¯ä¸ªç±»ä¸­æœ‰ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ï¼Œä½¿ç”¨äº†å£°æ˜å¼äº‹åŠ¡å¹¶é‡‡ç”¨çš„é»˜è®¤ä¼ æ’­å±æ€§ï¼Œåœ¨Aä¸­è°ƒç”¨äº†Bçš„æ–¹æ³•ã€‚<br>å½“è¯·æ±‚æ¥äº†è°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addA</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ—¶ï¼Œé¦–å…ˆè°ƒç”¨çš„æ˜¯ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå› æ­¤ä¼šè¿›å…¥</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">createTransactionIfNecessary</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•å¼€å¯äº‹åŠ¡ï¼š</span></p><pre><code>	protected TransactionInfo createTransactionIfNecessary(@Nullable PlatformTransactionManager tm,			@Nullable TransactionAttribute txAttr, final String joinpointIdentification) {		// If no name specified, apply method identification as transaction name.		if (txAttr != null &amp;&amp; txAttr.getName() == null) {			txAttr = new DelegatingTransactionAttribute(txAttr) {				@Override				public String getName() {					return joinpointIdentification;				}			};		}		TransactionStatus status = null;		if (txAttr != null) {			if (tm != null) {				//å¼€å¯äº‹åŠ¡ï¼Œè¿™é‡Œé‡ç‚¹çœ‹				status = tm.getTransaction(txAttr);			}			else {			}		}		//åˆ›å»ºäº‹åŠ¡ä¿¡æ¯å¯¹è±¡ï¼Œè®°å½•æ–°è€äº‹åŠ¡ä¿¡æ¯å¯¹è±¡		return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);	}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å®é™…ä¸Šå¼€å¯äº‹åŠ¡æ˜¯é€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">AbstractPlatformTransactionManager</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">åšçš„ï¼Œè€Œè¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…·ä½“å®ä¾‹åŒ–çš„å¯¹è±¡å°±æ˜¯æˆ‘ä»¬åœ¨é¡¹ç›®é‡Œå¸¸é…ç½®çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">DataSourceTransactionManager</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡ã€‚</span></p><pre><code>	public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException {		//è¿™é‡Œé‡ç‚¹çœ‹ï¼Œ.DataSourceTransactionObjectæ‹¿åˆ°å¯¹è±¡		Object transaction = doGetTransaction();		// Cache debug flag to avoid repeated checks.		boolean debugEnabled = logger.isDebugEnabled();		if (definition == null) {			// Use defaults if no transaction definition given.			definition = new DefaultTransactionDefinition();		}		//ç¬¬ä¸€æ¬¡è¿›æ¥connectionHolderä¸ºç©ºçš„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨äº‹åŠ¡		if (isExistingTransaction(transaction)) {			// Existing transaction found -&gt; check propagation behavior to find out how to behave.			return handleExistingTransaction(definition, transaction, debugEnabled);		}		// Check definition settings for new transaction.		if (definition.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) {			throw new InvalidTimeoutException("Invalid transaction timeout", definition.getTimeout());		}		// No existing transaction found -&gt; check propagation behavior to find out how to proceed.		if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) {			throw new IllegalTransactionStateException(					"No existing transaction found for transaction marked with propagation 'mandatory'");		}		//ç¬¬ä¸€æ¬¡è¿›æ¥å¤§éƒ¨åˆ†ä¼šèµ°è¿™é‡Œ		else if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||				definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||				definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) {			//å…ˆæŒ‚èµ·			SuspendedResourcesHolder suspendedResources = suspend(null);				if (debugEnabled) {					logger.debug("Creating new transaction with name [" + definition.getName() + "]: " + definition);				}				try {					boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);					//åˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œå…¶å®å°±æ˜¯å°è£…äº†äº‹åŠ¡å¯¹è±¡çš„ä¸€äº›ä¿¡æ¯ï¼Œè®°å½•äº‹åŠ¡çŠ¶æ€çš„					DefaultTransactionStatus status = newTransactionStatus(							definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);					//å¼€å¯äº‹åŠ¡,é‡ç‚¹çœ‹çœ‹ DataSourceTransactionObject					doBegin(transaction, definition);					//å¼€å¯äº‹åŠ¡åï¼Œæ”¹å˜äº‹åŠ¡çŠ¶æ€					prepareSynchronization(status, definition);					return status;			}			catch (RuntimeException | Error ex) {				resume(null, suspendedResources);				throw ex;			}		}		else {			boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);			return prepareTransactionStatus(definition, null, true, newSynchronization, debugEnabled, null);		}	}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿™ä¸ªæ–¹æ³•æµç¨‹æ¯”è¾ƒé•¿ï¼Œä¸€æ­¥æ­¥æ¥çœ‹ï¼Œå…ˆè°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">doGetTransaction</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•è·å–ä¸€ä¸ª</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">DataSourceTransactionObject</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡ï¼Œè¿™ä¸ªç±»æ˜¯</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">JdbcTransactionObjectSupport</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">çš„å­ç±»ï¼Œåœ¨çˆ¶ç±»ä¸­æŒæœ‰äº†ä¸€ä¸ª</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ConnectionHolder</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡ï¼Œè§åçŸ¥æ„ï¼Œè¿™ä¸ªå¯¹è±¡ä¿å­˜äº†å½“å‰çš„è¿æ¥ã€‚</span></p><pre><code>	protected Object doGetTransaction() {		//ç®¡ç†connectionå¯¹è±¡ï¼Œåˆ›å»ºå›æ»šç‚¹ï¼ŒæŒ‰ç…§å›æ»šç‚¹å›æ»šï¼Œé‡Šæ”¾å›æ»šç‚¹		DataSourceTransactionObject txObject = new DataSourceTransactionObject();		//DataSourceTransactionManageré»˜è®¤æ˜¯å…è®¸åµŒå¥—äº‹åŠ¡çš„		txObject.setSavepointAllowed(isNestedTransactionAllowed());		//obtainDataSource() è·å–æ•°æ®æºå¯¹è±¡ï¼Œå…¶å®å°±æ˜¯æ•°æ®åº“è¿æ¥å—å¯¹è±¡		ConnectionHolder conHolder =				(ConnectionHolder) TransactionSynchronizationManager.getResource(obtainDataSource());		txObject.setConnectionHolder(conHolder, false);		return txObject;	}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿½æº¯</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">getResource</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•å¯ä»¥çœ‹åˆ°</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ConnectionHolder æ˜¯ä»ThreadLocal</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">é‡Œè·å–çš„ï¼Œä¹Ÿå°±æ˜¯</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å½“å‰çº¿ç¨‹</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œkeyæ˜¯</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">DataSource</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡ï¼›ä½†æ˜¯ä»”ç»†æ€è€ƒä¸‹æˆ‘ä»¬æ˜¯ç¬¬ä¸€æ¬¡è¿›æ¥ï¼Œæ‰€ä»¥è¿™é‡Œè‚¯å®šè·å–ä¸åˆ°çš„ï¼Œåä¹‹ï¼Œè¦ä»è¿™é‡Œè·å–åˆ°å€¼ï¼Œé‚£å¿…ç„¶æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ç¬¬äºŒæ¬¡åŠä»¥åè¿›å…¥åˆ°è¿™é‡Œï¼Œä¹Ÿå°±æ˜¯åœ¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addA</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addB</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ—¶ï¼Œå¦å¤–éœ€è¦æ³¨æ„è¿™é‡Œä¿å­˜</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ConnectionHolder</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">åˆ°</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">DataSourceTransactionObject</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡æ—¶æ˜¯å°†</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">newConnectionHolder</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å±æ€§è®¾ç½®ä¸º</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">false</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">äº†çš„ã€‚<br>ç»§ç»­å¾€åï¼Œåˆ›å»ºå®Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">transaction</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡åï¼Œä¼šè°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">isExistingTransaction</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">åˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå¦‚æœå­˜åœ¨å°±ä¼šè°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">handleExistingTransaction</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å¤„ç†äº‹åŠ¡ä¼ æ’­çš„æ ¸å¿ƒæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ç¬¬ä¸€æ¬¡è¿›æ¥ï¼Œè‚¯å®šä¸å­˜åœ¨äº‹åŠ¡ï¼Œæ‰€ä»¥å…ˆè·³è¿‡ã€‚<br>å†å¾€åï¼Œå¯ä»¥çœ‹åˆ°å°±æ˜¯å¤„ç†ä¸åŒçš„ä¼ æ’­å±æ€§ï¼Œä¸»è¦çœ‹åˆ°ä¸‹é¢è¿™ä¸ªéƒ¨åˆ†ï¼š</span></p><pre><code>		else if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||				definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||				definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) {			//å…ˆæŒ‚èµ·			SuspendedResourcesHolder suspendedResources = suspend(null);				if (debugEnabled) {					logger.debug("Creating new transaction with name [" + definition.getName() + "]: " + definition);				}				try {					boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);					//åˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œå…¶å®å°±æ˜¯å°è£…äº†äº‹åŠ¡å¯¹è±¡çš„ä¸€äº›ä¿¡æ¯ï¼Œè®°å½•äº‹åŠ¡çŠ¶æ€çš„					DefaultTransactionStatus status = newTransactionStatus(							definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);					//å¼€å¯äº‹åŠ¡,é‡ç‚¹çœ‹çœ‹ DataSourceTransactionObject					doBegin(transaction, definition);					//å¼€å¯äº‹åŠ¡åï¼Œæ”¹å˜äº‹åŠ¡çŠ¶æ€					prepareSynchronization(status, definition);					return status;			}			catch (RuntimeException | Error ex) {				resume(null, suspendedResources);				throw ex;			}		}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ç¬¬ä¸€æ¬¡è¿›æ¥æ—¶ï¼Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_REQUIRED</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ã€</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_REQUIRES_NEW</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å’Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_NESTED</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">éƒ½ä¼šè¿›å…¥åˆ°è¿™é‡Œï¼Œé¦–å…ˆä¼šè°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">suspend</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æŒ‚èµ·å½“å‰å­˜åœ¨çš„äº‹åŠ¡ï¼Œåœ¨è¿™é‡Œæ²¡å•¥ä½œç”¨ã€‚æ¥ä¸‹æ¥é€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">newTransactionStatus</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">åˆ›å»ºäº†</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">DefaultTransactionStatus</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸»è¦å°±æ˜¯å­˜å‚¨å½“å‰äº‹åŠ¡çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">newTransaction</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å±æ€§è®¾ç½®ä¸ºäº†</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">true</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªæ–°äº‹åŠ¡ã€‚çŠ¶æ€å¯¹è±¡åˆ›å»ºå¥½ä¹‹åå°±æ˜¯é€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">doBegin</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¼€å¯äº‹åŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ª</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ¨¡æ¿æ–¹æ³•</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼š</span></p><pre><code>	protected void doBegin(Object transaction, TransactionDefinition definition) {		DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;		Connection con = null;		try {			//å¦‚æœæ²¡æœ‰æ•°æ®åº“è¿æ¥			if (!txObject.hasConnectionHolder() ||					txObject.getConnectionHolder().isSynchronizedWithTransaction()) {				//ä»è¿æ¥æ± é‡Œé¢è·å–è¿æ¥				Connection newCon = obtainDataSource().getConnection();				if (logger.isDebugEnabled()) {					logger.debug("Acquired Connection [" + newCon + "] for JDBC transaction");				}				//æŠŠè¿æ¥åŒ…è£…æˆConnectionHolderï¼Œç„¶åè®¾ç½®åˆ°äº‹åŠ¡å¯¹è±¡ä¸­				txObject.setConnectionHolder(new ConnectionHolder(newCon), true);			}			txObject.getConnectionHolder().setSynchronizedWithTransaction(true);			con = txObject.getConnectionHolder().getConnection();			//ä»æ•°æ®åº“è¿æ¥ä¸­è·å–éš”ç¦»çº§åˆ«			Integer previousIsolationLevel = DataSourceUtils.prepareConnectionForTransaction(con, definition);			txObject.setPreviousIsolationLevel(previousIsolationLevel);			// Switch to manual commit if necessary. This is very expensive in some JDBC drivers,			// so we don't want to do it unnecessarily (for example if we've explicitly			// configured the connection pool to set it already).			if (con.getAutoCommit()) {				txObject.setMustRestoreAutoCommit(true);				if (logger.isDebugEnabled()) {					logger.debug("Switching JDBC Connection [" + con + "] to manual commit");				}				//å…³é—­è¿æ¥çš„è‡ªåŠ¨æäº¤ï¼Œå…¶å®è¿™æ­¥å°±æ˜¯å¼€å¯äº†äº‹åŠ¡				con.setAutoCommit(false);			}			//è®¾ç½®åªè¯»äº‹åŠ¡ ä»è¿™ä¸€ç‚¹è®¾ç½®çš„æ—¶é—´ç‚¹å¼€å§‹ï¼ˆæ—¶é—´ç‚¹aï¼‰åˆ°è¿™ä¸ªäº‹åŠ¡ç»“æŸçš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–äº‹åŠ¡æ‰€æäº¤çš„æ•°æ®ï¼Œè¯¥äº‹åŠ¡å°†çœ‹ä¸è§ï¼			//è®¾ç½®åªè¯»äº‹åŠ¡å°±æ˜¯å‘Šè¯‰æ•°æ®åº“ï¼Œæˆ‘è¿™ä¸ªäº‹åŠ¡å†…æ²¡æœ‰æ–°å¢ï¼Œä¿®æ”¹ï¼Œåˆ é™¤æ“ä½œåªæœ‰æŸ¥è¯¢æ“ä½œï¼Œä¸éœ€è¦æ•°æ®åº“é”ç­‰æ“ä½œï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›			prepareTransactionalConnection(con, definition);			//è‡ªåŠ¨æäº¤å…³é—­äº†ï¼Œå°±è¯´æ˜å·²ç»å¼€å¯äº‹åŠ¡äº†ï¼Œäº‹åŠ¡æ˜¯æ´»åŠ¨çš„			txObject.getConnectionHolder().setTransactionActive(true);			int timeout = determineTimeout(definition);			if (timeout != TransactionDefinition.TIMEOUT_DEFAULT) {				txObject.getConnectionHolder().setTimeoutInSeconds(timeout);			}			// Bind the connection holder to the thread.			if (txObject.isNewConnectionHolder()) {				//å¦‚æœæ˜¯æ–°åˆ›å»ºçš„äº‹åŠ¡ï¼Œåˆ™å»ºç«‹å½“å‰çº¿ç¨‹å’Œæ•°æ®åº“è¿æ¥çš„å…³ç³»				TransactionSynchronizationManager.bindResource(obtainDataSource(), txObject.getConnectionHolder());			}		}		catch (Throwable ex) {			if (txObject.isNewConnectionHolder()) {				DataSourceUtils.releaseConnection(con, obtainDataSource());				txObject.setConnectionHolder(null, false);			}			throw new CannotCreateTransactionException("Could not open JDBC Connection for transaction", ex);		}	}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿™ä¸ªæ–¹æ³•é‡Œé¢ä¸»è¦åšäº†å…­ä»¶äº‹ï¼š</span></p><ul><li>é¦–å…ˆä»è¿æ¥æ± è·å–è¿æ¥å¹¶ä¿å­˜åˆ°<strong>DataSourceTransactionObject</strong>å¯¹è±¡ä¸­ã€‚</li><li>å…³é—­æ•°æ®åº“çš„<strong>è‡ªåŠ¨æäº¤</strong>ï¼Œä¹Ÿå°±æ˜¯å¼€å¯äº‹åŠ¡ã€‚</li><li>è·å–æ•°æ®åº“çš„éš”ç¦»çº§åˆ«ã€‚</li><li>æ ¹æ®å±æ€§è®¾ç½®è¯¥äº‹åŠ¡æ˜¯å¦ä¸º<strong>åªè¯»äº‹åŠ¡</strong>ã€‚</li><li>å°†è¯¥äº‹åŠ¡æ ‡è¯†ä¸º<strong>æ´»åŠ¨äº‹åŠ¡</strong>ï¼ˆtransactionActive=trueï¼‰ã€‚</li><li>å°†<strong>ConnectionHolder</strong>å¯¹è±¡ä¸å½“å‰çº¿ç¨‹ç»‘å®šã€‚</li></ul><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å®Œæˆä¹‹åé€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">prepareSynchronization</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å°†äº‹åŠ¡çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å±æ€§</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å’Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">çŠ¶æ€</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è®¾ç½®åˆ°</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">TransactionSynchronizationManager</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡ä¸­è¿›è¡Œç®¡ç†ã€‚æœ€åè¿”å›åˆ°</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">createTransactionIfNecessary</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ä¸­åˆ›å»º</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">TransactionInfo</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡ä¸å½“å‰çº¿ç¨‹ç»‘å®šå¹¶è¿”å›ã€‚<br>é€šè¿‡ä»¥ä¸Šçš„æ­¥éª¤å°±å¼€å¯äº†äº‹åŠ¡ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">proceedWithInvocation</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è°ƒç”¨å…¶å®ƒåˆ‡é¢ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆå‡è®¾æ²¡æœ‰å…¶å®ƒåˆ‡é¢äº†ï¼Œé‚£ä¹ˆå°±æ˜¯ç›´æ¥è°ƒç”¨åˆ°Aç±»çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addA</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­åˆè°ƒç”¨äº†Bç±»çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addB</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ï¼Œé‚£ä¹ˆè‚¯å®šä¹Ÿæ˜¯è°ƒç”¨åˆ°ä»£ç†ç±»çš„æ–¹æ³•ï¼Œå› æ­¤åˆä¼šè¿›å…¥åˆ°</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">createTransactionIfNecessary</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ä¸­ã€‚ä½†è¿™æ¬¡è¿›æ¥é€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">isExistingTransaction</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">åˆ¤æ–­æ˜¯å­˜åœ¨äº‹åŠ¡çš„ï¼Œå› æ­¤ä¼šè¿›å…¥åˆ°</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">handleExistingTransaction</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ï¼š</span></p><pre><code>	private TransactionStatus handleExistingTransaction(			TransactionDefinition definition, Object transaction, boolean debugEnabled)			throws TransactionException {		//ä¸å…è®¸æœ‰äº‹åŠ¡ï¼Œç›´æ¥å¼‚å¸¸		if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) {			throw new IllegalTransactionStateException(					"Existing transaction found for transaction marked with propagation 'never'");		}		//ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œæ“ä½œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œå°±æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·		if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) {			if (debugEnabled) {				logger.debug("Suspending current transaction");			}			//æŒ‚èµ·å½“å‰äº‹åŠ¡			Object suspendedResources = suspend(transaction);			boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);			//ä¿®æ”¹äº‹åŠ¡çŠ¶æ€ä¿¡æ¯ï¼ŒæŠŠäº‹åŠ¡çš„ä¸€äº›ä¿¡æ¯å­˜å‚¨åˆ°å½“å‰çº¿ç¨‹ä¸­ï¼ŒThreadLocalä¸­			return prepareTransactionStatus(					definition, null, false, newSynchronization, debugEnabled, suspendedResources);		}		if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) {			if (debugEnabled) {				logger.debug("Suspending current transaction, creating new transaction with name [" +						definition.getName() + "]");			}			//æŒ‚èµ·			SuspendedResourcesHolder suspendedResources = suspend(transaction);			try {				boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);				DefaultTransactionStatus status = newTransactionStatus(						definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);				doBegin(transaction, definition);				prepareSynchronization(status, definition);				return status;			}			catch (RuntimeException | Error beginEx) {				resumeAfterBeginException(transaction, suspendedResources, beginEx);				throw beginEx;			}		}		if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) {			if (!isNestedTransactionAllowed()) {				throw new NestedTransactionNotSupportedException(						"Transaction manager does not allow nested transactions by default - " +						"specify 'nestedTransactionAllowed' property with value 'true'");			}			if (debugEnabled) {				logger.debug("Creating nested transaction with name [" + definition.getName() + "]");			}			//é»˜è®¤æ˜¯å¯ä»¥åµŒå¥—äº‹åŠ¡çš„			if (useSavepointForNestedTransaction()) {				// Create savepoint within existing Spring-managed transaction,				// through the SavepointManager API implemented by TransactionStatus.				// Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.				DefaultTransactionStatus status =						prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null);				//åˆ›å»ºå›æ»šç‚¹				status.createAndHoldSavepoint();				return status;			}			else {				// Nested transaction through nested begin and commit/rollback calls.				// Usually only for JTA: Spring synchronization might get activated here				// in case of a pre-existing JTA transaction.				boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);				DefaultTransactionStatus status = newTransactionStatus(						definition, transaction, true, newSynchronization, debugEnabled, null);				doBegin(transaction, definition);				prepareSynchronization(status, definition);				return status;			}		}			// çœç•¥				boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);		return prepareTransactionStatus(definition, transaction, false, newSynchronization, debugEnabled, null);	}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿™é‡Œé¢ä¹Ÿæ˜¯å¯¹æ¯ä¸ªä¼ æ’­å±æ€§çš„åˆ¤æ–­ï¼Œå…ˆçœ‹</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_REQUIRES_NEW</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">çš„å¤„ç†ï¼Œå› ä¸ºè¯¥å±æ€§è¦æ±‚æ¯æ¬¡è°ƒç”¨éƒ½å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œæ‰€ä»¥é¦–å…ˆä¼šå°†å½“å‰äº‹åŠ¡æŒ‚èµ·ï¼Œæ€ä¹ˆæŒ‚èµ·å‘¢ï¼Ÿ</span></p><pre><code>	protected final SuspendedResourcesHolder suspend(@Nullable Object transaction) throws TransactionException {		if (TransactionSynchronizationManager.isSynchronizationActive()) {			List&lt;TransactionSynchronization&gt; suspendedSynchronizations = doSuspendSynchronization();			try {				Object suspendedResources = null;				//ç¬¬ä¸€æ¬¡è¿›æ¥ï¼Œè‚¯å®šä¸ºnullçš„				if (transaction != null) {					//å§connectionHolderè®¾ç½®ä¸ºç©º					suspendedResources = doSuspend(transaction);				}				//åšæ•°æ®è¿˜åŸæ“ä½œ				String name = TransactionSynchronizationManager.getCurrentTransactionName();				TransactionSynchronizationManager.setCurrentTransactionName(null);				boolean readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();				TransactionSynchronizationManager.setCurrentTransactionReadOnly(false);				Integer isolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel();				TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(null);				boolean wasActive = TransactionSynchronizationManager.isActualTransactionActive();				TransactionSynchronizationManager.setActualTransactionActive(false);				return new SuspendedResourcesHolder(						suspendedResources, suspendedSynchronizations, name, readOnly, isolationLevel, wasActive);			}			catch (RuntimeException | Error ex) {				// doSuspend failed - original transaction is still active...				doResumeSynchronization(suspendedSynchronizations);				throw ex;			}		}		else if (transaction != null) {			// Transaction active but no synchronization active.			Object suspendedResources = doSuspend(transaction);			return new SuspendedResourcesHolder(suspendedResources);		}		else {			// Neither transaction nor synchronization active.			return null;		}	}	protected Object doSuspend(Object transaction) {		DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;		txObject.setConnectionHolder(null);		//è§£é™¤ç»‘å®šå…³ç³»ï¼Œ		return TransactionSynchronizationManager.unbindResource(obtainDataSource());	}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿™é‡Œæ˜æ˜¾æ˜¯è¿›å…¥ç¬¬ä¸€ä¸ªifå¹¶ä¸”ä¼šè°ƒç”¨åˆ°</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">doSuspend</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ï¼Œæ•´ä½“æ¥è¯´æŒ‚èµ·äº‹åŠ¡å¾ˆç®€å•ï¼šé¦–å…ˆå°†</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">DataSourceTransactionObject</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ConnectionHolder</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è®¾ç½®ä¸ºç©ºå¹¶è§£é™¤ä¸å½“å‰çº¿ç¨‹çš„ç»‘å®šï¼Œä¹‹åå°†è§£é™¤ç»‘å®šçš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ConnectionHolder</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å’Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å…¶å®ƒå±æ€§</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼ˆäº‹åŠ¡åç§°ã€éš”ç¦»çº§åˆ«ã€åªè¯»å±æ€§ï¼‰é€šé€šå°è£…åˆ°</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">SuspendedResourcesHolder</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡ï¼Œå¹¶å°†å½“å‰äº‹åŠ¡çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ´»åŠ¨çŠ¶æ€</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è®¾ç½®ä¸ºfalseã€‚æŒ‚èµ·äº‹åŠ¡ä¹‹ååˆé€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">newTransactionStatus</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„äº‹åŠ¡çŠ¶æ€å¹¶è°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">doBegin</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¼€å¯äº‹åŠ¡ï¼Œè¿™é‡Œä¸å†é‡å¤åˆ†æã€‚<br>æ¥ç€æ¥çœ‹</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_NESTED</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼š</span></p><pre><code>		if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) {			if (!isNestedTransactionAllowed()) {				throw new NestedTransactionNotSupportedException(						"Transaction manager does not allow nested transactions by default - " +						"specify 'nestedTransactionAllowed' property with value 'true'");			}			if (debugEnabled) {				logger.debug("Creating nested transaction with name [" + definition.getName() + "]");			}			//é»˜è®¤æ˜¯å¯ä»¥åµŒå¥—äº‹åŠ¡çš„			if (useSavepointForNestedTransaction()) {				// Create savepoint within existing Spring-managed transaction,				// through the SavepointManager API implemented by TransactionStatus.				// Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.				DefaultTransactionStatus status =						prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null);				//åˆ›å»ºå›æ»šç‚¹				status.createAndHoldSavepoint();				return status;			}			else {				// Nested transaction through nested begin and commit/rollback calls.				// Usually only for JTA: Spring synchronization might get activated here				// in case of a pre-existing JTA transaction.				boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);				DefaultTransactionStatus status = newTransactionStatus(						definition, transaction, true, newSynchronization, debugEnabled, null);				doBegin(transaction, definition);				prepareSynchronization(status, definition);				return status;			}		}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿™é‡Œé¢å¯ä»¥çœ‹åˆ°å¦‚æœå…è®¸</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">åµŒå¥—äº‹åŠ¡</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">DefaultTransactionStatus</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¯¹è±¡ï¼ˆæ³¨æ„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">newTransaction</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ˜¯falseï¼Œè¡¨æ˜ä¸æ˜¯ä¸€ä¸ªæ–°äº‹åŠ¡ï¼‰å’Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å›æ»šç‚¹</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼›å¦‚æœä¸å…è®¸</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">åµŒå¥—</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œå°±ä¼šåˆ›å»º</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–°äº‹åŠ¡</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å¹¶å¼€å¯ã€‚<br>å½“ä¸Šé¢çš„åˆ¤æ–­éƒ½ä¸æ»¡è¶³æ—¶ï¼Œä¹Ÿå°±æ˜¯ä¼ æ’­å±æ€§ä¸ºé»˜è®¤</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_REQUIRED</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ—¶ï¼Œåˆ™åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ª</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">newTransaction</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ä¸ºfalseçš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">DefaultTransactionStatus</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿”å›ã€‚<br>å®Œæˆä¹‹ååˆæ˜¯è°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">proceedWithInvocation</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œé‚£ä¹ˆå°±æ˜¯æ‰§è¡ŒBç±»çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addB</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ï¼Œå‡å¦‚æ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆå°±ä¼šå›åˆ°åˆ‡é¢è°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">commitTransactionAfterReturning</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æäº¤</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addB</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">çš„äº‹åŠ¡ï¼š</span></p><pre><code>	protected void commitTransactionAfterReturning(@Nullable TransactionInfo txInfo) {		if (txInfo != null &amp;&amp; txInfo.getTransactionStatus() != null) {			txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());		}	}	public final void commit(TransactionStatus status) throws TransactionException {		processCommit(defStatus);	}	private void processCommit(DefaultTransactionStatus status) throws TransactionException {		try {			boolean beforeCompletionInvoked = false;			try {				boolean unexpectedRollback = false;				prepareForCommit(status);				triggerBeforeCommit(status);				triggerBeforeCompletion(status);				beforeCompletionInvoked = true;				if (status.hasSavepoint()) {					if (status.isDebug()) {						logger.debug("Releasing transaction savepoint");					}					// å¦‚æœæ˜¯nestedï¼Œæ²¡æœ‰æäº¤ï¼Œåªæ˜¯å°†savepointæ¸…é™¤æ‰äº†					unexpectedRollback = status.isGlobalRollbackOnly();					status.releaseHeldSavepoint();				}				//å¦‚æœéƒ½æ˜¯PROPAGATION_REQUIREDï¼Œæœ€å¤–å±‚çš„æ‰ä¼šèµ°è¿›æ¥ç»Ÿä¸€æäº¤ï¼Œå¦‚æœæ˜¯PROPAGATION_REQUIRES_NEWï¼Œæ¯ä¸€ä¸ªäº‹åŠ¡éƒ½ä¼šè¿›æ¥				else if (status.isNewTransaction()) {					if (status.isDebug()) {						logger.debug("Initiating transaction commit");					}					unexpectedRollback = status.isGlobalRollbackOnly();					doCommit(status);				}				else if (isFailEarlyOnGlobalRollbackOnly()) {					unexpectedRollback = status.isGlobalRollbackOnly();				}			}		}		finally {			cleanupAfterCompletion(status);		}	}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ä¸»è¦é€»è¾‘åœ¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">processCommit</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ä¸­ã€‚å¦‚æœå­˜åœ¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å›æ»šç‚¹</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œå¯ä»¥çœ‹åˆ°å¹¶</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ²¡æœ‰æäº¤äº‹åŠ¡</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œåªæ˜¯å°†</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å½“å‰äº‹åŠ¡çš„å›æ»šç‚¹</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ¸…é™¤äº†ï¼›è€Œå¦‚æœæ˜¯</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–°äº‹åŠ¡</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œå°±ä¼šè°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">doCommit</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æäº¤äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯åªæœ‰</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_REQUIRED</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å±æ€§ä¸‹çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æœ€å¤–å±‚äº‹åŠ¡</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å’Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_REQUIRES_NEW</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å±æ€§ä¸‹çš„äº‹åŠ¡èƒ½æäº¤ã€‚äº‹åŠ¡æäº¤å®Œæˆåä¼šè°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">cleanupAfterCompletion</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ¸…é™¤å½“å‰äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¦‚æœæœ‰æŒ‚èµ·çš„äº‹åŠ¡è¿˜ä¼šé€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">resume</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ¢å¤æŒ‚èµ·çš„äº‹åŠ¡ï¼ˆå°†è§£ç»‘çš„è¿æ¥å’Œå½“å‰çº¿ç¨‹ç»‘å®šä»¥åŠå°†ä¹‹å‰ä¿å­˜çš„äº‹åŠ¡çŠ¶æ€é‡æ–°è®¾ç½®å›å»ï¼‰ã€‚å½“å‰äº‹åŠ¡æ­£å¸¸æäº¤åï¼Œé‚£ä¹ˆå°±ä¼šè½®åˆ°</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addA</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•æäº¤ï¼Œå¤„ç†é€»è¾‘åŒä¸Šï¼Œä¸å†èµ˜è¿°ã€‚<br>å¦‚æœè°ƒç”¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addB</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å‘ç”Ÿå¼‚å¸¸ï¼Œå°±ä¼šé€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">completeTransactionAfterThrowing</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿›è¡Œå›æ»šï¼š</span></p><pre><code>	protected void completeTransactionAfterThrowing(@Nullable TransactionInfo txInfo, Throwable ex) {		if (txInfo != null &amp;&amp; txInfo.getTransactionStatus() != null) {			if (logger.isTraceEnabled()) {				logger.trace("Completing transaction for [" + txInfo.getJoinpointIdentification() +						"] after exception: " + ex);			}			if (txInfo.transactionAttribute != null &amp;&amp; txInfo.transactionAttribute.rollbackOn(ex)) {				try {					txInfo.getTransactionManager().rollback(txInfo.getTransactionStatus());				}			}		}	}	public final void rollback(TransactionStatus status) throws TransactionException {		DefaultTransactionStatus defStatus = (DefaultTransactionStatus) status;		processRollback(defStatus, false);	}	private void processRollback(DefaultTransactionStatus status, boolean unexpected) {		try {			boolean unexpectedRollback = unexpected;			try {				triggerBeforeCompletion(status);				//æŒ‰ç…§åµŒå¥—äº‹åŠ¡æŒ‰ç…§å›æ»šç‚¹å›æ»š				if (status.hasSavepoint()) {					if (status.isDebug()) {						logger.debug("Rolling back transaction to savepoint");					}					status.rollbackToHeldSavepoint();				}				//éƒ½ä¸ºPROPAGATION_REQUIREDæœ€å¤–å±‚äº‹åŠ¡ç»Ÿä¸€å›æ»š				else if (status.isNewTransaction()) {					if (status.isDebug()) {						logger.debug("Initiating transaction rollback");					}					doRollback(status);				}				else {					// Participating in larger transaction					if (status.hasTransaction()) {						if (status.isLocalRollbackOnly() || isGlobalRollbackOnParticipationFailure()) {							if (status.isDebug()) {								logger.debug("Participating transaction failed - marking existing transaction as rollback-only");							}							doSetRollbackOnly(status);						}						else {							if (status.isDebug()) {								logger.debug("Participating transaction failed - letting transaction originator decide on rollback");							}						}					}					else {						logger.debug("Should roll back transaction but cannot - no transaction available");					}					// Unexpected rollback only matters here if we're asked to fail early					if (!isFailEarlyOnGlobalRollbackOnly()) {						unexpectedRollback = false;					}				}			}			catch (RuntimeException | Error ex) {				triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);				throw ex;			}			triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK);			// Raise UnexpectedRollbackException if we had a global rollback-only marker			if (unexpectedRollback) {				throw new UnexpectedRollbackException(						"Transaction rolled back because it has been marked as rollback-only");			}		}		finally {			cleanupAfterCompletion(status);		}	}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æµç¨‹å’Œæäº¤æ˜¯ä¸€æ ·çš„ï¼Œå…ˆæ˜¯åˆ¤æ–­æœ‰æ²¡æœ‰å›æ»šç‚¹ï¼Œå¦‚æœæœ‰å°±å›åˆ°åˆ°å›æ»šç‚¹å¹¶æ¸…é™¤è¯¥å›æ»šç‚¹ï¼›å¦‚æœæ²¡æœ‰åˆ™åˆ¤æ–­æ˜¯ä¸æ˜¯æ–°äº‹åŠ¡ï¼ˆ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_REQUIRED</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å±æ€§ä¸‹çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æœ€å¤–å±‚äº‹åŠ¡</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å’Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">PROPAGATION_REQUIRES_NEW</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å±æ€§ä¸‹çš„äº‹åŠ¡ï¼‰ï¼Œæ»¡è¶³åˆ™ç›´æ¥å›æ»šå½“å‰äº‹åŠ¡ã€‚å›æ»šå®ŒæˆååŒæ ·éœ€è¦æ¸…é™¤æ‰å½“å‰çš„äº‹åŠ¡çŠ¶æ€å¹¶æ¢å¤æŒ‚èµ·çš„è¿æ¥ã€‚å¦å¤–éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯åœ¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">catch</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">é‡Œé¢è°ƒç”¨å®Œå›æ»šé€»è¾‘åï¼Œè¿˜é€šè¿‡</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">throw</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æŠ›å‡ºäº†å¼‚å¸¸ï¼Œè¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿæ„å‘³ç€å³ä½¿æ˜¯åµŒå¥—äº‹åŠ¡ï¼Œå†…å±‚äº‹åŠ¡çš„å›æ»šä¹Ÿä¼šå¯¼è‡´å¤–å±‚äº‹åŠ¡çš„å›æ»šï¼Œä¹Ÿå°±æ˜¯</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addA</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">çš„äº‹åŠ¡ä¹Ÿä¼šè·Ÿç€å›æ»šã€‚<br>è‡³æ­¤ï¼Œäº‹åŠ¡çš„ä¼ æ’­åŸç†åˆ†æå®Œæ¯•ï¼Œæ·±å…¥çœ‹æ¯ä¸ªæ–¹æ³•çš„å®ç°æ˜¯å¾ˆå¤æ‚çš„ï¼Œä½†å¦‚æœä»…ä»…æ˜¯åˆ†æå„ä¸ªä¼ æ’­å±æ€§å¯¹äº‹åŠ¡çš„å½±å“ï¼Œåˆ™æœ‰ä¸€ä¸ªç®€å•çš„æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥å°†å†…å±‚äº‹åŠ¡åˆ‡é¢</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ç­‰æ•ˆæ›¿æ¢</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ‰</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">invocation.proceedWithInvocation</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æ–¹æ³•ï¼Œæ¯”å¦‚ä¸Šé¢ä¸¤ä¸ªç±»çš„è°ƒç”¨å¯ä»¥çœ‹ä½œæ˜¯ä¸‹é¢è¿™æ ·ï¼š</span></p><pre><code>// addAçš„äº‹åŠ¡TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);Object retVal = null;try {	// addBçš„äº‹åŠ¡	TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);	Object retVal = null;	try {		retVal = invocation.proceedWithInvocation();	}	catch (Throwable ex) {		// target invocation exception		//äº‹åŠ¡å›æ»š		completeTransactionAfterThrowing(txInfo, ex);		throw ex;	}	finally {		cleanupTransactionInfo(txInfo);	}	//äº‹åŠ¡æäº¤	commitTransactionAfterReturning(txInfo);}catch (Throwable ex) {	//äº‹åŠ¡å›æ»š	completeTransactionAfterThrowing(txInfo, ex);	throw ex;}//äº‹åŠ¡æäº¤commitTransactionAfterReturning(txInfo);</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿™æ ·çœ‹æ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“å°±èƒ½åˆ†æå‡ºäº‹åŠ¡ä¹‹é—´çš„å½±å“ä»¥åŠæ˜¯æäº¤è¿˜æ˜¯å›æ»šäº†ï¼Ÿä¸‹é¢æ¥çœ‹å‡ ä¸ªå®ä¾‹åˆ†æã€‚</span></p><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">å®ä¾‹åˆ†æ</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æˆ‘å†æ·»åŠ ä¸€ä¸ªCç±»ï¼Œå’Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addC</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">çš„æ–¹æ³•ï¼Œç„¶ååœ¨</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">addA</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">é‡Œé¢è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚</span></p><pre><code>TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);Object retVal = null;try {	// addBçš„äº‹åŠ¡	TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);	Object retVal = null;	try {		b.addB();	}	catch (Throwable ex) {		// target invocation exception		//äº‹åŠ¡å›æ»š		completeTransactionAfterThrowing(txInfo, ex);		throw ex;	}	//äº‹åŠ¡æäº¤	commitTransactionAfterReturning(txInfo);	// addCçš„äº‹åŠ¡	TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);	Object retVal = null;	try {		c.addC();	}	catch (Throwable ex) {		// target invocation exception		//äº‹åŠ¡å›æ»š		completeTransactionAfterThrowing(txInfo, ex);		throw ex;	}	//äº‹åŠ¡æäº¤	commitTransactionAfterReturning(txInfo);}catch (Throwable ex) {	//äº‹åŠ¡å›æ»š	completeTransactionAfterThrowing(txInfo, ex);	throw ex;}//äº‹åŠ¡æäº¤commitTransactionAfterReturning(txInfo);</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ç­‰æ•ˆæ›¿æ¢åå°±æ˜¯ä¸Šé¢è¿™ä¸ªä»£ç ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥åˆ†æã€‚</span></p><ul><li>éƒ½æ˜¯<strong>PROPAGATION_REQUIRED</strong>å±æ€§ï¼šé€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯åŒä¸€ä¸ªè¿æ¥å’Œäº‹åŠ¡ï¼Œé‚£ä¹ˆä»»ä½•ä¸€ä¸ªå‡ºç°å¼‚å¸¸åˆ™éƒ½ä¼šå›æ»šã€‚</li><li><strong>addB</strong>ä¸º<strong>PROPAGATION_REQUIRES_NEW</strong>ï¼šå¦‚æœBä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆBä¸­è‚¯å®šä¼šå›æ»šï¼Œæ¥ç€å¼‚å¸¸å‘ä¸ŠæŠ›ï¼Œå¯¼è‡´Aäº‹åŠ¡æ•´ä½“å›æ»šï¼›å¦‚æœCä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œä¸éš¾çœ‹å‡ºCå’ŒAéƒ½ä¼šå›æ»šï¼Œä½†Bå·²ç»æäº¤äº†ï¼Œå› æ­¤ä¸ä¼šå—å½±å“ã€‚</li><li><strong>addC</strong>ä¸º<strong>PROPAGATION_NESTED</strong>ï¼Œ<strong>addB</strong>ä¸º<strong>PROPAGATION_REQUIRES_NEW</strong>ï¼šå¦‚æœBä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆBå›æ»šå¹¶æŠ›å‡ºå¼‚å¸¸ï¼ŒAä¹Ÿå›æ»šï¼ŒCä¸ä¼šæ‰§è¡Œï¼›å¦‚æœCä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œå…ˆæ˜¯å›æ»šåˆ°<strong>å›æ»šç‚¹</strong>å¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥Aä¹Ÿå›æ»šï¼Œä½†Bæ­¤æ—¶å·²ç»æäº¤ï¼Œä¸å—å½±å“ã€‚</li><li>éƒ½æ˜¯<strong>PROPAGATION_NESTED</strong>ï¼šè™½ç„¶åˆ›å»ºäº†å›æ»šç‚¹ï¼Œä½†æ˜¯ä»ç„¶æ˜¯åŒä¸€ä¸ªè¿æ¥ï¼Œä»»ä½•ä¸€ä¸ªå‘ç”Ÿå¼‚å¸¸éƒ½ä¼šå›æ»šï¼Œå¦‚æœä¸æƒ³å½±å“å½¼æ­¤ï¼Œå¯ä»¥try-catchç”Ÿåå­äº‹åŠ¡çš„å¼‚å¸¸å®ç°ã€‚</li></ul><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">è¿˜æœ‰å…¶å®ƒå¾ˆå¤šæƒ…å†µï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œåªè¦ä½¿ç”¨ä¸Šé¢çš„åˆ†ææ–¹æ³•éƒ½èƒ½å¤Ÿå¾ˆè½»æ¾çš„åˆ†æå‡ºæ¥ã€‚</span></p><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">æ€»ç»“</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">æœ¬ç¯‡è¯¦ç»†åˆ†æäº†äº‹åŠ¡çš„ä¼ æ’­åŸç†ï¼Œå¦å¤–è¿˜æœ‰</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">éš”ç¦»çº§åˆ«</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ï¼Œè¿™åœ¨Springä¸­æ²¡æœ‰ä½“ç°ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ç»“åˆæ•°æ®åº“çš„çŸ¥è¯†è¿›è¡Œåˆ†æè®¾ç½®ã€‚æœ€åæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å£°æ˜å¼äº‹åŠ¡</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å’Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ç¼–ç¨‹å¼äº‹åŠ¡</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">çš„ä¼˜ç¼ºç‚¹ï¼Œå£°æ˜å¼äº‹åŠ¡è™½ç„¶ç®€å•ï¼Œä½†ä¸é€‚åˆç”¨åœ¨é•¿äº‹åŠ¡ä¸­ï¼Œä¼šå ç”¨å¤§é‡è¿æ¥èµ„æºï¼Œè¿™æ—¶å°±éœ€è¦è€ƒè™‘åˆ©ç”¨ç¼–ç¨‹å¼äº‹åŠ¡çš„çµæ´»æ€§äº†ã€‚æ€»è€Œè¨€ä¹‹ï¼Œäº‹åŠ¡çš„ä½¿ç”¨å¹¶ä¸æ˜¯ä¸€å¾‹é»˜è®¤å°±å¥½ï¼Œæ¥å£çš„</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ä¸€è‡´æ€§</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">å’Œ</span><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ååé‡</span></strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ä¸äº‹åŠ¡æœ‰ç€ç›´æ¥å…³ç³»ï¼Œä¸¥é‡æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚</span></p><blockquote><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ä½œè€…ï¼š</span>å¤œå‹¿è¯­</p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">åŸæ–‡é“¾æ¥ï¼š</span>https://blog.csdn.net/l6108003/article/details/106696735</p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'é¢è¯•','é—®ä½ ','ä¸€ä¸ª'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>