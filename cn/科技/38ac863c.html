<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>分布式服务注册中心 XXL-REGISTRY | 极客快訊</title><meta property="og:title" content="分布式服务注册中心 XXL-REGISTRY - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/d0f0012bd09c48e4869122d45b8cca90"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/38ac863c.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/38ac863c.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/38ac863c.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/38ac863c.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/38ac863c.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/38ac863c.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/38ac863c.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/38ac863c.html><meta property="article:published_time" content="2020-11-14T21:00:28+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:28+08:00"><meta name=Keywords content><meta name=description content="分布式服务注册中心 XXL-REGISTRY"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/38ac863c.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>分布式服务注册中心 XXL-REGISTRY</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>XXL-REGISTRY 是一个轻量级分布式服务注册中心，拥有"轻量级、秒级注册上线、多环境、跨语言、跨机房"等特性。现已开放源代码，开箱即用。</p><div class=pgc-img><img alt="分布式服务注册中心 XXL-REGISTRY" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d0f0012bd09c48e4869122d45b8cca90><p class=pgc-img-caption></p></div><p>特性</p><ul><li>1、轻量级：基于DB与磁盘文件，只需要提供一个DB实例即可，无第三方依赖；</li><li>2、实时性：借助内部广播机制，新服务上线、下线，可以在1s内推送给客户端；</li><li>3、数据同步：注册中心会定期全量同步数据至磁盘文件，清理无效服务，确保服务数据实时可用；</li><li>4、性能：服务发现时仅读磁盘文件，性能非常高；服务注册、摘除时通过磁盘文件校验，防止重复注册操作；</li><li>5、扩展性：可方便、快速的横向扩展，只需保证服务注册中心配置一致即可，可借助负载均衡组件如Nginx快速集群部署；</li><li>6、多状态：服务内置三种状态：</li><li class=ql-indent-1>正常状态=支持动态注册、发现，服务注册信息实时更新；</li><li class=ql-indent-1>锁定状态=人工维护注册信息，服务注册信息固定不变；</li><li class=ql-indent-1>禁用状态=禁止使用，服务注册信息固定为空；</li><li>7、跨语言：注册中心提供HTTP接口（RESTFUL 格式）供客户端实用，语言无关，通用性更强；</li><li>8、兼容性：项目立项之初是为XXL-RPC量身设计，但是不限于XXL-RPC使用。兼容支持任何服务框架服务注册实用，如dubbo、springboot等；</li><li>9、跨机房：得益于服务注册中心集群关系对等特性，集群各节点提供幂等的配置服务；因此，异地跨机房部署时，只需要请求本机房服务注册中心即可，实现异地多活；</li><li>10、容器化：提供官方docker镜像，并实时更新推送dockerhub，进一步实现 "服务注册中心" 产品开箱即用；</li><li>11、访问令牌（accessToken）：为提升系统安全性，注册中心和客户端进行安全性校验，双方AccessToken匹配才允许通讯；</li></ul><p>一、简介</p><p>1.1 概述</p><p>XXL-REGISTRY 是一个轻量级分布式服务注册中心，拥有"轻量级、秒级注册上线、多环境、跨语言、跨机房"等特性。现已开放源代码，开箱即用。</p><p>1.2 特性</p><ul><li>1、轻量级：基于DB与磁盘文件，只需要提供一个DB实例即可，无第三方依赖；</li><li>2、实时性：借助内部广播机制，新服务上线、下线，可以在1s内推送给客户端；</li><li>3、数据同步：注册中心会定期全量同步数据至磁盘文件，清理无效服务，确保服务数据实时可用；</li><li>4、性能：服务发现时仅读磁盘文件，性能非常高；服务注册、摘除时通过磁盘文件校验，防止重复注册操作；</li><li>5、扩展性：可方便、快速的横向扩展，只需保证服务注册中心配置一致即可，可借助负载均衡组件如Nginx快速集群部署；</li><li>6、多状态：服务内置三种状态：</li><li class=ql-indent-1>正常状态=支持动态注册、发现，服务注册信息实时更新；</li><li class=ql-indent-1>锁定状态=人工维护注册信息，服务注册信息固定不变；</li><li class=ql-indent-1>禁用状态=禁止使用，服务注册信息固定为空；</li><li>7、跨语言：注册中心提供HTTP接口（RESTFUL 格式）供客户端实用，语言无关，通用性更强；</li><li>8、兼容性：项目立项之初是为XXL-RPC量身设计，但是不限于XXL-RPC使用。兼容支持任何服务框架服务注册实用，如dubbo、springboot等；</li><li>9、跨机房：得益于服务注册中心集群关系对等特性，集群各节点提供幂等的配置服务；因此，异地跨机房部署时，只需要请求本机房服务注册中心即可，实现异地多活；</li><li>10、容器化：提供官方docker镜像，并实时更新推送dockerhub，进一步实现 "服务注册中心" 产品开箱即用；</li><li>11、访问令牌（accessToken）：为提升系统安全性，注册中心和客户端进行安全性校验，双方AccessToken匹配才允许通讯；</li></ul><p>1.3 环境</p><ul><li>Maven3+</li><li>Jdk1.7+</li><li>Mysql5.6+</li></ul><p>二、快速入门</p><p>2.1 初始化 "服务注册中心" 数据库</p><p>请下载项目源码并解压，获取 "服务注册中心" 数据库初始化SQL脚本并执行即可</p><p>数据库初始化SQL脚本位置为:</p><pre>/xxl-registry/doc/db/xxl-registry-mysql.sql</pre><p>"服务注册中心" 支持集群部署，集群情况下各节点务必连接同一个mysql实例;</p><p>2.2 编译项目</p><p>解压源码,按照maven格式将源码导入IDE, 使用maven进行编译即可，源码结构如下：</p><pre>- /doc- /xxl-registry-admin ：分布式服务中心- /xxl-registry-client ：客户端核心依赖；</pre><p>2.3 配置部署“服务注册中心”</p><p>步骤一：配置项目：</p><p>配置文件地址：</p><pre>/xxl-registry/xxl-registry-admin/src/main/resources/application.properties</pre><p>消息中心配置内容说明：</p><pre>### 数据库配置spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl-registry?Unicode=true&amp;characterEncoding=UTF-8### 服务注册数据磁盘同步目录xxl.registry.data.filepath=/data/applogs/xxl-registry/registrydata### 登陆信息配置xxl.registry.login.username=adminxxl.registry.login.password=123456</pre><p>步骤二：部署项目：</p><p>如果已经正确进行上述配置，可将项目编译打包部署。 访问地址：http://localhost:8080/xxl-registry-admin (该地址接入方项目将会使用到，作为注册地址)，登录后运行界面如下图所示</p><div class=pgc-img><img alt="分布式服务注册中心 XXL-REGISTRY" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b179580fd1994e6b8ca92ba016a16bc0><p class=pgc-img-caption></p></div><p>至此“服务注册中心”项目已经部署成功。</p><p>步骤三：服务注册中心集群（可选）：</p><p>服务注册中心支持集群部署，提升消息系统容灾和可用性。</p><p>集群部署时，几点要求和建议：</p><ul><li>DB配置保持一致；</li><li>登陆账号配置保持一致；</li><li>建议：推荐通过nginx为集群做负载均衡，分配域名。访问、客户端使用等操作均通过该域名进行。</li></ul><p>其他：Docker 镜像方式搭建消息中心：</p><ul><li>下载镜像</li></ul><pre>// Docker地址：https://hub.docker.com/r/xuxueli/xxl-registry-admin/docker pull xuxueli/xxl-registry-admin</pre><ul><li>创建容器并运行</li></ul><pre>docker run -p 8080:8080 -v /tmp:/data/applogs --name xxl-registry-admin -d xuxueli/xxl-registry-admin/*** 如需自定义 mysql 等配置，可通过 "PARAMS" 指定，参数格式 RAMS="--key=value --key2=value2" ；* 配置项参考文件：/xxl-registry/xxl-registry-admin/src/main/resources/application.properties*/docker run -e PARAMS="--spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl-registry?Unicode=true&amp;characterEncoding=UTF-8" -p 8080:8080 -v /tmp:/data/applogs --name xxl-registry-admin -d xuxueli/xxl-registry-admin</pre><p>2.4 接入 "服务注册中心" 示例</p><p>a、XXL-RPC 接入示例；</p><p>XXL-RPC默认将 "XXL-REGISTRY" 作为原生注册中心。可前往 XXL-RPC (https://github.com/xuxueli/xxl-rpc ) 示例项目参考如何接入 "XXL-REGISTRY" 。</p><p>b、其他Java语言项目接入示例；</p><p>客户端maven依赖地址：</p><pre>&lt;dependency&gt; &lt;groupId&gt;com.xuxueli&lt;/groupId&gt; &lt;artifactId&gt;xxl-registry-client&lt;/artifactId&gt; &lt;version&gt;${最新稳定版}&lt;/version&gt;&lt;/dependency&gt;</pre><p>其他Java服务框架，可以借助原生提供的客户端JAR包快速接入使用，建议参考 XXL-RPC 提供的实例项目；</p><p>客户端JAR包内封装了与注册中心API服务交互的客户端代码，原生提供两个客户端类供实用：</p><ul><li>基础客户端类（com.xxl.registry.client.XxlRegistryBaseClient）：借助该客户端类，可方便的与注册中心进行注册数据交互，如：服务注册、续约、摘除、发现服务、监控等等；</li><li>增强客户端类（com.xxl.registry.client.XxlRegistryClient）：该类为增强版本客户端类，内置客户端服务续约线程和服务注册信息监控线程。 通过该客户端类注册的服务，底层线程将会主动维护续约操作，通过该客户端类发现的服务信息，底层线程将会主动定期刷新并实时监控变更。 同时对服务数据进行缓存处理，业务方可放心实用不用担心性能问题。</li></ul><p>客户端API实用示例代码如下：</p><pre>// 注册中心客户端（基础类）XxlRegistryBaseClient registryClient = new XxlRegistryBaseClient("http://localhost:8080/xxl-registry-admin/", null, "xxl-rpc", "test");// 注册中心客户端（增强类）XxlRegistryClient registryClient = new XxlRegistryClient("http://localhost:8080/xxl-registry-admin/", null, "xxl-rpc", "test");// 服务注册 &amp; 续约：List&lt;XxlRegistryDataParamVO&gt; registryDataList = new ArrayList&lt;&gt;();registryDataList.add(new XxlRegistryDataParamVO("service01", "address01"));registryDataList.add(new XxlRegistryDataParamVO("service02", "address02"));registryClient.registry(registryDataList);// 服务摘除：List&lt;XxlRegistryDataParamVO&gt; registryDataList = new ArrayList&lt;&gt;();registryDataList.add(new XxlRegistryDataParamVO("service01", "address01"));registryDataList.add(new XxlRegistryDataParamVO("service02", "address02"));registryClient.remove(registryDataList);// 服务发现：Set&lt;String&gt; keys = new TreeSet&lt;&gt;();keys.add("service01");keys.add("service02");Map&lt;String, TreeSet&lt;String&gt;&gt; serviceData = registryClient.discovery(keys);// 服务监控：Set&lt;String&gt; keys = new TreeSet&lt;&gt;();keys.add("service01");keys.add("service02");registryClient.monitor(keys);</pre><p>其他Java服务框架，如dubbo、springboot等，接入 "XXL-REGISTRY" 的示例项目，后续将会整理推出。</p><p>c、非Java语言项目接入；</p><p>非Java语言项目，可以借助提供的 RESTFUL 格式API接口实现服务注册与发现功能。</p><p>参考章节 "三、注册中心API服务"</p><p>三、注册中心API服务（RESTFUL 格式）</p><p>服务注册中心为支持服务注册与发现功能，提供的 RESTFUL 格式API接口如下：</p><p>3.1、服务注册 & 续约 API</p><p>说明：新服务注册上线1s内广播通知接入方；需要接入方循环续约，否则服务将会过期（三倍于注册中心心跳时间）下线；</p><pre>地址格式：{服务注册中心跟地址}/registry请求参数说明： 1、accessToken：请求令牌； 2、biz：业务标识 2、env：环境标识 3、registryDataList：服务注册信息请求数据格式如下，放置在 RequestBody 中，JSON格式： { "accessToken" : "xx", "biz" : "xx", "env" : "xx", "registryDataList" : [{ "key" : "service01", "value" : "address01" }] }</pre><p>3.2、服务摘除 API</p><p>说明：新服务摘除下线1s内广播通知接入方；</p><pre>地址格式：{服务注册中心跟地址}/remove请求参数说明： 1、accessToken：请求令牌； 2、biz：业务标识 2、env：环境标识 3、registryDataList：服务注册信息请求数据格式如下，放置在 RequestBody 中，JSON格式： { "accessToken" : "xx", "biz" : "xx", "env" : "xx", "registryDataList" : [{ "key" : "service01", "value" : "address01" }] }</pre><p>3.3、服务发现 API</p><p>说明：查询在线服务地址列表；</p><pre>地址格式：{服务注册中心跟地址}/discovery请求参数说明： 1、accessToken：请求令牌； 2、biz：业务标识 2、env：环境标识 3、keys：服务注册Key列表请求数据格式如下，放置在 RequestBody 中，JSON格式： { "accessToken" : "xx", "biz" : "xx", "env" : "xx", "keys" : [ "service01", "service02" ] }</pre><p>3.4、服务监控 API</p><p>说明：long-polling 接口，主动阻塞一段时间（三倍于注册中心心跳时间）；直至阻塞超时或服务注册信息变动时响应；</p><pre>地址格式：{服务注册中心跟地址}/monitor请求参数说明： 1、accessToken：请求令牌； 2、biz：业务标识 2、env：环境标识 3、keys：服务注册Key列表请求数据格式如下，放置在 RequestBody 中，JSON格式： { "accessToken" : "xx", "biz" : "xx", "env" : "xx", "keys" : [ "service01", "service02" ] }</pre><p>四、系统设计</p><p>4.1 系统架构图</p><div class=pgc-img><img alt="分布式服务注册中心 XXL-REGISTRY" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/34fb47a9d2974fe2b81655d4b0622d84><p class=pgc-img-caption></p></div><p>4.2 原理解析</p><p>XXL-REGISTRY内部通过广播机制，集群节点实时同步服务注册信息，确保一致。客户端借助 long pollong 实时感知服务注册信息，简洁、高效；</p><p>4.3 跨机房（异地多活）</p><p>得益于服务注册中心集群关系对等特性，集群各节点提供幂等的服务注册服务；因此，异地跨机房部署时，只需要请求本机房服务注册中心即可，实现异地多活；</p><p>举个例子：比如机房A、B 内分别部署服务注册中心集群节点。即机房A部署 a1、a2 两个服务注册中心服务节点，机房B部署 b1、b2 两个服务注册中心服务节点；</p><p>那么各机房内应用只需要请求本机房内部署的服务注册中心节点即可，不需要跨机房调用。即机房A内业务应用请求 a1、a2 获取配置、机房B内业务应用 b1、b2 获取配置。</p><p>这种跨机房部署方式实现了配置服务的 "异地多活"，拥有以下几点好处：</p><ul><li>1、注册服务响应更快：注册请求本机房内搞定；</li><li>2、注册服务更稳定：注册请求不需要跨机房，不需要考虑复杂的网络情况，更加稳定；</li><li>2、容灾性：即使一个机房内服务注册中心全部宕机，仅会影响到本机房内应用加载服务，其他机房不会受到影响。</li></ul><p>4.4 一致性</p><p>类似 Raft 方案，更轻量级、稳定；</p><ul><li>Raft：Leader统一处理变更操作请求，一致性协议的作用具化为保证节点间操作日志副本(log replication)一致，以term作为逻辑时钟(logical clock)保证时序，节点运行相同状态机(state machine)得到一致结果。</li><li>xxl-registry：</li><li class=ql-indent-1>Leader（统一处理分发变更请求）：DB消息表（仅变更时产生消息，消息量较小，而且消息轮训存在间隔，因此消息表压力不会太大；）；</li><li class=ql-indent-1>state machine（顺序操作日志副本并保证结果一直）：顺序消费消息，保证本地数据一致，并通过周期全量同步进一步保证一致性；</li></ul></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'XXL','REGISTRY','中心'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>