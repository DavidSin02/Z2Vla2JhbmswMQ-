<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>精品推荐！Nginx的日志文件、缓存、自动列目录、压缩等相关配置 | 极客快訊</title><meta property="og:title" content="精品推荐！Nginx的日志文件、缓存、自动列目录、压缩等相关配置 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/3c72000101f59eee9921"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/398a9b5e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/398a9b5e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/398a9b5e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/398a9b5e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/398a9b5e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/398a9b5e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/398a9b5e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/398a9b5e.html><meta property="article:published_time" content="2020-11-14T21:01:36+08:00"><meta property="article:modified_time" content="2020-11-14T21:01:36+08:00"><meta name=Keywords content><meta name=description content="精品推荐！Nginx的日志文件、缓存、自动列目录、压缩等相关配置"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/398a9b5e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>精品推荐！Nginx的日志文件、缓存、自动列目录、压缩等相关配置</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>前言</h1><p><strong>前几天与一位小姐姐一同探讨了一下Nginx服务器配置的问题。下文是关于Nginx的基本配置解析与用法</strong></p><p><img alt=精品推荐！Nginx的日志文件、缓存、自动列目录、压缩等相关配置 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/3c72000101f59eee9921></p><h1>日志文件</h1><p>记录了Nginx服务器操作的一些信息。可以使用log_format来配置日志文件的记录格式。</p><blockquote><p><br><strong>vim /usr/local/nginx/conf/nginx.conf</strong></p></blockquote><h1>变量如下：</h1><blockquote><p><strong>$remote_addr：客户端的IP地址</strong></p><p><strong>$remote_user：客户端的用户名</strong></p><p><strong>$request：请求的URL</strong></p><p><strong>$status：请求状态（请求中还是请求结束了）</strong></p><p><strong>$body_bytes_sent：发送给客户端的字节数</strong></p><p><strong>$http_referer：访问的原网页（客户从哪里访问到当前网页的）</strong></p><p><strong>$http_user_agent：客户端的浏览器对应的信息（类型：火狐/google...）</strong></p><p><strong>$http_x_forwarded_for：客户端的IP的值 和 $remote_addr差不多</strong></p><p><strong>#主要记录的是日志文件的信息是如何排列的</strong></p><p><strong>log_format main '$remote_addr - $remote_user [$time_local] "$request" '</strong></p><p><strong>'$status $body_bytes_sent "$http_referer" '</strong></p><p><strong>'"$http_user_agent" "$http_x_forwarded_for"';</strong></p></blockquote><h1>日志默认存储地址</h1><p>在nginx.conf中也可以进行配置：</p><blockquote><p><strong>error_log /alidata/log/nginx/error.log crit;</strong></p><p><strong>access_log /alidata/log/nginx/host.access.log main;</strong></p></blockquote><h1>关闭日志记录</h1><p>则添加：</p><blockquote><p><strong>#不记录日志信息</strong></p><p><strong>access_log off;</strong></p><p><strong>access_log /alidata/log/nginx/host.access.log main;</strong></p><p><strong>#注意：更改了配置文件之后要重新加载</strong></p></blockquote><h1>日志文件的切割</h1><p><strong>1、为了使日志文件的存储更合理、有序，可以利用计划任务crontab将日志文件自动切割</strong></p><blockquote><p>vim cutlog.sh #新建并编辑一个批处理</p></blockquote><p><strong>2、添加以下内容</strong></p><blockquote><p><strong>nowDate=$(date +%Y%m%D) #获取当前日期</strong></p><p><strong>mv /usr/local/nginx/logs/host.access.log ${nowDate}.log #将老的日志文件备份到今天的文件中</strong></p><p><strong>#cat /usr/local/nginx/nginx.pid 获取主进程号</strong></p><p><strong>kill -usr1 $(cat /usr/local/nginx/nginx.pid)</strong></p></blockquote><p><strong>3、定时执行批处理，shell中执行：</strong></p><blockquote><p><strong>crontab -e</strong></p></blockquote><p><strong>按i输入：</strong></p><blockquote><p><strong>#意思是在每天23：59分定时执行这段代码</strong></p><p><strong>23 59 *** /bin/bash /usr/local/nginx/logs/cutlog.sh</strong></p></blockquote><h1><strong>并保存，退出。</strong></h1><h1>Nginx缓存功能</h1><p><strong>觉得每次blog的打开都有点慢，怀疑是nginx没打开缓存导致的。在站点的nginx配置文件下添加以下内容：</strong></p><p><img alt=精品推荐！Nginx的日志文件、缓存、自动列目录、压缩等相关配置 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/3c6f0002cf4e96784f09></p><p><strong>其中expires 7d;表示 缓存时间为7天，7天后自动清除。</strong></p><hr><h1>Nginx自动列目录功能</h1><p>所谓的自动列目录就是，当你的目录下没有index文件的时候，浏览器访问此目录，会自动列出该目录下的文件。</p><p>实现这个功能需要同时具备两个条件：</p><p>1、不存在index之类的默认首页文件</p><p>2、服务器配置了自动列目录的功能</p><p>操作如下：</p><blockquote><p><strong>vim nginx.conf</strong></p></blockquote><p>加入以下代码：</p><blockquote><p><strong>http {</strong></p><p><strong>server {</strong></p><p><strong>.......</strong></p><p><strong>location / {</strong></p><p><strong>root /apps/oaapp;</strong></p><p><strong>index index.jsp index.html index.htm;</strong></p><p><strong>#开启自动列目录</strong></p><p><strong>autoindex on;</strong></p><p><strong>......</strong></p></blockquote><p>Nginx的Gzip压缩功能</p><p>Nginx的gzip模块是内置的，在http中添加配置，以下是配置详解：</p><blockquote><p><strong>gzip on|off</strong></p><p><strong># 默认值: gzip off</strong></p><p><strong># 开启或者关闭gzip模块</strong></p><p><strong>gzip_static on|off</strong></p><p><strong># nginx对于静态文件的处理模块</strong></p><p><strong># 该模块可以读取预先压缩的gz文件，这样可以减少每次请求进行gzip压缩的CPU资源消耗。该模块启用后，nginx首先检查是否存在请求静态文件的gz结尾的文件，如果有则直接返回该gz文件内容。为了要兼容不支持gzip的浏览器，启用gzip_static模块就必须同时保留原始静态文件和gz文件。这样的话，在有大量静态文件的情况下，将会大大增加磁盘空间。我们可以利用nginx的反向代理功能实现只保留gz文件。</strong></p><p><strong># 可以google"nginx gzip_static"了解更多</strong></p><p><strong>gzip_comp_level 4</strong></p><p><strong># 默认值：1(建议选择为4)</strong></p><p><strong># gzip压缩比/压缩级别，压缩级别 1-9，级别越高压缩率越大，当然压缩时间也就越长（传输快但比较消耗cpu）。</strong></p><p><strong>gzip_buffers 4 16k</strong></p><p><strong># 默认值: gzip_buffers 4 4k/8k</strong></p><p><strong># 设置系统获取几个单位的缓存用于存储gzip的压缩结果数据流。 例如 4 4k 代表以4k为单位，按照原始数据大小以4k为单位的4倍申请内存。 4 8k 代表以8k为单位，按照原始数据大小以8k为单位的4倍申请内存。</strong></p><p><strong># 如果没有设置，默认值是申请跟原始数据相同大小的内存空间去存储gzip压缩结果。</strong></p><p><strong>gzip_types mime-type [mime-type ...]</strong></p><p><strong># 默认值: gzip_types text/html (默认不对js/css文件进行压缩)</strong></p><p><strong># 压缩类型，匹配MIME类型进行压缩</strong></p><p><strong># 不能用通配符 text/*</strong></p><p><strong># (无论是否指定)text/html默认已经压缩</strong></p><p><strong># 设置哪压缩种文本文件可参考 conf/mime.types</strong></p><p><strong>gzip_min_length 1k</strong></p><p><strong># 默认值: 0 ，不管页面多大都压缩</strong></p><p><strong># 设置允许压缩的页面最小字节数，页面字节数从header头中的Content-Length中进行获取。</strong></p><p><strong># 建议设置成大于1k的字节数，小于1k可能会越压越大。 即: gzip_min_length 1024</strong></p><p><strong>gzip_http_version 1.0|1.1</strong></p><p><strong># 默认值: gzip_http_version 1.1(就是说对HTTP/1.1协议的请求才会进行gzip压缩)</strong></p><p><strong># 识别http的协议版本。由于早期的一些浏览器或者http客户端，可能不支持gzip自解压，用户就会看到乱码，所以做一些判断还是有必要的。</strong></p><p><strong># 注：99.99%的浏览器基本上都支持gzip解压了，所以可以不用设这个值,保持系统默认即可。</strong></p><p><strong># 假设我们使用的是默认值1.1，如果我们使用了proxy_pass进行反向代理，那么nginx和后端的upstream server之间是用HTTP/1.0协议通信的，如果我们使用nginx通过反向代理做Cache Server，而且前端的nginx没有开启gzip，同时，我们后端的nginx上没有设置gzip_http_version为1.0，那么Cache的url将不会进行gzip压缩</strong></p><p><strong>gzip_proxied [off|expired|no-cache|no-store|private|no_last_modified|no_etag|auth|any] ...</strong></p><p><strong># 默认值：off</strong></p><p><strong># Nginx作为反向代理的时候启用，开启或者关闭后端服务器返回的结果，匹配的前提是后端服务器必须要返回包含"Via"的 header头。</strong></p><p><strong>off - 关闭所有的代理结果数据的压缩</strong></p><p><strong>expired - 启用压缩，如果header头中包含 "Expires" 头信息</strong></p><p><strong>no-cache - 启用压缩，如果header头中包含 "Cache-Control:no-cache" 头信息</strong></p><p><strong>no-store - 启用压缩，如果header头中包含 "Cache-Control:no-store" 头信息</strong></p><p><strong>private - 启用压缩，如果header头中包含 "Cache-Control:private" 头信息</strong></p><p><strong>no_last_modified - 启用压缩,如果header头中不包含 "Last-Modified" 头信息</strong></p><p><strong>no_etag - 启用压缩 ,如果header头中不包含 "ETag" 头信息</strong></p><p><strong>auth - 启用压缩 , 如果header头中包含 "Authorization" 头信息</strong></p><p><strong>any - 无条件启用压缩</strong></p><p><strong>gzip_vary on</strong></p><p><strong># 和http头有关系，加个vary头，给代理服务器用的，有的浏览器支持压缩，有的不支持，所以避免浪费不支持的也压缩，所以根据客户端的HTTP头来判断，是否需要压缩</strong></p><p><strong>gzip_disable "MSIE [1-6]."</strong></p><p><strong># 禁用IE6的gzip压缩，又是因为杯具的IE6。当然，IE6目前依然广泛的存在，所以这里你也可以设置为“MSIE [1-5].”</strong></p><p><strong>IE6的某些版本对gzip的压缩支持很不好，会造成页面的假死，今天就测试出了这个问题</strong></p><p><strong>后来调试后，发现是对img进行gzip后造成IE6的假死，把对img的gzip压缩去掉后就正常了</strong></p><p><strong>为了确保其它的IE6版本不出问题，所以建议加上gzip_disable的设置</strong></p></blockquote><h1>ｐｓ：文章内容有点多，看起来比较乱，大家理解一下</h1><h1>希望大家多多支持，小编致力推荐精品，共享给大家学习交流。也欢迎大家随时留言回复，谢谢大家！</h1></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'推荐','Nginx','日志'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>