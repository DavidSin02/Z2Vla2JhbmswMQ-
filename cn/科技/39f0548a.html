<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>端智能系列文章｜端侧复杂事件实时处理框架 | 极客快訊</title><meta property="og:title" content="端智能系列文章｜端侧复杂事件实时处理框架 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/Rn8ZWA8GHj1SnA"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/39f0548a.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/39f0548a.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/39f0548a.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/39f0548a.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/39f0548a.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/39f0548a.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/39f0548a.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/39f0548a.html><meta property="article:published_time" content="2020-11-14T21:03:40+08:00"><meta property="article:modified_time" content="2020-11-14T21:03:40+08:00"><meta name=Keywords content><meta name=description content="端智能系列文章｜端侧复杂事件实时处理框架"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/39f0548a.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>端智能系列文章｜端侧复杂事件实时处理框架</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><strong class=highlight-text toutiao-origin=span>背景</strong></p><p>现在移动网络越来越发达，移动生活越来越丰富，在用户手机上可能同时存在数百种<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">APP</i>，这注定了用户使用某一款<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">APP</i>的时间也将逐渐缩短。如果用户在<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">APP</i>内仅浏览了几分钟甚至几十秒，那我们将很难为用户提供更有价值的服务与信息，大部分应用的做法是将最最热销的产品或最最火爆的活动放在应用的闪屏或是首焦上，对于闲鱼这样具有丰富业务生态的应用来说，显然还不够。</p><p>那如何在用户驻留的短暂时间内为用户提供更有价值的信息呢，闲鱼基于用户的访问路径，为用户提供了更加丰富的优质信息与服务。例如用户发布了商品，我们会推荐当前正在进行的包邮活动，用户没买到想要的商品，我们会及时给用户推荐同款。</p><p>为了实现这样的信息提供模式，闲鱼打造了一套流量调控系统，本篇将介绍该系统端侧部分的实时处理框架。</p><p><strong class=highlight-text toutiao-origin=span>实时处理框架是什么</strong></p><p>闲鱼实时流量调控系统的端侧版本是一个合作项目，我们称之为BehaviR，BehaviR框架在纵向流程上，涵盖了用户行为的实时处理，高质量的数据供给，强实时的数据传输，实时计算，决策与用户触达，在广度上能支撑用户在应用内的全场景，同时对典型场景会有定制的支持。而本篇介绍的实时处理框架即是其中的一部分，负责实时计算的闭环，让我们看下BehaviR全貌：</p><img alt=端智能系列文章｜端侧复杂事件实时处理框架 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/Rn8ZWA8GHj1SnA><p>为了完成实时计算的闭环，实时处理框架需要具备的能力：</p><img alt=端智能系列文章｜端侧复杂事件实时处理框架 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/Rn8ZWAg1hP2mhL><p>在实时处理框架中，负责规则计算的部分即是端侧计算引擎，同云侧计算引擎一样，端侧计算引擎的目的是也将获取到的无终结状态的数据进行有状态的实时流式计算。但由于计算发生在端侧，在一个输入源相对有限、运算资源相对有限、有版本限制的运算环境下，要完成上述目的，它需要解决以下几个问题：</p><ul><li><p>如何在端侧保证无终结状态的数据持续供给</p></li><li><p>如何在端侧进行有状态的实时计算</p></li><li><p>如何将实时计算结果进行有效输出</p></li></ul><p><strong>数据</strong></p><p>在端侧，数据的供给流程如图：</p><img alt=端智能系列文章｜端侧复杂事件实时处理框架 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/Rn8ZWB2Itxt6wU><p>数据的供给能力由BehaviR的数据模块完成，业务方在<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">APP</i>内集成BehaviR，然后将页面操作数据、网络请求数据、存储操作数据等有序灌给BehaviR，BehaviR会根据计算配置将待计算数据按需进行持久化和供给。例如端上指定如下配置：</p><pre><ol><li><p><code>{</code></p></li><li><p><code>"actionTypeIn":[</code></p></li><li><p><code>"leave"</code></p></li><li><p><code>],</code></p></li><li><p><code>"sceneIn":[</code></p></li><li><p><code>"https://market.m.taobao<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-4">.com</i>/<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">app</i>/idleFish-F2e/idlefish-renting/home",</code></p></li><li><p><code>"https://market.wapa.taobao<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-4">.com</i>/<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">app</i>/idleFish-F2e/idlefish-renting/home"</code></p></li><li><p><code>],</code></p></li><li><p><code>"taskArray":[</code></p></li><li><p><code>{</code></p></li><li><p><code>"taskType":"py_backtrace",</code></p></li><li><p><code>"pythonName":"test_cep_rent_rule2",</code></p></li><li><p><code>"filter":[</code></p></li><li><p><code>{</code></p></li><li><p><code>"alias":"e1",</code></p></li><li><p><code>"actionType":"leave"</code></p></li><li><p><code>},</code></p></li><li><p><code>{</code></p></li><li><p><code>"alias":"e2",</code></p></li><li><p><code>"actionType":"pv"</code></p></li><li><p><code>}</code></p></li><li><p><code>]</code></p></li><li><p><code>}</code></p></li><li><p><code>]</code></p></li><li><p><code>}</code></p></li></ol></pre><p>我们会在"actionType"内配置触发器，即BehaviR将会在"actionType"为"leave"的事件发生时，将拥有的数据提供给计算引擎。在计算发生前，计算所需要的数据类型是可预期的，因此BehaviR会根据"filter"内的配置，将数据过滤后传输给计算引擎。</p><p>在<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">APP</i>中运行计算任务前，每一个计算任务都将拥有一份这样属于自己的配置，来指定需要的计算数据类型。在BehaviR中根据端侧所有计算任务的数据需求，可以择优进行持久化来尽可能少的占用磁盘空间和内存空间。</p><p><strong>计算</strong></p><p>云侧实时计算能力已经成为了业界先驱，Flink、Siddhi、Spark等如数家珍，而端侧并没有计算框架先例，那我们在端侧需要做的，就是深入了解云侧引擎，然后针对端侧环境进行轻量化和定制化。<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-3">结合</i>我们已承接业务的经验，将计算框架从功能层面划分如下，并与云侧进行比较：</p><img alt=端智能系列文章｜端侧复杂事件实时处理框架 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/Rn8ZWBVQTKeiy><p>实时计算的窗口，可以对数据进行一定的预处理，例如按时间间隔每N秒处理一次，按数量每N个事件处理一次等。而在端上由于每个行为都有典型的特征，而大多数场景都对这些特征有着明确的预期，因此端上以Trigger的方式进行事件的处理，在Trigger上会描述我们需要开始计算的事件具有的属性，当事件属性与Trigger的属性匹配时，即开始计算。</p><p>（不确定有限）状态机和共享缓冲区是计算处理的核心，其中共享缓冲区是对状态计算中状态与事件对应关系的存储优化，我们在初版上也实现了其必要的组成部分。</p><p>在并发计划和事件时序控制上，端上暂时通过单端事件的有序录入，来保障绝大多数事件的时序，而并发的优化并不是初版的瓶颈所在，于是我们直接放弃了并发控制，在<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-5">单线</i>程上进行计算。</p><p>简而言之，我们去掉了多流处理的设计，在容错机制上弱化处理，但保留了核心的计算能力，同时将实时流处理上的概念进行融合，更加贴近我们的应用场景。关于计算部分的具体实现，后续将提供更详细的介绍。</p><p><strong>实现方案选型</strong></p><p>当框架的概念与功能确定后，我们需要考虑使用什么样的方式去实现。于是将预备的实现方案从动态性、执行效率、开发效率等方面进行了比较：</p><img alt=端智能系列文章｜端侧复杂事件实时处理框架 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/Rn8ZWBsBYc3Lik><p>由于在整个端侧处理框架研发上，我们是首次尝试落地，期望能快速验证可行性，因此项目上线及运行过程会具备很高的不确定性及稳定性风险。综上几个因素，恰逢集团能拥有高效、稳定的Python运行时框架Walle，因而我们选择在Python运行时框架下Walle，使用Python进行研发。</p><p><strong>描述及编译</strong></p><p>在开始运算前，我们会有一套基于Python的应用编程接口来描述计算逻辑，当使用该接口编写完成后，会在运行时编译并构建计算图实例，然后进行计算。该编程接口的表达以“访问详情然后离开”为例，我们可以描述为：</p><pre><ol><li><p><code><strong class=highlight-text toutiao-origin=span>Pattern</strong>('e1') \</code></p></li><li><p><code>.<strong class=highlight-text toutiao-origin=span>where</strong>(<strong class=highlight-text toutiao-origin=span>KVCondition</strong>('actionType', 'pv')) \</code></p></li><li><p><code>.<strong class=highlight-text toutiao-origin=span>and</strong>(<strong class=highlight-text toutiao-origin=span>KVCondition</strong>('scene', 'item_detail')) \</code></p></li><li><p><code>.followby('e2') \</code></p></li><li><p><code>.<strong class=highlight-text toutiao-origin=span>where</strong>(<strong class=highlight-text toutiao-origin=span>KVCondition</strong>('actionType', 'leave')) \</code></p></li><li><p><code>.<strong class=highlight-text toutiao-origin=span>and</strong>(<strong class=highlight-text toutiao-origin=span>KVCondition</strong>('scene', 'item_detail'))</code></p></li></ol></pre><p>为了云与端的体验一致性，我们也将支持从调控系统的标准DSL（该DSL已成为Blink支持的标准）到Python描述的转换，上述代码用DSL来描述，即：</p><pre><ol><li><p><code>EVENT: e1-&gt;e2</code></p></li><li><p><code>WHERE e1.extra_info.actionType = 'pv' </code></p></li><li><p><code>AND e1.extra_info.scene = 'item_detail' </code></p></li><li><p><code>AND e2.extra_info.actionType = 'leave'</code></p></li><li><p><code>AND e2.extra_info.scene = 'item_detail' </code></p></li></ol></pre><p><strong>输出</strong></p><p>当计算完成后，我们会将计算结果进行输出，在端侧的输出主要分为三个方面，一是业务权益触达，二是算法模型输入，三是另一次计算输入。</p><p>由于在业务权益触达形式上，不同的应用有着自己的展现形式和实现方式，因此我们仅保留公用的通讯协议来将计算结果进行格式化输出。在闲鱼端内，我们会介入协议的响应方，并接入闲鱼的决策分发模块进行统一管控。决策分发模块将对单次策略的触达效果进行管控，同时对同一用户的所有策略进行调控。在闲鱼应用内已经注入了丰富的触达形式供决策模块选择。</p><p>端侧的算法模型运行时，经常需要特定的行为作为模型运行的触发器，那么当计算结果作为算法模型输入时，由于在集团内端侧算法模型有统一的运行平台，因而我们需要将计算输出与统一的模型运行框架对接，支持特定的计算结果自动唤醒对应模型的运行，然后将计算结果经过有选择性的筛选后输出给算法模型。</p><p>如果需要通过多个计算策略串联计算后产出结果，那我们会提前约定好计算串联前的数据规范，当另一次计算处理需要以当前计算结果作为输入时，我们会在本次计算结果模拟为一次约定的特殊类型的行为数据并流入数据模块，然后在另一次计算配置上添加该类型数据的监听，即可顺利执行。</p><p><strong>流程回顾</strong></p><p>当我们了解了端侧复杂事件实时处理框架的各个部分后，可以用下图再回顾下整个运行过程：</p><img alt=端智能系列文章｜端侧复杂事件实时处理框架 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/Rn8ZWx3DDMrkPi><p>我们会在应用启动的时候去同步本次启动需要进行的计算任务配置，同时数据模块会开始实时处理数据，当处理的数据与任务配置相匹配时，即开始给计算框架供给数据，然后进行实时计算。计算完成后，会流转决策分发模块，由决策模块决定计算结果的输出方向，如果决策为触达用户，则会采用相关的触达配置与形式进行触达。</p><p><strong class=highlight-text toutiao-origin=span>效果及展望</strong></p><p>我们目前在闲鱼<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">APP</i>线上稳定运行了该实时处理框架的首个版本，云侧需要处理5秒左右，而现在全部流程可在毫秒级内完成，对服务器资源零消耗。</p><p>在计算细节上，我们仍然有很多需要打磨的地方，例如端上进程退出带来的计算终断问题， 少量事件乱序问题，需要能承接更多复杂场景的聚合计算等。由此，我们将为了更高效的计算和更稳定的服务而努力。更加详情的计算细节介绍，尽请期待！</p><p>闲鱼团队是Flutter+Dart FaaS前后端一体化新技术的行业领军者，就是现在！<strong class=highlight-text toutiao-origin=strong><i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-2">客户端</i>／服务端java／架构／前端／质量工程师</strong>面向社会招聘，base杭州阿里巴巴西溪园区，一起做有创想空间的社区产品、做深度顶级的开源项目，一起拓展技术边界成就极致！</p><p>*投喂简历给小闲鱼→<strong class=highlight-text toutiao-origin=span>guicai.gxy@alibaba-inc<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-4">.com</i></strong></p><img alt=端智能系列文章｜端侧复杂事件实时处理框架 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/R693yELCMK8FG4><p>开源项目、峰会直击、关键洞察、深度解读</p><p>请认准<strong class=highlight-text toutiao-origin=span>闲鱼技术</strong></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'端侧','实时','处理'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>