<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>微服务分布式架构中，如何实现日志链路跟踪？ | 极客快訊</title><meta property="og:title" content="微服务分布式架构中，如何实现日志链路跟踪？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/a3a2cecaee304124a86a864a75c38b5b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3b7ca126.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3b7ca126.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3b7ca126.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3b7ca126.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3b7ca126.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3b7ca126.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3b7ca126.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3b7ca126.html><meta property="article:published_time" content="2020-11-14T21:06:12+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:12+08:00"><meta name=Keywords content><meta name=description content="微服务分布式架构中，如何实现日志链路跟踪？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/3b7ca126.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>微服务分布式架构中，如何实现日志链路跟踪？</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><strong>欢迎关注头条号：老顾聊技术</strong></p><p><strong>精品原创技术分享，知识的组装工</strong></p><h1 class=pgc-h-arrow-right>背景</h1><p>开发排查系统问题用得<strong>最多的手段就是查看系统日志</strong>，在分布式环境中一般<strong>使用ELK来统一收集日志</strong>，但是在并发大时使用<strong>日志定位问题还是比较麻烦，</strong>我们来看下面的图</p><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a3a2cecaee304124a86a864a75c38b5b><p class=pgc-img-caption></p></div><p></p><blockquote class=ql-long-13868411><p>上图一个用户请求一个url，整个链路如图，每个处理层都会产生日志，那我们如何把这些日志串在一些，形成一个请求全路径日志。</p></blockquote><p>在现有的系统中，由于大量的其他用户/其他线程的日志也一起输出<strong>穿行其中导致很难筛选出指定请求的全部相关日志。</strong>那我们如何来处理呢？</p><h1 class=pgc-h-arrow-right>解决思路</h1><p>我们可以把<strong>每个请求弄一个唯一标识</strong>，然后我们<strong>可以在日志打印的时候代上每个请求都使用一个唯一标识</strong>，而且那个<strong>唯一标识需要传递给下游服务</strong>，<strong>下游服务打印日志的时候也带上这个唯一标识</strong>，这样就很好的追踪全部的链路显示在日志中。</p><p>那技术实现方案是什么呢？我们应该尽可能的<strong>对代码无入侵</strong>，使用<strong>Logback的MDC机制日志模板中加入traceId标识，取值方式为%X{traceId}</strong>。</p><h1 class=pgc-h-arrow-right>什么是MDC</h1><p>MDC（Mapped Diagnostic Context，映射调试上下文）<strong>是 log4j 和 logback 提供的一种方便在多线程条件下记录日志的功能</strong>。<strong>MDC 可以看成是一个与当前线程绑定的Map</strong>，可以<strong>往其中添加键值对</strong>。</p><p><strong>MDC 中包含的内容可以被同一线程中执行的代码所访问</strong>。当前线程的子线程会继承其父线程中的 MDC 的内容。当需要记录日志时，<strong>只需要从 MDC 中获取所需的信息即可</strong>。MDC 的内容则由程序在适当的时候保存进去。对于一个 Web 应用来说，通常是在请求被处理的最开始保存这些数据。</p><h1 class=pgc-h-arrow-right>方案实现</h1><p>由于MDC内部使用的是<strong>ThreadLocal所以只有本线程才有效</strong>，子线程和下游的服务MDC里的值会丢失；所以<strong>方案主要的难点是解决值的传递问题</strong>，主要包括以几下部分：</p><ul><li>API网关中的MDC数据如何传递给下游服务</li><li>服务如何接收数据，并且调用其他远程服务时如何继续传递</li><li>异步的情况下(线程池)如何传给子线程</li></ul><h1 class=pgc-h-arrow-right>修改日志模板</h1><p>logback配置文件日志格式添加该标识</p><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/55c887638fff42b682d0fd3c5530c5af><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>网关添加过滤器</h1><p>此过滤器就是来解决网关如何把MDC的数据传递给下游服务</p><p><strong>生成traceId并通过header传递给下游服务</strong></p><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3cc43457b12e481bbf6ba40a00519a78><p class=pgc-img-caption></p></div><p>上面代码有个MDC是属于org.slf4j.MDC中的，下面就是常量的值</p><pre><code>/*** 日志链路追踪id信息头*/String TRACE_ID_HEADER = "x-traceId-header";/*** 日志链路追踪id日志标志*/String LOG_TRACE_ID = "traceId";</code></pre><h1 class=pgc-h-arrow-right>下游服务增加spring拦截器</h1><p>接收并保存traceId的值</p><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6944b411109148a4a3960c9b79969892><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>下游服务增加feign拦截器</h1><p>继续把当前服务的traceId值传递给下游服务</p><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/24b473195074407c933dbaf8dbf4f015><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>解决父子线程传递问题</h1><p>主要针对业务会使用线程池(异步、并行处理)，并且spring自己也有@Async注解来使用线程池，要解决这个问题需要以下两个步骤:</p><p><strong>重写logback的LogbackMDCAdapter</strong></p><blockquote class=ql-long-13868411><p>由于logback的MDC实现内部使用的是ThreadLocal不能传递子线程，所以需要重写替换为阿里的TransmittableThreadLocal</p></blockquote><p><strong>TransmittableThreadLocal 是Alibaba开源的</strong>、用于<strong>解决 “在使用线程池等会缓存线程的组件情况下传递ThreadLocal” 问题的 InheritableThreadLocal 扩展</strong>。若希望 TransmittableThreadLocal 在线程池与主线程间传递，需配合TtlRunnable和TtlCallable使用。</p><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e28e66f3dc174be186a2a1126a9e037e><p class=pgc-img-caption></p></div><blockquote class=ql-long-13868411><p>其他代码与ch.qos.logback.classic.util.LogbackMDCAdapter一样，只需改为调用copyOnInheritThreadLocal变量</p></blockquote><p><strong>TtlMDCAdapterInitializer类</strong>用于程序启动时加载自己的mdcAdapter实现</p><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f8c5583c3d2e46849c6105fc3998d1cb><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>扩展线程池实现</h1><p>增加TtlRunnable和TtlCallable扩展</p><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4a860f9967db4b60a9f76ee285875920><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/58d3044d673e4d3aa173b00d64a7ea58><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>场景测试</h1><p><strong>测试代码如下</strong></p><pre><code>log.info("测试")@Asyncpublic void test(){  log.info("测试1")}userService.findByUserName("gu")</code></pre><p><strong>api网关打印的日志</strong></p><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d76f40a0fdbf491da7c0a94c4325fd02><p class=pgc-img-caption></p></div><p><strong>ELK聚合日志通过traceId查询整条链路日志</strong></p><p>当系统出现异常时，可直接通过该异常日志的traceId​的值，在日志中心中询该请求的所有日志信息，类似下图</p><div class=pgc-img><img alt=微服务分布式架构中，如何实现日志链路跟踪？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/82c896386f1b44bd806e12bfd84277c5><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>总结</h1><p>到此分布式的日志跟踪就已经完成了，这样就很好的可以排查整个微服务的日志链路，谢谢！！！</p><p><strong>---End---</strong></p><hr><div class=tt-column-card data-content='{"url":"","content":"","thumb_url":"http://p2.pstatp.com/large/pgc-image/9c2850b413da478abd6187d7705d657d","title":"微服务API网关框架","author_description":"老顾聊技术","price":199,"share_price":47.76,"sold":10,"column_id":"6724549139599720712","new_thumb_url":"http://sf3-ttcdn-tos.pstatp.com/img/pgc-image/9c2850b413da478abd6187d7705d657d"}'><p class=column-placeholder></p></div><blockquote class=ql-long-13868411><p>老顾的微服务网关分享课程，请大家多多支持</p></blockquote><p><strong>推荐阅读</strong></p><p>a、<a class=pgc-link data-content=mp href="https://www.toutiao.com/i6809075773232644612/?group_id=6809075773232644612" rel="noopener noreferrer" target=_blank>dubbo如何处理业务异常，这个一定要知道哦！</a></p><p>b、<a class=pgc-link data-content=mp href="https://www.toutiao.com/i6813711487660458500/?group_id=6813711487660458500" rel="noopener noreferrer" target=_blank>企业级SpringBoot应用多个子项目配置文件规划、多环境支持（一）</a></p><p>c、<a class=pgc-link data-content=mp href="https://www.toutiao.com/i6817352599189062152/?group_id=6817352599189062152" rel="noopener noreferrer" target=_blank>企业级SpringBoot应用多个子项目配置文件规划、多环境支持（二）</a></p><p>d、<a class=pgc-link data-content=mp href="https://www.toutiao.com/i6820001780399604237/?group_id=6820001780399604237" rel="noopener noreferrer" target=_blank>企业级SpringBoot应用多个子项目配置文件之配置中心（三）</a></p><p>e、<a class=pgc-link data-content=mp href="https://www.toutiao.com/i6823233475487728142/?group_id=6823233475487728142" rel="noopener noreferrer" target=_blank>利用阿里开源工具进行排查线上CPU居高问题</a></p><p>f、<a class=pgc-link data-content=mp href="https://www.toutiao.com/i6825162152513372675/?group_id=6825162152513372675" rel="noopener noreferrer" target=_blank>阿里二面：如何快速排查死锁？如何避免死锁？</a></p><p>1<strong>、</strong>基于RocketMq的SpringCloud Stream框架实战入门</p><p>2、如何搭建消息中间件应用框架之SpringCloud Stream</p><p>3<strong>、</strong>面试必备：网关异常了怎么办？如何做全局异常处理？</p><p>4<strong>、</strong>Gateway网关系列(二)：SpringCloud Gateway入门实战，路由规则</p><p>5<strong>、</strong>Gateway网关系列开篇：SpringCloud的官方网关Gateway介绍</p><p>6<strong>、</strong>API网关在微服务架构中的应用，这一篇就够了</p><p>7<strong>、</strong>学习Lambda表达式看这篇就够了，不会让你失望的哦（续篇）</p><p>8<strong>、</strong>Lambda用在哪里？几种场景？</p><p>9、为什么会出现Lambda表达式，你知道吗？</p><p>10、不说“分布式事务”理论，直接上大厂阿里的解决方案，绝对实用</p><p>11、女程序员问到这个问题，让我思考了半天，Mysql的“三高”架构</p><p>12、大厂二面：CAP原则为什么只能满足其中两项？而不能同时满足</p><p>13、阿里P7二面：聊聊零拷贝的原理</p><p>14、秒杀系统的核心点都在这里，快来取</p><p>15、你了解如何利用token方式实现分布式Session吗？</p><p>16、Mysql索引结构演变，为什么最终会是那个结构呢？让你一看就懂</p><p>17、一场比赛涉及到的知识，用通俗易通的方式介绍并发协调</p><p>18、企业实战Redis全方面思考，你思考了吗？</p><p>19、面试题：Thread的start和run的区别</p><p>20、面试题：什么是CAS？CAS的作用以及缺点</p><p>21、如何访问redis中的海量数据？避免事故产生</p><p>22、如何解决Redis热点问题？以及如何发现热点？</p><p>23、如何设计API接口，实现统一格式返回？</p><p>24、你真的知道在生产环境下如何部署tomcat吗？</p><p>25、分享一线互联网大厂分布式唯一ID设计 之 snowflake方案</p><p>26、分享大厂分布式唯一ID设计方案，快来围观</p><p>27、你想了解一线大厂的分布式唯一ID生成方案吗？</p><p>28、你知道如何处理大数据量吗？(数据拆分篇)</p><p>29、如何永不迁移数据和避免热点? 根据服务器指标分配数据量(揭秘篇)</p><p>30、你知道怎么分库分表吗？如何做到永不迁移数据和避免热点吗？</p><p>31、你了解大型网站的页面静态化吗？</p><p>32、你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？</p><p>33、你知道怎么解决DB读写分离，导致数据不一致问题吗？</p><p>34、DB读写分离情况下，如何解决缓存和数据库不一致性问题？</p><p>35、你真的知道怎么使用缓存吗？</p><p>36、如何利用锁，防止缓存击穿？重构思想的重要性</p><p>37、海量订单产生的业务高峰期，如何避免消息的重复消费？</p><p>38、你知道如何保障生产端100%消息投递成功吗？</p><p>39、微服务下的分布式session该如何管理？</p><p>40、阿里二面：filter、interceptor、aspect应如何选择？很多人中招</p><p>41、互联网架构重要组员CDN，很多高级开发都没有实操过，来看这里</p><p>42、阿里二面：CDN缓存控制原理，看看能不能难住你</p><p>43、SpringCloud Alibaba之Nacos多环境多项目管理</p><p>44、SpringCloud Alibaba系列之Nacos配置中心玩法</p><p>45、SpringCloud Alibaba之Nacos注册中心</p><p>46、SpringCloud Plus版本之SpringCloud Alibaba</p><p>47、SpringCloud Alibaba之Nacos集群、持久化</p><p>48、SpringCloud Alibaba之Nacos共享配置、灰度配置</p><p>49、SpringCloud Alibaba之Sentinel工作原理</p><p>50、SpringCloud Alibaba之Sentinel流控管理</p><p>51、SpringCloud Alibaba之Sentinel降级管理</p><p>52、SpringCloud Alibaba之Sentinel热点参数限流</p><p>53、SpringCloud Alibaba之Sentinel的API实战</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'务分','架构','实现'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>