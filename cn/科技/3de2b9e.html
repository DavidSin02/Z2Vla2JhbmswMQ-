<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>「纯干货」业务sql语句写法集锦（带例子） | 极客快訊</title><meta property="og:title" content="「纯干货」业务sql语句写法集锦（带例子） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/21e14b32e0134f9fae5a0af554992e22"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3de2b9e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3de2b9e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3de2b9e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3de2b9e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3de2b9e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3de2b9e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3de2b9e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3de2b9e.html><meta property="article:published_time" content="2020-10-29T20:59:31+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:31+08:00"><meta name=Keywords content><meta name=description content="「纯干货」业务sql语句写法集锦（带例子）"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/3de2b9e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>「纯干货」业务sql语句写法集锦（带例子）</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><br></p><p>这两年学会了跑sql，当时有很多同学帮助我精进了这个技能，现在也写成一个小教程，反馈给大家。</p><p>适用对象：工作中能接触到sql查询平台的业务同学（例如有数据查询权限的产品与运营同学）</p><p>适用场景：查询hive&mysql上的数据</p><p>文档优势：比起各类从零起步的教程教材，理解门槛低，有效信息密度大，可以覆盖高频业务场景。</p><p>文末有一些常见的小技巧，希望帮助同学们提升工作效率。</p><h1 class=pgc-h-decimal data-index=01>SQL的基础结构：</h1><p>做一个类比，我们用的“表”，就像是一个账本，每天就是一个“分区”，“字段”就是日记上记的不同的事情，例如支出、收入、物品和价格等；</p><p>一般来讲sql有如下结构，意思是从表α.table里面，获取某一天的abc三个字段，后面的讲解都是在这个基础上展开的：</p><pre><code>select                             a,b,c         //select后面输入需要查询的字段fromα.table        //from后面输入需要查询的表名wheredate='yymmdd' //where后面输入需要卡的条件，例如只看哪天的数据</code></pre><h1 class=pgc-h-decimal data-index=02>多个条件同时生效-and和or</h1><p>and的用法//表示多条件同时生效</p><pre><code>select                             a,b,c         //select后面输入需要查询的字段fromα.table       //from后面输入需要查询的表名where         date='yymmdd' //where后面输入需要卡的条件，例如只看哪天的数据and           //表示要看date='yymmdd' 且id='XXX'id=XXX</code></pre><h1 class=pgc-h-decimal data-index=03>or的用法//表示有一个条件生效即可</h1><pre><code>select                             a,b,c         //select后面输入需要查询的字段fromα.table        //from后面输入需要查询的表名where         date='yymmdd' //where后面输入需要卡的条件，例如只看哪天的数据and           (id=XXXor d_id=XXX)   //表示要看date='yymmdd' ，且id是xxx或d_id是xxx的数据。如果没有这个括号，表示的是要看date是yymmdd且id是xxx，或者不分日期，d_id是xxx的数据</code></pre><h1 class=pgc-h-decimal data-index=04>对指标进行加和//sum</h1><p>学习到本节时，我们需要明白维度和指标的区别，维度是表示属性的，指标是表示量级的，例如全中国有56个民族，全中国就是一个维度，民族数量就是一个指标</p><pre><code>select        //select后面输入需要查询的字段a,b,sum(c)    //需要加和的c字段（指标）括起来加sum即可，有点像excel那种fromα.table        //from后面输入需要查询的表名where         date='yymmdd' //where后面输入需要卡的条件，例如只看哪天的数据and           (id=XXXor sp_id=XXX)   //表示要看date='yymmdd' ，且id是xxx或sp_id是xxx的数据。如果没有这个括号，表示的是要看date是yymmdd且id是xxx，或者不分日期，sp_id是xxx的数据group by a,b  //没有被处理的字段（维度），需要在尾部group by 一下</code></pre><h1 class=pgc-h-decimal data-index=05>为字段重新命名//as</h1><pre><code>select        //select后面输入需要查询的字段a,b as b1,sum(c) as c1   //需要加和的c字段括起来加sum即可，有点像excel那种；这里用as把b重新命名成了b1，把c重新命名成了c1fromα.table        //from后面输入需要查询的表名where         date='yymmdd' //where后面输入需要卡的条件，例如只看哪天的数据and           (id=XXXor sp_id=XXX)   //表示要看date='yymmdd' ，且id是xxx或sp_id是xxx的数据。如果没有这个括号，表示的是要看date是yymmdd且id是xxx，或者不分日期，sp_id是xxx的数据group by a,b  //没有被处理的字段，需要在尾部group by 一下；被重新命名的维度字段，group by时仍用as前面的内容</code></pre><h1 class=pgc-h-decimal data-index=06>查数据条数，或查询维度的数量//count和distinct</h1><pre><code>select        //select后面输入需要查询的字段a,b,sum(c),   //需要加和的c字段括起来加sum即可，有点像excel那种count(distinct d)//去重查询在a,b枚举下,d有几个,例如查ka,la(a)的客户id(b)下,总共有几个广告主(d);不加distinct查询的是所有的广告主(d)总共出现了几次fromα.table        //from后面输入需要查询的表名where         date='yymmdd' //where后面输入需要卡的条件，例如只看哪天的数据and           (id=XXXor sp_id=XXX)   //表示要看date='yymmdd' ，且id是xxx或sp_id是xxx的数据。如果没有这个括号，表示的是要看date是yymmdd且id是xxx，或者不分日期，sp_id是xxx的数据group by a,b  //没有被处理的字段，需要在尾部group by 一下</code></pre><h1 class=pgc-h-decimal data-index=07>对一份数据做多次处理//嵌套结构</h1><pre><code>如下sql查询了每个人在当天的页面访问频次。3到7行先查询出每个用户id的页面访问频次，然后使用3到7行的结果，查询每个访问频次下，有几个id：SELECT cnt,count(id)FROM(select id,count(*) as cnt  //-'*'可以用来查询行数from α.tablewhere date ='20190928' and label='show'group by id) a                          //-这里写一个'a',用来给3到7行的结果命名,这样外层的sql才能识别括号里面的内容group by cnt</code></pre><h1 class=pgc-h-decimal data-index=08>对多份数据做关联处理//join</h1><p>最常用的场景：假设表A上有门店id是a，收入是b，表B上有门店id是a，门店名称c，如果需要获取门店id，收入，门店名称的关系，可以这么写：</p><pre><code>SELECT a,b,cFROM(select a,sum (b)  from A group by a) cost                //-为3到6行的sql命名为costleft join (           //-这里使用左连接select a,cfrom B group by a,c )text    //-为8到10行的sql命名为texton cost.a=text.a      //-这里需要写清连接两段sql的字段</code></pre><p><br></p><p>放下这张图,形象的表达了各种join方法，获取的数据范围。想获取对应数据时，替换上边第7行就可以用：</p><div class=pgc-img><img alt=「纯干货」业务sql语句写法集锦（带例子） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/21e14b32e0134f9fae5a0af554992e22><p class=pgc-img-caption>（图片来源于网络，侵删）</p></div><h1 class=pgc-h-decimal data-index=09>条件判断，对同一个字段做区分计算//if 和case when</h1><p><strong>判断一次是否//if</strong></p><pre><code>select a,sum (b),if (label = 'show_over', duration, 0) //这一句的意思是，当这一行数据的label是show_over的时候，取duration这个字段里的值，label不是show_over的时候，取0from A group by a</code></pre><p><strong>判断一次或多次是否//case when</strong></p><p>多加判断的方式见4和5两行：</p><pre><code>select a,sum (b),case when label = 'pv' then durationwhenlabel='play' then mockdurationelse 0end,                        //2到4行的意思是，当这一行数据的label是pv的时候，取duration这个字段里的值，如果label是play的时候，取duration这个字段里的值，如果还没有，就取0from A group by a</code></pre><p><br></p><h1 class=pgc-h-decimal data-index=10>除法取整//floor</h1><pre><code>select a,floor (X/100)  //-把X按100分档，0档表示X在[0,100)之间，1档表示X在[100,200)之间，以此类推from A group by a</code></pre><h1 class=pgc-h-decimal data-index=11>筛选字段为空/不为空的方法//null</h1><pre><code>select a,sum (b)from A where type is not null //找出type 不是null的情况，不加"not",就是找出type 是null的情况group by a</code></pre><h1 class=pgc-h-decimal data-index=12>各种常见类型字段、指定值的查询方法：</h1><ul><li>string：加单引号即可，例如一个字段type是string，就可以写：</li></ul><pre><code>select a,sum (b)from A where type='1'   //-string加单引号group by a</code></pre><ul><li>bigint：后面加一个L，例如一个字段type是bigint，就可以写：</li></ul><pre><code>select a,sum (b)from A where type=1L    //- bigint后加Lgroup by a</code></pre><ul><li>array&lt;XXX>：XXX代表数组内的字段类型，需要根据此类型的方式取数，假设model字段的类型是array&lt;bigint>：</li></ul><pre><code>select a,sum (b)from A where array_contains(model,123L)group by a</code></pre><ul><li>json：json经常会出现字段包字段的情况，例如常用的data是个json字段，里面会有a字段，a字段里面还会有b字段，如果想取出b，我们应该这么写：</li></ul><pre><code>select get_json_object(data,'$.a.b') from A</code></pre><h1 class=pgc-h-decimal data-index=13>扩展阅读</h1><p><strong>一些提升效率的方法</strong></p><ul><li>时间分区有多种存储方式，查询where条件的时候需要注意：有的表是‘yymmdd’，有的表是‘yy-mm-dd’；字段名也不固定，有的表是p_date，有的表是date，但是对於单个表，分区字段一般是固定的，例如你经常查a.bcde这个表，上次他的时间分区格式是date=‘yymmdd’，下次查的时候它还会是date=‘yymmdd’；</li><li>有时表中的时间戳不是常见的yymmdd，而是一串数字，如果where条件里需要卡时间戳，却不知道日期对应的一串数字是什么，可使用时间戳转换器转换：https://tool.lu/timestamp/</li><li>sql没数、跑错怎么办：有时解析功能没有发现问题，但是数据直观感觉不对，可以用如下方式自查：</li><li>检查相关表的分区，和你取的分区一致不一致，例如日期有多种格式，例如yymmdd，yy-mm-dd，yy-mm-dd 00:00:00等等；</li><li>如果sql包含多个部分，比如有join，可以把其他部分的sql注释掉，分别看每个部分的sql哪里有问题；（注释方式：代码前加“//” 例如 //select ...）</li><li>需要研究单个json字段的逻辑：可以用这个网址整理json字段，方便阅读：https://www.json.cn/</li><li>同时编辑多行，可以按住shift+alt/option，鼠标点击起始行和结束行，就能同时编辑多行了，例如批量</li></ul><p><strong>常用概念的解释</strong></p><ul><li>全量表和增量表</li></ul><p>增量表：每天存下来的数据，是当天产生的所有数据，例如日记，每日走路的步数，银行每天的收支信息等；</p><p>全量表：每天存下来的数据，是从有表开始所有的数据，相当于每天抄一份历史上所有的日记，再写今天的日记，例如银行账户的余额；</p><ul><li>不同数据库的区别</li></ul><p>mysql等实时查询的数据库：一般没有分区概念，存储的数据比较少，但是响应快；</p><p>hive等离线查询数据库：有分区概念，可以较低成本的存储海量数据，支持各种复杂处理，查询速度一般比mysql慢。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'纯干货','业务','sql'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>