<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>技术帖：Node.js各种异步模式是如何实现与数据库交互？ | 极客快訊</title><meta property="og:title" content="技术帖：Node.js各种异步模式是如何实现与数据库交互？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/3202000408db3cf640af"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3f0755b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3f0755b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3f0755b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3f0755b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3f0755b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3f0755b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3f0755b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3f0755b.html><meta property="article:published_time" content="2020-10-29T20:50:33+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:33+08:00"><meta name=Keywords content><meta name=description content="技术帖：Node.js各种异步模式是如何实现与数据库交互？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/3f0755b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>技术帖：Node.js各种异步模式是如何实现与数据库交互？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>与数据库交互看起来是一个很简单的事情，但由于Node.js的异步性质使得这一切并不是那么简单。通过Node.js编写异步代码有很多选择，每个都需要进行不同编码。在本系列中，我们将提供一些示例来说明如何利用各种异步模式获取、使用和关闭连接。在这篇文章中，我们将探讨异步编程与传统编程的区别。</p><p><strong>try...catch...finally</strong></p><p>JavaScript有一个try…catch…finally语句，try…catch部分很容易：运行某些代码并捕获异常，以便它们得到适当处理。但为什么我们需要finally？finally提供了一种允许你运行代码清理的方法，无论异常在try还是catch块中。清理代码通常包括关闭文件处理和数据库链接。</p><p>下面是例子：</p><p><img alt=技术帖：Node.js各种异步模式是如何实现与数据库交互？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/3202000408db3cf640af></p><p>如果你在浏览器控制台（或者Node.js）中运行，你会在控制到看到类似内容：</p><p><img alt=技术帖：Node.js各种异步模式是如何实现与数据库交互？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/31fb00006b0d0eff0b98></p><p>请注意catch块中引发的bar异常最终会作为未处理的异常，但在finally块执行之前不会起作用。</p><p>如果我们在Node.js中运行的所有代码都是异步，我们可以这样做：</p><p>不幸的是，try…catch…finally对于异步代码并不是非常有用—至少在异步函数可用之前，原因与Node.js中异步工作原理有关。</p><p><strong>异步</strong><strong>/</strong><strong>事件处理</strong></p><p>下面让我们看看异步操作如何执行，例如执行HTTP请求和执行数据库查询。</p><p><img alt=技术帖：Node.js各种异步模式是如何实现与数据库交互？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/321a00006b80a58d8d51></p><p>所有JavaScript代码在主线程运行，异步API从主线程调用并传递回调函数。根据类型不同，异步工作可能完全作为事件或者可能利用线程池。当异步工作完成时，回调函数被添加到回调对象，以便尽快在主线程上调用。</p><p>对于这种架构，在异步处理期间发生的错误会在完全不同的调用堆栈中带回到主线程。你不能捕捉在不同调用堆栈中引发的错误—为时太晚！</p><p>下面是调用异步API的非常简单的演示：</p><p>setTimeout(function() {</p><p>console.log('hello');</p><p>}, 2000);</p><p>console.log('world');</p><p>如果你在浏览器控制台或Node.js中运行该脚本，则输出是：</p><p>world</p><p>hello</p><p>在hello前两秒看到world会让异步编程新手感到惊讶。这里的秘密是传递到setTimeout的回调函数，它会“回调”，或者当指定时间过去时在主线程执行。</p><p>回调函数可追溯到JavaScript的开始，JavaScript被设计为将生活带到网络的语言。JavaScript开发人员需要将代码与事件关联（例如加载页面、点击鼠标或者按键），随着时间推移，下面这种DOM API被引入：</p><p>window.addEventListener('load', function() {</p><p>// do some work</p><p>});</p><p>上面的addEventListener方法将传入的异步函数作为第二个参数，并将其添加到windows元素load event相关的侦听器列表中。当该事件发生时，所有监听器被添加到回调对象，并将尽快被调用。</p><p>为了让回调正常工作，JavaScript中的函数需要重要的功能：它们需要是第一类对象，并需要关闭。</p><p><strong>函数作为第一类</strong><strong></strong></p><p>函数作为第一类对象的概念听起来很复杂。大多数编程语言提供了声明变量和创建命名代码单元的方法，通常被称为函数或过程。这两种结构之间通常有明确的区别，例如，你可以声明变量并将其传递给函数，但你不能将函数传递给函数。</p><p>另一方面，JavaScript允许函数可用作更标准数据类型（例如Number、String和Boolean）。函数可以被声明，从函数传递到函数，并可在未来某个时候被调用。函数作为第一类对象是传递函数到另一函数的前提条件。</p><p>想象一下，当页面加载以及当用户点击窗口时你想要执行相同的代码，你可以这样做：</p><p>window.addEventListener('load', function() {</p><p>// do some work</p><p>});</p><p>window.addEventListener('click', function() {</p><p>// do the same work here</p><p>});</p><p>上面代码的问题在于我们需要维持做相同工作的两个函数。然后，如果知道函数是第一类对象，我们可声明单一的命名函数，并根据需要传递引用。</p><p>function doWork() {</p><p>// do some work</p><p>}</p><p>window.addEventListener('load', doWork);</p><p>window.addEventListener('click', doWork);</p><p>你可以看到，函数作为第一类对象是简单而强大的JavaScript功能。</p><p><strong>函数提供闭合</strong></p><p>闭合的概念可能有点难理解，但它对异步/事件编程来说至关重要。简单来说，闭合是指在其封闭范围定义的变量的函数。</p><p>很多语言允许开发人员在函数中嵌套函数，子函数可引用父函数范围中声明的变量。使用其他语言的开发人员可能永远不会想到，如果在父函数完成执行后运行时调用子函数会发生什么？这根本不可能，但JavaScript并非如此！</p><p>请记住，JavaScript中的函数是第一类对象，所以与分配给变量的任何其他值一样，它们可通过传递来逃避其父函数的限制。当发生这种情况时，原始封闭范围（词汇范围）内对变量的引用仍将存在。那么，在以后调用子函数时应该怎么办？</p><p>闭合确保子函数能够访问这些变量，只要运行时可能需要调用子函数。这些变量不会像平常那样作为垃圾回收。</p><p>下面是示例：</p><p><img alt=技术帖：Node.js各种异步模式是如何实现与数据库交互？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/31fb00006cb3cb53dec7></p><p>你可将此代码复制并粘贴到具有.html扩展名的文件中，并在浏览器中打开。你会看到一个按钮写着“点击我”，当窗口加载时，onLoad函数会将onClick函数注册到按钮的click事件。</p><p>请注意，onClick不会在onLoad内调用。相反，应用被传递到API，可在未来调用该函数。因为onClick是指onLoad函数中声明的button变量，闭合可确保onClick在未来调用时可访问button。</p><p>现在我们已经探讨了JavaScript中异步编程相关的一些核心概念，下面让我们将注意力转移到Node.js中涉及的异步模式。</p><p><strong>常见异步模式</strong></p><p>目前，通过Node.js编写异步代码最常见（通用）模式是回调、异步模块和promise。Node.js 7.6版本升级到8版本，其中引入了被称为异步函数的异步处理新方法。</p><p>异步函数允许Javascript代码异步编写，且可异步执行。最重要的是，异步结构可按照你期望的方式运作。对于JavaScript来说，异步函数是重要变革，但promise以及异步处理仍然很重要。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'技术','Node','js'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>