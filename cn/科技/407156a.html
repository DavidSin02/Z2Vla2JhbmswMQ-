<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Istio1.4.5系列——流量治理 | 极客快訊</title><meta property="og:title" content="Istio1.4.5系列——流量治理 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/175d216bd88f40b2b7cd80a98027572d"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/407156a.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/407156a.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/407156a.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/407156a.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/407156a.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/407156a.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/407156a.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/407156a.html><meta property="article:published_time" content="2020-10-29T20:52:48+08:00"><meta property="article:modified_time" content="2020-10-29T20:52:48+08:00"><meta name=Keywords content><meta name=description content="Istio1.4.5系列——流量治理"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/407156a.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Istio1.4.5系列——流量治理</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div class=pgc-img><img alt=Istio1.4.5系列——流量治理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/175d216bd88f40b2b7cd80a98027572d><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>介绍</h1><p>流量治理是一个非常宽泛的话题， 例如：</p><ul><li>动态修改服务间访问的负载均衡策略， 比如根据某个请求特征做会话保持；</li><li>同一个服务有两个版本在线， 将一部分流量切到某个版本上；</li><li>对服务进行保护， 例如限制并发连接数、 限制请求数、 隔离故障服务实例等；</li><li>动态修改服务中的内容， 或者模拟一个服务运行故障等。</li></ul><p>在Istio中实现这些服务治理功能时无须修改任何应用的代码。 较之微服务的SDK方式， Istio以一种更轻便、 透明的方式向用户提供了这些功能。 用户可以用自己喜欢的任意语言和框架进行开发， 专注于自己的业务， 完全不用嵌入任何治理逻辑。 只要应用运行在Istio的基础设施上， 就可以使用这些治理能力。</p><p>一句话总结 Istio 流量治理的目标： 以基础设施的方式提供给用户非侵入的流量治理能力， 用户只需关注自己的业务逻辑开发， 无须关注服务访问管理。<br>在控制面会经过如下流程：<br>（ 1） 管理员通过命令行或者API创建流量规则；<br>（ 2） Pilot将流量规则转换为Envoy的标准格式；<br>（ 3） Pilot将规则下发给Envoy。<br>在数据面会经过如下流程：<br>（ 1） Envoy拦截Pod上本地容器的Inbound流量和Outbound流量；<br>（ 2） 在流量经过Envoy时执行对应的流量规则， 对流量进行治理。<br>下面具体看看Istio提供了哪些流量治理功能。 因为Istio提供的流量治理功能非常多， 所以这里仅从业<br>务场景上列举出典型和常用的功能。 读者可以根据后面介绍的规则构建更多的场景。</p><h1 class=pgc-h-arrow-right>负载均衡</h1><p>负载均衡从严格意义上讲不应该算治理能力， 因为它只做了服务间互访的基础工作， 在服务调用方<br>使用一个服务名发起访问的时候能找到一个合适的后端， 把流量导过去。<br>传统的负载均衡一般是在服务端提供的， 例如用浏览器或者手机访问一个 We b 网站<br>时， 一般在网站入口处有一个负载均衡器来做请求的汇聚和转发。 服务的虚拟 IP 和后端实例一般是通过静态配置文件维护的， 负载均衡器通过健康检查保证客户端的请求被路由到健康的后端实例上。<br>在微服务场景下， 负载均衡一般和服务发现配合使用， 每个服务都有多个对等的服务实例， 需要有<br>一种机制将请求的服务名解析到服务实例地址上。 服务发现负责从服务名中解析一组服务实例的列表，负载均衡负责从中选择一个实例。<br>不管是 SDK 的微服务架构， 还是Istio这样的<br>Service Mesh架构， 服务发现和负载均衡的工作流程都是类似的， 如下所述。<br>（ 1） 服务注册。 各服务将服务名和服务实例的对应信息注册到服务注册中心。<br>（ 2） 服务发现。 在客户端发起服务访问时， 以同步或者异步的方式从服务注册中心获取服务对应的<br>实例列表。<br>（ 3） 负载均衡。 根据配置的负载均衡算法从实例列表中选择一个服务实例。</p><h1 class=pgc-h-arrow-right>服务熔断</h1><p>熔断器在生活中一般指可以自动操作的电气开关， 用来保护电路不会因为电流过载或者短路而受<br>损， 典型的动作是在检测到故障后马上中断电流。<br>“熔断器”这个概念延伸到计算机世界中指的是故障检测和处理逻辑， 防止临时故障或意外导致系统<br>整体不可用， 最典型的应用场景是防止网络和服务调用故障级联发生， 限制故障的影响范围， 防止故障蔓延导致系统整体性能下降或雪崩。<br>(1) <strong>Hystrix</strong>熔断<br>关于熔断， 大家比较熟悉的一个落地产品就是Hystrix。 Hystrix是Netflix提供的众多服务治理工具集中<br>的一个， 在形态上是一个Java库， 在2011年出现， 后来多在Spring Cloud中配合其他微服务治理工具集一<br>起使用。<br>Hystrix的主要功能包括：<br>◎ 阻断级联失败， 防止雪崩；<br>◎ 提供延迟和失败保护；<br>◎ 快速失败并即时恢复；<br>◎ 对每个服务调用都进行隔离；<br>◎ 对每个服务都维护一个连接池， 在连接池满时直接拒绝访问；<br>◎ 配置熔断阈值， 对服务访问直接走失败处理 Fallback 逻辑， 可以定义失败处理逻辑；<br>◎ 在熔断生效后， 在设定的时间后探测是否恢复， 若恢复则关闭熔断；<br>◎ 提供实时监控、 告警和操作控制。<br>Hystrix的熔断机制基本上与Martin的熔断机制一致。 在实现上， 如图3-8所示， Hystrix将要保护的过<br>程封装在一个 HystrixCommand 中， 将熔断功能应用到调用的方法上， 并监视对该方法的失败调用， 当失<br>败次数达到阈值时， 后续调用自动失败并被转到一个Fallback方法上。 在 HystrixCommand 中封装的要保<br>护的方法并不要求是一个对远端服务的请求， 可以是任何需要保护的过程。 每个 HystrixCommand都可以<br>被设置一个 Fallback方法， 用户可以写代码定义Fallback方法的处理逻辑。<br>(2) <strong>Istio</strong>熔断<br>云原生场景下的服务调用关系更加复杂， 前文提到的若干问题也更加严峻， Istio提供了一套非侵入的<br>熔断能力来应对这种挑战。与Hystrix类似， 在Istio中也提供了连接池和故障实例隔离的能力， 只是概念术语稍有不同： 前者在Istio 的配置中叫作连接池管理， 后者叫作异常点检测， 分别对应 Envoy的熔断和异常点检测。</p><h1 class=pgc-h-arrow-right>故障注入</h1><p>对于一个系统， 尤其是一个复杂的系统， 重要的不是故障会不会发生， 而是什么时候发生。 故障处<br>理对于开发人员和测试人员来说都特别耗费时间和精力： 对于开发人员来说， 他们在开发代码时需要用20%的时间写80%的主要逻辑， 然后留出80%的时间处理各种非正常场景； 对于测试人员来说， 除了需要用80%的时间写20%的异常测试项， 更要用超过80%的时间执行这些异常测试项， 并构造各种故障场景，尤其是那种理论上才出现的故障， 让人苦不堪言。<br>故障注入是一种评估系统可靠性的有效方法， 最早在硬件场景下将电路板短路来其观察对系统的影<br>响， 在软件场景下也是使用一种手段故意在待测试的系统中引入故障， 从而测试其健壮性和应对故障的能力， 例如异常处理、 故障恢复等。 只有当系统的所有服务都经过故障测试且具备容错能力时， 整个应用才健壮可靠。<br>故障注入从方法上来说有编译期故障注入和运行期故障注入， 前者要通过修改代码来模拟故障， 后<br>者在运行阶段触发故障。 在分布式系统中， 比较常用的方法是在网络协议栈中注入对应协议的故障， 干预服务间的调用， 不用修改业务代码。 Istio的故障注入就是这样一种机制的实现， 但不是在底层网络层破坏数据包， 而是在网格中对特定的应用层协议进行故障注入， 虽然在网络访问阶段进行注入， 但其作用于应用层。 这样， 基于 Istio 的故障注入就可以模拟出应用的故障场景了。<br>还可以注入一个指定的延时， 这样客户端看到的就跟服务端真的响应慢一样， 我们无须为了达到这<br>种效果在服务端的代码里添一段sleep（ 500）。</p><p>实际上， 在 Istio 的故障注入中可以对故障的条件进行各种设置， 例如只对某种特定请求注入故障，<br>其他请求仍然正常。</p><h1 class=pgc-h-arrow-right>灰度发布</h1><p>在新版本上线时， 不管是在技术上考虑产品的稳定性等因素， 还是在商业上考虑新版本被用户接受<br>的程度， 直接将老版本全部升级是非常有风险的。 所以一般的做法是， 新老版本同时在线， 新版本只切分少量流量出来， 在确认新版本没有问题后， 再逐步加大流量比例。 这正是灰度发布要解决的问题。 其核心是能配置一定的流量策略， 将用户在同一个访问入口的流量导到不同的版本上。 有如下几种典型场景。<br><strong>1.</strong>蓝绿发布<br>蓝绿发布的主要思路 让新版本部署在另一套独立的资源上， 在新版本可用后将所有流量都从老版本切到新版本上来。 当新版本工作正常时， 删除老版本； 当新版本工作有问题时， 快速切回到老版本， 因此蓝绿发布看上去更像一种热部署方式。 在新老版本都可用时， 升级切换和回退的速度都可以非常快， 但快速切换的代价是要配置冗余的资源， 即有两倍的原有资源， 分别部署新老版本。 另外， 由于流量是全量切换的， 所以如果新版本有问题， 则所有用户都受影响， 但比蛮力发布在一套资源上重新安装新版本导致用户的访问全部中断， 效果要好很多。<br><strong>2.AB</strong>测试<br>AB测试的场景比较明确， 就是同时在线上部署A和B两个对等的版本来接收流量，按一定的目标选取策略让一部分用户使用 A 版本， 让一部分用户使用 B版本， 收集这两部分用户的使用反馈， 即对用户采样后做相关比较， 通过分析数据来最终决定采用哪个版本。<br><strong>3.</strong>金丝雀发布<br>金丝雀发布就比较直接，上线一个新版本， 从老版本中切分一部分线上流量到新版本来判定新版本在生产环境中的实际表现。 就像把一个金丝雀塞到瓦斯井里面一样， 探测这个新版本在环境中是否可用。 先让一小部分用户尝试新版本， 在观察到新版本没有问题后再增加切换的比例， 直到全部切换完成， 是一个渐变、 尝试的过程。<br>蓝绿发布、 AB 测试和金丝雀发布的差别比较细微， 有时只有金丝雀才被称为灰度发布， 这里不用太<br>纠缠这些划分， 只需关注其共同的需求， 就是要支持对流量的管理。 能否提供灵活的流量策略是判断基础设施灰度发布支持能力的重要指标。<br>灰度发布技术上的核心要求是要提供一种机制满足多不版本同时在线， 并能够灵活配置规则给不同<br>的版本分配流量， 可以采用以下几种方式。<br><strong>1.</strong>基于负载均衡器的灰度发布<br>比较传统的灰度发布方式是在入口的负载均衡器上配置流量策略， 这种方式要求负载均衡器必须支<br>持相应的流量策略， 并且只能对入口的服务做灰度发布， 不支持对后端服务单独做灰度发布。<br><strong>2.</strong>基于<strong>Kubernetes</strong>的灰度发布<br>在Kubernetes环境下可以基于Pod的数量比例分配流量。 比如某个服务的两个版本v2和v1分别有两个和3个实例， 当流量被均衡地分发到每个实例上时， 前者可以得到40%的流量， 后者可以得到60%的流量， 从而达到流量在两个版本间分配的效果。给 v1和 v2版本设置对应比例的 Pod 数量， 依靠 Kube-proxy把流量均衡地分发到目标后端， 可以解决一个服务的多个版本分配流量的问题， 但是限制非常明显： 首先， 要求分配的流量比例必须和 Pod 数量成比例， 在当前的 Pod 比例下不支持得到3： 7的流量比例， 试想， 基于这种方式支持3： 97比例的流量基本上是不可能的； 另外， 这种方式不支持根据请求的内容来分配流量， 比如要求Chrome浏览器发来的请求和IE浏览器发来的请求分别访问不同的版本。<br>有没有一种更细粒度的分流方式？ 答案当然是有， Istio就可以。 Istio叠加在Kubernetes之上， 从机制<br>上可以提供比Kubernetes更细的服务控制粒度及更强的服务管理能力， 该管理能力几乎包括本章的所有内容， 对于灰度发布场景， 和刚才Kubernetes的用法进行比较会体现得更明显。<br><strong>3.</strong>基于<strong>Istio</strong>的灰度发布<br>不同于前面介绍的熔断、 故障注入、 负载均衡等功能， Istio本身并没有关于灰度发布的规则定义， 灰<br>度发布只是流量治理规则的一种典型应用， 在进行灰度发布时， 只要写个简单的流量规则配置即可。<br>Istio在每个Pod里都注入了一个Envoy， 因而只要在控制面配置分流策略， 对目标服务发起访问的每<br>个Envoy便都可以执行流量策略， 完成灰度发布功能。</p><h1 class=pgc-h-arrow-right>服务访问入口</h1><p>一组服务组合在一起可以完成一个独立的业务功能， 一般都会有一个入口服务， 从外部可以访问，<br>主要是接收外部的请求并将其转发到后端的服务， 有时还可以定义通用的过滤器在入口处做权限、 限流等功能，<br><strong>1.Kuberntes</strong>服务的访问入口<br>在 Kubernetes 中可以将服务发布成 Loadbalancer 类型的 Service， 通过一个外部端口就能访问到集群中的指定服务， 从外部进来的流量不用经过过滤和多余处理， 就被转发到服务上。 这种方式直接、 简单， 在云平台上部署的服务一般都可以依赖云厂商提供的Loadbalancer来实现。<br>Kubernetes支持的另一种Ingress方式专门针对七层协议。 Ingress作为一个总的入口， 根据七层协议中的路径将服务指向不同的后端服务。其中， Ingress是一套规则定义， 将描述某个域名的特定路径的请求转发到集群指定的Service后端上。 Ingress Controller作为Kubernetes的一个控制器， 监听Kube-apiserver的Ingress对应的后端服务， 实时获取后端Service和Endpoints等的变化， 结合Ingress配置的规则动态更新负载均衡器的路由配置。<br><strong>2.Istio</strong>服务访问入口<br>在Istio中通过Gateway访问网格内的服务。 这个Gateway和其他网格内的Sidecar一样，也是一个Envoy， 从Istio的控制面接收配置， 统一执行配置的规则。 Gateway一般被发布为Loadbalancer类<br>型的Service， 接收外部访问， 执行治理、 TLS终止等管理逻辑， 并将请求转发给内部的服务。</p><h1 class=pgc-h-arrow-right>外部接入服务治</h1><p>随着系统越来越复杂， 服务间的依赖也越来越多， 当实现一个完整的功能时， 只靠内部的服务是无<br>法支撑的。 且不说当前云原生环境下的复杂应用， 就是在多年前的企业软件开发环境下， 自己开发的程序也需要搭配若干中间件才能完成， 后端依赖一个数据库服务， 这就需要一种机制能将数据库服<br>务接入并治理。 在当前的云化场景下， 这个数据库可以是部署的一个外部服务， 也可以是一个RDS的云服务。 在托管的云平台上搭建的应用一般都会访问数据库、 分布式缓存等中间件服务。<br>关于这种第三方服务的管理，Istio可以方便地对网格内的服务访问进行治理， 那么如何对这种网格外的服务访问进行治理呢？ 从实际需求上看， 对一个数据库访问进行管理， 比对两个纯粹的内部服务访问进行管理更重要。 在Istio中是通过一个ServiceEntry的资源对象将网格外的服务注册到网格上， 然后像对网格内的普通服务一样对网格外的服务访问进行治理的。</p><p>关于以上Istio强大的流量治理，下节将从virtualservice、destinationrule、gateway、serviceentry理解和实战。</p><p>如果对您有帮助，记得不要忘了给个关注哦！！！<a class=tteditor-mention data-concern-id data-id data-name=上海IT故事 data-uid>@上海IT故事</a></p><p>还可以关注我之前的文章：</p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6751354779600962051/?group_id=6751354779600962051" rel="noopener noreferrer" target=_blank>@监控系列 Prometheus</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6745439411091014156/?group_id=6745439411091014156" rel="noopener noreferrer" target=_blank>@公司IT系统账号大统一体系</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6797598788056777220/?group_id=6797598788056777220" rel="noopener noreferrer" target=_blank>@kube-prometheus</a></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Istio1.4','流量','治理'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>