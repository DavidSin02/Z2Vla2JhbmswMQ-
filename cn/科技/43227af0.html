<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划 | 极客快訊</title><meta property="og:title" content="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/RzRJaGZHUGczH5"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/43227af0.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/43227af0.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/43227af0.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/43227af0.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/43227af0.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/43227af0.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/43227af0.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/43227af0.html><meta property="article:published_time" content="2020-11-14T21:00:22+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:22+08:00"><meta name=Keywords content><meta name=description content="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/43227af0.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJaGZHUGczH5><p>作者 | Haor.L</p><p>责编 | 王晓曼</p><p>出品 | CSDN博客</p><p>笔者最近参加了校内的一场物联网开发竞赛，从零开始，<strong>踩坑无数，感觉很多时候事情都不像预料的一样发展</strong>，离开了美好的IDE，太多事情要在板子上一步步摸索。<strong>运行失败还好，运行成功但BUG了，简直不知道从何查起</strong>。</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJaHX9AGpgCF><p>但认识了M5Stack简单的线上系统，学习了MQTT，HTTP等数据传输方式，入门Arduino和MIrcopython等开发语言，接触ESP32的板子，感受最深的一点就是，<strong>物联网的准入门槛并没有那么高，成本也没有那么高</strong>，但这还是一片混沌未开的区域，进场者真的可以大有所为，<strong>起码方便自己的日常生活是绰绰有余的。</strong></p><p>总的来说，这次物联网入坑，<strong>值得！</strong></p><p><strong>阅读本文后你将收获：</strong></p><ul><li>了解M5STACK这款新兴的片上系统<br></li><li><p>了解这款板子的开发环境如何配置</p></li><li><p>掌握ONENET数据传输</p></li><li><p>掌握HTTP的GET方法</p></li><li>会搭建笔者前几天做的项目雏形：健康码追踪系统<br></li></ul><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RT4Gwk56bt5iOJ><p><strong>开发准备</strong></p><p>本博客作为学习物联网开发的笔记，也简单的将自己的片上系统作为例程写出来。</p><ul><li>ESP-IDF工具链配置：<strong>乐鑫文档</strong><br></li><li>UIflow<strong>在线IDE</strong></li><li>M5STACK的<strong>官方开发文档</strong>(<strong>很全，如果你也打算使用M5STACK系列的开发板，强烈建议从此入门</strong>)</li><li>本博客项目的代码仓库（欢迎赏星）：<strong>https://github.com/haoruilee/M5Stack_Healthy_code_tracer</strong><br></li></ul><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RT7S2kzFTfre26><p><strong>M5STACK简介</strong></p><p>M5STACK是一款对初学者非常友好的ESP32开发板，可以用Micropython和C编程，也可以用很简单的拖拽式编程，拥有庞大的官方文档，只是国内只在最近开始流行，油管和B站上都有官方的教学视频，也在常常更新，很有创造力的一个产品。</p><p>结构上主要分为Core和Unit，Core作为核心控件，Unit作为传感器采集数据。</p><p>下图图就是笔者自己做的产品雏形，中间的小屏幕是Core，作为主控,周围有GPS和RFID,摄像头等单元用来采集数据。</p><p>设计雏形：</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJaJ98L9dslf><p>由于所有的M5产品都预设了乐高块，所有你可以把他们拼在乐高模组上，油管上还有不少人用它做乐高机器人，确实是很有创意的一款产品，颜值也不错，所以笔者选择它用来开发。</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RTJXJ1kBqzfCnu><p><strong>环境配置</strong></p><p><strong>UIFlow环境</strong></p><p>在线编程地址：<strong>UIFlow</strong></p><p>前几天GIthub发布了远程编译器Codespace,可以看出远程编译确实是大势所趋。</p><p>这里不得不说UIFlow把物联网的门槛大大降低了，笔者配置ESP-IDF用了将近一天，而使用UIFlow可以免去一切环境配置的痛苦。</p><p>支持拖拽编程，可视化UI设计，自带例程，确实是良心产品。</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJaLW3Itg7uv><p><strong>ESP-IDF环境</strong></p><p><strong>方法一</strong></p><p>笔者配置ESP-IDF工具链时，一开始是使用Windows系统的<strong>工具安装器。</strong></p><p>ESP-IDF 工具安装器可在“开始”菜单中，创建一个打开ESP-IDF 命令提示符窗口的快捷方式。本快捷方式可以打开 Windows 命令提示符（即 cmd.exe），并运行 export.bat 脚本以设置各环境变量（比如 PATH，IDF_PATH 等）。</p><p>（不得不说，这个安装器的健壮性非常差！！）</p><p><strong>安装心得：上网技巧+把系统的PATH重新检查一遍，有些卸载残余的PATH会导致玄学问题！</strong></p><p><strong>方法二（更推荐）</strong></p><p>宇宙第一VS code中有插件 ESPRESSIF</p><p>可以更清楚每时每刻在干什么，也更清楚出了BUG去哪里修补。</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJaNtHAhhK0a><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RTJXJ7YR5xGDl><p><strong>感知模块</strong></p><p>M5开发了很多环境传感器，包括温湿度，人体感应，RFID，摄像头等等，在<strong>官方开发文档</strong>上也都给出了相关例程和GIthub的源码链接。</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RzRJbEVB7i1Xik><p>笔者自己的项目使用的是RFID、GPS和Camera模块，其中除了Camera只能用ESP-IDF编程，其他单元都支持在UIFlow上在线编程，再加上，Micropython确实比C++舒服太多。</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RTJXJ7uHXU5GZc><p><strong>网络连接</strong></p><p><strong>Wi-Fi链接</strong></p><p>M5Stack已经自己预置了Wi-Fi链接，开机就是，不过在Mircopython里写起来也很简单，下面是一个范例：</p><pre><pre>import network<br>SSID="YOUR-WIFI-NAME"<br>PASSWORD="YOUR-WIFI-PASSWORD"<br>wlan=None<br>s=None<br><br>def connectWifi(ssid,passwd):<br>'''<br>连接指定wifi<br>'''<br>global wlan<br>wlan=network.WLAN(network.STA_IF)<br>wlan.active(True)<br>wlan.disconnect<br>wlan.connect(ssid,passwd)<br>while(wlan.ifconfig[0]=='0.0.0.0'):<br>time.sleep(1)<br>return True<br></pre></pre><p>使用Mircoython的Wi-Fi模块，connect(ssid，password)，就可以进入可爱的Wi-Fi连接界面了，M5GO的封装还是不错的。</p><p><strong>NB-IOT</strong></p><p>IOT模组需要额外配一张NB卡，某宝20就可以拿下一年500M流量，不过笔者没有继续尝试，已经有可爱的M5GO和稳定的Wi-Fi，就没探索用3G进行通讯。</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RTLSNam5ZxLDlM><p><strong>HTTP通讯</strong></p><p>接下来介绍物联网的精髓，“联网”，采集到了数据，那数据上报和传输是重中之重。</p><p>笔者觉得HTTP是最好理解，好入门的通讯协议，这里也先介绍这种方法。</p><p>建议参考视频：<strong>B站：接入中国移动ONENET平台</strong></p><p>笔者尝试过诸如阿里云和一些外国的平台，最后发现都不如中国移动专门为物联网开发的ONENET，一来稳定，不用担心服务商跑路，而来阿里云显得太过臃肿，对入门者很不友好，最终选择了ONENET，他的HTTP封装好了很好看的数据流模板，如：</p><ul><li><p>位置信息可视化：</p></li></ul><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/RzRJbFsASrOdmM><ul><li><p>自动折线图</p></li></ul><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJbGQIXVuWxU><p><strong>POST上传数据</strong><strong>创建流模板</strong></p><p>首先需要创建一个数据流模板，用于接收传过来的数据：</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJbGw5LHXVeE><p><strong>发送请求</strong></p><p>请求方式：POST</p><p>URL:http://api.heclouds.com/devices/device_id/datapoints</p><p>其中，device_id：需要替换为设备ID</p><p>注意：ONENET默认post的数据叫Datastreams，参数配置见表：</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/RzRJbHYFXVLLaz><p>请求实例：</p><pre>{<br>"datastreams": [{<br>"id": "temperature",<br>"datapoints": [{<br>"at": "2013-04-22T00:35:43",<br>"value": "bacd"<br>},<br>{<br>"at": "2013-04-22T00:55:43",<br>"value": 84<br>}<br>]<br>},<br>{<br>"id": "key",<br>"datapoints": [{<br>"at": "2013-04-22T00:35:43",<br>"value": {<br>"x": 123,<br>"y": 123.994<br>}<br>},<br>{<br>"at": "2013-04-22T00:35:43",<br>"value": 23.001<br>}<br>]<br>}<br>]<br>}<br></pre><p>使用ONENET的<strong>模拟API调用</strong>可以快速熟悉数据的模式：</p><p>其中，URL的device_id,和下面的API_key换成自己设备的，可以在<strong>设备列表</strong>找到，就可以往自己设备的数据流模板传一个值为3的value。</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RzRJbul6jSXmHR><p><strong>Micropython用HTTP</strong>UIFlow里自带了HTTP模块，但是很玄学，<strong>很难用！</strong></p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJbwP1PJ4i4F><p>这里笔者用Micropython自己写了一份HTTP的传输：</p><pre>def http_put_data(data):<br>#post data into onenet<br>url='http://api.heclouds.com/devices/'+DEVICE_ID+'/datapoints'<br>values={'datastreams':[{"id":"temperature","datapoints":[{"value":data}]}]}<br>jdata = json.dumps(values)<br>r=urequests.post(url,data=jdata,headers={"api-key":API_KEY})<br>return r<br></pre><p>亲测还是很好用的，可能是UIFlow自己的json封装比较奇怪？</p><p><strong>使用模组交互的数据传输</strong></p><p>既然M5STACK可以同时使用多个模组，那么自然也就可以使用模组来控制数据传输：</p><p>如：使用RFID卡，控制POST：</p><pre>rfid0 = unit.get(unit.RFID, unit.PORTA)<br><br>while(True):<br>if rfid0.isCardOn:<br>rsp = http_put_data(12)<br>emoji0.show_map([[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,1,1,1,1,1,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]], 0xff0000)<br>else:<br>#wlan.disconnect<br>#wlan.active(False)<br>emoji0.show_map([[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0],[0,0,0,1,0,0,0]], 0xff0000)<br>wait(1)<br></pre><p><strong>第一行的rfid0 = unit.get(unit.RFID, unit.PORTA)是指定从PORTA读取RFID的射频信息</strong></p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RTRIuPNI7JPB03><p><strong>使用HTTP的GET获取b站信息</strong></p><p>有POST就要有GET，这里介绍一个B站大佬“<strong>正负加减</strong>”的例程，获取自己的粉丝数，里面讲解也很细致,大佬也是老Geek了,关注不亏！<strong>UIFlow的GET结构：</strong>核心思想是知道<strong>哪个key是follow</strong>，可以在F5审查源代码找到：</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RzRJbxOGYSihWs><p>此处的URL是</p><pre>http://api.bilibili.com/x/relation/stat?vmid=99566555<br></pre><p>UP和DOWN是控制RGB等的函数。</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJby1Bq5vkRn><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RTRIuPaahjHjS><p><strong>我的片上系统设计全过程</strong></p><p><strong>设计初衷</strong>在疫情管控最严格的的时候，经常能看到触目惊心的“<strong>寻找x月x日乘坐xxxx的乘客</strong>”，如果能追寻乘坐公共交通者的足迹，会给疫情管控带来很大便利。<strong>设计方法</strong></p><p>笔者希望结合GPS，RFID和摄像头功能，做个车载的识别信息-上报信息的小系统。</p><p>具体涉及到二维码识别，RFID识别，GPS获取和HTTP上报。</p><p>然而，这个设计一开始就遇到了难题。网上购买的测温枪，他的蓝牙数据我无法解包，好像是和<strong>腾讯连连</strong>有自己的相关配置。</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RzRJcmdEliYo36><p>腾讯连连界面：</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RzRJcnREhzsSk5><p>既然腾讯连连已经写到那么好了，那就不抢他的饭碗了。</p><p>既然没办法解析内容，那下面笔者将用ENV单元采集的环境温度代替乘客温度进行收发。</p><p><strong>分模块实现</strong><strong>RFID控制块</strong>首先声明RFID模块的串口：</p><pre>rfid0 = unit.get(unit.RFID, unit.PORTA)<br></pre><p>该段指从A口串入RFID模组</p><p>【注：M5STACK使用颜色标明了A,B,C三个Grove口，见下图】</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJco9BOmAhmT><p>上图中RFID的串口是红色，就对应到M5GO左侧的红色接口：</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RzRJcpK8z8UTOV><p><strong>GRIVE HUB</strong><strong>由于笔者同时还需要使用红色串口的ENV单元，因此额外购买了GROVE HUB</strong>：</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/RzRJcqB66D8FLd><p>这样就有两个A口了。</p><p>访问设置时不需要加以区分,都从PORTA引入：</p><pre>rfid0 = unit.get(unit.RFID, unit.PORTA)<br>env0 = unit.get(unit.ENV, unit.PORTA)<br></pre><p>使用Emoji模块做可视化：</p><p>笔者使用循环判断是否有卡片接近，无则显示待机Emoji，有则显示✅</p><pre> #循环判断是否有卡片接近<br>while(True):<br>#熄灭RGB灯<br>rgb.setBrightness(0)<br>#清空Emoji显示<br>emoji0.show_map([[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]], 0x000000)<br>#判断是否有卡片接近<br>if rfid0.isCardOn:<br>#有卡片接近显示对号<br>emoji0.show_map([[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,1],[0,0,0,0,0,1,1],[1,0,0,0,1,1,0],[0,1,1,1,1,0,0],[0,0,1,1,0,0,0]], 0x33ff33)<br>#发送RFID读取到的卡片ID<br>rsp_RFID = http_put_RFID((str(rfid0.readUid)))<br>#完成后指示灯变绿<br>rgb.setColorAll(0x33ff33)<br>rgb.setBrightness(10)<br>else:<br>#可选是否断开wifi<br>#wlan.disconnect<br>#wlan.active(False)<br>#等待卡片接近时，Emoji展示"。。。"<br>emoji0.show_map([[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,1,0,1,0,1,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]], 0x000000)<br>wait(1)<br></pre><p>这里的Emoji模块是先在UIFlow里敲好，再进Micropython里查看的。</p><p><strong>HTTP传输块</strong></p><p>HTTP传输在上文已经讲了不少，这里优先介绍GPS的传输：</p><p><strong>GPS的命令也是要加“value:”的，形如value:{“lon”:lon,“lat”:lat}，这个地方一开始把笔者坑的不轻</strong><strong>！</strong></p><pre>def http_put_location(lon,lat):<br>'''<br>传输地理位置数据点至ONENET平台的location数据流<br>lon:longitude,经度<br>lat: latitude,纬度<br>url：http的post地址<br>values:请参考https://open.iot.10086.cn/doc/multiprotocol/ 文档中的"HTTP协议上传数据点模块，配置json格式信息"<br>API_KEY:设备发送HTTP请求的证书，请参考https://open.iot.10086.cn/doc/multiprotocol/book/develop/http/api/api-usage.html 文档中的"鉴权说明"<br>'''<br>url='http://api.heclouds.com/devices/YOUR-DEVICE-ID/datapoints'<br>values={'datastreams':[{"id":"location","datapoints":[{"value":{"lon":lon,"lat":lat}}]}]}<br>jdata = json.dumps(values)<br>r=urequests.post(url,data=jdata,headers={"api-key":API_KEY})<br>return r<br></pre><p>这里请把YOUR-DEVICE-ID替换为自己的数据流中设备编号，参考<strong>ONENET手册。</strong><strong>Wi-Fi连接块</strong></p><p>UIflow里封装了很好的Wi-Fi-connect：</p><pre>wifiCfg.doConnect(SSID, PASSWORD)<br></pre><p>如果你的Micropython里没有一键Wi-Fi连接，笔者自己也实现了一个：</p><pre>def connectWifi(ssid,passwd):<br>'''<br>如果您的Micropython不携带WifiCfg.doconnect，请参考本函数<br>函数作用：连接至名称为SSID，密码为passwd的wifi<br>'''<br>global wlan<br>wlan=network.WLAN(network.STA_IF)<br>wlan.active(True)<br>wlan.disconnect<br>wlan.connect(ssid,passwd)<br>while(wlan.ifconfig[0]=='0.0.0.0'):<br>time.sleep(1)<br>return True<br></pre><p><strong>二维码识别块</strong></p><ul><li>本部分使用ESP-IDF编程<br></li><li><p>使用的摄像头是M5CAMERA</p></li><li>属性是OV2640<br></li></ul><p>参考<strong>官方例程</strong>：</p><pre>//拍摄<br>camera_fb_t* esp_camera_fb_get<br>{<br>if (s_state == ) {<br>return ;<br>}<br>if(!I2S0.conf.rx_start) {<br>if(s_state-&gt;config.fb_count &gt; 1) {<br>ESP_LOGD(TAG, "i2s_run");<br>}<br>if (i2s_run != 0) {<br>return ;<br>}<br>}<br>if(s_state-&gt;config.fb_count == 1) {<br>xSemaphoreTake(s_state-&gt;frame_ready, portMAX_DELAY);<br>}<br>if(s_state-&gt;config.fb_count == 1) {<br>return (camera_fb_t*)s_state-&gt;fb;<br>}<br>camera_fb_int_t * fb = ;<br>if(s_state-&gt;fb_out) {<br>xQueueReceive(s_state-&gt;fb_out, &amp;fb, portMAX_DELAY);<br>}<br>return (camera_fb_t*)fb;<br>}<br><br>//二维码识别<br>void qr_recoginze(void *pdata) {<br><br>camera_fb_t *camera_config = pdata;<br><br>if(pdata==)<br>{<br>ESP_LOGI(TAG,"Camera Size err");<br>return;<br>}<br><br>struct quirc *q;<br>struct quirc_data qd;<br>uint8_t *image;<br>q = quirc_new;<br><br>if (!q) {<br>printf("can't create quirc object\r\n");<br>vTaskDelete ;<br>}<br>//printf("begin to quirc_resize\r\n");<br><br>if (quirc_resize(q, camera_config-&gt;width, camera_config-&gt;height)&lt; 0)<br>{<br>printf("quirc_resize err\r\n");<br>quirc_destroy(q);<br>vTaskDelete ;<br>}<br><br>image = quirc_begin(q, , );<br>memcpy(image, camera_config-&gt;buf, camera_config-&gt;len);<br>quirc_end(q);<br><br>int id_count = quirc_count(q);<br>if (id_count == 0) {<br>quirc_destroy(q);<br>return;<br>}<br><br>struct quirc_code code;<br>quirc_extract(q, 0, &amp;code);<br>quirc_decode(&amp;code, &amp;qd);<br>dump_info(q);<br>quirc_destroy(q);<br>}<br></pre><p>这里依赖了太多官方库…建议去代码仓库翻一翻。</p><p><strong>K210的二维码识别</strong>上文是ESP32类型的开发板识别代码，可以看到非常繁琐，<strong>改起来简直要了老命</strong>…使用Micropython的话，代码就变的可爱多了~</p><p>【此部分使用Maxipy编程】</p><pre> import sensor<br>import image<br>import lcd<br>import time<br><br>clock = time.clock<br>lcd.init<br>sensor.reset<br>sensor.set_pixformat(sensor.RGB565)<br>sensor.set_framesize(sensor.QVGA)<br>sensor.set_vflip(1)<br>sensor.run(1)<br>sensor.skip_frames(30)<br>while True:<br>clock.tick<br>img = sensor.snapshot<br>res = img.find_qrcodes<br>fps =clock.fps<br>if len(res) &gt; 0:<br>img.draw_string(2,2, res[0].payload, color=(0,128,0), scale=2)<br>print(res[0].payload)<br>lcd.display(img)<br></pre><p>这里<strong>Maxipy的官方文档</strong>还给出了修正图像的方法：<strong>如果使用了镜头，画面会有扭曲，需要矫正画面使用 lens_corr 函数来矫正，比如 2.8mm， img.lens_corr(1.8)</strong></p><p>（没事翻一翻这个Maxipy的文档还是很有启发的，大概两小时就能通读一遍）</p><p><strong>GPS传输块</strong></p><p>室内经常没有信号（实测室外也很少有…）因此在传递GPS的时候笔者额外设计了防止无信号的代码。</p><p>GPS的http传输函数已经在上文讲了，此处和RFID卡片控制进行结合：</p><pre>if rfid0.isCardOn:<br>#有卡片接近显示对号<br>emoji0.show_map([[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,1],[0,0,0,0,0,1,1],[1,0,0,0,1,1,0],[0,1,1,1,1,0,0],[0,0,1,1,0,0,0]], 0x33ff33)<br>#发送RFID读取到的卡片ID<br>rsp_RFID = http_put_RFID((str(rfid0.readUid)))<br>#防止测试时无信号<br>if str(gps0.pos_quality) != "1" and str(gps0.pos_quality) != "6":<br>lon=116.39137751349433<br>lat=39.8969585128568<br>else:<br>#默认北京<br>lon=gps0.longitude<br>lat=gps0.latitude<br>try:<br>rsp_LOCATION=http_put_location(float(lon),float(lat))<br>except:<br>emoji0.show_map([[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,1],[0,0,0,0,0,1,1],[1,0,0,0,1,1,0],[0,1,1,1,1,0,0],[0,0,1,1,0,0,0]], 0xff0000)<br>#传输温度<br>rsp = http_put_data(env0.temperature)<br>#完成后指示灯变绿<br>rgb.setColorAll(0x33ff33)<br>rgb.setBrightness(10)<br>else:<br>#可选是否断开wifi<br>#wlan.disconnect<br>#wlan.active(False)<br>#等待卡片接近时，Emoji展示"。。。"<br>emoji0.show_map([[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,1,0,1,0,1,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]], 0x000000)<br>wait(1)<br></pre><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RTYlVXmICmMrFE><p><strong>后记</strong></p><p>参赛时间仓促，没能完全搞明白每个引脚的用途，没有好好触摸一遍C和开发板，没有用NB-IOT通讯。没有做蓝牙通讯解包…还是有很多遗憾的，还好设备还在，可以继续探索物联网的神奇。</p><p><strong>成果效果：</strong></p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzRJdZd2Ril03g><p>版权声明：本文为CSDN博主「Haor.L」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。</p><p>原文链接：https://blog.csdn.net/weixin_46233323/article/details/106054434」</p><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/R69FpRH4d90a7d><img alt="零基础物联网开发，踩坑无数，得到这份宝典 | 原力计划" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/Ryq1trhHccKmPg><pre><pre><p>☞程序员在家办公没显示屏，我被领导鄙视了</p><p>☞Get！读懂数据科学和机器学习，看这文就够了</p><p>☞深度剖析数据库国产化迁移之路</p><p>☞Go远超Python，机器学习人才极度稀缺，全球16,655位程序员告诉你这些真相</p><p>☞我佛了！用KNN实现验证码识别，又 Get 到一招</p><p>☞超级账本Hyperledger Fabric中的Protobuf到底是什么？</p></pre></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'零基','物联网','开发'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>