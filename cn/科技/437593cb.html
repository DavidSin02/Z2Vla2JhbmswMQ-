<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>常见问题：并发 | 极客快訊</title><meta property="og:title" content="常见问题：并发 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/6b38684f68fd4586b89489ed06ce916f"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/437593cb.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/437593cb.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/437593cb.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/437593cb.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/437593cb.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/437593cb.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/437593cb.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/437593cb.html><meta property="article:published_time" content="2020-11-14T21:02:06+08:00"><meta property="article:modified_time" content="2020-11-14T21:02:06+08:00"><meta name=Keywords content><meta name=description content="常见问题：并发"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/437593cb.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>常见问题：并发</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><div class=pgc-img><img alt=常见问题：并发 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6b38684f68fd4586b89489ed06ce916f><p class=pgc-img-caption></p></div><ul><li>MongoDB使用何种类型的锁？</li><li>MongoDB中锁的粒度有多细？</li><li>如何在我的mongod实例上看到锁的状态？</li><li>读取或写入操作是否会让渡(yield)锁？</li><li>一些常见的客户端操作会采取什么样的锁定？</li><li>哪些管理命令锁定数据库？</li><li>MongoDB操作是否锁定多个数据库？</li><li>分片如何影响并发？</li><li>并发性如何影响副本集的primay节点？</li><li>并发性如何影响副本集的secondary节点？</li><li>MongoDB是否支持事务？</li><li>MongoDB提供了什么样的隔离保证？</li></ul><p>在3.0版本中更改。</p><p>MongoDB允许多个客户端读取和写入相同的数据。为了确保一致性，它使用锁定和其他并发控制措施来防止多个客户端同时修改同一条数据。总之，这些机制保证对单个文档的所有写入完全或根本不发生，并且客户端永远不会看到数据的不一致视图。</p><p><strong>MongoDB使用何种类型的锁？</strong></p><p>MongoDB使用多粒度的锁</p><p>[1]</p><p>，允许操作锁定全局，数据库或集合级别，并允许各个存储引擎在集合级别下实现自己的并发控制（例如，在WiredTiger中的文档级别锁） 。</p><p>MongoDB使用读-写锁，允许并发读操作以共享的方式访问资源（如一个数据库或一个集合），但在MMAPv1中，对单个写入操作采取独占(排它)的访问方式。</p><p>除了用于读取的共享锁（S）模式和用于写入操作的排它锁（X）模式之外，意向共享锁（IS）和意向排它锁（IX）模式指示了使用更精细的锁定粒度来读取或写入资源的意图 。当以某个粒度锁定资源时，所有更高层面都使用</p><p>意向锁</p><p>。</p><p>例如，在锁定集合以进行写入时（使用排它锁（X）模式），必须在意向排它锁（IX）模式下锁定相应的数据库锁和全局锁。单个数据库可以同时锁定在IS（意向共享锁）和IX（意向排它锁）模式，但是（X）不能与任何其他模式共存，并且共享锁（S）只能与意图共享（IS）锁共存。</p><p>锁是公平的，读取和写入按顺序排队。但是，为了优化吞吐量，当一个请求被授予时，所有其他兼容请求将同时被授予，在冲突请求之前释放它们。例如，考虑X锁（排它锁）被释放的情况，其中冲突队列包含以下项：</p><p>IS→IS→X→X→S→IS</p><p>在严格的先进先出（FIFO）排序中，只授予前两种IS模式。然而，MongoDB实际上将授予所有IS和S模式，一旦它们全部完成，它将授予X，即使新的IS或S请求在此期间已进入排队。由于授权将始终在队列中提前移动所有其他请求，因此任何请求都不可能存在饥饿等待问题。</p><p>在db.serverStatus()和db.currentOp()输出中，锁定模式被表示如下：</p><div class=pgc-img><img alt=常见问题：并发 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c7972ddc45df4bd499fd5e3cf9869f29><p class=pgc-img-caption></p></div><p>[1] 在wiki上查看 多粒度锁 相关的更多信息.</p><p><strong>MongoDB中锁的粒度有多细？</strong></p><p>在版本3.0中更改。</p><p><strong>对于WiredTiger</strong></p><p>从版本3.0开始，MongoDB可以使用WiredTiger存储引擎。</p><p>对于大多数读写操作，WiredTiger使用乐观锁并发控制。WiredTiger仅在全局，数据库和集合级别使用意向锁。当存储引擎检测到两个操作之间的冲突时，其中一个会引发写入冲突，导致MongoDB（对用户而言透明）重试该操作。</p><p>一些全局操作（通常是涉及多个数据库的短期操作）仍然需要全局“实例范围”锁定。其他一些操作（例如删除集合）仍需要独占数据库锁。</p><p><strong>对于MMAPv1</strong></p><p>MMAPv1存储引擎在3.0版本系列中使用了集合级别锁，这是对早期版本的改进，在早期版本中数据库级别锁是最细粒度的锁。第三方存储引擎可以使用集合级锁或实现自己的更细粒度的并发控制。</p><p>举个例子，如果一个使用MMAPv1存储引擎的数据库中有六个集合，有一个采用集合级写锁的操作，则其他五个集合仍可用于读取和写入操作。一个排它数据库级别锁使得所有六个集合在持有锁的操作期间不可用。</p><p><strong>如何在我的mongod实例上看到锁的状态？</strong></p><p>要报告锁对象上的锁使用率信息，请使用以下任一方法：</p><p>· db.serverStatus()，</p><p>· db.currentOp()，</p><p>· mongotop，</p><p>· mongostat，和/或</p><p>·</p><p>MongoDB Cloud Manager</p><p>或</p><p>Ops Manager，MongoDB企业版提供的先进的解决方案</p><p>具体来说，serverStatus输出中的locks子文档或当前操作报告中（current operation reporting）的locks字段 ，提供了可以深入了解实例中锁的类型和锁争用的数量。</p><p>在db.serverStatus()和db.currentOp()输出中，所述锁定模式被表示如下：</p><div class=pgc-img><img alt=常见问题：并发 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7de7038cd642480daec8c73db3bc5aa7><p class=pgc-img-caption></p></div><p>要终止操作，请使用db.killOp()。</p><p><strong>读取或写入操作是否会让渡(yield)锁？</strong></p><p>在某些情况下，读写操作可以让渡(yield)它们持有的锁。</p><p>长时间运行的读写操作（例如查询，更新和删除）在许多条件下都会进行让渡(yield)。MongoDB如果单个修改文档的操作，影响带有multi参数修改多个文档update()操作，MongoDB也会让渡锁。</p><p>对于支持文档级并发控制的存储引擎，例如WiredTiger，当使用意向锁访问存储时不需要让渡(yield)，因为该锁是全局，数据库和集合级别，不会阻止其他读写操作。但是，操作会定期产生让渡(yield)，例如：</p><p>l 避免长时间执行的存储性事务，因为这些可能需要在内存中保存大量数据;</p><p>l 作为中断响应点（interruption points），以便你可以杀死长时间运行的操作;</p><p>l 允许需要对集合进行排它访问的操作得到执行，例如索引/集合的删除和创建。</p><p>MongoDB的MMAPv1存储引擎使用基于其访问模式的启发式方法来预测在执行读取之前数据是否可能存在于物理内存中。如果MongoDB 预测数据不在物理内存中，则当MongoDB将数据加载到内存中时，操作将让渡锁。一旦数据在内存中可用，操作将重新获取锁以完成操作。</p><p><strong>一些常见的客户端操作会采取什么样的锁定？</strong></p><p>下表列出了一些操作以及它们在文档级锁存储引擎中的锁类型：</p><div class=pgc-img><img alt=常见问题：并发 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/75d30317d9f64f6c89d747725dbd4048><p class=pgc-img-caption></p></div><p><strong>哪些管理命令锁定数据库？</strong></p><p>某些管理命令可以在很长一段时间内排它锁定数据库。在某些部署中，对于大型数据库，您可以考虑使mongod实例脱机，以便客户端不受影响。例如，如果 mongod是副本集的一部分，请执行mongod脱机操作，并在维护过程中，让副本集的其他成员服务请求负载。</p><p>以下管理操作需要在数据库级别进行长时间的排它锁定：</p><div class=pgc-img><img alt=常见问题：并发 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/21f21835e04c4e5cb06c7b557d9ba00e><p class=pgc-img-caption></p></div><p>以下管理操作会锁定数据库，但是只会锁定很短的时间：</p><div class=pgc-img><img alt=常见问题：并发 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3f918deec6f44becb3ecc6f369d12071><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=常见问题：并发 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/98e938452e154cc18c0928632859f865><p class=pgc-img-caption></p></div><p>参考：</p><p>MongoDB会锁定多个数据库吗?</p><p><strong>MongoDB操作是否锁定多个数据库？</strong></p><p>以下MongoDB操作采用全局排它锁（译者注：即会锁定所有的数据库）：</p><p>l db.copyDatabase()获取全局排它锁(global exclusive (W) lock)，将阻塞其他操作直到该操作完成。</p><p>l db.repairDatabase()获取全局排它锁(global exclusive (W) lock)，将阻塞其他操作直到该操作完成。</p><p>l 从MongoDB 4.0开始，db.collection.reIndex()获取 获取全局排它锁(globalexclusive (W) lock)，将阻塞其他操作直到该操作完成。</p><p>l 用户身份验证对于使用 2.6用户凭据的部署，需要在admin库上获取一个读锁。对于使用2.4模式进行用户凭据的部署，身份验证会锁定 admin数据库同时也会锁定用户正在访问的数据库。</p><p>l 对副本集primary节点的所有写入操作，会短时间锁住写入的目标数据库以及local数据库。锁定local数据库，允许 mongod占用操作总时间的一小部分来写入primary节点的oplog。</p><p>l 副本集成员状态转换采用全局排它锁。</p><p><strong>分片如何影响并发？</strong></p><p>分片通过将集合分布在多个mongod实例，提高并发的能力，允许分片服务器（即mongos进程）来并发的执行针对下游mongod 实例的任意数量的操作。</p><p>在分片群集中，锁定应用于每个单独的分片，而不是整个群集; 即每个mongod实例独立于分片集群中的其他实例并使用自己的 锁。一个 mongod实例上的操作不会阻止任何其他实例上的操作。</p><p><strong>并发性如何影响副本集的primay节点？</strong></p><p>对于副本集，当MongoDB写入主节点上的集合时 ，MongoDB还会写入主节点的oplog—local数据库中的特殊集合。因此，MongoDB必须锁定集合所在的数据库和local 数据库。mongod必须同时锁定这两个库来保持数据库一致性，并确保写入操作，甚至包括复制，是“all-or-nothing”的操作。</p><p>写入副本集时，锁的范围适用于主节点(primary)。</p><p><strong>并发性如何影响副本集的secondary节点？</strong></p><p>在进行副本复制同步时，MongoDB不会将写入连续的应用到从节点(secondaries)。从节点批量收集oplog记录，然后并行应用这些批处理。从节点在应用写入操作时不允许读取，并按照它们在oplog中出现的顺序应用这些写入操作。</p><p><strong>MongoDB是否支持事务？</strong></p><p>因为单个文档可以包含关联数据（译者注：通过内嵌文档或数组的方式），而这些关联数据在关系模型中是使用单独父子表进行建模的，MongoDB的单文档原子操作已经提供了满足大多数应用程序的数据完整性需求的事务语义。可以在单个操作中写入一个或多个字段，包括对多个子文档和数组元素的更新。MongoDB提供的单文档操作原子性保证确保在文档更新时完全隔离; 任何错误都会导致操作回滚，以便客户端收到文档的一致视图。</p><p>从版本4.0开始，对于需要原子性来更新多个文档或读取多个文档之间的一致性的情况，MongoDB 为副本集提供多文档事务，并计划在MongoDB 4.2中提供分片集群的事务。</p><p><strong>重要</strong></p><p>在大多数情况下，多文档事务比单个文档写入产生更高的性能成本，并且多文档事务的可用性不应该取代有效的模式设计。对于许多场景， 非规范化数据模型（嵌入式文档和数组）将继续为您的数据和用例提供最佳选择。也就是说，对于许多场景，合理的数据建模将最大限度地减少对多文档事务的需求。</p><p>[2]我们产品所描述的任何特性或功能的开发，发布和时间由我们自行决定。此信息仅用于概述我们的一般产品方向，不应依赖于做出购买决定，也不是承诺，或为法律义务提供任何材料，代码或功能。</p><p><strong>MongoDB提供了什么样的隔离保证？</strong></p><p>根据ReadConcern参数设置，客户端可以在写入持久化之前查看写入结果。要控制是否可以回滚读取的数据，客户端可以使用readConcern选项。</p><p>有关信息，请参阅：</p><p>· 读取隔离，一致性和因近原则</p><p>· 原子性和事务</p><p>· Read Concern</p><p>译者：钟秋</p><p>BBD技术经理，资深架构师，MongoDB中文社区联席主席</p><p>有丰富项目中应用MongoDB经验，熟悉MongoDB相互模式设计及性能优化，熟悉大数据相关技术和互联网及大数据应用架构设计</p><div class=pgc-img><img alt=常见问题：并发 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f3a7b934df384c16a0109260880d66c5><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'常见','问题'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>