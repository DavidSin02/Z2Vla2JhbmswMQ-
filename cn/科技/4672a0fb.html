<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ç‰›äººè®²è§£Javaå¯é‡å…¥é”åŸç† | æå®¢å¿«è¨Š</title><meta property="og:title" content="ç‰›äººè®²è§£Javaå¯é‡å…¥é”åŸç† - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/1535262549376823724db60"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4672a0fb.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4672a0fb.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4672a0fb.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4672a0fb.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4672a0fb.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4672a0fb.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4672a0fb.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4672a0fb.html><meta property="article:published_time" content="2020-11-14T20:55:06+08:00"><meta property="article:modified_time" content="2020-11-14T20:55:06+08:00"><meta name=Keywords content><meta name=description content="ç‰›äººè®²è§£Javaå¯é‡å…¥é”åŸç†"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/4672a0fb.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ç‰›äººè®²è§£Javaå¯é‡å…¥é”åŸç†</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><h1><br></h1><p><strong>ä¸€ã€ æ¦‚è¿°</strong></p><p>æœ¬æ–‡é¦–å…ˆä»‹ç»Lockæ¥å£ã€ReentrantLockçš„ç±»å±‚æ¬¡ç»“æ„ä»¥åŠé”åŠŸèƒ½æ¨¡æ¿ç±»AbstractQueuedSynchronizerçš„ç®€å•åŸç†ï¼Œç„¶åé€šè¿‡åˆ†æReentrantLockçš„lockæ–¹æ³•å’Œunlockæ–¹æ³•ï¼Œæ¥è§£é‡ŠReentrantLockçš„å†…éƒ¨åŸç†ï¼Œæœ€ååšä¸€ä¸ªæ€»ç»“ã€‚æœ¬æ–‡ä¸æ¶‰åŠReentrantLockä¸­çš„æ¡ä»¶å˜é‡ã€‚</p><p><strong>1.1ã€Lockæ¥å£</strong></p><p>Lockæ¥å£ï¼Œæ˜¯å¯¹æ§åˆ¶å¹¶å‘çš„å·¥å…·çš„æŠ½è±¡ã€‚å®ƒæ¯”ä½¿ç”¨synchronizedå…³é”®è¯æ›´çµæ´»ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ”¯æŒæ¡ä»¶å˜é‡ã€‚å®ƒæ˜¯ä¸€ç§æ§åˆ¶å¹¶å‘çš„å·¥å…·ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå®ƒæ§åˆ¶å¯¹æŸç§å…±äº«èµ„æºçš„ç‹¬å ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€æ—¶é—´å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–è¿™ä¸ªé”å¹¶å ç”¨èµ„æºã€‚å…¶ä»–çº¿ç¨‹æƒ³è¦è·å–é”ï¼Œå¿…é¡»ç­‰å¾…è¿™ä¸ªçº¿ç¨‹é‡Šæ”¾é”ã€‚åœ¨Javaå®ç°ä¸­çš„ReentrantLockå°±æ˜¯è¿™æ ·çš„é”ã€‚å¦å¤–ä¸€ç§é”ï¼Œå®ƒå¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è¯»å–èµ„æºï¼Œä½†æ˜¯åªèƒ½å…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å…¥èµ„æºï¼ŒReadWriteLockå°±æ˜¯è¿™æ ·ä¸€ç§ç‰¹æ®Šçš„é”ï¼Œç®€ç§°è¯»å†™é”ã€‚ä¸‹é¢æ˜¯å¯¹Lockæ¥å£çš„å‡ ä¸ªæ–¹æ³•çš„æ€»ä½“æè¿°ï¼š</p><p>æ–¹æ³•åç§°æè¿°lockè·å–é”ï¼Œå¦‚æœé”æ— æ³•è·å–ï¼Œé‚£ä¹ˆå½“å‰çš„çº¿ç¨‹å°±å˜ä¸ºä¸å¯è¢«è°ƒåº¦ï¼Œç›´åˆ°é”è¢«è·å–åˆ°lockInterruptiblyè·å–é”ï¼Œé™¤éå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ã€‚å¦‚æœè·å–åˆ°äº†é”ï¼Œé‚£ä¹ˆç«‹å³è¿”å›ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å˜å¾—ä¸å¯è¢«è°ƒåº¦ï¼Œä¸€ç›´ä¼‘çœ ç›´åˆ°ä¸‹é¢ä¸¤ä»¶äº‹æƒ…å‘ç”Ÿï¼š1ã€å½“å‰çº¿ç¨‹è·å–åˆ°äº†é”2ã€å…¶ä»–çš„çº¿ç¨‹ä¸­æ–­äº†å½“å‰çš„çº¿ç¨‹</p><p>tryLockå¦‚æœè°ƒç”¨çš„æ—¶å€™èƒ½å¤Ÿè·å–é”ï¼Œé‚£ä¹ˆå°±è·å–é”å¹¶ä¸”è¿”å›trueï¼Œå¦‚æœå½“å‰çš„é”æ— æ³•è·å–åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¼šç«‹åˆ»è¿”å›falsetryLcok(long time,TimeUnit unit)åœ¨æŒ‡å®šæ—¶é—´å†…å°è¯•è·å–é”å¦‚æœå¯ä»¥è·å–é”ï¼Œé‚£ä¹ˆè·å–é”å¹¶ä¸”è¿”å›trueï¼Œå¦‚æœå½“å‰çš„é”æ— æ³•è·å–ï¼Œé‚£ä¹ˆå½“å‰çš„çº¿ç¨‹å˜å¾—ä¸å¯è¢«è°ƒåº¦ï¼Œç›´åˆ°ä¸‹é¢ä¸‰ä»¶äº‹ä¹‹ä¸€å‘ç”Ÿï¼š1ã€å½“å‰çº¿ç¨‹è·å–åˆ°äº†é”2ã€å½“å‰çº¿ç¨‹è¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­</p><p>3ã€æŒ‡å®šçš„ç­‰å¾…æ—¶é—´åˆ°äº†</p><p>unlocké‡Šæ”¾å½“å‰çº¿ç¨‹å ç”¨çš„é”newConditionè¿”å›ä¸€ä¸ªä¸å½“å‰çš„é”å…³è”çš„æ¡ä»¶å˜é‡ã€‚åœ¨ä½¿ç”¨è¿™ä¸ªæ¡ä»¶å˜é‡ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹å¿…é¡»å ç”¨é”ã€‚è°ƒç”¨Conditionçš„awaitæ–¹æ³•ï¼Œä¼šåœ¨ç­‰å¾…ä¹‹å‰åŸå­åœ°é‡Šæ”¾é”ï¼Œå¹¶åœ¨ç­‰å¾…è¢«å”¤é†’ååŸå­çš„è·å–é”</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å›´ç»•lockå’Œunlockè¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œæ¥ä»‹ç»æ•´ä¸ªReentrantLockæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚åœ¨ä»‹ç»ReentrantLockä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ReentrantLockçš„ç±»å±‚æ¬¡ç»“æ„ä»¥åŠå’Œå®ƒå¯†åˆ‡ç›¸å…³çš„AbstractQueuedSynchronizer</p><p><strong>1.2ã€ReentrantLockç±»å±‚æ¬¡ç»“æ„</strong></p><div class=pgc-img><img alt=ç‰›äººè®²è§£Javaå¯é‡å…¥é”åŸç† onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1535262549376823724db60><p class=pgc-img-caption></p></div><p>ReentrantLockå®ç°äº†Lockæ¥å£ï¼Œå†…éƒ¨æœ‰ä¸‰ä¸ªå†…éƒ¨ç±»ï¼ŒSyncã€NonfairSyncã€FairSyncï¼ŒSyncæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»å‹ï¼Œå®ƒç»§æ‰¿AbstractQueuedSynchronizerï¼Œè¿™ä¸ªAbstractQueuedSynchronizeræ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå®ƒå®ç°äº†è®¸å¤šå’Œé”ç›¸å…³çš„åŠŸèƒ½ï¼Œå¹¶æä¾›äº†é’©å­æ–¹æ³•ä¾›ç”¨æˆ·å®ç°ï¼Œæ¯”å¦‚tryAcquireï¼ŒtryReleaseç­‰ã€‚Syncå®ç°äº†AbstractQueuedSynchronizerçš„tryReleaseæ–¹æ³•ã€‚NonfairSyncå’ŒFairSyncä¸¤ä¸ªç±»ç»§æ‰¿è‡ªSyncï¼Œå®ç°äº†lockæ–¹æ³•ï¼Œç„¶ååˆ†åˆ«å…¬å¹³æŠ¢å å’Œéå…¬å¹³æŠ¢å é’ˆå¯¹tryAcquireæœ‰ä¸åŒçš„å®ç°ã€‚</p><p><strong>1.3ã€AbstractQueuedSynchronizer</strong></p><p>é¦–å…ˆï¼ŒAbstractQueuedSynchronizerç»§æ‰¿è‡ªAbstractOwnableSynchronizerï¼ŒAbstractOwnableSynchronizerçš„å®ç°å¾ˆç®€å•ï¼Œå®ƒè¡¨ç¤ºç‹¬å çš„åŒæ­¥å™¨ï¼Œå†…éƒ¨ä½¿ç”¨å˜é‡exclusiveOwnerThreadè¡¨ç¤ºç‹¬å çš„çº¿ç¨‹ã€‚</p><p>å…¶æ¬¡ï¼ŒAbstractQueuedSynchronizerå†…éƒ¨ä½¿ç”¨CLHé”é˜Ÿåˆ—æ¥å°†å¹¶å‘æ‰§è¡Œå˜æˆä¸²è¡Œæ‰§è¡Œã€‚æ•´ä¸ªé˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚æ¯ä¸ªCLHé”é˜Ÿåˆ—çš„èŠ‚ç‚¹ï¼Œä¼šä¿å­˜å‰ä¸€ä¸ªèŠ‚ç‚¹å’Œåä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ï¼Œå½“å‰èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹ï¼Œä»¥åŠä¸€ä¸ªçŠ¶æ€ã€‚è¿™ä¸ªçŠ¶æ€ç”¨æ¥è¡¨æ˜è¯¥çº¿ç¨‹æ˜¯å¦åº”è¯¥blockã€‚å½“èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹è¢«é‡Šæ”¾çš„æ—¶å€™ï¼Œå½“å‰èŠ‚ç‚¹å°±è¢«å”¤é†’ï¼Œæˆä¸ºå¤´éƒ¨ã€‚æ–°åŠ å…¥çš„èŠ‚ç‚¹ä¼šæ”¾åœ¨é˜Ÿåˆ—å°¾éƒ¨ã€‚</p><p><strong>äºŒã€ éå…¬å¹³é”çš„lockæ–¹æ³•</strong></p><p><strong>2.1ã€lockæ–¹æ³•æµç¨‹å›¾</strong></p><div class=pgc-img><img alt=ç‰›äººè®²è§£Javaå¯é‡å…¥é”åŸç† onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1535262549148d5cacea56e><p class=pgc-img-caption></p></div><p><strong>2.2ã€lockæ–¹æ³•è¯¦ç»†æè¿°</strong></p><p>1ã€åœ¨åˆå§‹åŒ–ReentrantLockçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬ä¸ä¼ å‚æ•°æ˜¯å¦å…¬å¹³ï¼Œé‚£ä¹ˆé»˜è®¤ä½¿ç”¨éå…¬å¹³é”ï¼Œä¹Ÿå°±æ˜¯NonfairSyncã€‚</p><p>2ã€å½“æˆ‘ä»¬è°ƒç”¨ReentrantLockçš„lockæ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†NonfairSyncçš„lockæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…ˆç”¨CASæ“ä½œï¼Œå»å°è¯•æŠ¢å è¯¥é”ã€‚å¦‚æœæˆåŠŸï¼Œå°±æŠŠå½“å‰çº¿ç¨‹è®¾ç½®åœ¨è¿™ä¸ªé”ä¸Šï¼Œè¡¨ç¤ºæŠ¢å æˆåŠŸã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™è°ƒç”¨acquireæ¨¡æ¿æ–¹æ³•ï¼Œç­‰å¾…æŠ¢å ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>static final <strong>class</strong> NonfairSync <strong>extends</strong> Sync {</p><p>final <strong>void</strong> lock() {</p><p><strong>if</strong> (compareAndSetState(0, 1))</p><p>setExclusiveOwnerThread(Thread.currentThread());</p><p><strong>else</strong></p><p>acquire(1);</p><p>}</p><p>protected final <strong>boolean</strong> tryAcquire(<strong>int</strong> acquires) {</p><p><strong>return</strong> nonfairTryAcquire(acquires);</p><p>}</p><p>}</p><p>3ã€è°ƒç”¨acquire(1)å®é™…ä¸Šä½¿ç”¨çš„æ˜¯AbstractQueuedSynchronizerçš„acquireæ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€å¥—é”æŠ¢å çš„æ¨¡æ¿ï¼Œæ€»ä½“åŸç†æ˜¯å…ˆå»å°è¯•è·å–é”ï¼Œå¦‚æœæ²¡æœ‰è·å–æˆåŠŸï¼Œå°±åœ¨CLHé˜Ÿåˆ—ä¸­å¢åŠ ä¸€ä¸ªå½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹ï¼Œè¡¨ç¤ºç­‰å¾…æŠ¢å ã€‚ç„¶åè¿›å…¥CLHé˜Ÿåˆ—çš„æŠ¢å æ¨¡å¼ï¼Œè¿›å…¥çš„æ—¶å€™ä¹Ÿä¼šå»æ‰§è¡Œä¸€æ¬¡è·å–é”çš„æ“ä½œï¼Œå¦‚æœè¿˜æ˜¯è·å–ä¸åˆ°ï¼Œå°±è°ƒç”¨LockSupport.parkå°†å½“å‰çº¿ç¨‹æŒ‚èµ·ã€‚é‚£ä¹ˆå½“å‰çº¿ç¨‹ä»€ä¹ˆæ—¶å€™ä¼šè¢«å”¤é†’å‘¢ï¼Ÿå½“æŒæœ‰é”çš„é‚£ä¸ªçº¿ç¨‹è°ƒç”¨unlockçš„æ—¶å€™ï¼Œä¼šå°†CLHé˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„çº¿ç¨‹å”¤é†’ï¼Œè°ƒç”¨çš„æ˜¯LockSupport.unparkæ–¹æ³•ã€‚acquireä»£ç æ¯”è¾ƒç®€å•ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>public final <strong>void</strong> acquire(<strong>int</strong> arg) {</p><p><strong>if</strong> (!tryAcquire(arg) &&</p><p>acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</p><p>selfInterrupt();</p><p>}</p><p>3.1ã€acquireæ–¹æ³•å†…éƒ¨å…ˆä½¿ç”¨tryAcquireè¿™ä¸ªé’©å­æ–¹æ³•å»å°è¯•å†æ¬¡è·å–é”ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨NonfairSyncè¿™ä¸ªç±»ä¸­å…¶å®å°±æ˜¯ä½¿ç”¨äº†nonfairTryAcquireï¼Œå…·ä½“å®ç°åŸç†æ˜¯å…ˆæ¯”è¾ƒå½“å‰é”çš„çŠ¶æ€æ˜¯å¦æ˜¯0ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™å°è¯•å»åŸå­æŠ¢å è¿™ä¸ªé”ï¼ˆè®¾ç½®çŠ¶æ€ä¸º1ï¼Œç„¶åæŠŠå½“å‰çº¿ç¨‹è®¾ç½®æˆç‹¬å çº¿ç¨‹ï¼‰ï¼Œå¦‚æœå½“å‰é”çš„çŠ¶æ€ä¸æ˜¯0ï¼Œå°±å»æ¯”è¾ƒå½“å‰çº¿ç¨‹å’Œå ç”¨é”çš„çº¿ç¨‹æ˜¯ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œä¼šå»å¢åŠ çŠ¶æ€å˜é‡çš„å€¼ï¼Œä»è¿™é‡Œçœ‹å‡ºå¯é‡å…¥é”ä¹‹æ‰€ä»¥å¯é‡å…¥ï¼Œå°±æ˜¯åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥åå¤ä½¿ç”¨å®ƒå ç”¨çš„é”ã€‚å¦‚æœä»¥ä¸Šä¸¤ç§æƒ…å†µéƒ½ä¸é€šè¿‡ï¼Œåˆ™è¿”å›å¤±è´¥falseã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>final <strong>boolean</strong> nonfairTryAcquire(<strong>int</strong> acquires) {</p><p>final Thread current = Thread.currentThread();</p><p><strong>int</strong> c = getState();</p><p><strong>if</strong> (c == 0) {</p><p><strong>if</strong> (compareAndSetState(0, acquires)) {</p><p>setExclusiveOwnerThread(current);</p><p><strong>return</strong> <strong>true</strong>;</p><p>}</p><p>}</p><p><strong>else</strong> <strong>if</strong> (current == getExclusiveOwnerThread()) {</p><p><strong>int</strong> nextc = c + acquires;</p><p><strong>if</strong> (nextc &lt; 0) // overflow</p><p><strong>throw</strong> <strong>new</strong> Error("Maximum lock count exceeded");</p><p>setState(nextc);</p><p><strong>return</strong> <strong>true</strong>;</p><p>}</p><p><strong>return</strong> <strong>false</strong>;</p><p>}</p><p>3.2ã€tryAcquireä¸€æ—¦è¿”å›falseï¼Œå°±ä¼šåˆ™è¿›å…¥acquireQueuedæµç¨‹ï¼Œä¹Ÿå°±æ˜¯åŸºäºCLHé˜Ÿåˆ—çš„æŠ¢å æ¨¡å¼ï¼š</p><p>3.2.1ã€é¦–å…ˆï¼Œåœ¨CLHé”é˜Ÿåˆ—å°¾éƒ¨å¢åŠ ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¿å­˜äº†å½“å‰çº¿ç¨‹ï¼Œé€šè¿‡è°ƒç”¨addWaiterå®ç°ï¼Œè¿™é‡Œéœ€è¦è€ƒè™‘åˆå§‹åŒ–çš„æƒ…å†µï¼Œåœ¨ç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹è¿›å…¥çš„æ—¶å€™ï¼Œéœ€è¦åˆå§‹åŒ–ä¸€ä¸ªå¤´èŠ‚ç‚¹ç„¶åæŠŠå½“å‰èŠ‚ç‚¹åŠ å…¥åˆ°å°¾éƒ¨ï¼Œåç»­åˆ™ç›´æ¥åœ¨å°¾éƒ¨åŠ å…¥èŠ‚ç‚¹å°±è¡Œäº†ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>private Node addWaiter(Node mode) {</p><p>// åˆå§‹åŒ–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¿å­˜å½“å‰çº¿ç¨‹</p><p>Node node = <strong>new</strong> Node(Thread.currentThread(), mode);</p><p>// å½“CLHé˜Ÿåˆ—ä¸ä¸ºç©ºçš„è§†ä¹ï¼Œç›´æ¥åœ¨é˜Ÿåˆ—å°¾éƒ¨æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹</p><p>Node pred = tail;</p><p><strong>if</strong> (pred != <strong>null</strong>) {</p><p>node.prev = pred;</p><p><strong>if</strong> (compareAndSetTail(pred, node)) {</p><p>pred.next = node;</p><p><strong>return</strong> node;</p><p>}</p><p>}</p><p>// å½“CLHé˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œè°ƒç”¨enqæ–¹æ³•åˆå§‹åŒ–é˜Ÿåˆ—</p><p>enq(node);</p><p><strong>return</strong> node;</p><p>}</p><p>private Node enq(final Node node) {</p><p><strong>for</strong> (;;) {</p><p>Node t = tail;</p><p><strong>if</strong> (t == <strong>null</strong>) { // åˆå§‹åŒ–èŠ‚ç‚¹ï¼Œå¤´å°¾éƒ½æŒ‡å‘ä¸€ä¸ªç©ºèŠ‚ç‚¹</p><p><strong>if</strong> (compareAndSetHead(<strong>new</strong> Node()))</p><p>tail = head;</p><p>} <strong>else</strong> {// è€ƒè™‘å¹¶å‘åˆå§‹åŒ–</p><p>node.prev = t;</p><p><strong>if</strong> (compareAndSetTail(t, node)) {</p><p>t.next = node;</p><p><strong>return</strong> t;</p><p>}</p><p>}</p><p>}</p><p>}</p><p>3.2.2ã€å°†èŠ‚ç‚¹å¢åŠ åˆ°CLHé˜Ÿåˆ—åï¼Œè¿›å…¥acquireQueuedæ–¹æ³•ã€‚</p><p>é¦–å…ˆï¼Œå¤–å±‚æ˜¯ä¸€ä¸ªæ— é™forå¾ªç¯ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹çš„ä¸‹ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”é€šè¿‡tryAcquireè·å–åˆ°äº†é”ï¼Œè¯´æ˜å¤´èŠ‚ç‚¹å·²ç»é‡Šæ”¾äº†é”ï¼Œå½“å‰çº¿ç¨‹æ˜¯è¢«å¤´èŠ‚ç‚¹é‚£ä¸ªçº¿ç¨‹å”¤é†’çš„ï¼Œè¿™æ—¶å€™å°±å¯ä»¥å°†å½“å‰èŠ‚ç‚¹è®¾ç½®æˆå¤´èŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†failedæ ‡è®°è®¾ç½®æˆfalseï¼Œç„¶åè¿”å›ã€‚è‡³äºä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒçš„nextå˜é‡è¢«è®¾ç½®ä¸ºnullï¼Œåœ¨ä¸‹æ¬¡GCçš„æ—¶å€™ä¼šæ¸…ç†æ‰ã€‚</p><p>å¦‚æœæœ¬æ¬¡å¾ªç¯æ²¡æœ‰è·å–åˆ°é”ï¼Œå°±è¿›å…¥çº¿ç¨‹æŒ‚èµ·é˜¶æ®µï¼Œä¹Ÿå°±æ˜¯shouldParkAfterFailedAcquireè¿™ä¸ªæ–¹æ³•ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>final <strong>boolean</strong> acquireQueued(final Node node, <strong>int</strong> arg) {</p><p><strong>boolean</strong> failed = <strong>true</strong>;</p><p><strong>try</strong> {</p><p><strong>boolean</strong> interrupted = <strong>false</strong>;</p><p><strong>for</strong> (;;) {</p><p>final Node p = node.predecessor();</p><p><strong>if</strong> (p == head && tryAcquire(arg)) {</p><p>setHead(node);</p><p>p.next = <strong>null</strong>; // help GC</p><p>failed = <strong>false</strong>;</p><p><strong>return</strong> interrupted;</p><p>}</p><p><strong>if</strong> (shouldParkAfterFailedAcquire(p, node) &&</p><p>parkAndCheckInterrupt())</p><p>interrupted = <strong>true</strong>;</p><p>}</p><p>} <strong>finally</strong> {</p><p><strong>if</strong> (failed)</p><p>cancelAcquire(node);</p><p>}</p><p>}</p><p>3.2.3ã€å¦‚æœå°è¯•è·å–é”å¤±è´¥ï¼Œå°±ä¼šè¿›å…¥shouldParkAfterFailedAcquireæ–¹æ³•ï¼Œä¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æŒ‚èµ·ï¼Œå¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹å·²ç»æ˜¯SIGNALçŠ¶æ€ï¼Œåˆ™å½“å‰çº¿ç¨‹éœ€è¦æŒ‚èµ·ã€‚å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œåˆ™éœ€è¦å°†å–æ¶ˆèŠ‚ç‚¹ä»é˜Ÿåˆ—ç§»é™¤ã€‚å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€æ˜¯å…¶ä»–çŠ¶æ€ï¼Œåˆ™å°è¯•è®¾ç½®æˆSIGNALçŠ¶æ€ï¼Œå¹¶è¿”å›ä¸éœ€è¦æŒ‚èµ·ï¼Œä»è€Œè¿›è¡Œç¬¬äºŒæ¬¡æŠ¢å ã€‚å®Œæˆä¸Šé¢çš„äº‹åè¿›å…¥æŒ‚èµ·é˜¶æ®µã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>private static <strong>boolean</strong> shouldParkAfterFailedAcquire(Node pred, Node node) {</p><p><strong>int</strong> ws = pred.waitStatus;</p><p><strong>if</strong> (ws == Node.SIGNAL)</p><p>//</p><p><strong>return</strong> <strong>true</strong>;</p><p><strong>if</strong> (ws > 0) {</p><p>//</p><p><strong>do</strong> {</p><p>node.prev = pred = pred.prev;</p><p>} <strong>while</strong> (pred.waitStatus > 0);</p><p>pred.next = node;</p><p>} <strong>else</strong> {</p><p>//</p><p>compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</p><p>}</p><p><strong>return</strong> <strong>false</strong>;</p><p>}</p><p>3.2.4ã€å½“è¿›å…¥æŒ‚èµ·é˜¶æ®µï¼Œä¼šè¿›å…¥parkAndCheckInterruptæ–¹æ³•ï¼Œåˆ™ä¼šè°ƒç”¨LockSupport.park(this)å°†å½“å‰çº¿ç¨‹æŒ‚èµ·ã€‚ä»£ç ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>private final <strong>boolean</strong> parkAndCheckInterrupt() {</p><p>LockSupport.park(<strong>this</strong>);</p><p><strong>return</strong> Thread.interrupted();</p><p>}</p><p><strong>ä¸‰ã€ éå…¬å¹³é”çš„unlockæ–¹æ³•</strong></p><p><strong>3.1ã€unlockæ–¹æ³•çš„æ´»åŠ¨å›¾</strong></p><div class=pgc-img><img alt=ç‰›äººè®²è§£Javaå¯é‡å…¥é”åŸç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1535262549396988e364ba9><p class=pgc-img-caption></p></div><p><strong>3.2ã€unlockæ–¹æ³•è¯¦ç»†æè¿°</strong></p><p>1ã€è°ƒç”¨unlockæ–¹æ³•ï¼Œå…¶å®æ˜¯ç›´æ¥è°ƒç”¨AbstractQueuedSynchronizerçš„releaseæ“ä½œã€‚</p><p>2ã€è¿›å…¥releaseæ–¹æ³•ï¼Œå†…éƒ¨å…ˆå°è¯•tryReleaseæ“ä½œ,ä¸»è¦æ˜¯å»é™¤é”çš„ç‹¬å çº¿ç¨‹ï¼Œç„¶åå°†çŠ¶æ€å‡ä¸€ï¼Œè¿™é‡Œå‡ä¸€ä¸»è¦æ˜¯è€ƒè™‘åˆ°å¯é‡å…¥é”å¯èƒ½è‡ªèº«ä¼šå¤šæ¬¡å ç”¨é”ï¼Œåªæœ‰å½“çŠ¶æ€å˜æˆ0ï¼Œæ‰è¡¨ç¤ºå®Œå…¨é‡Šæ”¾äº†é”ã€‚</p><p>3ã€ä¸€æ—¦tryReleaseæˆåŠŸï¼Œåˆ™å°†CHLé˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º0ï¼Œç„¶åå”¤é†’ä¸‹ä¸€ä¸ªéå–æ¶ˆçš„èŠ‚ç‚¹çº¿ç¨‹ã€‚</p><p>4ã€ä¸€æ—¦ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹è¢«å”¤é†’ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å°±ä¼šè¿›å…¥acquireQueuedä»£ç æµç¨‹ä¸­ï¼Œå»è·å–é”ã€‚</p><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p>unlockä»£ç ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>public <strong>void</strong> unlock() {</p><p>sync.release(1);</p><p>}</p><p>releaseæ–¹æ³•ä»£ç ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>public final <strong>boolean</strong> release(<strong>int</strong> arg) {</p><p><strong>if</strong> (tryRelease(arg)) {</p><p>Node h = head;</p><p><strong>if</strong> (h != <strong>null</strong> && h.waitStatus != 0)</p><p>unparkSuccessor(h);</p><p><strong>return</strong> <strong>true</strong>;</p><p>}</p><p><strong>return</strong> <strong>false</strong>;</p><p>}</p><p>Syncä¸­é€šç”¨çš„tryReleaseæ–¹æ³•ä»£ç ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>protected final <strong>boolean</strong> tryRelease(<strong>int</strong> releases) {</p><p><strong>int</strong> c = getState() - releases;</p><p><strong>if</strong> (Thread.currentThread() != getExclusiveOwnerThread())</p><p><strong>throw</strong> <strong>new</strong> IllegalMonitorStateException();</p><p><strong>boolean</strong> free = <strong>false</strong>;</p><p><strong>if</strong> (c == 0) {</p><p>free = <strong>true</strong>;</p><p>setExclusiveOwnerThread(<strong>null</strong>);</p><p>}</p><p>setState(c);</p><p><strong>return</strong> free;</p><p>}</p><p>unparkSuccessorä»£ç ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>private <strong>void</strong> unparkSuccessor(Node node) {</p><p><strong>int</strong> ws = node.waitStatus;</p><p><strong>if</strong> (ws &lt; 0)</p><p>compareAndSetWaitStatus(node, ws, 0);</p><p>Node s = node.next;</p><p><strong>if</strong> (s == <strong>null</strong> || s.waitStatus > 0) {</p><p>s = <strong>null</strong>;</p><p><strong>for</strong> (Node t = tail; t != <strong>null</strong> && t != node; t = t.prev)</p><p><strong>if</strong> (t.waitStatus &lt;= 0)</p><p>s = t;</p><p>}</p><p><strong>if</strong> (s != <strong>null</strong>)</p><p>LockSupport.unpark(s.thread);</p><p>}</p><p><strong>å››ã€ å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŒºåˆ«</strong></p><p>å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œåœ¨CHLé˜Ÿåˆ—æŠ¢å æ¨¡å¼ä¸Šéƒ½æ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿›å…¥acquireQueuedè¿™ä¸ªæ–¹æ³•ä¹‹åéƒ½ä¸€æ ·ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨åˆæ¬¡æŠ¢å ä¸Šæœ‰åŒºåˆ«ï¼Œä¹Ÿå°±æ˜¯tryAcquireä¸Šçš„åŒºåˆ«ï¼Œä¸‹é¢æ˜¯ä¸¤è€…å†…éƒ¨è°ƒç”¨å…³ç³»çš„ç®€å›¾ï¼š</p><p>Java</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>NonfairSync</p><p>lock â€”> compareAndSetState</p><p>| â€”> setExclusiveOwnerThread</p><p>â€”> accquire</p><p>| â€”> tryAcquire</p><p>|â€”>nonfairTryAcquire</p><p>|â€”> acquireQueued</p><p>FairSync</p><p>lock â€”> acquire</p><p>| â€”> tryAcquire</p><p>|â€”>!hasQueuePredecessors</p><p>|â€”>compareAndSetState</p><p>|â€”>setExclusiveOwnerThread</p><p>|â€”> acquireQueued</p><p>çœŸæ­£çš„åŒºåˆ«å°±æ˜¯å…¬å¹³é”å¤šäº†hasQueuePredecessorsè¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºåˆ¤æ–­CHLé˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰èŠ‚ç‚¹ï¼Œå¯¹äºå…¬å¹³é”ï¼Œå¦‚æœCHLé˜Ÿåˆ—æœ‰èŠ‚ç‚¹ï¼Œåˆ™æ–°è¿›å…¥ç«äº‰çš„çº¿ç¨‹ä¸€å®šè¦åœ¨CHLä¸Šæ’é˜Ÿï¼Œè€Œéå…¬å¹³é”åˆ™æ˜¯æ— è§†CHLé˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼Œç›´æ¥è¿›è¡Œç«äº‰æŠ¢å ï¼Œè¿™å°±æœ‰å¯èƒ½å¯¼è‡´CHLé˜Ÿåˆ—ä¸Šçš„èŠ‚ç‚¹æ°¸è¿œè·å–ä¸åˆ°é”ï¼Œè¿™å°±æ˜¯éå…¬å¹³é”ä¹‹æ‰€ä»¥ä¸å…¬å¹³çš„åŸå› ã€‚</p><p><strong>äº”ã€ æ€»ç»“</strong></p><p>çº¿ç¨‹ä½¿ç”¨ReentrantLockè·å–é”åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯åˆæ¬¡ç«äº‰ï¼Œç¬¬äºŒä¸ªé˜¶æ®µæ˜¯åŸºäºCHLé˜Ÿåˆ—çš„ç«äº‰ã€‚åœ¨åˆæ¬¡ç«äº‰çš„æ—¶å€™æ˜¯å¦è€ƒè™‘é˜Ÿåˆ—èŠ‚ç‚¹ç›´æ¥åŒºåˆ†å‡ºäº†å…¬å¹³é”å’Œéå…¬å¹³é”ã€‚åœ¨åŸºäºCHLé˜Ÿåˆ—çš„é”ç«äº‰ä¸­ï¼Œä¾é CASæ“ä½œä¿è¯åŸå­æ“ä½œï¼Œä¾é LockSupportæ¥åšçº¿ç¨‹çš„æŒ‚èµ·å’Œå”¤é†’ï¼Œä½¿ç”¨é˜Ÿåˆ—æ¥ä¿è¯å¹¶å‘æ‰§è¡Œå˜æˆäº†ä¸²è¡Œæ‰§è¡Œï¼Œä»è€Œæ¶ˆé™¤äº†å¹¶å‘æ‰€å¸¦æ¥çš„é—®é¢˜ã€‚æ€»ä½“æ¥è¯´ï¼ŒReentrantLockæ˜¯ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„é”ï¼Œè€Œä¸”ä½¿ç”¨é¢å‘å¯¹è±¡çš„æ€æƒ³å»å®ç°äº†é”çš„åŠŸèƒ½ï¼Œæ¯”åŸæ¥çš„synchronizedå…³é”®å­—æ›´åŠ å¥½ç†è§£ã€‚</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'è®²è§£','Java','å¯é‡'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>