<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>携程如何基于ARIMA时序分析做业务量的预测 | 极客快訊</title><meta property="og:title" content="携程如何基于ARIMA时序分析做业务量的预测 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/0c45d5443d654c53a11fc201076e9a0b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/467cab41.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/467cab41.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/467cab41.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/467cab41.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/467cab41.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/467cab41.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/467cab41.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/467cab41.html><meta property="article:published_time" content="2020-11-14T21:05:06+08:00"><meta property="article:modified_time" content="2020-11-14T21:05:06+08:00"><meta name=Keywords content><meta name=description content="携程如何基于ARIMA时序分析做业务量的预测"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/467cab41.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>携程如何基于ARIMA时序分析做业务量的预测</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>一、 前言</h1><p>时间序列分析是统计学科的一个重要分支。它主要是通过研究随着时间的推移事物发展变化过程中的规律，来进行事物未来发展情况的预测。在我们的日常生活中，股票的价格走势，奶茶店每天的销售额，一年的降雨量分布，河水四季的涨落情况等都属于时间序列。时间序列的分析深入诸多行业。</p><p>时间序列的分类：</p><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0c45d5443d654c53a11fc201076e9a0b><p class=pgc-img-caption>图1</p></div><ul><li>根据指标的平稳性，分为平稳时间序列和非平稳时间序列；</li><li>根据指标的性质分类，分为总量指标时间序列，相对指标和平均指标时间序列；</li><li>根据指标的时间属性分类，分为时期指标时间序列，时点指标时间序列；</li></ul><p>时期指标时间序列是可以相加的，并且相加是有意义的，比如每天的订单量，一个月的订单量直接将这个月对应的每天的订单量相加即可。时点指标时间序列是不可以相加的，反映的是某一时间点达到的水平，比如每天库存量，库存量相加是没有统计意义的，每月总库存量不等于每天库存量加和。</p><p>对于互联网公司而言，业务量是公司经营关注的重要指标之一。实际情况的复杂性给业务量的分析预测带来了许多挑战：</p><ul><li>具有业务特征的周期性影响</li><li>节假日等特定时序节点的变异</li><li>地域差异，空间的相互作用</li><li>受到库存、实际市场容量的影响</li><li>其他外生变量，不可控自然或社会因素</li></ul><p>对于时间序列的分析，例如订单量，话务量，库存管理等，实现的方式有ANN，RNN，LR，ARIMA，Prophet等，这里我们重点关注ARIMA分析方法。</p><h1 class=pgc-h-arrow-right>二、 时间序列分析实践</h1><p><strong>2.1 ARIMA模型简介</strong></p><p>ARMA模型的全称是自回归移动平均模型，可以说是目前最常用的拟合平稳序列的模型。</p><p>ARMA模型由两部分组成：</p><p>p阶自回归模型AR(p)</p><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6fd887a5746442a4985c18e173dd69e2><p class=pgc-img-caption></p></div><p>当φ0=0时，自回归模型又称为中心化AR(p)模型。非中心化的AR(p)序列也可以转化（通过平移）为中心化的AR(p)模型。</p><p>AR模型将某时刻t的值用过去若干时刻t-1到t-p的值通过线性组合以及噪声来表示。</p><p>q阶移动平均模型MA(q)</p><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/39004eea8d7340a4a4c43484afcb7dbd><p class=pgc-img-caption></p></div><p>当μ=0时，模型MA(q)称为中心化MA(q)模型，对于非中心化的MA(q)模型只要做简单的位移就可以转化为中心化的MA(q)模型。</p><p>MA模型是通过历史点的噪声线性组合来表示当前时刻的值。</p><p>ARMA模型其实就是AR(P)和MA(q)的组合：</p><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/832c9306586d4a788f5b15b23e25adb9><p class=pgc-img-caption></p></div><p>同样的，当φ0=0时该模型称为中心化的ARMA(p,q)模型。他结合了两个模型的特点，AR模型处理当前数据与后期数据之间的关系，MA则处理随机变动的影响。</p><p>对于平稳时间序列可以采用ARMA模型直接进行拟合，但是实际场景中，我们的时间序列都是有趋势的，即一般时序为非平稳的，所以需要做平稳处理，其中最常用的是差分处理，使得时序平稳后进行ARMA分析。</p><p>这一过程其实就是ARIMA，在原始非平稳时间序列基础上做一阶或二阶差分处理后的平稳时间序列上应用ARMA模型。ARIMA(p,d,q)模型是在ARMA(p,q)两元组阶数基础上增加差分d的三元组阶数模型。</p><p><strong>2.2 ARIMA模型实践分析步骤</strong></p><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fda6b7b93a1e4e72afa9ba71b12631cf><p class=pgc-img-caption>图2</p></div><p>具体实现以python为例。</p><p><strong>Step1、读取时间序列</strong></p><pre><code>df = pd.read_csv('testdata.csv', encoding='gbk', index_col='ddate')#时间序列索引转换为日期格式df.index = pd.to_datetime(df.index)#指标量转为float类型df['cnt'] = df['cnt'].astype(float)plt.figure(facecolor='white',figsize=(20,8))plt.plot(df.index,df['cnt'],label='Time Series')plt.legend(loc='best')plt.show() </code></pre><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ccb0a18b1e9a46a894928863d93a19f8><p class=pgc-img-caption>图3</p></div><p><strong>Step2、时间序列平稳性检验</strong></p><p>什么是平稳？</p><p>平稳分为严平稳和宽平稳，严平稳保证时间序列的任何有限维分布对于时间的平移是不变的，比如高斯白噪声就是严平稳序列；宽平稳则要求协方差结构随时间的平移而不变，或均值和方差是不变的。</p><p>为什么需要平稳？</p><p>ARIMA包含了AR模型，AR模型的实质是用历史时间点数据预测当前时间点对应的值。这就要求序列的相关性不会随着时间变化而变化。</p><pre><code>from statsmodels.tsa.stattools import adfullerdef test_stationarity(timeseries):    dftest = adfuller(timeseries, autolag='AIC')    return dftest[1]</code></pre><p>原始时间序列平稳性检验未通过(0.94)。从图3也可以看到，时间序列具有明显的上升趋势，所以需要尝试对时间序列进行差分处理，再次检验其平稳性。</p><p><strong>Step3、差分处理后检验平稳性</strong></p><pre><code>pred_day = 7train_start = datetime(2017,3,1)train_end = datetime(2019,8,16)pred_start = train_end+timedelta(1)pred_end = train_end+timedelta(pred_day)train_diff=df[train_start:train_end]train_diff['cnt']=train_diff.diff()print(test_stationarity(train_diff['cnt'][train_start+timedelta(1):train_end]))plt.figure(facecolor='white',figsize=(20,8))plt.plot(train_diff.index,train_diff['cnt'],label='Time Series after diff')plt.legend(loc='best')plt.show()</code></pre><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d0e2410118e94c25934b2b603f4314b3><p class=pgc-img-caption>图4</p></div><p>差分后的时序平稳性检验值9.51*e(-15)，说明差分后时序已经是平稳时间序列了，可以应用ARIMA模型。</p><p><strong>Step4、画出ACF和PACF图</strong></p><p>自相关函数ACF，反映了两个点之间的相关性。</p><p>偏自相关函数PACF则是排除了两点之间其他点的影响，反应两点之间的相关性。比如：在AR(2)中，即使y(t-3)没有直接出现在模型中，但是y(t)和y(t-3)之间也相关。</p><pre><code>import statsmodels.api as smfig = plt.figure(figsize=(12,8))ax1 = fig.add_subplot(211)fig = sm.graphics.tsa.plot_acf(train_diff['cnt'][1:], lags=20, ax=ax1)ax1.xaxis.set_ticks_position('bottom')fig.tight_layout()ax2 = fig.add_subplot(212)fig = sm.graphics.tsa.plot_pacf(train_diff['cnt'][1:], lags=20, ax=ax2)ax2.xaxis.set_ticks_position('bottom')fig.tight_layout()plt.show()</code></pre><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/00173f6596704c3c85c972c04a51e642><p class=pgc-img-caption>图5</p></div><p>严格来看，ACF和PACF显示存在一定程度的拖尾和振荡。但是，ACF和PACF在3阶后有骤降和平稳的趋势，考虑到是短期预测的场景，可进一步结合预测效果和模型检验来进行判断。</p><p><strong>Step5、ARIMA模型</strong><strong>定阶</strong></p><p>虽然ACF和PACF为我们提供了选择模型参数的参考依据，但是一般实际情况中，我们总会需要通过模型训练效果确定最终采用的参数值。在ARMA模型中，我们通常采用AIC法则（赤池信息准则，AIC=2k-2ln(L)，k为模型参数个数，n为样本数量，L为似然函数）。AIC鼓励数据拟合的有良性但是尽量避免出现过拟合的情况。所以实际操作中，我们会选择模型AIC值最小的那组参数。</p><pre><code>#定阶warnings.filterwarnings("ignore") # specify to ignore warning messagespmax = 8qmax = 8aic_matrix = [] #aic矩阵for p in range(1,pmax+1):    tmp = []    for q in range(1,qmax+1):        try: #存在部分报错，所以用try来跳过报错。            model = ARIMA(endog=df['cnt'],order=(p,1,q))            results = model.fit(disp=-1)            tmp.append(results.aic)            print('ARIMA p:{} q:{} - AIC:{}'.format(p, q, results.aic))        except:            tmp.append(None)    aic_matrix.append(tmp)aic_matrix = pd.DataFrame(aic_matrix) #从中可以找出最小值p,q = aic_matrix.stack().idxmin() #先用stack展平，然后用idxmin找出最小值位置。print(u'AIC最小的p值和q值为：%s、%s' %(p+1,q+1))</code></pre><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6fcfe86c36114cafb68cba2a2ca6f782><p class=pgc-img-caption>图6</p></div><p>由于时间序列为1阶差分平稳时间序列，所以模型参数d=1，根据AIC最小原则得到p=7，q=7。</p><p><strong>Step6、模型测试与优化</strong></p><p>将训练得到的参数加入模型，分析模型效果。</p><pre><code>model = ARIMA(endog=df['cnt'], order=(p,1,q))   #建立ARIMA(7, 1,7)模型result_ARIMA = model.fit(disp=-1,method='css')predict_diff=result_ARIMA.predict()#一阶差分还原df_shift=df['cnt'].shift(1)predict=predict_diff+df_shiftplt.figure(figsize=(18,5),facecolor='white')predict[train_start+timedelta(p+1):train_end].plot(color='blue', label='Predict')df['cnt'][train_start+timedelta(p+1):train_end].plot(color='red', label='Original')err=sum(np.sqrt((predict[train_start+timedelta(p+1):train_end]-df['cnt'][train_start+timedelta(p+1):train_end])**2)/df['cnt'][train_start+timedelta(p+1):train_end])/df['cnt'][train_start+timedelta(p+1):train_end].sizeplt.legend(loc='best')plt.title('Error: %.4f'%err) plt.show()</code></pre><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/55ac7a50989842f887d34aeb67935b36><p class=pgc-img-caption>图7</p></div><p>用训练好的模型进行未来预测。</p><pre><code>y_forecasted =result_ARIMA.forecast(steps=pred_day, alpha=0.01)[0] #作为期7天的预测y_truth = df[pred_start:pred_end]['cnt']# 均方根误差  #平均错误率mse = np.sqrt( ((y_forecasted - y_truth) ** 2) ).mean()error_rate = ( abs(y_forecasted - y_truth)/y_truth  ).mean()print('\nThe Mean Error rate of our forecasts is {}'.format(round(error_rate, 4))) </code></pre><p>模型预测误差8.58%（【偏差/真实值】的均值），结果并不是太理想，所以我们需要对模型进行优化，考虑是因为指标受到了节假日和周的影响，所以在模型的外生变量里面我们加入节假日和周的识别参数。</p><p>加入exog外生变量后，需要重新定阶，重新训练模型，步骤与上类似。优化后的预测误差1.77%，相比之前有了很大程度的提升。</p><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/da4f067e87194241ae2fc1aa9d5713a9><p class=pgc-img-caption>图8</p></div><p><strong>Step7、模型检验</strong></p><p>用模型残差来检验模型的合理性。</p><pre><code>resid = result_ARIMA_improve.resid #赋值plt.figure(figsize=(12,8))qqplot(resid,line='q',fit=True)#利用D-W检验,检验残差的自相关性print('D-W检验值为{}'.format(durbin_watson(resid.values)))</code></pre><div class=pgc-img><img alt=携程如何基于ARIMA时序分析做业务量的预测 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/03e577bdf4324471a0b06925f67ff20b><p class=pgc-img-caption>图9</p></div><p>通过图9的qq图可以看出，残差基本满足了正态分布。D-W检验结果值为1.99，接近于2，说明残差序列不存在自相关性，即模型较好。</p><h1 class=pgc-h-arrow-right>三、总结与展望</h1><ul><li>对于时间序列的分析一定做好前期评估工作，直观的图表分析会助力我们的决策。多探索优秀的开源工具库，往往会使我们事半功倍。</li></ul><ul><li>模型选择至关重要，明确模型的适用场景，根据自身的时序选择适合的模型分析。</li></ul><ul><li>ARIMA模型在短时间内的预期效果还算可以，但是长时间比如未来一年的预测不太适用，因为偏差会逐渐增大。</li></ul><ul><li>现实中的复杂场景，单一模型很难解决，需要考虑多模型结合的方式实现分析预测。</li></ul><p><strong>【作者简介】</strong>June，携程数据分析经理，对数仓搭建，数据治理，数据分析等方面有较浓厚的兴趣。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'携程','ARIMA','时序'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>