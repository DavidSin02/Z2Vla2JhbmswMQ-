<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ä½¿ç”¨springcloud gatewayæ­å»ºç½‘å…³ï¼ˆåˆ†æµï¼Œé™æµï¼Œç†”æ–­ï¼‰ | æå®¢å¿«è¨Š</title><meta property="og:title" content="ä½¿ç”¨springcloud gatewayæ­å»ºç½‘å…³ï¼ˆåˆ†æµï¼Œé™æµï¼Œç†”æ–­ï¼‰ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/5dedf0d033b54111b51594e9169ef331"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/483ff7c0.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/483ff7c0.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/483ff7c0.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/483ff7c0.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/483ff7c0.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/483ff7c0.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/483ff7c0.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/483ff7c0.html><meta property="article:published_time" content="2020-11-14T21:03:15+08:00"><meta property="article:modified_time" content="2020-11-14T21:03:15+08:00"><meta name=Keywords content><meta name=description content="ä½¿ç”¨springcloud gatewayæ­å»ºç½‘å…³ï¼ˆåˆ†æµï¼Œé™æµï¼Œç†”æ–­ï¼‰"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/483ff7c0.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ä½¿ç”¨springcloud gatewayæ­å»ºç½‘å…³ï¼ˆåˆ†æµï¼Œé™æµï¼Œç†”æ–­ï¼‰</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><h1><strong>Spring Cloud Gateway</strong></h1><p>Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚</p><p>Spring Cloud Gateway ä½œä¸º Spring Cloud ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£ Netflix Zuulï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§/æŒ‡æ ‡ï¼Œå’Œé™æµã€‚</p><p>å¦‚æœæƒ³å­¦ä¹ Javaå·¥ç¨‹åŒ–ã€é«˜æ€§èƒ½åŠåˆ†å¸ƒå¼ã€æ·±å…¥æµ…å‡ºã€‚å¾®æœåŠ¡ã€Springï¼ŒMyBatisï¼ŒNettyæºç åˆ†æçš„æœ‹å‹å¯ä»¥åŠ æˆ‘çš„Javaé«˜çº§äº¤æµï¼š854630135ï¼Œç¾¤é‡Œæœ‰é˜¿é‡Œå¤§ç‰›ç›´æ’­è®²è§£æŠ€æœ¯ï¼Œä»¥åŠJavaå¤§å‹äº’è”ç½‘æŠ€æœ¯çš„è§†é¢‘å…è´¹åˆ†äº«ç»™å¤§å®¶ã€‚</p><p>ç›¸å…³æ¦‚å¿µ:</p><ul><li>Routeï¼ˆè·¯ç”±ï¼‰ï¼šè¿™æ˜¯ç½‘å…³çš„åŸºæœ¬æ„å»ºå—ã€‚å®ƒç”±ä¸€ä¸ª IDï¼Œä¸€ä¸ªç›®æ ‡ URIï¼Œä¸€ç»„æ–­è¨€å’Œä¸€ç»„è¿‡æ»¤å™¨å®šä¹‰ã€‚å¦‚æœæ–­è¨€ä¸ºçœŸï¼Œåˆ™è·¯ç”±åŒ¹é…ã€‚</li><li>Predicateï¼ˆæ–­è¨€ï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ª Java 8 çš„ Predicateã€‚è¾“å…¥ç±»å‹æ˜¯ä¸€ä¸ª ServerWebExchangeã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥åŒ¹é…æ¥è‡ª HTTP è¯·æ±‚çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚ headers æˆ–å‚æ•°ã€‚</li><li>Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ï¼šè¿™æ˜¯org.springframework.cloud.gateway.filter.GatewayFilterçš„å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä¿®æ”¹è¯·æ±‚å’Œå“åº”ã€‚</li></ul><p>å·¥ä½œæµç¨‹ï¼š</p><div class=pgc-img><img alt="ä½¿ç”¨springcloud gatewayæ­å»ºç½‘å…³ï¼ˆåˆ†æµï¼Œé™æµï¼Œç†”æ–­ï¼‰" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5dedf0d033b54111b51594e9169ef331><p class=pgc-img-caption></p></div><p>å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚å¦‚æœ Gateway Handler Mapping ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handlerã€‚Handler å†é€šè¿‡æŒ‡å®šçš„è¿‡æ»¤å™¨é“¾æ¥å°†è¯·æ±‚å‘é€åˆ°æˆ‘ä»¬å®é™…çš„æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å›ã€‚ è¿‡æ»¤å™¨ä¹‹é—´ç”¨è™šçº¿åˆ†å¼€æ˜¯å› ä¸ºè¿‡æ»¤å™¨å¯èƒ½ä¼šåœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰ï¼ˆâ€œpreâ€ï¼‰æˆ–ä¹‹åï¼ˆâ€œpostâ€ï¼‰æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚</p><p>Spring Cloud Gateway çš„ç‰¹å¾ï¼š</p><p>å¦‚æœæƒ³å­¦ä¹ Javaå·¥ç¨‹åŒ–ã€é«˜æ€§èƒ½åŠåˆ†å¸ƒå¼ã€æ·±å…¥æµ…å‡ºã€‚å¾®æœåŠ¡ã€Springï¼ŒMyBatisï¼ŒNettyæºç åˆ†æçš„æœ‹å‹å¯ä»¥åŠ æˆ‘çš„Javaé«˜çº§äº¤æµï¼š854630135ï¼Œç¾¤é‡Œæœ‰é˜¿é‡Œå¤§ç‰›ç›´æ’­è®²è§£æŠ€æœ¯ï¼Œä»¥åŠJavaå¤§å‹äº’è”ç½‘æŠ€æœ¯çš„è§†é¢‘å…è´¹åˆ†äº«ç»™å¤§å®¶ã€‚</p><ul><li>åŸºäº Spring Framework 5ï¼ŒProject Reactor å’Œ Spring Boot 2.0</li><li>åŠ¨æ€è·¯ç”±</li><li>Predicates å’Œ Filters ä½œç”¨äºç‰¹å®šè·¯ç”±</li><li>é›†æˆ Hystrix æ–­è·¯å™¨</li><li>é›†æˆ Spring Cloud DiscoveryClient</li><li>æ˜“äºç¼–å†™çš„ Predicates å’Œ Filters</li><li>é™æµ</li><li>è·¯å¾„é‡å†™</li></ul><h1><strong>å¿«é€Ÿä¸Šæ‰‹</strong></h1><p>å¼•å…¥spring-boot 2.1.1.RELEASE ï¼Œspringcloudçš„ç‰ˆæœ¬ä¸º Greenwich.M3</p><pre> &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.1.1.RELEASE&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt;  &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;spring-cloud.version&gt;Greenwich.M3&lt;/spring-cloud.version&gt; &lt;/properties&gt;  &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;${spring-cloud.version}&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt;</pre><p>æ·»åŠ çš„ä¾èµ–åŒ…å¦‚ä¸‹</p><pre> &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt; &lt;/dependency&gt;</pre><p>æ³¨æ„springcloud gatewayä½¿ç”¨çš„webæ¡†æ¶ä¸ºwebfluxï¼Œå’ŒspringMVCä¸å…¼å®¹ã€‚å¼•å…¥çš„é™æµç»„ä»¶æ˜¯hystrixã€‚redisåº•å±‚ä¸å†ä½¿ç”¨jedisï¼Œè€Œæ˜¯lettuceã€‚</p><h1><strong>è·¯ç”±æ–­è¨€</strong></h1><p>æ¥ä¸‹æ¥å°±æ˜¯é…ç½®äº†ï¼Œå¯ä»¥ä½¿ç”¨javaä»£ç ç¡¬ç¼–ç é…ç½®è·¯ç”±è¿‡æ»¤å™¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ymlé…ç½®æ–‡ä»¶é…ç½®ã€‚ä¸‹é¢æˆ‘ä»¬é¦–å…ˆä»‹ç»é…ç½®æ–‡ä»¶é…ç½®æ–¹å¼</p><p>application.yml</p><pre>server.port: 8082spring: application: name: gateway cloud: gateway: routes: - id: path_route uri: http://localhost:8000 order: 0 predicates: - Path=/foo/** filters: - StripPrefix=1</pre><p>ä¸Šé¢ç»™å‡ºäº†ä¸€ä¸ªæ ¹æ®è¯·æ±‚è·¯å¾„æ¥åŒ¹é…ç›®æ ‡uriçš„ä¾‹å­ï¼Œå¦‚æœè¯·æ±‚çš„è·¯å¾„ä¸º/foo/barï¼Œåˆ™ç›®æ ‡uriä¸º http://localhost:8000/barã€‚å¦‚æœä¸Šé¢ä¾‹å­ä¸­æ²¡æœ‰åŠ ä¸€ä¸ªStripPrefix=1è¿‡æ»¤å™¨ï¼Œåˆ™ç›®æ ‡uri ä¸ºhttp://localhost:8000/foo/barï¼ŒStripPrefixè¿‡æ»¤å™¨æ˜¯å»æ‰ä¸€ä¸ªè·¯å¾„ã€‚</p><p>å…¶ä»–çš„è·¯ç”±æ–­è¨€å’Œè¿‡æ»¤å™¨ä½¿ç”¨æ–¹æ³•è¯·æŸ¥çœ‹å®˜ç½‘</p><p>https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.0.RC2/single/spring-cloud-gateway.html#gateway-how-it-works</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è®¾è®¡ä¸€ä¸ªç½‘å…³åº”è¯¥éœ€è¦çš„ä¸€äº›åŠŸèƒ½</p><h1><strong>ä¿®æ”¹æ¥å£è¿”å›æŠ¥æ–‡</strong></h1><p>å› ä¸ºç½‘å…³è·¯ç”±çš„æ¥å£è¿”å›æŠ¥æ–‡æ ¼å¼å„å¼‚ï¼Œå¹¶ä¸”ç½‘å…³ä¹Ÿæœ‰æœ‰ä¸€äº›é™æµã€è®¤è¯ã€ç†”æ–­é™çº§çš„è¿”å›æŠ¥æ–‡ï¼Œä¸ºäº†ç»Ÿä¸€è¿™äº›æŠ¥æ–‡çš„è¿”å›æ ¼å¼ï¼Œç½‘å…³å¿…é¡»è¦å¯¹æ¥å£çš„è¿”å›æŠ¥æ–‡è¿›è¡Œä¿®æ”¹ï¼Œè¿‡æ»¤å™¨ä»£ç å¦‚ä¸‹ï¼š</p><pre>package org.gateway.filter.global;import java.nio.charset.Charset;import org.gateway.response.Response;import org.reactivestreams.Publisher;import org.springframework.cloud.gateway.filter.GatewayFilterChain;import org.springframework.cloud.gateway.filter.GlobalFilter;import org.springframework.core.Ordered;import org.springframework.core.io.buffer.DataBuffer;import org.springframework.core.io.buffer.DataBufferFactory;import org.springframework.core.io.buffer.DataBufferUtils;import org.springframework.http.server.reactive.ServerHttpResponse;import org.springframework.http.server.reactive.ServerHttpResponseDecorator;import org.springframework.stereotype.Component;import org.springframework.web.server.ServerWebExchange;import com.alibaba.fastjson.JSON;import reactor.core.publisher.Flux;import reactor.core.publisher.Mono;@Componentpublic class WrapperResponseFilter implements GlobalFilter, Ordered { @Override public int getOrder() { // -1 is response write filter, must be called before that return -2; } @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) { ServerHttpResponse originalResponse = exchange.getResponse(); DataBufferFactory bufferFactory = originalResponse.bufferFactory(); ServerHttpResponseDecorator decoratedResponse = new ServerHttpResponseDecorator(originalResponse) { @Override public Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body) { if (body instanceof Flux) { Flux&lt;? extends DataBuffer&gt; fluxBody = (Flux&lt;? extends DataBuffer&gt;) body; return super.writeWith(fluxBody.map(dataBuffer -&gt; { // probably should reuse buffers byte[] content = new byte[dataBuffer.readableByteCount()]; dataBuffer.read(content); // é‡Šæ”¾æ‰å†…å­˜ DataBufferUtils.release(dataBuffer); String rs = new String(content, Charset.forName("UTF-8")); Response response = new Response(); response.setCode("1"); response.setMessage("è¯·æ±‚æˆåŠŸ"); response.setData(rs);  byte[] newRs = JSON.toJSONString(response).getBytes(Charset.forName("UTF-8")); originalResponse.getHeaders().setContentLength(newRs.length);//å¦‚æœä¸é‡æ–°è®¾ç½®é•¿åº¦åˆ™æ”¶ä¸åˆ°æ¶ˆæ¯ã€‚ return bufferFactory.wrap(newRs); })); } // if body is not a flux. never got there. return super.writeWith(body); } }; // replace response with decorator return chain.filter(exchange.mutate().response(decoratedResponse).build()); }}</pre><p>éœ€è¦æ³¨æ„çš„æ˜¯orderéœ€è¦å°äº-1ï¼Œéœ€è¦å…ˆäºNettyWriteResponseFilterè¿‡æ»¤å™¨æ‰§è¡Œã€‚</p><p>æœ‰äº†ä¸€ä¸ªè¿™æ ·çš„è¿‡æ»¤å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»Ÿä¸€è¿”å›æŠ¥æ–‡æ ¼å¼äº†ã€‚</p><h1><strong>è®¤è¯</strong></h1><p>ä»¥ä¸‹æä¾›ä¸€ä¸ªç®€å•çš„è®¤è¯è¿‡æ»¤å™¨</p><pre>package org.gateway.filter.global;import java.nio.charset.StandardCharsets;import org.gateway.response.Response;import org.springframework.cloud.gateway.filter.GatewayFilterChain;import org.springframework.cloud.gateway.filter.GlobalFilter;import org.springframework.core.io.buffer.DataBuffer;import org.springframework.http.HttpStatus;import org.springframework.http.server.reactive.ServerHttpResponse;import org.springframework.stereotype.Component;import org.springframework.web.server.ServerWebExchange;import com.alibaba.fastjson.JSON;import reactor.core.publisher.Mono;@Componentpublic class AuthFilter implements GlobalFilter{ @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) { String token = exchange.getRequest().getHeaders().getFirst("token"); if ("token".equals(token)) { return chain.filter(exchange); } ServerHttpResponse response = exchange.getResponse(); Response data = new Response(); data.setCode("401"); data.setMessage("éæ³•è¯·æ±‚"); byte[] datas = JSON.toJSONString(data).getBytes(StandardCharsets.UTF_8); DataBuffer buffer = response.bufferFactory().wrap(datas); response.setStatusCode(HttpStatus.UNAUTHORIZED); response.getHeaders().add("Content-Type", "application/json;charset=UTF-8"); return response.writeWith(Mono.just(buffer)); }}</pre><h1><strong>é™æµ</strong></h1><p>springcloud gateway ä¸ºæˆ‘ä»¬æä¾›äº†é™æµè¿‡æ»¤å™¨RequestRateLimiterGatewayFilterFactoryï¼Œå’Œé™æµçš„å®ç°ç±»RedisRateLimiterä½¿ç”¨ä»¤ç‰Œæ¡¶é™æµã€‚ä½†æ˜¯å®˜æ–¹çš„ä¸ä¸€å®šæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡æ–°å†™ä¸€ä¸ªè¿‡æ»¤å™¨ï¼ˆåŸºæœ¬å’Œå®˜æ–¹ä¸€è‡´ï¼‰ï¼Œåªæ˜¯å°†å®˜æ–¹çš„è¿”å›æŠ¥æ–‡æ”¹äº†ã€‚</p><pre>package org.gateway.limiter;import java.nio.charset.StandardCharsets;import java.util.Map;import org.gateway.response.Response;import org.springframework.cloud.gateway.filter.GatewayFilter;import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;import org.springframework.cloud.gateway.filter.ratelimit.KeyResolver;import org.springframework.cloud.gateway.filter.ratelimit.RateLimiter;import org.springframework.cloud.gateway.route.Route;import org.springframework.cloud.gateway.support.ServerWebExchangeUtils;import org.springframework.core.io.buffer.DataBuffer;import org.springframework.http.HttpStatus;import org.springframework.http.server.reactive.ServerHttpResponse;import com.alibaba.fastjson.JSON;import reactor.core.publisher.Mono;/** * User Request Rate Limiter filter. See https://stripe.com/blog/rate-limiters and */public class RateLimiterGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;RateLimiterGatewayFilterFactory.Config&gt; { public static final String KEY_RESOLVER_KEY = "keyResolver"; private final RateLimiter defaultRateLimiter; private final KeyResolver defaultKeyResolver; public RateLimiterGatewayFilterFactory(RateLimiter defaultRateLimiter, KeyResolver defaultKeyResolver) { super(Config.class); this.defaultRateLimiter = defaultRateLimiter; this.defaultKeyResolver = defaultKeyResolver; } public KeyResolver getDefaultKeyResolver() { return defaultKeyResolver; } public RateLimiter getDefaultRateLimiter() { return defaultRateLimiter; } @SuppressWarnings("unchecked") @Override public GatewayFilter apply(Config config) { KeyResolver resolver = (config.keyResolver == null) ? defaultKeyResolver : config.keyResolver; RateLimiter&lt;Object&gt; limiter = (config.rateLimiter == null) ? defaultRateLimiter : config.rateLimiter; return (exchange, chain) -&gt; { Route route = exchange.getAttribute(ServerWebExchangeUtils.GATEWAY_ROUTE_ATTR); return resolver.resolve(exchange).flatMap(key -&gt; // TODO: if key is empty? limiter.isAllowed(route.getId(), key).flatMap(response -&gt; { for (Map.Entry&lt;String, String&gt; header : response.getHeaders().entrySet()) { exchange.getResponse().getHeaders().add(header.getKey(), header.getValue()); } if (response.isAllowed()) { return chain.filter(exchange); } ServerHttpResponse rs = exchange.getResponse(); Response data = new Response(); data.setCode("101"); data.setMessage("è®¿é—®è¿‡å¿«"); byte[] datas = JSON.toJSONString(data).getBytes(StandardCharsets.UTF_8); DataBuffer buffer = rs.bufferFactory().wrap(datas); rs.setStatusCode(HttpStatus.UNAUTHORIZED); rs.getHeaders().add("Content-Type", "application/json;charset=UTF-8"); return rs.writeWith(Mono.just(buffer)); })); }; } public static class Config { private KeyResolver keyResolver; private RateLimiter rateLimiter; private HttpStatus statusCode = HttpStatus.TOO_MANY_REQUESTS; public KeyResolver getKeyResolver() { return keyResolver; } public Config setKeyResolver(KeyResolver keyResolver) { this.keyResolver = keyResolver; return this; } public RateLimiter getRateLimiter() { return rateLimiter; } public Config setRateLimiter(RateLimiter rateLimiter) { this.rateLimiter = rateLimiter; return this; } public HttpStatus getStatusCode() { return statusCode; } public Config setStatusCode(HttpStatus statusCode) { this.statusCode = statusCode; return this; } }}</pre><p>ç„¶åé™æµå¿…é¡»è¦æœ‰ä¸€ä¸ªkeyï¼Œæ ¹æ®ä»€ä¹ˆæ¥è¿›è¡Œé™æµï¼Œipï¼Œæ¥å£ï¼Œæˆ–è€…ç”¨æˆ·æ¥è¿›è¡Œé™æµï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªKeyResolver</p><pre>package org.gateway.limiter;import org.springframework.cloud.gateway.filter.ratelimit.KeyResolver;import org.springframework.web.server.ServerWebExchange;import com.alibaba.fastjson.JSON;import reactor.core.publisher.Mono;public class CustomKeyResolver implements KeyResolver { public static final String BEAN_NAME = "customKeyResolver"; @Override public Mono&lt;String&gt; resolve(ServerWebExchange exchange) { return Mono.just(getKey(exchange)); } /** *  * @param exchange * @return */ private String getKey(ServerWebExchange exchange) {  LimitKey limitKey = new LimitKey();  limitKey.setApi(exchange.getRequest().getPath().toString()); limitKey.setBiz(exchange.getRequest().getQueryParams().getFirst("biz")); return JSON.toJSONString(limitKey); }}</pre><p>å¦‚æœæƒ³å­¦ä¹ Javaå·¥ç¨‹åŒ–ã€é«˜æ€§èƒ½åŠåˆ†å¸ƒå¼ã€æ·±å…¥æµ…å‡ºã€‚å¾®æœåŠ¡ã€Springï¼ŒMyBatisï¼ŒNettyæºç åˆ†æçš„æœ‹å‹å¯ä»¥åŠ æˆ‘çš„Javaé«˜çº§äº¤æµï¼š854630135ï¼Œç¾¤é‡Œæœ‰é˜¿é‡Œå¤§ç‰›ç›´æ’­è®²è§£æŠ€æœ¯ï¼Œä»¥åŠJavaå¤§å‹äº’è”ç½‘æŠ€æœ¯çš„è§†é¢‘å…è´¹åˆ†äº«ç»™å¤§å®¶ã€‚</p><p>æœ€åRedisRateLimiteræˆ‘ä»¬ä¹Ÿéœ€è¦é‡å†™ï¼Œå› ä¸ºä¸æ”¯æŒå¤šçº§é™æµï¼ŒåŸç”Ÿçš„åªä¼šåˆ¤æ–­ä¸€ä¸ªkeyã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre> /** * This uses a basic token bucket algorithm and relies on the fact that Redis scripts * execute atomically. No other operations can run between fetching the count and * writing the new count. */ @Override public Mono&lt;Response&gt; isAllowed(String routeId, String id) { if (!this.initialized.get()) { throw new IllegalStateException("RedisRateLimiter is not initialized"); } LimitConfig limitConfig = getLimitConfig(routeId);  if (limitConfig == null || limitConfig.getTokenConfig().size()==0) { return Mono.just(new Response(true,null)); } Map&lt;String, Config&gt; conf = limitConfig.getTokenConfig();  LimitKey limitKey = JSON.parseObject(id, LimitKey.class); //apié™æµ String api = limitKey.getApi(); Config apiConf = conf.get(api); //ä¸šåŠ¡æ–¹é™æµ String biz = limitKey.getBiz(); Config bizConf = conf.get(biz);  if (apiConf!=null) { return isSingleAllow(api,routeId,apiConf).flatMap(res -&gt; { if (res.isAllowed()) { if(bizConf!=null) { return isSingleAllow(biz, routeId, bizConf); }else { return Mono.just(new Response(true,new HashMap&lt;&gt;())); } }else { return Mono.just(res); } } ); }else { if (bizConf!=null) { return isSingleAllow(biz, routeId, bizConf); }else { return Mono.just(new Response(true,new HashMap&lt;&gt;())); } } } /** * å•çº§é™æµ * @param api * @param routeId * @param apiConf * @return  */ private Mono&lt;Response&gt; isSingleAllow(String key, String routeId, Config config) { // How many requests per second do you want a user to be allowed to do? int replenishRate = config.getReplenishRate(); // How much bursting do you want to allow? int burstCapacity = config.getBurstCapacity(); try { List&lt;String&gt; keys = getKeys(routeId+"$"+key); // The arguments to the LUA script. time() returns unixtime in seconds. List&lt;String&gt; scriptArgs = Arrays.asList(replenishRate + "", burstCapacity + "", Instant.now().getEpochSecond() + "", "1"); // allowed, tokens_left = redis.eval(SCRIPT, keys, args) Flux&lt;List&lt;Long&gt;&gt; flux = this.redisTemplate.execute(this.script, keys, scriptArgs); // .log("redisratelimiter", Level.FINER); return flux.onErrorResume(throwable -&gt; Flux.just(Arrays.asList(1L, -1L))) .reduce(new ArrayList&lt;Long&gt;(), (longs, l) -&gt; { longs.addAll(l); return longs; }) .map(results -&gt; { boolean allowed = results.get(0) == 1L; Long tokensLeft = results.get(1); Response response = new Response(allowed, getHeaders(config, tokensLeft)); if (log.isDebugEnabled()) { log.debug("response: " + response); } return response; }); } catch (Exception e) { /* * We don't want a hard dependency on Redis to allow traffic. Make sure to set * an alert so you know if this is happening too much. Stripe's observed * failure rate is 0.01%. */ log.error("Error determining if user allowed from redis", e); } return Mono.just(new Response(true, getHeaders(config, -1L))); } private LimitConfig getLimitConfig(String routeId) { Map&lt;String, LimitConfig&gt; map = new HashMap&lt;&gt;(); LimitConfig limitConfig = new LimitConfig(); limitConfig.setRouteId("rateLimit_route"); Map&lt;String, Config&gt; tokenMap = new HashMap&lt;&gt;(); Config apiConfig = new Config(); apiConfig.setBurstCapacity(5); apiConfig.setReplenishRate(5);  Config bizConfig = new Config(); bizConfig.setBurstCapacity(1); bizConfig.setReplenishRate(1);  tokenMap.put("/hello/rateLimit", apiConfig); tokenMap.put("jieyin", bizConfig); limitConfig.setTokenConfig(tokenMap); map.put("rateLimit_route", limitConfig); return limitConfig; }</pre><p>å¦‚ä¸Šçš„ä»£ç æ˜¯å†™æ­»çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ ¹æ®æˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚è®¾è®¡ä¸€ä¸ªè‡ªå®šä¹‰keyï¼Œè‡ªå®šä¹‰ä»¤ç‰Œæ¡¶å®¹é‡å’Œé€Ÿç‡çš„é™æµè§„åˆ™ã€‚</p><p>beané…ç½®å’Œymlé…ç½®å¦‚ä¸‹</p><pre> @Bean @Primary public CustomRedisRateLimiter customRedisRateLimiter(ReactiveRedisTemplate&lt;String, String&gt; redisTemplate, @Qualifier(RedisRateLimiter.REDIS_SCRIPT_NAME) RedisScript&lt;List&lt;Long&gt;&gt; redisScript, Validator validator) { return new CustomRedisRateLimiter(redisTemplate, redisScript, validator); }  @Bean public RateLimiterGatewayFilterFactory rateLimiterGatewayFilterFactory(CustomRedisRateLimiter customRedisRateLimiter, CustomKeyResolver customKeyResolver) { return new RateLimiterGatewayFilterFactory(customRedisRateLimiter, customKeyResolver); }</pre><p>å¦‚æœæƒ³å­¦ä¹ Javaå·¥ç¨‹åŒ–ã€é«˜æ€§èƒ½åŠåˆ†å¸ƒå¼ã€æ·±å…¥æµ…å‡ºã€‚å¾®æœåŠ¡ã€Springï¼ŒMyBatisï¼ŒNettyæºç åˆ†æçš„æœ‹å‹å¯ä»¥åŠ æˆ‘çš„Javaé«˜çº§äº¤æµï¼š854630135ï¼Œç¾¤é‡Œæœ‰é˜¿é‡Œå¤§ç‰›ç›´æ’­è®²è§£æŠ€æœ¯ï¼Œä»¥åŠJavaå¤§å‹äº’è”ç½‘æŠ€æœ¯çš„è§†é¢‘å…è´¹åˆ†äº«ç»™å¤§å®¶ã€‚</p><pre>server.port: 8082spring: application: name: gateway redis: host: localhost port: 6379 password: 123456 cloud: gateway: routes: - id: rateLimit_route uri: http://localhost:8000 order: 0 predicates: - Path=/foo/** filters: - StripPrefix=1 - name: RateLimiter</pre><h1><strong>ç†”æ–­</strong></h1><p>å½“ä¸‹æ¸¸æ¥å£è´Ÿè½½å¾ˆå¤§ï¼Œæˆ–è€…æ¥å£ä¸é€šç­‰å…¶ä»–åŸå› å¯¼è‡´è¶…æ—¶ï¼Œå¦‚æœæ¥å£ä¸ç†”æ–­çš„è¯å°†ä¼šå½±å“åˆ°ä¸‹æ¸¸æ¥å£å¾—ä¸åˆ°å–˜æ¯ï¼Œç½‘å…³ä¹Ÿä¼šå› ä¸ºè¶…æ—¶è¿æ¥ä¸€ç›´æŒ‚èµ·ï¼Œå¾ˆå¯èƒ½å› ä¸ºä¸€ä¸ªå­ç³»ç»Ÿçš„é—®é¢˜å¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„é›ªå´©ã€‚æ‰€ä»¥æˆ‘ä»¬çš„ç½‘å…³éœ€è¦è®¾è®¡ç†”æ–­ï¼Œå½“å› ä¸ºç†”æ–­å™¨æ‰“å¼€æ—¶ï¼Œç½‘å…³å°†è¿”å›ä¸€ä¸ªé™çº§çš„åº”ç­”ã€‚</p><p>ç†”æ–­é…ç½®å¦‚ä¸‹ï¼š</p><pre>server.port: 8082spring: application: name: gateway redis: host: localhost port: 6379 password: 123456 cloud: gateway: routes: - id: rateLimit_route uri: http://localhost:8000 order: 0 predicates: - Path=/foo/** filters: - StripPrefix=1 - name: RateLimiter - name: Hystrix args: name: fallbackcmd fallbackUri: forward:/fallback</pre><p>hystrix.command.fallbackcmd.execution.isolation.thread.timeoutInMilliseconds: 5000</p><pre>package org.gateway.controller;import org.gateway.response.Response;import org.springframework.web.bind.annotation.GetMapping;import org.springframework.web.bind.annotation.RestController;@RestControllerpublic class FallbackController { @GetMapping("/fallback") public Response fallback() { Response response = new Response(); response.setCode("100"); response.setMessage("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨"); return response; }}</pre><p>æ³¨æ„éœ€è¦è®¾ç½®commandKeyçš„è¶…æ—¶æ—¶é—´ã€‚å…¶ä»–çš„hystrixé…ç½®è¯·è®¿é—®Hystrix wiki.</p><h1><strong>åŠ¨æ€é…ç½®è·¯ç”±å’Œè¿‡æ»¤å™¨</strong></h1><p>æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•åŠ¨æ€é…ç½®è·¯ç”±å’Œè¿‡æ»¤å™¨ã€‚</p><p>å®šä¹‰è·¯ç”±å®ä½“</p><pre>/** * Gatewayçš„è·¯ç”±å®šä¹‰æ¨¡å‹ */public class GatewayRouteDefinition { /** * è·¯ç”±çš„Id */ private String id; /** * è·¯ç”±æ–­è¨€é›†åˆé…ç½® */ private List&lt;GatewayPredicateDefinition&gt; predicates = new ArrayList&lt;&gt;(); /** * è·¯ç”±è¿‡æ»¤å™¨é›†åˆé…ç½® */ private List&lt;GatewayFilterDefinition&gt; filters = new ArrayList&lt;&gt;(); /** * è·¯ç”±è§„åˆ™è½¬å‘çš„ç›®æ ‡uri */ private String uri; /** * è·¯ç”±æ‰§è¡Œçš„é¡ºåº */ private int order = 0;}</pre><p>è·¯ç”±æ–­è¨€å®ä½“</p><p>å¦‚æœæƒ³å­¦ä¹ Javaå·¥ç¨‹åŒ–ã€é«˜æ€§èƒ½åŠåˆ†å¸ƒå¼ã€æ·±å…¥æµ…å‡ºã€‚å¾®æœåŠ¡ã€Springï¼ŒMyBatisï¼ŒNettyæºç åˆ†æçš„æœ‹å‹å¯ä»¥åŠ æˆ‘çš„Javaé«˜çº§äº¤æµï¼š854630135ï¼Œç¾¤é‡Œæœ‰é˜¿é‡Œå¤§ç‰›ç›´æ’­è®²è§£æŠ€æœ¯ï¼Œä»¥åŠJavaå¤§å‹äº’è”ç½‘æŠ€æœ¯çš„è§†é¢‘å…è´¹åˆ†äº«ç»™å¤§å®¶ã€‚</p><pre>/** * è·¯ç”±æ–­è¨€å®šä¹‰æ¨¡å‹ */public class GatewayPredicateDefinition { /** * æ–­è¨€å¯¹åº”çš„Name */ private String name; /** * é…ç½®çš„æ–­è¨€è§„åˆ™ */ private Map&lt;String, String&gt; args = new LinkedHashMap&lt;&gt;();}</pre><p>è¿‡æ»¤å™¨å®ä½“</p><pre>/** * è¿‡æ»¤å™¨å®šä¹‰æ¨¡å‹ */public class GatewayFilterDefinition { /** * Filter Name */ private String name; /** * å¯¹åº”çš„è·¯ç”±è§„åˆ™ */ private Map&lt;String, String&gt; args = new LinkedHashMap&lt;&gt;();}</pre><p>è·¯ç”±å¢åˆ æ”¹controller</p><pre>package org.gateway.controller;import java.net.URI;import java.util.ArrayList;import java.util.Arrays;import java.util.HashMap;import java.util.List;import java.util.Map;import org.gateway.model.GatewayFilterDefinition;import org.gateway.model.GatewayPredicateDefinition;import org.gateway.model.GatewayRouteDefinition;import org.gateway.route.DynamicRouteServiceImpl;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.cloud.gateway.filter.FilterDefinition;import org.springframework.cloud.gateway.handler.predicate.PredicateDefinition;import org.springframework.cloud.gateway.route.RouteDefinition;import org.springframework.util.CollectionUtils;import org.springframework.web.bind.annotation.GetMapping;import org.springframework.web.bind.annotation.PathVariable;import org.springframework.web.bind.annotation.PostMapping;import org.springframework.web.bind.annotation.RequestBody;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;import org.springframework.web.util.UriComponentsBuilder;@RestController@RequestMapping("/route")public class RouteController { @Autowired private DynamicRouteServiceImpl dynamicRouteService; /** * å¢åŠ è·¯ç”± * @param gwdefinition * @return */ @PostMapping("/add") public String add(@RequestBody GatewayRouteDefinition gwdefinition) { try { RouteDefinition definition = assembleRouteDefinition(gwdefinition); return this.dynamicRouteService.add(definition); } catch (Exception e) { e.printStackTrace(); } return "succss"; } @GetMapping("/delete/{id}") public String delete(@PathVariable String id) { return this.dynamicRouteService.delete(id); } @PostMapping("/update") public String update(@RequestBody GatewayRouteDefinition gwdefinition) { RouteDefinition definition = assembleRouteDefinition(gwdefinition); return this.dynamicRouteService.update(definition); } private RouteDefinition assembleRouteDefinition(GatewayRouteDefinition gwdefinition) { RouteDefinition definition = new RouteDefinition(); List&lt;PredicateDefinition&gt; pdList=new ArrayList&lt;&gt;(); definition.setId(gwdefinition.getId()); List&lt;GatewayPredicateDefinition&gt; gatewayPredicateDefinitionList=gwdefinition.getPredicates(); for (GatewayPredicateDefinition gpDefinition: gatewayPredicateDefinitionList) { PredicateDefinition predicate = new PredicateDefinition(); predicate.setArgs(gpDefinition.getArgs()); predicate.setName(gpDefinition.getName()); pdList.add(predicate); }  List&lt;GatewayFilterDefinition&gt; gatewayFilterDefinitions = gwdefinition.getFilters(); List&lt;FilterDefinition&gt; filterList = new ArrayList&lt;&gt;(); if (!CollectionUtils.isEmpty(gatewayFilterDefinitions)) { for (GatewayFilterDefinition gatewayFilterDefinition : gatewayFilterDefinitions) { FilterDefinition filterDefinition = new FilterDefinition(); filterDefinition.setName(gatewayFilterDefinition.getName()); filterDefinition.setArgs(gatewayFilterDefinition.getArgs()); filterList.add(filterDefinition); } } definition.setPredicates(pdList); definition.setFilters(filterList); URI uri = UriComponentsBuilder.fromHttpUrl(gwdefinition.getUri()).build().toUri(); definition.setUri(uri); return definition; }}</pre><p>åŠ¨æ€è·¯ç”±service</p><pre>package org.gateway.route;import java.net.URI;import java.util.Arrays;import java.util.HashMap;import java.util.Map;import org.gateway.model.GatewayPredicateDefinition;import org.gateway.model.GatewayRouteDefinition;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.cloud.gateway.event.RefreshRoutesEvent;import org.springframework.cloud.gateway.handler.predicate.PredicateDefinition;import org.springframework.cloud.gateway.route.RouteDefinition;import org.springframework.cloud.gateway.route.RouteDefinitionWriter;import org.springframework.context.ApplicationEventPublisher;import org.springframework.context.ApplicationEventPublisherAware;import org.springframework.stereotype.Service;import org.springframework.web.util.UriComponentsBuilder;import com.alibaba.fastjson.JSON;import reactor.core.publisher.Mono;@Servicepublic class DynamicRouteServiceImpl implements ApplicationEventPublisherAware { @Autowired private RouteDefinitionWriter routeDefinitionWriter; private ApplicationEventPublisher publisher; /** * å¢åŠ è·¯ç”± * @param definition * @return */ public String add(RouteDefinition definition) { routeDefinitionWriter.save(Mono.just(definition)).subscribe(); this.publisher.publishEvent(new RefreshRoutesEvent(this)); return "success"; } /** * æ›´æ–°è·¯ç”± * @param definition * @return */ public String update(RouteDefinition definition) { try { this.routeDefinitionWriter.delete(Mono.just(definition.getId())); } catch (Exception e) { return "update fail,not find route routeId: "+definition.getId(); } try { routeDefinitionWriter.save(Mono.just(definition)).subscribe(); this.publisher.publishEvent(new RefreshRoutesEvent(this)); return "success"; } catch (Exception e) { return "update route fail"; } } /** * åˆ é™¤è·¯ç”± * @param id * @return */ public String delete(String id) { try { this.routeDefinitionWriter.delete(Mono.just(id)); return "delete success"; } catch (Exception e) { e.printStackTrace(); return "delete fail"; } } @Override public void setApplicationEventPublisher(ApplicationEventPublisher applicationEventPublisher) { this.publisher = applicationEventPublisher; }}</pre><pre> ä¸Šé¢ routeDefinitionWriterçš„å®ç°é»˜è®¤æ˜¯InMemoryRouteDefinitionRepositoryï¼Œå°†è·¯ç”±å­˜åœ¨å†…å­˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªå°†è·¯ç”±å­˜åœ¨redisä¸­çš„repositoryã€‚this.publisher.publishEvent(new RefreshRoutesEvent(this));åˆ™ä¼šå°†CachingRouteLocatorä¸­çš„è·¯ç”±ç¼“å­˜æ¸…ç©ºã€‚ä»¥ä¸Šåªæ˜¯springcloud gatewayæ”¯æŒçš„ä¸€å°éƒ¨åˆ†åŠŸèƒ½ã€‚</pre><p>å¦‚æœæƒ³å­¦ä¹ Javaå·¥ç¨‹åŒ–ã€é«˜æ€§èƒ½åŠåˆ†å¸ƒå¼ã€æ·±å…¥æµ…å‡ºã€‚å¾®æœåŠ¡ã€Springï¼ŒMyBatisï¼ŒNettyæºç åˆ†æçš„æœ‹å‹å¯ä»¥åŠ æˆ‘çš„Javaé«˜çº§äº¤æµï¼š854630135ï¼Œç¾¤é‡Œæœ‰é˜¿é‡Œå¤§ç‰›ç›´æ’­è®²è§£æŠ€æœ¯ï¼Œä»¥åŠJavaå¤§å‹äº’è”ç½‘æŠ€æœ¯çš„è§†é¢‘å…è´¹åˆ†äº«ç»™å¤§å®¶ã€‚</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'é™æµ','springcloud','gateway'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>