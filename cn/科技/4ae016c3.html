<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ | 极客快訊</title><meta property="og:title" content="为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/6b631728e9ef44db999639d7b09c1f30"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4ae016c3.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4ae016c3.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4ae016c3.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4ae016c3.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4ae016c3.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4ae016c3.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4ae016c3.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4ae016c3.html><meta property="article:published_time" content="2020-11-14T21:01:58+08:00"><meta property="article:modified_time" content="2020-11-14T21:01:58+08:00"><meta name=Keywords content><meta name=description content="为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/4ae016c3.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><blockquote class=pgc-blockquote-abstract><p>摘自 李猛 51CTO技术栈</p></blockquote><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6b631728e9ef44db999639d7b09c1f30><p class=pgc-img-caption></p></div><p><br></p><p>本文涉及到 MongoDB 与 Elasticsearch 两大阵营，可能会引起口水之争，仅代表个人经验之谈，非阵营之说。</p><p>我将围绕如下两个话题展开：</p><p>· <strong>为什么要从 MongoDB 迁移到 Elasticsearch？</strong></p><p>· <strong>如何从 MongoDB 迁移到 Elasticsearch？</strong></p><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3f97f2154a464dbe8ab186f4e5fe2b5e><p class=pgc-img-caption></p></div><p>MongoDB 与 Elasticsearch 热度排名</p><p><br></p><p>现状背景</p><p><br></p><p>MongoDB 本身定位与关系型数据库竞争，但工作中几乎没有见到哪个项目会将核心业务系统的数据放在上面，依然选择传统的关系型数据库。</p><p><strong>项目背景</strong></p><p><br></p><p>公司所在物流速运行业，业务系统复杂且庞大，用户操作者很多，每日有大量业务数据产生，同时业务数据会有很多次流转状态变化。</p><p><br></p><p>为了便于记录追踪分析，系统操作日志记录项目应运而生，考虑到原有的日均数据量，操作日志数据基于 MongoDB 存储。</p><p><br></p><p>操作日志记录系统需要记录两种数据，如下说明：</p><p><br></p><p>①变更主数据，什么人在什么时间在系统哪个模块做了什么操作，数据编号是什么，操作跟踪编号是什么。</p><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/237c5223fdb6479a86cd766da816f230><p class=pgc-img-caption></p></div><p><br></p><p><strong>②变更从数据，</strong>实际变更数据的变化前后，此类数据条数很多，一行数据多个字段变更就记录多条。</p><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/82502d0686d64cf7847e016317e2fa2e><p class=pgc-img-caption></p></div><p><br></p><p><strong>项目架构</strong></p><p>项目架构描述如下：</p><p>· 业务系统新增或者编辑数据，产生操作日志记录发送到 Kafka 集群，基于 dataid 字段作为 key。</p><p>· 新增或编辑数据实际存储到 MySQL 数据库。</p><p>· Canal 集群订阅 MySQL 集群，按照业务系统模块配置监控的数据库与表。</p><p>· Canal 将监控到的变更业务数据发送到 Kafka 集群，基于 dataid 字段作为 key。</p><p>· 操作日志系统从 Kafka 获取主记录数据与从记录数据。</p><p>· 操作日志系统写入数据到 MongoDB，同时需要反查询。</p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2603419c68bf40b08538e031a5dd569e><p class=pgc-img-caption></p></div><p>操作日志记录业务流程说明</p><p><br></p><p><strong>MongoDB 架构</strong></p><p>集群架构说明：</p><p>· 服务器配置 8c/32gb/500gb ssd。</p><p>· Router 路由服务器部署了 3 个节点。</p><p>· Config 配置服务器部署了 3 个节点。</p><p>· Shard 分片服务器部署了 9 个节点。</p><p>· 主操作记录设计 3 个分片。</p><p>· 从操作记录设计 3 个分片。</p><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8a5067dce2b0469390e67a6a99ec7ff0><p class=pgc-img-caption></p></div><p><strong>问题说明：</strong>MongoDB 的信徒们可能怀疑我们没有使用好，或者我们的运维能力欠缺，或者认为我们有 Elasticsearch 的高手在。不是这样的，弃用 MongoDB 选择 Elasticsearch 其实并非技术偏见问题，而是我们的实际场景需求，原因如下：</p><p><br></p><p><strong>①搜索查询</strong></p><p><br></p><p>项目背景：</p><p>· MongoDB 内部采用 B-Tree 作为索引结构，此索引基于最左优先原则，且必须保证查询顺序与索引字段的顺序一致才有效，这个即是优点，但在现在复杂业务场景也是致命的。</p><p>· 业务系统查询操作日志记录会有很多过滤条件，且查询条件是任意组合的，现有 MongoDB 是不支持的，或者说所有关系型数据库都不支持，如果要支持，得创建好多组合的 B+ 数索引，想法很不理智。</p><p>· 同时主记录与从记录中有很多字符类的数据，这些数据查询即要支持精确查询，也要支持全文检索，这几个方面 MongoDB 功能很单一，性能也很糟糕，业务系统查询时经常超时，反倒是 Elasticsearch 非常合适。</p><p><br></p><p><strong>②技术栈成熟度</strong></p><p><br></p><p>项目背景：</p><p>· 分片与副本实现问题，MongoDB 集合数据在设计时是需要绑定到具体的机器实例的，哪些分片分布在哪些节点上，哪些副本分布在哪些节点上。</p><p>这些都需要在配置集群时就要绑定死，跟传统的关系型数据库做分库分表本质上没有什么两样，其实现在很多数据产品的集群还是这种模式偏多，比如 Redis-cluster，ClickHouse 等。</p><p>而 Elasticsearch 的集群与分片和副本没有直接的绑定关系，可以任意的平衡调整，且节点的性能配置也可以很容易差异化。</p><p>· 操作日志数据量增加很快，单日写入超过千万条，不用多久，运维人员就需要对服务器进行扩容，且相对 Elasticsearch 复杂很多。</p><p>· MongoDB 单集合数据量超过 10 亿条，此情况下即使简单条件查询性能也不理想，不如 Elasticsearch 倒排索引快。</p><p>· 公司对于 ES 与 MongoDB 技术栈的经验积累不同，Elasticsearch 在很多项目中运用，非常核心的项目也是大量运用。</p><p>对于其技术与运维经验更丰富，而 MongoDB 如果除去核心业务场景，几乎找不到合适的切入口，实际没有人敢在核心项目中使用 MongoDB，这就很尴尬。</p><p><br></p><p><strong>③文档格式相同</strong></p><p><br></p><p>MongoDB 与 Elasticsearch 都属于文档型数据库，Bson 类同与 Json，_objectid与_id 原理一样，所以主数据与从数据迁移到 Elasticsearch 平台，数据模型几乎无需变化。</p><p><br></p><p>迁移方案</p><p><br></p><p>异构数据系统迁移，主要围绕这两大块内容展开：</p><p>· 上层应用系统迁移，原来是针对 MongoDB 的语法规则，现在要修改为面向 Elasticsearch 语法规则。</p><p>· 下层 MongoDB 数据迁移到 Elasticsearch。</p><p><br></p><p><strong>①Elastic 容量评估</strong></p><p><br></p><p>原有 MongoDB 集群采用了 15 台服务器，其中 9 台是数据服务器，迁移到 Elastic 集群需要多少台服务器？</p><p><br></p><p>我们采取简单推算办法，如假设生产环境上某个 MongoDB 集合的数据有 10 亿条数据，我们先在测试环境上从 MongoDB 到 ES 上同步 100 万条数据。</p><p><br></p><p>假设这 100 万条数据占用磁盘 10G，那生产上环境上需要 1 个 T 磁盘空间，然后根据业务预期增加量扩展一定冗余。</p><p><br></p><p>根据初步评估，Elastic 集群设置 3 台服务器， 配置 8c/16g 内存/2T 机械磁盘。服务器数量一下从 15 台缩减到 3 台，且配置也降低不少。</p><p><br></p><p><strong>②Elastic 索引规则</strong></p><p><br></p><p>系统操作日志是时序性数据，写完整后基本上无需再次修改。操作日志记录查询主要是当月的居多，后续的历史性数据查询频率很低，根据评估，核心数据索引按月创建生成，业务查询时候必须带上操作时间范围，后端根据时间反推需要查询哪些索引。</p><p><br></p><p>Elastic-Api 支持多索引匹配查询，完美利用 Elastic 的特性解决跨多个月份的查询合并。对于非核心数据索引，按年创建索引生成足以。</p><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f817308776884c84ac2ae4a11c8332cb><p class=pgc-img-caption></p></div><p>Elastic 操作日志索引创建规则<strong>③核心实现逻辑设计</strong></p><p><br></p><p>Elasticsearch 不是关系型数据库，不具备事务的机制。</p><p><br></p><p>操作日志系统的数据来源都是 Kafka，消费数据是有顺序机制的，有 2 种场景特别注意，如下：</p><p>· 主数据先到操作日志系统，从数据后到，从数据写的时候先拼凑主数据记录和 Binlog 字段数据。</p><p>· 从数据先到操作日志系统，主数据后到，主数据更新从索引的相关的索引字段。</p><p><br></p><p>Elasticsearch 索引数据更新是近实时的刷新机制，数据提交后不能马上通过 Search-Api 查询到，主记录的数据如何更新到从记录呢？而且业务部门不规范的使用，多条主记录的 dataId 和 tracId 可能一样。</p><p><br></p><p>由于主数据与从数据关联字段是 dataId 和 traceId。如果主数据与从数据在同时达到操作日志系统，基于 update_by_query 命令肯定失效不 准确，主从数据也可能是多对多的关联关系，dataId 和 traceId 不能唯一决定一条记录。</p><p><br></p><p>Elasticsearch 其实也是一个 NoSQL 数据库，可以做 key-value 缓存。</p><p><br></p><p>这时新建一个 Elastic 索引作为中间缓存， 原则是主数据与从数据谁先到缓存谁，索引的 _id=（dataId+traceId）。</p><p><br></p><p>通过这个中间索引可以找到主数据记录的 Id 或者从记录 Id， 索引数据模型多如下，detailId 为从索引的 _id 的数组记录。</p><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5f34ed3910da4ab38fd1d8ed54d18445><p class=pgc-img-caption></p></div><p>前面我们讲过主记录和从记录都是一个 Kafka 的分区上，我们拉一批数据的时候，操作 ES 用的用到的核心 API：</p><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/bec89d24a0944737a79b178bd63deb04><p class=pgc-img-caption></p></div><p>迁移过程</p><p><strong>①数据迁移</strong></p><p><br></p><p>选择 DataX 作为数据同步工具由以下几个因素：</p><p>· <strong>历史型数据。</strong>操作日志记录数据属于历史性的数据，记录产生之后几乎无需二次修改，等同于离线数据。</p><p>· <strong>非持续性迁移。</strong>项目全部完工之后，原有的 MongoDB 集群会全部销毁，不会有二次迁移需求。</p><p>· <strong>数据量问题。</strong>原有 MongoDB 操作日志数据量有几十亿条，迁移过程不能太快也不能太慢，速度太快，MongoDB 集群会出现性能问题，速度太慢，项目周期太长，增加运维的成本与复杂度。否则可以选择 Hadoop 作为中转平台的迁移。</p><p>· <strong>DataX 源码特定场景改造。</strong>如日期类型的转换、索引主键 _id 的生成、索引主键 _id 映射，支持重复同步。</p><p>· <strong>多实例多线程并行。</strong>主数据同步部署多个实例，从数据同步也部署多个实例，单实例中配置多个 Channel。</p><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/55bd9d323d8d44b9b644ed3d57eb52a7><p class=pgc-img-caption></p></div><p>DataX 同步数据示意图</p><p><br></p><p><strong>②迁移索引设置</strong></p><p><br></p><p>临时修改索引的一些设置，当数据同步完之后再修改回来，如下：</p><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/290abd60b32d47eab73f75d9c4625693><p class=pgc-img-caption></p></div><p><strong>③应用迁移</strong></p><p>操作日志项目采用 Spring Boot 构建，增加了自定义配置项，如下：</p><p><br></p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/aeec457539ed47208f071e93110a5a35><p class=pgc-img-caption></p></div><p><br></p><p>项目改造说明：</p><p>· 第一次上线的时候，先将 2 个写入标识设置为 true，双写 MongoDB 和 ES。</p><p>· 对于读，提供 2 个不同接口，前端自由的切换。</p><p>· 等数据迁移完，没有差异的时候，重新更改 flag 的值。</p><div class=pgc-img><img alt=为什么要从MongoDB迁移到ElasticSearch？这篇告诉你原委！ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6133d3fcc5864e1cbbb6578b749e75ef><p class=pgc-img-caption></p></div><p>应用平衡迁移</p><p><br></p><p>结语</p><p><strong>①迁移效果</strong></p><p><br></p><p>弃用 MongoDB 使用 ElasticSearch 作为存储数据库，服务器从原来的 15 台 MongoDB，变成了 3 台 ElasticSearch，每月为公司节约了一大笔费用。</p><p><br></p><p>同时查询性能提高了 10 倍以上，而且更好的支持了各种查询，得到了业务部门的使用者，运维团队和领导的一致赞赏。<strong>②经验总结</strong></p><p><br></p><p>整个项目前后历经几个月，多位同事参与，设计、研发，数据迁移、测试、数据验证、压测等各个环节。</p><p><br></p><p>技术方案不是一步到位，中间也踩了很多坑，最终上线了。ES 的技术优秀特点很多，灵活的使用，才能发挥最大的威力。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'什么','MongoDB','迁移'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>