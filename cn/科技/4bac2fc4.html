<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>è¿™4ç§ThreadLocalä½ éƒ½çŸ¥é“å—ï¼Ÿ | æå®¢å¿«è¨Š</title><meta property="og:title" content="è¿™4ç§ThreadLocalä½ éƒ½çŸ¥é“å—ï¼Ÿ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/02621283c0574fd79fbb6ff5ea971384"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4bac2fc4.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4bac2fc4.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4bac2fc4.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4bac2fc4.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4bac2fc4.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4bac2fc4.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4bac2fc4.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4bac2fc4.html><meta property="article:published_time" content="2020-11-14T21:07:43+08:00"><meta property="article:modified_time" content="2020-11-14T21:07:43+08:00"><meta name=Keywords content><meta name=description content="è¿™4ç§ThreadLocalä½ éƒ½çŸ¥é“å—ï¼Ÿ"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/4bac2fc4.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>è¿™4ç§ThreadLocalä½ éƒ½çŸ¥é“å—ï¼Ÿ</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right><strong>ä»€ä¹ˆæ˜¯ThreadLocal</strong></h1><p>ThreadLocal ç±»é¡¾åæ€ä¹‰å¯ä»¥ç†è§£ä¸ºçº¿ç¨‹æœ¬åœ°å˜é‡ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœå®šä¹‰äº†ä¸€ä¸ª ThreadLocal ï¼Œ æ¯ä¸ªçº¿ç¨‹å¾€è¿™ä¸ª ThreadLocal ä¸­è¯»å†™æ˜¯çº¿ç¨‹éš”ç¦»ï¼Œäº’ç›¸ä¹‹é—´ä¸ä¼šå½±å“çš„ã€‚å®ƒæä¾›äº†ä¸€ç§å°†å¯å˜æ•°æ®é€šè¿‡æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ç‹¬ç«‹å‰¯æœ¬ä»è€Œå®ç°çº¿ç¨‹å°é—­çš„æœºåˆ¶ã€‚</p><h1 class=pgc-h-arrow-right><strong>å®é™…åº”ç”¨</strong></h1><p>å®é™…å¼€å‘ä¸­æˆ‘ä»¬çœŸæ­£ä½¿ç”¨ ThreadLocal çš„åœºæ™¯è¿˜æ˜¯æ¯”è¾ƒå°‘çš„ï¼Œå¤§å¤šæ•°ä½¿ç”¨éƒ½æ˜¯åœ¨æ¡†æ¶é‡Œé¢ã€‚æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯çš„è¯å°±æ˜¯ç”¨å®ƒæ¥è§£å†³æ•°æ®åº“è¿æ¥ã€ Session ç®¡ç†ç­‰ä¿è¯æ¯ä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„æ•°æ®åº“è¿æ¥æ˜¯åŒä¸€ä¸ªã€‚è¿˜æœ‰ä¸€ä¸ªç”¨çš„æ¯”è¾ƒå¤šçš„åœºæ™¯å°±æ˜¯ç”¨æ¥è§£å†³ SimpleDateFormat è§£å†³çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ï¼Œä¸è¿‡ç°åœ¨ java8 æä¾›äº† DateTimeFormatter å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ã€‚è¿˜å¯ä»¥åˆ©ç”¨å®ƒè¿›è¡Œä¼˜é›…çš„ä¼ é€’å‚æ•°ï¼Œä¼ é€’å‚æ•°çš„æ—¶å€™ï¼Œå¦‚æœçˆ¶çº¿ç¨‹ç”Ÿæˆçš„å˜é‡æˆ–è€…å‚æ•°ç›´æ¥é€šè¿‡ ThreadLocal ä¼ é€’åˆ°å­çº¿ç¨‹å‚æ•°å°±ä¼šä¸¢å¤±ï¼Œè¿™ä¸ªåé¢ä¼šä»‹ç»ä¸€ä¸ªå…¶ä»–çš„ ThreadLocal æ¥ä¸“é—¨è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚</p><h1 class=pgc-h-arrow-right><strong>ThreadLocal apiä»‹ç»</strong></h1><p>ThreadLocalçš„APIè¿˜æ˜¯æ¯”è¾ƒå°‘çš„å°±å‡ ä¸ªapi</p><div class=pgc-img><img alt=è¿™4ç§ThreadLocalä½ éƒ½çŸ¥é“å—ï¼Ÿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/02621283c0574fd79fbb6ff5ea971384><p class=pgc-img-caption></p></div><p>æˆ‘ä»¬çœ‹ä¸‹è¿™å‡ ä¸ª api çš„ä½¿ç”¨ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿè¶…çº§ç®€å•</p><pre><code>    private static ThreadLocal&lt;String&gt; threadLocal = ThreadLocal.withInitial(()-&gt;"javaé‡‘è");    public static void main(String[] args) {        System.out.println("è·å–åˆå§‹å€¼ï¼š"+threadLocal.get());        threadLocal.set("å…³æ³¨ï¼šã€javaé‡‘èã€‘");        System.out.println("è·å–ä¿®æ”¹åçš„å€¼ï¼š"+threadLocal.get());        threadLocal.remove();    }</code></pre><p>è¾“å‡ºç»“æœï¼š</p><pre><code>è·å–åˆå§‹å€¼ï¼šjavaé‡‘èè·å–ä¿®æ”¹åçš„å€¼ï¼šå…³æ³¨ï¼šã€javaé‡‘èã€‘</code></pre><p>æ˜¯ä¸æ˜¯ç‚’é¸¡ç®€å•ï¼Œå°±å‡ è¡Œä»£ç å°±æŠŠæ‰€æœ‰ api éƒ½è¦†ç›–äº†ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥ç®€å•çœ‹çœ‹è¿™å‡ ä¸ª api çš„æºç å§ã€‚</p><p>æˆå‘˜å˜é‡</p><pre><code>        /**åˆå§‹å®¹é‡ï¼Œå¿…é¡»ä¸º2çš„å¹‚         * The initial capacity -- MUST be a power of two.         */        private static final int INITIAL_CAPACITY = 16;        /** Entryè¡¨ï¼Œå¤§å°å¿…é¡»ä¸º2çš„å¹‚         * The table, resized as necessary.         * table.length MUST always be a power of two.         */        private Entry[] table;        /**         * The number of entries in the table.         */        private int size = 0;        /**         * The next size value at which to resize.         */        private int threshold; // Default to 0</code></pre><p>è¿™é‡Œä¼šæœ‰ä¸€ä¸ªé¢è¯•ç»å¸¸é—®åˆ°çš„é—®é¢˜:ä¸ºä»€ä¹ˆ entry æ•°ç»„çš„å¤§å°ï¼Œä»¥åŠåˆå§‹å®¹é‡éƒ½å¿…é¡»æ˜¯ 2 çš„å¹‚ï¼Ÿå¯¹äº firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1); ä»¥åŠå¾ˆå¤šæºç é‡Œé¢éƒ½æ˜¯ä½¿ç”¨ hashCode &ï¼ˆ-1ï¼‰ æ¥ä»£æ›¿hashCode%ã€‚è¿™ç§å†™æ³•å¥½å¤„å¦‚ä¸‹ï¼š</p><ul><li>ä½¿ç”¨ä½è¿ç®—æ›¿ä»£å–æ¨¡ï¼Œæå‡è®¡ç®—æ•ˆç‡ã€‚</li><li>ä¸ºäº†ä½¿ä¸åŒ hash å€¼å‘ç”Ÿç¢°æ’çš„æ¦‚ç‡æ›´å°ï¼Œå°½å¯èƒ½ä¿ƒä½¿å…ƒç´ åœ¨å“ˆå¸Œè¡¨ä¸­å‡åŒ€åœ°æ•£åˆ—ã€‚</li></ul><p>setæ–¹æ³•</p><pre><code>   public void set(T value) {        Thread t = Thread.currentThread();        ThreadLocalMap map = getMap(t);        if (map != null)            map.set(this, value);        else            createMap(t, value);    }</code></pre><p>set æ–¹æ³•è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæˆ‘ä»¬å¯ä»¥é‡ç‚¹çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•é‡Œé¢çš„ThreadLocalMapï¼Œå®ƒæ—¢ç„¶æ˜¯ä¸ªmapï¼ˆæ³¨æ„ä¸è¦ä¸ java.util.map æ··ä¸ºä¸€è°ˆï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯æ¦‚å¿µä¸Šçš„ map ï¼‰ï¼Œè‚¯å®šæ˜¯æœ‰è‡ªå·±çš„keyå’Œvalueç»„æˆï¼Œæˆ‘ä»¬æ ¹æ®æºç å¯ä»¥çœ‹å‡ºå®ƒçš„ key æ˜¯å…¶å®å¯ä»¥æŠŠå®ƒç®€å•çœ‹æˆæ˜¯ ThreadLocal ï¼Œä½†æ˜¯å®é™…ä¸ŠThreadLocalä¸­å­˜æ”¾çš„æ˜¯ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œè€Œå®ƒçš„ value çš„è¯æ˜¯æˆ‘ä»¬å®é™… set çš„å€¼</p><pre><code>   static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; {            /** The value associated with this ThreadLocal. */            Object value; // å®é™…å­˜æ”¾çš„å€¼            Entry(ThreadLocal&lt;?&gt; k, Object v) {                super(k);                value = v;            }        }</code></pre><p>Entry å°±æ˜¯æ˜¯ ThreadLocalMap é‡Œå®šä¹‰çš„èŠ‚ç‚¹ï¼Œå®ƒç»§æ‰¿äº† WeakReference ç±»ï¼Œå®šä¹‰äº†ä¸€ä¸ªç±»å‹ä¸º Object çš„ value ï¼Œç”¨äºå­˜æ”¾å¡åˆ° ThreadLocal é‡Œçš„å€¼ã€‚æˆ‘ä»¬å†æ¥çœ‹ä¸‹è¿™ä¸ª ThreadLocalMapæ˜¯ä½äºå“ªé‡Œçš„ï¼Ÿæˆ‘ä»¬çœ‹åˆ° ThreadLocalMap æ˜¯ä½äº Thread é‡Œé¢çš„ä¸€ä¸ªå˜é‡ï¼Œè€Œæˆ‘ä»¬çš„å€¼åˆæ˜¯æ”¾åœ¨ ThreadLocalMap ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬å°±å®ç°äº†æ¯ä¸ªçº¿ç¨‹é—´çš„éš”ç¦»ã€‚ä¸‹é¢ä¸¤å¼ å›¾çš„åŸºæœ¬å°±æŠŠ ThreadLocal çš„ç»“æ„ç»™ä»‹ç»æ¸…æ¥šäº†ã€‚</p><div class=pgc-img><img alt=è¿™4ç§ThreadLocalä½ éƒ½çŸ¥é“å—ï¼Ÿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4ec9cdd3dfe249de8bcac91d464c5c03><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=è¿™4ç§ThreadLocalä½ éƒ½çŸ¥é“å—ï¼Ÿ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/382aed84cf2b4c579a262387595172ec><p class=pgc-img-caption></p></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹ä¸‹ ThreadLocalMap é‡Œé¢çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬çŸ¥é“ HaseMap è§£å†³ hash å†²çªæ˜¯ç”±é“¾è¡¨å’Œçº¢é»‘æ ‘ï¼ˆ jdk1.8 ï¼‰æ¥è§£å†³çš„ï¼Œä½†æ˜¯è¿™ä¸ªæˆ‘ä»¬çœ‹åˆ° ThreadLocalMap åªæœ‰ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒæ˜¯æ€ä¹ˆæ¥è§£å†³ hash å†²çªå‘¢ï¼Ÿ ThreadLocalMap é‡‡ç”¨ <strong>ã€Œçº¿æ€§æ¢æµ‹ã€</strong> çš„æ–¹å¼ï¼Œä»€ä¹ˆæ˜¯çº¿æ€§æ¢æµ‹å‘¢ï¼Ÿå°±æ˜¯æ ¹ã€Œæ®åˆå§‹ key çš„hashcodeå€¼ç¡®å®šå…ƒç´ åœ¨ table æ•°ç»„ä¸­çš„ä½ç½®ï¼Œå¦‚æœå‘ç°è¿™ä¸ªä½ç½®ä¸Šå·²ç»æœ‰å…¶ä»– key å€¼çš„å…ƒç´ è¢«å ç”¨ï¼Œåˆ™åˆ©ç”¨å›ºå®šçš„ç®—æ³•å¯»æ‰¾ä¸€å®šæ­¥é•¿çš„ä¸‹ä¸ªä½ç½®ï¼Œä¾æ¬¡åˆ¤æ–­ï¼Œç›´è‡³æ‰¾åˆ°èƒ½å¤Ÿå­˜æ”¾çš„ä½ç½®ã€ ã€‚ ThreadLocalMap è§£å†³ Hash å†²çªçš„æ–¹å¼å°±æ˜¯ç®€å•çš„æ­¥é•¿åŠ  1 æˆ–å‡ 1 ï¼Œå¯»æ‰¾ä¸‹ä¸€ä¸ªç›¸é‚»çš„ä½ç½®ã€‚</p><pre><code>        /**         * Increment i modulo len.         */        private static int nextIndex(int i, int len) {            return ((i + 1 &lt; len) ? i + 1 : 0);        }        /**         * Decrement i modulo len.         */        private static int prevIndex(int i, int len) {            return ((i - 1 &gt;= 0) ? i - 1 : len - 1);        }</code></pre><p>è¿™ç§æ–¹å¼çš„è¯å¦‚æœä¸€ä¸ªçº¿ç¨‹é‡Œé¢æœ‰å¤§é‡çš„ ThreadLocal å°±ä¼šäº§ç”Ÿæ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºæ¯æ¬¡éƒ½éœ€è¦å¯¹è¿™ä¸ª table è¿›è¡Œéå†ï¼Œæ¸…ç©ºæ— æ•ˆçš„å€¼ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™å°½å¯èƒ½çš„ä½¿ç”¨å°‘çš„ ThreadLocalï¼Œä¸è¦åœ¨çº¿ç¨‹é‡Œé¢åˆ›å»ºå¤§é‡çš„ ThreadLocal ï¼Œå¦‚æœéœ€è¦è®¾ç½®ä¸åŒçš„å‚æ•°ç±»å‹æˆ‘ä»¬å¯ä»¥é€šè¿‡ ThreadLocal æ¥å­˜æ”¾ä¸€ä¸ª Object çš„ Map è¿™æ ·çš„è¯ï¼Œå¯ä»¥å¤§å¤§å‡å°‘åˆ›å»º ThreadLocal çš„æ•°é‡ã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><pre><code>public final class HttpContext {    private HttpContext() {    }    private static final ThreadLocal&lt;Map&lt;String, Object&gt;&gt; CONTEXT = ThreadLocal.withInitial(() -&gt; new ConcurrentHashMap(64));    public static &lt;T&gt; void add(String key, T value) {        if(StringUtils.isEmpty(key) || Objects.isNull(value)) {            throw new IllegalArgumentException("key or value is null");        }        CONTEXT.get().put(key, value);    }    public static &lt;T&gt; T get(String key) {        return (T) get().get(key);    }    public static Map&lt;String, Object&gt; get() {        return CONTEXT.get();    }    public static void remove() {        CONTEXT.remove();    }}</code></pre><p>è¿™æ ·çš„è¯æˆ‘ä»¬å¦‚æœéœ€è¦ä¼ é€’ä¸åŒçš„å‚æ•°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€ä¸ª ThreadLocal å°±å¯ä»¥ä»£æ›¿å¤šä¸ª ThreadLocal äº†ã€‚å¦‚æœè§‰å¾—ä¸æƒ³è¿™ä¹ˆç©ï¼Œæˆ‘å°±æ˜¯è¦åˆ›å»ºå¤šä¸ª ThreadLocal ï¼Œæˆ‘çš„éœ€æ±‚å°±æ˜¯è¿™æ ·ï¼Œè€Œä¸”æ€§èƒ½è¿˜å¾—è¦å¥½ï¼Œè¿™ä¸ªèƒ½ä¸èƒ½å®ç°åˆ—ï¼Ÿå¯ä»¥ä½¿ç”¨ netty çš„ FastThreadLocal å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸è¿‡è¦é…åˆä½¿ FastThreadLocalThread æˆ–è€…å®ƒå­ç±»çš„çº¿ç¨‹çº¿ç¨‹æ•ˆç‡æ‰ä¼šæ›´é«˜ï¼Œæ›´å¤šå…³äºå®ƒçš„ä½¿ç”¨å¯ä»¥è‡ªè¡ŒæŸ¥é˜…èµ„æ–™å“¦ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å®ƒçš„è¿™ä¸ªå“ˆå¸Œå‡½æ•°</p><pre><code>    // ç”Ÿæˆhash codeé—´éš™ä¸ºè¿™ä¸ªé­”æ•°ï¼Œå¯ä»¥è®©ç”Ÿæˆå‡ºæ¥çš„å€¼æˆ–è€…è¯´ThreadLocalçš„IDè¾ƒä¸ºå‡åŒ€åœ°åˆ†å¸ƒåœ¨2çš„å¹‚å¤§å°çš„æ•°ç»„ä¸­ã€‚    private static final int HASH_INCREMENT = 0x61c88647;    /**     * Returns the next hash code.     */    private static int nextHashCode() {        return nextHashCode.getAndAdd(HASH_INCREMENT);    }</code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œå®ƒæ˜¯åœ¨ä¸Šä¸€ä¸ªè¢«æ„é€ å‡ºçš„ ThreadLocal çš„ ID/threadLocalHashCode çš„åŸºç¡€ä¸ŠåŠ ä¸Šä¸€ä¸ªé­”æ•° 0x61c88647 çš„ã€‚è¿™ä¸ªé­”æ•°çš„é€‰å–ä¸æ–æ³¢é‚£å¥‘æ•£åˆ—æœ‰å…³ï¼Œ 0x61c88647 å¯¹åº”çš„åè¿›åˆ¶ä¸º 1640531527 .å½“æˆ‘ä»¬ä½¿ç”¨ 0x61c88647 è¿™ä¸ªé­”æ•°ç´¯åŠ å¯¹æ¯ä¸ª ThreadLocal åˆ†é…å„è‡ªçš„ ID ä¹Ÿå°±æ˜¯ threadLocalHashCode å†ä¸ 2 çš„å¹‚ï¼ˆæ•°ç»„çš„é•¿åº¦ï¼‰å–æ¨¡ï¼Œå¾—åˆ°çš„ç»“æœåˆ†å¸ƒå¾ˆå‡åŒ€ã€‚æˆ‘ä»¬å¯ä»¥æ¥ä¹Ÿæ¼”ç¤ºä¸‹é€šè¿‡è¿™ä¸ªé­”æ•°</p><pre><code>public class MagicHashCode {    private static final int HASH_INCREMENT = 0x61c88647;    public static void main(String[] args) {        hashCode(16); //åˆå§‹åŒ–16        hashCode(32); //åç»­2å€æ‰©å®¹        hashCode(64);    }    private static void hashCode(Integer length) {        int hashCode = 0;        for (int i = 0; i &lt; length; i++) {            hashCode = i * HASH_INCREMENT + HASH_INCREMENT;//æ¯æ¬¡é€’å¢HASH_INCREMENT            System.out.print(hashCode &amp; (length - 1));            System.out.print(" ");        }        System.out.println();    }}</code></pre><p>è¿è¡Œç»“æœï¼š</p><p>ä¸å¾—ä¸ä½©æœä¸‹è¿™ä¸ªä½œè€…ï¼Œé€šè¿‡ä½¿ç”¨äº†æ–æ³¢é‚£å¥‘æ•£åˆ—æ³•ï¼Œæ¥ä¿è¯å“ˆå¸Œè¡¨çš„ç¦»æ•£åº¦ï¼Œè®©ç»“æœå¾ˆå‡åŒ€ã€‚å¯è§ <strong>ã€Œä»£ç è¦å†™çš„å¥½ï¼Œæ•°å­¦è¿˜æ˜¯å°‘ä¸äº†ã€</strong> å•Šã€‚å…¶ä»–çš„æºç å°±ä¸åˆ†æäº†ï¼Œå¤§å®¶æ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œå»æŸ¥çœ‹ä¸‹ã€‚</p><h1 class=pgc-h-arrow-right><strong>ThreadLocalçš„å†…å­˜æ³„éœ²</strong></h1><p>å…³äº ThreadLocal æ˜¯å¦ä¼šå¼•èµ·å†…å­˜æ³„æ¼ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰äº‰è®®æ€§çš„é—®é¢˜ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Ÿ</p><p>â</p><p>åœ¨Javaä¸­ï¼Œå†…å­˜æ³„æ¼å°±æ˜¯å­˜åœ¨ä¸€äº›è¢«åˆ†é…çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡æœ‰ä¸‹é¢ä¸¤ä¸ªç‰¹ç‚¹ï¼Œé¦–å…ˆï¼Œè¿™äº›å¯¹è±¡æ˜¯å¯è¾¾çš„ï¼Œå³åœ¨æœ‰å‘å›¾ä¸­ï¼Œå­˜åœ¨é€šè·¯å¯ä»¥ä¸å…¶ç›¸è¿ï¼›å…¶æ¬¡ï¼Œè¿™äº›å¯¹è±¡æ˜¯æ— ç”¨çš„ï¼Œå³ç¨‹åºä»¥åä¸ä¼šå†ä½¿ç”¨è¿™äº›å¯¹è±¡ã€‚å¦‚æœå¯¹è±¡æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œè¿™äº›å¯¹è±¡å°±å¯ä»¥åˆ¤å®šä¸ºJavaä¸­çš„å†…å­˜æ³„æ¼ï¼Œè¿™äº›å¯¹è±¡ä¸ä¼šè¢«GCæ‰€å›æ”¶ï¼Œç„¶è€Œå®ƒå´å ç”¨å†…å­˜ã€‚</p><p>â</p><p>ThreadLocal çš„å†…å­˜æ³„éœ²æƒ…å†µï¼š</p><ul><li>ThreadLocal GC ThreadLocal ThreadLocalMap key null Entry Entry value setã€get key null Entry Entry.value Entry ThreadLocalMap Entry[] table Entry.value GC</li></ul><pre><code> public static void main(String[] args) throws InterruptedException {        ThreadLocal&lt;Long []&gt; threadLocal = new ThreadLocal&lt;&gt;();        for (int i = 0; i &lt; 50; i++) {            run(threadLocal);        }        Thread.sleep(50000);        // å»é™¤å¼ºå¼•ç”¨        threadLocal = null;        System.gc();        System.runFinalization();        System.gc();    }    private static void run(ThreadLocal&lt;Long []&gt; threadLocal) {        new Thread(() -&gt; {            threadLocal.set(new Long[1024 * 1024 *10]);            try {                Thread.sleep(1000000000);            } catch (InterruptedException e) {                e.printStackTrace();            }        }).start();    }</code></pre><p>é€šè¿‡ jdk è‡ªå¸¦çš„å·¥å…· jconsole.exe ä¼šå‘ç°å³ä½¿æ‰§è¡Œäº† gc å†…å­˜ä¹Ÿä¸ä¼šå‡å°‘ï¼Œå› ä¸ºkeyè¿˜è¢«çº¿ç¨‹å¼ºå¼•ç”¨ç€ã€‚æ•ˆæœå›¾å¦‚ä¸‹:</p><div class=pgc-img><img alt=è¿™4ç§ThreadLocalä½ éƒ½çŸ¥é“å—ï¼Ÿ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5eacdd04eb5748b6b03b1762fef9512d><p class=pgc-img-caption></p></div><ul><li>ThreadLocalMap äº†set()ã€get()ã€remove() cleanSomeSlots()ã€expungeStaleEntry() key null value ThreadLocal set()ï¼Œget()ï¼Œremove() value static ThreadLocal ThreadLocal ThreadLocal ThreadLocal GC Entry key null remove remove key null ThreadLocal remove FastThreadLocal</li><li>åœ¨çº¿ç¨‹æ± çš„åœºæ™¯ï¼Œç¨‹åºä¸åœæ­¢ï¼Œçº¿ç¨‹ä¸€ç›´åœ¨å¤ç”¨çš„è¯ï¼ŒåŸºæœ¬ä¸ä¼šé”€æ¯ï¼Œå…¶å®æœ¬è´¨å°±è·Ÿä¸Šé¢ä¾‹å­æ˜¯ä¸€æ ·çš„ã€‚å¦‚æœçº¿ç¨‹ä¸å¤ç”¨ï¼Œç”¨å®Œå°±é”€æ¯äº†å°±ä¸ä¼šå­˜åœ¨æ³„éœ²çš„æƒ…å†µã€‚å› ä¸ºçº¿ç¨‹ç»“æŸçš„æ—¶å€™ä¼šjvm ä¸»åŠ¨è°ƒç”¨ exit æ–¹æ³•æ¸…ç†ã€‚</li></ul><pre><code>      /**         * This method is called by the system to give a Thread         * a chance to clean up before it actually exits.         */        private void exit() {            if (group != null) {                group.threadTerminated(this);                group = null;            }            /* Aggressively null out all reference fields: see bug 4006245 */            target = null;            /* Speed the release of some of these resources */            threadLocals = null;            inheritableThreadLocals = null;            inheritedAccessControlContext = null;            blocker = null;            uncaughtExceptionHandler = null;        }</code></pre><h1 class=pgc-h-arrow-right><strong>InheritableThreadLocal</strong></h1><p>æ–‡ç« å¼€å¤´æœ‰æåˆ°è¿‡çˆ¶å­ä¹‹é—´çº¿ç¨‹çš„å˜é‡ä¼ é€’ä¸¢å¤±çš„æƒ…å†µã€‚ä½†æ˜¯ InheritableThreadLocal æä¾›äº†ä¸€ç§çˆ¶å­çº¿ç¨‹ä¹‹é—´çš„æ•°æ®å…±äº«æœºåˆ¶ã€‚å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><pre><code> static ThreadLocal&lt;String&gt; threadLocal = new ThreadLocal&lt;&gt;();    static InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = new InheritableThreadLocal&lt;&gt;();    public static void main(String[] args) throws InterruptedException {        threadLocal.set("threadLocalä¸»çº¿ç¨‹çš„å€¼");        Thread.sleep(100);        new Thread(() -&gt; System.out.println("å­çº¿ç¨‹è·å–threadLocalçš„ä¸»çº¿ç¨‹å€¼ï¼š" + threadLocal.get())).start();        Thread.sleep(100);        inheritableThreadLocal.set("inheritableThreadLocalä¸»çº¿ç¨‹çš„å€¼");        new Thread(() -&gt; System.out.println("å­çº¿ç¨‹è·å–inheritableThreadLocalçš„ä¸»çº¿ç¨‹å€¼ï¼š" + inheritableThreadLocal.get())).start();    }</code></pre><p>è¾“å‡ºç»“æœ</p><pre><code>çº¿ç¨‹è·å–threadLocalçš„ä¸»çº¿ç¨‹å€¼ï¼šnullå­çº¿ç¨‹è·å–inheritableThreadLocalçš„ä¸»çº¿ç¨‹å€¼ï¼šinheritableThreadLocalä¸»çº¿ç¨‹çš„å€¼</code></pre><p>ä½†æ˜¯ InheritableThreadLocal å’Œçº¿ç¨‹æ± ä½¿ç”¨çš„æ—¶å€™å°±ä¼šå­˜åœ¨é—®é¢˜ï¼Œå› ä¸ºå­çº¿ç¨‹åªæœ‰åœ¨çº¿ç¨‹å¯¹è±¡åˆ›å»ºçš„æ—¶å€™æ‰ä¼šæŠŠçˆ¶çº¿ç¨‹ inheritableThreadLocals ä¸­çš„æ•°æ®å¤åˆ¶åˆ°è‡ªå·±çš„ inheritableThreadLocals ä¸­ã€‚è¿™æ ·å°±å®ç°äº†çˆ¶çº¿ç¨‹å’Œå­çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¼ é€’ã€‚ä½†æ˜¯çº¿ç¨‹æ± çš„è¯ï¼Œçº¿ç¨‹ä¼šå¤ç”¨ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨é—®é¢˜ã€‚å¦‚æœè¦è§£å†³è¿™ä¸ªé—®é¢˜å¯ä»¥æœ‰ä»€ä¹ˆåŠæ³•åˆ—ï¼Ÿå¤§å®¶å¯ä»¥æ€è€ƒä¸‹ï¼Œæˆ–è€…åœ¨ä¸‹æ–¹ç•™è¨€å“¦ã€‚å¦‚æœå®åœ¨ä¸æƒ³æ€è€ƒçš„è¯ï¼Œå¯ä»¥å‚è€ƒä¸‹é˜¿é‡Œå·´å·´çš„ transmittable-thread-local å“¦ã€‚</p><ul><li>ThreadLocal ThreadLocal ThreadLocalã€InheritableThreadLocalã€FastThreadLocalã€transmittable-thread-local ThreadLocal</li></ul><ul><li>ç”±äºè‡ªå·±æ‰ç–å­¦æµ…ï¼Œéš¾å…ä¼šæœ‰çº°æ¼ï¼Œå‡å¦‚ä½ å‘ç°äº†é”™è¯¯çš„åœ°æ–¹ï¼Œè¿˜æœ›ç•™è¨€ç»™æˆ‘æŒ‡å‡ºæ¥,æˆ‘ä¼šå¯¹å…¶åŠ ä»¥ä¿®æ­£ã€‚</li><li>å¦‚æœä½ è§‰å¾—æ–‡ç« è¿˜ä¸é”™ï¼Œä½ çš„è½¬å‘ã€åˆ†äº«ã€èµèµã€ç‚¹èµã€ç•™è¨€å°±æ˜¯å¯¹æˆ‘æœ€å¤§çš„é¼“åŠ±ã€‚</li><li>æ„Ÿè°¢æ‚¨çš„é˜…è¯»,ååˆ†æ¬¢è¿å¹¶æ„Ÿè°¢æ‚¨çš„å…³æ³¨ã€‚</li></ul><div class=pgc-img><img alt=è¿™4ç§ThreadLocalä½ éƒ½çŸ¥é“å—ï¼Ÿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/79a28d6e8c2444a2b03a751a1fd9f6d3><p class=pgc-img-caption></p></div><pre><code>æœ€è¿‘é¢è¯•BATï¼Œæ•´ç†ä¸€ä»½é¢è¯•èµ„æ–™ã€ŠJavaé¢è¯•BATJé€šå…³æ‰‹å†Œã€‹ï¼Œè¦†ç›–äº†Javaæ ¸å¿ƒæŠ€æœ¯ã€JVMã€Javaå¹¶å‘ã€SSMã€å¾®æœåŠ¡ã€æ•°æ®åº“ã€æ•°æ®ç»“æ„ã€ç­‰ç­‰ã€‚</code></pre><p style=text-align:start>è·å–æ–¹å¼ï¼šå›å¤ <strong>666</strong> é¢†å–ï¼Œæ›´å¤šå†…å®¹é™†ç»­å¥‰ä¸Šã€‚</p><p style=text-align:start>æ–‡ç« æœ‰å¸®åŠ©çš„è¯ï¼Œåœ¨çœ‹ï¼Œè½¬å‘å§ã€‚</p><p style=text-align:start>è°¢è°¢æ”¯æŒå“Ÿ (*^__^*ï¼‰</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ThreadLocal','çŸ¥é“'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>