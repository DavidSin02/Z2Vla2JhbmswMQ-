<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Android Notification 通知学习详细笔记 | 极客快訊</title><meta property="og:title" content="Android Notification 通知学习详细笔记 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/1537157071419b1605a9208"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4bc4df7.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4bc4df7.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4bc4df7.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4bc4df7.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4bc4df7.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4bc4df7.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4bc4df7.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4bc4df7.html><meta property="article:published_time" content="2020-10-29T21:08:29+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:29+08:00"><meta name=Keywords content><meta name=description content="Android Notification 通知学习详细笔记"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/4bc4df7.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Android Notification 通知学习详细笔记</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>通知栏通知在Android APP中的使用极为频繁，比如短信通知，QQ，微信消息通知，App 更新进度转态显示，截图时后图片进行删除或分享，查看操作等等。本篇文章记录了如何使用 Notification 显示消息, 设置提示音，呼吸灯，震动，以及响应用户对消息的处理动作。</p><h1>Notification 状态栏通知</h1><ul><li>建造者模式构建通知类： Notification.Builder</li><li>通知管理器(用于发出通知)： NotificationManager</li><li>通知通道(API 26新增，用户可以选择性屏蔽通知)：NotificationChannel</li><li>通知动作(用户点击滑动通知等)：PaddingIntent</li></ul><p><strong>发送通知的步骤</strong></p><ol><li>获取 NotificationManager</li><li>创建 Notification</li><li>给 Notification 设置参数</li><li>使用 NotificationManager 发送通知</li></ol><p><strong>Android 7.0 新内容</strong></p><p>Notification.Builder.serPriority: 设置通知优先级 Notification.Builder.setStyle: 设置通知扩展布局 MessagingStyle: 快速回复</p><p><strong>Android 8.0 新内容</strong></p><p>NotificationChannel：用户可以自定义通知的显示，以及关闭某个通知的提示音震动等</p><h1>构建一个最简单的 Notification</h1><p>一个简单的通知包含，一个小图标，一个标题和内容如图：</p><div class=pgc-img><img alt="Android Notification 通知学习详细笔记" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1537157071419b1605a9208><p class=pgc-img-caption></p></div><p>代码</p><pre>// 获取系统 通知管理 服务NotificationManager notificationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);// 构建 NotificationNotification.Builder builder = new Notification.Builder(this);builder.setContentTitle("ContentTitle") .setSmallIcon(R.drawable.ic_launcher_background) .setContentText("Content Text Here");// 兼容 API 26，Android 8.0if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O){ // 第三个参数表示通知的重要程度，默认则只在通知栏闪烁一下 NotificationChannel notificationChannel = new NotificationChannel("AppTestNotificationId", "AppTestNotificationName", NotificationManager.IMPORTANCE_DEFAULT); // 注册通道，注册后除非卸载再安装否则不改变 notificationManager.createNotificationChannel(notificationChannel); builder.setChannelId("AppTestNotificationId");}// 发出通知notificationManager.notify(1, builder.build());</pre><h1>控制 Notification 的震动，呼吸灯、提示音以及如何显示</h1><p>构建 Notification 代码</p><pre>// 构建 NotificationNotification.Builder builder = new Notification.Builder(this);builder.setContentTitle("ContentTitle") .setSmallIcon(R.drawable.ic_launcher_background) .setContentText("Content Text Here") .setDefaults(Notification.DEFAULT_ALL);</pre><p>这里关键的在于 SetDefaults 这个方法，它接收一个 int，可选值如下：</p><ul><li>Notification.DEFAULT_VIBRATE ：震动提示</li><li>Notification.DEFAULT_SOUND：提示音</li><li>Notification.DEFAULT_LIGHTS：三色灯</li><li>Notification.DEFAULT_ALL：以上三种全部</li></ul><p>控制震动时长</p><p>setVibrate 接收一个long[], 下标为奇数为延时，偶数为震动时长，本例中为，延时0ms,震动300ms,延时200ms,震动300</p><pre>builder.setVibrate(new long[]{0, 300, 200, 300});// Android 8.0 需用以下方法// notificationChannel.enableVibration(true);// notificationChannel.setVibrationPattern(new long[]{0,300,300,500,300,800});</pre><p>控制灯颜色</p><p>三个参数依次是 int ARGB 颜色值、亮的时长、不亮的时长。</p><pre>builder.setLights(0xFFFF0000, 1000,1000);// Android 8.0 需用以下方法，不可设置时长// notificationChannel.enableLights(true);// notificationChannel.setLightColor(0xFFFF0000);</pre><p>控制声音</p><pre>builder.setSound(Uri.parse("android.resource://" + getPackageName() + "/" + R.raw.a))// Android 8.0 需用以下方法， 这里用的是加载res/raw的声音资源// notificationChannel.setSound(Uri.parse("android.resource://" + getPackageName() + "/" + R.raw.a), null);</pre><p>在锁屏上的显示方式</p><p>这个方法需要使用锁屏并在设置中隐藏敏感信息才能生效</p><pre>builder.setVisibility(Notification.VISIBILITY_PUBLIC);// Android 8.0 需用一下方法// notificationChannel.setLockscreenVisibility(Notification.VISIBILITY_PUBLIC);</pre><p>这个方法接收一个 int</p><ul><li>Notification.VISIBILITY_PUBLIC 显示所有通知内容</li><li>Notification.VISIBILITY_PRIVATE 只显示标题</li><li>Notification.VISIBILITY_SECRET 不显示任何内容</li></ul><p>如何取消通知</p><ol><li>用户清除</li><li>setAutoCancel()，点击通知会清除</li><li>NotificationManager.cancel(int id)</li><li>NotificationManager.cancel(String tag, int id)</li><li>NotificationManager.cancelAll() 清除所有该应用的通知</li></ol><p>其他</p><p><strong>持续的通知</strong></p><p>如播放音乐，后台任务，下载, 当这个方法传入 true 时，表示它是一个持续的通知，用户无法删除它，只能在代码中让通知消失。</p><pre>builder.setOngoing(true);</pre><p><strong>显示进度条</strong></p><p>在后台处理某个耗时任务时需要使用到进度条, 参数作用依次是 进度条最大值、当前进度、进度是否确定，indeterminate 表示任务的进度是否可以准确获取</p><pre>builder.setProgress(int max, int progress, boolean indeterminate);</pre><p><strong>如何更新通知</strong></p><p>只需在发出通知时使用相同的 id 即可更新，如果这条通知已被移除则创建一个新的通知</p><pre>notificationManager.notify(int id, Notification.Builder);</pre><h1>如何响应用户动作</h1><p>给 Notification 设置 PendingIntent 用于响应点击、清除动作</p><p>PendingIntent 是一种特殊的 Intent， 作用和 Intent 一样是用于启动一个 Activity或者Service，或发送一条 Broadcast。通知响应用户动作便是用这个， 当对通知做出一个动作后，系统便会调用 PendingIntent，启动一个活动，服务或广播，这取决于你获取的是那种 PendingIntent。</p><p>在 PendingIntent 中传入的 Context 销毁以后，PendingIntent 依旧有效，它一般使用在当 Context 销毁后需要执行 Intent的地方，一般不是用于立即执行的时候，比如在点击通知后唤醒一个 Activity。。</p><p>获取 PendingIntent</p><pre>// 获取用于启动 Activity PendingIntent.getActivity(Context context, int requestCode, Intent intent, int flags);// 获取用于发送 BroadcastPendingIntent.getBroadcast(Context context, int requestCode, Intent intent, int flags);// 获取用于启动服务PendingIntent.getService(Context context, int requestCode, Intent intent, int flags);PendingIntent.getActivities(Context context, int reqeustCode, Intent[] intents, int flags);PendingIntent.getForgroundService(Context, int reqeustCode, Intent intent, int flags)</pre><p>各个参数的用途分别如下</p><ul><li>context, 当前上下文</li><li>requestCode, 请求标识，如果多次获取时这个值相同，则返回的结果与 flags 参数相关</li><li>intent, 请求意图</li><li>flags, 控制获取 PendingIntent 的方式，可选值如下</li><li class=ql-indent-1>PendingIntent.FLAG_CANCEL_CURRENT，如果当前已存在则取消当前的并返回一个新的 PendingIntent</li><li class=ql-indent-1>PendingIntent.FLAG_UPDATE_CURRENT，如果已存在则更新之前的</li><li class=ql-indent-1>PendingIntent.FLAG_NO_CREATE，如果已存在则返回当前存在的，否则返回 null</li><li class=ql-indent-1>PendingIntent.FLAG_ONE_SHOT，表明这个 PendingIntent 只能用一次，触发一次后自动 cancel</li><li class=ql-indent-1>PendingIntent.FLAG_IMMUTABLE，表明这个PendingIntent 不可变</li></ul><p>其中，requestCode 和 flags 是相关联的，如果多次获取 PendingIntent 时 requestCode 相同，此时返回的结果就需要参考 flags 的值。例如</p><pre> Intent intent1 = new Intent("NotificationAction"); intent1.putExtra("A", "value AA"); intent1.putExtra("B", "value BB"); Intent intent11 = new Intent("NotificationAction"); intent11.putExtra("B", "BBB"); PendingIntent pendingIntent = PendingIntent.getBroadcast(this, 1, intent1, PendingIntent.FLAG_CANCEL_CURRENT); PendingIntent pendingIntent11 = PendingIntent.getBroadcast(this, 1, intent11, PendingIntent.FLAG_UPDATE_CURRENT);</pre><p>这两个 PendingIntent 的 requestCode 是相同的，第二个获取时传入的 flags 为 PendingIntent.FLAG_UPDATE_CURRENT ，表示存在 requestCode 为 1，的PendingIntent则更新这个PendingIntent 的 Intent 值，此时 getStringExtr("A") 的值为 null，getStringExtra("B"), 的值为 BBB。</p><p>当我们获取了 PendingIntent 之后，只需要给 builder 的特定方法传入就可以响应点击、清除动作了</p><p>设置点击，清除 PendingIntent 代码：</p><pre>builder.setContentIntent(PendingIntent intent);builder.setDeleteIntent(PendingIntent intent);</pre><p>添加几个简单的按钮</p><p>在需要对通知内容进行简单操作的时候，比如短信的‘标记为已读’，‘删除’。我们可以对按钮设置图标、标题以及设置 PendingIntent 以便响应动作。这种按钮最多可以添加三个，按添加的顺序从左往右依次排列。<strong>api 23 之后图标不显示</strong></p><pre>Intent intent2 = new Intent("NotificationAction");intent2.putExtra("A", "Action button1 clicked");PendingIntent pendingIntent1 = PendingIntent.getBroadcast(this, 3, intent2, PendingIntent.FLAG_UPDATE_CURRENT);otification.Action.Builder actionBuilder = new Notification.Action.Builder(Icon.createWithResource(getApplicationContext(), R.drawable.ic_launcher_background), "Action1", pendingIntent1);builder.addAction(actionBuilder.build());</pre><p>结果如图，点击 Action1 按钮后将发出一条广播</p><div class=pgc-img><img alt="Android Notification 通知学习详细笔记" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1537157071995497d637ba2><p class=pgc-img-caption></p></div><h1>超长内容的 Notification, 各种 Style</h1><p>超长内容的 Notification，比如内容为文字很多，或者一个大图片，一个自定义的 View，通过 builder.setStyle(Style style) 这个方法设置。设置 style 之后，之前的 setContent 设置的内容将会失效。各种 style 的高度最大为 256 dp。</p><p>BigTextStyle，超长文本</p><pre>Notification.BigTextStyle bigTextStyle = new Notification.BigTextStyle().bigText( "This is big text notification. This is big text notification. " + "This is big text notification. This is big text notification. " + "This is big text notification. This is big text notification. " + "This is big text notification. This is big text notification. " + "This is big text notification. This is big text notification. " + "This is big text notification. This is big text notification. " + "This is big text notification. This is big text notification. " + "This is big text notification. This is big text notification. " + "This is big text notification. This is big text notification. ");builder.setStyle(bigTextStyle);</pre><p>InboxStyle，列表</p><p>inboxstyle 显示为一个文字列表，显示 addline 的顺序的文字，最多支持六行。</p><pre>Notification.InboxStyle inboxStyle = new Notification.InboxStyle();// 添加行inboxStyle.addLine("First line.");inboxStyle.addLine("Second line");inboxStyle.addLine("Third line");inboxStyle.addLine("Last line");// 设置标题以及简介文字inboxStyle.setBigContentTitle("ContentTitle");inboxStyle.setSummaryText("SummaryText");builder.setStyle(inboxStyle);</pre><p>BigPictureStyle, 大图片</p><pre>// 构建一个 StyleNotification.BigPictureStyle bigPictureStyle =  new Notification.BigPictureStyle().bigPicture(BitmapFactory.decodeResource(getResources(),R.drawable.big));// 设置标题bigPictureStyle.setBigContentTitle("ContentTitle");// 设置副标题，简介文字bigPictureStyle.setSummaryText("SummaryText");// 设置大图标bigPictureStyle.bigLargeIcon(BitmapFactory.decodeResource(getResources(), R.drawable.big));builder.setStyle(bigPictureStyle);</pre><p>MediaStyle</p><p>略</p><h1>快速回复 MessageNotification</h1><p>有些时候我们需要对通知内容进行快速回复，比如收到一条邮件，我们可以快速回复。当点击通知的一个 Action 按钮后将会出现一个输入框，可以进行发送消息。我们需要添加一个 MessageStyle 和 一个带 RemoteInput 的 Action，这个通知便能支持快速回复。<strong>这个功能需要 api 版本大于 24</strong></p><p>首先，构建一个 MessageStyle，并设置好</p><pre>Notification.MessagingStyle messagingStyle = new Notification .MessagingStyle("UserDisplayName"). addMessage("MessageStyle", 1000, "sender");builder.setStyle(messagingStyle);</pre><p>然后再创建一个 Action，Action 需添加一个 RemoteInput，一个响应发送动作的 PendingIntent，这个例子中点击发送按钮后将发送一条广播。</p><pre>Intent intent = new Intent("NotificationAction");PendingIntent pendingIntent = PendingIntent.getBroadcast(this, 11, intent, PendingIntent.FLAG_UPDATE_CURRENT);RemoteInput remoteInput = new RemoteInput .Builder("RemoteInputKey") .setLabel("RemoteInputLabel") .build();Notification.Action action = new Notification.Action .Builder(Icon.createWithResource(this, R.mipmap.ic_launcher_round), "ReplayAction", pendingIntent) .addRemoteInput(remoteInput) .build();// 发送该通知notificationManager.notify(22, builder.build());</pre><p>接受输入数据用的广播，我们在获取到输入数据后需要手动取消该通知，否则不会自动取消。</p><pre>class MBroadcast extends Broadcast{ [@Override](https://my.oschina.net/u/1162528) public void onReceive(Context context, Intent intent) { Bundle bundle = RemoteInput.getResultsFromIntent(intent); if (bundle != null){ String replayContent = bundle.getString("RemoteInputKey"); Log.d("MBroadcast", "onReceive: " + replayContent); // 取消该通知 ((NotificationManager)getSystemService(Context.NOTIFICATION_SERVICE)).cancel(22); }  }}</pre><h1>给 Notification 添加一个 View 扩展视图</h1><p>在通知栏进行对后台任务的控制的时候需要用到这个功能， 比如下载一个文件时可以 取消，暂停，后台播放音乐时可以 切换暂停和显示歌词等。通知的自定义 view 最大高度为 256 dp，且只有 <strong>Android N 以上版本才支持</strong> 自定义 view。</p><div class=pgc-img><img alt="Android Notification 通知学习详细笔记" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1537157071418385a22e806><p class=pgc-img-caption></p></div><p>RemoteViews 只支持几个 View，在这里我使用 ConstraintLayout 作为根 Layout 的时候发现会出现 android.app.RemoteServiceException: Bad notification posted from package xxx 这个错误，换了 LinearLayout 后就不会出现这个问题。支持的 View 如下</p><ul><li>Layout</li><li class=ql-indent-1>FrameLayout</li><li class=ql-indent-1>LinearLayout</li><li class=ql-indent-1>RelativeLayout</li><li class=ql-indent-1>GridLayout</li><li>View Button，ImageView，ImageButton，TextView，ProgressBar，ListView，GridView，StackView，ViewStub，AdapterViewFlipper，ViewFlipper，AnalogClock，Chronometer</li></ul><p>首先构建一个通知，创建一个 RemoteViews，RemoteViews 构造函数接受一个包含 view 所在的包名和一个 View 资源。RemoteViews 意思就是远程 view，该 view 不存在与 当前 Activity，进程，通常用于通知中的自定义 view 和桌面小部件。</p><pre>Notification.Builder builder = new Notification.Builder(this) .setContentTitle("ContentTitle") .setTicker("ThisIsTicker") .setSmallIcon(R.drawable.ic_launcher_background) .setContentText("ContentText");RemoteViews remoteViews = new RemoteViews(getPackageName(), R.layout.notify_view);</pre><p>这里的 notify_view 很简单，如下</p><pre>&lt;LinearLayout ...&gt;  &lt;ImageView id="@+id/notify_iv" .../&gt; &lt;TextView id="@+id/notify_tv" .../&gt; &lt;Button id="@+id/notify_bt" .../&gt;&lt;/LinearLayout&gt;</pre><p>设置 CustomContentView 和 Style。</p><pre>builder.setCustomContentView(remoteViews);Notification.DecoratedCustomViewStyle viewStyle = new Notification.DecoratedCustomViewStyle();builder.setStyle(viewStyle);</pre><p>如何监听自定义 view RemoteViews 中的点击事件，和更新 view</p><p>现在已经添加了一个 view，如何修改 view 中的数据以及响应 view 的事件呢？通过 RemoteViews.setOnClickPendingIntent(int r, PendingIntent intnet) 这个方法为 一个 view 绑定一个 PendingIntent，当点击了该view 后便执行相应的操作。</p><pre>Intent intent = new Intent("NotificationAction");intent.putExtra("action", "bt_click");PendingIntent pendingIntent = PendingIntent.getBroadcast(this, 12, intent, PendingIntent.FLAG_UPDATE_CURRENT);remoteViews.setOnClickPendingIntent(R.id.notify_bt, pendingIntent);</pre><p>更新 RemoteView 中的数据，更新一个 ImageView中的图片，对各种 view 更新都有相应的方法。</p><pre>remoteViews.setBitmap(R.id.notify_iv, "setImageBitmap", BitmapFactory.decodeResource(getResources(), R.drawable.me));</pre><p>（完）</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Android','Notification','学习'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>