<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>CORS——跨域请求那些事儿 | 极客快訊</title><meta property="og:title" content="CORS——跨域请求那些事儿 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/382fe92652924d74afe3f3ee787c9042"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4ca8329c.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4ca8329c.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4ca8329c.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4ca8329c.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4ca8329c.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4ca8329c.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4ca8329c.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4ca8329c.html><meta property="article:published_time" content="2020-11-14T21:00:34+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:34+08:00"><meta name=Keywords content><meta name=description content="CORS——跨域请求那些事儿"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/4ca8329c.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>CORS——跨域请求那些事儿</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>在日常的项目开发时会不可避免的需要进行跨域操作，而在实际进行跨域请求时，经常会遇到类似 No 'Access-Control-Allow-Origin' header is present on the requested resource.这样的报错。<br></p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/382fe92652924d74afe3f3ee787c9042><p class=pgc-img-caption></p></div><p><br>这样的错误，一般是由于CORS跨域验证机制设置不正确导致的，本文将详细讲解CORS跨域验证机制的原理，让您轻松掌握CORS跨域设置的使用方法，安全、方便的进行前端开发。</p><h1 class=pgc-h-arrow-right>什么是CORS</h1><p>CORS（Cross-Origin Resource Sharing 跨源资源共享），当一个请求url的协议、域名、端口三者之间任意一与当前页面地址不同即为跨域。</p><p>例如最常见的，在一个域名下的网页中，调用另一个域名中的资源。</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/def80fcb714246cfb06d4591088f66a1><p class=pgc-img-caption></p></div><p>相对于上面这种静态的调用方式，还可以通过Ajax技术来动态发起跨域请求。例如如下的方式，利用XMLHttpRequest对象发送一个GET请求，获取另一个域名下的图片内容。</p><pre><code>&lt;!DOCTYPE html&gt; &lt;html&gt;    &lt;head&gt;CORS Test&lt;/head&gt;    &lt;body&gt;        &lt;div id="img_Div"&gt;&lt;/div&gt;    &lt;script type="text/javascript"&gt;          //XmlHttpRequest对象          function createXmlHttpRequest(){              if(window.ActiveXObject){ //如果是IE浏览器                  return new ActiveXObject("Microsoft.XMLHTTP");              }else if(window.XMLHttpRequest){ //非IE浏览器                  return new XMLHttpRequest();              }          }          function getFile() {            var img_Container = document.getElementById("img_Div");            var xhr = createXmlHttpRequest();            xhr.open('GET', 'http://oss.youkouyang.com/1.jpg', true);            xhr.setRequestHeader('Content-Type', 'image/jpeg');            xhr.responseType = "blob";            xhr.onload = function() {                if (this.status == 200) {                    var blob = this.response;                    var img = document.createElement("img");                    img.onload = function(e) {                        window.URL.revokeObjectURL(img.src);                     };                    img.src = window.URL.createObjectURL(blob);                    img_Container.appendChild(img);                    }            }            xhr.send(null);        }    &lt;/script&gt;    &lt;div class="row"&gt;        &lt;input type="button" onclick="getFile()" value="Get" /&gt;    &lt;/div&gt;    &lt;/body&gt;&lt;/html&gt;  </code></pre><h1 class=pgc-h-arrow-right>CORS的作用</h1><p>为了改善网络应用程序，开发人员要求浏览器供应商允许跨域请求。跨域请求主要用于：</p><ul><li>调用XMLHttpRequest或fetchAPI通过跨站点方式访问资源</li><li>网络字体，例如Bootstrap（通过CSS使用@font-face 跨域调用字体）</li><li>通过canvas标签，绘制图表和视频。</li></ul><h1 class=pgc-h-arrow-right>CORS的安全隐患</h1><p>跨域请求和Ajax技术都会极大地提高页面的体验，但同时也会带来安全的隐患，其中最主要的隐患来自于CSRF（Cross-site request forgery）跨站请求伪造。</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/075ec861373e4ed5bea48fcd72e08d73><p class=pgc-img-caption></p></div><p>CSRF攻击的大致原理是：</p><ol start=1><li>用户通过浏览器，访问正常网站A（例如某银行），通过用户的身份认证（比如用户名/密码）成功A网站。</li><li>网站A产生Cookie信息并返回给用户的浏览器；</li><li>用户保持A网站页面登录状态，在同一浏览器中，打开一个新的TAB页访问恶意网站B；</li><li>网站B接收到用户请求后，返回一些攻击性代码，请求A网站的资源（例如转账请求）；</li><li>浏览器执行恶意代码，在用户不知情的情况下携带Cookie信息，向网站A发出请求。</li><li>网站A根据用户的Cookie信息核实用户身份（此时用户在A网站是已登录状态），A网站会处理该请求，导致来自网站B的恶意请求被执行。</li></ol><h1 class=pgc-h-arrow-right>CORS验证机制</h1><p>出于安全原因，浏览器限制从脚本中发起的跨域HTTP请求。默认的安全限制为同源策略， 即JavaScript或Cookie只能访问同域下的内容。W3C推荐了一种跨域的访问验证的机制，即CORS（Cross-Origin Resource Sharing 跨源资源共享）。这种机制让Web应用服务器能支持跨站访问控制，使跨站数据传输更加安全，减轻跨域HTTP请求的风险。CORS验证机制需要客户端和服务端协同处理。</p><h2 class=pgc-h-arrow-right>CORS浏览器支持情况</h2><p>目前主流浏览器都已基本提供对跨域资源共享的支持，移动端浏览器也几乎全部支持。<br></p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/38bcc34fc1b44e0e8ebcfbe71044b0ca><p class=pgc-img-caption></p></div><p><br></p><h2 class=pgc-h-arrow-right>客户端处理机制</h2><p>基于上述的CSRF的风险，各主流的浏览器都会对动态的跨域请求进行特殊的验证处理。验证处理分为简单请求验证处理和预先请求验证处理。</p><h3 class=pgc-h-arrow-right>简单请求</h3><p>当请求<u>同时满足</u>下面两个条件时，浏览器会直接发送GET请求，在同一个请求中做跨域权限的验证。</p><p>请求方法是下列之一：</p><ul><li>GET</li><li>HEAD</li><li>POST</li></ul><p>请求头中的Content-Type请求头的值是下列之一：</p><ul><li>application/x-www-form-urlencoded</li><li>multipart/form-data</li><li>text/plain</li></ul><p>简单请求时，浏览器会直接发送跨域请求，并在请求头中携带Origin 的header，表明这是一个跨域的请求。服务器端接到请求后，会根据自己的跨域规则，通过Access-Control-Allow-Origin和Access-Control-Allow-Methods响应头，来返回验证结果。如果验证成功，则会直接返回访问的资源内容。</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1252a6c8f3a44432806312962c23332d><p class=pgc-img-caption></p></div><p>如果验证失败，则返回403的状态码，不会返回跨域请求的资源内容。</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b8511b2e07c843aea238bd32cfe55ca2><p class=pgc-img-caption></p></div><p>可以通过浏览器的Console查看具体的验证失败原因</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8ede5547af864cec9e2b782deb64b666><p class=pgc-img-caption></p></div><h3 class=pgc-h-arrow-right>预先请求</h3><p>当请求满足下面<u>任意一个</u>条件时，浏览器会先发送一个OPTION请求，用来与目标域名服务器协商决定是否可以发送实际的跨域请求。</p><p>请求方法<u>不是</u>下列之一：</p><ul><li>GET</li><li>HEAD</li><li>POST</li></ul><p>请求头中的Content-Type请求头的值<u>不是</u>下列之一：</p><ul><li>application/x-www-form-urlencoded</li><li>multipart/form-data</li><li>text/plain</li></ul><p></p><p>浏览器在发现页面中有上述条件的动态跨域请求的时候，并不会立即执行对应的请求代码，而是会先发送Preflighted requests（预先验证请求），Preflighted requests是一个OPTION请求，用于询问要被跨域访问的服务器，是否允许当前域名下的页面发送跨域的请求。</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8bf3aedbd94e490fa14bd4cdde62b7cd><p class=pgc-img-caption></p></div><p></p><p>OPTIONS请求头部中会包含以下头部：Origin、Access-Control-Request-Method、Access-Control-Request-Headers。服务器收到OPTIONS请求后，设置Access-Control-Allow-Origin、Access-Control-Allow-Method、Access-Control-Allow-Headers头部与浏览器沟通来判断是否允许这个请求。如果Preflighted requests验证通过，浏览器才会发送真正的跨域请求。</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/490672b8dc9147b9ae97c9373b55f5af><p class=pgc-img-caption></p></div><p>　　</p><p>如果Preflighted requests验证失败，则会返回403状态，浏览器不会发送真正的跨域请求。</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8143fe43a1164cd585402efd63e08376><p class=pgc-img-caption></p></div><p>可以通过浏览器的Console查看具体的验证失败原因</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f3d5c8946f9948c299a24da4e432de96><p class=pgc-img-caption></p></div><p></p><h3 class=pgc-h-arrow-right>带认证的请求</h3><p>默认情况下，跨源请求不提供凭据(cookie、HTTP认证及客户端SSL证明等)。通过将withCredentials属性设置为true，可以指定某个请求应该发送凭据。xhr.withCredentials = true;如果服务器接收带凭据的请求，会用下面的HTTP头部来响应。Access-Control-Allow-Credentials: true服务器还可以在Preflight响应中发送这个HTTP头部，表示允许源发送带凭据的请求。</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/7f113a1bef5940a6815fec05fcaecd97><p class=pgc-img-caption></p></div><p>如果发送的是带凭据的请求，但服务器的响应中没有包含这个头，那么浏览器就不会把响应交给JavaScript(responseText中将是空字符串，size为0)。</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/047faf6f387c40fca551b7697bde1f8f><p class=pgc-img-caption></p></div><p>注意，当withCredentials属性设置为true，需要response header中的'Access-Control-Allow-Origin'为一个确定的域名，而不能使用'*'这样的通配符。</p><div class=pgc-img><img alt=CORS——跨域请求那些事儿 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6b503762355d48968f85bda212a8a82e><p class=pgc-img-caption></p></div><h2 class=pgc-h-arrow-right>服务端处理机制</h2><p>服务器端对于跨域请求的处理流程如下：</p><ol start=1><li>首先查看http头部有无origin字段；</li><li>如果没有，或者不允许，直接当成普通请求处理，结束；</li><li>如果有并且是允许的，那么再看是否是preflight(method=OPTIONS)；</li><li>如果不是preflight（简单请求），就返回Allow-Origin、Allow-Credentials等，并返回正常内容。</li><li>如果是preflight（预先请求），就返回Allow-Headers、Allow-Methods等，内容为空；</li></ol><h1 class=pgc-h-arrow-right>HTTP Header</h1><h2 class=pgc-h-arrow-right>Request header</h2><h3 class=pgc-h-arrow-right>Origin</h3><p>Origin头在跨域请求或预先请求中，标明发起跨域请求的源域名。<br></p><h3 class=pgc-h-arrow-right>Access-Control-Request-Method</h3><p>Access-Control-Request-Method头用于表明跨域请求使用的实际HTTP方法<br></p><h3 class=pgc-h-arrow-right>Access-Control-Request-Headers</h3><p>Access-Control-Request-Headers用于在预先请求时，告知服务器要发起的跨域请求中会携带的请求头信息<br></p><h2 class=pgc-h-arrow-right>Response header</h2><h3 class=pgc-h-arrow-right>Access-Control-Allow-Origin</h3><p>Access-Control-Allow-Origin头中携带了服务器端验证后的允许的跨域请求域名，可以是一个具体的域名或是一个*（表示任意域名）。简单请求时，浏览器会根据此响应头的内容决定是否给脚本返回相应内容，预先验证请求时，浏览器会根据此响应头决定是否发送实际的跨域请求。<br></p><h3 class=pgc-h-arrow-right>Access-Control-Expose-Headers</h3><p>Access-Control-Expose-Headers头用于允许返回给跨域请求的响应头列表，在列表中的响应头的内容，才可以被浏览器访问。<br></p><h3 class=pgc-h-arrow-right>Access-Control-Max-Age</h3><p>Access-Control-Max-Age用于告知浏览器可以将预先检查请求返回结果缓存的时间，在缓存有效期内，浏览器会使用缓存的预先检查结果判断是否发送跨域请求。<br></p><h3 class=pgc-h-arrow-right>Access-Control-Allow-Credentials</h3><p>Access-Control-Allow-Credentials用于告知浏览器当withCredentials属性设置为true时，是否可以显示跨域请求返回的内容。简单请求时，浏览器会根据此响应头决定是否显示响应的内容。预先验证请求时，浏览器会根据此响应头决定在发送实际跨域请求时，是否携带认证信息。<br></p><h3 class=pgc-h-arrow-right>Access-Control-Allow-Methods</h3><p>Access-Control-Allow-Methods用于告知浏览器可以在实际发送跨域请求时，可以支持的请求方法，可以是一个具体的方法列表或是一个*（表示任意方法）。简单请求时，浏览器会根据此响应头的内容决定是否给脚本返回相应内容，预先验证请求时，浏览器会根据此响应头决定是否发送实际的跨域请求。<br></p><h3 class=pgc-h-arrow-right>Access-Control-Allow-Headers</h3><p>Access-Control-Allow-Headers用于告知浏览器可以在实际发送跨域请求时，可以支持的请求头，可以是一个具体的请求头列表或是一个*（表示任意请求头）。简单请求时，浏览器会根据此响应头的内容决定是否给脚本返回相应内容，预先验证请求时，浏览器会根据此响应头决定是否发送实际的跨域请求。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'CORS','跨域','请求'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>