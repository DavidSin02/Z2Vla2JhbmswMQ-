<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®° | æå®¢å¿«è¨Š</title><meta property="og:title" content="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®° - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/b9d102263d0f46a0b5b203d7b6cd4a2e"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4cb74cd.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4cb74cd.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4cb74cd.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4cb74cd.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4cb74cd.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4cb74cd.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4cb74cd.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4cb74cd.html><meta property="article:published_time" content="2020-10-29T20:59:18+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:18+08:00"><meta name=Keywords content><meta name=description content="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/4cb74cd.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p class=ql-align-center><br></p><div class=pgc-img><img alt="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b9d102263d0f46a0b5b203d7b6cd4a2e><p class=pgc-img-caption></p></div><p><strong>å¼•è¨€æœ‰ç‚¹é•¿</strong></p><p>å‰ç«¯çš„å®å®ä¼šç”¨ajax,ç”¨å¼‚æ­¥ç¼–ç¨‹åˆ°å¿«ä¹çš„ä¸è¡Œ~ æˆ‘ä»¬javaä¹Ÿæœ‰å¼‚æ­¥,ç”¨èµ·æ¥æ¯”ä»–ä»¬è¿˜å¿«ä¹~ æˆ‘ä»¬bia<sub>ji</sub>ä¸€ä¸ªæ³¨(gÇ’upÃ­)è§£(gÄoyÃ o),ä¹Ÿæ˜¯å¿«ä¹é£ç”·...</p><div class=pgc-img><img alt="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/76774e1aae234e1fb0cd43b2cd9efe23><p class=pgc-img-caption></p></div><p>ä¸”çœ‹ä¸‹é¢çš„æ —å­:</p><p>æ³¨å†Œä¸€ä¸ªç”¨æˆ·,ç»™ä»–çš„è´¦æˆ·åˆå§‹åŒ–ç§¯åˆ†(ä¹Ÿå¯ä»¥æƒ³è±¡æˆæ³¨å†Œå¥–åŠ±),å†ç»™ç”¨æˆ·å‘ä¸ªæ³¨å†Œé€šçŸ¥çŸ­ä¿¡,å†å‘ä¸ªé‚®ä»¶,(åªæ˜¯ä¸¾æ —å­,åˆ‡è«ç‰›è§’å¤§æ³•),è¿™æ ·ä¸€ä¸ªæµç¨‹,çŸ­ä¿¡å’Œé‚®ä»¶æˆ‘è§‰å¾—å®Œå…¨å¯ä»¥æ‹†åˆ†å‡ºæ¥,æ²¡å¿…è¦æ‹–åœ¨åœ¨ä¸»æµç¨‹ä¸Šæ¥(å†è¡¥å……ä¸Š<strong>äº‹åŠ¡</strong>[ACID:åŸå­æ€§,ä¸€è‡´æ€§,éš”ç¦»æ€§,æŒä¹…æ€§]å°±å¥½äº†):</p><div class=pgc-img><img alt="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/64c95c7e357b4756aedc1df7d658f878><p class=pgc-img-caption></p></div><p>ä»Šå¤©å°±è¿™ç‚¹ä¸šåŠ¡,æˆ‘åœ¨æš—æƒ³,è¿™ä¸æ˜¯ä¸€ä¸ªæ³¨è§£å°±ææ‚çš„å˜›~~~ <sub>å“ˆå“ˆå“ˆ</sub></p><div class=pgc-img><img alt="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/39c186d466d1403b9163b08677a2675f><p class=pgc-img-caption></p></div><p>ç»“æœä¸æ˜¯æƒ³è±¡ä¸­çš„é‚£ä¹ˆå®Œç¾~~ æ¥çœ‹æˆ‘çš„<strong>å¼‚(dind)æ­¥(ding)å†é™©è®°</strong></p><div class=pgc-img><img alt="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9fea1352e1e44ad89441576d6bb309ca><p class=pgc-img-caption></p></div><p>æˆ‘çš„é¦–å‘åŸåˆ›åšå®¢åœ°å€:<strong>ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å— â˜ å¼‚æ­¥å†é™©å¥‡é‡è®°</strong><sup><strong>[1] https://juejin.im/post/5d47a80a6fb9a06ad3470f9a </strong></sup>é‡Œé¢æœ‰gitHubé¡¹ç›®åœ°å€,å…³æ³¨æˆ‘,é‡Œé¢å®æˆ˜å¤šå¤šå“¦~</p><hr><p><strong>å¥‡é‡ä¸€ å¾ªç¯ä¾èµ–å¼‚å¸¸</strong></p><p>çœ‹code:</p><pre>@Servicepublic class UserServiceImpl implements UserService { @Autowired UserService userService;  @Override @Transactional(rollbackFor = Exception.class, propagation = Propagation.REQUIRES_NEW) public int save(UserDTO userDTO) { User user = new User(); BeanCopyUtils.copy(userDTO, user); int insert = userMapper.insert(user); System.out.println("User ä¿å­˜ç”¨æˆ·æˆåŠŸ:" + user); userService.senMsg(user); userService.senEmail(user); return insert; } @Async @Override public Boolean senMsg(User user) { try { TimeUnit.SECONDS.sleep(2); System.out.println("å‘é€çŸ­ä¿¡ä¸­:....."); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",æ‰‹æœºå·:" + user.getMobile() + "å‘é€çŸ­ä¿¡æˆåŠŸ"); return true; } @Async @Override public Boolean senEmail(User user) { try { TimeUnit.SECONDS.sleep(3); System.out.println("å‘é€é‚®ä»¶ä¸­:....."); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",é‚®ç®±:" + user.getEmail() + "å‘é€é‚®ä»¶æˆåŠŸ"); return true; }</pre><p>ç»“æœ:å¯åŠ¨ä¸èµ·æ¥,Springå¾ªç¯ä¾èµ–é—®é¢˜ã€‚ Springä¸æ˜¯è§£å†³äº†å¾ªç¯ä¾èµ–é—®é¢˜å—ï¼Œå®ƒæ˜¯æ”¯æŒå¾ªç¯ä¾èµ–çš„å‘€ï¼Ÿæ€ä¹ˆä¼šå‘¢ï¼Ÿ</p><p>ä¸å¯å¦è®¤ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆåšä¿¡çš„ï¼Œå€˜è‹¥ä½ ç›®å‰ä¹Ÿå’Œæˆ‘æœ‰ä¸€æ ·åšæŒºçš„æƒ³æ³•,é‚£å°±è®©å¼‚å¸¸UnsatisfiedDependencyException,has been injected into other beans [userServiceImpl] in its raw version as part of a circular reference,,æ¥é¼“åŠ±ä½ ,æ‹¥æŠ±ä½ , å°±æ˜¯è¿™ä¹ˆçš„ä¸ç»™é¢å­,èµ¤è£¸è£¸çš„circular referenceã€‚</p><p>è°ˆåˆ°Spring Beançš„å¾ªç¯ä¾èµ–ï¼Œæœ‰çš„å°ä¼™ä¼´å¯èƒ½æ¯”è¾ƒé™Œç”Ÿï¼Œæ¯•ç«Ÿå¼€å‘è¿‡ç¨‹ä¸­å¥½åƒå¯¹å¾ªç¯ä¾èµ–è¿™ä¸ªæ¦‚å¿µæ— æ„ŸçŸ¥ã€‚å…¶å®ä¸ç„¶ï¼Œä½ æœ‰è¿™ç§é”™è§‰ï¼Œé‚£æ˜¯å› ä¸ºä½ å·¥ä½œåœ¨Springçš„<strong>è¥è¤“</strong>ä¸­ï¼Œä»è€Œè®©ä½ â€œ<strong>é«˜æ•æ— å¿§</strong>â€~ å…¶å®æˆ‘ä»¬çš„ä»£ç ä¸­è‚¯å®šè¢«æˆ‘ä»¬å†™äº†å¾ªç¯ä¾èµ–,æ¯”å¦‚åƒè¿™æ ·:</p><pre>@Servicepublic class AServiceImpl implements AService { @Autowired private BService bService; ...}@Servicepublic class BServiceImpl implements BService { @Autowired private AService aService; ...}</pre><p><strong>é€šè¿‡å®éªŒæ€»ç»“å‡º</strong>ï¼Œå‡ºç°ä½¿ç”¨@Asyncå¯¼è‡´å¾ªç¯ä¾èµ–é—®é¢˜çš„å¿…è¦æ¡ä»¶ï¼š</p><ul><li>å·²å¼€å¯@EnableAsyncçš„æ”¯æŒ</li><li>@Asyncæ³¨è§£æ‰€åœ¨çš„Beanè¢«å¾ªç¯ä¾èµ–äº†</li></ul><p><strong>å¥‡é‡äºŒ å¼‚æ­¥å¤±æ•ˆå¼‚å¸¸</strong></p><p>é‚£ä¹ˆæ—¢ç„¶ä¸èƒ½å¾ªç¯ä¾èµ–,æˆ‘ä»¬å°±ä¸å¾ªç¯ä¾èµ–,æˆ‘ä»¬è¿™ä¹ˆæ¥:</p><pre>@Servicepublic class UserServiceImpl implements UserService { @Autowired UserMapper userMapper; @Autowired SendService sendService;  @Override @Transactional() public int save(UserDTO userDTO) { User user = new User(); BeanCopyUtils.copy(userDTO, user); int insert = userMapper.insert(user); System.out.println("User ä¿å­˜ç”¨æˆ·æˆåŠŸ:" + user); this.senMsg(user); this.senEmail(user); return insert; } @Async @Override public Boolean senMsg(User user) { System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",æ‰‹æœºå·:" + user.getMobile() + "å‘é€çŸ­ä¿¡æˆåŠŸ"); return true; } @Async @Override public Boolean senEmail(User user) { System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",é‚®ç®±:" + user.getEmail() + "å‘é€é‚®ä»¶æˆåŠŸ"); return true; }</pre><p>ç»“æœæˆ‘ä»¬æµ‹è¯•äº†å‡ æŠŠ,æˆ‘æ‰“å°ä¸€ä¸‹ç»“æœ:</p><pre>2019-08-05 21:59:32.304 INFO 14360 --- [nio-8080-exec-3] com.alibaba.druid.pool.DruidDataSource : {dataSource-1} inited2019-08-05 21:59:32.346 DEBUG 14360 --- [nio-8080-exec-3] c.b.lea.mybot.mapper.UserMapper.insert : ==&gt; Preparing: insert into t_user (username, sex, mobile,email) values (?, ?, ?,?) 2019-08-05 21:59:32.454 DEBUG 14360 --- [nio-8080-exec-3] c.b.lea.mybot.mapper.UserMapper.insert : ==&gt; Parameters: ç‹éº»å­(String), ç”·(String), 18820158833(String), 22qq@qq.com(String)2019-08-05 21:59:32.463 DEBUG 14360 --- [nio-8080-exec-3] c.b.lea.mybot.mapper.UserMapper.insert : &lt;== Updates: 1User ä¿å­˜ç”¨æˆ·æˆåŠŸ:User(id=101, username=ç‹éº»å­, mobile=18820158833, email=22qq@qq.com, sex=ç”·, password=123435, createTime=Mon Aug 05 12:20:51 CST 2019, updateTime=null)å‘é€çŸ­ä¿¡ä¸­:.....http-nio-8080-exec-3ç»™ç”¨æˆ·id:101,æ‰‹æœºå·:18820158833å‘é€çŸ­ä¿¡æˆåŠŸå‘é€é‚®ä»¶ä¸­:.....http-nio-8080-exec-3ç»™ç”¨æˆ·id:101,é‚®ç®±:22qq@qq.comå‘é€é‚®ä»¶æˆåŠŸ</pre><p>è¿™ä¸ç™½çäº†å—?æ„ŸçŸ¥ä¸åˆ°æˆ‘çš„çˆ±,ç™½å†™äº†,éš¾å—~~çº¿ç¨‹ä¾ç„¶æ˜¯http-nio-8080-exec-3,é‚£ä¹ˆä¸ºä»€ä¹ˆäº†å‘¢? ä¸‹é¢ä¼šè®²çš„å“¦,å…ˆè¯´ç»“è®º:</p><p><strong>é€šè¿‡å®éªŒæ€»ç»“å‡º</strong>ï¼Œå‡ºç°ä½¿ç”¨@Asyncå¯¼è‡´å¼‚æ­¥å¤±æ•ˆçš„åŸå› ï¼š</p><ul><li>åœ¨æœ¬ç±»ä¸­ä½¿ç”¨äº†å¼‚æ­¥æ˜¯ä¸æ”¯æŒå¼‚æ­¥çš„</li><li>è°ƒç”¨è€…å…¶å®æ˜¯this,æ˜¯å½“å‰å¯¹è±¡,ä¸æ˜¯çœŸæ­£çš„ä»£ç†å¯¹è±¡userService,springæ— æ³•æˆªè·è¿™ä¸ªæ–¹æ³•è°ƒç”¨ æ‰€ä»¥ä¸åœ¨ä¸åœ¨æœ¬ç±»ä¸­å»è°ƒç”¨,ç½‘ä¸Šçš„è§£å†³æ–¹æ³•æœ‰applicationContext.getBean(UserService.class)å’ŒAopContext.currentProxy()</li></ul><p><strong>å¥‡é‡ä¸‰ äº‹åŠ¡å¤±æ•ˆå¼‚å¸¸</strong></p><p>é‚£ä¹ˆ,æ—¢ç„¶ä¸èƒ½ç”¨å½“å‰å¯¹è±¡,é‚£æˆ‘ä»¬ç”¨ä»£ç†,AopContext.currentProxy(),ç„¶é¹…,ä½ å‘ç°,æŠ¥é”™äº†,å¯¹Cannot find current proxy: Set 'exposeProxy' property on Advised to 'true' to make it available.å°±ä»–:</p><div class=pgc-img><img alt="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/412d5981a2be4f9182be7f899e5d94d2><p class=pgc-img-caption></p></div><p>ä½†æ˜¯ä½ å»ç½‘ä¸Šç™¾åº¦å°±ä¼šå‘ç°,éƒ½è¿™ä¹ˆæ</p><pre>@EnableAspectJAutoProxy(exposeProxy = true)</pre><p>æˆ‘ä¹Ÿè¿™ä¹ˆæ,ä½†æ˜¯åˆæŠ¥é”™äº†,ç»†ç»†çš„çœ‹æŠ¥é”™å†…å®¹,æ‰å‘ç°å°‘äº†ä¸ªjaråŒ…è¿™ä¸œè¥¿è¦é…åˆåˆ‡é¢ç»‡å…¥,è¦é…åˆ,æ‡‚å—?,æ¥ä¸ŠåŒ…</p><pre> &lt;!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt; &lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;/groupId&gt; &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt; &lt;version&gt;1.9.2&lt;/version&gt; &lt;/dependency&gt;</pre><p>å†æ¥çœ‹ä¸ºæ’’: è¿™æ˜¯ä¸€ä¸ªæ€§æ„Ÿçš„è¯é¢˜,exposeProxy = trueå®ƒçš„ä½œç”¨å°±æ˜¯<strong>å¯ç”¨åˆ‡é¢çš„è‡ªåŠ¨ä»£ç†</strong>,è¯´äººè¯å°±æ˜¯<strong>æš´éœ²å½“å‰ä»£ç†å¯¹è±¡åˆ°å½“å‰çº¿ç¨‹ç»‘å®š</strong>, çœ‹ä¸ªæŠ¥é”™Cannot find current proxy: Set 'exposeProxy' property on Advised to 'true' to make it available.å°±æ˜¯AopContextæå¾—é¬¼.</p><p>public final class AopContext {</p><p>private static final ThreadLocal&lt;Object> currentProxy = new NamedThreadLocal&lt;>("Current AOP proxy");</p><p>private AopContext() {</p><p>}</p><p>// è¯¥æ–¹æ³•æ˜¯public staticæ–¹æ³•ï¼Œè¯´æ˜å¯ä»¥è¢«ä»»æ„ç±»è¿›è¡Œè°ƒç”¨</p><p>public static Object currentProxy() throws IllegalStateException {</p><p>Object proxy = currentProxy.get();</p><p>// å®ƒæŠ›å‡ºå¼‚å¸¸çš„åŸå› æ˜¯å½“å‰çº¿ç¨‹å¹¶æ²¡æœ‰ç»‘å®šå¯¹è±¡</p><p>// è€Œç»™çº¿ç¨‹ç»‘å®šå¯¹è±¡çš„æ–¹æ³•åœ¨ä¸‹é¢ï¼šç‰¹åˆ«æœ‰æ„æ€çš„æ˜¯å®ƒçš„è®¿é—®æƒé™æ˜¯defaultçº§åˆ«ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½Springå†…éƒ¨å»è°ƒç”¨</p><p>if (proxy == null) {</p><p>throw new IllegalStateException("Cannot find current proxy: Set 'exposeProxy' property on Advised to 'true' to make it available.");</p><p>}</p><p>return proxy;</p><p>}</p><p>// å®ƒæœ€æœ‰æ„æ€çš„åœ°æ–¹æ˜¯å®ƒçš„è®¿é—®æƒé™æ˜¯defaultçš„ï¼Œè¡¨ç¤ºåªèƒ½ç»™Springå†…éƒ¨å»è°ƒç”¨</p><p>// è°ƒç”¨å®ƒçš„ç±»æœ‰CglibAopProxyå’ŒJdkDynamicAopProxy</p><p>@Nullable</p><p>static Object setCurrentProxy(@Nullable Object proxy) {</p><p>Object old = currentProxy.get();</p><p>if (proxy != null) {</p><p>currentProxy.set(proxy);</p><p>} else {</p><p>currentProxy.remove();</p><p>}</p><p>return old;</p><p>}</p><p>}</p><p>æ‰€ä»¥æˆ‘ä»¬è¦åšå¯ç”¨ä»£ç†è®¾ç½®,è®©ä»£ç†ç”Ÿæ•ˆ,æ¥èµ°èµ·,ä¸»çº¿ç¨‹çš„æ–¹æ³•ä½¿ç”¨æ¥è°ƒç”¨å¼‚æ­¥æ–¹æ³•,æ¥æµ‹è¯•èµ°èµ·: no code said niao:</p><pre>@Servicepublic class UserServiceImpl implements UserService { @Autowired UserMapper userMapper; @Override@Transactional(propagation = Propagation.REQUIRED) public int save(UserDTO userDTO) { User user = new User(); BeanCopyUtils.copy(userDTO, user); int insert = userMapper.insert(user); System.out.println("User ä¿å­˜ç”¨æˆ·æˆåŠŸ:" + user); UserService currentProxy = UserService.class.cast(AopContext.currentProxy()); currentProxy.senMsg(user); currentProxy.senEmail(user); int i = 1 / 0; return insert; } @Async @Override @Transactional(propagation = Propagation.REQUIRES_NEW) public void senMsg(User user) { user.setUsername(Thread.currentThread().getName()+"å‘çŸ­ä¿¡æµ‹è¯•äº‹åŠ¡...."+ new Random().nextInt()); userMapper.insert(user); System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",æ‰‹æœºå·:" + user.getMobile() + "å‘é€çŸ­ä¿¡æˆåŠŸ"); } @Async @Override @Transactional(propagation = Propagation.REQUIRES_NEW) public void senEmail(User user) { user.setUsername("å‘é‚®ä»¶æµ‹è¯•äº‹åŠ¡...."+ new Random().nextInt()); userMapper.insert(user); int i = 1 / 0; System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",é‚®ç®±:" + user.getEmail() + "å‘é€é‚®ä»¶æˆåŠŸ"); }} </pre><p>æµ‹è¯•ç»“æœ:</p><div class=pgc-img><img alt="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3f866b864cb644be946b2cde2f587dd3><p class=pgc-img-caption></p></div><p>å¦‚æˆ‘ä»¬æ‰€æ„¿,äº‹åŠ¡å’Œå¼‚æ­¥éƒ½ç”Ÿæ•ˆäº†</p><pre>1. å¼‚æ­¥çº¿ç¨‹SimpleAsyncTaskExecutor-1å’ŒSimpleAsyncTaskExecutor-2åˆ†åˆ«å‘çŸ­ä¿¡å’Œé‚®ä»¶,ä¸»çº¿ç¨‹ä¿å­˜ç”¨æˆ·2. å®é™…ç»“æœ,ä¸»çº¿ç¨‹ä¿å­˜çš„é‚£ä¸ªç”¨æˆ·å¤±è´¥,åå­—å«'å‘é€çŸ­ä¿¡'çš„ä¹Ÿä¿å­˜å¤±è´¥,åªæœ‰å«'å‘é‚®ä»¶'çš„ç”¨æˆ·æ’å…¥æˆåŠŸ3. é‚£ä¹ˆå°±åšåˆ°äº†äº‹åŠ¡çš„çº¿ç¨‹éš”ç¦»,äº‹åŠ¡çš„äº’ä¸å½±å“,å®Œç¾4. äº²,ä½ è¿™ä¹ˆå†™äº†å—?è¿™ä¹ˆå†™ä¸ä¼˜ç¾,è™½ç„¶æœ‰ç”¨,ä½†æ˜¯å†™çš„å¦è¾Ÿè¹Šå¾„å•Š</pre><p><strong>å¥‡é‡å›› å¼‚æ­¥åµŒå¥—å¼‚å¸¸</strong></p><p>æ¥,æˆ‘ä»¬çœ‹ä¸ªæ›´éªšæ°”çš„,å¼‚æ­¥ä¸­åµŒå¥—å¼‚æ­¥,æ¥ä¸Šcode:</p><pre>@Servicepublic class UserServiceImpl implements UserService { @Autowired UserMapper userMapper; @Override@Transactional(propagation = Propagation.REQUIRED) public int save(UserDTO userDTO) { User user = new User(); BeanCopyUtils.copy(userDTO, user); int insert = userMapper.insert(user); System.out.println("User ä¿å­˜ç”¨æˆ·æˆåŠŸ:" + user); UserService currentProxy = UserService.class.cast(AopContext.currentProxy()); currentProxy.send(user); return insert; } @Async @Override @Transactional(propagation = Propagation.REQUIRES_NEW) public void send(User user) { //å‘çŸ­ä¿¡ user.setUsername(Thread.currentThread().getName()+"å‘çŸ­ä¿¡æµ‹è¯•äº‹åŠ¡...."+ new Random().nextInt()); userMapper.insert(user); System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",æ‰‹æœºå·:" + user.getMobile() + "å‘é€çŸ­ä¿¡æˆåŠŸ"); //å‘é‚®ä»¶ UserService currentProxy = UserService.class.cast(AopContext.currentProxy()); currentProxy.senEmail(user); }  @Async @Override @Transactional(propagation = Propagation.REQUIRES_NEW) public void senEmail(User user) { user.setUsername("å‘é‚®ä»¶æµ‹è¯•äº‹åŠ¡...."+ new Random().nextInt()); userMapper.insert(user); System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",é‚®ç®±:" + user.getEmail() + "å‘é€é‚®ä»¶æˆåŠŸ"); }}</pre><p>çœ‹æˆ‘ä»¬çŒœä¸‹ç»“æœ? æ•°æ®åº“ä¼šæ–°å¢å‡ ä¸ªæ•°æ®?3ä¸ª?2ä¸ª?1ä¸ª?0ä¸ª?çº³å°¼æŠ¥é”™?</p><p>å“ˆå“ˆ``` ä¸Šç»“æœ:</p><div class=pgc-img><img alt="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/c410d8e4542447e299cb8c9aac2578e6><p class=pgc-img-caption></p></div><p><strong>ç­”æ¡ˆ</strong>:åªæœ‰ä¸€æ¡æ•°æ®ä¸»çº¿ç¨‹ä¿å­˜æˆåŠŸ,çŸ­ä¿¡å’Œé‚®ä»¶çš„æ’å…¥éƒ½å¤±è´¥äº†,æœ€ä¸»è¦çš„æ˜¯è¿˜æŠ¥é”™äº†,åˆæ˜¯é‚£ä¸ª~~~Set 'exposeProxy' property on Advised to 'true'ç£¨äººçš„å°å¦–ç²¾</p><p><strong>é€šè¿‡å®éªŒæ€»ç»“å‡º</strong>ï¼Œå‡ºç°å¯¼è‡´å¼‚æ­¥åµŒå¥—ä½¿ç”¨å¤±è´¥çš„åŸå› ï¼š</p><ul><li>åœ¨æœ¬ç±»ä¸­ä½¿ç”¨äº†å¼‚æ­¥åµŒå¥—å¼‚æ­¥æ˜¯ä¸æ”¯æŒçš„</li><li>è°ƒç”¨è€…å…¶å®è¢«ä»£ç†è¿‡ä¸€æ¬¡äº†,å†åµŒå¥—ä¼šå‡ºç°'äºŒæ¬¡ä»£ç†',å…¶å®æ˜¯è¾¾ä¸åˆ°ä»£ç†äº†æ•ˆæœ,å› ä¸ºå·²ç»å¼‚æ­¥äº†.å³æ—¶ä½ åœ¨åµŒå¥—ä¸­ä¸ä½¿ç”¨ä»£ç†å»è·å–,å³ä½¿ä¸ä¿å­˜,ä½†æ˜¯äº‹åŠ¡å’Œå¼‚æ­¥æ•ˆæœéƒ½ä¼šè·Ÿéšå½“å‰çš„ä»£ç†,å³åµŒå¥—çš„æ•ˆæœæ˜¯è¾¾ä¸åˆ°å†æ¬¡å¼‚æ­¥çš„.</li><li>è§£å†³åŠæ³•åº”è¯¥æœ‰,ä½†æ˜¯æˆ‘è§‰å¾—æˆ‘è¿˜æ²¡æ‰¾åˆ°.è¿™ä¸ªå†™æ³•æ˜¯æˆ‘ä»¬åº”è¯¥è§„é¿çš„,æˆ‘ä»¬åº”è¯¥éµå¾ªè§„èŒƒ,å¯ç”¨æ–°çš„æœåŠ¡ç±»å»å®Œæˆæˆ‘ä»¬çš„å¼‚æ­¥å·¥ä½œ</li></ul><p>ä¸‹é¢æˆ‘ä»¬ä¸¾ä¸ªæ —å­:æ­£ç¡®çš„å†™æ³•,ä¼˜é›…çš„å†™æ³•</p><pre>@Servicepublic class UserServiceImpl implements UserService { @Autowired UserMapper userMapper; @Autowired SendService sendService; @Override@Transactional(propagation = Propagation.REQUIRED) public int save(UserDTO userDTO) { User user = new User(); BeanCopyUtils.copy(userDTO, user); int insert = userMapper.insert(user); System.out.println("User ä¿å­˜ç”¨æˆ·æˆåŠŸ:" + user); sendService.senMsg(user); sendService.senEmail(user); return insert; }}---------------æ— è´£ä»»åˆ†å‰²çº¿--------------------@Servicepublic class SendServiceImpl implements SendService { @Override @Async @Transactional(propagation = Propagation.REQUIRES_NEW) public Boolean senMsg(User user) { try { TimeUnit.SECONDS.sleep(2); System.out.println("å‘é€çŸ­ä¿¡ä¸­:....."); } catch (InterruptedException e) { e.printStackTrace(); } int i = 1 / 0; System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",æ‰‹æœºå·:" + user.getMobile() + "å‘é€çŸ­ä¿¡æˆåŠŸ"); return true; } @Async @Override @Transactional(propagation = Propagation.REQUIRES_NEW) public Boolean senEmail(User user) { try { TimeUnit.SECONDS.sleep(3); System.out.println("å‘é€é‚®ä»¶ä¸­:....."); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",é‚®ç®±:" + user.getEmail() + "å‘é€é‚®ä»¶æˆåŠŸ"); return true; }}</pre><p>ç»“æœè‚¯å®šå®Œç¾:</p><div class=pgc-img><img alt="Springå¼‚æ­¥ç¼–ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å—ï¼Ÿå¼‚æ­¥å†é™©å¥‡é‡è®°" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8aaae381bb5f4a8cb5a6d47557519a76><p class=pgc-img-caption></p></div><p>å› æ­¤å½“ä½ çœ‹åˆ°ä½ åŒäº‹å°±åœ¨æœ¬ç±»å†™ä¸ªæ–¹æ³•æ ‡æ³¨ä¸Š@Asyncç„¶åè°ƒç”¨ï¼Œè¯·åˆ¶æ­¢ä»–å§ï¼Œåšçš„æ— ç”¨åŠŸ~~~ï¼ˆå…³é”®è‡ªå·±è¿˜ä»¥ä¸ºæœ‰ç”¨ï¼Œè¿™æ˜¯æœ€å¯æ€•çš„æ·±å‘~ï¼‰</p><p>é‚£æˆ‘è¡¥å……ç‚¹:@EnableAspectJAutoProxy(exposeProxy = true)çš„ä½œç”¨: æ­¤æ³¨è§£å®ƒå¯¼å…¥äº†AspectJAutoProxyRegistrarï¼Œæœ€ç»ˆè®¾ç½®æ­¤æ³¨è§£çš„ä¸¤ä¸ªå±æ€§çš„æ–¹æ³•ä¸ºï¼š</p><pre>public abstract class AopConfigUtils { ...æ­£åœ¨åŠ (sheng)è½½(lue)ä»£ç ä¸­ è¯·ç¨å....	public static void forceAutoProxyCreatorToUseClassProxying(BeanDefinitionRegistry registry) {		if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) {			BeanDefinition definition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);			definition.getPropertyValues().add("proxyTargetClass", Boolean.TRUE);		}	}	public static void forceAutoProxyCreatorToExposeProxy(BeanDefinitionRegistry registry) {		if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) {			BeanDefinition definition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);			definition.getPropertyValues().add("exposeProxy", Boolean.TRUE);		}	}}</pre><p>çœ‹åˆ°æ­¤æ³¨è§£æ ‡æ³¨çš„å±æ€§å€¼æœ€ç»ˆéƒ½è¢«è®¾ç½®åˆ°äº†internalAutoProxyCreatorèº«ä¸Šï¼Œä¹Ÿå°±æ˜¯å®ƒï¼š<strong>è‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨</strong>ã€‚ é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜æ™°çš„æ˜¯ï¼š@Asyncçš„ä»£ç†å¯¹è±¡å¹¶ä¸æ˜¯ç”±è‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨æ¥åˆ›å»ºçš„ï¼Œè€Œæ˜¯ç”±AsyncAnnotationBeanPostProcessorä¸€ä¸ªå•çº¯çš„BeanPostProcessorå®ç°çš„,å¾ˆæ˜¾ç„¶å½“æ‰§è¡ŒAopContext.currentProxy()è¿™å¥ä»£ç çš„æ—¶å€™æŠ¥é”™äº†ã€‚@EnableAsyncç»™å®¹å™¨æ³¨å…¥çš„æ˜¯AsyncAnnotationBeanPostProcessorï¼Œå®ƒç”¨äºç»™@Asyncç”Ÿæˆä»£ç†ï¼Œä½†æ˜¯å®ƒä»…ä»…æ˜¯ä¸ªBeanPostProcessorå¹¶ä¸å±äºè‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨ï¼Œå› æ­¤exposeProxy = trueå¯¹å®ƒæ— æ•ˆã€‚ æ‰€ä»¥AopContext.setCurrentProxy(proxy);è¿™ä¸ªsetæ–¹æ³•è‚¯å®šå°±ä¸ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥,å› æ­¤,ä½†å‡¡åªè¦ä¸šåŠ¡æ–¹æ³•ä¸­è°ƒç”¨AopContext.currentProxy()æ–¹æ³•å°±é“å®šæŠ›å¼‚å¸¸~~</p><p><strong>å¥‡é‡äº” åŸºæœ¬ç±»å‹å¼‚å¸¸</strong></p><p>çœ‹å˜›,å‘çŸ­ä¿¡å…¶å®æ˜¯ä¸€äº›ç½‘å…³è°ƒç”¨,æˆ‘æƒ³å†™ä¸ªçœ‹çŸ­ä¿¡,é‚®ä»¶å‘é€æˆåŠŸçš„æ ‡å¿—,æ˜¯å¦è°ƒç”¨æˆåŠŸçš„çŠ¶æ€,æ¥èµ°èµ·</p><pre>....çœç•¥...UserService---------------æ— è´£ä»»åˆ†å‰²çº¿--------------------@Servicepublic class SendServiceImpl implements SendService { @Override @Async @Transactional(propagation = Propagation.REQUIRES_NEW) public boolean senMsg(User user) { try { TimeUnit.SECONDS.sleep(2); System.out.println("å‘é€çŸ­ä¿¡ä¸­:....."); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",æ‰‹æœºå·:" + user.getMobile() + "å‘é€çŸ­ä¿¡æˆåŠŸ"); return true; } @Async @Override @Transactional(propagation = Propagation.REQUIRES_NEW) public boolean senEmail(User user) { try { TimeUnit.SECONDS.sleep(3); System.out.println("å‘é€é‚®ä»¶ä¸­:....."); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread().getName() + "ç»™ç”¨æˆ·id:" + user.getId() + ",é‚®ç®±:" + user.getEmail() + "å‘é€é‚®ä»¶æˆåŠŸ"); return true; }}</pre><p>çªå¤§çœ¼ç›çœ‹,æˆ‘çš„è¿”å›ç»“æœæ˜¯boolean,å±äºåŸºæœ¬ç±»å‹,è™½ç„¶æ²¡æœ‰ç”¨,ä½†æ˜¯æŠ¥é”™äº†:</p><pre>org.springframework.aop.AopInvocationException: Null return value from advice does not match primitive return type for: public boolean com.boot.lea.mybot.service.impl.SendServiceImpl.senMsg(com.boot.lea.mybot.entity.User)</pre><p>å¯¼è‡´æˆ‘çš„æ•°æ®åº“ä¸€æ¡æ•°æ®éƒ½æ²¡æœ‰,å½±å“åˆ°ä¸»çº¿ç¨‹äº†,å¯è§é—®é¢˜å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹<strong>è§¦å‘</strong>å¼‚æ­¥çº¿ç¨‹çš„æ—¶å€™,é‚£æˆ‘ä»¬æ‰¾åŸå› : æ˜¯èµ°ä»£ç†è§¦å‘çš„:æˆ‘å…ˆæ‰¾è¿™ä¸ªç±»CglibAopProxyå†é¡ºè—¤æ‘¸ç“œ</p><pre>/**	 * Process a return value. Wraps a return of {@code this} if necessary to be the	 * {@code proxy} and also verifies that {@code null} is not returned as a primitive.	 */	private static Object processReturnType(Object proxy, Object target, Method method, Object retVal) {		// Massage return value if necessary		if (retVal != null &amp;&amp; retVal == target &amp;&amp;				!RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) {			// Special case: it returned "this". Note that we can't help			// if the target sets a reference to itself in another returned object.			retVal = proxy;		}		Class&lt;?&gt; returnType = method.getReturnType();		if (retVal == null &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) {			throw new AopInvocationException(					"Null return value from advice does not match primitive return type for: " + method);		}		return retVal;	}</pre><p>åœ¨è¿™retVal == null && returnType != Void.TYPE && returnType.isPrimitive(),å› ä¸ºæˆ‘ä»¬çš„è¿™ç§å¼‚æ­¥å…¶å®æ˜¯ä¸æ”¯æŒå‹å¥½çš„è¿”å›ç»“æœçš„,æˆ‘ä»¬çš„ç»“æœåº”è¯¥æ˜¯void,å› ä¸ºè¿™ä¸ªå¼‚æ­¥çº¿ç¨‹è¢«ä¸»çº¿ç¨‹è§¦å‘åå…¶å®è¢«å½“åšä¸€ä¸ªä»»åŠ¡æäº¤åˆ°Springçš„å¼‚æ­¥çš„ä¸€ä¸ªçº¿ç¨‹æ± ä¸­è¿›è¡Œå¼‚æ­¥çš„å¤„ç†ä»»åŠ¡äº†,çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ˜¯ä¸èƒ½ä¹‹é—´è¿”å›çš„,å…¶å®ç”¨è¿™ç§å†™æ³•æˆ‘ä»¬å°±åº”è¯¥ç”¨voidå»å¼‚æ­¥æ‰§è¡Œ,ä¸è¦æœ‰è¿”å›å€¼,è€Œä¸”æˆ‘ä»¬çš„è¿”å›å€¼æ˜¯isPrimitive(),æ˜¯åŸºæœ¬ç±»å‹,åˆšå¥½è¾¾æ ‡....</p><p><strong>é‚£ä¹ˆæˆ‘å¤§å£°å–Šå‡º,ä½¿ç”¨å¼‚æ­¥çš„æ—¶å€™å°½é‡ä¸è¦æœ‰è¿”å›å€¼,å®åœ¨è¦æœ‰ä½ ä¹Ÿä¸èƒ½ç”¨åŸºæœ¬ç±»å‹.</strong></p><p><strong>å¥‡é‡å…­ è¿”å›å¼‚æ­¥ç»“æœ</strong></p><p>æœ‰äº›äººå°±æ˜¯éš¾å—,å°±æ˜¯æƒ³è¦è¿”å›ç»“æœ,é‚£ä¹ˆä¹Ÿæ˜¯å¯ä»¥æ»´:ä½†æ˜¯è¦å€ŸåŠ©Furtrueå°å§å§çš„get()æ¥è¿›è¡Œçº¿ç¨‹ä¹‹é—´çš„é˜»å¡é€šä¿¡,æ¯•ç«Ÿå°å§å§â„(â„ â„â€¢â„Ï‰â„â€¢â„ â„)â„å®³ç¾.</p><p>é…±ç´«å†™,ä½ å°±å¯ä»¥é˜»å¡ç­‰åˆ°æ‰§è¡Œä»»åŠ¡æœ‰ç»“æœçš„æ—¶å€™å»è·å–çœŸæ­£çš„ç»“æœäº†,è¿™ä¸ªå†™æ³•å’Œæˆ‘ä¹‹å‰çš„æ–‡ç« <strong>JAVAå¹¶å‘å¼‚æ­¥ç¼–ç¨‹ åŸæ¥åä¸ªæ¥å£çš„æ´»ç°åœ¨åªéœ€è¦ä¸€ä¸ªæ¥å£å°±æå®š!</strong><sup><strong>[2]</strong></sup>æ˜¯ä¸€æ ·çš„é“ç†äº†</p><pre>import com.boot.lea.mybot.service.AsyncService;import com.boot.lea.mybot.service.UserService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.scheduling.annotation.Async;import org.springframework.scheduling.annotation.AsyncResult;import org.springframework.stereotype.Service;@Service@Async("taskExecutor")public class AsyncServiceImpl implements AsyncService { @Autowired private UserService userService; @Override public Future&lt;Long&gt; queryUserMsgCount(final Long userId) { System.out.println("å½“å‰çº¿ç¨‹:" + Thread.currentThread().getName() + "=-=====queryUserMsgCount"); long countByUserId = userService.countMsgCountByUserId(userId); return new AsyncResult&lt;&gt;(countByUserId); } @Override public Future&lt;Long&gt; queryCollectCount(final Long userId) { System.out.println("å½“å‰çº¿ç¨‹:" + Thread.currentThread().getName() + "=-====queryCollectCount"); long collectCount = userService.countCollectCountByUserId(userId); return new AsyncResult&lt;&gt;(collectCount); }</pre><p><strong>ä½ éœ€è¦çŸ¥é“çš„ä¹å¤§å¼‚æ­¥æ³¨æ„äº‹é¡¹</strong></p><ol><li>å°½é‡ä¸è¦åœ¨æœ¬ç±»ä¸­å¼‚æ­¥è°ƒç”¨</li><li>å°½é‡ä¸è¦æœ‰è¿”å›å€¼</li><li>ä¸èƒ½ä½¿ç”¨æœ¬ç±»çš„ç§æœ‰æ–¹æ³•æˆ–è€…éæ¥å£åŒ–åŠ æ³¨@Async,å› ä¸ºä»£ç†ä¸åˆ°å¤±æ•ˆ</li><li>å¼‚æ­¥æ–¹æ³•ä¸èƒ½ä½¿ç”¨staticä¿®é¥°</li><li>å¼‚æ­¥ç±»æ²¡æœ‰ä½¿ç”¨@Componentæ³¨è§£ï¼ˆæˆ–å…¶ä»–æ³¨è§£ï¼‰å¯¼è‡´springæ— æ³•æ‰«æåˆ°å¼‚æ­¥ç±»</li><li>ç±»ä¸­éœ€è¦ä½¿ç”¨@Autowiredæˆ–@Resourceç­‰æ³¨è§£è‡ªåŠ¨æ³¨å…¥ï¼Œä¸èƒ½è‡ªå·±æ‰‹åŠ¨newå¯¹è±¡</li><li>å¦‚æœä½¿ç”¨SpringBootæ¡†æ¶å¿…é¡»åœ¨å¯åŠ¨ç±»ä¸­å¢åŠ @EnableAsyncæ³¨è§£</li><li>åœ¨è°ƒç”¨Asyncæ–¹æ³•çš„æ–¹æ³•ä¸Šæ ‡æ³¨@Transactionalæ˜¯ç®¡ç†è°ƒç”¨æ–¹æ³•çš„äº‹åŠ¡çš„</li><li>åœ¨Asyncæ–¹æ³•ä¸Šæ ‡æ³¨@Transactionalæ˜¯ç®¡ç†å¼‚æ­¥æ–¹æ³•çš„äº‹åŠ¡,äº‹åŠ¡å› çº¿ç¨‹éš”ç¦»</li></ol><p><strong>ä½ éœ€è¦æ‡‚çš„å¼‚æ­¥åŸç†</strong></p><p><strong>@Asyncçš„å¼‚æ­¥</strong>:</p><ul><li>å®é™…æ˜¯spring åœ¨æ‰«æbeançš„æ—¶å€™ä¼šæ‰«ææ–¹æ³•ä¸Šæ˜¯å¦åŒ…å«@Asyncçš„æ³¨è§£ï¼Œå¦‚æœåŒ…å«çš„ï¼Œspringä¼šä¸ºè¿™ä¸ªbeanåŠ¨æ€çš„ç”Ÿæˆä¸€ä¸ªå­ç±»ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä»£ç†ç±»(jdkProxy)ï¼Œ ä»£ç†ç±»æ˜¯ç»§æ‰¿æˆ‘ä»¬æ‰€å†™çš„beançš„ï¼Œç„¶åæŠŠä»£ç†ç±»æ³¨å…¥è¿›æ¥ï¼Œé‚£æ­¤æ—¶ï¼Œåœ¨æ‰§è¡Œæ­¤æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šåˆ°ä»£ç†ç±»ä¸­ï¼Œä»£ç†ç±»åˆ¤æ–­äº†æ­¤æ–¹æ³•éœ€è¦å¼‚æ­¥æ‰§è¡Œï¼Œå°±ä¸ä¼šè°ƒç”¨çˆ¶ç±» (æˆ‘ä»¬åŸæœ¬å†™çš„bean)çš„å¯¹åº”æ–¹æ³•ã€‚</li><li>springè‡ªå·±ç»´æŠ¤äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä»–ä¼šæŠŠéœ€è¦æ‰§è¡Œçš„æ–¹æ³•ï¼Œæ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…çº¿ç¨‹æ± å»è¯»å–è¿™ä¸ªé˜Ÿåˆ—ï¼Œå®Œæˆæ–¹æ³•çš„æ‰§è¡Œï¼Œ ä»è€Œå®Œæˆäº†å¼‚æ­¥çš„åŠŸèƒ½ã€‚</li><li>æˆ‘ä»¬å¯ä»¥å…³æ³¨åˆ°å†é…ç½®taskçš„æ—¶å€™ï¼Œæ˜¯æœ‰å‚æ•°è®©æˆ‘ä»¬é…ç½®çº¿ç¨‹æ± çš„æ•°é‡çš„ã€‚å› ä¸ºè¿™ç§å®ç°æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨åŒä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œæ·»åŠ @Asyncæ³¨è§£æ˜¯å¤±æ•ˆçš„ï¼ï¼ŒåŸå› æ˜¯å½“ä½ åœ¨åŒä¸€ä¸ªç±»ä¸­çš„æ—¶å€™ï¼Œæ–¹æ³•è°ƒç”¨æ˜¯åœ¨ç±»ä½“å†…æ‰§è¡Œçš„ï¼Œspringæ— æ³•æˆªè·è¿™ä¸ªæ–¹æ³•è°ƒç”¨(ä¸ºä»€ä¹ˆå‘¢,è¿™ä¸ªå°±æ˜¯ä¸‹æ–‡è®²çš„...å¥¸ç¬‘...å˜»å˜»å˜»å˜»...)ã€‚</li><li>é‚£åœ¨æ·±å…¥ä¸€æ­¥ï¼ŒSpringä¸ºæˆ‘ä»¬æä¾›äº†AOPï¼Œé¢å‘åˆ‡é¢çš„åŠŸèƒ½ã€‚ä»–çš„åŸç†å’Œå¼‚æ­¥æ³¨è§£çš„åŸç†æ˜¯ç±»ä¼¼çš„ï¼Œspringåœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™ï¼Œä¼šæ‰«æåˆ‡é¢æ‰€å®šä¹‰çš„ ç±»ã€‚åœ¨è¿™äº›ç±»è¢«æ³¨å…¥çš„æ—¶å€™ï¼Œæ‰€æ³¨å…¥çš„ä¹Ÿæ˜¯ä»£ç†ç±»ï¼Œå½“ä½ è°ƒç”¨è¿™äº›æ–¹æ³•çš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šæ˜¯è°ƒç”¨çš„ä»£ç†ç±»ã€‚é€šè¿‡ä»£ç†ç±»å†å»æ‰§è¡Œçˆ¶ç±»ç›¸å¯¹åº”çš„æ–¹æ³•ï¼Œé‚£springåªéœ€è¦åœ¨è°ƒç”¨ä¹‹å‰å’Œä¹‹åæ‰§è¡ŒæŸæ®µä»£ç å°±å®Œæˆäº†AOPçš„å®ç°äº†ï¼</li></ul><p>SpringBootç¯å¢ƒä¸­ï¼Œè¦ä½¿ç”¨@Asyncæ³¨è§£,æˆ‘ä»¬éœ€è¦å…ˆåœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š@EnableAsyncæ³¨è§£ã€‚è¿™ä¸ªä¸åœ¨SpringBootä¸­ä½¿ç”¨@Scheduledæ³¨è§£éœ€è¦åœ¨å¯åŠ¨ç±»ä¸­åŠ ä¸Š@EnableSchedulingæ˜¯ä¸€æ ·çš„é“ç†ï¼ˆå½“ç„¶ä½ ä½¿ç”¨å¤è€çš„XMLé…ç½®ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯åœ¨SpringBootç¯å¢ƒä¸­ï¼Œå»ºè®®çš„æ˜¯å…¨æ³¨è§£å¼€å‘ï¼‰ï¼Œå…·ä½“åŸç†ä¸‹é¢ä¼šåˆ†æã€‚åŠ ä¸Š@EnableAsyncæ³¨è§£åï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨è°ƒç”¨ä¸€ä¸ªæ–¹æ³•çš„æ—¶å€™å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹å¼€å§‹å¼‚æ­¥æ“ä½œï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸ŠåŠ ä¸Š@Asyncæ³¨è§£ï¼Œå½“ç„¶å‰ææ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•æ‰€åœ¨çš„ç±»å¿…é¡»åœ¨Springç¯å¢ƒä¸­ã€‚</p><pre>ç¤ºä¾‹:éspingbooté¡¹ç›®&lt;task:annotation-driven executor="annotationExecutor" /&gt;&lt;!-- æ”¯æŒ @Async æ³¨è§£ --&gt;&lt;task:executor id="annotationExecutor" pool-size="20"/&gt;</pre><p>æ‰§è¡Œæµç¨‹:</p><ol><li>æ‰«ææ˜¯å¦å¼€å¯æ³¨è§£EnableAsync,@EnableAsyncæ³¨è§£ä¸Šæœ‰ä¸ª@Import(AsyncConfigurationSelector.class),springbootçš„æ³¨å…¥è€å¥—è·¯äº†</li><li>è¯·æ‚¨å†ç§»æ­¥AsyncConfigurationSelector,çœ‹åˆ°selectImportsæ–¹æ³•äº†æ²¡,è¿™é‡Œä½¿ç”¨çš„æ˜¯é»˜è®¤ä½¿ç”¨çš„æ˜¯ProxyAsyncConfigurationè¿™ä¸ªé…ç½®ç±»</li><li>ç»§ç»­è§‚æ‘©ProxyAsyncConfigurationç»§æ‰¿AbstractAsyncConfiguration,å®ƒé‡Œé¢çš„çš„setConfigurersè¯´æ˜äº†æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°AsyncConfigureræ¥å£æ¥å®Œæˆçº¿ç¨‹æ± ä»¥åŠå¼‚å¸¸å¤„ç†å™¨çš„é…ç½®,è€Œä¸”åœ¨Springç¯å¢ƒä¸­åªèƒ½é…ç½®ä¸€ä¸ªå®ç°ç±»ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ ä¸Šä¸€ç‚¹ä»£ç :</li></ol><pre> /**	 * Collect any {@link AsyncConfigurer} beans through autowiring.	 */	@Autowired(required = false)	void setConfigurers(Collection&lt;AsyncConfigurer&gt; configurers) { 		if (CollectionUtils.isEmpty(configurers)) {			return;		} //AsyncConfigurerç”¨æ¥é…ç½®çº¿ç¨‹æ± é…ç½®ä»¥åŠå¼‚å¸¸å¤„ç†å™¨ï¼Œè€Œä¸”åœ¨Springç¯å¢ƒä¸­æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çŸ¥é“äº†ï¼Œå¦‚æœæƒ³è¦è‡ªå·±å»é…ç½®çº¿ç¨‹æ± ï¼Œåªéœ€è¦å®ç°AsyncConfigureræ¥å£ï¼Œå¹¶ä¸”ä¸å¯ä»¥åœ¨Springç¯å¢ƒä¸­æœ‰å¤šä¸ªå®ç°AsyncConfigurerçš„ç±»ã€‚		if (configurers.size() &gt; 1) {			throw new IllegalStateException("Only one AsyncConfigurer may exist");		}		AsyncConfigurer configurer = configurers.iterator().next();		this.executor = configurer.getAsyncExecutor();		this.exceptionHandler = configurer.getAsyncUncaughtExceptionHandler();	}</pre><ol><li>ProxyAsyncConfigurationæ³¨å…¥çš„bean AsyncAnnotationBeanPostProcessor,è¿™ä¸ªBeanPostBeanPostProcessorå¾ˆæ˜¾ç„¶ä¼šå¯¹å¸¦æœ‰èƒ½å¤Ÿå¼•å‘å¼‚æ­¥æ“ä½œçš„æ³¨è§£ï¼ˆæ¯”å¦‚@Asyncï¼‰çš„Beanè¿›è¡Œå¤„ç†</li><li>æˆ‘ä»¬æ³¨æ„åˆ°AsyncAnnotationBeanPostProcessoræœ‰é‡å†™çˆ¶ç±»çš„setBeanFactoryï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯æœ‰ç‚¹ç†Ÿæ‚‰å‘¢ï¼Œå®ƒæ˜¯BeanFactoryAwareæ¥å£ä¸­çš„æ–¹æ³•ï¼ŒAsyncAnnotationBeanPostProcessorçš„çˆ¶ç±»å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œåœ¨æˆ‘ä»¬å¾ˆä¹…ä¹‹å‰åˆ†æè¿‡çš„Beançš„åˆå§‹åŒ–ä¸­ï¼Œæ˜¯æœ‰æåˆ°è¿‡è¿™ä¸ªæ¥å£çš„ï¼Œå®ç°äº†Awareç±»å‹æ¥å£çš„Beanï¼Œä¼šåœ¨åˆå§‹åŒ–Beançš„æ—¶å€™è°ƒç”¨ç›¸åº”çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹AbstractAutowireCapableBeanFactory#initializeBean(final String beanName, final Object bean, RootBeanDefinition mbd)æ–¹æ³•</li><li>å¤„ç†Beançš„postProcessAfterInitializationæ–¹æ³•åœ¨ç¥–å…ˆç±»AbstractAdvisingBeanPostProcessorä¸­ã€‚ä»æºç ä¸­å¯ä»¥çœ‹åˆ°ã€‚AsyncAnnotationBeanPostProcessoræ˜¯å¯¹Beanè¿›è¡Œåç½®å¤„ç†çš„BeanPostProcessor</li><li>æœ€åä»£ç†åˆ°JdkDynamicAopProxyçš„invokeæ–¹æ³•ä¸­,æ˜¯ç”¨äº†è´£ä»»é“¾æ¨¡å¼:List&lt;Object> chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);,å°†ä»£ç†è¿›è¡Œæ‹¦æˆªæ¥æ‰§è¡Œ,é€šçŸ¥é“¾ä¼šåŒ…å«setBeanFactory()æ–¹æ³•ç”Ÿæˆçš„é€šçŸ¥,æ‰§è¡Œé“¾ä¼šç”¨äºåˆ›å»ºReflectiveMethodInvocationå¯¹è±¡ï¼Œæœ€ç»ˆæ˜¯è°ƒç”¨ReflectiveMethodInvocationçš„proceed()æ¥å®Œæˆå¯¹æ–¹æ³•çš„å¢å¼ºå¤„ç†,proceed()æ–¹æ³•åœ¨è¿™é‡Œä¼šæ‰§è¡Œæœ€åä¸€ä¸ªåˆ†æ”¯</li><li>å…·ä½“æ‰§è¡Œçš„æ˜¯AsyncExecutionInterceptorçš„invoke()</li><li><strong>æ³¨æ„</strong>:è™½ç„¶ä¸Šæ–‡Springç¯å¢ƒä¸­åªèƒ½æœ‰ä¸€ä¸ªAsyncConfigurerå®ç°ç±»ï¼Œä½†æ˜¯ä¸æ„å‘³ç€ï¼Œåœ¨Springç¯å¢ƒä¸­åªèƒ½é…ç½®ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œåœ¨Springç¯å¢ƒä¸­æ˜¯å¯ä»¥é…ç½®å¤šä¸ªçº¿ç¨‹æ± ï¼Œè€Œä¸”æˆ‘ä»¬å¯ä»¥åœ¨ä½¿ç”¨@Asyncæ³¨è§£è¿›è¡Œå¼‚æ­¥æ“ä½œçš„æ—¶å€™ï¼Œé€šè¿‡åœ¨valueå±æ€§ä¸ŠæŒ‡å®šçº¿ç¨‹æ± BeanName,è¿™æ ·å°±å¯ä»¥æŒ‡å®šç›¸åº”çš„çº¿ç¨‹æ± æ¥ä½œä¸ºä»»åŠ¡çš„è½½ä½“,å‚è§:determineAsyncExecutor</li></ol><p><strong>å°ç»“å…„å¼Ÿ:</strong></p><p>å½“æˆ‘ä»¬æƒ³è¦åœ¨SpringBootä¸­æ–¹ä¾¿çš„ä½¿ç”¨@Asyncæ³¨è§£å¼€å¯å¼‚æ­¥æ“ä½œçš„æ—¶å€™ï¼Œåªéœ€è¦å®ç°AsyncConfigureræ¥å£ï¼ˆè¿™æ ·å°±é…ç½®äº†é»˜è®¤çº¿ç¨‹æ± é…ç½®ï¼Œå½“ç„¶è¯¥ç±»éœ€è¦åœ¨Springç¯å¢ƒä¸­ï¼Œå› ä¸ºæ˜¯é»˜è®¤çš„ï¼Œæ‰€ä»¥åªèƒ½æœ‰ä¸€ä¸ªï¼Œæ²¡æœ‰å¤šä¸ªå®ç°ç±»æ’ä¼˜å…ˆçº§çš„è¯´æ³•ï¼‰ï¼Œå®ç°å¯¹çº¿ç¨‹æ± çš„é…ç½®ï¼Œå¹¶åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š@EnableAsyncæ³¨è§£ï¼Œå³å¯ä½¿å¾—@Asyncæ³¨è§£ç”Ÿæ•ˆã€‚</p><p>æˆ‘ä»¬ç”šè‡³å¯ä»¥ä¸æ˜¾å¼çš„å®ç°AsyncConfigurerï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Springç¯å¢ƒä¸­é…ç½®å¤šä¸ªExecutorç±»å‹çš„Beanï¼Œåœ¨ä½¿ç”¨@Asyncæ³¨è§£æ—¶ï¼Œå°†æ³¨è§£çš„valueæŒ‡å®šä¸ºä½ Executorç±»å‹çš„BeanNameï¼Œå°±å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± æ¥ä½œä¸ºä»»åŠ¡çš„è½½ä½“ï¼Œè¿™æ ·å°±ä½¿ç”¨çº¿ç¨‹æ± ä¹Ÿæ›´åŠ çµæ´»ã€‚</p><p><strong>å‚è€ƒèµ„æ–™</strong></p><p>[1]</p><p>ä½ çš„@Asyncå°±çœŸçš„å¼‚æ­¥å— â˜ å¼‚æ­¥å†é™©å¥‡é‡è®°: <em>https://juejin.im/post/5d47a80a6fb9a06ad3470f9a</em></p><p>[2]</p><p>JAVAå¹¶å‘å¼‚æ­¥ç¼–ç¨‹ åŸæ¥åä¸ªæ¥å£çš„æ´»ç°åœ¨åªéœ€è¦ä¸€ä¸ªæ¥å£å°±æå®š!: <em>https://juejin.im/post/5d3c46d2f265da1b9163dbce</em></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'å¼‚æ­¥','Spring','ç¼–ç¨‹'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>