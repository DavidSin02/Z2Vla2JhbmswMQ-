<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>æœ‰ä¸€è¯´ä¸€ï¼SpringAOP+æºç è§£æï¼Œåˆ‡å°±å®Œäº‹äº† | æå®¢å¿«è¨Š</title><meta property="og:title" content="æœ‰ä¸€è¯´ä¸€ï¼SpringAOP+æºç è§£æï¼Œåˆ‡å°±å®Œäº‹äº† - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/965c060c22b942c1a3a9f143215f114c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4d741bce.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4d741bce.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4d741bce.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4d741bce.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4d741bce.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4d741bce.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4d741bce.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4d741bce.html><meta property="article:published_time" content="2020-11-14T21:04:29+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:29+08:00"><meta name=Keywords content><meta name=description content="æœ‰ä¸€è¯´ä¸€ï¼SpringAOP+æºç è§£æï¼Œåˆ‡å°±å®Œäº‹äº†"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/4d741bce.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>æœ‰ä¸€è¯´ä¸€ï¼SpringAOP+æºç è§£æï¼Œåˆ‡å°±å®Œäº‹äº†</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>ä¸€ã€AOPã€SpringAOPã€AspectJçš„åŒºåˆ«</h1><p>AOPä¸ºAspect Oriented Programmingçš„ç¼©å†™ï¼Œæ„ä¸ºï¼š<strong>é¢å‘åˆ‡é¢ç¼–ç¨‹</strong>ï¼Œé€šè¿‡<strong>é¢„ç¼–è¯‘æ–¹å¼å’Œè¿è¡ŒæœŸé—´åŠ¨æ€ä»£ç†</strong>å®ç°ç¨‹åºåŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤çš„ä¸€ç§æŠ€æœ¯ã€‚åˆ©ç”¨AOPå¯ä»¥<strong>å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»</strong>ï¼Œä»è€Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚</p><p>æ–‡æœ‰æ–‡çš„ï¼Œæ²¡ç”¨è¿‡ç¡®å®å¾ˆæ‡µï¼Œä½†æ˜¯ç”¨è¿‡ä¹‹åï¼Œä¸è¯´æ¸…æ™°ï¼Œèµ·ç æœ‰ç‚¹æ„æ€äº†ã€‚</p><blockquote><p>Spring AOPï¼š</p><p>å®ƒåŸºäºåŠ¨æ€ä»£ç†æ¥å®ç°ã€‚é»˜è®¤çš„ï¼Œå¦‚æœä½¿ç”¨æ¥å£çš„ï¼Œç”¨ JDK æä¾›çš„åŠ¨æ€ä»£ç†å®ç°ï¼Œå¦‚æœæ²¡æœ‰æ¥å£ï¼Œä½¿ç”¨ CGLIB å®ç°ã€‚å¤§å®¶ä¸€å®šè¦æ˜ç™½èƒŒåçš„æ„æ€ï¼ŒåŒ…æ‹¬ä»€ä¹ˆæ—¶å€™ä¼šä¸ç”¨ JDK æä¾›çš„åŠ¨æ€ä»£ç†ï¼Œè€Œç”¨ CGLIB å®ç°ã€‚Spring 3.2 ä»¥åï¼Œspring-core ç›´æ¥å°±æŠŠ CGLIB å’Œ ASM çš„æºç åŒ…æ‹¬è¿›æ¥äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸éœ€è¦æ˜¾å¼å¼•å…¥è¿™ä¸¤ä¸ªä¾èµ–Spring çš„ IOC å®¹å™¨å’Œ AOP éƒ½å¾ˆé‡è¦ï¼ŒSpring AOP éœ€è¦ä¾èµ–äº IOC å®¹å™¨æ¥ç®¡ç†ã€‚å¦‚æœä½ æ˜¯ web å¼€å‘è€…ï¼Œæœ‰äº›æ—¶å€™ï¼Œä½ å¯èƒ½éœ€è¦çš„æ˜¯ä¸€ä¸ª Filter æˆ–ä¸€ä¸ª Interceptorï¼Œè€Œä¸ä¸€å®šæ˜¯ AOPã€‚Spring AOP åªèƒ½ä½œç”¨äº Spring å®¹å™¨ä¸­çš„ Beanï¼Œå®ƒæ˜¯ä½¿ç”¨çº¯ç²¹çš„ Java ä»£ç å®ç°çš„ï¼Œåªèƒ½ä½œç”¨äº bean çš„æ–¹æ³•ã€‚Spring æä¾›äº† AspectJ çš„æ”¯æŒï¼Œåé¢æˆ‘ä»¬ä¼šå•ç‹¬ä»‹ç»æ€ä¹ˆä½¿ç”¨ï¼Œä¸€èˆ¬æ¥è¯´æˆ‘ä»¬ç”¨çº¯çš„ Spring AOP å°±å¤Ÿäº†ã€‚å¾ˆå¤šäººä¼šå¯¹æ¯” Spring AOP å’Œ AspectJ çš„æ€§èƒ½ï¼ŒSpring AOP æ˜¯åŸºäºä»£ç†å®ç°çš„ï¼Œåœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™éœ€è¦ç”Ÿæˆä»£ç†å®ä¾‹ï¼Œåœ¨æ–¹æ³•è°ƒç”¨ä¸Šä¹Ÿä¼šå¢åŠ æ ˆçš„æ·±åº¦ï¼Œä½¿å¾— Spring AOP çš„æ€§èƒ½ä¸å¦‚ AspectJ é‚£ä¹ˆå¥½ã€‚</p><p>AspectJï¼š</p><p>AspectJ å‡ºèº«ä¹Ÿæ˜¯åé—¨ï¼Œæ¥è‡ªäº Eclipse åŸºé‡‘ä¼šï¼Œlinkï¼šhttps://www.eclipse.org/aspectj</p><p>å±äºé™æ€æ¤å…¥ï¼Œå®ƒæ˜¯é€šè¿‡ä¿®æ”¹ä»£ç æ¥å®ç°çš„ï¼Œå®ƒçš„æ¤å…¥æ—¶æœºå¯ä»¥æ˜¯ï¼š</p><p>Compile-time weavingï¼šç¼–è¯‘æœŸç»‡å…¥ï¼Œå¦‚ç±» A ä½¿ç”¨ AspectJ æ·»åŠ äº†ä¸€ä¸ªå±æ€§ï¼Œç±» B å¼•ç”¨äº†å®ƒï¼Œè¿™ä¸ªåœºæ™¯å°±éœ€è¦ç¼–è¯‘å™¨çš„æ—¶å€™å°±è¿›è¡Œæ¤å…¥ï¼Œå¦åˆ™æ²¡æ³•ç¼–è¯‘ç±» Bã€‚Post-compile weavingï¼šä¹Ÿå°±æ˜¯å·²ç»ç”Ÿæˆäº† .class æ–‡ä»¶ï¼Œæˆ–å·²ç»è¾¾æˆ jar åŒ…äº†ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬éœ€è¦å¢å¼ºå¤„ç†çš„è¯ï¼Œå°±è¦ç”¨åˆ°ç¼–è¯‘åç»‡å…¥ã€‚Load-time weavingï¼šæŒ‡çš„æ˜¯åœ¨åŠ è½½ç±»çš„æ—¶å€™è¿›è¡Œç»‡å…¥ï¼Œè¦å®ç°è¿™ä¸ªæ—¶æœŸçš„ç»‡å…¥ï¼Œæœ‰å‡ ç§å¸¸è§çš„æ–¹æ³•ã€‚1ã€è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å¹²è¿™ä¸ªï¼Œè¿™ä¸ªåº”è¯¥æ˜¯æœ€å®¹æ˜“æƒ³åˆ°çš„åŠæ³•ï¼Œåœ¨è¢«ç»‡å…¥ç±»åŠ è½½åˆ° JVM å‰å»å¯¹å®ƒè¿›è¡ŒåŠ è½½ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åŠ è½½çš„æ—¶å€™å®šä¹‰è¡Œä¸ºäº†ã€‚2ã€åœ¨ JVM å¯åŠ¨çš„æ—¶å€™æŒ‡å®š AspectJ æä¾›çš„ agentï¼š-javaagent:xxx/xxx/aspectjweaver.jarã€‚</p><p>AspectJ èƒ½å¹²å¾ˆå¤š Spring AOP å¹²ä¸äº†çš„äº‹æƒ…ï¼Œå®ƒæ˜¯ AOP ç¼–ç¨‹çš„å®Œå…¨è§£å†³æ–¹æ¡ˆã€‚Spring AOP è‡´åŠ›äºè§£å†³çš„æ˜¯ä¼ä¸šçº§å¼€å‘ä¸­æœ€æ™®éçš„ AOP éœ€æ±‚ï¼ˆæ–¹æ³•ç»‡å…¥ï¼‰ï¼Œè€Œä¸æ˜¯åŠ›æ±‚æˆä¸ºä¸€ä¸ªåƒ AspectJ ä¸€æ ·çš„ AOP ç¼–ç¨‹å®Œå…¨è§£å†³æ–¹æ¡ˆã€‚</p><p>å› ä¸º AspectJ åœ¨å®é™…ä»£ç è¿è¡Œå‰å®Œæˆäº†æ¤å…¥ï¼Œæ‰€ä»¥å¤§å®¶ä¼šè¯´å®ƒç”Ÿæˆçš„ç±»æ˜¯æ²¡æœ‰é¢å¤–è¿è¡Œæ—¶å¼€é”€çš„ã€‚</p></blockquote><h1 class=pgc-h-arrow-right><strong>äºŒã€AOPå…³é”®æœ¯è¯­</strong></h1><div class=pgc-img><img alt=æœ‰ä¸€è¯´ä¸€ï¼SpringAOP+æºç è§£æï¼Œåˆ‡å°±å®Œäº‹äº† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/965c060c22b942c1a3a9f143215f114c><p class=pgc-img-caption></p></div><ul><li>åˆ‡é¢ï¼ˆAspectï¼‰ï¼šä¹Ÿå°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„ä¸“æ³¨äºæä¾›è¾…åŠ©åŠŸèƒ½çš„æ¨¡å—ï¼Œæ¯”å¦‚å®‰å…¨ç®¡ç†ï¼Œæ—¥å¿—ä¿¡æ¯ç­‰ã€‚</li><li>è¿æ¥ç‚¹ï¼ˆJoinPointï¼‰ï¼šåˆ‡é¢ä»£ç å¯ä»¥é€šè¿‡è¿æ¥ç‚¹åˆ‡å…¥åˆ°æ­£å¸¸ä¸šåŠ¡ä¹‹ä¸­ï¼Œå›¾ä¸­æ¯ä¸ªæ–¹æ³•çš„æ¯ä¸ªç‚¹éƒ½æ˜¯è¿æ¥ç‚¹ã€‚</li><li>åˆ‡å…¥ç‚¹ï¼ˆPointCutï¼‰ï¼šä¸€ä¸ªåˆ‡é¢ä¸éœ€è¦é€šçŸ¥æ‰€æœ‰çš„è¿æ¥ç‚¹ï¼Œè€Œ<strong>åœ¨è¿æ¥ç‚¹çš„åŸºç¡€ä¹‹ä¸Šå¢åŠ åˆ‡å…¥çš„è§„åˆ™</strong>ï¼Œé€‰æ‹©éœ€è¦å¢å¼ºçš„ç‚¹ï¼Œæœ€ç»ˆçœŸæ­£é€šçŸ¥çš„ç‚¹å°±æ˜¯åˆ‡å…¥ç‚¹ã€‚</li><li>é€šçŸ¥æ–¹æ³•ï¼ˆAdviceï¼‰ï¼šå°±æ˜¯åˆ‡é¢éœ€è¦æ‰§è¡Œçš„å·¥ä½œï¼Œä¸»è¦æœ‰äº”ç§é€šçŸ¥ï¼šbeforeï¼Œafterï¼ŒafterReturningï¼ŒafterThrowingï¼Œaroundã€‚</li><li>ç»‡å…¥ï¼ˆWeavingï¼‰ï¼šå°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡å¹¶åˆ›å»ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ï¼ŒSpringAOPé€‰æ‹©åœ¨ç›®æ ‡å¯¹è±¡çš„è¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºä»£ç†å¯¹</li><li>å¼•å…¥ï¼ˆintroductionï¼‰ï¼šåœ¨ä¸ä¿®æ”¹ä»£ç çš„å‰æä¸‹ï¼Œå¼•å…¥å¯ä»¥åœ¨è¿è¡ŒæœŸä¸ºç±»åŠ¨æ€åœ°æ·»åŠ æ–¹æ³•æˆ–å­—æ®µã€‚</li></ul><h1 class=pgc-h-arrow-right><strong>ä¸‰ã€é€šçŸ¥çš„äº”ç§ç±»å‹</strong></h1><ul><li>å‰ç½®é€šçŸ¥Beforeï¼šç›®æ ‡æ–¹æ³•è°ƒç”¨ä¹‹å‰æ‰§è¡Œçš„é€šçŸ¥ã€‚</li><li>åç½®é€šçŸ¥Afterï¼šç›®æ ‡æ–¹æ³•å®Œæˆä¹‹åï¼Œæ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œçš„é€šçŸ¥ã€‚</li><li>è¿”å›é€šçŸ¥AfterReturningï¼šç›®æ ‡æ–¹æ³•æˆåŠŸä¹‹åè°ƒç”¨çš„é€šçŸ¥ã€‚</li><li>å¼‚å¸¸é€šçŸ¥AfterThrowingï¼šç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ä¹‹åè°ƒç”¨çš„é€šçŸ¥ã€‚</li><li>ç¯ç»•é€šçŸ¥Aroundï¼šå¯ä»¥çœ‹ä½œå‰é¢å››ç§é€šçŸ¥çš„ç»¼åˆã€‚</li></ul><h1 class=pgc-h-arrow-right><strong>å››ã€åˆ‡å…¥ç‚¹è¡¨è¾¾å¼</strong></h1><p>ä¸Šé¢æåˆ°ï¼šè¿æ¥ç‚¹å¢åŠ åˆ‡å…¥è§„åˆ™å°±ç›¸å½“äºå®šä¹‰äº†åˆ‡å…¥ç‚¹ï¼Œå½“ç„¶åˆ‡å…¥ç‚¹è¡¨è¾¾å¼åˆ†ä¸ºä¸¤ç§ï¼šwithinå’Œexecutionï¼Œè¿™é‡Œä¸»è¦å­¦ä¹ executionè¡¨è¾¾å¼ã€‚</p><ul><li>å†™æ³•ï¼šexecution(è®¿é—®ä¿®é¥°ç¬¦ è¿”å›å€¼ åŒ…å.åŒ…åâ€¦â€¦ç±»å.æ–¹æ³•å(å‚æ•°åˆ—è¡¨))</li><li>ä¾‹ï¼šexecution(public void com.smday.service.impl.AccountServiceImpl.saveAccount())</li><li>è®¿é—®ä¿®é¥°ç¬¦å¯ä»¥çœç•¥ï¼Œè¿”å›å€¼å¯ä»¥ä½¿ç”¨é€šé…ç¬¦*åŒ¹é…ã€‚</li><li>åŒ…åä¹Ÿå¯ä»¥ä½¿ç”¨*åŒ¹é…ï¼Œæ•°é‡ä»£è¡¨åŒ…çš„å±‚çº§ï¼Œå½“å‰åŒ…å¯ä»¥ä½¿ç”¨..æ ‡è¯†ï¼Œä¾‹å¦‚* *..AccountServiceImpl.saveAccount()</li><li>ç±»åå’Œæ–¹æ³•åä¹Ÿéƒ½å¯ä»¥ä½¿ç”¨*åŒ¹é…ï¼š* *..*.*()</li><li>å‚æ•°åˆ—è¡¨ä½¿ç”¨..å¯ä»¥æ ‡è¯†æœ‰æ— å‚æ•°å‡å¯ï¼Œä¸”å‚æ•°å¯ä¸ºä»»æ„ç±»å‹ã€‚</li></ul><blockquote><p>å…¨é€šé…å†™æ³•ï¼š* *â€¦*.*(â€¦)</p></blockquote><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œåˆ‡å…¥ç‚¹åº”å½“è®¾ç½®åœ¨ä¸šåŠ¡å±‚å®ç°ç±»ä¸‹çš„æ‰€æœ‰æ–¹æ³•ï¼š* com.smday.service.impl.*.*(..)ã€‚</p><h1 class=pgc-h-arrow-right><strong>äº”ã€AOPåº”ç”¨åœºæ™¯</strong></h1><ul><li>è®°å½•æ—¥å¿—</li><li>ç›‘æ§æ€§èƒ½</li><li>æƒé™æ§åˆ¶</li><li>äº‹åŠ¡ç®¡ç†</li></ul><h1 class=pgc-h-arrow-right><strong>å…­ã€AOPæºç åˆ†æ</strong></h1><h1 class=pgc-h-arrow-right><strong>SpringBeançš„ç”Ÿå‘½å‘¨æœŸ</strong></h1><p>å†™äº†å¥½å¤šç¯‡æ–‡ç« ï¼Œæ¯æ¬¡éƒ½è¦æ¥å›é¡¾ä¸€ä¸‹SpringBeançš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯è§å®ƒçœŸçš„ååˆ†é‡è¦ã€‚</p><ul><li>Springçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚</li><li>Springè§£å†³å¾ªç¯ä¾èµ–ï¼Œå¯¹å®ä¾‹åŒ–ä¹‹åï¼Œåˆå§‹åŒ–ä¹‹å‰åŠ¨äº†æ‰‹è„šã€‚</li></ul><p>Springçš„Aopåˆæ˜¯åœ¨å“ªå®Œæˆçš„å¯¹ç›®æ ‡å¯¹è±¡çš„ä»£ç†å‘¢ï¼Ÿæˆ‘ä»¬å¤§æ¦‚ä¹Ÿèƒ½å¤Ÿæƒ³åˆ°ï¼Œå…¶å®å°±æ˜¯åœ¨æ‰§è¡Œå›è°ƒçš„æ—¶å€™ã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œå…ˆå¤ä¹ ä¸€ä¸‹ï¼Œä»getBeanå¼€å§‹åˆ°è¿”å›Beanç»å†äº†ä»€ä¹ˆï¼š</p><div class=pgc-img><img alt=æœ‰ä¸€è¯´ä¸€ï¼SpringAOP+æºç è§£æï¼Œåˆ‡å°±å®Œäº‹äº† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7b40b58f048d4a25a0eee21e8e3aeace><p class=pgc-img-caption></p></div><p>å›é¡¾å®ŒSpringBeançš„åˆ›å»ºæµç¨‹ä¹‹åï¼Œæˆ‘ä»¬ä»¥æ³¨è§£æ–¹å¼@EnableAspectJAutoProxyé…ç½®Aopå¼€å¯@Aspectjä¸ºä¾‹ï¼Œè¿›è¡Œä¸€æ³¢AOPçš„æµç¨‹æ€»ç»“ï¼š</p><h1 class=pgc-h-arrow-right><strong>AOPçš„æµç¨‹æ€»ç»“</strong></h1><p>é€šè¿‡æºç å¯ä»¥å‘ç°ï¼Œå…¶å®æ˜¯é€šè¿‡@EnableAspectJAutoProxyæ³¨è§£æ³¨å…¥äº†ä¸€ä¸ªAnnotationAwareAspectJAutoProxyCreatorï¼Œä½†è¿™ä¸ªç±»ä¸­å…¶å®å¹¶æ²¡æœ‰é‡å†™postProcessAfterInitialization()ï¼Œæœ€ç»ˆå®ç°å…¶å®æ˜¯åœ¨AbstractAutoProxyCreatorä¸­ã€‚</p><p>å…·ä½“å¹²çš„äº‹æƒ…ï¼Œæˆ‘å·²ç»é€šè¿‡ä¸€å¼ å›¾æ€»ç»“å‡ºæ¥äº†ï¼Œå¦‚æœæƒ³è¦äº†è§£æ›´åŠ å…·ä½“çš„ä¿¡æ¯ï¼Œä¸å¦¨æ‰“å¼€æºç ï¼Œå¯ä»¥çœ‹çš„æ›´åŠ æ¸…æ™°ä¸€äº›ã€‚</p><div class=pgc-img><img alt=æœ‰ä¸€è¯´ä¸€ï¼SpringAOP+æºç è§£æï¼Œåˆ‡å°±å®Œäº‹äº† onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/58d5f2744d3d4b7a9beecbc7f80de87e><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>AnnotationAwareAspectJAutoProxyCreatorçš„æ³¨å†Œ</strong></h1><p>é¦–å…ˆæ˜¯å¯¹AnnotationAwareAspectJAutoProxyCreatorçš„æ³¨å†Œç¯èŠ‚ï¼šã€åœ¨æ­¤ä¸ä½œèµ˜è¿°ã€‘</p><pre><code>class AspectJAutoProxyBeanDefinitionParser implements BeanDefinitionParser {    @Override    @Nullable     // 1. æ³¨å†Œproxy creator    public BeanDefinition parse(Element element, ParserContext parserContext) {    AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element);        extendBeanDefinition(element, parserContext);        return null;    }}</code></pre><h1 class=pgc-h-arrow-right><strong>applyBeanPostProcessorsAfterInitializationå…¥å£</strong></h1><p>AbstractAutowireCapableBeanFactory.java</p><pre><code>protected Object initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) {    //å¦‚æœbeanå®ç°äº†BeanNameAwareã€BeanClassLoaderAwareã€BeanFactoryAwareæ¥å£, å›è°ƒ    invokeAwareMethods(beanName, bean);    Object wrappedBean = bean;    //aopåœ¨init-methodä¹‹å‰å¹¶æ²¡æœ‰è¿›è¡Œæ“ä½œ, ç›®å‰è¿˜æ˜¯åŸæ¥é‚£ä¸ªå¯¹è±¡    if (mbd == null || !mbd.isSynthetic()) {        //BeanPostProcessor çš„ postProcessBeforeInitialization å›è°ƒ        wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);    }     //å¤„ç†beanä¸­å®šä¹‰çš„init-methodæˆ– beanå®ç°äº†InitializingBean ,è°ƒç”¨afterPropertiesSet() æ–¹æ³•    invokeInitMethods(beanName, wrappedBean, mbd);    if (mbd == null || !mbd.isSynthetic()) {        //BeanPostProcessor çš„ postProcessAfterInitialization å›è°ƒ æ³¨æ„è¿™é‡Œï¼        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);    }    return wrappedBean;}</code></pre><pre><code>@Overridepublic Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)    throws BeansException {    Object result = existingBean;    for (BeanPostProcessor processor : getBeanPostProcessors()) {        //AnnotationAwareAspectJAutoProxyCreator        Object current = processor.postProcessAfterInitialization(result, beanName);        if (current == null) {            return result;        }        result = current;    }    return result;//è¿”å›[å¯èƒ½ä»£ç†åçš„]ç»“æœ}</code></pre><h1 class=pgc-h-arrow-right><strong>AbstractAutoProxyCreatorçš„ä¸»è¦æ–¹æ³•</strong></h1><pre><code>//SpringAopåœ¨IOCå®¹å™¨åˆ›å»ºbeanå®ä¾‹çš„æœ€åå¯¹beanè¿›è¡Œå¤„ç†,è¿›è¡Œä»£ç†å¢å¼º, AbstractAutoProxyCreato	@Override public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {    if (bean != null) {        Object cacheKey = getCacheKey(bean.getClass(), beanName);        if (this.earlyProxyReferences.remove(cacheKey) != bean) {            return wrapIfNecessary(bean, beanName, cacheKey);//è¿™ä¸ªæ–¹æ³•å°†è¿”å›ä»£ç†ç±»        }    }    return bean;}</code></pre><pre><code>protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {    //è¿”å›åŒ¹é…å½“å‰bean çš„æ‰€æœ‰çš„advisor, advice, interceptor    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);    if (specificInterceptors != DO_NOT_PROXY) {        this.advisedBeans.put(cacheKey, Boolean.TRUE);        //åœ¨è¿™é‡Œåˆ›å»ºä»£ç†        Object proxy = createProxy(            bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));        this.proxyTypes.put(cacheKey, proxy.getClass());        return proxy;    }    this.advisedBeans.put(cacheKey, Boolean.FALSE);    return bean;}</code></pre><h1 class=pgc-h-arrow-right><strong>createProxyè¿‡ç¨‹</strong></h1><pre><code>protected Object createProxy(Class&lt;?&gt; beanClass, @Nullable String beanName,@Nullable Object[] specificInterceptors, TargetSource targetSource) {	//åˆ›å»ºProxyFactoryå®ä¾‹    ProxyFactory proxyFactory = new ProxyFactory();    proxyFactory.copyFrom(this);	//åœ¨schema-basedé…ç½®æ–¹å¼é‡Œ,å¯ä»¥å°† proxy-target-class="true",è¿™æ ·ä¸ç®¡æœ‰æ²¡æœ‰æ¥å£éƒ½ä½¿ç”¨cglib    if (!proxyFactory.isProxyTargetClass()) {        if (shouldProxyTargetClass(beanClass, beanName)) {            proxyFactory.setProxyTargetClass(true);        }        else {            evaluateProxyInterfaces(beanClass, proxyFactory);        }    }	//è¿”å›å½“å‰beançš„advisorsæ•°ç»„    Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);    proxyFactory.addAdvisors(advisors); //è®¾ç½®advisorsæ•°ç»„    proxyFactory.setTargetSource(targetSource);//targetSource æºå¸¦äº†çœŸå®å®ç°çš„ä¿¡æ¯    customizeProxyFactory(proxyFactory);    proxyFactory.setFrozen(this.freezeProxy);    if (advisorsPreFiltered()) {        proxyFactory.setPreFiltered(true);    }    return proxyFactory.getProxy(getProxyClassLoader());//getProxy(getProxyClassLoader())è¿™ä¸€æ­¥åˆ›å»ºä»£ç†}</code></pre><h1 class=pgc-h-arrow-right><strong>JDKåŠ¨æ€ä»£ç†å’ŒCGLIBåŠ¨æ€ä»£ç†ä½•æ—¶ä½¿ç”¨</strong></h1><p>è¿™ä¸€æ­¥äº§ç”Ÿåˆ†æ­§çš„åœ°æ–¹åœ¨ProxyFactoryçš„getProxyæ–¹æ³•ï¼Œåœ¨getProxyä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦æ‰§è¡ŒcreateAopProxyï¼Œè€ŒcreateAopProxyæ–¹æ³•åˆè¢«è¿™ä¸ªAopProxyFactoryè°ƒç”¨ï¼š</p><pre><code>protected final synchronized AopProxy createAopProxy() {    if (!this.active) {        activate();    }    //åˆ›å»ºAopProxyä¹‹å‰,éœ€è¦ä¸€ä¸ªAopProxyFactory    return getAopProxyFactory().createAopProxy(this);}// ProxyCreatorSupport//è¿™ä¸ªaopProxyFactoryç”¨äºåˆ›å»ºaopProxy, ä¹‹åå¯ä»¥ç”¨aopProxy.getProxy(classLoader)åˆ›å»ºä»£ç†public ProxyCreatorSupport() {    this.aopProxyFactory = new DefaultAopProxyFactory();}</code></pre><p>ä¹Ÿå°±æ˜¯æœ€åä¼šèµ°åˆ°DefaultAopProxyFactoryä¸­</p><pre><code>@Overridepublic AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException {        if (!IN_NATIVE_IMAGE &amp;&amp;         (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config))) {        Class&lt;?&gt; targetClass = config.getTargetClass();        if (targetClass == null) {            throw new AopConfigException();        }        //å¦‚æœè¦ä»£ç†çš„ç±»æœ¬èº«å°±æ˜¯æ¥å£,ä½¿ç”¨JDKåŠ¨æ€ä»£ç†        if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) {            return new JdkDynamicAopProxy(config);        }        //jdkåŠ¨æ€ä»£ç†åŸºäºæ¥å£,åªæœ‰æ¥å£ä¸­çš„æ–¹æ³•æ‰ä¼šè¢«å¢å¼º, cglibåŸºäºç±»ç»§æ‰¿,å¦‚æœæ–¹æ³•ä½¿ç”¨äº†finalæˆ–è€…privateä¿®é¥°,ä¹Ÿä¸èƒ½å¢å¼º        return new ObjenesisCglibAopProxy(config);    }    else {        // å¦‚æœæœ‰æ¥å£ï¼Œä¼šè·‘åˆ°è¿™ä¸ªåˆ†æ”¯        return new JdkDynamicAopProxy(config);    }}</code></pre><p>æ€»ç»“ï¼š</p><ul><li>å¦‚æœè¢«ä»£ç†çš„ç›®æ ‡å®ç°äº†ä¸€ä¸ªæˆ–å¤šä¸ªè‡ªå®šä¹‰çš„æ¥å£ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨JDKåŠ¨æ€ä»£ç†ã€‚</li><li>å¦‚æœæ²¡æœ‰å®ç°ä»»ä½•æ¥å£ï¼Œåˆ™ä½¿ç”¨CGLIBå®ç°ä»£ç†ã€‚</li><li>å¦‚æœè®¾ç½®proxy-target-class=trueæˆ–&lt;property name="proxyTargetClass" value="true"/>åˆ™ä¸ç®¡æœ‰æ²¡æœ‰å®ç°æ¥å£éƒ½ä¼šä½¿ç”¨CGLIBã€‚</li></ul><h1 class=pgc-h-arrow-right><strong>ä¸ƒã€JDKåŠ¨æ€ä»£ç†çš„å®ç°</strong></h1><p>æœ€ç»ˆçš„æœ€ç»ˆï¼Œéƒ½ä¼šèµ°åˆ°çœŸæ­£åˆ›å»ºä»£ç†å¯¹è±¡çš„æµç¨‹ä¸Šï¼š</p><pre><code>@Overridepublic Object getProxy(@Nullable ClassLoader classLoader) {	//è·å–ä»£ç†æ¥å£    Class&lt;?&gt;[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(this.advised, true);    //æŸ¥æ‰¾ä»£ç†ç›®æ ‡çš„æ¥å£æ˜¯å¦å®šä¹‰equalså’Œhashcodeæ–¹æ³•    findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);    //ä½¿ç”¨jdkåŠ¨æ€ä»£ç†åˆ›å»ºä»£ç†å¯¹è±¡    return Proxy.newProxyInstance(classLoader, proxiedInterfaces, this);}</code></pre><p>ç¬¬ä¸€ä¸ªå‚æ•°ï¼šclassLoaderã€‚</p><p>ç¬¬äºŒä¸ªå‚æ•°ï¼šå®ç°çš„æ¥å£ã€‚</p><p>ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šInvocationHandlerå®ä¾‹ã€‚</p><p>è€Œæœ¬èº«JdkDynamicAopProxyæœ¬å°±å®ç°äº†InvocationHandlerï¼Œå› æ­¤ä¼ å…¥thisã€‚è‡³æ­¤ï¼Œå½“è°ƒç”¨è¢«ä»£ç†ç±»çš„æ–¹æ³•çš„æ—¶å€™ï¼Œéƒ½ä¼šæœ€ç»ˆè°ƒç”¨ä»£ç†ç±»å®ç°çš„invokeæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®šä¹‰æ¨ªåˆ‡çš„é€»è¾‘ã€‚</p><pre><code>public interface InvocationHandler {    public Object invoke(Object proxy, Method method, Object[] args)        throws Throwable;}</code></pre><ul><li>proxyï¼šä»£ç†å¯¹è±¡çš„å¼•ç”¨ã€‚</li><li>methodï¼šå½“å‰æ‰§è¡Œçš„æ–¹æ³•ã€‚</li><li>argsï¼šå½“å‰æ‰§è¡Œæ–¹æ³•æ‰€éœ€çš„å‚æ•°ã€‚</li><li>returnï¼šå’Œè¢«ä»£ç†å¯¹è±¡æœ‰ç›¸åŒçš„è¿”å›å€¼ã€‚</li></ul><pre><code>@Override@Nullablepublic Object invoke(Object proxy, Method method, Object[] args) throws Throwable { 	//å½“ç”Ÿæˆçš„ä»£ç†ç±»å¯¹å¤–æä¾›æœåŠ¡çš„æ—¶å€™,éƒ½ä¼šå¯¼å…¥åˆ°è¿™ä¸ªinvokeæ–¹æ³•ä¸­    Object oldProxy = null;    boolean setProxyContext = false;	    TargetSource targetSource = this.advised.targetSource;    Object target = null;    try {        if (!this.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) {            // å¯¹equalsæ–¹æ³•çš„ä»£ç†            return equals(args[0]);        }        else if (!this.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) {            //å¯¹hashCode()æ–¹æ³•çš„ä»£ç†            return hashCode();        }        //...        Object retVal;		//å¦‚æœè®¾ç½®äº†exposeProxy,å°†proxyæ”¾å…¥ThreadLocalä¸­        if (this.advised.exposeProxy) {             oldProxy = AopContext.setCurrentProxy(proxy);            setProxyContext = true;        }        // Get as late as possible to minimize the time we "own" the target,        // in case it comes from a pool.        target = targetSource.getTarget();        Class&lt;?&gt; targetClass = (target != null ? target.getClass() : null);        // è·å–ç›®æ ‡æ–¹æ³•çš„æ‹¦æˆªé“¾ï¼ŒåŒ…å«æ‰€æœ‰è¦æ‰§è¡Œçš„ advice        List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);        // æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªé“¾ä¸Šæ˜¯ä¸æ˜¯æœ‰adviceï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œå¯ä»¥è·³è¿‡åˆ›å»ºMethodInvocation        if (chain.isEmpty()) { //chainå¦‚æœæ˜¯ç©ºçš„,è¡¨ç¤ºä¸éœ€è¦è¢«å¢å¼ºï¼Œç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•            Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);            retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);        }        else {            // å¦‚æœchainé‡Œæœ‰advice æ‰§è¡Œæ–¹æ³•,å¾—åˆ°è¿”å›å€¼            MethodInvocation invocation =                new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);            //æ²¿ç€æ‹¦æˆªå™¨é“¾ï¼Œæ‰§è¡Œé€šçŸ¥            retVal = invocation.proceed();        }        // å¯¹è¿”å›å€¼çš„å¤„ç†        Class&lt;?&gt; returnType = method.getReturnType();        if (retVal != null &amp;&amp; retVal == target &amp;&amp;            returnType != Object.class &amp;&amp; returnType.isInstance(proxy) &amp;&amp;            !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) {            retVal = proxy;        }        else if (retVal == null &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) {            throw new AopInvocationException();        }        return retVal;    }    finally {        if (target != null &amp;&amp; !targetSource.isStatic()) {            // é‡Šæ”¾ç›®æ ‡å¯¹è±¡            targetSource.releaseTarget(target);        }        if (setProxyContext) {            // å­˜å‚¨ä»£ç†å¯¹è±¡            AopContext.setCurrentProxy(oldProxy);        }    }}</code></pre><h1 class=pgc-h-arrow-right><strong>å…«ã€æ€»ç»“</strong></h1><blockquote><p>ä»¥@AspectJæ³¨è§£æ–¹å¼ä¸ºä¾‹</p></blockquote><ul><li>é¦–å…ˆï¼Œä¾æ®&lt;aop:aspectj-autoproxy>æˆ–@EnableAspectJAutoProxyï¼ŒSpringä¼šåœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™æ³¨å†Œåå«internalAutoProxyCreatorçš„AnnotationAwareAspectJAutoProxyCreatorã€‚</li><li>åœ¨beanå®ä¾‹åŒ–å®Œæˆï¼Œå±æ€§è£…é…å®Œæˆä¹‹åï¼Œå¼€å§‹æ‰§è¡Œå›è°ƒæ–¹æ³•ï¼Œè¿™æ—¶å–å‡ºæ‰€æœ‰çš„BeanPostProcessorï¼Œæ‰§è¡Œå…¶postProcessAfterInitializationæ–¹æ³•ï¼Œå‡†å¤‡å¼€å§‹å¯¹ç›®æ ‡å¯¹è±¡ä»£ç†çš„åˆ›å»ºã€‚</li><li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªä»£ç†å·¥å‚ProxyFactoryï¼Œè®¾ç½®ä¸€ç³»åˆ—çš„å±æ€§ï¼Œå¦‚æ‰€æœ‰çš„é€šçŸ¥æ–¹æ³•ï¼Œå¢å¼ºå™¨ï¼Œæ‹¦æˆªå™¨å’Œç›®æ ‡ç±»ç­‰æ³¨å…¥ä»£ç†å·¥å‚ï¼Œå†è°ƒç”¨ProxyFactory.getProxy(classLoader)è·å–ä»£ç†ã€‚</li><li>é€šè¿‡åˆ¤æ–­æ˜¯ç”¨JDKåŠ¨æ€ä»£ç†è¿˜æ˜¯CGLIBåˆ›å»ºä¸åŒçš„AopProxyï¼Œæœ€åè·å–getProxyã€‚</li></ul><p>å¦‚æœæ„Ÿè§‰æœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©å…³æ³¨æˆ‘ä¸€èµ·å­¦ä¹ è¿›æ­¥ï¼</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'SpringAOP','æºç ','å®Œäº‹'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>