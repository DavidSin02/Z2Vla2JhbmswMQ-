<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>JavaScript 中的异步原理 | 极客快訊</title><meta property="og:title" content="JavaScript 中的异步原理 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/83f6255ffb254e588bf7f4afb66cef42"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4e324d9.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4e324d9.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4e324d9.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4e324d9.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4e324d9.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4e324d9.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4e324d9.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4e324d9.html><meta property="article:published_time" content="2020-10-29T20:50:33+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:33+08:00"><meta name=Keywords content><meta name=description content="JavaScript 中的异步原理"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/4e324d9.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>JavaScript 中的异步原理</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><blockquote><p>来源：极链科技</p><p>作者：周哲</p></blockquote><p>所谓“异步” ，简单说就是一个任务分成两段，先执行第一段，然后转而执行其他任务，等做好了准备，再回过头执行第二段。比如，有一个任务是读取文件进行处理，异步的执行过程就是下面这样。</p><p>常见的浏览器无响应（假死），往往就是因为某一段 Javascript 代码长时间运行（比如死循环），导致整个页面卡在这个地方，其他任务无法执行。</p><p>为了解决这个问题，Javascript 语言将任务的执行模式分成两种：同步（ Synchronous ）和异步（ Asynchronous ）。</p><div class=pgc-img><img alt=JavaScript 中的异步原理 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/83f6255ffb254e588bf7f4afb66cef42><p class=pgc-img-caption></p></div><p><strong>异步编程原理</strong></p><p>JavaScript 引擎负责解析，执行 JavaScript 代码，但它并不能单独运行，通常都得有一个宿主环境，一般如浏览器或 Node 服务器，前文说到的单线程是指在这些宿主环境创建单一线程，提供一种机制，调用 JavaScript 引擎完成多个 JavaScript 代码块的调度，这种机制就称为事件循环（ Event Loop ）。</p><p><strong>关于事件循环流程分解如下：</strong></p><ol><li>宿主环境为JavaScript 创建线程时，会创建堆 (heap) 和栈 (stack) ，堆内存储 JavaScript 对象，栈内存储执行上下文；</li><li>栈内执行上下文的同步任务按序执行，执行完即退栈，而当异步任务执行时，该异步任务进入等待状态（不入栈），同时通知线程：当触发该事件时（或该异步操作响应返回时），需向消息队列插入一个事件消息；</li><li>当事件触发或响应返回时，线程向消息队列插入该事件消息（包含事件及回调）；</li><li>当栈内同步任务执行完毕后，线程从消息队列取出一个事件消息，其对应异步任务（函数）入栈，执行回调函数，如果未绑定回调，这个消息会被丢弃，执行完任务后退栈；</li><li>当线程空闲（即执行栈清空）时继续拉取消息队列下一轮消息（next tick ，事件循环流转一次称为一次 tick ）。</li></ol><div class=pgc-img><img alt=JavaScript 中的异步原理 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8492a4ce11844488a7a27aa813f18170><p class=pgc-img-caption></p></div><p>很多的队列先后按顺序执行任务就形成了 Event</p><p><strong>异步编程实现</strong></p><p><strong>1 ：回调函数</strong></p><p>优点：简单、容易理解和部署。</p><p>缺点：不利于代码的阅读和维护，各个部分之间高度耦合（ Coupling ），流程会很混乱。</p><p><strong>2 ： Promise 对象</strong></p><p>一个 promise 可能有三种状态：等待（ pending ）、已完成（ fulfilled ）、已拒绝（ rejected ） ;</p><div class=pgc-img><img alt=JavaScript 中的异步原理 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/9c953e62074d44c08d81fff0268a9853><p class=pgc-img-caption></p></div><p><strong>resolve ，接受一个成功值，传递给绑定的 fulfilled 回调函数中。</strong>主要工作是将当前状态变为 fulfilled 状态，同时调用绑定的 fulfilled 回调函数。</p><p><strong>reject ，接受一个失败信息，传递给绑定的 rejected 回调函数中。</strong>主要工作是将当前状态变为 rejected 状态，同时调用绑定的 rejected 回调函数。</p><p><strong>then 方法返回一个 Promise 。</strong>它有两个参数，分别为 Promise 在成功和失败情况下的回调函数。</p><p>语法：</p><div class=pgc-img><img alt=JavaScript 中的异步原理 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8f9d433f02bf4a4f96cf05a0ca5b7a32><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=JavaScript 中的异步原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b505cc7e709a448c901cfd8e63ce3160><p class=pgc-img-caption></p></div><p>概括来说 promise 是对异步的执行结果的描述对象。</p><p><strong>3 ： Generator</strong></p><p>Generator 函数是 ES6 提供的一种异步编程解决方案 ，允许函数的暂停和恢复。</p><p>异步任务的封装：</p><div class=pgc-img><img alt=JavaScript 中的异步原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3d2ddf3ac87642f1b771b5bd484e7e6d><p class=pgc-img-caption></p></div><p>整个过程类似于，浏览器遇到标识符 * 之后，就明白这个函数是生成器函数，一旦遇到 yield 标识符，就会将以后的函数放入此异步函数之内，待异步返回结果后再进行执行。</p><p><strong>更深一步，从内存上来讲：</strong></p><p>普通函数在被调用时，JS 引擎会创建一个栈帧，在里面准备好局部变量、函数参数、临时值、代码执行的位置（也就是说这个函数的第一行对应到代码区里的第几行机器码），在当前栈帧里设置好返回位置，然后将新帧压入栈顶。待函数执行结束后，这个栈帧将被弹出栈然后销毁，返回值会被传给上一个栈帧。</p><p>当执行到 yield 语句时， Generator 的栈帧同样会被弹出栈外，但 Generator 在这里耍了个花招 —— 它在堆里保存了栈帧的引用（或拷贝）！这样当 it.next 方法被调用时， JS 引擎便不会重新创建一个栈帧，而是把堆里的栈帧直接入栈。因为栈帧里保存了函数执行所需的全部上下文以及当前执行的位置，所以当这一切都被恢复如初之时，就好像程序从原本暂停的地方继续向前执行了。</p><p>而因为每次 yield 和 it.next 都对应一次出栈和入栈，所以可以直接利用已有的栈机制，实现值的传出和传入。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'JavaScript','异步','原理'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>