<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>WebRTC音视频技术入门与提高 | 极客快訊</title><meta property="og:title" content="WebRTC音视频技术入门与提高 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/dfic-imagehandler/70f3ac8a-bb55-4478-86c0-ad7f1bf45b07"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4f7cb00b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4f7cb00b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4f7cb00b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4f7cb00b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4f7cb00b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4f7cb00b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4f7cb00b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4f7cb00b.html><meta property="article:published_time" content="2020-11-14T21:08:02+08:00"><meta property="article:modified_time" content="2020-11-14T21:08:02+08:00"><meta name=Keywords content><meta name=description content="WebRTC音视频技术入门与提高"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/4f7cb00b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>WebRTC音视频技术入门与提高</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1>1 WebRTC入门</h1><p>（1）了解什么WebRTC</p><p>（2）掌握WebRTC通话原理</p><p>（3）WebRTC视频教程</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/dfic-imagehandler/70f3ac8a-bb55-4478-86c0-ad7f1bf45b07><p class=pgc-img-caption></p></div><p>1.1 什么是WebRTC</p><p>WebRTC（Web Real-Time Communication）是 Google于2010以6829万美元从 Global IP Solutions 公司购买，并于2011年将其开源，旨在建立一个互联网浏览器间的实时通信的平台，让 WebRTC技术成为 H5标准之一。我们看官网（https://webrtc.org）的介绍</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/299f277876514e2d8e454f4a398901cd><p class=pgc-img-caption></p></div><p>从官网上的描述我们可以知道，WebRTC是一个免费的开放项目，它通过简单的API为浏览器和移动应用程序提供实时通信（RTC）功能。</p><p>1.2 WebRTC框架</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/901a5f60157e444b998cc1ede2a312f2><p class=pgc-img-caption></p></div><p>上图的框架对于不同的开发人员关注点不同：</p><p>（1）紫色部分是Web应用开发者API层</p><p>（2）蓝色实线部分是面向浏览器厂商的API层</p><p>（3）蓝色虚线部分浏览器厂商可以自定义实现</p><p>特别是图中的 <strong>PeerConnection </strong>为 Web 开发人员提供了一个抽象，从复杂的内部结构中抽象出来。我们只需要关注PeerConnection这个对象即可以开发音视频通话应用内。</p><p>WebRTC架构组件介绍</p><p>Your Web App</p><p>Web开发者开发的程序，Web开发者可以基于集成WebRTC的浏览器提供的web API开发基于视频、音频的实时通信应用。</p><p>Web API</p><p>面向第三方开发者的WebRTC标准API（Javascript），使开发者能够容易地开发出类似于网络视频聊天的web应用，最新的标准化进程可以查看这里。</p><p>WebRTC Native C++ API</p><p>本地C++ API层，使浏览器厂商容易实现WebRTC标准的Web API，抽象地对数字信号过程进行处理。</p><p>Transport / Session</p><p>传输/会话层</p><p>会话层组件采用了libjingle库的部分组件实现，无须使用xmpp/jingle协议</p><p>VoiceEngine</p><p>音频引擎是包含一系列音频多媒体处理的框架。</p><p>PS：VoiceEngine是WebRTC极具价值的技术之一，是Google收购GIPS公司后开源的。在VoIP上，技术业界领先。</p><p>Opus：支持从6 kbit/s到510 kbit/s的恒定和可变比特率编码，帧大小从2.5 ms到60 ms，各种采样率从8 kHz（4 kHz带宽）到48 kHz（20 kHz带宽，可复制人类听觉系统的整个听力范围）。由IETF RFC 6176定义。</p><p>NetEQ模块是Webrtc语音引擎中的核心模块 ，一种动态抖动缓冲和错误隐藏算法，用于隐藏网络抖动和数据包丢失的负面影响。保持尽可能低的延迟，同时保持最高的语音质量。</p><p>VideoEngine</p><p>WebRTC视频处理引擎</p><p>VideoEngine是包含一系列视频处理的整体框架，从摄像头采集视频到视频信息网络传输再到视频显示整个完整过程的解决方案。</p><p><strong>VP8 </strong>视频图像编解码器，是WebRTC视频引擎的默认的编解码器</p><p>VP8适合实时通信应用场景，因为它主要是针对低延时而设计的编解码器。</p><p>1.3 WebRTC发展前景</p><p>WebRTC虽然冠以“web”之名，但并不受限于传统互联网应用或浏览器的终端运行环境。实际上无论终端运行环境是<strong>浏览器、桌面应用、移动设备（Android或iOS）还是IoT设备</strong>，只要IP连接可到达且符合WebRTC规范就可以互通。这一点释放了大量智能终端（或运行在智能终端上的app）的实时通信能力，打开了许多对于实时交互性要求较高的应用场景的想象空间，譬如在线教育、视频会议、视频社交、远程协助、远程操控等等都是其合适的应用领域。</p><p>全球领先的技术研究和咨询公司Technavio最近发布了题为“全球网络实时通讯（WebRTC）市场，2017-2021”的报告。报告显示，2017-2021年期间，全球网络实时通信（WebRTC）市场将以<strong>34.37％的年均复合增长率增长</strong>，增长十分迅速。增长主要来自北美、欧洲及亚太地区。</p><p>1.4 国内方案厂商</p><p>声网、即构科技、环信、融云等公司都在基于WebRTC二次开发自己的音视频通话方案。</p><p>声网 https://www.agora.io/cn/</p><p>即构科技 https://www.zego.im/</p><p>1.5 WebRTC通话原理</p><p>首先思考的问题：两个不同网络环境的（具备摄像头/麦克风多媒体设备的）浏览器，要实现点对点 的实时音视频对话，难点在哪里？</p><p><strong>1. 媒体协商</strong></p><p><strong>彼此要了解对方支持的媒体格式</strong></p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5a3b0860d78c469984af46d4f3c4d1e9><p class=pgc-img-caption></p></div><p>比如：Peer-A端可支持VP8、H264多种编码格式，而Peer-B端支持VP9、H264，要保证二端都正确的编解码，最简单的办法就是取它们的交集H264</p><p>注：有一个专门的协议 ，称为Session Description Protocol (SDP)，可用于描述上述这类信息，在WebRTC中，参与视频通讯的双方必须先交换SDP信息，这样双方才能知根知底，而交换SDP的过程，也称为"媒体协商"。</p><p><strong>2. 网络协商</strong></p><p><strong>彼此要了解对方的网络情况，这样才有可能找到一条相互通讯的链路</strong></p><p><strong>先说结论：(1)获取外网IP地址映射；（2）通过信令服务器（signal server）交换"网络信息"</strong></p><p>理想的网络情况是每个浏览器的电脑都是私有公网IP，可以直接进行点对点连接。</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/81a9418d6dee4836a22447abee04369c><p class=pgc-img-caption></p></div><p>实际情况是：我们的电脑和电脑之前或大或小都是在某个局域网中，需要NAT（Network Address Translation，网络地址转换），显示情况如下图：</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/35e6fa37e1554f6ba086577e6f88b910><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/225044abbc934722b10cf3ce30f64033><p class=pgc-img-caption></p></div><p>在解决WebRTC使用过程中的上述问题的时候，我们需要用到STUN和TURN。</p><p><strong>STUN</strong></p><p>STUN（Session Traversal Utilities for NAT，NAT会话穿越应用程序）是一种网络协议，它允许位于NAT（或多重NAT）后的客户端找出自己的公网地址，查出自己位于哪种类型的NAT之后以及NAT为某一个本地端口所绑定的Internet端端口。这些信息被用来在两个同时处于NAT路由器之后的主机之间创建UDP通信。该协议由RFC 5389定义。</p><p>在遇到上述情况的时候，我们可以建立一个STUN服务器，这个服务器做什么用的呢？主要是给无法在公网环境下的视频通话设备分配公网IP用的。这样两台电脑就可以在公网IP中进行通话。</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1534b4eca4d14e379b86054225f3d649><p class=pgc-img-caption></p></div><p>使用一句话说明STUN做的事情就是：告诉我你的公网IP地址+端口是什么。搭建STUN服务器很简单，媒体流传输是按照P2P的方式。</p><p>那么问题来了，<strong>STUN并不是每次都能成功的为需要NAT的通话设备分配IP地址的，P2P在传输媒体流时，使用的本地带宽，在多人视频通话的过程中，通话质量的好坏往往需要根据使用者本地的带宽确定。</strong>那么怎么办？TURN可以很好的解决这个问题。</p><p><strong>TURN</strong></p><p>TURN的全称为Traversal Using Relays around NAT，是STUN/RFC5389的一个拓展，主要添加了Relay功能。如果终端在NAT之后， 那么在特定的情景下，有可能使得终端无法和其对等端（peer）进行直接的通信，这时就需要公网的服务器作为一个中继， 对来往的数据进行转发。这个转发的协议就被定义为TURN。</p><p>在上图的基础上，再架设几台TURN服务器：</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8be5b48ac2484dcca9405247d664caf1><p class=pgc-img-caption></p></div><p>在STUN分配公网IP失败后，可以通过TURN服务器请求公网IP地址作为中继地址。这种方式的带宽由服务器端承担，在多人视频聊天的时候，本地带宽压力较小，并且，根据Google的说明，TURN协议可以使用在所有的环境中。（单向数据200kbps 一对一通话）</p><p>以上是WebRTC中经常用到的2个协议，STUN和TURN服务器我们使用coturn开源项目来搭建。</p><p>补充：ICE跟STUN和TURN不一样，ICE不是一种协议，而是一个框架（Framework），它整合了STUN和TURN。coturn开源项目集成了STUN和TURN的功能。</p><p>在WebRTC中用来描述 网络信息的术语叫candidate。</p><p>媒体协商 sdp</p><p>网络协商 candidate</p><p>3. 媒体协商+网络协商数据的交换通道</p><p>从上面1/2点我们知道了2个客户端协商媒体信息和网络信息，那怎么去交换？是不是需要一个中间商去做交换？所以我们需要一个信令服务器（Signal server）转发彼此的媒体信息和网络信息。</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1015f71c047146c88c774e8310534283><p class=pgc-img-caption></p></div><p>如上图，我们在基于WebRTC API开发应用（APP）时，可以将彼此的APP连接到信令服务器（Signal Server，一般搭建在公网，或者两端都可以访问到的局域网），借助信令服务器，就可以实现上面提到的SDP媒体信息及Candidate网络信息交换。</p><p><strong>信令服务器不只是交互 媒体信息sdp和网络信息candidate，比如：</strong></p><p><strong>（1）房间管理</strong></p><p><strong>（2）人员进出房间</strong></p><p><strong>WebRTC APIs</strong></p><p><strong>MediaStream </strong>—  MediaStream用来表示一个媒体数据流（通过getUserMedia接口获取），允许你访问输入设备，如麦克风和 Web摄像机,该 API 允许从其中任意一个获取媒体流。</p><p><strong>RTCPeerConnection </strong>— RTCPeerConnection 对象允许用户在两个浏览器之间直接通讯 ，你可以通过网络将捕获的音频和视频流实时发送到另一个 WebRTC 端点。使用这些 Api，你可以在本地机器和远程对等点之间创建连接。它提供了连接到远程对等点、维护和监视连接以及在不再需要连接时关闭连接的方法。</p><p>4. 一对一通话</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9d557f9b84ce4061b7e8923c6e31dc8d><p class=pgc-img-caption></p></div><p>在一对一通话场景中，每个 Peer均创建有一个 PeerConnection 对象，由一方主动发 Offer SDP，另一方则应答 AnswerSDP，最后双方交换 ICE Candidate 从而完成通话链路的建立。但是在中国的网络环境中，据一些统计数据显示，至少1半的网络是无法直接穿透打通，这种情况下只能借助TURN服务器中转。</p><p>5. NAT知识补充</p><p>具体NAT打洞的知识在本课程不做进一步的讲解，这里提供些链接给大家做参考：</p><p>P2P技术详解(一)：NAT详解——详细原理、P2P简介 https://www.cnblogs.com/mlgjb/p/8243646.htm</p><p>P2P技术详解(二)：P2P中的NAT穿越(打洞)方案详解 https://www.jianshu.com/p/9bfbcbee0abb</p><p>P2P技术详解(三)：P2P技术之STUN、TURN、ICE详解 https://www.jianshu.com/p/258e7d8be2ba</p><p>详解P2P技术中的NAT穿透原理 https://www.jianshu.com/p/f71707892eb2</p><p>附：webrtc学习视频教程</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9391f4c470ea40be81dd7035082bba97><p class=pgc-img-caption></p></div><p>目的：帮助更多的学员入门WebRTC，视频免费领取，后台私信 1</p><p>分为以下章节：</p><p>（1）WebRTC入门</p><p>（2）WebRTC开发环境搭建</p><p>（3）Coturn穿透和转发服务器搭建</p><p>（4）音视频采集和播放</p><p>（5）Nodejs实战</p><p>（6）手把手实现音视频一对一通话（包含信令协议设计、Web to Web、Android to Web、 Android to Android）</p><p>（7）开源方案介绍</p><p>（8）AppRTC开源方案搭建</p><div class=pgc-img><img alt=WebRTC音视频技术入门与提高 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/53bd4b69ecc644dca2cabedf22ee012e><p class=pgc-img-caption></p></div><p>学完后希望大家都有所收获！</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'WebRTC','音视','频技术'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>