<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Kafka动态配置了解下？ | 极客快訊</title><meta property="og:title" content="Kafka动态配置了解下？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/dfic-imagehandler/4ace17fe-2d4d-499a-8ef9-367d6ac94b47"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5238801.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5238801.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5238801.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5238801.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5238801.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5238801.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5238801.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5238801.html><meta property="article:published_time" content="2020-10-29T20:58:17+08:00"><meta property="article:modified_time" content="2020-10-29T20:58:17+08:00"><meta name=Keywords content><meta name=description content="Kafka动态配置了解下？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/5238801.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Kafka动态配置了解下？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>什么是动态Broker参数配置？</h1><p>在开始分享之前，我们先来复习一下设置 Kafka 参数，特别是 Broker 端参数的方法。</p><p>在 Kafka 安装目录的 config 路径下，有个 server.properties 文件。通常情况下，我们会指定这个文件的路径来启动 Broker。如果要设置 Broker 端的任何参数，我们必须在这个文件中显式地增加一行对应的配置，之后启动 Broker 进程，令参数生效。我们常见的做法是，一次性设置好所有参数之后，再启动 Broker。当后面需要变更任何参数时，我们必须重启 Broker。但生产环境中的服务器，怎么能随意重启呢？所以，目前修改 Broker 端参数是非常痛苦的过程。</p><p>基于这个痛点，社区于 1.1.0 版本中正式引入了动态 Broker 参数（Dynamic BrokerConfigs）。所谓动态，就是指修改参数值后，无需重启 Broker 就能立即生效，而之前在server.properties 中配置的参数则称为静态参数（Static Configs）。显然，动态调整参数值而无需重启服务，是非常实用的功能。如果你想体验动态 Broker 参数的话，那就赶快升级到 1.1 版本吧。</p><p>当然了，当前最新的 2.3 版本中的 Broker 端参数有 200 多个，社区并没有将每个参数都升级成动态参数，它仅仅是把一部分参数变成了可动态调整。那么，我们应该如何分辨哪些参数是动态参数呢？</p><p>如果你打开 1.1 版本之后（含 1.1）的 Kafka 官网，你会发现Broker Configs表中增加了Dynamic Update Mode 列。该列有 3 类值，分别是 read-only、per-broker 和 cluster-wide。我来解释一下它们的含义。</p><ul><li>read-only。被标记为 read-only 的参数和原来的参数行为一样，只有重启 Broker，才能令修改生效。</li><li>per-broker。被标记为 per-broker 的参数属于动态参数，修改它之后，只会在对应的Broker 上生效。</li><li>cluster-wide。被标记为 cluster-wide 的参数也属于动态参数，修改它之后，会在整个集群范围内生效，也就是说，对所有 Broker 都生效。你也可以为具体的 Broker 修改cluster-wide 参数。</li></ul><p>我来举个例子说明一下 per-broker 和 cluster-wide 的区别。Broker 端参数 listeners 想必你应该不陌生吧。它是一个 per-broker 参数，这表示你只能为单个 Broker 动态调整listeners，而不能直接调整一批 Broker 的 listeners。log.retention.ms 参数是 cluster-wide 级别的，Kafka 允许为集群内所有 Broker 统一设置一个日志留存时间值。当然了，你也可以为单个 Broker 修改此值。</p><div class=pgc-img><img alt=Kafka动态配置了解下？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/4ace17fe-2d4d-499a-8ef9-367d6ac94b47><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>使用场景</h1><p>你可能会问，动态 Broker 参数的使用场景都有哪些呢？实际上，因为不必重启 Broker，动态 Broker 参数的使用场景非常广泛，通常包括但不限于以下几种：</p><ul><li>动态调整 Broker 端各种线程池大小，实时应对突发流量。</li><li>动态调整 Broker 端连接信息或安全配置信息。</li><li>动态更新 SSL Keystore 有效期。</li><li>动态调整 Broker 端 Compact 操作性能。</li><li>实时变更 JMX 指标收集器 (JMX Metrics Reporter)。</li></ul><p>在这些使用场景中，动态调整线程池大小应该算是最实用的功能了。很多时候，当 KafkaBroker 入站流量（inbound data）激增时，会造成 Broker 端请求积压（Backlog）。有了动态参数，我们就能够动态增加网络线程数和 I/O 线程数，快速消耗一些积压。当突发流量过去后，我们也能将线程数调整回来，减少对资源的浪费。整个过程都不需要重启Broker。你甚至可以将这套调整线程数的动作，封装进定时任务中，以实现自动扩缩容。</p><h1 class=pgc-h-arrow-right>如何保存？</h1><p>由于动态配置的特殊性，它必然有和普通只读参数不同的保存机制。下面我来介绍一下Kafka 是如何保存动态配置的。</p><p>首先，Kafka 将动态 Broker 参数保存在 ZooKeeper 中，具体的 znode 路径如下图所示。</p><div class=pgc-img><img alt=Kafka动态配置了解下？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/91bb7480dd524b5b96af5768bd72bfda><p class=pgc-img-caption></p></div><p>我来解释一下图中的内容。changes 是用来实时监测动态参数变更的，不会保存参数值；topics 是用来保存 Kafka 主题级别参数的。虽然它们不属于动态 Broker 端参数，但其实它们也是能够动态变更的。</p><p>users 和 clients 则是用于动态调整客户端配额（Quota）的 znode 节点。所谓配额，是指Kafka 运维人员限制连入集群的客户端的吞吐量或者是限定它们使用的 CPU 资源。</p><p>分析到这里，我们就会发现，/config/brokers znode 才是真正保存动态 Broker 参数的地方。该 znode 下有两大类子节点。第一类子节点就只有一个，它有个固定的名字叫 &lt;default >，保存的是前面说过的 cluster-wide 范围的动态参数；另一类则以 broker.id 为名，保存的是特定 Broker 的 per-broker 范围参数。由于是 per-broker 范围，因此这类子节点可能存在多个。</p><p>我们一起来看一张图片，它展示的是我的一个 Kafka 集群环境上的动态 Broker 端参数。</p><div class=pgc-img><img alt=Kafka动态配置了解下？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8c962f9fb8164062b59ee99a8d3cb6b2><p class=pgc-img-caption></p></div><p>在这张图中，我首先查看了 /config/brokers 下的子节点，我们可以看到，这里面有 &lt;default > 节点和名为 0、1 的子节点。&lt; default > 节点中保存了我设置的 cluster-wide范围参数；0 和 1 节点中分别保存了我为 Broker 0 和 Broker1 设置的 per-broker 参数。</p><p>接下来，我分别展示了 cluster-wide 范围和 per-broker 范围的参数设置。拿num.io.threads 参数为例，其 cluster-wide 值被动态调整为 12，而在 Broker 0 上被设置成 16，在 Broker 1 上被设置成 8。我为 Broker 0 和 Broker 1 单独设置的值，会覆盖掉cluster-wide 值，但在其他 Broker 上，该参数默认值还是按 12 计算。</p><p>如果我们再把静态参数加进来一起讨论的话，cluster-wide、per-broker 和 static 参数的优先级是这样的：per-broker 参数 > cluster-wide 参数 > static 参数 > Kafka 默认值。</p><p>另外，如果你仔细查看上图中的<strong>ephemeralOwner 字段</strong>，你会发现它们的值都是 0x0。这表示这些 znode 都是持久化节点，它们将一直存在。即使 ZooKeeper 集群重启，这些数据也不会丢失，这样就能保证这些动态参数的值会一直生效。</p><h1 class=pgc-h-arrow-right>如何配置？</h1><p>讲完了保存原理，我们来说说如何配置动态 Broker 参数。目前，设置动态参数的工具行命令只有一个，那就是 Kafka 自带的 kafka-configs 脚本。接下来，我来以unclean.leader.election.enable 参数为例，演示一下如何动态调整。</p><p>下面这条命令展示了如何在集群层面设置全局值，即设置 cluster-wide 范围值。</p><pre><code>$ bin/kafka-configs.sh --bootstrap-server kafka-host:port --entity-type brokers --entityCompleted updating default config for brokers in the cluster,</code></pre><p>总体来说命令很简单，但有一点需要注意。<strong>如果要设置 cluster-wide 范围的动态参数，需要显式指定 entity-default</strong>。现在，我们使用下面的命令来查看一下刚才的配置是否成功。</p><pre><code>$ bin/kafka-configs.sh --bootstrap-server kafka-host:port --entity-type brokers --entityDefault config for brokers in the cluster are:unclean.leader.election.enable=true sensitive=false synonyms={DYNAMIC_DEFAULT_BROKER_C</code></pre><p>从输出来看，我们成功地在全局层面上设置该参数值为 true。注意 sensitive=false 的字眼，它表明我们要调整的参数不是敏感数据。如果我们调整的是类似于密码这样的参数时，该字段就会为 true，表示这属于敏感数据。</p><p>好了，调整完 cluster-wide 范围的参数，我来演示下如何设置 per-broker 范围参数。我们还是以 unclean.leader.election.enable 参数为例，我现在为 ID 为 1 的 Broker 设置一个不同的值。命令如下：</p><pre><code>$ bin/kafka-configs.sh --bootstrap-server kafka-host:port --entity-type brokers --entityCompleted updating config for broker: 1.</code></pre><p>同样，我们使用下列命令，来查看一下刚刚的设置是否生效了。</p><pre><code>$ bin/kafka-configs.sh --bootstrap-server kafka-host:port --entity-type brokers --entityConfigs for broker 1 are:unclean.leader.election.enable=false sensitive=false synonyms={DYNAMIC_BROKER_CONFIG:u</code></pre><p>这条命令的输出信息很多。我们关注两点即可。</p><ol start=1><li>在 Broker 1 层面上，该参数被设置成了 false，这表明命令运行成功了。</li><li>从倒数第二行可以看出，在全局层面上，该参数值依然是 true。这表明，我们之前设置的 cluster-wide 范围参数值依然有效。</li></ol><p>如果我们要删除 cluster-wide 范围参数或 per-broker 范围参数，也非常简单，分别执行下面的命令就可以了。</p><pre><code>#删除cluster-wide范围参数$ bin/kafka-configs.sh --bootstrap-server kafka-host:port --entity-type brokers --entityCompleted updating default config for brokers in the cluster,</code></pre><pre><code>#删除per-broker范围参数$ bin/kafka-configs.sh --bootstrap-server kafka-host:port --entity-type brokers --entityCompleted updating config for broker: 1.</code></pre><p><strong>删除动态参数要指定 delete-config</strong>。当我们删除完动态参数配置后，再次运行查看命令，结果如下：</p><pre><code>#查看cluster-wide范围参数$ bin/kafka-configs.sh --bootstrap-server kafka-host:port  --entity-type brokers --entitDefault config for brokers in the cluster are:</code></pre><pre><code>#查看Broker 1上的动态参数配置$ bin/kafka-configs.sh --bootstrap-server kafka-host:port  --entity-type brokers --entitConfigs for broker 1 are:`</code></pre><p>此时，刚才配置的所有动态参数都已经被成功移除了。</p><p>刚刚我只是举了一个参数的例子，如果你想要知道动态 Broker 参数都有哪些，一种方式是在 Kafka 官网中查看 Broker 端参数列表，另一种方式是直接运行无参数的 kafka-configs脚本，该脚本的说明文档会告诉你当前动态 Broker 参数都有哪些。我们可以先来看看下面这两张图。</p><div class=pgc-img><img alt=Kafka动态配置了解下？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5ae3619348ef45db8f89234533a72bb4><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=Kafka动态配置了解下？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/38bf02fa76ed479eaadb3789571cdd81><p class=pgc-img-caption></p></div><p>看到有这么多动态 Broker 参数，你可能会问：这些我都需要调整吗？你能告诉我最常用的几个吗？根据我的实际使用经验，我来跟你分享一些有较大机率被动态调整值的参数。</p><p><strong>1.log.retention.ms</strong>。</p><p>修改日志留存时间应该算是一个比较高频的操作，毕竟，我们不可能完美地预估所有业务的消息留存时长。虽然该参数有对应的主题级别参数可以设置，但拥有在全局层面上动态变更的能力，依然是一个很好的功能亮点。</p><p><strong>2.num.io.threads 和 num.network.threads</strong>。</p><p>这是我们在前面提到的两组线程池。就我个人而言，我觉得这是动态 Broker 参数最实用的场景了。毕竟，在实际生产环境中，Broker 端请求处理能力经常要按需扩容。如果没有动态 Broker 参数，我们是无法做到这一点的。</p><p><strong>3. 与 SSL 相关的参数</strong>。</p><p>主要是 4 个参数（ssl.keystore.type、ssl.keystore.location、ssl.keystore.password 和ssl.key.password）。允许动态实时调整它们之后，我们就能创建那些过期时间很短的 SSL证书。每当我们调整时，Kafka 底层会重新配置 Socket 连接通道并更新 Keystore。新的连接会使用新的 Keystore，阶段性地调整这组参数，有利于增加安全性。</p><p><strong>4.num.replica.fetchers</strong>。</p><p>这也是我认为的最实用的动态 Broker 参数之一。Follower 副本拉取速度慢，在线上Kafka 环境中一直是一个老大难的问题。针对这个问题，常见的做法是增加该参数值，确保有充足的线程可以执行 Follower 副本向 Leader 副本的拉取。现在有了动态参数，你不需要再重启 Broker，就能立即在 Follower 端生效，因此我说这是很实用的应用场景。</p><h1 class=pgc-h-arrow-right>总结</h1><p>本文重点讨论了 Kafka 1.1.0 版本引入的动态 Broker 参数。这类参数最大的好处在于，无需重启 Broker，就可以令变更生效，因此能够极大地降低运维成本。除此之外，还给出了动态参数的保存机制和设置方法。</p><h1 class=pgc-h-arrow-right>推荐阅读</h1><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6838587386201375246/?group_id=6838587386201375246" rel="noopener noreferrer" target=_blank>绝对干货，掌握这27个知识点，轻松拿下80%的技术面试(Java岗)</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6834116040591409667/?group_id=6834116040591409667" rel="noopener noreferrer" target=_blank>一线大厂为什么面试必问分布式？</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6833015309616546308/?group_id=6833015309616546308" rel="noopener noreferrer" target=_blank>在一次又一次的失败中,我总结了这份万字的《MySQL性能调优笔记》</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6826325537179304456/?group_id=6826325537179304456" rel="noopener noreferrer" target=_blank>并发编程详解:十三个工具类,十大设计模式,从理论基础到案例实战</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6840807600871703051/?group_id=6840807600871703051" rel="noopener noreferrer" target=_blank>如何高效部署分布式消息队列？这份《RabbitMQ实战》绝对可以帮到你</a></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Kafka','动态','了解'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>