<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一般人不知道的线程间数据交换Exchanger | 极客快訊</title><meta property="og:title" content="一般人不知道的线程间数据交换Exchanger - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/df26ce3a590f4daba6b29648f36e3ae7"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/543694ba.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/543694ba.html><meta property="article:published_time" content="2020-11-14T21:00:06+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:06+08:00"><meta name=Keywords content><meta name=description content="一般人不知道的线程间数据交换Exchanger"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/543694ba.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一般人不知道的线程间数据交换Exchanger</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>线程间的数据共享除了定义一个共享数据然后各个线程去访问这种方式外，还可以使用Exchanger交换数据。</p><h1 class=pgc-h-arrow-right>简单案例</h1><p>首先看看Exchanger的运用，Exchanger最简单的测试代码，如下图：</p><div class=pgc-img><img alt=一般人不知道的线程间数据交换Exchanger onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/df26ce3a590f4daba6b29648f36e3ae7><p class=pgc-img-caption></p></div><p>对应打印的结果如下：</p><p>线程2创建对象java.lang.Object@3f6d4362</p><p>线程1创建对象java.lang.Object@c986ad7</p><p>线程2得到的类java.lang.Object@c986ad7</p><p>线程1得到的类java.lang.Object@3f6d4362</p><p>可以看出来线程2创建的对象与线程1得到的线程是同一个对象，也就是他们指向的是同一个引用。</p><h1 class=pgc-h-arrow-right>Exchanger源码分析</h1><p>Exchanger只提供了两个exchange方法，一个是只带交换的数据参数，另外一个不仅有数据参数，还有时间限制，这也从侧面说明exchange是一个阻塞线程的方法，并且可以指定阻塞时间，这里我们先分析下不带时间参数的exchange方法，源码分析主流程如下图：</p><div class=pgc-img><img alt=一般人不知道的线程间数据交换Exchanger onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5f8d684e8d294b5bbdeff1c540d47d25><p class=pgc-img-caption></p></div><p>左边是exchange方法的代码流程图，比较简单可以明显的看出来主要依靠两个方法slotExchange与arenaExchange方法，流程主要有两步，<strong>首先尝试从slotExchange方法获取值，如果获取为null则再从arenaExchange方法获取，当返回还是null时则抛出中断异常，否则最终返回结果</strong>。</p><h1 class=pgc-h-arrow-right>slotExchange源码分析</h1><p>上图中右边的分析图是slotExchange方法的主要代码图，再分析这个方法前先说明一下Exchanger的一个内部类Node,Node有7个属性，这里先说明三个属性item（创建node线程要交换出去的值）、match（创建node线程要获取的值）、parked（创建node的线程）；每个线程再执行到Exchanger方法后都会创建一个Node。</p><p>理解这个基本概念后，再来快速过一下slotExchange方法流程，方法包含两个循环，第一个循环分析如下：</p><p>首先判断Exchanger的slot是否为null，<strong>如果不为空则尝试修改slot值为null,如果修改成功则返回slot的item,并设置slot的match，并唤醒slot的线程，交换成功</strong>。如果设置失败则说明有其他线程正在修改slot，即存在竞争，这是会判断机器的CPU数，如果大于1则会初始化Exchanger的Node[] arena（这个是下个方法说明），进入下一个循环。</p><p>如果slot为null则判断arena是否为null，如果不为null则直接返回null，表示由arenaExchange去执行。</p><p>如果都不是则尝试当前线程的node的item设置为要交换的值，同时尝试设置为slot，设置成功则跳出循环，失败则进入下次循环；</p><p><br></p><p><strong>第一个循环主要包含两步，如果slot不为null则尝试交换值，交换成功就返回，否则就尝试设置slot的值，设置成功就跳出循环</strong>；在cpu是多个的情况下又存在竞争的情况下会再arenaExchange去处理。</p><p>这个循环如果跳出来了则说明设置slot成功，那么当前线程只需要等待node的match不为null就行，<strong>所以第二个循环的判断条件就是node的match不为null，如果为null就挂起，当唤醒的时候再判断，直到node的match不为null则返回match的值。</strong></p><h1 class=pgc-h-arrow-right>分析arenaExchange方法</h1><p>在slotExchange方法中会在存在竞争修改slot并且运行程序的机器的CPU大于1时会初始化Node[] arena属性，在第二次修改slot还存在竞争失败时就会返回null,这个时候就到了arenaExchange方法上场了。</p><p><strong>arenaExchange也是一个for的无限循环，每次取出当前线程的Node来获取进行处理，这里再介绍node一个属性index,用来标记node</strong><strong>再</strong><strong>arena数组的位置</strong>，处理流程的简单分析如下：</p><p>首先根据node的index获取j（计算方法：index&lt;&lt;7+ABASE(1&lt;&lt;7的常量)，原因后面特别说明），如果不为null则尝试修改arena的第j项为null，如果成功则返回arena[j]的node的item的值，并设置match，最后唤醒node保存的线程。</p><p>第二步如果node为null则把当前线程的node的item设置为要交换出去的值，然后尝试修改arena[j]的值为当前线程的node，如果修改成功则循环判断match的值，当不为null则返回值，否则判断线程中断等条件后则挂起线程，等唤醒再判断。</p><p>第三步也就是node不为null，但是在第一步更新失败后，会根据node的bound与Exchange的bound等对比，计算index的值，有时会增长有时会减少，然后进入下一个循环判断。</p><p>总结这三步主要目的如下，<strong>首先是尝试从arena找一个节点来交换数据，如果交换成功则唤醒对应的线程并返回交换结果，如果交换失败则更新index，再次尝试寻找并交换，如果在找到的arena[j]为null则尝试新建一个node并保存进arena，挂起线程等待唤醒</strong>。</p><p>对之前的arena的j特别说明，把index扩大再作为数组的索引，原因是内存在加载数组一个元素时会把附近的也加载，而修改过后会把加载出来的设置为过期，为了避免这种浪费在数组间隔一定位置在设置值。</p><h1 class=pgc-h-arrow-right>总结</h1><p>Exchanger利用一个Node类型的属性slot实现线程间的交换，如果slot为null则初始化一个并设置item为需要交换的值，然后挂起，当其他线程进来的时候看到slot为null则取出node的item值，然后把自己要交换的值设置进match上，然后唤醒node中线程。</p><p>利用一个属性也够了，但是在并发的情况下吞吐量并不高，所以又建了一个Node的数组arena，线程在arena一个个找不为null的值，尝试修改直到修改成功，则获取node的item，再设置match并唤醒线程。如果找到的为null则自己主动new一个node并设置item,然后挂起等待唤醒。</p><p><br></p><p>Java程序员日常学习笔记，如理解有误欢迎各位交流讨论！</p><div class=pgc-img><img alt=一般人不知道的线程间数据交换Exchanger onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/fd903d7d90574f57af18c224be17a56c><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'程间','数据','交换'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>