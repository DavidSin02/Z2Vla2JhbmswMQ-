<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Android WMS 及 绘图机制 | 极客快訊</title><meta property="og:title" content="Android WMS 及 绘图机制 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/898e1a9a20264a19a7ccecdc184d38ae"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/55bf9ea8.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/55bf9ea8.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/55bf9ea8.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/55bf9ea8.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/55bf9ea8.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/55bf9ea8.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/55bf9ea8.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/55bf9ea8.html><meta property="article:published_time" content="2020-10-29T21:08:51+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:51+08:00"><meta name=Keywords content><meta name=description content="Android WMS 及 绘图机制"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/55bf9ea8.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Android WMS 及 绘图机制</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6823978543869854220/?group_id=6823978543869854220" rel="noopener noreferrer" target=_blank>最新(2020)Android高级面试知识点干货分享（五）</a></p><p>*转载请注明出处！*</p><h1 class=pgc-h-center-line>一、Android自定义View</h1><blockquote class=pgc-blockquote-abstract><p>更深入一点的，应该了解一下WMS，以及View与Window、Activity之间是怎么关联，怎么添加上去的。针对View，还得了解它的测量模式与测量规范。</p></blockquote><ul><li>延伸：从源码角度分析View的绘制流程(onAttach--onMeasure---onLayout---onDraw)</li></ul><h1 class=pgc-h-center-line>$1.1、Activity、Window/PhoneWindow、View、ViewRootImpl、DecorView的关系</h1><p>下面这图是我自己根据源码画的图：从Activity启动开始，WMS是如何把View添加到窗口上且与Activity相关起来的。</p><p><br></p><div class=pgc-img><img alt="Android WMS 及 绘图机制" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/898e1a9a20264a19a7ccecdc184d38ae><p class=pgc-img-caption></p></div><p></p><p>下面这图来源于网络，清楚的展现出了Activity、PhoneWindow/Window、DecorView三者之间的关系。</p><p><br></p><div class=pgc-img><img alt="Android WMS 及 绘图机制" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b72db644f2fb496a915ed9f2e49c67a1><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-center-line>二、Android 动画绘制原理</h1><p><strong>$2.1、 Android屏幕刷新机制</strong></p><ul><li>每隔16.6ms刷新一次屏幕(即每帧【每一屏幕】绘制时间大致为16.6ms:理想状态下，每秒展示不低于60帧(FPS)时才会感觉不到卡顿 ，即一帧屏幕绘制完耗时：1000ms/60fps = 16.6ms）</li><li>帧的渲染过程(下图来源于google开发者文档)</li></ul><p><br></p><div class=pgc-img><img alt="Android WMS 及 绘图机制" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/66531b9cfe0b4b1387334f2f333cd68a><p class=pgc-img-caption>帧的渲染过程</p></div><p><strong>$2.2、典型的显示系统：CPU、GPU、Buffer</strong></p><p>（只有一个缓冲，又称单缓冲）</p><p><br></p><div class=pgc-img><img alt="Android WMS 及 绘图机制" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3451620bf5cd4dadb8f2d6af5ca29f61><p class=pgc-img-caption>简单显示系统（单缓冲）</p></div><ul><li>显示器重要特性：</li><li>行频(HSYNC:水平扫描频率Horizontal Scanning Frequency)：HSYNC脉冲信号为高电平时，将告诉系统该扫描下一行了，即要转到下一行起始处了。</li><li>场频(VSYNC:垂直扫描频率Vertical Scanning Frequency)：由于屏幕是先从左至右扫描，再垂直扫描，因此场频也是作为屏幕刷新完毕的条件，即每秒屏幕刷新的的次数。</li><li>行频 = 场频 * 纵座标分辨率</li></ul><p>（下图来源于网络）</p><p><br></p><div class=pgc-img><img alt="Android WMS 及 绘图机制" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/76475f00abb341de8588c143294f6687><p class=pgc-img-caption>屏幕刷新过程</p></div><p><br></p><ul><li>VSync(VerticalSynchronization)垂直同步：</li></ul><p>当屏幕从左至右，从上到下扫描一次完毕后，又将从头开始，进入下一次循环。</p><p>这时有一段时间空隙，叫做VBI(VerticalBlankingInterval)。</p><p>因为此时屏幕没有在刷新，这个时间点就是我们进行缓冲区交换的最佳时间，也就避免了交换过程中出现 screentearing的状况</p><p>VSync是属于脉冲信号，由高低电平来控制类似开关的操作。因此在VBI时，底层硬件发出VSync脉冲信号，来进行缓冲区数据的交互。</p><p><br></p><p>DoubleBuffer双缓冲系统：</p><p><br></p><div class=pgc-img><img alt="Android WMS 及 绘图机制" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/9fb5acd3131040e9b08b41ed8b2ff183><p class=pgc-img-caption>显示系统（双缓冲）</p></div><p><br></p><p>Triple Buffer三级缓冲：</p><p>与双缓冲差不多，就是多了一个BackBuffer.</p><p><strong>$2.3、 View动画（Tween Animation 补间动画)</strong></p><ul><li>- View.startAnimation(mAnimation):</li></ul><p>调用此方法时，并不会立即开始动画，startAnimation方法里面会去遍历View树，调用draw()方法进行绘制，最终执行动画的方法是在draw()方法里面</p><ul><li>主要执行流程图：</li></ul><p><br></p><div class=pgc-img><img alt="Android WMS 及 绘图机制" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/417ac724a3144f81ac2358edc4f942c3><p class=pgc-img-caption>动画执行流程</p></div><p><br></p><p>记住一点：</p><p><strong class=highlight-text>View动画最后执行的原理为Matrix矩阵变换</strong>。比如：平移、缩放、旋转，Alpha渐变等。变换的是parentView，也就是ViewGroup，但对其他没影响。因此View动画才不会改变view的属性。</p><p></p><p><strong>$2.4、 属性动画（Property Animator)</strong></p><ul><li>工作原理</li></ul><p>在一定时间间隔内，通过不断对值进行改变，并不断将该值赋给对象的属性，从而实现该对象在该属性上的动画效果</p><ul><li>执行流程图</li></ul><p>属性动画在原理上与视图动画有很大的区别。属性动画是利用显示系统原理来进行渲染显示。在Android中主要是利用SurfaceFlinger 与 Choreographer来接收VSnc垂直同步信号，通过帧回调来刷新界面显示。</p><ul><li>SurfaceFlinger:用于接收各种数据，并组进行组合，之后将结果存入FrameBuffer中。以便Display显示系统从中获取。类似【编剧】</li><li>Choreographer:编舞者。用于对View的编排。由ViewRootImpl持有。当接收到VSnc信号时，就会执行回调方法</li></ul><p></p><p><strong>插值器（Interpolator）</strong></p><ol start=1><li>一个辅助动画实现的接口；</li><li>设置属性值 从“初始值” 【过渡】到“结束值”的变化规律（如：匀速、加速、减速、先加速后减速、先减速后加速。可根据需要的变化规律进行自定义插值器）；</li><li>系统内置插值器：</li></ol><ul><li>LinearInterpolator(线性插值器)：动画匀速改变</li><li>DecelerateInterpolator(减速插值器):动画高速开始，减速运行</li><li>AccelerateInterpolator(加速插值器):动画低速开始，加速运行</li><li>AccelerateDecelerateInterpolator:先加速后减速</li><li>AnticipateInterpolator：先退后，再加速向前至终点结束</li><li>AnticipateOvershootInterpolator：先退后，再加速先进，越过终点后，再返回终点</li><li>BounceInterpolator：到达终点后，再回弹，至静止</li><li>CycleInterpolator：周期运动（动画可以不到终点就回弹，也可以到了终点后在回弹，还可以回弹多次，小于1.0f不到终点就回弹，大于1.0f会到了终点后回弹，如果大于2，则会回弹多次）</li><li>OvershootInterpolator：快速完成动画，会超出一点然后再回到结束样式</li><li>PathInterpolator：根据路径来控制动画的执行快慢，路径可以是贝塞尔曲线，也可以是普通Path。</li></ul><p><strong>估值器（TypeEvaluator)</strong></p><ul><li>一个辅助动画插值器实现的接口；</li><li>设置属性值 在从初始值过渡到结束值的变化规律中的过渡值。(如：从0 过渡到1时，估值器会根据给定的插值器变化规律，估算出0~1之间的过渡值：0.4，0.6，0.7等)</li><li>系统内置估值器：IntEvaluator、FloatEvaluator、ArgbEvaluator(针对Color)</li><li>为属性动画所特有，可自定义</li></ul><h1 class=pgc-h-center-line>三、Android Camera系统</h1><p>重点相关概念及知识点：</p><p><strong>$3.1、照相机物理架构(下图来源于网络)</strong></p><p><br></p><div class=pgc-img><img alt="Android WMS 及 绘图机制" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a7708f615a8149a68df3008580eb4b3d><p class=pgc-img-caption></p></div><p><strong>为生产者消费者模型</strong>：</p><p>Camera负责生产，Display负责消费</p><p>名词解释：</p><ul><li>IPU: Image Process Unit 图像处理单元，用于控制摄像机和显示屏</li><li>DMA:内存映射（在这里指将IPU采集到的数据DMA到内存里面</li><li>QBUF(QueueBuffer):缓存队列</li><li>DQBUF(DequeueBuffer):空闲队列</li></ul><p></p><p><strong>$3.2、Camera Android架构(下图来源于网络)</strong></p><p><br></p><div class=pgc-img><img alt="Android WMS 及 绘图机制" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bbe43e7979854127b197ae4eb1cf0245><p class=pgc-img-caption></p></div><p><strong>$3.3、Camera、Camera2、CameraX</strong></p><p><br></p><div class=pgc-img><img alt="Android WMS 及 绘图机制" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c4dd445704104330bf34d9bb66c415da><p class=pgc-img-caption></p></div><p><br></p><p><strong>$3.4、Surface、SurfaceView、SurfaceHolder</strong></p><ul><li>Surface: 对应一块屏幕缓冲区，它是由SurfaceFlinger(屏幕显示内容合成器)来管理的【原始缓冲区】的句柄(即Surface对象为SurfaceFlinger所持有)。</li></ul><blockquote class=pgc-blockquote-abstract><p>每个Window对应一个Surface。所有的View都要画在Surface的Canvas上。传统的View共享一块屏幕缓冲区，即共享一个Surface,且所有的绘制都在UI线程。</p></blockquote><p><br></p><ul><li>-总结：拿到Surface对象后，就可以获取原始缓冲区中的原始数据或者往缓冲区中存储数据、获取Canvas画布、其他。</li><li>SurfaceView:</li></ul><blockquote class=pgc-blockquote-abstract><p>它继承自View，里面新建了一个Window对象，因此SurfaceView内嵌了一个Surface,SurfaceView则用来控制Surface里面的View的位置与尺寸。</p></blockquote><p><br></p><ul><li>SurfaceHolder:</li></ul><p>接口，用于访问和控制SurfaceView中Surface相关的方法。</p><p></p><p><strong class=highlight-text>Surface\SurfaceView\SurfaceHolder为典型的MVC模式。</strong></p><p><strong>$3. 5、SurfaceTexture</strong></p><p>SurfaceTexture和SurfaceView不同的是，它对图像流的处理并不直接显示，而是转为GL外部纹理，因此可用于图像流数据的二次处理（如Camera滤镜，桌面特效等）。比如Camera的预览数据，变成纹理后有以下2种处理方式：</p><ul><li>可以交给GLSurfaceView直接显示，</li><li>也可以通过SurfaceTexture交给TextureView作为View heirachy中的一个硬件加速层来显示。</li><li>首先，SurfaceTexture从图像流（来自Camera预览，视频解码，GL绘制场景等）中获得帧数据，当调用updateTexImage()时，</li></ul><p>根据内容流中最近的图像更新SurfaceTexture对应的GL纹理对象，</p><ul><li>接下来，就可以像操作普通GL纹理一样操作它了。</li><li>TextureView与SurfaceView的区别：</li><li>TextureView是将纹理加入到了View树中，因此可以像操作普通View一样操作此纹理控件。</li><li>SurfaceView则是有独立的Surface,可以在子线程中展示。独立于View树。</li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Android','WMS','绘图'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>