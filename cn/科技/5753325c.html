<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>如何实现一个分布式统计和过滤的链路追踪 | 极客快訊</title><meta property="og:title" content="如何实现一个分布式统计和过滤的链路追踪 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/3476ff40e4614445b3755a142c79cba8"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5753325c.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5753325c.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5753325c.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5753325c.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5753325c.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5753325c.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5753325c.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5753325c.html><meta property="article:published_time" content="2020-11-14T21:06:12+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:12+08:00"><meta name=Keywords content><meta name=description content="如何实现一个分布式统计和过滤的链路追踪"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/5753325c.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>如何实现一个分布式统计和过滤的链路追踪</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><br></p><p>首届云原生编程挑战赛正在报名中，初赛共有三个赛道，题目如下：</p><p><br></p><p>赛道一：实现一个分布式统计和过滤的链路追踪</p><p>赛道二：实现规模化容器静态布局和动态迁移</p><p>赛道三：服务网格控制面分治体系构建</p><p><br></p><p>本文主要针对赛道一题目做出剖析，帮助选手更高效的解题。<strong>点击文末“阅读原文”，获取赛道一详情。</strong></p><p><br></p><h2 class=pgc-h-arrow-right><strong>背景</strong></h2><hr><p><br></p><p>为了应对各种复杂的业务，系统架构也从单机大型软件演化成微服务架构。微服务构建在不同的软件集上，这些软件模块可能是由不同团队开发的，可能使用不同的编程语言来实现，还可能发布在多台服务器上。因此，如果一个服务出现问题，可能导致几十个服务都出现异常。</p><p><br></p><p>分布式追踪系统用来记录请求范围内的信息，用户在页面的一次点击发送请求，这个请求的所有处理过程，比如经过多少个服务，在哪些机器上执行，每个服务的耗时和异常情况。可参考链路追踪的概念：</p><p><br></p><p><u>https://help.aliyun.com/document_detail/90498.html?spm=5176.12281978.0.0.6ae23149d34P0g</u></p><p><br></p><p>采集链路数据过程中，采集的数据越多，消耗的成本就越多。为了降低成本，目前普遍的做法是对数据进行采样。请求是否采样都是从头节点决定并通过跟踪上下文透传到所有节点(head-based sampling)。</p><p><br></p><p>目前业界普遍的采样都是按照这个方式，比如固定比例采样(Probabilistic Sampling)，蓄水池采样(Rate Limiting Sampling)，混合采样(Adaptive Sample)。这样的采样可以保证整个调用链的完整性。但是这样采样也带来两个问题：</p><p><br></p><p>1、有些异常和慢请求因为采样的原因没有被采集到，而这些链路数据对业务很重要。</p><p>2、99% 的请求都是正常的，而这些数据对问题排查并不重要，也就是说大量的成本花在并不重要的数据上。</p><p><br></p><p>本题目是另外一种采样方式(tail-based Sampling)，只要请求的链路追踪数据中任何节点出现重要数据特征（错慢请求），这个请求的所有链路数据都采集（由分布式微服务的各个节点上产生），这种采样方式在一些场景特别有效，比如错慢全采，大客户全采。目前开源的链路追踪产品都没有实现完整的 tail-based Sampling ，主要的挑战是：任何节点出现符合采样条件的链路数据，那就需要把这个请求的所有链路数据采集。即使这些链路数据在这个链路节点之前或者之后产生，即使这些链路数据在分布式系统的成百上千台机器上。</p><p><br></p><h2 class=pgc-h-arrow-right><strong>赛题</strong></h2><hr><p><br></p><p><strong>首届云原生编程挑战赛赛题一题目：实现一个分布式统计和过滤的链路追踪</strong></p><p><br></p><p>用户需要实现两个程序，一个是数量流（橙色标记）的处理程序，该程序拉取数据后进行处理，一个是后端程序（蓝色标记），和客户端数据流处理程序（橙色标记）通信，将最终数据结果在后端引擎上聚合。</p><div class=pgc-img><img alt=如何实现一个分布式统计和过滤的链路追踪 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3476ff40e4614445b3755a142c79cba8><p class=pgc-img-caption></p></div><p><br><strong>架构示例图</strong></p><p><br></p><p>赛题可以理解为很多组数据（trace）分布在两台机器上，任何一条数据（span）符合采集条件（ http.status_code 不为 200，或者 error 等于1），需要将这组数据（trace）从两台机器上采集下来，在后端程序上聚合汇总。</p><p><br></p><p>数据聚合过程如下图：</p><p><br></p><div class=pgc-img><img alt=如何实现一个分布式统计和过滤的链路追踪 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1362dfeeee2241bc9f5febf23b511cef><p class=pgc-img-caption></p></div><p><br>数据处理示例图</p><p><br></p><h2 class=pgc-h-arrow-right><strong>赛题分析</strong></h2><hr><p><br></p><p>赛题数据处理很简单，就是一个 map-reduce 处理。在实际场景中，无法将所有数据都上报进行实时计算（全量上报的数据量非常大），需要在客户端完成筛选，在服务端进行聚合。</p><p><br></p><p><strong>最大程度利用三台分布式机器的资源</strong></p><p><br></p><p>最简单的解决方案是，在一台机器上读取多个数据流数据存放到一个文件中。跳过数据同步的过程，直接对这个文件做数据聚合。这样处理会带来两个问题：</p><p>1、只利用单台机器的资源，无法充分利用另外两台机器的资源。</p><p>2、存放到文件中，涉及到读写硬盘，相比内存处理会慢一些。</p><p><br></p><p>为了最大限度的利用三台机器的资源，需要三者之间良好的协同。我们可以分析链路追踪的场景，需要采集的数据占总数据的比例比较低。那可以在数据处理层做第一次过滤，过滤后三台机器只需要基于需要采集的数据进行通信。</p><p><br></p><p><strong>数据处理端的数据缓存、同步</strong></p><p><br></p><p>每个节点都只有部分数据，需要将数据进行缓存，再将符合条件的数据在服务端聚合。<br>数据处理示例图中，数据流 1 缓存了 traceId:1,traceId:2,traceId:3. 检测发现 traceId ：2 符合采集条件。数据流 2 也缓存了 traceId:1,traceId:2,traceId:3，检测发现traceId：3 符合采集条件. 那最终只需要聚合 traceId:2,traceId:3 的数据。traceId：1 的数据不做任何处理。</p><p><br></p><p>在评测环境，数据流 1 和数据流 2 都大于 4G 的数据， 而处理数据流的机器内存都只有 4G ，无法在内存中做全量缓存。那选手需要思考做流式缓存处理。在链路追踪的真实场景中，会有时间窗口方式来处理，一般请求不会超过 3 分钟，各个数据流节点同步时间窗口内的数据。同步数据，那就需要保持各个接口数据的同步。而各个节点的数据处理有快有慢，同步的话，可能会 block 数据处理，对性能有影响。通用的解决方式是多个线程来处理，数据处理和数据同步分别两个线程。，数据处理和线程拉取数据并处理，数据同步是对历史数据做同步，例如数据处理示例图中，在数据处理线程处理traceId：3 时， 数据同步线程可以上报 traceId：2 的数据。</p><p><br></p><p><strong>服务端的数据缓存，同步和聚合</strong></p><p><br></p><p>服务端收集到这个节点的数据后，需要检查各个节点数据是否齐全，如果齐全的话，那需要收集各个节点的数据，如果不齐全的话，那就需要继续等待，甚至阻塞数据上报，直到数据齐全或者超时。比如说，采集某一段数据或者某一个时间窗口的数据时， 节点 1 的数据上报了，节点 2 数据未上报，那需要继续等待节点2的数据。由于并发执行的缘故，节点1的数据在持续上报，而节点 2 数据迟迟未上报，那就需要考虑超时，缓存清除，数据同步。</p><p><br></p><p>数据聚合时，题目对真实场景做了简化。在真实场景中，需要同一个请求的所有数据（同一个 traceId 下的所有 span ）构建调用关系的一颗树。</p><p><br></p><div class=pgc-img><img alt=如何实现一个分布式统计和过滤的链路追踪 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6137cac18dcf45a7a426f201d531e204><p class=pgc-img-caption></p></div><p>实际场景中的链路详情展示（阿里云链路追踪产品）</p><p><br></p><p>简化后，选手只需要根据数据的 startTime 做升序排序，生成 checkSum（Md5）值,保证数据完整性的同时降低业务逻辑的强耦合。具体的 Md5 计算可参考 Demo 。</p><p><br></p><p><strong>其他的优化点</strong></p><p><br></p><p>1、rpc 建立长连接。<br>2、Demo 程序采用的 http 方式，本地在服务端程序除了开放了8002端口，还开放了8003，8004端口。选手可以利用这些端口开启长连接通信，比如dubbo，grpc，加快处理过程，提高性能。<br>3、多线程拉取。<br>4、为了充分利用数据处理程序的机器资源，可以通过Rang方式多线程去拉取数据。</p><p><br></p><p><u>https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests?spm=5176.12282029.0.0.3d195131aJdGy4</u></p><p><br></p><p>例如curl -H 'Range: bytes=200-2000' "http://localhost:8081/trace1.data"。</p><p><br></p><h2 class=pgc-h-arrow-right><strong>赛题评测</strong></h2><hr><p><br></p><p>评测环境由 1 台 2 核 4G 的评测机，2 台 2 核 4G 的数据流处理机器和 1 台 1 核 2G 的后端服务组成。数据流处理机器和后端服务机器都会在docker内运行（docker 容器会限制 CPU 和内存大小）。</p><p><br></p><p>1、用户提交编译好的docker image（不限定开发语言，分布式程序建议用go和java）。</p><p>2、通过kubernetes的部署docker 容器。</p><p>3、评测机器调用数据流处理机器和后端服务机器，检查应用是否启动。</p><p>4、评测机器发送评测数据的位置发给数据流处理机器和后端服务机器，并开始计时。</p><p>5、评测机器收到上报的接口，并进行分值计算。<br>6、评测程序的跑分方式：将选手生成的结果同已知结果进行对比，计算 F1 Score；同时记录整个跑分从开始到输出结果的时间 time，最后的比赛得分: F1/time。即 F1 值越大越好，耗时越小越好。</p><p><br></p><h2 class=pgc-h-arrow-right><strong>总结</strong></h2><hr><p><br></p><p>本文结合首届云原生挑战赛的赛题背景、题目场景、题目分析和评测环境与过程的角度，介绍了分布式链路跟踪系统的tail-based sampling的基本设计思路，希望对即将参加比赛的同学们能有所帮助，也欢迎更多的技术同学报名参加我们的挑战赛，分享你在编程方面的思考和实践。</p><p><br></p><p><strong>更多</strong></p><hr><p><br></p><p>1、链路追踪相关的介绍：</p><p><u>https://cn.aliyun.com/product/xtrace</u></p><p><br></p><p>2、链路追踪的demo（需要开通链路追踪服务，开通后不上报数据，不收取任何费用）：</p><p><u>https://tracing.console.aliyun.com/?demo=1#/appList/cn-beijing</u></p><p><br></p><p>3、apache 顶级项目skywalging，优秀的开源的链路追踪项目：</p><p><u>https://github.com/apache/skywalking</u></p><p><br></p><p>4、云原生的可观察性的开源项目opentelemetry：</p><p><u>https://opentelemetry.io/</u></p><p><br></p><p>5、cncf的标准开源项目 jaeger：</p><p><u>https://www.jaegertracing.io/</u></p><p><br></p><p>以上内容来自<strong>赛道一的明星导师竹影。</strong></p><p><br></p><p><strong>作者信息：</strong></p><p>徐建伟，花名：竹影，具有多年系统架构、性能调优经验。目前主要从事链路跟踪、应用监控相关工作。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'实现','一个','统计'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>