<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>åŠ¨æ‰‹å­¦ä¹ TCPï¼šTCPè¿æ¥å»ºç«‹ä¸ç»ˆæ­¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®® | æå®¢å¿«è¨Š</title><meta property="og:title" content="åŠ¨æ‰‹å­¦ä¹ TCPï¼šTCPè¿æ¥å»ºç«‹ä¸ç»ˆæ­¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®® - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/2213ae70bb254bdcb7c9305d0a560b20"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5b8b8a5.html><meta property="article:published_time" content="2020-10-29T20:50:28+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:28+08:00"><meta name=Keywords content><meta name=description content="åŠ¨æ‰‹å­¦ä¹ TCPï¼šTCPè¿æ¥å»ºç«‹ä¸ç»ˆæ­¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®®"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/5b8b8a5.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>åŠ¨æ‰‹å­¦ä¹ TCPï¼šTCPè¿æ¥å»ºç«‹ä¸ç»ˆæ­¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®®</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p>TCPæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®®ï¼Œä»»ä½•ä¸€æ–¹åœ¨å‘é€æ•°æ®ä¹‹å‰ï¼Œéƒ½å¿…é¡»å…ˆåœ¨åŒæ–¹ä¹‹é—´å»ºç«‹ä¸€æ¡è¿æ¥ã€‚æ‰€ä»¥ï¼Œæœ¬æ–‡å°±ä¸»è¦çœ‹çœ‹TCPè¿æ¥çš„å»ºç«‹å’Œç»ˆæ­¢ã€‚</p><p>åœ¨å¼€å§‹ä»‹ç»TCPè¿æ¥ä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹TCPæ•°æ®åŒ…çš„é¦–éƒ¨ï¼Œé¦–éƒ¨é‡Œé¢æœ‰å¾ˆå¤šé‡è¦çš„å­—æ®µï¼Œåœ¨æˆ‘ä»¬å®ç°ç¨‹åºçš„æ—¶å€™éœ€è¦è¿›è¡Œè®¾ç½®ã€‚</p><h1>TCPçš„é¦–éƒ¨</h1><p>åœ¨OSIä¸ƒå±‚æ¨¡å‹ä¸­ï¼Œä¸Šå±‚çš„æ•°æ®åŒ…éƒ½ä¼šä½œä¸ºä¸‹å±‚æ•°æ®åŒ…çš„æ•°æ®éƒ¨åˆ†ï¼ˆpayloadï¼‰ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ„é€ TCPæ•°æ®åŒ…çš„æ—¶å€™ï¼Œä¼šæŠŠåº”ç”¨å±‚çš„æ•°æ®åŒ…ä½œä¸ºTCPåŒ…çš„æ•°æ®éƒ¨åˆ†ï¼Œç„¶ååŠ ä¸ŠTCPå¤´æ„æˆTCPæ•°æ®åŒ…ï¼›åŒæ ·ï¼Œå½“æ„é€ IPæ•°æ®åŒ…çš„æ—¶å€™ï¼Œæ•´ä¸ªTCPåŒ…å°±ä¼šè¢«å½“ä½œæ•°æ®éƒ¨åˆ†ï¼Œç„¶ååŠ ä¸ŠIPå¤´æ„æˆIPæ•°æ®åŒ…ã€‚</p><div class=pgc-img><img alt=åŠ¨æ‰‹å­¦ä¹ TCPï¼šTCPè¿æ¥å»ºç«‹ä¸ç»ˆæ­¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®® onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2213ae70bb254bdcb7c9305d0a560b20></div><p>TCPå¤´çš„æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼Œåœ¨ä¸åŒ…æ‹¬å¯é€‰å­—æ®µçš„æƒ…å†µä¸‹ï¼Œä¸€èˆ¬TCPå¤´ä¼šå ç”¨20ä¸ªå­—èŠ‚ã€‚</p><div class=pgc-img><img alt=åŠ¨æ‰‹å­¦ä¹ TCPï¼šTCPè¿æ¥å»ºç«‹ä¸ç»ˆæ­¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®® onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6f2c33f651c44c8fa261039e49333852></div><p><strong>åœ¨TCPé¦–éƒ¨ä¸­ï¼Œæœ‰å‡ ä¸ªå­—æ®µæ˜¯éœ€è¦å…³æ³¨ä¸€ä¸‹ï¼š</strong></p><ul><li>åœ¨TCPé¦–éƒ¨ä¸­æ²¡æœ‰æºå’Œç›®æ ‡çš„IPã€MACåœ°å€ï¼ˆIPå’ŒMACåœ°å€åˆ†åˆ«æ˜¯ç½‘ç»œå±‚å’Œé“¾è·¯å±‚é¦–éƒ¨çš„ä¿¡æ¯ï¼‰ï¼Œåªæœ‰æºå’Œç›®æ ‡çš„ç«¯å£</li><li>Sequence Numberæ˜¯åŒ…çš„åºå·ï¼Œç½‘ç»œå±‚ï¼ˆIPå±‚ï¼‰çš„ä¼ è¾“æ˜¯ä¸å¯é çš„ï¼Œå¯èƒ½äº§ç”ŸåŒ…ä¹±åºï¼Œæ‰€ä»¥è¿™ä¸ªéœ€è¦å¯ä»¥è§£å†³ç½‘ç»œåŒ…ä¹±åºçš„é—®é¢˜</li><li>Acknowledgement Numberç”¨æ¥ç¡®è®¤æ”¶åˆ°æ•°æ®åŒ…çš„ç¡®è®¤åºå·ï¼Œä¸ºTCPçš„ä¼ è¾“æä¾›äº†å¯é æ€§ä¿è¯</li><li>TCP FlagsåŒ…æ‹¬äº†8ä¸ªbitï¼Œé€šè¿‡å¯¹è¿™äº›bitçš„è®¾ç½®ï¼Œå¯ä»¥ä»£è¡¨ä¸åŒç±»å‹çš„TCPæ•°æ®åŒ…</li></ul><p>ä¸‹é¢å°±çœ‹çœ‹TCPè¿æ¥çš„å»ºç«‹å’Œç»ˆæ­¢ã€‚</p><h1>TCPè¿æ¥å»ºç«‹</h1><p>TCPè¿æ¥å»ºç«‹çš„è¿‡ç¨‹è¢«ç§°ä¸ºä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š</p><ol><li>è¿æ¥å»ºç«‹å‘èµ·ç«¯å‘é€[SYN]åŒ…ï¼Œè¯¥ç«¯å°†ä¸»åŠ¨æ‰“å¼€ï¼ˆactive openï¼‰</li><li>æ¥æ”¶ç«¯å°†å‘é€[SYN, ACK]åŒ…ï¼Œè¯¥ç«¯å°†è¢«åŠ¨æ‰“å¼€ï¼ˆpassive openï¼‰ï¼ŒACKæ ‡å¿—è¡¨ç¤ºå¯¹æ”¶åˆ°çš„[SYN]åŒ…çš„ç¡®è®¤</li><li>è¿æ¥å»ºç«‹å‘èµ·ç«¯å‘é€[ACK]åŒ…ç¡®è®¤[SYN, ACK]åŒ…</li></ol><div class=pgc-img><img alt=åŠ¨æ‰‹å­¦ä¹ TCPï¼šTCPè¿æ¥å»ºç«‹ä¸ç»ˆæ­¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®® onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/52b3e6184085488b8a6680a0259c8f69></div><h1>Initial Sequence Number</h1><p>è¿æ¥å»ºç«‹è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªé‡è¦çš„å·¥ä½œå°±æ˜¯åˆå§‹åŒ–Sequence Numberï¼Œé€šä¿¡çš„åŒæ–¹åœ¨å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ä¸­äº’ç›¸é€šçŸ¥å¯¹æ–¹è‡ªå·±çš„åˆå§‹Sequence Numberï¼ˆISNï¼šInitial Sequence Numberï¼‰ã€‚ISNä¸æ˜¯å›ºå®šçš„ï¼ŒISNè·Ÿæ—¶é’Ÿç»‘å®šï¼Œæ ¹æ®ç‰¹å®šçš„é—´éš”è‡ªå¢ï¼Œç›´åˆ°è¶…è¿‡2^32ï¼Œåˆä»0å¼€å§‹ã€‚</p><p>SYNå…¨ç§°å°±æ˜¯Synchronize Sequence Numberï¼Œé€šè¿‡seqåºå·ï¼ŒTCPå°±å¯ä»¥ä¿è¯æ•°æ®åŒ…çš„é¡ºåºï¼›é€šè¿‡ackåºå·ï¼ŒTCPå°±æœ‰äº†å¯é æ€§ã€‚</p><h1>è¿æ¥å»ºç«‹æ³¨æ„ç‚¹</h1><p>åœ¨å»ºç«‹TCPè¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p><ol><li>[SYN]æ ‡å¿—çš„æ•°æ®åŒ…ä¼šä½¿ç”¨æ¶ˆè€—ä¸€ä¸ªåºå·ï¼Œæ‰€ä»¥å¯¹ç«¯çš„ç¡®è®¤å·ï¼ˆackï¼‰æ˜¯å½“å‰åºå·ï¼ˆseqï¼‰åŠ ä¸€</li><li>å½“è¢«åŠ¨æ‰“å¼€ç«¯å‘é€[ACK]ç¡®è®¤åŒ…çš„æ—¶å€™ï¼ŒåŒæ—¶è®¾ç½®äº†[SYN]æ ‡å¿—ï¼Œæ‰€ä»¥TCPè¿æ¥å»ºç«‹çš„è¿‡ç¨‹åªéœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œè€Œä¸æ˜¯å››æ¬¡</li></ol><h1>TCPè¿æ¥ç»ˆæ­¢</h1><p>TCPè¿æ¥ç»ˆæ­¢çš„è¿‡ç¨‹è¢«ç§°ä¸ºå››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹ï¼Œä»¥ä¸‹å›¾ä¸ºä¾‹ï¼š</p><ol><li>è¿æ¥ç»ˆæ­¢ç«¯ï¼ˆclientï¼‰å‘é€[FIN, ACK] åŒ…ï¼Œå…³é—­clientåˆ°serveræ–¹å‘çš„æ•°æ®å‘é€é€šè·¯</li><li>serverç«¯å‘é€[ACK]åŒ…æ¥ç¡®è®¤æ¥è‡ªclientçš„[FIN, ACK] åŒ…</li><li>serverç«¯å‘é€[FIN, ACK] åŒ…ï¼Œå…³é—­serveråˆ°clientæ–¹å‘çš„æ•°æ®å‘é€é€šè·¯</li><li>clientç«¯å‘é€[ACK]åŒ…æ¥ç¡®è®¤æ¥è‡ªserverçš„[FIN, ACK] åŒ…ï¼Œåˆ°æ­¤TCPè¿æ¥å…³é—­</li></ol><div class=pgc-img><img alt=åŠ¨æ‰‹å­¦ä¹ TCPï¼šTCPè¿æ¥å»ºç«‹ä¸ç»ˆæ­¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®® onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3bacf62a29ee4c08939ed6de4f5db07b></div><h1>è¿æ¥ç»ˆæ­¢æ³¨æ„ç‚¹</h1><p>åœ¨å»ºç«‹TCPè¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p><ul><li>[FIN]æ ‡å¿—çš„æ•°æ®åŒ…ä¼šä½¿ç”¨æ¶ˆè€—ä¸€ä¸ªåºå·ï¼Œæ‰€ä»¥å¯¹ç«¯çš„ç¡®è®¤å·ï¼ˆackï¼‰æ˜¯å½“å‰åºå·ï¼ˆseqï¼‰åŠ ä¸€</li><li>ä¸å»ºç«‹è¿æ¥æ—¶çš„ä¸‰æ¬¡ æ¡æ‰‹ä¸åŒï¼Œç»ˆæ­¢è¿æ¥éœ€è¦å››æ¬¡æŒ¥æ‰‹å› ä¸ºTCPè¿æ¥æ˜¯å…¨åŒå·¥çš„ï¼Œæ¯ä¸ªæ–¹å‘éƒ½å¿…é¡»å•ç‹¬è¿›è¡Œå…³é—­ã€‚å½“ä¸€æ–¹å®Œæˆå®ƒçš„æ•°æ®å‘é€ä»»åŠ¡åå°±èƒ½å‘é€ä¸€ä¸ªFINæ¥ç»ˆæ­¢è¿™ä¸ªæ–¹å‘çš„è¿æ¥ã€‚æ”¶åˆ°ä¸€ä¸ª FINåªæ„å‘³ç€è¿™ä¸€æ–¹å‘ä¸Šæ²¡æœ‰æ•°æ®æµåŠ¨ï¼Œä½†æ˜¯TCPè¿æ¥åœ¨æ”¶åˆ°ä¸€ä¸ªFINåä»èƒ½å‘é€æ•°æ®</li></ul><h1>TCPè¿æ¥å®éªŒ</h1><p>å¥½äº†ï¼Œäº†è§£äº†TCPè¿æ¥å»ºç«‹å’Œç»ˆæ­¢çš„åŸºæœ¬çŸ¥è¯†åï¼Œå°±å¯ä»¥é€šè¿‡Pcap.Netæ¥è¿›è¡ŒTCPè¿æ¥å»ºç«‹å’Œç»ˆæ­¢çš„å®éªŒäº†ã€‚</p><p>å»ºç«‹è¿æ¥ä»£ç çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>clientç¨‹åºä½¿ç”¨ä¸€ä¸ªåˆå§‹çš„seqåºå·ï¼ˆ100ï¼‰ï¼Œç„¶åç”Ÿæˆå¹¶å‘é€ä¸€ä¸ªå¸¦[SYN]æ ‡å¿—çš„TCPåŒ…</li><li>clientå°†æœŸå¾…æ¥è‡ªæœåŠ¡ç«¯çš„[SYN, ACK]åŒ…</li><li>å½“æ”¶åˆ°[SYN, ACK]åŒ…ä¹‹åï¼Œclientéœ€è¦ç”Ÿæˆå¹¶å‘é€ä¸€ä¸ª[ACK]åŒ…è¿›è¡Œç¡®è®¤ï¼Œè¿™ä¸ª[ACK]åŒ…çš„ackå·æ˜¯[SYN, ACK]åŒ…seqå·åŠ ä¸€</li></ol><p>ç»ˆæ­¢è¿æ¥ä»£ç çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>clientç¨‹åºdelay 10ç§’é’Ÿï¼Œç„¶åå‘é€[FIN, ACK]åŒ…å…³é—­clientåˆ°serverçš„é€šè·¯ï¼Œç»§ç»­ä½¿ç”¨å…¨å±€çš„seqå·</li><li>clientå°†æœŸå¾…æ¥è‡ªæœåŠ¡ç«¯çš„[ACK]åŒ…ï¼Œä»¥åŠ[FIN, ACK]åŒ…</li><li>æœ€åclientå‘é€[ACK]åŒ…ï¼Œseqå·éœ€è¦åŠ ä¸€ï¼Œå› ä¸º[FIN]æ ‡å¿—çš„åŒ…å°†æ¶ˆè€—ä¸€ä¸ªåºå·ï¼ŒTCPè¿æ¥ç»ˆæ­¢å®Œæˆ</li></ol><p>ä¸»ç¨‹åºå¦‚ä¸‹ï¼Œå‘é€TCPè¿æ¥å»ºç«‹å’Œç»ˆæ­¢è¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚å‘é€åéƒ½ç”¨PacketHandlerå¤„ç†æ”¶åˆ°çš„åŒ…ï¼š</p><p>communicator.SendPacket(Utils.BuildTcpPacket(endPointInfo, TcpControlBits.Synchronize, null));</p><p>PacketHandler(communicator, endPointInfo);</p><p>// delay 10 secs, then client to send Fin</p><p>Thread.Sleep(10000);</p><p>communicator.SendPacket(Utils.BuildTcpPacket(endPointInfo, TcpControlBits.Fin | TcpControlBits.Acknowledgment));</p><p>PacketHandler(communicator, endPointInfo);</p><p>ç¨‹åºçš„ä¸»è¦é€»è¾‘åœ¨PacketHandlerä¸­ï¼Œè¿™ä¸ªå‡½æ•°æ ¹æ®æ”¶åˆ°çš„ä¸åŒTCPåŒ…çš„ç±»å‹å®Œæˆä¸åŒçš„é€»è¾‘ï¼Œäº§ç”Ÿå¹¶å‘é€ä¸åŒç±»å‹çš„åŒ…ã€‚</p><p>ä¾‹å¦‚ï¼Œå½“PacketHandleræ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„[SYN, ACK]åŒ…åï¼Œå¤„ç†å‡½æ•°å°±ä¼šç”Ÿæˆå¹¶å‘é€ä¸€ä¸ª[ACK]ç¡®è®¤åŒ…ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒPacketHandlerçš„é€»è¾‘å°±æ˜¯å®ç°äº†TCPè¿æ¥å»ºç«‹å’Œç»ˆæ­¢çš„é€»è¾‘ã€‚</p><p>private static void PacketHandler(PacketCommunicator communicator, EndPointInfo endPointInfo)</p><p>{</p><p>Packet packet = null;</p><p>bool running = true;</p><p>do</p><p>{</p><p>PacketCommunicatorReceiveResult result = communicator.ReceivePacket(out packet);</p><p>switch (result)</p><p>{</p><p>case PacketCommunicatorReceiveResult.Timeout:</p><p>// Timeout elapsed</p><p>continue;</p><p>case PacketCommunicatorReceiveResult.Ok:</p><p>bool isRecvedPacket = (packet.Ethernet.IpV4.Destination.ToString() == endPointInfo.SourceIp) ? true : false;</p><p>if (isRecvedPacket)</p><p>{</p><p>switch (packet.Ethernet.IpV4.Tcp.ControlBits)</p><p>{</p><p>case (TcpControlBits.Synchronize | TcpControlBits.Acknowledgment):</p><p>Utils.PacketInfoPrinter(packet);</p><p>Packet ack4SynAck = Utils.BuildTcpResponsePacket(packet, TcpControlBits.Acknowledgment);</p><p>communicator.SendPacket(ack4SynAck);</p><p>break;</p><p>case (TcpControlBits.Fin | TcpControlBits.Acknowledgment):</p><p>Utils.PacketInfoPrinter(packet);</p><p>Packet ack4FinAck = Utils.BuildTcpResponsePacket(packet, TcpControlBits.Acknowledgment);</p><p>communicator.SendPacket(ack4FinAck);</p><p>break;</p><p>case TcpControlBits.Acknowledgment:</p><p>Utils.PacketInfoPrinter(packet);</p><p>break;</p><p>default:</p><p>Utils.PacketInfoPrinter(packet);</p><p>break;</p><p>}</p><p>}</p><p>else</p><p>{</p><p>switch (packet.Ethernet.IpV4.Tcp.ControlBits)</p><p>{</p><p>case (TcpControlBits.Fin | TcpControlBits.Acknowledgment):</p><p>Utils.PacketInfoPrinter(packet);</p><p>break;</p><p>case TcpControlBits.Synchronize:</p><p>Utils.PacketInfoPrinter(packet);</p><p>break;</p><p>case TcpControlBits.Acknowledgment:</p><p>Utils.PacketInfoPrinter(packet);</p><p>running = false;</p><p>break;</p><p>default:</p><p>Utils.PacketInfoPrinter(packet);</p><p>break;</p><p>}</p><p>}</p><p>break;</p><p>default:</p><p>throw new InvalidOperationException("The result " + result + " should never be reached here");</p><p>}</p><p>} while (running);</p><p>}</p><p>åœ¨PacketHandlerå‡½æ•°ä¸­ç”¨åˆ°äº†BuildTcpResponsePacketè¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ ¹æ®æ”¶åˆ°çš„TCPåŒ…ï¼Œæ¥æ„å»ºresponseåŒ…ã€‚</p><p>è¿™ä¸ªå‡½æ•°æœ‰ä¸‹é¢å‡ ä¸ªæ³¨æ„ç‚¹ï¼š</p><ul><li>è¯¥å‡½æ•°ä¼šæ ¹æ®æ”¶åˆ°çš„åŒ…ï¼Œè®¾ç½®responseåŒ…çš„æºå’Œç›®çš„åœ°å€</li><li>è¯¥å‡½æ•°ä¼šæ¥å—PacketHandlerä¼ é€’æ¥çš„TCP flagsï¼Œå¹¶è®¾ç½®åˆ°TCPé¦–éƒ¨ä¸­</li><li>è¯¥å‡½æ•°çš„å¦ä¸€ä¸ªé‡è¦éƒ¨åˆ†å°±æ˜¯ä¼šè®¡ç®—å¹¶è®¾ç½®TCPé¦–éƒ¨ä¸­çš„seqå·ackå·ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦</li></ul><p>public static Packet BuildTcpResponsePacket(Packet packet, TcpControlBits tcpControlBits)</p><p>{</p><p>EthernetLayer ethernetHeader = new EthernetLayer</p><p>{</p><p>Source = new MacAddress(packet.Ethernet.Destination.ToString()),</p><p>Destination = new MacAddress(packet.Ethernet.Source.ToString()),</p><p>EtherType = EthernetType.None, // Will be filled automatically.</p><p>};</p><p>IpV4Layer ipHeader = new IpV4Layer</p><p>{</p><p>Source = new IpV4Address(packet.Ethernet.IpV4.Destination.ToString()),</p><p>CurrentDestination = new IpV4Address(packet.Ethernet.IpV4.Source.ToString()),</p><p>Fragmentation = IpV4Fragmentation.None,</p><p>HeaderChecksum = null, // Will be filled automatically.</p><p>Identification = 123,</p><p>Options = IpV4Options.None,</p><p>Protocol = null, // Will be filled automatically.</p><p>Ttl = 100,</p><p>TypeOfService = 0,</p><p>};</p><p>TcpLayer tcpHeader = new TcpLayer</p><p>{</p><p>SourcePort = packet.Ethernet.IpV4.Tcp.DestinationPort,</p><p>DestinationPort = packet.Ethernet.IpV4.Tcp.SourcePort,</p><p>Checksum = null, // Will be filled automatically.</p><p>SequenceNumber = seqNum = packet.Ethernet.IpV4.Tcp.AcknowledgmentNumber,</p><p>AcknowledgmentNumber = ackNum = packet.Ethernet.IpV4.Tcp.SequenceNumber + (uint)((packet.Ethernet.IpV4.Tcp.Payload.Length > 0) ? packet.Ethernet.IpV4.Tcp.Payload.Length : 1),</p><p>ControlBits = tcpControlBits,</p><p>Window = windowSize,</p><p>UrgentPointer = 0,</p><p>Options = TcpOptions.None,</p><p>};</p><p>PacketBuilder builder = new PacketBuilder(ethernetHeader, ipHeader, tcpHeader);</p><p>return builder.Build(DateTime.Now);</p><p>}</p><h1>è¿è¡Œæ•ˆæœ</h1><p>æ‰“å¼€Wiresharkç›‘å¬"VirtualBox Host-Only Network"ç½‘å¡ï¼Œå¹¶è®¾ç½®filterä¸º"port 8081"ã€‚</p><p>ç„¶åè¿è¡Œç¨‹åºï¼Œé€šè¿‡consoleå¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯å‘é€çš„åŒ…ï¼Œä»¥åŠæœåŠ¡ç«¯è¿”å›çš„åŒ…ï¼Œé€šè¿‡è¿™äº›åŒ…å®Œæˆäº†TCPè¿æ¥çš„å»ºç«‹å’Œç»ˆæ­¢ã€‚</p><div class=pgc-img><img alt=åŠ¨æ‰‹å­¦ä¹ TCPï¼šTCPè¿æ¥å»ºç«‹ä¸ç»ˆæ­¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®® onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/22a89c80460443b3889c134c8d43e75a></div><p>ä¸‹é¢æ˜¯Wiresharkä¸­æ˜¾ç¤ºçš„ç»“æœï¼ŒWiresharkæ¯”è¾ƒå‹å¥½ï¼Œä¼šæ˜¾ç¤ºç›¸å¯¹seqå·ï¼Œæ‰€ä»¥çœ‹åˆ°çš„éƒ½æ˜¯ä»0å¼€å§‹ç¼–å·ã€‚</p><p>æ³¨æ„seqå·å’Œackå·çš„å˜åŒ–ï¼Œ[SYN]å’Œ[FIN]æ ‡å¿—çš„TCPåŒ…éƒ½ä¼šæ¶ˆè€—ä¸€ä¸ªåºå·ã€‚</p><div class=pgc-img><img alt=åŠ¨æ‰‹å­¦ä¹ TCPï¼šTCPè¿æ¥å»ºç«‹ä¸ç»ˆæ­¢ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®® onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2a16e7e8b6d4497bbe1b7c3841e6a89d></div><h1>æ€»ç»“</h1><p>æœ¬æ–‡ä»‹ç»äº†TCPé¦–éƒ¨ï¼Œé€šè¿‡è®¾ç½®TCPé¦–éƒ¨ä¸­çš„[SYN]æ ‡å¿—ï¼Œå¯ä»¥æ„é€ TCPè¿æ¥å»ºç«‹è¯·æ±‚åŒ…ï¼›é€šè¿‡è®¾ç½®[FIN]æ ‡å¿—ï¼Œå¯ä»¥æ„é€ TCPè¿æ¥ç»ˆæ­¢è¯·æ±‚åŒ…ã€‚</p><p>æ–‡ä¸­ä½¿ç”¨Pcap.Netæ„å»ºäº†ä¸€ä¸ªç®€å•çš„å®¢æˆ·ç«¯ï¼Œå®Œæˆäº†å‘æœåŠ¡å™¨å»ºç«‹ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰å’Œç»ˆæ­¢ï¼ˆå››æ¬¡æŒ¥æ‰‹ï¼‰è¿æ¥çš„è¿‡ç¨‹ã€‚</p><p>é€šè¿‡è¿™ä¸ªå®éªŒï¼Œä¸€å®šä¼šå¯¹TCPè¿æ¥çš„å»ºç«‹å’Œç»ˆæ­¢æœ‰ä¸€ä¸ªæ¯”è¾ƒç›´è§‚çš„è®¤è¯†ã€‚</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'TCP','è¿æ¥','åŠ¨æ‰‹'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>