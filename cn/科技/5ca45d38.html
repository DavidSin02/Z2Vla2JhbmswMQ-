<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>算法效率改进，浮点数的printf展示 | 极客快訊</title><meta property="og:title" content="算法效率改进，浮点数的printf展示 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/d5e4da901b224d18968c86d30499f451"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5ca45d38.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5ca45d38.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5ca45d38.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5ca45d38.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5ca45d38.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5ca45d38.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5ca45d38.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5ca45d38.html><meta property="article:published_time" content="2020-11-14T21:00:51+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:51+08:00"><meta name=Keywords content><meta name=description content="算法效率改进，浮点数的printf展示"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/5ca45d38.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>算法效率改进，浮点数的printf展示</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>更多互联网新鲜资讯、工作奇淫技巧<strong><span style="color:#a82e2e;--tt-darkmode-color: #A92E2E">关注原创【飞鱼在浪屿】</span></strong>（日更新）</p><div class=pgc-img><img alt=算法效率改进，浮点数的printf展示 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d5e4da901b224d18968c86d30499f451><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><span style="color:#555;--tt-darkmode-color: #555555">浮点数如何呈现为文本字符串？</span></h1><p><span style="color:#555;--tt-darkmode-color: #555555">这是一个非常棘手的难题，上次解决方案还是自1990年左右。</span></p><p><span style="color:#555;--tt-darkmode-color: #555555">在斯蒂尔和怀特（Steele and White）的“如何准确打印浮点数”之前，的实现printf和类似的渲染功能尽了最大努力来渲染浮点数，但是它们的表现方式差异很大。例如，诸如1.3之类的数字可能会呈现为1.29999999，或者如果将一个数字放入要写出的反馈循环中并读回其书面表示形式，则每个连续结果都可能与原始结果越来越远。</span></p><p><span style="color:#555;--tt-darkmode-color: #555555">斯蒂尔和怀特命名为“ Dragon4”的聪明算法（“ Dragon”算法的第四个版本）有效地解决了这个问题。Dragon4算法在各种语言运行时之间迅速传播，以至于如今很少有程序员了解这是一个问题。确实，但是问题如何解决？Dragon4及其派生类非常复杂，并且由于依赖于任意精度整数算法来计算其结果，因此它们具有很高的性能成本。</span></p><p><span style="color:#555;--tt-darkmode-color: #555555">2010年，Florian Loitsch发表了一篇精彩的论文，“用整数快速而精确地打印浮点数”，这是该领域20年来的最大一步：他主要想出了如何使用机器整数来进行精确渲染！为什么说“大部分”？因为尽管Loitsch的“ Grisu3”算法非常快，但它</span><em><span style="color:#555;--tt-darkmode-color: #555555">放弃了</span></em><span style="color:#555;--tt-darkmode-color: #555555">大约0.5％的数字，在这种情况下，必须退回Dragon4或派生产品。</span></p><p><span style="color:#555;--tt-darkmode-color: #555555">Grisu3比printfGNU libc中使用的算法快大约5倍。一些语言实现者已经注意到了这一点：Google聘用了Loitsch，而Grisu家族在V8和Mozilla Javascript引擎中均充当默认渲染算法（取代了David Gay已有17年的dtoa代码）。Loitsch已将其Grisu算法的实现发布为一个名为的库double-conversion。</span></p><p><span style="color:#555;--tt-darkmode-color: #555555">当然，在不提及Haskell的情况下，不能不谈性能：使用了Loitsch的库并编写了一个Haskell接口，据测量，该接口的速度比Haskell运行时库中使用的默认渲染器快30倍。这具有一些不错的连锁效果。</span></p><hr><h1 class=pgc-h-arrow-right>17位有效的十进制数标示双精度浮点数</h1><p>任意双精度二进制浮点数的精确十进制等效项通常看起来很笨，如下所示：</p><p style=text-align:start>0.1000000000000000055511151231257827021181583404541015625</p><p style=text-align:start>通常，打印浮点数时，不希望看到其所有数字。无论如何，它们中的大多数都是“不关心的信息”。但是，你需要几位数？想要一个短字符串，但是你希望它足够长，以便它标识原始浮点数。计算机科学的一个众所周知的结果是，需要17位有效的十进制数字来标识任意双精度浮点数。如果要将任何浮点数的精确十进制值四舍五入为17个有效数字，则将有一个数字，当转换回浮点数时，该数字将为您提供原始的浮点数。也就是说，这个数字是往返可逆的。这里的示例数字为0.10000000000000001。</p><p style=text-align:start>但是17位数字是最坏的情况，这意味着在许多情况下，更少的数字（甚至少至一位）就可以工作。所需的数字取决于特定的浮点数。在我们的示例中，短字符串0.1可以解决问题。这意味着至少就其浮点表示而言，0.1000000000000000055511151231257827021181583404541015625和0.10000000000000001和0.1相同。</p><hr><p>以下，举例说明可以和不能缩短的十进制字符串的示例</p><h1 class=pgc-h-arrow-right>示例1：只需要一个数字</h1><p style=text-align:start>让我们仔细看一下0.1的例子。此双精度浮点数线图说明了其工作原理：</p><div class=pgc-img><img alt=算法效率改进，浮点数的printf展示 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8f35e99977ba4d6b963b14c23b5f0d25><p class=pgc-img-caption>示例：最短的十进制字符串为1位数字</p></div><p style=text-align:start>蓝色是三个浮点数的精确十进制值：中间的一个是示例数，左边的一个是在其前面的浮点数，而右边的一个是在其后的浮点数。用灰色标记了示例编号与其邻居之间的中点。这些中点之间的任何值都将四舍五入为示例数字。从中可以看出，尽管0.10000000000000001更近，但0.1仍在舍入范围内；因此，从最短的观点出发，优选0.1。</p><h1 class=pgc-h-arrow-right>示例2：17位数字是必需的</h1><p style=text-align:start>浮点数50388143.0682372152805328369140625不能四舍五入为小于17位的数字，并且仍然是双向的。四舍五入为17位数字，即50388143.068237215，它将转换回浮点数。舍入到16位数字是50388143.06823722，但是它更接近<em>下一个</em>浮点数：</p><div class=pgc-img><img alt=算法效率改进，浮点数的printf展示 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/54293f6715354d99b577136d44d54368><p class=pgc-img-caption>示例：最短的十进制字符串为17位</p></div><p style=text-align:start>不存在较短的字符串，因为四舍五入到较短的长度只会引入更多的误差。</p><h1 class=pgc-h-arrow-right>示例3：仅需要10位数字</h1><p style=text-align:start>浮点数54167628.179999999701976776123046875可以四舍五入到10位数字，但不少于10位。四舍五入到10位数字为54167628.18。四舍五入为9位数字，它是54167628.2，往返距离中间相隔着2,684,354个二进制浮点数。</p><div class=pgc-img><img alt=算法效率改进，浮点数的printf展示 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cdc261fb038242bfac88a1db2b002cf4><p class=pgc-img-caption>示例：最短的十进制字符串为10位</p></div><p><br></p><h1 class=pgc-h-arrow-right>示例4：仅需要15位数字</h1><p style=text-align:start>浮点数9161196241250.05078125可以四舍五入到15位（9161196241250.05），并且仍然是双向的。当然，它也将四舍五入为17位数字（9161196241250.0508）和16位数字（9161196241250.051），这已在图中显示。</p><div class=pgc-img><img alt=算法效率改进，浮点数的printf展示 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1e22179318934449b31170482b7f7ae2><p class=pgc-img-caption>示例：最短的十进制字符串为15位</p></div><p style=text-align:start>在此示例中，四舍五入为17位数字表示一个17位数字的字符串，四舍五入为16位数字表示为16位数字的字符串，而四舍五入为15位数字则为15位数字的字符串。这与示例3不同，示例3中无论将其舍入为17、16、15、14、13、12、11或10位，都将54167628.17999999970970776776123046875舍入到10位字符串54167628.18。</p><hr><p>接下来来解释下为什么？</p><h1 class=pgc-h-arrow-right>四舍五入的最短十进制字符串可能不是最近的</h1><p>可以使用最多17个有效十进制数字来标识任何双精度浮点数。这意味着，如果将浮点数转换为十进制字符串，将其（最接近）四舍五入为17位数字，然后再将其转换回浮点数，则将恢复原始浮点数。换句话说，转换是往返可逆的。</p><p style=text-align:start>有时（很多）少于17位数字将用于往返；通常希望找到最短的此类字符串。一些编程语言生成最短的十进制字符串，但许多不生成。确认语言是什么规则的方法是，将浮点数四舍五入为递增长度的十进制字符串，然后每次检查字符串往返是否可逆。对于双精度，你需要四舍五入到15位数字，然后如果需要则四舍五入到16位数字，如果需要，最后四舍五入到17位数字。</p><hr><h1 class=pgc-h-arrow-right>问题根源：2的幂</h1><p style=text-align:start>让我们在2 -44上尝试蛮力算法，该算法的十六进制浮点常量为0x1p-44，而全精度十进制值为5.684341886080801486968994140625e-14。四舍五入为15位数字，它是5.6843418860808e-14，但这不是往返可逆的：它转换为0x1.ffffffffffffep-45。四舍五入为16位数字，它是5.684341886080801e-14，但这也不是往返的：它转换为0x1.fffffffffffffp-45。因此，必须使用17位标示数字5.6843418860808015e-14。</p><p style=text-align:start>可是等等！有往返的16位数字，我们错过了：5.684341886080802e-14。为什么没有更接近的16位数字，却要往返呢？</p><p style=text-align:start>问题的根源在于二进制浮点数之间的间隙大小以两个边界的幂变化。大于2的幂的间隙大小是小于2的幂的间隙大小的两倍。这种不对称是必要的条件，但它本身并不会导致问题。以及两个因子的幂附近的十进制数字之间的差距的大小。对于双精度，有问题的十进制间隙大小仅出现在16位数字上。</p><p style=text-align:start>即使对于16位数字，并不是所有的2的幂都表现出异常。二进制和十进制数字必须以某种方式对齐。对于初学者，最接近的16位十进制数字必须<em>低于2</em>的幂，而下一个更高的16位十进制数字必须<em>高于2</em>的幂。此外，最接近的16位十进制数必须比下一个较低的53位二进制数大一半（不能为中位数，因为舍入至最接近偶数会将其映射为2的幂），而下一个较高的16位十进制数不能超过下一个较高的53位二进制数的一半。由于中途距离在2的幂的任一侧都不相同，因此，越远的十进制数将映射到2的幂，但越小的十进制数则不会。</p><p style=text-align:start>下图按比例绘制，描述了示例的情况：</p><div class=pgc-img><img alt=算法效率改进，浮点数的printf展示 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/08be6e0f2fb043e384a0570bc363f72a><p class=pgc-img-caption>示例：最短的十进制字符串不是最近的</p></div><p style=text-align:start>该图显示了从2 -45指数到2 -44指数范围的53位二进制浮点数。这在16位数浮点十进制数的10 -14范围内发生。二进制间隙变化的从大小2 （-45 + 1-53） = 2 -97 ≈ <strong>6.3×10 -30</strong>〜2 （-44 + 1-53） = 2 -96 ≈ <strong>1.3×10 -29</strong>。在该范围内的小数位间隔保持恒定为10 （-14 + 1-16） = <strong>10 -29</strong>。问题就在这里。十进制间隙大小介于两个二进制间隙大小之间。</p><h1 class=pgc-h-arrow-right>当出现十进制间隙大小时</h1><p style=text-align:start>有问题的十进制间隙大小仅适用于16位十进制数字。这是因为对于15位以下的十进制数字，十进制间隙大小大于最大的双精度二进制间隙大小，对于17位以上的十进制数字，十进制间隙大小小于最小的双精度大小。二进制间隙大小。后两个事实分别是往返十进制到浮点到十进制以及浮点到十进制到浮点转换的结果。</p><h1 class=pgc-h-arrow-right>发生的所有两种力量</h1><p style=text-align:start>我编写了一个C程序来测试正常双精度范围内2的所有1046次幂：2 -1022到2 1023。对于54，最接近的16位数字不能往返，但是下一位数可以：</p><p style=text-align:start>2 976，2 966，2 956，2 896，2 890，2 863，2 803，2 740，2 710，2 594，2 574，2 554，2 544，2 534，2 481，2 405，2 398，2 378，2 345，2 305，2 275，2 182，2 172，2 149，2 132，2 122，289，2 -24，2 -44，2 -77，2 -97，2 -140，2 -296，2 -366，2 -383，2 -489，2 -496，2 -499，2 -509， 2 -549，2 -569，2 -645，2 -652，2 -662，2 -695，2 -705，2 -778，2 -788，2 -791，2 -808，2 -921，2 - 957，2-1007，2 -1017</p><p style=text-align:start>其中，有八个数字以15位四舍五入为整数，该数字往返：</p><p style=text-align:start>2 966，2 956，2 890，2 740，2 149，2 -499，2 -569，2 -645</p><p style=text-align:start>因此，如果使用蛮力测试算法，则异常行为仅在46个浮点数中起作用。</p><p style=text-align:start>（事实证明，对于这八种情况，15位四舍五入和非最近的16位数字是相同的。）</p><h1 class=pgc-h-arrow-right>单精度</h1><p style=text-align:start>同样的异常也适用於单精度，往返保护将舍入到6位或更少或9位或更多位，保留7和8位数字作为候选。</p><h1 class=pgc-h-arrow-right>讨论区</h1><p style=text-align:start>对于任何二进制精度，问题区域将位于“中间位置”，其中数字计数在两个往返边界之间。</p><p style=text-align:start>对于负数，结果是相同的，只是图纸是镜像图像。</p><p style=text-align:start>对Java，Python，PHP和Javascript进行了快速测试（C并没有真正的机制）。似乎只有Python（3）和Javascript（在Firefox，Chrome，Edge和Internet Explorer上经过测试）才被设计为返回最短的十进制字符串。（实际上，我知道Python是这样设计的；我没有研究Javascript的设计和代码。）</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'改进','浮点数','printf'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>