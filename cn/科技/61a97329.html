<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>祸害阿里云宕机3小时的IO HANG究竟是什么？ | 极客快訊</title><meta property="og:title" content="祸害阿里云宕机3小时的IO HANG究竟是什么？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/RK1IFLn80SX5dl"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/61a97329.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/61a97329.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/61a97329.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/61a97329.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/61a97329.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/61a97329.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/61a97329.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/61a97329.html><meta property="article:published_time" content="2020-11-14T21:05:13+08:00"><meta property="article:modified_time" content="2020-11-14T21:05:13+08:00"><meta name=Keywords content><meta name=description content="祸害阿里云宕机3小时的IO HANG究竟是什么？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/61a97329.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>祸害阿里云宕机3小时的IO HANG究竟是什么？</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><strong>本文来自微信公号“CSDN”（ID：CSDNnews），作者 | 王知无， 责编| 郭 芮。</strong></p><p>2019年3月3日凌晨，微博炸锅，有网友反映说阿里云疑似出现宕机，华北很多互联网公司受到暴击伤害，APP、网站全部瘫痪，我自己的朋友圈和微信群里也有好友反馈，刚刚从被窝被叫起来去修Bug，结果发现服务器登不上去了......</p><p>凌晨2点37分，阿里云官方回应称：华北2地域可用区C部分ECS服务器等实例出现IO HANG，经紧急排查处理后逐步恢复，此外将根据协议尽快赔偿。并已经全面排查其他地域及可用区，未发现此类情况。</p><p><strong>IO HANG</strong></p><p>那么问题来了，IO HANG是个什么鬼？简单的说，就是服务器磁盘读写过慢，导致线程和进程挂起。大量读写线程/进程挂起导致服务器宕机......</p><p>阿里云有大量的类似RDS、HybridDB数据库，支持海量数据在线事务（OLTP）和在线分析（OLAP），需要大量的IO读写，而Linux的IO性能将直接影响SQL的执行速度，严重情况下将导致服务器卡死和宕机。</p><p>如何监控自己服务器的IO情况呢？本文将带大家详细了解这些常用的命令。</p><p><strong>如何监控自己服务器的IO情况？</strong></p><p>常用的命令包括：top，iostat和iotop。那么他们都有什么区别，以及如何使用呢？我们一一分解。</p><p>我本机安装的是CentOS-7的虚拟机，内核信息为：</p><p><strong>top命令</strong></p><p>top命令提供了实时的对系统处理器的状态监视。它将显示系统中CPU最"敏感"的任务列表，该命令可以按CPU使用、内存使用和执行时间对任务进行排序，而且该命令的很多特性都可以通过交互式命令。</p><p>在Linux下，输入`top` ：</p><img alt="祸害阿里云宕机3小时的IO HANG究竟是什么？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RK1IFLn80SX5dl><p>Tasks、Cpus、Mem和Swap分别代表了进程信息、CPU信息和内存信息。各个列表示的指标意义如下 ：</p><p>PID进程id</p><p>USER进程所有者用户名</p><p>PR 优先级</p><p>NI nice值</p><p>VIRT进程使用的虚拟内存总量</p><p>RES进程使用的未被换出的物理内存大小</p><p>SHR共享内存大小</p><p>S 进程状态S=睡眠T=跟踪R=运行Z=僵尸进程D=不可中断的睡眠进程</p><p>CPUcpu时间统计</p><p>MEM 物理内存占比</p><p>COMMAND命令行命令名</p><p>top常用的交互式命令使用格式：</p><p>top [-] [d] [p] [q] [c] [C] [S] [s] [n]</p><p>参数说明：</p><p>d：指定每两次屏幕信息刷新之间的时间间隔，当然用户可以使用s交互命令来改变之；</p><p>p：通过指定监控进程ID来仅仅监控某个进程的状态；</p><p>q：该选项将使top没有任何延迟的进行刷新。如果调用程序有超级用户权限，那么top将以尽可能高的优先级运行；</p><p>S：指定累计模式；</p><p>s：使top命令在安全模式中运行，这将去除交互命令所带来的潜在危险；</p><p>i：使top不显示任何闲置或者僵死进程；</p><p>c：显示整个命令行而不只是显示命令名。</p><p>通过top命令，我们即可查到当前服务器的进程占用CPU和内存情况。</p><p><strong>iostat命令</strong></p><p>iostat主要用于监控系统设备的IO负载情况，iostat首次运行时显示自系统启动开始的各项统计信息，之后运行iostat将显示自上次运行该命令以后的统计信息。用户可以通过指定统计的次数和时间来获得所需的统计信息。</p><p>基本使用：</p><p>$iostat -d -k 2</p><p>参数说明：</p><p>-d：显示设备（磁盘）使用状态；</p><p>-k：某些使用block为单位的列强制使用Kilobytes为单位；</p><p>2：数据显示每隔2秒刷新一次。</p><img alt="祸害阿里云宕机3小时的IO HANG究竟是什么？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RK1IFM07GPYpgh><p>如果提示没有iostat命令需要使用yum安装，安装命令如下：</p><p>`yum install sysstat`</p><p>参数解释如下：</p><p>tps：该设备每秒的传输次数，一次传输意思是“一次I/O请求”，多个逻辑请求可能会被合并为“一次I/O请求”；</p><p>kB_read/s：每秒从设备（drive expressed）读取的数据量；kB_wrtn/s：每秒向设备（drive expressed）写入的数据量；</p><p>kB_read：读取的总数据量；</p><p>kB_wrtn：写入的总数量数据量，这些单位都为Kilobytes。</p><p>上面的例子中，我们可以看到磁盘sda以及它的各个分区的统计数据，当时瞬时统计的磁盘总TPS是1.88，下面是各个分区的TPS（因为是瞬间值，所以总TPS并不严格等于各个分区TPS的总和）。</p><p>在实际业务中，我们经常使用的命令是：</p><p>iostat -xdm</p><p>例如：iostat -xdm 2，2代表2秒钟刷新一次。</p><img alt="祸害阿里云宕机3小时的IO HANG究竟是什么？" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RK1IFMB9CbBlzA><p>我们可以看到，%util这个参数即代表磁盘繁忙程度。100%表示磁盘繁忙, 0%表示磁盘空闲。但是我们需要注意，磁盘繁忙程度并不意味着磁盘读写速度大小。</p><p>iostat是系统级别的监控指令，iostat给我们的展示结果揭示了我们当前服务器磁盘的繁忙程度，虽然有一定的指导意义，但是不能精确到进程级别，这时候我们就需要iotop了。</p><p><strong>iotop命令</strong></p><p>我们上文讲到top命令，顾名思义，iotop代表io版本的top命令，使用起来简单粗暴，直接在命令行敲下：iotop。</p><img alt="祸害阿里云宕机3小时的IO HANG究竟是什么？" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RK1IFMO8FvecLL><p>iotop命令可以按进程统计IO状况,我们可以指导当前系统哪些进程在占用IO,百分比是多少，占用IO的进程是在读，还是在写，读写量是多少等信息。然后我们可以定位到具体的进程，查看进程详情。</p><p>同样个iotop命令有一个很像的命令叫做pidstat，参数很多。</p><p>例如：`pidstat -d` ：</p><img alt="祸害阿里云宕机3小时的IO HANG究竟是什么？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RK1IFUR5mi4sF4><p>我们同样可以看到每个进程的读写情况，然后定位到具体的线程去查看问题。</p><p><strong>总结</strong></p><p>在生产实践中，实时监控我们的服务器IO情况至关重要，尤其是数据库所在的服务器，它直接关系到我们的程序的读写速度、SQL的执行情况等。</p><p>服务器IO的情况是我们选择服务器的重要考虑因素之一。IO变差，轻则写入服务读写响应缓慢，重则导致大量进程长时间挂起，数据库拥堵卡死，服务器严重卡顿，甚至宕机。</p><p>作者：王知无，阿里巴巴高级大数据开发工程师，先后在京东，阿里等大型互联网公司从事大数据平台、实时计算和离线计算中间件和业务平台开发。自媒体人，业余讲师，希望为更多的互联网开发人员提供最新和最热的大数据方向的技术动态，技术前沿研究。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'祸害','云宕机','小时'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>