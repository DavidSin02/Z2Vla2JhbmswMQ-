<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Tomcatæ˜¯å¦‚ä½•å®ç°å¼‚æ­¥Servletçš„ï¼Œä½ çŸ¥é“å—ï¼Ÿ | æå®¢å¿«è¨Š</title><meta property="og:title" content="Tomcatæ˜¯å¦‚ä½•å®ç°å¼‚æ­¥Servletçš„ï¼Œä½ çŸ¥é“å—ï¼Ÿ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/0bcf5bea5af74396a75b5443b8557d29"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/64095ff.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/64095ff.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/64095ff.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/64095ff.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/64095ff.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/64095ff.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/64095ff.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/64095ff.html><meta property="article:published_time" content="2020-10-29T20:59:18+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:18+08:00"><meta name=Keywords content><meta name=description content="Tomcatæ˜¯å¦‚ä½•å®ç°å¼‚æ­¥Servletçš„ï¼Œä½ çŸ¥é“å—ï¼Ÿ"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/64095ff.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Tomcatæ˜¯å¦‚ä½•å®ç°å¼‚æ­¥Servletçš„ï¼Œä½ çŸ¥é“å—ï¼Ÿ</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><blockquote><p><strong>&lt;æ¨èé˜…è¯»></strong></p><p><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6747531576701092365/?group_id=6747531576701092365" target=_blank>MySQLå¤ä¹ ï¼š20é“å¸¸è§é¢è¯•é¢˜ï¼ˆå«ç­”æ¡ˆï¼‰+21æ¡MySQLæ€§èƒ½è°ƒä¼˜ç»éªŒ</a></strong></p><p><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6746159736158159373/?group_id=6746159736158159373" target=_blank>æˆ‘çš„ç¾å›¢offerå‡‰å‡‰äº†ï¼Ÿå¼€å‘å·¥ç¨‹å¸ˆï¼ˆJavaå²—ï¼‰ä¸‰é¢ç»“æŸç­‰é€šçŸ¥...</a></strong></p></blockquote><h1>01 å‰è¨€</h1><p>æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬æ¥èŠèŠTomcatæ˜¯å¦‚ä½•å®ç°å¼‚æ­¥Servletçš„ä»¥åŠå¼‚æ­¥Servletçš„ä½¿ç”¨åœºæ™¯ã€‚</p><div class=pgc-img><img alt=Tomcatæ˜¯å¦‚ä½•å®ç°å¼‚æ­¥Servletçš„ï¼Œä½ çŸ¥é“å—ï¼Ÿ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0bcf5bea5af74396a75b5443b8557d29><p class=pgc-img-caption></p></div><h1>02 æ‰‹æ’¸ä¸€ä¸ªå¼‚æ­¥çš„Servlet</h1><p>æˆ‘ä»¬ç›´æ¥å€ŸåŠ©SpringBootæ¡†æ¶æ¥å®ç°ä¸€ä¸ªServlet,è¿™é‡Œåªå±•ç¤ºServletä»£ç ï¼š</p><pre>@WebServlet(urlPatterns = "/async",asyncSupported = true)@Slf4jpublic class AsyncServlet extends HttpServlet { ExecutorService executorService =Executors.newSingleThreadExecutor(); @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { //å¼€å¯å¼‚æ­¥,è·å–å¼‚æ­¥ä¸Šä¸‹æ–‡ final AsyncContext ctx = req.startAsync(); // æäº¤çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œ executorService.execute(new Runnable() { @Override public void run() { try { log.info("async Service å‡†å¤‡æ‰§è¡Œäº†"); //æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡ Thread.sleep(10000L); ctx.getResponse().getWriter().print("async servlet"); log.info("async Service æ‰§è¡Œäº†"); } catch (IOException e) { e.printStackTrace(); } catch (InterruptedException e) { e.printStackTrace(); } //æœ€åæ‰§è¡Œå®Œæˆåå®Œæˆå›è°ƒã€‚ ctx.complete(); } }); }</pre><p>ä¸Šé¢çš„ä»£ç å®ç°äº†ä¸€ä¸ªå¼‚æ­¥çš„Servlet,å®ç°äº†doGetæ–¹æ³•æ³¨æ„åœ¨SpringBootä¸­ä½¿ç”¨éœ€è¦å†å¯åŠ¨ç±»åŠ ä¸Š@ServletComponentScanæ³¨è§£æ¥æ‰«æServletã€‚æ—¢ç„¶ä»£ç å†™å¥½äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®é™…è¿è¡Œæ•ˆæœã€‚</p><div class=pgc-img><img alt=Tomcatæ˜¯å¦‚ä½•å®ç°å¼‚æ­¥Servletçš„ï¼Œä½ çŸ¥é“å—ï¼Ÿ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d95912ce3b224793a621625516b74f71><p class=pgc-img-caption></p></div><p>æˆ‘ä»¬å‘é€ä¸€ä¸ªè¯·æ±‚åï¼Œçœ‹åˆ°é¡µé¢æœ‰å“åº”ï¼ŒåŒæ—¶ï¼Œçœ‹åˆ°è¯·æ±‚æ—¶é—´èŠ±è´¹äº†10.05s,é‚£ä¹ˆæˆ‘ä»¬è¿™ä¸ªServletç®—æ˜¯èƒ½æ­£å¸¸è¿è¡Œå•¦ã€‚æœ‰åŒå­¦è‚¯å®šä¼šé—®ï¼Œè¿™ä¸æ˜¯å¼‚æ­¥servletå—ï¼Ÿä½ çš„å“åº”æ—¶é—´å¹¶æ²¡æœ‰åŠ å¿«ï¼Œæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå¯¹ï¼Œæˆ‘ä»¬çš„å“åº”æ—¶é—´å¹¶ä¸èƒ½åŠ å¿«ï¼Œè¿˜æ˜¯ä¼šå–å†³äºæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯æˆ‘ä»¬çš„å¼‚æ­¥servletè¯·æ±‚åï¼Œä¾èµ–äºä¸šåŠ¡çš„å¼‚æ­¥æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³è¿”å›ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒTomcatçš„çº¿ç¨‹å¯ä»¥ç«‹å³å›æ”¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒTomcatçš„æ ¸å¿ƒçº¿ç¨‹æ˜¯<strong>10</strong>ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯<strong>200</strong>,æˆ‘ä»¬èƒ½åŠæ—¶å›æ”¶çº¿ç¨‹ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬èƒ½å¤„ç†æ›´å¤šçš„è¯·æ±‚ï¼Œèƒ½å¤Ÿå¢åŠ æˆ‘ä»¬çš„ååé‡ï¼Œè¿™ä¹Ÿæ˜¯å¼‚æ­¥Servletçš„ä¸»è¦ä½œç”¨ã€‚</p><h1>03 å¼‚æ­¥Servletçš„å†…éƒ¨åŸç†</h1><p>äº†è§£å®Œå¼‚æ­¥Servletçš„ä½œç”¨åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼ŒTomcatæ˜¯å¦‚ä½•æ˜¯å…ˆå¼‚æ­¥Servletçš„ã€‚å…¶å®ä¸Šé¢çš„ä»£ç ï¼Œä¸»è¦æ ¸å¿ƒé€»è¾‘å°±ä¸¤éƒ¨åˆ†ï¼Œfinal AsyncContext ctx = req.startAsync()å’Œctx.complete()é‚£æˆ‘ä»¬æ¥çœ‹çœ‹ä»–ä»¬ç©¶ç«Ÿåšäº†ä»€ä¹ˆï¼Ÿ</p><pre> public AsyncContext startAsync(ServletRequest request, ServletResponse response) { if (!isAsyncSupported()) { IllegalStateException ise = new IllegalStateException(sm.getString("request.asyncNotSupported")); log.warn(sm.getString("coyoteRequest.noAsync", StringUtils.join(getNonAsyncClassNames())), ise); throw ise; } if (asyncContext == null) { asyncContext = new AsyncContextImpl(this); } asyncContext.setStarted(getContext(), request, response, request==getRequest() &amp;&amp; response==getResponse().getResponse()); asyncContext.setTimeout(getConnector().getAsyncTimeout()); return asyncContext; }</pre><p>æˆ‘ä»¬å‘ç°req.startAsync()åªæ˜¯ä¿å­˜äº†ä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶è®¾ç½®ä¸€äº›åŸºç¡€ä¿¡æ¯ï¼Œæ¯”å¦‚Timeout,é¡ºä¾¿æä¸€ä¸‹ï¼Œè¿™é‡Œè®¾ç½®çš„é»˜è®¤è¶…æ—¶æ—¶é—´æ˜¯<strong>30S</strong>ï¼Œå¦‚æœä½ çš„å¼‚æ­¥å¤„ç†é€»è¾‘è¶…è¿‡<strong>30S</strong>,æ­¤æ—¶æ‰§è¡Œctx.complete()å°±ä¼šæŠ›å‡ºIllegalStateException å¼‚å¸¸ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ctx.complete()çš„é€»è¾‘</p><pre> public void complete() { if (log.isDebugEnabled()) { logDebug("complete "); } check(); request.getCoyoteRequest().action(ActionCode.ASYNC_COMPLETE, null); }//ç±»ï¼šAbstractProcessor  public final void action(ActionCode actionCode, Object param) { case ASYNC_COMPLETE: { clearDispatches(); if (asyncStateMachine.asyncComplete()) { processSocketEvent(SocketEvent.OPEN_READ, true); } break; }  } //ç±»ï¼šAbstractProcessor protected void processSocketEvent(SocketEvent event, boolean dispatch) { SocketWrapperBase&lt;?&gt; socketWrapper = getSocketWrapper(); if (socketWrapper != null) { socketWrapper.processSocket(event, dispatch); } } //ç±»ï¼šAbstractEndpointpublic boolean processSocket(SocketWrapperBase&lt;S&gt; socketWrapper, SocketEvent event, boolean dispatch) { //çœç•¥éƒ¨åˆ†ä»£ç  SocketProcessorBase&lt;S&gt; sc = null; if (processorCache != null) { sc = processorCache.pop(); } if (sc == null) { sc = createSocketProcessor(socketWrapper, event); } else { sc.reset(socketWrapper, event); } Executor executor = getExecutor(); if (dispatch &amp;&amp; executor != null) { executor.execute(sc); } else { sc.run(); }  return true; }</pre><p>æ‰€ä»¥ï¼Œè¿™é‡Œæœ€ç»ˆä¼šè°ƒç”¨AbstractEndpointçš„processSocketæ–¹æ³•ï¼Œä¹‹å‰çœ‹è¿‡æˆ‘å‰é¢åšå®¢çš„åŒå­¦åº”è¯¥æœ‰å°è±¡ï¼ŒEndPointæ˜¯ç”¨æ¥æ¥å—å’Œå¤„ç†è¯·æ±‚çš„ï¼Œæ¥ä¸‹æ¥å°±ä¼šäº¤ç»™Processorå»è¿›è¡Œåè®®å¤„ç†ã€‚</p><pre>ç±»ï¼šAbstractProcessorLightpublic SocketState process(SocketWrapperBase&lt;?&gt; socketWrapper, SocketEvent status) throws IOException { //çœç•¥éƒ¨åˆ†diam SocketState state = SocketState.CLOSED; Iterator&lt;DispatchType&gt; dispatches = null; do { if (dispatches != null) { DispatchType nextDispatch = dispatches.next(); state = dispatch(nextDispatch.getSocketStatus()); } else if (status == SocketEvent.DISCONNECT) {  } else if (isAsync() || isUpgrade() || state == SocketState.ASYNC_END) { state = dispatch(status); if (state == SocketState.OPEN) { state = service(socketWrapper); } } else if (status == SocketEvent.OPEN_WRITE) { state = SocketState.LONG; } else if (status == SocketEvent.OPEN_READ){ state = service(socketWrapper); } else { state = SocketState.CLOSED; } } while (state == SocketState.ASYNC_END || dispatches != null &amp;&amp; state != SocketState.CLOSED); return state; }</pre><p>è¿™éƒ¨åˆ†æ˜¯é‡ç‚¹ï¼ŒAbstractProcessorLightä¼šæ ¹æ®SocketEventçš„çŠ¶æ€æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯è¦å»è°ƒç”¨service(socketWrapper),è¯¥æ–¹æ³•æœ€ç»ˆä¼šå»è°ƒç”¨åˆ°å®¹å™¨ï¼Œä»è€Œå®Œæˆä¸šåŠ¡é€»è¾‘çš„è°ƒç”¨ï¼Œæˆ‘ä»¬è¿™ä¸ªè¯·æ±‚æ˜¯æ‰§è¡Œå®Œæˆåè°ƒç”¨çš„ï¼Œè‚¯å®šä¸èƒ½è¿›å®¹å™¨äº†ï¼Œä¸ç„¶å°±æ˜¯æ­»å¾ªç¯äº†ï¼Œè¿™é‡Œé€šè¿‡isAsync()åˆ¤æ–­ï¼Œå°±ä¼šè¿›å…¥dispatch(status),æœ€ç»ˆä¼šè°ƒç”¨CoyoteAdapterçš„asyncDispatchæ–¹æ³•</p><pre>public boolean asyncDispatch(org.apache.coyote.Request req, org.apache.coyote.Response res, SocketEvent status) throws Exception { //çœç•¥éƒ¨åˆ†ä»£ç  Request request = (Request) req.getNote(ADAPTER_NOTES); Response response = (Response) res.getNote(ADAPTER_NOTES); boolean success = true; AsyncContextImpl asyncConImpl = request.getAsyncContextInternal(); try { if (!request.isAsync()) { response.setSuspended(false); } if (status==SocketEvent.TIMEOUT) { if (!asyncConImpl.timeout()) { asyncConImpl.setErrorState(null, false); } } else if (status==SocketEvent.ERROR) {  } if (!request.isAsyncDispatching() &amp;&amp; request.isAsync()) { WriteListener writeListener = res.getWriteListener(); ReadListener readListener = req.getReadListener(); if (writeListener != null &amp;&amp; status == SocketEvent.OPEN_WRITE) { ClassLoader oldCL = null; try { oldCL = request.getContext().bind(false, null); res.onWritePossible();//è¿™é‡Œæ‰§è¡Œæµè§ˆå™¨å“åº”ï¼Œå†™å…¥æ•°æ® if (request.isFinished() &amp;&amp; req.sendAllDataReadEvent() &amp;&amp; readListener != null) { readListener.onAllDataRead(); } } catch (Throwable t) {  } finally { request.getContext().unbind(false, oldCL); } }  } } //è¿™é‡Œåˆ¤æ–­å¼‚æ­¥æ­£åœ¨è¿›è¡Œï¼Œè¯´æ˜è¿™ä¸æ˜¯ä¸€ä¸ªå®Œæˆæ–¹æ³•çš„å›è°ƒï¼Œæ˜¯ä¸€ä¸ªæ­£å¸¸å¼‚æ­¥è¯·æ±‚ï¼Œç»§ç»­è°ƒç”¨å®¹å™¨ã€‚ if (request.isAsyncDispatching()) { connector.getService().getContainer().getPipeline().getFirst().invoke( request, response); Throwable t = (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION); if (t != null) { asyncConImpl.setErrorState(t, true); } } //æ³¨æ„ï¼Œè¿™é‡Œï¼Œå¦‚æœè¶…æ—¶æˆ–è€…å‡ºé”™ï¼Œrequest.isAsync()ä¼šè¿”å›falseï¼Œè¿™é‡Œæ˜¯ä¸ºäº†å°½å¿«çš„è¾“å‡ºé”™è¯¯ç»™å®¢æˆ·ç«¯ã€‚ if (!request.isAsync()) { //è¿™é‡Œä¹Ÿæ˜¯è¾“å‡ºé€»è¾‘ request.finishRequest(); response.finishResponse(); } //é”€æ¯requestå’Œresponse if (!success || !request.isAsync()) { updateWrapperErrorCount(request, response); request.recycle(); response.recycle(); } } return success; }</pre><p>ä¸Šé¢çš„ä»£ç å°±æ˜¯ctx.complete()æ‰§è¡Œæœ€ç»ˆçš„æ–¹æ³•äº†ï¼ˆå½“ç„¶çœç•¥äº†å¾ˆå¤šç»†èŠ‚ï¼‰ï¼Œå®Œæˆäº†æ•°æ®çš„è¾“å‡ºï¼Œæœ€ç»ˆè¾“å‡ºåˆ°æµè§ˆå™¨ã€‚</p><p>è¿™é‡Œæœ‰åŒå­¦å¯èƒ½ä¼šè¯´ï¼Œæˆ‘çŸ¥é“å¼‚æ­¥æ‰§è¡Œå®Œåï¼Œè°ƒç”¨ctx.complete()ä¼šè¾“å‡ºåˆ°æµè§ˆå™¨ï¼Œä½†æ˜¯ï¼Œç¬¬ä¸€æ¬¡doGetè¯·æ±‚æ‰§è¡Œå®Œæˆåï¼ŒTomcatæ˜¯æ€ä¹ˆçŸ¥é“ä¸ç”¨è¿”å›åˆ°å®¢æˆ·ç«¯çš„å‘¢ï¼Ÿå…³é”®ä»£ç åœ¨CoyoteAdapterä¸­çš„serviceæ–¹æ³•ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><pre> postParseSuccess = postParseRequest(req, request, res, response); //çœç•¥éƒ¨åˆ†ä»£ç  if (postParseSuccess) { request.setAsyncSupported( connector.getService().getContainer().getPipeline().isAsyncSupported()); connector.getService().getContainer().getPipeline().getFirst().invoke( request, response); } if (request.isAsync()) { async = true; } else { //è¾“å‡ºæ•°æ®åˆ°å®¢æˆ·ç«¯ request.finishRequest(); response.finishResponse(); if (!async) { updateWrapperErrorCount(request, response); //é”€æ¯requestå’Œresponse request.recycle(); response.recycle(); }</pre><p>è¿™éƒ¨åˆ†ä»£ç åœ¨è°ƒç”¨å®ŒServletåï¼Œä¼šé€šè¿‡request.isAsync()æ¥åˆ¤æ–­æ˜¯å¦æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå¦‚æœæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå°±è®¾ç½®async = trueã€‚å¦‚æœæ˜¯éå¼‚æ­¥è¯·æ±‚å°±æ‰§è¡Œè¾“å‡ºæ•°æ®åˆ°å®¢æˆ·ç«¯é€»è¾‘ï¼ŒåŒæ—¶é”€æ¯requestå’Œresponseã€‚è¿™é‡Œå°±å®Œæˆäº†è¯·æ±‚ç»“æŸåä¸å“åº”å®¢æˆ·ç«¯çš„æ“ä½œã€‚</p><h1>04 ä¸ºä»€ä¹ˆè¯´Spring Bootçš„@EnableAsyncæ³¨è§£ä¸æ˜¯å¼‚æ­¥Servlet</h1><p>å› ä¸ºä¹‹å‰å‡†å¤‡å†™æœ¬ç¯‡æ–‡ç« çš„æ—¶å€™å°±æŸ¥è¯¢è¿‡å¾ˆå¤šèµ„æ–™ï¼Œå‘ç°å¾ˆå¤šèµ„æ–™å†™SpringBootå¼‚æ­¥ç¼–ç¨‹éƒ½æ˜¯ä¾èµ–äº@EnableAsyncæ³¨è§£ï¼Œç„¶ååœ¨Controllerç”¨å¤šçº¿ç¨‹æ¥å®Œæˆä¸šåŠ¡é€»è¾‘ï¼Œæœ€åæ±‡æ€»ç»“æœï¼Œå®Œæˆè¿”å›è¾“å‡ºã€‚è¿™é‡Œæ‹¿ä¸€ä¸ªå¤§ä½¬çš„æ–‡ç« æ¥ä¸¾ä¾‹ã€Šæ–°æ‰‹ä¹Ÿèƒ½çœ‹æ‡‚çš„ SpringBoot å¼‚æ­¥ç¼–ç¨‹æŒ‡å—ã€‹ï¼Œè¿™ç¯‡æ–‡ç« å†™å¾—å¾ˆé€šä¿—æ˜“æ‡‚ï¼Œéå¸¸ä¸é”™ï¼Œä»ä¸šåŠ¡å±‚é¢æ¥è¯´ï¼Œç¡®å®æ˜¯å¼‚æ­¥ç¼–ç¨‹ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒæŠ›å¼€ä¸šåŠ¡çš„å¹¶è¡Œå¤„ç†æ¥è¯´ï¼Œé’ˆå¯¹æ•´ä¸ªè¯·æ±‚æ¥è¯´ï¼Œå¹¶ä¸æ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½ç«‹å³é‡Šæ”¾Tomcatçš„çº¿ç¨‹ï¼Œä»è€Œä¸èƒ½è¾¾åˆ°å¼‚æ­¥Servletçš„æ•ˆæœã€‚è¿™é‡Œæˆ‘å‚è€ƒä¸Šæ–‡ä¹Ÿå†™äº†ä¸€ä¸ªdemoï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸‹ï¼Œä¸ºä»€ä¹ˆå®ƒä¸æ˜¯å¼‚æ­¥çš„ã€‚</p><pre>@RestController@Slf4jpublic class TestController { @Autowired private TestService service; @GetMapping("/hello") public String test() { try { log.info("testAsynch Start"); CompletableFuture&lt;String&gt; test1 = service.test1(); CompletableFuture&lt;String&gt; test2 = service.test2(); CompletableFuture&lt;String&gt; test3 = service.test3(); CompletableFuture.allOf(test1, test2, test3); log.info("test1=====" + test1.get()); log.info("test2=====" + test2.get()); log.info("test3=====" + test3.get()); } catch (InterruptedException e) { e.printStackTrace(); } catch (ExecutionException e) { e.printStackTrace(); } return "hello"; }@Servicepublic class TestService { @Async("asyncExecutor") public CompletableFuture&lt;String&gt; test1() throws InterruptedException { Thread.sleep(3000L); return CompletableFuture.completedFuture("test1"); } @Async("asyncExecutor") public CompletableFuture&lt;String&gt; test2() throws InterruptedException { Thread.sleep(3000L); return CompletableFuture.completedFuture("test2"); } @Async("asyncExecutor") public CompletableFuture&lt;String&gt; test3() throws InterruptedException { Thread.sleep(3000L); return CompletableFuture.completedFuture("test3"); }}@SpringBootApplication@EnableAsyncpublic class TomcatdebugApplication { public static void main(String[] args) { SpringApplication.run(TomcatdebugApplication.class, args); } @Bean(name = "asyncExecutor") public Executor asyncExecutor() { ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(3); executor.setMaxPoolSize(3); executor.setQueueCapacity(100); executor.setThreadNamePrefix("AsynchThread-"); executor.initialize(); return executor; }</pre><p>è¿™é‡Œæˆ‘è¿è¡Œä¸‹ï¼Œçœ‹çœ‹æ•ˆæœ</p><div class=pgc-img><img alt=Tomcatæ˜¯å¦‚ä½•å®ç°å¼‚æ­¥Servletçš„ï¼Œä½ çŸ¥é“å—ï¼Ÿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4d1b5006dfb54876be61a5df981f87d3><p class=pgc-img-caption></p></div><p>è¿™é‡Œæˆ‘è¯·æ±‚ä¹‹åï¼Œåœ¨è°ƒç”¨å®¹å™¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä¹‹å‰æ‰“äº†ä¸€ä¸ªæ–­ç‚¹ï¼Œç„¶ååœ¨è¿”å›ä¹‹åçš„åŒæ ·æ‰“äº†ä¸€ä¸ªæ–­ç‚¹ï¼Œåœ¨Controlleræ‰§è¡Œå®Œä¹‹åï¼Œè¯·æ±‚æ‰å›åˆ°äº†CoyoteAdapterä¸­ï¼Œå¹¶ä¸”åˆ¤æ–­request.isAsync(),æ ¹æ®å›¾ä¸­çœ‹åˆ°ï¼Œæ˜¯ä¸ºfalse,é‚£ä¹ˆæ¥ä¸‹æ¥å°±ä¼šæ‰§è¡Œrequest.finishRequest()å’Œresponse.finishResponse() æ¥æ‰§è¡Œå“åº”çš„ç»“æŸï¼Œå¹¶é”€æ¯è¯·æ±‚å’Œå“åº”ä½“ã€‚å¾ˆæœ‰è¶£çš„äº‹æƒ…æ˜¯ï¼Œæˆ‘å®éªŒçš„æ—¶å€™å‘ç°ï¼Œåœ¨æ‰§è¡Œrequest.isAsync()ä¹‹å‰ï¼Œæµè§ˆå™¨çš„é¡µé¢ä¸Šå·²ç»å‡ºç°äº†å“åº”ä½“ï¼Œè¿™æ˜¯SpringBootæ¡†æ¶å·²ç»é€šè¿‡StringHttpMessageConverterç±»ä¸­çš„writeInternalæ–¹æ³•å·²ç»è¿›è¡Œè¾“å‡ºäº†ã€‚</p><p><strong>ä»¥ä¸Šåˆ†æçš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯</strong>ï¼ŒTomcatçš„çº¿ç¨‹æ‰§è¡ŒCoyoteAdapterè°ƒç”¨å®¹å™¨åï¼Œå¿…é¡»è¦ç­‰åˆ°è¯·æ±‚è¿”å›ï¼Œç„¶åå†åˆ¤æ–­æ˜¯å¦æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå†å¤„ç†è¯·æ±‚ï¼Œç„¶åæ‰§è¡Œå®Œæ¯•åï¼Œçº¿ç¨‹æ‰èƒ½è¿›è¡Œå›æ”¶ã€‚è€Œæˆ‘ä¸€æœ€å¼€å§‹çš„å¼‚æ­¥Servletä¾‹å­ï¼Œæ‰§è¡Œå®ŒdoGetæ–¹æ³•åï¼Œå°±ä¼šç«‹å³è¿”å›ï¼Œä¹Ÿå°±æ˜¯ä¼šç›´æ¥åˆ°request.isAsync()çš„é€»è¾‘ï¼Œç„¶åæ•´ä¸ªçº¿ç¨‹çš„é€»è¾‘æ‰§è¡Œå®Œæ¯•ï¼Œçº¿ç¨‹è¢«å›æ”¶ã€‚</p><h1>05 èŠèŠå¼‚æ­¥Servletçš„ä½¿ç”¨åœºæ™¯</h1><p>åˆ†æäº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆå¼‚æ­¥Servletçš„ä½¿ç”¨åœºæ™¯æœ‰å“ªäº›å‘¢ï¼Ÿå…¶å®æˆ‘ä»¬åªè¦æŠ“ä½ä¸€ç‚¹å°±å¯ä»¥åˆ†æäº†ï¼Œå°±æ˜¯å¼‚æ­¥Servletæé«˜äº†ç³»ç»Ÿçš„ååé‡ï¼Œå¯ä»¥æ¥å—æ›´å¤šçš„è¯·æ±‚ã€‚å‡è®¾webç³»ç»Ÿä¸­Tomcatçš„çº¿ç¨‹ä¸å¤Ÿç”¨äº†ï¼Œå¤§é‡è¯·æ±‚åœ¨ç­‰å¾…ï¼Œè€Œæ­¤æ—¶Webç³»ç»Ÿåº”ç”¨å±‚é¢çš„ä¼˜åŒ–å·²ç»ä¸èƒ½å†ä¼˜åŒ–äº†ï¼Œä¹Ÿå°±æ˜¯æ— æ³•ç¼©çŸ­ä¸šåŠ¡é€»è¾‘çš„å“åº”æ—¶é—´äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæƒ³è®©å‡å°‘ç”¨æˆ·çš„ç­‰å¾…æ—¶é—´ï¼Œæé«˜ååé‡ï¼Œå¯ä»¥å°è¯•ä¸‹ä½¿ç”¨å¼‚æ­¥Servletã€‚</p><p><strong>ä¸¾ä¸€ä¸ªå®é™…çš„ä¾‹å­</strong>ï¼šæ¯”å¦‚åšä¸€ä¸ªçŸ­ä¿¡ç³»ç»Ÿï¼ŒçŸ­ä¿¡ç³»ç»Ÿå¯¹å®æ—¶æ€§è¦æ±‚å¾ˆé«˜ï¼Œæ‰€ä»¥è¦æ±‚ç­‰å¾…æ—¶é—´å°½å¯èƒ½çŸ­ï¼Œè€Œå‘é€åŠŸèƒ½æˆ‘ä»¬å®é™…ä¸Šæ˜¯å§”æ‰˜è¿è¥å•†å»å‘é€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦è°ƒç”¨æ¥å£ï¼Œå‡è®¾å¹¶å‘é‡å¾ˆé«˜ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä¸šåŠ¡ç³»ç»Ÿè°ƒç”¨æˆ‘ä»¬çš„å‘é€çŸ­ä¿¡åŠŸèƒ½ï¼Œå°±æœ‰å¯èƒ½æŠŠæˆ‘ä»¬çš„Tomcatçº¿ç¨‹æ± ç”¨å®Œï¼Œå‰©ä¸‹çš„è¯·æ±‚å°±ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œé‚£è¿™ä¸ªæ—¶å€™ï¼ŒçŸ­ä¿¡çš„å»¶æ—¶å°±ä¸Šå»äº†ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥å¼‚æ­¥Servlet,æ¥å—æ›´å¤šçš„çŸ­ä¿¡å‘é€è¯·æ±‚ï¼Œä»è€Œå‡å°‘çŸ­ä¿¡çš„å»¶æ—¶ã€‚</p><h1>06 æ€»ç»“</h1><p>è¿™ç¯‡æ–‡ç« æˆ‘ä»æ‰‹å†™ä¸€ä¸ªå¼‚æ­¥Servletæ¥å¼€å§‹ï¼Œåˆ†æäº†å¼‚æ­¥Servletçš„ä½œç”¨ï¼Œä»¥åŠTomcatå†…éƒ¨æ˜¯å¦‚ä½•å®ç°å¼‚æ­¥Servletçš„ï¼Œç„¶åæˆ‘ä¹Ÿæ ¹æ®äº’è”ç½‘ä¸Šæµè¡Œçš„SpringBootå¼‚æ­¥ç¼–ç¨‹æ¥è¿›è¡Œè¯´æ˜ï¼Œå…¶åœ¨Tomcatå†…éƒ¨å¹¶ä¸æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„Servletã€‚æœ€åï¼Œæˆ‘è°ˆåˆ°äº†å¼‚æ­¥Servletçš„ä½¿ç”¨åœºæ™¯ï¼Œåˆ†æäº†ä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥å°è¯•å¼‚æ­¥Servletã€‚</p><p>åŸæ–‡é“¾æ¥ï¼šhttps://juejin.im/post/5d872a1b6fb9a06ad16fadb0</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Tomcat','å®ç°','å¼‚æ­¥'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>