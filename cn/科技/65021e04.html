<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Javaå¹¶å‘ç¼–ç¨‹ -- æ‰‹åŠ¨å®ç°å¯é‡å…¥Lock | æå®¢å¿«è¨Š</title><meta property="og:title" content="Javaå¹¶å‘ç¼–ç¨‹ -- æ‰‹åŠ¨å®ç°å¯é‡å…¥Lock - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/65021e04.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/65021e04.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/65021e04.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/65021e04.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/65021e04.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/65021e04.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/65021e04.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/65021e04.html><meta property="article:published_time" content="2020-11-14T20:55:07+08:00"><meta property="article:modified_time" content="2020-11-14T20:55:07+08:00"><meta name=Keywords content><meta name=description content="Javaå¹¶å‘ç¼–ç¨‹ -- æ‰‹åŠ¨å®ç°å¯é‡å…¥Lock"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/65021e04.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Javaå¹¶å‘ç¼–ç¨‹ -- æ‰‹åŠ¨å®ç°å¯é‡å…¥Lock</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><h1>å†…å®¹å¯¼è¯»</h1><blockquote><p>åŒæ­¥å—ä¸ä¿è¯ç­‰å¾…è¾“å…¥å®ƒçš„çº¿ç¨‹è¢«æˆäºˆè®¿é—®æƒé™çš„é¡ºåºã€‚åŒæ­¥å—å¿…é¡»å®Œå…¨åŒ…å«åœ¨å•ä¸ªæ–¹æ³•ä¸­ã€‚è°ƒç”¨æ­¤æ–¹æ³•çš„å…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šå¯¼è‡´æœªç»æ£€æŸ¥çš„å¼‚å¸¸ï¼ˆRuntimeExceptionï¼‰ã€‚ç»“æœæ²¡æœ‰å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œè¿™é‡Œä¸åšæˆªå›¾äº†ï¼Œè‡ªå·±å¯ä»¥è¯•è¯•ã€‚ä½†æ˜¯æˆ‘ä»¬å†™çš„æ–¹æ³•è¿˜æœ‰ä¸€å®šçš„é—®é¢˜ï¼Œå°±æ˜¯MyLockè¿™ä¸ªç±»ä¸æ”¯æŒ å¯é‡å…¥é”ï¼Œæ„æ€å°±æ˜¯å¦‚æœæœ‰ä¸¤ä¸ªé”åµŒå¥—ï¼Œå¦‚æœç›¸åŒçš„çº¿ç¨‹å…ˆè°ƒç”¨aæ–¹æ³•ï¼Œå†è°ƒç”¨å¸¦é”çš„bæ–¹æ³•ï¼Œåˆ™å°±ä¼šè¿›å…¥è‡ªæ—‹é”ã€‚ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œa()æ–¹æ³•ï¼Œå¾—åˆ°äº†é”ï¼Œä½¿lockedByç­‰äºå½“å‰çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰§è¡Œçš„è¿™ä¸ªæ–¹æ³•çš„çº¿ç¨‹è·å¾—äº†è¿™ä¸ªé”ï¼Œæ‰§è¡Œadd()æ–¹æ³•æ—¶ï¼ŒåŒæ ·è¦å…ˆè·å¾—é”ï¼Œå› ä¸æ»¡è¶³whileå¾ªç¯çš„æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸ç­‰å¾…ï¼Œç»§ç»­è¿›è¡Œï¼Œå°†æ­¤æ—¶çš„lockedCountå˜é‡ï¼Œä¹Ÿå°±æ˜¯å½“å‰è·å¾—é”çš„æ•°é‡åŠ ä¸€ï¼Œå½“é‡Šæ”¾äº†æ‰€æœ‰çš„é”ï¼Œæ‰æ‰§è¡Œnotify()ã€‚</p></blockquote><blockquote><p>Lockå°±åƒsynchronizedå—ä¸€æ ·æ˜¯ä¸€ä¸ªçº¿ç¨‹åŒæ­¥æœºåˆ¶ã€‚ ç„¶è€Œï¼ŒLockå®šæ¯”synchronizedæ›´çµæ´»ã€æ›´å¤æ‚ã€‚</p></blockquote><h3>Lockå’Œsynchronizedå— çš„åŒºåˆ«</h3><ul class=list-paddingleft-2><li><p>åŒæ­¥å—ä¸ä¿è¯ç­‰å¾…è¾“å…¥å®ƒçš„çº¿ç¨‹è¢«æˆäºˆè®¿é—®æƒé™çš„é¡ºåºã€‚</p></li><li><p>ä¸èƒ½å°†ä»»ä½•å‚æ•°ä¼ é€’ç»™åŒæ­¥å—çš„æ¡ç›®ã€‚</p></li><li><p>åŒæ­¥å—å¿…é¡»å®Œå…¨åŒ…å«åœ¨å•ä¸ªæ–¹æ³•ä¸­ã€‚ ä¸€ä¸ªLockå¯ä»¥åœ¨ä¸åŒçš„æ–¹æ³•ä¸­è°ƒç”¨lockï¼ˆï¼‰å’Œunlockï¼ˆï¼‰ã€‚</p></li></ul><h3>ç®€å•ä¾‹å­</h3><pre>Lock lock = new ReentrantLock();lock.lock();//è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„ä»£ç lock.unlock();</pre><p>å…¶ä¸­ï¼Œä½ åº”è¯¥èƒ½å¤ŸçŒœåˆ°ï¼Œlock() æ–¹æ³•æ˜¯åŠ é”ï¼Œunlock()æ–¹æ³•æ˜¯è§£é”ã€‚</p><h3>Lockæ¥å£å«æœ‰çš„æ–¹æ³•</h3><ul class=list-paddingleft-2><li><p>lock()</p></li><li><p>lockInterruptibly()</p></li><li><p>tryLock()</p></li><li><p>tryLock(long timeout, TimeUnit timeUnit)</p></li><li><p>unlock()</p></li></ul><p>lockï¼ˆï¼‰æ–¹æ³•é”å®šLockå®ä¾‹ã€‚ å¦‚æœé”å®šå®ä¾‹å·²è¢«é”å®šï¼Œåˆ™çº¿ç¨‹è°ƒç”¨é”å®šï¼ˆï¼‰å°†è¢«é”å®šï¼Œç›´åˆ°è§£é”é”å®šã€‚</p><p>lockInterruptiblyï¼ˆï¼‰æ–¹æ³•é”å®šLockï¼Œé™¤éè°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹å·²è¢«ä¸­æ–­ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è¢«é˜»å¡ï¼Œç­‰å¾…é€šè¿‡æ­¤æ–¹æ³•é”å®šLockï¼Œè¯¥çº¿ç¨‹å°†è¢«ä¸­æ–­ï¼Œå¹¶é€€å‡ºæ­¤æ–¹æ³•è°ƒç”¨ã€‚ï¼ˆè·å–é”çš„æ—¶å€™å¯ä»¥è¢«ä¸­æ–­ï¼‰</p><p>tryLockï¼ˆï¼‰æ–¹æ³•ç«‹å³å°è¯•é”å®šLockå®ä¾‹ã€‚ å¦‚æœé”å®šæˆåŠŸåˆ™è¿”å›true;å¦‚æœLockå·²ç»è¢«é”å®šï¼Œåˆ™è¿”å›falseã€‚ <strong>è¿™ä¸ªæ–¹æ³•æ°¸è¿œä¸ä¼šé˜»å¡</strong></p><p>tryLockï¼ˆlong timeoutï¼ŒTimeUnit timeUnitï¼‰çš„å·¥ä½œæ–¹å¼ä¸tryLockï¼ˆï¼‰æ–¹æ³•ç›¸ä¼¼ï¼Œåªæ˜¯å®ƒå¯¹è¶…æ—¶æ—¶é—´æœ‰æ‰€è§„å®šã€‚</p><p>unlockï¼ˆï¼‰æ–¹æ³•è§£é”Lockå®ä¾‹ã€‚ é€šå¸¸ï¼ŒLockå®ç°å°†åªå…è®¸å·²é”å®šLockçš„çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•ã€‚ è°ƒç”¨æ­¤æ–¹æ³•çš„å…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šå¯¼è‡´æœªç»æ£€æŸ¥çš„å¼‚å¸¸ï¼ˆRuntimeExceptionï¼‰ã€‚</p><h3>ReentrantLockå®ä¾‹</h3><p>ReentrantLock å¯é‡å…¥é”ï¼Œæ˜¯Lockçš„ä¸€ä¸ªå­ç±»ã€‚æˆ‘ä»¬è¿™é‡Œæ¥ä½¿ç”¨å®ƒå®ç°çº¿ç¨‹å®‰å…¨ç¼–ç¨‹ã€‚</p><pre>package com.lock;import com.thread.security.Task;import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;/** * é‡å…¥é” * Created by Fant.J. * 2018/3/6 20:09 */public class ReentrantLockTest { public int value = 0; //å®ä¾‹åŒ–é‡å…¥é”é” Lock lock = new ReentrantLock(); public int getValue() { //åŠ é” lock.lock(); int a = value++; //æ¶ˆé™¤é” lock.unlock(); return a; } public static void main(String[] args) { ReentrantLockTest task = new ReentrantLockTest(); new Thread(){ @Override public void run() { while (true) { System.out.println(Thread.currentThread().getName() + " " + task.getValue()); try { Thread.sleep(500); } catch (InterruptedException e) { e.printStackTrace(); } } } }.start(); new Thread(){ @Override public void run() { while (true) { System.out.println(Thread.currentThread().getName() + " " + task.getValue()); try { Thread.sleep(500); } catch (InterruptedException e) { e.printStackTrace(); } } } }.start(); }}</pre><h3>æ‰‹å†™è‡ªå·±çš„Lockå®ç°ç±»</h3><p>å¦‚æœæœ‰ç‰¹æ®Šä¸šåŠ¡éœ€æ±‚ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡å†™Lockæ¥å£ï¼Œæ¥æ‰“é€ ä¸€ä¸ªè‡ªå·±çš„locké”ã€‚</p><pre>package com.lock;import java.util.concurrent.TimeUnit;import java.util.concurrent.locks.Condition;import java.util.concurrent.locks.Lock;/** * Created by Fant.J. * 2018/3/6 20:12 */public class MyLock implements Lock { //å£°æ˜ä¸€ä¸ªåˆ¤æ–­é”çš„å¸ƒå°”å€¼ private boolean isLocked = false; /** * å¿…é¡»å£°æ˜ synchronized åŸè‡ªè¡Œæ“ä½œï¼Œä¸ç„¶jvmä¸ä¼šè¯†åˆ«æ˜¯å“ªä¸ªçº¿ç¨‹çš„waitæ–¹æ³•ï¼Œnotifyä¹Ÿä¸€æ · */ @Override public synchronized void lock() { while (isLocked){ try { wait(); } catch (InterruptedException e) { e.printStackTrace(); } } isLocked = true; } @Override public synchronized void unlock() { isLocked = false; notify(); } @Override public void lockInterruptibly() throws InterruptedException { } @Override public boolean tryLock() { return false; } @Override public boolean tryLock(long time, TimeUnit unit) throws InterruptedException { return false; } @Override public Condition newCondition() { return null; }}</pre><p>ç„¶åæˆ‘ä»¬åšæµ‹è¯•</p><pre>package com.lock;/** * Created by Fant.J. * 2018/3/6 20:24 */public class MyLockTest { public int value = 0; MyLock myLock = new MyLock(); public int getValue(){ myLock.lock(); value++; myLock.unlock(); return value; } public static void main(String[] args) { MyLockTest task = new MyLockTest(); new Thread(){ @Override public void run() { while (true) { System.out.println(Thread.currentThread().getName() + " " + task.getValue()); try { Thread.sleep(500); } catch (InterruptedException e) { e.printStackTrace(); } } } }.start(); new Thread(){ @Override public void run() { while (true) { System.out.println(Thread.currentThread().getName() + " " + task.getValue()); try { Thread.sleep(500); } catch (InterruptedException e) { e.printStackTrace(); } } } }.start(); }}</pre><p>ç»“æœæ²¡æœ‰å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œè¿™é‡Œä¸åšæˆªå›¾äº†ï¼Œè‡ªå·±å¯ä»¥è¯•è¯•ã€‚ä½†æ˜¯æˆ‘ä»¬å†™çš„æ–¹æ³•è¿˜æœ‰ä¸€å®šçš„é—®é¢˜ï¼Œå°±æ˜¯MyLockè¿™ä¸ªç±»ä¸æ”¯æŒ å¯é‡å…¥é”ï¼Œæ„æ€å°±æ˜¯å¦‚æœæœ‰ä¸¤ä¸ªé”åµŒå¥—ï¼Œå¦‚æœç›¸åŒçš„çº¿ç¨‹å…ˆè°ƒç”¨aæ–¹æ³•ï¼Œå†è°ƒç”¨å¸¦é”çš„bæ–¹æ³•ï¼Œåˆ™å°±ä¼šè¿›å…¥è‡ªæ—‹é”ã€‚</p><h5>æµ‹è¯•æ–¹æ³•æºç </h5><pre>package com.lock;/** * Created by Fant.J. * 2018/3/6 20:24 */public class MyLockTest2 { public int value = 0; MyLock myLock = new MyLock(); public void a(){ myLock.lock(); System.out.println("a"); b(); myLock.unlock(); } public void b(){ myLock.lock(); System.out.println("b"); myLock.unlock(); } public static void main(String[] args) { MyLockTest2 task = new MyLockTest2(); new Thread(){ @Override public void run() { task.a(); } }.start(); new Thread(){ @Override public void run() { task.a(); } }.start(); }}</pre><p>æ‰§è¡Œè¯¥æ–¹æ³•åï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œçº¿ç¨‹åœæ­¢åœ¨æ‰“å°å‡º"a"åï¼Œä¸€ç›´åœ¨ç­‰å¾…ã€‚è¿™å°±æ˜¯å› ä¸ºè¯¥é”ä¸æ˜¯å¯é‡å…¥é”ã€‚</p><h5>å¯é‡å…¥é”çš„è®¾è®¡</h5><p>æˆ‘åœ¨è¿™é‡Œåªè´´å’Œä¸Šé¢ä»£ç ä¸åŒçš„éƒ¨åˆ†ã€‚</p><pre>public class MyLock implements Lock { //å£°æ˜ä¸€ä¸ªåˆ¤æ–­é”çš„å¸ƒå°”å€¼ private boolean isLocked = false; Thread lockBy = null; int lockCount = 0; @Override public synchronized void lock() { Thread currentThread = Thread.currentThread(); //è·å–åˆ°å½“å‰çº¿ç¨‹ while (isLocked &amp;&amp; currentThread != lockBy){ try { wait(); } catch (InterruptedException e) { e.printStackTrace(); } } isLocked = true; lockBy = currentThread; //å°†currentThreadçº¿ç¨‹æŒ‡å‘ lockByçº¿ç¨‹ lockCount++;//è®¡æ•°å™¨è‡ªå¢ } @Override public synchronized void unlock() { if (lockBy == Thread.currentThread()){ lockCount--; if (lockCount ==0 ){ notify(); isLocked = false; } } }}</pre><p>ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œa()æ–¹æ³•ï¼Œå¾—åˆ°äº†é”ï¼Œä½¿lockedByç­‰äºå½“å‰çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰§è¡Œçš„è¿™ä¸ªæ–¹æ³•çš„çº¿ç¨‹è·å¾—äº†è¿™ä¸ªé”ï¼Œæ‰§è¡Œadd()æ–¹æ³•æ—¶ï¼ŒåŒæ ·è¦å…ˆè·å¾—é”ï¼Œå› ä¸æ»¡è¶³whileå¾ªç¯çš„æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸ç­‰å¾…ï¼Œç»§ç»­è¿›è¡Œï¼Œå°†æ­¤æ—¶çš„lockedCountå˜é‡ï¼Œä¹Ÿå°±æ˜¯å½“å‰è·å¾—é”çš„æ•°é‡åŠ ä¸€ï¼Œå½“é‡Šæ”¾äº†æ‰€æœ‰çš„é”ï¼Œæ‰æ‰§è¡Œnotify()ã€‚å¦‚æœåœ¨æ‰§è¡Œè¿™ä¸ªæ–¹æ³•æ—¶ï¼Œæœ‰ç¬¬äºŒä¸ªçº¿ç¨‹æƒ³è¦æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºlockedByä¸ç­‰äºç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œå¯¼è‡´è¿™ä¸ªçº¿ç¨‹è¿›å…¥äº†å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…ï¼Œä¸æ–­æ‰§è¡Œwait()æ–¹æ³•ã€‚åªæœ‰å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾äº†æ‰€æœ‰çš„é”ï¼Œæ‰§è¡Œäº†notify()æ–¹æ³•ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹æ‰å¾—ä»¥è·³å‡ºå¾ªç¯ï¼Œç»§ç»­æ‰§è¡Œã€‚</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Java','å‘ç¼–ç¨‹','--'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>