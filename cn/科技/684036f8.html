<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>使用 freetype 显示单个文字 | 极客快訊</title><meta property="og:title" content="使用 freetype 显示单个文字 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/dfic-imagehandler/ec645347-4f84-4e97-8a0c-6bd59c588704"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/684036f8.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/684036f8.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/684036f8.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/684036f8.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/684036f8.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/684036f8.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/684036f8.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/684036f8.html><meta property="article:published_time" content="2020-11-14T21:05:00+08:00"><meta property="article:modified_time" content="2020-11-14T21:05:00+08:00"><meta name=Keywords content><meta name=description content="使用 freetype 显示单个文字"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/684036f8.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>使用 freetype 显示单个文字</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><br></p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/dfic-imagehandler/ec645347-4f84-4e97-8a0c-6bd59c588704><p class=pgc-img-caption></p></div><blockquote class=pgc-blockquote-abstract><p>来源：百问网</p><p style=text-align:justify>作者：韦东山</p><p style=text-align:justify>本文字数：5290，阅读时长：7分钟</p></blockquote><p>使用 GIT 下载所有源码后，本节源码位于如下目录：</p><blockquote class=pgc-blockquote-abstract><p>01_all_series_quickstart\</p><p>04_嵌入式 Linux 应用开发基础知识\source\10_freetype\</p><p>01_wchar\test_wchar.c</p><p>02_freetype_show_font\freetype_show_font.c</p><p>03_freetype_show_font_angle\freetype_show_font_angle.c</p></blockquote><p><br></p><h1 class=pgc-h-arrow-right>1、矢量字体引入</h1><p>使用点阵字库显示英文字母、汉字时，大小固定，如果放大缩小则会模糊甚至有锯齿出现，为了解决这</p><p>个问题，引用矢量字体。</p><p>矢量字体形成分三步：</p><p>① 确定关键点，</p><p>② 使用数学曲线（贝塞尔曲线）连接头键点，</p><p>③ 填充闭合区线内部空间。</p><p>什么是关键点？以字母“A”为例，它的的关键点如下图中的黄色所示。</p><p><br></p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e4e270128cb44bb1a1cf3eb5c273a9d8><p class=pgc-img-caption></p></div><p>再用数学曲线(比如贝塞尔曲线)将关键点都连接起来，得到一系列的封闭的曲线，如下图所示：</p><p><br></p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/9e2d9375d9884e63a5ed48cc0884a928><p class=pgc-img-caption></p></div><p>最后把封闭空间填满颜色，就显示出一个 A 字母，如下图所示：</p><p><br></p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c83a31c31b4c4190a8d4566369ae7832><p class=pgc-img-caption></p></div><p>如果需要放大或者缩小字体，关键点的相对位置是不变的，只要数学曲线平滑，字体就不会变形。</p><p><br></p><h1 class=pgc-h-arrow-right>2、Freetype 介绍</h1><p>Freetype 是开源的字体引擎库，它提供统一的接口来访问多种字体格式文件，从而实现矢量字体显示。我们只需要移植这个字体引擎，调用对应的 API 接口，提供字体文件，就可以让 freetype 库帮我们取出关键点、实现闭合曲线，填充颜色，达到显示矢量字体的目的。</p><p>关键点(glyph)存在字体文件中，Windows 使用的字体文件在 c:\Windows\Fonts 目录下，扩展名为 TTF的都是矢量字库，本次使用实验使用的是新宋字体 simsun.ttc。</p><p>给定一个字符，怎么在字体文件中找到它的关键点？</p><p>首先要确定该字符的编码值：比如 ASCII 码、GB2312 码、UNICODE 码。如果字体文件支持某种编码格式(charset)，就可以使用这类编码值去找到该字符的关键点(glyph)。有些字体文件支持多种编码格式(charset)，这在文件中被称为 charmaps(注意：这个单词是复数，意味着可能支持多种 charset)。</p><p>以 simsun.ttc 为值，该字体文件的格如下：头部含有 charmaps，可以使用某种编码值去 charmaps 中找到它对应的关键点。下图中的“A、B、中、国、韦”等只是 glyph 的示意图，表示关键点。</p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fbb04ce877b04d679560a69923071101><p class=pgc-img-caption></p></div><p>Charmaps 表示字符映射表，字体文件可能支持哪一些编码，GB2312、UNICODE、BIG5 或其他。如果字体文件支持该编码，使用编码值通过 charmap 就可以找到对应的 glyph，一般而言都支持 UNICODE 码。</p><p><br></p><p>有了以上基础，一个文字的显示过程可以概括如下：</p><p>① 给定一个字符可以确定它的编码值(ASCII、UNICODE、GB2312)；</p><p>② 设置字体大小；</p><p>③ 根据编码值，从文件头部中通过 charmap 找到对应的关键点(glyph)，它会根据字体大小调整关键点；</p><p>④ 把关键点转换为位图点阵；</p><p>⑤ 在 LCD 上显示出来</p><p><br></p><p>下载到“freetype-doc-2.10.2.tar.xz”，下图中的文件就是官方文档：</p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/62d86b3bddbc429ab0e45d6f294b5b17><p class=pgc-img-caption></p></div><p>参照上图中 step1，step2，step3 里的内容，可以学习如何使用 freetype 库，总结出下列步骤：</p><p>① 初始化：FT_InitFreetype</p><p>② 加载(打开)字体 Face：FT_New_Face</p><p>③ 设置字体大小：FT_Set_Char_Sizes 或 FT_Set_Pixel_Sizes</p><p>④ 选择 charmap：FT_Select_Charmap</p><p>⑤ 根据编码值 charcode 找到 glyph_index：glyph_index = FT_Get_Char_Index（face，charcode）</p><p>⑥ 根据 glyph_index 取出 glyph：FT_Load_Glyph（face，glyph_index）</p><p>⑦ 转为位图：FT_Render_Glyph</p><p>⑧ 移动或旋转:FT_Set_Transform</p><p>⑨ 最后显示出来。</p><p><br></p><p>上面的⑤⑥⑦可以使用一个函数代替：FT_Load_Char(face, charcode, FT_LOAD_RENDER)，它就可以得到位图。</p><p><br></p><h1 class=pgc-h-arrow-right>3、在 LCD 上显示一个矢量字体</h1><p><strong>1. 使用 wchar_t 获得字符的 UNICODE 值</strong></p><p>要显示一个字符，首先要确定它的编码值。常用的是 UNICODE 编码，在程序里使用这样的语句定义字符串时，str 中保存的要么是 GB2312 编码值，要么是 UTF-8 格式的编码值，即使编译时使用“-fexec-charset=UTF-8”，str 中保存的也不是直接能使用的 UNICODE 值：</p><pre><code>char *str = “中”;</code></pre><p>如果想在代码中能直接使用 UNICODE 值，需要使用 wchar_t，宽字符，示例代码如下：</p><pre><code>01 #include &lt;stdio.h&gt;02 #include &lt;string.h&gt;03 #include &lt;wchar.h&gt;0405 int main( int argc, char** argv)06 {07 wchar_t *chinese_str = L"中 gif";08 unsigned int *p = (wchar_t *)chinese_str;09 int i;1011 printf("sizeof(wchar_t) = %d, str's Uniocde: \n", (int)sizeof(wchar_t));12 for (i = 0; i &lt; wcslen(chinese_str); i++)13 {14 printf("0x%x ", p[i]);15 }16 printf("\n");1718 return 0;19 }}</code></pre><p>以 UTF-8 格式保存 test_wchar.c，编译、测试命令如下：</p><pre><code>book@book-virtual-machine:~/10_freetype/01_wchar$ gcc -o test_wchar test_wchar.cbook@book-virtual-machine:~/10_freetype/01_wchar$ ./test_wcharsizeof(wchar_t) = 4, str's Uniocde:0x4e2d 0x67 0x69 0x66</code></pre><p>每个 wchar_t 占据 4 字节，可执行程序里 wchar_t 中保存的就是字符的 UNICODE 值。</p><p><strong>注意</strong>：如果 test_wchar.c 是以 ANSI(GB2312)格式保存，那么需要使用以下命令来编译：</p><pre><code>gcc -finput-charset=GB2312 -fexec-charset=UTF-8 -o test_wchar test_wchar.c</code></pre><p><br></p><p><strong>2. 使用 freetype 得到位图</strong></p><p>参考“freetype-doc-2.10.2\freetype-2.10.2\docs\tutorial\image.c”，使用 freetype 显示一个字</p><p>符并不难。</p><p>使用 GIT 下载所有源码后，本节源码位于如下目录：</p><pre><code>01_all_series_quickstart\04_嵌入式 Linux 应用开发基础知识\source\10_freetype\02_freetype_show_font\freetype_show_font.c</code></pre><p>要使用 freetype 得到一个字符的位图，只需要 4 个步骤，代码先贴出来再分析：</p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/303406257dc74c0e8a3bc2c3bac3c48b><p class=pgc-img-caption></p></div><p>① 初始化 freetype 库</p><pre><code>158 error = FT_Init_FreeType( &amp;library ); /* initialize library */</code></pre><p><br></p><p>② 加载字体文件，保存在&face 中：</p><pre><code>161 error = FT_New_Face( library, argv[1], 0, &amp;face ); /* create face object */162 /* error handling omitted */163 slot = face-&gt;glyph;</code></pre><p>第 163 行是从 face 中获得 FT_GlyphSlot，后面的代码中文字的位图就是保存在 FT_GlyphSlot 里。</p><p><br></p><p>③ 设置字体大小</p><pre><code>165 FT_Set_Pixel_Sizes(face, font_size, 0);</code></pre><p><br></p><p>④ 根据编码值得到位图</p><p>使用 FT_Load_Char 函数，就可以实现这 3 个功能：</p><p>a. 根据编码值获得 glyph_index：FT_Get_Char_Index</p><p>b. 根据 glyph_idex 取出 glyph：FT_Load_Glyph</p><p>c. 渲染出位图：FT_Render_Glyph</p><p>代码如下：</p><pre><code>175 /* load glyph image into the slot (erase previous one) */176 error = FT_Load_Char( face, chinese_str[0], FT_LOAD_RENDER );</code></pre><p><br></p><p><strong>3. 在屏幕上显示位图</strong></p><p>位图里的数据格式是怎样的？参考 example1.c 的代码，可以得到下面这个图：</p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f6c82ed4654e4b63b75963c1105b5384><p class=pgc-img-caption></p></div><p>要在屏幕上显示出这些位图，并不复杂：</p><pre><code>183 draw_bitmap( &amp;slot-&gt;bitmap,184 var.xres/2,185 var.yres/2);</code></pre><p>draw_bitmap 函数代码如下，由于位图中每一个像素用一个字节来表示，在 0x00RRGGBB 的颜色格式中它只能表示蓝色，所以在 LCD 上显示出来的文字是蓝色的：</p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/39340873544f4d4e98229d8958e89331><p class=pgc-img-caption></p></div><p><strong>4. 编译</strong></p><p>编译命令(如果你使用的交叉编译链前缀不是 arm-buildroot-linux-gnueabihf，请自行修改命令)：</p><pre><code>$ arm-buildroot-linux-gnueabihf-gcc -o freetype_show_font freetype_show_font.c -lfreetype</code></pre><p><br></p><p>它会提示如下错误：</p><pre><code>freetype_show_font.c:12:10: fatal error: ft2build.h: No such file or directory#include &lt;ft2build.h&gt; ^~~~~~~~~~~~compilation terminated.</code></pre><p>我们不是已经编译过 freetype 并且把头文件复制进工具链里了吗？怎么还有这个错误？</p><p>我们编译出 freetype 后，得到的 ft2build.h 是位于 freetype2 目录里，我们把整个 freetype2 目录</p><p>复制进了工具链里。</p><p>但是包括头文件时，用的是“#include &lt;ft2build.h>”，要么改成：</p><pre><code>#include &lt;freetype2/ft2build.h&gt;</code></pre><p>要么把工具链里 incldue/freetype2/*.h 复制到上一级目录，我们使用这种方法：跟 freetype 文档保持一致。执行以下命令：</p><pre><code>book@PC$ cd /home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/includebook@PC$ mv freetype2/* ./</code></pre><p>然后再次执行以下命令：</p><pre><code>$ arm-buildroot-linux-gnueabihf-gcc -o freetype_show_font freetype_show_font.c -lfreetype</code></pre><p><br></p><p><strong>5. 上机</strong></p><p>将编译好的 freetype_show_font 文件与 simsun.ttc 字体文件拷贝至开发板，这 2 个文件放在同一个目录下，然后执行以下命令。</p><pre><code>[root@board:~]# ./freetype_show_font ./simsun.ttc 或[root@board:~]# ./freetype_show_font ./simsun.ttc 300</code></pre><p>如果实验成功，我们将在屏幕中间看到一个蓝色的“繁”字。</p><p><br></p><h1 class=pgc-h-arrow-right>4、在 LCD 上令矢量字体旋转某个角度</h1><p>使用 GIT 下载所有源码后，本节源码位于如下目录：</p><pre><code>01_all_series_quickstart\04_嵌入式 Linux 应用开发基础知识\source\10_freetype\03_freetype_show_font_angle\freetype_show_font_angle.c</code></pre><p>在实现显示一个矢量字体后，我们可以添加让该字旋转某个角度的功能，主要代码还是参照 example1.c。</p><p><strong>1. 关键代码</strong></p><p>① 定义 2 个变量：角度、矩阵，如下：</p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7643c0f0fb9e4417ab4e433460aef4d4><p class=pgc-img-caption></p></div><p>② 设置角度值：</p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/06da8ab2c4664916a37a9fb8c02bc71e><p class=pgc-img-caption></p></div><p>③ 设置矩阵、交形、加载位图：</p><div class=pgc-img><img alt="使用 freetype 显示单个文字" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/afd374db440449f88dc8425312dc5fb5><p class=pgc-img-caption></p></div><p><strong>2. 编译</strong></p><p>编译命令(如果你使用的交叉编译链前缀不是 arm-buildroot-linux-gnueabihf，请自行修改命令)：</p><pre><code>$ arm-buildroot-linux-gnueabihf-gcc -o freetype_show_font_angle freetype_show_font_angle.c -lfreetype -lm</code></pre><p><strong>3. 上机</strong></p><p>将编译好的 freetype_show_font_angle 文件与 simsun.ttc 字体文件拷贝至开发板，这 2 个文件放在同一个目录下，然后执行以下命令。</p><pre><code>[root@board:~]# ./freetype_show_font_angle ./simsun.ttc 90 200</code></pre><p>如果实验成功，我们将在屏幕中间看到一个蓝色的、旋转了 90 度的“繁”字。</p><p style=text-align:center><strong><a class=pgc-link data-content=mp data-source=innerLink href="https://www.toutiao.com/i6852662053107302919/?group_id=6852662053107302919" rel="noopener noreferrer" target=_blank>「新品首发」STM32MP157开发板火爆预售！首批仅300套</a></strong></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'freetype','显示','单个'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>