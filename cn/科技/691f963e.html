<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思 | 极客快訊</title><meta property="og:title" content="程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/913668674f0d4e629060e223c434f97b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/691f963e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/691f963e.html><meta property="article:published_time" content="2020-11-14T21:02:06+08:00"><meta property="article:modified_time" content="2020-11-14T21:02:06+08:00"><meta name=Keywords content><meta name=description content="程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/691f963e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>在上一章节中分析HashMap内部实现基本点，HashMap初始化，HashMap扩容。本章对Hash冲突，树化，线程安全内容继续剖析。</p><div class=pgc-img><img alt=程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/913668674f0d4e629060e223c434f97b><p class=pgc-img-caption></p></div><h1><strong>分析目录：</strong></h1><p>HashMap内部实现基本点分析；</p><p>容量（capcity）；负载系数（load factor）；</p><p>HashMap初始化；</p><p>HashMap扩容；</p><p>Hash冲突；</p><p>树化；</p><p>线程安全；</p><div class=pgc-img><img alt=程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dac9dfa4faec4dd992e4b612c864ae67><p class=pgc-img-caption></p></div><h1>Hash冲突分析：</h1><p>前面提到HashMap 数据结构是 数组 + 链表 + 红黑树；</p><p>当HashMap中添加一个数据的时候，需要通过key计算Hash值，通过Hash值计算数组存放的索引，不同的Key 通过Hash算法计算可能会出现相同的值，所以如果通过数组存放数据的时候地址会出现冲突，而HashMap的出现就是为了解决Hash冲突。</p><p><strong>计算Hash值源代码：</strong></p><pre>static final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);}</pre><p>通过传入的Key获取计算hash值，然后调用图1 putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict)方法进行插入。</p><p>通过n = tab.length，p = tab[i = (n - 1) & hash] ；</p><p>通过(n - 1) & hash计算出数组的索引；</p><p>通过位运算消耗资源更少，效率更高，还避免了hashcode为负数的情况。</p><div class=pgc-img><img alt=程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cd5c92e9532e4925a037ebf0576d6ed8><p class=pgc-img-caption>图1</p></div><p><strong>哈希冲突概念：</strong></p><p>哈希冲突是指哈希函数算的数据存放地址被别的数据占用了。不同的Hash函数实现会影响发生哈希冲突率。</p><div class=pgc-img><img alt=程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/bf9b8fb757bc4dd6a1f293c48c34deb7><p class=pgc-img-caption>put操作</p></div><pre>transient Node&lt;K,V&gt;[] table;</pre><p>HashMap中的数组通过源代码我们知道它虽然是数组，但是它是通过Hash算法将数据放入数据中，就是一个Hash表结构。</p><p><strong>哈希表概念：</strong></p><p>哈希表是通过散列技术实现的，散列技术是指在数据存储位置和它的关键字（Key）之间建立对应关系，使每一个关键字（key）都对应一个存储位置。在查找的数据的过程中，只需要通过这个对应关系找到给定值key的映射关系。只要集合中存在关键字和key相等的记录，则可以找到存储位置。我们把这种对应关系 称为散列函数或哈希函数。简单的理解就是在指定的区域内为房间编排个门牌号，我们需要找房间的时候通过钥匙（key）上编号知道门牌号，然后找到房间。</p><div class=pgc-img><img alt=程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d09341e1a29549e3a305c772fb81994a><p class=pgc-img-caption>hash表样式</p></div><p>所以采用散列技术将记录存储在一块连续的存储空间中，这块连续的存储空间称为哈希表，所得的存储地址称为哈希地址或散列地址，HashMap中的数组就是哈希表，也叫Hash桶。</p><p><strong>为什么要使用哈希表？</strong></p><p>普通的数组以及链表在查询指定元素的时候，需要从开始遍历，时间复杂度为O(n)。</p><p>哈希表能够根据元素本身计算Hash值直接找到元素指定位置，时间复杂度为O（1）；所以哈希表它在查询和删除、插入性能上会比数组和链表要快很多。</p><p><strong>当冲突后怎么办？带着问题继续看</strong></p><div class=pgc-img><img alt=程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/dd1abb2792594882ae687a60fa54b16c><p class=pgc-img-caption>图2</p></div><h1>HashMap树化</h1><p>Jdk1.8引入了红黑树数据结构，这个主要是为了解决<strong>大量hash冲突</strong>而引入的，当发生hash冲突的时候，会将数据存入链表后面；当hash冲突量比较大的时候，链表长度会比较长，导致查询比较慢，所有使用红黑树的形式。</p><p>如图2，static final int TREEIFY_THRESHOLD = 8;所以当链表长度大于8的时候，会将链表转换成红黑树存储，链表查询的复杂度是O(n)，红黑树时间复杂度变成了O（n/2），所以查询性能提升了许多。</p><p><strong>树化代码分析：</strong></p><div class=pgc-img><img alt=程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/933ec535508a4b3e8284e83dff506dea><p class=pgc-img-caption>树化代码</p></div><pre>fnal void treeifyBin(Node&lt;K,V&gt;[] tab, int hash) {int n, index; Node&lt;K,V&gt; e;if (tab == null || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)resize();else if ((e = tab[index = (n - 1) &amp; hash]) != null) {//树化逻辑}}</pre><p>上面是的 treeifyBin（）方法示意，可以理解为，当 bin 的数量大于 TREEIFY_THRESHOLD 时：</p><p>*如果容量小于MIN_TREEIFY_CAPACITY，只会进行简单的扩容。</p><p>*如果容量大于MIN_TREEIFY_CAPACITY ，则会进行树化改造。</p><p><strong>性能疑问</strong></p><p>可能会有人疑问，维护红黑树需要性能的，这样会不会性能反而下降了。我个人理解发生大量冲突后更新数据的频率是小于查询数据的频率的，而且链表插入一条新数据和红黑树插入一条新数据时间差距就是可能需要重新维护红黑树结构上，综合下来就可以JDK1.8用红黑树性能确实提升不少。</p><div class=pgc-img><img alt=程序员练级之路，高薪程序员必会知识，Hash冲突，树化是什么意思 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/eb92e4eb51574226a5150093f8c98f29><p class=pgc-img-caption>Map结构图，来源杨晓峰</p></div><h1>线程安全</h1><p>HashMap不支持线程的同步，即任一时刻可以有多个线程同时写HashMap都可能会导致数据的不一致或出现其他错误。</p><p><strong>使用建议：</strong></p><p>如果需要同步使用ConcurrentHashMap类，相较于HashTable锁住的是对象整体， ConcurrentHashMap基于lock实现锁分段技术。ConcurrentHashMap不仅保证了多线程运行环境下的数据访问安全性，而且性能上有长足的提升。</p><p><strong>最后疑问：</strong></p><p>我们都HashMap不是线程安全的，所以你有想过会在哪些情况不安全吗？</p><p>如：HashMap需要扩容，多个线程在这个时候同时操作会导致意想不到情况，可能会导致数据丢失，数据错误。</p><p>你还能想到其他不安全场景吗？欢迎在下发评论和大家一起分享！</p><blockquote><p>还会继续更新Java相关技术文章哦，欢迎围观哦！</p><p>作者：喵小北vlog</p><p>文章参考内容：</p><p>通读了大约20余篇网上相关HashMap博客文章；</p><p>JDK1.8_Api</p><p>Oracle 杨晓峰java核心36讲</p><p>JDK1.8源代码</p><p>JAVA编程思想</p></blockquote></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'程序','员练级','必会'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>