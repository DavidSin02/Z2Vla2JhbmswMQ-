<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Spring Cloud项目OAuth2授权验证终极必杀技 | 极客快訊</title><meta property="og:title" content="Spring Cloud项目OAuth2授权验证终极必杀技 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/01da8a903ea945018f0c19ed201e0382"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6bc6579d.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6bc6579d.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6bc6579d.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6bc6579d.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6bc6579d.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6bc6579d.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6bc6579d.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6bc6579d.html><meta property="article:published_time" content="2020-10-29T21:10:35+08:00"><meta property="article:modified_time" content="2020-10-29T21:10:35+08:00"><meta name=Keywords content><meta name=description content="Spring Cloud项目OAuth2授权验证终极必杀技"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/6bc6579d.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Spring Cloud项目OAuth2授权验证终极必杀技</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><strong>Spring Cloud项目OAuth2授权验证终极必杀技</strong></p><h2 class=pgc-h-arrow-right>一、OAuth2兴起背景</h2><p>OAuth2是一种授权验证获取用户信息的标准，在传统的用户认证体系中，想要获取用户信息必须通过输入用户名和密码，不是很安全。必须记录登录的Session会话状态，十分不利。</p><p>(图片)</p><p>那么有没有一种标准，无需记录登录Session状态，就能获取用户信息呢？最早的思路是基于Spring Session,利用Redis存储Session，客户端请求只需要在Header中携带特定的header，后端服务端就能获取用户信息。</p><p>随着技术的进一步升级，JWT大行其道，JWT确实有自身的优势，加盐加密用户信息，Token中采用相同解密算法就能获取到用户信息，还能控制有效期，很好的解决了用户认证的需求。应该说，通过这一步，已经能够满足绝大多数企业的用户需求了。</p><p>(JWT图片)</p><p>虽然，JWT已经能满足用户的处理逻辑需求。那么，有没有更好的方式更安全的方式进行权限验证呢？Spring Security OAuth2标准横空出世，基于OAuth2，提供了更安全的方式进行验证拦截，getCodeToken也很方便，指定的标准去做就可以了。</p><p>除此之外，OAuth2还可以扩展登录认证方式，邮箱登录、验证码登录、扫码登录都可以集成扩展。还支持前后端分离的Token认证方式，十分便捷，因此被更多的公司关注采用。</p><h2 class=pgc-h-arrow-right>二、邂逅OAuth2</h2><p>笔者曾经在一家互联网公司就职，当时要扩展微信公众号的功能。参与微信公众号的开发，当时就接触了微信的身份认证方式。当时觉得很复杂，要授权，还要设置回调跳转地址，看API看的不是很明白，差点想放弃。</p><p>第一次设置回调地址，再加上前端需要编写getCodeToken,终于成功拿到微信端Token，实现相关功能。</p><p>第一次接触微信是基于OAuth2标准实现登录授权，虽然不懂原理，但还是在参考了大量资料的情况下完成了任务，算是有所成就。</p><h2 class=pgc-h-arrow-right>三、完成Spring Cloud+OAuth2工程的搭建</h2><p>搭建Spring Cloud工程，引入Spring Cloud依赖仓库座标</p><p></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/01da8a903ea945018f0c19ed201e0382><p class=pgc-img-caption></p></div><p><br></p><p>指定了Spring Cloud项目的基本依赖</p><p>在Pom.xml文件，引入需要的配置及工具</p><p></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/84f7ab3460c64963a4ff77510d3332e5><p class=pgc-img-caption></p></div><p><br></p><p>在子工程，构建Spring Boot Web工程:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/efdbef5a6be44b8c88699cb95a62ecf6><p class=pgc-img-caption></p></div><p><br></p><p>引入<strong>OAuth2</strong>的<strong>核心依赖</strong>:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b0ebe78a991c4b7a80580a9c0074cfdb><p class=pgc-img-caption></p></div><p><br></p><p>引入Redis作为Token的存储介质:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/21f3fd21bc4c4455a97f24fce02e776d><p class=pgc-img-caption></p></div><p><br></p><p>引入MySQL作为客户端登录需要的配置密钥:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0d92f946b90e4794b86b3261dec6e423><p class=pgc-img-caption></p></div><p><br></p><p>引入JDBC:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/72e6ea8473334da1b57bd7757899753f><p class=pgc-img-caption></p></div><p><br></p><p>引入Swagger:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d1c41406a0564528bb905e007fb4ac98><p class=pgc-img-caption></p></div><p><br></p><p>引入前端组件:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f129af5c395c47b3b8a43c43d97683b4><p class=pgc-img-caption></p></div><p><br></p><p>至此，工程构建完毕!</p><h2 class=pgc-h-arrow-right>四、主工程模块介绍</h2><p>打开application.yml，配置客户端登录标识:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/37f883df54ba4b1485ebd035e537bcfc><p class=pgc-img-caption></p></div><p><br></p><p>主工程结果返回实体:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/31fe0becbf704bdab0aacb1b3669278a><p class=pgc-img-caption></p></div><p><br></p><p>指定用户实体类，Spring Security用户类:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fb53f79d4c764d2690d2d6dc66a61535><p class=pgc-img-caption></p></div><p><br></p><p>配置客户端属性工具:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/67162dc606834d18acb8899c891e0785><p class=pgc-img-caption></p></div><p><br></p><p>配置客户端密钥:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ef6524269b104d6586e36b787c756d43><p class=pgc-img-caption></p></div><p><br></p><p>指定授权码模式登录之后的页面:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c55ca7ee45464bd4ad8d5fe4a9118f02><p class=pgc-img-caption></p></div><p><br></p><p>指定OAuth2配置验证实体类:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4b334354420d4562853494a58420f73e><p class=pgc-img-caption></p></div><p><br></p><p>指定授权码登录跳转的处理页面:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/586685c0dffe45c9a3001002dc0557fc><p class=pgc-img-caption></p></div><p><br></p><p>指定授权确认页面:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7803f83c98aa425480e5d8c4d3d625f6><p class=pgc-img-caption></p></div><p><br></p><p>指定用户验证实体UserDetailService:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/58f99078a4014bdcad6a89702b23d7e6><p class=pgc-img-caption></p></div><p><br></p><p>其中loadUserByUsername为验证用户的工具:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1de1ed64d35d4bf687b5cfe600058069><p class=pgc-img-caption></p></div><p><br></p><p>找出用户实体</p><h3 class=pgc-h-arrow-right>4.1 OAuth2核心处理工具</h3><p>设置允许的请求方式:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/840280680c464c17bdba36678e85ff79><p class=pgc-img-caption></p></div><p><br></p><p>指定认证服务器:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4352ec6eeaeb49e3a32fe5fc3165a80b><p class=pgc-img-caption></p></div><p><br></p><p>设置允许的安全认证方式:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a3fa171083644f45b14f6b93c2628c52><p class=pgc-img-caption></p></div><p><br></p><p>设置认证方式及支持的Token存储时间:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/80ca1e9c6fc54257b69880ba574d8ea0><p class=pgc-img-caption></p></div><p><br></p><p>设置令牌处理服务器:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cc430c7e131c452481db2184143d3428><p class=pgc-img-caption></p></div><p><br></p><p>指定WebSecurity的处理逻辑:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a4d55b49e3f841f38914f4bd5687f48c><p class=pgc-img-caption></p></div><p><br></p><p>指定登录页及Token请求地址:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e43e7323d01d447aa697b9e441986c46><p class=pgc-img-caption></p></div><p><br></p><h2 class=pgc-h-arrow-right>五、运行代码看效果</h2><h3 class=pgc-h-arrow-right>5.1密码模式登录</h3><p>打开PostMan输入地址:</p><p>http://localhost:4761/token/getToken</p><p>输入用户用户名密码:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/af354a8f884244e1b806aae618f44b0b><p class=pgc-img-caption></p></div><p><br></p><p>指定了授权类型为密码模式</p><p>返回结果:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5d04bec330c3428a973c41ad126f8dd0><p class=pgc-img-caption></p></div><p><br></p><p>用户名密码模式验证成功</p><h3 class=pgc-h-arrow-right>5.2Refresh Token模式</h3><p>将步骤一里面的返回参数refresh_token取出来作为入参，修改登录模式为刷新模式</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1ebe357b0df143c5b8a44387f8bc12a1><p class=pgc-img-caption></p></div><p><br></p><p>依然是调用</p><p>http://localhost:4761/token/getToken</p><p>返回结果:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/580ce9552fcc44829ec1f5126984bc14><p class=pgc-img-caption></p></div><p><br></p><h3 class=pgc-h-arrow-right>5.3授权码模式</h3><p><br></p><p>打开网页浏览器:</p><p>http://127.0.0.1:4761/oauth/authorize?response_type=code&client_id=liyue&redirect_uri=http://localhost:9080/sso1/login&state=test&scope=server</p><p>返回结果进入统一认证中心:</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fa3ac11dc8dc40239ba1a9cd5750c4ef><p class=pgc-img-caption></p></div><p><br></p><p>输入账号:admin/123456</p><p>链接中拿到了code</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/30ff778e24444041b37faddbdf96f953><p class=pgc-img-caption></p></div><p><br></p><p>用PostMan请求GET获取getCodeToken的接口:</p><p>http://127.0.0.1:4761/oauth/token?grant_type=authorization_code&client_id=liyue&client_secret=123456&redirect_uri=http://localhost:9080/sso1/login&code=5QwpoR&scope=server</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0e71a00ce7394e94abf2fc527f2e7ed2><p class=pgc-img-caption></p></div><p><br></p><p>返回结果拿到了Token</p><h3 class=pgc-h-arrow-right>5.4客户端模式登录</h3><p>打开PostMan选用Post方式,url:</p><p>http://127.0.0.1:4761/oauth/token</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/72a75cd23af74475bb9c5dbcd3326bd7><p class=pgc-img-caption></p></div><p><br></p><p>返回结果</p><p><br></p><div class=pgc-img><img alt="Spring Cloud项目OAuth2授权验证终极必杀技" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/915e46c0a4d54daba5cde17d5723a086><p class=pgc-img-caption></p></div><p><br></p><p>客户端模式登录演示完毕</p><h2 class=pgc-h-arrow-right>六、总结</h2><p><br></p><p>OAuth2登录认证方式还有很多，大家可以自己去了解</p><p><br></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Spring','Cloud','项目'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>