<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>TCP协议总结 | 极客快訊</title><meta property="og:title" content="TCP协议总结 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/153156590409218ee54748f"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6ca6ff7.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6ca6ff7.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6ca6ff7.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6ca6ff7.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6ca6ff7.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6ca6ff7.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6ca6ff7.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6ca6ff7.html><meta property="article:published_time" content="2020-10-29T20:50:29+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:29+08:00"><meta name=Keywords content><meta name=description content="TCP协议总结"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/6ca6ff7.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>TCP协议总结</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>我们大家都知道在TCP IP的网络模型中，也被人叫做DoD(Department of Defense)模型，TCP/IP简化了OSI的七层网络模型为四层，由下而上分别为：网络接口层，网际层，传输层和应用层。这篇文章要讲的就是传输层的TCP协议。TCP特点：基于字节流，面向连接，可靠传输，缓冲传输，全双工，流量控制。</p><p>本文目录如下：</p><p>1).TCP协议简介</p><p>2).TCP报文的格式</p><p>3).TCP的次握手三建立连接和挥手四次移除链接</p><p>4).TCP经常看到的状态</p><p>5).TCP常见计时器</p><h1><strong>一.TCP协议简介</strong></h1><p>TCP是TCP/IP协议栈中的传输层的协议，TCP协议又叫传输控制协议(Transport Control Protocal)，是面向连接的，可靠的字节流服务。它的可靠性体现在：1，滑动窗口机制；2，3次握手建立连接；3，一定的拥塞避免算法；4，流量控制；5，以及一定的超时重传机制。本文不介绍实现原理。</p><p>首先我们要学习TCP协议，首先当然要了解TCP报文的报文格式，下面就是TCP的报文格式，以及各个字段的意思</p><div class=pgc-img><img alt=TCP协议总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/153156590409218ee54748f><p class=pgc-img-caption></p></div><p>1).<strong>16位的源端口号和目的端口号</strong>，我们知道端口号就是标识特定主机上的唯一的进程，而IP地址是来表示标识网络中的不同主机的，这两个源（source）和目的（dst）端口号和IP首部中的源和目的IP地址，则标识互联网上的唯一进程，所以套接字的定义说白了就是IP地址和端口号共同组成。</p><p>2).<strong>32位的确认序号</strong>，上一个字段的序号是对数据的编号，所以确认序号是下一个期望接收的TCP分段号，相当于是对对方所发送的并且已经被本方所正确接受的分段的确认。仅当ACK标志为1时有效。确认号表示期望收到的下一个字节的序号。</p><p>3).<strong>32位的序号</strong>，表示在这个报文段中的第一个数据字节序号。如果将字节流看作在两个应用程序间的单向流动，则TCP用序列号对每个字节进行计数。用来保证到达数据顺序的编号，所以这个字段需要比较大的存储。</p><p>4).<strong>4位的报头长度</strong>，以32位（4字节）字长为单位，需要这个值是因为任选字段的长度是可变的。跟IP头部一样，以4字节为单位。最大是60个字节。不存在任选字段正常的报头长度是20字节。其实相当于给出数据在数据段中的开始位置。</p><p>5).<strong>保留位</strong>，6位，必须为0</p><p>6).<strong>标志位</strong>，占有6个比特位，他们中可以有多个为置为1，依次为：<strong>URG，ACK，PSH，RST，SYN，FIN</strong>。</p><p>下面具体分析：</p><p><strong>URG：</strong>该位为1说明表示TCP包的紧急指针域有效，用来保证TCP连接不被中断，并督促上层应用敢快处理这些数据。</p><p><strong>ACK：</strong>确认号有效</p><p><strong>PSH：</strong>接收方应尽快将这个报文交给应用层，叫做push。所谓Push操作就是指在数据包到达接收端以后，立即传送给应用程序，而不是在缓冲区中排队。</p><p><strong>RST：</strong>连接复位，复位因主机奔溃或其他原因而出现的错误连接，也可以用于拒绝非法的分段或拒绝连接请求，这个用处还是比较多的</p><p><strong>SYN：</strong>是一个同步序号，通常与ACK合用用来建立连接。也就是常说的三次握手</p><p><strong>FIN：</strong>既然有建立连接那么必然有拆除连接，这个字段表示发送端已经达到数据末尾，也就是说双方的数据传送完成，没有数据可以传送了，发送FIN标志位的TCP数据包后，连接将被断开。这个标志的数据包也经常被用于进行端口扫描。</p><p>看到上面，有些人就会有些疑问，URG和PSH都是紧急时使用，那么这两个有什么关系和区别呢？</p><p><strong>答：</strong>在一般的数据中都会存在PSH，而URG只有在紧急情况下才会触发TCP报文中的紧急指针字段，那么到底什么样的情况才是紧急情况呢？ 紧急方式是向对方发送紧急数据的一种方式，表示数据需要优先处理。它是一个正的偏移，与TCP首部中序号字段的值相加表示紧急数据后面的字节，紧急指针是数据最后一个字节，TCP首部中只有紧急指针指出紧急数据的位置，它所指的字节为紧急数据，但没有办法指定紧急数据的长度。</p><p>7).<strong>紧急指针，</strong> 只有当URG标志置1时紧急指针才有效。紧急指针是一个正的偏移量，和序号字段中的值相加表示紧急数据最后一个字节的序号。TCP的紧急方式是发送端向另一端发送紧急数据的一种方式。</p><p>8).<strong>窗口大小，</strong>TCP的流量控制由连接的每一端通过声明的窗口大小来提供。窗口大小为字节数，起始于确认序号字段指明的值，这个值是接收端正期望接收的字节。这是一个16 bit字段，因而窗口大小最大为<strong>65535</strong>字节。</p><p>9).<strong>校验和</strong>，用于对分段首部和数据进行校验。正常情况下为一定为0</p><h1>二，TCP如何保证数据的可靠性呢?</h1><p>a ) 首先，应用数据被分割成TCP认为最合适发送的数据块。称为段（Segment）传递给IP层。这个第一个步骤。</p><p>b）当TCP发出一个段后，它会启动一个定时器，等待目的端确认收到这个报文段。若没有及时收到确认，将重发送这个报文段。</p><p>c）当TCP收到发自TCP连接另一端的数据，它将发送一个确认。这个确认不是立即发送的，通常将推迟几分之一秒。</p><p>d）TCP将保持它首部和数据的校验和，这是一个端到端的校验和，目的是检测数据在传输过程中的任何变化。如果收到段的校验和有差错，TCP将丢弃这个报文也不进行确认（对方就会重复发送了）。</p><p>e）TCP承载与IP数据报来传输，而IP数据报可能会失序，因为中间的路由过程可能路线不一致，到达的时间也会有长短，所以TCP的报文段到达时也可能会失序。但是TCP收到数据后会重新排序到正确的顺序（通过序号）。</p><p>f）IP数据报会重复报，TCP的接收端会丢弃这些重复包。</p><p>g）TCP还能提供流量控制，TCP连接的双方都是有一定大小的存储空间</p><h1>三，滑动窗口协议的理解</h1><p>TCP滑动窗口技术通过动态改变窗口大小来调节两台主机间数据传输。每个TCP/IP主机支持全双工数据传输，因此TCP有两个滑动窗口：一个用于接收数据，另一个用于发送数据。TCP使用肯定确认技术，其确认号指的是下一个所期待的字节。<strong> </strong>假定发送方设备以每一次三个数据包的方式发送数据，也就是说，窗口大小为3。发送方发送序列号为1、2、3的三个数据包，接收方设备成功接收数据包，用序列号4确认。发送方设备收到确认，继续以窗口大小3发送数据。当接收方设备要求降低或者增大网络流量时，可以对窗口大小进行减小或者增加，本例降低窗口大小为2，每一次发送两个数据包。当接收方设备要求窗口大小为0，表明接收方已经接收了全部数据，或者接收方应用程序没有时间读取数据，要求暂停发送。发送方接收到携带窗口号为0的确认，停止这一方向的数据传输。</p><p>我们可以看下面一张图来分析一下固定窗口大小有什么问题。</p><div class=pgc-img><img alt=TCP协议总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153156899287632f8304a59><p class=pgc-img-caption></p></div><p>这里我们可以看到假设窗口的大小是1，也是就每次只能发送一个数据只有接受方对这个数据进行确认了以后才能发送第2个数据。我们可以看到发送方每发送一个数据接受方就要给发送方一个ACK对这个数据进行确认。只有接受到了这个确认数据以后发送方才能传输下个数据。 这样我们考虑一下如果说窗口过小，那么当传输比较大的数据的时候需要不停的对数据进行确认，这个时候就会造成很大的延迟。如果说窗口的大小定义的过大。我们假设发送方一次发送100个数据。但是接收方只能处理50个数据。这样每次都会只对这50个数据进行确认。发送方下一次还是发送100个数据，但是接受方还是只能处理50个数据。这样就避免了不必要的数据来拥塞我们的链路。所以我们就引入了滑动窗口机制，窗口的大小并不是固定的而是根据我们之间的链路的带宽的大小，这个时候链路是否拥护塞。接受方是否能处理这么多数据了。</p><p>我们看看滑动窗口是如何工作的。我们看下面几张图。</p><div class=pgc-img><img alt=TCP协议总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1531568993293bfc2529324><p class=pgc-img-caption></p></div><p>首先是<strong>第一次发送数据这个时候的窗口大小是根据链路带宽的大小来决定的</strong>。我们假设这个时候窗口的大小是3。这个时候接受方收到数据以后会对数据进行确认告诉发送方我下次希望手到的是数据是多少。这里我们看到<strong>接收方发送的ACK=3(这是发送方发送序列2的回答确认，下一次接收方期望接收到的是3序列信号)</strong>。这个时候发送方收到这个数据以后就知道我第一次发送的3个数据对方<strong>只收到了2个</strong>。就知道第3个数据对方没有收到。下次在发送的时候就从第3个数据开始发。这个时候<strong>窗口大小就变成了2 </strong>。</p><div class=pgc-img><img alt=TCP协议总结 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/15315689929908f046386f7><p class=pgc-img-caption></p></div><p>这个时候发送方发送2个数据。</p><div class=pgc-img><img alt=TCP协议总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15315689932202839da0ec7><p class=pgc-img-caption></p></div><p>看到接收方发送的ACK是5就表示他下一次希望收到的数据是5，发送方就知道我刚才发送的2个数据对方收了这个时候开始发送第5个数据。</p><p>这就是滑动窗口的工作机制，当链路变好了或者变差了这个窗口还会发生变话，并不是第一次协商好了以后就永远不变了。</p><p>滑动窗口协议</p><p>滑动窗口协议，是TCP使用的一种流量控制方法。该协议允许发送方在停止并等待确认前可以连续发送多个分组。由于发送方不必每发一个分组就停下来等待确认，因此该协议可以加速数据的传输。</p><p>只有在接收窗口向前滑动时（与此同时也发送了确认），发送窗口才有可能向前滑动。</p><p>收发两端的窗口按照以上规律不断地向前滑动，因此这种协议又称为滑动窗口协议。</p><p>当发送窗口和接收窗口的大小都等于1时，就是停止等待协议。</p><h1>四，Ack的理解</h1><p>ack表示期望下次接收到的序号。</p><p>那么ack是如何算出来的呢，就是通过收到的序号，和数据长度相加得来。</p><p>假设A收到B过来的数据（seq = 5，len = 15）。len表示数据长度。</p><p>那么A就会回复B，“刚才的数据我已经收到了，你接下来就发序号为20的包给我吧”。这样就保证了数据不会乱序。</p><p>综上，确认号就是下一次将要收到包的序号。同时也等于发送方的序号+数据长度（确认号在ACK标志位有效时才有用。)</p><h1>喜欢我的文章的话，就关注我吧！不要只收藏和转发哦，每天至少两篇编程知识给大家，都是本人多年的总结！</h1></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'TCP','协议','总结'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>