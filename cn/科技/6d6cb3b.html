<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>自动化搭建微型linux系统ftp服务器 | 极客快訊</title><meta property="og:title" content="自动化搭建微型linux系统ftp服务器 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/19488a5f7b8446ab94cedd3303c0f7d4"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6d6cb3b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6d6cb3b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6d6cb3b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6d6cb3b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6d6cb3b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6d6cb3b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6d6cb3b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6d6cb3b.html><meta property="article:published_time" content="2020-10-29T20:58:46+08:00"><meta property="article:modified_time" content="2020-10-29T20:58:46+08:00"><meta name=Keywords content><meta name=description content="自动化搭建微型linux系统ftp服务器"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/6d6cb3b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>自动化搭建微型linux系统ftp服务器</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><div class=pgc-img><img alt=自动化搭建微型linux系统ftp服务器 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/19488a5f7b8446ab94cedd3303c0f7d4><p class=pgc-img-caption></p></div><p>一、构思</p><p>在这里我们是通过在一台拥有两个盘的linux上运行自动化脚本(一个系统所在盘sda,一个空盘sdb),在其系统所在盘创建一个类linux根目录,和boot目录,并通过母linux系统,将其所需的grub,软件,服务等复制过去,然后将它挂载到sdb,最后新建一个linux用母系统的sdb盘作为系统盘.</p><p>二、所需文件</p><div class=pgc-img><img alt=自动化搭建微型linux系统ftp服务器 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/df8d3d20530640f1b131b52dd9539acf><p class=pgc-img-caption></p></div><p>我的自动化脚本main.sh;另外我实现了用户登录验证,这里我是直接把login这个单独弄了出来,方便复制;还有一个名叫txt的文件,这里他是记录我们所需的命令,例如ls等,如果有其他需要可以在这里面继续添加,防止在给微型linux系统加命令是有不必要的麻烦</p><p>四、建立微型linux系统</p><p>将上述已经做好的盘,放到准备建立的新的linux系统下</p><p>启动服务/usr/local/sbin/vsftpd /etc/vsftpd/vsftpd.conf</p><div class=pgc-img><img alt=自动化搭建微型linux系统ftp服务器 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/70687b9bcd91405aaabf735c9f5dd007><p class=pgc-img-caption></p></div><p>main.sh</p><p>#!/bin/bash</p><p>#</p><p>alias rm=rm</p><p>SYSROOT=/mnt/sysroot</p><p>BOOT=/mnt/boot</p><p>read -p "please input which dev you want to run :" WHDEV</p><p>umountall()</p><p>{</p><p>for PART in `fdisk -l $1 | grep -o "^${1}[0-9]\{1,\}"`;do</p><p>fuser -km $PART &> /dev/null</p><p>umount $PART</p><p>done</p><p>}</p><p>umountall $WHDEV</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>fdinput()</p><p>{</p><p>read -p "would you want to do this :y/n" PANDUAN</p><p>if [ "$PANDUAN" = "y" ];then</p><p>dd if=/dev/zero of=$1 bs=512 count=1 &> /dev/null</p><p>sync</p><p>sync</p><p>sync</p><p>sync</p><p>sync</p><p>sleep 20</p><p>sync</p><p>sync</p><p>sync</p><p>sync</p><p>sync</p><p>[ $? -eq 0 ] || return 67</p><p>echo '</p><p>n</p><p>p</p><p>1</p><p>+100M</p><p>n</p><p>p</p><p>2</p><p>+1G</p><p>n</p><p>p</p><p>3</p><p>+128M</p><p>t</p><p>3</p><p>82</p><p>w ' | fdisk $1 &> /dev/null</p><p>[ $? -eq 0 ] || return 68</p><p>sync</p><p>partprobe $1</p><p>sync</p><p>echo "please wait 5 seconds"</p><p>sync</p><p>sync</p><p>sleep 5</p><p>sync</p><p>sync</p><p>mkfs -t ext3 ${1}1</p><p>[ $? -eq 0 ] || return 69</p><p>mkfs -t ext3 ${1}2</p><p>[ $? -eq 0 ] || return 69</p><p>mkswap ${1}3</p><p>[ $? -eq 0 ] || return 69</p><p>return 0</p><p>else</p><p>exit</p><p>fi</p><p>}</p><p>fdinput $WHDEV</p><p>case $? in</p><p>67)</p><p>echo "qingkong dev failed"</p><p>;;</p><p>68)</p><p>echo "create main dev failed"</p><p>;;</p><p>69)</p><p>echo "mkfs dev failed"</p><p>;;</p><p>0)</p><p>echo "successful"</p><p>;;</p><p>*)</p><p>echo "unknow fault"</p><p>;;</p><p>esac</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>mountall()</p><p>{</p><p>[ -d $BOOT ] || mkdir -p $BOOT</p><p>[ -d $SYSROOT ] || mkdir -p $SYSROOT</p><p>mount ${1}1 $BOOT</p><p>mount ${1}2 $SYSROOT</p><p>}</p><p>mountall $WHDEV</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>installgrub()</p><p>{</p><p>grub-install --root-directory=/mnt /dev/sdb $1 &> /dev/null</p><p>}</p><p>installgrub $WHDEV</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>mkrootfs()</p><p>{</p><p>mkdir -p $SYSROOT/{proc,boot,sys,dev,tmp,lib,bin,sbin,root,home.opt,mnt,media,misc}</p><p>mkdir -p $SYSROOT/usr/{share/{man,doc},bin,sbin,local/sbin,src,lib}</p><p>mkdir -p $SYSROOT/etc/{rc.d,sysconfig}</p><p>mkdir -p $SYSROOT/var/{lock,tmp,spool,run,log}</p><p>}</p><p>mkrootfs</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>bcp()</p><p>{</p><p>COMMAND=`which $1 | grep -o "/.*"`</p><p>CMDPATH=${COMMAND%/*}</p><p>[ -d $SYSROOT$CMDPATH ] || mkdir -p $SYSROOT$CMDPATHI</p><p>[ -e $SYSROOT$COMMAND ] || cp $COMMAND $SYSROOT$CMDPATH</p><p>for LIB in `ldd $COMMAND | grep -o "/.*lib[^[:space:]]*"`;do</p><p>LIBPATH=${LIB%/*}</p><p>[ -d $SYSROOT$LIBPATH ] || mkdir -p $SYSROOT$LIBPATH</p><p>[ -e $SYSROOT$LIB ] || cp $LIB $SYSROOT$LIBPATH</p><p>done</p><p>}</p><p>for COMD in `cat txt`;do</p><p>case $COMD in</p><p>q|Q)</p><p>break</p><p>;;</p><p>*)</p><p>! which $COMD &> /dev/null && echo "wrond command ,please input again." && continue</p><p>bcp $COMD</p><p>;;</p><p>esac</p><p>done</p><p>#copy kernel</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>cpker()</p><p>{</p><p>cp /boot/vmlinuz-2.6.18-308.el5 $BOOT/vmlinuz</p><p>cd /tmp</p><p>mkdir myroot</p><p>cd myroot/</p><p>zcat /boot/initrd-2.6.18-308.el5.img | cpio -id</p><p>sed -i '93,97d' init</p><p>sed -i 's@/dev/vo10/root@/dev/sda2@' init</p><p>find . | cpio -o -H newc --quiet | gzip -9 > $BOOT/initrd.gz</p><p>cd /tmp</p><p>rm -r myroot/</p><p>}</p><p>cpker</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>#conf</p><p>cconf()</p><p>{</p><p>cd $BOOT</p><p>cd grub</p><p>touch grub.conf</p><p>echo "</p><p>default=0</p><p>timeout=3</p><p>title MY Linux</p><p>root (hd0,0)</p><p>kernel /vmlinuz ro root=/dev/sda2 quiet</p><p>initrd /initrd.gz</p><p>" > grub.conf</p><p>sync</p><p>sync</p><p>sync</p><p>cd $SYSROOT/bin</p><p>ln -s bash sh</p><p>cd $SYSROOT</p><p>cd etc/</p><p>touch inittab</p><p>echo "</p><p>id:3:initdefault:</p><p>si::sysinit:/etc/rc.d/rc.sysinit</p><p>l0:0:wait:/etc/rc.d/rc.sysdone</p><p>l1:1:wait:/sbin/init -t 1 S</p><p>1:2345:respawn:/sbin/mingetty tty1</p><p>2:2345:respawn:/sbin/mingetty tty2</p><p>" > inittab</p><p>sync</p><p>sync</p><p>touch rc.d/rc.sysinit</p><p>chmod +x rc.d/rc.sysinit</p><p>echo "</p><p>#!/bin/bash</p><p>#</p><p>echo -e "\twelcome to \033[31mMY\033[0m Linux"</p><p>#set hostname</p><p>[ -f /etc/sysconfig/network ] && source /etc/sysconfig/network</p><p>if [ -z $HOSTNAME -o $HOSTNAME='(none)' ];then</p><p>/bin/hostname localhost</p><p>else</p><p>/bin/hostname $HOSTNAME</p><p>fi</p><p>if [ $? -eq 0 ];then</p><p>echo -n "Set the hostname"</p><p>echo -e "\033[60G[ \033[32mOK\033[0m ]"</p><p>fi</p><p>#initial net device</p><p>/sbin/insmod /lib/modules/mii.ko &> /dev/null</p><p>/sbin/insmod /lib/modules/pcnet32.ko &> /dev/null</p><p>if [ $? -eq 0 ];then</p><p>echo -n "Initial nercard driver"</p><p>echo -e "\033[60G[ \033[32mOK\033[0m ]"</p><p>fi</p><p>#set kernel para</p><p>/sbin/sysctl -p &>/dev/null</p><p>#remount rootfs</p><p>/bin/mount -n -o remount,rw /dev/sda2 / &> /dev/null</p><p>if [ $? -eq 0 ];then</p><p>echo -n "Rmount rootfs"</p><p>echo -e "\033[60G[ \033[32mOK\033[0m ]"</p><p>fi</p><p># Set IPADDR</p><p>/sbin/ifconfig lo 127.0.0.1/8 &> /dev/null</p><p>/sbin/ifconfig eth0 172.16.128.1/16 &> /dev/null</p><p>if [ $? -eq 0 ];then</p><p>echo -n "Set IPADDR"</p><p>echo -e "\033[60G[ \033[32mOK\033[0m ]"</p><p>fi</p><p>" > rc.d/rc.sysinit</p><p>touch rc.d/rc.sysdone</p><p>chmod +x rc.d/rc.sysdone</p><p>echo "</p><p>#!/bin/bash</p><p>#</p><p>exec /sbin/halt -p</p><p>" > rc.d/rc.sysdone</p><p>touch sysconfig/network</p><p>echo "</p><p>HOSTNAME=qinqin</p><p>" > sysconfig/network</p><p>}</p><p>cconf</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>#copy modules lib</p><p>cpmo()</p><p>{</p><p>CPGREP=`modinfo $1 | grep "filename"`</p><p>CPCOM=/${CPGREP#*/}</p><p>CPMPATH=${CPCOM%/*}</p><p>[ -d $SYSROOT$CPMPATH ] || mkdir -p $SYSROOT$CPMPATH</p><p>[ -e $SYSROOT$CPCOM ] || cp $COMMAND $SYSROOT$CPCOM</p><p>}</p><p>while true;do</p><p>read -p "please input the modules which you want to copy the lib:" CPMODU</p><p>case $CPMODU in</p><p>q|Q)</p><p>echo "the system will be exit"</p><p>break</p><p>;;</p><p>*)</p><p>modinfo $CPMODU &> /dev/null || echo "wrong words ."</p><p>cpmo $CPMODU</p><p>;;</p><p>esac</p><p>done</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>####</p><p>cd /mnt/sysroot</p><p>find . | cpio -o -H newc --quiet | gzip > /root/sysroot.1</p><p>touch /etc/profile</p><p>echo "</p><p>#!/bin/bash</p><p>#</p><p>export PS1='\[\u@\h\W\]\$'</p><p>" > /etc/profile</p><p>cd</p><p>#login</p><p>cp login /mnt/sysroot/bin/</p><p>chmod +x /mnt/sysroot/bin/login</p><p>cp -d /lib/libnss_* $SYSROOT/lib/</p><p>cp -d /usr/lib/libnss* $SYSROOT/usr/lib/</p><p>cp /etc/nsswitch.conf $SYSROOT/etc/</p><p>sed -i '39,$d' $SYSROOT/etc/nsswitch.conf</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>cp -p /etc/passwd /etc/shadow /etc/group $SYSROOT/etc/</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>tar xf vsftpd-2.3.5.tar.gz</p><p>cd vsftpd-2.3.5</p><p>sed -i 's/#define VSF_BUILD_PAM/#undef VSF_BUILD_PAM/g' builddefs.h</p><p>make</p><p>make install</p><p>sync</p><p>sleep 2</p><p>sync</p><p>cd</p><p>bcp vsftpd</p><p>mkdir $SYSROOT/usr/share/empty</p><p>mkdir $SYSROOT/etc/vsftpd</p><p>chmod 555 $SYSROOT/usr/share/empty</p><p>mkdir -pv $SYSROOT/var/ftp/pub</p><p>cd vsftpd-2.3.5</p><p>cp vsftpd.conf $SYSROOT/etc/vsftpd</p><p>sync</p><p>sync</p><p>sleep 2</p><p>sync</p><p>sync</p><p>cd</p><p>rm -r vsftpd-2.3.5</p><p>txt</p><p>mingetty</p><p>sync</p><p>sleep</p><p>reboot</p><p>init</p><p>bash</p><p>ifconfig</p><p>halt</p><p>hostname</p><p>netstat</p><p>ping</p><p>mkdir</p><p>mount</p><p>netstat</p><p>umount</p><p>vim</p><p>cat</p><p>touch</p><p>ls</p><p>rm</p><p>insmod</p><p>ps</p><p>kill</p><p>killall</p><p>chmod</p><p>cp</p><p>mv</p><p>grep</p><p>passwd</p><p>sysctl</p><p>q</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'自动化','linux','系统'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>