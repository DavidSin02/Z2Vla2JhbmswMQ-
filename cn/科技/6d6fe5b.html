<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一个因CA根证书过期引起的故障...... | 极客快訊</title><meta property="og:title" content="一个因CA根证书过期引起的故障...... - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6d6fe5b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6d6fe5b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6d6fe5b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6d6fe5b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6d6fe5b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6d6fe5b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6d6fe5b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6d6fe5b.html><meta property="article:published_time" content="2020-10-29T21:04:13+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:13+08:00"><meta name=Keywords content><meta name=description content="一个因CA根证书过期引起的故障......"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/6d6fe5b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一个因CA根证书过期引起的故障......</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>服务器上的应用服务对外发送的一些https请求都失败了，真相竟然是。。。</p><h3 class=pgc-h-arrow-right>问题</h3><p>10点左右，同事反馈咨询线上的Sentry服务器现在是否正常。之后去检查Sentry服务，运行正常，但是该应用服务对接的Sentry频道已经很久没有事件进来了。</p><p>感觉不太对劲，再去检查下Sentry worker专用的容器, 发现该Worker服务中中有些错误日志：</p><pre><code>E, [2020-06-01T04:02:03.670850 #6] ERROR -- sentry: ** [Raven] Unable to record event with remote Sentry server (Raven::Error - SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed (certificate has expired)):/usr/local/bundle/gems/sentry-raven-2.7.3/lib/raven/transports/http.rb:34:in `rescue in send_event&#39;/usr/local/bundle/gems/sentry-raven-2.7.3/lib/raven/transports/http.rb:16:in `send_event&#39;/usr/local/bundle/gems/sentry-raven-2.7.3/lib/raven/client.rb:37:in `send_event&#39;/usr/local/bundle/gems/sentry-raven-2.7.3/lib/raven/instance.rb:81:in `send_event&#39;/app/src/worker.rb:26:in `perform&#39;/usr/local/bundle/gems/sidekiq-5.1.3/lib/sidekiq/processor.rb:187:in `execute_job&#39;/usr/local/bundle/gems/sidekiq-5.1.3/lib/sidekiq/processor.rb:169:in `block (2 levels) in process&#39;/usr/local/bundle/gems/sidekiq-5.1.3/lib/sidekiq/middleware/chain.rb:128:in `block in invoke&#39;/usr/local/bundle/gems/sentry-raven-2.7.3/lib/raven/integrations/sidekiq.rb:9:in `call&#39;/usr/local/bundle/gems/sidekiq-5.1.3/lib/sidekiq/middleware/chain.rb:130:in `block in invoke&#39;/usr/local/bundle/gems/sidekiq-5.1.3/lib/sidekiq/middleware/chain.rb:133:in `invoke&#39;E, [2020-06-01T04:02:03.671130 #6] ERROR -- sentry: ** [Raven] Failed to submit event: &lt;no message value&gt;</code></pre><p>奇怪？sentry-worker在连sentry server 时请求域名的证书过期了？</p><h3 class=pgc-h-arrow-right>分析</h3><p>针对上面的错误信息，先去检查了相关调用的域名证书的有效期，发现都在有效期内。而且印象中都是年初刚更换的。所以排除了是域名证书问题。</p><p>然后根据错误日志，尝试在自己电脑上用下curl 命令,巧合的很，也遇到了类似的错误.</p><pre><code>$ curl https://sentry.xxx.comcurl: (60) SSL certificate problem: certificate has expiredMore details here: https://curl.haxx.se/docs/sslcerts.htmlcurl failed to verify the legitimacy of the server and therefore could notestablish a secure connection to it. To learn more about this situation andhow to fix it, please visit the web page mentioned above.</code></pre><p>我又去找了其它一台Centos主机，发现curl返回的结果是正常的，从web端和centos客户端curl都成功的看，像是我本机电脑的curl和sentry-worker主机出了问题。</p><p>之后用到网上找到使用openssl命令排查ssl错误的方法:</p><pre><code>$ openssl s_client -showcerts -servername sentry.xxx.com -connect sentry.xxx.com:443CONNECTED(00000003)depth=3 C = SE, O = AddTrust AB, OU = AddTrust External TTP Network, CN = AddTrust External CA Rootverify error:num=10:certificate has expirednotAfter=May 30 10:48:38 2020 GMT---Certificate chain 0 s:/OU=Domain Control Validated/OU=GoGetSSL Wildcard SSL/CN=*.xxx.com   i:/C=LV/L=Riga/O=GoGetSSL/CN=GoGetSSL RSA DV CA-----BEGIN CERTIFICATE-----#...省略</code></pre><p>从上面执行命令返回的内容来看，这里的CA证书AddTrust External CA Root 在<strong>May 30 10:48:38 2020 GMT</strong> 这个时间过期了。</p><p>上网查了下相关的资料，发现他们官方发过一篇通告：Sectigo-AddTrust-External-CA-Root-Expiring-May-30-2020.</p><h3 class=pgc-h-arrow-right>解决方案</h3><p>现在算是找到为什么请求https会出现证书过期的原因了。接下来看下如何解决：</p><ol start=1><li>修改服务器ca配置</li><li>更新ca库信息</li></ol><h4 class=pgc-h-arrow-right>主机（Ubuntu）</h4><h5 class=pgc-h-arrow-right>修改服务器CA配置</h5><p>修改服务器ca证书配置文件：/etc/ca-certificates.conf</p><pre><code>sed -i &#34;/AddTrust_External_Root.crt/d&#34; /etc/ca-certificates.conf</code></pre><h5 class=pgc-h-arrow-right>更新CA库</h5><p>使用update-ca-certificates 该命令用以更新目录/etc/ssl/certs来保存SSL证书，并生成ca-certificates.crt:</p><pre><code>$ sudo update-ca-certificates --freshClearing symlinks in /etc/ssl/certs...done.Updating certificates in /etc/ssl/certs...147 added, 0 removed; done.Running hooks in /etc/ca-certificates/update.d...done.</code></pre><p>重启主机上的应用程序。</p><h4 class=pgc-h-arrow-right>容器（Docker-Alpine OS）</h4><p>容器同主机上的修改差不太多。修改ca配置文件，之后执行更新命令。以下以alpine系统为例：</p><p>修改配置文件：</p><pre><code>sed -i &#34;/AddTrust_External_Root.crt/d&#34; /etc/ca-certificates.conf</code></pre><p>更新ca证书链：</p><pre><code>update-ca-certificates -f -v</code></pre><p>当然上面的两条命令最好是放在Dockerfile中，你知道，在容器里做的任何修改都是不可靠的（除非挂载了共享或卷）</p><p>Dockerfile示例，在CMD之前添加一行：</p><pre><code>省略...RUN sed -i &#34;/AddTrust_External_Root.crt/d&#34; /etc/ca-certificates.conf \    && update-ca-certificates -f -v</code></pre><h4 class=pgc-h-arrow-right>macOS</h4><p>我自己电脑上的curl也是同样的问题，目前没找到好的自动修改的方式。不过找到了系统上的ca文件路径。</p><p>先备份下文件：</p><pre><code>sudo cp /etc/ssl/cert.pem ~/etc-ssl-cert.pem-20200601</code></pre><p>之后，运行以下命令可以禁用掉过期的CA证书：</p><pre><code>sudo sed -i &#34;/^### AddTrust/,/^-.*END/ s/^/#/g&#34; /etc/ssl/cert.pem</code></pre><p>上面是注释掉，当然你也可以直接编辑文件删除这些行。</p><h5 class=pgc-h-arrow-right>验证</h5><p>修改更新完ca配置后，再次执行curl 命令去访问之前的网站：</p><pre><code>$ curl https://sentry.xxx.com</code></pre><p>这次访问正常了.</p><h3 class=pgc-h-arrow-right>其他问题</h3><p>当时出现问题时，还有另外一个现象，就是用curl访问其他网站（如，bing.com、qq.com）都是正常的. 怀疑是不是目标域名使用的证书链不一样， 导致了只有我们业务域名出现了问题呢？</p><h5 class=pgc-h-arrow-right>验证下猜想</h5><p>使用openssl 检查下我们业务域名证书的链</p><pre><code># openssl s_client  -connect sentry.xxx.com:443CONNECTED(00000003)depth=2 C = US, ST = New Jersey, L = Jersey City, O = The USERTRUST Network, CN = USERTrust RSA Certification Authorityverify return:1depth=1 C = LV, L = Riga, O = GoGetSSL, CN = GoGetSSL RSA DV CAverify return:1depth=0 OU = Domain Control Validated, OU = GoGetSSL Wildcard SSL, CN = *.xxx.comverify return:1---Certificate chain 0 s:/OU=Domain Control Validated/OU=GoGetSSL Wildcard SSL/CN=*.xxx.com   i:/C=LV/L=Riga/O=GoGetSSL/CN=GoGetSSL RSA DV CA 1 s:/C=LV/L=Riga/O=GoGetSSL/CN=GoGetSSL RSA DV CA   i:/C=US/ST=New Jersey/L=Jersey City/O=The USERTRUST Network/CN=USERTrust RSA Certification Authority 2 s:/C=US/ST=New Jersey/L=Jersey City/O=The USERTRUST Network/CN=USERTrust RSA Certification Authority   i:/C=SE/O=AddTrust AB/OU=AddTrust External TTP Network/CN=AddTrust External CA Root---Server certificate省略...</code></pre><p>在检测下上面说的其他网站bing.com:</p><pre><code>$ openssl s_client  -connect cn.bing.com:443CONNECTED(00000003)depth=2 C = IE, O = Baltimore, OU = CyberTrust, CN = Baltimore CyberTrust Rootverify return:1depth=1 C = US, ST = Washington, L = Redmond, O = Microsoft Corporation, OU = Microsoft IT, CN = Microsoft IT TLS CA 2verify return:1depth=0 CN = www.bing.comverify return:1---Certificate chain 0 s:/CN=www.bing.com   i:/C=US/ST=Washington/L=Redmond/O=Microsoft Corporation/OU=Microsoft IT/CN=Microsoft IT TLS CA 2 1 s:/C=US/ST=Washington/L=Redmond/O=Microsoft Corporation/OU=Microsoft IT/CN=Microsoft IT TLS CA 2   i:/C=IE/O=Baltimore/OU=CyberTrust/CN=Baltimore CyberTrust Root---省略...</code></pre><p>我又测试了其他几个大的站点，发现都正常。为什么唯独我们的SSL证书链中的其中一个CA(Sectigo AddTrust)过期了呢？</p><p>去查找下相关的文章,关键词sectigo gogetssl 2020 may 30.</p><p>发现第三条记录中有gogetssl发布的新闻, 标题是：Sectigo AddTrust External CA Root Expired May 30, 2020, 感兴趣的可以点击进去看看。</p><p>新闻大致的意思：</p><blockquote><p>由于Sectigo AddTrust外部CA根证书过期，影响了一些旧的设备或者一些老服务器，因为上面的根证书链中还存在该过期的CA证书。对于客户端（浏览器/SDK）来说，他们是不受该CA过期的问题影响。所以<strong>最大影响是在server端</strong>. 可以通过下载最新的AddTrust RSA 证书替换过期的。</p></blockquote><h3 class=pgc-h-arrow-right>总结</h3><p>目前该问题的影响面广不广，这个还暂时未知，不过根据我遇到的情况来看，影响大多在服务器端的外部服务之间的调用。对web用户端来说，因为浏览器内证书链是更新的，不涉及该问题。但对于 服务端来说，对于一些对外调用的https请求，如果对方域名证书链中涉及到该过期CA的话，可能会访问失败。</p><p>Tips1：如果你的应用程序的部署方式是直接运行在主机上的话，可以使用配置管理工具（ansible/saltstack），统一修改。如果是容器话部署的情况，可能涉及的稍微多一些，需要修改项目的Dockerfile,之后滚动更新该服务（当然如果你的应用不涉及到对外访问https/ssl调用，理论上可以延后更改！）。</p><p>Tips2: 删除过期证书后，记得要重启主机上运行的服务！！！</p><p>来源：https://aliasmee.github.io/post/resolve-certificate-verify-failed-with-2020-may-30/</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'一个','CA','根证书'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>