<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>FreeSql.Generator命令行代码生成器是如何实现的 | 极客快訊</title><meta property="og:title" content="FreeSql.Generator命令行代码生成器是如何实现的 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/b311f2e364484022876ad95bbad918cc"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6e682b92.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6e682b92.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6e682b92.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6e682b92.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6e682b92.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6e682b92.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6e682b92.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6e682b92.html><meta property="article:published_time" content="2020-11-14T20:55:22+08:00"><meta property="article:modified_time" content="2020-11-14T20:55:22+08:00"><meta name=Keywords content><meta name=description content="FreeSql.Generator命令行代码生成器是如何实现的"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/6e682b92.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>FreeSql.Generator命令行代码生成器是如何实现的</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>目录</p><ul><li>FreeSql介绍</li><li>FreeSql.Generator</li><li>RazorEngine.NetCore</li><li>源码解析</li><li>FreeSql.Tools</li></ul><h2 class=pgc-h-arrow-right>FreeSql</h2><p>FreeSql 是功能强大的对象关系映射技术(O/RM)，支持 .NETCore 2.1+ 或 .NETFramework 4.0+ 或 Xamarin。</p><p>有一个强大的ORM，也方便我们开发一个代码生成器。</p><p>一般情况下，我们开发数据库相关的应用，主要分为三种code first、db first、model first</p><p>我只用过前二种，</p><ul><li>code first，代码优先，数据库都是根据实体类生成，所有的关系，可以是逻辑关联，也可以是物理关联。</li><li>DB First: 数据库优先，直接设计表结构，用设计工具生成表，设计主键，外键、索引，关联关系等。</li></ul><p>当我们使用DB First时，设计好的数据库，我们怎么生成一些实体类、通用的代码、控制器、服务层、Dto呢。今天我来给大家介绍一下FreeSql项目中的一些工具。当然，不使用此ORM的小伙伴也能使用此工具，因为他是通用。</p><h2 class=pgc-h-arrow-right>FreeSql.Generator 命令行方式</h2><p>通过几行命令，就可实现生成项目中通用的代码结构，不需要复制一段代码后修改，加快开发速度，减少重复劳动，少用一根头发。</p><p>由于每个人的项目结构，代码位置各不相同，对于ORM来说，不同的业务逻辑各不相同，所以该项目没有相应的模板，相信使用过Razor的同学一定能实现自己的模板。</p><p>1-2年前，我和一个学长也写过代码生成器，这里分享一下当时做项目时的一些模板，https://github.com/i542873057/SJNScaffolding/tree/master/SJNScaffolding.RazorPage/Templates,该项目是基于 . NET Core+Razor Page,由于已离职，所以没有继续维护，这些模板都和ABP相关，当时提取了一些通用的功能，单表操作，可以直接生成前后端功能，只需要在word中按统一的格式写好数据字典的文档，直接复制到系统，即可根据空格，定义类型等方式解析字段。</p><p><strong>回到FreeSql.Generator 命令行</strong></p><ul><li>对于此工具的使用可参考 https://github.com/dotnetcore/FreeSql/wiki/DbFirst</li><li>源码位置 https://github.com/dotnetcore/FreeSql/tree/master/Extensions/FreeSql.Generator</li><li>前提是本地安装了.net core 3.1 的sdk.</li></ul><p>怎么使用呢。</p><ol start=1><li>安装 dotnet-tool 生成实体类</li></ol><pre><code>dotnet tool install -g FreeSql.Generator</code></pre><ol start=2><li>新建目录，在地址栏输入 cmd 快速打开命令窗口，输入命令：</li></ol><pre><code>FreeSql.Generator --help</code></pre><p>我们可以看到</p><pre><code>C:\Users\igeekfan\Desktop\code&gt;FreeSql.Generator --help        ____                   ____         __       / __/  ____ ___  ___   / __/ ___ _  / /      / _/   / __// -_)/ -_) _\ \  / _ `/ / /     /_/    /_/   \__/ \__/ /___/  \_, / /_/                                    /_/  # Github # https://github.com/2881099/FreeSql v1.5.0    使用 FreeSql 快速生成数据库的实体类    更新工具：dotnet tool update -g FreeSql.Generator  # 快速开始 #  &gt; FreeSql.Generator -Razor 1 -NameOptions 0,0,0,0 -NameSpace MyProject -DB "MySql,Data Source=127.0.0.1;..."     -Razor 1                  * 选择模板：实体类+特性     -Razor 2                  * 选择模板：实体类+特性+导航属性     -Razor "d:\diy.cshtml"    * 自定义模板文件     -NameOptions              * 总共4个布尔值，分别对应：                               # 首字母大写                               # 首字母大写,其他小写                               # 全部小写                               # 下划线转驼峰     -NameSpace                * 命名空间     -DB "MySql,Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;Initial Catalog=数据库;Charset=utf8;SslMode=none;Max pool size=2"     -DB "SqlServer,Data Source=.;Integrated Security=True;Initial Catalog=数据库;Pooling=true;Max Pool Size=2"     -DB "PostgreSQL,Host=192.168.164.10;Port=5432;Username=postgres;Password=123456;Database=数据库;Pooling=true;Maximum Pool Size=2"     -DB "Oracle,user id=user1;password=123456;data source=//127.0.0.1:1521/XE;Pooling=true;Max Pool Size=2"     -DB "Sqlite,Data Source=document.db"     -DB "Dameng,server=127.0.0.1;port=5236;user id=2user;password=123456789;database=2user;poolsize=2"                               Dameng 是国产达梦数据库     -Filter                   Table+View+StoreProcedure                               默认生成：表+视图+存储过程                               如果不想生成视图和存储过程 -Filter View+StoreProcedure     -Match                    正则表达式，只生成匹配的表，如：dbo\.TB_.+     -FileName                 文件名，默认：{name}.cs     -Output                   保存路径，默认为当前 shell 所在目录                               推荐在实体类目录创建 gen.bat，双击它重新所有实体类</code></pre><ul><li>更新命令行</li></ul><pre><code>dotnet tool update -g FreeSql.Generator</code></pre><ol start=3><li>这里lin-cms-dotnetcore这个项目来测试。</li></ol><div class=pgc-img><img alt=FreeSql.Generator命令行代码生成器是如何实现的 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/b311f2e364484022876ad95bbad918cc><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=FreeSql.Generator命令行代码生成器是如何实现的 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ccab6d067ec342e98bddd7dd5526eac5><p class=pgc-img-caption></p></div><ul><li>数据库表名是下划线，字段也是下划线方式。</li><li>-Razor 指定 第一个模板</li><li>-NameOptions 0,0,0,1 最后一个1，代表 下划线转驼峰，满足C#命名规则</li><li>-NameSpace 指定了命名空间 LinCms.Core.Entities</li><li>-DB 就是数据库的相关配置</li><li>mysql 本地地址 127.0.0.1 3306端口 用户名 root 密码123456 数据库 lin-cms</li><li>-Match book 这样就能只生成book，支持正则表达式，如 -Math lin_user 就会生成以lin_user开头的表。如dbo.TB_.+，会生成以TB开头的表。即只生成匹配的表</li></ul><ol start=4><li>执行此命令。</li></ol><pre><code>FreeSql.Generator -Razor 1  -NameOptions 0,0,0,1 -NameSpace LinCms.Core.Entities -DB "MySql,Data Source=127.0.0.1;Port=3306;User ID=root;Password=123456;Initial Catalog=lincms;Charset=utf8;SslMode=none;Max pool size=2"</code></pre><p>这时候代码已经生成了</p><p>其中一个代码 生成如下。这些类是partial ，熟悉C#的同学，应该知道，类的定义使用此关键字，我们能在不同的地方为该类扩展。以防止重新同步数据库的结构时，丢失改动的字段。</p><pre><code>namespace LinCms.Core.Entities {	[JsonObject(MemberSerialization.OptIn), Table(Name = "book")]	public partial class Book {		/// &lt;summary&gt;		/// 主键Id		/// &lt;/summary&gt;		[JsonProperty, Column(Name = "id", IsPrimary = true, IsIdentity = true)]		public long Id { get; set; }		[JsonProperty, Column(Name = "author", DbType = "varchar(20)")]		public string Author { get; set; } = string.Empty;		[JsonProperty, Column(Name = "image", DbType = "varchar(50)")]		public string Image { get; set; } = string.Empty;        //更多xxx	}}</code></pre><ul><li>最终效果图如下</li></ul><div class=pgc-img><img alt=FreeSql.Generator命令行代码生成器是如何实现的 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b9b3fec8c50c48fea49cb4befee55684><p class=pgc-img-caption></p></div><p>此时会生成二个文件__重新生成.bat,下次重新点击他就能重新生成实体类了。</p><pre><code>FreeSql.Generator -Razor "__razor.cshtml.txt" -NameOptions 1,1,0,1 -NameSpace MyProject -DB "MySql,Data Source=127.0.0.1;Port=3306;User ID=root;Password=123456;Initial Catalog=lincms;Charset=utf8;SslMode=none;Max pool size=2" -FileName "{name}.cs"</code></pre><p>上面的命令-Razor 指定了这个txt文件 __razor.cshtml.txt</p><p>我们可以定义自己的模板，以生成符合自已业务的的代码，从而实现快速开发。</p><p>我们可以看下模板中的文件内容,他就是asp.net下的mvc 结构下的razor后端模板渲染,把这个.txt后缀去掉，就很明了了。对于asp.net mvc的razor，我们可以将控制器下方法的值替换掉cshtml中的值。这个过程是有一个类库在帮我们实现的,叫RazorEngine，不过那个是.net framework下的实践。.NET Framework 下的RazorEngine代码生成介绍</p><pre><code>@using FreeSql.DatabaseModel;@{var gen = Model as RazorModel;Func&lt;string, string&gt; GetAttributeString = attr =&gt; {	if (string.IsNullOrEmpty(attr)) return null;	return string.Concat(", ", attr.Trim('[', ']'));};Func&lt;DbColumnInfo, string&gt; GetDefaultValue = col =&gt; {    if (col.CsType == typeof(string)) return " = string.Empty;";    return "";};}//xxxnamespace @gen.NameSpace {@if (string.IsNullOrEmpty(gen.table.Comment) == false) {	@:/// &lt;summary&gt;	@:/// @gen.table.Comment.Replace("\r\n", "\n").Replace("\n", "\r\n		/// ")	@:/// &lt;/summary&gt;}	[JsonObject(MemberSerialization.OptIn)@GetAttributeString(gen.GetTableAttribute())]	public partial class @gen.GetCsName(gen.FullTableName) {	@foreach (var col in gen.columns) {		if (string.IsNullOrEmpty(col.Coment) == false) {		@:/// &lt;summary&gt;		@:/// @col.Coment.Replace("\r\n", "\n").Replace("\n", "\r\n		/// ")		@:/// &lt;/summary&gt;		}		@:@("[JsonProperty" + GetAttributeString(gen.GetColumnAttribute(col)) + "]")		@:public @gen.GetCsType(col) @gen.GetCsName(col.Name) { get; set; }@GetDefaultValue(col)@:	}	}@gen.GetMySqlEnumSetDefine()}</code></pre><h2 class=pgc-h-arrow-right>RazorEngine.NetCore</h2><p>到了.NET Core时代，我看了下FreeSql.Generator用的这个类库RazorEngine.NetCore，实现动态操作cshtml，生成需要的文本。</p><p>Razor Engine是基于微软Razor解析的模板引擎，它允许你使用Razor语法构建动态模板，你只需要使用Engine的静态方法，Engine.Razor.RunCompile等。</p><p>创建一个控制台应用，然后安装包。</p><pre><code>Install-Package RazorEngine.NetCore</code></pre><pre><code>using RazorEngine;using RazorEngine.Templating; // For extension methods.string template = "Hello @Model.Name, welcome to RazorEngine!";var result = Engine.Razor.RunCompile(template, "templateKey", null, new { Name = "World" });Console.WriteLine(result);</code></pre><ul><li>输出如下内容</li></ul><pre><code>Hello World, welcome to RazorEngine!</code></pre><blockquote><p>此处使用的<strong>RunCompile</strong>方法是扩展方法，您需要引用RazorEngine.Templating命名空间。</p></blockquote><p>The "templateKey" 保持唯一值，比如使用guid值。字符串，并且你可以根据此字符串key重新运行缓存的模板。</p><p>如果再次根据此key，可使用原本的模板。</p><pre><code>var result = Engine.Razor.Run("templateKey", null, new { Name = "Max" });</code></pre><ul><li>会输出如下内容</li></ul><pre><code>Hello Max, welcome to RazorEngine!</code></pre><p>上面中的RunCompile第三个参数，传null,因为我们第四个参数使用的是匿名类，</p><p>根目录创建一个HelloWord.cshtml，要选择属性，->如果较新则复制 内容，</p><pre><code>Hello @Model.Name, welcome to RazorEngine!</code></pre><p>控制台如下代码。</p><pre><code>string templateFilePath = "HelloWorld.cshtml";var templateFile = File.ReadAllText(templateFilePath);string templateFileResult = Engine.Razor.RunCompile(templateFile, Guid.NewGuid().ToString(), null, new{    Name = "World"});Console.WriteLine(templateFileResult);</code></pre><ul><li>控制台输出</li></ul><pre><code>Hello World, welcome to RazorEngine!</code></pre><ul><li>使用强类型 CopyRightUserInfo.cs生成一个版权所有</li></ul><pre><code>using System;namespace OvOv.Razor{    public class CopyRightUserInfo    {        public string UserName { get; set; }        public string EmailAddress { get; set; }        public DateTime CreateTime { get; set; }        public string FileRemark { get; set; }    }}</code></pre><p>根目录创建一个CopyRightTemplate.cshtml，要选择属性，->如果较新则复制 内容，</p><pre><code>@{    var gen = Model as OvOv.Razor.CopyRightUserInfo;}//=============================================================// 创建人:            @gen.UserName// 创建时间:          @gen.CreateTime// 邮箱：             @gen.EmailAddress//==============================================================</code></pre><p>控制台如下代码。</p><pre><code>string copyRightTemplatePath = "CopyRightTemplate.cshtml";var copyRightTemplate = File.ReadAllText(copyRightTemplatePath);string copyRightResult = Engine.Razor.RunCompile(copyRightTemplate, Guid.NewGuid().ToString(), typeof(CopyRightUserInfo), new CopyRightUserInfo{    CreateTime = DateTime.Now,    EmailAddress = "710277267@qq.com",    UserName = "IGeekFan"});Console.WriteLine(copyRightResult);Console.ReadKey();</code></pre><ul><li>控制台输出</li></ul><pre><code>//=============================================================// 创建人:            IGeekFan// 创建时间:          2020/6/23 18:14:08// 邮箱：             710277267@qq.com//==============================================================</code></pre><p>全放到控制台下，输出如下结果。代码生成器最重要的一点解决了，我们就能实现自己的代码生成器，先构建自己的模板，实现输入（命令行，WPF，WEB端及更多），输出（生成文件）。</p><div class=pgc-img><img alt=FreeSql.Generator命令行代码生成器是如何实现的 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b4ed679ea4734713a67357aa1892ee6c><p class=pgc-img-caption></p></div><ul><li>以上源码已放到示例代码中 https://github.com/luoyunchong/dotnetcore-examples/blob/master/aspnetcore-freesql/OvOv.Razor/Program.cs</li></ul><h2 class=pgc-h-arrow-right>源码解析</h2><p>首先这是一个控制台应用，Main(string[] args)可接收多个参数。</p><ol start=1><li>处理无参数，--help</li><li>处理args数组，解析出所有的参数，如果没有设置，则为默认值。（处理一些参数异常问题）最重要的是根据-Razor，选定对应的模板。</li></ol><pre><code>ArgsRazor=""//根据-Razor  1 不是2 还是模板的路径，取出的模板文本值。var razorId = Guid.NewGuid().ToString("N");RazorEngine.Engine.Razor.Compile(ArgsRazor, razorId);</code></pre><ol start=3><li>根据数据库连接串，取出参数过滤后的表，视图，存储过程</li><li>循环数据库的表等，</li></ol><ul><li>model为模板中需要的数据</li><li>razorId与上文的razorId相同，</li><li>sw为生成后的文本保存的值。</li></ul><pre><code>var sw = new StringWriter();var model = new RazorModel(fsql, ArgsNameSpace, ArgsNameOptions, tables, table);RazorEngine.Engine.Razor.Run(razorId, sw, null, model);</code></pre><ol start=5><li>将sw字符串保存生成类.cs文件（根据参数配置生成文件名）</li><li>另外生成一个__重新生成.bat,__razor.cshtml.txt，方便后续用户重新生成实体类。</li></ol><h2 class=pgc-h-arrow-right>FreeSql.Tools</h2><p>这是 FreeSql 衍生出来的辅助工具包，内含生成器等功能；作者：mypeng1985因为这个不兼容mac,linux,所以作者建议使用dotnet-tool 命令行工具生成实体类，从而支持MAC/Linux系统。对于不是使用FreeSql的开发者，也能使用此工具，你只需要修改对应的模板即可。</p><p>使用方式：不多介绍。</p><ul><li>https://github.com/2881099/Freesql.tools</li><li>分为WPF ，WinForm + DSkin 版本（套网页）</li><li>看了下代码，底层生成代码逻辑也是用的RazorEngine .NET Framework 下的RazorEngine代码生成介绍</li></ul><h2 class=pgc-h-arrow-right>FreeSql官方群 4336577</h2><h5 class=pgc-h-arrow-right>预览图</h5><div class=pgc-img><img alt=FreeSql.Generator命令行代码生成器是如何实现的 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/58cc512805e64465b3a66bb73b8a626e><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=FreeSql.Generator命令行代码生成器是如何实现的 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3f4bac3df46c47fca6a200b237589855><p class=pgc-img-caption></p></div><p><br></p><p>作者： 、天上有木月OvO</p><p>原文地址：https://cnblogs.com/igeekfan</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'生成器','FreeSql','Generator'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>