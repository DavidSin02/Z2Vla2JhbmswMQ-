<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>程序员的一次失误，在 45 分钟里搞垮了一家上市公司 | 极客快訊</title><meta property="og:title" content="程序员的一次失误，在 45 分钟里搞垮了一家上市公司 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="http://p1.pstatp.com/large/pgc-image/RupKXl2WLPhUP"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/748e9e2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/748e9e2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/748e9e2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/748e9e2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/748e9e2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/748e9e2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/748e9e2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/748e9e2.html><meta property="article:published_time" content="2020-10-29T20:48:27+08:00"><meta property="article:modified_time" content="2020-10-29T20:48:27+08:00"><meta name=Keywords content><meta name=description content="程序员的一次失误，在 45 分钟里搞垮了一家上市公司"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/748e9e2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>程序员的一次失误，在 45 分钟里搞垮了一家上市公司</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>如果有人告诉你，45 分钟就能搞垮一家大公司，你可能会觉得有点荒谬。但工程师 Doug Seven 却真的亲历过这样的事情。</p><p>8 年前，因为一次失败的部署，Knight Capital Group 在仅仅 45 分钟内就造成了 4.6 亿美元的亏损。</p><p>这是一个真实的故事。</p><p>尽管 Doug Seven 并不是事件的参与者，但他在后来的会议中不断提及 DevOps、代码配置和持续交付的主题，希望让开发人员意识到部署的重要性。</p><p>究竟是怎么回事？Doug Seven 在博客中分享了这个故事。</p><img alt="程序员的一次失误，在 45 分钟里搞垮了一家上市公司" onerror=errorimg.call(this); src=http://p1.pstatp.com/large/pgc-image/RupKXl2WLPhUP><p><strong>故事背景</strong></p><p>这个故事的主角是一家名为 Knight Capital Group 的美国全球金融服务公司，它从事做市、电子执行、机构销售和交易。</p><p>2012 年，Knight 是美国最大的股票交易商，在纽约证交所和纳斯达克的市场份额约为 17%。Knight 电子交易集团（ETG）平均每日交易量超过 33 亿笔，每日交易额超过 210 亿美元。</p><p>种种数据表明，当时公司的运营和财务状况非常优秀。</p><p>2012 年 7 月 31 日，Knight 拥有约 3.65 亿美元的资产。</p><p>当时，纽约证交所正计划于 2012 年 8 月 1 日推出一项新的零售流动性计划。</p><p>为了准备这次活动，Knight 更新了他们的路由器 SMARS。这个路由器负责将订单发送到市场上执行。SMARS 的核心功能之一是接收 Knight 交易平台其他组件的订单（父订单），然后发送一个或多个子订单执行。换言之，SMARS 将从交易平台收到大量订单，并将它们分成多个较小的订单，以便找到股票数量相匹配的买家或者卖家。父订单越大，生成的子订单越多。</p><p>在 SMARS 中，有一段老旧的代码，名为「Power Peg」，它已经 8 年没被用到过了，而此次更新的目的正是要换掉这段代码。更新的代码重新调整了用于激活 Power Peg 功能的旧标志的功能。</p><p>代码经过了彻底的测试，并且还进行了一系列的验证。所有的一切都看起来很完美，找不到出错的理由。</p><p><strong>死灰复燃的旧代码</strong></p><p>2012 年 7 月 27 日至 2012 年 7 月 31 日期间，Knight 的开发人员每天手动将新的软件部署到公司的 8 台服务器上。这就是 SEC 文件中关于手动部署过程的内容。如果 SEC 文件中有关于部署的内容，那么就可能出现了严重的错误。</p><p>然而，在新代码的部署过程中，Knight 的一名技术人员忘记将新代码复制到所有 8 台 SMARS 计算机服务器中——他漏掉了其中一台服务器。</p><p>没有第二个技术人员来审查这个部署。</p><p>Knight 的所有人都没有意识到，Power Peg 代码并没有从第 8 个服务器上删除，也没有添加新的 RLP 代码。Knight 没有书面流程要求这样的审查。</p><p>2012 年 8 月 1 日，在美国东部时间上午 9:30，市场开盘。Knight 开始代表客户处理订单。</p><p>具有正确 SMARS 部署的 7 台服务器开始正确处理这些订单。然而，发送到第 8 台服务器的命令触发了可支持的重新利用标志，并从死地中恢复了旧的 Power Peg 代码。</p><p><strong>杀手代码如僵尸般的攻击</strong></p><p>Power Peg 代码用于在执行子订单时，根据父订单计算购买或者出售的股份。Power Peg 将指示系统在完成父订单后停止传送子订单。</p><p>也就是说，Power Peg 会跟踪子订单，并在父订单完成后停止它们。</p><p>2005 年，Knight 将这种累计跟踪功能移到了代码执行的早期阶段，从而从 Power Peg 中删除了计数跟踪。</p><p>当激活第 8 台服务器上的 Power Peg 标志时，Power Peg 功能开始路由子订单以供执行。但由于没有根据父订单跟踪共享量，造成了一个永无止境的循环。</p><p><strong>地狱 45 分钟</strong></p><p>想象一下，如果你有一个系统，它能够向市场发送自动化的、高速的订单，且没有任何跟踪程序来检查是否执行了足够的订单，会发生什么？没有比这更糟糕的事了。</p><p>上午 9:30 开市时，人们很快就知道出了问题。到上午 9 点 31 分，华尔街的许多人都清楚发生了一些严重的事情。市场上充斥着非正常交易量的股票订单。</p><p>到上午 9 点 32 分，华尔街的人们都在想，为什么订单还没有停下来，为什么没有人按下任何系统的关闭开关？结果他们发现，并没有关闭开关。在交易的前 45 分钟里，Knight 的交易量占了总交易量的 50% 以上，这使得某些股票的市值上涨了 10% 以上。因此，其他股票因错误的交易而贬值。</p><p>更糟糕的是，Knight 的系统在当天早些时候开始自动发送电子邮件。早在上午 8:01，SMAR 已经处理了符合上市前交易条件的订单。邮件消息引用 SMARS，并将错误识别为「Power Peg disabled」。</p><p>在上午 8:01 到 9:30 之间，Knight 工作人员也收到了 97 封邮件。可惜的是，这些电子邮件不是作为系统警报设计的，因此没有人立即查看它们。</p><p>在 Knight 经历的 45 分钟内，他们尝试了几种反制措施，试图阻止错误的交易。由于没有终止开关，所以他们只能在实时交易环境中尝试诊断问题。</p><p>每分钟，系统上约有 800 万股股票被交易。他们无法确定是什么导致了错误的命令，所以他们从正确部署的服务器上卸载了新代码。</p><p>换句话说，他们删除了工作代码，留下了损坏的代码。</p><p>这更加放大了问题。最开始，仅在部署不正确的服务器上，额外的父命令激活了 Power Peg 代码。现在，问题蔓延到了所有服务器上。最后，他们终于停止了系统，但此时已经进行了 45 分钟的交易。</p><p>在开盘的前 45 分钟，市场收到并处理了 212 份父订单。因此，SMARS 向市场发送了数以百万计的子订单，产生了 400 万笔交易，而其中 154 只股票的交易量超过了 3.97 亿股。这意味着，Knight 资本集团在 45 分钟内造成了 4.6 亿美元的亏损。</p><p>然而，Knight 只有 3.65 亿美元的资产。</p><p>45 分钟后，美国股市最大的交易商、纽约证交所和纳斯达克的主要做市商 Knight 破产，4 个月后被 Getco LLC 收购。</p><p><strong>软件发布必须可重复、可靠</strong></p><p>所有开发和运营团队都应该从这次事件中吸取教训。仅仅构建优秀的软件并对其进行测试是不够的，你还必须确保它被正确地交付给市场，这样你的客户才能获得你所交付的价值。</p><p>部署 SMARS 的工程师并不是此事唯一的责任人，Knight 设置的流程和他们所面临的风险并不匹配。此外，他们的流程天生就容易出错。任何时候，如果你的部署过程依赖于人主动阅读和遵循说明，那么都将面临风险。人是会犯错的。错误可能出现在指令中，也可能出现在指令的解释中，或出现在指令的执行中。</p><p>部署需要自动化，并且可重复，尽可能避免潜在的人为错误。如果 Knight 实现了自动化部署系统，将配置、部署和测试全部自动化，那么这次错误本可以避免。</p><p>即使没有实施完整的连续交付过程，你仍然需要遵守的几个连续交付原则：</p><ul><li><p>软件发布应该是一个可重复、可靠的过程。</p></li><li><p>尽可能地自动化。</p></li></ul><p>via：https://dougseven.com/2014/04/17/knightmare-a-devops-cautionary-tale/</p><p>雷锋网雷锋网雷锋网</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'失误','45','分钟里'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>