<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 | 极客快訊</title><meta property="og:title" content="对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/153725561242172fe921af5"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/74e14b06.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/74e14b06.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/74e14b06.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/74e14b06.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/74e14b06.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/74e14b06.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/74e14b06.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/74e14b06.html><meta property="article:published_time" content="2020-10-29T21:11:31+08:00"><meta property="article:modified_time" content="2020-10-29T21:11:31+08:00"><meta name=Keywords content><meta name=description content="对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/74e14b06.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1><strong>私信“干货”二字，即可领取18G伺服与机器人专属资料！</strong></h1><p>【导读】论述伺服驱动控制器的实现方法，通过对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现出来；这种架构控制器系统分工明确，提高了算法的实时性；提高了控制器对外接口EtherCAT的实时性；提高了系统的稳定性。这种架构方案在天津电气科学研究院有限公司的伺服驱动器产品中进行了实验，现场的应用取得了良好的效果，体现出这种技术的现实意义。</p><p><strong>1.引言</strong></p><p class=ql-align-justify><br></p><p class=ql-align-justify>伺服驱动器是用来控制伺服电机的一种控制器，一般是通过位置、速度和力矩三种方式对电机进行控制，实现高精度的系统定位。</p><p>目前，伺服控制器CPU的架构主要有：</p><p>1、单CPU架构ARM（AcornRISCMachine）控制器；</p><p>2、单CPU架构DSP(DigitalSignalProcess)控制器；</p><p>3、ARM+FPGA+DSP架构的多CPU控制器。</p><p class=ql-align-justify><br></p><p class=ql-align-justify>方法3是目前最先进的架构，前两种方法都有局限性。方法1和方法2这种单CPU架构的控制器，一个CPU集算法、采集控制、通讯、显示功能于一体，当算法复杂度和实时性要求高时往往会顾此失彼。而方法3的架构中各个CPU的分工明确，ARM负责通信和显示功能，DSP负责算法运算，FPGA负责采集和控制。方法3的技术瓶颈是满足伺服控制器的实时性要求需要几个CPU之间的高速数据通信，因此，如果能够找到一个高速的通信方式完全可以发挥各个CPU的特性，就像一个多核CPU在工作一样。</p><p>本研究基于ARM+FPGA+DSP架构，采用并口通信的方法用于几个CPU之间的内部高速通信；此外伺服驱动器作为伺服系统的一部分还需要和主控器和编码器进行高速通信，来满足整个伺服系统的实时性要求，本架构采用EtherCAT和高速485接口用于控制器和其他设备进行高速通信，描述了系统的原理架构和软件设计架构。</p><p class=ql-align-justify><br></p><p><strong>2.多CPU架构控制器原理分析</strong></p><p class=ql-align-justify><br></p><p>2.1 此架构的控制器中ARM负责通信和显示功能，DSP负责算法运算，FPGA负责采集和控制，如图1所示。FPGA采集相电压、相电流等物理量通过并口传给DSP；ARM通过EtherCAT接收主控制器命令，通过高速485采集码盘的速度和位置等信息，通过并口传给FPGA中转下再传到DSP；DSP中执行伺服控制的算法，利用FPGA和ARM中采集的数据进行计算，把计算结果再通过并口传给FPGA和ARM，由FPGA和ARM进行相关的控制操作。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153725561242172fe921af5><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>图1 多 CPU 架构控制器结构图</p><p class=ql-align-justify><br></p><p>2.2 此架构控制器中几个CPU之间的双口RAM通信：用双口RAM中各位数据都是并行传送的，它通常是以字节（8位）的整数倍为单位进行数据传输，能完成数据的输入和输出。用双口RAM通信的原理如2所示。用双口RAM通信具有各数据位同时传输，传输速度快、效率高的特点，多用在实时、快速的场合。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15372556124859709fbaf5a><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>图2 用双口RAM通信原理图</p><p class=ql-align-justify><br></p><p>2.3 此架构控制器的对外接口有EtherCAT和高速485。码盘的接口一般采用485接口，所以本控制器也采用485的接口，用DMA来实现；伺服控制器与主控制之间的接口有EtherCAT和PROFINET等协议，本控制器采用应用比较广的EtherCAT接口。实时以太网EtherCAT是由倍福开发的一种工业以太网技术。它以高速率、高有效数据利用率、完全符合以太网标准、刷新周期短、同步性能好等优势,在伺服通讯领域中得到越来越多的应用。其原理如图3所示。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153725561250916081463ec><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>图3 EtherCAT报文</p><p class=ql-align-justify><br></p><p><strong>3.多CPU架构控制器硬件设计</strong></p><p class=ql-align-justify><br></p><p class=ql-align-justify>3.1控制器ARM的设计</p><p class=ql-align-justify>主控制器ARM通过STM32F407芯片完成上节介绍的与FPGA的并口通信、EtherCAT通信、485通信。STM32F407属于高端的32位ARM微控制器，该系列芯片是意法半导体（ST）公司出品，其内核是Cortex-M4。本次设计充分利用其资源，实现了并口通信、therCAT通信、485通信。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15372556125065465561e39><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>图4 FSMC框图</p><p class=ql-align-justify><br></p><p class=ql-align-justify>并口通信：STM32F407具有FSMC功能，灵活的静态存储器控制器(FSMC)是内置大容量的外部存储器控制器，使用这个控制器，STM32可以与FPGA或者存储器进行并口通信。FSMC产生所有驱动这些存储器（把FPGA当做存储器来操作）的信号时序：16个数据线和16个地址线,原理如图4所示。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153725561247433af5af809><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>图5 数据总线XINTF连接框图</p><p class=ql-align-justify><br></p><p class=ql-align-justify>EtherCAT通信和485通信：EtherCAT通信通过芯片ET1100来实现，ET1100是一款强大的EtherCAT从站控制器ESC专用芯片，ET1100与ARM的接口采用SPI的方式；485通信速度为2.5Mbps，采用DMA的方式来实现，DMA的具体实现方法在下章软件设计中详述。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15372556125223811f9c42b><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>图6读操作时序</p><p class=ql-align-justify><br></p><p class=ql-align-justify>3.2控制器FPGA和DSP的并口通信设计</p><p class=ql-align-justify>FPGA采用Altera的Cyclone®IV系列FPGA，具有低成本、低功耗的特点，高达532个用户I/O，支持高达200MHz的DDR2SDRAM接口；DSP采用TMS320C28346，通过XINTF连接FPGA，实现双向并口通信。DSP的输入和输出采用中断控制,当FPGA准备好数据后,向DSP发送中断，DSP响应中断后读取相应地址的数据并向另外一段地址写入数据，FPGA等待60μs开始读数据。这样就能够完成两个芯片的并行通信。TMS320C28346型DSP芯片有16位XINTF数据总线,做为系统外部接口,它可以与各种外部存储器或者CPU实现无缝连接，如图5所示。在此系统中,将它与FPGA的16个用户可定义I/O管脚相连,用于实现16位并行数据的通信。TMS320C28346芯片可编程通用输入/输出引脚,任选一个和FPGA的用户I/O管脚相连,作为DSP的读写中断。</p><p><strong>4.多CPU架构控制器软件设计</strong></p><p class=ql-align-justify><br></p><p class=ql-align-justify>4.1控制器ARM的软件设计</p><p class=ql-align-justify>控制器中ARM与FPGA的并口通信用FSMC来实现，采用非总线复用的异步NOR闪存的方式来驱动，读时序如图6所示，写时序如图7所示。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15372556127041f6afd077f><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>图7 写操作时序</p><p class=ql-align-justify><br></p><p class=ql-align-justify>并口通信的地址选择使用了FSMC的BANK1的子板块2，具体程序代码如下：</p><p class=ql-align-justify></p><p>p.FSMC_AccessMode=FSMC_AccessMode_A;</p><p>FSMC_NORSRAMInitStructure.FSMC_Bank=FSMC_Bank1_NORSRAM2;</p><p>FSMC_NORSRAMCmd(FSMC_Bank1_NORSRAM2,ENABLE);</p><p class=ql-align-justify><br></p><p class=ql-align-justify>ARM与FPGA通信触发由外部中断来触发，当FPGA准备好数据后给ARM一个中断，中断周期为120μs，其中前60μs用于ARM从并口地址读取数据并且把要传给FPGA的数据写入相应地址，后60μs用于FPGA从并口地址读取数据，程序代码如下：</p><p>pBuf=(s16*)EXT_SRAM_ADDR+31;</p><p>for(i=31;i&lt;91;i++)//read</p><p>{FPGA_TO_ARM[i]=*pBuf++;}</p><p>pBuf=(s16*)EXT_SRAM_ADDR+41;</p><p>for(i=41;i&lt;61;i++)//write</p><p>{*pBuf++=(FPGA_TO_ARM[i]+1);}</p><p class=ql-align-justify><br></p><p class=ql-align-justify>ARM与码盘通信通过485来实现，通信速度为2.5Mbps，由于速度快采用一般的中断方式很难满足需求，本系统采用DMA来实现，程序代码如下：</p><p>DMA_InitStructure.DMA_PeripheralBaseAddr=(uint32_t)(&(USART3->DR));//串口3接收DMA</p><p>DMA_InitStructure.DMA_Memory0BaseAddr=(uint32_t)UART3_DMA_RxBuffer;</p><p>DMA_InitStructure.DMA_PeripheralBaseAddr=(uint32_t)(&(USART3->DR));//串口3发送DMA</p><p>DMA_InitStructure.DMA_Memory0BaseAddr=(uint32_t)UART3_DMA_TxBuffer;</p><p class=ql-align-justify><br></p><p class=ql-align-justify>4.2控制器FPGA的软件设计</p><p class=ql-align-justify>FPGA与DSP并行总线通讯模块用于FPGA与DSP之间的并行总线数据交换，其中包含两段独立的地址空间，一个空间用于DSP读FPGA内部数据通道，另一个空间用于DSP向FPGA写数据通道。程序使用ALTERA提供的双口RAM的IP核。程序模块图如图8所示。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1537255612757f2cefe2995><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>图8 FPGA程序模块图</p><p class=ql-align-justify><br></p><p class=ql-align-justify>FPGA与DSP并行总线通讯模块主时钟CLK的频率应是DSP总线读写频率的4倍以上，一般选取120M，这个时钟由FPGA内部的PLL锁相环生成。由于DSP的地址总线一般为16位以上，ADDR_DSP连接DSP地址总线的低位。RD_DSP连接DSP读使能，WR_DSP连接DSP写使能，如果有片选信号，DSP读写使能信号需要与片选信号取或后再与WR_DSP和RD_DSP连接。</p><p class=ql-align-justify>4.3控制器DSP的软件设计</p><p class=ql-align-justify>DSP28346芯片通过外部接口（XINTF）来读写外扩存储单元，本系统中即为FPGA的双口RAM空间。DSP28346的XINTF是一个非复用的异步总线。在配置XINTF时，应该检测内部XTIMCLK所需要的与SYSCLKOUT有关的比例。通过写XINTFCNF2寄存器的XTIMCLK位，可以将TIMCLK配置成与SYSCLKOUT相等或者等于SYSCLKOUT/2。XINTF的所有访问从XCLKOUT的上升沿开始，而外部逻辑受到XCLKOUT时钟的控制。通过写XINTFCNF2寄存器的CLKMODE位，可将XCLKOUT配置成与内部XINTF时钟XTIMCLK成比例的频率。程序代码如下：</p><p>XintfRegs.XINTCNF2.bit.XTIMCLK=0;</p><p>XintfRegs.XINTCNF2.bit.WRBUFF=3;</p><p>XintfRegs.XINTCNF2.bit.CLKOFF=0;</p><p>XintfRegs.XINTCNF2.bit.CLKMODE=0;</p><p>XintfRegs.XINTCNF2.bit.BY4CLKMODE=1;</p><p>XintfRegs.XTIMING6.bit.XWRLEAD=3;</p><p>XintfRegs.XTIMING6.bit.XWRACTIVE=5;</p><p>XintfRegs.XTIMING6.bit.XWRTRAIL=2;</p><p>XintfRegs.XTIMING6.bit.XRDLEAD=3;</p><p>XintfRegs.XTIMING6.bit.XRDACTIVE=5;</p><p>XintfRegs.XTIMING6.bit.XRDTRAIL=2;</p><p>XintfRegs.XTIMING6.bit.X2TIMING=0;</p><p>XintfRegs.XTIMING6.bit.USEREADY=1;</p><p>XintfRegs.XTIMING6.bit.READYMODE=1;</p><p class=ql-align-justify><br></p><p><strong>5.结论</strong></p><p class=ql-align-justify><br></p><p class=ql-align-justify>市面上的伺服驱动器CPU的架构主要有单ARM控制器和单DSP控制器。单ARM控制器方案在通信和控制方面存在优势，但是复杂算法在实现的时候往往会因为运算耗时而降低整个系统实时性；单DSP控制器方案中在算法中存下优势，但是在对外通信和控制方面往往会实现起来比较复杂。采用ARM+FPGA+DSP架构的多CPU控制器方案完全解决了上述两种方法的弊端，充分发挥了各个CPU的优势。本文论述的架构在本公司的伺服驱动器产品中进行试验和应用，证明了“ARM+FPGA+DSP架构的多CPU控制器架构”的可行性和技术优势。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1537255612784157e7093eb><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>图9 CPU算法在线仿真图</p><p class=ql-align-justify><br></p><p class=ql-align-justify>如图9中的红色标记框图所示，整个伺服驱动器系统的CPU使用率在75.22%（A:空跑时优先级最低的计数器个数；B满算法运行时优先级最低计数器的个数；CPU使用率=(A-B)/A*100），此CPU架构达到了控制CPU使用率和提高系统效率的目标。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=对ARM+FPGA+DSP架构的多CPU控制器的具体分析将其原理和优势展现 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1537255612730440b329f20><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>图10</p><p class=ql-align-justify><br></p><p class=ql-align-justify>如图10中的离线惯量辨识2s周期（0.5转速）PI不变时跟随情况，通道1是转速给定，通道2是电磁转矩，通道3是实际转速，通道4是实际A相电流。速度采集首先通过ARM的高速485采集码盘数据，并通过并口传给DSP和FPGA，经过算法处理再把数据下发给码盘，整个闭环过程通过并口传输，满足了伺服驱动器的算法实时性要求，此CPU架构达到了提高整个系统实时性的目标。</p><h1><strong>私信“干货”二字，即可领取18G伺服与机器人专属资料！</strong></h1></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ARM','FPGA','DSP'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>