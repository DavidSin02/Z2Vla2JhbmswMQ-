<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus | æå®¢å¿«è¨Š</title><meta property="og:title" content="Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/153260587912802d119c482"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/754aca8.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/754aca8.html><meta property="article:published_time" content="2020-10-29T21:04:29+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:29+08:00"><meta name=Keywords content><meta name=description content="Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/754aca8.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p><strong>èƒŒæ™¯</strong></p><p>å¯¹äºAndroidç³»ç»Ÿæ¥è¯´ï¼Œæ¶ˆæ¯ä¼ é€’æ˜¯æœ€åŸºæœ¬çš„ç»„ä»¶ï¼Œæ¯ä¸€ä¸ªAppå†…çš„ä¸åŒé¡µé¢ï¼Œä¸åŒç»„ä»¶éƒ½åœ¨è¿›è¡Œæ¶ˆæ¯ä¼ é€’ã€‚æ¶ˆæ¯ä¼ é€’æ—¢å¯ä»¥ç”¨äºAndroidå››å¤§ç»„ä»¶ä¹‹é—´çš„é€šä¿¡ï¼Œä¹Ÿå¯ç”¨äºå¼‚æ­¥çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚å¯¹äºAndroidå¼€å‘è€…æ¥è¯´ï¼Œç»å¸¸ä½¿ç”¨çš„æ¶ˆæ¯ä¼ é€’æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä»æœ€æ—©ä½¿ç”¨çš„Handlerã€BroadcastReceiverã€æ¥å£å›è°ƒï¼Œåˆ°è¿‘å‡ å¹´æµè¡Œçš„é€šä¿¡æ€»çº¿ç±»æ¡†æ¶EventBusã€RxBusã€‚Androidæ¶ˆæ¯ä¼ é€’æ¡†æ¶ï¼Œæ€»åœ¨ä¸æ–­çš„æ¼”è¿›ä¹‹ä¸­ã€‚</p><p><strong>ä»EventBusè¯´èµ·</strong></p><p>EventBusæ˜¯ä¸€ä¸ªAndroidäº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¡†æ¶ï¼Œé€šè¿‡è§£è€¦å‘å¸ƒè€…å’Œè®¢é˜…è€…ç®€åŒ–Androidäº‹ä»¶ä¼ é€’ã€‚EventBuså¯ä»¥ä»£æ›¿Androidä¼ ç»Ÿçš„Intentã€Handlerã€Broadcastæˆ–æ¥å£å›è°ƒï¼Œåœ¨Fragmentã€Activityã€Serviceçº¿ç¨‹ä¹‹é—´ä¼ é€’æ•°æ®ï¼Œæ‰§è¡Œæ–¹æ³•ã€‚</p><p>EventBusæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯ç®€æ´ã€è§£è€¦ã€‚åœ¨æ²¡æœ‰EventBusä¹‹å‰æˆ‘ä»¬é€šå¸¸ç”¨å¹¿æ’­æ¥å®ç°ç›‘å¬ï¼Œæˆ–è€…è‡ªå®šä¹‰æ¥å£å‡½æ•°å›è°ƒï¼Œæœ‰çš„åœºæ™¯æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨Intentæºå¸¦ç®€å•æ•°æ®ï¼Œæˆ–è€…åœ¨çº¿ç¨‹ä¹‹é—´é€šè¿‡Handlerå¤„ç†æ¶ˆæ¯ä¼ é€’ã€‚ä½†æ— è®ºæ˜¯å¹¿æ’­è¿˜æ˜¯Handleræœºåˆ¶è¿œè¿œä¸èƒ½æ»¡è¶³æˆ‘ä»¬é«˜æ•ˆçš„å¼€å‘ã€‚EventBusç®€åŒ–äº†åº”ç”¨ç¨‹åºå†…å„ç»„ä»¶é—´ã€ç»„ä»¶ä¸åå°çº¿ç¨‹é—´çš„é€šä¿¡ã€‚EventBusä¸€ç»æ¨å‡ºï¼Œä¾¿å—åˆ°å¹¿å¤§å¼€å‘è€…çš„æ¨å´‡ã€‚</p><p>ç°åœ¨çœ‹æ¥ï¼ŒEventBusç»™Androidå¼€å‘è€…ä¸–ç•Œå¸¦æ¥äº†ä¸€ç§æ–°çš„æ¡†æ¶å’Œæ€æƒ³ï¼Œå°±æ˜¯æ¶ˆæ¯çš„å‘å¸ƒå’Œè®¢é˜…ã€‚è¿™ç§æ€æƒ³åœ¨å…¶åå¾ˆå¤šæ¡†æ¶ä¸­éƒ½å¾—åˆ°äº†åº”ç”¨ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153260587912802d119c482><p class=pgc-img-caption></p></div><p>å›¾ç‰‡æ‘˜è‡ªEventBus GitHubä¸»é¡µ</p><p><strong>å‘å¸ƒ/è®¢é˜…æ¨¡å¼</strong></p><p>è®¢é˜…å‘å¸ƒæ¨¡å¼å®šä¹‰äº†ä¸€ç§â€œä¸€å¯¹å¤šâ€çš„ä¾èµ–å…³ç³»ï¼Œè®©å¤šä¸ªè®¢é˜…è€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡ã€‚è¿™ä¸ªä¸»é¢˜å¯¹è±¡åœ¨è‡ªèº«çŠ¶æ€å˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰è®¢é˜…è€…å¯¹è±¡ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°è‡ªå·±çš„çŠ¶æ€ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1532605879208bb17a1c8b4><p class=pgc-img-caption></p></div><p><strong>RxBusçš„å‡ºç°</strong></p><p>RxBusä¸æ˜¯ä¸€ä¸ªåº“ï¼Œè€Œæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ç°åªæœ‰çŸ­çŸ­30è¡Œä»£ç ã€‚RxBusæœ¬èº«ä¸éœ€è¦è¿‡å¤šåˆ†æï¼Œå®ƒçš„å¼ºå¤§å®Œå…¨æ¥è‡ªäºå®ƒåŸºäºçš„RxJavaæŠ€æœ¯ã€‚å“åº”å¼ç¼–ç¨‹ï¼ˆReactive Programmingï¼‰æŠ€æœ¯è¿™å‡ å¹´ç‰¹åˆ«ç«ï¼ŒRxJavaæ˜¯å®ƒåœ¨Javaä¸Šçš„å®ä½œã€‚RxJavaå¤©ç”Ÿå°±æ˜¯å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å¤„ç†çº¿ç¨‹åˆ‡æ¢ã€‚æ‰€ä»¥ï¼ŒRxBuså‡­å€ŸåŒºåŒº30è¡Œä»£ç ï¼Œå°±æ•¢æŒ‘æˆ˜EventBusâ€œæ±Ÿæ¹–è€å¤§â€çš„åœ°ä½ã€‚</p><p><strong>RxBusåŸç†</strong></p><p>åœ¨RxJavaä¸­æœ‰ä¸ªSubjectç±»ï¼Œå®ƒç»§æ‰¿Observableç±»ï¼ŒåŒæ—¶å®ç°äº†Observeræ¥å£ï¼Œå› æ­¤Subjectå¯ä»¥åŒæ—¶æ‹…å½“è®¢é˜…è€…å’Œè¢«è®¢é˜…è€…çš„è§’è‰²ï¼Œæˆ‘ä»¬ä½¿ç”¨Subjectçš„å­ç±»PublishSubjectæ¥åˆ›å»ºä¸€ä¸ªSubjectå¯¹è±¡ï¼ˆPublishSubjectåªæœ‰è¢«è®¢é˜…åæ‰ä¼šæŠŠæ¥æ”¶åˆ°çš„äº‹ä»¶ç«‹åˆ»å‘é€ç»™è®¢é˜…è€…ï¼‰ï¼Œåœ¨éœ€è¦æ¥æ”¶äº‹ä»¶çš„åœ°æ–¹ï¼Œè®¢é˜…è¯¥Subjectå¯¹è±¡ï¼Œä¹‹åå¦‚æœSubjectå¯¹è±¡æ¥æ”¶åˆ°äº‹ä»¶ï¼Œåˆ™ä¼šå‘å°„ç»™è¯¥è®¢é˜…è€…ï¼Œæ­¤æ—¶Subjectå¯¹è±¡å……å½“è¢«è®¢é˜…è€…çš„è§’è‰²ã€‚</p><p>å®Œæˆäº†è®¢é˜…ï¼Œåœ¨éœ€è¦å‘é€äº‹ä»¶çš„åœ°æ–¹å°†äº‹ä»¶å‘é€ç»™ä¹‹å‰è¢«è®¢é˜…çš„Subjectå¯¹è±¡ï¼Œåˆ™æ­¤æ—¶Subjectå¯¹è±¡ä½œä¸ºè®¢é˜…è€…æ¥æ”¶äº‹ä»¶ï¼Œç„¶åä¼šç«‹åˆ»å°†äº‹ä»¶è½¬å‘ç»™è®¢é˜…è¯¥Subjectå¯¹è±¡çš„è®¢é˜…è€…ï¼Œä»¥ä¾¿è®¢é˜…è€…å¤„ç†ç›¸åº”äº‹ä»¶ï¼Œåˆ°è¿™é‡Œå°±å®Œæˆäº†äº‹ä»¶çš„å‘é€ä¸å¤„ç†ã€‚</p><p>æœ€åå°±æ˜¯å–æ¶ˆè®¢é˜…çš„æ“ä½œäº†ï¼ŒRxJavaä¸­ï¼Œè®¢é˜…æ“ä½œä¼šè¿”å›ä¸€ä¸ªSubscriptionå¯¹è±¡ï¼Œä»¥ä¾¿åœ¨åˆé€‚çš„æ—¶æœºå–æ¶ˆè®¢é˜…ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œå¦‚æœä¸€ä¸ªç±»äº§ç”Ÿå¤šä¸ªSubscriptionå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªCompositeSubscriptionå­˜å‚¨èµ·æ¥ï¼Œä»¥è¿›è¡Œæ‰¹é‡çš„å–æ¶ˆè®¢é˜…ã€‚</p><p><strong>RxBusæœ‰å¾ˆå¤šå®ç°ï¼Œå¦‚ï¼š</strong></p><blockquote><p>AndroidKnife/RxBusï¼ˆhttps://github.com/AndroidKnife/RxBusï¼‰</p><p>Blankj/RxBusï¼ˆhttps://github.com/Blankj/RxBusï¼‰</p></blockquote><p>å…¶å®æ­£å¦‚å‰é¢æ‰€è¯´çš„ï¼ŒRxBusçš„åŸç†æ˜¯å¦‚æ­¤ç®€å•ï¼Œæˆ‘ä»¬è‡ªå·±éƒ½å¯ä»¥å†™å‡ºä¸€ä¸ªRxBusçš„å®ç°ï¼š</p><p><strong>åŸºäºRxJava1çš„RxBuså®ç°ï¼š</strong></p><blockquote><p>public final class RxBus {</p><p>private final Subject&lt;Object, Object> bus;</p><p>private RxBus() {</p><p>bus = new SerializedSubject&lt;>(PublishSubject.create());</p><p>}</p><p>private static class SingletonHolder {</p><p>private static final RxBus defaultRxBus = new RxBus();</p><p>}</p><p>public static RxBus getInstance() {</p><p>return SingletonHolder.defaultRxBus;</p><p>}</p><p>/*</p><p>* å‘é€</p><p>*/</p><p>public void post(Object o) {</p><p>bus.onNext(o);</p><p>}</p><p>/*</p><p>* æ˜¯å¦æœ‰Observableè®¢é˜…</p><p>*/</p><p>public boolean hasObservable() {</p><p>return bus.hasObservers();</p><p>}</p><p>/*</p><p>* è½¬æ¢ä¸ºç‰¹å®šç±»å‹çš„Obserbale</p><p>*/</p><p>public &lt;T> Observable&lt;T> toObservable(Class&lt;T> type) {</p><p>return bus.ofType(type);</p><p>}</p><p>}</p></blockquote><p><strong>åŸºäºRxJava2çš„RxBuså®ç°ï¼š</strong></p><blockquote><p>public final class RxBus2 {</p><p>private final Subject&lt;Object> bus;</p><p>private RxBus2() {</p><p>// toSerialized method made bus thread safe</p><p>bus = PublishSubject.create().toSerialized();</p><p>}</p><p>public static RxBus2 getInstance() {</p><p>return Holder.BUS;</p><p>}</p><p>private static class Holder {</p><p>private static final RxBus2 BUS = new RxBus2();</p><p>}</p><p>public void post(Object obj) {</p><p>bus.onNext(obj);</p><p>}</p><p>public &lt;T> Observable&lt;T> toObservable(Class&lt;T> tClass) {</p><p>return bus.ofType(tClass);</p><p>}</p><p>public Observable&lt;Object> toObservable() {</p><p>return bus;</p><p>}</p><p>public boolean hasObservers() {</p><p>return bus.hasObservers();</p><p>}</p><p>}</p></blockquote><p><strong>å¼•å…¥LiveDataBusçš„æƒ³æ³•</strong></p><p><strong>ä»LiveDataè°ˆèµ·</strong></p><p>LiveDataæ˜¯Android Architecture Componentsæå‡ºçš„æ¡†æ¶ã€‚LiveDataæ˜¯ä¸€ä¸ªå¯ä»¥è¢«è§‚å¯Ÿçš„æ•°æ®æŒæœ‰ç±»ï¼Œå®ƒå¯ä»¥æ„ŸçŸ¥å¹¶éµå¾ªActivityã€Fragmentæˆ–Serviceç­‰ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚æ­£æ˜¯ç”±äºLiveDataå¯¹ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå¯æ„ŸçŸ¥ç‰¹ç‚¹ï¼Œå› æ­¤å¯ä»¥åšåˆ°ä»…åœ¨ç»„ä»¶å¤„äºç”Ÿå‘½å‘¨æœŸçš„æ¿€æ´»çŠ¶æ€æ—¶æ‰æ›´æ–°UIæ•°æ®ã€‚</p><p>LiveDataéœ€è¦ä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯Observerç±»çš„å…·ä½“å®ç°ã€‚å½“è§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸå¤„äºSTARTEDæˆ–RESUMEDçŠ¶æ€æ—¶ï¼ŒLiveDataä¼šé€šçŸ¥è§‚å¯Ÿè€…æ•°æ®å˜åŒ–ï¼›åœ¨è§‚å¯Ÿè€…å¤„äºå…¶ä»–çŠ¶æ€æ—¶ï¼Œå³ä½¿LiveDataçš„æ•°æ®å˜åŒ–äº†ï¼Œä¹Ÿä¸ä¼šé€šçŸ¥ã€‚</p><p><strong>LiveDataçš„ä¼˜ç‚¹</strong></p><ul><li><strong>UIå’Œå®æ—¶æ•°æ®ä¿æŒä¸€è‡´ï¼Œ</strong>å› ä¸ºLiveDataé‡‡ç”¨çš„æ˜¯è§‚å¯Ÿè€…æ¨¡å¼ï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥åœ¨æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶è·å¾—é€šçŸ¥ï¼Œæ›´æ–°UIã€‚</li><li><strong>é¿å…å†…å­˜æ³„æ¼ï¼Œ</strong>è§‚å¯Ÿè€…è¢«ç»‘å®šåˆ°ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸä¸Šï¼Œå½“è¢«ç»‘å®šçš„ç»„ä»¶é”€æ¯ï¼ˆdestroyï¼‰æ—¶ï¼Œè§‚å¯Ÿè€…ä¼šç«‹åˆ»è‡ªåŠ¨æ¸…ç†è‡ªèº«çš„æ•°æ®ã€‚</li><li><strong>ä¸ä¼šå†äº§ç”Ÿç”±äºActivityå¤„äºstopçŠ¶æ€è€Œå¼•èµ·çš„å´©æºƒï¼Œ</strong>ä¾‹å¦‚ï¼šå½“Activityå¤„äºåå°çŠ¶æ€æ—¶ï¼Œæ˜¯ä¸ä¼šæ”¶åˆ°LiveDataçš„ä»»ä½•äº‹ä»¶çš„ã€‚</li><li><strong>ä¸éœ€è¦å†è§£å†³ç”Ÿå‘½å‘¨æœŸå¸¦æ¥çš„é—®é¢˜ï¼Œ</strong>LiveDataå¯ä»¥æ„ŸçŸ¥è¢«ç»‘å®šçš„ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œåªæœ‰åœ¨æ´»è·ƒçŠ¶æ€æ‰ä¼šé€šçŸ¥æ•°æ®å˜åŒ–ã€‚</li><li><strong>å®æ—¶æ•°æ®åˆ·æ–°ï¼Œ</strong>å½“ç»„ä»¶å¤„äºæ´»è·ƒçŠ¶æ€æˆ–è€…ä»ä¸æ´»è·ƒçŠ¶æ€åˆ°æ´»è·ƒçŠ¶æ€æ—¶æ€»æ˜¯èƒ½æ”¶åˆ°æœ€æ–°çš„æ•°æ®ã€‚</li><li><strong>è§£å†³Configuration Changeé—®é¢˜ï¼Œ</strong>åœ¨å±å¹•å‘ç”Ÿæ—‹è½¬æˆ–è€…è¢«å›æ”¶å†æ¬¡å¯åŠ¨ï¼Œç«‹åˆ»å°±èƒ½æ”¶åˆ°æœ€æ–°çš„æ•°æ®ã€‚</li></ul><p>è°ˆä¸€è°ˆAndroid Architecture Components</p><p>Android Architecture Componentsçš„æ ¸å¿ƒæ˜¯Lifecycleã€LiveDataã€ViewModel ä»¥åŠ Roomï¼Œé€šè¿‡å®ƒå¯ä»¥éå¸¸ä¼˜é›…çš„è®©æ•°æ®ä¸ç•Œé¢è¿›è¡Œäº¤äº’ï¼Œå¹¶åšä¸€äº›æŒä¹…åŒ–çš„æ“ä½œï¼Œé«˜åº¦è§£è€¦ï¼Œè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œè€Œä¸”ä¸ç”¨æ‹…å¿ƒå†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚</p><ul><li><strong>Room</strong></li><li>ä¸€ä¸ªå¼ºå¤§çš„SQLiteå¯¹è±¡æ˜ å°„åº“ã€‚</li><li><strong>ViewModel</strong></li><li>ä¸€ç±»å¯¹è±¡ï¼Œå®ƒç”¨äºä¸ºUIç»„ä»¶æä¾›æ•°æ®ï¼Œåœ¨è®¾å¤‡é…ç½®å‘ç”Ÿå˜æ›´æ—¶ä¾æ—§å¯ä»¥å­˜æ´»ã€‚</li><li><strong>LiveData</strong> ä¸€ä¸ªå¯æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸã€å¯è¢«è§‚å¯Ÿçš„æ•°æ®å®¹å™¨ï¼Œå®ƒå¯ä»¥å­˜å‚¨æ•°æ®ï¼Œè¿˜ä¼šåœ¨æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶è¿›è¡Œæé†’ã€‚</li><li><strong>Lifecycle</strong></li><li>åŒ…å«LifeCycleOwerå’ŒLifecycleObserverï¼Œåˆ†åˆ«æ˜¯ç”Ÿå‘½å‘¨æœŸæ‰€æœ‰è€…å’Œç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥è€…ã€‚</li></ul><p><strong>Android Architecture Componentsçš„ç‰¹ç‚¹</strong></p><ul><li><strong>æ•°æ®é©±åŠ¨å‹ç¼–ç¨‹</strong></li><li>å˜åŒ–çš„æ°¸è¿œæ˜¯æ•°æ®ï¼Œç•Œé¢æ— éœ€æ›´æ”¹ã€‚</li><li><strong>æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</strong></li><li><strong>é«˜åº¦è§£è€¦</strong></li><li>æ•°æ®ï¼Œç•Œé¢é«˜åº¦åˆ†ç¦»ã€‚</li><li><strong>æ•°æ®æŒä¹…åŒ–</strong></li><li>æ•°æ®ã€ViewModelä¸ä¸ UIçš„ç”Ÿå‘½å‘¨æœŸæŒ‚é’©ï¼Œä¸ä¼šå› ä¸ºç•Œé¢çš„é‡å»ºè€Œé”€æ¯ã€‚</li></ul><p><strong>é‡ç‚¹ï¼šä¸ºä»€ä¹ˆä½¿ç”¨LiveDataæ„å»ºæ•°æ®é€šä¿¡æ€»çº¿LiveDataBus</strong></p><p><strong>ä½¿ç”¨LiveDataçš„ç†ç”±</strong></p><ul><li><strong>LiveDataå…·æœ‰çš„è¿™ç§å¯è§‚å¯Ÿæ€§å’Œç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥çš„èƒ½åŠ›ï¼Œä½¿å…¶éå¸¸é€‚åˆä½œä¸ºAndroidé€šä¿¡æ€»çº¿çš„åŸºç¡€æ„ä»¶ã€‚</strong></li><li><strong>ä½¿ç”¨è€…ä¸ç”¨æ˜¾ç¤ºè°ƒç”¨åæ³¨å†Œæ–¹æ³•ã€‚</strong></li><li>ç”±äºLiveDataå…·æœ‰ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥èƒ½åŠ›ï¼Œæ‰€ä»¥LiveDataBusåªéœ€è¦è°ƒç”¨æ³¨å†Œå›è°ƒæ–¹æ³•ï¼Œè€Œä¸éœ€è¦æ˜¾ç¤ºçš„è°ƒç”¨åæ³¨å†Œæ–¹æ³•ã€‚è¿™æ ·å¸¦æ¥çš„å¥½å¤„ä¸ä»…å¯ä»¥ç¼–å†™æ›´å°‘çš„ä»£ç ï¼Œè€Œä¸”å¯ä»¥å®Œå…¨æœç»å…¶ä»–é€šä¿¡æ€»çº¿ç±»æ¡†æ¶ï¼ˆå¦‚EventBusã€RxBusï¼‰å¿˜è®°è°ƒç”¨åæ³¨å†Œæ‰€å¸¦æ¥çš„å†…å­˜æ³„æ¼çš„é£é™©ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆè¦ç”¨LiveDataBusæ›¿ä»£EventBuså’ŒRxBus</strong></p><ul><li><strong>LiveDataBusçš„å®ç°åŠå…¶ç®€å•</strong>ï¼Œç›¸å¯¹EventBuså¤æ‚çš„å®ç°ï¼ŒLiveDataBusåªéœ€è¦ä¸€ä¸ªç±»å°±å¯ä»¥å®ç°ã€‚</li><li><strong>LiveDataBuså¯ä»¥å‡å°APKåŒ…çš„å¤§å°</strong>ï¼Œç”±äºLiveDataBusåªä¾èµ–Androidå®˜æ–¹Android Architecture Componentsç»„ä»¶çš„LiveDataï¼Œæ²¡æœ‰å…¶ä»–ä¾èµ–ï¼Œæœ¬èº«å®ç°åªæœ‰ä¸€ä¸ªç±»ã€‚ä½œä¸ºæ¯”è¾ƒï¼ŒEventBus JARåŒ…å¤§å°ä¸º57kbï¼ŒRxBusä¾èµ–RxJavaå’ŒRxAndroidï¼Œå…¶ä¸­RxJava2åŒ…å¤§å°2.2MBï¼ŒRxJava1åŒ…å¤§å°1.1MBï¼ŒRxAndroidåŒ…å¤§å°9kbã€‚ä½¿ç”¨LiveDataBuså¯ä»¥å¤§å¤§å‡å°APKåŒ…çš„å¤§å°ã€‚</li><li><strong>LiveDataBusä¾èµ–æ–¹æ”¯æŒæ›´å¥½</strong>ï¼ŒLiveDataBusåªä¾èµ–Androidå®˜æ–¹Android Architecture Componentsç»„ä»¶çš„LiveDataï¼Œç›¸æ¯”RxBusä¾èµ–çš„RxJavaå’ŒRxAndroidï¼Œä¾èµ–æ–¹æ”¯æŒæ›´å¥½ã€‚</li><li><strong>LiveDataBuså…·æœ‰ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥</strong>ï¼ŒLiveDataBuså…·æœ‰ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ï¼Œåœ¨Androidç³»ç»Ÿä¸­ä½¿ç”¨è°ƒç”¨è€…ä¸éœ€è¦è°ƒç”¨åæ³¨å†Œï¼Œç›¸æ¯”EventBuså’ŒRxBusä½¿ç”¨æ›´ä¸ºæ–¹ä¾¿ï¼Œå¹¶ä¸”æ²¡æœ‰å†…å­˜æ³„æ¼é£é™©ã€‚</li></ul><p><strong>LiveDataBusçš„è®¾è®¡å’Œæ¶æ„</strong></p><p><strong>LiveDataBusçš„ç»„æˆ</strong></p><ul><li><strong>æ¶ˆæ¯</strong></li><li>æ¶ˆæ¯å¯ä»¥æ˜¯ä»»ä½•çš„Objectï¼Œå¯ä»¥å®šä¹‰ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼Œå¦‚Booleanã€Stringã€‚ä¹Ÿå¯ä»¥å®šä¹‰è‡ªå®šä¹‰ç±»å‹çš„æ¶ˆæ¯ã€‚</li><li><strong>æ¶ˆæ¯é€šé“</strong></li><li>LiveDataæ‰®æ¼”äº†æ¶ˆæ¯é€šé“çš„è§’è‰²ï¼Œä¸åŒçš„æ¶ˆæ¯é€šé“ç”¨ä¸åŒçš„åå­—åŒºåˆ†ï¼Œåå­—æ˜¯Stringç±»å‹çš„ï¼Œå¯ä»¥é€šè¿‡åå­—è·å–åˆ°ä¸€ä¸ªLiveDataæ¶ˆæ¯é€šé“ã€‚</li><li><strong>æ¶ˆæ¯æ€»çº¿</strong></li><li>æ¶ˆæ¯æ€»çº¿é€šè¿‡å•ä¾‹å®ç°ï¼Œä¸åŒçš„æ¶ˆæ¯é€šé“å­˜æ”¾åœ¨ä¸€ä¸ªHashMapä¸­ã€‚</li><li><strong>è®¢é˜…</strong></li><li>è®¢é˜…è€…é€šè¿‡getChannelè·å–æ¶ˆæ¯é€šé“ï¼Œç„¶åè°ƒç”¨observeè®¢é˜…è¿™ä¸ªé€šé“çš„æ¶ˆæ¯ã€‚</li><li><strong>å‘å¸ƒ</strong></li><li>å‘å¸ƒè€…é€šè¿‡getChannelè·å–æ¶ˆæ¯é€šé“ï¼Œç„¶åè°ƒç”¨setValueæˆ–è€…postValueå‘å¸ƒæ¶ˆæ¯ã€‚</li></ul><p><strong>LiveDataBusåŸç†å›¾</strong></p><div class=pgc-img><img alt=Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1532605879297c275574cb1><p class=pgc-img-caption></p></div><p><strong>LiveDataBusçš„å®ç°</strong></p><p><strong>ç¬¬ä¸€ä¸ªå®ç°ï¼š</strong></p><blockquote><p>public final class LiveDataBus {</p><p>private final Map&lt;String, MutableLiveData&lt;Object>> bus;</p><p>private LiveDataBus() {</p><p>bus = new HashMap&lt;>();</p><p>}</p><p>private static class SingletonHolder {</p><p>private static final LiveDataBus DATA_BUS = new LiveDataBus();</p><p>}</p><p>public static LiveDataBus get() {</p><p>return SingletonHolder.DATA_BUS;</p><p>}</p><p>public &lt;T> MutableLiveData&lt;T> getChannel(String target, Class&lt;T> type) {</p><p>if (!bus.containsKey(target)) {</p><p>bus.put(target, new MutableLiveData&lt;>());</p><p>}</p><p>return (MutableLiveData&lt;T>) bus.get(target);</p><p>}</p><p>public MutableLiveData&lt;Object> getChannel(String target) {</p><p>return getChannel(target, Object.class);</p><p>}</p><p>}</p></blockquote><p>çŸ­çŸ­äºŒåè¡Œä»£ç ï¼Œå°±å®ç°äº†ä¸€ä¸ªé€šä¿¡æ€»çº¿çš„å…¨éƒ¨åŠŸèƒ½ï¼Œå¹¶ä¸”è¿˜å…·æœ‰ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥åŠŸèƒ½ï¼Œå¹¶ä¸”ä½¿ç”¨èµ·æ¥ä¹ŸåŠå…¶ç®€å•ï¼š</p><p><strong>æ³¨å†Œè®¢é˜…ï¼š</strong></p><blockquote><p>LiveDataBus.get().getChannel("key_test", Boolean.class)</p><p>.observe(this, new Observer&lt;Boolean>() {</p><p>@Override</p><p>public void onChanged(@Nullable Boolean aBoolean) {</p><p>}</p><p>});</p></blockquote><p><strong>å‘é€æ¶ˆæ¯ï¼š</strong></p><blockquote><p>LiveDataBus.get().getChannel("key_test").setValue(true);</p></blockquote><p>æˆ‘ä»¬å‘é€äº†ä¸€ä¸ªåä¸º"key_test"ï¼Œå€¼ä¸ºtrueçš„äº‹ä»¶ã€‚</p><p>è¿™ä¸ªæ—¶å€™è®¢é˜…è€…å°±ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œå¹¶ä½œç›¸åº”çš„å¤„ç†ï¼Œéå¸¸ç®€å•ã€‚</p><p><strong>é—®é¢˜å‡ºç°</strong></p><p>å¯¹äºLiveDataBusçš„ç¬¬ä¸€ç‰ˆå®ç°ï¼Œæˆ‘ä»¬å‘ç°ï¼Œåœ¨ä½¿ç”¨è¿™ä¸ªLiveDataBusçš„è¿‡ç¨‹ä¸­ï¼Œè®¢é˜…è€…ä¼šæ”¶åˆ°è®¢é˜…ä¹‹å‰å‘å¸ƒçš„æ¶ˆæ¯ã€‚å¯¹äºä¸€ä¸ªæ¶ˆæ¯æ€»çº¿æ¥è¯´ï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„ã€‚æ— è®ºEventBusæˆ–è€…RxBusï¼Œè®¢é˜…æ–¹éƒ½ä¸ä¼šæ”¶åˆ°è®¢é˜…ä¹‹å‰å‘å‡ºçš„æ¶ˆæ¯ã€‚å¯¹äºä¸€ä¸ªæ¶ˆæ¯æ€»çº¿ï¼ŒLiveDataBuså¿…é¡»è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p><strong>é—®é¢˜åˆ†æ</strong></p><p>æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå…ˆåˆ†æä¸‹åŸå› ï¼š</p><p>å½“LifeCircleOwnerçš„çŠ¶æ€å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨LiveData.ObserverWrapperçš„activeStateChangedå‡½æ•°ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ObserverWrapperçš„çŠ¶æ€æ˜¯activeï¼Œå°±ä¼šè°ƒç”¨LiveDataçš„dispatchingValueã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15326058791517f12641571><p class=pgc-img-caption></p></div><p>åœ¨LiveDataçš„dispatchingValueä¸­ï¼Œåˆä¼šè°ƒç”¨LiveDataçš„considerNotifyæ–¹æ³•ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15326058792210910f8b537><p class=pgc-img-caption></p></div><p>åœ¨LiveDataçš„considerNotifyæ–¹æ³•ä¸­ï¼Œçº¢æ¡†ä¸­çš„é€»è¾‘æ˜¯å…³é”®ï¼Œå¦‚æœObserverWrapperçš„mLastVersionå°äºLiveDataçš„mVersionï¼Œå°±ä¼šå»å›è°ƒmObserverçš„onChangedæ–¹æ³•ã€‚è€Œæ¯ä¸ªæ–°çš„è®¢é˜…è€…ï¼Œå…¶versionéƒ½æ˜¯-1ï¼ŒLiveDataä¸€æ—¦è®¾ç½®è¿‡å…¶versionæ˜¯å¤§äº-1çš„ï¼ˆæ¯æ¬¡LiveDataè®¾ç½®å€¼éƒ½ä¼šä½¿å…¶versionåŠ 1ï¼‰ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´LiveDataBusæ¯æ³¨å†Œä¸€ä¸ªæ–°çš„è®¢é˜…è€…ï¼Œè¿™ä¸ªè®¢é˜…è€…ç«‹åˆ»ä¼šæ”¶åˆ°ä¸€ä¸ªå›è°ƒï¼Œå³ä½¿è¿™ä¸ªè®¾ç½®çš„åŠ¨ä½œå‘ç”Ÿåœ¨è®¢é˜…ä¹‹å‰ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/153260587914599287f92a0><p class=pgc-img-caption></p></div><p><strong>é—®é¢˜åŸå› æ€»ç»“</strong></p><p>å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæ€»ç»“ä¸€ä¸‹å‘ç”Ÿçš„æ ¸å¿ƒåŸå› ã€‚å¯¹äºLiveDataï¼Œå…¶åˆå§‹çš„versionæ˜¯-1ï¼Œå½“æˆ‘ä»¬è°ƒç”¨äº†å…¶setValueæˆ–è€…postValueï¼Œå…¶vesionä¼š+1ï¼›å¯¹äºæ¯ä¸€ä¸ªè§‚å¯Ÿè€…çš„å°è£…ObserverWrapperï¼Œå…¶åˆå§‹versionä¹Ÿä¸º-1ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸€ä¸ªæ–°æ³¨å†Œçš„è§‚å¯Ÿè€…ï¼Œå…¶versionä¸º-1ï¼›å½“LiveDataè®¾ç½®è¿™ä¸ªObserverWrapperçš„æ—¶å€™ï¼Œå¦‚æœLiveDataçš„versionå¤§äºObserverWrapperçš„versionï¼ŒLiveDataå°±ä¼šå¼ºåˆ¶æŠŠå½“å‰valueæ¨é€ç»™Observerã€‚</p><p><strong>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜</strong></p><p>æ˜ç™½äº†é—®é¢˜äº§ç”Ÿçš„åŸå› ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆæ‰èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¾ˆæ˜¾ç„¶ï¼Œæ ¹æ®ä¹‹å‰çš„åˆ†æï¼Œåªéœ€è¦åœ¨æ³¨å†Œä¸€ä¸ªæ–°çš„è®¢é˜…è€…çš„æ—¶å€™æŠŠWrapperçš„versionè®¾ç½®æˆè·ŸLiveDataçš„versionä¸€è‡´å³å¯ã€‚</p><p>é‚£ä¹ˆæ€ä¹ˆå®ç°å‘¢ï¼Œçœ‹çœ‹LiveDataçš„observeæ–¹æ³•ï¼Œä»–ä¼šåœ¨æ­¥éª¤1åˆ›å»ºä¸€ä¸ªLifecycleBoundObserverï¼ŒLifecycleBoundObserveræ˜¯ObserverWrapperçš„æ´¾ç”Ÿç±»ã€‚ç„¶åä¼šåœ¨æ­¥éª¤2æŠŠè¿™ä¸ªLifecycleBoundObserveræ”¾å…¥ä¸€ä¸ªç§æœ‰Mapå®¹å™¨mObserversä¸­ã€‚æ— è®ºObserverWrapperè¿˜æ˜¯LifecycleBoundObserveréƒ½æ˜¯ç§æœ‰çš„æˆ–è€…åŒ…å¯è§çš„ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡ç»§æ‰¿çš„æ–¹å¼æ›´æ”¹LifecycleBoundObserverçš„versionã€‚</p><p>é‚£ä¹ˆèƒ½ä¸èƒ½ä»Mapå®¹å™¨mObserversä¸­å–åˆ°LifecycleBoundObserverï¼Œç„¶åå†æ›´æ”¹versionå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé€šè¿‡æŸ¥çœ‹SafeIterableMapçš„æºç æˆ‘ä»¬å‘ç°æœ‰ä¸€ä¸ªprotectedçš„getæ–¹æ³•ã€‚å› æ­¤ï¼Œåœ¨è°ƒç”¨observeçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°LifecycleBoundObserverï¼Œå†æŠŠLifecycleBoundObserverçš„versionè®¾ç½®æˆå’ŒLiveDataä¸€è‡´å³å¯ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153260587956410d5916b87><p class=pgc-img-caption></p></div><p>å¯¹äºéç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥çš„observeForeveræ–¹æ³•æ¥è¯´ï¼Œå®ç°çš„æ€è·¯æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°ç•¥æœ‰ä¸åŒã€‚observeForeverçš„æ—¶å€™ï¼Œç”Ÿæˆçš„wrapperä¸æ˜¯LifecycleBoundObserverï¼Œè€Œæ˜¯AlwaysActiveObserverï¼ˆæ­¥éª¤1ï¼‰ï¼Œè€Œä¸”æˆ‘ä»¬ä¹Ÿæ²¡æœ‰æœºä¼šåœ¨observeForeverè°ƒç”¨å®Œæˆä¹‹åå†å»æ›´æ”¹AlwaysActiveObserverçš„versionï¼Œå› ä¸ºåœ¨observeForeveræ–¹æ³•ä½“å†…ï¼Œæ­¥éª¤3çš„è¯­å¥ï¼Œå›è°ƒå°±å‘ç”Ÿäº†ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1532605879463daf62b18de><p class=pgc-img-caption></p></div><p>é‚£ä¹ˆå¯¹äºobserveForeverï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæ—¢ç„¶æ˜¯åœ¨è°ƒç”¨å†…å›è°ƒçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªObserverWrapperï¼ŒæŠŠçœŸæ­£çš„å›è°ƒç»™åŒ…è£…èµ·æ¥ã€‚æŠŠObserverWrapperä¼ ç»™observeForeverï¼Œé‚£ä¹ˆåœ¨å›è°ƒçš„æ—¶å€™æˆ‘ä»¬å»æ£€æŸ¥è°ƒç”¨æ ˆï¼Œå¦‚æœå›è°ƒæ˜¯observeForeveræ–¹æ³•å¼•èµ·çš„ï¼Œé‚£ä¹ˆå°±ä¸å›è°ƒçœŸæ­£çš„è®¢é˜…è€…ã€‚</p><p><strong>LiveDataBusæœ€ç»ˆå®ç°</strong></p><blockquote><p>public final class LiveDataBus {</p><p>private final Map&lt;String, BusMutableLiveData&lt;Object>> bus;</p><p>private LiveDataBus() {</p><p>bus = new HashMap&lt;>();</p><p>}</p><p>private static class SingletonHolder {</p><p>private static final LiveDataBus DEFAULT_BUS = new LiveDataBus();</p><p>}</p><p>public static LiveDataBus get() {</p><p>return SingletonHolder.DEFAULT_BUS;</p><p>}</p><p>public &lt;T> MutableLiveData&lt;T> with(String key, Class&lt;T> type) {</p><p>if (!bus.containsKey(key)) {</p><p>bus.put(key, new BusMutableLiveData&lt;>());</p><p>}</p><p>return (MutableLiveData&lt;T>) bus.get(key);</p><p>}</p><p>public MutableLiveData&lt;Object> with(String key) {</p><p>return with(key, Object.class);</p><p>}</p><p>private static class ObserverWrapper&lt;T> implements Observer&lt;T> {</p><p>private Observer&lt;T> observer;</p><p>public ObserverWrapper(Observer&lt;T> observer) {</p><p>this.observer = observer;</p><p>}</p><p>@Override</p><p>public void onChanged(@Nullable T t) {</p><p>if (observer != null) {</p><p>if (isCallOnObserve()) {</p><p>return;</p><p>}</p><p>observer.onChanged(t);</p><p>}</p><p>}</p><p>private boolean isCallOnObserve() {</p><p>StackTraceElement[] stackTrace = Thread.currentThread().getStackTrace();</p><p>if (stackTrace != null && stackTrace.length > 0) {</p><p>for (StackTraceElement element : stackTrace) {</p><p>if ("android.arch.lifecycle.LiveData".equals(element.getClassName()) &&</p><p>"observeForever".equals(element.getMethodName())) {</p><p>return true;</p><p>}</p><p>}</p><p>}</p><p>return false;</p><p>}</p><p>}</p><p>private static class BusMutableLiveData&lt;T> extends MutableLiveData&lt;T> {</p><p>private Map&lt;Observer, Observer> observerMap = new HashMap&lt;>();</p><p>@Override</p><p>public void observe(@NonNull LifecycleOwner owner, @NonNull Observer&lt;T> observer) {</p><p>super.observe(owner, observer);</p><p>try {</p><p>hook(observer);</p><p>} catch (Exception e) {</p><p>e.printStackTrace();</p><p>}</p><p>}</p><p>@Override</p><p>public void observeForever(@NonNull Observer&lt;T> observer) {</p><p>if (!observerMap.containsKey(observer)) {</p><p>observerMap.put(observer, new ObserverWrapper(observer));</p><p>}</p><p>super.observeForever(observerMap.get(observer));</p><p>}</p><p>@Override</p><p>public void removeObserver(@NonNull Observer&lt;T> observer) {</p><p>Observer realObserver = null;</p><p>if (observerMap.containsKey(observer)) {</p><p>realObserver = observerMap.remove(observer);</p><p>} else {</p><p>realObserver = observer;</p><p>}</p><p>super.removeObserver(realObserver);</p><p>}</p><p>private void hook(@NonNull Observer&lt;T> observer) throws Exception {</p><p>//get wrapper's version</p><p>Class&lt;LiveData> classLiveData = LiveData.class;</p><p>Field fieldObservers = classLiveData.getDeclaredField("mObservers");</p><p>fieldObservers.setAccessible(true);</p><p>Object objectObservers = fieldObservers.get(this);</p><p>Class&lt;?> classObservers = objectObservers.getClass();</p><p>Method methodGet = classObservers.getDeclaredMethod("get", Object.class);</p><p>methodGet.setAccessible(true);</p><p>Object objectWrapperEntry = methodGet.invoke(objectObservers, observer);</p><p>Object objectWrapper = null;</p><p>if (objectWrapperEntry instanceof Map.Entry) {</p><p>objectWrapper = ((Map.Entry) objectWrapperEntry).getValue();</p><p>}</p><p>if (objectWrapper == null) {</p><p>throw new NullPointerException("Wrapper can not be bull!");</p><p>}</p><p>Class&lt;?> classObserverWrapper = objectWrapper.getClass().getSuperclass();</p><p>Field fieldLastVersion = classObserverWrapper.getDeclaredField("mLastVersion");</p><p>fieldLastVersion.setAccessible(true);</p><p>//get livedata's version</p><p>Field fieldVersion = classLiveData.getDeclaredField("mVersion");</p><p>fieldVersion.setAccessible(true);</p><p>Object objectVersion = fieldVersion.get(this);</p><p>//set wrapper's version</p><p>fieldLastVersion.set(objectWrapper, objectVersion);</p><p>}</p><p>}</p><p>}</p></blockquote><p><strong>æ³¨å†Œè®¢é˜…ï¼š</strong></p><blockquote><p>LiveDataBus.get()</p><p>.with("key_test", String.class)</p><p>.observe(this, new Observer&lt;String>() {</p><p>@Override</p><p>public void onChanged(@Nullable String s) {</p><p>}</p><p>});</p></blockquote><p><strong>å‘é€æ¶ˆæ¯ï¼š</strong></p><blockquote><p>LiveDataBus.get().with("key_test").setValue(s);</p></blockquote><p><strong>æºç è¯´æ˜</strong></p><p>LiveDataBusçš„æºç å¯ä»¥ç›´æ¥æ‹·è´ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å‰å¾€ä½œè€…çš„GitHubä»“åº“æŸ¥çœ‹ä¸‹è½½ï¼š</p><blockquote><p>https://github.com/JeremyLiao/LiveDataBus</p></blockquote><p><strong>æ€»ç»“</strong></p><p>æœ¬æ–‡æä¾›äº†ä¸€ä¸ªæ–°çš„æ¶ˆæ¯æ€»çº¿æ¡†æ¶â€”â€”LiveDataBusã€‚è®¢é˜…è€…å¯ä»¥è®¢é˜…æŸä¸ªæ¶ˆæ¯é€šé“çš„æ¶ˆæ¯ï¼Œå‘å¸ƒè€…å¯ä»¥æŠŠæ¶ˆæ¯å‘å¸ƒåˆ°æ¶ˆæ¯é€šé“ä¸Šã€‚åˆ©ç”¨LiveDataBusï¼Œä¸ä»…å¯ä»¥å®ç°æ¶ˆæ¯æ€»çº¿åŠŸèƒ½ï¼Œè€Œä¸”å¯¹äºè®¢é˜…è€…ï¼Œä»–ä»¬ä¸éœ€è¦å…³å¿ƒä½•æ—¶å–æ¶ˆè®¢é˜…ï¼Œæå¤§å‡å°‘äº†å› ä¸ºå¿˜è®°å–æ¶ˆè®¢é˜…é€ æˆçš„å†…å­˜æ³„æ¼é£é™©ã€‚</p><p><strong>ä½œè€…ç®€ä»‹</strong></p><p>æµ·äº®ï¼Œç¾å›¢é«˜çº§å·¥ç¨‹å¸ˆï¼Œ2017å¹´åŠ å…¥ç¾å›¢ï¼Œç›®å‰ä¸»è¦è´Ÿè´£ç¾å›¢è½»æ”¶é“¶ã€ç¾å›¢æ”¶é“¶é›¶å”®ç‰ˆç­‰Appçš„ç›¸å…³ä¸šåŠ¡åŠæ¨¡å—å¼€å‘å·¥ä½œã€‚</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Android','æ€»çº¿','æ¼”è¿›'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>