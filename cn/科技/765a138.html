<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>回复关键词的无限扩展机制 | 极客快訊</title><meta property="og:title" content="回复关键词的无限扩展机制 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/f7aeaf983fb1468ab77f5368d88fd7ac"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/765a138.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/765a138.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/765a138.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/765a138.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/765a138.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/765a138.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/765a138.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/765a138.html><meta property="article:published_time" content="2020-10-29T21:06:50+08:00"><meta property="article:modified_time" content="2020-10-29T21:06:50+08:00"><meta name=Keywords content><meta name=description content="回复关键词的无限扩展机制"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/765a138.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>回复关键词的无限扩展机制</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>引言</strong></p><p>在微信公众号的开发中，自动回复关键词主要可回复的内容为文本消息、图文消息（目前仅支持一个链接）。为了让关键词支持“<strong>带参数</strong>” 和 <strong>无限扩展</strong>，本文引入一个对接关键词的接口规范，使得关键词可以携参数一起交由第三方处理，并返回用户文本消息或图文消息。</p><p>基本原理：为关键词配置回调地址，关键词与参数使用空格分隔，第一个空格后边的均为参数，公众号在接收到用户文本消息后，解析关键词与参数，并根据配置将其发送请求给回调地址，获取返回的处理结果。</p><p>本文主要介绍接口的定义，并提供一个具体的接口实现。</p><p><strong>1 接口约定</strong></p><p><strong>1.1 传入参数</strong></p><p>作为 Request.Body 请求体 POST 给回调地址。</p><pre>{ "keyword" : "Keyword", "parameter" : "Parameters string", "user" : "useropenid"}</pre><p><strong>1.2 返回格式</strong></p><p>返回结果为 JSON 形式，要求必须有 err_code 与 err_msg 属性，其中 err_code 为状态码，状态码为 200 时，表示成功，其它表示失败。err_msg 表示消息描述。如：</p><pre>{ "err_code" : 101, "err_msg" : "操作失败！"}</pre><p>当成功时，支持返回“文字”与“链接”两种类型的消息。</p><p>使用 key_type 属性表示，可取值“文字”或"链接"。</p><p>当 key_type 为“文字”的时候，data 为相应的文本内容。</p><p>当 key_type 为“链接”的时候，data 为链接信息的数组，只是目前只支持一个链接。</p><p>链接的属性包括：</p><p>title : 标题</p><p>icon : 图标</p><p>note_desc : 描述</p><p>url : 链接地址</p><p><strong>1.3 文字类型示例</strong></p><pre>{ "err_code" : 101, "err_msg" : "操作失败！", "key_type" : "文字", "data" : "回复的内容"}</pre><p><strong>1.4 链接类型示例</strong></p><pre>{ "err_code" : 101, "err_msg" : "操作失败！", "key_type" : "链接", "data" : [ { "title" : "一个数学公式", "icon" : "http://****/formula.png", "note_desc" : "一个神寄的数学公式", "url" : "http://****" } ]}</pre><p><strong>2 关键词接口示例</strong></p><p>以下为一个完整的接口实现示例。</p><p><strong>2.1 功能需求描述</strong></p><p>关键词：<strong>提取</strong></p><p>参数：一段文本或仅是一个 url</p><p>功能描述：从文本中提取出邮箱、手机号、身份证号、IPv4 地址（可进一步补充与完善）。如果参数仅是一个 url，则进行提取的文本为请求该 url 所得的内容。</p><p><strong>2.2 实现过程</strong></p><p>流程：是否仅为url -> 是则请求url 得到内容 -> 根据正则表达式提取匹配数据 -> 根据长度返回文本消息 或是 返回一个可操作界面的链接。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=回复关键词的无限扩展机制 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f7aeaf983fb1468ab77f5368d88fd7ac><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p><strong>2.2.1 准备好匹配的正则表达式</strong></p><pre>private static Dictionary&lt;string, string&gt; _RegexDict;public static Dictionary&lt;string, string&gt; RegexDict{ get { if (_RegexDict == null) { _RegexDict = new Dictionary&lt;string, string&gt;(); // _RegexDict.Add("链接", @"((ht)tps?):\/\/[\w\-]+(\.[\w\-]+)+([\w\-.,@?^=%&amp;:\/~+#]*[\w\-@?^=%&amp;\/~+#])?");  _RegexDict.Add("邮箱", @"[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+"); _RegexDict.Add("手机号", @"(((13[0-9]{1})|(14[0-9]{1})|(15[0-9]{1})|(17[0-9]{1})|(18[0-9]{1})|(19[0-9]{1}))+\d{8})"); _RegexDict.Add("身份证号", @"[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]"); _RegexDict.Add("IPv4地址", @"(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])"); } return _RegexDict; }}</pre><p><strong>2.2.2 处理过程</strong></p><p>一个工具方法，请求 url 获取内容。</p><pre>public static string GetUrlContent(string url){ System.Net.WebClient webClientObj = new System.Net.WebClient(); webClientObj.Encoding = Encoding.UTF8; string respInfo = webClientObj.DownloadString(url); return respInfo;}</pre><p>处理流程实现，建立一个 WebApi，代码如是说。</p><pre>public JObject Index([FromBody] JObject body){ string keyword = body.Value&lt;string&gt;("keyword"); string parameter = body.Value&lt;string&gt;("parameter"); string user = body.Value&lt;string&gt;("user"); JObject result = new JObject(); if (!"提取".Equals(keyword)) { result["err_code"] = 101; result["err_msg"] = "关键词未找到"; return result; } //// 处理过程  var content = parameter; var regUrl = @"^((ht)tps?):\/\/[\w\-]+(\.[\w\-]+)+([\w\-.,@?^=%&amp;:\/~+#]*[\w\-@?^=%&amp;\/~+#])?$";  // (1) 为网址吗 if (Regex.IsMatch(content, regUrl)) { try { content = GetUrlContent(content); } catch (Exception ue) { result["err_code"] = 101; result["err_msg"] = "站点无法连接！"; return result; } }  //（2）根据正则表达式提取 Dictionary&lt;string, List&lt;string&gt;&gt; typeMatches = new Dictionary&lt;string, List&lt;string&gt;&gt;(); foreach (var kv in RegexDict) { List&lt;string&gt; list = new List&lt;string&gt;(); var mc = Regex.Matches(content, kv.Value, RegexOptions.IgnoreCase); foreach (Match c in mc) { list.Add(c.Value); } if (list.Count &gt; 0) { typeMatches.Add(kv.Key, list); } } //（3）拼成字符串 StringBuilder sb = new StringBuilder(1024); foreach (var kv in typeMatches) { sb.Append(kv.Key + "\n" + String.Join("\n", kv.Value) + "\n");  } //（4）长度&lt;1020 文本消息 if (sb.Length &lt; 1020) { result["err_code"] = 200; result["err_msg"] = "success"; result["key_type"] = "文字"; result["data"] = sb.Length == 0 ? "无匹配内容！" : sb.ToString(); return result; } //（5）长度较大，返回工具链接 JObject link = new JObject(); link["title"] = "提取内容中的格式化数据信息"; link["icon"] = "http://www.timeddd.com/Content/images/logo_bar.png"; link["note_desc"] = "指定链接地址或文本内容，从中提取一些常格式数据，如邮箱、手机号、链接、身份证号等信息！"; link["url"] = "http://www.timeddd.com/Tool/Fetch"; JArray links = new JArray(); links.Add(link); result["err_code"] = 200; result["err_msg"] = "success"; result["key_type"] = "链接"; result["data"] = links; return result; }</pre><p><strong>3 效果</strong></p><p>在公众号“时间维度”中，回复关键词提取，空格带上内容，如下：</p><blockquote><p>提取 各种格式的邮箱入下所示：kevintian126@126.com ，1136667341@qq.com3. meiya@cn-meiya.com 4. wq901200@hotmail.com 5. meiyahr@163.com 6. meiyuan@0757info.com 7. chingpeplo@sina.com 8. tony@erene.com.com 9. melodylu@buynow.com</p></blockquote><p>会得到以下结果：</p><blockquote><p>邮箱</p><p>kevintian126@126.com</p><p>1136667341@qq.com</p><p>meiya@cn-meiya.com</p><p>wq901200@hotmail.com</p><p>meiyahr@163.com</p><p>meiyuan@0757info.com</p><p>chingpeplo@sina.com</p><p>tony@erene.com.com</p><p>melodylu@buynow.com</p></blockquote><p>回复：</p><blockquote><p>提取 https://www.nhxz.com/doc/181017fc325d4b598aaede18.html</p></blockquote><p>会得到：</p><blockquote><p>邮箱</p><p>kevintian126@126.com</p><p>1136667341@qq.com</p><p>meiya@cn-meiya.com</p><p>wq901200@hotmail.com</p><p>meiyahr@163.com</p><p>meiyuan@0757info.com</p><p>chingpeplo@sina.com</p><p>tony@erene.com.com</p><p>melodylu@buynow.com</p><p>xxxxxx@163.com</p><p>123321@126.com</p><p>手机号</p><p>15758523729</p><p>18101710555</p><p>18300405945</p><p>身份证号</p><p>560087183004059455</p></blockquote><p><strong>3 招募关键词</strong></p><p>给定一个<strong>关键词</strong>，一个<strong>接收关键词及参数的 URL 地址</strong>，按约定的格式返回 JSON，就有可能成为“时间维度”公众号里的实用工具供大家使用。如有兴趣欢迎在“时间维度”留言。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'关键','无限','扩展'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>