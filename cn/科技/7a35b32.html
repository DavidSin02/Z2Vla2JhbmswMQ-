<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Java Springboot 多线程 异步调用 全解析 | 极客快訊</title><meta property="og:title" content="Java Springboot 多线程 异步调用 全解析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/6fb9fe1b67c24d5cb9f50727c3dc81e7"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7a35b32.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7a35b32.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7a35b32.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7a35b32.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7a35b32.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7a35b32.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7a35b32.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7a35b32.html><meta property="article:published_time" content="2020-10-29T20:59:18+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:18+08:00"><meta name=Keywords content><meta name=description content="Java Springboot 多线程 异步调用 全解析"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/7a35b32.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Java Springboot 多线程 异步调用 全解析</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>本文主要介绍Springboot异步调用，包括：</strong></p><p><strong>1、Springboot同步调用演示；</strong></p><p><strong>2、Springboot两种异步调用方式；</strong></p><p><strong>3、Springboot使用注解的异步调用方式详解；</strong></p><p><strong>4、Springboot使用注解异步调用时的异常处理；</strong></p><p><strong>5、利用Future获取异步子线程的执行结果；</strong></p><p><strong>6、Springboot使用注解异步调用与事务一起使用时的注意事项；</strong></p><p><strong>7、Springboot异步调用时多线程池实现；</strong></p><p><strong>8、Springboot使用注解异步调用失效的原因汇总；</strong></p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6fb9fe1b67c24d5cb9f50727c3dc81e7><p class=pgc-img-caption>图0</p></div><p><strong>1、Springboot同步调用演示，</strong>如下面图1所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/67458bce1b204f1fbede48155bea29fb><p class=pgc-img-caption>图1</p></div><p>我们在thread2方法中打印出调用线程名和调用前后时间以及间隔时间。</p><p>结果如下面图2所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/34b77decfe2e4851a9b9b5a3ddd44c4c><p class=pgc-img-caption>图2</p></div><p>程序3秒后返回并打印出的结果和我们的预期一样。</p><p><strong>2、Springboot两种异步调用方式</strong></p><p>异步调用的效果就是主线程可以提前返回，然后交由任务子线程进行处理。</p><p>下面会介绍Springboot异步调用的两种方式，并着重介绍最常用的第二种方式。</p><p><strong>&lt;1、自定义线程类；</strong></p><p><strong>&lt;2、使用@Async和@EnableAsync注解；</strong></p><p><strong>&lt;1、自定义线程类</strong></p><p>Controller类代码如下面图3所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3f97d3ce18b54444b643d1a2e22381fb><p class=pgc-img-caption>图3</p></div><p>在Controller类的thread3方法中打印出调用线程名和调用前后时间，并且创建了一个新线程。（创建线程也可以使用线程池的方式）。</p><p>如下面图4所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fc4132e8243e473685105ec1792f1745><p class=pgc-img-caption>图4</p></div><p>在ThreadTask类的run方法中打印出调用线程名和调用前后时间以及间隔时间，注意run方法中的打印语句前都打印了“---”。</p><p>结果如下面图5所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5f493b5084934ae79aff388eff4fe2c9><p class=pgc-img-caption>图5</p></div><p>从结果中可以看出，Controller类的thread3方法执行时间间隔为0秒，而ThreadTask类的run方法执行时间间隔为3秒。和我们预期的相符。</p><p><strong>3、Springboot使用注解的异步调用方式详解</strong></p><p><strong>3.1、使用@Async和@EnableAsync注解</strong></p><p>3.1.1、首先使用@EnableAsync注解开启异步调用功能</p><p>该注解可以放置的位置有：</p><p>&lt;1、启动类上方，如下面图6所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e7cc1990a7a545d09a046a15fb4c1e26><p class=pgc-img-caption>图6</p></div><p>&lt;2、调用异步的当前类上方，如下面图7所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/94f12e68613449a492c34e29125b2a04><p class=pgc-img-caption>图7</p></div><p>&lt;3、在配置类上方使用，如下面图8所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ee6712b0fe324edfb7aa690c3d0c1a46><p class=pgc-img-caption>图8</p></div><p>配置类中，如果不指定 Executor ，则默认使用 SimpleAsyncTaskExecutor。</p><p>我们以第&lt;3种为例进行介绍，当然你也可以在启动类中进行相关配置。</p><p>如下面图9所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/10a13fcdd67242ddabb15b9f5754163d><p class=pgc-img-caption>图9</p></div><p>新建TestAsyncService类，并在该类中新建serviceThread4方法，在serviceThread4方法上加@Async注解，注意我这里为了方便没有在ServiceImpl中写代码逻辑。</p><p>如下面图10、图11所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f1ae032a5ffd42f1b968a5afc5c4aae3><p class=pgc-img-caption>图10</p></div><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/648dc667c4e6479c98f08d616a712a0d><p class=pgc-img-caption>图11</p></div><p>将TestAsyncService类注入到TestAsyncController类，并新建thread4方法，其中是调用taService.serviceThread4();异步方法。</p><p>如下面图12所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/20cb0ecd9e704ac893b6a516efe82431><p class=pgc-img-caption>图12</p></div><p>从结果可以看到，主线程http-nio-8085-exec-4时间间隔为0，直接返回，而子线程asyncExecutor-1为3秒。</p><p><strong>注意：加了@Async注解的异步方法，不能在本类中使用this进行调用，因为Spring是通过创建代理来进行异步调用的，故在本类调用是无效的。（如果不怕麻烦，也是有办法的。）</strong></p><p><strong>4、Springboot使用注解异步调用时的异常处理</strong></p><p>如下面图13所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6921e49d375840968d3b27b3f4de6b12><p class=pgc-img-caption>图13</p></div><p>在SpringAsyncConfigurer类增加getAsyncUncaughtExceptionHandler()方法。</p><p>修改TestAsyncService类的serviceThread4方法，如下图红框中所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/db15719fd39547c4a5144f7e3875c3ad><p class=pgc-img-caption>图14</p></div><p>此方法将会抛出空指针异常。</p><p>如下面图15所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7e79d180572e43659aa094dad8d3ba41><p class=pgc-img-caption>图15</p></div><p><strong>5、利用Future获取异步子线程的执行结果</strong></p><p>如下面图16所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fe35ed79c29b4d75a6a9019232632d95><p class=pgc-img-caption>图16</p></div><p>在TestAsyncService类中增加serviceThread5方法，如果正常出现结果，则返回<strong>success:参数值</strong>，出现异常则返回<strong>error</strong>。</p><p>如下面图17所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ffe03b2e07a4489c8b23c984f20d4706><p class=pgc-img-caption>图17</p></div><p>Controller类中增加thread5方法，注意方法中获取子线程返回值的地方，其中，future.get()是具有阻塞特性的，也就是说，虽然子线程是以异步的方式执行，但如果我们在Controller类的thread5方法中调用future.get()，则thread5方法同样会阻塞直到子线程执行完毕。</p><p>如下面图18所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dcfd6812677c4f7cb748eb6605734616><p class=pgc-img-caption>图18</p></div><p>从结果中也可以发现，因为future.get()的阻塞特性，实际上thread5方法的执行时间间隔为4秒，也就是子线程的睡眠时间。</p><p><strong>6、Springboot中异步调用事务的处理机制</strong></p><p>被@Async注解的方法，也可以同时使用@Transactional注解；在调用数据库操作之时，将无法产生事务管理的控制，原因就在于其是基于异步处理的操作。</p><p>那该如何给这些操作添加事务管理呢？我们可以将需要事务管理操作的方法放置到异步方法内部，在内部被调用的方法上添加@Transactional.</p><p>例如：方法1，使用了@Async/@Transactional来标注，但是无法产生事务控制的目的。方法2，使用了@Async来标注，方法2中调用了方法3、方法4，方法3/方法4分别使用@Transactional做了标注，则可以实现事务控制的目的。</p><p><strong>7、Springboot异步调用时多线程池实现，</strong>如下面图19所示：</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8e03b472396f45a5b12485ca53d5afc4><p class=pgc-img-caption>图19</p></div><p>在SpringAsyncConfigurer类中像上图中这样创建bean即可。使用时如下面图20在@Async注解中加入属性值即可。</p><div class=pgc-img><img alt="Java Springboot 多线程 异步调用 全解析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/299cea39d0d142b3878ad6bbd94e1bce><p class=pgc-img-caption>图20</p></div><p><strong>8、Springboot异步调用失效原因汇总</strong></p><p>&lt;1、异步方法和调用方法在同一个类中；</p><p>&lt;2、异步方法使用static修饰；</p><p>&lt;3、注解扫描时，要注意过滤，避免重复实例化，因为会有覆盖问题；</p><p><strong>注：</strong>&lt;1和&lt;2是一类原因，都是因为Spring通过代理类来使注解生效的，而Spring代理一般有动态代理和使用cglib进行生成，且为原来类或者接口的子类故不能被子类正常重写的方法，即使是加了@Async注解的方法也是不能生效的，像事务注解或其他自定义注解等不能生效，都可能有代理类无法正常使用的原因。(具体原因和使用动态代理和使用cglib的差别后面会有更细致的梳理，在这里只是我能想起的知识点)。</p><p><strong>本篇完。</strong></p><p><strong>持续更新完善中......欢迎关注,共同学习</strong></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Java','Springboot','多线程'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>