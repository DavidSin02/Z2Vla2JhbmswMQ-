<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>35、Activiti整合规则引擎Drools | 极客快訊</title><meta property="og:title" content="35、Activiti整合规则引擎Drools - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/ceac9629132b415586fd3872913607af"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7b97843f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7b97843f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7b97843f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7b97843f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7b97843f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7b97843f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7b97843f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7b97843f.html><meta property="article:published_time" content="2020-11-14T20:59:54+08:00"><meta property="article:modified_time" content="2020-11-14T20:59:54+08:00"><meta name=Keywords content><meta name=description content="35、Activiti整合规则引擎Drools"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/7b97843f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>35、Activiti整合规则引擎Drools</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>日常生活是由规则驱动的。红灯停绿灯行，这是我们的交通规则；我们站着往上跳，最终还是要落下来，这是地球的引力规则。规则在生活中无处不在。软件开发中我们也需要规则，满足什么规则应该进入什么分支。如果做过风控系统，就知道风控系统里存在非常多的规则（比如：age &lt; 16 || age > 50 -> REJECT ）。最便捷的实现就是用 if-else 来写，但是随着规则的增加以及需求的变动，代码将变得越来越难阅读和理解，如果再去修改这些代码，然后测试不够充分的话，将产生严重的生产事故。这时候就要引入Drools等规则引擎了。Drools就是为了解决业务代码和业务规则分离的引擎。</p><p>要使用Drools规则引擎，需要先安装安装JBoss Drools Support插件，这里就不多说怎么安装安装JBoss Drools Support插件。下载地址如下：</p><p>https://download.jboss.org/drools/release/7.3.0.Final/droolsjbpm-tools-distribution-7.3.0.Final.zip</p><p>1、 新建项目sc-activiti-drools，对应的pom.xml文件如下</p><pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.sc&lt;/groupId&gt; &lt;artifactId&gt;sc-activiti-drools&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;sc-activiti-drools&lt;/name&gt; &lt;!-- FIXME change it to the project's website --&gt; &lt;url&gt;http://www.example.com&lt;/url&gt; &lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt; &lt;/properties&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.0.4.RELEASE&lt;/version&gt; &lt;/parent&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;Finchley.RELEASE&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.activiti&lt;/groupId&gt; &lt;artifactId&gt;activiti-engine&lt;/artifactId&gt; &lt;version&gt;6.0.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.activiti&lt;/groupId&gt; &lt;artifactId&gt;activiti-spring&lt;/artifactId&gt; &lt;version&gt;6.0.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;scope&gt;runtime&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.drools&lt;/groupId&gt; &lt;artifactId&gt;drools-core&lt;/artifactId&gt; &lt;version&gt;7.0.0.Final&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.drools&lt;/groupId&gt; &lt;artifactId&gt;drools-compiler&lt;/artifactId&gt; &lt;version&gt;7.0.0.Final&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.drools&lt;/groupId&gt; &lt;artifactId&gt;knowledge-api&lt;/artifactId&gt; &lt;version&gt;6.5.0.Final&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;pluginManagement&gt;&lt;!-- lock down plugins versions to avoid using Maven  defaults (may be moved to parent pom) --&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;artifactId&gt;maven-clean-plugin&lt;/artifactId&gt; &lt;version&gt;3.0.0&lt;/version&gt; &lt;/plugin&gt; &lt;!-- see http://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_jar_packaging --&gt; &lt;plugin&gt; &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt; &lt;version&gt;3.0.2&lt;/version&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;version&gt;3.7.0&lt;/version&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt; &lt;version&gt;2.20.1&lt;/version&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt; &lt;version&gt;3.0.2&lt;/version&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;artifactId&gt;maven-install-plugin&lt;/artifactId&gt; &lt;version&gt;2.5.2&lt;/version&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;artifactId&gt;maven-deploy-plugin&lt;/artifactId&gt; &lt;version&gt;2.8.2&lt;/version&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/pluginManagement&gt; &lt;/build&gt; &lt;/project&gt;</pre><p>2、新建spring配置文件application.yml</p><pre>spring: datasource: driver-class-name: com.mysql.jdbc.Driver url: jdbc:mysql://127.0.0.1:3306/sc?characterEncoding=utf8&amp;useSSL=true username: root password: root activiti: check-process-definitions: false #自动部署验证设置:true-开启（默认）、false-关闭 jpa: properties: hibernate: hbm2ddl: auto: update show-sql: true server: port: 8081 context-path: / session: timeout: 10 tomcat: uri-encoding: UTF-8</pre><p>3、新建activiti对应的配置文件activiti.cfg.xml</p><pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"&gt; &lt;bean id="dataSource" class="org.springframework.jdbc.datasource.SimpleDriverDataSource"&gt; &lt;property name="driverClass" value="com.mysql.jdbc.Driver" /&gt; &lt;property name="url" value="jdbc:mysql://localhost:3306/act?useUnicode=true&amp;characterEncoding=UTF-8" /&gt; &lt;property name="username" value="root" /&gt; &lt;property name="password" value="root" /&gt; &lt;/bean&gt; &lt;bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager"&gt; &lt;property name="dataSource" ref="dataSource" /&gt; &lt;/bean&gt; &lt;bean id="processEngineConfiguration" class="org.activiti.spring.SpringProcessEngineConfiguration"&gt; &lt;property name="dataSource" ref="dataSource" /&gt; &lt;property name="transactionManager" ref="transactionManager" /&gt; &lt;property name="databaseSchemaUpdate" value="true" /&gt; &lt;property name="customPostDeployers"&gt; &lt;list&gt;  &lt;bean class="org.activiti.engine.impl.rules.RulesDeployer" /&gt; &lt;/list&gt;  &lt;/property&gt; &lt;!--  &lt;property name="deploymentResources" value="classpath*:/bpmn/*.bpmn" /&gt;  --&gt; &lt;/bean&gt; &lt;bean id="processEngine" class="org.activiti.spring.ProcessEngineFactoryBean"&gt; &lt;property name="processEngineConfiguration" ref="processEngineConfiguration" /&gt; &lt;/bean&gt; &lt;bean id="repositoryService" factory-bean="processEngine" factory-method="getRepositoryService" /&gt; &lt;bean id="runtimeService" factory-bean="processEngine" factory-method="getRuntimeService" /&gt; &lt;bean id="taskService" factory-bean="processEngine" factory-method="getTaskService" /&gt; &lt;bean id="historyService" factory-bean="processEngine" factory-method="getHistoryService" /&gt; &lt;bean id="managementService" factory-bean="processEngine" factory-method="getManagementService" /&gt; &lt;/beans&gt;</pre><p>4、新建请假流程对应的bpmn文件如下</p><pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org/test"&gt; &lt;process id="leave" name="请假审批" isExecutable="true"&gt; &lt;startEvent id="startevent1" name="Start"&gt;&lt;/startEvent&gt; &lt;endEvent id="endevent1" name="End"&gt;&lt;/endEvent&gt; &lt;userTask id="usertask1" name="部门经理审批"&gt;&lt;/userTask&gt; &lt;businessRuleTask id="businessruletask1" name="天数判断" activiti:ruleVariablesInput="${leave}" activiti:rules="leave1,leave2" activiti:resultVariable="reason"&gt;&lt;/businessRuleTask&gt; &lt;serviceTask id="servicetask1" name="获取变量" activiti:class="sc.ad.service.DroolsService"&gt;&lt;/serviceTask&gt; &lt;userTask id="usertask2" name="HR审批"&gt;&lt;/userTask&gt; &lt;sequenceFlow id="flow1" sourceRef="startevent1" targetRef="usertask1"&gt;&lt;/sequenceFlow&gt; &lt;sequenceFlow id="flow2" sourceRef="usertask1" targetRef="businessruletask1"&gt;&lt;/sequenceFlow&gt; &lt;sequenceFlow id="flow3" sourceRef="businessruletask1" targetRef="servicetask1"&gt;&lt;/sequenceFlow&gt; &lt;userTask id="usertask3" name="总经理审批"&gt;&lt;/userTask&gt; &lt;sequenceFlow id="flow4" sourceRef="servicetask1" targetRef="usertask3"&gt; &lt;conditionExpression xsi:type="tFormalExpression"&gt;&lt;![CDATA[${reason[0].total &gt;= 10}]]&gt;&lt;/conditionExpression&gt; &lt;/sequenceFlow&gt; &lt;sequenceFlow id="flow5" sourceRef="servicetask1" targetRef="usertask2"&gt; &lt;conditionExpression xsi:type="tFormalExpression"&gt;&lt;![CDATA[${reason[0].total &lt; 10}]]&gt;&lt;/conditionExpression&gt; &lt;/sequenceFlow&gt; &lt;sequenceFlow id="flow6" sourceRef="usertask3" targetRef="usertask2"&gt;&lt;/sequenceFlow&gt; &lt;sequenceFlow id="flow7" sourceRef="usertask2" targetRef="endevent1"&gt;&lt;/sequenceFlow&gt; &lt;/process&gt; &lt;/definitions&gt;</pre><p>bpmn文件对应的图如下</p><div class=pgc-img><img alt=35、Activiti整合规则引擎Drools onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ceac9629132b415586fd3872913607af><p class=pgc-img-caption></p></div><p>5、新建规则文件leave.drl</p><pre>package sc.ad; import sc.ad.model.Leave; rule "leave1" when u : Leave(day &lt; 3); then u.setTotal(u.getDay() + 2); end rule "leave2" when u : Leave(day &gt;= 3); then u.setTotal(u.getDay() + 5); end</pre><p>对应的图如下</p><div class=pgc-img><img alt=35、Activiti整合规则引擎Drools onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/996cf62b503a49fdb304c0c9b9c6aca5><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>6、新建springboot启动类文件</p><pre>package sc.ad; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.context.annotation.ImportResource; @SpringBootApplication @ImportResource("activiti.cfg.xml") public class ActivitiDroolsApp { public static void main(String[] args) { SpringApplication.run(ActivitiDroolsApp.class, args); } }</pre><p>7、新建一个controller，用来发起请假请求</p><pre>package sc.ad.controller; import java.util.HashMap; import java.util.List; import java.util.Map; import org.activiti.engine.RepositoryService; import org.activiti.engine.RuntimeService; import org.activiti.engine.TaskService; import org.activiti.engine.repository.Deployment; import org.activiti.engine.repository.DeploymentBuilder; import org.activiti.engine.repository.ProcessDefinition; import org.activiti.engine.runtime.ProcessInstance; import org.activiti.engine.task.Task; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; import sc.ad.model.Leave; @RestController public class ADController { @Autowired private RepositoryService repositoryService; @Autowired private RuntimeService runtimeService; @Autowired private TaskService taskService; // @RequestMapping("/ad") // public void ad() { // // // 根据bpmn文件部署流程 // Deployment deployment = repositoryService.createDeployment() // .addClasspathResource("holiday.bpmn").deploy(); // // 获取流程定义 // ProcessDefinition processDefinition = repositoryService // .createProcessDefinitionQuery() // .deploymentId(deployment.getId()).singleResult(); // // 启动流程定义，返回流程实例 // ProcessInstance pi = runtimeService // .startProcessInstanceById(processDefinition.getId()); // String processId = pi.getId(); // System.out.println("流程创建成功，当前流程实例ID：" + processId); // // Task task = taskService.createTaskQuery().processInstanceId(processId) // .singleResult(); // System.out.println("第一次执行前，任务名称：" + task.getName()); // taskService.complete(task.getId()); // // task = taskService.createTaskQuery().processInstanceId(processId) // .singleResult(); // System.out.println("第二次执行前，任务名称：" + task.getName()); // taskService.complete(task.getId()); // // task = taskService.createTaskQuery().processInstanceId(processId) // .singleResult(); // System.out.println("task为null，任务执行完毕：" + task); // } @RequestMapping("/drl") public void drl() { /** * 注意这里：必须要把drl文件一起deploy */ DeploymentBuilder deploy = repositoryService.createDeployment(); deploy.addClasspathResource("leave.bpmn").addClasspathResource("leave.drl"); deploy.deploy(); ProcessInstance pi = runtimeService.startProcessInstanceByKey("leave"); Map&lt;String, Object&gt; vars = new HashMap&lt;String, Object&gt;();  vars.put("leave", new Leave("白展堂", 12)); /** * 当前任务 */ List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list(); for(Task task : tasks) { System.out.println(task.getId() + " , " + task.getName()); taskService.complete(task.getId(), vars); } /** * 下一步任务 */ tasks = taskService.createTaskQuery().processInstanceId(pi.getId()).list(); for(Task task : tasks) { System.out.println(task.getId() + " , " + task.getName()); } } }</pre><p>8、启动并验证规则是否生效</p><p>从日志中看启动成功</p><div class=pgc-img><img alt=35、Activiti整合规则引擎Drools onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/84c0a86f42e34364b901d5f9dd05724a><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>访问http://127.0.0.1:8081/drl后，再次查看日志：</p><div class=pgc-img><img alt=35、Activiti整合规则引擎Drools onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/acb4f7ef9244458e99b0d110f403448b><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>把修改controller的如下代码</p><p>vars.put("leave", new Leave("白展堂", 12));</p><p>改成</p><p>vars.put("leave", new Leave("乔峰", 2));</p><div class=pgc-img><img alt=35、Activiti整合规则引擎Drools onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c8e226cff0d3492c87f858e2c788596e><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>可以看到规则文件的规则已经生效：</p><div class=pgc-img><img alt=35、Activiti整合规则引擎Drools onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/500c4921d01e47e091d65a6a5bb0d930><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'35','Activiti','规则'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>