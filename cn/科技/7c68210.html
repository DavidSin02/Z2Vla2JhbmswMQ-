<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一文看懂Oracle数据库LOB大字段类型、存储及相关命令 | 极客快訊</title><meta property="og:title" content="一文看懂Oracle数据库LOB大字段类型、存储及相关命令 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/eeb7a4ba723748fd8b316a52e8116495"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c68210.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c68210.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7c68210.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c68210.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c68210.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7c68210.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7c68210.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c68210.html><meta property="article:published_time" content="2020-10-29T20:59:31+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:31+08:00"><meta name=Keywords content><meta name=description content="一文看懂Oracle数据库LOB大字段类型、存储及相关命令"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/7c68210.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一文看懂Oracle数据库LOB大字段类型、存储及相关命令</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>概述</h1><p>在ORACLE数据库中，DBA_OBJECTS视图中OBJECT_TYPE为LOB的对象是什么东西呢？其实OBJECT_TYPE为LOB就是大对象（LOB），它指那些用来存储大量数据的数据库字段。</p><p><strong>Oracle 11gR2 文档：</strong></p><blockquote><p>http://download.oracle.com/docs/cd/E11882_01/appdev.112/e18294/adlob_tables.htm#ADLOB45267</p></blockquote><div class=pgc-img><img alt=一文看懂Oracle数据库LOB大字段类型、存储及相关命令 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/eeb7a4ba723748fd8b316a52e8116495><p class=pgc-img-caption></p></div><hr><h1><strong>一、LOB 分类</strong></h1><p>LOB大对象主要是用来存储大量数据的数据库字段，在Oracle 9iR2 中LOB的最大容量是4G，Oracle 10g 最大8T，Oracle 11g 最大是128T。具体取决于blocksize 的大小。</p><blockquote><p>The built-in LOB data types BLOB, CLOB, and NCLOB (stored internally) and BFILE (stored externally) can store large and unstructured data such as text, image, video, and spatial data. The size of BLOB, CLOB, and NCLOB data can be up to (232-1 bytes) * (the value of the CHUNK parameter of LOB storage).</p></blockquote><p><strong>1、Oracle 支持4 种类型的LOB：</strong></p><p>CLOB：字符LOB。这种类型用于存储大量的文本信息，如XML 或者只是纯文本。这个数据类型需要进行字符集转换，也就是说，在获取时，这个字段中的字符会从数据库的字符集转换为客户的字符集，而在修改时会从客户的字符集转换为数据库的字符集。</p><p>NCLOB：这是另一种类型的字符LOB。存储在这一列中的数据所采用的字符集是数据库的国家字符集，而不是数据库的默认字符集。</p><p>BLOB：二进制LOB。这种类型用于存储大量的二进制信息，如字处理文档，图像和你能想像到的任何其他数据。它不会执行字符集转换。应用向BLOB 中写入什么位和字节，BLOB就会返回什么为和字节。</p><p>BFILE：二进制文件LOB。这与其说是一个数据库存储实体，不如说是一个指针。带BFILE列的数据库中存储的只是操作系统中某个文件的一个指针。这个文件在数据库之外维护，根本不是数据库的一部分。BFILE 提供了文件内容的只读访问。</p><p><strong>2、LOB数据类型分类</strong></p><p>2.1、按存储数据的类型分：</p><p>（1）字符类型：</p><p>CLOB:存储大量 单字节 字符数据。</p><p>NLOB:存储定宽 多字节 字符数据。</p><p>（2）二进制类型：</p><p>BLOB:存储较大无结构的二进制数据。</p><p>（3）二进制文件类型：</p><p>BFILE:将二进制文件存储在数据库外部的操作系统文件中。存放文件路径。</p><p>2.2、按存储方式分：</p><p>（1）存储在内部表空间（内部LOB）：</p><p>CLOB，NLOB和BLOB</p><p>（2）指向外部操作系统文件（外部LOB）：</p><p>BFILE</p><hr><p><strong>二、Lob的存储</strong></p><p>我们建立含有lob字段的表时，oracle会自动为lob字段建立两个单独的segment,一个用来存放数据，另一个用来存放索引，并且它们都会存储在对应表指定的表空间中。</p><div class=pgc-img><img alt=一文看懂Oracle数据库LOB大字段类型、存储及相关命令 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1c160bda480b4c24a0e499e0f4fcb1cc><p class=pgc-img-caption></p></div><p>如上例所示，每个lob字段都对应两个segment，其中存放lob数据的以SYS_LOB开头，存放索引以SYS_IL开头。</p><p>LOB 按“块”（chunk）或（piece）来存储，每个片段都可以访问。</p><hr><h1><strong>三、Lob与其它类型的转换</strong></h1><p>通过TO_CLOB可以将CHAR，NCHAR，VARCHAR2,NVARCHAR2，NCLOB类型转换成CLOB；</p><p>通过TO_LOB可以将LONG RAW转换成BLOB，LONG转换成CLOB；</p><p>通过TO_NCLOB可以将CHAR，NCHAR，VARCHAR2,NVARCHAR2，CLOB转换成NCLOB。</p><hr><p><strong>四、Oracle数据库的SYS_LOB</strong></p><p>看看你的表里是不是存在blog，clob等类型的字段，当我们所建立的表中含有lob型的数据时，oracle会为每个lob字段生成一个独立的segment用来存放数据，同时也建立了独立的index segment .oracle对它们是单独管理的。</p><p>普通表只会新增一个或两个段对象.类型为TABLE和INDEX，数据就存放在表段中.索引就放在索引段中。但是LOB列则额外新增了两个段对象,类型为LOBSEGMENT和LOBINDEX，LOBINDEX用于指向LOB段,找出其中的某一部分，所以存储在表中的LOB存储的是一个地址,或者说是一个指针,实际上表中的lob列中存的是一个地址段.然后在lobindex找到所有的地址段.然后在lobSegment中把所有地址段的值都读取了来。所以lobSegment就保存了LOG列的真正的数据，所以会非常大，并且独立于原始表存在。</p><p><strong><em>先看看这个对应的表的字段是否有数据，如果有你就无法删除这个sys_lob$的对象。想减少空间的占用就清理历史数据，或者重新导出导入下。</em></strong></p><hr><h1>五、相关概念</h1><p><strong>关于LOB，我们可以使用dbms_metadata来获得它的完整的脚本：</strong></p><pre>SELECT DBMS_METADATA.GET_DDL( 'TABLE', 'LOB_TABLE' ) FROM DUAL</pre><p><strong>1、表空间</strong></p><p>保存lob数据的表空间可以不同于保存表数据的表空间，为LOB数据单独使用一个表空间有利于备份和恢复以及空间管理但是lobindex和lobsegment必须在同一个表空间中</p><p><strong>2、IN ROW</strong></p><pre>ENABLE STORAGE IN ROWDISABLE STORAGE IN ROW</pre><p>控制LOB数据是否总与表分开存储（存储在lobsegment中），或是有时可以与表一同存储，而不用单独放在lobsegment中。</p><p>如果设置了ENABLE STORAGE IN ROW，而不是DISABLE STORAGE IN ROW，小LOB（最多4,000字节）就会像VARCHAR2一样存储在表本身中。只有当LOB超过了4,000字节时，才会“移出”到lobsegment中</p><p>默认行为是启用行内存储ENABLE STORAGE IN ROW，如果lob存储的数据大小能在表本身中放下，建议采用内联存储</p><p><strong>3、CHUNK</strong></p><p>块（chunk）是逻辑上连续的一组数据库块（block），这也是LOB的最小分配单元。，每个LOB实例（每个行外存储的LOB值）会占用至少一个CHUNK。一个CHUNK有一个LOB值使用，每个chunk的大小应该尽可能与实际lob数据的大小相近，以减少浪费空间；</p><p><strong>4、PCTVERSION</strong></p><p>控制lob的读一致性</p><p>PCTVERSION控制着用于实现LOB数据版本化的已分配LOB空间的百分比（这些数据库块由某个时间点的LOB所用，并处在lobsegment的HWM以下）。对于许多使用情况来说，默认设置12%就足够了，因为在很多情况下，你只是要INSERT和获取LOB（通常不会执行LOB的更新；LOB往往会插入一次，而获取多次）。因此，不必为LOB版本化预留太多的空间（甚至可以没有）。</p><p>如果你的应用确实经常修改LOB，假设很频繁地读LOB，与此同时另外某个会话正在修改这些LOB，12%可能就太小了。如果处理LOB时遇到一个ORA-22924错误，解决方案不是增加undo表空间的大小，也不是增加undo保留时间（UNDO_RETENTION），如果你在使用手动undo管理，那么增加更多RBS空间也不能解决这个问题。而是应该使用以下命令：</p><pre>ALTER TABLE tabname MODIFY LOB (lobname) ( PCTVERSION n)</pre><p>增加lobsegment中为实现数据版本化所用的空间大小。</p><p><strong>5、CACHE</strong></p><p>控制lobsegment数据是否存储在缓冲区缓存中。默认的NOCACHE指示，每个访问都是从磁盘的一个直接读</p><pre>ALTER TABLE tabname MODIFY LOB (lobname) ( CACHE );ALTER TABLE tabname MODIFY LOB (lobname) ( NOCACHE );</pre><hr><h1>六、查看ORACLE的LOB(BLOB和CLOB)对象占用的大小</h1><p>1、查看Oracle中表空间及表数据大小</p><pre>Select Segment_Name, Sum(bytes) / 1024 / 1024 From User_Extents where SEGMENT_NAME LIKE 'SYS_LOB%' GROUP BY Segment_Name order by Sum(bytes) / 1024 / 1024 desc;</pre><div class=pgc-img><img alt=一文看懂Oracle数据库LOB大字段类型、存储及相关命令 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/722edf067b7347ba890661dde3766564><p class=pgc-img-caption></p></div><p>从返回的结果看，有一个segment名为"SYS_LOB0000701017C00045$$"的对象占用了大量的空间，这种带有SYS_LOB***即LOB(BLOB和CLOB)对象占用数据库的空间名称。</p><p>2、根据segment_name，就可以从 dba_lobs 表里查到是哪个表，哪个字段</p><pre>SELECT * FROM DBA_LOBS WHERE SEGMENT_NAME LIKE 'SYS_LOB0000701017C00045$$';</pre><div class=pgc-img><img alt=一文看懂Oracle数据库LOB大字段类型、存储及相关命令 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d9ac791ba46e41928065b2702a286304><p class=pgc-img-caption></p></div><hr><p>后面会分享更多devops和DBA方面的内容，感兴趣的朋友可以关注下！</p><div class=pgc-img><img alt=一文看懂Oracle数据库LOB大字段类型、存储及相关命令 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2cef83730333490d9782ae24b0374fbd><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Oracle','数据库','LOB'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>