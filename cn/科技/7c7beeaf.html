<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文 | 极客快訊</title><meta property="og:title" content="入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/9cc70e53ffca4c35b6ea8146e5065e7c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c7beeaf.html><meta property="article:published_time" content="2020-11-14T21:00:23+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:23+08:00"><meta name=Keywords content><meta name=description content="入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/7c7beeaf.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>今天超子和大家一起构建一下MQTT协议中的CONNECT报文连接腾讯的物联网开发平台，只有CONNECT报文成功之后才能进行后面的通信。</p><p>我们直入主题，首先是CONNECT报文的固定报头0x10 ??，??是剩余长度，只有我们确定了可变报头和负载的长度后才能计算出来，所以一会再说。</p><p>CONNECT报文中的可变报头用来设置信息和各种功能，腾讯物联网平台和阿里云的一样，所以直接把阿里云的可变报头拿过来就行，简化的16进制书写，去掉0x，结果如下：</p><p>00 04 4D 51 54 54 04 C2 00 64</p><p>CONNECT报文中的负载包含客户端ID，用户名和密码这3个非常重要的信息，首先我们要总结下各个信息对应于腾讯云物联网平台的什么内容。</p><p>客户端ID：产品ID +设备名称</p><p>用户名：产品ID +设备名称+分号+ 21010406 +分号+78945 +分号+2147483647</p><p>密码：这个比较麻烦，需要先对设备秘钥进行base64解码，解码后的数据再作为密钥对用户名进行hmacsha1加密，加密后的密文就是MQTT协议CONNECT报文中负载的密码了</p><p>我们一起来找一下相关的信息在什么地方。</p><div class=pgc-img><img alt=入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9cc70e53ffca4c35b6ea8146e5065e7c><p class=pgc-img-caption></p></div><p>首先登录腾讯云物联网开发平台，超子在上一篇文章介绍了如何新建项目和产品。然后进入我们建立好的项目内，点击我们建立的产品。</p><p>《<a class=pgc-link data-content=mp href="https://www.toutiao.com/i6818907510808773124/?group_id=6818907510808773124" rel="noopener noreferrer" target=_blank>新手入门腾讯物联网开发平台，如何建立项目产品？简单详细上手快</a>》</p><div class=pgc-img><img alt=入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/0225ac3b48d54effa84f839a5b572e36><p class=pgc-img-caption></p></div><p>进入产品详情页后，我们选择第4步的设备调试，点击红圈中的新建设备，因为设备是连接平台的终端。</p><div class=pgc-img><img alt=入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a2dd32118a7440b1bb7c1fd077ebf3a2><p class=pgc-img-caption></p></div><p>我们给设备起一个名称就行，然后点击保存。</p><div class=pgc-img><img alt=入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b5e967a04c894960af44b9e4a32bedf7><p class=pgc-img-caption></p></div><p>设备建立成功后，在设备列表可以看到刚才建立的D001，然后我们点击设备，进入设备详情页面。</p><div class=pgc-img><img alt=入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2fcd46f8da53416a93239e3066c3cf48><p class=pgc-img-caption></p></div><p>上图中的3个信息，就是构建客户端ID，用户名和密码需要用到的内容。</p><p>先看客户端ID，结构是产品ID +设备名称，就是65NJZ04A1BD001，然后换成16进制是36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31，长度是14，按照MQTT的格式要求，我们还要在最前面加入2个字节表示长度14，那么最终的16进制，简化书写，去掉0x结果如下：</p><p>00 0E 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31</p><p>接着构建用户名，产品ID +设备名称+分号+ 21010406 +分号+78945 +分号+2147483647，就是65NJZ04A1BD001;21010406;78945;2147483647，然后换成16进制是36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 3B 32 31 30 31 30 34 30 36 3B 37 38 39 34 35 3B 32 31 34 37 34 38 33 36 34 37，长度是40，然后按照MQTT的格式要求，我们还要在最前面加入2个字节表示长度40，那么最终的16进制，简化书写，去掉0x结果如下：</p><p>00 28 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 3B 32 31 30 31 30 34 30 36 3B 37 38 39 34 35 3B 32 31 34 37 34 38 33 36 34 37</p><p>最后构建密码，先对ZmLVuCs4H/zX6E63+i2Ung==设备密钥进行base64解码，解码后换成16进制是66 62 D5 B8 2B 38 1F FC D7 E8 4E B7 FA 2D 94 9E，然后再作为密钥对用户名进行hmacsha1加密，加密后的结果，换成16进制是31 34 31 33 36 31 32 61 30 61 31 65 37 32 62 66 32 31 39 32 36 30 31 39 30 66 35 38 65 61 32 64 39 37 64 61 61 30 36 38 3B 68 6D 61 63 73 68 61 31，长度是49，我们还要在最前面加入2个字节表示长度49，那么最终的16进制，简化书写，去掉0x结果如下：</p><p>00 31 31 34 31 33 36 31 32 61 30 61 31 65 37 32 62 66 32 31 39 32 36 30 31 39 30 66 35 38 65 61 32 64 39 37 64 61 61 30 36 38 3B 68 6D 61 63 73 68 61 31</p><p>到此整个负载就搞定了，接下来我们把客户端ID+用户名+密码连接起来构成负载信息，简化16进制，去掉0x结果如下：</p><p>00 0E 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 00 28 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 3B 32 31 30 31 30 34 30 36 3B 37 38 39 34 35 3B 32 31 34 37 34 38 33 36 34 37 00 31 31 34 31 33 36 31 32 61 30 61 31 65 37 32 62 66 32 31 39 32 36 30 31 39 30 66 35 38 65 61 32 64 39 37 64 61 61 30 36 38 3B 68 6D 61 63 73 68 61 31</p><p>我们一起数一下，整个负载部分共计109个字节 。剩余长度=可变报头+负载=10+109=119，119/128=0，一个字节就能搞定，换成16进制就是0x77，最后我们把固定报头、可变报头和负载同连接起来，简化16进制，去掉0x的最终结果如下所示：</p><p>10 77 00 04 4D 51 54 54 04 C2 00 64 00 0E 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 00 28 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 3B 32 31 30 31 30 34 30 36 3B 37 38 39 34 35 3B 32 31 34 37 34 38 33 36 34 37 00 31 31 34 31 33 36 31 32 61 30 61 31 65 37 32 62 66 32 31 39 32 36 30 31 39 30 66 35 38 65 61 32 64 39 37 64 61 61 30 36 38 3B 68 6D 61 63 73 68 61 31</p><p>到此CONNECT报文构建完毕，我们用网络助手实测一下，腾讯云物联网开发平台提供的是域名，端口号是1883，那么网络助手中，远程主机地址就是</p><p>iotcloud-mqtt.gz.tencentdevices.com:1883</p><p>我们实际测试一下CONNECT报文，看看设备是不是在线了。</p><div class=pgc-img><img alt=入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fb6a5e541b614fe2a441f52cc9b93294><p class=pgc-img-caption></p></div><p>发送CONNECT报文后，服务器回复我们的CONNACK报文中，我们看最后1个字节是0x00，说明我们的CONNECT报文正确。</p><div class=pgc-img><img alt=入门腾讯物联网开发平台，如何构建MQTT协议CONNECT报文 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/73c20aff88644f978822b5aa75b8f399><p class=pgc-img-caption></p></div><p>CONNECT报文成功发送后，我们再看设备列表，对应的D001设备的状态已经显示在线了。CONNECT报文中我们设置的keep alive的时间是100s，按协议标准要求，1.5倍时间也就是150s内，没有数据发送的话，服务器可以把我们踢下来。如果我们没有什么数据要发送的话，可以通过发送PING报文，来保持连接，不被踢下来。</p><p>今天我们就把CONNECT报文搞定了，任务圆满完成。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'入门','腾讯物','联网'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../cn/%E7%A7%91%E6%8A%80/35a190b6.html alt=新手入门腾讯物联网开发平台，如何建立项目产品？简单详细上手快 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/59aad044a64e4326b2dba8689527b1d7 style=border-radius:25px></a>
<a href=../../cn/%E7%A7%91%E6%8A%80/35a190b6.html title=新手入门腾讯物联网开发平台，如何建立项目产品？简单详细上手快>新手入门腾讯物联网开发平台，如何建立项目产品？简单详细上手快</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>