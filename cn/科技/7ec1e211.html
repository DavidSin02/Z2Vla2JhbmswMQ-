<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>没想到 Hash 冲突还能这么玩，你的服务中招了吗？ | 极客快訊</title><meta property="og:title" content="没想到 Hash 冲突还能这么玩，你的服务中招了吗？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/55e00cdde1784db9825c0f945b30126a"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7ec1e211.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7ec1e211.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7ec1e211.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7ec1e211.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7ec1e211.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7ec1e211.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7ec1e211.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7ec1e211.html><meta property="article:published_time" content="2020-11-14T21:02:06+08:00"><meta property="article:modified_time" content="2020-11-14T21:02:06+08:00"><meta name=Keywords content><meta name=description content="没想到 Hash 冲突还能这么玩，你的服务中招了吗？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/7ec1e211.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>没想到 Hash 冲突还能这么玩，你的服务中招了吗？</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>以下文章来源于程序猿石头 ，作者码农唐磊</p><h2 class=pgc-h-arrow-right><strong>背景</strong></h2><p>其实这个问题我之前也看到过，刚好在前几天，洪教授在某个群里分享的一个《一些有意思的攻击手段.pdf》，我觉得这个话题应该还是有不少人不清楚的，今天我就准备来“实战”一把，还请各位看官轻拍。</p><blockquote><p>洪强宁（洪教授），爱因互动创始人兼 CTO，曾任豆瓣首席架构师，为中国 Python 用户组（CPUG）的创立者之一。</p></blockquote><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/55e00cdde1784db9825c0f945b30126a><p class=pgc-img-caption></p></div><p>这才是真大佬，原来洪教授在宜信的时候，就有分享过这个内容，可惜当初不知道没参加。看了之后才知道原来我上一篇的文章中讲的 <strong>计时攻击（Timing Attack）</strong> 也是其中的内容之一。哈哈，后面有空再研究研究继续讲其他内容。</p><h2 class=pgc-h-arrow-right>Hash 冲突</h2><p>啥叫 Hash 冲突？我们从 Hash 表（或者散列表）讲起，我们知道在一个 hash 表的查找一个元素，期望的时间复杂度为 O(1)，怎么做到的呢？其实就是 hash() 函数在起作用。</p><p>粗略来讲，hash 表内部实际存储还是跟数组类似，用连续的内存空间存储元素，只要通过某种方法将将要存储的元素映射为数组的下标，即可像数组一样通过下标去读取对应的元素，这也是为什么能做到 O(1) 的原因。</p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cb14cb4218a742e5a81d28894e487921><p class=pgc-img-caption>Hash 示例</p></div><p><br></p><p>以上图为例，假设是我设计的一个 hash 函数，恰好满足如下条件：</p><ul><li>hash("hello")=0：字符串 "hello" 就存储数组下标为 0 的地方；</li><li>hash("world")=2："world" 存储数组下标为 2 的地方；</li><li>hash("tangleithu")=5："tangleithu" 存储数组下标为 5 的地方；</li></ul><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cc6821b611d443b6970add4926c46c38><p class=pgc-img-caption></p></div><p>目前来看一切好像很完美，但这终归是假设，我不能假设这个 hash 都很完美的将不同的字符串都映射到了不同的下标处。</p><p>另外来了个字符串，hash("石头") = 2，怎么办？这就是所谓的 “Hash 冲突”，最常见 Hash 冲突的解决方案其实就是“开链”法，其实还有比如线性试探、平方试探等等。</p><p>类似讲解 HashMap 的文章满大街都是，一搜一大把，本文就不详述了。为了方便读者理解，就简单来个例子。</p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/535b7407afc34c45ac95a969e242b1ef><p class=pgc-img-caption>Hash冲突开链法</p></div><p><br></p><p>开链法如上图所示，我们存储元素的时候，存储形式为一个链表，当冲突的时候，就在链表末尾直接添加冲突的元素。上图示例恰好运气比较差，字符串 shitou，stone 算出来的下标都为 2。</p><p>这样一来，问题大了。原本我们期望 O(1) 的时间复杂度查找元素，现在变成在链表中线性查找了，而如果这个时候插入 个数据，最坏的情况下的时间复杂度就是 了。（这里就不讨论链表转树的情形）</p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c0de5b3770e748948993a51e9ff09cc5><p class=pgc-img-caption>坏人可乘机而入</p></div><p><br></p><p>这就又给坏人留下了想象空间。只要坏人精心设计一组要放进 hash 表的字符串，且让这些字符串的 hashcode 都一样，这就会导致 hash 冲突，结果会导致 cpu 要花费大量的时间来处理 hash 冲突，造成 DoS（Denial of Service）攻击。</p><p>而用 hash 表存储的情形太常见了。在 Web 服务中，一般表单的处理都是用 hash 表来保存的（后端往往要知道通过某个具体的参数 key 获取对应的参数 value）。</p><h2 class=pgc-h-arrow-right>实战</h2><p>本文石头哥将以 Java SpringBoot 为例，尝试进行一次攻击。</p><p>不过别以为这种 “Hash 冲突 DoS” 只有 Java 才有哦，什么 Python，Apache Tomcat/Jetty，PHP 之类都会有这个问题的。其实早在 2011 年年末的时候就被大量爆出了，有的框架陆陆续续有一些改进和修复。详细情况可以看这篇文章：oCERT-2011-003 multiple implementations denial-of-service via hash algorithm collision[1]。</p><p>这里，咱们给列举其中一个 Apatch Tomcat，来自 CVE-2011-4858[2]。</p><blockquote><p>Apache Tomcat before 5.5.35, 6.x before 6.0.35, and 7.x before 7.0.23 computes hash values for form parameters without restricting the ability to trigger hash collisions predictably, which allows remote attackers to cause a denial of service (CPU consumption) by sending many crafted parameters.</p></blockquote><p><br></p><p>下面截图来自洪教授的 PPT，但内容的具体来源不详了（尝试找了下，没找到），大家参考参考就好。</p><p><br></p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b065a4941e394bb4a4560d4df5628ee5><p class=pgc-img-caption>实现 hash 冲突 DoS 攻击所需带宽</p></div><p>左边表示用不同的语言（框架）实现这种攻击所需要的带宽，右边是攻击的 cpu 目标。可以看出，实施这种攻击成本其实挺低的（后文石头的试验也佐证了这一点）。</p><p><br></p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fe3d3eb6bea24fbc928dc9219b214b78><p class=pgc-img-caption></p></div><p>不得不说 “PHP 是世界上最好的编程语言”（大家别打架），还是有一定道理的，哈哈哈哈哈哈 （一张图还不够，再加一张）</p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1b46f95d9d9f4b408b072ba45d03bf17><p class=pgc-img-caption></p></div><p>上面的语言排序，不一定对，大家参考一下即可，不用纠结具体的准确性。</p><p>其实要验证，方法当然也相对简单，只要找出产生冲突的不同字符串即可，具体语言可能不一样。</p><h2 class=pgc-h-arrow-right>talk is cheap</h2><p>现在跟着我来尝试进行一次攻击吧，本人用自己的笔记本进行试验（配置：MBP 13-inch，2.5 GHz Intel Core i7，16 GB 2133 MHz LPDDR3）。</p><p>首先构造一把 hash 冲突的字符串，下面代码是 hash 冲突的字符串对的实例，后面的其实可以通过前面排列组合生成。</p><pre><code>System.out.println("Aa".hashCode());System.out.println("BB".hashCode());System.out.println("BBBBBBBBBBBBBBBBBBBBBBBBAaBBBBAa".hashCode());System.out.println("BBBBBBBBBBBBBBBBBBBBBBBBAaBBBBBB".hashCode());// 输出2112211220678584322067858432</code></pre><p>具体生成过程本文不详述了，感兴趣可以看看 StackOverflow 上的这篇文章 Application vulnerability due to Non Random Hash Functions[3]，或者参考耗子叔的这篇 Hash Collision DoS 问题[4]。</p><p>然后我启用一个 SpringBoot（2.2.2.RELEASE） 的 Web 服务，JDK 1.8（其实用 1.7 效果更明显）。</p><pre><code>@RequestMapping("/hash")public String hash(HttpServletRequest request) {    // Demo，简单返回参数大小和其对应hashCode    int size = request.getParameterMap().size();    String key = (String)(request.getParameterMap().keySet().toArray())[0];    return String.format("size=%s, hashCode=%s", size, key.hashCode());}</code></pre><p>先试水一把（如下图），看看基本功能正常，用 curl 发送请求即可，然后将 post 的字段放在文件里面（太长也只能放文件中）。</p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2e607d0943d34cafa78ca254715e590a><p class=pgc-img-caption>curl 实验结果</p></div><p><br></p><p>生成的字符串不够的话，还可以增加并发请求，可以借用类似 “Apache Benchmarking” 压测的工具发送请求，我之前也有一篇文章介绍了这个命令 <strong>性能测试工具 - ab 简单应用</strong>，感兴趣的可以参考一下。</p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ea4d6528c6094e6880342fc1d33fdcf5><p class=pgc-img-caption>冲突的 hashcode 一样</p></div><p><br></p><p>打个断点看看效果，如上图所示，确实所有的 hash 值都是一样的。不过一次请求好像并没有影响我电脑 cpu 的明显变化。</p><p>我测试的字符串已经是 29859 个了，正准备生成更多的冲突的字符串进行尝试时，结果仔细一看才发现请求被截断了，请求返回的参数 size 大小为 10000。原来 SpringBoot 内置的 tomcat 给做了手脚，看下图，因为默认的请求的参数个数大小被限制成 10000 了。</p><blockquote><p>More than the maximum number of request parameters (GET plus POST) for a single request ([10,000]) were detected. Any parameters beyond this limit have been ignored. To change this limit, set the maxParameterCount attribute on the Connector.</p></blockquote><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/84e7eea70904493fafca22b38137a951><p class=pgc-img-caption>post参数数量被限制</p></div><p><br></p><p>一种方法当然是去修改这个请求参数个数的限制。另外其实可以尝试用 JDK 1.7 去验证，应该效果会更好（原因，聪明的读者你肯定知道吧？）。这里石头哥就懒得去折腾了，直接尝试以量来取胜，用前文说的 ab 进行并发提交请求，然后观察效果。</p><p>这是我用如下参数跑的压测结果：</p><pre><code>ab -c 200 -n 100000 -p req.txt 'localhost:8080/hash'</code></pre><p>压测的结果如图所示：</p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/b54e4766e0124e25b032aca0becc7665><p class=pgc-img-caption>ab 压测 hash 冲突结果</p></div><p><br></p><p>然后我们来看看 CPU 的变化情况，特意录屏做了个动图，可以看出还是相对比较明显的。从基本不占用 cpu 到 39.6%，然后突然就涨到 158% 了。</p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f08fe13fe09c4a68a5a809c3ef7ac8ca><p class=pgc-img-caption>hash-collision-demo动图</p></div><p>实际试验中这个过程没有一直持续（上面是重试过程中抓到的其中一次），一方面因为本人用的 JDK 1.8，本来冲突后的查找过程已经优化了，可能效果并不明显，另外也猜测可能会有一些 cache 之类的优化吧，另外对于 10000 的量也还不够？具体我也没有深究了，感兴趣的读者可以去尝试一下玩玩。</p><p><br></p><p>到这里实验算成功了吧。</p><p><br></p><div class=pgc-img><img alt="没想到 Hash 冲突还能这么玩，你的服务中招了吗？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/54f5170413fe4b9a9264ac5d3549a67b><p class=pgc-img-caption></p></div><p>实验成功就是拽</p><p>我这还是单机，要是多搞几个 client，不分分钟把 Web 服务搞死啊。</p><h2 class=pgc-h-arrow-right><br></h2><h2 class=pgc-h-arrow-right><strong>防御方法</strong></h2><p><br></p><p>上面实验算是成功了，那么防御方法呢？其实就是：</p><ul><li>改 hash 算法算一种了；例如像有的用随机算法作为 hash 函数的情况，可以用不同的随机种子尝试生成；但事实上并没有完美的 hash 算法的。</li><li>本文实验中的也遇到这个了，就是要限制请求的参数个数，以及请求长度。在不影响业务的情况下，限制尽可能更小；</li><li>上 WAF（Web Application Firewall），用专业的防火墙清洗流量。</li></ul><h2 class=pgc-h-arrow-right><br></h2><h2 class=pgc-h-arrow-right><strong>最后</strong></h2><p><br></p><p>本文只供学习交流使用，请大家不要轻易尝试线上服务，不要轻易尝试线上服务，不要轻易尝试线上服务。</p><p><br></p><p>本人才疏学浅，如果有不对的地方，还望大家指出。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Hash','冲突','还能'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>