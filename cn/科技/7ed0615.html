<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>状态机思路在单片机程序设计中的应用 | 极客快訊</title><meta property="og:title" content="状态机思路在单片机程序设计中的应用 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/dfic-imagehandler/46a273ec-0a03-4c77-a413-f6d2bf6b85e0"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7ed0615.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7ed0615.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7ed0615.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7ed0615.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7ed0615.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7ed0615.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7ed0615.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7ed0615.html><meta property="article:published_time" content="2020-10-29T20:59:15+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:15+08:00"><meta name=Keywords content><meta name=description content="状态机思路在单片机程序设计中的应用"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/7ed0615.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>状态机思路在单片机程序设计中的应用</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>一、状态机的概念</strong></p><p>状态机是软件编程中的一个重要概念。比这个概念更重要的是对它的灵活应用。在一个思路清晰而且高效的程序中，必然有状态机的身影浮现。</p><p>比如说一个按键命令解析程序，就可以被看做状态机：本来在A状态下，触发一个按键后切换到了B状态；再触发另一个键后切换到C状态，或者返回到A状态。这就是最简单的按键状态机例子。实际的按键解析程序会比这更复杂些，但这不影响我们对状态机的认识。</p><p>进一步看，击键动作本身也可以<span>看做</span>一个状态机。一个细小的击键动作包含了：释放、抖动、闭合、抖动和重新释放等状态。</p><p>同样，一个串行通信的时序（不管它是遵循何种协议，标准串口也好、I2C也好；也不管它是有线的、还是红外的、无线的）也都可以<span>看做</span>由一系列有限的状态构成。</p><p>显示扫描程序也是状态机；通信命令解析程序也是状态机；甚至连继电器的吸合/释放控制、发光管（LED）的亮/灭控制又何尝不是个状态机。</p><p>当我们打开思路，把状态机作为一种思想导入到程序中去时，就会找到解决问题的一条有效的捷径。有时候用状态机的思维去思考程序该干什么，比用控制流程的思维去思考，可能会更有效。这样一来状态机便有了更实际的功用。</p><p>程序其实就是状态机。</p><p>也许你还不理解上面这句话。请想想看，计算机的大厦不就是建立在“0”和“1”两个基本状态的地基之上么？</p><p><strong>二、状态机的要素</strong></p><p>状态机可归纳为4个要素，即现态、条件、动作、次态。这样的归纳，主要是出于对状态机的内在因果关系的考虑。“现态”和“条件”是因，“动作”和“次态”是果。详解如下：</p><p>①现态：是指当前所处的状态。</p><p>②条件：又称为“事件”。当一个条件被满足，将会触发一个动作，或者执行一次状态的迁移。</p><p>③动作：条件满足后执行的动作。动作执行完毕后，可以迁移到新的状态，也可以仍旧保持原状态。动作不是必需的，当条件满足后，也可以不执行任何动作，直接迁移到新状态。</p><p>④次态：条件满足后要迁往的新状态。“次态”是相对于“现态”而言的，“次态”一旦被激活，就转变成新的“现态”了。</p><p>如果我们进一步归纳，把“现态”和“次态”统一起来，而把“动作”忽略（降格处理），则只剩下两个最关键的要素，即：状态、迁移条件。</p><p>状态机的表示方法有许多种，我们可以用文字、图形或表格的形式来表示一个状态机。</p><p>纯粹用文字描述是很低效的，所以就不介绍了。接下来先介绍图形的方式。</p><ul><li><strong>状态迁移图（STD）</strong></li></ul><p>状态迁移图（STD），是一种描述系统的状态、以及相互转化关系的图形方式。状态迁移图的画法有许多种，不过一般都大同小异。我们结合一个例子来说明一下它的画法，如图1所示。</p><div class=pgc-img><img alt=状态机思路在单片机程序设计中的应用 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/dfic-imagehandler/46a273ec-0a03-4c77-a413-f6d2bf6b85e0><p class=pgc-img-caption></p></div><p>①状态框：用方框表示状态，包括所谓的“现态”和“次态”。</p><p>②条件及迁移箭头：用箭头表示状态迁移的方向，并在该箭头上标注触发条件。</p><p>③节点圆圈：当多个箭头指向一个状态时，可以用节点符号（小圆圈）连接汇总。</p><p>④动作框：用椭圆框表示。</p><p>⑤附加条件判断框：用六角菱形框表示。</p><p>状态迁移图和我们常见的流程图相比有着本质的区别，具体体现为：在流程图中，箭头代表了程序PC指针的跳转；而在状态迁移图中，箭头代表的是状态的改变。</p><p>我们会发现，这种状态迁移图比普通程序流程图更简练、直观、易懂。这正是我们需要达到的目的。</p><ul><li><strong>状态迁移表</strong></li></ul><p>除了状态迁移图，我们还可以用表格的形式来表示状态之间的关系。这种表一般称为状态迁移表。</p><p>表1就是前面介绍的那张状态迁移图的另一种描述形式。</p><p>表1 状态迁移表</p><div class=pgc-img><img alt=状态机思路在单片机程序设计中的应用 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/dfic-imagehandler/b007ce55-22af-4201-a4d7-501256429e02><p class=pgc-img-caption></p></div><p>①采用表格方式来描述状态机，优点是可容纳更多的文字信息。例如，我们不但可以在状态迁移表中描述状态的迁移关系，还可以把每个状态的特征描述也包含在内。</p><p>②如果表格内容较多，过于臃肿不利于阅读，我们也可以将状态迁移表进行拆分。经过拆分后的表格根据其具体内容，表格名称也有所变化。</p><p>③比如，我们可以把状态特征和迁移关系分开列表。被单独拆分出来的描述状态特征的表格，也可以称为“状态真值表”。这其中比较常见的就是把每个状态的显示内容单独列表。这种描述每个状态显示内容的表称之为“显示真值表”。同样，我们把单独表述基于按键的状态迁移表称为“按键功能真值表”。另外，如果每一个状态包含的信息量过多，我们也可以把每个状态单独列表。</p><p>④由此可见，状态迁移表作为状态迁移图的有益补充，它的表现形式是灵活的。</p><p>⑤状态迁移表优点是信息涵盖面大，缺点是视觉上不够直观，因此它并不能取代状态迁移图。比较理想的是将图形和表格结合应用。用图形展现宏观，用表格说明细节。二者互为参照，相得益彰。</p><ul><li><strong>用状态机思路实现一个时钟程序</strong></li></ul><p>接下来，我将就状态机的应用，结合流程图、状态迁移图和状态迁移，举一个实际例子。下面这张图是一个时钟程序的状态迁移图，如图2所示。</p><div class=pgc-img><img alt=状态机思路在单片机程序设计中的应用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/22531357-d030-4ac4-9606-80fe4916a599><p class=pgc-img-caption></p></div><p>图2 时钟程序状态迁移图</p><p>把这张图稍做归纳，就可以得到它的另一种表现形式——状态迁移表，如表2所示。</p><p>表2 时钟程序状态迁移表</p><div class=pgc-img><img alt=状态机思路在单片机程序设计中的应用 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/dfic-imagehandler/3fd46d73-341c-4172-b963-40e3c4728328><p class=pgc-img-caption></p></div><p>状态机应用的注意事项</p><p>基于状态机的程序调度机制，其应用的难点并不在于对状态机概念的理解，而在于对系统工作状态的合理划分。</p><p>初学者往往会把某个“程序动作”当作是一种“状态”来处理（本人就是）。我称之为“伪态”。那么如何区分“动作”和“状态”。本匠人的心得是看二者的本质：“动作”是不稳定的，即使没有条件的触发，“动作”一旦执行完毕就结束了；而“状态”是相对稳定的，如果没有外部条件的触发，一个状态会一直持续下去。</p><p>初学者的另一种比较致命的错误，就是在状态划分时漏掉一些状态。我称之为“漏态”。</p><p>“伪态”和“漏态”这两种错误的存在，将会导致程序结构的涣散。因此要特别小心避免。</p><p>更复杂的状态机</p><p>前面介绍的是一种简单的状态结构。它只有一级，并且只有一维，如图3所示。</p><div class=pgc-img><img alt=状态机思路在单片机程序设计中的应用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/9dc96157-01e2-45f4-8250-7f3cd97f4793><p class=pgc-img-caption></p></div><p>图3 线性状态机结构</p><p>如果有必要，我们可以建立更复杂的状态机模型。</p><p><strong>1 多级状态结构</strong></p><p>状态机可以是多级的。在分层的多级状态机系统里面，一个“父状态”下可以划分多个“子状态”，这些子状态共同拥有上级父状态的某些共性，同时又各自拥有自己的一些个性。（类的继承和派生）</p><p>在某些状态下，还可以进一步划分子状态。比如，我们可以把前面的时钟例子修改如下：</p><p>把所有和时钟功能有关的状态，合并成1个一级状态。在这个状态下，又可以划分出3个二级子状态，分别为显示时间、设置小时、设置分钟；</p><p>同样，我们也可以把所有和闹钟功能有关的状态，合并成1个一级状态。在这个状态下，再划分出4个二级子状态，分别为显示闹钟、设置“时”、设置“分”、设置鸣叫时间。</p><p>我们需要用另一个状态变量（寄存器）来表示这些子状态。</p><p>子状态下面当然还可以有更低一级的孙状态（子子孙孙无穷尽也），从而将整个状态体系变成了树状多级状态结构，如图4所示。</p><div class=pgc-img><img alt=状态机思路在单片机程序设计中的应用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/3ce56483-3025-47b9-8464-9058060e1bcd><p class=pgc-img-caption></p></div><p>图4 树状多级状态结构</p><p><strong>2 多维状态结构</strong></p><p>状态结构也可以是多维的。从不同的角度对系统进行状态的划分，这些状态的某些特性是交叉的。比如，在按照按键和显示划分状态的同时，又按照系统的工作进程做出另一种状态划分。这两种状态划分同时存在，相互交叉，从而构成了二维的状态结构空间。</p><p>举一个这方面的例子，如：空调遥控器，如图5所示。</p><div class=pgc-img><img alt=状态机思路在单片机程序设计中的应用 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/9ea85d31-613b-4789-a2f3-27f70c0757fd><p class=pgc-img-caption></p></div><p>图5 多维状态机结构</p><p>同样，我们也可以构建三维、四维甚至更多维的状态结构。每一维的状态都需要用一个状态变量（寄存器）来表示。</p><p>无论多级状态结构和多维状态结构看上去多么迷人，匠人的忠告是：我们依然要尽可能地简化状态结构，能用单级、单维的结构，就不要给自己找事，去玩那噩梦般的复杂结构。</p><p class=ql-align-center>简单的才是最有效的。</p><div class=pgc-img><img alt=状态机思路在单片机程序设计中的应用 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1540342050159a0321ec480><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>0</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'状态机','单片机','设计'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>