<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Stm32单片机开发KEIL启动文件汇编语言详解 | 极客快訊</title><meta property="og:title" content="Stm32单片机开发KEIL启动文件汇编语言详解 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/9a63184582d34eebb5e951834c301311"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7edacb46.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7edacb46.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7edacb46.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7edacb46.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7edacb46.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7edacb46.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7edacb46.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7edacb46.html><meta property="article:published_time" content="2020-11-14T21:04:32+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:32+08:00"><meta name=Keywords content><meta name=description content="Stm32单片机开发KEIL启动文件汇编语言详解"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/7edacb46.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Stm32单片机开发KEIL启动文件汇编语言详解</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>文章目录</h1><ol><li><strong>简介</strong></li><li><strong>启动文件汇编代码相关指令</strong></li><li><strong>堆栈空间的定义</strong></li><li><strong>初始化中断向量表</strong></li><li><strong>复位中断函数</strong></li><li><strong>中断函数的弱（WEAK）声明</strong></li><li><strong>用户栈和堆初始化</strong></li></ol><h1><strong>简介</strong></h1><p>我们在做单片机编程的时候，大部分都是用KEIL自带的启动文件来使程序进入C语言main函数，然后进行C语言编程开发的工作。那么这个启动文件到底做了什么呢？相信朋友们肯定和我一样好奇，想弄明白启动文件到底都干了些什么。那么本文就来介绍下，本文介绍stm32启动文件汇编代码，对应文件名startup_stm32f10x_hd.s。其他Cortex-M3内核的单片机都是大同小异的。</p><p>其实启动文件存在的目的就是构建可以供C语言代码运行的工作环境，比如传递参数时需要的栈空间初始化，动态分配内存时的堆初始化，一些初始化为0的变量空间的初始化等等。如果这些没有配置好，无法达到C语言代码运行的工作环境，那么后面的C语言代码执行的结果就是不对的，也会导致总个系统无法工作。所以启动文件很重要，也正是因为我们觉得它重要，所以才想搞懂它。</p><p>startup_stm32f10x_hd.s启动文件中的汇编代码主要做了下面5个工作。</p><p>1.堆栈空间的定义；</p><p>2.初始化中断向量表；</p><p>3.复位中断函数（Reset_Handler）{系统初始化，然后进入main函数}；</p><p>4.中断函数的弱（WEAK）声明</p><p>5.用户栈和堆初始化</p><p>再介绍这5个部分的详细代码前，这里已经先总结了启动文件中用到的汇编代码与编译器相关的指令，下面就先来介绍下这些指令。</p><h1><strong>启动文件汇编代码相关指令</strong></h1><p>启动文件代码主要由ARM指令代码和与编译器相关的汇编指令组成，下表罗列了启动文件中用到的相关汇编指令。</p><div class=pgc-img><img alt=Stm32单片机开发KEIL启动文件汇编语言详解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9a63184582d34eebb5e951834c301311><p class=pgc-img-caption></p></div><p>上面只是对指令做了简要的说明，后面代码用到时我们再一一讲解。我们也可以通过在代码中选中指令，按F1按键调出帮助说明，查看具体指令的相关介绍。</p><div class=pgc-img><img alt=Stm32单片机开发KEIL启动文件汇编语言详解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1ce62ba6eb8d461d9cc185a0e88a3f94><p class=pgc-img-caption></p></div><p>接下来我们就对代码做详细分析吧。</p><h1><strong>一、堆栈空间的定义</strong></h1><div class=pgc-img><img alt=Stm32单片机开发KEIL启动文件汇编语言详解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a78595099e704149a7ed051ad1f79bb8><p class=pgc-img-caption></p></div><p>首先这里使用指令EQU定义了一个数值常量符号Stack_Size指明栈大小为0x00000400即1K，这个值可以根据实际需求更改。使用QEU定义常数，类似与C语言的#define定义常数。</p><p>然后这里又使用指令AREA定义了一个未初始化，可以读写并要求8字节边界对齐的段，段名,为STACK。这里可以为段选择任何段名。但是，以一个数字开始的名称必须包含在竖杠号内，否则会产生一个缺失段名错误。例如， |1_DataArea|。有些名称是习惯性的名称。例如，|.text| 用于表示由 C 编译程序产生的代码段，或用于以某种方式与 C 库关联的代码段。这里的NOINIT表示数据段是未初始化的或初始化为零。其只包含零初始化的空间保留命令 SPACE 或 DCB, DCD, DCDU, DCQ, DCQU, DCW 或 DCWU 。可以决定在链接时 AREA 是未初始化的，还是零初始化的，后面一条指令是SPACE，所以这里要初始化为0，READWRITE指明段可以读写，ALIGN=3指明段要在2^3=8字节边界上对齐。</p><p>再然后使用SPACE定义了一个初始化为0的存储块Stack_Mem，可以理解为存储块是归别到段里的。标号__initial_sp紧挨着SPACE语句放置，表示栈的结束地址，即栈顶地址，栈是由高向低生长的。</p><p>同样的堆也是这样定义的，只是这里先是指明了堆开始__heap_base（堆起始地址），再指明堆存储块，最后指明__heap_limit（堆终止地址）。堆是由低向高生长的，跟栈的生长方向相反。堆主要用来动态内存的分配，像malloc()函数申请的内存就在堆上面。这里堆默认大小为0x00000200即512字节，一般的程序中我们很少用到malloc函数，所以这里也就不做过多更改，如果要使用malloc函数，需要将此处堆大小定义的值根据需求改大。</p><p>后面的PRESERVE8，指明当前文件的堆栈按照8字节对齐。</p><h1><strong>二、初始化中断向量表</strong></h1><div class=pgc-img><img alt=Stm32单片机开发KEIL启动文件汇编语言详解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3e5171b6661a4b0c81726386e947dc17><p class=pgc-img-caption></p></div><p>THUMB指示汇编器将随后的指令解释为16位的Thumb指令。Cortex-M3使用的是Thumb-2指令集，是一种介于Thumb指令集和ARM指令集。ARM指令集全部是32位的，Thumb指令集全部是16位的，Thumb-2指令集是即有部分16位Thumb指令的也有部分32位的ARM指令。</p><p>后面定义一个只读数据段RESET，用于保存中断向量表，和三个标号__Vectors（向量表开始）、__Vectors_End（向量表结束）和__Vectors_Size（向量表大小）并使用EXPORT指明其具有全局性。这样可以使在其他文件中访问此文件中的这三标号。</p><p>DCD 命令分配一个或多个字的存储器，在四个字节的边界上对齐，并定义存储器的运行时初值。</p><p>__Vectors DCD __initial_sp ; Top of Stack</p><p>这里就指示了段的开始为向量表的开始，标号__Vectors（向量表开始）编译器会根据不同单片机为其指定值，比如stm32单片机就是0x08000000,然后我们定义的RESET段就被分在了0x08000000开始的地址处，其结束位置就是从0x08000000开始依次加4个字节，因为这里每个DCD命令占存储器4个字节，这样一直到__Vectors_End（向量表结束），__Vectors_Size（向量表大小）就是这个RESET段所占大小。比如复位的时候，复位中断来了，就从这个段的第二个存储地址0x08000004处对应的值0x08000144作为复位函数Reset_Handler的地址。</p><h1><strong>三、复位中断函数</strong></h1><div class=pgc-img><img alt=Stm32单片机开发KEIL启动文件汇编语言详解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6d167c2a0c574d3d840d705f99b205a8><p class=pgc-img-caption></p></div><p>这里先使用AREA定义了一个只读代码段。这里的标号Reset_Handler就代表了复位函数的入口地址（函数名），使用PROC标记函数入口，使用ENDP标记函数结束。</p><p>EXPORT Reset_Handler [WEAK]</p><p>这里EXPORT声明Reset_Handler是一个全局性的。WEAK表示其他地方没有定义Reset_Handler函数时，就将此处作为Reset_Handler函数的实例。IMPORT用于指示如果在当前汇编代码中未找到其引用，则不导入该名称，很显然，下面有用到__main和SystemInit。</p><p>从上那些代码我就就知道，程序上电后，从0x08000000地址处加载SP，上电复位从0x08000004处加载PC，0x08000004处的地址就是复位函数的地址，然后复位函数里面先调用SystemInit函数来初始化系统的各种时钟，再调用__main函数（由编译器实现）。</p><p>复位函数中用到的Thumb-2指令介绍如下：</p><p>LDR从存储器中加载字到一个寄存器中</p><p>BL跳转到由寄存器/标号给出的地址，并把跳转前的下条指令地址保存到LR</p><p>BLX跳转到由寄存器给出的地址，并根据寄存器的LSE确定处理器的状态，还要把跳转前的下条指令地址保存到LR</p><p>BX跳转到由寄存器/标号给出的地址，不用返回</p><h1><strong>四、中断函数的弱（WEAK）声明</strong></h1><div class=pgc-img><img alt=Stm32单片机开发KEIL启动文件汇编语言详解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0428237a42fc49189de0660d8bfeaa50><p class=pgc-img-caption></p></div><p>这里定义了各种中断函数，使用PROC表示函数开始，ENDP表示函数结束，EXPORT说明函数的全局性，WEAK说明如果其他地方没有定义这个函数，那么就把此处作为函数的实例。这里函数的代码都是B . 。这里的B表示跳转到一个标号，这里跳转到一个'.'，即表示无限循环，所以我们在写C语言程序时如果没有写中断函数，那么对应的中断来了会运行这里到中断函数，即B .那么将无限循环在此。</p><div class=pgc-img><img alt=Stm32单片机开发KEIL启动文件汇编语言详解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/630759fb9c6f4a9c860a1f5dd0d2e1dd><p class=pgc-img-caption></p></div><p>ALIGN命令通过用零或空指令NOP填充，来使当前位置与一个指定的边界对齐。使用ALIGN来确保数据和代码对齐到适当的边界上。这里使用了默认为字对齐方式。</p><h1><strong>五、用户栈和堆初始化</strong></h1><div class=pgc-img><img alt=Stm32单片机开发KEIL启动文件汇编语言详解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/af5ec5590a91482297bc7b54a8573eca><p class=pgc-img-caption></p></div><p>栈和堆初始化部分，这里IF、ELSE、ENDIF是条件编译。</p><p>先判断是否定义了__MICROLIB ，如果定义了则赋予标号__initial_sp（栈顶地址）、__heap_base（堆起始地址）、__heap_limit（堆结束地址）全局属性，可供外部文件调用，这样我们使用到molloc函数申请的空间就是从这里有关堆的两个标号之间的内存中申请的。如果没有定义（实际的默认情况就是我们没定义__MICROLIB）则通过 IMPORT __use_two_region_memory 表明使用双段模式，即一部分储存区用于栈空间，其他的存储区用于堆空间，堆区空间可以为0，但是，这样就不能调用malloc()内存分配函数。然后使用__user_initial_stackheap标号处的代码用于初始化用户堆栈，这部分由编译器提供的__main来调用。</p><p>END 命令指示汇编器，已到达一个源文件的末尾。</p><p>关于STM32单片机的Keil启动文件汇编代码就讲解完了，大家有没有看明白呢，欢迎评论交流，如果觉得我这篇文章写到很好到话，就转发出去分享给更多到朋友吧。最后欢迎大家点赞评论转发收藏，跟多好文章欢迎关注我——<strong>单片机嵌入式爱好者</strong>。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Stm32','单片','机开发'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>