<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>电子那点事： STM32F103 中断软硬件讲解 | 极客快訊</title><meta property="og:title" content="电子那点事： STM32F103 中断软硬件讲解 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/329116c018af48f9b995c20c4b73c8fc"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7f23fb6.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7f23fb6.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7f23fb6.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7f23fb6.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7f23fb6.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7f23fb6.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7f23fb6.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7f23fb6.html><meta property="article:published_time" content="2020-10-29T20:50:02+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:02+08:00"><meta name=Keywords content><meta name=description content="电子那点事： STM32F103 中断软硬件讲解"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/7f23fb6.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>电子那点事： STM32F103 中断软硬件讲解</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>由于 STM32F103 是基于 ARM Cortex M3 内核设计的，因此我们先了解一下 ARM Cortex M3 的中断，M3 内核的中断分为两大部分，第一部分是系统中断，一共有 16 个，第二部分是 留给芯片厂家的 240 的外设中断（这两部分加起来一共有 256 个中断）。但是芯片厂家可能 用不上 240 个外设中断，因此会对其进行裁剪，我们的 STM32F103 只是用了 60 个外设中断。 下面我们看一下 STM32F103 这 76 个中断（16 个系统中断有些是预留的，有意义的系统中断 为 10 个。另外中断优先级数越小优先级别越高）：</p><div class=pgc-img><img alt="电子那点事： STM32F103 中断软硬件讲解" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/329116c018af48f9b995c20c4b73c8fc><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="电子那点事： STM32F103 中断软硬件讲解" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6e573eaef60e4cc493f07e9527632fad><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="电子那点事： STM32F103 中断软硬件讲解" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e0435e2d2d4a48dba21b04e53d7384bd><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="电子那点事： STM32F103 中断软硬件讲解" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8fad3f91cfe34524ac9cde4a71e5091c><p class=pgc-img-caption></p></div><p>其中蓝色部分是系统的 16 个中断，其余 60 个为外设中断。另外除了三个中断优先级固 定外，剩余的中断优先级都是可以通过程序设置的，STM32 支持 16 个可编程优先级。 这里说一下和中断设置有关的名词： 中断使能/失能：中断使能的意思是让中断有效或者说是开中断，反之，失能则是关闭 中断。 中断挂起/解挂：当一个中断发生时，此时单片机正在执行和该中断同优先级或者更高 优先级的另外一个中断时，该中断将被挂起，直到另一个中断执行完才可解挂并执行，其实 就是根据中断优先级排队。 中断嵌套：正如前面图片表述那样，一个高优先级的中断打断了低优先级的中断的过程 就是中断嵌套，这样做使得不同优先级的中断能够按照优先级的大小依次执行，可以理解为 VIP 插队。 接下来我们看一下 STM32F103 中断的相关寄存器（这些寄存器是用于设置 STM32F103 的 60 个外设中断的）：</p><div class=pgc-img><img alt="电子那点事： STM32F103 中断软硬件讲解" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/27e17326336243748f128afa9e4196e1><p class=pgc-img-caption></p></div><p>该段代码位于 core_cm3.h 文件中，它定义的是就是 STM32 的中断相关寄存器。我们依 次讲解一下。</p><p>⚫ 中断使/失能寄存器（ISER/ICER）</p><p>ISER 用于使能某个中断，寄存器中的一个位对应着一个中断，写 1 就使能，写 0 被忽 略。由于 CM3 内核最多支持 240 个外设中断，因此 ISER 是由 8 个 32 位的寄存器组成（只不 过剩余的最高 16 位没有用到），而 STM32F103 只有 60 个中断，因此只用到了 ISER[0]和 ISER[1]的低 28 位。 同理，ICER 用于设置 STM32 的中断失能，写 1 失能，写 0 忽略。</p><p>⚫ 中断挂起/解挂寄存器(ISPR/ICPR)</p><p>这两组寄存器用于设置中断挂起和解挂，操作和中断使/失能寄存器一致。</p><p>⚫ 活动中断标志寄存器</p><p>字面理解就是用于记录此时正在执行中断的寄存器，如果一个中断被执行，那么该中断 对应位就会被置 1，即使该中断被其他更高优先级的中断打断，只要该中断没有执行完就一 直保持 1 的状态，直到中断服务函数执行完才会被自动清零。</p><p>⚫ 中断优先级寄存器(IP)</p><p>中断优先级寄存器用于设置每个中断的优先级，CM3 内核最大支持 240 个外设中断并为 每个中断分配了 8 位可编程优先级，但是 STM32F103 只用到了 60 个中断优先级寄存器，而 且每个中断只用到了高四位来设置中断优先级。这高四位又被分组为两部分优先级：抢占优 先级和子优先级（也可以叫响应优先级或者亚优先级）。一个中断是否需能够抢占其他中断 由三个因素决定：抢占优先级，子优先级，中断编号。 先说抢占优先级，如果中断 A 的抢占优先级比中断 B 的抢占优先级高，那么不管这两个 中断的子优先级和中断编号是什么，A 都会抢占 B，或者说发生 B 的时候 A 在执行，那么 B 会被挂起。 当 A、B 两个中断的抢占优先级相同的情况下，且 A 的子优先级比 B 高，那么当他们同 时发生或者同时解挂的时候会优先执行 A,如果 A 中断发生的时候 B 中断正在执行，那么 A也不会抢占 B，而是要挂起，等待正在执行的 B 中断执行完成才执行 A 中断。 当两个中断的抢占优先级和子优先级都相同的情况下且两个中断一起发生时，则根据中 断编号进行响应（号小的先响应）。</p><p>⚫ 软件触发中断寄存器(STIR)</p><p>用户可以通过写该寄存器来手动的触发对应中断，比如写入 0x08，则触发中断编号 8 的 中断。 下面说一下中断分组，STM32 的中断分组由 AIRCR 寄存器的 10-8 位控制：</p><div class=pgc-img><img alt="电子那点事： STM32F103 中断软硬件讲解" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/10de6d63f9db4c628fb4a4d45c4f5192><p class=pgc-img-caption></p></div><p>该中断分组设置是全局的，例如此时将中断优先级分组设置为第三分组，那么对于所有 的外设中断来说，都将使用这种分组方式。STM32F103 的中断共分为 5 组：</p><div class=pgc-img><img alt="电子那点事： STM32F103 中断软硬件讲解" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8de42f84fc6142bdbac2e02faf4d4134><p class=pgc-img-caption></p></div><p>就拿 2 组为例，此时抢占优先级的取值范围是 0~3，子优先级取值范围也是 0~3， 分组的好处是可以扩展优先级的功能。我们在配置中断的时候，一般要做两个工作：</p><p>1. 在一开机就设置中断分组，且在下次重启之前最好不要再进行分组设置。我们看一下设 置中断分组的函数（位于 misc.c）：</p><div class=pgc-img><img alt="电子那点事： STM32F103 中断软硬件讲解" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d4c158821ac1418ea00027be54f9540b><p class=pgc-img-caption></p></div><p>该函数先检查参数是否合理，然后将该分组号赋给 AIRCR 寄存器，其中的 AIRCR_VECTKEY_MASK 是该寄存器的访问秘钥，对该寄存器写操作就必须先填入秘钥。我们 此时将其设置为分组 2: NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);</p><p>2. 设置相应外设的中断，设置内容选择某个外设中断并设置它的抢占优先级和子优先级。 代码如下（以外部中断 0 为例）：</p><div class=pgc-img><img alt="电子那点事： STM32F103 中断软硬件讲解" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/22887d60ccd047dcbd1cdf342ecd8b59><p class=pgc-img-caption></p></div><p>本章需要大家掌握的是 STM32 的分组概念以及根据分组设置中断优先级，在程序上其 实只需要两步即可，第一步是开机分组，第二步是设置对应中断优先级并使能。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'电子','那点','STM32F103'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>