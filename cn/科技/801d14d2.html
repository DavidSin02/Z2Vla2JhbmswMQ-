<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>使用Memory Leak进行内存泄漏查找 | 极客快訊</title><meta property="og:title" content="使用Memory Leak进行内存泄漏查找 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/42047080a6c143b8a4d08d12c7358f40"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/801d14d2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/801d14d2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/801d14d2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/801d14d2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/801d14d2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/801d14d2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/801d14d2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/801d14d2.html><meta property="article:published_time" content="2020-11-14T20:55:17+08:00"><meta property="article:modified_time" content="2020-11-14T20:55:17+08:00"><meta name=Keywords content><meta name=description content="使用Memory Leak进行内存泄漏查找"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/801d14d2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>使用Memory Leak进行内存泄漏查找</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>备注：这是三年前还在做游戏项目时分享的一篇文章，虽然已经过去三年，但其中所涉及的方法却一直都在使用，因此再贴出来，希望能帮到一部分程序工程师朋友。</p><p>在项目的整个开发过程中一直伴随着手机客户端的内存问题，时不时的也会出现一些内存导致的Crash情况，出现Crash的原因可能会有很多，但在IOS设备上很多常常是由于内存吃紧导致的，如果出现内存不够用而Crash的一个直观表现是在Iphone 6 plus设备上更容易重现，这是由于6P的内存只有1G，但由于该设备屏幕更大而需要更多的Frame buffer空间，因此在该IOS 设备的内存最为吃紧。</p><p>很多内存问题在PC的开发阶段就可以暴露出现，这种情况比较容易处理，毕竟PC上工具链很丰富，本文要探讨的问题是在IOS设备上导致的一些问题，本文也介绍工具是Xcode的Instruments提供的Memory Leaks工具，如图，由下图中可以看出Instruments提供了很多工具可供开发使用，其它工具慢慢摸索。</p><div class=pgc-img><img alt="使用Memory Leak进行内存泄漏查找" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/42047080a6c143b8a4d08d12c7358f40><p class=pgc-img-caption></p></div><p>如何启动Leaks工具，参考官方文档[自行搜索吧，头条不允许放外链]<br></p><p><strong>发现问题：</strong></p><p>在Xcode中启动游戏后，使用内存监控工具查看内存的变化情况，发现当场景Load完成后一段时间内内存是稳定的，然后过段时间内存突然涨了赶来，如下图所示。出现这个问题第一个反应是去检查了一下代码逻辑，打出了一些Log后也没有发现有哪里会突然需要分配这么多的内存，纠结了一会之后突然想来Xcode提供的Memory Profile工具，于是乎有了后面的内容。</p><div class=pgc-img><img alt="使用Memory Leak进行内存泄漏查找" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7c226c13357f4c15b6bcc2809fe9a4bf><p class=pgc-img-caption></p></div><p>选择游戏项目，使用Leaks工具启动Record功能，在游戏内跑一下游戏，得到了如下的内存使用时间序列图，首先从图中可以看出Neox引擎在启动游戏不久之后就出现了内存泄漏（图中红色的叉），占进去看一下吧^^，所幸这些Leaks并非是导致内存暴涨的原因。</p><div class=pgc-img><img alt="使用Memory Leak进行内存泄漏查找" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/026c5bc9c36a4309bfead88d68b3fce0><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="使用Memory Leak进行内存泄漏查找" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6b4051cf1cb54b86b105e2411e9a8d66><p class=pgc-img-caption></p></div><p><br>粗略看了一上内存泄漏的部分，可以看出这些漏泄并不是本次关心的重点，重点是最内存使用图中最后一次的增长，那么这一时间段内到底是什么占用了内存呢？所幸Instruments给我们提供了查看某一时间段内内存分配的功能，好了，现在就我们把锁定到第40s左右来看看。</p><div class=pgc-img><img alt="使用Memory Leak进行内存泄漏查找" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1df60aa9f5574984a586d4524da10529><p class=pgc-img-caption></p></div><p>如图中蓝色部分，时间 大概是39s-42s之间，这段时间内内存增加了大约70M, Allocation Summary部分给出了这段时间内内存的分配情况。从图中我们可以看到有一个68M的内存分配，那么这些内存是分配给谁了呢？带着这个问题，我们一层一层的点进去看看究竟吧。</p><div class=pgc-img><img alt="使用Memory Leak进行内存泄漏查找" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/04666cd6329d47ff88246a9861898ca5><p class=pgc-img-caption></p></div><p>进去之后，我们对分配内存的操作进行排下序，会发现有10次的内存分配操作，每次分配了6.6M的内存。也即是说这段时间内NXMemoryFile分配了66M的内存。还好在这一步我们还可以继续往下深入分析，最终定位到分配内存的那段代码：</p><div class=pgc-img><img alt="使用Memory Leak进行内存泄漏查找" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/550ce5ecd84c4f7e905ca333682d1bca><p class=pgc-img-caption></p></div><p>至此，可以说是找到了内存暴涨的主要原因的线索，由于NXMemoryFile是一个基础的模块，其实我们还没有找到究竟是谁调用了这段代码，其实到了这一步问题就变得很简单了，加个断点，根据call stack来查找问题源头。ps, 由于Xcode出了点问题，执行断点时加载不出来了调用栈，这里面就不贴图了，栈的源头是_audio.cpp模块加载fsb文件。为什么fsb文件的加载会导致内存的暴涨呢？</p><p>FMOD模块在加载fsb时，以流的方式读取解压文件，所以播放FSB格式的音频文件理论上来说不会导致太多的内存增长，而问题是我们将fsb文件打入了NPK文件内部，因为Fmod模块没有办法直接使用流的方式读取npk文件，因此为了能够加载npk内的fsb文件，neox里面有一个基于内存的文件系统NXMemoryFile，先将文件读取到内存中，然后fmod才能以文件的形式加载fsb数据，因此也就导致了内存的暴涨。</p><p>另外（由于没看Fmod代码，这是根据程序运行时的表现猜测的）Fmod在读fsb时应该是open一个文件，然后持有一个handler，而每一个handler对应一个内存文件，这也就导致了同一份fsb文件在内存中会有多个内存文件。</p><p>既然定位到问题是由于将FSB文件打入npk导致的，那么就尝试将fsb文件从npk文件中分离出来，下图是不再将fsb打入npk的客户端的运行情况，内存的使用情况较先前有了很大的好转，同时在不同设备上运行一段时间之后，crash的情况也确实变得很少了。</p><div class=pgc-img><img alt="使用Memory Leak进行内存泄漏查找" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b4d5aa2b130444dbb3564ccfb0a07c99><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Memory','Leak','进行'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>