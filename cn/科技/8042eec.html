<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Redis规约-初稿 | 极客快訊</title><meta property="og:title" content="Redis规约-初稿 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/1977cc3894834fe8a3b262ed560f3e91"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8042eec.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8042eec.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8042eec.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8042eec.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8042eec.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8042eec.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8042eec.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8042eec.html><meta property="article:published_time" content="2020-10-29T21:01:26+08:00"><meta property="article:modified_time" content="2020-10-29T21:01:26+08:00"><meta name=Keywords content><meta name=description content="Redis规约-初稿"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/8042eec.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Redis规约-初稿</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right><u>参考阿里云Redis设计规范</u></h1><h1 class=pgc-h-arrow-right>一、键值设计</h1><h1 class=pgc-h-arrow-right><strong>1. key名设计</strong></h1><h1 class=pgc-h-arrow-right>(1)【建议】: 可读性和可管理性</h1><p>以业务名(或数据库名)为前缀(防止key冲突)，用冒号分隔，比如业务名:表名:id</p><div class=pgc-img><img alt=Redis规约-初稿 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1977cc3894834fe8a3b262ed560f3e91><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>(2)【建议】：简洁性</h1><p>保证语义的前提下，控制key的长度，当key较多时，内存占用也不容忽视，例如：</p><div class=pgc-img><img alt=Redis规约-初稿 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/780fe3a6446a4c06aa517b11c8303bad><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>(3)【强制】：不要包含特殊字符</h1><p>反例：包含空格、换行、单双引号以及其他转义字符</p><h1 class=pgc-h-arrow-right><strong>2. value设计</strong></h1><h1 class=pgc-h-arrow-right>(1)【强制】：拒绝bigkey(防止网卡流量、慢查询)</h1><p>string类型控制在10KB以内，hash、list、set、zset元素个数不要超过5000。</p><p><strong>反例</strong>：一个包含200万个元素的list。</p><p>非字符串的bigkey，不要使用del删除，使用hscan、sscan、zscan方式渐进式删除，同时要注意防止bigkey过期时间自动删除问题(例如一个200万的zset设置1小时过期，会触发del操作，造成阻塞，而且该操作不会不出现在慢查询中(latency可查))，查找方法和删除方法</p><h1 class=pgc-h-arrow-right>(2)【推荐】：选择适合的数据类型。</h1><p>例如：实体类型(要合理控制和使用数据结构内存编码优化配置,例如ziplist，但也要注意节省内存和性能之间的平衡)</p><p><strong>反例</strong>：</p><div class=pgc-img><img alt=Redis规约-初稿 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ebd867d5d5ec4d84ab5eb619d3f67bed><p class=pgc-img-caption></p></div><p><strong>正例</strong>:</p><div class=pgc-img><img alt=Redis规约-初稿 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ba5ccf1861e045b8bbb05e8cbd2d6397><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>(3)【推荐】：控制key的生命周期，redis不是垃圾桶。</h1><p>建议使用expire设置过期时间(条件允许可以打散过期时间，防止集中过期)，不过期的数据重点关注idletime。</p><h1 class=pgc-h-arrow-right>二、命令使用</h1><h1 class=pgc-h-arrow-right><strong>1.【推荐】 O(N)命令关注N的数量</strong></h1><p>例如hgetall、lrange、smembers、zrange、sinter等并非不能使用，但是需要明确N的值。有遍历的需求可以使用hscan、sscan、zscan代替。</p><p><strong>2.【推荐】：禁用命令</strong></p><p>禁止线上使用keys、flushall、flushdb等，通过redis的rename机制禁掉命令，或者使用scan的方式渐进式处理。</p><p><strong>3.【推荐】合理使用select</strong></p><p>redis的多数据库较弱，使用数字进行区分，很多客户端支持较差，同时多业务用多数据库实际还是单线程处理，会有干扰。</p><p><strong>4.【推荐】使用批量操作提高效率</strong></p><p>原生命令：例如mget、mset。</p><p>非原生命令：可以使用pipeline提高效率。</p><p>但要注意控制一次批量操作的元素个数(例如500以内，实际也和元素字节数有关)。</p><p><strong>注意两者不同</strong>：</p><ol start=1><li>原生是原子操作，pipeline是非原子操作。</li><li>pipeline可以打包不同的命令，原生做不到</li><li>pipeline需要客户端和服务端同时支持。</li></ol><p><strong>5.【建议】Redis事务功能较弱，不建议过多使用</strong></p><p>Redis的事务功能较弱(不支持回滚)，而且集群版本(自研和官方)要求一次事务操作的key必须在一个slot上(可以使用hashtag功能解决)</p><p><strong>6.【建议】Redis集群版本在使用Lua上有特殊要求：</strong></p><p>a. 所有key都应该由 KEYS 数组来传递，redis.call/pcall 里面调用的redis命令，key的位置，必须是KEYS array, 否则直接返回</p><pre><code>error，"-ERR bad lua script for redis cluster, all the keys that the script uses should be passed using the KEYS array"</code></pre><p><br></p><pre><code>error, "-ERR eval/evalsha command keys must in same slot" </code></pre><p><br></p><p><strong>7.【建议】必要情况下使用monitor命令时，要注意不要长时间使用。</strong></p><h1 class=pgc-h-arrow-right>三、客户端使用</h1><p><strong>1.【推荐】</strong></p><p>避免多个应用使用一个Redis实例</p><p><strong>正例</strong>：不相干的业务拆分，公共数据做服务化。</p><p><strong>2.【推荐】</strong></p><p>使用带有连接池的数据库，可以有效控制连接，同时提高效率：</p><p><strong>3.【建议】</strong></p><p>高并发下建议客户端添加熔断功能(例如netflix hystrix)</p><p><strong>4.【推荐】</strong></p><p>设置合理的密码，如有必要可以使用SSL加密访问（阿里云Redis支持）</p><p><strong>5.【建议】</strong></p><p>根据自身业务类型，选好<strong>maxmemory-policy(</strong>最大内存淘汰策略)，设置好过期时间。</p><p>默认策略是<strong>volatile-lru</strong>，即超过最大内存后，在过期键中使用lru算法进行key的剔除，保证不过期数据不被删除，但是可能会出现OOM问题。</p><p><strong>其他策略如下</strong>：</p><ul><li><strong>allkeys-lru</strong>：根据LRU算法删除键，不管数据有没有设置超时属性，直到腾出足够空间为止。</li><li><strong>allkeys-random</strong>：随机删除所有键，直到腾出足够空间为止。</li><li><strong>volatile-random</strong>:随机删除过期键，直到腾出足够空间为止。</li><li><strong>volatile-ttl</strong>：根据键值对象的ttl属性，删除最近将要过期数据。如果没有，回退到noeviction策略。</li><li><strong>noeviction</strong>：不会剔除任何数据，拒绝所有写入操作并返回客户端错误信息"(error) OOM command not allowed when used memory"，此时Redis只响应读操作。</li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Redis','规约','初稿'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>