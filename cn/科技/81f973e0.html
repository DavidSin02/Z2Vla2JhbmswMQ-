<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>8583报文实例讲解(A) | 极客快訊</title><meta property="og:title" content="8583报文实例讲解(A) - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/8fc06edc28db43f6bd1299ec54f240d3"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/81f973e0.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/81f973e0.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/81f973e0.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/81f973e0.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/81f973e0.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/81f973e0.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/81f973e0.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/81f973e0.html><meta property="article:published_time" content="2020-10-29T21:09:08+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:08+08:00"><meta name=Keywords content><meta name=description content="8583报文实例讲解(A)"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/81f973e0.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>8583报文实例讲解(A)</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>中文名</strong></p><p>8583协议</p><p><strong>位图位置</strong></p><p>1</p><p><strong>格 式</strong></p><p>定长</p><p><strong>类 型</strong></p><p>B16（二进制16字节，16*8=128bit)</p><p><strong>8583协议简介</strong></p><p>ISO8583报文（简称8583包）又称8583报文是一个国际标准的包格式，最多由128个字段域组成，每个域都有统一的规定，并有定长与变长之分。</p><p>8583包前面一段为位图，用来确定包的字段域组成情况。</p><p>其中位图是8583包的灵魂，它是打包解包确定字段域的关键， 而了解每个字段域的属性则是填写数据的基础。在POS机的开发上时经常要用到，例如回头客会员管理系统在POS机上的应用就是采用8583报文。</p><p>简单介绍下ISO8583。</p><p>这个东西说白了就是一种数据结构。我们定义一种规则把一堆东西放进去，再按照规则</p><p>把数据正确拿出来。这就是报文的实质。</p><p>ISO8583报文的结构是：前面有16字节（128位）位图数据，后面就是数据。</p><p>报文最多有128个域（字段）。具体的一个报文不会有这么多，一般是几个域。</p><p>有哪几个就记录在位图中。而且域有定长和变长之分。</p><p>这些都是事先定义好的，具体可以看我写的properties定义文件.</p><p>位图转化成01字符串就是128个，如果某一位是1，代表这个域有值，然后按照properties定义的规则取值。</p><p>如果是0，则这个域没有值。</p><p>再说定长和变长。</p><p>定长域(定长比较好理解，一个字段规定是N位，那么字段值绝对不能超过N位，不足N位就在后面补空格)</p><p>变长域(变长域最后组装成的效果：例如变长3位，定义var3，这里的3是指长度值占3位，字段值是123456，最后结果就是006123456)</p><p><strong>注意（变长的长度按照域值得字节长度计算，而不是按照域值字符串长度算！）</strong></p><h1><strong>8583协议描述</strong></h1><p>描述：</p><p>如将位图的第一位设为'1'，表示使用扩展位图（128个域），否则表示只使用基本位图（64个域）。</p><p>如使用某数据域，应该在位图中将相应的位设位'1'，如使用41域，需将位图的41位设为'1'。</p><p>如：(64个域)0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 1000 0000 0000 0000 0000 0000</p><p>第41位为1</p><p>选用条件：如使用65到128域，需设位图域第一位为'1'</p><h1>报文格式定义</h1><p>POS终端上送POS中心的消息报文结构包括TPDU、报文头和应用数据三部分：</p><div class=pgc-img><img alt=8583报文实例讲解(A) onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8fc06edc28db43f6bd1299ec54f240d3><p class=pgc-img-caption></p></div><p>—— TPDU说明：长度为10个字节, 压缩时用BCD码表示为5个字节长度的数值。</p><p>—— 报文头说明：总长度为12字节，压缩时用BCD码表示为6个字节长度的数值。</p><p>在POS上送的请求/通知报文中，该数值由POS终端应用程序在打包上送时根据POS终端参数和当前状态填入应用类别、软件总版本号、终端状态和软件分版本号（具体指各厂商的程序版本号），用于POS中心根据数值进行相应的处理。</p><p>在POS中心返回的应答报文中，由POS中心填入处理要求，其他域保持原值返回，POS将根据收到报文头中的处理要求进行相应处理。</p><p>看懂8583报文需要知道的概念</p><p><strong>BCD码</strong>：用4位二进制数来表示1位十进制数中的0~9这10个数码。举个列子，’0x03 0x02’的BCD码表示为0X32，将前一个的低四位转移到后一个的高四位，具体实现会单独开一章。这里知道如何用即可。</p><h1><strong>8583协议域定义</strong></h1><p>typedef struct ISO8583</p><p>{</p><p>int bit_flag; /*域数据类型0 -- string, 1 -- int, 2 -- binary*/</p><p>char *data_name; /*域名*/</p><p>int length; /*数据域长度*/</p><p>int length_in_byte;/*实际长度（如果是变长）*/</p><p>int variable_flag; /*是否变长标志0：否 2：2位变长, 3：3位变长*/</p><p>int datatyp; /*0 -- string, 1 -- int, 2 -- binary*/</p><p>char *data; /*存放具体值*/</p><p>int attribute; /*保留*/</p><p>} ISO8583;</p><h1>ISO8583报文如下(十六进制表示法)：</h1><p>60 00 03 00 00 60 31 00 31 07 30 02 00 30 20 04 C0 20 C0 98 11 00 00 00 00 00 00 00 00 01 00 03 49 02 10 00 12 30 62 25 82 21 12 99 63 01 5D 15 11 10 10 00 00 35 36 38 35 32 33 31 34 32 33 35 32 31 34 35 32 36 38 35 39 32 33 36 31 35 36 C6 24 83 4D 36 7E 9E 9E 20 00 00 00 00 00 00 00 00 13 22 00 00 08 00 05 00 36 37 41 32 32 39 39 41</p><p>第一步</p><p>POS终端上送POS中心的消息报文结构包括TPDU、报文头和应用数据三部分：</p><p><strong>TPDU：</strong></p><p>总长度为10个字节,压缩时用BCD码表示为5个字节长度的数值。</p><p>ID：60H</p><p>目的地址:00 06</p><p>源地址:00 00</p><p><strong>报文头：</strong></p><p>总长度为12字节，压缩时用BCD码表示为6个字节长度的数值。</p><p>应用类别定义：N2</p><p>软件版本号:N2</p><p>终端状态:N1</p><p>处理要求:N1</p><p>保留使用:N6</p><p>在POS上送的请求/通知报文中，该数值由POS终端应用程序在打包上送时根据POS终端参数和当前状态填入应用类别、软件版本号和终端状态，</p><p>用于POSP根据数值进行相应的处理。在POSP返回的响应报文中，由POSP填入处理要求，其他域保持原值返回，POS将根据收到报文头中的处理要求进行相应处理。</p><p>报文头取值如下：</p><p>●应用类别定义：</p><p>目前只定义</p><p>磁条卡金融支付类应用为：60</p><p>IC卡金融支付类应用为： 61</p><p>磁条卡增值业务类支付为：62</p><p>IC卡增值业务类支付为： 63</p><p>●软件版本号：01</p><p>●终端状态： 1</p><p>●处理要求：1</p><p>●保留使用：以备后用</p><p><strong>应用数据说明：</strong></p><p>一般长度都是4个字节，压缩时用BCD码表示为2个字节的长度的数值。</p><p>所以上述报文中前五个字节为TPDU，即60 00 03 00 00</p><p>报文头占用六个字节，即 60 31 00 31 07 30</p><p>应用数据占用2个字节，即 02 00 也就是"0200"</p><p>0200金融类请求消息：</p><p>● POS查询请求。</p><p>● POS消费请求。</p><p>● POS消费撤销请求。</p><p>● POS预授权完成（请求）请求。</p><p>● POS预授权完成撤销请求。</p><p>● 电子现金脱机消费请求。</p><p>● 分期付款消费请求。</p><p>● 分期付款消费撤销请求。</p><p>● 基于PBOC电子钱包/电子现金的IC圈存类交易请求。</p><p>● 磁条卡现金充值请求。</p><p>第二步</p><p>分析位图：</p><p>首先取第十四个字节，即0x30 ，转化为二进制为0011 0000，在该字节的第一位为0（从左往右）表示当前报文中只需包括64个域，也就是从当前字节开始连续8个字节为位图（包括当前字节），如要包括128个域，该位为1。</p><p>现在进入关键的位图分析，现在我们取到了表示位图的8个字节即30 20 04 C0 20 C0 98 11，转为二进制为</p><p>00110000 00100000 00000100 11000000 00100000 11000000 10011000 00010001</p><p>位图中为1的位置即代表相应的域，在上面的二进制位中从左往右有第3位、第4位、第11位、第22位、第25位、第26位、第35位、第41位、第42位、第49位、第52位、第53位、第60位、第64位。</p><p>下面开始这些域中的数据，首先分析3域，3域为交易处理码，压缩成BCD码后占定长3个字节，我们从位图所占的8个字节后开始连续取3个字节，即 00 00 00，解压后即为“000000”，具体代表含义这里就不叙述了。</p><p>4域为交易金额，压缩成BCD码后占定长6个字节，同理取6个字节，即00 00 00 00 00 01，也就是金额0.01元，具体转换参考银联规范。</p><p>11域为受卡方系统跟踪号（流水号），压缩成BCD码占定长3个字节，同理取3个字节，即00 03 49，即000349。</p><p>22域为服务点输入方式码，压缩成BCD码占定长2个字节，同理取2个字节，即02 10，由于22域本身只占3个字节，压缩时左靠，右补0，所以转换为“021”，具体含义不再叙述。</p><p>25域为服务点条件码，压缩成BCD码占定长1个字节，同理取1个字节，即00，转换为“00”，“00”代表正常提交。</p><p>26域为服务点PIN获取码，压缩成BCD码占定长1个字节，同理取1个字节，即12，转换为“12”，表示服务点设备所允许输入的个人密码明文的最大长度为12。</p><p>解下来的35域由于不是定长，所以处理方法不同，先取一个字节，即30，转换为“30”,表示第二磁道的数据占用30个字节，取连续15个字节即62 25 82 21 12 99 63 01 5D 15 11 10 10 00 00，这里不对这串数据进行说明了。</p><p>41域为受卡机终端标识码，占8个字节的定长域，取35 36 38 35 32 33 31 34。</p><p>42域为受卡方标识码，占15个字节的定长域，取32 33 35 32 31 34 35 32 36 38 35 39 32 33 36。</p><p>49域为交易货币代码，占3个字节的定长域，取31 35 36。</p><p>52域为个人标识码数据，占8个字节的定长二进制数域，取C6 24 83 4D 36 7E 9E 9E。</p><p>53域为安全控制信息，压缩成BCD码占8个字节定长域，取20 00 00 00 00 00 00 00。</p><p>60域为自定义域，为不定长域，先取长度（压缩成BCD码占两个字节），即00 13，转换为13即占60域占13个字节，压缩成BCD码占7个字节，取22 00 00 08 00 05 00。</p><p>64域为报文鉴别码，占定长8个字节，取最后八个字节36 37 41 32 32 39 39 41。</p><h1>实例报文解析</h1><p>这里举个签到报文的例子。原始报文: 00 3B 60 00 06 00 00 60 22 00 00 00 00 08 00 00 20 00 00 00 C0 00 12 00 12 47 35 38 44 30 31 31 31 35 38 38 37 35 38 44 30 34 38 31 36 35 35 35 35 00 11 00 00 00 01 00 30 00 02 30 31</p><p>拿到原始报文后我们来拆分一下。根据上面的报文格式定义，我们先拆分出来TPDU和报文头：TPDU占5个字节，报文头占6个字节，还有报文的前两个字节是报文长度，那么：</p><p>报文长度：00 3B=59个字节</p><p>TPDU：60 00 06 00 00</p><p>Header：60 22 00 00 00 00</p><p>剩下的就是ISO8538的内容。看下签到报文内容：</p><div class=pgc-img><img alt=8583报文实例讲解(A) onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7ae3aef4adc84b899a49ae5a954a3e02><p class=pgc-img-caption></p></div><p>重要的是找到位图信息，</p><p>消息头2个字节：08 00</p><p>位图8个字节：00 20 00 00 00 C0 00 12</p><p>用位图分析工具分析出域的信息：</p><div class=pgc-img><img alt=8583报文实例讲解(A) onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e8a14c8ee87f47e09478a514d18397cd><p class=pgc-img-caption></p></div><p>从图上看域是11 41 42 60 63，到了这里就去看下规范中的域信息定义。</p><p>11域：00 12 47</p><p>41域：35 38 44 30 31 31 31 35</p><p>42域：38 38 37 35 38 44 30 34 38 31 36 35 35 35 35</p><p>60域：00 11 00 00 00 01 00 30——长度是00 11 值是00 00 00 01 00 30</p><p>63域：00 02 30 31——长度是0002 值是30 31</p><p>如下图：</p><div class=pgc-img><img alt=8583报文实例讲解(A) onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7c5d9bfac6134f9aa6e9d527615a29ad><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'8583','报文','实例'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>