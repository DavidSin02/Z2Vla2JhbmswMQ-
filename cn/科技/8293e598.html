<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MySQl事务最全详解 | 极客快訊</title><meta property="og:title" content="MySQl事务最全详解 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/c61163c863114226b14bb3760da19e4d"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8293e598.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8293e598.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8293e598.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8293e598.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8293e598.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8293e598.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8293e598.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8293e598.html><meta property="article:published_time" content="2020-11-14T21:08:12+08:00"><meta property="article:modified_time" content="2020-11-14T21:08:12+08:00"><meta name=Keywords content><meta name=description content="MySQl事务最全详解"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/8293e598.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MySQl事务最全详解</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>浪子编程走四方</p><p>作者:浪子编程走四方,勤记录，懂分享,刻意练习，日精进!</p><p>公众号:深夜有话聊</p><p>记得前些日子分享过一篇有关MySQL中事务的知识点,但当时对MySQL中的事务只是纯粹的知道如何使用,缺乏对理论的进一步认识,抽时间单独去了解了一下,便在做一个较为全面的总结.</p><blockquote><p>什么是事务?</p></blockquote><p>用MySQL官方的一句话来描述事务是什么?MySQL 事务主要用于处理操作量大,复杂度高的数据.那何为数据量大?何为复杂度高呢?我用我自己的理解来描述一下吧.事务其实就是MySQL中处理数据的一种方式,主要用在数据完整性高,数据之间依赖性大的情况下的一种数据处理方式.举个例子,小张向小李的银行卡打200块钱,在小张点击了确认转账的按钮时,系统突然崩溃了.会出现这样几中不正确的情况:</p><p>1.小张的钱打到小李的账户上,但是自己的账户上的钱没被扣.</p><p>2.小张的钱打没到小李的账户上了,但是自己账户上的钱被扣.</p><p>这样的业务场景就需要MySQL事务保持,即使机器出故障的情况下,数据仍然是正确的.</p><blockquote><p>事务使用的条件</p></blockquote><p>MySQL要使用事务,需要MySQL中的存储引擎支持.现目前MySQL内置的存储引擎支持事务的有InnoDB、NDB cluster,第三方的存储引擎有PBXT和XtrDB.</p><blockquote><p>事务有什么特点?</p></blockquote><p>MySQL中的事务有如下几个特点(ACID):</p><p><strong>原子性(atomicity):</strong></p><p>一个事务必须被作为一个不可分割的最小工作单元,每个事务中的所有操作必须要么成功,或者要么失败,永远不可能一些操作失败,一些操作成功,这就是所谓的原子性的概念.</p><p><strong>一致性(consistency):</strong></p><p>一致性就像上面举的一个例子一样,当发生异常情况下,数据仍然是正确的.就是说当一个事务执行失败了,数据之间是不会受异常的情况而影响,永远保持着他的正确性.</p><p><strong>隔离性(isolation):</strong></p><p>当一个事务还未提交,每个事务之间是相互隔离的,互补受到影响.</p><p><strong>持久性(durability):</strong></p><p>当一个事务进行提交之后,发生的变化就会永远保存在数据库中.</p><blockquote><p>事务的隔离级别</p></blockquote><p>在谈及到MySQL的隔离性的特点,就不得不说说隔离性的几种级别.至于为什么会涉及到这一点,可以这样简单的理解:如果同一时刻,有两个请求在执行事务的操作,并且这两个事务是对同一条数据做操作,那么到底最终的结果是以谁的为准呢?不同的隔离级别导致的结果不一样,因此事务的隔离级别也是一个非常重要的点.</p><p>隔离级别分为如下几点:</p><p><strong>1.未提交读(READ UNCOMMITTED)</strong></p><p>一个事务中对数据所做的修改,即使没有提交,这个修改对其他的事务仍是可见的,这种情况下就容易出现脏读,影响了数据的完整性.</p><p>举例:小明在用支付宝支付时,查看了银行卡的余额还有300块,其实只有100块,只是因为他女朋友正在向银行卡存款了200块,此时女朋友不想存了,点击了回滚操作,小明进行支付却失败了.</p><p><strong>2.读提交(READ COMMITTED)</strong></p><p>一个事务开始时,只能看见其他已经提交过的事务.这种情况下容易出现不可重复读(两次读的结果不一样).</p><p>举例:同样用上面的例子举例,当他女朋友在刷卡时卡里余额有100块,但是在点击最终支付时,提示余额不足,此时看卡里的钱没了.这是因为小明女朋友在支付时,小明操作的事务还未提交,所以小明女朋友两次看到的结果不一样.</p><p><strong>3.可重复读(REPEATABLE READ)</strong></p><p>多次读取记录的结果都是一致的,可重复读可以解决上面的不可重复读的情况.但是有这样一种情况,当一个事务在读取某个范围的记录时,另外一个事务在这个范围内插入了一条新的数据,当事务再次进行读取数据时,发现比第一次读取记录多了一条,这就是所谓的幻读,两次读取的结果不一致.</p><p>举例:小明女朋友在查看银行卡的记录时,看见有5条消费记录,此时小明正在消费,这时候消费记录里面记录了这条消费记录,当女朋友再次读取记录时,发现有6条记录了.</p><p><strong>4.可串行(SERIALIZABLE)</strong></p><p>串行就像一个队列一个样,每个事务都是排队等候着执行,只有前一个事务提交之后,下一个事务才能进行操作.这种情况虽然可以解决上面的幻读,但是他会在每一条数据上加一个锁,容易导致大量的锁超时和锁竞争,特别不适用在一些高并发的业务场景下.</p><p>举例:我们在银行排队存钱,只有前一个人全部操作完,下一个人才可以进行办理.中间的人是不可以插队的,只能一个一个的排对,事务的串行就是这样的一个概念,其实所谓的串行模式都是这样的一个概念.</p><p>| 事务隔离级别 | 脏读 | 不可重复度 | 幻读 | 加锁度 |</p><p>| :---: | :---: | :---: | :---: | :---: |</p><p>| 未提交读 | √ | √ | √ | × |</p><p>| 提交读 | × | √ | √ | × |</p><p>| 可重复读 | × | × | √ | × |</p><p>| 可重复读 | × | × | × | √ |</p><div class=pgc-img><img alt=MySQl事务最全详解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c61163c863114226b14bb3760da19e4d><p class=pgc-img-caption></p></div><p><strong>隔离性总结</strong></p><p>通过上面的举例,我们不难发现.脏读和不可重复读重在更新数据,然后幻读重在插入数据.</p><blockquote><p>多种存储引擎时事务的处理方式</p></blockquote><p>根据上面事务使用的条件,我们可以得知有的存储引擎是不支持事务的,例如MyISAM存储引擎就不支持.那如果在一个事务中使用了事务性的存储引擎和非事务性的存储,提交是可以正常进行,但是回滚非事务性的存储引擎则会显示响应的错误信息,具体信息和存储引擎有关.</p><blockquote><p>如何使用事务</p></blockquote><p>MySQL中事务隐式开启的,也就是说,一个sql语句就是一个事务,当sql语句执行完毕,事务就提交了.在演示的过程中,我们显式开启.</p><blockquote><p>MySQL中的自动提交</p></blockquote><p>上面提到了MySQL中事务是隐式开启的,则代表我们每一个sql是自动提交的,需要关闭则需要设置autocommit选项.</p><p>2.使用事务</p><p><strong>MySQL实现事务</strong></p><p>下面的代码,我们主要做了如下几个操作</p><p>a.开启事务</p><p>b.修改数据</p><p>c.查询数据是否改变</p><p>d.数据回滚</p><p>e.再次查询数据,发现数据变回修改之前的状态</p><p>f.修改数据</p><p>g.事务提交</p><p>h.查询数据,发现数据变为最后一次修改的状态</p><p>i.尝试事务回滚</p><p>j.查询验证是否被回滚了,发现数据还是为最后一次修改的状态,事务回滚失败</p><pre>// 我们先查看表中的数据,id为1的age字段是12mysql root@127.0.0.1:test&gt; select * from user;+----+------+-----+| id | name | age |+----+------+-----+| 1 | 张三 | 12 || 2 | 李四 | 15 |+----+------+-----+2 rows in setTime: 0.013s// 开启事务mysql root@127.0.0.1:test&gt; begin;Query OK, 0 rows affectedTime: 0.001s// 将id为1的age字段改为10mysql root@127.0.0.1:test&gt; update user set age=10 where id=1;Query OK, 1 row affectedTime: 0.001s// 再次查询数据时,发现数据改为修改后的值mysql root@127.0.0.1:test&gt; select * from user;+----+------+-----+| id | name | age |+----+------+-----+| 1 | 张三 | 10 || 2 | 李四 | 15 |+----+------+-----+2 rows in setTime: 0.012s// 此时我们进行回滚操作mysql root@127.0.0.1:test&gt; rollback;Query OK, 0 rows affectedTime: 0.001s// 再次查询发现数据回到最初状态mysql root@127.0.0.1:test&gt; select * from user;+----+------+-----+| id | name | age |+----+------+-----+| 1 | 张三 | 12 || 2 | 李四 | 15 |+----+------+-----+2 rows in setTime: 0.019s// 我们再次对数据进行修改mysql root@127.0.0.1:test&gt; update user set age=15 where id=1;Query OK, 1 row affectedTime: 0.001s// 此时将事务进行提交mysql root@127.0.0.1:test&gt; commit;Query OK, 0 rows affectedTime: 0.000s// 发现此时的数据变为我们最终提交的值mysql root@127.0.0.1:test&gt; select * from user;+----+------+-----+| id | name | age |+----+------+-----+| 1 | 张三 | 15 || 2 | 李四 | 15 |+----+------+-----+2 rows in setTime: 0.012s// 我们尝试用刚才回滚的方式进行还原数据mysql root@127.0.0.1:test&gt; rollback;Query OK, 0 rows affectedTime: 0.000s// 发现数据无法回退了,仍然是提交后的数据mysql root@127.0.0.1:test&gt; select * from user;+----+------+-----+| id | name | age |+----+------+-----+| 1 | 张三 | 15 || 2 | 李四 | 15 |+----+------+-----+2 rows in setTime: 0.017s</pre><p><strong>PHP实现事务实例代码</strong></p><pre>&lt;?php// 连接MySQL$mysqli = new mysqli('127.0.0.1', 'root', '123456', 'test', 3306);// 关闭事务自动提交$mysqli-&gt;autocommit(false);// 1.开启事务$mysqli-&gt;begin_transaction();// 2.修改数据$mysqli-&gt;query("update user set age=10 where id=1");// 3.查看数据$mysqli-&gt;query("select * from user");// 4.事务回滚$mysqli-&gt;rollback();// 5.查看数据$mysqli-&gt;query("select * from user");// 7.修改数据$mysqli-&gt;query("update user set age=15 where id=1");// 8.事务提交$mysqli-&gt;commit();// 9.事务回滚$mysqli-&gt;rollback();// 10.查看数据$mysqli-&gt;query("select * from user");</pre><blockquote><p>如何设置事务的隔离级别</p></blockquote><pre>// 查看当前的事务隔离级别mysql root@127.0.0.1:test&gt; select @@tx_isolation;+-----------------+| @@tx_isolation |+-----------------+| REPEATABLE-READ |+-----------------+1 row in setTime: 0.015s// 设置隔离级别set session transaction isolation level 隔离级别(上面事务隔离级别中的英文单词);</pre></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'MySQl','事务','详解'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>