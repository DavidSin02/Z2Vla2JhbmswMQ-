<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>é‡ç£…å¼€æºï½œAOP for Flutterå¼€å‘åˆ©å™¨â€”â€”AspectD | æå®¢å¿«è¨Š</title><meta property="og:title" content="é‡ç£…å¼€æºï½œAOP for Flutterå¼€å‘åˆ©å™¨â€”â€”AspectD - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/a9081cd0f8f5469dbff78c136b207e34"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/833fcd87.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/833fcd87.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/833fcd87.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/833fcd87.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/833fcd87.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/833fcd87.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/833fcd87.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/833fcd87.html><meta property="article:published_time" content="2020-11-14T21:04:30+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:30+08:00"><meta name=Keywords content><meta name=description content="é‡ç£…å¼€æºï½œAOP for Flutterå¼€å‘åˆ©å™¨â€”â€”AspectD"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/833fcd87.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>é‡ç£…å¼€æºï½œAOP for Flutterå¼€å‘åˆ©å™¨â€”â€”AspectD</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p>ä½œè€…ï¼šé—²é±¼æŠ€æœ¯-æ­£ç‰©</p><p>https://github.com/alibaba-flutter/aspectd</p><h1><strong>é—®é¢˜èƒŒæ™¯</strong></h1><p>éšç€Flutterè¿™ä¸€æ¡†æ¶çš„å¿«é€Ÿå‘å±•ï¼Œæœ‰è¶Šæ¥è¶Šå¤šçš„ä¸šåŠ¡å¼€å§‹ä½¿ç”¨Flutteræ¥é‡æ„æˆ–æ–°å»ºå…¶äº§å“ã€‚ä½†åœ¨æˆ‘ä»¬çš„å®è·µè¿‡ç¨‹ä¸­å‘ç°ï¼Œä¸€æ–¹é¢Flutterå¼€å‘æ•ˆç‡é«˜ï¼Œæ€§èƒ½ä¼˜å¼‚ï¼Œè·¨å¹³å°è¡¨ç°å¥½ï¼Œå¦ä¸€æ–¹é¢Flutterä¹Ÿé¢ä¸´ç€æ’ä»¶ï¼ŒåŸºç¡€èƒ½åŠ›ï¼Œåº•å±‚æ¡†æ¶ç¼ºå¤±æˆ–è€…ä¸å®Œå–„ç­‰é—®é¢˜ã€‚</p><p>ä¸¾ä¸ªæ —å­ï¼Œæˆ‘ä»¬åœ¨å®ç°ä¸€ä¸ªè‡ªåŠ¨åŒ–å½•åˆ¶å›æ”¾çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œéœ€è¦å»ä¿®æ”¹Flutteræ¡†æ¶(Dartå±‚é¢)çš„ä»£ç æ‰èƒ½å¤Ÿæ»¡è¶³è¦æ±‚ï¼Œè¿™å°±ä¼šæœ‰äº†å¯¹æ¡†æ¶çš„ä¾µå…¥æ€§ã€‚è¦è§£å†³è¿™ç§ä¾µå…¥æ€§çš„é—®é¢˜ï¼Œæ›´å¥½åœ°å‡å°‘è¿­ä»£è¿‡ç¨‹ä¸­çš„ç»´æŠ¤æˆæœ¬ï¼Œæˆ‘ä»¬è€ƒè™‘çš„é¦–è¦æ–¹æ¡ˆå³é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•è§£å†³AOP for Flutterè¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ¬æ–‡å°†é‡ç‚¹ä»‹ç»ä¸€ä¸ªé—²é±¼æŠ€æœ¯å›¢é˜Ÿå¼€å‘çš„é’ˆå¯¹Dartçš„AOPç¼–ç¨‹æ¡†æ¶AspectDã€‚</p><h1><strong>AspectD:é¢å‘Dartçš„AOPæ¡†æ¶</strong></h1><p>AOPèƒ½åŠ›ç©¶ç«Ÿæ˜¯è¿è¡Œæ—¶è¿˜æ˜¯ç¼–è¯‘æ—¶æ”¯æŒä¾èµ–äºè¯­è¨€æœ¬èº«çš„ç‰¹ç‚¹ã€‚ä¸¾ä¾‹æ¥è¯´åœ¨iOSä¸­ï¼ŒObjective Cæœ¬èº«æä¾›äº†å¼ºå¤§çš„è¿è¡Œæ—¶å’ŒåŠ¨æ€æ€§ä½¿å¾—è¿è¡ŒæœŸAOPç®€å•æ˜“ç”¨ã€‚åœ¨Androidä¸‹ï¼ŒJavaè¯­è¨€çš„ç‰¹ç‚¹ä¸ä»…å¯ä»¥å®ç°ç±»ä¼¼AspectJè¿™æ ·çš„åŸºäºå­—èŠ‚ç ä¿®æ”¹çš„ç¼–è¯‘æœŸé™æ€ä»£ç†ï¼Œä¹Ÿå¯ä»¥å®ç°Spring AOPè¿™æ ·çš„åŸºäºè¿è¡Œæ—¶å¢å¼ºçš„è¿è¡ŒæœŸåŠ¨æ€ä»£ç†ã€‚</p><p>é‚£ä¹ˆDartå‘¢ï¼Ÿä¸€æ¥Dartçš„åå°„æ”¯æŒå¾ˆå¼±ï¼Œåªæ”¯æŒäº†æ£€æŸ¥(Introspection)ï¼Œä¸æ”¯æŒä¿®æ”¹(Modification)ï¼›å…¶æ¬¡Flutterä¸ºäº†åŒ…å¤§å°ï¼Œå¥å£®æ€§ç­‰çš„åŸå› ç¦æ­¢äº†åå°„ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬è®¾è®¡å®ç°äº†åŸºäºç¼–è¯‘æœŸä¿®æ”¹çš„AOPæ–¹æ¡ˆAspectDã€‚</p><h1>è®¾è®¡è¯¦å›¾</h1><div class=pgc-img><img alt="é‡ç£…å¼€æºï½œAOP for Flutterå¼€å‘åˆ©å™¨â€”â€”AspectD" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a9081cd0f8f5469dbff78c136b207e34><p class=pgc-img-caption></p></div><p><strong>å…¸å‹çš„AOPåœºæ™¯</strong></p><p>ä¸‹åˆ—AspectDä»£ç è¯´æ˜äº†ä¸€ä¸ªå…¸å‹çš„AOPä½¿ç”¨åœºæ™¯:</p><pre>aop.dartimport 'package:example/main.dart' as app;import 'aop_impl.dart';void main()=&gt; app.main();aop_impl.dartimport 'package:aspectd/aspectd.dart';@Aspect()@pragma("vm:entry-point")class ExecuteDemo { @pragma("vm:entry-point") ExecuteDemo(); @Execute("package:example/main.dart", "_MyHomePageState", "-_incrementCounter") @pragma("vm:entry-point") void _incrementCounter(PointCut pointcut) { pointcut.proceed(); print('KWLM called!'); }}</pre><h1>é¢å‘å¼€å‘è€…çš„APIè®¾è®¡</h1><p><strong>PointCutçš„è®¾è®¡</strong></p><pre>@Call("package:app/calculator.dart","Calculator","-getCurTime")</pre><p>PointCutéœ€è¦å®Œå¤‡è¡¨å¾ä»¥æ€ä¹ˆæ ·çš„æ–¹å¼(Call/Executeç­‰)ï¼Œå‘å“ªä¸ªLibraryï¼Œå“ªä¸ªç±»(Library Methodçš„æ—¶å€™æ­¤é¡¹ä¸ºç©º)ï¼Œå“ªä¸ªæ–¹æ³•æ¥æ·»åŠ AOPé€»è¾‘ã€‚</p><p>PointCutçš„æ•°æ®ç»“æ„:</p><pre>@pragma('vm:entry-point')class PointCut { final Map&lt;dynamic, dynamic&gt; sourceInfos; final Object target; final String function; final String stubId; final List&lt;dynamic&gt; positionalParams; final Map&lt;dynamic, dynamic&gt; namedParams; @pragma('vm:entry-point') PointCut(this.sourceInfos, this.target, this.function, this.stubId,this.positionalParams, this.namedParams); @pragma('vm:entry-point') Object proceed(){ return null; }}</pre><p>å…¶ä¸­åŒ…å«äº†æºä»£ç ä¿¡æ¯(å¦‚åº“åï¼Œæ–‡ä»¶åï¼Œè¡Œå·ç­‰)ï¼Œæ–¹æ³•è°ƒç”¨å¯¹è±¡ï¼Œå‡½æ•°åï¼Œå‚æ•°ä¿¡æ¯ç­‰ã€‚</p><p>è¯·æ³¨æ„è¿™é‡Œçš„@pragma('vm:entry-point')æ³¨è§£ï¼Œå…¶æ ¸å¿ƒé€»è¾‘åœ¨äºTree-Shakingã€‚åœ¨AOT(ahead of time)ç¼–è¯‘ä¸‹ï¼Œå¦‚æœä¸èƒ½è¢«åº”ç”¨ä¸»å…¥å£(main)æœ€ç»ˆå¯èƒ½è°ƒåˆ°ï¼Œé‚£ä¹ˆå°†è¢«è§†ä¸ºæ— ç”¨ä»£ç è€Œä¸¢å¼ƒã€‚AOPä»£ç å› ä¸ºå…¶æ³¨å…¥é€»è¾‘çš„æ— ä¾µå…¥æ€§ï¼Œæ˜¾ç„¶æ˜¯ä¸ä¼šè¢«mainè°ƒåˆ°çš„ï¼Œå› æ­¤éœ€è¦æ­¤æ³¨è§£å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦ä¸¢å¼ƒè¿™æ®µé€»è¾‘ã€‚</p><p>æ­¤å¤„çš„proceedæ–¹æ³•ï¼Œç±»ä¼¼AspectJä¸­çš„ProceedingJoinPoint.proceed()æ–¹æ³•ï¼Œè°ƒç”¨pointcut.proceed()æ–¹æ³•å³å¯å®ç°å¯¹åŸå§‹é€»è¾‘çš„è°ƒç”¨ã€‚åŸå§‹å®šä¹‰ä¸­çš„proceedæ–¹æ³•ä½“åªæ˜¯ä¸ªç©ºå£³ï¼Œå…¶å†…å®¹å°†ä¼šè¢«åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆã€‚</p><p><strong>Adviceçš„è®¾è®¡</strong></p><pre>@pragma("vm:entry-point")Future&lt;String&gt; getCurTime(PointCut pointcut) async{ ... return result;}</pre><p>æ­¤å¤„çš„@pragma("vm:entry-point")æ•ˆæœåŒaä¸­æ‰€è¿°ï¼ŒpointCutå¯¹è±¡ä½œä¸ºå‚æ•°ä¼ å…¥AOPæ–¹æ³•ï¼Œä½¿å¼€å‘è€…å¯ä»¥è·å¾—æºä»£ç è°ƒç”¨ä¿¡æ¯çš„ç›¸å…³ä¿¡æ¯ï¼Œå®ç°è‡ªèº«é€»è¾‘æˆ–è€…æ˜¯é€šè¿‡pointcut.proceed()è°ƒç”¨åŸå§‹é€»è¾‘ã€‚</p><p><strong>Aspectçš„è®¾è®¡</strong></p><pre>@Aspect()@pragma("vm:entry-point")class ExecuteDemo { @pragma("vm:entry-point") ExecuteDemo(); ... }</pre><p>Aspectçš„æ³¨è§£å¯ä»¥ä½¿å¾—ExecuteDemoè¿™æ ·çš„AOPå®ç°ç±»è¢«æ–¹ä¾¿åœ°è¯†åˆ«å’Œæå–ï¼Œä¹Ÿå¯ä»¥èµ·åˆ°å¼€å…³çš„ä½œç”¨ï¼Œå³å¦‚æœå¸Œæœ›ç¦æ‰æ­¤æ®µAOPé€»è¾‘ï¼Œç§»é™¤@Aspectæ³¨è§£å³å¯ã€‚</p><h1>AOPä»£ç çš„ç¼–è¯‘</h1><p><strong>åŒ…å«åŸå§‹å·¥ç¨‹ä¸­çš„mainå…¥å£</strong></p><p>ä»ä¸Šæ–‡å¯ä»¥çœ‹åˆ°ï¼Œaop.dartå¼•å…¥import 'package:example/main.dart' as app;,è¿™ä½¿å¾—ç¼–è¯‘aop.dartæ—¶å¯åŒ…å«æ•´ä¸ªexampleå·¥ç¨‹çš„æ‰€æœ‰ä»£ç ã€‚</p><p><strong>Debugæ¨¡å¼ä¸‹çš„ç¼–è¯‘</strong></p><p>åœ¨aop.dartä¸­å¼•å…¥import 'aop_impl.dart';è¿™ä½¿å¾—aop_impl.dartä¸­å†…å®¹å³ä¾¿ä¸è¢«aop.dartæ˜¾å¼ä¾èµ–ï¼Œä¹Ÿå¯ä»¥åœ¨Debugæ¨¡å¼ä¸‹è¢«ç¼–è¯‘è¿›å»ã€‚</p><p><strong>Releaseæ¨¡å¼ä¸‹çš„ç¼–è¯‘</strong></p><p>åœ¨AOTç¼–è¯‘(Releaseæ¨¡å¼ä¸‹),Tree-Shakingé€»è¾‘ä½¿å¾—å½“aop_impl.dartä¸­çš„å†…å®¹æ²¡æœ‰è¢«aopä¸­mainè°ƒç”¨æ—¶ï¼Œå…¶å†…å®¹å°†ä¸ä¼šç¼–è¯‘åˆ°dillä¸­ã€‚é€šè¿‡æ·»åŠ @pragma("vm:entry-point")å¯ä»¥é¿å…å…¶å½±å“ã€‚</p><p>å½“æˆ‘ä»¬ç”¨AspectDå†™å‡ºAOPä»£ç ï¼Œé€è¿‡ç¼–è¯‘aop.dartç”Ÿæˆä¸­é—´äº§ç‰©ï¼Œä½¿å¾—dillä¸­æ—¢åŒ…å«äº†åŸå§‹é¡¹ç›®ä»£ç ï¼Œä¹ŸåŒ…å«äº†AOPä»£ç åï¼Œåˆ™éœ€è¦è€ƒè™‘å¦‚ä½•å¯¹å…¶ä¿®æ”¹ã€‚åœ¨AspectJä¸­ï¼Œä¿®æ”¹æ˜¯é€šè¿‡å¯¹Classæ–‡ä»¶è¿›è¡Œæ“ä½œå®ç°çš„ï¼Œåœ¨AspectDä¸­ï¼Œæˆ‘ä»¬åˆ™å¯¹dillæ–‡ä»¶è¿›è¡Œæ“ä½œã€‚</p><h1>Dillæ“ä½œ</h1><p>dillæ–‡ä»¶ï¼Œåˆç§°ä¸ºDart Intermediate Languageï¼Œæ˜¯Dartè¯­è¨€ç¼–è¯‘ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œæ— è®ºæ˜¯Script Snapshotè¿˜æ˜¯AOTç¼–è¯‘ï¼Œéƒ½éœ€è¦dillä½œä¸ºä¸­é—´äº§ç‰©ã€‚</p><p><strong>Dillçš„ç»“æ„</strong></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡dart sdkä¸­çš„vm packageæä¾›çš„dump_kernel.dartæ‰“å°å‡ºdillçš„å†…éƒ¨ç»“æ„ã€‚</p><pre>dart bin/dump_kernel.dart /Users/kylewong/Codes/AOP/aspectd/example/aop/build/app.dill /Users/kylewong/Codes/AOP/aspectd/example/aop/build/app.dill.txt</pre><div class=pgc-img><img alt="é‡ç£…å¼€æºï½œAOP for Flutterå¼€å‘åˆ©å™¨â€”â€”AspectD" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7a500a4b1cc74694b2345bff5855586e><p class=pgc-img-caption></p></div><p><strong>Dillå˜æ¢</strong></p><p>dartæä¾›äº†ä¸€ç§Kernel to Kernel Transformçš„æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡å¯¹dillæ–‡ä»¶çš„é€’å½’å¼ASTéå†ï¼Œå®ç°å¯¹dillçš„å˜æ¢ã€‚</p><p>åŸºäºå¼€å‘è€…ç¼–å†™çš„AspectDæ³¨è§£ï¼ŒAspectDçš„å˜æ¢éƒ¨åˆ†å¯ä»¥æå–å‡ºæ˜¯å“ªäº›åº“/ç±»/æ–¹æ³•éœ€è¦æ·»åŠ æ€æ ·çš„AOPä»£ç ï¼Œå†åœ¨ASTé€’å½’çš„è¿‡ç¨‹ä¸­é€šè¿‡å¯¹ç›®æ ‡ç±»çš„æ“ä½œï¼Œå®ç°Call/Executeè¿™æ ·çš„åŠŸèƒ½ã€‚</p><p>ä¸€ä¸ªå…¸å‹çš„Transforméƒ¨åˆ†é€»è¾‘å¦‚ä¸‹æ‰€ç¤º:</p><pre> @override MethodInvocation visitMethodInvocation(MethodInvocation methodInvocation) { methodInvocation.transformChildren(this); Node node = methodInvocation.interfaceTargetReference?.node; String uniqueKeyForMethod = null; if (node is Procedure) { Procedure procedure = node; Class cls = procedure.parent as Class; String procedureImportUri = cls.reference.canonicalName.parent.name; uniqueKeyForMethod = AspectdItemInfo.uniqueKeyForMethod( procedureImportUri, cls.name, methodInvocation.name.name, false, null); } else if(node == null) { String importUri = methodInvocation?.interfaceTargetReference?.canonicalName?.reference?.canonicalName?.nonRootTop?.name; String clsName = methodInvocation?.interfaceTargetReference?.canonicalName?.parent?.parent?.name; String methodName = methodInvocation?.interfaceTargetReference?.canonicalName?.name; uniqueKeyForMethod = AspectdItemInfo.uniqueKeyForMethod( importUri, clsName, methodName, false, null); } if(uniqueKeyForMethod != null) { AspectdItemInfo aspectdItemInfo = _aspectdInfoMap[uniqueKeyForMethod]; if (aspectdItemInfo?.mode == AspectdMode.Call &amp;&amp; !_transformedInvocationSet.contains(methodInvocation) &amp;&amp; AspectdUtils.checkIfSkipAOP(aspectdItemInfo, _curLibrary) == false) { return transformInstanceMethodInvocation( methodInvocation, aspectdItemInfo); } } return methodInvocation; }</pre><p>é€šè¿‡å¯¹äºdillä¸­ASTå¯¹è±¡çš„éå†(æ­¤å¤„çš„visitMethodInvocationå‡½æ•°)ï¼Œç»“åˆå¼€å‘è€…ä¹¦å†™çš„AspectDæ³¨è§£(æ­¤å¤„çš„_aspectdInfoMap_å’ŒaspectdItemInfo)ï¼Œå¯ä»¥å¯¹åŸå§‹çš„ASTå¯¹è±¡(æ­¤å¤„methodInvocation)è¿›è¡Œå˜æ¢ï¼Œä»è€Œæ”¹å˜åŸå§‹çš„ä»£ç é€»è¾‘ï¼Œå³Transformè¿‡ç¨‹ã€‚</p><h1>AspectDæ”¯æŒçš„è¯­æ³•</h1><p>ä¸åŒäºAspectJä¸­æä¾›çš„BeforeAroundAfterä¸‰ç§é¢„å‘ï¼Œåœ¨AspectDä¸­ï¼Œåªæœ‰ä¸€ç§ç»Ÿä¸€çš„æŠ½è±¡å³Aroundã€‚</p><p>ä»æ˜¯å¦ä¿®æ”¹åŸå§‹æ–¹æ³•å†…éƒ¨è€Œè¨€ï¼Œæœ‰Callå’ŒExecuteä¸¤ç§ï¼Œå‰è€…çš„PointCutæ˜¯è°ƒç”¨ç‚¹ï¼Œåè€…çš„PointCutåˆ™æ˜¯æ‰§è¡Œç‚¹ã€‚</p><p><strong>Call</strong></p><pre>import 'package:aspectd/aspectd.dart';@Aspect()@pragma("vm:entry-point")class CallDemo{ @Call("package:app/calculator.dart","Calculator","-getCurTime") @pragma("vm:entry-point") Future&lt;String&gt; getCurTime(PointCut pointcut) async{ print('Aspectd:KWLM02'); print('${pointcut.sourceInfos.toString()}'); Future&lt;String&gt; result = pointcut.proceed(); String test = await result; print('Aspectd:KWLM03'); print('${test}'); return result; }}</pre><p><strong>Execute</strong></p><pre>import 'package:aspectd/aspectd.dart';@Aspect()@pragma("vm:entry-point")class ExecuteDemo{ @Execute("package:app/calculator.dart","Calculator","-getCurTime") @pragma("vm:entry-point") Future&lt;String&gt; getCurTime(PointCut pointcut) async{ print('Aspectd:KWLM12'); print('${pointcut.sourceInfos.toString()}'); Future&lt;String&gt; result = pointcut.proceed(); String test = await result; print('Aspectd:KWLM13'); print('${test}'); return result; }</pre><p><strong>Inject</strong></p><p>ä»…æ”¯æŒCallå’ŒExecuteï¼Œå¯¹äºFlutter(Dart)è€Œè¨€æ˜¾ç„¶å¾ˆæ˜¯å•è–„ã€‚ä¸€æ–¹é¢Flutterç¦æ­¢äº†åå°„ï¼Œé€€ä¸€æ­¥è®²ï¼Œå³ä¾¿Flutterå¼€å¯äº†åå°„æ”¯æŒï¼Œä¾ç„¶å¾ˆå¼±ï¼Œå¹¶ä¸èƒ½æ»¡è¶³éœ€æ±‚ã€‚</p><p>ä¸¾ä¸ªå…¸å‹çš„åœºæ™¯ï¼Œå¦‚æœéœ€è¦æ³¨å…¥çš„dartä»£ç é‡Œï¼Œx.dartæ–‡ä»¶çš„ç±»yå®šä¹‰äº†ä¸€ä¸ªç§æœ‰æ–¹æ³•mæˆ–è€…æˆå‘˜å˜é‡pï¼Œé‚£ä¹ˆåœ¨aop_impl.dartä¸­æ˜¯æ²¡æœ‰åŠæ³•å¯¹å…¶è®¿é—®çš„ï¼Œæ›´ä¸ç”¨è¯´å¤šä¸ªè¿ç»­çš„ç§æœ‰å˜é‡å±æ€§è·å¾—ã€‚å¦ä¸€æ–¹é¢ï¼Œä»…ä»…å¯¹æ–¹æ³•æ•´ä½“è¿›è¡Œæ“ä½œå¯èƒ½æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨æ–¹æ³•çš„ä¸­é—´æ’å…¥å¤„ç†é€»è¾‘ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒAspectDè®¾è®¡äº†ä¸€ç§è¯­æ³•Injectï¼Œå‚è§ä¸‹é¢çš„ä¾‹å­:</p><p>flutteråº“ä¸­åŒ…å«äº†ä¸€ä¸‹è¿™æ®µæ‰‹åŠ¿ç›¸å…³ä»£ç :</p><pre>@override Widget build(BuildContext context) { final Map&lt;Type, GestureRecognizerFactory&gt; gestures = &lt;Type, GestureRecognizerFactory&gt;{}; if (onTapDown != null || onTapUp != null || onTap != null || onTapCancel != null) { gestures[TapGestureRecognizer] = GestureRecognizerFactoryWithHandlers&lt;TapGestureRecognizer&gt;( () =&gt; TapGestureRecognizer(debugOwner: this), (TapGestureRecognizer instance) { instance ..onTapDown = onTapDown ..onTapUp = onTapUp ..onTap = onTap ..onTapCancel = onTapCancel; }, ); }</pre><p>å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨onTapCancelä¹‹åæ·»åŠ ä¸€æ®µå¯¹äºinstanceå’Œcontextçš„å¤„ç†é€»è¾‘ï¼ŒCallå’ŒExecuteæ˜¯ä¸å¯è¡Œçš„ï¼Œè€Œä½¿ç”¨Injectåï¼Œåªéœ€è¦ç®€å•çš„å‡ å¥å³å¯è§£å†³:</p><pre>import 'package:aspectd/aspectd.dart';@Aspect()@pragma("vm:entry-point")class InjectDemo{ @Inject("package:flutter/src/widgets/gesture_detector.dart","GestureDetector","-build", lineNum:452) @pragma("vm:entry-point") static void onTapBuild() { Object instance; //Aspectd Ignore Object context; //Aspectd Ignore print(instance); print(context); print('Aspectd:KWLM25'); }}</pre><p>é€šè¿‡ä¸Šè¿°çš„å¤„ç†é€»è¾‘ï¼Œç»è¿‡ç¼–è¯‘æ„å»ºåçš„dillä¸­çš„GestureDetector.buildæ–¹æ³•å¦‚ä¸‹æ‰€ç¤º:</p><div class=pgc-img><img alt="é‡ç£…å¼€æºï½œAOP for Flutterå¼€å‘åˆ©å™¨â€”â€”AspectD" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/159fb8ddc93141c39beab75a577696cf><p class=pgc-img-caption></p></div><p>æ­¤å¤–ï¼ŒInjectçš„è¾“å…¥å‚æ•°ç›¸å¯¹äºCall/Executeè€Œè¨€ï¼Œå¤šäº†ä¸€ä¸ªlineNumçš„å‘½åå‚æ•°ï¼Œå¯ç”¨äºæŒ‡å®šæ’å…¥é€»è¾‘çš„å…·ä½“è¡Œå·ã€‚</p><h1>æ„å»ºæµç¨‹æ”¯æŒ</h1><p>è™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–è¯‘aop.dartè¾¾åˆ°åŒæ—¶ç¼–è¯‘åŸå§‹å·¥ç¨‹ä»£ç å’ŒAspectDä»£ç åˆ°dillæ–‡ä»¶ï¼Œå†é€šè¿‡Transformå®ç°dillå±‚æ¬¡çš„å˜æ¢å®ç°AOPï¼Œä½†æ ‡å‡†çš„flutteræ„å»º(å³flutter_tools)å¹¶ä¸æ”¯æŒè¿™ä¸ªè¿‡ç¨‹ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦å¯¹æ„å»ºè¿‡ç¨‹åšç»†å¾®ä¿®æ”¹ã€‚</p><p>åœ¨AspectJä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹æ˜¯ç”±éæ ‡å‡†Javaç¼–è¯‘å™¨çš„Ajcæ¥å®ç°çš„ã€‚åœ¨AspectDä¸­ï¼Œé€šè¿‡å¯¹flutter_toolsæ‰“ä¸Šåº”ç”¨Patchï¼Œå¯ä»¥å®ç°å¯¹äºAspectDçš„æ”¯æŒã€‚</p><pre>kylewong@KyleWongdeMacBook-Pro fluttermaster % git apply --3way /Users/kylewong/Codes/AOP/aspectd/0001-aspectd.patchkylewong@KyleWongdeMacBook-Pro fluttermaster % rm bin/cache/flutter_tools.stampkylewong@KyleWongdeMacBook-Pro fluttermaster % flutter doctor -vBuilding flutter tool...</pre><h1>å®æˆ˜ä¸æ€è€ƒ</h1><p>åŸºäºAspectDï¼Œæˆ‘ä»¬åœ¨å®è·µä¸­æˆåŠŸåœ°ç§»é™¤äº†æ‰€æœ‰å¯¹äºFlutteræ¡†æ¶çš„ä¾µå…¥æ€§ä»£ç ï¼Œå®ç°äº†åŒæœ‰ä¾µå…¥æ€§ä»£ç åŒæ ·çš„åŠŸèƒ½ï¼Œæ”¯æ’‘ä¸Šç™¾ä¸ªè„šæœ¬çš„å½•åˆ¶å›æ”¾ä¸è‡ªåŠ¨åŒ–å›å½’ç¨³å®šå¯é è¿è¡Œã€‚</p><p>ä»AspectDçš„è§’åº¦çœ‹ï¼ŒCall/Executeå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¾¿æ·å®ç°è¯¸å¦‚æ€§èƒ½åŸ‹ç‚¹(å…³é”®æ–¹æ³•çš„è°ƒç”¨æ—¶é•¿)ï¼Œæ—¥å¿—å¢å¼º(è·å–æŸä¸ªæ–¹æ³•å…·ä½“æ˜¯åœ¨ä»€ä¹ˆåœ°æ–¹è¢«è°ƒç”¨åˆ°çš„è¯¦ç»†ä¿¡æ¯)ï¼ŒDoomå½•åˆ¶å›æ”¾(å¦‚éšæœºæ•°åºåˆ—çš„ç”Ÿæˆè®°å½•ä¸å›æ”¾)ç­‰åŠŸèƒ½ã€‚Injectè¯­æ³•åˆ™æ›´ä¸ºå¼ºå¤§ï¼Œå¯ä»¥é€šè¿‡ç±»ä¼¼æºä»£ç è¯¸å¦‚çš„æ–¹å¼ï¼Œå®ç°é€»è¾‘çš„è‡ªç”±æ³¨å…¥ï¼Œå¯ä»¥æ”¯æŒè¯¸å¦‚Appå½•åˆ¶ä¸è‡ªåŠ¨åŒ–å›å½’(å¦‚ç”¨æˆ·è§¦æ‘¸äº‹ä»¶çš„å½•åˆ¶ä¸å›æ”¾)ç­‰å¤æ‚åœºæ™¯ã€‚</p><p>è¿›ä¸€æ­¥æ¥è¯´ï¼ŒAspectDçš„åŸç†åŸºäºDillå˜æ¢ï¼Œæœ‰äº†Dillæ“ä½œè¿™ä¸€åˆ©å™¨ï¼Œå¼€å‘è€…å¯ä»¥è‡ªç”±åœ°å¯¹Dartç¼–è¯‘äº§ç‰©è¿›è¡Œæ“ä½œï¼Œè€Œä¸”è¿™ç§å˜æ¢é¢å‘çš„æ˜¯è¿‘ä¹æºä»£ç çº§åˆ«çš„ASTå¯¹è±¡ï¼Œä¸ä»…å¼ºå¤§è€Œä¸”å¯é ã€‚æ— è®ºæ˜¯åšä¸€äº›é€»è¾‘æ›¿æ¢ï¼Œè¿˜æ˜¯æ˜¯Json&lt;-->æ¨¡å‹è½¬æ¢ç­‰ï¼Œéƒ½æä¾›äº†ä¸€ç§æ–°çš„è§†è§’ä¸å¯èƒ½ã€‚</p><h1><strong>å†™åœ¨æœ€å</strong></h1><p>AspectDä½œä¸ºé—²é±¼æŠ€æœ¯å›¢é˜Ÿæ–°å¼€å‘çš„é¢å‘Flutterçš„AOPæ¡†æ¶ï¼Œå·²ç»å¯ä»¥æ”¯æŒä¸»æµçš„AOPåœºæ™¯å¹¶åœ¨Githubå¼€æºï¼Œæ¬¢è¿ä½¿ç”¨ã€‚Aspectd for Flutter</p><p>https://github.com/alibaba-flutter/aspectd</p><p>å¦‚æœä½ åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæœ‰ä»»ä½•é—®é¢˜æˆ–è€…å»ºè®®ï¼Œæ¬¢è¿æissueæˆ–è€…PR.</p><p>https://github.com/alibaba-flutter/aspectd/pulls</p><p>æˆ–è€…ç›´æ¥è”ç³»ä½œè€…</p><p>mailto:kang.wang1988@gmail.com</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'å¼€æº','AOP','Flutter'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>