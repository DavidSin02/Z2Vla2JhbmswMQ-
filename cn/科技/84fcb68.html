<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>「Springboot」发送邮件、重置密码业务实战 | 极客快訊</title><meta property="og:title" content="「Springboot」发送邮件、重置密码业务实战 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/84fcb68.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/84fcb68.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/84fcb68.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/84fcb68.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/84fcb68.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/84fcb68.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/84fcb68.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/84fcb68.html><meta property="article:published_time" content="2020-10-29T20:52:15+08:00"><meta property="article:modified_time" content="2020-10-29T20:52:15+08:00"><meta name=Keywords content><meta name=description content="「Springboot」发送邮件、重置密码业务实战"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/84fcb68.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>「Springboot」发送邮件、重置密码业务实战</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>关注我的微信公众号：<strong>后端技术漫谈</strong></p><p><strong>不定期推送关于后端开发、爬虫、算法题、数据结构方面的原创技术文章，以及生活中的逸闻趣事。</strong></p><p>我目前是一名后端开发工程师。主要关注后端开发，数据安全，网络爬虫，物联网，边缘计算等方向。</p><p><strong>原创博客主要内容</strong></p><ul><li>Java知识点复习全手册</li><li>Leetcode算法题解析</li><li>剑指offer算法题解析</li><li>SpringCloud菜鸟入门实战系列</li><li>SpringBoot菜鸟入门实战系列</li><li>Python爬虫相关技术文章</li><li>后端开发相关技术文章</li></ul><p>前言</p><p><strong>忘记密码并通过邮件重置密码</strong>是一个常见的业务需求，在开发我的个人小项目过程中，也需要用到这个业务，今天就给大家带来一个业务实战。</p><h1>开发环境</h1><ul><li>springboot：1.5.16.RELEASE</li></ul><h1>业务流程</h1><p>根据controller中函数分为两个部分：</p><ol start=1><li>用户申请重置邮件：</li></ol><ul><li>用户在页面中输入邮箱</li><li>服务器检查是否允许重置（邮箱所指向用户是否存在，重置是否过于频繁，重置是否到达日请求上限）</li><li>验证通过后，想validate表写入申请记录，包含token，用户邮箱和id</li><li>发送邮件（包含带有token的链接）</li><li>用户点击邮件内连接</li><li>跳转到新密码输入网页</li><li>提交重置密码请求（POST中包含token，新密码）</li></ul><ol start=1><li>用户重置密码</li></ol><ul><li>服务器验证token（token是否过期，该用户是否发起过其它新token）</li><li>通过validate表记录查找用户id，修改用户密码</li></ul><h1>实战</h1><ol start=1><li>pom.xml添加email依赖</li></ol><pre>&lt;!--邮件: email--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-mail&lt;/artifactId&gt;&lt;/dependency&gt;</pre><ol start=2><li>添加pm_validate表结构</li></ol><p>其中reset_token由UUID生成，type默认为resetPassword（方便以后新增需求），user_id为用户表用户id</p><pre>-- ------------------------------ Table structure for pm_validate-- ----------------------------DROP TABLE IF EXISTS `pm_validate`;CREATE TABLE `pm_validate` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) NOT NULL, `email` varchar(40) NOT NULL, `reset_token` varchar(40) NOT NULL, `type` varchar(20) NOT NULL, `gmt_create` datetime DEFAULT NULL, `gmt_modified` datetime DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8;</pre><p>生成或编写对应pojo和mapper。，由于我使用了mybatis-generator插件，需要运行插件生成对应pojo和mapper。</p><ol start=3><li>修改application.properties，添加邮箱配置</li></ol><pre># 发送邮件配置spring.mail.host=smtp.gmail.comspring.mail.username=xxxxxx@gmail.comspring.mail.password=xxxxxxxspring.mail.properties.mail.smtp.auth=truespring.mail.properties.mail.smtp.starttls.enable=truespring.mail.properties.mail.smtp.starttls.required=true</pre><ol start=4><li>编写controller和service</li></ol><ul><li>ValidateController</li></ul><pre>@RestController@RequestMapping(value = &#34;/validate&#34;)public class ValidateController { @Autowired private ValidateService validateService; @Autowired private UserService userService; @Value(&#34;${spring.mail.username}&#34;) private String from; /** * 发送忘记密码邮件请求，每日申请次数不超过5次，每次申请间隔不低于1分钟 * @param email * @param request * @return */ @ApiOperation(value = &#34;发送忘记密码邮件&#34;, notes = &#34;发送忘记密码邮件&#34;) @RequestMapping(value = &#34;/sendValidationEmail&#34;, method = {RequestMethod.POST}) public ResponseData&lt;String&gt; sendValidationEmail(@ApiParam(&#34;邮箱地址&#34;) @RequestParam(&#34;email&#34;) String email, HttpServletRequest request){ ResponseData&lt;String&gt; responseData = new ResponseData&lt;&gt;(); List&lt;User&gt; users = userService.findUserByEmail(email); if (users == null){ responseData.jsonFill(2, &#34;该邮箱所属用户不存在&#34;, null); }else { if (validateService.sendValidateLimitation(email, 5,1)){ // 若允许重置密码，则在pm_validate表中插入一行数据，带有token Validate validate = new Validate(); validateService.insertNewResetRecord(validate, users.get(0), UUID.randomUUID().toString()); // 设置邮件内容 String appUrl = request.getScheme() + &#34;://&#34; + request.getServerName(); SimpleMailMessage passwordResetEmail = new SimpleMailMessage(); passwordResetEmail.setFrom(from); passwordResetEmail.setTo(email); passwordResetEmail.setSubject(&#34;【电商价格监控】忘记密码&#34;); passwordResetEmail.setText(&#34;您正在申请重置密码，请点击此链接重置密码: \n&#34; + appUrl + &#34;/validate/reset?token=&#34; + validate.getResetToken()); validateService.sendPasswordResetEmail(passwordResetEmail); responseData.jsonFill(1, null, null); }else { responseData.jsonFill(2,&#34;操作过于频繁，请稍后再试！&#34;,null); } } return responseData; } /** * 将url的token和数据库里的token匹配，成功后便可修改密码，token有效期为60分钟 * @param token * @param password * @param confirmPassword * @return */ @ApiOperation(value = &#34;重置密码&#34;, notes = &#34;重置密码&#34;) @RequestMapping(value = &#34;/resetPassword&#34;, method = RequestMethod.POST) public ResponseData&lt;String&gt; resetPassword(@ApiParam(&#34;token&#34;) @RequestParam(&#34;token&#34;) String token, @ApiParam(&#34;密码&#34;) @RequestParam(&#34;password&#34;) String password, @ApiParam(&#34;密码确认&#34;) @RequestParam(&#34;confirmPassword&#34;) String confirmPassword){ ResponseData&lt;String&gt; responseData = new ResponseData&lt;&gt;(); // 通过token找到validate记录 List&lt;Validate&gt; validates = validateService.findUserByResetToken(token); if (validates == null){ responseData.jsonFill(2,&#34;该重置请求不存在&#34;,null); }else { Validate validate = validates.get(0); if (validateService.validateLimitation(validate.getEmail(), Long.MAX_VALUE, 60, token)){ Integer userId = validate.getUserId(); if (password.equals(confirmPassword)) { userService.updatePassword(password, userId); responseData.jsonFill(1, null,null); }else { responseData.jsonFill(2,&#34;确认密码和密码不一致，请重新输入&#34;, null); } }else { responseData.jsonFill(2,&#34;该链接失效&#34;,null); } } return responseData; }}</pre><ul><li>ValidateService</li></ul><pre>public interface ValidateService { void sendPasswordResetEmail(SimpleMailMessage email); int insertNewResetRecord(Validate validate, User users, String token); List&lt;Validate&gt; findUserByResetToken(String resetToken); boolean validateLimitation(String email, long requestPerDay, long interval, String token); boolean sendValidateLimitation(String email, long requestPerDay, long interval);}</pre><ul><li>ValidateServiceImpl</li></ul><pre>@Servicepublic class ValidateServiceImpl implements ValidateService { @Autowired private JavaMailSender javaMailSender; @Autowired private ValidateMapper validateMapper; /** * 发送邮件：@Async进行异步调用发送邮件接口 * @param email */ @Override @Async public void sendPasswordResetEmail(SimpleMailMessage email){ javaMailSender.send(email); } /** * 在pm_validate表中插入一条validate记录，userid，email属性来自pm_user表，token由UUID生成 * @param validate * @param users * @param token * @return */ @Override public int insertNewResetRecord(Validate validate, User users, String token){ validate.setUserId(users.getId()); validate.setEmail(users.getEmail()); validate.setResetToken(token); validate.setType(&#34;passwordReset&#34;); validate.setGmtCreate(new Date()); validate.setGmtModified(new Date()); return validateMapper.insert(validate); } /** * pm_validate表中，通过token查找重置申请记录 * @param token * @return */ @Override public List&lt;Validate&gt; findUserByResetToken(String token){ ValidateExample validateExample = new ValidateExample(); ValidateExample.Criteria criteria = validateExample.createCriteria(); criteria.andResetTokenEqualTo(token); return validateMapper.selectByExample(validateExample); } /** * 验证是否发送重置邮件：每个email的重置密码每日请求上限为requestPerDay次，与上一次的请求时间间隔为interval分钟。 * @param email * @param requestPerDay * @param interval * @return */ @Override public boolean sendValidateLimitation(String email, long requestPerDay, long interval){ ValidateExample validateExample = new ValidateExample(); ValidateExample.Criteria criteria= validateExample.createCriteria(); criteria.andEmailEqualTo(email); List&lt;Validate&gt; validates = validateMapper.selectByExample(validateExample); // 若查无记录，意味着第一次申请，直接放行 if (validates.isEmpty()) { return true; } // 有记录，则判定是否频繁申请以及是否达到日均请求上线 long countTodayValidation = validates.stream().filter(x-&gt;DateUtils.isSameDay(x.getGmtModified(), new Date())).count(); Optional validate = validates.stream().map(Validate::getGmtModified).max(Date::compareTo); Date dateOfLastRequest = new Date(); if (validate.isPresent()) dateOfLastRequest = (Date) validate.get(); long intervalForLastRequest = new Date().getTime() - dateOfLastRequest.getTime(); return countTodayValidation &lt;= requestPerDay &amp;&amp; intervalForLastRequest &gt;= interval * 60 * 1000; } /** * 验证连接是否失效：链接有两种情况失效 1.超时 2.最近请求的一次链接自动覆盖之前的链接（待看代码） * @param email * @param requestPerDay * @param interval * @return */ @Override public boolean validateLimitation(String email, long requestPerDay, long interval, String token){ ValidateExample validateExample = new ValidateExample(); ValidateExample.Criteria criteria= validateExample.createCriteria(); criteria.andEmailEqualTo(email); List&lt;Validate&gt; validates = validateMapper.selectByExample(validateExample); // 有记录才会调用该函数，只需判断是否超时 Optional validate = validates.stream().map(Validate::getGmtModified).max(Date::compareTo); Date dateOfLastRequest = new Date(); if (validate.isPresent()) dateOfLastRequest = (Date) validate.get(); long intervalForLastRequest = new Date().getTime() - dateOfLastRequest.getTime(); Optional lastRequestToken = validates.stream().filter(x-&gt; x.getResetToken().equals(token)).map(Validate::getGmtModified).findAny(); Date dateOfLastRequestToken = new Date(); if (lastRequestToken.isPresent()) { dateOfLastRequestToken = (Date) lastRequestToken.get(); } return intervalForLastRequest &lt;= interval * 60 * 1000 &amp;&amp; dateOfLastRequest == dateOfLastRequestToken; }}</pre><h1>结语</h1><p>如上实现了整个重置密码流程，前端网页自行设计实现。</p><h1>关注我</h1><p>我是蛮三刀把刀，目前为后台开发工程师。主要关注后台开发，网络安全，Python爬虫等技术。</p><p>来微信和我聊聊：yangzd1102</p><p>Github：https://github.com/qqxx6661</p><p><strong>原创博客主要内容</strong></p><ul><li>笔试面试复习知识点手册</li><li>Leetcode算法题解析（前150题）</li><li>剑指offer算法题解析</li><li>Python爬虫相关技术分析和实战</li><li>后台开发相关技术分析和实战</li></ul><p><strong>同步更新以下博客</strong></p><p><strong>1. Csdn</strong></p><p>http://blog.csdn.net/qqxx6661</p><p>拥有专栏：Leetcode题解（Java/Python）、Python爬虫开发、面试助攻手册</p><p><strong>2. 知乎</strong></p><p>https://www.zhihu.com/people/yang-zhen-dong-1/</p><p>拥有专栏：码农面试助攻手册</p><p><strong>3. 掘金</strong></p><p>https://juejin.im/user/5b48015ce51d45191462ba55</p><p><strong>4. 简书</strong></p><p>https://www.jianshu.com/u/b5f225ca2376</p><p><strong>个人公众号：后端数据漫谈</strong></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Springboot','发送','邮件'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>