<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单 | 极客快訊</title><meta property="og:title" content="ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/5f0b7eb90c6b4b849a804211ddb3e403"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/84fdc2ea.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/84fdc2ea.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/84fdc2ea.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/84fdc2ea.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/84fdc2ea.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/84fdc2ea.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/84fdc2ea.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/84fdc2ea.html><meta property="article:published_time" content="2020-11-14T21:03:23+08:00"><meta property="article:modified_time" content="2020-11-14T21:03:23+08:00"><meta name=Keywords content><meta name=description content="ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/84fdc2ea.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1><strong>0 </strong>介绍</h1><p>zookeeper在很多框架中都有应用，例如：Dubbo，Hadoop，Kafka等，但典型的用法也就几种，掌握了这几种用法，再看zookeeper在相关框架中的应用就很轻松，下一篇文章将会详细介绍zookeeper在dubbo中的使用，以便有一个更深刻的了解</p><p>本文参考了《从Paxos到ZooKeeper》，鉴于本文的定位是一篇科普性质的文章，因此对于一些诸如共享锁和分布式队列的具体实现没有进行更详细的描述，实际工作中需要实现时可以参考这本书</p><p>zookeeper的数据模型和文件系统类似，每一个节点称为znode，是zookeeper中的最小数据单元，每一个znode上可以报存数据和挂载子节点，从而构成一个层次化的属性结构</p><p>可以创建如下四种节点（znode）</p><ol><li>持久节点：节点创建后会一直存在zookeeper服务器上，直到主动删除</li><li>持久顺序节点：每个节点都会为它的一级子节点维护一个顺序</li><li>临时节点：临时节点的生命周期和客户端的会话保持一致。当客户端会话失效，该节点自动清理</li><li>临时顺序节点：在临时节点上多了一个顺序的特性</li></ol><p>简单演示一下常用的命令</p><pre>create [-s] [-e] path data acl</pre><p>-s : 创建顺序节点</p><p>-e : 创建临时节点</p><p>path : 路径</p><p>data : 数据</p><p>acl : 权限</p><p>create默认创建的是持久节点</p><pre>create /level-1 123create /level-1/level-1-2 456get /level-1（获取节点level-1的值，输出123）ls /level-1 （获取节点level-1的子节点，输出[level-1-2]）// 创建一个顺序节点create -s /nodes 123（实际为nodes0000000003）create -s /nodes 456（实际为nodes0000000004）</pre><p>执行完上述命令后，数据结构如下所示</p><div class=pgc-img><img alt=ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5f0b7eb90c6b4b849a804211ddb3e403><p class=pgc-img-caption></p></div><p>这里简单说一下顺序节点的特性。每次创建顺序节点时，zk都会在路径后面自动添加上10位的数字（计数器），例如 &lt; path >0000000001，&lt; path >0000000002，……这个计数器可以保证在同一个父节点下是唯一的。在zk内部使用了4个字节的有符号整形来表示这个计数器，也就是说当计数器的大小超过2147483647时，将会发生溢出，每次在父节点下创建一个顺序节点时，大小加1，如上图的3到4</p><p>zookeeper提供了分布式数据发布/订阅，允许客户端向服务端注册一个watcher监听，当服务端的一些指定事件触发了这个watcher，那么就会向指定客户端发送一个事件通知来实现分布式的通知功能。</p><p>简单举几个watcher的事件类型</p><p>EventType</p><p>触发条件</p><p>NodeCreated（节点创建）</p><p>Watcher监听的对应数据节点被创建</p><p>NodeDeleted（节点删除）</p><p>Watcher监听的对应数据节点被删除</p><p>NodeDataChanged（节点数据修改）</p><p>Watcher监听的对应数据节点的数据内容发生变更</p><p>NodeChildrenChanged（子节点变更）</p><p>Watcher监听的对应数据节点的子节点列表发生变更</p><p>基础知识讲解完毕，下面正式分享zookeeper的作用</p><h1><strong>1 </strong>数据发布/订阅</h1><p>数据发布/订阅（Publish/Subscribe）系统，即所谓的配置中心，顾明思义就是发布者将数据发布到zookeeper的一个或一系列的节点上，供订阅者进行数据订阅，进而达到动态获取数据的目的，实现配置信息的集中式管理和数据的动态更新。</p><p>zookeeper采用推拉结合的方式来实现发布订阅系统：客户端向服务端注册自己需要关注的节点，一旦该节点的数据发生变更，那么服务端就会向相应的客户端发送Watcher事件通知，客户端接收到这个消息通知之后，需要主动到服务端获取最新的数据。</p><p>程序总是需要配置的，如果程序分散部署在多台机器上，要这个改变配置就变得困难。好吧，现在把这些配置全部放到zookeeper上去，保存在zookeeper的某个目录节点中，然后所有相关应用程序对这个目录节点进行监控，一旦配置信息发生变化，每个应用程序就会收到zookeeper的通知，然后从zookeeper中获取新的配置信息应用到系统中就好</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ea207ef7604b45a084975b815f3de8fe><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><h1><strong>2 </strong>负载均衡</h1><p>每台服务端在启动时都会去zookeeper的servers节点下注册临时节点（注册临时节点是因为，当服务不可用时，这个临时节点会消失，客户端也就不会请求这个服务端），每台客户端在启动时都会去servers节点下取得所有可用的工作服务器列表，并通过一定的负载均衡算法计算得出应该将请求发到哪个服务器上</p><div class=pgc-img><img alt=ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4b72e6855d1141c1b5762ed7154526f3><p class=pgc-img-caption></p></div><h1><strong>3 </strong>生成分布式唯一ID</h1><p>在过去的单库单表型系统中，通常可以使用数据库字段自带的auto_increment属性来自动为每条记录生成一个唯一的ID。但是分库分表后，就无法在依靠数据库的auto_increment属性来唯一标识一条记录了。此时我们就可以用zookeeper在分布式环境下生成全局唯一ID。做法如下：每次要生成一个新Id时，创建一个持久顺序节点，创建操作返回的节点序号，即为新Id，然后把比自己节点小的删除即可。</p><div class=pgc-img><img alt=ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2423d667ab724894ae16d75033d7c105><p class=pgc-img-caption></p></div><h1><strong>4 </strong>Master选举</h1><p>Master选举是一个在分布式系统中非常常见的应用场景。在分布式系统中，Master往往用来协调系统中的其他系统单元，具有对分布式系统状态变更的决定权。例如，在一些读写分离的应用场景用，客户端的写请求往往是由Master来处理的，而在另一些场景中， Master则常常负负责处理一下复杂的逻辑，并将处理结果同步给集群中其他系统单元。Master选举可以说是zookeeper最典型的应用场景了</p><p>利用zookeeper的强一致性，能够很好地保证在分布式高并发情况下节点的创建一定能保证全局唯一性，即zookeeper将会保证客户端无法重复创建一个已经存在的数据节点。也就是说，如果同时有多个客户端请求创建同一个节点，那么最终一定只有一个客户端能够创建成功。利用这个特性，就很容易在分布式环境中进行Master选举</p><div class=pgc-img><img alt=ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f0646ca1e6db422191ad447c937692f4><p class=pgc-img-caption></p></div><p>客户端集群往zookeeper上创建一个/master临时节点。在这个过程中，只有一个客户端能够成功创建这个节点，那么这个客户端就成了master。同时其他没有在zookeeper上成功创建节点的客户端，都会在节点/master上注册一个变更的watcher，用于监控当前的master机器是否存活，一旦发现当前的master挂了，那么其余的客户端将会重新进行master选举</p><h1><strong>5 </strong>分布式锁</h1><p>在同一个JVM中，为了保证对一个资源的有序访问，如往文件中写数据，可以用synchronized或者ReentrantLock来实现对资源的互斥访问，如果2个程序在不同的JVM中，并且都要往同一个文件中写数据，如何保证互斥访问呢？这时就需要用到分布式锁了</p><p>目前分布式锁的主流实现方式有两种</p><ol><li>利用redis setnex(key value) key不存在返回0，key存在返回1</li><li>zookeeper实现排他锁，共享锁（读锁）</li></ol><p>这里只简单介绍一下排他锁的实现方式</p><p>实现原理和master选举类似，所有客户端在/exclusive_lock节点下创建临时子节点/exclusive_lock/lock，zookeeper会保证在所有的客户端中，最终只有一个客户端能够创建成功，那么就认为该客户端获取了锁，其他没有获取到锁的客户端就需要到/exclusive_lock节点看上注册一个子节点变更的watcher监听，以便实时监听到lock节点的变更情况</p><p>释放锁的情况有如下两种</p><ol><li>当前获取锁的客户端发生宕机，那么zookeeper上的这个临时节点就会被删除</li><li>正常执行完业务逻辑后，客户端会主动将自己创建的临时节点删除</li></ol><p>整个排他锁的获取和释放流程可以用如下图表示</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f9b819ae50c1487098312364b60ab2da><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><h1><strong>6 </strong>分布式队列</h1><p>如下图，创建/queue作为一个队列，然后每创建一个顺序节点，视为一条消息(节点存储的数据即为消息内容)，生产者每次创建一个新节点，做为消息发送，消费者监听queue的子节点变化（或定时轮询)，每次取最小节点当做消费消息，处理完后，删除该节点。相当于实现了一个FIFO(先进先出)的队列。注：zookeeper强调的是CP（一致性)，而非专为高并发、高性能场景设计的，如果在高并发，qps很高的情况下，分布式队列需酌情考虑。</p><div class=pgc-img><img alt=ZooKeeper就是类文件系统，应用场景都是基于这一特性，超级简单 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ae7abfe1fa8940bdab9ffbc92a41ab99><p class=pgc-img-caption></p></div><p>本文为小编原创文章，首发于<strong>Java识堂</strong>，一个高原创，高收藏，有干货的<strong>微信公众号，</strong>一起成长，一起进步，欢迎关注</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ZooKeeper','系统','应用'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>