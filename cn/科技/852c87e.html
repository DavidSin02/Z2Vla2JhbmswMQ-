<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº† | æå®¢å¿«è¨Š</title><meta property="og:title" content="æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº† - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/e66a7bcfded64b34b43ebc1565b3e557"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/852c87e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/852c87e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/852c87e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/852c87e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/852c87e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/852c87e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/852c87e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/852c87e.html><meta property="article:published_time" content="2020-10-29T20:59:17+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:17+08:00"><meta name=Keywords content><meta name=description content="æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº†"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/852c87e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº†</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p><strong>æœ¬æ–‡å¯¼è¯»ï¼š</strong></p><ul><li><strong>ä¸šåŠ¡éœ€æ±‚åœºæ™¯ä»‹ç»</strong></li><li><strong>æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆæ€è€ƒ</strong></li><li><strong>Future è®¾è®¡æ¨¡å¼å®æˆ˜</strong></li><li><strong>CompletableFuture æ¨¡å¼å®æˆ˜</strong></li><li><strong>CompletableFuture ç”Ÿäº§å»ºè®®</strong></li><li><strong>CompletableFuture æ€§èƒ½æµ‹è¯•</strong></li><li><strong>CompletableFuture ä½¿ç”¨æ‰©å±•</strong></li></ul><hr><p><strong>1ã€ä¸šåŠ¡éœ€æ±‚åœºæ™¯ä»‹ç»</strong></p><hr><p>ä¸å˜çš„ä¸œè¥¿å°±æ˜¯ä¸€ç›´åœ¨å˜åŒ–ä¸­ã€‚</p><p>æƒ³å¿…ï¼Œå¤§å®¶åœ¨é—²æš‡æ—¶åˆ»ï¼Œä¼šç»å¸¸çœ‹è§†é¢‘ï¼Œç»å¸¸ç”¨çš„å‡ ä¸ª APPï¼Œæ¯”å¦‚ä¼˜é…·ã€çˆ±å¥‡è‰ºã€è…¾è®¯ç­‰ã€‚</p><p>è¿™äº›è§†é¢‘ APP ä¸ä»…ä»…å¯ä»¥åœ¨æ‰‹æœºä¸Šæ’­æ”¾ï¼Œè¿˜èƒ½å¤Ÿæ”¯æŒåœ¨ç”µè§†ä¸Šæ’­æ”¾ã€‚</p><p>åœ¨ç”µè§†ç»ˆç«¯ä¸Šæ’­æ”¾çš„ APP æ˜¯ç‹¬ç«‹å‘å¸ƒçš„ç‰ˆæœ¬ï¼Œè·Ÿæ‰‹æœºç«¯çš„ APP æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>å½“æˆ‘ä»¬çœ‹ä¸€éƒ¨ç”µå½±æ—¶ï¼Œç‚¹å‡»è¿›å…¥æŸä¸€éƒ¨ç”µå½±ï¼Œå°±è¿›å…¥åˆ°äº†ä¸“è¾‘è¯¦æƒ…é¡µé¡µé¢ï¼Œæ­¤æ—¶ï¼Œæ’­æ”¾å™¨ä¼šè‡ªåŠ¨æ’­æ”¾è§†é¢‘ã€‚ç”¨æˆ·åœ¨æ‰‹æœºä¸Šçœ‹åˆ°çš„ä¸“è¾‘è¯¦æƒ…é¡µï¼Œä¸ç”µè§†ä¸Šçœ‹åˆ°çš„ä¸“è¾‘è¯¦æƒ…é¡µï¼Œé¡µé¢æ ·å¼è®¾è®¡ä¸Šæ˜¯ä¸åŒçš„ã€‚</p><p>æˆ‘ä»¬æ¥ç›´è§‚çš„çœ‹ä¸€ä¸‹æ•ˆæœã€‚</p><p>æ‰‹æœºä¸Šçš„è…¾è®¯è§†é¢‘ä¸“è¾‘è¯¦æƒ…é¡µ:</p><div class=pgc-img><img alt="æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e66a7bcfded64b34b43ebc1565b3e557><p class=pgc-img-caption></p></div><p>ä¸ŠåŠéƒ¨åˆ†æˆªå›¾ï¼Œä¸‹é¢è¿˜æœ‰ä¸ºä½ æ¨èã€æ˜æ˜Ÿæ¼”å‘˜ã€å‘¨è¾¹æ¨èã€è¯„è®ºç­‰åŠŸèƒ½ã€‚</p><p>ç›¸åº”çš„ï¼Œåœ¨ç”µè§†ç«¯çš„ä¸“è¾‘è¯¦æƒ…é¡µå±•ç¤ºæ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ã€‚å‡è®¾äº§å“ç»ç†æå‡ºä¸€ä¸ªéœ€æ±‚ï¼Œè¦æ±‚å¯¹è¯¦æƒ…é¡µåšä¸ªæ”¹ç‰ˆã€‚</p><p>æ ·å¼è¦æ±‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt="æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6529422d9088498eae0ccc2fce47b782><p class=pgc-img-caption></p></div><p>ä¸¤ä¸ªç»ˆç«¯çš„æ ·å¼å¯¹æ¯”ï¼Œåœ¨ç”µè§†ç«¯ä¸“è¾‘è¯¦æƒ…é¡µä¸­ï¼ŒåŒ…å«äº†å¾ˆå¤šæ¿å—ï¼Œæ¯ä¸ªæ¿å—æ¨ªå‘å±•ç¤ºå¤šä¸ªå†…å®¹ã€‚</p><p>äº§å“çš„è®¾è®¡ä¸Šè¦æ±‚æ˜¯ï¼Œæœ‰çš„æ¿å—å†…å®¹æ¥æºäºæ¨èã€æœ‰çš„æ¿å—æ¥æºäºæœç´¢ã€æœ‰çš„æ¿å—æ¥æºCMSï¼ˆå†…å®¹ç®¡ç†ç³»ç»Ÿï¼‰ã€‚ç®€å•ç†è§£ä¸ºï¼Œæ¯ä¸ªæ¿å—å†…å®¹æ¥æºä¸åŒï¼Œæ¥æºäºæ¨èã€æœç´¢ç­‰æ¥å£çš„å†…å®¹è¦æ±‚æ˜¯è¿‘å®æ—¶çš„è¯·æ±‚ã€‚</p><p><strong>2ã€æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆæ€è€ƒ</strong></p><hr><p>è€ƒè™‘åˆ°äº§å“æçš„è¿™ä¸ªéœ€æ±‚ï¼Œå…¶å®å®ç°èµ·æ¥å¹¶ä¸éš¾ã€‚</p><p>ä¸»è¦åˆ†ä¸ºäº†é™æ€æ•°æ®éƒ¨åˆ†å’ŒåŠ¨æ€æ•°æ®éƒ¨åˆ†ï¼Œå¯¹äºä¸ç»å¸¸å˜åŒ–çš„æ•°æ®å¯ä»¥é€šè¿‡é™æ€æ¥å£è·å–ï¼Œå¯¹äºè¿‘ä¹å®æ—¶çš„æ•°æ®å¯ä»¥é€šè¿‡åŠ¨æ€æ¥å£è·å–ã€‚</p><p><strong>é™æ€æ¥å£è®¾è®¡ï¼š</strong></p><p>ä¸“è¾‘æœ¬èº«çš„å±æ€§ä»¥åŠä¸“è¾‘ä¸‹çš„è§†é¢‘æ•°æ®ï¼Œä¸€èˆ¬æ˜¯ä¸ç»å¸¸å˜åŒ–çš„ã€‚</p><p>åœ¨éœ€æ±‚åœºæ™¯ä»‹ç»ä¸­ï¼Œæˆ‘æˆªå›¾çš„æ˜¯ç”µå½±é¢‘é“ã€‚å¦‚æœæ˜¯ç”µè§†å‰§é¢‘é“ï¼Œä¼šå±•ç¤ºå‰§é›†åˆ—è¡¨ï¼ˆä¸“è¾‘ä¸‹çš„æ‰€æœ‰è§†é¢‘ï¼Œå¦‚ç¬¬ 1 é›†ã€ç¬¬ 2 é›†...ï¼‰ï¼Œè€Œè§†é¢‘çš„æ›´æ–°ä¸€èˆ¬æ˜¯ä¸å¤ªé¢‘ç¹çš„ï¼Œæ‰€ä»¥åœ¨ä¸“è¾‘è¯¦æƒ…é¡µå‰§é›†åˆ—è¡¨æ•°æ®å°±å¯ä»¥ä»é™æ€æ¥å£è·å–ã€‚</p><p>é™æ€æ¥å£æ•°æ®ç”Ÿæˆæµç¨‹ï¼š</p><div class=pgc-img><img alt="æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/52d585253ae24a7aa174d87db3baf078><p class=pgc-img-caption></p></div><p>å¦å¤–ä¸€éƒ¨åˆ†ï¼Œå°±æ˜¯éœ€è¦åŠ¨æ€æ¥å£æ¥å®ç°ï¼Œè°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£è·å–æ•°æ®ï¼Œæ¯”å¦‚æ¨èã€æœç´¢æ•°æ®ã€‚</p><p>åŒæ—¶ï¼Œè¦æ±‚æ¿å—ä¸æ¿å—ä¹‹é—´çš„å†…å®¹ä¸å…è®¸é‡å¤ã€‚</p><p><strong>åŠ¨æ€æ¥å£è®¾è®¡ï¼š</strong></p><p><strong>æ–¹æ¡ˆä¸€ï¼š</strong></p><p>ä¸²è¡Œè°ƒç”¨ï¼Œå³æŒ‰ç…§æ¯ä¸ªæ¿å—çš„å±•ç¤ºå…ˆåé¡ºåºï¼Œè°ƒç”¨ç›¸åº”çš„ç¬¬ä¸‰æ–¹æ¥å£è·å–æ•°æ®ã€‚</p><p><strong>æ–¹æ¡ˆäºŒï¼š</strong></p><p>å¹¶è¡Œè°ƒç”¨ï¼Œå³å¤šä¸ªæ¿å—ä¹‹é—´å¯ä»¥å¹¶è¡Œè°ƒç”¨ï¼Œæé«˜æ•´ä½“æ¥å£å“åº”æ•ˆç‡ã€‚</p><p>å…¶å®ä»¥ä¸Šä¸¤ä¸ªæ–¹æ¡ˆï¼Œå„æœ‰åˆ©å¼Šã€‚</p><p>æ–¹æ¡ˆä¸€ä¸²è¡Œè°ƒç”¨ï¼Œå¥½å¤„æ˜¯å¼€å‘æ¨¡å‹ç®€å•ï¼ŒæŒ‰ç…§ä¸²è¡Œæ–¹å¼ä¾æ¬¡è°ƒç”¨æ¥å£ï¼Œå†…å®¹æ•°æ®å»é‡ï¼Œèšåˆæ‰€æœ‰çš„æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>ä½†æ˜¯ï¼Œæ¥å£å“åº”æ—¶é—´ä¾èµ–äºç¬¬ä¸‰æ–¹æ¥å£çš„å“åº”æ—¶é—´ï¼Œé€šå¸¸ç¬¬ä¸‰æ–¹æ¥å£æ€»æ˜¯ä¸å¯é çš„ï¼Œå¯èƒ½å°±ä¼šæ‹‰é«˜æ¥å£æ•´ä½“å“åº”æ—¶é—´ï¼Œè¿›è€Œå¯¼è‡´å ç”¨çº¿ç¨‹æ—¶é—´è¿‡é•¿ï¼Œå½±å“æ¥å£æ•´ä½“ååé‡ã€‚</p><p>æ–¹æ¡ˆäºŒå¹¶è¡Œè°ƒç”¨ï¼Œç†è®ºä¸Šæ˜¯å¯ä»¥æé«˜æ¥å£çš„æ•´ä½“å“åº”æ—¶é—´ï¼Œå‡è®¾åŒæ—¶è°ƒç”¨å¤šä¸ªç¬¬ä¸‰æ–¹æ¥å£ï¼Œå–å†³äºæœ€æ…¢çš„æ¥å£å“åº”æ—¶é—´ã€‚</p><p>å¹¶è¡Œè°ƒç”¨æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ°ã€Œæ± åŒ–æŠ€æœ¯ã€ï¼Œå³ä¸èƒ½æ— é™åˆ¶çš„åœ¨ JVM è¿›ç¨‹ä¸Šåˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ã€‚åŒæ—¶ï¼Œä¹Ÿè¦è€ƒè™‘åˆ°æ¿å—ä¸æ¿å—ä¹‹é—´çš„å†…å®¹æ•°æ®ï¼Œè¦æŒ‰ç…§äº§å“è®¾è®¡ä¸Šçš„å…ˆåé¡ºåºåšå»é‡ã€‚</p><p>æ ¹æ®è¿™ä¸ªéœ€æ±‚åœºæ™¯ï¼Œæˆ‘ä»¬é€‰æ‹©ç¬¬äºŒç§æ–¹æ¡ˆæ¥å®ç°æ›´åˆé€‚ä¸€äº›ã€‚</p><p>é€‰æ‹©äº†æ–¹æ¡ˆäºŒï¼Œæˆ‘ä»¬æŠ½è±¡å‡ºå¦‚ä¸‹å›¾æ‰€ç¤ºçš„ç®€æ˜“æ¨¡å‹ï¼š</p><div class=pgc-img><img alt="æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9bea889c2f8f45a883b29b65072655d3><p class=pgc-img-caption></p></div><p>T1ã€T2ã€T3 è¡¨ç¤ºå¤šä¸ªæ¿å—å†…å®¹çº¿ç¨‹ã€‚T1 çº¿ç¨‹å…ˆè¿”å›ç»“æœï¼ŒT2 çº¿ç¨‹è¿”å›çš„ç»“æœä¸èƒ½ä¸ä¸ T1 çº¿ç¨‹è¿”å›çš„ç»“æœå†…å®¹é‡å¤ï¼ŒT3 çº¿ç¨‹è¿”å›çš„ç»“æœä¸èƒ½ä¸ T1ã€T2 ä¸¤ä¸ªçº¿ç¨‹è¿”å›çš„ç»“æœå†…å®¹é‡å¤ã€‚</p><p>æˆ‘ä»¬ä»æŠ€æœ¯å®ç°ä¸Šè€ƒé‡ï¼Œå½“å¹¶è¡Œè°ƒç”¨å¤šä¸ªç¬¬ä¸‰æ–¹æ¥å£æ—¶ï¼Œéœ€è¦è·å–æ¥å£çš„è¿”å›ç»“æœï¼Œé¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯ Future ï¼Œèƒ½å¤Ÿå®ç°å¼‚æ­¥è·å–ä»»åŠ¡ç»“æœã€‚</p><p>å¦å¤–ï¼ŒJDK8 æä¾›äº† CompletableFuture æ˜“äºä½¿ç”¨çš„è·å–å¼‚æ­¥ç»“æœçš„å·¥å…·ç±»ï¼Œè§£å†³äº† Future çš„ä¸€äº›ä½¿ç”¨ä¸Šçš„ç—›ç‚¹ï¼Œä»¥æ›´ä¼˜é›…çš„æ–¹å¼å®ç°ç»„åˆå¼å¼‚æ­¥ç¼–ç¨‹ï¼ŒåŒæ—¶ä¹Ÿå¥‘åˆå‡½æ•°å¼ç¼–ç¨‹ã€‚</p><p><strong>3ã€Future è®¾è®¡æ¨¡å¼å®æˆ˜</strong></p><hr><p><strong>Future æ¥å£è®¾è®¡ï¼š</strong></p><p>æä¾›äº†è·å–ä»»åŠ¡ç»“æœã€å–æ¶ˆä»»åŠ¡ã€åˆ¤æ–­ä»»åŠ¡çŠ¶æ€æ¥å£ã€‚è°ƒç”¨è·å–ä»»åŠ¡ç»“æœæ–¹æ³•ï¼Œåœ¨ä»»åŠ¡æœªå®Œæˆæƒ…å†µä¸‹ï¼Œä¼šå¯¼è‡´è°ƒç”¨é˜»å¡ã€‚</p><p><strong>Future æ¥å£æä¾›çš„æ–¹æ³•ï¼š</strong></p><p>```</p><p>// è·å–ä»»åŠ¡ç»“æœ</p><p>V get() throws InterruptedException, ExecutionException;</p><p>// æ”¯æŒè¶…æ—¶æ—¶é—´çš„è·å–ä»»åŠ¡ç»“æœ</p><p>V get(long timeout, TimeUnit unit)</p><p>throws InterruptedException, ExecutionException, TimeoutException;</p><p>// åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²å®Œæˆ</p><p>boolean isDone();</p><p>// åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²å–æ¶ˆ</p><p>boolean isCancelled();</p><p>// å–æ¶ˆä»»åŠ¡</p><p>boolean cancel(boolean mayInterruptIfRunning);</p><p>```</p><p>é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨è€ƒè™‘åˆ°ä½¿ç”¨ Future è·å–ä»»åŠ¡ç»“æœæ—¶ï¼Œä¼šä½¿ç”¨ ThreadPoolExecutor æˆ–è€… FutureTask æ¥å®ç°åŠŸèƒ½éœ€æ±‚ã€‚</p><p><strong>ThreadPoolExecutorã€FutureTask ä¸ Future æ¥å£å…³ç³»ç±»å›¾ï¼š</strong></p><div class=pgc-img><img alt="æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/be71e30e6bc7453eaf76bc3f7e7579b0><p class=pgc-img-caption></p></div><p><strong>TheadPoolExecutor æä¾›ä¸‰ä¸ª submit æ–¹æ³•ï¼š</strong></p><pre>// 1. æäº¤æ— éœ€è¿”å›å€¼çš„ä»»åŠ¡ï¼ŒRunnable æ¥å£ run() æ–¹æ³•æ— è¿”å›å€¼public Future&lt;?&gt; submit(Runnable task) {}// 2. æäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ï¼ŒCallable æ¥å£ call() æ–¹æ³•æœ‰è¿”å›å€¼public &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) {}// 3. æäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ï¼Œä»»åŠ¡ç»“æœæ˜¯ç¬¬äºŒä¸ªå‚æ•° result å¯¹è±¡public &lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result) {}</pre><p>ç¬¬ 3 ä¸ª submit æ–¹æ³•ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre>static String x = "ä¸œå‡çš„æ€è€ƒ";public static void main(String[] args) throws Exception { ExecutorService executor = Executors.newFixedThreadPool(1); // åˆ›å»º Result å¯¹è±¡ r Result r = new Result(); r.setName(x); // æäº¤ä»»åŠ¡ Future&lt;Result&gt; future = executor.submit(new Task(r), r); Result fr = future.get(); // ä¸‹é¢ç­‰å¼æˆç«‹ System.out.println(fr == r); System.out.println(fr.getName() == x); System.out.println(fr.getNick() == x);}static class Result { private String name; private String nick; // ... ignore getter and setter }static class Task implements Runnable { Result r; // é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥ result Task(Result r) { this.r = r; } @Override public void run() { // å¯ä»¥æ“ä½œ result String name = r.getName(); r.setNick(name); }}</pre><p>æ‰§è¡Œç»“æœéƒ½æ˜¯trueã€‚</p><p><strong>FutureTask è®¾è®¡å®ç°ï¼š</strong></p><p>å®ç°äº† Runnable å’Œ Future ä¸¤ä¸ªæ¥å£ã€‚å®ç°äº† Runnable æ¥å£ï¼Œè¯´æ˜å¯ä»¥ä½œä¸ºä»»åŠ¡å¯¹è±¡ï¼Œç›´æ¥æäº¤ç»™ ThreadPoolExecutor å»æ‰§è¡Œã€‚å®ç°äº† Future æ¥å£ï¼Œè¯´æ˜èƒ½å¤Ÿè·å–æ‰§è¡Œä»»åŠ¡çš„è¿”å›ç»“æœã€‚</p><p>æˆ‘ä»¬æ¥æ ¹æ®äº§å“çš„éœ€æ±‚ï¼Œä½¿ç”¨ FutureTask æ¨¡æ‹Ÿä¸¤ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡ç¤ºä¾‹å®ç°ä¸‹åŠŸèƒ½ã€‚</p><p>ç»“åˆç¤ºä¾‹ä»£ç æ³¨é‡Šç†è§£ï¼š</p><pre>public static void main(String[] args) throws Exception { // åˆ›å»ºä»»åŠ¡ T1 çš„ FutureTaskï¼Œè°ƒç”¨æ¨èæ¥å£è·å–æ•°æ® FutureTask&lt;String&gt; ft1 = new FutureTask&lt;&gt;(new T1Task()); // åˆ›å»ºä»»åŠ¡ T1 çš„ FutureTaskï¼Œè°ƒç”¨æœç´¢æ¥å£è·å–æ•°æ®ï¼Œä¾èµ– T1 ç»“æœ FutureTask&lt;String&gt; ft2 = new FutureTask&lt;&gt;(new T2Task(ft1)); // çº¿ç¨‹ T1 æ‰§è¡Œä»»åŠ¡ ft1 Thread T1 = new Thread(ft1); T1.start(); // çº¿ç¨‹ T2 æ‰§è¡Œä»»åŠ¡ ft2 Thread T2 = new Thread(ft2); T2.start(); // ç­‰å¾…çº¿ç¨‹ T2 æ‰§è¡Œç»“æœ System.out.println(ft2.get());}// T1Task è°ƒç”¨æ¨èæ¥å£è·å–æ•°æ®static class T1Task implements Callable&lt;String&gt; { @Override public String call() throws Exception { System.out.println("T1: è°ƒç”¨æ¨èæ¥å£è·å–æ•°æ®..."); TimeUnit.SECONDS.sleep(1); System.out.println("T1: å¾—åˆ°æ¨èæ¥å£æ•°æ®..."); TimeUnit.SECONDS.sleep(10); return " [T1 æ¿å—æ•°æ®] "; }} // T2Task è°ƒç”¨æœç´¢æ¥å£æ•°æ®ï¼ŒåŒæ—¶éœ€è¦æ¨èæ¥å£æ•°æ®static class T2Task implements Callable&lt;String&gt; { FutureTask&lt;String&gt; ft1; // T2 ä»»åŠ¡éœ€è¦ T1 ä»»åŠ¡çš„ FutureTask è¿”å›ç»“æœå»é‡ T2Task(FutureTask&lt;String&gt; ft1) { this.ft1 = ft1; } @Override public String call() throws Exception { System.out.println("T2: è°ƒç”¨æœç´¢æ¥å£è·å–æ•°æ®..."); TimeUnit.SECONDS.sleep(1); System.out.println("T2: å¾—åˆ°æœç´¢æ¥å£çš„æ•°æ®..."); TimeUnit.SECONDS.sleep(5); // è·å– T2 çº¿ç¨‹çš„æ•°æ® System.out.println("T2: è°ƒç”¨ T1.get() æ¥å£è·å–æ¨èæ•°æ®"); String tf1 = ft1.get(); System.out.println("T2: è·å–åˆ°æ¨èæ¥å£æ•°æ®:" + tf1); System.out.println("T2: å°† T1 ä¸ T2 æ¿å—æ•°æ®åšå»é‡å¤„ç†"); return "[T1 å’Œ T2 æ¿å—æ•°æ®èšåˆç»“æœ]"; }}</pre><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><pre>&gt; Task :FutureTaskTest.main()T1: è°ƒç”¨æ¨èæ¥å£è·å–æ•°æ®...T2: è°ƒç”¨æœç´¢æ¥å£è·å–æ•°æ®...T1: å¾—åˆ°æ¨èæ¥å£æ•°æ®...T2: å¾—åˆ°æœç´¢æ¥å£çš„æ•°æ®...T2: è°ƒç”¨ T1.get() æ¥å£è·å–æ¨èæ•°æ®T2: è·å–åˆ°æ¨èæ¥å£æ•°æ®: [T1 æ¿å—æ•°æ®] T2: å°† T1 ä¸ T2 æ¿å—æ•°æ®åšå»é‡å¤„ç†[T1 å’Œ T2 æ¿å—æ•°æ®èšåˆç»“æœ] </pre><p><strong>å°ç»“ï¼š</strong></p><p>Future è¡¨ç¤ºã€Œæœªæ¥ã€çš„æ„æ€ï¼Œä¸»è¦æ˜¯å°†è€—æ—¶çš„ä¸€äº›æ“ä½œä»»åŠ¡ï¼Œäº¤ç»™å•ç‹¬çš„çº¿ç¨‹å»æ‰§è¡Œã€‚ä»è€Œè¾¾åˆ°å¼‚æ­¥çš„ç›®çš„ï¼Œæäº¤ä»»åŠ¡çš„å½“å‰çº¿ç¨‹ï¼Œåœ¨æäº¤ä»»åŠ¡åå’Œè·å–ä»»åŠ¡ç»“æœçš„è¿‡ç¨‹ä¸­ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œä¸éœ€è¦åœ¨é‚£å‚»ç­‰ç€è¿”å›æ‰§è¡Œç»“æœã€‚</p><p><strong>4ã€CompleteableFuture æ¨¡å¼å®æˆ˜</strong></p><hr><p>å¯¹äº Future è®¾è®¡æ¨¡å¼ï¼Œè™½ç„¶æˆ‘ä»¬æäº¤ä»»åŠ¡æ—¶ï¼Œä¸ä¼šè¿›å…¥ä»»ä½•é˜»å¡ï¼Œä½†æ˜¯å½“è°ƒç”¨æ–¹è¦è·å¾—è¿™ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œè¿˜æ˜¯å¯èƒ½ä¼šé˜»å¡ç›´è‡³ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</p><p>åœ¨ JDK1.5 è®¾è®¡ä¹‹åˆå°±ä¸€ç›´å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå‘å±•åˆ° JDK1.8 å¼•å…¥äº† CompletableFuture æ‰å¾—åˆ°å®Œç¾çš„å¢å¼ºã€‚</p><p>åœ¨æ­¤æœŸé—´ï¼ŒGoogle å¼€æºçš„ Guava å·¥å…·åŒ…æä¾›äº† ListenableFuture ï¼Œç”¨äºæ”¯æŒä»»åŠ¡å®Œæˆæ—¶æ”¯æŒå›è°ƒæ–¹å¼ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹ä»¬å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ç ”ç©¶ã€‚</p><p>åœ¨ä¸šåŠ¡éœ€æ±‚åœºæ™¯ä»‹ç»ä¸­ï¼Œä¸åŒæ¿å—çš„æ•°æ®æ¥æºæ˜¯ä¸åŒçš„ï¼Œå¹¶ä¸”æ¿å—ä¸æ¿å—ä¹‹é—´æ˜¯å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„ã€‚</p><p>å¯ä»¥ç†è§£ä¸ºä»»åŠ¡ä¸ä»»åŠ¡ä¹‹é—´æ˜¯æœ‰æ—¶åºå…³ç³»çš„ï¼Œè€Œæ ¹æ® CompletableFuture æä¾›çš„ä¸€äº›åŠŸèƒ½ç‰¹æ€§ï¼Œæ˜¯éå¸¸é€‚åˆè¿™ç§ä¸šåŠ¡åœºæ™¯çš„ã€‚</p><p><strong>CompletableFuture ç±»å›¾ï¼š</strong></p><div class=pgc-img><img alt="æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/963ea7f277e24eaf9ec15a916b9c2815><p class=pgc-img-caption></p></div><p>CompletableFuture å®ç°äº† Future å’Œ CompletionStage ä¸¤ä¸ªæ¥å£ã€‚å®ç° Future æ¥å£æ˜¯ä¸ºäº†å…³æ³¨å¼‚æ­¥ä»»åŠ¡ä»€ä¹ˆæ—¶å€™ç»“æŸï¼Œå’Œè·å–å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„ç»“æœã€‚å®ç° CompletionStage æ¥å£ï¼Œå…¶æä¾›äº†éå¸¸ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå®ç°äº†ä¸²è¡Œå…³ç³»ã€å¹¶è¡Œå…³ç³»ã€æ±‡èšå…³ç³»ç­‰ã€‚</p><p><strong>CompletableFuture æ ¸å¿ƒä¼˜åŠ¿ï¼š</strong></p><p>1ï¼‰æ— éœ€æ‰‹å·¥ç»´æŠ¤çº¿ç¨‹ï¼Œç»™ä»»åŠ¡åˆ†é…çº¿ç¨‹çš„å·¥ä½œæ— éœ€å¼€å‘äººå‘˜å…³æ³¨ï¼›</p><p>2ï¼‰åœ¨ä½¿ç”¨ä¸Šï¼Œè¯­ä¹‰æ›´åŠ æ¸…æ™°æ˜ç¡®ï¼›</p><p>ä¾‹å¦‚ï¼št3 = t1.thenCombine(t2, () -> { // doSomething ... } èƒ½å¤Ÿæ˜ç¡®çš„è¡¨è¿°ä»»åŠ¡ 3 è¦ç­‰ä»»åŠ¡ 2 å’Œ ä»»åŠ¡ 1å®Œæˆåæ‰ä¼šå¼€å§‹æ‰§è¡Œã€‚</p><p>3ï¼‰ä»£ç æ›´åŠ ç®€ç»ƒï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼Œè®©ä½ æ›´ä¸“æ³¨ä¸šåŠ¡é€»è¾‘ã€‚</p><p>4ï¼‰æ–¹ä¾¿çš„å¤„ç†å¼‚å¸¸æƒ…å†µ</p><p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡ CompletableFuture æ¥æ¨¡æ‹Ÿå®ç°ä¸“è¾‘ä¸‹å¤šæ¿å—æ•°æ®èšåˆå¤„ç†ã€‚</p><p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre>public static void main(String[] args) throws Exception { // æš‚å­˜æ•°æ® List&lt;String&gt; stashList = Lists.newArrayList(); // ä»»åŠ¡ 1ï¼šè°ƒç”¨æ¨èæ¥å£è·å–æ•°æ® CompletableFuture&lt;String&gt; t1 = CompletableFuture.supplyAsync(() -&gt; { System.out.println("T1: è·å–æ¨èæ¥å£æ•°æ®..."); sleepSeconds(5); stashList.add("[T1 æ¿å—æ•°æ®]"); return "[T1 æ¿å—æ•°æ®]"; }); // ä»»åŠ¡ 2ï¼šè°ƒç”¨æœç´¢æ¥å£è·å–æ•°æ® CompletableFuture&lt;String&gt; t2 = CompletableFuture.supplyAsync(() -&gt; { System.out.println("T2: è°ƒç”¨æœç´¢æ¥å£è·å–æ•°æ®..."); sleepSeconds(3); return " [T2 æ¿å—æ•°æ®] "; }); // ä»»åŠ¡ 3ï¼šä»»åŠ¡ 1 å’Œä»»åŠ¡ 2 å®Œæˆåæ‰§è¡Œï¼Œèšåˆç»“æœ CompletableFuture&lt;String&gt; t3 = t1.thenCombine(t2, (t1Result, t2Result) -&gt; { System.out.println(t1Result + " ä¸ " + t2Result + "å®ç°å»é‡é€»è¾‘å¤„ç†"); return "[T1 å’Œ T2 æ¿å—æ•°æ®èšåˆç»“æœ]"; }); // ç­‰å¾…ä»»åŠ¡ 3 æ‰§è¡Œç»“æœ System.out.println(t3.get(6, TimeUnit.SECONDS));}static void sleepSeconds(int timeout) { try { TimeUnit.SECONDS.sleep(timeout); } catch (InterruptedException e) { e.printStackTrace(); }}</pre><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><pre>&gt; Task :CompletableFutureTest.main()T1: è·å–æ¨èæ¥å£æ•°æ®...T2: è°ƒç”¨æœç´¢æ¥å£è·å–æ•°æ®...[T1 æ¿å—æ•°æ®] ä¸ [T2 æ¿å—æ•°æ®] å®ç°å»é‡é€»è¾‘å¤„ç†[T1 å’Œ T2 æ¿å—æ•°æ®èšåˆç»“æœ]</pre><p>ä¸Šè¿°çš„ç¤ºä¾‹ä»£ç åœ¨ IDEA ä¸­æ–°å»ºä¸ªClassï¼Œç›´æ¥å¤åˆ¶è¿›å»ï¼Œå³å¯æ­£å¸¸è¿è¡Œã€‚</p><p><strong>** 5ã€CompletableFuture ç”Ÿäº§å»ºè®®**</strong></p><hr><p><strong>åˆ›å»ºåˆç†çš„çº¿ç¨‹æ± ï¼š</strong></p><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œä¸å»ºè®®ç›´æ¥ä½¿ç”¨ä¸Šè¿°ç¤ºä¾‹ä»£ç å½¢å¼ã€‚å› ä¸ºç¤ºä¾‹ä»£ç ä¸­ä½¿ç”¨çš„</p><p>CompletableFuture.supplyAsync(() -> {});</p><p>åˆ›å»º CompletableFuture å¯¹è±¡çš„ supplyAsync() æ–¹æ³•ï¼ˆè¿™é‡Œä½¿ç”¨çš„å·¥å‚æ–¹æ³•æ¨¡å¼ï¼‰ï¼Œåº•å±‚ä½¿ç”¨çš„é»˜è®¤çº¿ç¨‹æ± ï¼Œä¸ä¸€å®šèƒ½æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ã€‚</p><p>ç»“åˆåº•å±‚æºä»£ç æ¥çœ‹ä¸€ä¸‹ï¼š</p><pre>// é»˜è®¤ä½¿ç”¨ ForkJoinPool çº¿ç¨‹æ± private static final Executor asyncPool = useCommonPool ? ForkJoinPool.commonPool() : new ThreadPerTaskExecutor();public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier) { return asyncSupplyStage(asyncPool, supplier);}</pre><p>åˆ›å»º ForkJoinPool çº¿ç¨‹æ± ï¼š</p><p>é»˜è®¤çº¿ç¨‹æ± å¤§å°æ˜¯ Runtime.getRuntime().availableProcessors() - 1ï¼ˆCPU æ ¸æ•° - 1ï¼‰ï¼Œå¯ä»¥é€šè¿‡ JVM å‚æ•° -Djava.util.concurrent.ForkJoinPool.common.parallelism è®¾ç½®çº¿ç¨‹æ± å¤§å°ã€‚</p><p>JVM å‚æ•°ä¸Šé…ç½® -Djava.util.concurrent.ForkJoinPool.common.threadFactory è®¾ç½®çº¿ç¨‹å·¥å‚ç±»ï¼›é…ç½® -Djava.util.concurrent.ForkJoinPool.common.exceptionHandler è®¾ç½®å¼‚å¸¸å¤„ç†ç±»ï¼Œè¿™ä¸¤ä¸ªå‚æ•°è®¾ç½®åï¼Œå†…éƒ¨ä¼šé€šè¿‡ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½ Classã€‚</p><p>å¦‚æœæ‰€æœ‰ CompletableFuture éƒ½ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± ï¼Œä¸€æ—¦æœ‰ä»»åŠ¡æ‰§è¡Œå¾ˆæ…¢çš„ I/O æ“ä½œï¼Œå°±ä¼šå¯¼è‡´æ‰€æœ‰çº¿ç¨‹éƒ½é˜»å¡åœ¨ I/O æ“ä½œä¸Šï¼Œè¿›è€Œå½±å“ç³»ç»Ÿæ•´ä½“æ€§èƒ½ã€‚</p><p>æ‰€ä»¥ï¼Œå»ºè®®å¤§å®¶åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ—¶ï¼Œæ ¹æ®ä¸åŒçš„ä¸šåŠ¡ç±»å‹åˆ›å»ºä¸åŒçš„çº¿ç¨‹æ± ï¼Œä»¥é¿å…äº’ç›¸å½±å“ã€‚</p><p>CompletableFuture è¿˜æä¾›äº†å¦å¤–æ”¯æŒçº¿ç¨‹æ± çš„æ–¹æ³•ã€‚</p><pre>// ç¬¬äºŒä¸ªå‚æ•°æ”¯æŒä¼ é€’ Executor è‡ªå®šä¹‰çº¿ç¨‹æ± public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier, Executor executor) { return asyncSupplyStage(screenExecutor(executor), supplier);}</pre><p>è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œå»ºè®®å‚è€ƒ ã€Œé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€ï¼Œæ¨èä½¿ç”¨ ThreadPoolExecutor è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µè®¾ç½®é˜Ÿåˆ—å¤§å°ã€‚</p><p>çº¿ç¨‹æ± å¤§å°çš„è®¾ç½®ï¼Œåœ¨ ã€ŒJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€ä¸€ä¹¦ä¸­ï¼ŒBrian Goetz æä¾›äº†ä¸å°‘ä¼˜åŒ–å»ºè®®ã€‚å¦‚æœçº¿ç¨‹æ± æ•°é‡è¿‡å¤šï¼Œç«äº‰ CPU å’Œå†…å­˜èµ„æºï¼Œå¯¼è‡´å¤§é‡æ—¶é—´åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸Šã€‚åä¹‹ï¼Œå¦‚æœçº¿ç¨‹æ± æ•°é‡è¿‡å°‘ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨ CPU å¤šæ ¸ä¼˜åŠ¿ã€‚</p><p>çº¿ç¨‹æ± å¤§å°ä¸ CPU å¤„ç†å™¨çš„åˆ©ç”¨ç‡ä¹‹æ¯”å¯ä»¥ç”¨ä¸‹é¢å…¬å¼ä¼°ç®—ï¼š</p><div class=pgc-img><img alt="æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15a2f43eee5747129967153c9b0fff42><p class=pgc-img-caption></p></div><p><strong>å¼‚å¸¸å¤„ç†ï¼š</strong></p><p>CompletableFuture æä¾›äº†éå¸¸ç®€å•çš„å¼‚å¸¸å¤„ç† ï¼Œå¦‚ä¸‹è¿™äº›æ–¹æ³•ï¼Œæ”¯æŒé“¾å¼ç¼–ç¨‹æ–¹å¼ã€‚</p><pre>// ç±»ä¼¼äº try{}catch{} ä¸­çš„ catch{}public CompletionStage&lt;T&gt; exceptionally (Function&lt;Throwable, ? extends T&gt; fn); // ç±»ä¼¼äº try{}finally{} ä¸­çš„ finally{}ï¼Œä¸æ”¯æŒè¿”å›ç»“æœpublic CompletionStage&lt;T&gt; whenComplete (BiConsumer&lt;? super T, ? super Throwable&gt; action);public CompletionStage&lt;T&gt; whenCompleteAsync (BiConsumer&lt;? super T, ? super Throwable&gt; action); // ç±»ä¼¼äº try{}finally{} ä¸­çš„ finally{}ï¼Œæ”¯æŒè¿”å›ç»“æœpublic &lt;U&gt; CompletionStage&lt;U&gt; handle (BiFunction&lt;? super T, Throwable, ? extends U&gt; fn);public &lt;U&gt; CompletionStage&lt;U&gt; handleAsync (BiFunction&lt;? super T, Throwable, ? extends U&gt; fn);</pre><p><strong>#### 6ã€CompletableFuture æ€§èƒ½æµ‹è¯•ï¼š</strong></p><p>å¾ªç¯å‹æµ‹ä»»åŠ¡æ•°å¦‚ä¸‹æ‰€ç¤ºï¼Œæ¯æ¬¡æ‰§è¡Œå‹æµ‹ï¼Œä» 1 åˆ° jobNum æ•°æ®å åŠ æ±‡èšç»“æœï¼Œè®¡ç®—è€—æ—¶ã€‚</p><p>ç»Ÿè®¡ç»´åº¦ï¼šCompletableFuture é»˜è®¤çº¿ç¨‹æ±  ä¸ è‡ªå®šä¹‰çº¿ç¨‹æ± ã€‚</p><p>æ€§èƒ½æµ‹è¯•ä»£ç ï¼š</p><pre>// æ€§èƒ½æµ‹è¯•ä»£ç Arrays.asList(-3, -1, 0, 1, 2, 4, 5, 10, 16, 17, 30, 50, 100, 150, 200, 300).forEach(offset -&gt; { int jobNum = PROCESSORS + offset; System.out.println( String.format("When %s tasks =&gt; stream: %s, parallelStream: %s, future default: %s, future custom: %s", testCompletableFutureDefaultExecutor(jobNum), testCompletableFutureCustomExecutor(jobNum)));});// CompletableFuture ä½¿ç”¨é»˜è®¤ ForkJoinPool çº¿ç¨‹æ± private static long testCompletableFutureDefaultExecutor(int jobCount) { List&lt;CompletableFuture&lt;Integer&gt;&gt; tasks = new ArrayList&lt;&gt;(); IntStream.rangeClosed(1, jobCount).forEach(value -&gt; tasks.add(CompletableFuture.supplyAsync(CompleteableFuturePerfTest::getJob))); long start = System.currentTimeMillis(); int sum = tasks.stream().map(CompletableFuture::join).mapToInt(Integer::intValue).sum(); checkSum(sum, jobCount); return System.currentTimeMillis() - start;}// CompletableFuture ä½¿ç”¨è‡ªå®šä¹‰çš„çº¿ç¨‹æ± private static long testCompletableFutureCustomExecutor(int jobCount) { ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(200, 200, 5, TimeUnit.MINUTES, new ArrayBlockingQueue&lt;&gt;(100000), new ThreadFactory() { @Override public Thread newThread(Runnable r) { Thread thread = new Thread(r); thread.setName("CUSTOM_DAEMON_COMPLETABLEFUTURE"); thread.setDaemon(true); return thread; } }, new ThreadPoolExecutor.CallerRunsPolicy()); List&lt;CompletableFuture&lt;Integer&gt;&gt; tasks = new ArrayList&lt;&gt;(); IntStream.rangeClosed(1, jobCount).forEach(value -&gt; tasks.add(CompletableFuture.supplyAsync(CompleteableFuturePerfTest::getJob, threadPoolExecutor))); long start = System.currentTimeMillis(); int sum = tasks.stream().map(CompletableFuture::join).mapToInt(Integer::intValue).sum(); checkSum(sum, jobCount); return System.currentTimeMillis() - start;}</pre><p>æµ‹è¯•æœºå™¨é…ç½®ï¼š8 æ ¸CPUï¼Œ16Gå†…å­˜</p><p>æ€§èƒ½æµ‹è¯•ç»“æœï¼š</p><div class=pgc-img><img alt="æœ‰äº† CompletableFutureï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰é‚£ä¹ˆéš¾äº†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5cbf2ad690624651b897fc36cafb8794><p class=pgc-img-caption></p></div><p>æ ¹æ®å‹æµ‹ç»“æœçœ‹åˆ°ï¼Œéšç€å‹æµ‹ä»»åŠ¡æ•°é‡è¶Šå¤§ï¼Œä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ± æ€§èƒ½è¶Šå·®ã€‚</p><p><strong>7ã€CompletableFuture ä½¿ç”¨æ‰©å±•ï¼š</strong></p><hr><p><strong>å¯¹è±¡åˆ›å»ºï¼š</strong></p><p>é™¤å‰é¢æåˆ°çš„ supplyAsync æ–¹æ³•å¤–ï¼ŒCompletableFuture è¿˜æä¾›äº†å¦‚ä¸‹æ–¹æ³•ï¼š</p><pre>// æ‰§è¡Œä»»åŠ¡ï¼ŒCompletableFuture&lt;Void&gt; æ— è¿”å›å€¼ï¼Œé»˜è®¤çº¿ç¨‹æ± public static CompletableFuture&lt;Void&gt; runAsync(Runnable runnable) { return asyncRunStage(asyncPool, runnable);}// æ‰§è¡Œä»»åŠ¡ï¼ŒCompletableFuture&lt;Void&gt; æ— è¿”å›å€¼ï¼Œæ”¯æŒè‡ªå®šä¹‰çº¿ç¨‹æ± public static CompletableFuture&lt;Void&gt; runAsync(Runnable runnable, Executor executor) { return asyncRunStage(screenExecutor(executor), runnable);}</pre><p>æˆ‘ä»¬åœ¨ CompletableFuture æ¨¡å¼å®æˆ˜ä¸­ï¼Œæåˆ°äº† CompletableFuture å®ç°äº† CompletionStage æ¥å£ï¼Œè¯¥æ¥å£æä¾›äº†éå¸¸ä¸°å¯Œçš„åŠŸèƒ½ã€‚</p><p>CompletionStage æ¥å£æ”¯æŒä¸²è¡Œå…³ç³»ã€æ±‡èš AND å…³ç³»ã€æ±‡èš OR å…³ç³»ã€‚</p><p>ä¸‹é¢å¯¹è¿™äº›å…³ç³»çš„æ¥å£åšä¸ªç®€å•æè¿°ï¼Œå¤§å®¶åœ¨ä½¿ç”¨æ—¶å¯ä»¥å»è‡ªè¡ŒæŸ¥é˜… JDK APIã€‚</p><p>åŒæ—¶ï¼Œè¿™äº›å…³ç³»æ¥å£ä¸­æ¯ä¸ªæ–¹æ³•éƒ½æä¾›äº†å¯¹åº”çš„ xxxAsync() æ–¹æ³•ï¼Œè¡¨ç¤ºå¼‚æ­¥åŒ–æ‰§è¡Œä»»åŠ¡ã€‚</p><p><strong>ä¸²è¡Œå…³ç³»ï¼š</strong></p><p>CompletionStage æè¿°ä¸²è¡Œå…³ç³»ï¼Œä¸»è¦æœ‰ thenApplyã€thenRunã€thenAccept å’Œ thenCompose ç³»åˆ—æ¥å£ã€‚</p><p>æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre>// å¯¹åº” U apply(T t) ï¼Œæ¥æ”¶å‚æ•° Tå¹¶æ”¯æŒè¿”å›å€¼ Upublic &lt;U&gt; CompletionStage&lt;U&gt; thenApply(Function&lt;? super T,? extends U&gt; fn);public &lt;U&gt; CompletionStage&lt;U&gt; thenApplyAsync(Function&lt;? super T,? extends U&gt; fn);// ä¸æ¥æ”¶å‚æ•°ä¹Ÿä¸æ”¯æŒè¿”å›å€¼public CompletionStage&lt;Void&gt; thenRun(Runnable action);public CompletionStage&lt;Void&gt; thenRunAsync(Runnable action);// æ¥æ”¶å‚æ•°ä½†ä¸æ”¯æŒè¿”å›å€¼public CompletionStage&lt;Void&gt; thenAccept(Consumer&lt;? super T&gt; action);public CompletionStage&lt;Void&gt; thenAcceptAsync(Consumer&lt;? super T&gt; action);// ç»„åˆä¸¤ä¸ªä¾èµ–çš„ CompletableFuture å¯¹è±¡public &lt;U&gt; CompletionStage&lt;U&gt; thenCompose (Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn);public &lt;U&gt; CompletionStage&lt;U&gt; thenComposeAsync (Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn);</pre><p><strong>æ±‡èš AND å…³ç³»ï¼š</strong></p><p>CompletionStage æè¿° æ±‡èš AND å…³ç³»ï¼Œä¸»è¦æœ‰ thenCombineã€thenAcceptBoth å’Œ runAfterBoth ç³»åˆ—æ¥å£ã€‚</p><p>æºç å¦‚ä¸‹æ‰€ç¤ºï¼ˆçœç•¥äº†Async æ–¹æ³•ï¼‰ï¼š</p><pre>// å½“å‰å’Œå¦å¤–çš„ CompletableFuture éƒ½å®Œæˆæ—¶ï¼Œä¸¤ä¸ªå‚æ•°ä¼ é€’ç»™ fnï¼Œfn æœ‰è¿”å›å€¼public &lt;U,V&gt; CompletionStage&lt;V&gt; thenCombine (CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; fn);// å½“å‰å’Œå¦å¤–çš„ CompletableFuture éƒ½å®Œæˆæ—¶ï¼Œä¸¤ä¸ªå‚æ•°ä¼ é€’ç»™ actionï¼Œaction æ²¡æœ‰è¿”å›å€¼public &lt;U&gt; CompletionStage&lt;Void&gt; thenAcceptBoth (CompletionStage&lt;? extends U&gt; other, BiConsumer&lt;? super T, ? super U&gt; action);// å½“å‰å’Œå¦å¤–çš„ CompletableFuture éƒ½å®Œæˆæ—¶ï¼Œæ‰§è¡Œ actionpublic CompletionStage&lt;Void&gt; runAfterBoth(CompletionStage&lt;?&gt; other, Runnable action);</pre><p><strong>æ±‡èš OR å…³ç³»ï¼š</strong></p><p>CompletionStage æè¿° æ±‡èš OR å…³ç³»ï¼Œä¸»è¦æœ‰ applyToEitherã€acceptEither å’Œ runAfterEither ç³»åˆ—æ¥å£ã€‚</p><p>æºç å¦‚ä¸‹æ‰€ç¤ºï¼ˆçœç•¥äº†Async æ–¹æ³•ï¼‰ï¼š</p><pre>// å½“å‰ä¸å¦å¤–çš„ CompletableFuture ä»»ä½•ä¸€ä¸ªæ‰§è¡Œå®Œæˆï¼Œå°†å…¶ä¼ é€’ç»™ fnï¼Œæ”¯æŒè¿”å›å€¼public &lt;U&gt; CompletionStage&lt;U&gt; applyToEither (CompletionStage&lt;? extends T&gt; other, Function&lt;? super T, U&gt; fn);// å½“å‰ä¸å¦å¤–çš„ CompletableFuture ä»»ä½•ä¸€ä¸ªæ‰§è¡Œå®Œæˆï¼Œå°†å…¶ä¼ é€’ç»™ actionï¼Œä¸æ”¯æŒè¿”å›å€¼public CompletionStage&lt;Void&gt; acceptEither (CompletionStage&lt;? extends T&gt; other, Consumer&lt;? super T&gt; action);// å½“å‰ä¸å¦å¤–çš„ CompletableFuture ä»»ä½•ä¸€ä¸ªæ‰§è¡Œå®Œæˆï¼Œç›´æ¥æ‰§è¡Œ actionpublic CompletionStage&lt;Void&gt; runAfterEither(CompletionStage&lt;?&gt; other, Runnable action);</pre><p>åˆ°æ­¤ï¼ŒCompletableFuture çš„ç›¸å…³ç‰¹æ€§éƒ½ä»‹ç»å®Œäº†ã€‚</p><p>å¼‚æ­¥ç¼–ç¨‹æ…¢æ…¢å˜å¾—è¶Šæ¥è¶Šæˆç†Ÿï¼ŒJava è¯­è¨€å®˜ç½‘ä¹Ÿå¼€å§‹æ”¯æŒå¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼Œæ‰€ä»¥å­¦å¥½å¼‚æ­¥ç¼–ç¨‹è¿˜æ˜¯æœ‰å¿…è¦çš„ã€‚</p><p>æœ¬æ–‡ç»“åˆä¸šåŠ¡éœ€æ±‚åœºæ™¯é©±åŠ¨ï¼Œå¼•å‡ºäº† Future è®¾è®¡æ¨¡å¼å®æˆ˜ï¼Œç„¶åå¯¹ JDK1.8 ä¸­çš„ CompletableFuture æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œæ ¸å¿ƒä¼˜åŠ¿ã€æ€§èƒ½æµ‹è¯•å¯¹æ¯”ã€ä½¿ç”¨æ‰©å±•æ–¹é¢åšäº†è¿›ä¸€æ­¥å‰–æã€‚</p><p>å¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ï¼</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'CompletableFuture','å¼‚æ­¥','ç¼–ç¨‹'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>