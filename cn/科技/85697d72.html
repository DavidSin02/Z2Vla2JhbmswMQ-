<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>我用 Go 生成的随机数为什么不随机？随机数是怎样产生的 | 极客快訊</title><meta property="og:title" content="我用 Go 生成的随机数为什么不随机？随机数是怎样产生的 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/47dfbe87bec844cf988f2e497c78641a"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/85697d72.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/85697d72.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/85697d72.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/85697d72.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/85697d72.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/85697d72.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/85697d72.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/85697d72.html><meta property="article:published_time" content="2020-11-14T21:08:08+08:00"><meta property="article:modified_time" content="2020-11-14T21:08:08+08:00"><meta name=Keywords content><meta name=description content="我用 Go 生成的随机数为什么不随机？随机数是怎样产生的"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/85697d72.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>我用 Go 生成的随机数为什么不随机？随机数是怎样产生的</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div class=pgc-img><img alt="我用 Go 生成的随机数为什么不随机？随机数是怎样产生的" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/47dfbe87bec844cf988f2e497c78641a><p class=pgc-img-caption></p></div><p>Illustration created for “A Journey With Go”, made from the original Go Gopher, created by Renee French.</p><p>这篇文章基于 Go 1.13 版本</p><p>Go 实现了两个包来产生随机数：</p><ul><li>在包 math/rand 的一个伪随机数生成器（ PRNG ）</li><li>在包 crypto/rand 中实现的加密伪随机数生成器（ CPRNG ）</li></ul><p>如果这两个包都产生了随机数，你需要在真正的随机数和性能之间寻找平衡。</p><h2 class=pgc-h-arrow-right>确定的结果</h2><p>Go 的 rand 包会使用相同的源来产生一个确定的伪随机数序列。这个源会产生一个不变的数列，稍后在执行期间使用。将你的程序运行多次将会读到一个完全相同的序列并产生相同的结果。让我们用一个简单的例子来尝试一下：</p><pre><code>func main() {   for i := 0; i &lt; 4; i++  {      println(rand.Intn(100))   }}</code></pre><p>多次运行这个程序将会产生相同的结果：</p><pre><code>81874759</code></pre><p>由于源代码已经发布到 Go 的官方标准库中，因此任何运行此程序的计算机都会得到相同的结果。但是，由于 Go 仅保留一个生成的数字序列，我们可能想知道 Go 是如何管理用户请求的时间间隔的。Go 实际上使用此数字序列来播种一个产生这个随机数的源，然后获取其请求间隔的模。例如，运行相同的程序，最大值为 10，则模 10 的结果相同。</p><pre><code>1779</code></pre><p>让我们来看一下如何在每次运行我们的程序时得到不同的序列。</p><h2 class=pgc-h-arrow-right>播种</h2><p>Go 提供一个方法， Seed(see int64) ，该方法能让你初始化这个默认序列。默认情况下，它会使用变量 1。使用另一个变量将会提供一个新的序列，但会保持确定性：</p><pre><code>func main() {   rand.Seed(2)   for i := 0; i &lt; 4; i++  {      println(rand.Intn(100))   }}</code></pre><p>这些是新的结果：</p><pre><code>86869240</code></pre><p>在你每次运行这个程序时，这个序列将会保持不变。这是构建此序列的工作流：</p><div class=pgc-img><img alt="我用 Go 生成的随机数为什么不随机？随机数是怎样产生的" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/faf7743287794054b10531e30b565ce9><p class=pgc-img-caption></p></div><p>The sequence is pre-generated at the bootstrap</p><p>获取一个全新序列的解决方案是使用一个在运行时能改变的变量，比如当前时间：</p><pre><code>func main() {   rand.Seed(time.Now().UnixNano())   for i := 0; i &lt; 3; i++  {      println(rand.Intn(100))   }}</code></pre><p>由于当前纳秒数在任何时刻都是不同的，因此这个程序每次运行都会使用一个不同的序列。然而，尽管这个序列在每次运行都是不同的，可这些数字仍是伪随机数。如果你准备牺牲性能来获得更好的随机性，那么 Go 已经为你提供了另一种实现方式。</p><h2 class=pgc-h-arrow-right>随机数生成器</h2><p>Go 的标准库也提供了一个适用于加密应用的随机数生成器。因此，理所当然的，生成的随机数并不固定，并且一定会提供更好的随机性。这有一个例子使用了这个新包 cryto/rand ：</p><pre><code>func main() {   for i := 0; i &lt; 4; i++  {      n, _ := rand.Int(rand.Reader, big.NewInt(100))      println(n.Int64())   }}</code></pre><p>这是结果：</p><pre><code>12245619</code></pre><p>多次运行这个程序将会得到不同的结果。在内部，Go 应用了如下规则：</p><blockquote><p>在 Linux 和 FreeBSD 系统上，Reader 会使用 getrandom(2) （如果可用的话），否则使用 /dev/urandom。</p><p>在 OpenBSD 上，Reader 会使用 getentropy(2)。</p><p>在其他的类 Unix 系统上，Reader 会读取 /dev/urandom。</p><p>在 Windows 系统上，Reader 会使用 CryptGenRandom API.</p><p>在 Wasm 上，Reader 会使用 Web Cryto API。</p></blockquote><p>但是，获得更好的质量意味着性能降低，因为它必须执行更多的操作并且不能使用预生成的序列。</p><h2 class=pgc-h-arrow-right>性能</h2><p>为了理解生成随机数的两种不同方式之间的折衷，我基于先前的两个例子运行了一个基准测试。结果如下：</p><pre><code>name    time/opRandWithCrypto-8  272ns ± 3%name    time/opRandWithMath-8   22.8ns ± 4%</code></pre><p>不出所料，crypto 包更慢一些。但是，如果你不用去处理安全的随机数，那么 math 包就足够了并且它将会给你提供最好的性能。</p><p>你也可以调整默认数字生成器，由于内部互斥锁的存在，它是并发安全的。如果生成器并不在并发环境下使用，那么你就可以在不使用锁的情况下创建你自己的生成器：</p><pre><code>func main() {   gRand := rand.New(rand.NewSource(1).(rand.Source64))   for i := 0; i &lt; 4; i++  {      println(gRand.Intn(100))   }}</code></pre><p>性能会更好：</p><pre><code>name                  time/opRandWithMathNoLock-8  10.7ns ± 4%</code></pre><hr><p>via：https://medium.com/a-journey-with-go/go-how-are-random-numbers-generated-e58ee8696999</p><p>作者：<strong>Vincent Blanchon[1]</strong>译者：<strong>sh1luo[2]</strong>校对：<strong>lxbwolf[3]</strong></p><p>本文由 <strong>GCTT[4]</strong> 原创编译，<strong>Go 中文网[5]</strong> 荣誉推出</p><h3 class=pgc-h-arrow-right>参考资料</h3><p>[1]</p><p>Vincent Blanchon: https://medium.com/@blanchon.vincent</p><p>[2]</p><p>sh1luo: https://github.com/sh1luo</p><p>[3]</p><p>lxbwolf: https://github.com/lxbwolf</p><p>[4]</p><p>GCTT: https://github.com/studygolang/GCTT</p><p>[5]</p><p>Go 中文网: https://studygolang.com/</p><p><br></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'随机','我用','Go'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>