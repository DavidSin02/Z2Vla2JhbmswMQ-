<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>浅析数据库与缓存的双写一致性问题 | 极客快訊</title><meta property="og:title" content="浅析数据库与缓存的双写一致性问题 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/2050ed7e40ed40779b7aae6c6e1882f2"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8661033e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8661033e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8661033e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8661033e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8661033e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8661033e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8661033e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8661033e.html><meta property="article:published_time" content="2020-11-14T21:04:04+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:04+08:00"><meta name=Keywords content><meta name=description content="浅析数据库与缓存的双写一致性问题"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/8661033e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>浅析数据库与缓存的双写一致性问题</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>更多内容，欢迎关注微信公众号：全菜工程师小辉~</p><p>缓存由于其高并发和高性能的特性，在项目中被广泛使用。读缓存流程如下图：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=浅析数据库与缓存的双写一致性问题 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2050ed7e40ed40779b7aae6c6e1882f2><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>双写一致性有以下三个要求：</p><ol><li>缓存不能读到脏数据</li><li>缓存可能会读到过期数据，但要在可容忍时间内实现最终一致</li><li>这个可容忍时间尽可能的小</li></ol><p>要想同时满足上面三条，可以采用读请求和写请求串行化，串到一个内存队列里去，这样就可以保证一定不会出现不一致的情况。但是，串行化之后，就会导致系统的吞吐量会大幅度的降低，要用比正常情况下多几倍的机器去支撑线上请求。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=浅析数据库与缓存的双写一致性问题 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d135ec11180742b28c777fa5f0107256><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>所以，在这里，我们讨论三种常见方法：</p><ol><li>先更新数据库，再更新缓存</li><li>先删除缓存，再更新数据库</li><li>先更新数据库，再删除缓存</li></ol><h1><strong>1. 先更新数据库，再更新缓存</strong></h1><p>这种方法是大家普遍反对的，原因集中在下面两点：</p><p>原因1：线程安全角度。</p><p>同时有请求A和请求B进行更新操作，那么会出现:</p><ol><li>线程A更新了数据库</li><li>线程B更新了数据库</li><li>线程B更新了缓存</li><li>线程A更新了缓存</li><li>这就出现请求A更新缓存应该比请求B更新缓存早才对，但是因为网络等原因，B却比A更早更新了缓存。这就导致了脏数据，因此不考虑。</li></ol><blockquote><p>"先更新缓存，再更新数据库"这种方案同理，也是造成脏数据，所以不被考虑</p></blockquote><p>原因2：业务场景角度。</p><p>有如下两点：</p><ol><li>如果你是一个写数据库场景比较多，而读数据场景比较少的业务需求，采用这种方案就会导致数据压根还没读到，缓存就被频繁的更新，浪费性能。</li><li>如果你写入数据库的值，并不是直接写入缓存的，而是要经过一系列复杂的计算再写入缓存。那么，每次写入数据库后，都再次计算写入缓存的值，无疑是浪费性能的。显然，删除缓存更为适合。</li></ol><blockquote><p>如果一定要更新缓存，可以考虑给缓存数据增加版本号</p></blockquote><p class=ql-align-center><br></p><div class=pgc-img><img alt=浅析数据库与缓存的双写一致性问题 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/67a5b742c00f4dce83bc08da0d62c8d7><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><h1><strong>2. 先删除缓存，再更新数据库</strong></h1><p>该方案同样会导致不一致。同时有请求A和请求B进行更新操作，那么会出现:</p><ol><li>请求A进行写操作，删除缓存</li><li>请求B查询发现缓存不存在</li><li>请求B去数据库查询得到旧值</li><li>请求B将旧值写入缓存</li><li>请求A将新值写入数据库上述情况就会导致不一致的情形出现。而且，如果不采用给缓存设置过期时间策略，该数据永远都是脏数据。</li></ol><p class=ql-align-center><br></p><div class=pgc-img><img alt=浅析数据库与缓存的双写一致性问题 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e0a158bd257642679a5d6dfac60b1d53><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>解决方法：</p><ol><li>先删除缓存</li><li>再写数据库(这两步和原来一样)</li><li>休眠一定时间（例如1秒或200ms），再次删除缓存。这么做，可以将缓存脏数据再次删除。</li></ol><blockquote><p>然而这种解决方案由于要休眠线程还是很影响吞吐量的</p></blockquote><h1><strong>3. 先更新数据库，再删除缓存</strong></h1><p>这种方案是很多工程采用的方案，我们来看下是否一定安全。</p><p>假设有两个请求，一个请求A做查询操作，一个请求B做更新操作，那么会有如下情形产生</p><ol><li>缓存刚好失效</li><li>请求A查询数据库，得一个旧值</li><li>请求B将新值写入数据库</li><li>请求B删除缓存</li><li>请求A将查到的旧值写入缓存</li></ol><p>这样，脏数据就产生了，然而上面的情况是假设在数据库写请求<span>比读</span>请求还要快。实际上，工程中数据库的读操作的速度远快于写操作的。</p><p>要么通过2PC或是Paxos协议保证一致性，要么就是想尽办法降低并发时脏数据的概率，大概是因为2PC太慢，而Paxos又太复杂，综合考虑，Facebook选择了这个第三种方案。</p><h1><strong>如果删除缓存失败了怎么办？</strong></h1><p>启动一个订阅程序去订阅数据库的binlog，获得需要操作的数据。在应用程序中，另起一段程序，获得这个订阅程序传来的信息，进行删除缓存操作。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=浅析数据库与缓存的双写一致性问题 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3ac4489eb43d4f63bf7ce12770dccaa8><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><blockquote><p>阿里开源的中间件canal可以完成订阅binlog日志的功能。</p></blockquote><h1><strong>总结</strong></h1><p>本文是对目前互联网中已有的一致性方案进行了一个总结，希望大家有所收获。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'浅析','数据库','缓存'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>