<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>如何设计一个高可用、高并发秒杀系统 | 极客快訊</title><meta property="og:title" content="如何设计一个高可用、高并发秒杀系统 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/276d44d4e08e46c091540e4c54b5b98c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/87c923e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/87c923e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/87c923e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/87c923e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/87c923e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/87c923e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/87c923e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/87c923e.html><meta property="article:published_time" content="2020-10-29T20:59:27+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:27+08:00"><meta name=Keywords content><meta name=description content="如何设计一个高可用、高并发秒杀系统"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/87c923e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>如何设计一个高可用、高并发秒杀系统</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>作者：vincentsu，腾讯 PCG 后台开发工程师</p><blockquote><p>如今的互联网已经在海量服务领域有了很成熟的理论，因此自己也很庆幸，能够从 0 到 1 完整践行海量服务。微视春节项目中的集卡瓜分活动，是一个典型的秒杀场景，自己参与其中，分享一些心得和总结。</p></blockquote><p>如今的互联网已经在海量服务领域有了很成熟的理论，因此自己也很庆幸，能够从 0 到 1 完整践行海量服务。微视春节项目中的集卡瓜分活动，是一个典型的秒杀场景，自己参与其中，分享一些心得和总结。</p><h1>秒杀系统的难点</h1><ul><li>友好的用户体验</li><li>用户不能接受破窗的体验，例如：系统超时、系统错误的提示，或者直接 404 页面</li><li>瞬时高并发流量的挑战</li><li>木桶短板理论，整个系统的瓶颈往往都在 DB，如何设计出高并发、高可用系统？</li></ul><h1>如何设计</h1><div class=pgc-img><img alt=如何设计一个高可用、高并发秒杀系统 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/276d44d4e08e46c091540e4c54b5b98c></div><p><br></p><p>上图是一个典型的互联网业务，用户完成一个写操作，一般会通过接入层和逻辑层，这里的服务都是无状态，可以通过平行拓展去解决高并发的问题；到了 db 层，必须要落到介质中，可以是磁盘/ssd/内存，如果出现 key 的冲突，会有一些并发控制技术，例如 cas/加锁/串行排队等。</p><p><strong>直筒型</strong></p><p>直筒型业务，指的是用户请求 1:1 的洞穿到 db 层，如下图所示。在比较简单的业务中，才会采用这个模型。随着业务规模复杂度上来，一定会有 db 和逻辑层分离、逻辑层和接入层分离。</p><div class=pgc-img><img alt=如何设计一个高可用、高并发秒杀系统 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/25e71cf09cae4cd284a786a32ca01ff8></div><p><br></p><p><strong>漏斗型</strong></p><p>漏斗型业务，指的是，用户的请求，从客户端到 db 层，层层递减，递减的程度视业务而定。例如当 10w 人去抢 1 个物品时，db 层的请求在个位数量级，这就是比较理想的模型。如下图所示</p><div class=pgc-img><img alt=如何设计一个高可用、高并发秒杀系统 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f2bfd1310e374b0aa70b93ef240738b6></div><p><br></p><p>这个模型，是高并发的基础，翻译一下就是下面这些：</p><ul><li>及早发现，及早拒绝</li><li>Fast Fail</li><li>前端保护后端</li></ul><p><br></p><h1>如何实现漏斗型系统</h1><p>漏斗型系统需要从产品策略/客户端/接入层/逻辑层/DB 层全方位立体的设计。</p><div class=pgc-img><img alt=如何设计一个高可用、高并发秒杀系统 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ebc9a259e0d04efdbf0e110d24ba4e8f></div><p><br></p><p>产品策略</p><ul><li>轻重逻辑分离，以秒杀为例，将抢到和到账分开；</li><li>抢到，是比较轻的操作，库存扣成功后，就可以成功了</li><li>到账，是比较重的操作，需要涉及到到事务操作</li><li>用户分流，以整点秒杀活动为例，在 1 分钟内，陆续对用户放开入口，将所有用户请求打散在 60s 内，请求就可以降一个数量级</li><li>页面简化，在秒杀开始的时候，需要简化页面展示，该时刻只保留和秒杀相关的功能。例如，秒杀开始的时候，页面可以不展示推荐的商品。</li></ul><p><br></p><p>客户端</p><ul><li>重试策略非常关键，如果用户秒杀失败了，频繁重试，会加剧后端的雪崩。如何重试呢？根据后端返回码的约定，有两种方法：</li><li>不允许重试错误，此时 ui 和文案都需要有一个提示。同时不允许重试</li><li>可重试错误，需要策略重试，例如二进制退避法。同时文案和 ui 需要提示。</li><li>ui 和文案，秒杀开始前后，用户的所有异常都需要有精心设计的 ui 和文案提示。例如：【当前活动太火爆，请稍后再重试】【你的货物堵在路上，请稍后查看】等</li><li>前端随机丢弃请求可以作为降级方案，当用户流量远远大于系统容量时，人工下发随机丢弃标记，用户本地客户端开始随机丢弃请求。</li></ul><p><br></p><p>接入层</p><ul><li>所有请求需要鉴权，校验合法身份</li><li>如果是长链接的服务，鉴权粒度可以在 session 级别；如果是短链接业务，需要应对这种高并发流量，例如 cache 等</li><li>根据后端系统容量，需要一个全局的限流功能，通常有两种做法：</li><li>设置好 N 后，动态获取机器部署情况 M，然后下发单机限流值 N/M。要求请求均匀访问，部署机器统一。</li><li>维护全局 key，以时间戳建 key。有热 key 问题，可以通过增加更细粒度的 key 或者定时更新 key 的方法。</li><li>对於单用户/单 ip 需要频控，主要是防黑产和恶意用户。如果秒杀是有条件的，例如需要完成 xxx 任务，解锁资格，对于获得资格的步骤，可以进行安全扫描，识别出黑产和恶意用户。</li></ul><p><br></p><p>逻辑层</p><ul><li>逻辑层首先应该进入校验逻辑，例如参数的合法性，是否有资格，如果失败的用户，快速返回，避免请求洞穿到 db。</li><li>异步补单，对于已经扣除秒杀资格的用户，如果发货失败后，通常的两种做法是：</li><li>事务回滚，回滚本次行为，提示用户重试。这个代价特别大，而且用户重试和前面的重试策略结合的话，用户体验也不大流畅。</li><li>异步重做，记录本次用户的 log，提示用户【稍后查看，正在发货中】，后台在峰值过后，启动异步补单。需要服务支持幂等</li><li>对于发货的库存，需要处理热 key。通常的做法是，维护多个 key，每个用户固定去某个查询库存。对于大量人抢红包的场景，可以提前分配。</li></ul><p><br></p><p>存储层</p><p>对于业务模型而言，对于 db 的要求需要保证几个原则：</p><ul><li>可靠性</li><li>主备：主备能互相切换，一般要求在同城跨机房</li><li>异地容灾：当一地异常，数据能恢复，异地能选主</li><li>数据需要持久化到磁盘，或者更冷的设备</li><li>一致性</li><li>对于秒杀而言，需要严格的一致性，一般要求主备严格的一致。</li></ul><p><br></p><h1>实践——微视集卡瓜分系统</h1><p>微视集卡瓜分项目属于微视春节项目之一。用户的体验流程如下：</p><div class=pgc-img><img alt=如何设计一个高可用、高并发秒杀系统 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6133eff6e396435097de8b5f74e2ae39></div><p><br></p><p>架构图</p><div class=pgc-img><img alt=如何设计一个高可用、高并发秒杀系统 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a47f13bca966442c893c407699b015ba></div><p><br></p><ul><li>客户端主要是微视主 app 和 h5 页面，主 app 是入口，h5 页面是集卡活动页面和瓜分页面。</li><li>逻辑部分为分：发卡来源、集卡模块、奖品模块，发卡来源主要是任务模块；集卡模块主要由活动模块和集卡模块组成。瓜分部分主要在活动控制层。</li><li>奖品模块主要是发钱和其他奖品。</li></ul><p>瓜分降级预案</p><p>为了做好瓜分时刻的高并发，对整个系统需要保证两个重要的事情：</p><ul><li>全链路梳理，包括调用链的合理性和时延设置</li><li>降级服务预案分析，提升系统的鲁棒性</li></ul><p>如下图所示，是针对瓜分全链路调用分析如下图，需要特别说明的几点：</p><div class=pgc-img><img alt=如何设计一个高可用、高并发秒杀系统 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/77c113e69a574c6bba95e6312117f56d></div><p><br></p><ul><li>时延很重要，需要全链路分析。不但可以提高吞吐量，而且可以快速暴露系统的瓶颈。</li><li>峰值时刻，补单逻辑需要关闭，避免加剧雪崩。</li></ul><p>我们的降级预案大概如下：</p><ul><li>一级预案，瓜分时刻前后 5 分钟自动进入：</li><li>入口处 1 分钟内陆续放开入口倒计时，未登录用户不弹入口</li><li>主会场排队，进入主会场以 100wqps 为例，超过了进入排队，由接入层频控控制</li><li>拉取资格接口排队，拉取资格接口 100wqps，超过了进入排队，由接入层频控控制</li><li>抢红包排队，抢红包 100wqps，超过了进入排队，由接入层频控控制</li><li>红包到账排队，如果资格扣除成功，现金发放失败，进入排队，24 小时内到账。异步补单</li><li>入口处调用后端非关键 rpc:ParticipateStatus，手动关闭</li><li>异步补单逻辑关闭。</li><li>二级预案，后端随机丢请求，接入层频控失效或者下游服务过载，手动开启进入</li><li>三级预案，前端随机丢请求，后端服务过载或者宕机进入。手动开启</li></ul><p>综上，整个瓜分时刻体验如下所示：</p><div class=pgc-img><img alt=如何设计一个高可用、高并发秒杀系统 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8dbb1710bf004552b7a9119364c79cb0></div><p><br></p><p>回顾下漏斗模型，总结下整个实践：</p><div class=pgc-img><img alt=如何设计一个高可用、高并发秒杀系统 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/75f8eec593bc42f5a59056e0ef1c5f63></div><p><br></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'设计','一个','发秒'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>