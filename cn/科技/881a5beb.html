<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Kuberneteså…±äº«å­˜å‚¨ä¹‹Glusterfs+Heketi | æå®¢å¿«è¨Š</title><meta property="og:title" content="Kuberneteså…±äº«å­˜å‚¨ä¹‹Glusterfs+Heketi - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/99fae0316a954b669b420bf79dd56645"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/881a5beb.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/881a5beb.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/881a5beb.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/881a5beb.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/881a5beb.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/881a5beb.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/881a5beb.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/881a5beb.html><meta property="article:published_time" content="2020-11-14T20:59:56+08:00"><meta property="article:modified_time" content="2020-11-14T20:59:56+08:00"><meta name=Keywords content><meta name=description content="Kuberneteså…±äº«å­˜å‚¨ä¹‹Glusterfs+Heketi"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/881a5beb.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Kuberneteså…±äº«å­˜å‚¨ä¹‹Glusterfs+Heketi</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><div class=pgc-img><img alt=Kuberneteså…±äº«å­˜å‚¨ä¹‹Glusterfs+Heketi onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/99fae0316a954b669b420bf79dd56645><p class=pgc-img-caption></p></div><p>KubernetesæŒä¹…åŒ–å­˜å‚¨å¯åˆ†ä¸ºé™æ€å­˜å‚¨ä»¥åŠåŠ¨æ€å­˜å‚¨ï¼Œé™æ€å­˜å‚¨ï¼Œå¸¸ç”¨çš„ç”¨hostpathæœ¬åœ°å­˜å‚¨ï¼ŒNFSï¼Œglusterfså­˜å‚¨ç­‰ï¼Œéœ€è¦äº‹å…ˆéƒ¨ç½²å¥½å­˜å‚¨å·pvï¼Œå†é€šè¿‡K8Sçš„pvcè·å–åˆ°å­˜å‚¨ç©ºé—´è¿›è¡Œå­˜å‚¨ã€‚åŠ¨æ€å­˜å‚¨ï¼Œäº‹å…ˆéƒ¨ç½²å¥½glusterfsé›†ç¾¤ä»¥åŠHeketiï¼Œé€šè¿‡äºŒè€…åä½œï¼Œè¾¾åˆ°åªéœ€è¦åˆ›å»ºç”³è¯·pvcå°±å¯ä»¥åŠ¨æ€ç”³è¯·åˆ°å­˜å‚¨ç©ºé—´ï¼Œçœå»äº†åº•å±‚å­˜å‚¨å·ä»¥åŠpvçš„åˆ›å»ºã€‚</p><p>å‡†å¤‡ä¸‰å°è™šæ‹Ÿæœºï¼Œé…ç½®2æ ¸4g kubeadmå®‰è£…çš„é«˜å¯ç”¨K8Sé›†ç¾¤</p><p>172.30.0.74 k8smaster1 hostnameï¼š k8smaster1</p><p>172.30.0.82 k8smaster2 hostnameï¼š k8smaster2</p><p>172.30.0.90 k8snode hostnameï¼š k8snode</p><p><strong>glusterfsé›†ç¾¤åˆ›å»º</strong></p><p><strong></strong><strong>é…ç½®glusterfs yumæº</strong></p><pre> # CentOS-Gluster-4.1.repo # # Please see http://wiki.centos.org/SpecialInterestGroup/Storage for more # information [centos-gluster41] name=CentOS-$releasever - Gluster 4.1 (Long Term Maintanance) baseurl=http://mirror.centos.org/centos-7/7/storage/x86_64/gluster-4.1/ gpgcheck=0 enabled=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Storage [centos-gluster41-test] name=CentOS-$releasever - Gluster 4.1 Testing (Long Term Maintenance) baseurl=http://buildlogs.centos.org/centos/$releasever/storage/$basearch/gluster-4.1/ gpgcheck=0 enabled=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Storage</pre><p><strong>å®‰è£…glusterfs</strong></p><pre> # yum install glusterfs-server å¯åŠ¨ï¼š # systemctl start glusterd # systemctl start glusterfsd </pre><p>æ¯å°glusterfsèŠ‚ç‚¹éƒ½è¦å®‰è£…</p><p><strong>glusterfsä½¿ç”¨</strong></p><pre> # glusterfs peer probe k8smaster2 # glusterfs peer probe k8snode å°†glusterfsèŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ä¸­ è®¾ç½®glusterfså·ï¼š # mkdir /data/brick1/gv2</pre><p>ä¸‰å°æœºå­éƒ½éœ€è¦æ‰§è¡Œ</p><p>åˆ›å»ºå¤åˆ¶å·ï¼š</p><pre> # gluster volume create gv2 replica 2 172.30.0.74:/data/brick1/gv2 172.30.0.82:/data/brick1/gv2 force</pre><p>å¯åŠ¨glusterfså·ï¼š</p><pre> # gluster volume start gv2 # gluster volume info </pre><p>æŸ¥çœ‹å·çš„æƒ…å†µ</p><p>glusterfsé›†ç¾¤åˆ›å»ºå®Œæˆ</p><p><strong>Heketié…ç½®</strong></p><p>Heketiæä¾›äº†ä¸€ä¸ªRESTfulç®¡ç†ç•Œé¢ï¼Œå¯ä»¥ç”¨æ¥ç®¡ç†GlusterFSå·çš„ç”Ÿå‘½å‘¨æœŸã€‚ é€šè¿‡Heketiï¼Œå°±å¯ä»¥åƒä½¿ç”¨OpenStack Manilaï¼ŒKuberneteså’ŒOpenShiftä¸€æ ·ç”³è¯·å¯ä»¥åŠ¨æ€é…ç½®GlusterFSå·ã€‚Heketiä¼šåŠ¨æ€åœ¨é›†ç¾¤å†…é€‰æ‹©bricksæ„å»ºæ‰€éœ€çš„volumesï¼Œè¿™æ ·ä»¥ç¡®ä¿æ•°æ®çš„å‰¯æœ¬ä¼šåˆ†æ•£åˆ°é›†ç¾¤ä¸åŒçš„æ•…éšœåŸŸå†…ã€‚åŒæ—¶Heketiè¿˜æ”¯æŒä»»æ„æ•°é‡çš„ClusterFSé›†ç¾¤ï¼Œä»¥ä¿è¯æ¥å…¥çš„äº‘æœåŠ¡å™¨ä¸å±€é™æ–¼å•ä¸ªGlusterFSé›†ç¾¤ã€‚</p><p><strong>è·å–å®‰è£…åŒ…</strong></p><pre> # wget https://github.com/heketi/heketi/releases/download/v5.0.1/heketi-v5.0.1.linux.amd64.tar.gz # tar xf heketi-v5.0.1.linux.amd64.tar.gz # ln -s /root/heketi/heketi /bin/heketi # ln -s /root/heketi/heketi-cli /bin/heketi-cli</pre><p><strong>ä¿®æ”¹Heketié…ç½®æ–‡ä»¶</strong></p><p>ä¿®æ”¹heketié…ç½®æ–‡ä»¶/etc/heketi/heketi.jsonï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><p>......</p><p>#ä¿®æ”¹ç«¯å£ï¼Œé˜²æ­¢ç«¯å£å†²çª</p><pre> "port": "18080", ...... #å…è®¸è®¤è¯ "use_auth": true, ......  #adminç”¨æˆ·çš„keyæ”¹ä¸ºadminkey "key": "adminkey" ...... #ä¿®æ”¹æ‰§è¡Œæ’ä»¶ä¸ºsshï¼Œå¹¶é…ç½®sshçš„æ‰€éœ€è¯ä¹¦ï¼Œæ³¨æ„è¦èƒ½å¯¹é›†ç¾¤ä¸­çš„æœºå™¨å…å¯†sshç™»é™†ï¼Œä½¿ç”¨ssh-copy-idæŠŠpub keyæ‹·åˆ°æ¯å°glusterfsæœåŠ¡å™¨ä¸Š "executor": "ssh", "sshexec": { "keyfile": "/root/.ssh/id_rsa", "user": "root", "port": "22", "fstab": "/etc/fstab" }, ...... # å®šä¹‰heketiæ•°æ®åº“æ–‡ä»¶ä½ç½® "db": "/var/lib/heketi/heketi.db" ...... #è°ƒæ•´æ—¥å¿—è¾“å‡ºçº§åˆ« "loglevel" : "warning"</pre><p>PSï¼šéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œheketiæœ‰ä¸‰ç§executorï¼Œåˆ†åˆ«ä¸ºmockã€sshã€kubernetesï¼Œå»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä½¿ç”¨mockï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨sshï¼Œå½“glusterfsä»¥å®¹å™¨çš„æ–¹å¼éƒ¨ç½²åœ¨kubernetesä¸Šæ—¶ï¼Œæ‰ä½¿ç”¨kubernetesã€‚æˆ‘ä»¬è¿™é‡Œå°†glusterfså’Œheketiç‹¬ç«‹éƒ¨ç½²ï¼Œä½¿ç”¨sshçš„æ–¹å¼ã€‚</p><p>å¯åŠ¨Heketiï¼š</p><pre> nohup heketi --config=/etc/heketi/heketi.json &amp; </pre><p><strong>Heketiæ·»åŠ Glusterfs</strong></p><p><strong>åˆ›å»ºé›†ç¾¤</strong></p><pre> # heketi-cli --user admin --server http://172.30.0.74:28080 --secret adminkey --json cluster create {"id":"7e320f3f04068c0564eb92e865263bd4","nodes":[],"volumes":[]}</pre><p>ä½¿ç”¨è¿”å›çš„å”¯ä¸€é›†ç¾¤idå°†ä¸‰ä¸ªèŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ä¸­</p><pre> # heketi-cli --user admin --server http://172.30.0.73:28080 --secret adminkey --json node add --cluster "7e320f3f04068c0564eb92e865263b" --management-host-name 172.30.0.73 --storage-host-name 172.30.0.74 --zone 1 # heketi-cli --user admin --server http://172.30.0.73:28080 --secret adminkey --json node add --cluster "7e320f3f04068c0564eb92e865263b" --management-host-name 172.30.0.81 --storage-host-name 172.30.0.82 --zone 1 # heketi-cli --user admin --server http://172.30.0.73:28080 --secret adminkey --json node add --cluster "7e320f3f04068c0564eb92e865263b" --management-host-name 172.30.0.89 --storage-host-name 172.30.0.90 --zone 1 </pre><p>åœ¨ä¸‰ä¸ªèŠ‚ç‚¹åˆ›å»ºé€»è¾‘å·ï¼Œä½œä¸ºHeketiçš„deviceï¼Œæ–¹ä¾¿åç»­æ‰©å±•ï¼Œæ³¨æ„Heketiåªæ”¯æŒè£¸åˆ†åŒºæˆ–è€…è£¸ç£ç›˜ï¼Œä¸éœ€è¦æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ</p><pre> # heketi-cli --json device add --name="/dev/myvg/mylv" --server http://172.30.0.74:28080 --node "78850cf6d4a44964b1fdf09970feb0" # heketi-cli --json device add --name="/dev/myvg/mylv" --server http://172.30.0.74:28080 --node "560f238695f64479298429c062dc4c"  # heketi-cli --json device add --name="/dev/myvg/mylv" --server http://172.30.0.74:28080 --node "4e3e965421d26e6858d18e6ccaf19f"</pre><p><strong>ç”Ÿäº§å®é™…é…ç½®</strong></p><p>ä¸Šé¢å±•ç¤ºäº†å¦‚ä½•æ‰‹åŠ¨ä¸€æ­¥æ­¥ç”Ÿæˆclusterï¼Œå¾€clusterä¸­æ·»åŠ èŠ‚ç‚¹ï¼Œæ·»åŠ deviceçš„æ“ä½œï¼Œåœ¨æˆ‘ä»¬å®é™…ç”Ÿäº§é…ç½®ä¸­ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡é…ç½®æ–‡ä»¶å®Œæˆã€‚</p><p>åˆ›å»ºä¸€ä¸ª/etc/heketi/topology-sample.jsonçš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><pre>{ "clusters": [ { "nodes": [ { "node": { "hostnames": { "manage": [ "192.168.75.175" ], "storage": [ "192.168.75.175" ] }, "zone": 1 }, "devices": [ "/dev/vda2" ] }, { "node": { "hostnames": { "manage": [ "192.168.75.176" ], "storage": [ "192.168.75.176" ] }, "zone": 1 }, "devices": [ "/dev/vda2" ] }, { "node": { "hostnames": { "manage": [ "192.168.75.177" ], "storage": [ "192.168.75.177" ] }, "zone": 1 }, "devices": [ "/dev/vda2" ] }, { "node": { "hostnames": { "manage": [ "192.168.75.178" ], "storage": [ "192.168.75.178" ] }, "zone": 1 }, "devices": [ "/dev/vda2" ] }  ] } ]}</pre><p>åˆ›å»ºï¼š</p><p>heketi-cli topology load --json topology-sample.json</p><p>è‡³æ­¤å‰æœŸglusterfsä»¥åŠHeketiçš„å‡†å¤‡å·¥ä½œå·²å®Œæˆ</p><p>åˆ›å»ºK8Sçš„storageclassæ–‡ä»¶ï¼Œä½¿å¾—K8Sè°ƒç”¨Heketiåˆ›å»ºåº•å±‚pv</p><p><strong>åˆ›å»ºstorageclass</strong></p><pre> [root@consolefan-1 yaml]# cat glusterfs/storageclass-glusterfs.yaml  apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: glusterfs provisioner: kubernetes.io/glusterfs  parameters: resturl: "http://172.30.0.74:28080" clusterid: "7e320f3f04068c0564eb92e865263b" restauthenabled: "true" restuser: "admin" restuserkey: "adminkey" gidMin: "40000" gidMax: "50000" volumetype: "replicate:2" # kubectl apply -f storageclass-glusterfs.yamlã€</pre><p>åˆ›å»ºpvcè¿›è¡ŒéªŒè¯ï¼š</p><pre> [root@consolefan-1 yaml]# cat glusterfs/pvc-glusterfs.yaml  kind: PersistentVolumeClaim apiVersion: v1 metadata: name: glusterfs-test1 namespace: default annotations: volume.beta.kubernetes.io/storage-class: "glusterfs" spec: accessModes: - ReadWriteMany resources: requests: storage: 1Gi  # kubectl apply -f pvc-glusterfs.yaml</pre><p>æ„å»ºæˆåŠŸ</p><div class=pgc-img><img alt=Kuberneteså…±äº«å­˜å‚¨ä¹‹Glusterfs+Heketi onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2ac24d6c6a654f2ca28e57fdc1b5bb7e><p class=pgc-img-caption></p></div><p>å…³æ³¨æˆ‘ï¼Œç§ä¿¡å…³é”®å­—ã€èµ„æ–™ã€‘å³å¯è·å–Javaå¹¶å‘ç¼–ç¨‹/Springæºç åˆ†æ/redis/mongodb/dubbo/zookeeperfka /Spring-cloudå’Œé«˜å¹¶å‘ã€é«˜å¯ç”¨ã€åˆ†å¸ƒå¼ã€é«˜æ€§èƒ½æ¶æ„è®¾è®¡ç²¾è®²ï¼Œè¿˜æœ‰é¢è¯•ä¸“é¢˜èµ„æ–™</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Kubernetes','å­˜å‚¨','Glusterfs'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>