<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MySQL 传统复制中常见故障处理和结构优化案例分析 | 极客快訊</title><meta property="og:title" content="MySQL 传统复制中常见故障处理和结构优化案例分析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/c993e94407a64d11a011fbe9f2793025"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8aa8e939.html><meta property="article:published_time" content="2020-11-14T21:04:04+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:04+08:00"><meta name=Keywords content><meta name=description content="MySQL 传统复制中常见故障处理和结构优化案例分析"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/8aa8e939.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MySQL 传统复制中常见故障处理和结构优化案例分析</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>虽然MySQL5.7 的主从复制已经很稳定了，但在备库可读写的情况下，总是会出现部分数据不一致的情况，例如常见的1062、1032和1050错误。下面就介绍下这类报错的常见处理方法和常见主从复制结构的调整。</p><p>环境描述</p><p>一</p><ul class=ul-level-0><li>1、mysql 5.7 以上，</li><li>2、binlog format 是row格式（5.7默认）</li><li>3、传统复制（生产强烈推荐使用gtid）</li><li>4、log-bin , log_slave_updates 开启</li><li>5、复制结构：101：3306> 103:3306 > 104:3306</li></ul><p>常见主从复制报错</p><p>二</p><p>1、表重复错误： 1050</p><p>从库已经有T2表，再在主库上创建T2. 处理原则：以主库为准，在从库上drop t2。 然后重启slave。</p><p>注意： 在db里的操作都会记录到binlog中，如果不想被记录到binlog中，可以先set sql_log_bin=0.drop完成后，再 set sql_log_bin=1即可。</p><p>从5.7 开始，有super read only。</p><div class=pgc-img><img alt="MySQL 传统复制中常见故障处理和结构优化案例分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c993e94407a64d11a011fbe9f2793025><p class=pgc-img-caption></p></div><p>处理方法：</p><p>从库操作：</p><p>set sql_log_bin=0；</p><p>drop table t2;</p><p>set sql_log_bin=1;</p><p>start slave;</p><p>show slave status;</p><p>2、主键冲突： 1062</p><div class=pgc-img><img alt="MySQL 传统复制中常见故障处理和结构优化案例分析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/513e7061090a46a98a515bdf74b0e0ff><p class=pgc-img-caption></p></div><p>处理方法：</p><p>从库操作：</p><blockquote><p>set sql_log_bin=0；</p><p>delete from t2 where id =2;</p><p>set sql_log_bin=1;</p><p>start slave;</p><p>show slave status;</p></blockquote><p>3、主库上更新后，从库找不到记录 ：1032</p><div class=pgc-img><img alt="MySQL 传统复制中常见故障处理和结构优化案例分析" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/31b512eb8d1b4a3fb0097b4573a73b3c><p class=pgc-img-caption></p></div><p>这时需要解析主库的binlog，把从库的数据补回来。</p><div class=pgc-img><img alt="MySQL 传统复制中常见故障处理和结构优化案例分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d7e27ff6c3fa401ea06357b007a17aa2><p class=pgc-img-caption></p></div><p>这里就能看到从库丢失的那条记录。然后在从库补充这条记录即可。</p><p>处理方法：</p><p>从库操作：</p><blockquote><p>set sql_log_bin=0；</p><p>insert into t2 (id) values (2);</p><p>set sql_log_bin=1;</p><p>start slave;</p><p>show slave status;</p></blockquote><p>4、主库上delete后，从库找不到记录： 1032</p><div class=pgc-img><img alt="MySQL 传统复制中常见故障处理和结构优化案例分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6e28635e00ee49ba9586ad484d4f7abc><p class=pgc-img-caption></p></div><p>想看某段pos内执行过的sql： 主库执行：</p><blockquote><p><br></p></blockquote><pre><code>mysqlbinlog --base64-output=decode-rows -v --start-position=2465 --stop-position=2748 mysql-bin.000050 &gt; 50.sql</code></pre><p>输出如下：</p><blockquote><p><br></p></blockquote><pre><code>### DELETE FROM `wubx`.`wubx`### WHERE###   @1=2###   @2='wubx'ROLLBACK /* added by mysqlbinlog */ /*!*/; </code></pre><p>注意这里的rollback。如果以后基于binlog和时间点的恢复。这条数据会被rollback掉，造成一条数据的丢失。所以如果想保留这条数据，需要找到commit的位置，或者下个pos的位置。</p><p>处理方法：</p><p>从库操作：</p><blockquote><p>slave stop;</p><p>SET GLOBAL SQL_SLAVE_SKIP_COUNTER = 1 #跳过一个事务</p><p>slave start</p></blockquote><p>常见复制结构调整</p><p>三</p><p>1、一主一从，添加从库</p><blockquote><p><br></p></blockquote><pre><code>st=&gt;operation: M 101:3306e=&gt;endop=&gt;operation: S1 103:3306 st-&gt;op-&gt;op1</code></pre><p>调整为，级联或星型结构</p><blockquote><p><br></p></blockquote><pre><code>st=&gt;operation: M 101:3306e=&gt;endop=&gt;operation: S1 103:3306op1=&gt;operation: S11 104:3306 st-&gt;op-&gt;op1</code></pre><p>2、级联复制调整</p><p><strong>从103.3306 dump数据</strong></p><blockquote><p><br></p></blockquote><pre><code>mysqldump --single-transaction --master-data=2 -uroot -p123456  -A -S /tmp/mysql3306.sock</code></pre><p><strong>104 导入数据</strong></p><blockquote><p><br></p></blockquote><pre><code>mysql -S /tmp/mysql3306.sock -uroot -p123456 &lt; /tmp/1203.sql</code></pre><p><strong>change 104 到103</strong></p><blockquote><p><br></p></blockquote><pre><code>change master to master_host='192.168.56.103', master_user='repl', master_password='repl4slave', master_port=3306, MASTER_LOG_FILE='mysql-bin.000001', MASTER_LOG_POS=4138, master_connect_retry=10;</code></pre><p><strong>101 插入测试数据</strong></p><blockquote><p><br></p></blockquote><pre><code>insert into t2 values (200);</code></pre><p><strong>101 持续insert</strong></p><blockquote><p><br></p></blockquote><pre><code>for ((i=1;i&lt;=1000000;i++))domysql -S /tmp/mysql3306.sock -uroot -p123456 -e "insert into enmo.t2 values($i)"done</code></pre><p><strong>关闭103 主机，并检查104 slave 状态</strong></p><div class=pgc-img><img alt="MySQL 传统复制中常见故障处理和结构优化案例分析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3514db9272cd4991a8fa7ee8f8a8489e><p class=pgc-img-caption></p></div><p><strong>主从的binlog 都会记录主库的server id 和timestamp信息。可以根据这2个信息去定位相应的pos信息。</strong></p><p>101:3306</p><div class=pgc-img><img alt="MySQL 传统复制中常见故障处理和结构优化案例分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5f30419856304f4594264aea3afe40db><p class=pgc-img-caption></p></div><p>104:3306</p><div class=pgc-img><img alt="MySQL 传统复制中常见故障处理和结构优化案例分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fba122e6b2644ababfa4b6b215145ded><p class=pgc-img-caption></p></div><p>这里可以看到101 结束 insert 1419后，并commit的 pos 是387204，所以104 change 的pos 可以选择到387204这里。但是如果104没有把1419 这条记录commit的话，就要选择101 开始 insert 1419 这个事务之间的pos：387020.</p><p><strong>104 change 到101</strong></p><blockquote><p><br></p></blockquote><pre><code>change master to master_host='192.168.56.103', master_user='repl', master_password='repl4slave', master_port=3306,  MASTER_LOG_FILE='mysql-bin.000093', MASTER_LOG_POS=387204, master_connect_retry=10;</code></pre><p>作者介绍</p><p>张灿 云和恩墨技术顾问</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'MySQL','传统','处理'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>