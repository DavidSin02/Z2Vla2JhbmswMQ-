<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MongoDB云上灾备：如何快速复制阿里异地灾备、多活架构 | 极客快訊</title><meta property="og:title" content="MongoDB云上灾备：如何快速复制阿里异地灾备、多活架构 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/15348464211881fc66bb425"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ab616ca.html><meta property="article:published_time" content="2020-10-29T21:09:57+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:57+08:00"><meta name=Keywords content><meta name=description content="MongoDB云上灾备：如何快速复制阿里异地灾备、多活架构"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/8ab616ca.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MongoDB云上灾备：如何快速复制阿里异地灾备、多活架构</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>摘要</strong>： MongoDB云上灾备BLS产品正式发布</p><h1>1. 背景</h1><p>当前的数据库系统生态中，大部分系统都支持多个节点实例间的数据同步机制 ，如Mysql Master/Slave主从同步，Redis AOF主从同步等，MongoDB更是支持3节点(及以上)ReplicaSet同步，上述机制很好的支撑了一个逻辑单元的数据冗余及HA。</p><p>跨逻辑单元(3节点实例、主从实例)，甚至跨单元、跨数据中心的数据同步，在业务层有时候就显得很重要，可以支持同城多机房的负载均衡，多机房的互备，甚至是异地多数据中心容灾(比如 光纤被挖断、地震等小概率事件)和多活。</p><p>基于以上背景，云数据库MongoDB版本正式推出MongoDB实例间的双向同步产品<strong>“MongoDB云上灾备”</strong>（也称BLS），助力企业快速复制阿里巴巴异地灾备、多活架构。</p><p>产品地址</p><h1>2. 产品介绍</h1><p>“MongoDB云上灾备”通过从源数据库拉取Oplog（Operations Log）数据（其是MongoDB的日志，所有对数据库的修改操作都会保存到oplog中），然后将其传输到目的数据库进行回放实现复制的目的。我们通过构造两条复制链路实现双向同步的功能，基于此，可以实现灾备和多活的功能。</p><div class=pgc-img><img alt=MongoDB云上灾备：如何快速复制阿里异地灾备、多活架构 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/15348464211881fc66bb425><p class=pgc-img-caption></p></div><p>上图给出了整体复制同步的流程。目前，“MongoDB云上灾备”支持的源、目的数据库类型为ReplicaSet副本集，Sharding模式即将上线，不支持单节点模式。为了减缓主节点的压力，系统从备（Secondary）上拉取Oplog。</p><p><strong>全量加增量</strong></p><p>同步模型采用全量+增量的方式：在创建时会对源数据库进行全量同步，后续的修改通过增量来同步。</p><p><strong>双活以及多活模型</strong></p><p>由于复制是异步模式，所以对于双活/多活模式，由用户保证不会对同一个唯一键同时修改，因为同时修改将可能导致数据错乱。目前冲突策略可以为覆盖或者忽略。后续将会上线校验程序，在用户操作相同唯一键时提供接口报错。</p><p><strong>高效性保证</strong></p><p>同步延迟因地域和网络不同而不同，理论TPS能够接近20万（每秒传输20万条oplog）。为了保证批量传输的高效性，数据发送存在缓存机制，所以少量数据的同步时延可能超过5秒。</p><ul><li>源数据库并行拉取，解决冲突依赖</li><li>并行发往Kafka通道</li><li>目的端在解决依赖的同时并行写入数据库</li></ul><p><strong>环形复制</strong></p><p>为了防止环形复制（数据从源复制到目的，又从目的复制到源），在Oplog日志中打入gid解决该问题。</p><p><strong>可靠性传输</strong></p><p>支持断点续传，实例重启时数据同步不受影响。</p><p><strong>高可用</strong></p><p>链路同步具有高可用性，如果同步进程挂掉，会有备进程启动接管服务。</p><p><strong>限制说明</strong></p><ul><li>DDL语句同步暂未开放，所以如果修改了源、目的数据的索引操作，无法同步。</li><li>目的数据库需要创建，暂不支持在2个已有MongoDB实例之间直接搭通道。</li><li>当前只支持双活功能(2个MongoDB实例之间同步数据)，后续会上线多活功能(多个MongoDB实例之间同步数据)。</li></ul><h1>3. 架构</h1><p>在“MongoDB云上灾备”产品中，主要有3大组件：</p><ul><li>BLS Manager。中心控制模块，负责Collector、Receiver的调度、监控等任务。</li><li>BLS Collector。数据采集模块，负责从源MongoDB数据库拉取Oplog数据后发送到Kafka通道。</li><li>BLS Receiver。数据回放模块，负责从Kafka通道中获取数据，然后写入目的MongoDB数据库。</li></ul><p>下图展示了系统的整体架构图。</p><div class=pgc-img><img alt=MongoDB云上灾备：如何快速复制阿里异地灾备、多活架构 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15348464210819d8c6a0a82><p class=pgc-img-caption></p></div><h1>4. 用户使用案例</h1><p>高德地图 App是国内首屈一指的地图及导航应用，阿里云MongoDB数据库服务为该应用提供了部分功能的存储支撑，存储亿级别数据。现在高德使用国内三中心的策略，通过地理位置等信息路由最近中心提升服务质量，业务方(高德地图)通过用户路由到三个城市数据中心，如下图所示，机房数据之间无依赖计算。数据在不同中心的同步通过“MongoDB云上灾备”产品实现。</p><div class=pgc-img><img alt=MongoDB云上灾备：如何快速复制阿里异地灾备、多活架构 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1534846421211c37b37fe43><p class=pgc-img-caption></p></div><p>这三个城市地理上从北到南横跨了整个中国 ，这对多数据中心如何做好复制、容灾提出了挑战，如果某个地域的机房、网络出现问题，可以平滑的将流量切换到另一个地方，做到用户几乎无感知？</p><p>目前策略是，拓扑采用机房两两互联方式，每个机房的数据都通过“MongoDB云上灾备”异步地将数据同步到另外两个机房。然后通过高德的路由层，将用户请求路由到不同的数据中心，读写均发送在同一个数据中心，保证一定的事务性。这样保证每个数据中心都有全量的数据(保证最终一致性) 。任意机房出现问题，另两个机房中的一个可以通过切换后提供读写服务。下图展示了城市1和城市2机房的同步情况。</p><div class=pgc-img><img alt=MongoDB云上灾备：如何快速复制阿里异地灾备、多活架构 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1534846421235b94088083e><p class=pgc-img-caption></p></div><p>遇到某个单元不能访问的问题，Manager通过“MongoDB云上灾备”产品管理接口，可以获得各个机房的同步偏移量和时间戳，通过判断采集和写入值即可判断异步复制是否在某个时间点已经完成。再配合业务方的DNS切流，切走单元流量并保证原有单元的请求在新单元是可以读写的，如下图所示。</p><div class=pgc-img><img alt=MongoDB云上灾备：如何快速复制阿里异地灾备、多活架构 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1534846421292b086787c35><p class=pgc-img-caption></p></div><p>作者：烛昭</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'灾备','MongoDB','云上'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>