<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 | 极客快訊</title><meta property="og:title" content="GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/371ad575b55b44229e1db4afbdfa29f8"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8c67467.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8c67467.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8c67467.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8c67467.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8c67467.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8c67467.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8c67467.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8c67467.html><meta property="article:published_time" content="2020-10-29T21:01:13+08:00"><meta property="article:modified_time" content="2020-10-29T21:01:13+08:00"><meta name=Keywords content><meta name=description content="GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/8c67467.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>近期360互联网安全中心监控到一款GarrantyDecrypt勒索病毒的新变种开始在国内传播。该勒索病毒通过RSA结合salsa20对文件进行加密，被加密的文件后缀会被修改为NOSTRO，加密过程也非常规范，密钥使用完成会被马上销毁，加密文件实行"一次一密"。该勒索病毒也是我们见到的最丧心病狂的勒索病毒之一——<strong>不区分文件类型，加密几乎所有类型的文件</strong>。根据360互联网安全中心的监测，该勒索病毒主要通过爆破远程桌面弱口令，登录远程后手动投毒进行传播。</p><p>样本分析</p><p><strong>前期准备</strong></p><p>该勒索病毒在加密文件之前，会先做下面4项准备：</p><p>1. 判断当前进程权限，如果权限较低，则重新提权启动。</p><p>2. 判断当前系统语言环境，避开斯拉夫语系的环境。这一点和之前很多勒索病毒一样(例如Hermes、Locky等勒索病毒)，都避开了俄罗斯、乌克兰、哈萨克斯坦几个地区。</p><p>3. 删除系统卷影，破坏Windows系统的系统恢复功能。</p><p>4. 结束系统中运行的一些挖矿程序，由这点也可以看出：<strong>勒索病毒和挖矿攻击的目标经常是重叠的</strong>。</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/371ad575b55b44229e1db4afbdfa29f8><p class=pgc-img-caption>图1. 前期准备</p></div><p><strong>密钥处理</strong></p><p>该勒索病毒采用的微软提供的Crypto系列函数，随机生成一对当前客户端使用的RSA密钥对，在获取到该密钥对后，立即销毁了内存中密钥对。</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/518f247974454ad2a86bbf6e9f8e9f05><p class=pgc-img-caption>图2. RSA密钥对</p></div><p>在获取到RSA密钥对后，又对私钥进行了一些处理，之后使用样本内嵌的作者的RSA公钥对这个处理后的密钥进行了加密，最后连同生成的RSA公钥一并写入到%appdata%/_uninstalling_.png文件中。</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0b0b8e74825b483784cb741571eca553><p class=pgc-img-caption>图3. 密钥处理</p></div><p><strong>文件加密</strong></p><p>在处理好密钥数据后，该勒索病毒创建了两个线程来加密文件：其中一个线程用来遍历网络资源文件，而另一个线程用来遍历本地文件。</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1831e747f528491ba30b82971ba32d31><p class=pgc-img-caption>图4. 加密文件线程</p></div><p>常见的勒索病毒，通常会指定一个文件类型的范围，只对范围内的文件进行加密。而该勒索病毒则没有做这个判断——它会将所有类型的普通文件都进行加密。排除列表只包括5个目录和病毒自己产生的一些文件，同时还排除了一些被占用的和系统属性的文件：</p><p>· // Windows</p><p>· // Program Files</p><p>· // Program Files(x86)</p><p>· // $Recycle.bin</p><p>· // System Volume Information</p><p>· .NOSTRO</p><p>· #RECOVERY_FILES#.txt</p><p>· _uninstalling_.png</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b9f43be683f64c86b8d58d079654b855><p class=pgc-img-caption>图5. 排除在外的目录和文件</p></div><p>该勒索病毒制造者在加密文件这块做的也非常用心，每次加密一个文件之前，都会使用CryptGenRandom接口生成一个随机数做为密钥，这样就保证了一个文件一个密钥。同时在加密文件后该勒索病毒会立即销毁内存中的密钥信息，避免用户在中毒后通过从内存中dump出密钥信息来解密文件。</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9bcb833dd2f44ce5a6d0abc50881d3ca><p class=pgc-img-caption>图6. 获取随机数</p></div><p>此外，在这一阶段，勒索病毒还会检查被加密文件的扩展名，如果扩展名在指定的列表范围内，则会对其进行全文加密，否则在后续的加密过程中只会进行一轮的加密循环——即只加密文件的头部1024字节内容。该逻辑我们认为是作者希望在保证勒索病毒破坏力的前提下，尽可能的对加密速度进行优化，这一点在文件加密算法的选择上也得到了印证。</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ed3cc06f4de545699e3fb0fba1c0ebf9><p class=pgc-img-caption>图7. 判断文件是否需要被全文加密</p></div><p>而当前，该勒索病毒所定义的"需要被全文加密"的文件扩展名，则仅有".txt"一个。即，只有.txt文件需要被全文加密，其他扩展名的文件则均只加密前1024个字节的内容：</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5859335d173141149ce3f0fb1fde54e1><p class=pgc-img-caption>图8. 需要被全文加密的文件扩展名列表</p></div><p>该勒索病毒在加密文件时，是用CryptGenRandom函数产生的随机数作为salsa20加密算法的密钥来加密文件。并在加密完文件后，将0xD3ADBE3F标记和被用RSA加密后的文件加密密钥添加到被加密文件的末尾。</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/66a4e32bd981448da1719056ce7e21f9><p class=pgc-img-caption>图9. 加密文件</p></div><p>以下是被加密文件末尾的格式。有4个字节是写入的标记0xD3ADBE3F，最末尾的48个字节是写入的被RSA加密的当前文件的加密密钥。</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e0137f905a4340e6bb573ccd6f06789d><p class=pgc-img-caption>图10. 被加密文件格式</p></div><p><strong>收尾</strong></p><p>在完成一个文件夹的加密之后，会在这个文件夹下创建#RECOVERY_FILES#.txt文件，留下勒索信息，要求用户联系对方。</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f33118377a8c494f9ca83a59b5e86a58><p class=pgc-img-caption>图11. 勒索信息</p></div><p>总结：</p><p>针对服务器的勒索病毒攻击依然是当下勒索病毒的一个主要方向，企业需要加强自身的信息安全管理能力——尤其是弱口令、漏洞、文件共享和远程桌面的管理，以应对勒索病毒的威胁，在此我们给各位管理员一些建议：</p><p>1. 多台机器，不要使用相同的账号和口令</p><p>2. 登录口令要有足够的长度和复杂性，并定期更换登录口令</p><p>3. 重要资料的共享文件夹应设置访问权限控制，并进行定期备份</p><p>4. 定期检测系统和软件中的安全漏洞，及时打上补丁。</p><p>5. 定期到服务器检查是否存在异常。查看范围包括：</p><p>a) 是否有新增账户</p><p>b) Guest是否被启用</p><p>c) Windows系统日志是否存在异常</p><p>d) 杀毒软件是否存在异常拦截情况</p><div class=pgc-img><img alt=GarrantyDecrypt勒索病毒最新变种“无差别攻击”全部文件 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c073ba891af84762b519be174c55b0af><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'GarrantyDecrypt','变种','无差别'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>