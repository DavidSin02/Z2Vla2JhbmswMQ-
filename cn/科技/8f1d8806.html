<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Android Viewç»˜åˆ¶åŸç†ï¼šç»˜åˆ¶æµç¨‹è°ƒåº¦ã€æµ‹ç®—ç­‰ | æå®¢å¿«è¨Š</title><meta property="og:title" content="Android Viewç»˜åˆ¶åŸç†ï¼šç»˜åˆ¶æµç¨‹è°ƒåº¦ã€æµ‹ç®—ç­‰ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8f1d8806.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8f1d8806.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8f1d8806.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8f1d8806.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8f1d8806.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8f1d8806.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8f1d8806.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8f1d8806.html><meta property="article:published_time" content="2020-10-29T21:08:52+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:52+08:00"><meta name=Keywords content><meta name=description content="Android Viewç»˜åˆ¶åŸç†ï¼šç»˜åˆ¶æµç¨‹è°ƒåº¦ã€æµ‹ç®—ç­‰"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/8f1d8806.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Android Viewç»˜åˆ¶åŸç†ï¼šç»˜åˆ¶æµç¨‹è°ƒåº¦ã€æµ‹ç®—ç­‰</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p>æœ¬æ–‡ä¸»è¦å…³æ³¨Viewçš„æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶ä¸‰ä¸ªæ­¥éª¤ï¼Œè®¨è®ºè¿™ä¸‰ä¸ªæ­¥éª¤çš„æ‰§è¡Œæµç¨‹ã€‚æœ¬æ–‡æš‚ä¸æ¶‰åŠViewå’ŒWindowä¹‹é—´çš„äº¤äº’ä»¥åŠWindowçš„ç®¡ç†ã€‚å†è®ºè¿°å®Œè¿™ä¸‰ä¸ªæ­¥éª¤ä¹‹åï¼Œæ–‡æœ«ä»¥è‡ªå®šä¹‰TagGroupä¸ºä¾‹ï¼Œè®²è¿°å¦‚ä½•è‡ªå®šä¹‰ViewGroupã€‚</p><p>View æ ‘çš„ç»˜å›¾æµç¨‹</p><p>Viewæ ‘çš„ç»˜å›¾æµç¨‹æ˜¯ç”±æ ¸å¿ƒç±»ï¼šViewRootImpl æ¥å¤„ç†çš„ï¼ŒViewRootImplä½œä¸ºæ•´ä¸ªæ§ä»¶æ ‘çš„æ ¹éƒ¨ï¼Œå®ƒæ˜¯æ§ä»¶æ ‘æ­£å¸¸è¿ä½œçš„åŠ¨åŠ›æ‰€åœ¨ï¼Œæ§ä»¶çš„æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶ä»¥åŠè¾“å…¥äº‹ä»¶çš„æ´¾å‘å¤„ç†éƒ½ç”±ViewRootImplè§¦å‘ã€‚</p><p>æ ¸å¿ƒæˆå‘˜å˜é‡</p><p>è¿™é‡Œæˆ‘ä¸»è¦è®²å‡ ä¸ªHandler</p><p>ViewRootHandler</p><p>è¿™æ˜¯ViewRootImplè°ƒåº¦çš„æ ¸å¿ƒï¼Œå…¶å¤„ç†çš„æ¶ˆæ¯äº‹ä»¶ä¸»è¦æœ‰ï¼š MSG_INVALIDATEã€MSG_INVALIDATE_RECTã€MSG_RESIZEDã€MSG_DISPATCH_INPUT_EVENTã€MSG_CHECK_FOCUSã€MSG_DISPATCH_DRAG_EVENTã€MSG_CLOSE_SYSTEM_DIALOGSã€MSG_UPDATE_CONFIGURATIONç­‰</p><p>ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç±»ï¼šViewç»˜åˆ¶ç›¸å…³ã€è¾“å…¥ç„¦ç‚¹ç­‰ç”¨æˆ·äº¤äº’ç›¸å…³ã€ç³»ç»Ÿé€šçŸ¥ç›¸å…³ã€‚</p><p>æœ‰ç»éªŒçš„åŒå­¦è‚¯å®šé‡åˆ°è¿‡è¿™æ ·çš„åœºæ™¯ï¼šåŠ¨æ€åˆ›å»ºä¸€ä¸ªViewä¹‹åï¼Œæƒ³è¦ç›´æ¥è·å–measureWidth å’Œ measureHeightå¾€å¾€å–ä¸åˆ°ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¼šé€šè¿‡view.postDelayed()æ–¹æ³•å»è·å–ã€‚é‚£ä¹ˆï¼Œé—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆè¿™æ ·å°±èƒ½å–åˆ°å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆå°±åœ¨ViewRootImplä¸­çš„ViewRootHandlerï¼Œview.post--> attachInfo.mHandler.post --> ViewRootImpl ViewRootHandler. è¿™ä¸ªHandlerä¿è¯äº†å½“ä½ postçš„runableè¢«æ‰§è¡Œåˆ°æ—¶ï¼Œviewæ—©å°±æµ‹é‡å¥½äº†ã€‚</p><pre>public boolean post(Runnable action) { final AttachInfo attachInfo = mAttachInfo; if (attachInfo != null) { return attachInfo.mHandler.post(action); }  // Postpone the runnable until we know on which thread it needs to run. // Assume that the runnable will be successfully placed after attach. getRunQueue().post(action); return true;}å¤åˆ¶ä»£ç </pre><p>Choreographer.FrameHandler</p><p>Choreographerè¿™ä¸ªç±»æ¥æ§åˆ¶åŒæ­¥å¤„ç†è¾“å…¥(Input)ã€åŠ¨ç”»(Animation)ã€ç»˜åˆ¶(Draw)ä¸‰ä¸ªUIæ“ä½œï¼Œè¿™é‡Œä¸å¾—ä¸æä¸€ä¸‹Choreographer.FrameHandlerç›®çš„å°±åœ¨äºViewRootImplä¸­æ¶‰åŠåˆ°åˆ°çš„Viewç»˜åˆ¶æµç¨‹ï¼Œæ˜¯é€šè¿‡Choreographer.FrameHandleræ¥è¿›è¡Œè°ƒåº¦çš„ã€‚å…·ä½“çš„è°ƒåº¦è¿‡ç¨‹å¦‚ä¸‹</p><p>ä¸€ ã€‚ViewRootImpl.scheduleTraversals</p><p>è¿™ä¸ªæ–¹æ³•ä¼šå¾€Choreographeræ³¨å†Œç±»å‹ä¸ºChoreographer.CALLBACK_TRAVERSALçš„Callbackã€‚</p><pre>// ViewRootImpl.scheduleTraversals æ³¨å†ŒcallbackmChoreographer.postCallback( Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);å¤åˆ¶ä»£ç  äºŒã€ Choreographer.FrameHandler</pre><p>Choreographer.FrameHandleræºç å¦‚ä¸‹ï¼Œä¸»è¦å¤„ç†ä¸‰ä¸ªä¿¡å·ï¼š MSG_DO_FRAMEï¼šå¼€å§‹æ¸²æŸ“ä¸‹ä¸€å¸§çš„æ“ä½œ MSG_DO_SCHEDULE_VSYNCï¼šè¯·æ±‚Vsyncä¿¡å· MSG_DO_SCHEDULE_CALLBACKï¼šè¯·æ±‚æ‰§è¡Œcallback</p><p>å¯¹äºè¿™ä¸‰ä¸ªä¿¡å·ï¼ŒChoreographeræ˜¯æœ‰ä¸€ä¸ªè°ƒåº¦è¿‡ç¨‹çš„ï¼Œæœ€ç»ˆcallbackçš„å›è°ƒæ‰§è¡Œéƒ½æ˜¯è½å®åˆ°doFrame()æ–¹æ³•ä¸Šé¢çš„ã€‚</p><pre>private final class FrameHandler extends Handler { public FrameHandler(Looper looper) { super(looper); }  @Override public void handleMessage(Message msg) { switch (msg.what) { case MSG_DO_FRAME: doFrame(System.nanoTime(), 0); break; case MSG_DO_SCHEDULE_VSYNC: doScheduleVsync(); break; case MSG_DO_SCHEDULE_CALLBACK: doScheduleCallback(msg.arg1); break; } }}å¤åˆ¶ä»£ç </pre><p>doFrameæ‰§è¡Œå›è°ƒæœ‰ä¸€ä¸ªé¡ºåºçš„ï¼Œé¡ºåºä¾æ¬¡å¦‚ä¸‹ï¼š Choreographer.CALLBACK_INPUT Choreographer.CALLBACK_ANIMATION Choreographer.CALLBACK_TRAVERSAL Choreographer.CALLBACK_COMMIT</p><pre>Trace.traceBegin(Trace.TRACE_TAG_VIEW, "Choreographer#doFrame"); mFrameInfo.markInputHandlingStart(); doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos); mFrameInfo.markAnimationsStart(); doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos); mFrameInfo.markPerformTraversalsStart(); doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos); doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos);å¤åˆ¶ä»£ç </pre><p>å…³äºChoreographerï¼Œè¯»è€…å¯ä»¥å‚è€ƒä¸‹è¿™ç¯‡æ–‡ç« ï¼Œè®²çš„éå¸¸è¯¦ç»†ï¼šAndroid Choreographer æºç åˆ†æ</p><p>å¦‚ä½•åŠ¨æ€å»æ£€æµ‹APPå¡é¡¿</p><p>è¿™é‡Œç®€å•è¯´ä¸€ä¸ªå°çªé—¨ï¼Œé€šè¿‡Choreographer.getInstance().postFrameCallback() æ³¨å†Œå›è°ƒï¼Œå¹¶è®¡ç®—å‰åä¸¤å¸§çš„æ—¶é—´å·®ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹ç®—å‡ºAPPçš„æ‰å¸§æ•°ï¼Œä»è€ŒåŠ¨æ€æ£€æµ‹APP å¡é¡¿ã€‚</p><pre>Choreographer.getInstance().postFrameCallback(new Choreographer.FrameCallback() {  long lastFrameTimeNanos = 0; long currentFrameTimeNanos = 0;  @Override public void doFrame(long frameTimeNanos) { if (lastFrameTimeNanos == 0) { lastFrameTimeNanos = frameTimeNanos; } currentFrameTimeNanos = frameTimeNanos; long diffMs = TimeUnit.MILLISECONDS.convert(currentFrameTimeNanos - lastFrameTimeNanos, TimeUnit.NANOSECONDS); long droppedCount = 0; if (diffMs &gt; 100) { droppedCount = (int) (diffMs / 16.6); String anrLog = collectAnrLog(applicationContext); DjLog.e("Block occur, droppedCount: " + droppedCount + ", anrLog: " + anrLog); } lastFrameTimeNanos = frameTimeNanos; Choreographer.getInstance().postFrameCallback(this); } });å¤åˆ¶ä»£ç </pre><p>Viewæ ‘æµç¨‹æ§åˆ¶ï¼šperformTraversals</p><p>æ•´ä¸ª View æ ‘çš„ç»˜å›¾æµç¨‹åœ¨ViewRoot.javaç±»çš„performTraversals()å‡½æ•°å±•å¼€ï¼Œè¯¥å‡½æ•°æ‰€åš çš„å·¥ä½œå¯ç®€å•æ¦‚å†µä¸ºæ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—è§†å›¾å¤§å°(measure)ã€æ˜¯å¦éœ€è¦é‡æ–°å®‰ç½®è§†å›¾çš„ä½ç½®(layout)ã€ä»¥åŠæ˜¯å¦éœ€è¦é‡ç»˜(draw)ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p>æ›´è¯¦ç»†çš„å›¾ç¤ºå¦‚ä¸‹ï¼š</p><p>performTraversals æ–¹æ³•éå¸¸åºå¤§ï¼Œæ•´ä¸ªæºç åœ¨800è¡Œå·¦å³ï¼Œçœ‹èµ·æ¥ä¼šè®©äººåè¡€ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦çš„è¿‡ç¨‹æœ‰å››ä¸ªï¼š</p><p><strong>é¢„æµ‹é‡é˜¶æ®µ</strong> è¿™æ˜¯è¿›å…¥performTraversals()æ–¹æ³•åçš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œå®ƒä¼šå¯¹æ§ä»¶æ ‘è¿›è¡Œç¬¬ä¸€æ¬¡æµ‹é‡ã€‚æµ‹é‡ç»“æœå¯ä»¥é€šè¿‡mView. getMeasuredWidth()/Height()è·å¾—ã€‚åœ¨æ­¤é˜¶æ®µä¸­å°†ä¼šè®¡ç®—å‡ºæ§ä»¶æ ‘ä¸ºæ˜¾ç¤ºå…¶å†…å®¹æ‰€éœ€çš„å°ºå¯¸ï¼Œå³æœŸæœ›çš„çª—å£å°ºå¯¸ã€‚åœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼ŒViewåŠå…¶å­ç±»çš„onMeasure()æ–¹æ³•å°†ä¼šæ²¿ç€æ§ä»¶æ ‘ä¾æ¬¡å¾—åˆ°å›è°ƒã€‚</p><p><strong>å¸ƒå±€çª—å£é˜¶æ®µ</strong> æ ¹æ®é¢„æµ‹é‡çš„ç»“æœï¼Œé€šè¿‡IWindowSession.relayout()æ–¹æ³•å‘WMSè¯·æ±‚è°ƒæ•´çª—å£çš„å°ºå¯¸ç­‰å±æ€§ï¼Œè¿™å°†å¼•å‘WMSå¯¹çª—å£è¿›è¡Œé‡æ–°å¸ƒå±€ï¼Œå¹¶å°†å¸ƒå±€ç»“æœè¿”å›ç»™ViewRootImplã€‚</p><p><strong>æœ€ç»ˆæµ‹é‡é˜¶æ®µ</strong> é¢„æµ‹é‡çš„ç»“æœæ˜¯æ§ä»¶æ ‘æ‰€æœŸæœ›çš„çª—å£å°ºå¯¸ã€‚ç„¶è€Œç”±äºåœ¨WMSä¸­å½±å“çª—å£å¸ƒå±€çš„å› ç´ å¾ˆå¤š(å‚è€ƒç¬¬4ç« )ï¼ŒWMSä¸ä¸€å®šä¼šå°†çª—å£å‡†ç¡®åœ°å¸ƒå±€ä¸ºæ§ä»¶æ ‘æ‰€è¦æ±‚çš„å°ºå¯¸ï¼Œè€Œè¿«äºWMSä½œä¸ºç³»ç»ŸæœåŠ¡çš„å¼ºåŠ¿åœ°ä½ï¼Œæ§ä»¶æ ‘ä¸å¾—ä¸æ¥å—WMSçš„å¸ƒå±€ç»“æœã€‚å› æ­¤åœ¨è¿™ä¸€é˜¶æ®µï¼ŒperformTraversals()å°†ä»¥çª—å£çš„å®é™…å°ºå¯¸å¯¹æ§ä»¶è¿›è¡Œæœ€ç»ˆæµ‹é‡ã€‚åœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼ŒViewåŠå…¶å­ç±»çš„onMeasure()æ–¹æ³•å°†ä¼šæ²¿ç€æ§ä»¶æ ‘ä¾æ¬¡è¢«å›è°ƒã€‚</p><p><strong>å¸ƒå±€æ§ä»¶æ ‘é˜¶æ®µ</strong> å®Œæˆæœ€ç»ˆæµ‹é‡ä¹‹åä¾¿å¯ä»¥å¯¹æ§ä»¶æ ‘è¿›è¡Œå¸ƒå±€äº†ã€‚æµ‹é‡ç¡®å®šçš„æ˜¯æ§ä»¶çš„å°ºå¯¸ï¼Œè€Œå¸ƒå±€åˆ™æ˜¯ç¡®å®šæ§ä»¶çš„ä½ç½®ã€‚åœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼ŒViewåŠå…¶å­ç±»çš„onLayout()æ–¹æ³•å°†ä¼šè¢«å›è°ƒã€‚</p><p><strong>ç»˜åˆ¶é˜¶æ®µ</strong> è¿™æ˜¯performTraversals()çš„æœ€ç»ˆé˜¶æ®µã€‚ç¡®å®šäº†æ§ä»¶çš„ä½ç½®ä¸å°ºå¯¸åï¼Œä¾¿å¯ä»¥å¯¹æ§ä»¶æ ‘è¿›è¡Œç»˜åˆ¶äº†ã€‚åœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼ŒViewåŠå…¶å­ç±»çš„onDraw()æ–¹æ³•å°†ä¼šè¢«å›è°ƒã€‚</p><p>é‚£é—®é¢˜æ¥äº†ï¼Œè¿™ä¸ªæ–¹æ³•ä»€ä¹ˆæ—¶å€™ä¼šè¢«è§¦å‘ï¼Œæˆ–è€…è¯´Androidç³»ç»Ÿä»€ä¹ˆæ—¶å€™ä¼šå¯¹æ•´ä¸ªViewæ ‘è¿›è¡Œä¸€æ¬¡å…¨é‡çš„æ“ä½œå‘¢ï¼Ÿä»æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒçš„æ–¹æ³•ä¼šè§¦å‘ï¼š</p><p>ä¸€ã€requestLayout: æ³¨æ„åœ¨Viewä¸­ä¹Ÿæœ‰åŒæ ·çš„ä¸€ä¸ªrequestLayoutæ–¹æ³•ï¼Œviewä¸­çš„requestLayoutæ–¹æ³•è°ƒç”¨çš„å°±æ˜¯ViewRootImplä¸­çš„requestLayoutï¼Œæœ€ç»ˆè§¦å‘Viewæ ‘çš„ç»˜åˆ¶æµç¨‹ï¼Œå³ measure-layout-drawï¼›</p><p>äºŒã€invalidateï¼šåŒæ ·çš„Viewä¸­ä¹Ÿæœ‰ä¸€ä¸ªinvalidateæ–¹æ³•ï¼ŒViewä¸­è¯¥æ–¹æ³•çš„è°ƒç”¨æœ€ç»ˆè°ƒç”¨çš„ä¹Ÿæ˜¯ViewRootImplä¸­çš„æ–¹æ³•ã€‚æœ‰ç»éªŒçš„åŒå­¦è‚¯å®šçŸ¥é“ï¼Œinvalidateåªä¼šè§¦å‘drawï¼Œä¸ä¼šè§¦å‘measureå’Œ layoutã€‚å…·ä½“çš„ViewRootImplä¼šé€šè¿‡å˜é‡mLayoutRequestedæ§åˆ¶æ˜¯å¦è¦è¿›è¡Œmeasureå’Œlayoutï¼Œinvalidateæ“ä½œæ—¶è¿™ä¸ªå˜é‡ä¸ºfalse</p><p>åŠ è£™ æŸ’é›¶182ç•™ä¹…60ä¸å®šæ—¶å‘èµ„æ–™å¯ä»¥è£™é‡Œä¸€èµ·äº¤æµå­¦ä¹ </p><pre>@Overridepublic void requestLayout() { if (!mHandlingLayoutInLayoutRequest) { checkThread(); mLayoutRequested = true; scheduleTraversals(); }} void invalidate() {  ...  if (!mWillDrawSoon) { scheduleTraversals(); }}å¤åˆ¶ä»£ç </pre><p>View ç»˜åˆ¶æµç¨‹å‡½æ•°è°ƒç”¨é“¾</p><p>æœ‰å‡ ç‚¹æ³¨æ„ï¼š â€¢ invalidate/postInvalidate åªä¼šè§¦å‘ drawï¼› â€¢ requestLayoutï¼Œä¼šè§¦å‘ measureã€layout å’Œ draw çš„è¿‡ç¨‹ï¼› â€¢ å®ƒä»¬éƒ½æ˜¯èµ°çš„ scheduleTraversals -> performTraversalsï¼Œç”¨ä¸åŒçš„æ ‡è®°ä½æ¥è¿›è¡ŒåŒºåˆ†ï¼› â€¢ resume ä¼šè§¦å‘ invalidateï¼› â€¢ dispatchDraw æ˜¯ç”¨æ¥ç»˜åˆ¶ child çš„ï¼Œå‘ç”Ÿåœ¨è‡ªå·±çš„ onDraw ä¹‹åï¼Œchild çš„ draw ä¹‹å‰ Measure å’Œ Layout çš„å…·ä½“è¿‡ç¨‹</p><p>Measure å’Œ Layout çš„å…·ä½“è¿‡ç¨‹</p><p>å…³äºMeasureè¿‡ç¨‹ï¼Œä¸å¾—ä¸è¯¦ç»†æä¸€ä¸‹MeasureSpecã€‚MeasureSpecæ˜¯ä¸€ä¸ªå¤åˆæ•´å‹å˜é‡ï¼ˆ32bitï¼‰ï¼Œç”¨äºæŒ‡å¯¼æ§ä»¶å¯¹è‡ªèº«è¿›è¡Œæµ‹é‡ï¼Œå®ƒæœ‰ä¸¤ä¸ªåˆ†é‡ï¼šå‰ä¸¤ä½è¡¨ç¤ºSPEC_MODEï¼Œå30ä½è¡¨ç¤ºSPEC_SIZEã€‚SPEC_MODEçš„å–å€¼å–å†³äºæ­¤æ§ä»¶çš„LayoutParams.width/heightçš„è®¾ç½®ï¼ŒSPEC_SIZEåˆ™æ˜¯çˆ¶è§†å›¾ç»™å®šçš„æŒ‡å¯¼å¤§å°ã€‚</p><p>SPEC_MODEæœ‰ä¸‰ç§æ¨¡å¼ï¼Œå…·ä½“çš„è®¡ç®—å¦‚ä¸‹ï¼š</p><p>MeasureSpec.UNSPECIFIEDï¼š è¡¨ç¤ºæ§ä»¶åœ¨è¿›è¡Œæµ‹é‡æ—¶ï¼Œå¯ä»¥æ— è§†SPEC_SIZEçš„å€¼ã€‚æ§ä»¶å¯ä»¥æ˜¯å®ƒæ‰€æœŸæœ›çš„ä»»æ„å°ºå¯¸ã€‚</p><p>MeasureSpec.EXACTLY: è¡¨ç¤ºå­æ§ä»¶å¿…é¡»ä¸ºSPEC_SIZEæ‰€åˆ¶å®šçš„å°ºå¯¸ã€‚å½“æ§ä»¶çš„LayoutParams.width/heightä¸ºä¸€ç¡®å®šå€¼ï¼Œæˆ–è€…æ˜¯MATCH_PARENTæ—¶ï¼Œå¯¹åº”çš„MeasureSpecå‚æ•°ä¼šä½¿ç”¨è¿™ä¸ªSPEC_MODEã€‚</p><p>MeasureSpec.AT_MOST: è¡¨ç¤ºå­æ§ä»¶å¯ä»¥æ˜¯å®ƒæ‰€æœŸæœ›çš„å°ºå¯¸ï¼Œä½†æ˜¯ä¸å¾—å¤§äºSPEC_SIZEã€‚å½“æ§ä»¶çš„LayoutParams.width/heightä¸ºWRAP_CONTENTæ—¶ï¼Œå¯¹åº”çš„MeasureSpecå‚æ•°ä¼šä½¿ç”¨è¿™ä¸ªSPEC_MODEã€‚</p><p>è‡ªå®šä¹‰ä¸€ä¸ªTagGroup</p><p>è®²äº†è¿™ä¹ˆå¤šï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®æ“ä¸€ä¸‹ã€‚</p><p>éœ€æ±‚ï¼šè‡ªå®šä¹‰ä¸€ä¸ªTagGroupï¼Œç”¨æ¥æ˜¾ç¤ºä¸€ç³»åˆ—æ ‡ç­¾å…ƒç´ ã€‚è¦æ±‚æ ‡ç­¾æ ·å¼å®Œå…¨å¯ä»¥è‡ªå®šä¹‰ï¼Œæ ‡ç­¾é—´è·å¯åœ¨xmlä¸­æŒ‡å®šï¼Œè¦æœ‰æœ€å¤šæ˜¾ç¤ºå¤šå°‘è¡Œçš„æ§åˆ¶ï¼Œæ˜¾ç¤ºä¸å…¨æ—¶è¦å±•ç¤ºâ€œæ›´å¤š ...â€</p><p>æ ·å¼åå®š</p><p>åœ¨attrs.xmlä¸­åå®šæ ·å¼ï¼š</p><pre>&lt;declare-styleable name="DjTagGroup"&gt; &lt;attr name="tag_horizontalSpacing" format="dimension" /&gt; &lt;attr name="tag_verticalSpacing" format="dimension" /&gt; &lt;attr name="max_row" format="integer"/&gt;&lt;/declare-styleable&gt;å¤åˆ¶ä»£ç </pre><p>åå®šæ¥å£ï¼Œç”¨æ¥æä¾›å…·ä½“çš„æ ‡ç­¾å…ƒç´ ï¼š</p><pre>public interface TagViewHolder { View getView();}å¤åˆ¶ä»£ç </pre><p>è‡ªå®šä¹‰Measureè¿‡ç¨‹</p><pre>@Overrideprotected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { final int widthMode = MeasureSpec.getMode(widthMeasureSpec); final int heightMode = MeasureSpec.getMode(heightMeasureSpec); final int widthSize = MeasureSpec.getSize(widthMeasureSpec); final int heightSize = MeasureSpec.getSize(heightMeasureSpec);  measureChildren(widthMeasureSpec, heightMeasureSpec);  int width = 0; int height = 0;  int row = 0; // The row counter. int rowWidth = 0; // Calc the current row width. int rowMaxHeight = 0; // Calc the max tag height, in current row.  if (moreTagHolder != null) { moreTagMeasureWidth = moreTagHolder.getView().getMeasuredWidth(); moreTagMeasureHeight = moreTagHolder.getView().getMeasuredHeight(); }  final int count = getChildCount(); for (int i = 0; i &lt; count; i++) { final View child = getChildAt(i); final int childWidth = child.getMeasuredWidth(); final int childHeight = child.getMeasuredHeight();  if (child.getVisibility() != GONE) { // judge the max_row if (row + 1 &gt;= maxRow &amp;&amp; rowWidth + childWidth &gt; widthSize) { break; } rowWidth += childWidth; if (rowWidth &gt; widthSize) { // Next line. rowWidth = childWidth; // The next row width. height += rowMaxHeight + verticalSpacing; rowMaxHeight = childHeight; // The next row max height. row++; } else { // This line. rowMaxHeight = Math.max(rowMaxHeight, childHeight); } rowWidth += horizontalSpacing; } }  // Account for the last row height. height += rowMaxHeight;  // Account for the padding too. height += getPaddingTop() + getPaddingBottom();  // If the tags grouped in one row, set the width to wrap the tags. if (row == 0) { width = rowWidth; width += getPaddingLeft() + getPaddingRight(); } else {// If the tags grouped exceed one line, set the width to match the parent. width = widthSize; }  setMeasuredDimension(widthMode == MeasureSpec.EXACTLY ? widthSize : width, heightMode == MeasureSpec.EXACTLY ? heightSize : height);}å¤åˆ¶ä»£ç </pre><p>è‡ªå®šä¹‰layoutè¿‡ç¨‹</p><pre>@Overrideprotected void onLayout(boolean changed, int l, int t, int r, int b) { final int parentLeft = getPaddingLeft(); final int parentRight = r - l - getPaddingRight(); final int parentTop = getPaddingTop(); final int parentBottom = b - t - getPaddingBottom();  int childLeft = parentLeft; int childTop = parentTop;  int row = 0; int rowMaxHeight = 0;  boolean showMoreTag = false;  final int count = getChildCount(); int unTagCount = count; if (moreTagHolder != null) { unTagCount--; } for (int i = 0; i &lt; unTagCount; i++) { final View child = getChildAt(i); final int width = child.getMeasuredWidth(); final int height = child.getMeasuredHeight();  if (child.getVisibility() != GONE) { if (row + 1 &gt;= maxRow &amp;&amp; childLeft + width + (horizontalSpacing + moreTagMeasureWidth) &gt; parentRight) { // é¢„ç•™ä¸€ä¸ªç©ºä½æ”¾ç½®moreTag showMoreTag = true; break; } if (childLeft + width &gt; parentRight) { // Next line childLeft = parentLeft; childTop += rowMaxHeight + verticalSpacing; rowMaxHeight = height; row++; } else { rowMaxHeight = Math.max(rowMaxHeight, height); }  // this is point child.layout(childLeft, childTop, childLeft + width, childTop + height);  childLeft += width + horizontalSpacing; } }  if (showMoreTag) { final View child = getChildAt(count - 1); final int width = child.getMeasuredWidth(); final int height = child.getMeasuredHeight(); child.layout(childLeft, childTop, childLeft + width, childTop + height); }}å¤åˆ¶ä»£ç </pre><p>ä½¿ç”¨</p><p>åœ¨xmlä¸­ç›´æ¥å¼•ç”¨</p><pre>&lt;com.xud.tag.DjTagGroup android:id="@+id/dj_tag_group" android:layout_width="match_parent" android:layout_height="wrap_content" android:padding="16dp" app:tag_horizontalSpacing="8dp" app:tag_verticalSpacing="8dp" app:max_row="4"/&gt;å¤åˆ¶ä»£ç </pre><p>å®šä¹‰è‡ªå·±çš„TagViewHolder</p><pre>public class DjTagViewHolder implements DjTagGroup.TagViewHolder {  public String content;  public View rootView;  public TextView tagView;  public DjTagViewHolder(View itemView, String content) { this.rootView = itemView; tagView = itemView.findViewById(R.id.tag); tagView.setText(content);  tagView.setOnClickListener(v -&gt; Toast.makeText(context, "ç‚¹å‡»äº†ï¼š" + content, Toast.LENGTH_SHORT).show()); }  @Override public View getView() { return rootView; }}å¤åˆ¶ä»£ç </pre><p>å¾€DjTagGroupç›´æ¥è®¾ç½®tags</p><pre>private void initDjTags() { String[] tags = TagGenarator.generate(10, 6); List&lt;DjTagGroup.TagViewHolder&gt; viewHolders = new ArrayList&lt;&gt;(); for (String tag: tags) { DjTagViewHolder viewHolder = new DjTagViewHolder(LayoutInflater.from(context).inflate(R.layout.view_tag, djTagGroup, false), tag); viewHolders.add(viewHolder); } DjTagViewHolder moreHolder = new DjTagViewHolder(LayoutInflater.from(context).inflate(R.layout.view_tag, djTagGroup, false), "æ›´å¤š ..."); djTagGroup.setTags(viewHolders, moreHolder);}å¤åˆ¶ä»£ç </pre><p>å®é™…çš„æ•ˆæœ</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Android','View','è°ƒåº¦'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>