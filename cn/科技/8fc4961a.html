<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Linuxä¸­æ–­å¤„ç† | æå®¢å¿«è¨Š</title><meta property="og:title" content="Linuxä¸­æ–­å¤„ç† - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/59a9811eea6b458e9c75fc84249c8beb"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8fc4961a.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8fc4961a.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8fc4961a.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8fc4961a.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8fc4961a.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8fc4961a.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8fc4961a.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8fc4961a.html><meta property="article:published_time" content="2020-10-29T21:09:37+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:37+08:00"><meta name=Keywords content><meta name=description content="Linuxä¸­æ–­å¤„ç†"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/8fc4961a.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Linuxä¸­æ–­å¤„ç†</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1>ä¸­æ–­å¤„ç† - ä¸ŠåŠéƒ¨ï¼ˆç¡¬ä¸­æ–­ï¼‰</h1><p>ç”±äº APICä¸­æ–­æ§åˆ¶å™¨ æœ‰ç‚¹å°å¤æ‚ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸»è¦é€šè¿‡ 8259Aä¸­æ–­æ§åˆ¶å™¨ æ¥ä»‹ç»Linuxå¯¹ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹ã€‚</p><h1>ä¸­æ–­å¤„ç†ç›¸å…³ç»“æ„</h1><p>å‰é¢è¯´è¿‡ï¼Œ8259Aä¸­æ–­æ§åˆ¶å™¨ ç”±ä¸¤ç‰‡ 8259A é£æ ¼çš„å¤–éƒ¨èŠ¯ç‰‡ä»¥ çº§è” çš„æ–¹å¼è¿æ¥åœ¨ä¸€èµ·ï¼Œæ¯ä¸ªèŠ¯ç‰‡å¯å¤„ç†å¤šè¾¾ 8 ä¸ªä¸åŒçš„ IRQï¼ˆä¸­æ–­è¯·æ±‚ï¼‰ï¼Œæ‰€ä»¥å¯ç”¨ IRQ çº¿çš„ä¸ªæ•°è¾¾åˆ° 15 ä¸ªã€‚å¦‚ä¸‹å›¾ï¼š</p><div class=pgc-img><img alt=Linuxä¸­æ–­å¤„ç† onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/59a9811eea6b458e9c75fc84249c8beb><p class=pgc-img-caption></p></div><p>åœ¨å†…æ ¸ä¸­æ¯æ¡IRQçº¿ç”±ç»“æ„ä½“ irq_desc_t æ¥æè¿°ï¼Œirq_desc_t å®šä¹‰å¦‚ä¸‹ï¼š</p><pre>typedef struct { unsigned int status; /* IRQ status */ hw_irq_controller *handler; struct irqaction *action; /* IRQ action list */ unsigned int depth; /* nested irq disables */ spinlock_t lock;} irq_desc_t;</pre><p>ä¸‹é¢ä»‹ç»ä¸€ä¸‹ irq_desc_t ç»“æ„å„ä¸ªå­—æ®µçš„ä½œç”¨ï¼š</p><ul class=list-paddingleft-2><li>status: IRQçº¿çš„çŠ¶æ€ã€‚</li><li>handler: ç±»å‹ä¸º hw_interrupt_type ç»“æ„ï¼Œè¡¨ç¤ºIRQçº¿å¯¹åº”çš„ç¡¬ä»¶ç›¸å…³å¤„ç†å‡½æ•°ï¼Œæ¯”å¦‚ 8259Aä¸­æ–­æ§åˆ¶å™¨ æ¥æ”¶åˆ°ä¸€ä¸ªä¸­æ–­ä¿¡å·æ—¶ï¼Œéœ€è¦å‘é€ä¸€ä¸ªç¡®è®¤ä¿¡å·æ‰ä¼šç»§ç»­æ¥æ”¶ä¸­æ–­ä¿¡å·çš„ï¼Œå‘é€ç¡®è®¤ä¿¡å·çš„å‡½æ•°å°±æ˜¯ hw_interrupt_type ä¸­çš„ ack å‡½æ•°ã€‚</li><li>action: ç±»å‹ä¸º irqaction ç»“æ„ï¼Œä¸­æ–­ä¿¡å·çš„å¤„ç†å…¥å£ã€‚ç”±äºä¸€æ¡IRQçº¿å¯ä»¥è¢«å¤šä¸ªç¡¬ä»¶å…±äº«ï¼Œæ‰€ä»¥ action æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ¯ä¸ª action ä»£è¡¨ä¸€ä¸ªç¡¬ä»¶çš„ä¸­æ–­å¤„ç†å…¥å£ã€‚</li><li>depth: é˜²æ­¢å¤šæ¬¡å¼€å¯å’Œå…³é—­IRQçº¿ã€‚</li><li>lock: é˜²æ­¢å¤šæ ¸CPUåŒæ—¶å¯¹IRQè¿›è¡Œæ“ä½œçš„è‡ªæ—‹é”ã€‚</li></ul><p>hw_interrupt_type è¿™ä¸ªç»“æ„ä¸ç¡¬ä»¶ç›¸å…³ï¼Œè¿™é‡Œå°±ä¸ä½œä»‹ç»äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ irqaction è¿™ä¸ªç»“æ„ï¼š</p><pre>struct irqaction { void (*handler)(int, void *, struct pt_regs *); unsigned long flags; unsigned long mask; const char *name; void *dev_id; struct irqaction *next;};</pre><p>ä¸‹é¢è¯´è¯´ irqaction ç»“æ„å„ä¸ªå­—æ®µçš„ä½œç”¨ï¼š</p><ul class=list-paddingleft-2><li>handler: ä¸­æ–­å¤„ç†çš„å…¥å£å‡½æ•°ï¼Œhandler çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸­æ–­å·ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è®¾å¤‡å¯¹åº”çš„IDï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸­æ–­å‘ç”Ÿæ—¶ç”±å†…æ ¸ä¿å­˜çš„å„ä¸ªå¯„å­˜å™¨çš„å€¼ã€‚</li><li>flags: æ ‡å¿—ä½ï¼Œç”¨äºè¡¨ç¤º irqaction çš„ä¸€äº›è¡Œä¸ºï¼Œä¾‹å¦‚æ˜¯å¦èƒ½å¤Ÿä¸å…¶ä»–ç¡¬ä»¶å…±äº«IRQçº¿ã€‚</li><li>name: ç”¨äºä¿å­˜ä¸­æ–­å¤„ç†çš„åå­—ã€‚</li><li>dev_id: è®¾å¤‡IDã€‚</li><li>next: æ¯ä¸ªç¡¬ä»¶çš„ä¸­æ–­å¤„ç†å…¥å£å¯¹åº”ä¸€ä¸ª irqaction ç»“æ„ï¼Œç”±äºå¤šä¸ªç¡¬ä»¶å¯ä»¥å…±äº«åŒä¸€æ¡IRQçº¿ï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡ next å­—æ®µæ¥è¿æ¥ä¸åŒçš„ç¡¬ä»¶ä¸­æ–­å¤„ç†å…¥å£ã€‚</li></ul><p>irq_desc_t ç»“æ„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><div class=pgc-img><img alt=Linuxä¸­æ–­å¤„ç† onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ad4d87322e46480498dcf8d18c93ca1d><p class=pgc-img-caption></p></div><h1>æ³¨å†Œä¸­æ–­å¤„ç†å…¥å£</h1><p>åœ¨å†…æ ¸ä¸­ï¼Œå¯ä»¥é€šè¿‡ setup_irq() å‡½æ•°æ¥æ³¨å†Œä¸€ä¸ªä¸­æ–­å¤„ç†å…¥å£ã€‚setup_irq() å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p><pre>int setup_irq(unsigned int irq, struct irqaction * new){ int shared = 0; unsigned long flags; struct irqaction *old, **p; irq_desc_t *desc = irq_desc + irq; ... spin_lock_irqsave(&amp;desc-&gt;lock,flags); p = &amp;desc-&gt;action; if ((old = *p) != NULL) { if (!(old-&gt;flags &amp; new-&gt;flags &amp; SA_SHIRQ)) { spin_unlock_irqrestore(&amp;desc-&gt;lock,flags); return -EBUSY; } do { p = &amp;old-&gt;next; old = *p; } while (old); shared = 1; } *p = new; if (!shared) { desc-&gt;depth = 0; desc-&gt;status &amp;= ~(IRQ_DISABLED | IRQ_AUTODETECT | IRQ_WAITING); desc-&gt;handler-&gt;startup(irq); } spin_unlock_irqrestore(&amp;desc-&gt;lock,flags); register_irq_proc(irq); // æ³¨å†Œprocæ–‡ä»¶ç³»ç»Ÿ return 0;}</pre><p>setup_irq() å‡½æ•°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é€šè¿‡ irq å·æ¥æŸ¥æ‰¾å¯¹åº”çš„ irq_desc_t ç»“æ„ï¼Œå¹¶æŠŠæ–°çš„ irqaction è¿æ¥åˆ° irq_desc_t ç»“æ„çš„ action é“¾è¡¨ä¸­ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè®¾å¤‡ä¸æ”¯æŒå…±äº«IRQçº¿ï¼ˆä¹Ÿå³æ˜¯ flags å­—æ®µæ²¡æœ‰è®¾ç½® SA_SHIRQ æ ‡å¿—ï¼‰ï¼Œé‚£ä¹ˆå°±è¿”å› EBUSY é”™è¯¯ã€‚</p><p>æˆ‘ä»¬çœ‹çœ‹ æ—¶é’Ÿä¸­æ–­å¤„ç†å…¥å£ çš„æ³¨å†Œå®ä¾‹ï¼š</p><pre>static struct irqaction irq0 = { timer_interrupt, SA_INTERRUPT, 0, "timer", NULL, NULL};void __init time_init(void){ ... setup_irq(0, &amp;irq0);}</pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæ—¶é’Ÿä¸­æ–­å¤„ç†å…¥å£çš„IRQå·ä¸º0ï¼Œå¤„ç†å‡½æ•°ä¸º timer_interrupt()ï¼Œå¹¶ä¸”ä¸æ”¯æŒå…±äº«IRQçº¿ï¼ˆflags å­—æ®µæ²¡æœ‰è®¾ç½® SA_SHIRQ æ ‡å¿—ï¼‰ã€‚</p><h1>å¤„ç†ä¸­æ–­è¯·æ±‚</h1><p>å½“ä¸€ä¸ªä¸­æ–­å‘ç”Ÿæ—¶ï¼Œä¸­æ–­æ§åˆ¶å±‚ä¼šå‘é€ä¿¡å·ç»™CPUï¼ŒCPUæ”¶åˆ°ä¿¡å·ä¼šä¸­æ–­å½“å‰çš„æ‰§è¡Œï¼Œè½¬è€Œæ‰§è¡Œä¸­æ–­å¤„ç†è¿‡ç¨‹ã€‚ä¸­æ–­å¤„ç†è¿‡ç¨‹é¦–å…ˆä¼šä¿å­˜å¯„å­˜å™¨çš„å€¼åˆ°æ ˆä¸­ï¼Œç„¶åè°ƒç”¨ do_IRQ() å‡½æ•°è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œdo_IRQ() å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p><pre>asmlinkage unsigned int do_IRQ(struct pt_regs regs){ int irq = regs.orig_eax &amp; 0xff; /* è·å–IRQå· */ int cpu = smp_processor_id(); irq_desc_t *desc = irq_desc + irq; struct irqaction * action; unsigned int status; kstat.irqs[cpu][irq]++; spin_lock(&amp;desc-&gt;lock); desc-&gt;handler-&gt;ack(irq); status = desc-&gt;status &amp; ~(IRQ_REPLAY | IRQ_WAITING); status |= IRQ_PENDING; /* we _want_ to handle it */ action = NULL; if (!(status &amp; (IRQ_DISABLED | IRQ_INPROGRESS))) { // å½“å‰IRQä¸åœ¨å¤„ç†ä¸­ action = desc-&gt;action; // è·å– action é“¾è¡¨ status &amp;= ~IRQ_PENDING; // å»é™¤IRQ_PENDINGæ ‡å¿—, è¿™ä¸ªæ ‡å¿—ç”¨äºè®°å½•æ˜¯å¦åœ¨å¤„ç†IRQè¯·æ±‚çš„æ—¶å€™åˆå‘ç”Ÿäº†ä¸­æ–­ status |= IRQ_INPROGRESS; // è®¾ç½®IRQ_INPROGRESSæ ‡å¿—, è¡¨ç¤ºæ­£åœ¨å¤„ç†IRQ } desc-&gt;status = status; if (!action) // å¦‚æœä¸Šä¸€æ¬¡IRQè¿˜æ²¡å®Œæˆ, ç›´æ¥é€€å‡º goto out; for (;;) { spin_unlock(&amp;desc-&gt;lock); handle_IRQ_event(irq, Â®s, action); // å¤„ç†IRQè¯·æ±‚ spin_lock(&amp;desc-&gt;lock);  if (!(desc-&gt;status &amp; IRQ_PENDING)) // å¦‚æœåœ¨å¤„ç†IRQè¯·æ±‚çš„æ—¶å€™åˆå‘ç”Ÿäº†ä¸­æ–­, ç»§ç»­å¤„ç†IRQè¯·æ±‚ break; desc-&gt;status &amp;= ~IRQ_PENDING; } desc-&gt;status &amp;= ~IRQ_INPROGRESS;out: desc-&gt;handler-&gt;end(irq); spin_unlock(&amp;desc-&gt;lock); if (softirq_active(cpu) &amp; softirq_mask(cpu)) do_softirq(); // ä¸­æ–­ä¸‹åŠéƒ¨å¤„ç† return 1;}</pre><p>do_IRQ() å‡½æ•°é¦–å…ˆé€šè¿‡IRQå·è·å–åˆ°å…¶å¯¹åº”çš„ irq_desc_t ç»“æ„ï¼Œæ³¨æ„çš„æ˜¯åŒä¸€ä¸ªä¸­æ–­æœ‰å¯èƒ½å‘ç”Ÿå¤šæ¬¡ï¼Œæ‰€ä»¥è¦åˆ¤æ–­å½“å‰IRQæ˜¯å¦æ­£åœ¨è¢«å¤„ç†å½“ä¸­ï¼ˆåˆ¤æ–­ irq_desc_t ç»“æ„çš„ status å­—æ®µæ˜¯å¦è®¾ç½®äº† IRQ_INPROGRESS æ ‡å¿—ï¼‰ï¼Œå¦‚æœä¸æ˜¯å¤„ç†å½“å‰ï¼Œé‚£ä¹ˆå°±è·å–åˆ° action é“¾è¡¨ï¼Œç„¶åé€šè¿‡è°ƒç”¨ handle_IRQ_event() å‡½æ•°æ¥æ‰§è¡Œ action é“¾è¡¨ä¸­çš„ä¸­æ–­å¤„ç†å‡½æ•°ã€‚</p><p>å¦‚æœåœ¨å¤„ç†ä¸­æ–­çš„è¿‡ç¨‹ä¸­åˆå‘ç”Ÿäº†ç›¸åŒçš„ä¸­æ–­ï¼ˆirq_desc_t ç»“æ„çš„ status å­—æ®µè¢«è®¾ç½®äº† IRQ_INPROGRESS æ ‡å¿—ï¼‰ï¼Œé‚£ä¹ˆå°±ç»§ç»­å¯¹ä¸­æ–­è¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œä¸­æ–­åï¼Œè°ƒç”¨ do_softirq() å‡½æ•°æ¥å¯¹ä¸­æ–­ä¸‹åŠéƒ¨è¿›è¡Œå¤„ç†ï¼ˆä¸‹é¢ä¼šè¯´ï¼‰ã€‚</p><p>æ¥ä¸‹æ¥çœ‹çœ‹ handle_IRQ_event() å‡½æ•°çš„å®ç°ï¼š</p><pre>int handle_IRQ_event(unsigned int irq, struct pt_regs * regs, struct irqaction * action){ int status; int cpu = smp_processor_id(); irq_enter(cpu, irq); status = 1; /* Force the "do bottom halves" bit */ if (!(action-&gt;flags &amp; SA_INTERRUPT)) // å¦‚æœä¸­æ–­å¤„ç†èƒ½å¤Ÿåœ¨æ‰“å¼€ä¸­æ–­çš„æƒ…å†µä¸‹æ‰§è¡Œ, é‚£ä¹ˆå°±æ‰“å¼€ä¸­æ–­ __sti(); do { status |= action-&gt;flags; action-&gt;handler(irq, action-&gt;dev_id, regs); action = action-&gt;next; } while (action); if (status &amp; SA_SAMPLE_RANDOM) add_interrupt_randomness(irq); __cli(); irq_exit(cpu, irq); return status;}</pre><p>handle_IRQ_event() å‡½æ•°éå¸¸ç®€å•ï¼Œå°±æ˜¯éå† action é“¾è¡¨å¹¶ä¸”æ‰§è¡Œå…¶ä¸­çš„å¤„ç†å‡½æ•°ï¼Œæ¯”å¦‚å¯¹äº æ—¶é’Ÿä¸­æ–­ å°±æ˜¯è°ƒç”¨ timer_interrupt() å‡½æ•°ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸­æ–­å¤„ç†è¿‡ç¨‹èƒ½å¤Ÿå¼€å¯ä¸­æ–­çš„ï¼Œé‚£ä¹ˆå°±æŠŠä¸­æ–­æ‰“å¼€ï¼ˆå› ä¸ºCPUæ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ä¼šå…³é—­ä¸­æ–­ï¼‰ã€‚</p><h1>ä¸­æ–­å¤„ç† - ä¸‹åŠéƒ¨ï¼ˆè½¯ä¸­æ–­ï¼‰</h1><p>ç”±äºä¸­æ–­å¤„ç†ä¸€èˆ¬åœ¨å…³é—­ä¸­æ–­çš„æƒ…å†µä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥ä¸­æ–­å¤„ç†ä¸èƒ½å¤ªè€—æ—¶ï¼Œå¦åˆ™åç»­å‘ç”Ÿçš„ä¸­æ–­å°±ä¸èƒ½å®æ—¶åœ°è¢«å¤„ç†ã€‚é‰´äºè¿™ä¸ªåŸå› ï¼ŒLinuxæŠŠä¸­æ–­å¤„ç†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸ŠåŠéƒ¨ å’Œ ä¸‹åŠéƒ¨ï¼Œä¸ŠåŠéƒ¨ åœ¨å‰é¢å·²ç»ä»‹ç»è¿‡ï¼Œæ¥ä¸‹æ¥å°±ä»‹ç»ä¸€ä¸‹ ä¸‹åŠéƒ¨ çš„æ‰§è¡Œã€‚</p><p>ä¸€èˆ¬ä¸­æ–­ ä¸ŠåŠéƒ¨ åªä¼šåšä¸€äº›æœ€åŸºç¡€çš„æ“ä½œï¼ˆæ¯”å¦‚ä»ç½‘å¡ä¸­å¤åˆ¶æ•°æ®åˆ°ç¼“å­˜ä¸­ï¼‰ï¼Œç„¶åå¯¹è¦æ‰§è¡Œçš„ä¸­æ–­ ä¸‹åŠéƒ¨ è¿›è¡Œæ ‡è¯†ï¼Œæ ‡è¯†å®Œè°ƒç”¨ do_softirq() å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p><h1>softirqæœºåˆ¶</h1><p>ä¸­æ–­ä¸‹åŠéƒ¨ ç”± softirqï¼ˆè½¯ä¸­æ–­ï¼‰ æœºåˆ¶æ¥å®ç°çš„ï¼Œåœ¨Linuxå†…æ ¸ä¸­ï¼Œæœ‰ä¸€ä¸ªåä¸º softirq_vec çš„æ•°ç»„ï¼Œå¦‚ä¸‹ï¼š</p><pre>static struct softirq_action softirq_vec[32];</pre><p>å…¶ç±»å‹ä¸º softirq_action ç»“æ„ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><pre>struct softirq_action{ void (*action)(struct softirq_action *); void *data;};</pre><p>softirq_vec æ•°ç»„æ˜¯ softirq æœºåˆ¶çš„æ ¸å¿ƒï¼Œsoftirq_vec æ•°ç»„æ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ç§softirqã€‚ä½†åœ¨Linuxä¸­åªå®šä¹‰äº†å››ç§softirqï¼Œå¦‚ä¸‹ï¼š</p><pre>enum{ HI_SOFTIRQ=0, NET_TX_SOFTIRQ, NET_RX_SOFTIRQ, TASKLET_SOFTIRQ};</pre><p>HI_SOFTIRQ æ˜¯é«˜ä¼˜å…ˆçº§taskletï¼Œè€Œ TASKLET_SOFTIRQ æ˜¯æ™®é€štaskletï¼Œtaskletæ˜¯åŸºäºsoftirqæœºåˆ¶çš„ä¸€ç§ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä¸‹é¢ä¼šä»‹ç»ï¼‰ã€‚NET_TX_SOFTIRQ å’Œ NET_RX_SOFTIRQ ç‰¹å®šç”¨äºç½‘ç»œå­æ¨¡å—çš„è½¯ä¸­æ–­ï¼ˆä¸ä½œä»‹ç»ï¼‰ã€‚</p><h1>æ³¨å†Œsoftirqå¤„ç†å‡½æ•°</h1><p>è¦æ³¨å†Œä¸€ä¸ªsoftirqå¤„ç†å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡ open_softirq() å‡½æ•°æ¥è¿›è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre>void open_softirq(int nr, void (*action)(struct softirq_action*), void *data){ unsigned long flags; int i; spin_lock_irqsave(&amp;softirq_mask_lock, flags); softirq_vec[nr].data = data; softirq_vec[nr].action = action; for (i=0; i&lt;NR_CPUS; i++) softirq_mask(i) |= (1&lt;&lt;nr); spin_unlock_irqrestore(&amp;softirq_mask_lock, flags);}</pre><p>open_softirq() å‡½æ•°çš„ä¸»è¦å·¥ä½œå°±æ˜¯å‘ softirq_vec æ•°ç»„æ·»åŠ ä¸€ä¸ªsoftirqå¤„ç†å‡½æ•°ã€‚</p><p>Linuxåœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶æ³¨å†Œäº†ä¸¤ç§softirqå¤„ç†å‡½æ•°ï¼Œåˆ†åˆ«ä¸º TASKLET_SOFTIRQ å’Œ HI_SOFTIRQï¼š</p><pre>void __init softirq_init(){ ... open_softirq(TASKLET_SOFTIRQ, tasklet_action, NULL); open_softirq(HI_SOFTIRQ, tasklet_hi_action, NULL);}</pre><h1>å¤„ç†softirq</h1><p>å¤„ç†softirqæ˜¯é€šè¿‡ do_softirq() å‡½æ•°å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre>asmlinkage void do_softirq(){ int cpu = smp_processor_id(); __u32 active, mask; if (in_interrupt()) return; local_bh_disable(); local_irq_disable(); mask = softirq_mask(cpu); active = softirq_active(cpu) &amp; mask; if (active) { struct softirq_action *h;restart: softirq_active(cpu) &amp;= ~active; local_irq_enable(); h = softirq_vec; mask &amp;= ~active; do { if (active &amp; 1) h-&gt;action(h); h++; active &gt;&gt;= 1; } while (active); local_irq_disable(); active = softirq_active(cpu); if ((active &amp;= mask) != 0) goto retry; } local_bh_enable(); return;retry: goto restart;}</pre><p>å‰é¢è¯´äº† softirq_vec æ•°ç»„æœ‰32ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ç§ç±»å‹çš„softirqï¼Œé‚£ä¹ˆLinuxæ€ä¹ˆçŸ¥é“å“ªç§softirqéœ€è¦è¢«æ‰§è¡Œå‘¢ï¼Ÿåœ¨Linuxä¸­ï¼Œæ¯ä¸ªCPUéƒ½æœ‰ä¸€ä¸ªç±»å‹ä¸º irq_cpustat_t ç»“æ„çš„å˜é‡ï¼Œirq_cpustat_t ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre>typedef struct { unsigned int __softirq_active; unsigned int __softirq_mask; ...} irq_cpustat_t;</pre><p>å…¶ä¸­ __softirq_active å­—æ®µè¡¨ç¤ºæœ‰å“ªç§softirqè§¦å‘äº†ï¼ˆintç±»å‹æœ‰32ä¸ªä½ï¼Œæ¯ä¸€ä¸ªä½ä»£è¡¨ä¸€ç§softirqï¼‰ï¼Œè€Œ __softirq_mask å­—æ®µè¡¨ç¤ºå“ªç§softirqè¢«å±è”½äº†ã€‚Linuxé€šè¿‡ __softirq_active è¿™ä¸ªå­—æ®µå¾—çŸ¥å“ªç§softirqéœ€è¦æ‰§è¡Œï¼ˆåªéœ€è¦æŠŠå¯¹åº”ä½è®¾ç½®ä¸º1ï¼‰ã€‚</p><p>æ‰€ä»¥ï¼Œdo_softirq() å‡½æ•°é¦–å…ˆé€šè¿‡ softirq_mask(cpu) æ¥è·å–å½“å‰CPUå¯¹åº”è¢«å±è”½çš„softirqï¼Œè€Œ softirq_active(cpu) & mask å°±æ˜¯è·å–éœ€è¦æ‰§è¡Œçš„softirqï¼Œç„¶åå°±é€šè¿‡å¯¹æ¯” __softirq_active å­—æ®µçš„å„ä¸ªä½æ¥åˆ¤æ–­æ˜¯å¦è¦æ‰§è¡Œè¯¥ç±»å‹çš„softirqã€‚</p><h1>taskletæœºåˆ¶</h1><p>å‰é¢è¯´äº†ï¼Œtaskletæœºåˆ¶æ˜¯åŸºäºsoftirqæœºåˆ¶çš„ï¼Œtaskletæœºåˆ¶å…¶å®å°±æ˜¯ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡softirqæ‰§è¡Œã€‚åœ¨Linuxå†…æ ¸ä¸­æœ‰ä¸¤ç§taskletï¼Œä¸€ç§æ˜¯é«˜ä¼˜å…ˆçº§taskletï¼Œä¸€ç§æ˜¯æ™®é€štaskletã€‚è¿™ä¸¤ç§taskletçš„å®ç°åŸºæœ¬ä¸€è‡´ï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯æ‰§è¡Œçš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜å…ˆçº§taskletä¼šå…ˆäºæ™®é€štaskletæ‰§è¡Œã€‚</p><p>taskletæœ¬è´¨æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé€šè¿‡ç»“æ„ä½“ tasklet_head å­˜å‚¨ï¼Œå¹¶ä¸”æ¯ä¸ªCPUæœ‰ä¸€ä¸ªè¿™æ ·çš„é˜Ÿåˆ—ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ç»“æ„ä½“ tasklet_head çš„å®šä¹‰ï¼š</p><pre>struct tasklet_head{ struct tasklet_struct *list;};struct tasklet_struct{ struct tasklet_struct *next; unsigned long state; atomic_t count; void (*func)(unsigned long); unsigned long data;};</pre><p>ä» tasklet_head çš„å®šä¹‰å¯ä»¥çŸ¥é“ï¼Œtasklet_head ç»“æ„æ˜¯ tasklet_struct ç»“æ„é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œè€Œ tasklet_struct ç»“æ„çš„ func å­—æ®µæ­£å¼ä»»åŠ¡è¦æ‰§è¡Œçš„å‡½æ•°æŒ‡é’ˆã€‚Linuxå®šä¹‰äº†ä¸¤ç§çš„taskleté˜Ÿåˆ—ï¼Œåˆ†åˆ«ä¸º tasklet_vec å’Œ tasklet_hi_vecï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><pre>struct tasklet_head tasklet_vec[NR_CPUS];struct tasklet_head tasklet_hi_vec[NR_CPUS];</pre><p>å¯ä»¥çœ‹å‡ºï¼Œtasklet_vec å’Œ tasklet_hi_vec éƒ½æ˜¯æ•°ç»„ï¼Œæ•°ç»„çš„å…ƒç´ ä¸ªæ•°ä¸ºCPUçš„æ ¸å¿ƒæ•°ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªCPUæ ¸å¿ƒéƒ½æœ‰ä¸€ä¸ªé«˜ä¼˜å…ˆçº§taskleté˜Ÿåˆ—å’Œä¸€ä¸ªæ™®é€štaskleté˜Ÿåˆ—ã€‚</p><h1>è°ƒåº¦tasklet</h1><p>å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªtaskletéœ€è¦æ‰§è¡Œï¼Œé‚£ä¹ˆé«˜ä¼˜å…ˆçº§taskletå¯ä»¥é€šè¿‡ tasklet_hi_schedule() å‡½æ•°è°ƒåº¦ï¼Œè€Œæ™®é€štaskletå¯ä»¥é€šè¿‡ tasklet_schedule() è°ƒåº¦ã€‚è¿™ä¸¤ä¸ªå‡½æ•°åŸºæœ¬ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬åªåˆ†æå…¶ä¸­ä¸€ä¸ªï¼š</p><pre>static inline void tasklet_hi_schedule(struct tasklet_struct *t){ if (!test_and_set_bit(TASKLET_STATE_SCHED, &amp;t-&gt;state)) { int cpu = smp_processor_id(); unsigned long flags; local_irq_save(flags); t-&gt;next = tasklet_hi_vec[cpu].list; tasklet_hi_vec[cpu].list = t; __cpu_raise_softirq(cpu, HI_SOFTIRQ); local_irq_restore(flags); }}</pre><p>å‡½æ•°å‚æ•°çš„ç±»å‹æ˜¯ tasklet_struct ç»“æ„çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºéœ€è¦æ‰§è¡Œçš„taskletç»“æ„ã€‚tasklet_hi_schedule() å‡½æ•°é¦–å…ˆåˆ¤æ–­è¿™ä¸ªtaskletæ˜¯å¦å·²ç»è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœä¸æ˜¯å°±æ·»åŠ åˆ° tasklet_hi_vec é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”é€šè¿‡è°ƒç”¨ __cpu_raise_softirq(cpu, HI_SOFTIRQ) æ¥å‘Šè¯‰softirqéœ€è¦æ‰§è¡Œ HI_SOFTIRQ ç±»å‹çš„softirqï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ __cpu_raise_softirq() å‡½æ•°çš„å®ç°ï¼š</p><pre>static inline void __cpu_raise_softirq(int cpu, int nr){ softirq_active(cpu) |= (1&lt;&lt;nr);}</pre><p>å¯ä»¥çœ‹å‡ºï¼Œ__cpu_raise_softirq() å‡½æ•°å°±æ˜¯æŠŠ irq_cpustat_t ç»“æ„çš„ __softirq_active å­—æ®µçš„ nrä½ è®¾ç½®ä¸º1ã€‚å¯¹äº tasklet_hi_schedule() å‡½æ•°å°±æ˜¯æŠŠ HI_SOFTIRQ ä½ï¼ˆ0ä½ï¼‰è®¾ç½®ä¸º1ã€‚</p><p>å‰é¢æˆ‘ä»¬ä¹Ÿä»‹ç»è¿‡ï¼ŒLinuxåœ¨åˆå§‹åŒ–æ—¶ä¼šæ³¨å†Œä¸¤ç§softirqï¼ŒTASKLET_SOFTIRQ å’Œ HI_SOFTIRQï¼š</p><pre>void __init softirq_init(){ ... open_softirq(TASKLET_SOFTIRQ, tasklet_action, NULL); open_softirq(HI_SOFTIRQ, tasklet_hi_action, NULL);}</pre><p>æ‰€ä»¥å½“æŠŠ irq_cpustat_t ç»“æ„çš„ __softirq_active å­—æ®µçš„ HI_SOFTIRQ ä½ï¼ˆ0ä½ï¼‰è®¾ç½®ä¸º1æ—¶ï¼Œsoftirqæœºåˆ¶å°±ä¼šæ‰§è¡Œ tasklet_hi_action() å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ tasklet_hi_action() å‡½æ•°çš„å®ç°ï¼š</p><pre>static void tasklet_hi_action(struct softirq_action *a){ int cpu = smp_processor_id(); struct tasklet_struct *list; local_irq_disable(); list = tasklet_hi_vec[cpu].list; tasklet_hi_vec[cpu].list = NULL; local_irq_enable(); while (list != NULL) { struct tasklet_struct *t = list; list = list-&gt;next; if (tasklet_trylock(t)) { if (atomic_read(&amp;t-&gt;count) == 0) { clear_bit(TASKLET_STATE_SCHED, &amp;t-&gt;state); t-&gt;func(t-&gt;data); // è°ƒç”¨taskletå¤„ç†å‡½æ•° tasklet_unlock(t); continue; } tasklet_unlock(t); } ... }}</pre><p>tasklet_hi_action() å‡½æ•°éå¸¸ç®€å•ï¼Œå°±æ˜¯éå† tasklet_hi_vec é˜Ÿåˆ—å¹¶ä¸”æ‰§è¡Œå…¶ä¸­taskletçš„å¤„ç†å‡½æ•°ã€‚</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Linux','ä¸­æ–­','å¤„ç†'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>