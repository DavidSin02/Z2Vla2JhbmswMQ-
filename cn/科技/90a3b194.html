<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Springï¼šAOP é¢å‘åˆ‡é¢ç¼–ç¨‹ | æå®¢å¿«è¨Š</title><meta property="og:title" content="Springï¼šAOP é¢å‘åˆ‡é¢ç¼–ç¨‹ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/2e916acf35c540c59694eae279114599"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/90a3b194.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/90a3b194.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/90a3b194.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/90a3b194.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/90a3b194.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/90a3b194.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/90a3b194.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/90a3b194.html><meta property="article:published_time" content="2020-11-14T21:04:29+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:29+08:00"><meta name=Keywords content><meta name=description content="Springï¼šAOP é¢å‘åˆ‡é¢ç¼–ç¨‹"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/90a3b194.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Springï¼šAOP é¢å‘åˆ‡é¢ç¼–ç¨‹</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div class=pgc-img><img alt="Springï¼šAOP é¢å‘åˆ‡é¢ç¼–ç¨‹" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2e916acf35c540c59694eae279114599><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>è½¬è´¦æ¡ˆä¾‹</h1><p>éœ€æ±‚ï¼šä½¿ç”¨ spring æ¡†æ¶æ•´åˆ DBUtils æŠ€æœ¯ï¼Œå®ç°ç”¨æˆ·è½¬è´¦åŠŸèƒ½</p><h1 class=pgc-h-arrow-right><strong>åŸºç¡€åŠŸèƒ½</strong></h1><p>æ­¥éª¤åˆ†æï¼š</p><ol start=1><li>åˆ›å»º java é¡¹ç›®ï¼Œå¯¼å…¥åº§æ ‡</li><li>ç¼–å†™ Account å®ä½“ç±»</li><li>ç¼–å†™ AccountDao æ¥å£å’Œå®ç°ç±»</li><li>ç¼–å†™ AccountService æ¥å£å’Œå®ç°ç±»</li><li>ç¼–å†™ spring æ ¸å¿ƒé…ç½®æ–‡ä»¶</li><li>ç¼–å†™æµ‹è¯•ä»£ç </li></ol><h1 class=pgc-h-arrow-right><strong>åˆ›å»º java é¡¹ç›®ï¼Œå¯¼å…¥åº§æ ‡</strong></h1><pre><code>&lt;dependencies&gt;    &lt;dependency&gt;        &lt;groupId&gt;mysql&lt;/groupId&gt;        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;        &lt;version&gt;5.1.47&lt;/version&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;        &lt;artifactId&gt;druid&lt;/artifactId&gt;        &lt;version&gt;1.1.15&lt;/version&gt;    &lt;/dependency&gt;â€‹    &lt;dependency&gt;        &lt;groupId&gt;commons-dbutils&lt;/groupId&gt;        &lt;artifactId&gt;commons-dbutils&lt;/artifactId&gt;        &lt;version&gt;1.6&lt;/version&gt;    &lt;/dependency&gt;â€‹    &lt;dependency&gt;        &lt;groupId&gt;org.springframework&lt;/groupId&gt;        &lt;artifactId&gt;spring-context&lt;/artifactId&gt;        &lt;version&gt;5.1.5.RELEASE&lt;/version&gt;    &lt;/dependency&gt;â€‹    &lt;dependency&gt;        &lt;groupId&gt;org.springframework&lt;/groupId&gt;        &lt;artifactId&gt;spring-test&lt;/artifactId&gt;        &lt;version&gt;5.1.5.RELEASE&lt;/version&gt;    &lt;/dependency&gt;â€‹    &lt;dependency&gt;        &lt;groupId&gt;junit&lt;/groupId&gt;        &lt;artifactId&gt;junit&lt;/artifactId&gt;        &lt;version&gt;4.12&lt;/version&gt;    &lt;/dependency&gt;â€‹    &lt;dependency&gt;        &lt;groupId&gt;org.aspectj&lt;/groupId&gt;        &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;        &lt;version&gt;1.8.13&lt;/version&gt;    &lt;/dependency&gt;&lt;/dependencies&gt;</code></pre><h1 class=pgc-h-arrow-right><strong>ç¼–å†™ AccountDao æ¥å£å’Œå®ç°ç±»</strong></h1><pre><code>public interface AccountDao {    /**     * è½¬å‡ºæ“ä½œ     * @param outUser     * @param money     */    void out(String outUser,Double money);â€‹    /**     * è½¬å…¥æ“ä½œ     * @param inUser     * @param money     */    void in(String inUser,Double money);}@Repository("AccountDao")public class AccountDaoImpl implements AccountDao {    @Autowired    private QueryRunner queryRunner;â€‹    @Override    public void out(String outUser, Double money) {        String sql = "update account set money = money - ? where name = ?";        try {            queryRunner.update(sql, money, outUser);        } catch (SQLException throwables) {            throwables.printStackTrace();        }    }â€‹    @Override    public void in(String inUser, Double money) {        String sql = "update account set money = money + ? where name = ?";        try {            queryRunner.update(sql, money, inUser);        } catch (SQLException throwables) {            throwables.printStackTrace();        }    }}</code></pre><h1 class=pgc-h-arrow-right><strong>ç¼–å†™ AccountService æ¥å£å’Œå®ç°ç±»</strong></h1><pre><code>public interface AccountService {        /**         * è½¬è´¦æ–¹æ³•         */        void transfer(String outUser,String inUser,Double money);}@Service("accountService")public class AccountServiceImpl implements AccountService {    @Autowired    private AccountDao accountDao;    /**     * è½¬è´¦æ–¹æ³•     */    @Override    public void transfer(String outUser, String inUser, Double money) {        // ç¼–å†™äº†äº‹åŠ¡ç›¸å…³ä»£ç         // è°ƒç”¨äº†å‡é’±æ–¹æ³•        accountDao.out(outUser,money);        // æ¨¡æ‹Ÿå‡ºé”™        // int i= 1/0;        // è°ƒç”¨äº†åŠ é’±æ–¹æ³•        accountDao.in(inUser,money);    }}</code></pre><h1 class=pgc-h-arrow-right><strong>ç¼–å†™ spring æ ¸å¿ƒé…ç½®æ–‡ä»¶</strong></h1><pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;beans xmlns="http://www.springframework.org/schema/beans"       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"       xmlns:context="http://www.springframework.org/schema/context"       xmlns:aop="http://www.springframework.org/schema/aop"       xsi:schemaLocation="       	http://www.springframework.org/schema/beans		http://www.springframework.org/schema/beans/spring-beans.xsd       	http://www.springframework.org/schema/context		http://www.springframework.org/schema/context/spring-context.xsd		http://www.springframework.org/schema/aop		http://www.springframework.org/schema/aop/spring-aop.xsd"&gt;    &lt;!-- å¼€å¯æ³¨è§£æ‰«æ --&gt;    &lt;context:component-scan base-package="com.renda"/&gt;    &lt;!-- å¼•å…¥ properties --&gt;    &lt;context:property-placeholder location="classpath:jdbc.properties"/&gt;    &lt;!-- é…ç½® DataSource --&gt;    &lt;bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource"&gt;        &lt;property name="driverClassName" value="${jdbc.driverClassName}"/&gt;        &lt;property name="url" value="${jdbc.url}"/&gt;        &lt;property name="username" value="${jdbc.username}"/&gt;        &lt;property name="password" value="${jdbc.password}"/&gt;    &lt;/bean&gt;    &lt;!-- é…ç½® queryRunner --&gt;    &lt;bean id="queryRunner" class="org.apache.commons.dbutils.QueryRunner"&gt;        &lt;constructor-arg name="ds" ref="dataSource"/&gt;    &lt;/bean&gt;&lt;/beans&gt;</code></pre><h1 class=pgc-h-arrow-right><strong>ç¼–å†™æµ‹è¯•ä»£ç </strong></h1><pre><code>@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration({"classpath:applicationContext.xml"})public class AccountServiceTest {    @Autowired    private AccountService accountService;    @Test    public void testTransfer() {        accountService.transfer("tom", "jerry", 100d);    }}</code></pre><h1 class=pgc-h-arrow-right><strong>é—®é¢˜åˆ†æ</strong></h1><p>ä¸Šé¢çš„ä»£ç äº‹åŠ¡åœ¨ Dao å±‚ï¼Œè½¬å‡ºè½¬å…¥æ“ä½œéƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ï¼Œä½†å®é™…å¼€å‘ï¼Œåº”è¯¥æŠŠä¸šåŠ¡é€»è¾‘æ§åˆ¶åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæ‰€ä»¥åº”è¯¥å°†äº‹åŠ¡æŒªåˆ° Service å±‚ã€‚</p><h1 class=pgc-h-arrow-right><strong>ä¼ ç»Ÿäº‹åŠ¡</strong></h1><p>æ­¥éª¤åˆ†æï¼š</p><ol start=1><li>ç¼–å†™çº¿ç¨‹ç»‘å®šå·¥å…·ç±»</li><li>ç¼–å†™äº‹åŠ¡ç®¡ç†å™¨</li><li>ä¿®æ”¹ service å±‚ä»£ç </li><li>ä¿®æ”¹ dao å±‚ä»£ç </li></ol><h1 class=pgc-h-arrow-right><strong>ç¼–å†™çº¿ç¨‹ç»‘å®šå·¥å…·ç±»</strong></h1><pre><code>@Componentpublic class ConnectionUtils {    @Autowired    private DataSource dataSource;â€‹    private ThreadLocal&lt;Connection&gt; threadLocal = new ThreadLocal&lt;&gt;();â€‹    /**     * è·å–å½“å‰çº¿ç¨‹ä¸Šç»‘å®šè¿æ¥ï¼šå¦‚æœè·å–åˆ°çš„è¿æ¥ä¸ºç©ºï¼Œé‚£ä¹ˆå°±è¦ä»æ•°æ®æºä¸­è·å–è¿æ¥ï¼Œå¹¶ä¸”æ”¾åˆ° ThreadLocal ä¸­ï¼ˆç»‘å®šåˆ°å½“å‰çº¿ç¨‹ï¼‰     */    public Connection getThreadConnection() {        // 1.å…ˆä» ThreadLocal ä¸Šè·å–è¿æ¥        Connection connection = threadLocal.get();        // 2.åˆ¤æ–­å½“å‰çº¿ç¨‹ä¸­æ˜¯å¦æ˜¯æœ‰ Connection        if(connection == null){            // 3.ä»æ•°æ®æºä¸­è·å–ä¸€ä¸ªè¿æ¥ï¼Œå¹¶ä¸”å­˜å…¥ ThreadLocal ä¸­            try {                // ä¸ä¸º null                connection = dataSource.getConnection();                threadLocal.set(connection);            } catch (SQLException e) {                e.printStackTrace();            }        }        return  connection;    }â€‹    /**     * è§£é™¤å½“å‰çº¿ç¨‹çš„è¿æ¥ç»‘å®š     */    public void  removeThreadConnection(){        threadLocal.remove();    }}</code></pre><h1 class=pgc-h-arrow-right><strong>ç¼–å†™äº‹åŠ¡ç®¡ç†å™¨</strong></h1><pre><code>@Component("transactionManager")public class TransactionManager {    @Autowired    private ConnectionUtils connectionUtils;â€‹    /**     * å¼€å¯äº‹åŠ¡     */    public void beginTransaction(){        // è·å– connection å¯¹è±¡        Connection connection = connectionUtils.getThreadConnection();        try {            // å¼€å¯äº†ä¸€ä¸ªæ‰‹åŠ¨äº‹åŠ¡            connection.setAutoCommit(false);        } catch (SQLException e) {            e.printStackTrace();        }    }â€‹    /**     * æäº¤äº‹åŠ¡     */    public void commit(){        Connection connection = connectionUtils.getThreadConnection();        try {            connection.commit();        } catch (SQLException e) {            e.printStackTrace();        }    }â€‹    /**     * å›æ»šäº‹åŠ¡     */    public void rollback(){        Connection connection = connectionUtils.getThreadConnection();        try {            connection.rollback();        } catch (SQLException e) {            e.printStackTrace();        }    }â€‹    /**     * é‡Šæ”¾èµ„æº     */    public void release(){        // å°†æ‰‹åŠ¨äº‹åŠ¡æ”¹å›æˆè‡ªåŠ¨æäº¤äº‹åŠ¡        Connection connection = connectionUtils.getThreadConnection();        try {            connection.setAutoCommit(true);            // å°†è¿æ¥å½’è¿˜åˆ°è¿æ¥æ±             connectionUtils.getThreadConnection().close();            // è§£é™¤çº¿ç¨‹ç»‘å®š            connectionUtils.removeThreadConnection();        } catch (SQLException e) {            e.printStackTrace();        }    }}</code></pre><h1 class=pgc-h-arrow-right><strong>ä¿®æ”¹ service å±‚ä»£ç </strong></h1><pre><code>@Service("accountService")public class AccountServiceImpl implements AccountService {    @Autowired    private AccountDao accountDao;    @Autowired    private TransactionManager transactionManager;    @Override    public void transfer(String outUser, String inUser, Double money) {        try {            // 1.å¼€å¯äº‹åŠ¡            transactionManager.beginTransaction();            // 2.ä¸šåŠ¡æ“ä½œ            // ç¼–å†™äº†äº‹åŠ¡ç›¸å…³ä»£ç             // è°ƒç”¨äº†å‡é’±æ–¹æ³•            accountDao.out(outUser, money);            // æ¨¡æ‹Ÿå‡ºé”™            // int i= 1/0;            // è°ƒç”¨äº†åŠ é’±æ–¹æ³•            accountDao.in(inUser, money);            // 3.æäº¤äº‹åŠ¡            transactionManager.commit();        } catch (Exception e) {            // 4.å›æ»šäº‹åŠ¡            transactionManager.rollback();            e.printStackTrace();        } finally {            // 5.é‡Šæ”¾èµ„æº            transactionManager.release();        }    }}</code></pre><h1 class=pgc-h-arrow-right><strong>ä¿®æ”¹ Dao å±‚ä»£ç </strong></h1><pre><code>@Repository("AccountDao")public class AccountDaoImpl implements AccountDao {    @Autowired    private QueryRunner queryRunner;    @Autowired    private ConnectionUtils connectionUtils;    /**     * è½¬å‡ºæ“ä½œ     */    @Override    public void out(String outUser, Double money) {        String sql = "update account set money = money - ? where name = ?";        try {            queryRunner.update(connectionUtils.getThreadConnection(), sql, money, outUser);        } catch (SQLException throwables) {            throwables.printStackTrace();        }    }    /**     * è½¬å…¥æ“ä½œ     */    @Override    public void in(String inUser, Double money) {        String sql = "update account set money = money + ? where name = ?";        try {            queryRunner.update(connectionUtils.getThreadConnection(), sql, money, inUser);        } catch (SQLException throwables) {            throwables.printStackTrace();        }    }}</code></pre><h1 class=pgc-h-arrow-right><strong>é—®é¢˜åˆ†æ</strong></h1><p>ä¸Šé¢ä»£ç ï¼Œé€šè¿‡å¯¹ä¸šåŠ¡å±‚æ”¹é€ ï¼Œå·²ç»å¯ä»¥å®ç°äº‹åŠ¡æ§åˆ¶äº†ï¼Œä½†æ˜¯ç”±äºæ·»åŠ äº†äº‹åŠ¡æ§åˆ¶ï¼Œä¹Ÿäº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼š ä¸šåŠ¡å±‚æ–¹æ³•å˜å¾—è‡ƒè‚¿äº†ï¼Œé‡Œé¢å……æ–¥ç€å¾ˆå¤šé‡å¤ä»£ç ã€‚å¹¶ä¸”ä¸šåŠ¡å±‚æ–¹æ³•å’Œäº‹åŠ¡æ§åˆ¶æ–¹æ³•è€¦åˆäº†ï¼Œè¿èƒŒäº†é¢å‘å¯¹è±¡çš„å¼€å‘æ€æƒ³ã€‚</p><p><br></p><h1 class=pgc-h-arrow-right><strong>Proxy ä¼˜åŒ–è½¬è´¦æ¡ˆä¾‹</strong></h1><p>å¯ä»¥å°†ä¸šåŠ¡ä»£ç å’Œäº‹åŠ¡ä»£ç è¿›è¡Œæ‹†åˆ†ï¼Œé€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œå¯¹ä¸šåŠ¡æ–¹æ³•è¿›è¡Œäº‹åŠ¡çš„å¢å¼ºã€‚è¿™æ ·å°±ä¸ä¼šå¯¹ä¸šåŠ¡å±‚äº§ç”Ÿå½±å“ï¼Œè§£å†³äº†è€¦åˆæ€§çš„é—®é¢˜ã€‚</p><p>å¸¸ç”¨çš„åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼š</p><ul><li>JDK ä»£ç†ï¼ŒåŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†æŠ€æœ¯ - åˆ©ç”¨æ‹¦æˆªå™¨ï¼ˆå¿…é¡»å®ç° invocationHandlerï¼‰åŠ ä¸Šåå°„æœºåˆ¶ç”Ÿæˆä¸€ä¸ªä»£ç†æ¥å£çš„åŒ¿åç±»ï¼Œåœ¨è°ƒç”¨å…·ä½“æ–¹æ³•å‰è°ƒç”¨ InvokeHandler æ¥å¤„ç†ï¼Œä»è€Œå®ç°æ–¹æ³•å¢å¼º</li><li>CGLIB ä»£ç†ï¼ŒåŸºäºçˆ¶ç±»çš„åŠ¨æ€ä»£ç†æŠ€æœ¯ - åŠ¨æ€ç”Ÿæˆä¸€ä¸ªè¦ä»£ç†çš„å­ç±»ï¼Œå­ç±»é‡å†™è¦ä»£ç†çš„ç±»çš„æ‰€æœ‰ä¸æ˜¯ final çš„æ–¹æ³•ï¼›åœ¨å­ç±»ä¸­é‡‡ç”¨æ–¹æ³•æ‹¦æˆªæŠ€æœ¯æ‹¦æˆªæ‰€æœ‰çš„çˆ¶ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œé¡ºåŠ¿ç»‡å…¥æ¨ªåˆ‡é€»è¾‘ï¼Œå¯¹æ–¹æ³•è¿›è¡Œå¢å¼º</li></ul><h1 class=pgc-h-arrow-right><strong>JDK åŠ¨æ€ä»£ç†æ–¹å¼</strong></h1><p>å»æ‰ AccountServiceImpl çš„äº‹åŠ¡æ§åˆ¶ä»£ç </p><pre><code>@Service("accountService")public class AccountServiceImpl implements AccountService {    @Autowired    private AccountDao accountDao;    @Override    public void transfer(String outUser, String inUser, Double money) {        accountDao.out(outUser, money);        // æ¨¡æ‹Ÿå‡ºé”™        int i= 1/0;        accountDao.in(inUser, money);    }}</code></pre><p>JDK å·¥å‚ç±»</p><pre><code>@Componentpublic class JDKProxyFactory {    @Autowired    private AccountService accountService;    @Autowired    private TransactionManager transactionManager;    /**     * é‡‡ç”¨ JDK åŠ¨æ€ä»£ç†æŠ€æœ¯æ¥ç”Ÿæˆç›®æ ‡ç±»çš„ä»£ç†å¯¹è±¡     * ClassLoader loader : ç±»åŠ è½½å™¨ï¼šå€ŸåŠ©è¢«ä»£ç†å¯¹è±¡è·å–åˆ°ç±»åŠ è½½å™¨     * Class&lt;?&gt;[] interfaces ï¼š è¢«ä»£ç†ç±»æ‰€éœ€è¦å®ç°çš„å…¨éƒ¨æ¥å£     * InvocationHandler h ï¼š å½“ä»£ç†å¯¹è±¡è°ƒç”¨æ¥å£ä¸­çš„ä»»æ„æ–¹æ³•æ—¶ï¼Œé‚£ä¹ˆéƒ½ä¼šæ‰§è¡Œ InvocationHandler ä¸­ invoke æ–¹æ³•     */    public AccountService createAccountServiceJdkProxy() {        return (AccountService) Proxy.newProxyInstance(                accountService.getClass().getClassLoader(),                accountService.getClass().getInterfaces(),                new InvocationHandler() {                    /**                     * @param proxy å½“å‰çš„ä»£ç†å¯¹è±¡å¼•ç”¨                     * @param method è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•çš„å¼•ç”¨                     * @param args è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•æ‰€ç”¨åˆ°çš„å‚æ•°                     */                    @Override                    public Object invoke(Object proxy, Method method, Object[] args) {                        try {                            if ("transfer".equalsIgnoreCase(method.getName())) {                                System.out.println("JDK Proxy: Pre-Enhance ...");                                transactionManager.beginTransaction();                                method.invoke(accountService, args);                                System.out.println("JDK Proxy: Post-Enhance ...");                                transactionManager.commit();                            } else {                                method.invoke(accountService, args);                            }                        } catch (Exception e) {                            transactionManager.rollback();                            e.printStackTrace();                        } finally {                            transactionManager.release();                        }                        return null;                    }                });    }}</code></pre><p>æµ‹è¯•ä»£ç </p><pre><code>@Autowiredprivate JDKProxyFactory jdkProxyFactory;@Testpublic void testTransferProxyJDK(){    // å½“å‰è¿”å›çš„å®é™…ä¸Šæ˜¯ AccountService çš„ä»£ç†å¯¹è±¡ proxy    AccountService accountServiceJDKProxy = jdkProxyFactory.createAccountServiceJDKProxy();    // ä»£ç†å¯¹è±¡ proxy è°ƒç”¨æ¥å£ä¸­çš„ä»»æ„æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œåº•å±‚çš„ invoke æ–¹æ³•    accountServiceJDKProxy.transfer("tom", "jerry", 100d);}</code></pre><h1 class=pgc-h-arrow-right><strong>CGLIB åŠ¨æ€ä»£ç†æ–¹å¼</strong></h1><p>CGLIB å·¥å‚ç±»</p><pre><code>@Componentpublic class CglibProxyFactory {    @Autowired    private AccountService accountService;    @Autowired    private TransactionManager transactionManager;    /**     * ç¼–å†™ cglib å¯¹åº”çš„ API æ¥ç”Ÿæˆä»£ç†å¯¹è±¡è¿›è¡Œè¿”å›     * å‚æ•° 1 ï¼š ç›®æ ‡ç±»çš„å­—èŠ‚ç å¯¹è±¡     * å‚æ•° 2ï¼š  åŠ¨ä½œç±»ï¼Œå½“ä»£ç†å¯¹è±¡è°ƒç”¨ç›®æ ‡å¯¹è±¡ä¸­åŸæ–¹æ³•æ—¶ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œ intercept æ–¹æ³•     */    public AccountService createAccountServiceCglibProxy() {        return (AccountService) Enhancer.create(accountService.getClass(), new MethodInterceptor() {            /**             * @param o ä»£è¡¨ç”Ÿæˆçš„ä»£ç†å¯¹è±¡             * @param method è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„å¼•ç”¨             * @param objects æ–¹æ³•å…¥å‚             * @param methodProxy ä»£ç†æ–¹æ³•             */            @Override            public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) {                try {                    System.out.println("CGLIB Proxy: Pre-Enhance ...");                    // æ‰‹åŠ¨å¼€å¯äº‹åŠ¡ï¼šè°ƒç”¨äº‹åŠ¡ç®¡ç†å™¨ç±»ä¸­çš„å¼€å¯äº‹åŠ¡æ–¹æ³•                    transactionManager.beginTransaction();                    method.invoke(accountService, objects);                    System.out.println("CGLIB Proxy: Post-Enhance ...");                    transactionManager.commit();                } catch (Exception e) {                    // æ‰‹åŠ¨å›æ»šäº‹åŠ¡                    transactionManager.rollback();                    e.printStackTrace();                } finally {                    // æ‰‹åŠ¨é‡Šæ”¾èµ„æº                    transactionManager.release();                }                return null;            }        });    }}</code></pre><p>æµ‹è¯•ä»£ç </p><pre><code>@Autowiredprivate CglibProxyFactory cglibProxyFactory;@Testpublic void testTransferProxyCglib(){    AccountService accountServiceCglibProxy = cglibProxyFactory.createAccountServiceCglibProxy();    accountServiceCglibProxy.transfer("tom","jerry",100d);}</code></pre><h1 class=pgc-h-arrow-right><br></h1><h1 class=pgc-h-arrow-right><strong>åˆè¯† AOP</strong></h1><h1 class=pgc-h-arrow-right><strong>ä»€ä¹ˆæ˜¯ AOP</strong></h1><p>AOP ä¸º Aspect Oriented Programming çš„ç¼©å†™ï¼Œæ„æ€ä¸ºé¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚</p><p>AOP æ˜¯ OOPï¼ˆé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰ çš„å»¶ç»­ï¼Œæ˜¯è½¯ä»¶å¼€å‘ä¸­çš„ä¸€ä¸ªçƒ­ç‚¹ï¼Œä¹Ÿæ˜¯ Spring æ¡†æ¶ä¸­çš„ä¸€ä¸ªé‡è¦å†…å®¹ï¼Œåˆ©ç”¨ AOP å¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»ï¼Œä»è€Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚</p><p>ä¼˜åŠ¿ï¼š</p><ol start=1><li>åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œåœ¨ä¸ä¿®æ”¹æºç çš„æƒ…å†µä¸‹å¯¹æ–¹æ³•è¿›è¡ŒåŠŸèƒ½å¢å¼º</li><li>é€»è¾‘æ¸…æ™°ï¼Œå¼€å‘æ ¸å¿ƒä¸šåŠ¡çš„æ—¶å€™ï¼Œä¸å¿…å…³æ³¨å¢å¼ºä¸šåŠ¡çš„ä»£ç </li><li>å‡å°‘é‡å¤ä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼Œä¾¿äºåæœŸç»´æŠ¤</li></ol><h1 class=pgc-h-arrow-right><strong>AOP åº•å±‚å®ç°</strong></h1><p>å®é™…ä¸Šï¼ŒAOP çš„åº•å±‚æ˜¯é€šè¿‡ Spring æä¾›çš„çš„åŠ¨æ€ä»£ç†æŠ€æœ¯å®ç°çš„ã€‚åœ¨è¿è¡ŒæœŸé—´ï¼ŒSpring é€šè¿‡åŠ¨æ€ä»£ç†æŠ€æœ¯åŠ¨æ€çš„ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡æ–¹æ³•æ‰§è¡Œæ—¶è¿›è¡Œå¢å¼ºåŠŸèƒ½çš„ä»‹å…¥ï¼Œåœ¨å»è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œä»è€Œå®ŒæˆåŠŸèƒ½çš„å¢å¼ºã€‚</p><h1 class=pgc-h-arrow-right><strong>AOP ç›¸å…³æœ¯è¯­</strong></h1><p>Spring çš„ AOP å®ç°åº•å±‚å°±æ˜¯å¯¹ä¸Šé¢çš„åŠ¨æ€ä»£ç†çš„ä»£ç è¿›è¡Œäº†å°è£…ï¼Œå°è£…åæˆ‘ä»¬åªéœ€è¦å¯¹éœ€è¦å…³æ³¨çš„éƒ¨åˆ†è¿›è¡Œä»£ç ç¼–å†™ï¼Œå¹¶é€šè¿‡é…ç½®çš„æ–¹å¼å®ŒæˆæŒ‡å®šç›®æ ‡çš„æ–¹æ³•å¢å¼ºã€‚</p><p>åœ¨æ­£å¼è®²è§£ AOP çš„æ“ä½œä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»ç†è§£ AOP çš„ç›¸å…³æœ¯è¯­ï¼Œå¸¸ç”¨çš„æœ¯è¯­å¦‚ä¸‹ï¼š</p><pre><code>* Targetï¼ˆç›®æ ‡å¯¹è±¡ï¼‰ï¼šä»£ç†çš„ç›®æ ‡å¯¹è±¡ï¼›è¢«ä»£ç†ç±»* Proxyï¼ˆä»£ç†ï¼‰ï¼šä¸€ä¸ªç±»è¢« AOP ç»‡å…¥å¢å¼ºåï¼Œå°±äº§ç”Ÿä¸€ä¸ªç»“æœä»£ç†ç±»ï¼›ç”Ÿæˆä»£ç†å¯¹è±¡* Joinpointï¼ˆè¿æ¥ç‚¹ï¼‰ï¼šæ‰€è°“è¿æ¥ç‚¹æ˜¯æŒ‡é‚£äº›å¯ä»¥è¢«æ‹¦æˆªåˆ°çš„ç‚¹ï¼›åœ¨ spring ä¸­ï¼Œè¿™äº›ç‚¹æŒ‡çš„æ˜¯æ–¹æ³•ï¼Œå› ä¸º spring åªæ”¯æŒæ–¹æ³•ç±»å‹çš„è¿æ¥ç‚¹ï¼›å¯ä»¥è¢«æ‹¦æˆªå¢å¼ºçš„æ–¹æ³•* Pointcutï¼ˆåˆ‡å…¥ç‚¹ï¼‰ï¼šæ‰€è°“åˆ‡å…¥ç‚¹æ˜¯æŒ‡æˆ‘ä»¬è¦å¯¹å“ªäº› Joinpoint è¿›è¡Œæ‹¦æˆªçš„å®šä¹‰ï¼›å³çœŸæ­£è¢«æ‹¦æˆªå¢å¼ºçš„æ–¹æ³•* Adviceï¼ˆé€šçŸ¥/ å¢å¼ºï¼‰ï¼šæ‰€è°“é€šçŸ¥æ˜¯æŒ‡æ‹¦æˆªåˆ° Joinpoint ä¹‹åæ‰€è¦åšçš„äº‹æƒ…å°±æ˜¯é€šçŸ¥åˆ†ç±»ï¼šå‰ç½®é€šçŸ¥ã€åç½®é€šçŸ¥ã€å¼‚å¸¸é€šçŸ¥ã€æœ€ç»ˆé€šçŸ¥ã€ç¯ç»•é€šçŸ¥ - ä¸€ç§å¯ä»¥é€šè¿‡ä»£ç çš„æ–¹å¼æ¥æ‰‹åŠ¨æ§åˆ¶çš„ç±»å‹ï¼›å³å¢å¼ºçš„ä¸šåŠ¡é€»è¾‘* Aspectï¼ˆåˆ‡é¢ï¼‰ï¼šæ˜¯åˆ‡å…¥ç‚¹å’Œé€šçŸ¥ï¼ˆå¼•ä»‹ï¼‰çš„ç»“åˆ* Weavingï¼ˆç»‡å…¥ï¼‰ï¼šæ˜¯æŒ‡æŠŠå¢å¼ºåº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡æ¥åˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚Spring é‡‡ç”¨åŠ¨æ€ä»£ç†ç»‡å…¥ï¼Œè€Œ AspectJ é‡‡ç”¨ç¼–è¯‘æœŸç»‡å…¥å’Œç±»è£…è½½æœŸç»‡å…¥</code></pre><h1 class=pgc-h-arrow-right><strong>AOP å¼€å‘æ˜ç¡®äº‹é¡¹</strong></h1><h1 class=pgc-h-arrow-right><strong>å¼€å‘é˜¶æ®µ</strong></h1><ol start=1><li>ç¼–å†™æ ¸å¿ƒä¸šåŠ¡ä»£ç ï¼ˆç›®æ ‡ç±»çš„ç›®æ ‡æ–¹æ³•ï¼‰ åˆ‡å…¥ç‚¹</li><li>æŠŠå…¬ç”¨ä»£ç æŠ½å–å‡ºæ¥ï¼Œåˆ¶ä½œæˆé€šçŸ¥ï¼ˆå¢å¼ºåŠŸèƒ½æ–¹æ³•ï¼‰ é€šçŸ¥</li><li>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå£°æ˜åˆ‡å…¥ç‚¹ä¸é€šçŸ¥é—´çš„å…³ç³»ï¼Œå³åˆ‡é¢</li></ol><h1 class=pgc-h-arrow-right><strong>è¿è¡Œé˜¶æ®µï¼ˆSpring æ¡†æ¶è‡ªåŠ¨å®Œæˆï¼‰</strong></h1><p>Spring æ¡†æ¶ç›‘æ§åˆ‡å…¥ç‚¹æ–¹æ³•çš„æ‰§è¡Œã€‚ä¸€æ—¦ç›‘æ§åˆ°åˆ‡å…¥ç‚¹æ–¹æ³•è¢«è¿è¡Œï¼Œä½¿ç”¨ä»£ç†æœºåˆ¶ï¼ŒåŠ¨æ€åˆ›å»ºç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œæ ¹æ®é€šçŸ¥ç±»åˆ«ï¼Œåœ¨ä»£ç†å¯¹è±¡çš„å¯¹åº”ä½ç½®ï¼Œå°†é€šçŸ¥å¯¹åº”çš„åŠŸèƒ½ç»‡å…¥ï¼Œå®Œæˆå®Œæ•´çš„ä»£ç é€»è¾‘è¿è¡Œã€‚</p><h1 class=pgc-h-arrow-right><strong>åº•å±‚ä»£ç†å®ç°</strong></h1><p>åœ¨ Spring ä¸­ï¼Œæ¡†æ¶ä¼šæ ¹æ®ç›®æ ‡ç±»æ˜¯å¦å®ç°äº†æ¥å£æ¥å†³å®šé‡‡ç”¨å“ªç§åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼š</p><ul><li>å½“ bean å®ç°æ¥å£æ—¶ï¼Œä¼šç”¨ JDK ä»£ç†æ¨¡å¼</li><li>å½“ bean æ²¡æœ‰å®ç°æ¥å£ï¼Œç”¨ cglib å®ç°ï¼ˆ å¯ä»¥å¼ºåˆ¶ä½¿ç”¨ cglibï¼ˆåœ¨ spring é…ç½®ä¸­åŠ å…¥ &lt;aop:aspectj-autoproxy proxy-target-class=â€trueâ€/>ï¼‰</li></ul><h1 class=pgc-h-arrow-right><strong>å°ç»“</strong></h1><pre><code>* aop - é¢å‘åˆ‡é¢ç¼–ç¨‹* aop åº•å±‚å®ç°ï¼šåŸºäº JDK çš„åŠ¨æ€ä»£ç†å’ŒåŸºäº Cglib çš„åŠ¨æ€ä»£ç†* aop çš„é‡ç‚¹æ¦‚å¿µï¼š    Pointcutï¼ˆåˆ‡å…¥ç‚¹ï¼‰ï¼šçœŸæ­£è¢«å¢å¼ºçš„æ–¹æ³•    Adviceï¼ˆé€šçŸ¥/ å¢å¼ºï¼‰ï¼šå°è£…å¢å¼ºä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•    Aspectï¼ˆåˆ‡é¢ï¼‰ï¼šåˆ‡ç‚¹ + é€šçŸ¥    Weavingï¼ˆç»‡å…¥ï¼‰ï¼šå°†åˆ‡ç‚¹ä¸é€šçŸ¥ç»“åˆï¼Œäº§ç”Ÿä»£ç†å¯¹è±¡çš„è¿‡ç¨‹</code></pre><p><br></p><h1 class=pgc-h-arrow-right><strong>åŸºäº XML çš„ AOP å¼€å‘</strong></h1><h1 class=pgc-h-arrow-right><strong>å¿«é€Ÿå…¥é—¨</strong></h1><p>å¿«é€Ÿå…¥é—¨ï¼š</p><ol start=1><li>åˆ›å»º java é¡¹ç›®ï¼Œå¯¼å…¥ AOP ç›¸å…³åº§æ ‡</li><li>åˆ›å»ºç›®æ ‡æ¥å£å’Œç›®æ ‡å®ç°ç±»ï¼ˆå®šä¹‰åˆ‡å…¥ç‚¹ï¼‰</li><li>åˆ›å»ºé€šçŸ¥ç±»åŠæ–¹æ³•ï¼ˆå®šä¹‰é€šçŸ¥ï¼‰</li><li>å°†ç›®æ ‡ç±»å’Œé€šçŸ¥ç±»å¯¹è±¡åˆ›å»ºæƒäº¤ç»™ spring</li><li>åœ¨æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­é…ç½®ç»‡å…¥å…³ç³»ï¼ŒåŠåˆ‡é¢</li><li>ç¼–å†™æµ‹è¯•ä»£ç </li></ol><h1 class=pgc-h-arrow-right><strong>åˆ›å»º java é¡¹ç›®ï¼Œå¯¼å…¥ AOP ç›¸å…³åº§æ ‡</strong></h1><pre><code>&lt;properties&gt;    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;    &lt;maven.compiler.encoding&gt;UTF-8&lt;/maven.compiler.encoding&gt;    &lt;java.version&gt;1.11&lt;/java.version&gt;    &lt;maven.compiler.source&gt;1.11&lt;/maven.compiler.source&gt;    &lt;maven.compiler.target&gt;1.11&lt;/maven.compiler.target&gt;&lt;/properties&gt;&lt;dependencies&gt;    &lt;!-- å¯¼å…¥ spring çš„ context åº§æ ‡ï¼Œcontext ä¾èµ– aop --&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework&lt;/groupId&gt;        &lt;artifactId&gt;spring-context&lt;/artifactId&gt;        &lt;version&gt;5.1.5.RELEASE&lt;/version&gt;    &lt;/dependency&gt;    &lt;!-- aspectj çš„ç»‡å…¥ï¼ˆåˆ‡ç‚¹è¡¨è¾¾å¼éœ€è¦ç”¨åˆ°è¯¥ jar åŒ…ï¼‰ --&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.aspectj&lt;/groupId&gt;        &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;        &lt;version&gt;1.8.13&lt;/version&gt;    &lt;/dependency&gt;    &lt;!-- spring æ•´åˆ junit --&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework&lt;/groupId&gt;        &lt;artifactId&gt;spring-test&lt;/artifactId&gt;        &lt;version&gt;5.1.5.RELEASE&lt;/version&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;junit&lt;/groupId&gt;        &lt;artifactId&gt;junit&lt;/artifactId&gt;        &lt;version&gt;4.12&lt;/version&gt;    &lt;/dependency&gt;&lt;/dependencies&gt;</code></pre><h1 class=pgc-h-arrow-right><strong>åˆ›å»ºç›®æ ‡æ¥å£å’Œç›®æ ‡å®ç°ç±»</strong></h1><pre><code>public interface AccountService {    /**     * ç›®æ ‡æ–¹æ³•ï¼šï¼ˆåˆ‡å…¥ç‚¹ï¼šè¦è¿›è¡Œæ‹¦æˆªå¢å¼ºçš„æ–¹æ³•ï¼‰     */    void transfer();}public class AccountServiceImpl implements AccountService {    @Override    public void transfer() {        System.out.println("è½¬è´¦æ–¹æ³•æ‰§è¡Œäº†....");        //int i = 1/0;    }}</code></pre><h1 class=pgc-h-arrow-right><strong>åˆ›å»ºé€šçŸ¥ç±»</strong></h1><pre><code>public class MyAdvice {    public void before(){        System.out.println("å‰ç½®é€šçŸ¥æ‰§è¡Œäº†....");    }}</code></pre><h1 class=pgc-h-arrow-right><strong>å°†ç›®æ ‡ç±»å’Œé€šçŸ¥ç±»å¯¹è±¡åˆ›å»ºæƒäº¤ç»™ spring</strong></h1><pre><code>&lt;!-- ç›®æ ‡ç±»äº¤ç»™ IOC å®¹å™¨ --&gt;&lt;bean id="accountServcie" class="com.renda.service.impl.AccountServiceImpl"/&gt;&lt;!-- é€šçŸ¥ç±»äº¤ç»™ IOC å®¹å™¨ --&gt;&lt;bean id="myAdvice" class="com.renda.advice.MyAdvice"/&gt;</code></pre><h1 class=pgc-h-arrow-right><strong>åœ¨æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­é…ç½®ç»‡å…¥å…³ç³»ï¼ŒåŠåˆ‡é¢</strong></h1><p>å¯¼å…¥ AOP å‘½åç©ºé—´</p><pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;beans xmlns="http://www.springframework.org/schema/beans"       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"       xmlns:aop="http://www.springframework.org/schema/aop"       xsi:schemaLocation="http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://www.springframework.org/schema/aop        http://www.springframework.org/schema/aop/spring-aop.xsd"&gt;        &lt;bean id="accountServcie" class="com.renda.service.impl.AccountServiceImpl"/&gt;        &lt;bean id="myAdvice" class="com.renda.advice.MyAdvice"/&gt;        &lt;aop:config&gt;        &lt;aop:aspect ref="myAdvice"&gt;            &lt;aop:before method="before" pointcut="execution(public void com.renda.service.impl.AccountServiceImpl.transfer())"/&gt;        &lt;/aop:aspect&gt;    &lt;/aop:config&gt;â€‹&lt;/beans&gt;</code></pre><h1 class=pgc-h-arrow-right><strong>ç¼–å†™æµ‹è¯•ä»£ç </strong></h1><pre><code>@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration({"classpath:applicationContext.xml"})public class AccountServiceTest {    @Autowired    private AccountService accountService;â€‹    @Test    public void testTransfer() {        accountService.transfer();    }}</code></pre><h1 class=pgc-h-arrow-right><strong>XML é…ç½® AOP è¯¦è§£</strong></h1><h1 class=pgc-h-arrow-right><strong>åˆ‡ç‚¹è¡¨è¾¾å¼</strong></h1><p>è¡¨è¾¾å¼è¯­æ³•ï¼š</p><ul><li>è®¿é—®ä¿®é¥°ç¬¦å¯ä»¥çœç•¥</li><li>è¿”å›å€¼ç±»å‹ã€åŒ…åã€ç±»åã€æ–¹æ³•åå¯ä»¥ä½¿ç”¨æ˜Ÿå· * ä»£æ›¿ï¼Œä»£è¡¨ä»»æ„</li><li>åŒ…åä¸ç±»åä¹‹é—´ä¸€ä¸ªç‚¹ . ä»£è¡¨å½“å‰åŒ…ä¸‹çš„ç±»ï¼Œä¸¤ä¸ªç‚¹ .. è¡¨ç¤ºå½“å‰åŒ…åŠå…¶å­åŒ…ä¸‹çš„ç±»</li><li>å‚æ•°åˆ—è¡¨å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªç‚¹ .. è¡¨ç¤ºä»»æ„ä¸ªæ•°ï¼Œä»»æ„ç±»å‹çš„å‚æ•°åˆ—è¡¨</li></ul><p>ä¾‹å­ï¼š</p><pre><code>- execution([ä¿®é¥°ç¬¦] è¿”å›å€¼ç±»å‹ åŒ…å.ç±»å.æ–¹æ³•å(å‚æ•°))execution(public void com.renda.service.impl.AccountServiceImpl.transfer(java.lang.String))- è®¿é—®ä¿®é¥°ç¬¦å¯ä»¥çœç•¥execution(void com.renda.service.impl.AccountServiceImpl.transfer(java.lang.String))- è¿”å›å€¼ç±»å‹ã€åŒ…åã€ç±»åã€æ–¹æ³•åå¯ä»¥ä½¿ç”¨æ˜Ÿå· * ä»£æ›¿ï¼Œä»£è¡¨ä»»æ„execution(* *.*.*.*.*.*())- åŒ…åä¸ç±»åä¹‹é—´ä¸€ä¸ªç‚¹ . ä»£è¡¨å½“å‰åŒ…ä¸‹çš„ç±»ï¼Œä¸¤ä¸ªç‚¹ .. è¡¨ç¤ºå½“å‰åŒ…åŠå…¶å­åŒ…ä¸‹çš„ç±»execution(* *..*.*())- å‚æ•°åˆ—è¡¨å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªç‚¹ .. è¡¨ç¤ºä»»æ„ä¸ªæ•°ï¼Œä»»æ„ç±»å‹çš„å‚æ•°åˆ—è¡¨execution(* *..*.*(..))</code></pre><p>åˆ‡ç‚¹è¡¨è¾¾å¼æŠ½å–ï¼šå½“å¤šä¸ªå¢å¼ºçš„åˆ‡ç‚¹è¡¨è¾¾å¼ç›¸åŒæ—¶ï¼Œå¯ä»¥å°†åˆ‡ç‚¹è¡¨è¾¾å¼è¿›è¡ŒæŠ½å–ï¼Œåœ¨å¢å¼ºä¸­ä½¿ç”¨ pointcut-ref å±æ€§ä»£æ›¿ pointcut å±æ€§æ¥å¼•ç”¨æŠ½å–åçš„åˆ‡ç‚¹è¡¨è¾¾å¼ã€‚</p><pre><code>public class MyAdvice {    public void before(){        System.out.println("å‰ç½®é€šçŸ¥æ‰§è¡Œäº†....");    }    public void afterReturning(){        System.out.println("åç½®é€šçŸ¥æ‰§è¡Œäº†....");    }    public void afterThrowing(){        System.out.println("å¼‚å¸¸é€šçŸ¥æ‰§è¡Œäº†....");    }    public void after(){        System.out.println("æœ€ç»ˆé€šçŸ¥æ‰§è¡Œäº†....");    }    /**     * @param pjp Proceeding JoinPoint - æ­£åœ¨æ‰§è¡Œçš„è¿æ¥ç‚¹ï¼šåˆ‡ç‚¹     */    public Object around(ProceedingJoinPoint pjp){        Object proceed = null;        try {            System.out.println("å‰ç½®é€šçŸ¥æ‰§è¡Œäº†");            // åˆ‡ç‚¹æ–¹æ³•æ‰§è¡Œ            proceed = pjp.proceed();            System.out.println("åç½®é€šçŸ¥æ‰§è¡Œäº†");        } catch (Throwable throwable) {            throwable.printStackTrace();            System.out.println("å¼‚å¸¸é€šçŸ¥æ‰§è¡Œäº†");        }finally {            System.out.println("æœ€ç»ˆé€šçŸ¥æ‰§è¡Œäº†");        }        return proceed;    }}&lt;aop:config&gt;    &lt;!-- æŠ½å–çš„åˆ‡ç‚¹è¡¨è¾¾å¼ --&gt;    &lt;aop:pointcut id="myPointcut" expression="execution(* com.renda.service.impl.AccountServiceImpl.*(..))"/&gt;    &lt;!-- é…ç½®åˆ‡é¢ï¼šåˆ‡å…¥ç‚¹ + é€šçŸ¥ --&gt;    &lt;aop:aspect ref="myAdvice"&gt;        &lt;aop:before method="before" pointcut-ref="myPointcut"/&gt;        &lt;aop:after-returning method="afterReturning" pointcut-ref="myPointcut"/&gt;        &lt;aop:after-throwing method="afterThrowing" pointcut-ref="myPointcut"/&gt;        &lt;aop:after method="after" pointcut-ref="myPointcut"/&gt;        &lt;!-- &lt;aop:around method="around" pointcut-ref="myPointcut"/&gt; --&gt;    &lt;/aop:aspect&gt;&lt;/aop:config&gt;</code></pre><h1 class=pgc-h-arrow-right><strong>é€šçŸ¥ç±»å‹</strong></h1><p>é€šçŸ¥çš„é…ç½®è¯­æ³•ï¼š</p><pre><code>&lt;aop:é€šçŸ¥ç±»å‹ method=â€œé€šçŸ¥ç±»ä¸­æ–¹æ³•åâ€ pointcut=â€œåˆ‡ç‚¹è¡¨è¾¾å¼"&gt;&lt;/aop:é€šçŸ¥ç±»å‹&gt;</code></pre><ul><li>å‰ç½®é€šçŸ¥ &lt;aop:before> - ç”¨äºé…ç½®å‰ç½®é€šçŸ¥ã€‚æŒ‡å®šå¢å¼ºçš„æ–¹æ³•åœ¨åˆ‡å…¥ç‚¹æ–¹æ³•ä¹‹å‰æ‰§è¡Œ</li><li>åç½®é€šçŸ¥ &lt;aop:afterReturning> - ç”¨äºé…ç½®åç½®é€šçŸ¥ã€‚æŒ‡å®šå¢å¼ºçš„æ–¹æ³•åœ¨åˆ‡å…¥ç‚¹æ–¹æ³•ä¹‹åæ‰§è¡Œ</li><li>å¼‚å¸¸é€šçŸ¥ &lt;aop:afterThrowing> - ç”¨äºé…ç½®å¼‚å¸¸é€šçŸ¥ï¼›æŒ‡å®šå¢å¼ºçš„æ–¹æ³•å‡ºç°å¼‚å¸¸åæ‰§è¡Œ</li><li>æœ€ç»ˆé€šçŸ¥ &lt;aop:after> - ç”¨äºé…ç½®æœ€ç»ˆé€šçŸ¥ï¼›æ— è®ºåˆ‡å…¥ç‚¹æ–¹æ³•æ‰§è¡Œæ—¶æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œéƒ½ä¼šæ‰§è¡Œ</li><li>ç¯ç»•é€šçŸ¥ &lt;aop:around> - ç”¨äºé…ç½®ç¯ç»•é€šçŸ¥ï¼›å¼€å‘è€…å¯ä»¥æ‰‹åŠ¨æ§åˆ¶å¢å¼ºä»£ç åœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œ</li></ul><p>æ³¨æ„ï¼šé€šå¸¸æƒ…å†µä¸‹ï¼Œç¯ç»•é€šçŸ¥éƒ½æ˜¯ç‹¬ç«‹ä½¿ç”¨çš„</p><h1 class=pgc-h-arrow-right><strong>å°ç»“</strong></h1><pre><code>* aop ç»‡å…¥çš„é…ç½®    &lt;aop:config&gt;        &lt;aop:aspect ref=â€œé€šçŸ¥ç±»â€&gt;        &lt;aop:before method=â€œé€šçŸ¥æ–¹æ³•åç§°â€ pointcut=â€œåˆ‡ç‚¹è¡¨è¾¾å¼"&gt;&lt;/aop:before&gt;        &lt;/aop:aspect&gt;    &lt;/aop:config&gt;                                                        * é€šçŸ¥çš„ç±»å‹    å‰ç½®é€šçŸ¥ã€åç½®é€šçŸ¥ã€å¼‚å¸¸é€šçŸ¥ã€æœ€ç»ˆé€šçŸ¥    ç¯ç»•é€šçŸ¥    * åˆ‡ç‚¹è¡¨è¾¾å¼    execution([ä¿®é¥°ç¬¦] è¿”å›å€¼ç±»å‹ åŒ…å.ç±»å.æ–¹æ³•å(å‚æ•°))</code></pre><p><br></p><h1 class=pgc-h-arrow-right><strong>åŸºäºæ³¨è§£çš„ AOP å¼€å‘</strong></h1><h1 class=pgc-h-arrow-right><strong>å¿«é€Ÿå…¥é—¨</strong></h1><p>æ­¥éª¤åˆ†æï¼š</p><ol start=1><li>åˆ›å»º java é¡¹ç›®ï¼Œå¯¼å…¥ AOP ç›¸å…³åº§æ ‡</li><li>åˆ›å»ºç›®æ ‡æ¥å£å’Œç›®æ ‡å®ç°ç±»ï¼ˆå®šä¹‰åˆ‡å…¥ç‚¹ï¼‰</li><li>åˆ›å»ºé€šçŸ¥ç±»ï¼ˆå®šä¹‰é€šçŸ¥ï¼‰</li><li>å°†ç›®æ ‡ç±»å’Œé€šçŸ¥ç±»å¯¹è±¡åˆ›å»ºæƒäº¤ç»™ spring</li><li>åœ¨é€šçŸ¥ç±»ä¸­ä½¿ç”¨æ³¨è§£é…ç½®ç»‡å…¥å…³ç³»ï¼Œå‡çº§ä¸ºåˆ‡é¢ç±»</li><li>åœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯ç»„ä»¶æ‰«æå’Œ AOP çš„è‡ªåŠ¨ä»£ç†</li><li>ç¼–å†™æµ‹è¯•ä»£ç </li></ol><h1 class=pgc-h-arrow-right><strong>åˆ›å»º java é¡¹ç›®ï¼Œå¯¼å…¥ AOP ç›¸å…³åº§æ ‡</strong></h1><pre><code>&lt;properties&gt;    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;    &lt;maven.compiler.encoding&gt;UTF-8&lt;/maven.compiler.encoding&gt;    &lt;java.version&gt;1.11&lt;/java.version&gt;    &lt;maven.compiler.source&gt;1.11&lt;/maven.compiler.source&gt;    &lt;maven.compiler.target&gt;1.11&lt;/maven.compiler.target&gt;&lt;/properties&gt;&lt;dependencies&gt;    &lt;!-- å¯¼å…¥ spring çš„ context åº§æ ‡ï¼Œcontext ä¾èµ– aop --&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework&lt;/groupId&gt;        &lt;artifactId&gt;spring-context&lt;/artifactId&gt;        &lt;version&gt;5.1.5.RELEASE&lt;/version&gt;    &lt;/dependency&gt;    &lt;!-- aspectj çš„ç»‡å…¥ --&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.aspectj&lt;/groupId&gt;        &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;        &lt;version&gt;1.8.13&lt;/version&gt;    &lt;/dependency&gt;    &lt;!-- spring æ•´åˆ junit --&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework&lt;/groupId&gt;        &lt;artifactId&gt;spring-test&lt;/artifactId&gt;        &lt;version&gt;5.1.5.RELEASE&lt;/version&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;junit&lt;/groupId&gt;        &lt;artifactId&gt;junit&lt;/artifactId&gt;        &lt;version&gt;4.12&lt;/version&gt;    &lt;/dependency&gt;&lt;/dependencies&gt;</code></pre><h1 class=pgc-h-arrow-right><strong>åˆ›å»ºç›®æ ‡æ¥å£å’Œç›®æ ‡å®ç°ç±»</strong></h1><pre><code>public interface AccountService {    void transfer();}public class AccountServiceImpl implements AccountService {    @Override    public void transfer() {        System.out.println("è½¬è´¦æ–¹æ³•æ‰§è¡Œäº†....");    }}</code></pre><h1 class=pgc-h-arrow-right><strong>åˆ›å»ºé€šçŸ¥ç±»</strong></h1><pre><code>public class MyAdvice {    public void before(){        System.out.println("å‰ç½®é€šçŸ¥æ‰§è¡Œäº†....");    }}</code></pre><h1 class=pgc-h-arrow-right><strong>å°†ç›®æ ‡ç±»å’Œé€šçŸ¥ç±»å¯¹è±¡åˆ›å»ºæƒäº¤ç»™ spring</strong></h1><pre><code>@Servicepublic class AccountServiceImpl implements AccountService {    @Override    public void transfer() {        System.out.println("è½¬è´¦æ–¹æ³•æ‰§è¡Œäº†....");    }}@Componentpublic class MyAdvice {    ...}</code></pre><h1 class=pgc-h-arrow-right><strong>åœ¨é€šçŸ¥ç±»ä¸­ä½¿ç”¨æ³¨è§£é…ç½®ç»‡å…¥å…³ç³»ï¼Œå‡çº§ä¸ºåˆ‡é¢ç±»</strong></h1><pre><code>@Component@Aspect // å‡çº§ä¸ºåˆ‡é¢ç±»ï¼šé…ç½®åˆ‡å…¥ç‚¹å’Œé€šçŸ¥çš„å…³ç³»public class MyAdvice {    @Before("execution(* com.renda.service.impl.AccountServiceImpl.*(..))")    public void before(){        System.out.println("å‰ç½®é€šçŸ¥æ‰§è¡Œäº†....");    }}</code></pre><h1 class=pgc-h-arrow-right><strong>åœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯ç»„ä»¶æ‰«æå’Œ AOP çš„è‡ªåŠ¨ä»£ç†</strong></h1><pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;beans xmlns="http://www.springframework.org/schema/beans"       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"       xmlns:aop="http://www.springframework.org/schema/aop"       xmlns:context="http://www.springframework.org/schema/context"       xsi:schemaLocation="http://www.springframework.org/schema/beans		http://www.springframework.org/schema/beans/spring-beans.xsd		http://www.springframework.org/schema/aop		http://www.springframework.org/schema/aop/spring-aop.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"&gt;    &lt;!-- å¼€å¯ IOC æ³¨è§£æ‰«æ --&gt;    &lt;context:component-scan base-package="com.renda"/&gt;    &lt;!-- aop çš„è‡ªåŠ¨ä»£ç†ï¼šé‡‡ç”¨åŠ¨æ€ä»£ç†å®Œæˆç»‡å…¥å¢å¼ºï¼Œå¹¶ä¸”ç”Ÿæˆä»£ç†ï¼›proxy-target-class="true" è¡¨ç¤ºå¼ºåˆ¶ä½¿ç”¨ cglib åŠ¨æ€ä»£ç†--&gt;    &lt;aop:aspectj-autoproxy proxy-target-class="false"/&gt;&lt;/beans&gt;</code></pre><h1 class=pgc-h-arrow-right><strong>ç¼–å†™æµ‹è¯•ä»£ç </strong></h1><pre><code>@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration("classpath:applicationContext.xml")public class AccountServiceTest {    @Autowired    private AccountService accountService;    @Test    public void testTransfer(){        accountService.transfer();    }}</code></pre><h1 class=pgc-h-arrow-right><strong>æ³¨è§£é…ç½® AOP è¯¦è§£</strong></h1><h1 class=pgc-h-arrow-right><strong>åˆ‡ç‚¹è¡¨è¾¾å¼</strong></h1><p>åˆ‡ç‚¹è¡¨è¾¾å¼çš„æŠ½å–</p><pre><code>@Component@Aspect // å‡çº§ä¸ºåˆ‡é¢ç±»ï¼šé…ç½®åˆ‡å…¥ç‚¹å’Œé€šçŸ¥çš„å…³ç³»public class MyAdvice {    @Pointcut("execution(* com.renda.service.impl.AccountServiceImpl.*(..))")    public void myPoint(){    }    @Before("MyAdvice.myPoint()")    public void before(){        System.out.println("å‰ç½®é€šçŸ¥æ‰§è¡Œäº†....");    }    @AfterReturning("MyAdvice.myPoint()")    public void afterReturning(){        System.out.println("åç½®é€šçŸ¥æ‰§è¡Œäº†....");    }    @AfterThrowing("MyAdvice.myPoint()")    public void afterThrowing(){        System.out.println("å¼‚å¸¸é€šçŸ¥æ‰§è¡Œäº†....");    }    @After("MyAdvice.myPoint()")    public void after(){        System.out.println("æœ€ç»ˆé€šçŸ¥æ‰§è¡Œäº†....");    }    /**     * @param pjp Proceeding JoinPoint - æ­£åœ¨æ‰§è¡Œçš„è¿æ¥ç‚¹ï¼šåˆ‡ç‚¹     */    public Object around(ProceedingJoinPoint pjp){        Object proceed = null;        try {            System.out.println("å‰ç½®é€šçŸ¥æ‰§è¡Œäº†");            // åˆ‡ç‚¹æ–¹æ³•æ‰§è¡Œ            proceed = pjp.proceed();            System.out.println("åç½®é€šçŸ¥æ‰§è¡Œäº†");        } catch (Throwable throwable) {            throwable.printStackTrace();            System.out.println("å¼‚å¸¸é€šçŸ¥æ‰§è¡Œäº†");        }finally {            System.out.println("æœ€ç»ˆé€šçŸ¥æ‰§è¡Œäº†");        }        return proceed;    }}</code></pre><h1 class=pgc-h-arrow-right><strong>é€šçŸ¥ç±»å‹</strong></h1><p>é€šçŸ¥çš„é…ç½®è¯­æ³•ï¼š@é€šçŸ¥æ³¨è§£(â€œåˆ‡ç‚¹è¡¨è¾¾å¼")</p><ul><li>å‰ç½®é€šçŸ¥ @Before - ç”¨äºé…ç½®å‰ç½®é€šçŸ¥ï¼›æŒ‡å®šå¢å¼ºçš„æ–¹æ³•åœ¨åˆ‡å…¥ç‚¹æ–¹æ³•ä¹‹å‰æ‰§è¡Œ</li><li>åç½®é€šçŸ¥ @AfterReturning - ç”¨äºé…ç½®åç½®é€šçŸ¥ï¼›æŒ‡å®šå¢å¼ºçš„æ–¹æ³•åœ¨åˆ‡å…¥ç‚¹æ–¹æ³•ä¹‹åæ‰§è¡Œ</li><li>å¼‚å¸¸é€šçŸ¥ @AfterThrowing - ç”¨äºé…ç½®å¼‚å¸¸é€šçŸ¥ï¼›æŒ‡å®šå¢å¼ºçš„æ–¹æ³•å‡ºç°å¼‚å¸¸åæ‰§è¡Œ</li><li>æœ€ç»ˆé€šçŸ¥ @After - ç”¨äºé…ç½®æœ€ç»ˆé€šçŸ¥ï¼›æ— è®ºåˆ‡å…¥ç‚¹æ–¹æ³•æ‰§è¡Œæ—¶æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œéƒ½ä¼šæ‰§è¡Œ</li><li>ç¯ç»•é€šçŸ¥ @Around - ç”¨äºé…ç½®ç¯ç»•é€šçŸ¥ï¼›å¼€å‘è€…å¯ä»¥æ‰‹åŠ¨æ§åˆ¶å¢å¼ºä»£ç åœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œ</li></ul><h1 class=pgc-h-arrow-right><strong>æ³¨æ„</strong></h1><p>å½“å‰å››ä¸ªé€šçŸ¥ç»„åˆåœ¨ä¸€èµ·æ—¶ï¼Œå‡ºç°ä¸€ä¸ª Spring çš„æ‰§è¡Œé¡ºåºçš„ Bugï¼Œé”™è¯¯çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š</p><pre><code>@Before -&gt; @After -&gt; @AfterReturningï¼ˆå¦‚æœæœ‰å¼‚å¸¸ï¼š@AfterThrowingï¼‰</code></pre><p>å¦‚æœå•ç‹¬ä½¿ç”¨ç¯ç»•é€šçŸ¥ @Around æ³¨è§£åˆ™ä¸ä¼šæœ‰è¿™ä¸ª Bugï¼Œæ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š</p><pre><code>@Before -&gt; @AfterReturningï¼ˆå¦‚æœæœ‰å¼‚å¸¸ï¼š@AfterThrowingï¼‰-&gt; @After</code></pre><h1 class=pgc-h-arrow-right><strong>çº¯æ³¨è§£é…ç½®</strong></h1><p>å»æ‰ applicationContext.xml é…ç½®æ–‡ä»¶ï¼Œå¢åŠ  SpringConfig é…ç½®ç±»</p><pre><code>@Configuration@ComponentScan("com.renda")@EnableAspectJAutoProxy // å¼€å¯ AOP çš„è‡ªåŠ¨ä»£ç†ï¼Œæ›¿ä»£ xml é…ç½®çš„ &lt;aop:aspectj-autoproxy /&gt;public class SpringConfig {}</code></pre><p>ä¿®æ”¹æµ‹è¯•ç±»</p><pre><code>@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(classes = SpringConfig.class)public class AccountServiceTest {â€‹    @Autowired    private AccountService accountService;â€‹    @Test    public void testTransfer(){        accountService.transfer();    }â€‹}</code></pre><h1 class=pgc-h-arrow-right><strong>çŸ¥è¯†å°ç»“</strong></h1><pre><code>* ä½¿ç”¨ @Aspect æ³¨è§£ï¼Œæ ‡æ³¨åˆ‡é¢ç±»* ä½¿ç”¨ @Before ç­‰æ³¨è§£ï¼Œæ ‡æ³¨é€šçŸ¥æ–¹æ³•* ä½¿ç”¨ @Pointcut æ³¨è§£ï¼ŒæŠ½å–åˆ‡ç‚¹è¡¨è¾¾å¼* é…ç½® aop è‡ªåŠ¨ä»£ç† &lt;aop:aspectj-autoproxy/&gt; æˆ– @EnableAspectJAutoProxy</code></pre><p><br></p><h1 class=pgc-h-arrow-right><strong>AOP ä¼˜åŒ–è½¬è´¦æ¡ˆä¾‹</strong></h1><p>ä¾ç„¶ä½¿ç”¨å‰é¢çš„è½¬è´¦æ¡ˆä¾‹ï¼Œå°†ä¸¤ä¸ªä»£ç†å·¥å‚å¯¹è±¡ç›´æ¥åˆ é™¤ï¼Œæ”¹ä¸º spring çš„ AOP æ€æƒ³æ¥å®ç°</p><h1 class=pgc-h-arrow-right><strong>xml é…ç½®å®ç°</strong></h1><h1 class=pgc-h-arrow-right><strong>é…ç½®æ–‡ä»¶</strong></h1><pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;beans xmlns="http://www.springframework.org/schema/beans"       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"       xmlns:context="http://www.springframework.org/schema/context"       xmlns:aop="http://www.springframework.org/schema/aop"       xsi:schemaLocation="       	http://www.springframework.org/schema/beans		http://www.springframework.org/schema/beans/spring-beans.xsd       	http://www.springframework.org/schema/context		http://www.springframework.org/schema/context/spring-context.xsd		http://www.springframework.org/schema/aop		http://www.springframework.org/schema/aop/spring-aop.xsd"&gt;    &lt;!-- å¼€å¯æ³¨è§£æ‰«æ --&gt;    &lt;context:component-scan base-package="com.renda"/&gt;    &lt;!-- å¼•å…¥ properties --&gt;    &lt;context:property-placeholder location="classpath:jdbc.properties"/&gt;    &lt;!-- é…ç½® DataSource --&gt;    &lt;bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource"&gt;        &lt;property name="driverClassName" value="${jdbc.driverClassName}"/&gt;        &lt;property name="url" value="${jdbc.url}"/&gt;        &lt;property name="username" value="${jdbc.username}"/&gt;        &lt;property name="password" value="${jdbc.password}"/&gt;    &lt;/bean&gt;    &lt;!-- é…ç½® queryRunner --&gt;    &lt;bean id="queryRunner" class="org.apache.commons.dbutils.QueryRunner"&gt;        &lt;constructor-arg name="ds" ref="dataSource"/&gt;    &lt;/bean&gt;    &lt;!-- AOP é…ç½® --&gt;      &lt;aop:config&gt;          &lt;!-- 1.åˆ‡ç‚¹è¡¨è¾¾å¼ --&gt;          &lt;aop:pointcut id="myPointcut" expression="execution(* com.renda.service.impl.AccountServiceImpl.*(..))"/&gt;          &lt;!-- 2.åˆ‡é¢é…ç½® --&gt;          &lt;aop:aspect ref="transactionManager"&gt;              &lt;aop:before method="beginTransaction" pointcut-ref="myPointcut"/&gt;              &lt;aop:after-returning method="commit"  pointcut-ref="myPointcut"/&gt;              &lt;aop:after-throwing method="rollback" pointcut-ref="myPointcut"/&gt;              &lt;aop:after method="release" pointcut-ref="myPointcut"/&gt;          &lt;/aop:aspect&gt;      &lt;/aop:config&gt;&lt;/beans&gt;</code></pre><h1 class=pgc-h-arrow-right><strong>äº‹åŠ¡ç®¡ç†å™¨ï¼ˆé€šçŸ¥ï¼‰</strong></h1><pre><code>package com.renda.utils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;import java.sql.Connection;import java.sql.SQLException;/** * äº‹åŠ¡ç®¡ç†å™¨å·¥å…·ç±»ï¼šåŒ…å«ï¼šå¼€å¯äº‹åŠ¡ã€æäº¤äº‹åŠ¡ã€å›æ»šäº‹åŠ¡ã€é‡Šæ”¾èµ„æº *      Spring AOP çš„é€šçŸ¥ç±» * * @author Renda Zhang * @create 2020-09-04 15:31 */@Component("transactionManager")public class TransactionManager {    @Autowired    private ConnectionUtils connectionUtils;    /**     * å¼€å¯äº‹åŠ¡     */    public void beginTransaction(){        // è·å– connection å¯¹è±¡        Connection connection = connectionUtils.getThreadConnection();        try {            // å¼€å¯äº†ä¸€ä¸ªæ‰‹åŠ¨äº‹åŠ¡            connection.setAutoCommit(false);            System.out.println("å¼€å¯äº‹åŠ¡");        } catch (SQLException e) {            e.printStackTrace();        }    }    /**     * æäº¤äº‹åŠ¡     */    public void commit(){        Connection connection = connectionUtils.getThreadConnection();        try {            connection.commit();            System.out.println("æäº¤äº‹åŠ¡");        } catch (SQLException e) {            e.printStackTrace();        }    }    /**     * å›æ»šäº‹åŠ¡     */    public void rollback(){        Connection connection = connectionUtils.getThreadConnection();        try {            connection.rollback();            System.out.println("å›æ»šäº‹åŠ¡");        } catch (SQLException e) {            e.printStackTrace();        }    }    /**     * é‡Šæ”¾èµ„æº     */    public void release(){        // å°†æ‰‹åŠ¨äº‹åŠ¡æ”¹å›æˆè‡ªåŠ¨æäº¤äº‹åŠ¡        Connection connection = connectionUtils.getThreadConnection();        try {            connection.setAutoCommit(true);            // å°†è¿æ¥å½’è¿˜åˆ°è¿æ¥æ±             connectionUtils.getThreadConnection().close();            // è§£é™¤çº¿ç¨‹ç»‘å®š            connectionUtils.removeThreadConnection();            System.out.println("é‡Šæ”¾èµ„æº");        } catch (SQLException e) {            e.printStackTrace();        }    }}</code></pre><h1 class=pgc-h-arrow-right><strong>æ³¨è§£é…ç½®å®ç°</strong></h1><h1 class=pgc-h-arrow-right><strong>é…ç½®æ–‡ä»¶</strong></h1><pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;beans xmlns="http://www.springframework.org/schema/beans"       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"       xmlns:context="http://www.springframework.org/schema/context"       xmlns:aop="http://www.springframework.org/schema/aop"       xsi:schemaLocation="        http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://www.springframework.org/schema/context        http://www.springframework.org/schema/context/spring-context.xsd        http://www.springframework.org/schema/aop        http://www.springframework.org/schema/aop/spring-aop.xsd"&gt;â€‹    &lt;!-- å¼€å¯æ³¨è§£æ‰«æ --&gt;    &lt;context:component-scan base-package="com.renda"/&gt;â€‹    &lt;!-- å¼•å…¥ properties --&gt;    &lt;context:property-placeholder location="classpath:jdbc.properties"/&gt;â€‹    &lt;!-- é…ç½® DataSource --&gt;    &lt;bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource"&gt;        &lt;property name="driverClassName" value="${jdbc.driverClassName}"/&gt;        &lt;property name="url" value="${jdbc.url}"/&gt;        &lt;property name="username" value="${jdbc.username}"/&gt;        &lt;property name="password" value="${jdbc.password}"/&gt;    &lt;/bean&gt;â€‹    &lt;!-- é…ç½® queryRunner --&gt;    &lt;bean id="queryRunner" class="org.apache.commons.dbutils.QueryRunner"&gt;        &lt;constructor-arg name="ds" ref="dataSource"/&gt;    &lt;/bean&gt;â€‹    &lt;!-- å¼€å¯ AOP çš„è‡ªåŠ¨ä»£ç† --&gt;    &lt;aop:aspectj-autoproxy/&gt;â€‹&lt;/beans&gt;</code></pre><h1 class=pgc-h-arrow-right><strong>äº‹åŠ¡ç®¡ç†å™¨ï¼ˆé€šçŸ¥ï¼‰</strong></h1><pre><code>@Component("transactionManager")@Aspect // è¡¨æ˜è¯¥ç±»ä¸ºåˆ‡é¢ç±»public class TransactionManager {    @Autowired    private ConnectionUtils connectionUtils;â€‹    @Around("execution(* com.renda.service.impl.AccountServiceImpl.*(..))")    public Object around(ProceedingJoinPoint pjp) throws SQLException {        Object proceed = null;â€‹        try {            // å¼€å¯æ‰‹åŠ¨äº‹åŠ¡            System.out.println("å¼€å¯äº‹åŠ¡");            connectionUtils.getThreadConnection().setAutoCommit(false);â€‹            // åˆ‡å…¥ç‚¹æ–¹æ³•æ‰§è¡Œ            proceed = pjp.proceed();â€‹            // æ‰‹åŠ¨æäº¤äº‹åŠ¡            System.out.println("æäº¤äº‹åŠ¡");            connectionUtils.getThreadConnection().commit();        } catch (Throwable throwable) {            throwable.printStackTrace();            // æ‰‹åŠ¨å›æ»šäº‹åŠ¡            System.out.println("å›æ»šäº‹åŠ¡");            connectionUtils.getThreadConnection().rollback();        } finally {            System.out.println("é‡Šæ”¾èµ„æº");            // å°†æ‰‹åŠ¨äº‹åŠ¡æ¢å¤æˆè‡ªåŠ¨äº‹åŠ¡            connectionUtils.getThreadConnection().setAutoCommit(true);            // å°†è¿æ¥å½’è¿˜åˆ°è¿æ¥æ±             connectionUtils.getThreadConnection().close();            // è§£é™¤çº¿ç¨‹ç»‘å®š            connectionUtils.removeThreadConnection();        }â€‹        return proceed;    }}</code></pre><blockquote class=pgc-blockquote-abstract><p>æƒ³äº†è§£æ›´å¤šï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼šRenda_Zhang</p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Spring','AOP','ç¼–ç¨‹'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../cn/%E7%A7%91%E6%8A%80/2798be0b.html alt="Spring AOP é¢å‘åˆ‡é¢ç¼–ç¨‹éœ€è¦çŸ¥é“çš„äº‹" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/63832e5a-4ec8-451b-87cf-c6295ac2adf5 style=border-radius:25px></a>
<a href=../../cn/%E7%A7%91%E6%8A%80/2798be0b.html title="Spring AOP é¢å‘åˆ‡é¢ç¼–ç¨‹éœ€è¦çŸ¥é“çš„äº‹">Spring AOP é¢å‘åˆ‡é¢ç¼–ç¨‹éœ€è¦çŸ¥é“çš„äº‹</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>