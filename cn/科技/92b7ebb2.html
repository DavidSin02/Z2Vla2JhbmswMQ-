<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>å¤§æ•°æ®ä¸“å®¶ï¼Œå¯¹Flinkæ‰¹å¤„ç†ç”ŸæˆJobGraphæµç¨‹æ·±å…¥åˆ†æï¼Œå€¼å¾—æ”¶è— | æå®¢å¿«è¨Š</title><meta property="og:title" content="å¤§æ•°æ®ä¸“å®¶ï¼Œå¯¹Flinkæ‰¹å¤„ç†ç”ŸæˆJobGraphæµç¨‹æ·±å…¥åˆ†æï¼Œå€¼å¾—æ”¶è— - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/9c9227424d8f4b52958e32ec1ffdb116"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/92b7ebb2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/92b7ebb2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/92b7ebb2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/92b7ebb2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/92b7ebb2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/92b7ebb2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/92b7ebb2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/92b7ebb2.html><meta property="article:published_time" content="2020-11-14T21:02:46+08:00"><meta property="article:modified_time" content="2020-11-14T21:02:46+08:00"><meta name=Keywords content><meta name=description content="å¤§æ•°æ®ä¸“å®¶ï¼Œå¯¹Flinkæ‰¹å¤„ç†ç”ŸæˆJobGraphæµç¨‹æ·±å…¥åˆ†æï¼Œå€¼å¾—æ”¶è—"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/92b7ebb2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>å¤§æ•°æ®ä¸“å®¶ï¼Œå¯¹Flinkæ‰¹å¤„ç†ç”ŸæˆJobGraphæµç¨‹æ·±å…¥åˆ†æï¼Œå€¼å¾—æ”¶è—</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p>æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªç®€å•çš„æ‰¹é‡å¤„ç†WordCountçš„ç¨‹åºï¼Œæ¥äº†è§£ä¸€ä¸‹ï¼Œåœ¨ç¼–ç¨‹APIå±‚é¢çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠFlinkæ˜¯å¦‚ä½•åŸºäºPipelineé£æ ¼çš„APIå®ç°ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ç¨‹åºçš„ï¼Œè¿˜æœ‰å°±æ˜¯æ¯ä¸€æ­¥æ“ä½œçš„åº•å±‚ï¼Œéƒ½æ˜¯å¦‚ä½•è¿›è¡Œè½¬æ¢çš„ã€‚WordCountç¨‹åºä»£ç ï¼Œç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>final MultipleParameterTool params = MultipleParameterTool.fromArgs(args);final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();env.getConfig().setGlobalJobParameters(params);Â // get input dataDataSet&lt;String&gt; text = env.readTextFile(input);DataSet&lt;Tuple2&lt;String, Integer&gt;&gt; counts =Â Â Â Â Â Â Â Â // split up the lines in pairs (2-tuples) containing: (word,1)Â Â Â Â Â Â Â Â text.flatMap(new Tokenizer())Â Â Â Â Â Â Â Â // group by the tuple field "0" and sum up tuple field "1"Â Â Â Â Â Â Â Â .groupBy(0)Â Â Â Â Â Â Â Â .sum(1);counts.writeAsCsv(params.get("output"), "\n", " ");// execute programenv.execute("WordCount Example");</code></pre><p>ä¸Šè¿°WordCountç¤ºä¾‹ç¨‹åºï¼Œå®ƒåœ¨ç”¨æˆ·ç¼–ç¨‹APIä½¿ç”¨çš„å±‚é¢æ¥çœ‹æ˜¯å‘ˆçº¿æ€§çš„ï¼Œå¯¹åº”ä¸€ä¸ªè®¡ç®—DAGï¼Œæˆ‘ä»¬ä»¥å®ƒä¸ºä¾‹å› ä¸ºçº¿æ€§æ¯”è¾ƒç®€å•ï¼Œæ›´å®¹æ˜“ç†è§£å’Œè¯´æ˜ã€‚é€šè¿‡æŸ¥çœ‹Flinkæºç å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢ç¨‹åºé€šè¿‡è°ƒç”¨ExecutionEnvironmentçš„readTextFile()ã€flatMap()ã€groupBy()ã€sum()ã€writeAsCsv()æ–¹æ³•ï¼Œç”Ÿæˆäº†ä¸€ä¸ªè®¡ç®—Job DAGã€‚è¿™ä¸ªJobå¯ä»¥é€šè¿‡ä¸‹å›¾æ¥å±•ç¤ºFlinkåœ¨High-Level APIå±‚é¢æ˜¯å¦‚ä½•æ˜ å°„åˆ°æˆ‘ä»¬æ‰€è¯´çš„Operatorç»„ä»¶çš„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt=å¤§æ•°æ®ä¸“å®¶ï¼Œå¯¹Flinkæ‰¹å¤„ç†ç”ŸæˆJobGraphæµç¨‹æ·±å…¥åˆ†æï¼Œå€¼å¾—æ”¶è— onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9c9227424d8f4b52958e32ec1ffdb116><p class=pgc-img-caption></p></div><p>ä¸Šå›¾ä¸­ï¼Œç¬¬ä¸€å±‚è“è‰²æ–¹æ¡†è¡¨ç¤ºé€šè¿‡ç”¨æˆ·ç¼–ç¨‹APIè°ƒç”¨æ–¹æ³•åï¼Œè½¬æ¢æˆçš„å„ä¸ªDataSetå¯¹è±¡ï¼Œå®ƒä»¬è¡¨ç¤ºæ¯ç»è¿‡ä¸€ä¸ªè½¬æ¢æ“ä½œï¼Œéƒ½ç”±ä¸€ä¸ªDataSetç”Ÿæˆå¦ä¸€ä¸ªDataSetã€‚é™¤äº†DataSinkå’ŒUnsortedGroupingä»¥å¤–ï¼Œè¿™äº›DataSetéƒ½æ˜¯ä½äºorg.apache.flink.api.java.operatorsåŒ…ä¸‹é¢çš„å®ç°ç±»ã€‚ç¬¬äºŒå±‚çš„é»‘è‰²æ–¹æ¡†è¡¨ç¤ºï¼Œä¸ºäº†èƒ½å¤Ÿè¿›ä¸€æ­¥æ ¡éªŒç”¨æˆ·ç¼–å†™çš„Batch Jobç¨‹åºçš„è§„èŒƒæ€§ï¼Œä»¥åŠè·å–æ›´å¤šæœ‰å…³Dataflowçš„ä¿¡æ¯ï¼ŒåˆæŠ½è±¡å‡ºäº†ä¸€å±‚Operatorè®¾è®¡ï¼Œè¿™ä¸€å±‚Operatorä½äºorg.apache.flink.api.common.operatorsåŒ…ä¸‹é¢ã€‚ä»å·¦å³å‘å³ç®­å¤´è¡¨ç¤ºï¼Œç”¨æˆ·ç¨‹åºå¯¹è¾“å…¥æ•°æ®é›†è¿›è¡Œè½¬æ¢æ“ä½œçš„é¡ºåºï¼›ä»å³å‘å·¦ç®­å¤´è¡¨ç¤ºï¼Œæ¯ç»è¿‡ä¸€æ¬¡è½¬æ¢æ“ä½œç”Ÿæˆä¸€ä¸ªæ–°çš„DataSetï¼Œå®ƒå†…éƒ¨éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆç”¨æ¥æŒ‡å‘ä¸Šä¸€ä¸ªDataSetï¼Œè¿™æ–¹ä¾¿äº†å¯¹å„ä¸ªè½¬æ¢æ“ä½œæ–°ç”Ÿæˆç”ŸæˆDataSetçš„é¡ºåºè¿›è¡Œè·Ÿè¸ªã€‚å…¶å®ï¼ŒFlinkåœ¨æ„å»ºJobGraphçš„è¿‡ç¨‹ä¸­ï¼Œå°±æ˜¯ä»åå‘å‰è¿›è¡Œéå†ï¼Œä¸æ–­å¯¹Jobçš„DAGå›¾ä¸­å„ä¸ªOperatorè¿›è¡Œå¢å¼ºå’Œä¼˜åŒ–ã€‚ä¸‹é¢æˆ‘ä»¬ä¼šå¯¹è¿™ä¸¤å±‚è¿›è¡Œè¯¦ç»†è§£é‡Šè¯´æ˜ã€‚æœ‰å…³DataSetç±»çš„è®¾è®¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt=å¤§æ•°æ®ä¸“å®¶ï¼Œå¯¹Flinkæ‰¹å¤„ç†ç”ŸæˆJobGraphæµç¨‹æ·±å…¥åˆ†æï¼Œå€¼å¾—æ”¶è— onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1346c393ae964d29bcd6088043e89750><p class=pgc-img-caption></p></div><p>å›¾ä¸­å„ä¸ªOperatorçš„å…·ä½“å®ç°ç±»ï¼Œæ˜¯æ„å»ºDAGå›¾æœ€åŸå§‹çš„è¡¨ç¤ºå½¢å¼ï¼Œä»–ä»¬å†…éƒ¨ç›´æ¥å°è£…äº†é€šè¿‡ç¼–ç¨‹APIä¼ å…¥çš„å‡½æ•°ï¼Œæˆ–è€…Flinkå†…éƒ¨ä¸ºå®ŒæˆDAGè€Œå®ç°çš„å†…ç½®å‡½æ•°ã€‚æˆ‘ä»¬ä»¥flatMapä¸ºä¾‹ï¼Œè°ƒç”¨flatMap()ä¼šåˆ›å»ºåä¸ºFlatMapOperatorçš„DataSetï¼Œå…·ä½“å®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>public &lt;R&gt; FlatMapOperator&lt;T, R&gt; flatMap(FlatMapFunction&lt;T, R&gt; flatMapper) {Â Â Â Â if (flatMapper == null) {Â Â Â Â Â Â Â Â throw new NullPointerException("FlatMap function must not be null.");Â Â Â Â }Â Â Â Â Â String callLocation = Utils.getCallLocationName();Â Â Â Â TypeInformation&lt;R&gt; resultType = TypeExtractor.getFlatMapReturnTypes(flatMapper, getType(), callLocation, true);Â Â Â Â return new FlatMapOperator&lt;&gt;(this, resultType, clean(flatMapper), callLocation);}</code></pre><p>ä»£ç ä¸­çš„FlatMapFunctionå°±æ˜¯ç”¨æˆ·ç¼–å†™Flinkç¨‹åºæ—¶ï¼Œä¼ å…¥ç»™flatMap()æ–¹æ³•çš„å‡½æ•°å®ç°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è®¾ç½®ä¸ºFlatMapOperatorå¯¹è±¡çš„ä¸€ä¸ªfunctionå±æ€§çš„å€¼ã€‚å½“æˆ‘ä»¬ç¼–å†™çš„Flinkæ‰¹é‡å¤„ç†ç¨‹åºä¸­ï¼Œæœ€åä¼šè°ƒç”¨ExecutionEnvironment.execute()ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šå¯¹æœ€åŸå§‹çš„ç”±Operatoræ„å»ºå¥½çš„DAGå›¾è¿›è¡Œå¤„ç†ï¼Œå¤„ç†çš„åŸºæœ¬æµç¨‹ç®€è¦æè¿°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ol start=1><li>åˆ›å»ºä¸€ä¸ªPlanï¼Œå®ƒæ˜¯Pipelineæ¥å£çš„å…·ä½“å®ç°ç±»ï¼Œè¡¨ç¤ºäº†ä»DataSinkåˆ°DataSourceå®ç°è¿é€šçš„æ•°æ®æµDAGå›¾ã€‚</li><li>æ ¹æ®è¾“å…¥é…ç½®ï¼Œè·å–åˆ°å¯¹åº”çš„PipelineExecutorï¼Œç”¨æ¥å°†å®ç°çš„Jobæäº¤åˆ°æ‰§è¡Œå¼•æ“è¿›è¡Œè®¡ç®—å¤„ç†ã€‚</li><li>å°†Planè¿›ä¸€æ­¥è¿›è¡Œä¼˜åŒ–ï¼Œç¼–è¯‘ç”ŸæˆOptimizedPlanï¼Œå®ƒè¡¨ç¤ºäº†å¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ï¼Œé€šè¿‡æŠ½è±¡çš„æ•°æ®ç»“æ„PlanNodeå’ŒChannelæ¥æ›´åŠ ç²¾ç¡®æè¿°ç¨‹åºå¦‚ä½•è¢«æ‰§è¡Œã€‚</li><li>æœ€åï¼Œæ ¹æ®OptimizedPlanç”Ÿæˆæœ€ç»ˆçš„JobGraphï¼Œä»è€Œæäº¤åˆ°é›†ç¾¤JobManagerè¿›è¡ŒçœŸæ­£æ‰§è¡Œã€‚</li></ol><p>è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ä¼šéå¸¸æ·±å…¥åœ°è¯´æ˜å„ä¸ªæ­¥éª¤æ¶‰åŠåˆ°çš„ç»†èŠ‚ï¼Œä½†æ˜¯ä¼šä»æ›´é«˜Levelæ¥ç†è§£ç”ŸæˆJobGraphçš„è¿‡ç¨‹ä¸­ï¼Œéƒ½åšäº†å“ªäº›å¤„ç†ã€‚</p><p><strong>ç”ŸæˆPlan</strong></p><p>åœ¨ç”ŸæˆPlançš„è¿‡ç¨‹ä¸­ï¼Œå°±æ¶‰åŠåˆ°ä¸Šé¢WordCountæ•°æ®æµDAGå›¾ä¸­å±•ç¤ºçš„ç¬¬äºŒå±‚æ„æˆDAGçš„åŸºæœ¬å…ƒç´ Operatorï¼Œå®ƒä»¬æ˜¯ä½äºorg.apache.flink.api.common.operatorsåŒ…ä¸‹é¢å®ç°ç±»ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹è¿™ä¸ªOperatorç±»ä½“ç³»çš„ç»§æ‰¿å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt=å¤§æ•°æ®ä¸“å®¶ï¼Œå¯¹Flinkæ‰¹å¤„ç†ç”ŸæˆJobGraphæµç¨‹æ·±å…¥åˆ†æï¼Œå€¼å¾—æ”¶è— onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c0c61514b7d3450583c14f232fc92541><p class=pgc-img-caption></p></div><p>ä¸Šé¢ç±»å›¾ä¸­ï¼Œå¤§å¤šæ•°Operatorå®ç°ç±»åç§°éƒ½å¸¦æœ‰ä¸€ä¸ªBaseçš„åç¼€ï¼Œå¤§éƒ¨åˆ†éƒ½ä¸org.apache.flink.api.javaåŒ…ä¸‹é¢çš„Operatorå®ç°ç±»æœ‰ä¸€ä¸ªå¯¹åº”å…³ç³»ï¼Œæ¯”å¦‚ï¼ŒFlatMapOperatorå¯¹åº”FlatMapOperatorBaseï¼ŒDataSourceå¯¹åº”DataSourceBaseã€AggregateOperatorå¯¹åº”GroupReduceOperatorBaseç­‰ç­‰ï¼Œä¸å†ä¸€ä¸€åˆ—ä¸¾ã€‚åœ¨DataSetçš„å…·ä½“å®ç°ç±»ä¸­ï¼Œæ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªtranslateToDataFlow()æ–¹æ³•ï¼Œèƒ½å¤Ÿå°†è¯¥Operatorçš„è¾“å…¥DataSetè½¬æ¢æˆä¸€ä¸ªorg.apache.flink.api.common.operators.Operatorï¼Œæ‰€ä»¥åœ¨ä»DataSinkåˆ°DataSourceé€’å½’éå†è¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šè¿›è¡Œè¯¥è½¬æ¢æ“ä½œã€‚å¦å¤–ï¼Œè¿˜ä¼šæ ¹æ®ç”¨æˆ·ç¼–å†™ç¨‹åºä¸­è®¾ç½®çš„å„ç§å‚æ•°ï¼ŒåŒ…æ‹¬Flinké»˜è®¤çš„ä¸€äº›å‚æ•°å€¼ç­‰ç­‰ï¼Œéƒ½é…ç½®åˆ°åŸºäºorg.apache.flink.api.common.operators.Operatorçš„å…·ä½“å¯¹è±¡ä¸Šã€‚ä¸‹é¢æ˜¯æ ¸å¿ƒçš„å¤„ç†ä»£ç ï¼š</p><pre><code>public Plan translateToPlan(List&lt;DataSink&lt;?&gt;&gt; sinks, String jobName) {Â Â Â Â List&lt;GenericDataSinkBase&lt;?&gt;&gt; planSinks = new ArrayList&lt;&gt;();Â Â Â Â Â for (DataSink&lt;?&gt; sink : sinks) {Â Â Â Â Â Â Â Â planSinks.add(translate(sink));Â Â Â Â }Â Â Â Â Â Plan p = new Plan(planSinks);Â Â Â Â p.setJobName(jobName);Â Â Â Â return p;}</code></pre><p>å…¶ä¸­ï¼Œå‚æ•°sinksæ˜¯åœ¨ExecutionEnvironmentä¸­ç®¡ç†çš„æœ€åŸå§‹Flinkç¨‹åºDAGï¼Œå¯¹äºä¸Šé¢çš„WordCountä¾‹å­ï¼Œå®é™…åªæœ‰ä¸€ä¸ªDataSinkã€‚ä¸Šé¢çš„translate(sink)æ–¹æ³•è°ƒç”¨ï¼Œå¯¹æœ€åˆæ„å»ºå¥½çš„æ•´ä¸ªDAGè¿›è¡Œç¿»è¯‘å¤„ç†ï¼Œå®ƒæ˜¯ä¸€ä¸ªé€’å½’å¤„ç†è¿‡ç¨‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>private &lt;T&gt; GenericDataSinkBase&lt;T&gt; translate(DataSink&lt;T&gt; sink) {Â Â Â Â // translate the input recursivelyÂ Â Â Â Operator&lt;T&gt; input = translate(sink.getDataSet());Â Â Â Â // translate the sink itself and connect it to the inputÂ Â Â Â GenericDataSinkBase&lt;T&gt; translatedSink = sink.translateToDataFlow(input);Â Â Â Â translatedSink.setResources(sink.getMinResources(), sink.getPreferredResources());Â Â Â Â return translatedSink;}</code></pre><p>ä¸Šé¢translate(sink.getDataSet())æ–¹æ³•è°ƒç”¨ä¸­ï¼Œå¯¹å„ç§ä¸åŒç±»å‹çš„Operatorè¿›è¡Œç¿»è¯‘å¤„ç†ï¼Œå› ä¸ºæ¯ä¸ªOperatorçš„ç‰¹ç‚¹ä»¥åŠè¡Œä¸ºæœ¬èº«å°±ä¸åŒï¼Œæ‰€ä»¥translate()æ–¹æ³•ä¸­åˆ†åˆ«è¿›è¡Œäº†ä¸åŒçš„å¤„ç†ï¼Œå®ç°å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><pre><code>private &lt;T&gt; Operator&lt;T&gt; translate(DataSet&lt;T&gt; dataSet) {Â Â Â Â while (dataSet instanceof NoOpOperator) {Â Â Â Â Â Â Â Â dataSet = ((NoOpOperator&lt;T&gt;) dataSet).getInput();Â Â Â Â }Â Â Â Â Â // check if we have already translated that data set (operation or source)Â Â Â Â Operator&lt;?&gt; previous = this.translated.get(dataSet);Â Â Â Â if (previous != null) {Â Â Â Â Â Â Â Â // Union operators may only have a single output.Â Â Â Â Â Â Â Â // We ensure this by not reusing previously created union operators.Â Â Â Â Â Â Â Â // The optimizer will merge subsequent binary unions into one n-ary union.Â Â Â Â Â Â Â Â if (!(dataSet instanceof UnionOperator)) {Â Â Â Â Â Â Â Â Â Â Â Â // all other operators are reused.Â Â Â Â Â Â Â Â Â Â Â Â @SuppressWarnings("unchecked")Â Â Â Â Â Â Â Â Â Â Â Â Operator&lt;T&gt; typedPrevious = (Operator&lt;T&gt;) previous;Â Â Â Â Â Â Â Â Â Â Â Â return typedPrevious;Â Â Â Â Â Â Â Â }Â Â Â Â }Â Â Â Â Â Operator&lt;T&gt; dataFlowOp;Â Â Â Â if (dataSet instanceof DataSource) {Â Â Â Â Â Â Â Â DataSource&lt;T&gt; dataSource = (DataSource&lt;T&gt;) dataSet;Â Â Â Â Â Â Â Â dataFlowOp = dataSource.translateToDataFlow();Â Â Â Â Â Â Â Â dataFlowOp.setResources(dataSource.getMinResources(), dataSource.getPreferredResources());Â Â Â Â }Â Â Â Â else if (dataSet instanceof SingleInputOperator) {Â Â Â Â Â Â Â Â SingleInputOperator&lt;?, ?, ?&gt; singleInputOperator = (SingleInputOperator&lt;?, ?, ?&gt;) dataSet;Â Â Â Â Â Â Â Â dataFlowOp = translateSingleInputOperator(singleInputOperator);Â Â Â Â Â Â Â Â dataFlowOp.setResources(singleInputOperator.getMinResources(), singleInputOperator.getPreferredResources());Â Â Â Â }Â Â Â Â else if (dataSet instanceof TwoInputOperator) {Â Â Â Â Â Â Â Â TwoInputOperator&lt;?, ?, ?, ?&gt; twoInputOperator = (TwoInputOperator&lt;?, ?, ?, ?&gt;) dataSet;Â Â Â Â Â Â Â Â dataFlowOp = translateTwoInputOperator(twoInputOperator);Â Â Â Â Â Â Â Â dataFlowOp.setResources(twoInputOperator.getMinResources(), twoInputOperator.getPreferredResources());Â Â Â Â }Â Â Â Â else if (dataSet instanceof BulkIterationResultSet) {Â Â Â Â Â Â Â Â BulkIterationResultSet&lt;?&gt; bulkIterationResultSet = (BulkIterationResultSet&lt;?&gt;) dataSet;Â Â Â Â Â Â Â Â dataFlowOp = translateBulkIteration(bulkIterationResultSet);Â Â Â Â Â Â Â Â dataFlowOp.setResources(bulkIterationResultSet.getIterationHead().getMinResources(),Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â bulkIterationResultSet.getIterationHead().getPreferredResources());Â Â Â Â }Â Â Â Â else if (dataSet instanceof DeltaIterationResultSet) {Â Â Â Â Â Â Â Â DeltaIterationResultSet&lt;?, ?&gt; deltaIterationResultSet = (DeltaIterationResultSet&lt;?, ?&gt;) dataSet;Â Â Â Â Â Â Â Â dataFlowOp = translateDeltaIteration(deltaIterationResultSet);Â Â Â Â Â Â Â Â dataFlowOp.setResources(deltaIterationResultSet.getIterationHead().getMinResources(),Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â deltaIterationResultSet.getIterationHead().getPreferredResources());Â Â Â Â }Â Â Â Â else if (dataSet instanceof DeltaIteration.SolutionSetPlaceHolder || dataSet instanceof DeltaIteration.WorksetPlaceHolder) {Â Â Â Â Â Â Â Â throw new InvalidProgramException("A data set that is part of a delta iteration was used as a sink or action."Â Â Â Â Â Â Â Â Â Â Â Â + " Did you forget to close the iteration?");Â Â Â Â }Â Â Â Â else {Â Â Â Â Â Â Â Â throw new RuntimeException("Error while creating the data flow plan for the program: Unknown operator or data set type: " + dataSet);Â Â Â Â }Â Â Â Â Â this.translated.put(dataSet, dataFlowOp);Â Â Â Â // take care of broadcast variablesÂ Â Â Â translateBcVariables(dataSet, dataFlowOp);Â Â Â Â return dataFlowOp;}</code></pre><p>ä¸Šé¢translateSingleInputOperator()ã€translateTwoInputOperator()ç­‰æ–¹æ³•ä¸­ï¼Œä¼šé€’å½’è°ƒç”¨è¯¥translate()æ–¹æ³•æ¥å¯¹æŸä¸ªOperatorè¿›è¡Œç¿»è¯‘å¤„ç†ã€‚æˆ‘ä»¬ä»¥å‰é¢ç»™å‡ºçš„WordCountç¨‹åºä¸ºä¾‹ï¼Œå°±ä¼šå¯¹DataSourceâ†’FlatMapOperatorâ†’UnsortedGroupingâ†’AggregateOperatorâ†’DataSinkè¿›è¡Œä»åè‡³å‰çš„éå†ï¼Œæœ€ç»ˆç¿»è¯‘æˆGenericDataSourceBaseâ†’FlatMapOperatorBaseâ†’GroupReduceOperatorBaseâ†’GenericDataSinkBaseã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ä¾¿å¾—åˆ°äº†æœ€åŸºæœ¬çš„Planã€‚</p><p><strong>ç”ŸæˆOptimizedPlan</strong></p><p>é€šè¿‡ä¸Šä¸€æ­¥ç”Ÿæˆçš„Planï¼Œæˆ‘ä»¬è¿˜æ— æ³•ç²¾ç¡®åœ°çŸ¥é“å¦‚ä½•çœŸæ­£è¿è¡ŒæŸä¸ªOperatorã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œç”Ÿæˆçš„OptimizedPlanèƒ½å¤Ÿåšåˆ°å¦‚ä¸‹äº‹æƒ…ï¼š</p><ul><li>åŸºäºç”¨æˆ·çš„ç¨‹åºç”ŸæˆPlanï¼Œæ›´è¿›ä¸€æ­¥ç”Ÿæˆæ›´ç²¾ç¡®æè¿°ç”¨æˆ·ç¨‹åºæ‰§è¡Œçš„OptimizedPlanã€‚</li><li>OptimizedPlanèƒ½å¤Ÿç²¾ç¡®åœ°æè¿°ç¨‹åºå¦‚ä½•ç‰©ç†åœ°æ‰§è¡Œã€‚</li><li>Operatorä½¿ç”¨ä½•ç§ç­–ç•¥æ‰§è¡Œï¼Œæ¯”å¦‚ï¼Œæ˜¯Hash Joinè¿˜æ˜¯Sort Merge Joinã€‚</li><li>Operatorä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢çš„ç­–ç•¥ï¼Œæ˜¯Local Pipe Forwardã€Shuffleï¼Œè¿˜æ˜¯Broadcastã€‚</li><li>Operatorä¹‹é—´ä½¿ç”¨çš„æ•°æ®äº¤æ¢æ¨¡å¼ï¼Œæ˜¯Pipelinedè¿˜æ˜¯Batchã€‚</li><li>åœ¨ä»€ä¹ˆåœ°æ–¹ç¼“å­˜ä¸­é—´ç»“æœã€‚</li></ul><p>è¿™é‡Œï¼Œæˆ‘ä»¬ä¸å†æ›´è¯¦ç»†åœ°å»åˆ†æï¼Œåé¢ä¼šå¯¹å•ç‹¬å†™æ–‡ç« è¿›è¡Œæ·±å…¥åˆ†æã€‚ç°åœ¨å¯ä»¥æŸ¥çœ‹å¯¹åº”ä»£ç æ¥äº†è§£ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>GraphCreatingVisitor graphCreator = new GraphCreatingVisitor(defaultParallelism, defaultDataExchangeMode);program.accept(graphCreator);Â // if we have a plan with multiple data sinks, add logical optimizer nodes that have two data-sinks as children// each until we have only a single root node. This allows to transparently deal with the nodes with// multiple outputsOptimizerNode rootNode;if (graphCreator.getSinks().size() == 1) {Â Â Â Â rootNode = graphCreator.getSinks().get(0);}else if (graphCreator.getSinks().size() &gt; 1) {Â Â Â Â Iterator&lt;DataSinkNode&gt; iter = graphCreator.getSinks().iterator();Â Â Â Â rootNode = iter.next();Â Â Â Â while (iter.hasNext()) {Â Â Â Â Â Â Â Â rootNode = new SinkJoiner(rootNode, iter.next());Â Â Â Â }}else {Â Â Â Â throw new CompilerException("Bug: The optimizer plan representation has no sinks.");}Â // now that we have all nodes created and recorded which ones consume memory, tell the nodes their minimal// guaranteed memory, for further cost estimations. We assume an equal distribution of memory among consumer tasksrootNode.accept(new IdAndEstimatesVisitor(this.statistics));Â // We need to enforce that union nodes always forward their output to their successor.// Any partitioning must be either pushed before or done after the union, but not on the union's output.UnionParallelismAndForwardEnforcer unionEnforcer = new UnionParallelismAndForwardEnforcer();rootNode.accept(unionEnforcer);Â // We are dealing with operator DAGs, rather than operator trees.// That requires us to deviate at some points from the classical DB optimizer algorithms.// This step builds auxiliary structures to help track branches and joins in the DAGBranchesVisitor branchingVisitor = new BranchesVisitor();rootNode.accept(branchingVisitor);Â // Propagate the interesting properties top-down through the graphInterestingPropertyVisitor propsVisitor = new InterestingPropertyVisitor(this.costEstimator);rootNode.accept(propsVisitor);Â // perform a sanity check: the root may not have any unclosed branchesif (rootNode.getOpenBranches() != null &amp;&amp; rootNode.getOpenBranches().size() &gt; 0) {Â Â Â Â throw new CompilerException("Bug: Logic for branching plans (non-tree plans) has an error, and does not " +Â Â Â Â Â Â Â Â Â Â Â Â "track the re-joining of branches correctly.");}Â // the final step is now to generate the actual plan alternativesList&lt;PlanNode&gt; bestPlan = rootNode.getAlternativePlans(this.costEstimator);if (bestPlan.size() != 1) {Â Â Â Â throw new CompilerException("Error in compiler: more than one best plan was created!");}Â // check if the best plan's root is a data sink (single sink plan)// if so, directly take it. if it is a sink joiner node, get its contained sinksPlanNode bestPlanRoot = bestPlan.get(0);List&lt;SinkPlanNode&gt; bestPlanSinks = new ArrayList&lt;SinkPlanNode&gt;(4);Â if (bestPlanRoot instanceof SinkPlanNode) {Â Â Â Â bestPlanSinks.add((SinkPlanNode) bestPlanRoot);} else if (bestPlanRoot instanceof SinkJoinerPlanNode) {Â Â Â Â ((SinkJoinerPlanNode) bestPlanRoot).getDataSinks(bestPlanSinks);}Â // finalize the planOptimizedPlan plan = new PlanFinalizer().createFinalPlan(bestPlanSinks, program.getJobName(), program);plan.accept(new BinaryUnionReplacer());plan.accept(new RangePartitionRewriter(plan));Â // post pass the plan. this is the phase where the serialization and comparator code is setpostPasser.postPass(plan);</code></pre><p>è¿™é‡Œéœ€è¦è¯´çš„æ˜¯ï¼Œç»è¿‡ä¸Šé¢ä»£ç çš„å¤„ç†ï¼Œé¦–å…ˆä¼šå°†Planç”Ÿæˆä¸€ä¸ªä¸­é—´ç»“æ„çš„Planï¼Œä¸»è¦æ˜¯é€šè¿‡GraphCreatingVisitoræ¥è¿›è¡Œå¤„ç†çš„ï¼ŒDAGå›¾ä»¥OptimizerNodeä¸ºåŸºæœ¬èŠ‚ç‚¹è¿›è¡ŒæŠ½è±¡æ„å»ºï¼Œå¯¹åº”çš„ç±»åŠå…¶ç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt=å¤§æ•°æ®ä¸“å®¶ï¼Œå¯¹Flinkæ‰¹å¤„ç†ç”ŸæˆJobGraphæµç¨‹æ·±å…¥åˆ†æï¼Œå€¼å¾—æ”¶è— onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c701d403f5af48f5bb38533054b76334><p class=pgc-img-caption></p></div><p>ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ä¼šä½¿ç”¨æ¯ä¸ªOptimizerNodeæä¾›çš„ä¿¡æ¯æ¥æ„å»ºDAGï¼Œç§°ä¸ºOptimizer DAGï¼Œä»è€Œå®Œæˆå¦‚ä¸‹å¤„ç†å·¥ä½œï¼š</p><ul><li>è¯„ä¼°æ¯ä¸ªOperatorå¤„ç†çš„æ•°æ®é‡çš„å¤§å°ï¼Œä»¥åŠKey/Valueæ•°æ®çš„æ•°é‡ã€‚</li><li>ç¡®å®šåœ¨DAGçš„ä»€ä¹ˆä½ç½®è¿›è¡ŒSplitï¼ˆåˆ†æ”¯ï¼‰æˆ–è€…Joinï¼ˆåˆå¹¶ï¼‰å¤„ç†æ“ä½œã€‚</li><li>ä½¿ç”¨DagConnectionæ•°æ®æ¥å£æ¥æè¿°Operatorä¹‹é—´å¦‚ä½•è¿›è¡Œè¿æ¥ï¼ŒåŒ…æ‹¬Broadcastè¿æ¥ã€Incomingè¿æ¥å’ŒOutgoingè¿æ¥ã€‚</li><li>é€‰æ‹©åˆé€‚çš„å±æ€§ï¼Œä»è€Œä¸æ–­è¿­ä»£ä¼˜åŒ–å€™é€‰è®¡åˆ’ï¼ˆCandidate Planï¼‰ã€‚</li></ul><p>ç„¶åï¼Œæ ¹æ®ä¸Šé¢åŸºäºOptimizerNodeçš„DAGï¼Œåˆè¿›è¡Œä¼˜åŒ–å¤„ç†ï¼Œæœ€ç»ˆå¾—åˆ°äº†ä»¥PlanNodeä¸ºåŸºæœ¬èŠ‚ç‚¹æŠ½è±¡çš„DAGå›¾ï¼ŒPlanNodeç±»åŠå…¶ç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt=å¤§æ•°æ®ä¸“å®¶ï¼Œå¯¹Flinkæ‰¹å¤„ç†ç”ŸæˆJobGraphæµç¨‹æ·±å…¥åˆ†æï¼Œå€¼å¾—æ”¶è— onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4dd907b1283c449f952d73fe4b822d28><p class=pgc-img-caption></p></div><p>æ¯ä¸ªPlanNodeå¹¶ä¸æ˜¯å’Œä¹‹å‰ç¿»è¯‘è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸€äº›æ•°æ®ç»“æ„æ²¡å…³ç³»ï¼Œå®ƒä»¬å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªOptimizerNodeçš„å¼•ç”¨ï¼Œä»è€Œèƒ½è®¿é—®åˆ°OptimizerNodeå†…éƒ¨çš„ä¿¡æ¯ã€‚PlanNodeä¸»è¦æŠ½è±¡äº†DAGå›¾ä¸­å„ä¸ªOperatorä¹‹é—´å¦‚ä½•è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œä»¥åŠæ•°æ®äº¤æ¢ç­–ç•¥ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªå”¯ä¸€çš„æœ€ä½³Planï¼Œå¯¹åº”ä»£ç ç‰‡æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>List&lt;PlanNode&gt; bestPlan = rootNode.getAlternativePlans(this.costEstimator);if (bestPlan.size() != 1) {Â Â Â Â throw new CompilerException("Error in compiler: more than one best plan was created!");}Â // check if the best plan's root is a data sink (single sink plan)// if so, directly take it. if it is a sink joiner node, get its contained sinksPlanNode bestPlanRoot = bestPlan.get(0);List&lt;SinkPlanNode&gt; bestPlanSinks = new ArrayList&lt;SinkPlanNode&gt;(4);if (bestPlanRoot instanceof SinkPlanNode) {Â Â Â Â bestPlanSinks.add((SinkPlanNode) bestPlanRoot);} else if (bestPlanRoot instanceof SinkJoinerPlanNode) {Â Â Â Â ((SinkJoinerPlanNode) bestPlanRoot).getDataSinks(bestPlanSinks);}Â // finalize the planOptimizedPlan plan = new PlanFinalizer().createFinalPlan(bestPlanSinks, program.getJobName(), program);plan.accept(new BinaryUnionReplacer());Â plan.accept(new RangePartitionRewriter(plan));Â // post pass the plan. this is the phase where the serialization and comparator code is setpostPasser.postPass(plan);</code></pre><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œå·²ç»ç”Ÿæˆäº†ä¸€ä¸ªOptimizedPlanï¼Œé€šè¿‡OptimizedPlanå°±å¯ä»¥ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„JobGraphäº†ã€‚</p><p><strong>ç”ŸæˆJobGraph</strong></p><p>JobGraphæ˜¯JobManagerèƒ½å¤Ÿæ¥æ”¶çš„Jobçš„æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸€ç§Low-Levelçš„æ•°æ®æµDAGè¡¨ç°å½¢å¼ï¼Œå®ƒå®šä¹‰äº†JobèŒƒå›´å†…ï¼ˆJob-wideï¼‰çš„ä¸€äº›è®¾ç½®ã€‚ç”ŸæˆJobGraphçš„ä¸»æµç¨‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>private JobGraph compilePlan(Plan plan, Configuration optimizerConfiguration) {Â Â Â Â Optimizer optimizer = new Optimizer(new DataStatistics(), optimizerConfiguration);Â Â Â Â OptimizedPlan optimizedPlan = optimizer.compile(plan);Â Â Â Â JobGraphGenerator jobGraphGenerator = new JobGraphGenerator(optimizerConfiguration);Â Â Â Â return jobGraphGenerator.compileJobGraph(optimizedPlan, plan.getJobId());}</code></pre><p>ç»„æˆJobGraphè®¡ç®—å›¾æ‹“æ‰‘ä¸­ï¼Œæœ€æ ¸å¿ƒçš„ä¸¤ä¸ªæ•°æ®ç»“æ„ä¸ºJobVertexå’ŒIntermediateDataSetã€‚å…¶ä¸­ï¼ŒJobVertexæ˜¯å¯¹è®¡ç®—é€»è¾‘å•å…ƒçš„æŠ½è±¡ï¼Œå®ƒé€šè¿‡è®¾ç½®invokableClassNameå±æ€§æ¥è¡¨ç¤ºï¼Œå®ƒå¿…é¡»æ˜¯AbstractInvokableç±»çš„å…·ä½“å®ç°ç±»ï¼Œèƒ½å¤Ÿç›´æ¥åœ¨TaskManagerä¸Šé€šè¿‡åå°„ç”ŸæˆAbstractInvokableå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶invoke()æ–¹æ³•æ‰§è¡Œè¯¥Taskå¯¹åº”çš„å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚ï¼Œæ‰¹å¤„ç†Jobä½¿ç”¨çš„æ˜¯å…·ä½“å®ç°BatchTaskã€‚IntermediateDataSetæ˜¯ä¸€ä¸ªOperatoræ‰§è¡Œåäº§ç”Ÿçš„ä¸­é—´ç»“æœé›†çš„æŠ½è±¡ï¼Œä¹ŸåŒ…æ‹¬ä¸€ä¸ªDataSourceå¯¹åº”çš„æ•°æ®é›†ï¼Œå®ƒèƒ½å¤Ÿè¢«å…¶ä»–Operatorè¯»å–ã€ç‰©åŒ–ï¼ˆMaterializedï¼‰ï¼Œç”šè‡³ä¸¢å¼ƒã€‚</p><p>æœ¬æ–‡ä½œè€…æ¥è‡ªæ—¶å»¶å†›ï¼ŒåŸæ–‡ç‚¹å‡»äº†è§£æ›´å¤šâ†“â†“â†“</p><p><strong>æ„Ÿè°¢å¤§å®¶æ”¯æŒï¼Œå¤šå¤šè½¬å‘å…³æ³¨ä¸è¿·è·¯~~~~~</strong></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'å¤§æ•°æ®','ä¸“å®¶','Flink'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>