<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>这个单机 1 万个并发连接问题，程序员做架构设计都避免不了 | 极客快訊</title><meta property="og:title" content="这个单机 1 万个并发连接问题，程序员做架构设计都避免不了 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/dfic-imagehandler/aa16b3c3-2d99-4de8-b796-650b9366a0cc"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/936ea470.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/936ea470.html><meta property="article:published_time" content="2020-11-14T21:06:37+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:37+08:00"><meta name=Keywords content><meta name=description content="这个单机 1 万个并发连接问题，程序员做架构设计都避免不了"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/936ea470.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>这个单机 1 万个并发连接问题，程序员做架构设计都避免不了</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>来源｜极客时间《卖桃者说》</p><p>编辑｜夏天</p><p>你好，这里是卖桃者说，今天和你聊一点并发相关的知识。</p><p>在现代互联网上，大数据和海量用户应用场景越来越多。你看着街边的停车位越来越少，车越来越多，开始抱怨社会膨胀了。但这些是肉眼可见的，互联网数据的发展可比车增加的快多了，而且指数级的。比如新浪微博，整体 HTTP 接口调用量 2018 年到了百万 QPS 这个量级，视频吞吐是 TBPS 级别的，与之对应高并发技术也一年年更新换代，层出不穷，涉及到的领域包括编程语言、技术框架和软硬件性能优化等。</p><p>但是，就像汽车一样，这些技术也不是凭空出现的，究其根源，我们可以从一个技术名词 C10K 聊起。</p><div class=pgc-img><img alt="这个单机 1 万个并发连接问题，程序员做架构设计都避免不了" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/dfic-imagehandler/aa16b3c3-2d99-4de8-b796-650b9366a0cc><p class=pgc-img-caption></p></div><p>在做技术规划和架构设计的时候，我常常告诫技术人员，不要做过度设计，如果咱们只有 1 万用户，先别去操百万用户在线的心。淘宝那么大，也是从 Apache、PHP、MySql 发展起来的，没人能预见到淘宝会发展到这样一个规模，一旦发展起来，业务的爆发性增长会驱动技术的迅速发展，在业务规模还不及格的时候，不用为技术的未来担心。</p><p>这个思路在业务领域不会有太大的问题，因为需求的变化实在是太快了，需要时时去应对。但在底层技术的发展上，我们就有可能遭到“短视”的报复，比如：这个数据长度不会超过 16 位吧，这个程序不可能使用到 2000 年吧。于是就有了千年虫的问题，也有了 C10K 的问题。</p><p>C10K 就是 Client 10000 问题，即“在同时连接到服务器的客户端数量超过 10000 个的环境中，即便硬件性能足够， 依然无法正常提供服务”，简而言之，就是单机 1 万个并发连接问题。这个概念最早由 Dan Kegel 提出并发布于其个人站点。</p><p>为什么会这样呢？因为计算机的上古时代，比如没有网络的 PC 时代，不会有程序员高瞻远瞩，预测到互联网时代的来临，也不会想到一台服务器会创建那么多的进程，即使在互联网初期，一台服务器能有 100 个在线用户已经是不得了的事情了。甚至，他们在设计 Unix 的 PID 的时候，采用了有符号的 16 位整数，这就导致一台计算机上能够创建出来的进程无法超过 32767 个。而计算机自己也得运行一些后台进程，这样应用软件能够创建的进程数就更少了。</p><div class=pgc-img><img alt="这个单机 1 万个并发连接问题，程序员做架构设计都避免不了" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/7ab7767a-24d5-4d62-8066-6f2b368dfbf2><p class=pgc-img-caption></p></div><p>当然，这个问题随着技术的发展很快就解决了，现在大部分的个人电脑操作系统可以创建 64 位的进程，由于数据类型所带来的进程数上限消失了，但是我们依然不能无限制的创建进程，因为随着并发连接数的上升会占用系统大量的内存，同样会造成系统的不可用。</p><p>操作系统里内存管理的主要作用是，进程请求内存的时候为其分配可用内存，进程释放后回收内存，并监控内存的使用状况。为了提高内存的使用率，现代操作系统需要程序能够共享内存，并且内存的限制对开发者透明，有些程序占用了内存空间，但不一定是一直使用的，这样可以把这部分内存数据序列化到磁盘上，需要的时候再加载到内存里，这样内存资源永远会给最需要的程序使用。于是程序员们发明了虚拟内存（Virtual Memory）。</p><p>虚拟内存技术支持程序访问比物理内存大得多的内存空间，也使得多个程序共享内存更加高效。物理内存由 RAM 芯片提供，虚拟内存则依靠透明的使用磁盘空间，使程序运行起来好像有了更大的内存空间。</p><p>但是问题依然存在，进程和线程的创建都需要消耗一定的内存，每创建一个栈空间，都会产生内存开销，当内存使用超过物理内存的时候，一部分数据就会持久化到磁盘上，随之而来的就是性能的大幅度下降。</p><div class=pgc-img><img alt="这个单机 1 万个并发连接问题，程序员做架构设计都避免不了" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/f2f2fd1a-7617-4970-8444-0cbb6ef57434><p class=pgc-img-caption></p></div><p>这就像银行挤兑，人们把现金存入银行，收取一定的利息，平时只有少数人去银行取现，银行会拿人们存的钱去做更有价值的投资。但是，如果大部分人都去银行取现，银行是没有那么多现金的。取不到钱的用户，被门挡在外面的用户，一定会去拉横幅喊口号“最喜欢双截棍柔中带刚，不喜欢银行就上少林武当”云云，于是银行就处于不可用状态了。现在的互联网金融也是一个道理，投资者都去变现退出，无论是多么良性的资产，一样玩完。</p><p>为什么现在会有这么大的连接需求呢？因为业务驱动和技术发展嘛。除了普通的网页浏览和表单提交，即时通信和实时互动交流越来越成为主流需求，keep-alive 技术也能让浏览器产生长连接，实时在线的客户端越来越多，如果不能解决 C10K 问题，将导致服务商需要购买大量的服务器，而每一台服务器都不能做到物尽其用，即使你配置了更好的 CPU 和更大的内存。</p><p>当然，现在我们早已经突破了 C10K 这个瓶颈，具体的思路就是通过单个进程或线程服务于多个客户端请求，通过异步编程和事件触发机制替换轮询，IO 采用非阻塞的方式，减少不必要的性能损耗，等等。</p><p><br></p><div class=pgc-img><img alt="这个单机 1 万个并发连接问题，程序员做架构设计都避免不了" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/e0c2d1bd-6cc3-4ed6-b2b1-78bcab90a40c><p class=pgc-img-caption></p></div><p>底层的相关技术包括 epoll、kqueue、libevent 等，应用层面的解决方案包括 OpenResty、Golang、Node.js 等，比如 OpenResty 的介绍中是这么说的：</p><blockquote class=ql-long-26092344><p>OpenResty 通过汇聚各种设计精良的 Nginx 模块，从而将 Nginx 有效地变成一个强大的通用 Web 应用平台。这样，Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 C10K 乃至 C1000K 以上单机并发连接的高性能 Web 应用系统。</p></blockquote><p>现在人们都去搞 C10M 了，你们怕不怕？</p><p>实际操作中，每个解决方案都不是那么容易实现的，很多技术领域油光水滑的东西，放到线上，往往会出现各种各样的问题和毛病。松本行弘先生介绍了一个“最弱连接”的概念：</p><blockquote class=ql-long-26092344><p>如果往两端用力拉一条由很多环 （连接）组成的锁链，其中最脆弱的一个连接会先断掉。因此，锁链整体的强度取决于其中最脆弱的一环。</p></blockquote><blockquote class=ql-long-26092344><p>C10K 问题的情况也很相似。一台服务器同时应付超过一万个（或者更多）并发连接的情况，哪怕只有一个要素没有考虑到超过一万个客户端的情况，这个要素就会成为“最弱连接”，从而导致问题的发生。</p></blockquote><p>每个做架构设计和技术实现的程序员，都应当考虑这个最弱连接问题。</p><p>今天关于 C10K 这个问题，就和大家聊到这里，你在实际工作中，用过哪些高并发技术呢？应对过多大的 QPS 呢？欢迎在留言区给出你的解决方案。</p><p>卖桃者说，明天见。</p><p><strong>福利时间～</strong></p><p>价值<strong>199</strong>元的学习加油包，可<strong>免费畅看</strong>价值万元线下大会实录视频，425位国内外大厂资深专家特邀分享面对面向BAT等一线大厂取经。</p><p>小伙伴们<strong>关注+评论+转发+点赞</strong>后，私信小编回复“<strong>学习礼包</strong>”即可领取～每人仅限一份哦！</p><div class=pgc-img><img alt="这个单机 1 万个并发连接问题，程序员做架构设计都避免不了" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1c0e330016d74518afa78c360d5ba9fc><p class=pgc-img-caption></p></div><p>点击链接，阅读更多“卖桃者说”精彩文章！</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'这个','单机','万个'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>