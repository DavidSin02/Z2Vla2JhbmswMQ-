<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>计算机基础 | 多核、缓存...现代CPU是如何工作的 | 极客快訊</title><meta property="og:title" content="计算机基础 | 多核、缓存...现代CPU是如何工作的 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/00b13f1351104d2580b788c820758128"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/93f9f87.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/93f9f87.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/93f9f87.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/93f9f87.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/93f9f87.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/93f9f87.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/93f9f87.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/93f9f87.html><meta property="article:published_time" content="2020-10-29T20:53:40+08:00"><meta property="article:modified_time" content="2020-10-29T20:53:40+08:00"><meta name=Keywords content><meta name=description content="计算机基础 | 多核、缓存...现代CPU是如何工作的"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/93f9f87.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>计算机基础 | 多核、缓存...现代CPU是如何工作的</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><blockquote><p>现代CPU一般使用缓存（Cache）来解决CPU读写主存慢的问题；使用多核来并行计算以加速程序运行。并行计算一般需要多线程技术，如何操作多线程对编程人员提出了挑战。</p></blockquote><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/00b13f1351104d2580b788c820758128><p class=pgc-img-caption>计算机软硬件体系结构</p></div><p>之前的文章《源代码如何被计算机执行》已经提到，对于一段源代码，计算机主要依靠编译器将源代码转化为CPU可以执行的程序。那么，CPU到底是如何工作的呢？本文将介绍现代CPU的工作原理。</p><p><strong>冯·诺依曼架构</strong></p><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a668a74c0e9f45fbb1a34cbaf7093531><p class=pgc-img-caption>冯·诺依曼架构 来源：维基百科</p></div><p>1945年，天才科学家冯·诺依曼提出了一种计算机设计实现架构，奠定了现代计算机的理论基础。冯·诺依曼架构主要有几大部分：</p><ul><li>包含控制单元和逻辑运算单元的CPU</li><li>存储指令和数据的内存</li><li>输入和输出设备</li></ul><p>下文将简单描述CPU，指令、控制单元等概念。除了冯·诺依曼架构，哈佛架构也是一种计算机的实现方式。现代计算机经过了几十年的飞速发展，集百家之长，很难界定现代计算机到底是冯·诺依曼架构还是哈佛架构，这里暂不赘述。</p><p><strong>CPU工作原理</strong></p><p>CPU（Central Processing Unit），中文翻译为中央处理器，负责执行用户和操作系统下发的指令。CPU是计算机中最为核心的部分，经常被比作计算机的大脑。CPU只能接受01二进制语言，0和1用来控制高低电位。比如，一个加法运算，在x86处理器上的的二进制代码为：</p><pre>01001000 00000001 11000011</pre><p>这样一行代码被称为机器码，它执行了加法操作。除了这样的加法，CPU的电路还要实现很多其他指令，如存取内存数据，进行逻辑判断等。不同厂商的电路设计不同，在电路上所能进行的二进制码不同。某类CPU能支持一种指令集（instruction set architecture）。指令集相当于一种设计图纸，规定了一种CPU架构实现哪些指令。参照指令集，硬件开发人员只需要关心如何设计电路，软件开发人员只关心如何用01机器码实现软件功能。比较常见的指令集有x86、ARM、MIPS、SPARC、Power等。x86和ARM被广泛应用在我们身边的电子产品上，相对比较知名，此外，龙芯实现了MIPS，IBM小型机则采用Power指令集。</p><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/19b978a40c044cf98572e2a0cafe829d><p class=pgc-img-caption>单核计算机系统示意图</p></div><p>一个单核CPU的架构包括：</p><ul><li>Control Unit（CU）起协调管理功能。</li><li>Arithmetic Logic Unit（ALU）接受控制单元的命令，负责进行加减乘与或非运算。所有数据都存放在寄存器（Register）里。</li><li>寄存器以极高的速度与CU和ALU交互，通常小于1纳秒。从寄存器的名字可以看出来，里面的数据是临时寄存的，这些数据和指令会被ALU和CU拿来立即进行计算。如果寄存器没有CPU想要的数据，CPU会去内存或硬盘中读取。</li><li>CPU通过Bus（总线）读取内存或其他设备的数据。计算机中有多条总线。</li></ul><p>我们以一个加法运算来解释上面这些概念。对于一个2 + 2的加法，人类可以直接说出答案，但是换成13234 + 87912，就不得不拿出纸和笔来算一下了。计算机对这两次计算速度没有差别，其本质为半导体电路对两个数字执行加法操作。但与人类不同的是，计算机需要知道两个问题：</p><ol><li>本次所执行的是哪个指令。</li><li>该指令的执行对象是什么。</li></ol><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/14fd0f7ab44244dbb2c13cf2d933e75a><p class=pgc-img-caption>指令执行过程</p></div><p>因此，控制单元先取指令 Fetch，然后指令译码 Decode解析出要执行什么指令，并确认指令是对哪些数据（操作数 operand）进行操作，并将操作数从主存加载到寄存器中。ALU执行指令 Execute后结果写回 Store。</p><p><strong>存储金字塔</strong></p><p>随着技术的发展，计算机的速度瓶颈已经变成了超高速的CPU运算速度与落后的数据读取速度之间的矛盾。CPU计算速度在纳秒级别，但是CPU读取主存的速度竟有百纳秒，CPU进行完计算后，要闲置几十倍的时间，实在是巨大的浪费。从计算本身来说，某个程序一般不需要把硬盘或主存中的所有数据都拿来进行计算，绝大多数时间只需要处理部分热点数据，因此，把热点数据加载到缓存中能解决绝大多数问题。综合计算速度、技术水平、生产成本，设计人员给CPU增加了很多中间的缓存Cache。</p><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/289a2ac996c2487d9de7072667685b69><p class=pgc-img-caption>存储金字塔</p></div><p>CPU的寄存器存取速度极快，但是造价成本太高，发热量大，不能被大量采用。通常，CPU的寄存器只有几KB。L1 Cache和L2 Cache一般设计在CPU上，访问延迟在几纳秒只几十纳秒内，主存的访问延迟在百纳秒内。速度越快，意味着成本越高。所以硬件设计是在现有技术水平、期望计算速度、成本、散热等因素之间所做的trade-off。</p><p><strong>多核</strong></p><p>当单个CPU主频超过一定范围后，CPU成本和散热成了很大的问题，主频很难突破10GHz。为了获得更快的计算速度和更好的性能，芯片设计者决定绕过主频，采用人海战术，在一块CPU中增加多个核心（Core）。</p><p>一个核心是一个可以运行指令的独立单元，它包含了前面所提到的ALU和寄存器，并配备L1和L2 Cache。多个核心共享L3 Cache。</p><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ddb75e3ff40e45189fce3a155e00a4ad><p class=pgc-img-caption>CPU和cache</p></div><p>上图中是一个多核处理器的电路图，每个Core旁边的黑色圆圈分别为L1和L2 Cache。可以看到CPU中，各类Cache占用了很大的空间。</p><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f97fa69975d7412dbc036c20ee67a1db><p class=pgc-img-caption>多处理器多核结构</p></div><p>高性能服务器通常可以支持多个处理器，提供更多计算核心。支持单个CPU的服务器被称为单路服务器，支持两个CPU的服务器被称为双路服务器，支持四个CPU的服务器被称为四路服务器。上图展示了Intel的四路架构，系统支持四个CPU，假如每块CPU内有8个核心，系统可对外提供32核计算能力。</p><p><strong>单线程与多线程</strong></p><p>在多核架构出现之前，CPU在某个特定时刻只能执行某个程序，无法并行。就像人在某个时刻只能做一件事情，不可能“吃着火锅还唱着歌”，因为两项活动都占着嘴呢嘛。如果要干另一件事，就必须把其中一件事停下来。这种处理计算任务的场景被称为<strong>单线程</strong>。单线程每次切换任务，会产生一些资源开销。</p><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f1cb39a9633c45b58afee50ec786ca0c><p class=pgc-img-caption>单核单线程</p></div><p>以网页浏览器为例，浏览器打开一个网页时通常需要下载网页中素材，同时也要把数据渲染成画面。在单核场景下，时间被切成了不同的片段，某段时间只能用来做渲染、缓存或下载中的一项任务。每个任务都有优先级，CPU优先执行高优先级的任务。比如，浏览器打开一个新网页时，要第一时间把网页展示出来，背景音乐下载比较慢，可以等网站渲染好后再下载，所以有时候背景音乐会比网页晚半分钟甚至更长。</p><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/82f3751aded34db389adc0a07545df4f><p class=pgc-img-caption>多核多线程</p></div><p>多核架构提供给用户多个可以独立计算的核心，这也意味着计算机可以同时并行执行多项任务，即<strong>并行计算</strong>。某个计算任务在某个核中进行，被称作<strong>线程</strong>。多个核处理多个任务通常被称为<strong>多线程</strong>。</p><p>当多个核心都处理相同任务，极有可能使用同一块数据，就有可能出现数据读写的问题。</p><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ab027f2e5e164c7c8c13ea99834c76a5><p class=pgc-img-caption>线程安全问题</p></div><p>例如，进行i = i + 1操作，如果两个线程短时间内都对变量i加一，变量应该被加了两次。由于两个线程相隔时间太短，加上前面所说的缓存机制，计算的过程和临时结果还在寄存器和L1缓存，没来得及写到主存上。线程B读到还是较老的数据，这样就出现了数据不一致的情况。这种问题被称为线程安全问题。一般需要使用<strong>锁</strong>来处理线程安全问题。</p><p>本专栏将在未来的文章中分享多线程编程和线程安全的具体案例。</p><p><strong>小结</strong></p><div class=pgc-img><img alt="计算机基础 | 多核、缓存...现代CPU是如何工作的" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/748e41ad610e43a1952740ff7b321da5><p class=pgc-img-caption></p></div><p>现代CPU一般使用缓存（Cache）来解决CPU读写主存慢的问题；使用多核来并行计算以加速程序运行。并行计算一般需要多线程技术，如何操作多线程对编程人员提出了挑战。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'计算机','基础','缓存'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>