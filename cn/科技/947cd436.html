<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Spring Security OAuth2 å…¥é—¨ | æå®¢å¿«è¨Š</title><meta property="og:title" content="Spring Security OAuth2 å…¥é—¨ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/30b7584056744a0eb2d53d1f039f7bb7"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/947cd436.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/947cd436.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/947cd436.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/947cd436.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/947cd436.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/947cd436.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/947cd436.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/947cd436.html><meta property="article:published_time" content="2020-11-14T21:00:29+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:29+08:00"><meta name=Keywords content><meta name=description content="Spring Security OAuth2 å…¥é—¨"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/947cd436.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Spring Security OAuth2 å…¥é—¨</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><ul><li>1. æ¦‚è¿°</li><li>2. å¼•å…¥ Spring Security OAuth2 ä¾èµ–</li><li>3. é…ç½®èµ„æºæœåŠ¡å™¨</li><li>4. é…ç½®æˆæƒæœåŠ¡å™¨</li><li class=ql-indent-1>4.1 æˆæƒç æ¨¡å¼</li><li>Spring Security Setting</li><li class=ql-indent-1>4.2 å¯†ç æ¨¡å¼</li><li class=ql-indent-1>4.3 ç®€åŒ–æ¨¡å¼</li><li class=ql-indent-1>4.4 å®¢æˆ·ç«¯æ¨¡å¼</li><li class=ql-indent-1>4.5 å¦‚ä½•é€‰æ‹©ï¼Ÿ</li><li class=ql-indent-1>4.6 ä¸ºä»€ä¹ˆæœ‰ Client ç¼–å·å’Œå¯†ç </li><li>5. åˆ·æ–°ä»¤ç‰Œ</li><li class=ql-indent-1>5.1 è·å–åˆ·æ–°ä»¤ç‰Œ</li><li class=ql-indent-1>5.2 â€œåˆ·æ–°â€è®¿é—®ä»¤ç‰Œ</li><li class=ql-indent-1>5.3 ä¸ºä»€ä¹ˆéœ€è¦æœ‰åˆ·æ–°ä»¤ç‰Œ</li><li>6. åˆ é™¤ä»¤ç‰Œ</li><li class=ql-indent-1>6.1 åˆ é™¤è®¿é—®ä»¤ç‰Œ</li><li class=ql-indent-1>6.2 åˆ é™¤åˆ·æ–°ä»¤ç‰Œ</li><li class=ql-indent-1>6.3 RFC7009 - OAuth2 Token Revocation</li><li>7. ä»¤ç‰Œå…ƒæ•°æ®</li><li>666. å½©è›‹</li></ul><hr><h1><strong>1. æ¦‚è¿°</strong></h1><p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥å…¥é—¨ Spring Security OAuth2.0 çš„ä½¿ç”¨ã€‚é€šè¿‡æœ¬æ–‡ï¼Œå¸Œæœ›ä½ å¯¹ OAuth2.0 æœ‰ä¸€æ¬¡èº«ä¸´å…¶å¢ƒçš„æ„Ÿå—ã€‚</p><p>å¦å¤–ï¼Œè¿™æ˜¯ä¸€ç¯‡å…¥é—¨çš„æ–‡ç« ï¼Œæ‰€ä»¥å®é™…åœºæ™¯ä¸‹ï¼Œéœ€è¦åšä¸€äº›å¾®è°ƒã€‚å½“ç„¶ï¼Œéœ€è¦å¾®è°ƒçš„åœ°æ–¹ï¼Œç¬”è€…ä¼šåœ¨ç¤ºä¾‹ä¸­è¯´æ˜ï¼Œä»¥å…è¯¯å¯¼ã€‚</p><p>å¦‚æœä½ æ˜¯ OAuth2.0 çš„èŒæ–°ï¼Œå»ºè®®å…ˆé€šè¯»é˜®ä¸€å³°å¤§ç¥çš„ ã€Šç†è§£OAuth 2.0ã€‹ã€‚å› ä¸ºï¼Œæœ¬æ–‡ä¸ä¼šå»é˜è¿° OAuth2.0 æ¦‚å¿µéƒ¨åˆ†çš„å†…å®¹ã€‚æˆ–è€…ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹ ã€ŠOAuth 2.0æœ€ç®€å‘å¯¼ã€‹ ï¼Œæ¯”è¾ƒç”ŸåŠ¨å½¢è±¡ã€‚</p><p>é˜…è¯»å®Œæœ¬æ–‡åï¼Œä½ æƒ³è¦æ›´åŠ æ·±å…¥çš„ç†è§£ OAuth2.0 ï¼Œå¯ä»¥é˜…è¯»å¦‚ä¸‹ä¸¤æœ¬ä¹¦ç±ï¼š</p><ul><li>ã€ŠOAuth2 in Actionã€‹ é‡åŸç†</li><li>ã€ŠOAuth2 2.0 Cookbookã€‹ é‡å®è·µï¼ŒåŸºäº Spring Security OAuth2 ã€‚</li></ul><p>é˜…è¯»å®Œæœ¬æ–‡åï¼Œä½ æƒ³è¦äº†è§£æºç ï¼Œå¯ä»¥é˜…è¯»è€å¾çš„ä¸¤ç¯‡æ–‡ç« ï¼š</p><ul><li>ã€ŠReï¼šä»é›¶å¼€å§‹çš„Spring Security OAuth2ï¼ˆäºŒï¼‰ã€‹</li><li>ã€ŠReï¼šä»é›¶å¼€å§‹çš„Spring Security OAuth2ï¼ˆä¸‰ï¼‰ã€‹</li></ul><hr><p>OKï¼Œä¸€æ³¢å®‰åˆ©ä¹‹åï¼Œæˆ‘ä»¬æ¥ä¸€èµ·è¿›å…¥æ­£æ–‡ã€‚å¯¹äº Spring Security OAuth2 çš„é…ç½®ï¼Œå¤§ä½“æ¥è¯´ï¼Œå°±æ˜¯<strong>ä¸¤æ­¥</strong>ï¼š</p><ol><li>é…ç½®æˆæƒæœåŠ¡å™¨( AuthorizationServer )</li><li>é…ç½®èµ„æºæœåŠ¡å™¨( ResourceServer )</li></ol><h1><strong>2. å¼•å…¥ Spring Security OAuth2 ä¾èµ–</strong></h1><p>åœ¨ pom.xml æ–‡ä»¶ä¸­ï¼Œå¼•å…¥å¦‚ä¸‹:</p><pre>&lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;1.5.16.RELEASE&lt;/version&gt; &lt;relativePath /&gt; &lt;!-- lookup parent from repository --&gt;&lt;/parent&gt;&lt;dependencies&gt; &lt;!-- for Spring MVC --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- for Spring Security --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- for OAuth 2.0 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt; &lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt;</pre><p>å› ä¸ºï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ SpringBoot çš„ç‰ˆæœ¬ä¸º 1.5.16.RELEASE ï¼Œæ‰€ä»¥ä½¿ç”¨çš„ Spring Security çš„ç‰ˆæœ¬ä¸º 4.2.8.RELEASE ï¼ŒSpring Security OAuth2 çš„ç‰ˆæœ¬ä¸º 2.2.0.15.RELEASE ã€‚</p><h1><strong>3. é…ç½®èµ„æºæœåŠ¡å™¨</strong></h1><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œèµ„æºæœåŠ¡å™¨æŒ‡çš„æ˜¯ï¼Œæˆ‘ä»¬æä¾› API çš„åº”ç”¨æˆ–æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œè®¢å•æœåŠ¡ã€å•†å“æœåŠ¡ã€‚<strong>è€ƒè™‘åˆ°è®©æ•´ä¸ªç¤ºä¾‹æ›´åŠ ç®€å•ï¼Œæœ¬æ–‡å…ˆå°†å®ƒå’ŒæˆæƒæœåŠ¡å™¨æ”¾åœ¨ä¸€ä¸ª Maven é¡¹ç›®ä¸­</strong>ã€‚</p><p>â‘  åˆ›å»ºä¸€ä¸ª Controller ç±»</p><pre>/** * ç¤ºä¾‹æ¨¡å— Controller */@RestController@RequestMapping("/api/example")public class ExampleController { @RequestMapping("/hello") public String hello() { return "world"; }}</pre><ul><li>éå¸¸ç®€å•ï¼Œè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ¨¡å—çš„ Controller ï¼Œæä¾› /api/example/hello æ¥å£ã€‚</li></ul><p>â‘¡ é…ç½®èµ„æºæœåŠ¡å™¨</p><pre>// èµ„æºæœåŠ¡é…ç½®@Configuration@EnableResourceServerpublic class OAuth2ResourceServer extends ResourceServerConfigurerAdapter { @Override public void configure(HttpSecurity http) throws Exception { http.authorizeRequests() // å¯¹ "/api/**" å¼€å¯è®¤è¯ .anyRequest() .authenticated() .and() .requestMatchers() .antMatchers("/api/**"); }}</pre><ul><li>@Configuration æ³¨è§£ï¼Œä¿è¯ OAuth2ResourceServer èƒ½å¤Ÿè¢« SpringBoot æ‰«æåˆ°é…ç½®ã€‚</li><li>@EnableResourceServer æ³¨è§£ï¼Œå¼€å¯èµ„æºæœåŠ¡å™¨ã€‚</li><li>ç»§æ‰¿( extends ) ResourceServerConfigurerAdapter ç±»ï¼Œå¹¶è¦†å†™ #configure(HttpSecurity http) æ–¹æ³•ï¼Œé…ç½®å¯¹ HTTP è¯·æ±‚ä¸­ï¼ŒåŒ¹é… /api/**" è·¯å¾„ï¼Œå¼€å¯è®¤è¯çš„éªŒè¯ã€‚</li></ul><h1><strong>4. é…ç½®æˆæƒæœåŠ¡å™¨</strong></h1><p>åœ¨ OAuth2.0 ä¸­ï¼Œå®šä¹‰äº†<strong>å››ç§</strong>æˆæƒæ¨¡å¼ï¼š</p><ul><li>æˆæƒç æ¨¡å¼( authorization code )</li><li>å¯†ç æ¨¡å¼( resource owner password credentials )</li><li>ç®€åŒ–æ¨¡å¼( implicit )</li><li>å®¢æˆ·ç«¯æ¨¡å¼( client credentials )</li></ul><p>æ‰€ä»¥ï¼Œç¬”è€…åœ¨ SpringBoot-Labs/lab-02 ç›®å½•ä¸‹ï¼Œæ¯ä¸€ç§æ–¹å¼ï¼Œéƒ½æä¾›äº†ä¸€ä¸ª Maven é¡¹ç›®ç¤ºä¾‹ã€‚</p><p><strong>4.1 æˆæƒç æ¨¡å¼</strong></p><p>Maven é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/30b7584056744a0eb2d53d1f039f7bb7><p class=pgc-img-caption></p></div><p>Maven é¡¹ç›®ç»“æ„</p><p>å¯¹åº” GitHub åœ°å€ï¼šhttps://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-02/authorization-code-server</p><p>â‘  é…ç½®æˆæƒæœåŠ¡å™¨</p><pre>// æˆæƒæœåŠ¡å™¨é…ç½®@Configuration@EnableAuthorizationServerpublic class OAuth2AuthorizationServer extends AuthorizationServerConfigurerAdapter { @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception { clients.inMemory() // &lt;1&gt; // &lt;2&gt; begin ... .withClient("clientapp").secret("112233") // Client è´¦å·ã€å¯†ç ã€‚ .redirectUris("http://localhost:9001/callback") // é…ç½®å›è°ƒåœ°å€ï¼Œé€‰å¡«ã€‚ .authorizedGrantTypes("authorization_code") // æˆæƒç æ¨¡å¼ .scopes("read_userinfo", "read_contacts") // å¯æˆæƒçš„ Scope // &lt;2&gt; end ...// .and().withClient() // å¯ä»¥ç»§ç»­é…ç½®æ–°çš„ Client // &lt;3&gt; ; }}</pre><ul><li>@Configuration æ³¨è§£ï¼Œä¿è¯ OAuth2AuthorizationServer èƒ½å¤Ÿè¢« SpringBoot æ‰«æåˆ°é…ç½®ã€‚</li><li>@EnableAuthorizationServer æ³¨è§£ï¼Œå¼€å¯æˆæƒæœåŠ¡å™¨ã€‚</li><li>&lt;1> å¤„ï¼ŒåŸºäºå†…å­˜ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ã€‚å®é™…æƒ…å†µä¸‹ï¼Œæœ€å¥½æ”¾å…¥<strong>æ•°æ®åº“</strong>ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚</li><li>&lt;2> å¤„ï¼Œåˆ›å»ºä¸€ä¸ª Client é…ç½®ã€‚</li><li>&lt;3> å¤„ï¼Œå¯ä»¥ä½¿ç”¨ #and() æ–¹æ³•ï¼Œç»§ç»­æ·»åŠ å¦å¤–çš„ Client é…ç½®ã€‚</li></ul><p>â‘¡ é…ç½®ç™»é™†è´¦å·</p><p>åˆ›å»º application.properties æ–‡ä»¶ï¼Œå¹¶é…ç½®å¦‚ä¸‹ï¼š</p><pre># Spring Security Settingsecurity.user.name=yunaisecurity.user.password=1024</pre><ul><li>è¿™é‡Œé…ç½®äº†ä¸€ä¸ªè´¦å·ä¸º "yunai" ï¼Œå¯†ç ä¸º "1024" çš„ç™»é™†è´¦æˆ·ã€‚</li><li>å®é™…ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œç™»é™†è´¦å·çš„æ•°æ®ï¼Œè‚¯å®šæ˜¯æ”¾åœ¨<strong>æ•°æ®åº“</strong>ä¸­ã€‚</li></ul><p>â‘¢ å¯åŠ¨é¡¹ç›®</p><pre>@SpringBootApplicationpublic class Application { public static void main(String[] args) { SpringApplication.run(Application.class, args); }}</pre><p>å¯åŠ¨é¡¹ç›®</p><p>â‘£ è·å–æˆæƒç </p><p>4.1 æµè§ˆå™¨æ‰“å¼€ http://localhost:8080/oauth/authorize?client_id=clientapp&redirect_uri=http://localhost:9001/callback&response_type=code&scope=read_userinfo</p><ul><li>client_id å‚æ•°ï¼Œ<strong>å¿…ä¼ </strong>ï¼Œä¸ºæˆ‘ä»¬åœ¨ OAuth2AuthorizationServer ä¸­é…ç½®çš„ Client çš„ç¼–å·ã€‚</li><li>redirect_url å‚æ•°ï¼Œ<strong>å¯é€‰</strong>ï¼Œå›è°ƒåœ°å€ã€‚å½“ç„¶ï¼Œå¦‚æœ client_id å¯¹åº”çš„ Client æœªé…ç½® redirectUris å±æ€§ï¼Œä¼šæŠ¥é”™ã€‚</li><li>response_type å‚æ•°ï¼Œ<strong>å¿…ä¼ </strong>ï¼Œè¿”å›ç»“æœä¸º<strong>æˆæƒç </strong>ã€‚</li><li>scope å‚æ•°ï¼Œ<strong>å¯é€‰</strong>ï¼Œç”³è¯·æˆæƒçš„ Scope ã€‚å¦‚æœå¤šä¸ªï¼Œä½¿ç”¨é€—å·åˆ†éš”ã€‚</li><li>state å‚æ•°ï¼Œ<strong>å¯é€‰</strong>ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼ã€‚</li><li class=ql-indent-1><em>æœªåœ¨ä¸Šè¿° URL ä¸­ä½“ç°å‡ºæ¥</em>ã€‚</li></ul><p>4.2 æµè§ˆå™¨æ‰“å¼€åï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2c0398b6bfa446ad8f35c8a8cff08e0c><p class=pgc-img-caption></p></div><p>æµè§ˆå™¨</p><ul><li>è¾“å…¥åœ¨ ã€Œâ‘¡ é…ç½®ç™»é™†è´¦å·ã€ ä¸­é…ç½®çš„ç™»é™†è´¦å· "yunai" / "1024" ã€‚</li><li>å®é™…ç”Ÿäº§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä»¥ QQ ä¸‰æ–¹ç™»é™†ä½œä¸ºä¾‹å­ï¼Œå¦‚ä¸‹å›¾ï¼š</li></ul><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0e54b12c8993489e9b338e0ec9cdbfbb><p class=pgc-img-caption></p></div><ul><li>QQ ç¤ºä¾‹</li></ul><p>4.3 ç™»é™†æˆåŠŸï¼Œé€‰æ‹©å…è®¸æ‰€æœ‰ç”³è¯·çš„ Scope ï¼Œç‚¹å‡»ã€Authorizeã€‘æŒ‰é’®ï¼Œç¡®è®¤æˆæƒã€‚å¦‚ä¸‹å›¾ï¼š</p><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5d74dc322da1462fa716502d32d37942><p class=pgc-img-caption></p></div><p>Authorize</p><p>4.4 æˆæƒå®Œæˆï¼Œå›è°ƒ redirect_uri åœ°å€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/583e98bb10534b13b4b33a404d7d6a91><p class=pgc-img-caption></p></div><p>å›è°ƒåœ°å€</p><ul><li>code å‚æ•°ï¼Œå°±æ˜¯è¿”å›çš„æˆæƒç ã€‚</li></ul><p>â‘¤ è·å–è®¿é—®ä»¤ç‰Œ</p><pre>curl -X POST --user clientapp:112233 http://localhost:8080/oauth/token -H "content-type: application/x-www-form-urlencoded" -d "code=UydkmV&amp;grant_type=authorization_code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A9001%2Fcallback&amp;scope=read_userinfo"</pre><ul><li>--user clientapp:112233 å¤„ï¼Œå¡«å†™æˆ‘ä»¬åœ¨ OAuth2AuthorizationServer ä¸­é…ç½®çš„ Client çš„ç¼–å·å’Œå¯†ç ã€‚</li><li>code=UydkmV å¤„ï¼Œå¡«å†™åœ¨ ã€Œâ‘£ è·å–æˆæƒç ã€ ä¸­è·å–çš„æˆæƒç ( code ) ã€‚</li></ul><p>è¿”å›ç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre>{ "access_token": "e60e41f2-2ad0-4c79-97d5-49af38e5c2e8",  "token_type": "bearer",  "expires_in": 43199,  "scope": "read_userinfo"}</pre><ul><li>access_token å±æ€§ï¼Œè®¿é—®ä»¤ç‰Œã€‚<strong>éç©º</strong>ã€‚</li><li>token_type å±æ€§ï¼Œä»¤ç‰Œç±»å‹ï¼Œå¯ä»¥æ˜¯ "bearer" æˆ– "mac" ç±»å‹ã€‚<strong>éç©º</strong>ã€‚</li><li>expires_in å±æ€§ï¼Œè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéç©ºã€‚</li><li>scope å±æ€§ï¼Œæƒé™èŒƒå›´ã€‚å¦‚æœä¸ Client ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚</li><li>refresh_token å±æ€§ï¼Œåˆ·æ–°ä»¤ç‰Œï¼Œç”¨æ¥è·å–ä¸‹ä¸€æ¬¡çš„è®¿é—®ä»¤ç‰Œã€‚</li><li class=ql-indent-1>åœ¨æˆæƒç æ¨¡å¼ä¸‹ï¼Œ<strong>å…è®¸ä¸ºç©º</strong>ã€‚</li></ul><p>å¯èƒ½æœ‰éƒ¨åˆ†èƒ–å‹æ˜¯ Windows ç”µè„‘ï¼Œå¯ä»¥å‚è€ƒ ã€Šwindowsï¼ˆ64ä½ï¼‰ä¸‹ä½¿ç”¨ curl å‘½ä»¤ã€‹ æ¥å®‰è£…ä¸€ä¸ª curl å‘½ä»¤ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœèƒ–å‹ä½¿ç”¨ Postman ï¼Œå¯ä»¥å‚çœ‹å¦‚ä¸‹ä¸¤å›¾ï¼š</p><ul><li><br></li></ul><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ac0e54ab22eb41ddae5c3dc910be6adb><p class=pgc-img-caption></p></div><ul><li>å›¾ 1</li></ul><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/db6f5dd8b9654d82978837aa59292829><p class=pgc-img-caption></p></div><ul><li>å›¾ 2</li></ul><p>â‘¥ è°ƒç”¨èµ„æºæœåŠ¡å™¨çš„ API</p><pre>curl -X GET http://localhost:8080/api/example/hello -H "authorization: Bearer e60e41f2-2ad0-4c79-97d5-49af38e5c2e8"</pre><ul><li>authorization: Bearer e60e41f2-2ad0-4c79-97d5-49af38e5c2e8 å¤„ï¼Œå¡«å†™æŒ‡å®šçš„è®¿é—®ä»¤ç‰Œç±»å‹å’Œè®¿é—®ä»¤ç‰Œã€‚ä¾‹å¦‚æ­¤å¤„åˆ†åˆ«ä¸ºï¼Œ"Bearer"ã€"e60e41f2-2ad0-4c79-97d5-49af38e5c2e8" ã€‚</li></ul><p>å¦‚æœèƒ–å‹ä½¿ç”¨ Postman ï¼Œå¯ä»¥å‚çœ‹å¦‚ä¸‹å›¾ï¼š</p><ul><li><br></li></ul><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1cf8acd198fa4fa0a6879e1f7fe0a231><p class=pgc-img-caption></p></div><ul><li>å›¾</li></ul><p><strong>4.2 å¯†ç æ¨¡å¼</strong></p><p>Maven é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/805fda53fe80438d9185ed53ec3f9ee1><p class=pgc-img-caption></p></div><p>Maven é¡¹ç›®ç»“æ„</p><p>å¯¹åº” GitHub åœ°å€ï¼šhttps://github.com/YunaiV/SpringBoot-Labs/tree/f8d701cbd9b2a4f2cee3a7f2186148bcdf859895/lab-02/resource-owner-password-credentials-server</p><p>â‘  é…ç½®æˆæƒæœåŠ¡å™¨</p><pre>// æˆæƒæœåŠ¡å™¨é…ç½®@Configuration@EnableAuthorizationServerpublic class OAuth2AuthorizationServer extends AuthorizationServerConfigurerAdapter { // ç”¨æˆ·è®¤è¯ @Autowired private AuthenticationManager authenticationManager; @Override public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception { endpoints.authenticationManager(authenticationManager); } @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception { clients.inMemory() .withClient("clientapp").secret("112233") // Client è´¦å·ã€å¯†ç ã€‚ .authorizedGrantTypes("password") // å¯†ç æ¨¡å¼ .scopes("read_userinfo", "read_contacts") // å¯æˆæƒçš„ Scope// .and().withClient() // å¯ä»¥ç»§ç»­é…ç½®æ–°çš„ Client ; }}</pre><ul><li>é…ç½® Client çš„æ–¹å¼ï¼Œå’Œã€æˆæƒç æ¨¡å¼ã€‘åŸºæœ¬ä¸€è‡´ã€‚å·®åˆ«åœ¨äºï¼š</li><li class=ql-indent-1>æ— éœ€é…ç½® `redirectUris` å±æ€§ï¼Œå› ä¸ºä¸éœ€è¦å›è°ƒåœ°å€ã€‚</li><li class=ql-indent-1>é…ç½®æˆæƒæ¨¡å¼ä¸ºã€<strong>å¯†ç æ¨¡å¼</strong>ã€‘ã€‚</li><li>å¦å¤–ï¼Œéœ€è¦å¼•å…¥ <strong>AuthenticationManager</strong> æ¥æ”¯æŒã€å¯†ç æ¨¡å¼ã€‘ï¼Œå¦åˆ™ä¼šæŠ¥ "Resolved [error="unsupported_grant_type", error_description="Unsupported grant type: password"]" å¼‚å¸¸ã€‚</li></ul><p>â‘¡ é…ç½®ç™»é™†è´¦å·</p><p>å’Œã€æˆæƒç æ¨¡å¼ã€‘<strong>ä¸€è‡´</strong>ã€‚</p><p>â‘¢ å¯åŠ¨é¡¹ç›®</p><p>å’Œã€æˆæƒç æ¨¡å¼ã€‘<strong>ä¸€è‡´</strong>ã€‚</p><p>â‘£ è·å–è®¿é—®ä»¤ç‰Œ</p><pre>curl -X POST --user clientapp:112233 http://localhost:8080/oauth/token -H "accept: application/json" -H "content-type: application/x-www-form-urlencoded" -d "grant_type=password&amp;username=yunai&amp;password=1024&amp;scope=read_userinfo"</pre><ul><li>å’Œã€æˆæƒç æ¨¡å¼ã€‘å·®å¼‚æ¯”è¾ƒå¤§ã€‚</li><li>ç›´æ¥è¯·æ±‚ oauth/token æ¥å£ï¼Œè·å¾—è®¿é—®ä»¤ç‰Œã€‚</li><li>è¯·æ±‚å‚æ•°å¸¦ä¸Šäº† username å’Œ password ï¼Œå°±ç”¨æˆ·çš„ç™»é™†è´¦å·å’Œå¯†ç ã€‚</li><li>è¯·æ±‚å‚æ•° grant_type ä¸º password ï¼Œè¡¨ç¤ºã€å¯†ç æ¨¡å¼ã€‘ã€‚</li></ul><p>è¿”å›ç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre>{ "access_token": "68de6eb9-5672-4e47-a3e6-110404285ba9", "token_type": "bearer", "expires_in": 43199, "scope": "read_userinfo"}</pre><ul><li>å’Œã€æˆæƒç æ¨¡å¼ã€‘ä¸€è‡´ã€‚</li></ul><p>â‘¤ è°ƒç”¨èµ„æºæœåŠ¡å™¨çš„ API</p><p>å’Œã€æˆæƒç æ¨¡å¼ã€‘<strong>ä¸€è‡´</strong>ã€‚</p><p><strong>4.3 ç®€åŒ–æ¨¡å¼</strong></p><p>Maven é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/07b3cdb156354222bf76ff9c252080e4><p class=pgc-img-caption></p></div><p>Maven é¡¹ç›®ç»“æ„</p><p>å¯¹åº” GitHub åœ°å€ï¼šhttps://github.com/YunaiV/SpringBoot-Labs/tree/f8d701cbd9b2a4f2cee3a7f2186148bcdf859895/lab-02/implicit-server</p><p>â‘  é…ç½®æˆæƒæœåŠ¡å™¨</p><pre>// æˆæƒæœåŠ¡å™¨é…ç½®@Configuration@EnableAuthorizationServerpublic class OAuth2AuthorizationServer extends AuthorizationServerConfigurerAdapter { @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception { clients.inMemory() .withClient("clientapp").secret("112233") // Client è´¦å·ã€å¯†ç ã€‚ .redirectUris("http://localhost:9001/callback") // é…ç½®å›è°ƒåœ°å€ï¼Œé€‰å¡«ã€‚ .authorizedGrantTypes("implicit") // æˆæƒç æ¨¡å¼ .scopes("read_userinfo", "read_contacts") // å¯æˆæƒçš„ Scope// .and().withClient() // å¯ä»¥ç»§ç»­é…ç½®æ–°çš„ Client ; }}</pre><ul><li>å’Œã€æˆæƒç æ¨¡å¼ã€‘åŸºæœ¬ä¸€è‡´ã€‚å·®åˆ«<strong>ä»…ä»…</strong>åœ¨äºï¼šé…ç½®æˆæƒæ¨¡å¼ä¸ºã€ç®€åŒ–æ¨¡å¼ã€‘ã€‚</li></ul><blockquote><p>FROM ã€Šç†è§£ OAuth 2.0ã€‹</p><p>ç®€åŒ–æ¨¡å¼ï¼ˆimplicit grant typeï¼‰ä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè·³è¿‡äº†"æˆæƒç "è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤å¾—åã€‚æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯å¯è§çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è®¤è¯ã€‚</p></blockquote><p>â‘¡ é…ç½®ç™»é™†è´¦å·</p><p>å’Œã€æˆæƒç æ¨¡å¼ã€‘ä¸€è‡´ã€‚</p><p>â‘¢ å¯åŠ¨é¡¹ç›®</p><p>å’Œã€æˆæƒç æ¨¡å¼ã€‘ä¸€è‡´ã€‚</p><p>â‘£ è·å–æˆæƒç </p><p>4.1 æµè§ˆå™¨æ‰“å¼€ http://localhost:8080/oauth/authorize?client_id=clientapp&redirect_uri=http://localhost:9001/callback&response_type=implicit&scope=read_userinfo</p><ul><li>å’Œã€æˆæƒç æ¨¡å¼ã€‘åŸºæœ¬ä¸€è‡´ã€‚å·®åˆ«<strong>ä»…ä»…</strong>åœ¨äºï¼šè¯·æ±‚å‚æ•° response_type ä¸º "implicit" ç®€åŒ–æ¨¡å¼ã€‚</li></ul><p>4.2 æµè§ˆå™¨æ‰“å¼€åï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e12f36b8e90249cfb2ae9ea547800601><p class=pgc-img-caption></p></div><p>æµè§ˆå™¨</p><ul><li>å’Œã€æˆæƒç æ¨¡å¼ã€‘åŸºæœ¬ä¸€è‡´ï¼Œè¾“å…¥åœ¨ ã€Œâ‘¡ é…ç½®ç™»é™†è´¦å·ã€ ä¸­é…ç½®çš„ç™»é™†è´¦å· "yunai" / "1024" ã€‚</li></ul><p>4.3 ç™»é™†æˆåŠŸï¼Œç›´æ¥æˆæƒå®Œæˆï¼Œå›è°ƒ redirect_uri åœ°å€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0fd5174469084e718cfe845c9131b93e><p class=pgc-img-caption></p></div><p>æµè§ˆå™¨</p><ul><li>å’Œã€æˆæƒç æ¨¡å¼ã€‘åŸºæœ¬ä¸ä¸€è‡´çš„æœ‰<strong>ä¸¤ç‚¹</strong>ï¼š</li><li class=ql-indent-1>ç™»é™†æˆåŠŸåï¼Œ<strong>æ— éœ€</strong>é€‰æ‹©å…è®¸æ‰€æœ‰ç”³è¯·çš„ Scope ï¼Œç›´æ¥æˆæƒå®Œæˆã€‚</li><li class=ql-indent-1>è¿”å›çš„ä¸æ˜¯æˆæƒç ï¼Œè€Œæ˜¯<strong>è®¿é—®ä»¤ç‰Œ</strong>ã€‚</li></ul><blockquote><p>æ€»çš„æ¥è¯´ï¼Œã€ç®€åŒ–æ¨¡å¼ã€‘æ˜¯ã€æˆæƒç æ¨¡å¼ã€‘çš„ç®€åŒ–æ¨¡å¼ã€‚</p></blockquote><p>â‘¤ è°ƒç”¨èµ„æºæœåŠ¡å™¨çš„ API</p><p>å’Œã€æˆæƒç æ¨¡å¼ã€‘ä¸€è‡´ã€‚</p><p><strong>4.4 å®¢æˆ·ç«¯æ¨¡å¼</strong></p><p>Maven é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/642724b17b7f416daebf5f9273ad8640><p class=pgc-img-caption></p></div><p>Maven é¡¹ç›®ç»“æ„</p><p>å¯¹åº” GitHub åœ°å€ï¼šhttps://github.com/YunaiV/SpringBoot-Labs/tree/f8d701cbd9b2a4f2cee3a7f2186148bcdf859895/lab-02/client-credentials-server</p><p>â‘  é…ç½®æˆæƒæœåŠ¡å™¨</p><p>å’Œã€å¯†ç æ¨¡å¼ã€‘ä¸€è‡´ã€‚</p><p>â‘¡ é…ç½®ç™»é™†è´¦å·</p><p>å®ƒ<strong>æ— éœ€</strong>é…ç½®ç™»é™†è´¦å·ã€‚å› ä¸ºå®ƒæ²¡æœ‰ç”¨æˆ·çš„æ¦‚å¿µï¼Œç›´æ¥ä¸æˆæƒæœåŠ¡å™¨äº¤äº’ï¼Œé€šè¿‡ Client çš„ç¼–å·( client_id )å’Œå¯†ç ( client_secret )æ¥ä¿è¯å®‰å…¨æ€§ã€‚</p><p>â‘¢ å¯åŠ¨é¡¹ç›®</p><p>å’Œã€å¯†ç æ¨¡å¼ã€‘ä¸€è‡´ã€‚</p><p>â‘£ è·å–è®¿é—®ä»¤ç‰Œ</p><pre>curl -X POST "http://localhost:8080/oauth/token" --user clientapp:112233 -d "grant_type=client_credentials&amp;scope=read_contacts"</pre><ul><li>å’Œã€å¯†ç æ¨¡å¼ã€‘åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«å¦‚ä¸‹ï¼š</li><li class=ql-indent-1>è¯·æ±‚å‚æ•°<strong>æ— éœ€</strong>å¸¦ä¸Šäº† `username` å’Œ `password` ã€‚</li><li class=ql-indent-1>è¯·æ±‚å‚æ•° `grant_type` ä¸º `client_credentials` ï¼Œè¡¨ç¤ºã€å¯†ç æ¨¡å¼ã€‘ã€‚</li></ul><p>è¿”å›ç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre>{ "access_token":"cb2bdfd8-18fa-4b8f-b525-10587bd672e8", "token_type":"bearer", "expires_in":43199, "scope":"read_contacts"}</pre><ul><li>å’Œã€å¯†ç æ¨¡å¼ã€‘ä¸€è‡´ã€‚</li></ul><p>â‘¤ è°ƒç”¨èµ„æºæœåŠ¡å™¨çš„ API</p><p>å’Œã€å¯†ç æ¨¡å¼ã€‘<strong>ä¸€è‡´</strong>ã€‚</p><blockquote><p>æ€»çš„æ¥è¯´ï¼Œã€å®¢æˆ·ç«¯æ¨¡å¼ã€‘æ˜¯ã€å¯†ç æ¨¡å¼ã€‘çš„ç®€åŒ–æ¨¡å¼ã€‚</p></blockquote><p><strong>4.5 å¦‚ä½•é€‰æ‹©ï¼Ÿ</strong></p><p>å¯èƒ½å¾ˆå¤šèƒ–å‹ï¼Œæœ‰è·Ÿç¬”è€…ä¸€æ ·çš„å›°æƒ‘ã€‚ä¸‹é¢ç¬”è€…å¼•ç”¨æ¨æ³¢è€å¸ˆçš„ä¸€å¼ å›¾ï¼Œç›¸ä¿¡èƒ½è§£å†³æˆ‘ä»¬çš„å›°æ‰°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><blockquote><p>FROM ã€Šæ·±åº¦å‰–æ OAuth2 å’Œå¾®æœåŠ¡å®‰å…¨æ¶æ„ã€‹</p></blockquote><div class=pgc-img><img alt="Spring Security OAuth2 å…¥é—¨" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7509a1cd750a40319046830196d1ef53><p class=pgc-img-caption></p></div><blockquote><p>æˆæƒç±»å‹é€‰æ‹©</p></blockquote><p>å½“ç„¶ï¼Œå¯¹äº<strong>é»„æ¡†</strong>éƒ¨åˆ†ï¼Œå¯¹äºç¬”è€…è¿˜æ˜¯æ¯”è¾ƒå›°æƒ‘çš„ã€‚ç¬”è€…è®¤ä¸ºï¼Œç¬¬ä¸‰æ–¹çš„å•é¡µåº”ç”¨ SPA ï¼Œä¹Ÿæ˜¯é€‚åˆé‡‡ç”¨ Authorization Code Grant æˆæƒæ¨¡å¼çš„ã€‚ä¾‹å¦‚ï¼Œã€Šå¾®ä¿¡ç½‘é¡µæˆæƒã€‹ ï¼š</p><blockquote><p>å…·ä½“è€Œè¨€ï¼Œç½‘é¡µæˆæƒæµç¨‹åˆ†ä¸ºå››æ­¥ï¼š</p><p>1ã€å¼•å¯¼ç”¨æˆ·è¿›å…¥æˆæƒé¡µé¢åŒæ„æˆæƒï¼Œè·å–code</p><p>2ã€é€šè¿‡codeæ¢å–ç½‘é¡µæˆæƒaccess_tokenï¼ˆä¸åŸºç¡€æ”¯æŒä¸­çš„access_tokenä¸åŒï¼‰</p><p>3ã€å¦‚æœéœ€è¦ï¼Œå¼€å‘è€…å¯ä»¥åˆ·æ–°ç½‘é¡µæˆæƒaccess_tokenï¼Œé¿å…è¿‡æœŸ</p><p>4ã€é€šè¿‡ç½‘é¡µæˆæƒaccess_tokenå’Œopenidè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆæ”¯æŒUnionIDæœºåˆ¶ï¼‰</p></blockquote><p>æ‰€ä»¥ï¼Œç¬”è€…çŒœæµ‹ï¼Œä¹‹æ‰€ä»¥å›¾ä¸­ç”»çš„æ˜¯ Implicit Grant çš„åŸå› æ˜¯ï¼Œå— Google çš„ ã€ŠOAuth 2.0 for Client-side Web Applicationsã€‹ ä¸€æ–‡ä¸­ï¼Œæ¨èä½¿ç”¨äº† Implicit Grant ã€‚</p><p>å½“ç„¶ï¼Œå…·ä½“ä½¿ç”¨ Implicit Grant è¿˜æ˜¯ Authorization Code Grant æˆæƒæ¨¡å¼ï¼Œæ²¡æœ‰å®šè®ºã€‚ç¬”è€…ï¼Œåå‘äºä½¿ç”¨ <strong>Authorization Code Grant</strong>ï¼Œå¯¹äºç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯çš„åœºæ™¯ã€‚</p><p><strong>4.6 ä¸ºä»€ä¹ˆæœ‰ Client ç¼–å·å’Œå¯†ç </strong></p><p>æˆ‘ä»¬çœ‹åˆ°ä¸Šè¿°å››ç§æˆæƒæ¨¡å¼ï¼Œæ— è®ºæ˜¯å“ªä¸€ç§ï¼Œæœ€ç»ˆè°ƒç”¨æˆæƒæœåŠ¡å™¨æ—¶ï¼Œéƒ½ä¼šä¼ é€’ Client ç¼–å·å’Œå¯†ç ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿé€šè¿‡ Client ç¼–å·å’Œå¯†ç ï¼ŒæˆæƒæœåŠ¡å™¨å¯ä»¥çŸ¥é“è°ƒç”¨çš„æ¥æºä»¥åŠæ­£ç¡®æ€§ã€‚è¿™æ ·ï¼Œå³ä½¿â€œåäººâ€æ‹¿åˆ° Access Token ï¼Œä½†æ˜¯æ²¡æœ‰ Client ç¼–å·å’Œå¯†ç ï¼Œä¹Ÿä¸èƒ½å’ŒæˆæƒæœåŠ¡å™¨å‘ç”Ÿ<strong>æœ‰æ•ˆ</strong>çš„äº¤äº’ã€‚</p><h1><strong>5. åˆ·æ–°ä»¤ç‰Œ</strong></h1><p>åœ¨ ã€Œ4. é…ç½®æˆæƒæœåŠ¡å™¨ã€ ä¸­ï¼Œæˆ‘ä»¬ä¸€ç›´æ²¡æœ‰çœ‹åˆ°æˆ‘ä»¬æœŸç›¼çš„åˆ·æ–°ä»¤ç‰Œ( refresh token )çš„èº«å½±ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨é…ç½® Spring Security OAuth2 å¹¶æœªé…ç½®ï¼Œè·å–è®¿é—®ä»¤ç‰Œçš„åŒæ—¶ï¼Œè·å–åˆ·æ–°ä»¤ç‰Œã€‚</p><p>é‚£ä¹ˆï¼Œæ€ä¹ˆé…ç½®å¼€å¯è·å–åˆ·æ–°ä»¤ç‰Œçš„åŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹ ã€Œ5.1 è·å–åˆ·æ–°ä»¤ç‰Œã€ ã€‚</p><p><strong>5.1 è·å–åˆ·æ–°ä»¤ç‰Œ</strong></p><p>å› ä¸ºã€å¯†ç æ¨¡å¼ã€‘ç›¸å¯¹ç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨åŸæœ‰ç¨‹åºä¸Šåšæ”¹é€ ã€‚å¯¹åº” GitHub åœ°å€ï¼šhttps://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-02/authorization-code-server-with-refresh-token ã€‚</p><blockquote><p>åœ¨æ­¥éª¤ä¸Šï¼Œå¦‚æœå’ŒåŸæœ‰ã€å¯†ç æ¨¡å¼ã€‘ä¿æŒä¸€è‡´çš„åœ°æ–¹ï¼Œä¸‹æ–‡ä¼šè¿›è¡Œçœç•¥ï¼Œå¹¶æ ‡æ³¨â€œå’ŒåŸæœ‰<strong>ä¸€è‡´</strong>â€ã€‚</p></blockquote><p>â‘  é…ç½®æˆæƒæœåŠ¡å™¨</p><pre>// æˆæƒæœåŠ¡å™¨é…ç½®@Configuration@EnableAuthorizationServerpublic class OAuth2AuthorizationServer extends AuthorizationServerConfigurerAdapter { // ç”¨æˆ·è®¤è¯ @Autowired private AuthenticationManager authenticationManager; @Override public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception { endpoints.authenticationManager(authenticationManager); } @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception { clients.inMemory() .withClient("clientapp").secret("112233") // Client è´¦å·ã€å¯†ç ã€‚ .authorizedGrantTypes("password", "refresh_token") // å¯†ç æ¨¡å¼ // &lt;1&gt; .scopes("read_userinfo", "read_contacts") // å¯æˆæƒçš„ Scope// .and().withClient() // å¯ä»¥ç»§ç»­é…ç½®æ–°çš„ Client ; }}</pre><ul><li>åœ¨ &lt;1> å¤„ï¼Œæˆ‘ä»¬å¾ˆç¥å¥‡çš„å¤šé…ç½®äº†ä¸€ä¸ª "refresh_token" ï¼Œç”¨äºå¼€å¯è·å–åˆ·æ–°ä»¤ç‰Œçš„åŠŸèƒ½ã€‚ä½†æ˜¯ä½†æ˜¯ä½†æ˜¯ï¼ŒOAuth2 çš„æˆæƒæ¨¡å¼è¯´å¥½çš„æ˜¯å››ç§çš„ä¹ˆï¼Œæ€ä¹ˆåˆå‡ºç°äº† "refresh_token" è¿™ç§æˆæƒæ¨¡å¼ï¼Ÿæ·¡å®šï¼Œåœ¨ Spring Security OAtuh2 ä¸­ï¼Œ"refresh_token" ä½œä¸ºä¸€ç§ç‰¹æ®Šçš„æˆæƒæ¨¡å¼<strong>é…ç½®</strong>ï¼Œç”¨äºå¼€å¯è·å–åˆ·æ–°ä»¤ç‰Œçš„åŠŸèƒ½ã€‚æ‰€ä»¥ï¼Œå…¶å®ƒæˆæƒæ¨¡å¼å¦‚æœå¼€å¯è·å–åˆ·æ–°ä»¤ç‰Œçš„åŠŸèƒ½ï¼Œéœ€è¦åœ¨ #authorizedGrantTypes(â€¦) è®¾ç½®æ—¶ï¼Œå¤šä¼ å…¥ "refresh_token" æ–¹æ³•å‚æ•°ã€‚</li></ul><p>â‘¡ é…ç½®ç™»é™†è´¦å·</p><p>å’ŒåŸæœ‰<strong>ä¸€è‡´</strong>ã€‚</p><p>â‘¢ å¯åŠ¨é¡¹ç›®</p><p>å’ŒåŸæœ‰<strong>ä¸€è‡´</strong>ã€‚</p><p>â‘£ è·å–è®¿é—®ä»¤ç‰Œ</p><pre>curl -X POST --user clientapp:112233 http://localhost:8080/oauth/token -H "accept: application/json" -H "content-type: application/x-www-form-urlencoded" -d "grant_type=password&amp;username=yunai&amp;password=1024&amp;scope=read_userinfo"</pre><ul><li>å’ŒåŸæœ‰<strong>ä¸€è‡´</strong>ã€‚</li></ul><p>è¿”å›ç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre>{ "access_token":"092a2286-04e7-4e7d-8c20-19fbe25865ff", "token_type":"bearer", "refresh_token":"afeeb083-997f-4ea8-9334-aab6c1696cca", "expires_in":43199, "scope":"read_userinfo"}</pre><ul><li>åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šï¼Œ<strong>å¤š</strong>è¿”å›äº† "refresh_token" åˆ·æ–°ä»¤ç‰Œã€‚ç¾æ»‹æ»‹ã€‚</li></ul><p>â‘¤ è°ƒç”¨èµ„æºæœåŠ¡å™¨çš„ API</p><p>å’ŒåŸæœ‰<strong>ä¸€è‡´</strong>ã€‚</p><p><strong>5.2 â€œåˆ·æ–°â€è®¿é—®ä»¤ç‰Œ</strong></p><p>å› ä¸ºè®¿é—®è®¿é—®ä»¤ç‰Œä¼šè‡ªåŠ¨è¿‡æœŸï¼Œé€šè¿‡ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼Œå¯ä»¥è·å¾—<strong>æ–°çš„</strong>è®¿é—®ä»¤ç‰Œã€‚æ³¨æ„ï¼Œè®¿é—®ä»¤ç‰Œè·å–åˆ°çš„æ˜¯<strong>æ–°çš„</strong>ï¼Œä¸æ˜¯è€çš„å“ˆã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œåœ¨æ ‡é¢˜ä¸Šï¼Œç¬”è€…å¯¹<strong>åˆ·æ–°</strong>åŠ äº†åŒå¼•å·ã€‚</p><pre>curl -i -X POST -u 'clientapp:112233' http://localhost:8080/oauth/token -H "accept: application/json" -d 'grant_type=refresh_token&amp;refresh_token=afeeb083-997f-4ea8-9334-aab6c1696cca'</pre><ul><li>è°ƒç”¨æ¥å£è¿˜æ˜¯ "oauth/token" ï¼Œå·®åˆ«åœ¨äºä¼ å…¥çš„è¯·æ±‚å‚æ•° grant_type ä¸º "refresh_token"ï¼Œä½¿ç”¨åˆ·æ–°ä»¤ç‰Œã€‚</li><li>è¯·æ±‚å‚æ•° refresh_token ä¸ºä¸Šé¢è·å–åˆ°çš„åˆ·æ–°ä»¤ç‰Œ "afeeb083-997f-4ea8-9334-aab6c1696cca" ã€‚</li></ul><p>è¿”å›ç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre>{ "access_token":"507eb761-4b25-4159-b927-ef3eff5e7eff", "token_type":"bearer", "refresh_token":"afeeb083-997f-4ea8-9334-aab6c1696cca", "expires_in":43199, "scope":"read_userinfo"}</pre><ul><li>è·å¾—çš„è®¿é—®ä»¤ç‰Œä¸º "507eb761-4b25-4159-b927-ef3eff5e7eff" ï¼Œæ˜¯<strong>æ–°çš„</strong>ã€‚å¹¶ä¸”ï¼Œè¿‡æœŸæ—¶é—´ä¹Ÿå˜æˆ<strong>æ–°çš„</strong>ã€‚</li></ul><hr><p>ç¬”è€…åœ¨çœ‹ OAuth2.0 çš„åˆ·æ–°ä»¤ç‰Œæ—¶ï¼Œä¸€ç›´æœ‰ä¸ªç–‘æƒ‘ï¼šåˆ·æ–°ä»¤ç‰Œæ˜¯å¦æœ‰è¿‡æœŸæ—¶é—´ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œ<strong>æœ‰</strong>ã€‚ä½†æ˜¯ï¼Œç¬”è€…ä¸å¤ªç¡®å®šï¼Œåœ¨ Spring Security OAuth2 ä¸­ï¼Œå¦‚æœä¸è®¾ç½®åˆ·æ–°ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œåˆ·æ–°æ—¶é—´æ˜¯å¦<strong>æ— é™é•¿</strong>ï¼Ÿå½“ç„¶ï¼Œè¿™ä¸ªè²Œä¼¼ä¹Ÿå¹¶ä¸é‡è¦ã€‚å› ä¸ºï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬è‚¯å®šæ˜¯éœ€è¦æ˜¾ç¤º( ä¸»åŠ¨ )è®¾ç½®åˆ·æ–°ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œä½¿ç”¨ ClientBuilder#refreshTokenValiditySeconds(int refreshTokenValiditySeconds) æ–¹æ³•ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre>@Overridepublic void configure(ClientDetailsServiceConfigurer clients) throws Exception { clients.inMemory() .withClient("clientapp").secret("112233") // Client è´¦å·ã€å¯†ç ã€‚ .authorizedGrantTypes("password", "refresh_token") // å¯†ç æ¨¡å¼ .scopes("read_userinfo", "read_contacts") // å¯æˆæƒçš„ Scope .refreshTokenValiditySeconds(1200) // 1200 ç§’è¿‡æœŸ// .and().withClient() // å¯ä»¥ç»§ç»­é…ç½®æ–°çš„ Client ;}</pre><p>åˆ·æ–°ä»¤ç‰Œè¿‡æœŸæ—¶ï¼Œè¿”å›ç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre>{ "error":"invalid_token", "error_description":"Invalid refresh token (expired): 7139d075-c4ea-48f0-9dbb-6f65fa6dbeb0"}</pre><ul><li>å¦‚æœèƒ–å‹è¦æµ‹è¯•è¿™ä¸ªæ•ˆæœï¼Œå¯ä»¥æŠŠåˆ·æ–°ä»¤ç‰Œè¿‡æœŸæ—¶é—´è®¾ç½®ä¸º 1 ç§’ã€‚</li></ul><p><strong>5.3 ä¸ºä»€ä¹ˆéœ€è¦æœ‰åˆ·æ–°ä»¤ç‰Œ</strong></p><p>å‡ºäº<strong>å®‰å…¨æ€§</strong>çš„è€ƒè™‘ï¼Œè®¿é—®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´æ¯”è¾ƒçŸ­ï¼Œåˆ·æ–°ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´æ¯”è¾ƒé•¿ã€‚è¿™æ ·ï¼Œå¦‚æœè®¿é—®ä»¤ç‰Œå³ä½¿è¢«ç›—ç”¨èµ°ï¼Œé‚£ä¹ˆåœ¨ä¸€å®šçš„æ—¶é—´åï¼Œè®¿é—®ä»¤ç‰Œä¹Ÿèƒ½åœ¨è¾ƒçŸ­çš„æ—¶é—´å¼è¿‡æœŸã€‚å½“ç„¶ï¼Œå®‰å…¨ä¹Ÿæ˜¯ç›¸å¯¹çš„ï¼Œå¦‚æœä½¿ç”¨åˆ·æ–°ä»¤ç‰Œåï¼Œè·å–åˆ°æ–°çš„è®¿é—®ä»¤ç‰Œï¼Œè®¿é—®ä»¤ç‰Œ<strong>åç»­</strong>åˆ<strong>å¯èƒ½</strong>è¢«ç›—ç”¨ã€‚</p><p>å¦å¤–ï¼Œåˆ·æ–°ä»¤ç‰Œæ˜¯å¯é€‰é¡¹ï¼Œä¸ä¸€å®šä¼šè¿”å›ã€‚</p><p>ç¬”è€…æ•´ç†äº†ä¸‹ï¼Œå¤§å®¶å¸¸ç”¨å¼€æ”¾å¹³å°çš„ä»¤ç‰Œè¿‡æœŸæ—¶é—´ï¼Œè®©å¤§å®¶æ›´å¥½çš„ç†è§£ï¼š</p><ul><li>å°ç±³å¼€æ”¾å¹³å°</li><li class=ql-indent-1>ã€ŠAccess Token ç”Ÿå‘½å‘¨æœŸã€‹</li><li class=ql-indent-1>Access Token ï¼š90 å¤©æœ‰æ•ˆæœŸ</li><li class=ql-indent-1>Refresh Token ï¼š10 å¹´æœ‰æ•ˆæœŸ</li><li>å¾®ä¿¡å¼€æ”¾å¹³å°</li><li class=ql-indent-1>ã€Šç½‘ç«™åº”ç”¨å¾®ä¿¡ç™»å½•å¼€å‘æŒ‡å—ã€‹</li><li class=ql-indent-1>Access Token ï¼š2 å°æ—¶æœ‰æ•ˆæœŸ</li><li class=ql-indent-1>Refresh Token ï¼šæœªçŸ¥æœ‰æ•ˆæœŸ</li><li>è…¾è®¯å¼€æ”¾å¹³å°</li><li class=ql-indent-1>ã€Šè·å– Access_Tokenã€‹</li><li class=ql-indent-1>Access Token ï¼š90 å¤©æœ‰æ•ˆæœŸ</li><li class=ql-indent-1>Refresh Token ï¼šæœªçŸ¥æœ‰æ•ˆæœŸ</li></ul><h1><strong>6. åˆ é™¤ä»¤ç‰Œ</strong></h1><p>å®é™…åœ¨ OAuth2 æ—¶ï¼Œæœ‰åˆ é™¤è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œçš„éœ€æ±‚ã€‚ä¾‹å¦‚ï¼šç”¨æˆ·ç™»å‡ºç³»ç»Ÿã€‚è™½ç„¶è¯´ï¼Œå¯ä»¥é€šè¿‡å®¢æˆ·ç«¯<strong>æœ¬åœ°</strong>åˆ é™¤ä»¤ç‰Œçš„æ–¹å¼å®ç°ã€‚ä½†æ˜¯ï¼Œè€ƒè™‘åˆ°çœŸæ­£çš„å½»åº•çš„å®ç°åˆ é™¤ä»¤ç‰Œï¼Œå¿…ç„¶æœåŠ¡ç«¯<strong>è‡ªèº«</strong>éœ€è¦åˆ é™¤ä»¤ç‰Œã€‚</p><p>åœ¨ Spring Security OAuth2 ä¸­ï¼Œå¹¶æ²¡æœ‰æä¾›å†…ç½®çš„æ¥å£ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±å»å®ç°ã€‚ç¬”è€…å‚çœ‹ ã€ŠSpring Security OAuth2 â€“ Simple Token Revocationã€‹ æ–‡æ¡£ï¼Œå®ç°åˆ é™¤ä»¤ç‰Œçš„ API æ¥å£ã€‚</p><p>å› ä¸ºã€å¯†ç æ¨¡å¼ã€‘ç›¸å¯¹ç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨åŸæœ‰ç¨‹åºä¸Šåšæ”¹é€ ã€‚å¯¹åº” GitHub åœ°å€ï¼š ã€‚æ³¨æ„ï¼Œå¦‚ä¸‹ä»…ä»…æ˜¯ Demo ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒä¸‹éœ€è¦åšæ”¹é€ ã€‚</p><p><strong>6.1 åˆ é™¤è®¿é—®ä»¤ç‰Œ</strong></p><p>â‘  æ–°å¢åˆ é™¤è®¿é—®ä»¤ç‰Œçš„ API æ¥å£</p><pre>@Autowiredprivate ConsumerTokenServices tokenServices;@RequestMapping(method = RequestMethod.POST, value = "api/access_token/revoke")public String revokeToken(@RequestParam("token") String token) { tokenServices.revokeToken(token); return token;}</pre><ul><li>ä½¿ç”¨ ConsumerTokenServices#revokeToken(String tokenValue) æ–¹æ³•ï¼Œåˆ é™¤è®¿é—®ä»¤ç‰Œã€‚</li></ul><p><strong>æ³¨æ„</strong>ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒä¸‹ï¼ŒæˆæƒæœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨æ˜¯ä¸åœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥æ­¤å¤„ä»…ä»…æ˜¯ç¤ºä¾‹ã€‚ä¸»è¦æ˜¯ä¸ºäº†ä»‹ç» ConsumerTokenServices#revokeToken(String tokenValue) æ–¹æ³•çš„ä½¿ç”¨ã€‚</p><p>â‘¡ è®¿é—®åˆ é™¤è®¿é—®ä»¤ç‰Œçš„ API æ¥å£ã€‚</p><pre>curl -X POST http://localhost:8080/api/access_token/revoke -H "authorization: Bearer 23874e0b-a1d8-4337-9551-7b9be1ebaebe" -d "token=23874e0b-a1d8-4337-9551-7b9be1ebaebe"</pre><p>ç§»é™¤æˆåŠŸåï¼Œåœ¨ä½¿ç”¨å½“å‰è®¿é—®ä»¤ç‰Œï¼Œå°±ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p><pre>{ "error":"invalid_token", "error_description":"Invalid access token: 23874e0b-a1d8-4337-9551-7b9be1ebaebe"}</pre><hr><p>å¦å¤–ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ https://github.com/geektime-geekbang/oauth2lab/blob/master/lab05/oauth-server/src/main/java/io/spring2go/config/RevokeTokenEndpoint.java çš„å®ç°ã€‚</p><p><strong>6.2 åˆ é™¤åˆ·æ–°ä»¤ç‰Œ</strong></p><p>â‘  æ–°å¢åˆ é™¤è®¿é—®ä»¤ç‰Œçš„ API æ¥å£</p><pre>@Autowired(required = false) // &lt;1&gt;private TokenStore tokenStore;@RequestMapping(method = RequestMethod.POST, value = "api/refresh_token/revoke")public String revokeRefreshToken(@RequestParam("token") String token) { tokenStore.removeRefreshToken(new DefaultOAuth2RefreshToken(token)); return token;}</pre><ul><li>&lt;1> å¤„ï¼Œä½¿ç”¨äº† required = false çš„åŸå› æ˜¯ï¼Œæœ¬ç¤ºä¾‹å¹¶æœªæ˜¾ç¤ºå£°æ˜ TokenStore Bean å¯¹è±¡äº¤ç»™ Spring ç®¡ç†ï¼Œæ‰€ä»¥æ— æ³•æ³¨å…¥ã€‚ æ‰€ä»¥ ã€Œ6.2 åˆ é™¤åˆ·æ–°ä»¤ç‰Œã€ æ˜¯ä¸€ä¸ªæ— æ³•<strong>è·‘é€š</strong>çš„ç¤ºä¾‹ã€‚</li><li>é‡ç‚¹åœ¨äºï¼Œè°ƒç”¨ TokenStore#removeRefreshToken(OAuth2RefreshToken token) æ–¹æ³•ï¼Œåˆ é™¤åˆ·æ–°ä»¤ç‰Œã€‚</li></ul><p>â‘¡ è®¿é—®åˆ é™¤åˆ·æ–°ä»¤ç‰Œçš„ API æ¥å£ã€‚</p><pre>curl -X POST http://localhost:8080/api/refresh_token/revoke -H "authorization: Bearer 52e85411-ac1d-4844-bf03-cf5633e4eecd" -d "token=ead4734a-ca5c-45bf-ac25-9a92291a9fe1"</pre><p>ç§»é™¤æˆåŠŸåï¼Œåœ¨ä½¿ç”¨å½“å‰åˆ·æ–°ä»¤ç‰Œï¼Œå°±ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p><pre>{ "error":"invalid_token", "error_description":"Invalid refresh token: ead4734a-ca5c-45bf-ac25-9a92291a9fe1"}</pre><hr><p>å¦å¤–ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ https://github.com/geektime-geekbang/oauth2lab/blob/master/lab05/oauth-server/src/main/java/io/spring2go/config/TokenController.java çš„å®ç°ã€‚</p><p><strong>6.3 RFC7009 - OAuth2 Token Revocation</strong></p><p>åœ¨ OAuth2 ä¸­ï¼Œåˆ é™¤ä»¤ç‰Œï¼Œæ ‡å‡†çš„è¯´æ³•ä¸º OAuth2 Token æ’¤é”€ï¼Œå¯¹åº” RFC7009 ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ã€‚</p><blockquote><p>FROM ã€ŠOAuth2 Token æ’¤é”€ï¼ˆRFC7009 - OAuth2 Token Revocationï¼‰ã€‹</p></blockquote><p>ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªåè®®è§„å®šäº†ä¸€ä¸ªAuthorization serveræä¾›ä¸€ä¸ªæ€æ ·çš„APIæ¥ä¾›Clientæ’¤é”€access_tokenæˆ–è€…refresh_tokenã€‚</p><p>æ¯”å¦‚Clientå‘èµ·ä¸€ä¸ªå¦‚ä¸‹çš„è¯·æ±‚ï¼š</p><blockquote><p><em>POST /revoke HTTP/1.1</em></p><p><em>Host: server.example.com</em></p><p><em>Content-Type: application/x-www-form-urlencoded</em></p><p><em>Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</em></p><p><em>token=45ghiukldjahdnhzdauz&token_type_hint=refresh_token</em></p></blockquote><p>å…¶ä¸­å„é¡¹å«ä¹‰å¦‚ä¸‹ï¼š</p><ol><li>/revokeï¼šæ˜¯Authorization Serveréœ€è¦æä¾›çš„APIåœ°å€ï¼ŒClientä½¿ç”¨Postæ–¹å¼è¯·æ±‚è¿™ä¸ªåœ°å€ã€‚</li><li>Content-Type: application/x-www-form-urlencodedï¼šå›ºå®šæ­¤æ ¼å¼ã€‚</li><li>Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JWï¼šè®¿é—®å—ä¿æŠ¤èµ„æºçš„æˆæƒå‡­è¯ã€‚</li><li>tokenï¼šå¿…é€‰ï¼Œå¯ä»¥æ˜¯access_tokenæˆ–è€…refresh_tokençš„å†…å®¹ã€‚</li><li>token_type_hintï¼šå¯é€‰ï¼Œè¡¨ç¤ºtokençš„ç±»å‹ï¼Œå€¼ä¸ºâ€access_tokenâ€œæˆ–è€…"refresh_token"ã€‚</li></ol><p>å¦‚æœæ’¤é”€æˆåŠŸï¼Œåˆ™è¿”å›ä¸€ä¸ªHTTP status codeä¸º200çš„å“åº”å°±å¯ä»¥äº†ã€‚</p><h1><strong>7. ä»¤ç‰Œå…ƒæ•°æ®</strong></h1><blockquote><p>FROM ã€ŠOAuth2 Token å…ƒæ•°æ®ï¼ˆRFC7662 - OAuth2 Token Introspectionï¼‰ã€‹</p></blockquote><p>ç®€å•çš„æ€»ç»“æ¥è¯´ï¼Œè¿™ä¸ªè§„èŒƒæ˜¯ä¸ºOAuth2æ‰©å±•äº†ä¸€ä¸ªAPIæ¥å£ï¼ˆIntrospection Endpointï¼‰ï¼Œè®©ç¬¬ä¸‰æ–¹Clientå¯ä»¥æŸ¥è¯¢ä¸Šé¢æåˆ°çš„é‚£äº›ä¿¡æ¯ï¼ˆæ¯”å¦‚ï¼Œaccess_tokenæ˜¯å¦è¿˜æœ‰æ•ˆï¼Œè°é¢å‘çš„ï¼Œé¢å‘ç»™è°çš„ï¼Œscopeåˆå“ªäº›ç­‰ç­‰çš„å…ƒæ•°æ®ä¿¡æ¯ï¼‰ã€‚</p><p>æ¯”å¦‚Clientå‘èµ·ä¸€ä¸ªå¦‚ä¸‹çš„è¯·æ±‚ï¼š</p><blockquote><p><em>POST /introspect HTTP/1.1</em></p><p><em>Host: server.example.com</em></p><p><em>Accept: application/json</em></p><p><em>Content-Type: application/x-www-form-urlencoded</em></p><p><em>Authorization: Bearer 23410913-abewfq.123483</em></p><p><em>token=2YotnFZFEjr1zCsicMWpAA&token_type_hint=access_token</em></p></blockquote><p>çœ‹èµ·æ¥å’Œä¸Šé¢çš„æ’¤é”€Tokençš„è¯·æ±‚å·®ä¸å¤šï¼Œå…¶ä¸­å„é¡¹å«ä¹‰å¦‚ä¸‹ï¼š</p><ol><li>/introspectï¼šæ˜¯Authorization Serveréœ€è¦æä¾›çš„APIåœ°å€ï¼ŒClientä½¿ç”¨Postæ–¹å¼è¯·æ±‚è¿™ä¸ªåœ°å€ã€‚</li><li>Accept:application/jsonï¼šè¡¨ç¤ºAuthorization Serveréœ€è¦è¿”å›ä¸€ä¸ªJSONæ ¼å¼çš„æ•°æ®ã€‚</li><li>Content-Type: application/x-www-form-urlencodedï¼šå›ºå®šæ­¤æ ¼å¼ã€‚</li><li>Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JWï¼šè®¿é—®å—ä¿æŠ¤èµ„æºçš„æˆæƒå‡­è¯ã€‚</li><li>tokenï¼šå¿…é€‰ï¼Œå¯ä»¥æ˜¯access_tokenæˆ–è€…refresh_tokençš„å†…å®¹ã€‚</li><li>token_type_hintï¼šå¯é€‰ï¼Œè¡¨ç¤ºtokençš„ç±»å‹ï¼Œå€¼ä¸ºâ€access_tokenâ€œæˆ–è€…"refresh_token"ã€‚</li></ol><p>å¦‚æœè¯·æ±‚æˆåŠŸï¼Œåˆ™ä¼šè¿”å›å¦‚ä¸‹çš„ä¿¡æ¯ï¼š</p><pre> 1 { 2 "active": true, 3 "client_id": "l238j323ds-23ij4", 4 "token_type":"access_token", 5 "username": "jdoe", 6 "scope": "read write dolphin", 7 "sub": "Z5O3upPC88QrAjx00dis", 8 "aud": "https://protected.example.net/resource", 9 "iss": "https://server.example.com/",10 "exp": 1419356238,11 "iat": 1419350238,12 "nbf": 1419350238,13 "jti": "abcdefg"14 "extension_field": "twenty-seven"15 }</pre><p>JSONå„é¡¹å±æ€§å«ä¹‰å¦‚ä¸‹ï¼ˆå…¶ä¸­æœ‰äº›ä¿¡æ¯æ˜¯åœ¨JSON Web Tokenä¸­å®šä¹‰çš„ï¼Œå‚è€ƒé“¾æ¥æœ‰è¯¦ç»†çš„ä»‹ç»ï¼‰:</p><ol><li>activeï¼šå¿…é¡»çš„ã€‚è¡¨ç¤ºtokenæ˜¯å¦è¿˜æ˜¯æœ‰æ•ˆçš„ã€‚</li><li>client_idï¼šå¯é€‰çš„ã€‚è¡¨ç¤ºtokenæ‰€å±çš„Clientã€‚æ¯”å¦‚ä¸Šé¢çš„<strong>åœ¨çº¿æ‰“å°å¹¶ä¸”åŒ…é‚®çš„ç½‘ç«™</strong>ã€‚</li><li>token_typeï¼šå¯é€‰çš„ã€‚è¡¨ç¤ºtokençš„ç±»å‹ã€‚å¯¹åº”ä¼ é€’çš„token_type_hintã€‚</li><li>user_nameï¼šå¯é€‰çš„ã€‚è¡¨ç¤ºtokençš„æˆæƒè€…çš„åå­—ã€‚æ¯”å¦‚ä¸Šé¢çš„<strong>å°æ˜</strong>ã€‚</li><li>scopeï¼šå¯é€‰çš„ã€‚å’Œä¸Šç¯‡5.1.1 Authorization Requestä¸­çš„å¯é€‰å‚æ•°scopeå¯¹åº”ï¼Œè¡¨ç¤ºæˆæƒç»™Clientè®¿é—®çš„èŒƒå›´ï¼Œæ¯”å¦‚æ˜¯ç›¸å†Œï¼Œè€Œä¸æ˜¯å°æ˜çš„æ—¥å¿—ä»¥åŠå…¶ä»–å—ä¿æŠ¤èµ„æºã€‚</li><li>subï¼šå¯é€‰çš„ã€‚tokenæ‰€å±çš„èµ„æºæ‹¥æœ‰è€…çš„å”¯ä¸€æ ‡è¯†ï¼ŒJWTå®šä¹‰çš„ã€‚ä¹Ÿå°±æ˜¯å°æ˜çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚</li><li>audï¼šå¯é€‰çš„ã€‚tokené¢å‘ç»™è°çš„ï¼ŒJWTå®šä¹‰çš„ã€‚</li><li>issï¼šå¯é€‰çš„ã€‚tokençš„é¢å‘è€…ï¼ŒJWTå®šä¹‰çš„ã€‚</li><li>expï¼šå¯é€‰çš„ã€‚tokençš„è¿‡æœŸæ—¶é—´ï¼ŒJWTå®šä¹‰çš„ã€‚</li><li>iatï¼šå¯é€‰çš„ã€‚issé¢å‘tokençš„æ—¶é—´ï¼ŒJWTå®šä¹‰çš„ã€‚</li><li>nbfï¼šå¯é€‰çš„ã€‚tokenä¸ä¼šåœ¨è¿™ä¸ªæ—¶é—´ä¹‹å‰è¢«ä½¿ç”¨ï¼ŒJWTå®šä¹‰çš„ã€‚</li><li>jtiï¼šå¯é€‰çš„ã€‚tokençš„å”¯ä¸€æ ‡è¯†ï¼ŒJWTå®šä¹‰çš„ã€‚</li><li>extension_fieldï¼šå¯ä»¥è‡ªå·±æ‰©å±•ç›¸å…³å…¶ä»–å±æ€§ã€‚</li></ol><p>å…¶ä¸­å¤§é‡çš„ä¿¡æ¯éƒ½æ˜¯å¯é€‰çš„ä¿¡æ¯ï¼Œè€Œä¸”å¯ä»¥è‡ªå·±æ‰©å±•éœ€è¦çš„å±æ€§ä¿¡æ¯ï¼Œä»è¿™äº›å±æ€§ä¸­å°±å¯ä»¥è§£å†³æˆ‘ä»¬ä¸Šé¢æåˆ°çš„access_tokenå¯¹äºClientä¸é€æ˜çš„é—®é¢˜ã€‚</p><p>æˆ‘ä»¬æ³¨æ„åˆ°å…¶ä¸­æœ‰å¾ˆå¤šå±äºJWTå®šä¹‰çš„å±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ªJWTæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ ã€ŠJSON Web Token (JWT)ã€‹ ã€‚</p><hr><p>å¯¹äºä»¤ç‰Œå…ƒæ•°æ® API æ¥å£çš„å®ç°ï¼Œç¬”è€…è¿™é‡Œå°±æš‚æ—¶ä¸æä¾›ã€‚å¦‚æœæœ‰éœ€è¦çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ TokenStore çš„ä¸¤ä¸ª API ï¼š</p><ul><li>#readAccessToken(String tokenValue) æ–¹æ³•ï¼Œè¯»å–æŒ‡å®šçš„è®¿é—®ä»¤ç‰Œçš„ä¿¡æ¯ã€‚</li><li>#readRefreshToken(String tokenValue) æ–¹æ³•ï¼Œè¯»å–æŒ‡å®šçš„åˆ·æ–°ä»¤ç‰Œçš„ä¿¡æ¯ã€‚</li></ul><h1><strong>666. å½©è›‹</strong></h1><p>ä¸€ä¸‡ä¸ªæ³¨æ„ï¼Œæœ¬æ–‡ä»…ä»…æ˜¯ Spring Security OAuth2 çš„å…¥é—¨æ–‡ç« ã€‚å®é™…ç”Ÿäº§ä½¿ç”¨æ—¶ï¼Œè¿˜éœ€è¦åšå¾ˆå¤šäº‹æƒ…ã€‚ä¾‹å¦‚ï¼š</p><ul><li>ä½¿ç”¨å…³ç³»æ•°æ®åº“ï¼Œ<strong>æŒä¹…åŒ–</strong>å­˜å‚¨ Client å’Œä»¤ç‰Œä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ JdbcTokenStore ã€‚</li><li>æˆæƒæœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨åˆ†ç¦»ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ RemoteTokenServices ã€‚</li><li>ä½¿ç”¨ç¼“å­˜æœåŠ¡å™¨ï¼Œæå‡ Client å’Œä»¤ç‰Œä¿¡æ¯çš„<strong>è®¿é—®</strong>é€Ÿåº¦ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ RedisTokenStore ã€‚</li></ul><p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p><ul><li>CatalpaFlat ã€ŠSpring Security OAuth2 æ·±å…¥è§£æã€‹</li><li>å°ä¸œå­ ã€ŠSpring Security OAuth2 å¼€å‘æŒ‡å—ã€‹</li><li>èŠèŠæ¶æ„ ã€Šè½»æ¾ç­¹ 1.6 äº¿æ³¨å†Œç”¨æˆ·çš„ Passport è´¦æˆ·ä½“ç³»æ¶æ„è®¾è®¡ã€‹</li></ul></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Spring','Security','OAuth2'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>