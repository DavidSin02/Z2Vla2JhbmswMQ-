<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>9、磁盘及文件系统 | 极客快訊</title><meta property="og:title" content="9、磁盘及文件系统 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/96a8b0e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/96a8b0e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/96a8b0e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/96a8b0e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/96a8b0e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/96a8b0e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/96a8b0e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/96a8b0e.html><meta property="article:published_time" content="2020-10-29T21:07:20+08:00"><meta property="article:modified_time" content="2020-10-29T21:07:20+08:00"><meta name=Keywords content><meta name=description content="9、磁盘及文件系统"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/96a8b0e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>9、磁盘及文件系统</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>磁盘及文件系统</p><p>硬盘的物理构成：</p><p>扇区（sector）、磁道（track）、磁头、柱面(cylinder)</p><p>分区：就是记录每一个分区的起始柱面和结束柱面。分区信息存放在0柱面0磁头1扇区上：MBR 主引导记录(446字节)+DPT磁盘分区表（64字节）+结束标志（2个字节）</p><p>硬盘的主引导记录（MBR）是不属于任何一个操作系统的，它先于所有的操作系统而被调入内存，并发挥作用，然后才将控制权交给主分区（活动分区）内的</p><p>操作系统，并用主分区信息表来管理硬盘。</p><p>文件系统是操作系统用于明确存储设备（常见的是磁盘）或分区上的文件的方法和数据结构；即在存储设备上组织文件的方法。</p><p>block ：数据存储的最小单元</p><p>inode:索引节点，全局唯一编号，除了记录文件的属性外，同时还具有指针功能，指向文件内容放置的快</p><p>（里面保存的是文件的权限，所有者，所属主等基本信息）</p><p>1、文件的拥有者与用户组（owner/group）</p><p>2、文件的访问模式（read/write/excute）</p><p>3、文件的类型（type）</p><p>4、文件建立或状态改变的时间（ctime)、最近一次的读取时间（atime）、最近修改时间（mtime）</p><p>5、文件的大小</p><p>6、定义文件属性的标志（flag），如setUID...</p><p>7、文件真正内容的指针（pointer）</p><p>创建目录：分配一个inode和至少一个block</p><p>inode记录该目录的相关属性，并指向分配到的那个快；</p><p>block记录在这个目录下的相关文件（或目录）的关联性</p><p>创建文件：分配至少一个inode与相对于该文件大小的快数量</p><p>inode不记录文件名，而是记录文件的相关属性，文件名记录在目录所属的block区域</p><p>例如：读取/etc/crontab的流程如下：</p><p>1、操作系统根据根目录（/）的相关数据可获取/etc目录所在的inode，并读取/etc这个目录所有相关属性</p><p>2、根据/etc的inode的数据，可以获取/etc目录下所有文件的关联数据是放置在哪一个block中，并前往该block读取文件的关联性内容</p><p>3、由上步骤的block中，可以知道crontab文件的inode所在地，并前往该inode</p><p>4、由上步骤的inode中，可以获取crontab文件的所有属性，并前往由inode所指向的block区域，获取crontab文件内容</p><p>块组：block group 对用户是不可见的，子逻辑区域，有个超级标示区</p><p>文件系统构成：（dumpe2fs 可以查看）</p><p>superblock(超级块)：记录整个文件系统相关信息</p><p>1、block与inode的总量</p><p>2、未使用和已使用的inode/block数量</p><p>3、文件系统的载入时间、最近一次写入数据的时间、最近一次检验磁盘（fsck）的时间等文件系统的相关信息</p><p>4、有效位的值，已载入为0，未载入为1</p><p>group description(组描述)：记录此block由何处开始记录</p><p>block bitmap(快位图)：此处记录block是否使用</p><p>inode bitmap(inode位图)：此处记录inode是否使用</p><p>inode table(inode表)：为每个inode的数据存放区</p><p>data block(数据块)：为每个block的数据存放区</p><p>metadata bitmap （块位图)dentry 目录项</p><p>创建文件：先在目录下创建一个条目，把名字和iNode对应上，回到源数据，指定块位置</p><p>删除文件：删除条目里面的名字和iNode对应关系，将对应的iNode标记为0</p><p>通过inode号码来删除文件：find ./ -inum 400935 -exec rm -rf {} \;</p><p>extundelete： linux下高效数据恢复工具 http://extundelete.sourceforge.net/ 安装时需要的依赖包 e2fsprogs-lib e2fsprogs-devel</p><p>复制文件：不同的inode和block</p><p>剪切文件：同一个分区，inode号和磁盘块位置都没有变，只是把条目里面的名字改变了一下</p><p>链接：硬链接和软链接（符号链接），多个文件指向同一个iNode，硬链接；符号连接，指向的是源文件的路径，而不是文件块</p><p>ln (link) [-s -v] 源文件 链接</p><p>硬链接：在某个目录下的block中增加一个文件关联数据，不会用到inode与磁盘空间</p><p>只能对文件进行创建，为了避免循环引用</p><p>不能跨文件系统，可以在不同目录下</p><p>创建硬链接可以增加文件被连接的次数</p><p>符号链接：建立一个独立的文件，这个文件会让数据的读取指向它连接的文件内容</p><p>可以对目录创建</p><p>可以跨文件系统</p><p>不会增加被链接文件的链接次数</p><p>其大小为指定路径所包含的字符个数</p><p>-b 删除，覆盖以前建立的链接</p><p>-d 允许超级用户制作目录的硬链接</p><p>-f 强制执行</p><p>-i 交互模式，文件存在则提示用户是否覆盖</p><p>-n 把符号链接视为一般目录</p><p>-s 软链接(符号链接)</p><p>-v 显示详细的处理过程</p><p>du 查看文件大小 [-s -h ]</p><p>-s 只分别计算命令列中每个参数所占的总用量</p><p>-h 做单位转换</p><p>df　 查看硬盘使用情况</p><p>-i 查看inode的使用情况</p><p>-P 不换行显示</p><p>-h 做单位转换</p><p>设备文件：</p><p>b：块设备文件，以块为单位，随机访问</p><p>c: 以字符为单位，是线性设备，访问时有先后顺序</p><p>例：ls -l /dev</p><p>主设备号(标示设备类型，major number)</p><p>次设备号(标示同一类型的不同设备，minor number)</p><p>创建设备文件：mknod -m name type major ninor</p><p>硬盘的设备文件名：</p><p>IDE ATA :hd</p><p>SATA SCSI USB :sd</p><p>a b c ....来区别同一种类型下的不同设备</p><p>IDE: 第一个IDE口，控制器，主 从hda hdb</p><p>第二个IDE口，主从 hdc hdd</p><p>fdisk 查看当前系统识别的硬盘和分区的情况</p><p>fdisk -l [/dev/to/smoe_device_file]</p><p>还可用来管理分区</p><p>fdisk /dev/sda</p><p>p:显示当前硬件的分区，包括没有保存的改动</p><p>n:创建一个新的分区</p><p>d：删除一个分区</p><p>w:保存并退出</p><p>q:不保存退出</p><p>t：修改分区类型（文件系统类型）</p><p>l:显示所支持的所有类型</p><p>cat /proc/partitions 查看分区</p><p>partprobe [/dev/sda] 通知操作系统分区表的变化</p><p>partx -a [/dev/sda] 告诉内核磁盘分区是否存在及其编号</p><p>cat /proc/filesystem 查看文件系统类型</p><p>高级格式化：mkfs -t ext4</p><p>mkfs -t msdos /dev/hdb3</p><p>mkfs.ext2 、mkfs.ext3 、mke2fs</p><p>-b：分区时设定每个数据区块占用空间大小，目前支持1024, 2048 以及4096 bytes每个块。</p><p>-i：设定inode大小</p><p>-N：设定inode数量，有时使用默认的inode数不够用，所以要自定设定inode数量。</p><p>-c：在格式化前先检测一下磁盘是否有问题，加上这个选项后会非常慢</p><p>-L：预设该分区的标签label</p><p>-j：建立ext3格式的分区，如果使用mkfs.ext3 就不用加这个选项了</p><p>查看磁盘超级块的信息：</p><p>tune2fs -l /dev/sda[n] 调整ext2/ext3/ext4文件系统参数</p><p>dumpe2fs -h /dev/sda[n] 显示ext2/ext3/ext4文件系统信息</p><p>二.swap</p><p>swap分区：主要是用来内存过载使用，可以和内存上暂停进程的页面保存在swap分区中，再次启用时再分配页面，pageoutswap分区：主要是用来内存过载使用，可以和内存上暂停进程的页面保存在swap分区中，再次启用时再分配页面，pageout pagein ,swap out swap in ,发现有频繁的换进和换出的时候就需要加内存。</p><p>1.虚拟内存：</p><p>虚拟地址：线性地址；</p><p>页面的换进和换出，允许了内存的过载使用</p><p>计存器1纳秒，缓存10纳秒，内存10毫秒，磁盘秒</p><p>free 查看物理内存和交换空间使用情况</p><p>-m</p><p>buffers 缓冲 cached 缓存</p><p>fdisk命令中，调整分区类型为82；</p><p>创建交换分区：</p><p>格式化：# mkswap /dev/sda8，先调整分区类型为82，fdisk,</p><p>-L LABEL</p><p>swapon /dev/sda8，启用该交换空间</p><p>-a:启用所有的定义在/etc/fstab文件中的交换设备</p><p>swapoff /dev/sda8</p><p>回环设备</p><p>loopback, 使用软件来模拟实现硬件</p><p>创建一个镜像文件，120G，当作一个硬件设备来使用</p><p>dd命令：</p><p>if=数据来源</p><p>of=数据存储目标</p><p>bs=1</p><p>count=2</p><p>seek=#: 创建数据文件时，跳过的空间大小；</p><p>dd if=/dev/sda of=/mnt/usb/mbr.backup bs=512 count=1</p><p>dd if=/mnt/usb/mbr.backup of=/dev/sda bs=512 count=1</p><p>可用来备份和恢复mbr</p><p>dd if=/dev/zero of=/var/swapfile bs=1M count=1024</p><p>seek 跳过多大的空间</p><p>mkswap 格式化为swap分区</p><p>1、通过fdisk创建swap分区或者使用dd命令创建一个虚拟内存的文件</p><p>dd if=/dev/zero of=/tmp/swap bs=1M count=1024</p><p>2、mkswap进行swap分区格式化</p><p>3、swapon 激活swap分区</p><p>swapoff 关闭swap分区</p><p>mount：挂载命令</p><p>命令格式：mount [-t vfstype] [-o options] device dir</p><p>-a 挂载fstab中提到的所有文件系统</p><p>-o remount 重新挂载已挂载的文件系统</p><p>-o loop：用来把一个文件当成硬盘分区挂接上系统</p><p>-o ro：采用只读方式挂接设备</p><p>-o rw：采用读写方式挂接设备</p><p>挂接光盘镜像文件</p><p>1、从光盘制作光盘镜像文件。将光盘放入光驱，执行下面的命令。</p><p>#cp /dev/cdrom /home/sunky/mydisk.iso 或</p><p>#dd if=/dev/cdrom of=/home/sunky/mydisk.iso</p><p>2、挂载光盘镜像文件</p><p>#mount -o loop -t iso9660 /home/sunky/mydisk.iso /mnt/vcdrom</p><p>三.自动挂载</p><p>文件系统的配置文件/etc/fstab</p><p>OS在初始时，会自动挂载此文件中定义的每个文件系统</p><p>要挂载的设备 挂载点 文件系统类型 挂载选项 转储频率(每多少天做一次完全备份) 文件系统检测次序(只有根可以为1)</p><p>/dev/sda5 /mnt/test ext4 defaults 0 0</p><p>mount -a：挂载/etc/fstab文件中定义的所有文件系统</p><p>/etc/fstab文件 实现开机自动挂载</p><p>设备 挂载点 文件系统类型 挂载参数 是否执行备份命令dump 是否启动使用fsck扫描磁盘</p><p>fuser: 验正进程正在使用的文件或套接字文件</p><p>-v: 查看某文件上正在运行的进程</p><p>-k:</p><p>-m：针对目录，也就是挂载点，一般和-k 一起使用</p><p>fuser -km MOUNT_POINT：终止正在访问此挂载点的所有进程</p><p>wodim --devices 查看设备名（没有挂载的光盘）</p><p>练习：</p><p>1、创建一个5G的分区，文件系统为ext4，卷标为MYDATA，块大小为1024，预留管理空间为磁盘分区的3%，要求开机后可以自动挂载至/data目录，并且自动挂载的设备要使用卷标进行引用；</p><p>2、创建一个本地回环文件/var/swaptemp/swapfile来用于swap，要求大小为512MB，卷标为SWAP-FILE，且开机自动启用此交换设备；</p><p># mkdir /var/swaptemp</p><p># dd if=/dev/zero of=/var/swaptemp/swapfile bs=1M count=512</p><p># mkswap LABLE=SWAP-FILE /var/swaptemp/swapfile</p><p>/etc/fstab</p><p>/var/swaptemp/swapfile swap swap defaults 0 0</p><p>3、上述第一问，如何让其自动挂载的同时启用ACL功能；</p><p>/etc/fstab</p><p>LABEL='MYDATA' /data ext4 defaults,acl 0 0</p><p>Linux： 查看VFS结构图</p><p>VFS:virtual filesystem ,interface:system call</p><p>当前，除了Linux标准的文件系统Ext2/Ext3/Ext4外，还有很多种文件系统，比如reiserfs, xfs, Windows的vfat NTFS，</p><p>网络文件系统nfs 以及flash 文件系统jffs2, yaffs/yaffs2 ubifs。</p><p>linux通过叫做VFS的中间层对这些文件系统提供了完美的支持。</p><p>VFS存在的意义</p><p>1. 向上，对应用层提供一个标准的文件操作接口；</p><p>2. 对下，对文件系统提供一个标准的接口，以便其他操作系统的文件系统可以方便的移植到Linux上；</p><p>3. VFS内部则通过一系列高效的管理机制，比如inode cache, dentry cache 以及文件系统的预读等技术，</p><p>使得底层文件系统不需沉溺到复杂的内核操作，即可获得高性能；</p><p>4. 此外VFS把一些复杂的操作尽量抽象到VFS内部，使得底层文件系统实现更简单</p><p>VFS 是一种软件机制，也许称它为 Linux 的文件系统管理者更确切点，与它相关的数据结构只存在于物理内存当中。</p><p>所以在每次系统初始化期间，Linux 都首先要在内存当中构造一棵 VFS 的目录树(在 Linux 的源代码里称之为 namespace)，</p><p>实际上便是在内存中建立相应的数据结构。</p><p>VFS: virtual filesystem 中间层</p><p>每个分区都是一个单独的文件系统</p><p>物理和逻辑之间的关系</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'磁盘','系统','文件'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>