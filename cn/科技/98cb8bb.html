<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Jenkins扩展共享库进阶 | 极客快訊</title><meta property="og:title" content="Jenkins扩展共享库进阶 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/dfic-imagehandler/33443a51-98a8-4ff5-878c-7fd0a579d929"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/98cb8bb.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/98cb8bb.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/98cb8bb.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/98cb8bb.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/98cb8bb.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/98cb8bb.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/98cb8bb.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/98cb8bb.html><meta property="article:published_time" content="2020-10-29T21:06:50+08:00"><meta property="article:modified_time" content="2020-10-29T21:06:50+08:00"><meta name=Keywords content><meta name=description content="Jenkins扩展共享库进阶"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/98cb8bb.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Jenkins扩展共享库进阶</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><br></p><div class=pgc-img><img alt=Jenkins扩展共享库进阶 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/33443a51-98a8-4ff5-878c-7fd0a579d929><p class=pgc-img-caption></p></div><p>前面我们介绍了<a class=pgc-link data-content=mp href="https://www.toutiao.com/i6832815180884214276/?group_id=6832815180884214276" rel="noopener noreferrer" target=_blank>Jenkins多分支流水线</a>、<a class=pgc-link data-content=mp href="https://www.toutiao.com/i6826988883767460365/?group_id=6826988883767460365" rel="noopener noreferrer" target=_blank>Jenkins流水线即代码之扩展共享库初体验</a>，其实都是“流水线即代码”的体现。我们将Jenkinsfile纳入项目版本库中统一管理，实现了“谁构建、谁运行”的理念。</p><p><strong>但是在实际项目中，CI/CD其实是由运维来管理的，这样就会导致运维、开发都要通过版本库去修改Jenkinsfile、项目代码。</strong></p><p>试想下运维在调试流水线频繁提交版本，导致远程分支不断更新，如果有钩子触发自动发版，势必会引起开发的烦感。</p><p>为了避免这个情况的发生，<strong>我们引入了Jenkins扩展共享库，即将流水线操作拆分为两块</strong>：</p><ol start=1><li>Jenkinsfile定义流水线步骤、环境变量、参数等与项目相关的一切变量；</li><li>扩展共享库定义流水线调用的方法、函数、类库等与构建相关的具体操作；</li></ol><p>由于一旦流水线步骤及变量确定一般就不会改动了，而扩展共享库的方法等具体操作实现我们可以以代码的方式放入远程版本中，修改提交后<strong>Jenkinsfile构建自动加载共享库，获取最新的构建修改</strong>。</p><p>另，通过扩展共享库我们可以<strong>提高构建操作的费用，有效减少构建代码量</strong>；Jenkinsfile、扩展库还可以作<strong>为备份托管在版本库中，可谓是两全其美啊</strong>。</p><p>下面我们对多分支流水线、扩展共享库结合实现Vue项目的发版、回滚来具体讲解下扩展共享库的使用。</p><p><strong>注：多分支流水线可以有效将多个分支放到一个项目下统一管理，避免因分支导致的项目分散。</strong></p><h1 class=pgc-h-arrow-right><strong>Vue场景</strong></h1><p>Jenkins+远程web服务器</p><p>功能实现：</p><ul><li>参数化构建：deploy-发版，rollback-回滚。</li><li>发版：判断git版本是否更新，若更新则在Jenkins上打包，并将dist包分发到远程web服务器上；若未更新，则停止构建。</li><li>回滚：回滚archiveArtifacts的版本包，分发到远程web服务器上。</li></ul><p>注意：我们使用archiveArtifacts来归档版本包，回滚时可从归档路径中获取。</p><h1 class=pgc-h-arrow-right><strong>扩展共享库</strong></h1><p><strong>一、添加扩展共享库</strong></p><p>Manage Jenkins--Configure System--Global Pipeline Libraries中添加</p><div class=pgc-img><img alt=Jenkins扩展共享库进阶 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6af4777e0486497bbf034dc4284c0fa6><p class=pgc-img-caption></p></div><p><strong>二、代码库结构</strong></p><pre><code>pipeline-shared-library/├── resources  #空├── src  #空└── vars    └── vueUpdate.groovy</code></pre><p>vueUpdate.groovy 是所有vue项目的构建具体操作。</p><p><strong>注意：由于所有的vue项目构建由共享库中的统一的方法实现，因此不同分支对应的环境要高度一致，这样才能最大限度的实现代码复用。</strong></p><p><strong>三、具体实现</strong></p><p>我们将代码分为三部分，即deploy、rollback、update。</p><p><strong>1.deploy-发版</strong></p><p>（1）判断版本是否更新</p><p>我们通过将本次git的版本id存入文件，以便下次构建时将其与GIT_COMMIT进行比较，实现版本是否更新。</p><p><strong>注意：由于第一次构建时，流水线报错“</strong></p><pre><code>No such property: GIT_PREVIOUS_SUCCESSFUL_COMMIT for class: groovy.lang.Binding</code></pre><p><strong>”。此时是无法通过GIT_PREVIOUS_SUCCESSFUL_COMMIT变量来获取上一次版本的，因此只能将其写入文件存放。</strong></p><p>（2）打包</p><p>通过npm 打包vue项目生成dist。</p><p><strong>注意：我们将dist压缩并改名为dist_temp.zip 作为我们分发到项目的版本包。其目的是作为中间临时文件，用于和项目的实际dist目录进行替换，更新后销毁即可。</strong></p><p><strong>另最终归档的版本包也为dist_temp.zip。</strong></p><p><strong>2.回滚-rollback</strong></p><p>回滚的版本存在于archiveArtifacts归档后的构建目录中，在此目录中</p><pre><code>${JENKINS_HOME}/jobs/`echo ${JOB_NAME}|awk -F'/' '{print \$1}'`/branches/${BRANCH_NAME}/builds/${version}/archive/</code></pre><p>多分支流水线的目录以分支名区分子目录。</p><p><strong>3.分发更新</strong></p><p>Jenkins通过sshpublisher将版本包dist_temp.zip 分发到远程web服务器上，通过rsync对项目目录dist进行更新，最后销毁dist_temp.zip。</p><p><strong>注意：归档dist_temp.zip 及 邮件通知由Jenkinsfile定义，不放在共享库中。</strong></p><p>具体代码如下：</p><p><strong>所有的变量由跟随项目的Jenkinsfile提供。</strong></p><pre><code>def deploy() {    sh """        #新建commitid文件，初次写入0        if [ ! -f commitid ];then             echo 0 &gt; commitid         fi        #从commitid获取上次版本id        previous_id=`cat commitid`        if [ \$previous_id != $GIT_COMMIT ];then            #写入本次git commit，用于下次判断            echo $GIT_COMMIT &gt; commitid            echo "start npm install&amp;build"            /usr/local/nodejs/bin/npm install            /usr/local/nodejs/bin/npm run build            [ -f ${ZIP_NAME}.zip ] &amp;&amp; rm -rfv ${ZIP_NAME}.zip            [ -d ${ZIP_NAME} ] &amp;&amp; rm -rfv ${ZIP_NAME}            echo -e "\\033[34m将dist改名为${ZIP_NAME}：\\033[0m"            mv -v dist ${ZIP_NAME} &amp;&amp; echo -e "\\033[32mdist改名为${ZIP_NAME}成功。\\033[0m" || {                echo -e "\\033[32mdist改名为${ZIP_NAME}失败。\\033[0m"                exit 1            }            zip -r ${ZIP_NAME}.zip ${ZIP_NAME} &amp;&amp; echo -e "\\033[32m${ZIP_NAME}压缩成功。\\033[0m" || {                echo -e "\\033[32m${ZIP_NAME}压缩失败。\\033[0m"                exit 1            }        else            echo -e "\\033[31mRepositories not update, stop deploy\\033[0m"            exit 1        fi    """}def rollback() {    sh """    [ ${version} -eq 0 ] &amp;&amp; {        echo -e "\\033[31m版本号非0。\\033[0m"        exit 1    } || echo -e "\\033[34mAction：${deploy_env}\\033[0m"    echo -e "\\033[34mRollback version：${version}\\033[0m"    rm -rfv ${ZIP_NAME}.zip    cp -Rv ${JENKINS_HOME}/jobs/`echo ${JOB_NAME}|awk -F'/' '{print \$1}'`/branches/${BRANCH_NAME}/builds/${version}/archive/${ZIP_NAME}.zip .    [ \$? -eq 0 ] &amp;&amp; echo -e "\\033[32m指定版本号${version}的${ZIP_NAME}.zip复制到当前部署目录成功。\\033[0m" || {        echo -e "\\033[31m指定版本号${version}的${ZIP_NAME}.zip复制到当前部署目录失败。\\033[0m"        exit 1    }    """}def update(host) {    for(i in host){        sshPublisher(            publishers: [sshPublisherDesc(configName: "$i", transfers: [sshTransfer(cleanRemote: false, excludes: '', execCommand: """            IN_Face=`/sbin/route -n |awk '{if(\$4~/UG/){print \$8}}'|head -n 1`            Local_IP=`/sbin/ip addr show "\${IN_Face}" | grep -w 'inet' | awk '{print \$2}'`            cd /App/htdocs/${APP_NAME}                            echo -e "\\033[34m\${Local_IP}节点解压新版压缩包${ZIP_NAME}.zip：\\033[0m"            unzip -o ${ZIP_NAME}.zip &amp;&amp; echo -e "\\033[32m\${Local_IP}节点${ZIP_NAME}.zip解压成功。\\033[0m" || {            echo -e "\\033[31m\${Local_IP}节点${ZIP_NAME}.zip解压失败。\\033[0m"            exit 1            }            public_dir=`echo ${ZIP_NAME} | awk -F'_' '{print \$1}'`            echo -e "\\033[34m\${Local_IP}节点将${ZIP_NAME}目录下数据同步到生产目录\${public_dir}内：\\033[0m"            [ -d ${ZIP_NAME} ] &amp;&amp; rsync -vrl --delete ${ZIP_NAME}/ \${public_dir:-/tmp/aaa}/            [ \$? -eq 0 ] &amp;&amp; echo -e "\\033[32m\${Local_IP}节点数据同步成功。\\033[0m" || {            echo -e "\\033[31m\${Local_IP}节点数据同步失败。\\033[0m"            exit 1            }            echo -e "\\033[34m\${Local_IP}节点将${ZIP_NAME}.zip删除：\\033[0m"            rm -rfv ${ZIP_NAME}.zip ${ZIP_NAME}            echo -e "\\033[32m${JOB_NAME}发布成功。\\033[0m"            """, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: '[, ]+', remoteDirectory: "htdocs/${APP_NAME}", remoteDirectorySDF: false, removePrefix: '', sourceFiles: "${ZIP_NAME}.zip")], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)]        )    }}</code></pre><h1 class=pgc-h-arrow-right><strong>Jenkinsfile</strong></h1><p><strong>1.参数化构建</strong></p><p>通过parameters 定义构建的参数：deploy、rollback</p><p>回滚通过BUILD_NUMBER传输历史版本的归档。</p><p><strong>2.环境变量</strong></p><p>我们定义两个环境变量：</p><p>APP_NAME 项目所在目录，如/App/${APP_NAME}/dist</p><p>ZIP_NAME 版本包</p><p><strong>3.流水线步骤</strong></p><p>发版：调用共享库deploy方法；</p><p>回滚：调用共享库rollback方法；</p><p>测试部署：调用共享库update方法，传入测试环境服务器列表；</p><p>生产部署：调用共享库update方法，传入生产环境服务器列表；</p><p>归档：不管构建状态，总是归档版本包dist_temp.zip；</p><p>邮件通知：构建不稳定、成功、失败发送邮件通知；</p><p><br></p><p><strong>注意：流水线中我们使用when来匹配参数化构建，这样可以避避免在sh中使用case或if 判断，减少代码量。</strong></p><p>具体代码如下：</p><pre><code>//引入jenkins扩展共享库@Library('shared-library') _pipeline {    agent any    options {        ansiColor('xterm')        timestamps()    }    parameters {        choice choices: ['deploy', 'rollback'], description: '''deploy：发布            rollback：回滚''', name: 'deploy_env'        string defaultValue: '0', description: '''回滚版本号，发布时忽略该参数            版本号为jenkins job BUILD_NUMBER''', name: 'version', trim: false    }    environment {        APP_NAME="www.test.cn"        ZIP_NAME="dist_temp"    }    stages {        stage('发版') {            //匹配发版参数            when {                expression { params.deploy_env ==~ 'deploy' }            }      steps {                script {                    vueUpdate.deploy()                }            }        }        stage('回滚') {            //匹配回滚参数            when {                expression { params.deploy_env ==~ 'rollback' }            }            steps {                script {                    vueUpdate.rollback()                }            }        }        stage('测试部署') {            //匹配develop分支            when {                branch 'develop'            }            steps {                script {                    def host = ["test-10.13", "test-10.14"]                    vueUpdate.update(host)            }        }        stage('生产部署') {            //匹配master分支            when {                branch 'master'            }            steps {                script {                    def host = ["prod-10.11", "prod-10.12"]                    vueUpdate.update(host)                }            }        }  }    post {        always {            archiveArtifacts "${ZIP_NAME}.zip"        }        unstable {            emailext (                body: """项目名称：${JOB_NAME}\n构建编号：${BUILD_NUMBER}\n构建日志：${BUILD_URL}console""",                subject: '【Jenkins构建通知】:$JOB_NAME - Build # $BUILD_NUMBER - Unstable!',                to: 'xx@test.cn',                from: 'test@test.cn'            )        }        success {            emailext (                body: """项目名称：${JOB_NAME}\n构建编号：${BUILD_NUMBER}\n构建日志：${BUILD_URL}console""",                subject: '【Jenkins构建通知】:$JOB_NAME - Build # $BUILD_NUMBER - Successful!',                to: 'xx@test.cn',                from: 'test@test.cn'            )        }        failure {            emailext (                body: """项目名称：${JOB_NAME}\n构建编号：${BUILD_NUMBER}\n构建日志：${BUILD_URL}console""",                subject: '【Jenkins构建通知】:$JOB_NAME - Build # $BUILD_NUMBER - Failure!',                to: 'xx@test.cn',                from: 'test@test.cn'            )        }    }}</code></pre><p>最终结果如下：</p><p><br></p><div class=pgc-img><img alt=Jenkins扩展共享库进阶 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/39e1e758c4d64ffb9c04a84b135569bc><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=Jenkins扩展共享库进阶 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/44a50dd47e20488ca9ba2aa552f880e9><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>总结</strong></h1><p>Jenkins扩展共享库+多分支流水线一方面可以简化CI/CD过程中的项目管理，一方面可以驱动我们各个环境的标准化，为实现自动化做好铺垫。</p><p>反过来环境标准化是我们灵活应用Jenkins扩展共享库的前提，没有足够的标准化，那么我们就需要增加代码量去适配各个环境。</p><p>总之，在运维的过程中，你会发现标准化和规范化越来越重要。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Jenkins','扩展','进阶'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>