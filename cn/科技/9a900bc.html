<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>PageHelperåˆ†é¡µæ’ä»¶æºç åŠåŸç†å‰–æ | æå®¢å¿«è¨Š</title><meta property="og:title" content="PageHelperåˆ†é¡µæ’ä»¶æºç åŠåŸç†å‰–æ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/7be33d442f35419cbb3709ec81b6fb94"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9a900bc.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9a900bc.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9a900bc.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9a900bc.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9a900bc.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9a900bc.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9a900bc.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9a900bc.html><meta property="article:published_time" content="2020-10-29T20:58:00+08:00"><meta property="article:modified_time" content="2020-10-29T20:58:00+08:00"><meta name=Keywords content><meta name=description content="PageHelperåˆ†é¡µæ’ä»¶æºç åŠåŸç†å‰–æ"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/9a900bc.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>PageHelperåˆ†é¡µæ’ä»¶æºç åŠåŸç†å‰–æ</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p>PageHelperæ˜¯ä¸€æ¬¾å¥½ç”¨çš„å¼€æºå…è´¹çš„Mybatisç¬¬ä¸‰æ–¹ç‰©ç†åˆ†é¡µæ’ä»¶ï¼Œå…¶å®æˆ‘å¹¶ä¸æƒ³åŠ ä¸Šå¥½ç”¨ä¸¤ä¸ªå­—ï¼Œä½†æ˜¯ä¸ºäº†è¡¨æ‰¬æ’ä»¶ä½œè€…å¼€æºå…è´¹çš„å´‡é«˜ç²¾ç¥ï¼Œæˆ‘æ¯«ä¸çŠ¹è±«çš„åŠ ä¸Šäº†å¥½ç”¨ä¸€è¯ä½œä¸ºèµç¾ã€‚</p><p>åŸæœ¬ä»¥ä¸ºåˆ†é¡µæ’ä»¶ï¼Œåº”è¯¥æ˜¯å¾ˆç®€å•çš„ï¼Œç„¶è€ŒPageHelperæ¯”æˆ‘æƒ³è±¡çš„è¦å¤æ‚è®¸å¤šï¼Œå®ƒåšçš„å¾ˆå¼ºå¤§ï¼Œä¹Ÿå¾ˆå½»åº•ï¼Œå¼ºå¤§åˆ°ä½¿ç”¨è€…å¯èƒ½å¹¶ä¸éœ€è¦è¿™ä¹ˆå¤šåŠŸèƒ½ï¼Œå½»åº•åˆ°ä¸€å‚å¯ä»¥ä¸¤ç”¨ã€‚ä½†æ˜¯ï¼Œæˆ‘è®¤ä¸ºï¼Œä½œä¸ºåˆ†é¡µæ’ä»¶ï¼Œå®Œæˆç‰©ç†åˆ†é¡µä»»åŠ¡æ˜¯æ ¹æœ¬ï¼Œå…¶å®ƒçš„å¾ˆå¤šæ™ºèƒ½å¹¶ä¸æ˜¯å¿…è¦çš„ï¼Œä¿æŒå®ƒå¤Ÿå‚»å¤Ÿæ†¨ï¼Œä¸“ä¸šæœ¯è¯­å«stupidï¼Œç®€å•å°±æ˜¯ç¾ã€‚</p><p>æˆ‘ä»¬å°†ç®€å•ä»‹ç»PageHelperçš„åŸºæœ¬ä½¿ç”¨å’Œé…ç½®å‚æ•°çš„å«ä¹‰ï¼Œé‡ç‚¹åˆ†æPageHelperä½œä¸ºMybatisåˆ†é¡µæ’ä»¶çš„å®ç°åŸç†ã€‚</p><p>1. PageHelperçš„mavenä¾èµ–åŠæ’ä»¶é…ç½®</p><pre>&lt;dependency&gt; &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt; &lt;artifactId&gt;pagehelper&lt;/artifactId&gt; &lt;version&gt;4.1.6&lt;/version&gt;&lt;/dependency&gt;</pre><p>PageHelperé™¤äº†æœ¬èº«çš„jaråŒ…å¤–ï¼Œå®ƒè¿˜ä¾èµ–äº†ä¸€ä¸ªå«jsqlparserçš„jaråŒ…ï¼Œä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦å•ç‹¬æŒ‡å®šjsqlparserçš„mavenä¾èµ–ï¼Œmavençš„é—´æ¥ä¾èµ–ä¼šå¸®æˆ‘ä»¬å¼•å…¥ã€‚</p><p><br></p><div class=pgc-img><img alt=PageHelperåˆ†é¡µæ’ä»¶æºç åŠåŸç†å‰–æ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7be33d442f35419cbb3709ec81b6fb94><p class=pgc-img-caption></p></div><p><br></p><pre>&lt;!-- com.github.pagehelperä¸ºPageHelperç±»æ‰€åœ¨åŒ…å --&gt;&lt;plugin interceptor="com.github.pagehelper.PageHelper"&gt; &lt;property name="dialect" value="mysql" /&gt; &lt;!-- è¯¥å‚æ•°é»˜è®¤ä¸ºfalse --&gt; &lt;!-- è®¾ç½®ä¸ºtrueæ—¶ï¼Œä¼šå°†RowBoundsç¬¬ä¸€ä¸ªå‚æ•°offsetå½“æˆpageNumé¡µç ä½¿ç”¨ --&gt; &lt;!-- å’ŒstartPageä¸­çš„pageNumæ•ˆæœä¸€æ · --&gt; &lt;property name="offsetAsPageNum" value="false" /&gt; &lt;!-- è¯¥å‚æ•°é»˜è®¤ä¸ºfalse --&gt; &lt;!-- è®¾ç½®ä¸ºtrueæ—¶ï¼Œä½¿ç”¨RowBoundsåˆ†é¡µä¼šè¿›è¡ŒcountæŸ¥è¯¢ --&gt; &lt;property name="rowBoundsWithCount" value="true" /&gt; &lt;!-- è®¾ç½®ä¸ºtrueæ—¶ï¼Œå¦‚æœpageSize=0æˆ–è€…RowBounds.limit = 0å°±ä¼šæŸ¥è¯¢å‡ºå…¨éƒ¨çš„ç»“æœ --&gt; &lt;!-- ï¼ˆç›¸å½“äºæ²¡æœ‰æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢ï¼Œä½†æ˜¯è¿”å›ç»“æœä»ç„¶æ˜¯Pageç±»å‹ï¼‰ &lt;property name="pageSizeZero" value="true"/&gt; --&gt; &lt;!-- 3.3.0ç‰ˆæœ¬å¯ç”¨ - åˆ†é¡µå‚æ•°åˆç†åŒ–ï¼Œé»˜è®¤falseç¦ç”¨ --&gt; &lt;!-- å¯ç”¨åˆç†åŒ–æ—¶ï¼Œå¦‚æœpageNum&lt;1ä¼šæŸ¥è¯¢ç¬¬ä¸€é¡µï¼Œå¦‚æœpageNum&gt;pagesä¼šæŸ¥è¯¢æœ€åä¸€é¡µ --&gt; &lt;!-- ç¦ç”¨åˆç†åŒ–æ—¶ï¼Œå¦‚æœpageNum&lt;1æˆ–pageNum&gt;pagesä¼šè¿”å›ç©ºæ•°æ® --&gt; &lt;property name="reasonable" value="true" /&gt; &lt;!-- 3.5.0ç‰ˆæœ¬å¯ç”¨ - ä¸ºäº†æ”¯æŒstartPage(Object params)æ–¹æ³• --&gt; &lt;!-- å¢åŠ äº†ä¸€ä¸ª`params`å‚æ•°æ¥é…ç½®å‚æ•°æ˜ å°„ï¼Œç”¨äºä»Mapæˆ–ServletRequestä¸­å–å€¼ --&gt; &lt;!-- å¯ä»¥é…ç½®pageNum,pageSize,count,pageSizeZero,reasonable,ä¸é…ç½®æ˜ å°„çš„ç”¨é»˜è®¤å€¼ --&gt; &lt;!-- ä¸ç†è§£è¯¥å«ä¹‰çš„å‰æä¸‹ï¼Œä¸è¦éšä¾¿å¤åˆ¶è¯¥é…ç½® &lt;property name="params" value="pageNum=start;pageSize=limit;"/&gt; --&gt;&lt;/plugin&gt;</pre><p>ä¸Šé¢æ˜¯PageHelperå®˜æ–¹ç»™çš„é…ç½®å’Œæ³¨é‡Šï¼Œè™½ç„¶å†™çš„å¾ˆå¤šï¼Œä¸è¿‡ç¡®å®æè¿°çš„å¾ˆæ˜ç™½ã€‚</p><blockquote><p><strong>dialectï¼š</strong>æ ‡è¯†æ˜¯å“ªä¸€ç§æ•°æ®åº“ï¼Œè®¾è®¡ä¸Šå¿…é¡»ã€‚</p><p><strong>offsetAsPageNumï¼š</strong>å°†RowBoundsç¬¬ä¸€ä¸ªå‚æ•°offsetå½“æˆpageNumé¡µç ä½¿ç”¨ï¼Œè¿™å°±æ˜¯ä¸Šé¢è¯´çš„ä¸€å‚ä¸¤ç”¨ï¼Œä¸ªäººè§‰å¾—å®Œå…¨æ²¡å¿…è¦ï¼Œoffset = pageSize * pageNumå°±æå®šäº†ï¼Œä½•å¿…æ··ç”¨å‚æ•°å‘¢ï¼Ÿ</p><p><strong>rowBoundsWithCountï¼š</strong>è®¾ç½®ä¸ºtrueæ—¶ï¼Œä½¿ç”¨RowBoundsåˆ†é¡µä¼šè¿›è¡ŒcountæŸ¥è¯¢ï¼Œä¸ªäººè§‰å¾—å®Œå…¨æ²¡å¿…è¦ï¼Œå®é™…å¼€å‘ä¸­ï¼Œæ¯ä¸€ä¸ªåˆ—è¡¨åˆ†é¡µæŸ¥è¯¢ï¼Œéƒ½é…å¤‡ä¸€ä¸ªcountæ•°é‡æŸ¥è¯¢å³å¯ã€‚</p><p><strong>reasonableï¼š</strong>value=trueæ—¶ï¼ŒpageNumå°äº1ä¼šæŸ¥è¯¢ç¬¬ä¸€é¡µï¼Œå¦‚æœpageNumå¤§äºpageSizeä¼šæŸ¥è¯¢æœ€åä¸€é¡µ ï¼Œä¸ªäººè®¤ä¸ºï¼Œå‚æ•°æ ¡éªŒåœ¨è¿›å…¥Mybatisä¸šåŠ¡ä½“ç³»ä¹‹å‰ï¼Œå°±åº”è¯¥å®Œæˆäº†ï¼Œä¸å¯èƒ½åˆ°è¾¾Mybatisä¸šåŠ¡ä½“ç³»å†…å‚æ•°è¿˜å¸¦æœ‰éæ³•çš„å€¼ã€‚</p></blockquote><p>è¿™ä¹ˆä¸€æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦è®°ä½ dialect = mysql ä¸€ä¸ªå‚æ•°å³å¯ï¼Œå…¶å®ï¼Œè¿˜æœ‰ä¸‹é¢å‡ ä¸ªç›¸å…³å‚æ•°å¯ä»¥é…ç½®ã€‚</p><blockquote><p><strong>autoDialectï¼š</strong>true or falseï¼Œæ˜¯å¦è‡ªåŠ¨æ£€æµ‹dialectã€‚</p><p><strong>autoRuntimeDialectï¼š</strong>true or falseï¼Œå¤šæ•°æ®æºæ—¶ï¼Œæ˜¯å¦è‡ªåŠ¨æ£€æµ‹dialectã€‚</p><p><strong>closeConnï¼š</strong>true or falseï¼Œæ£€æµ‹å®Œdialectåï¼Œæ˜¯å¦å…³é—­Connectionè¿æ¥ã€‚</p></blockquote><p>ä¸Šé¢è¿™3ä¸ªæ™ºèƒ½å‚æ•°ï¼Œä¸åˆ°ä¸‡ä¸å¾—å·²ï¼Œæˆ‘ä»¬ä¸åº”è¯¥åœ¨ç³»ç»Ÿä¸­ä½¿ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªdialect = mysql æˆ–è€… dialect = oracleå°±å¤Ÿäº†ï¼Œå¦‚æœç³»ç»Ÿä¸­éœ€è¦ä½¿ç”¨ï¼Œè¿˜æ˜¯å¾—é—®é—®è‡ªå·±ï¼Œæ˜¯å¦çœŸçš„éç”¨ä¸å¯ã€‚</p><p>2. PageHelperæºç åˆ†æ</p><pre>@Intercepts(@Signature(type = Executor.class, method = "query", args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}))public class PageHelper implements Interceptor { //sqlå·¥å…·ç±» private SqlUtil sqlUtil; //å±æ€§å‚æ•°ä¿¡æ¯ private Properties properties; //é…ç½®å¯¹è±¡æ–¹å¼ private SqlUtilConfig sqlUtilConfig; //è‡ªåŠ¨è·å–dialect,å¦‚æœæ²¡æœ‰setPropertiesæˆ–setSqlUtilConfigï¼Œä¹Ÿå¯ä»¥æ­£å¸¸è¿›è¡Œ private boolean autoDialect = true; //è¿è¡Œæ—¶è‡ªåŠ¨è·å–dialect private boolean autoRuntimeDialect; //å¤šæ•°æ®æºæ—¶ï¼Œè·å–jdbcurlåæ˜¯å¦å…³é—­æ•°æ®æº private boolean closeConn = true; //ç¼“å­˜ private Map&lt;String, SqlUtil&gt; urlSqlUtilMap = new ConcurrentHashMap&lt;String, SqlUtil&gt;(); private ReentrantLock lock = new ReentrantLock();// ...}</pre><p>ä¸Šé¢æ˜¯å®˜æ–¹æºç ä»¥åŠæºç æ‰€å¸¦çš„æ³¨é‡Šï¼Œæˆ‘ä»¬å†è¡¥å……ä¸€ä¸‹ã€‚</p><p><strong>SqlUtilï¼š</strong>æ•°æ®åº“ç±»å‹ä¸“ç”¨sqlå·¥å…·ç±»ï¼Œä¸€ä¸ªæ•°æ®åº“urlå¯¹åº”ä¸€ä¸ªSqlUtilå®ä¾‹ï¼ŒSqlUtilå†…æœ‰ä¸€ä¸ªParserå¯¹è±¡ï¼Œå¦‚æœæ˜¯mysqlï¼Œå®ƒæ˜¯MysqlParserï¼Œå¦‚æœæ˜¯oracleï¼Œå®ƒæ˜¯OracleParserï¼Œè¿™ä¸ªParserå¯¹è±¡æ˜¯SqlUtilä¸åŒå®ä¾‹çš„ä¸»è¦å­˜åœ¨ä»·å€¼ã€‚æ‰§è¡ŒcountæŸ¥è¯¢ã€è®¾ç½®Parserå¯¹è±¡ã€æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢ã€ä¿å­˜Pageåˆ†é¡µå¯¹è±¡ç­‰åŠŸèƒ½ï¼Œå‡ç”±SqlUtilæ¥å®Œæˆã€‚</p><p><strong>SqlUtilConfigï¼š</strong>Spring Bootä¸­ä½¿ç”¨ï¼Œå¿½ç•¥ã€‚</p><p><strong>autoRuntimeDialectï¼š</strong>å¤šä¸ªæ•°æ®æºåˆ‡æ¢æ—¶ï¼Œæ¯”å¦‚mysqlå’Œoracleæ•°æ®æºåŒæ—¶å­˜åœ¨ï¼Œå°±ä¸èƒ½ç®€å•æŒ‡å®šdialectï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿è¡Œæ—¶è‡ªåŠ¨æ£€æµ‹å½“å‰çš„dialectã€‚</p><p><strong>Map&lt;String, SqlUtil> urlSqlUtilMapï¼š</strong>å®ƒå°±ç”¨æ¥ç¼“å­˜autoRuntimeDialectè‡ªåŠ¨æ£€æµ‹ç»“æœçš„ï¼Œkeyæ˜¯æ•°æ®åº“çš„urlï¼Œvalueæ˜¯SqlUtilã€‚ç”±äºè¿™ç§è‡ªåŠ¨æ£€æµ‹åªéœ€è¦æ‰§è¡Œ1æ¬¡ï¼Œæ‰€ä»¥åšäº†ç¼“å­˜ã€‚</p><p><strong>ReentrantLock lockï¼š</strong>è¿™ä¸ªlockå¯¹è±¡æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ç°è±¡ï¼ŒurlSqlUtilMapæ˜æ˜æ˜¯ä¸€ä¸ªåŒæ­¥ConcurrentHashMapï¼Œåˆæäº†ä¸€ä¸ªlockå‡ºæ¥åŒæ­¥ConcurrentHashMapåšä»€ä¹ˆå‘¢ï¼Ÿæ˜¯å¦æ˜¯ç”»è›‡æ·»è¶³ï¼Ÿ</p><p>åœ¨ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ä¸€ä¹¦ä¸­æœ‰è¯¦ç»†è®ºè¿°ï¼Œç®€å•çš„è¯´ï¼ŒConcurrentHashMapå¯ä»¥ä¿è¯putæˆ–è€…removeæ–¹æ³•ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å®ƒä¸èƒ½ä¿è¯putã€getã€removeçš„ç»„åˆæ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸ºäº†ä¿è¯ç»„åˆæ“ä½œä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ä½¿ç”¨äº†lockã€‚</p><p>com.github.pagehelper.PageHelper.javaæºç ã€‚</p><pre> // Mybatisæ‹¦æˆªå™¨æ–¹æ³•  public Object intercept(Invocation invocation) throws Throwable { if (autoRuntimeDialect) { // å¤šæ•°æ®æº SqlUtil sqlUtil = getSqlUtil(invocation); return sqlUtil.processPage(invocation); } else { // å•æ•°æ®æº if (autoDialect) { initSqlUtil(invocation); } // æŒ‡å®šäº†dialect return sqlUtil.processPage(invocation); } } public synchronized void initSqlUtil(Invocation invocation) { if (this.sqlUtil == null) { this.sqlUtil = getSqlUtil(invocation); if (!autoRuntimeDialect) { properties = null; sqlUtilConfig = null; } autoDialect = false; } } public void setProperties(Properties p) { checkVersion(); //å¤šæ•°æ®æºæ—¶ï¼Œè·å–jdbcurlåæ˜¯å¦å…³é—­æ•°æ®æº String closeConn = p.getProperty("closeConn"); //è§£å†³#97 if(StringUtil.isNotEmpty(closeConn)){ this.closeConn = Boolean.parseBoolean(closeConn); } //åˆå§‹åŒ–SqlUtilçš„PARAMS SqlUtil.setParams(p.getProperty("params")); //æ•°æ®åº“æ–¹è¨€ String dialect = p.getProperty("dialect"); String runtimeDialect = p.getProperty("autoRuntimeDialect"); if (StringUtil.isNotEmpty(runtimeDialect) &amp;&amp; runtimeDialect.equalsIgnoreCase("TRUE")) { this.autoRuntimeDialect = true; this.autoDialect = false; this.properties = p; } else if (StringUtil.isEmpty(dialect)) { autoDialect = true; this.properties = p; } else { autoDialect = false; sqlUtil = new SqlUtil(dialect); sqlUtil.setProperties(p); } } public SqlUtil getSqlUtil(Invocation invocation) { MappedStatement ms = (MappedStatement) invocation.getArgs()[0]; //æ”¹ä¸ºå¯¹dataSourceåšç¼“å­˜ DataSource dataSource = ms.getConfiguration().getEnvironment().getDataSource(); String url = getUrl(dataSource); if (urlSqlUtilMap.containsKey(url)) { return urlSqlUtilMap.get(url); } try { lock.lock(); if (urlSqlUtilMap.containsKey(url)) { return urlSqlUtilMap.get(url); } if (StringUtil.isEmpty(url)) { throw new RuntimeException("æ— æ³•è‡ªåŠ¨è·å–jdbcUrlï¼Œè¯·åœ¨åˆ†é¡µæ’ä»¶ä¸­é…ç½®dialectå‚æ•°!"); } String dialect = Dialect.fromJdbcUrl(url); if (dialect == null) { throw new RuntimeException("æ— æ³•è‡ªåŠ¨è·å–æ•°æ®åº“ç±»å‹ï¼Œè¯·é€šè¿‡dialectå‚æ•°æŒ‡å®š!"); } SqlUtil sqlUtil = new SqlUtil(dialect); if (this.properties != null) { sqlUtil.setProperties(properties); } else if (this.sqlUtilConfig != null) { sqlUtil.setSqlUtilConfig(this.sqlUtilConfig); } urlSqlUtilMap.put(url, sqlUtil); return sqlUtil; } finally { lock.unlock(); } }</pre><blockquote><p><strong>autoRuntimeDialectï¼š</strong>å¤šæ•°æ®æºï¼Œä¼šåˆ›å»ºå¤šä¸ªSqlUtilã€‚</p><p><strong>autoDialectï¼š</strong>å•æ•°æ®æºï¼Œåªä¼šåˆ›å»º1ä¸ªSqlUtilã€‚å•æ•°æ®æºæ—¶ï¼Œä¹Ÿå¯ä»¥å½“åšå¤šæ•°æ®æºæ¥ä½¿ç”¨ã€‚</p><p><strong>æŒ‡å®šäº†dialectï¼š</strong>åªä¼šåˆ›å»º1ä¸ªSqlUtilã€‚</p></blockquote><p>3. PageSqlSource</p><pre>public abstract class PageSqlSource implements SqlSource { /** * è·å–æ­£å¸¸çš„BoundSql * * @param parameterObject * @return */ protected abstract BoundSql getDefaultBoundSql(Object parameterObject); /** * è·å–CountæŸ¥è¯¢çš„BoundSql * * @param parameterObject * @return */ protected abstract BoundSql getCountBoundSql(Object parameterObject); /** * è·å–åˆ†é¡µæŸ¥è¯¢çš„BoundSql * * @param parameterObject * @return */ protected abstract BoundSql getPageBoundSql(Object parameterObject); /** * è·å–BoundSql * * @param parameterObject * @return */ @Override public BoundSql getBoundSql(Object parameterObject) { Boolean count = getCount(); if (count == null) { return getDefaultBoundSql(parameterObject); } else if (count) { return getCountBoundSql(parameterObject); } else { return getPageBoundSql(parameterObject); } }}</pre><blockquote><p><strong>getDefaultBoundSqlï¼š</strong>è·å–åŸå§‹çš„æœªç»æ”¹é€ çš„BoundSqlã€‚</p><p><strong>getCountBoundSqlï¼š</strong>ä¸éœ€è¦å†™countæŸ¥è¯¢ï¼Œæ’ä»¶æ ¹æ®åˆ†é¡µæŸ¥è¯¢sqlï¼Œæ™ºèƒ½çš„ä¸ºä½ ç”Ÿæˆçš„countæŸ¥è¯¢BoundSqlã€‚</p><p><strong>getPageBoundSqlï¼š</strong>è·å–åˆ†é¡µæŸ¥è¯¢çš„BoundSqlã€‚</p></blockquote><p>ä¸¾ä¾‹ï¼š</p><p>DefaultBoundSqlï¼š</p><pre>select stud_id as studId , name, email, dob, phone from students</pre><p>CountBoundSqlï¼š</p><pre>select count(0) from students --ç”±PageHelperæ™ºèƒ½å®Œæˆ</pre><p>PageBoundSqlï¼š</p><pre>select stud_id as studId , name, email, dob, phone from students limit ?, ?</pre><p><br></p><div class=pgc-img><img alt=PageHelperåˆ†é¡µæ’ä»¶æºç åŠåŸç†å‰–æ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/88aff6a4ee9e495db10fc087bbb86f48><p class=pgc-img-caption></p></div><p><br></p><pre>public class PageStaticSqlSource extends PageSqlSource { private String sql; private List&lt;ParameterMapping&gt; parameterMappings; private Configuration configuration; private SqlSource original; @Override protected BoundSql getDefaultBoundSql(Object parameterObject) { String tempSql = sql; String orderBy = PageHelper.getOrderBy(); if (orderBy != null) { tempSql = OrderByParser.converToOrderBySql(sql, orderBy); } return new BoundSql(configuration, tempSql, parameterMappings, parameterObject); } @Override protected BoundSql getCountBoundSql(Object parameterObject) { // localParseræŒ‡çš„å°±æ˜¯MysqlParseræˆ–è€…OracleParser // localParser.get().getCountSql(sql)ï¼Œå¯ä»¥æ ¹æ®åŸå§‹çš„sqlï¼Œç”Ÿæˆä¸€ä¸ªcountæŸ¥è¯¢çš„sql return new BoundSql(configuration, localParser.get().getCountSql(sql), parameterMappings, parameterObject); } @Override protected BoundSql getPageBoundSql(Object parameterObject) { String tempSql = sql; String orderBy = PageHelper.getOrderBy(); if (orderBy != null) { tempSql = OrderByParser.converToOrderBySql(sql, orderBy); } // getPageSqlå¯ä»¥æ ¹æ®åŸå§‹çš„sqlï¼Œç”Ÿæˆä¸€ä¸ªå¸¦æœ‰åˆ†é¡µå‚æ•°ä¿¡æ¯çš„sqlï¼Œæ¯”å¦‚ limit ?, ? tempSql = localParser.get().getPageSql(tempSql); // ç”±äºsqlå¢åŠ äº†åˆ†é¡µå‚æ•°çš„ï¼Ÿå·å ä½ç¬¦ï¼ŒgetPageParameterMapping()å°±æ˜¯åœ¨åŸæœ‰List&lt;ParameterMapping&gt;åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸¤ä¸ªåˆ†é¡µå‚æ•°å¯¹åº”çš„ParameterMappingå¯¹è±¡ï¼Œä¸ºåˆ†é¡µå‚æ•°èµ‹å€¼ä½¿ç”¨ return new BoundSql(configuration, tempSql, localParser.get().getPageParameterMapping(configuration, original.getBoundSql(parameterObject)), parameterObject); }}</pre><p>å‡è®¾List&lt;ParameterMapping>åŸæ¥çš„size=2ï¼Œæ·»åŠ åˆ†é¡µå‚æ•°åï¼Œå…¶size=4ï¼Œå…·ä½“å¢åŠ å¤šå°‘ä¸ªï¼Œçœ‹åˆ†é¡µå‚æ•°çš„ï¼Ÿå·æ•°é‡ã€‚</p><p>å…¶ä»–PageSqlSourceï¼ŒåŸç†å’ŒPageStaticSqlSourceä¸€æ¨¡ä¸€æ ·ã€‚</p><p>è§£æsqlï¼Œå¹¶å¢åŠ åˆ†é¡µå‚æ•°å ä½ç¬¦ï¼Œæˆ–è€…ç”ŸæˆcountæŸ¥è¯¢çš„sqlï¼Œéƒ½ä¾é Parseræ¥å®Œæˆã€‚</p><p>4. com.github.pagehelper.parser.Parser</p><div class=pgc-img><img alt=PageHelperåˆ†é¡µæ’ä»¶æºç åŠåŸç†å‰–æ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e2c68f0b100d445aaa3db3b6e3765487><p class=pgc-img-caption></p></div><p><br></p><pre>public class MysqlParser extends AbstractParser { @Override public String getPageSql(String sql) { StringBuilder sqlBuilder = new StringBuilder(sql.length() + 14); sqlBuilder.append(sql); sqlBuilder.append(" limit ?,?"); return sqlBuilder.toString(); } @Override public Map&lt;String, Object&gt; setPageParameter(MappedStatement ms, Object parameterObject, BoundSql boundSql, Page&lt;?&gt; page) { Map&lt;String, Object&gt; paramMap = super.setPageParameter(ms, parameterObject, boundSql, page); paramMap.put(PAGEPARAMETER_FIRST, page.getStartRow()); paramMap.put(PAGEPARAMETER_SECOND, page.getPageSize()); return paramMap; }}</pre><p>æˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼ŒMysqlParseræ˜¯å¦‚ä½•æ·»åŠ åˆ†é¡µå ä½ç¬¦å’Œåˆ†é¡µå‚æ•°çš„ã€‚</p><pre>public abstract class AbstractParser implements Parser, Constant { public String getCountSql(final String sql) { return sqlParser.getSmartCountSql(sql); }}</pre><p>ç”Ÿæˆcount sqlï¼Œåˆ™æ˜¯å‰æ–‡æåˆ°çš„jsqlparserå·¥å…·åŒ…æ¥å®Œæˆçš„ï¼Œæ˜¯å¦å¤–ä¸€ä¸ªå¼€æºçš„sqlè§£æå·¥å…·åŒ…ã€‚</p><p>5. SqlUtil.doProcessPage()åˆ†é¡µæŸ¥è¯¢</p><pre>// PageSqlSourceè£…é¥°åŸSqlSource public void processMappedStatement(MappedStatement ms) throws Throwable { SqlSource sqlSource = ms.getSqlSource(); MetaObject msObject = SystemMetaObject.forObject(ms); SqlSource pageSqlSource; if (sqlSource instanceof StaticSqlSource) { pageSqlSource = new PageStaticSqlSource((StaticSqlSource) sqlSource); } else if (sqlSource instanceof RawSqlSource) { pageSqlSource = new PageRawSqlSource((RawSqlSource) sqlSource); } else if (sqlSource instanceof ProviderSqlSource) { pageSqlSource = new PageProviderSqlSource((ProviderSqlSource) sqlSource); } else if (sqlSource instanceof DynamicSqlSource) { pageSqlSource = new PageDynamicSqlSource((DynamicSqlSource) sqlSource); } else { throw new RuntimeException("æ— æ³•å¤„ç†è¯¥ç±»å‹[" + sqlSource.getClass() + "]çš„SqlSource"); } msObject.setValue("sqlSource", pageSqlSource); //ç”±äºcountæŸ¥è¯¢éœ€è¦ä¿®æ”¹è¿”å›å€¼ï¼Œå› æ­¤è¿™é‡Œè¦åˆ›å»ºä¸€ä¸ªCountæŸ¥è¯¢çš„MS msCountMap.put(ms.getId(), MSUtils.newCountMappedStatement(ms)); }// æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢private Page doProcessPage(Invocation invocation, Page page, Object[] args) throws Throwable { //ä¿å­˜RowBoundsçŠ¶æ€ RowBounds rowBounds = (RowBounds) args[2]; //è·å–åŸå§‹çš„ms MappedStatement ms = (MappedStatement) args[0]; //åˆ¤æ–­å¹¶å¤„ç†ä¸ºPageSqlSource if (!isPageSqlSource(ms)) { processMappedStatement(ms); } //è®¾ç½®å½“å‰çš„parserï¼Œåé¢æ¯æ¬¡ä½¿ç”¨å‰éƒ½ä¼šsetï¼ŒThreadLocalçš„å€¼ä¸ä¼šäº§ç”Ÿä¸è‰¯å½±å“ ((PageSqlSource)ms.getSqlSource()).setParser(parser); try { //å¿½ç•¥RowBounds-å¦åˆ™ä¼šè¿›è¡ŒMybatisè‡ªå¸¦çš„å†…å­˜åˆ†é¡µ args[2] = RowBounds.DEFAULT; //å¦‚æœåªè¿›è¡Œæ’åº æˆ– pageSizeZeroçš„åˆ¤æ–­ if (isQueryOnly(page)) { return doQueryOnly(page, invocation); } //ç®€å•çš„é€šè¿‡totalçš„å€¼æ¥åˆ¤æ–­æ˜¯å¦è¿›è¡ŒcountæŸ¥è¯¢ if (page.isCount()) { page.setCountSignal(Boolean.TRUE); //æ›¿æ¢MS args[0] = msCountMap.get(ms.getId()); //æŸ¥è¯¢æ€»æ•° Object result = invocation.proceed(); //è¿˜åŸms args[0] = ms; //è®¾ç½®æ€»æ•° page.setTotal((Integer) ((List) result).get(0)); if (page.getTotal() == 0) { return page; } } else { page.setTotal(-1l); } //pageSize&gt;0çš„æ—¶å€™æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢ï¼ŒpageSize&lt;=0çš„æ—¶å€™ä¸æ‰§è¡Œç›¸å½“äºå¯èƒ½åªè¿”å›äº†ä¸€ä¸ªcount if (page.getPageSize() &gt; 0 &amp;&amp; ((rowBounds == RowBounds.DEFAULT &amp;&amp; page.getPageNum() &gt; 0) || rowBounds != RowBounds.DEFAULT)) { //å°†å‚æ•°ä¸­çš„MappedStatementæ›¿æ¢ä¸ºæ–°çš„qs page.setCountSignal(null); BoundSql boundSql = ms.getBoundSql(args[1]); args[1] = parser.setPageParameter(ms, args[1], boundSql, page); page.setCountSignal(Boolean.FALSE); //æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢ Object result = invocation.proceed(); //å¾—åˆ°å¤„ç†ç»“æœ page.addAll((List) result); } } finally { ((PageSqlSource)ms.getSqlSource()).removeParser(); } //è¿”å›ç»“æœ return page; }</pre><p>æºç ä¸­æ³¨æ„å…³é”®çš„å››ç‚¹å³å¯ï¼š</p><p>1ã€msCountMap.put(ms.getId(), MSUtils.newCountMappedStatement(ms))ï¼Œåˆ›å»ºcountæŸ¥è¯¢çš„MappedStatementå¯¹è±¡ï¼Œå¹¶ç¼“å­˜äºmsCountMapã€‚</p><p>2ã€å¦‚æœcount=trueï¼Œåˆ™æ‰§è¡ŒcountæŸ¥è¯¢ï¼Œç»“æœtotalå€¼ä¿å­˜äºpageå¯¹è±¡ä¸­ï¼Œç»§ç»­æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢ã€‚</p><p>3ã€æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢ï¼Œå°†æŸ¥è¯¢ç»“æœä¿å­˜äºpageå¯¹è±¡ä¸­ï¼Œpageæ˜¯ä¸€ä¸ªArrayListå¯¹è±¡ã€‚</p><p>4ã€args[2] = RowBounds.DEFAULTï¼Œæ”¹å˜MybatisåŸæœ‰åˆ†é¡µè¡Œä¸ºï¼›</p><p>args[1] = parser.setPageParameter(ms, args[1], boundSql, page)ï¼Œæ”¹å˜åŸæœ‰å‚æ•°åˆ—è¡¨ï¼ˆå¢åŠ åˆ†é¡µå‚æ•°ï¼‰ã€‚</p><p>6. PageHelperçš„ä¸¤ç§ä½¿ç”¨æ–¹å¼</p><p><br></p><div class=pgc-img><img alt=PageHelperåˆ†é¡µæ’ä»¶æºç åŠåŸç†å‰–æ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/48f79ebb-7d32-4f43-8b94-d2a9aec3d6d0><p class=pgc-img-caption></p></div><p><br></p><p>ç¬¬ä¸€ç§ã€ç›´æ¥é€šè¿‡RowBoundså‚æ•°å®Œæˆåˆ†é¡µæŸ¥è¯¢ ã€‚</p><pre>List&lt;Student&gt; list = studentMapper.find(new RowBounds(0, 10));Page page = ((Page) list;</pre><p>ç¬¬äºŒç§ã€PageHelper.startPage()é™æ€æ–¹æ³•</p><pre>//è·å–ç¬¬1é¡µï¼Œ10æ¡å†…å®¹ï¼Œé»˜è®¤æŸ¥è¯¢æ€»æ•°count PageHelper.startPage(1, 10);//ç´§è·Ÿç€çš„ç¬¬ä¸€ä¸ªselectæ–¹æ³•ä¼šè¢«åˆ†é¡µ List&lt;Country&gt; list = studentMapper.find(); Page page = ((Page) list;</pre><blockquote><p>æ³¨ï¼šè¿”å›ç»“æœlistï¼Œå·²ç»æ˜¯Pageå¯¹è±¡ï¼ŒPageå¯¹è±¡æ˜¯ä¸€ä¸ªArrayListã€‚</p></blockquote><p>åŸç†ï¼šä½¿ç”¨ThreadLocalæ¥ä¼ é€’å’Œä¿å­˜Pageå¯¹è±¡ï¼Œæ¯æ¬¡æŸ¥è¯¢ï¼Œéƒ½éœ€è¦å•ç‹¬è®¾ç½®PageHelper.startPage()æ–¹æ³•ã€‚</p><pre>public class SqlUtil implements Constant { private static final ThreadLocal&lt;Page&gt; LOCAL_PAGE = new ThreadLocal&lt;Page&gt;();}</pre><p>æœ¬æ–‡ä¸­ç»å¸¸æåˆ°çš„countæŸ¥è¯¢ï¼Œå…¶å®æ˜¯PageHelperå¸®åŠ©æˆ‘ä»¬ç”Ÿæˆçš„ä¸€ä¸ªMappedStatementå†…å­˜å¯¹è±¡ï¼Œå®ƒå¯ä»¥å…å»æˆ‘ä»¬åœ¨XXXMapper.xmlå†…å•ç‹¬å£°æ˜ä¸€ä¸ªsql countæŸ¥è¯¢ï¼Œæˆ‘ä»¬åªéœ€è¦å†™ä¸€ä¸ªsqlåˆ†é¡µä¸šåŠ¡æŸ¥è¯¢å³å¯ã€‚</p><p>PageHelperä½¿ç”¨å»ºè®®ï¼ˆæ€§èƒ½æœ€å¥½ï¼‰ï¼š</p><blockquote><p>1ã€æ˜ç¡®æŒ‡å®šdialectã€‚<br>2ã€æ˜ç¡®ç¼–å†™sqlåˆ†é¡µä¸šåŠ¡å’Œä¸å®ƒå¯¹åº”çš„countæŸ¥è¯¢ï¼Œåˆ«å›¾çœäº‹ã€‚</p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'æ’ä»¶','PageHelper','åˆ†é¡µ'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../cn/%E7%A7%91%E6%8A%80/c7685cf.html alt=ä¸€æ€’ä¹‹ä¸‹æˆ‘è‡ªå·±å†™äº†ä¸ªPageHelperåˆ†é¡µæ’ä»¶ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/50426602d0764e93a53961830b578346 style=border-radius:25px></a>
<a href=../../cn/%E7%A7%91%E6%8A%80/c7685cf.html title=ä¸€æ€’ä¹‹ä¸‹æˆ‘è‡ªå·±å†™äº†ä¸ªPageHelperåˆ†é¡µæ’ä»¶>ä¸€æ€’ä¹‹ä¸‹æˆ‘è‡ªå·±å†™äº†ä¸ªPageHelperåˆ†é¡µæ’ä»¶</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>