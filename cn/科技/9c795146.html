<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>这个列式数据库牛！20亿行的查询，1s完成 | 极客快訊</title><meta property="og:title" content="这个列式数据库牛！20亿行的查询，1s完成 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/SAOKE832lqYoIy"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9c795146.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9c795146.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9c795146.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9c795146.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9c795146.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9c795146.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9c795146.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9c795146.html><meta property="article:published_time" content="2020-11-14T21:01:59+08:00"><meta property="article:modified_time" content="2020-11-14T21:01:59+08:00"><meta name=Keywords content><meta name=description content="这个列式数据库牛！20亿行的查询，1s完成"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/9c795146.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>这个列式数据库牛！20亿行的查询，1s完成</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><strong>★★★</strong><strong class=highlight-text toutiao-origin=span>建议</strong><strong>星标</strong><strong class=highlight-text toutiao-origin=span>我们</strong><strong>★★★</strong></p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/SAOKE832lqYoIy><p>链接：juejin.im/post/6863283398727860238</p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/Ryxcguy98OEq9e><p><strong>2020年Java原创面试题库连载中</strong></p><p>【000期】Java最全面试题库思维导图</p><p>【001期】JavaSE面试题（一）：面向对象</p><p>【002期】JavaSE面试题（二）：基本数据类型与访问修饰符</p><p>【003期】JavaSE面试题（三）：JavaSE语法（1）</p><p>【004期】JavaSE面试题（四）：JavaSE语法（3）</p><p>【005期】JavaSE面试题（五）：String类</p><p>【006期】JavaSE面试题（六）：泛型</p><p>【007期】JavaSE面试题（七）：异常</p><p>【008期】JavaSE面试题（八）：集合之List</p><p>【009期】JavaSE面试题（九）：集合之Set</p><p>【010期】JavaSE面试题（十）：集合之Map</p><p>【011期】JavaSE面试题（十一）：多线程（1）</p><p>【012期】JavaSE面试题（十二）：多线程（2）</p><p>【013期】JavaSE面试题（十三）：多线程（3）</p><p>【014期】JavaSE面试题（十四）：基本IO流</p><p>【015期】JavaSE面试题（十五）：网络IO流</p><p>【016期】JavaSE面试题（十六）：反射</p><p>【017期】JavaSE面试题（十七）：JVM之内存模型</p><p>【018期】JavaSE面试题（十八）：JVM之垃圾回收</p><p>【020期】JavaSE系列面试题汇总（共18篇）</p><p>【019期】JavaWeb面试题（一）：JDBC</p><p>【021期】JavaWeb面试题（二）：HTTP协议</p><p>【022期】JavaWeb面试题（三）：Cookie和Session</p><p>【023期】JavaWeb面试题（四）：JSP</p><p>【024期】JavaWeb面试题（五）：Filter和Listener</p><p>【025期】Java工具面试题（一）：版本控制工具</p><p>【026期】Java工具面试题（二）：项目管理工具</p><p>【027期】Java设计模式面试题</p><p>【028期】JavaWeb系列面试题汇总（共10篇）</p><p>【029期】JavaEE面试题（一）Web应用服务器</p><p>【030期】JavaEE面试题（二）SpringMVC</p><p>【031期】JavaEE面试题（三）Spring（1）</p><p>【032期】JavaEE面试题（四）Spring（2）</p><p>【033期】JaveEE面试题（五）MyBatis</p><p>【034期】JavaEE面试题（六）Hibernate</p><p>【035期】JavaEE面试题（七）SpringBoot（1）</p><p>更多内容，点击上面蓝字查看</p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/Ryxcguy98OEq9e><p></p><h2 toutiao-origin=h2>一、ClickHouse 是什么？</h2><p></p><blockquote><p>ClickHouse：是一个用于联机分析(OLAP)的列式数据库管理系统(DBMS)</p></blockquote><p><strong>通过ClickHouse实践，完美的解决了MySQL查询瓶颈，</strong><strong>20亿行以下数据量级查询，90%都可以在1s内给到结果</strong><strong>，随着数据量增加，ClickHouse同样也支持集群，大家如果感兴趣，可以积极尝试</strong></p><p>我们首先理清一些基础概念</p><p>OLTP：是传统的关系型数据库，主要操作增删改查，强调事务一致性，比如银行系统、电商系统</p><p>OLAP：是仓库型数据库，主要是读取数据，做复杂数据分析，侧重技术决策支持，提供直观简单的结果</p><p>接着我们用图示，来理解一下<strong>列式数据库</strong>和<strong>行式数据库</strong>区别</p><p>在传统的行式数据库系统中（MySQL、Postgres和MS SQL Server），数据按如下顺序存储：</p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/SAOKE974xBxI2c><p>在列式数据库系统中（ClickHouse），数据按如下的顺序存储：</p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/SAOKE9d2Ebzyju><p>两者在存储方式上对比：</p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/SAOKHARExJpUni><p>以上是ClickHouse基本介绍，更多可以查阅官方手册</p><p></p><h2 toutiao-origin=h2><strong toutiao-origin=h2>二、业务问题</strong></h2><p>业务端现有存储在Mysql中，5000万数据量的大表及两个辅表，单次联表查询开销在3min+，执行效率极低。经过索引优化、水平分表、逻辑优化，成效较低，因此决定借助ClickHouse来解决此问题</p><p>最终通过优化，<strong>查询时间降低至1s内，查询效率提升200倍！</strong></p><p>希望通过本文，可以帮助大家快速掌握这一利器，并能在实践中少走弯路。</p><p></p><h2 toutiao-origin=h2><strong toutiao-origin=h2>三、ClickHouse实践</strong></h2><h2 toutiao-origin=h3><strong toutiao-origin=h2>1.Mac下的Clickhouse安装</strong></h2><p>我是通过docker安装，也可以下载CK编译安装，相对麻烦一些。</p><p>docker安装</p><p>https://blog.csdn.net/qq_24993831/article/details/103715194</p><p></p><h2 toutiao-origin=h3><strong toutiao-origin=h2>2.数据迁移：从Mysql到ClickHouse</strong></h2><p>ClickHouse支持Mysql大多数语法，迁移成本低，目前有五种迁移方案：</p><ul><li><p>create table engin mysql，映射方案数据还是在Mysql</p></li><li><p>insert into select from，先建表，在导入</p></li><li><p>create table as select from，建表同时导入</p></li><li><p>csv离线导入</p></li><li><p>streamsets</p></li></ul><p>选择第三种方案做数据迁移：</p><p><code>CREATE TABLE[IF NOT EXISTS][db.]table_name ENGINE=MergetreeAS SELECT*FROM mysql('host:port','db','database','user','password')</code></p><p></p><h2 toutiao-origin=h3><strong toutiao-origin=h2>3.性能测试对比</strong></h2><table><thead><tr><th>类型</th><th>数据量</th><th>表大小</th><th>查询速度</th></tr></thead><tbody><tr><td>MySQL</td><td>5000万</td><td>10G</td><td>205s</td></tr><tr><td>ClickHouse</td><td>5000万</td><td>600MB</td><td>1s内</td></tr></tbody></table><p></p><h2 toutiao-origin=h3><strong toutiao-origin=h2>4.数据同步方案</strong></h2><p><strong>临时表</strong></p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/SAOKHBM2PshZ9l><p>图片来源：携程 新建temp中间表，将Mysql数据全量同步到ClickHouse内temp表，再替换原ClickHouse中的表，适用数据量适度，增量和变量频繁的场景</p><p><strong>synch</strong></p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/SAOKHBe1R82ENH><p>开源的同步软件推荐：synch 原理是通过Mysql的binlog日志，获取sql语句，再通过消息队列消费task</p><p></p><h2 toutiao-origin=h3><strong toutiao-origin=h2>5.ClickHouse为什么快？</strong></h2><ul><li><p>只需要读取要计算的列数据，而非行式的整行数据读取，降低IO cost</p></li><li><p>同列同类型，有十倍压缩提升，进一步降低IO</p></li><li><p>clickhouse根据不同存储场景，做个性化搜索算法</p></li></ul><p></p><h2 toutiao-origin=h2><strong toutiao-origin=h2>四、遇到的坑</strong></h2><h2 toutiao-origin=h3><strong toutiao-origin=h2>1.ClickHouse与mysql数据类型差异性</strong></h2><p>用Mysql的语句查询，发现报错：</p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/SAOKHC4A0a4Fra><p><strong>解决方案</strong>：LEFT JOIN B b ON toUInt32(h.id) = toUInt32(ec.post_id)，中转一下，统一无符号类型关联</p><p></p><h2 toutiao-origin=h3><strong toutiao-origin=h2>2.删除或更新是异步执行，只保证最终一致性</strong></h2><p>查询CK手册发现，即便对数据一致性支持最好的Mergetree，也只是保证最终一致性：</p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/SAOKHCRCFK6HnL><p>如果对数据一致性要求较高，推荐大家做全量同步来解决</p><p></p><h2 toutiao-origin=h2><strong toutiao-origin=h2>五、总结</strong></h2><p>通过ClickHouse实践，完美的解决了Mysql查询瓶颈，20亿行以下数据量级查询，90%都可以在1s内给到结果，随着数据量增加，ClickHouse同样也支持集群，大家如果感兴趣，可以积极尝试 : )</p><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/R6Aez96HF10BZ3><pre><div><p>之前，给大家发过<strong class=highlight-text toutiao-origin=strong>三份Java</strong>面试宝典，这次新增了一份，目前总共是<strong class=highlight-text toutiao-origin=strong>四份</strong>面试宝典，相信在跳槽前一个月按照面试宝典准备准备，基本没大问题。</p><ul><li><p><strong class=highlight-text toutiao-origin=strong>《java面试宝典5.0》</strong><strong class=highlight-text toutiao-origin=span>(初中级)</strong></p></li><li><p><strong class=highlight-text toutiao-origin=strong>《350道Java面试题：整理自100+公司》</strong><strong class=highlight-text toutiao-origin=span>（中高级）</strong></p></li><li><p><strong class=highlight-text toutiao-origin=strong>《资深java面试宝典-视频版》</strong><strong class=highlight-text toutiao-origin=span>（资深）</strong></p></li><li><p><strong class=highlight-text toutiao-origin=strong>《Java[BAT]面试必备》</strong><strong class=highlight-text toutiao-origin=span>（资深）</strong></p></li></ul><p>分别适用于<strong class=highlight-text toutiao-origin=span>初中级，中高级</strong><strong class=highlight-text toutiao-origin=span>，</strong><strong class=highlight-text toutiao-origin=span>资深</strong><strong class=highlight-text toutiao-origin=span>级工程师</strong>的面试复习。</p><p>内容包含java基础、javaweb、mysql性能优化、JVM、锁、百万并发、消息队列，高性能缓存、反射、Spring全家桶原理、微服务、Zookeeper、数据结构、限流熔断降级等等。</p><div><div><div><div><div><div><div><img alt=这个列式数据库牛！20亿行的查询，1s完成 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RFppAnaHsaFKbv></div><div><p><strong class=highlight-text toutiao-origin=span>看到这里，证明有所收获</strong></p></div></div></div></div></div></div></div></div></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'列式','这个','数据库'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>