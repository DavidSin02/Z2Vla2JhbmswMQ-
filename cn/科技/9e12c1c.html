<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>åŸºäºnettyçš„æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»„ä»¶ | æå®¢å¿«è¨Š</title><meta property="og:title" content="åŸºäºnettyçš„æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»„ä»¶ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/986b490e49b842fabd62759b54ab934f"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9e12c1c.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9e12c1c.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9e12c1c.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9e12c1c.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9e12c1c.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9e12c1c.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9e12c1c.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9e12c1c.html><meta property="article:published_time" content="2020-10-29T20:59:18+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:18+08:00"><meta name=Keywords content><meta name=description content="åŸºäºnettyçš„æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»„ä»¶"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/9e12c1c.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>åŸºäºnettyçš„æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»„ä»¶</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><h1>1.ç®€ä»‹</h1><p>è¯¥ç»„ä»¶åŸºäºnetty3.6.3å®ç°ï¼Œå…·æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼šæ–‡ä»¶ä¸Šä¼ ï¼Œæ–‡ä»¶æ›¿æ¢ï¼Œæ–‡ä»¶åˆ é™¤ï¼Œå¦‚æœæ˜¯å›¾ç‰‡çš„è¯ï¼Œè¿˜å¯ä»¥ç”Ÿæˆç¼©ç•¥å›¾ç­‰åŠŸèƒ½ã€‚</p><p>ä½¿ç”¨ç®€å•ï¼Œåªéœ€è¦å¼•å…¥netty-file-clientï¼Œå³å¯ä»¥å®ç°æ–‡ä»¶çš„ä»¥ä¸Šæ“ä½œã€‚</p><p>è¯¥ç»„ä»¶çš„ä»£ç ç»“æ„åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå®¢æˆ·ç«¯ç»„ä»¶ï¼ˆnetty-flie-clientï¼‰å’ŒæœåŠ¡ç«¯ç»„ä»¶ï¼ˆnetty-flie-serverï¼‰ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt=åŸºäºnettyçš„æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»„ä»¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/986b490e49b842fabd62759b54ab934f><p class=pgc-img-caption></p></div><p>image.png</p><h1>2.netty-file-client</h1><p>2.1 æ¦‚è¿°</p><p>å®¢æˆ·ç«¯ç»„ä»¶ä¸»è¦æä¾›å¯¹å¤–è®¿é—®æœåŠ¡ç«¯ç»„ä»¶çš„æ¥å£ï¼Œæä¾›ä»¥ä¸‹æ¥å£ï¼šæ–‡ä»¶ä¸Šä¼ ï¼Œæ–‡ä»¶æ›¿æ¢ï¼Œæ–‡ä»¶åˆ é™¤ï¼Œå¦‚æœæ˜¯å›¾ç‰‡çš„è¯ï¼Œè¿˜å¯ä»¥ç”Ÿæˆç¼©ç•¥å›¾ç­‰åŠŸèƒ½ã€‚ä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><div class=pgc-img><img alt=åŸºäºnettyçš„æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»„ä»¶ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/31820a04299f48dface68444e3a9f776><p class=pgc-img-caption></p></div><p>org.lyx.file.clientåŒ…æ˜¯è¯¥ç»„ä»¶çš„æ ¸å¿ƒåŒ…ï¼ŒFileClientç±»æ˜¯å¯¹å¤–æä¾›æ¥å£çš„å·¥å…·ç±»ã€‚å…·æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š</p><ol><li>uploadFile æ–‡ä»¶ä¸Šä¼ ï¼Œå¯¹åº”æ–‡ä»¶å¤„ç†å¥æŸ„ç±»ä¸ºï¼šUploadFileClientHandler</li><li>deleteFile åˆ é™¤æœåŠ¡ç«¯æ–‡ä»¶ï¼Œå¯¹åº”æ–‡ä»¶å¤„ç†å¥æŸ„ç±»ä¸ºï¼šDeleteFileClientHandler</li><li>replaceFile æ›¿æ¢æœåŠ¡ç«¯æ–‡ä»¶ï¼Œå¯¹åº”æ–‡ä»¶å¤„ç†å¥æŸ„ç±»ä¸ºï¼šReplaceFileClientHandler</li><li>createThumbPicture ç”Ÿæˆç¼©ç•¥å›¾ï¼Œå¯¹åº”æ–‡ä»¶å¤„ç†å¥æŸ„ç±»ä¸ºï¼šCreateThumbPictureClientHandler</li></ol><p>ä»¥ä¸Šæ‰€æœ‰å¥æŸ„ç±»çš„çˆ¶ç±»å‡ä¸ºUploadFileClientHandlerï¼Œè¯¥ç±»å®ç°äº†ä¸€äº›å…±æœ‰æ–¹æ³•ï¼Œæ¯”å¦‚ä¸€äº›å…¬å…±å‚æ•°çš„åŒ…è£…ç­‰ã€‚</p><p>2.2 å®ç°æ­¥éª¤</p><p>å®ç°æ­¥éª¤ä»¥ä¸Šä¼ æ–‡ä»¶ä¸ºä¾‹ï¼Œå…¶ä»–ç±»ä¼¼å®ç°ã€‚</p><p>ç›´æ¥ä¸Šä»£ç ï¼š</p><pre>/** * æ–‡ä»¶ä¸Šä¼  * @param file éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ * @param fileName æ–‡ä»¶åç§° * @param thumbMark æ˜¯å¦éœ€è¦ç”Ÿæˆç¼©ç•¥å›¾ * @return * @author:landyChris */ public static String uploadFile(File file, String fileName, boolean thumbMark) { FileClientPipelineFactory clientPipelineFactory = new FileClientPipelineFactory(); //è¾…åŠ©ç±»ã€‚ç”¨äºå¸®åŠ©æˆ‘ä»¬åˆ›å»ºNETTYæœåŠ¡ ClientBootstrap bootstrap = createClientBootstrap(clientPipelineFactory); String strThumbMark = Constants.THUMB_MARK_NO; if (thumbMark) { strThumbMark = Constants.THUMB_MARK_YES; } //å…·ä½“å¤„ç†ä¸Šä¼ æ–‡ä»¶é€»è¾‘ uploadFile(bootstrap, FileClientContainer.getHost(), FileClientContainer.getPort(), file, fileName, strThumbMark, FileClientContainer.getUserName(), FileClientContainer.getPassword()); Result result = clientPipelineFactory.getResult(); if ((result != null) &amp;&amp; (result.isCode())) { return result.getFilePath(); } return null; }</pre><p>å…·æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œå‰é¢å‡ è¡Œä»£ç éƒ½æ˜¯å¾ˆä¸€äº›nettyçš„åˆå§‹åŒ–å·¥ä½œï¼Œå…·ä½“çœ‹ä¸€ä¸ªç§æœ‰æ–¹æ³•uploadFileï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><p>private static void uploadFile(ClientBootstrap bootstrap, String host,</p><p>int port, File file, String fileName, String thumbMark,</p><p>String userName, String pwd) {</p><p>//1.æ„å»ºuriå¯¹è±¡</p><p>URI uri = getUri(host, port);</p><p>//2.è¿æ¥nettyæœåŠ¡ç«¯</p><p>ChannelFuture future = bootstrap.connect(new InetSocketAddress(host,</p><p>port));</p><p>//3.å¼‚æ­¥è·å–Channelå¯¹è±¡</p><p>Channel channel = future.awaitUninterruptibly().getChannel();</p><p>if (!future.isSuccess()) {</p><p>future.getCause().printStackTrace();</p><p>bootstrap.releaseExternalResources();</p><p>return;</p><p>}</p><p>//4.åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ å¥æŸ„å¯¹è±¡</p><p>WrapFileClientHandler handler = new UploadFileClientHandler(host, uri,</p><p>file, fileName, thumbMark, userName, pwd);</p><p>//5.è·å–Requestå¯¹è±¡</p><p>HttpRequest request = handler.getRequest();</p><p>//6.è·å–Httpæ•°æ®å¤„ç†å·¥å‚</p><p>HttpDataFactory factory = getHttpDataFactory();</p><p>//7.è¿›è¡Œæ•°æ®çš„åŒ…è£…å¤„ç†ï¼Œä¸»è¦æ˜¯è¿›è¡Œä¸Šä¼ æ–‡ä»¶æ‰€éœ€è¦çš„å‚æ•°çš„è®¾ç½®ï¼Œæ­¤æ—¶è°ƒç”¨çš„å¥æŸ„æ˜¯å…·ä½“çš„UploadFileClientHandlerå¯¹è±¡</p><p>HttpPostRequestEncoder bodyRequestEncoder = handler</p><p>.wrapRequestData(factory);</p><p>//8.æŠŠrequestå†™åˆ°ç®¡é“ä¸­ï¼Œä¼ è¾“ç»™æœåŠ¡ç«¯</p><p>channel.write(request);</p><p>//9.åšä¸€äº›å…³é—­èµ„æºçš„åŠ¨ä½œ</p><p>if (bodyRequestEncoder.isChunked()) {</p><p>channel.write(bodyRequestEncoder).awaitUninterruptibly();</p><p>}</p><p>bodyRequestEncoder.cleanFiles();</p><p>channel.getCloseFuture().awaitUninterruptibly();</p><p>bootstrap.releaseExternalResources();</p><p>factory.cleanAllHttpDatas();</p><p>}</p><p>ä¸»è¦æœ‰ä»¥ä¸‹å®ç°æ­¥éª¤ï¼š</p><ol><li>æ„å»ºuriå¯¹è±¡</li><li>è¿æ¥nettyæœåŠ¡ç«¯</li><li>å¼‚æ­¥è·å–Channelå¯¹è±¡</li><li>åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ å¥æŸ„å¯¹è±¡</li><li>è·å–Requestå¯¹è±¡</li><li>è·å–Httpæ•°æ®å¤„ç†å·¥å‚</li><li>è¿›è¡Œæ•°æ®çš„åŒ…è£…å¤„ç†ï¼Œä¸»è¦æ˜¯è¿›è¡Œä¸Šä¼ æ–‡ä»¶æ‰€éœ€è¦çš„å‚æ•°çš„è®¾ç½®ï¼Œæ­¤æ—¶è°ƒç”¨çš„å¥æŸ„æ˜¯å…·ä½“çš„UploadFileClientHandlerå¯¹è±¡</li><li>æŠŠrequestå†™åˆ°ç®¡é“ä¸­ï¼Œä¼ è¾“ç»™æœåŠ¡ç«¯</li><li>åšä¸€äº›å…³é—­èµ„æºçš„åŠ¨ä½œ</li><li>å…·ä½“ç»†èŠ‚å®ç°è¯·å‚è€ƒgithubä¸Šçš„ä»£ç ã€‚å¦‚æœå„ä½è¯»è€…å–œæ¬¢çš„è¯ï¼Œå¯ä»¥åŠ ä¸ªstarå“ˆã€‚</li></ol><h1>3.netty-file-server</h1><p>3.1 æ¦‚è¿°</p><p>æœåŠ¡ç«¯ç»„ä»¶å®ç°åŠŸèƒ½ä¹Ÿæ˜¯è·Ÿå®¢æˆ·ç«¯ä¸€è‡´ï¼Œå…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼šæ–‡ä»¶ä¸Šä¼ ï¼Œæ–‡ä»¶æ›¿æ¢ï¼Œæ–‡ä»¶åˆ é™¤ï¼Œå¦‚æœæ˜¯å›¾ç‰‡çš„è¯ï¼Œè¿˜å¯ä»¥ç”Ÿæˆç¼©ç•¥å›¾ç­‰åŠŸèƒ½ã€‚ä»£ç ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=pgc-img><img alt=åŸºäºnettyçš„æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»„ä»¶ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b16d19b7ee9b4b6da368197f71a88e9c><p class=pgc-img-caption></p></div><p>org.lyx.file.serveråŒ…æ˜¯è¯¥ç»„ä»¶çš„æ ¸å¿ƒåŒ…ã€‚å…·ä½“çš„å¤„ç†å¥æŸ„ç±»æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</p><ol><li>æ–‡ä»¶ä¸Šä¼ ï¼šUploadFileServerHandler</li><li>åˆ é™¤æ–‡ä»¶ï¼šDeleteFileServerHandler</li><li>æ›¿æ¢æ–‡ä»¶ï¼šReplaceFileServerHandler</li><li>ç”Ÿæˆç¼©ç•¥å›¾ï¼šCreateThumbPictureServerHandler</li></ol><p>ä»¥ä¸Šæ‰€ä»¥å¥æŸ„ç±»çš„æ¥å£å‡ä¸ºFileServerProcessorï¼Œå¹¶ä¸”ç»§æ‰¿äº†æŠ½è±¡ç±»AbstractFileServerHandlerã€‚</p><p>3.2 å®ç°æ­¥éª¤</p><p>å…·ä½“å®ç°æ­¥éª¤è¿˜æ˜¯ä»¥æ–‡ä»¶ä¸Šä¼ ä¸ºä¾‹ã€‚</p><p>é¦–å…ˆorg.lyx.file.server.support.FileServerHandlerç±»ä¼šæŒç»­ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¦‚æœæ˜¯æ–‡ä»¶å¤„ç†åŠ¨ä½œï¼Œåˆ™ä¼šè¿›å…¥messageReceivedæ–¹æ³•è¿›è¡Œç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚è¯¥ç±»å®šä¹‰äº†ä»¥ä¸‹æˆå‘˜å˜é‡ï¼š</p><pre>//httpè¯·æ±‚ private HttpRequest request; //æ˜¯å¦éœ€è¦æ–­ç‚¹ç»­ä¼ ä½œä¸š private boolean readingChunks; //æ¥æ”¶åˆ°çš„æ–‡ä»¶å†…å®¹ private final StringBuffer responseContent = new StringBuffer(); //è§£ææ”¶åˆ°çš„æ–‡ä»¶ private static final HttpDataFactory factory = new DefaultHttpDataFactory(DefaultHttpDataFactory.MINSIZE); //16384L //postè¯·æ±‚çš„è§£ç ç±»,å®ƒè´Ÿè´£æŠŠå­—èŠ‚è§£ç æˆHttpè¯·æ±‚ã€‚ private HttpPostRequestDecoder decoder; //è¯·æ±‚å‚æ•° private RequestParam requestParams = new RequestParam();</pre><p>è¯¥æ–¹æ³•å®ç°ä¸­ï¼Œå¦‚æœæ–‡ä»¶å¤§å°å°äºchunkedçš„æœ€å°å€¼ï¼Œåˆ™ç›´æ¥è¿›è¡Œæ–‡ä»¶ä¸Šä¼ æ“ä½œã€‚å¦åˆ™ï¼Œéœ€è¦è¿›è¡Œåˆ†å—å¤„ç†ã€‚ç„¶åè¿›è¡Œæ–‡ä»¶ä¸Šä¼ æ“ä½œã€‚</p><p>æ–‡ä»¶å¤§å°å°äº1kçš„æ“ä½œï¼š</p><div class=pgc-img><img alt=åŸºäºnettyçš„æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»„ä»¶ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c0921035faf24afa829c971b43866277><p class=pgc-img-caption></p></div><p>éœ€è¦åˆ†å—å¤„ç†æ“ä½œï¼š</p><div class=pgc-img><img alt=åŸºäºnettyçš„æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»„ä»¶ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/42fa6426001145a1b274ab28ca00389f><p class=pgc-img-caption></p></div><p>ä»¥ä¸Šæ“ä½œä¸»è¦æœ‰ä¸¤ä¸ªæ³¨æ„ç‚¹ï¼š</p><ol><li>è¯·æ±‚å‚æ•°çš„è§£æå·¥ä½œï¼ˆæ ¹æ®HttpDataTypeè¿›è¡Œç›¸åº”å‚æ•°çš„èµ‹å€¼æ“ä½œï¼‰</li><li>æ ¹æ®è§£æçš„å‚æ•°è¿›è¡Œç›¸åº”çš„æ–‡ä»¶å¤„ç†æ“ä½œï¼ˆæ ¹æ®æ–‡ä»¶æ“ä½œç±»å‹ï¼Œé€‰æ‹©ç›¸åº”çš„å¤„ç†å¥æŸ„è¿›è¡Œæ–‡ä»¶å¤„ç†ï¼‰</li></ol></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'netty','ä¼ ä¸‹è½½','ç»„ä»¶'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>