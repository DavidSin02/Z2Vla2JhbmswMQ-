<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>「C语言笔记」assert怎么用？ | 极客快訊</title><meta property="og:title" content="「C语言笔记」assert怎么用？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/0816bedea8784129bb9a4b65f01dc337"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a0e9a5a9.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a0e9a5a9.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a0e9a5a9.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a0e9a5a9.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a0e9a5a9.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a0e9a5a9.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a0e9a5a9.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a0e9a5a9.html><meta property="article:published_time" content="2020-11-14T21:03:15+08:00"><meta property="article:modified_time" content="2020-11-14T21:03:15+08:00"><meta name=Keywords content><meta name=description content="「C语言笔记」assert怎么用？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/a0e9a5a9.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>「C语言笔记」assert怎么用？</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class="md-end-block md-heading">一、什么是assert()？</h1><p>编写代码时，我们总是会做出一些假设，断言（assert）就是用于在代码中捕捉这些假设，可以将断言看作是异常处理的一种高级形式。</p><p>断言表示为一些布尔表达式，程序员相信在程序中的某个特定点该表达式值为真。可以在任何时候启用和禁用断言验证，因此可以在测试时启用断言，而在部署时禁用断言。同样，程序投入运行后，最终用户在遇到问题时可以重新启用断言。</p><blockquote><p>注意assert()是一个宏，而不是函数。</p></blockquote><h1 class="md-end-block md-heading">二、assert怎么用？</h1><h2 class="md-end-block md-heading">1、assert所在的头文件及原型</h2><p>在MinGW工具中，assert()宏在存在于头文件assert.h中，其关键内容如下：</p><pre><code>#ifdef NDEBUG#define assert(x)	((void)0)#else /* debugging enabled */_CRTIMP void __cdecl __MINGW_NOTHROW _assert (const char*, const char*, int) __MINGW_ATTRIB_NORETURN;#define assert(e)       ((e) ? (void)0 : _assert(#e, __FILE__, __LINE__))#endif	/* NDEBUG */</code></pre><p>assert()宏接受一个整形表达式参数。如果表达式的值为假，assert()宏就会调用_assert函数在标准错误流中打印一条错误信息，并调用abort()（abort()函数的原型在stdlib.h头文件中）函数终止程序。</p><p>当我们认为已经排除了程序的bug时，就可以把宏定义#define NDEBUG写在包含assert.h位置前面。</p><p>小知识：</p><ul class=ul-list><li>__cdecl是C Declaration的缩写（declaration，声明），表示C语言默认的函数调用方法：所有参数从右到左依次入栈。</li><li>_CRTIMP是C run time implement的简写，C运行库的实现的意思。作为用户代码，不应该使用这个东西。提示是使用dll的动态 C 运行时库还是静态连接的 C 运行库的一个宏。</li></ul><pre><code>#ifndef _CRTIMP#ifdef _DLL#define _CRTIMP __declspec(dllimport)#else /* ndef _DLL */#define _CRTIMP#endif /* _DLL */#endif /* _CRTIMP */</code></pre><ul class=ul-list><li>__MINGW_NOTHROW与__MINGW_ATTRIB_NORETURN是异常处理相关标识</li></ul><p>这几个标识符在C语言标准库文件中都有用得到，但是我们不需要关心，在我们用户的角度来看，以上函数原型我们看成：void _assert(const char*, const char*, int)；即可。</p><h2 class="md-end-block md-heading">2、assert应用</h2><p>assert主要用于类型检查及单元测试中。</p><blockquote><p>单元测试（unit testing），是指对软件中的最小可测试单元进行检查和验证。对於单元测试中单元的含义，一般来说，要根据实际情况去判定其具体含义，如C语言中单元指一个函数。</p></blockquote><p><strong>（1）例子一：除法运算</strong></p><pre><code>/*编译工具：mingw32  gcc6.3.0*/#include &lt;stdio.h&gt;#include &lt;assert.h&gt;	int main(void){	int a, b, c;	printf("请输入b, c的值：");	scanf("%d %d", &amp;b, &amp;c);	a = b / c;	printf("a = %d", a);	return 0;}</code></pre><p>此处，变量c作为分母是不能等于0，如果我们输入2 0，结果是什么呢？结果是程序会蹦：</p><div class=pgc-img><img alt=「C语言笔记」assert怎么用？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0816bedea8784129bb9a4b65f01dc337><p class=pgc-img-caption></p></div><p>这个例子中只有几行代码，我们很快就可以找到程序蹦的原因就是变量c的值为0。但是，如果代码量很大，我们还能这么快的找到问题点吗？</p><p>这时候，assert()就派上用场了，以上代码中，我们可以在a = b / c;这句代码之前加上assert(c);这句代码用来判断变量c的有效性。此时，再编译运行，得到的结果为：</p><div class=pgc-img><img alt=「C语言笔记」assert怎么用？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/aca4e3244b1c42609e66cc1bfa4fbcab><p class=pgc-img-caption></p></div><p>可见，程序蹦的同时还会在标准错误流中打印一条错误信息：</p><blockquote><p>Assertion failed：c, file hello.c, line 12</p></blockquote><p>这条信息包含了一些对我们查找bug很有帮助的信息：问题出在变量c，在hello.c文件的第12行。这么一来，我们就可以迅速的定位到问题点了。</p><p>这时候细心的朋友会发现，上边我们对assert()的介绍中，有这么一句说明：<strong>如果表达式的值为假，assert()宏就会调用_assert函数在标准错误流中打印一条错误信息，并调用abort()（abort()函数的原型在stdlib.h头文件中）函数终止程序。</strong></p><p>所以，针对我们这个例子，我们的assert()宏我们也可以用以下代码来代替：</p><pre><code>if (0 == c){	puts("c的值不能为0，请重新输入！");	abort();}</code></pre><p>这样，也可以给我们起到提示的作用：</p><div class=pgc-img><img alt=「C语言笔记」assert怎么用？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/615c6443ef4c4d1d979087a5087f68eb><p class=pgc-img-caption></p></div><p>但是，使用assert()至少有几个好处：</p><p>1）能自动标识文件和出问题的行号。</p><p>2）无需要更改代码就能开启或关闭assert机制(开不开启关系到程序大小的问题)。如果认为已经排除了程序的bug，就可以把下面的宏定义写在包含assert.h的位置的前面：</p><pre><code>#define NDEBUG</code></pre><p>并重新编译程序，这样编辑器就会禁用工程文件中所有的assert()语句。如果程序又出现问题，可以移除这条#define指令（或把它注释掉），然后重新编译程序，这样就可以重新启用了assert()语句。</p><p><strong>（2）例子二：STM32库函数</strong></p><p>我们来看我们比较熟悉的GPIO初始化函数：</p><div class=pgc-img><img alt=「C语言笔记」assert怎么用？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/08f218c4be784699b6b5cc093911ea03><p class=pgc-img-caption></p></div><p>可见，该函数的实现中，有三条assert_param()这样的语句，其作用就是对一些函数入口参数进行一些有效性检查。其实assert_param()这就类似与我们C标准库中的assert()。针对stm32f10x系列来说，其被定义在文件stm32f10x_conf.h中：</p><div class=pgc-img><img alt=「C语言笔记」assert怎么用？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2bbff64405c7493caf56f4429f4b3197><p class=pgc-img-caption></p></div><p>这是一个例子，除了GPIO初始化函数之外，STM32固件库函数中的其他函数都是会做这样的参数检查。</p><h1 class="md-end-block md-heading">三、assert与if的比较？</h1><p>assert()断言功能好像用if也能实现，仔细一看这两者还是有区别。下面看一下它们的区别：</p><p>先看一个例子，我们使用malloc函数定义一个存着堆空间中的变量，我们该怎么定义及该怎么做一些防御处理呢？</p><p>首先，我们要知道，malloc函数如果分配成功内存则返回指向被分配内存的指针(此存储区中的初始值不确定)，否则返回空指针NULL。看如下代码：</p><pre><code>int* p = (int*)malloc(sizeof(int))；assert(p);		/* 错误示例 */</code></pre><p>这么写会有问题吗？</p><p>看似没问题，但是问题很大！我们的assert()会在我们调试完毕之后禁用掉，这么一来以上代码就相当于只有下面这一句了：</p><pre><code>int* p = (int*)malloc(sizeof(int))；</code></pre><p>此时，当我们的程序在跑的时候malloc申请不到内存空间了，也没有做一些解决措施，可能就会产生致命错误。</p><p>我们应该把以上代码改写为：</p><pre><code>int* p = (int*)malloc(sizeof(int))；if (NULL == p) /*请使用if来判断,这是有必要的*/{    /* 做一些处理 */}</code></pre><p><br></p><p>下面看一下assert与if做防错处理的几点用法区别：</p><p>1、assert语句用在debug版本的调试中；if(NULL!=p)是在release版本中检验指针的有效性；</p><p>2、assert一般用与检查函数参数的合法性（有效性）而不是正确性，但是合法的程序并不见得是程序逻辑正确的程序，该用if做判断处理的地方还是得做处理。</p><p>也就是assert在调试期间用来检查一些不允许出现的情况是否有发生，一旦发生就表明我们的程序很可能有BUG，而if判断的就是我们理所应当处理的各种情况，且这些情况如果发生并不代表程序发生BUG。</p><p><br></p><h1 class="md-end-block md-heading">四、_Static_assert(C11标准)</h1><p>assert()是在运行时进行检查的，如果一份工程很大，编译起来需要很长时间，一些情况在运行时检查，效率就比较低了。</p><p>这时候_Static_assert()就派上用场了，这是C11标准中的一个特性，_Static_assert()在编译时进行检查，如果编译时检测到代码里的一些异常情况，就会导致程序无法通过编译。下面来看一个例子：</p><pre><code>/*编译环境：mingw32  gcc6.3.0编译命令：gcc -std=c11 hello.c -o hello.exe*/#include &lt;stdio.h&gt;#include &lt;limits.h&gt;  /*CHAR_BIT是limits.h中的一个宏*/_Static_assert(CHAR_BIT == 16, "16-bit char falsely assumed");	int main(void){	printf("欢迎关注嵌入式大杂烩！查看更多笔记\n");	return 0;}</code></pre><p>_Static_assert接受两个参数，第一个参数是整型常量表达式，第二个参数是一个字符串。如果第一个表达式为0，编译时就会输出第二个参数的字符串，而且编译不通过。</p><p>该程序编译结果如下：</p><div class=pgc-img><img alt=「C语言笔记」assert怎么用？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0286d95c788748be9697ece36164bb74><p class=pgc-img-caption></p></div><p>可见，编译报错了，并且打印提示了我们的问题所在点，打印出了我们_Static_assert第二个参数的字符串，这样我们就可以很快地定位到导致编译错误的问题了。</p><p>以上就是关于assert()断言宏的一些总结笔记，如有错误欢迎指出！</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'语言','笔记','assert'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>