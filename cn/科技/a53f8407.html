<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码） | 极客快訊</title><meta property="og:title" content="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/b5a702c9ea2b45508ec96155ee411b5a"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a53f8407.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a53f8407.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a53f8407.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a53f8407.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a53f8407.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a53f8407.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a53f8407.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a53f8407.html><meta property="article:published_time" content="2020-11-14T21:00:09+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:09+08:00"><meta name=Keywords content><meta name=description content="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/a53f8407.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><blockquote><p>我们在做小程序开发时，消息推送是不可避免的。今天就来教大家如何实现小程序消息推送的后台和前台开发。源码会在文章末尾贴出来。</p></blockquote><p>其实我之前有写过一篇：《springboot实现微信消息推送，java实现小程序推送，含小程序端实现代码》 但是有同学反应这篇文章里的代码太繁琐，接入也比较麻烦。今天就来给大家写个精简版的，基本上只需要几行代码，就能实现小<span>程序模版</span>消息推送功能。</p><p>老规矩先看效果图</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b5a702c9ea2b45508ec96155ee411b5a><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>这是我们最终推送给用户的模版消息。这是用户手机微信上显示的推送消息截图。</p><h1><strong>本节知识点</strong></h1><p>1，java开发推送后台</p><p>2，springboot实现推送功能</p><p>3，小程序获取用户openid</p><p>4，小程序获取fromid用来推送</p><h1><strong>先来看后台推送功能的实现</strong></h1><p>只有下面一个简单的PushController类，就可以实现小程序消息的推送</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0782abb3219a421ea0c228551953576d><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>再来看下PushController类，你没看错，实现小程序消息推送，就需要下面这几行代码就可以实现了。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/137a522334ac4df8b1cf1bb3baf59da0><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>由于本推送代码是用springboot来实现的，下面就来简单的讲下。我我们需要注意的几点内容。</p><p>1，需要在pom.xml引入一个三方类库（推送的三方类库）</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8c196a8a96fa4663be42c8753ee9b4d6><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>pom.xml的完整代码如下</p><pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.1.5.RELEASE&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;groupId&gt;com.qcl&lt;/groupId&gt; &lt;artifactId&gt;wxapppush&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;wxapppush&lt;/name&gt; &lt;description&gt;Demo project for Spring Boot&lt;/description&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;!--微信小程序模版推送--&gt; &lt;dependency&gt; &lt;groupId&gt;com.github.binarywang&lt;/groupId&gt; &lt;artifactId&gt;weixin-java-miniapp&lt;/artifactId&gt; &lt;version&gt;3.4.0&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt;</pre><p>其实到这里我们java后台的推送功能，就已经实现了。我们只需要运行springboot项目，就可以实现推送了。</p><p>下面贴出完整的PushController.java类。里面注释很详细了。</p><pre>package com.qcl.wxapppush;import org.springframework.web.bind.annotation.GetMapping;import org.springframework.web.bind.annotation.RequestParam;import org.springframework.web.bind.annotation.RestController;import java.util.ArrayList;import java.util.List;import cn.binarywang.wx.miniapp.api.WxMaService;import cn.binarywang.wx.miniapp.api.impl.WxMaServiceImpl;import cn.binarywang.wx.miniapp.bean.WxMaTemplateData;import cn.binarywang.wx.miniapp.bean.WxMaTemplateMessage;import cn.binarywang.wx.miniapp.config.WxMaInMemoryConfig;import me.chanjar.weixin.common.error.WxErrorException;/** * Created by qcl on 2019-05-20 * ：2501902696 * desc: 微信小程序模版推送实现 */@RestControllerpublic class PushController { @GetMapping("/push") public String push(@RequestParam String openid, @RequestParam String formid) { //1,配置小程序信息 WxMaInMemoryConfig wxConfig = new WxMaInMemoryConfig(); wxConfig.setAppid("wx7c54942dfc87f4d8");//小程序appid wxConfig.setSecret("5873a729c365b65ab42bb5fc82d2ed49");//小程序AppSecret WxMaService wxMaService = new WxMaServiceImpl(); wxMaService.setWxMaConfig(wxConfig); //2,设置模版信息（keyword1：类型，keyword2：内容） List&lt;WxMaTemplateData&gt; templateDataList = new ArrayList&lt;&gt;(2); WxMaTemplateData data1 = new WxMaTemplateData("keyword1", "获取老师微信"); WxMaTemplateData data2 = new WxMaTemplateData("keyword2", "2501902696"); templateDataList.add(data1); templateDataList.add(data2); //3，设置推送消息 WxMaTemplateMessage templateMessage = WxMaTemplateMessage.builder() .toUser(openid)//要推送的用户openid .formId(formid)//收集到的formid .templateId("eDZCu__qIz64Xx19dAoKg0Taf5AAoDmhUHprF6CAd4A")//推送的模版id（在小程序后台设置） .data(templateDataList)//模版信息 .page("pages/index/index")//要跳转到小程序那个页面 .build(); //4，发起推送 try { wxMaService.getMsgService().sendTemplateMsg(templateMessage); } catch (WxErrorException e) { System.out.println("推送失败：" + e.getMessage()); return e.getMessage(); } return "推送成功"; }}</pre><p>看代码我们可以知道，我们需要做一些配置，需要下面信息</p><p>1，小程序appid</p><p>2，小程序AppSecret（密匙）</p><p>3，小程序推送模版id</p><p>4，用户的openid</p><p>5，用户的formid（一个formid只能用一次）</p><h1><strong>下面就是小程序部分，来教大家如何获取上面所需的5个信息。</strong></h1><p>1,appid和AppSecret的获取（登录小程序管理后台）</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2038a3446ff942aabcab86c41797cd26><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>2，推送模版id</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fca49e78e36f4992bc3b0fbd5f02920f><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>3，用户openid的获取，可以看下面的这篇文章，也可以看源码，这里不做具体讲解</p><p>小程序开发如何获取用户openid</p><p>4，获取formid</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/410df3a76a10400ab5cbf44de4db3782><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>看官方文档，可以知道我们的formid有效期是7天，并且一个form_id只能使用一次，所以我们小程序端所需要做的就是尽可能的多拿些formid，然后传个后台，让后台存到数据库中，这样7天有效期内，想怎么用就怎么用了。<strong>所以接下来要讲的就是小程序开发怎么尽可能多的拿到formid了</strong></p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7ba2a7a5c45e4906849118e55fa80a75><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>看下官方提供的，只有在表单提交时把report-submit设为true时才能拿到formid，比如这样</p><pre> &lt;form report-submit='true' &gt; &lt;button form-type='submit'&gt;获取formid&lt;/button&gt; &lt;/form&gt;</pre><p>所以我们就要在这里下功夫了，既然只能在form组件获取，我们能不能把我们小程序里用到最多的地方用form来伪装呢。</p><p><strong>下面简单写个获取formid和openid的完整示例，方便大家学习</strong></p><p>效果图</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/caa24ab463e7400cb4c762496b54cc15><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>我们要做的就是点击获取formid按钮，可以获取到用户的formid和openid，正常我们开发时，是需要把openid和formid传给后台的，这里简单起见，我们直接用获取到的formid和openid实现推送功能</p><p><strong>下面来看小程序端的实现代码</strong></p><p>1,index.wxml</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fb23b90cf41d46bbaf4e12b37b6604aa><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>2,index.js</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8b0a9a2eec504773bfbd647c5fa1f0fe><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>到这里我们小程序端的代码也实现了，接下来测试下推送。</p><pre>formid: 6ee9ce80c1ed4a2f887fccddf87686ebopenid o3DoL0Uusu1URBJK0NJ4jD1LrRe0</pre><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f283d491d7974f769223b996b79f6bca><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>可以看到我们用了上面获取到的openid和formid做了一次推送，显示推送成功</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/23848335ddee493a8df9820945033aec><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center><br></p><div class=pgc-img><img alt="5行代码实现微信小程序模版消息推送 （含推送后台和小程序源码）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5da74db929a246ec8cd2ea54f2aff186><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>到这里我们小程序消息推送的后台和小程序端都讲完了。</p><p><strong>这里有两点需要大家注意</strong></p><p>1，推送的openid和formid必须对应。</p><p>2，一个formid只能用一次，多次使用会报一下错误。</p><pre>{"errcode":41029,"errmsg":"form id used count reach limit hint: [ssun8a09984113]"}</pre><blockquote><p>编程小石头，码农一枚，非著名全栈开发人员。分享自己的一些经验，学习心得，希望后来人少走弯路，少填坑。</p></blockquote><p>这里就不单独贴出源码下载链接了，大家感兴趣的话，可以私信我，或者在底部留言,我会把源码下载链接贴在留言区。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'推送','程序','行代码'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>