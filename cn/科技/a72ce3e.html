<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>为了30分钟配送，盒马工程师都有哪些“神操作”？ | 极客快訊</title><meta property="og:title" content="为了30分钟配送，盒马工程师都有哪些“神操作”？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/46b73fe7999d4ede9e16ea84933c4eac"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a72ce3e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a72ce3e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a72ce3e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a72ce3e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a72ce3e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a72ce3e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a72ce3e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a72ce3e.html><meta property="article:published_time" content="2020-10-29T20:52:48+08:00"><meta property="article:modified_time" content="2020-10-29T20:52:48+08:00"><meta name=Keywords content><meta name=description content="为了30分钟配送，盒马工程师都有哪些“神操作”？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/a72ce3e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>为了30分钟配送，盒马工程师都有哪些“神操作”？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p class=ql-align-center><br></p><div class=pgc-img><img alt=为了30分钟配送，盒马工程师都有哪些“神操作”？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/46b73fe7999d4ede9e16ea84933c4eac><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>阿里妹导读：提到盒马鲜生，除了新鲜的大龙虾以外，大家印象最深的就是快速配送：门店附近3公里范围内，30分钟送货上门。</p><p>盒马是基于规模化和业务复杂度两个交织，从IT到DT，从原产地到消费者而形成的端到端的平台，而盒马配送更是集成IOT、智能化、自动化等到线下作业，同时受不可抗力因素雨雪冰雾、道路交通、小区设施等让配送系统的稳定性更加雪上加霜，如何保障线下配送作业的稳定性，让骑手快乐，更让用户开心是盒马配送永恒的话题。</p><p><strong>三大规范</strong></p><p>整个盒马技术部对线上/线下作业生产之关注，代码质量之高、故障处理之严，让我们工程师在反复反复地肯定自己的同时又不断地否定自己，在开发中设计重构系统，在生产之中检验系统。经过线上/线下冰与火的历练，我们淬炼出了一套稳定性的方法论，概括起来就12个字：<strong>研发规范、架构规范、稳定性规范。</strong></p><p><strong>无规矩，无以成方圆</strong></p><p>首先是研发规范，且看下图：</p><div class=pgc-img><img alt=为了30分钟配送，盒马工程师都有哪些“神操作”？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c7c09e4c60c545ac893cd9c637d26d32><p class=pgc-img-caption></p></div><p>这个图管它叫做7层漏斗模型（努力画出漏斗，画图功夫不行，浅色的箭头表示漏斗），7层是指PRD评审、技术方案评审、TC评审、编码、测试&代码Review、灰度发布、运维。为什么是漏斗模型呢？因为我们通过这7层经过层层筛选，将阻碍线下流程的重大故障全部在这7层兜住。</p><p><strong>PRD评审：</strong>我们有个需求池，所有的需求都先扔到这个池子里面，每两周有个运营双周会，从中筛选出优先级高、紧急程度高的需求开始进行PRD评审（倒排项目除外），所有的PRD评审都有PD组织，从项目或者需求的价值认识上达成一致，在评审的过程中研发同学从PRD中寻找名词进行领域建模和抽象。整个需求和项目需要识别到技术风险，遵循“不被别人搞死、不搞死别人”的原则，识别核心链路和非核心链路；测试同学从中识别风险点和测试功能点，为后面TC评审做好准备。</p><p><strong>技术方案评审：</strong>PM组织研发、测试和PD总共参与，研发同学按照事先分配好的研发模块进行技术串讲，同时和PD、甚至电话业务同学共同达成产品兜底方案和业务兜底方案。人都会犯错，何况是人写出来的代码，我们要拥抱bug，但更要识别到潜在的风险进行兜底。</p><p><strong>TC评审：</strong>一般在技术评审完成后的两天内会进行TC评审，主要功能的覆盖点、技术方案潜在的坑、非功能角度的业务降级方案、性能的QPS\RT、接口的可测性的评估、测试环境、测试数据等，最后给出可靠的上线时间。</p><p><strong>编码：</strong>首先遵循集团的编码规则，然后就是防御性编程，业务系统可能80%的代码都在考虑异常情况下如何保证高可用。系统异常、业务异常的处理，上线时门店灰度方案（一个门店出问题，不影响整个盒马门店），缓存机制、柔性可用、重试机制、事务处理、串并行、打日志等等。</p><p><strong>测试&代码Review：</strong>首先研发完成自测并冒烟通过，正式提测，当然在编码的过程中也会进行代码Review，那时的代码Review管它叫线上Review，通过Aone的功能提交给相关同学进行Review；整个测试结束后上线前我们会聚集到一起进行代码围观Review，这个阶段也会完成系统依赖顺序、发布顺序、回滚顺序，每个人的位置。</p><p><strong>灰度发布：</strong>首先我们严格遵守盒马研发红线，按照发布窗口进行发布，同时为了将风险降到最低，针对不同的业务做不同的发布时间点，比如O2O场景下午2点准时发布，B2C场景晚上8点半准时点火；针对不同的门店进行灰度，发布完成后就立马通过SLS查看原始错误日志，A3查看错误统计日志，EagleEye查看QPS/RT，CloudDBA查看DB性能/慢SQL等全面盯屏30分钟以上。一般我们觉得风险比较大的，在发布时会只发2台机器，第二天观察没有任何问题再全部上线，如果有问题就直接上去Kill掉这两台机器。</p><p><strong>运维：</strong>每次发布后第二天早起盯屏是非常关键，尤其是配送涉及不同运力商、运力类型等作业的校验方式不同，在早上运力类型丰富是最容易出问题，也最容易发现问题。一旦有问题，谁先第一个发现先问题就会立马在群里钉钉电话所有人，若是跨团队的会单独拉小群电话所有人，对于问题的定位我们设置专门的同学，有人看SLS，有人看EagleEye，有人看A3，有人看Xflush，有人看CloudDBA，有人对外发声安抚骑手，一个人统一指挥，大家分工明确，整个问题处理起来就像一个人。</p><p><strong>不把鸡蛋放在一个篮子</strong></p><p>盒马配送目前有50+系统，其中核心应用有20+，那么这么多系统如何既保稳定又能协作？且看下图：</p><div class=pgc-img><img alt=为了30分钟配送，盒马工程师都有哪些“神操作”？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/61c694c88a324bdb9d9aaaa243825b40><p class=pgc-img-caption></p></div><p><strong>项目化：</strong>盒马配送从刚开始按照项目维度构建整个系统，能够满足盒马用户的个性化需求，这种在人少的情况下开发起来很快，也能快速的迭代。</p><p><strong>产品化：</strong>随着业务需求越来越多，这种开发方式越来越拖慢整个项目节奏，尤其是需求的灵活多变，这个时候产品化的方式随之而来，我们在去年5月份的引入了NBF的规则中心、各种Setup，将运营逻辑和业务逻辑区别开来等各种配置化，快速支持需求的变化。</p><p><strong>服务化：</strong>去年8月份的时候和点我达、邻趣、蜂鸟等三方进行对接，对接的过程比较痛苦，我们发现业务逻辑主要是在盒马场景下，三方的场景需要做一些定制，这个时候我们开始考虑整个线下作业不变业务规则和基于场景的业务规则，将不变业务规则下沉作为我们的后台，基于场景的业务规则放到我们的中台，形成后台解释业务概念、业务状态和业务规则，中台做统一权限校验、场景化的业务逻辑、数据网关、整个降级限流可以上浮到中台来，完成对各运力商的流控，慢慢孵化出上面的架构规范。这一过程比较痛苦，我们既要追赶业务，又把34个核心的L0服务梳理业务逻辑、接口参数的合理性、外部依赖等重新升级一遍，新老服务平滑迁移对业务无感，最后注册到NBF上，通过NBF链接起所需的各域能力去表达业务。</p><p><strong>数字化：</strong>最底下一层是我们的用工管理平台，新零售从企业角度看有两个核心层面，其一是技术层面“人货场”的数字化；其二是零售层面的“人货场”的变革或者革命；用技术驱动零售变革，让我们真正能看到整个线下作业流程的好与坏，哪些门店好，哪些门店差，原因到底在哪里，如何去优化提供技术依据和支撑，整个数据模型如下图：</p><div class=pgc-img><img alt=为了30分钟配送，盒马工程师都有哪些“神操作”？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/555231337b9d478fba1d21edabb5d326><p class=pgc-img-caption></p></div><p><strong>纸上得来终觉浅</strong></p><p>任何理论、架构都要不断接受实践的检验，在错误中学习，在错误中成长，提出了一套适合线下配送的7路23招打法，如下图：</p><div class=pgc-img><img alt=为了30分钟配送，盒马工程师都有哪些“神操作”？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/86967918bfa7431da6cebe8bbb28dd53><p class=pgc-img-caption></p></div><p><strong>第一路：核心和非核心隔离</strong></p><p>首先我们从应用维度进行核心和非核心隔离，核心服务和非核心服务隔离，从数据库层面我们做了核心库和非核心库隔离，读写分离、充分发挥各存储层的优势，比如核心作业场景我们采用Mysql，实时聚合分析场景我们采用ADS，非核心多维度组合查询场景我们引入OpenSearch、和离线场景的ODPS，这样既起到分流的作用，又保护了核心作业场景。如此架构升级，可以让我们的上嘉同学进来在一些非核心场景上独挡一面，充分发挥他们的潜力。</p><p>系统交互上我们采用基于Request/Response模式的HSF水平调用；另外一种基于Event-driven模式的消息垂直调用。</p><div class=pgc-img><img alt=为了30分钟配送，盒马工程师都有哪些“神操作”？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a0d6d599b5194edcb34184c97bcd3bbe><p class=pgc-img-caption></p></div><p>对核心服务的依赖上，我们本着不信任任何外部服务的原则，即使外部服务出问题，我们依然能够继续作业，形成如下图的调用方式：</p><div class=pgc-img><img alt=为了30分钟配送，盒马工程师都有哪些“神操作”？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/dfe3858c792e4fa8b1934fa1e83cf74a><p class=pgc-img-caption></p></div><p>链路开销大且网络抖动很容易引起问题，我们会将其做成一个“航母级”的服务来调用，如下调用：</p><div class=pgc-img><img alt=为了30分钟配送，盒马工程师都有哪些“神操作”？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/bfc1f73bb1154605ad8dae8e6e265c4d><p class=pgc-img-caption></p></div><p>举个例子：配送人货匹配生成笛卡尔积后类似map-reduce进行分布式计算，通过鹰眼链路观察发现耗时主要在map到reduce的网络耗时，不在于计算耗时，我们将将人货匹配生成矩阵，平衡网络开销和分布式计算，最后将108次调用变为9次，性能基本提升12倍，如下矩阵：</p><div class=pgc-img><img alt=为了30分钟配送，盒马工程师都有哪些“神操作”？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fd4f5fb7f9d64994b7b153c389e47512><p class=pgc-img-caption></p></div><p><strong>第二路：及时发现问题是稳定的一半</strong></p><p>服务级别-幂等、参数校验、熔断、还是静态和动态控制超时时间、重试次数来保障服务级别的高可用；</p><p>系统级别-流量调度、研发红线、代码Reivew文化、重大发布集体上光明顶、流量调度、A3\EagleEye\SLS\Xflush等的QPS\RT同比环比的服务监控还是底层的机器性能监控都能保证在第一时间发现问题。重大发布集体上光明顶是我们的一个文化，记得在双12前两周我们对整个系统架构进行了一次升级，涉及13个系统又在大促前顶着压力发布上线，最终在双12期间系统整体平稳，较双11各项指标毛刺减少，特别是双12哪几天的雨雪天气在站内批次积压严重的情况下，我们的人货追加服务较双11的QPS增加近一倍，但我们的RT却降低了50%。</p><p>其它招，比如我们在过年期间每天的专人进行核心系统的例行检查，确保系统正常运行；在稳定性知识方面，我们内外结合进行分享，同时将别的team的故障都当做自己的故障来分析原因和查找我们系统的不足。</p><p><strong>第三路：故障预防</strong></p><p>在系统复杂和业务需求不断导致代码腐化，我们定时对整个系统进行重构，将整个重构方案大家达成一致；在今年系统的混部环境对我们也是一个挑战，所以我们引入了超时和重试机制，特别是做到了运行期修改超时时间，防止雪崩，每一个新功能上线时都会做故障注入和故障演练，识别潜在风险。</p><p><strong>第四路：故障缓解</strong></p><p>我们机器留有一些buffer以防大促、线程池满等紧急扩容情况下使用，同时对高QPS有降级预案以防异常情况紧急止血。还是前面提到的业务系统一定要有产品和业务兜底方案，比如我们在和蜂鸟对接时当蜂鸟的系统如果出现问题时，我们服务端针对此种情况做了防御性编程，打开开关让蜂鸟骑手用飞鱼app进行作业，减轻对用户的影响面。在稳定上，我们不但要自己赢，也要让合作伙伴赢。</p><p><strong>第五路：快速恢复</strong></p><p>回滚是系统发布后出现异常最有效的止血方案，对于弱依赖我们通过柔性可用性让它跳过不阻塞继续往下走，当出现异常case时比如履约和配的状态不一致我们通过阿波罗后台进行一键修复，异常紧急订正预案、Diamond命令下发等来快速恢复。</p><p><strong>第六路：快速补偿</strong></p><p>我们的系统在设计的都是无状态扁平化，不存在单点，机器扩容是应对某些异常情况的快速止血方案。</p><p><strong>第七路：发布治疗</strong></p><p>在上述路数招数都无法快速止血的情况下只能采用发布治疗，我们有一次突然机器Load飙高，收到报警后第一反应是机器问题，但又发现部分机器的线程池也快满了，我们随即开始扩容和机器重启，一部分同学在快速扩容，一部分同学在不停的机器重启，其它同学在迅速查找问题的根本原因，最后通过DUMP发现是由于引用了一个Jar，而这个Jar包里面使用了Java的正则表达式在解析一个特殊商品名称的时候进入了死循环，找到原因后这种情况只能通过发布解决，我们迅速达成一致紧急发布解决，正是前面一部分同学的扩容和不停的重启，从而避免了一场故障。</p><p><strong>大海航行靠舵手</strong></p><p>盒马配送的稳定性靠的是业务方、产品、研发、测试、Web端、App端、RF端、GOC、上下游、算法、IOT、NBF、盒马安全生产、中间件、网络、气象台、雨雪冰雾、道路交通、红绿灯、小区设施、骑手装备等等各种因素，每一个组成部分都是至关重要。稳定性的探索我们还在路上，不断追求极致。</p><p><strong>本周三晚，阿里技术直播等你来！</strong></p><p class=ql-align-justify><strong>3月20日（周三）晚19:30，咱们一起聊聊“AI与安全：数字时代下的机遇与挑战！”，欢迎收看。</strong></p><div class=pgc-img><img alt=为了30分钟配送，盒马工程师都有哪些“神操作”？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cdd2dc50af564f36b94e5ddb41bab7ff><p class=pgc-img-caption></p></div><p><strong>直播参与方式：</strong></p><ul><li class=ql-align-justify>直接观看：扫描上方图片二维码，或在浏览器中（记住！一定要用浏览器打开，手机或PC均可）打开直播链接：https://alivideolive.taobao.com/h5/liveDetail/22c3dd6d-8855-4575-b347-adacb4867ac8，收藏起来，定好闹钟，3月20日（周三）准时观看</li><li class=ql-align-justify>钉钉群观看：使用“钉钉”搜索交流群号 <strong>21933455</strong>，加入AI与安全技术交流群，既可到时观看直播，也可与嘉宾、行业同仁互动探讨。</li></ul><p class=ql-align-justify><br></p><p><strong>直播亮点：</strong></p><p>本次直播，我们将重点介绍多模态融合、小样本学习、领域迁移、视频graph建模等前沿AI安全技术。究竟阿里如何通过这些技术提升整体风险防控能力?本周三晚，不见不散！</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'30','分钟','盒马'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>