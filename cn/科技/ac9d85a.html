<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一文教你学会Android 悬浮窗、悬浮球开发 | 极客快訊</title><meta property="og:title" content="一文教你学会Android 悬浮窗、悬浮球开发 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/f45e807af66941c090d3ed3249a87e5b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ac9d85a.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ac9d85a.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ac9d85a.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ac9d85a.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ac9d85a.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ac9d85a.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ac9d85a.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ac9d85a.html><meta property="article:published_time" content="2020-10-29T21:07:11+08:00"><meta property="article:modified_time" content="2020-10-29T21:07:11+08:00"><meta name=Keywords content><meta name=description content="一文教你学会Android 悬浮窗、悬浮球开发"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/ac9d85a.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一文教你学会Android 悬浮窗、悬浮球开发</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>废话不多说，直接上干货，不会的话可以来找我。</p><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">一、权限管理</span></h1><p>悬浮窗权限：</p><pre><code>&lt;uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" /&gt;</code></pre><p>权限检验和请求：</p><pre><code>            //检查是否已经授予权限，大于6.0的系统适用，小于6.0系统默认打开，无需理会            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M&amp;&amp;!Settings.canDrawOverlays(this)) {                //没有权限，需要申请权限，因为是打开一个授权页面，所以拿不到返回状态的，所以建议是在onResume方法中从新执行一次校验                Intent intent = new Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION);                intent.setData(Uri.parse("package:" + getPackageName()));                startActivityForResult(intent, 100);            }else{                //已经有权限，可以直接显示悬浮窗            }        </code></pre><p>其他注意问题：</p><pre><code>        //因为部分type在部分系统中已经废弃，懒得看文档，下面是我亲测是兼容7.0和8.0系统的方法        if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O) {            wmParams.type = WindowManager.LayoutParams.TYPE_SYSTEM_ALERT;        } else {            wmParams.type = WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY;        }</code></pre><p></p><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">二、Base类BaseSuspend</span></h1><pre><code> import android.content.Context;import android.graphics.PixelFormat;import android.os.Build;import android.view.Gravity;import android.view.LayoutInflater;import android.view.View;import android.view.WindowManager; import com.imxiaoyu.common.utils.entity.SizeEntity; public abstract class BaseSuspend {    private Context context;    private View view;    private boolean isShowing = false;    /**     * UI     */    private WindowManager.LayoutParams wmParams;//悬浮窗的布局     /**     * 变量     */    private WindowManager mWindowManager;//创建浮动窗口设置布局参数的对象     /**     * 接口     */    private OnSuspendDismissListener onSuspendDismissListener;     public BaseSuspend(Context context) {        this.context = context;        view = LayoutInflater.from(context).inflate(getLayoutId(), null);        init();        initView();        onCreateSuspension();    }     public void init() {        if (mWindowManager == null) {            mWindowManager = (WindowManager) context.getApplicationContext().getSystemService(Context.WINDOW_SERVICE);        }        wmParams = getParams();//设置好悬浮窗的参数        // 悬浮窗默认显示以左上角为起始座标        wmParams.gravity = Gravity.LEFT | Gravity.TOP;    }     /**     * 布局文件id，这里是用不到的，但还是建议填写，方便跳转到布局管理     *     * @return     */    protected abstract int getLayoutId();     /**     * 注册需要使用的控件     */    protected abstract void initView();     protected abstract void onCreateSuspension();     /**     * 根据id快速找到控件     *     * @param id     * @param &lt;E&gt;     * @return     */    public final &lt;E extends View&gt; E findView(int id) {        try {            return (E) view.findViewById(id);        } catch (ClassCastException ex) {            throw ex;        }    }     /**     * 根据id快速找到控件     *     * @param id     * @param onClickListener     * @param &lt;E&gt;     * @return     */    public final &lt;E extends View&gt; E findView(int id, View.OnClickListener onClickListener) {        E e = findView(id);        e.setOnClickListener(onClickListener);        return e;    }     /**     * 对windowManager进行设置     *     * @return     */    public WindowManager.LayoutParams getParams() {        wmParams = new WindowManager.LayoutParams();        //设置window type 下面变量2002是在屏幕区域显示，2003则可以显示在状态栏之上        //wmParams.type = LayoutParams.TYPE_PHONE;        if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O) {            wmParams.type = WindowManager.LayoutParams.TYPE_SYSTEM_ALERT;        } else {            wmParams.type = WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY;        }//        wmParams.type = WindowManager.LayoutParams.TYPE_SYSTEM_ERROR;        //设置图片格式，效果为背景透明        wmParams.format = PixelFormat.RGBA_8888;        //设置浮动窗口不可聚焦（实现操作除浮动窗口外的其他可见窗口的操作）        //wmParams.flags = LayoutParams.FLAG_NOT_FOCUSABLE;        //设置可以显示在状态栏上        wmParams.flags = WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE | WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL |                WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN | WindowManager.LayoutParams.FLAG_LAYOUT_INSET_DECOR |                WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH;        return wmParams;    }     /**     * 全屏显示悬浮视图     */    public void showSuspend() {        showSuspend(0, 0, true);    }     /**     * 显示悬浮视图     *     * @param sizeEntity     * @param isMatchParent 是否全屏显示     */    public void showSuspend(SizeEntity sizeEntity, boolean isMatchParent) {        if (sizeEntity != null) {            showSuspend(sizeEntity.getWidth(), sizeEntity.getHeight(), isMatchParent);        }    }     /**     * 显示悬浮视图     *     * @param width     * @param height     */    public void showSuspend(int width, int height, boolean isMatchParent) {        //设置悬浮窗口长宽数据        if (isMatchParent) {            wmParams.width = WindowManager.LayoutParams.MATCH_PARENT;            wmParams.height = WindowManager.LayoutParams.MATCH_PARENT;        } else {            wmParams.width = WindowManager.LayoutParams.WRAP_CONTENT;            wmParams.height = WindowManager.LayoutParams.WRAP_CONTENT;        }        //悬浮窗的开始位置，读取缓存        wmParams.x = width;        wmParams.y = height;         if (isShowing) {            removeView();        }        mWindowManager.addView(view, wmParams);        isShowing = true;    }     /**     * 更新当前视图的位置     *     * @param x 更新后的X轴的增量     * @param y 更新后的Y轴的增量     */    public void updateSuspend(int x, int y) {        if (view != null) {            //必须是当前显示的视图才给更新            WindowManager.LayoutParams layoutParams = (WindowManager.LayoutParams) view.getLayoutParams();            layoutParams.x += x;            layoutParams.y += y;            mWindowManager.updateViewLayout(view, layoutParams);        }    }     /**     * 移除当前悬浮窗     */    public void dismissSuspend() {        if (view != null) {            mWindowManager.removeView(view);            isShowing = false;            if (onSuspendDismissListener != null) {                onSuspendDismissListener.onDismiss();            }        }    }     public Context getContext() {        return context;    }     public View getView() {        return view;    }     /**     * 是否正在显示     *     * @return     */    public boolean isShowing() {        return isShowing;    }     /**     * 移除弹窗的时候回调     *     * @param onSuspendDismissListener     */    public void setOnSuspendDismissListener(OnSuspendDismissListener onSuspendDismissListener) {        this.onSuspendDismissListener = onSuspendDismissListener;    }     public interface OnSuspendDismissListener {        public void onDismiss();    }}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">还有里面用到的一个size类：</span></p><pre><code> /** * 宽高实体 * Created by 她叫我小渝 on 2016/11/4. */ public class SizeEntity {    private int width;    private int height;     public SizeEntity(){}    public SizeEntity(int width,int height){        setWidth(width);        setHeight(height);    }      public int getWidth() {        return width;    }     public void setWidth(int width) {        this.width = width;    }     public int getHeight() {        return height;    }     public void setHeight(int height) {        this.height = height;    }}</code></pre><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">3、定制视图和使用</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">要实现的逻辑是，显示一个悬浮球，然后可以拖动移动悬浮球的位置，效果图：</span></p><div class=pgc-img><img alt="一文教你学会Android 悬浮窗、悬浮球开发" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f45e807af66941c090d3ed3249a87e5b><p class=pgc-img-caption></p></div><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999"></span></p><div class=pgc-img><img alt="一文教你学会Android 悬浮窗、悬浮球开发" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9d4eff3c6b2447ffb8a3319098b31fe6><p class=pgc-img-caption></p></div><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">然后新建一个类，LogoSuspend继承BaseSuspend，里面引用到了一些工具类就不贴出来了，用到的地方我会加上注释</span></p><pre><code> /** * 悬浮球 * Created by 她叫我小渝 on 2017/1/1. */ public class LogoSuspend extends BaseSuspend {     /**     * ui     */    private ImageView ivLogo;    /**     * 变量     */    private int width, height;    private float mStartX, mStartY, mStopX, mStopY, touchStartX, touchStartY;    private long touchStartTime;    /**     * 接口     */    private View.OnClickListener onClickListener;     public LogoSuspend(Context context) {        super(context);    }      @Override    protected int getLayoutId() {        return R.layout.suspend_logo;    }     @Override    protected void initView() {        ivLogo = findView(R.id.iv_logo);        ivLogo.setOnTouchListener(new View.OnTouchListener() {            @Override            public boolean onTouch(View view, MotionEvent event) {                final int action = event.getAction();                mStopX = event.getRawX();                mStopY = event.getRawY();                switch (action) {                    case MotionEvent.ACTION_DOWN:                        // 以当前父视图左上角为原点                        mStartX = event.getRawX();                        mStartY = event.getRawY();                        touchStartX = event.getRawX();                        touchStartY = event.getRawY();                        touchStartTime = DateUtil.getTimeForLong();//获取当前时间戳                        break;                    case MotionEvent.ACTION_MOVE:                        width = (int) (mStopX - mStartX);                        height = (int) (mStopY - mStartY);                        mStartX = mStopX;                        mStartY = mStopY;                        updateSuspend(width, height);                        break;                    case MotionEvent.ACTION_UP:                        width = (int) (mStopX - mStartX);                        height = (int) (mStopY - mStartY);                        updateSuspend(width, height);                        WindowManager.LayoutParams layoutParams = (WindowManager.LayoutParams) getView().getLayoutParams();                        SuspensionCache.setSuspendSize(getContext(), new SizeEntity(layoutParams.x + width, layoutParams.y + height));//缓存一下当前位置                        if ((mStopX - touchStartX) &lt; 30 &amp;&amp; (mStartY - touchStartY) &lt; 30 &amp;&amp; (DateUtil.getTimeForLong() - touchStartTime) &lt; 300) {                            //左右上下移动距离不超过30的，并且按下和抬起时间少于300毫秒，算是单击事件，进行回调                            if (onClickListener != null) {                                onClickListener.onClick(view);                            }                        }                        break;                }                return true;            }        });    }     @Override    protected void onCreateSuspension() {     }     /**     * 设置点击监听     *     * @param onClickListener     */    public void setOnClickListener(View.OnClickListener onClickListener) {        this.onClickListener = onClickListener;    }}</code></pre><p style=text-align:start><strong><span style="color:#4d4d4d;--tt-darkmode-color: #999999">布局文件syspend_logo.xml</span></strong></p><pre><code>&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"    android:id="@+id/rly_bg"    android:layout_width="wrap_content"    android:layout_height="wrap_content"&gt;     &lt;ImageView        android:id="@+id/iv_logo"        android:layout_width="wrap_content"        android:layout_height="wrap_content"        android:src="@drawable/ic_home_add_normal" /&gt;&lt;/RelativeLayout&gt;</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">因为Activity是有生命周期的，所以打开悬浮窗的Context上下文，不要用Activity的，而是用Service的</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">创建并注册一个Service，然后在onCreate方法中执行调用代码就好</span></p><pre><code>@Override    public void onCreate() {        super.onCreate();        ALog.e("服务已创建");         if (logoSuspend == null) {            logoSuspend = new LogoSuspend(this);        }        logoSuspend.showSuspend(SuspensionCache.getSuspendSize(this), false);//从缓存中提取上一次显示的位置        logoSuspend.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                //处理单击事件            }        });    }</code></pre><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">四、废话</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">上面的例子，其实还是比较简单的，但一般开发对于悬浮球的需求并不算很大，Base类的话，目前只是最基础的东西，在开发的过程中，需要用到什么了再往里面加就好，问题不大。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">目前代码支持同时显示多个悬浮窗、悬浮球，主要用于在于悬浮窗交互的时候，直接弹出其他的交互界面（也是以悬浮窗的状态出现），但建议每一个页面都有关闭按钮或者做返回键关闭的相关操作，毕竟是显示在最前端的，要是关不掉就点哪里都没用，只能是强制关机了…………</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">（）&@（）……（）@#*￥）（）@*#…………@#）（）*￥）（）…………</span></p><h1 class=pgc-h-arrow-right>五、最后</h1><p>正在学习Android，或者正在准备Android面试的朋友可以关注我，<strong>评论区留言“111”，免费分享Android架构师进阶学习资料，还有大厂面试真题和解析</strong>。</p><p>种一棵树最好的时间有两个，一个是十年前，另一个就是现在。</p><p>学习也是如此。</p><p>亡羊补牢，为时不晚。要想进步，不被淘汰，那就要不断学习。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'浮球','学会','Android'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>