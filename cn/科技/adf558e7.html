<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码 | 极客快訊</title><meta property="og:title" content="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/60bc9160b4bd4c319ed419be29146606"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/adf558e7.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/adf558e7.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/adf558e7.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/adf558e7.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/adf558e7.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/adf558e7.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/adf558e7.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/adf558e7.html><meta property="article:published_time" content="2020-11-14T21:04:32+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:32+08:00"><meta name=Keywords content><meta name=description content="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/adf558e7.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>喜欢的话可以收藏转发加关注</strong></p><p>为什么写这篇文章？</p><p>昨天在技术群上，有人问了个问题：</p><blockquote><p>如果一个结构体, 只是读里面的成员, 在 golang 里面传值的时候, 不传递指针, golang 编译器会帮你优化成 const & 么?</p></blockquote><p>随便一猜：golang 肯定是直接 copy 整个结构体。</p><p>为了确认是否真的是这样，最直白的方式就是直接看 golang 生成的汇编代码。</p><p>从图中的汇编代码中，我们可以清楚的看到：golang 的确是执行了完整的结构体 copy 。</p><div class=pgc-img><img alt="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/60bc9160b4bd4c319ed419be29146606><p class=pgc-img-caption></p></div><p>然后群友给了这样的反馈...</p><div class=pgc-img><img alt="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/756aeb5ae28b440d8a6fb49c47690926><p class=pgc-img-caption></p></div><p>看着自己日益升高的发际线，我陷入了沉思...</p><hr><p>好了，进入正题。</p><p>本文将以 1 + ... + 100 的代码为例，介绍以下几种语言查看“汇编代码”的方式。</p><p>（这里的“汇编代码”只是个统称，大家不用太计较）</p><ol><li>GolangLuaJavaScript（V8）RustPython等等 ...</li></ol><p>1. Golang 生成汇编代码</p><p>源码</p><pre>package mainfunc main(){	var sum = 0	for i:=1 ; i &lt;= 100; i++ {		sum = sum + i	}}</pre><p>查看方式</p><pre>go tool compile -S .\test.gogo tool objdump .\test.o</pre><div class=pgc-img><img alt="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/392b2e86c24f4dfdaa2e5c283e2c0244><p class=pgc-img-caption></p></div><p>分析</p><p>行 1 : 表示 将数值 1 放到 AX 中</p><p>行 2 : 表示 跳转到 行 4</p><p>行 3 : 表示 对 AX 中的数值执行 + 1 操作</p><p>行 4 : 比较 AX 是否在 100 以内。（0x64 是 数值 100 的 16 进制）</p><p>行 5 : 跳转到 行 3</p><p>嗯... 怎么感觉就是在空循环，我们的 sum 变量哪里去了？</p><p>事实上：golang 检测到 sum 没有被使用，直接就帮我们优化掉了，只留下一个空循环。</p><p>（但它没有彻底的帮我们把这个空循环也删掉...)</p><p>如果我们把代码改成这样子：</p><pre>package mainfunc main(){}func getSum()int{	var sum = 0	for i:=1 ; i &lt;= 100; i++ {		sum = sum + i	}	return sum}</pre><p>那么 sum 累加部分的汇编就是可以正常的显示出来，如图所示：</p><div class=pgc-img><img alt="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f9ba29aa7cb74fc09767a322945ceb8f><p class=pgc-img-caption></p></div><p>2. Lua 生成汇编代码</p><p>源码</p><pre>function getSum() local sum = 0 for i=1, 100 do sum = sum + i end return sumend</pre><p>查看方式</p><pre>luac.exe -l test.lua </pre><div class=pgc-img><img alt="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/db28602e1bfe4fe2888ba384cd8c3944><p class=pgc-img-caption></p></div><p>分析</p><p>Lua 虚拟机是基于寄存器来实现的。这段汇编代码读起来，就不像golang那么好理解了。</p><p>（关于寄存器虚拟机的相关内容，我在文章的评论中补充了一些。有兴趣的话，可以看看）</p><p>这里我就简单的分析下：</p><p>行 1-4：将常量表里的 0，1，100，1分别加载到寄存器中。</p><p>LOADK 指令后面的跟着 2 个参数，分别是：参数1 寄存器索引，参数2 常量表索引</p><p>分号后面的数值是： 具体的常量值</p><p>这四个数字中：</p><p>第一个数字 0 ，就是 sum 的初始值 。</p><p>后面三个数（1， 100， 1）：表示了循环从 1 开始，到 100 结束，步长为 1</p><p>（ 也就是说 i 从 1 开始，每次循环自动+1，直到达到 100）</p><p>行 5-7：执行循环</p><p>Lua 通过 FORPREP、FORLOOP 两条指令来实现循环。</p><p>它们的第一个参数：表示指向 循环所需的三个数字 的起始寄存器索引，也就是 寄存器 1。</p><p>（这样虚拟机就知道了，循环所需的三个数字：1，100，1，从而准确的控制循环的逻辑）</p><p>它们的第二个参数，表示PC指令跳转的距离。</p><p>注意：FORLOOP 会把 i+1 的结果 放在寄存器 4 中，对应 add 的第 3 个参数</p><p>行 6：执行 Add 操作</p><p>Add 后面跟着 3 个参数。含义如下：</p><p>参数1：存放结果的寄存器索引</p><p>参数2、参数3： 分别是两个加数的索引位置</p><p>既然已经分析了 golang 和 lua 两个语言生成的汇编代码，后面的语言就不再详细的分析了，基本大同小异。</p><p>3. JavaScript 生成汇编代码</p><pre>function getSum(){ let sum = 0; for(let i = 1 ; i &lt;= 100; i++){ sum += i } return sum}</pre><p>查看方式</p><pre>node --print-bytecode .\test.js</pre><div class=pgc-img><img alt="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f2169124971f4a929b95824cc4ac9829><p class=pgc-img-caption></p></div><p>4. Rust 生成汇编代码</p><p>rust 就比较有意思了（和 c++ 差不多），值得稍微提一下。</p><pre>fn main() { println!("{}", get_sum());}fn get_sum() -&gt; i32{ let mut sum = 0; for i in 1..=100 { sum += i } return sum}</pre><p>查看方式</p><pre>rustc -O --emit asm=test_rust.s .\test_rust.rs</pre><p>加入了 -O 优化之后，生成的汇编代码是这个样子，它直接用 5050 来赋值，省略了计算的过程。</p><div class=pgc-img><img alt="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/408b99fe34db4becb8cc9305d01e7606><p class=pgc-img-caption></p></div><p>5. Python 生成汇编代码</p><pre>import disdef getSum(): sum = 0 for i in range(1,101): sum = sum + i return sumdis.dis(getSum)</pre><p>查看方式</p><pre>python .\test.py# 也可以通过 python -m py_compile .\test.py 来编译出 pyc 文件# 再通过第三方工具，来查看 pyc 的字节码</pre><div class=pgc-img><img alt="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0b8e62113ec64d6080ebca314632c0a5><p class=pgc-img-caption></p></div><p>其它语言:有时间再补充</p><p>...</p><p>最后</p><p>那么了解汇编层面的东西，有什么用呢？</p><p>嗯...对于绝大多数开发者来说，的确没什么用...</p><p>但是如果你有深入底层的追求，那么了解汇编的知识，会让你对程序理解的更加透彻。</p><p>而且，不管是 Rust，还是 C++ 都支持 内联汇编：可以在代码里嵌入汇编语言，直接控制 CPU，从而获取极致的底层操作、以及性能上的提升。</p><blockquote><p>比如：腾讯开源的C++协程库：Tencent/libco 就用到了该技术方案。</p></blockquote><p><strong>学习C/C++的伙伴可以私信回复小编“学习”领取全套免费C/C++学习资料、视频</strong></p><div class=pgc-img><img alt="查看 Golang、Lua、JS、Rust、Python等语言生成的汇编代码" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e37af2d7c6674313bf4f855272bf8a4b><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Golang','Lua','JS'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>