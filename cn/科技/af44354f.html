<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ä½¿ç”¨GoåŸºäºWebSocketæ„å»ºåƒä¸‡çº§è§†é¢‘ç›´æ’­å¼¹å¹•ç³»ç»Ÿ | æå®¢å¿«è¨Š</title><meta property="og:title" content="ä½¿ç”¨GoåŸºäºWebSocketæ„å»ºåƒä¸‡çº§è§†é¢‘ç›´æ’­å¼¹å¹•ç³»ç»Ÿ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/f89b8532845242149b2510d6fe6b0bec"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/af44354f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/af44354f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/af44354f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/af44354f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/af44354f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/af44354f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/af44354f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/af44354f.html><meta property="article:published_time" content="2020-11-14T20:55:07+08:00"><meta property="article:modified_time" content="2020-11-14T20:55:07+08:00"><meta name=Keywords content><meta name=description content="ä½¿ç”¨GoåŸºäºWebSocketæ„å»ºåƒä¸‡çº§è§†é¢‘ç›´æ’­å¼¹å¹•ç³»ç»Ÿ"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/af44354f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ä½¿ç”¨GoåŸºäºWebSocketæ„å»ºåƒä¸‡çº§è§†é¢‘ç›´æ’­å¼¹å¹•ç³»ç»Ÿ</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h2 class=pgc-h-arrow-right>ï¼ˆ1ï¼‰ä¸šåŠ¡å¤æ‚åº¦ä»‹ç»</h2><p>å¼€é—¨è§å±±ï¼Œå‡è®¾ä¸€ä¸ªç›´æ’­é—´åŒæ—¶500Wäººåœ¨çº¿ï¼Œé‚£ä¹ˆ1ç§’é’Ÿ1000æ¡å¼¹å¹•ï¼Œé‚£ä¹ˆå¼¹å¹•ç³»ç»Ÿçš„æ¨é€é¢‘ç‡å°±æ˜¯ï¼š500W * 1000æ¡/ç§’=50äº¿æ¡/ç§’ï¼Œæƒ³æƒ³Bç«™2019è·¨å¹´æ™šä¼šé‚£æ¬¡å¼¹å¹•ç³»ç»Ÿå¾—æ˜¯å¤šä¹ˆçš„NBï¼Œå†µä¸”ä¸€ä¸ªå¤§å‹ç½‘ç«™ä¸å¯èƒ½åªæœ‰ä¸€ä¸ªç›´æ’­é—´ï¼</p><p>goè¯­è¨€ä¸­æ–‡æ–‡æ¡£ï¼šwww.topgoer.com</p><p>è½¬è‡ªï¼šhttps://blog.51cto.com/xvjunjie/2509035</p><div class=pgc-img><img alt=ä½¿ç”¨GoåŸºäºWebSocketæ„å»ºåƒä¸‡çº§è§†é¢‘ç›´æ’­å¼¹å¹•ç³»ç»Ÿ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f89b8532845242149b2510d6fe6b0bec><p class=pgc-img-caption></p></div><p>ä½¿ç”¨GoåšWebSocketå¼€å‘æ— éå°±æ˜¯ä¸‰ç§æƒ…å†µï¼š</p><ul><li>ä½¿ç”¨GoåŸç”Ÿè‡ªå¸¦çš„åº“ï¼Œä¹Ÿå°±æ˜¯golang.org/x/netï¼Œä½†æ˜¯è¿™ä¸ªå®˜æ–¹åº“çœŸæ˜¯å‡ºäº†å¥‡Bugå¤š</li><li>ä½¿ç”¨GitHubå¤§ä½¬gorilla/websocketåº“ï¼Œå¯ä»¥ç»“åˆåˆ°æŸäº›Webå¼€å‘æ¡†æ¶ï¼Œæ¯”å¦‚Ginã€irisç­‰ï¼Œåªè¦ä½¿ç”¨çš„æ¡†æ¶å¼åŸºäºgolang.org/netçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªåº“å°±å¯ä»¥ä¸è¿™ä¸ªæ¡†æ¶ç»“åˆ</li><li>æ‰‹æ’¸ä¸€ä¸ªWebSocketæ¡†æ¶</li></ul><p>æ ¹æ®ä¼°ç®—ç»“æœï¼Œå¼¹å¹•æ¨é€é‡å¾ˆå¤§çš„æ—¶å€™ï¼ŒLinuxå†…æ ¸å°†ä¼šå‡ºç°ç“¶é¢ˆï¼Œå› ä¸ºLinuxå†…æ ¸å‘é€TCPåŒ…çš„æ—¶å€™æé™åŒ…å‘é€é¢‘ç‡æ˜¯100Wã€‚å› æ­¤å¯ä»¥å°†åŒä¸€ç§’å†…çš„å¼¹å¹•æ¶ˆæ¯åˆå¹¶ä¸º1æ¡æ¨é€ï¼Œå‡å°‘ç½‘ç»œå°æ•°æ®åŒ…çš„å‘é€ï¼Œä»è€Œé™ä½æ¨é€é¢‘ç‡ã€‚</p><p>å¼¹å¹•ç³»ç»Ÿéœ€è¦ç»´æŠ¤åœ¨çº¿çš„ç”¨æˆ·é•¿è¿æ¥æ¥å®ç°å®šå‘æ¨é€åˆ°åœ¨çº¿çš„ç”¨æˆ·ï¼Œé€šå¸¸æ˜¯ä½¿ç”¨Hashå­—å…¸ç»“æ„ï¼Œé€šå¸¸æ¨é€æ¶ˆæ¯å°±æ˜¯éå†åœ¨çº¿ç”¨çš„Hashå­—å…¸ã€‚åœ¨å¼¹å¹•æ¨é€æœŸé—´ç”¨æˆ·åœ¨ä¸æ–­çš„ä¸Šä¸‹çº¿ï¼Œä¸ºäº†ç»´æŠ¤ä¸Šçº¿ç”¨æˆ·ï¼Œé‚£ä¹ˆå°±å¾—ä¸æ–­çš„ä¿®æ”¹Hashå­—å…¸ï¼Œä¸æ–­åœ°è¿›è¡Œé”æ“ä½œï¼Œç”¨æˆ·é‡è¿‡å¤§å¯¼è‡´é”ç“¶é¢ˆã€‚å› æ­¤å¯ä»¥å°†æ•´ä¸ªHashç»“æ„æ‹†åˆ†ä¸ºå¤šä¸ªHashç»“æ„ï¼Œåˆ†åˆ«å¯¹å¤šä¸ªHashç»“æ„åŠ ä¸åŒçš„é”ï¼Œå¹¶ä¸”ä½¿ç”¨è¯»å†™é”æ›¿ä»£äº’æ–¥é”ã€‚</p><p>é€šå¸¸æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯äº¤äº’ä½¿ç”¨JSONç»“æ„ï¼Œé‚£ä¹ˆéœ€è¦ä¸æ–­çš„ç¼–ç è§£ç JSONæ•°æ®ï¼Œè¿™å°†ä¼šå¯¼è‡´CPUç“¶é¢ˆã€‚å°†æ¶ˆæ¯å…ˆè¿›è¡Œåˆå¹¶ï¼Œç„¶åè¿›è¡Œç¼–ç ï¼Œæœ€åè½®è¯¢Hashç»“æ„è¿›è¡Œæ¨é€ã€‚</p><p>ä»¥ä¸Šæ˜¯å•ä½“æ¶æ„å­˜åœ¨çš„é—®é¢˜ï¼Œä¸ºäº†æ”¯æŒæ›´å¤šçš„ç”¨æˆ·è´Ÿè½½ï¼Œé€šå¸¸å¼¹å¹•ç³»ç»Ÿé‡‡ç”¨åˆ†å¸ƒå¼æ¶æ„ï¼Œè¿›è¡Œå¼¹æ€§æ‰©å®¹ç¼©å®¹ã€‚</p><h2 class=pgc-h-arrow-right>ï¼ˆ2ï¼‰æ¨é€è¿˜æ˜¯æ‹‰å–ï¼Ÿ</h2><p>å¦‚æœæ˜¯å®¢æˆ·ç«¯æ‹‰å–æœåŠ¡å™¨ç«¯æ•°æ®ï¼Œé‚£ä¹ˆå°†ä¼šå­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ç›´æ’­åœ¨çº¿äººæ•°å¤šå°±æ„å‘³ç€æ¶ˆæ¯æ•°æ®æ›´æ–°é¢‘ç‡é«˜ï¼Œæ‹‰å–æ¶ˆæ¯æ„å‘³ç€å¼¹å¹•æ— æ³•æ»¡è¶³æ—¶æ•ˆæ€§</li><li>å¦‚æœå¾ˆå¤šå®¢æˆ·ç«¯åŒæ—¶æ‹‰å–ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ç«¯çš„å‹åŠ›æ— å¼‚äºDDOS</li><li>ä¸€ä¸ªå¼¹å¹•ç³»ç»Ÿåº”è¯¥æ˜¯é€šç”¨çš„ï¼Œå› æ­¤å¯¹äºç›´æ’­é—´å¼¹å¹•è¾ƒå°‘çš„åœºæ™¯ï¼Œæ„å‘³ç€æ¶ˆæ¯æ•°æ®æ‹‰å–è¯·æ±‚éƒ½æ˜¯æ— æ•ˆçš„</li></ul><p>å› æ­¤æˆ‘ä»¬è€ƒè™‘æ¨é€æ¨¡å¼ï¼šå½“æ•°æ®å‘ç”Ÿæ›´æ–°çš„æ—¶å€™æœåŠ¡å™¨ç«¯ä¸»åŠ¨æ¨é€åˆ°å®¢æˆ·ç«¯ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆå‡å°‘å®¢æˆ·ç«¯çš„è¯·æ±‚æ¬¡æ•°ã€‚å¦‚æœéœ€è¦å®ç°æ¶ˆæ¯æ¨é€ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€æœåŠ¡å™¨ç«¯ç»´æŠ¤å¤§é‡çš„é•¿è¿æ¥ã€‚</p><h2 class=pgc-h-arrow-right>ï¼ˆ3ï¼‰ä¸ºä»€ä¹ˆä½¿ç”¨WebSocketï¼Ÿ</h2><p>å®ç°å¼¹å¹•æ¶ˆæ¯çš„å®æ—¶æ›´æ–°ä¸€å®šæ˜¯ä½¿ç”¨Socketçš„æ–¹å¼ï¼Œé‚£ä¹ˆä¸ºå•¥è¦ä½¿ç”¨WebSocketå‘¢ï¼Ÿç°åœ¨å¤§éƒ¨åˆ†ç›´æ’­åº”ç”¨çš„å¼€å‘éƒ½æ˜¯è·¨å¹³å°çš„ï¼Œç„¶è€Œè·¨å¹³å°çš„å¼€å‘æ¡†æ¶æœ¬è´¨å°±æ˜¯Webå¼€å‘ï¼Œé‚£ä¹ˆä¸€å®šç¦»ä¸å¼€WebSocketï¼Œè€Œä¸”ä¸€éƒ¨åˆ†ç”¨æˆ·ä¼šé€‰æ‹©åœ¨Webç«¯çœ‹è§†é¢‘ï¼Œæ¯”å¦‚Bilibiliï¼Œç°å¦‚ä»Šä¹Ÿæœ‰ä¸€äº›æ¡Œé¢åº”ç”¨æ˜¯ç”¨Electronç­‰è·¨å¹³å°æ¡†æ¶å¼€å‘çš„ï¼Œæ¯”å¦‚Larké£ä¹¦ç­‰ï¼Œå› æ­¤å®ç°æ¶ˆæ¯æ¨é€çš„æœ€ä½³æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨WebSocketã€‚</p><p>ä½¿ç”¨WebSocketå¯ä»¥è½»æ¾çš„ç»´æŒæœåŠ¡å™¨ç«¯é•¿è¿æ¥ï¼Œå…¶æ¬¡WebSocketæ˜¯æ¶æ„åœ¨HTTPåè®®ä¹‹ä¸Šçš„ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥ä½¿ç”¨HTTPSæ–¹å¼ï¼Œå› æ­¤WebSocketæ˜¯å¯é ä¼ è¾“ï¼Œå¹¶ä¸”ä¸éœ€è¦å¼€å‘è€…å…³æ³¨åº•å±‚ç»†èŠ‚ã€‚</p><div class=pgc-img><img alt=ä½¿ç”¨GoåŸºäºWebSocketæ„å»ºåƒä¸‡çº§è§†é¢‘ç›´æ’­å¼¹å¹•ç³»ç»Ÿ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bdb483f6895640618baeaed7b597534f><p class=pgc-img-caption></p></div><p>ä¸ºå•¥è¦ä½¿ç”¨GoæWebSocketå‘¢ï¼Ÿé¦–å…ˆè¯´åˆ°WebSocketä½ å¯èƒ½ä¼šæƒ³åˆ°Node.jsï¼Œä½†æ˜¯Node.jsæ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œå¦‚æœå®ç°é«˜å¹¶å‘ï¼Œä¸å¾—ä¸åˆ›å»ºå¤šä¸ªNode.jsè¿›ç¨‹ï¼Œä½†æ˜¯è¿™åˆä¸å®¹æ˜“æœåŠ¡ç«¯éå†æ•´ä¸ªè¿æ¥é›†åˆï¼›å¦‚æœä½¿ç”¨Javaå°±ä¼šæ˜¾å¾—æ¯”è¾ƒç¬¨é‡ï¼ŒJavaé¡¹ç›®çš„éƒ¨ç½²ï¼Œç¼–å†™Dockerfileéƒ½ä¸å¦‚Goçš„ç›®æ ‡äºŒè¿›åˆ¶æ›´åŠ ç®€æ´ï¼Œå¹¶ä¸”Goåç¨‹å¾ˆå®¹æ˜“å®ç°é«˜å¹¶å‘ï¼Œä¸Šä¸€ç« è¯´åˆ°Goè¯­è¨€ç›®å‰ä¹Ÿæœ‰æˆç†Ÿçš„WebSocketè½®å­ã€‚</p><h2 class=pgc-h-arrow-right>ï¼ˆ4ï¼‰æœåŠ¡ç«¯åŸºæœ¬Demo</h2><p>é¦–å…ˆæ­å»ºå¥½ä¸€ä¸ªæ¡†æ¶ï¼š</p><pre><code>package mainimport (    "fmt"    "net/http")func main() {  fmt.Println("Listen localhost:8080")     // æ³¨å†Œä¸€ä¸ªç”¨äºWebSocketçš„è·¯ç”±ï¼Œå®é™…ä¸šåŠ¡ä¸­ä¸å¯èƒ½åªæœ‰ä¸€ä¸ªè·¯ç”±    http.HandleFunc("/messages", messageHandler)    // ç›‘å¬8080ç«¯å£ï¼Œæ²¡æœ‰å®ç°æœåŠ¡å¼‚å¸¸å¤„ç†å™¨ï¼Œå› æ­¤ç¬¬äºŒä¸ªå‚æ•°æ˜¯nil    http.ListenAndServe("localhost:8080", nil)}func messageHandler(response http.ResponseWriter, request *http.Request) {    // TODO: å®ç°æ¶ˆæ¯å¤„ç†    response.Write([]byte("HelloWorld"))}</code></pre><p>ç„¶åå®Œå–„messageHandlerå‡½æ•°ï¼š</p><pre><code>func messageHandler(response http.ResponseWriter, request *http.Request) {    var upgrader = websocket.Upgrader{        // å…è®¸è·¨åŸŸ        CheckOrigin: func(resquest *http.Request) bool {            return true        },    }    // å»ºç«‹è¿æ¥    conn, err := upgrader.Upgrade(response, request, nil)    if err != nil {        return    }    // æ”¶å‘æ¶ˆæ¯    for {        // è¯»å–æ¶ˆæ¯        _, bytes, err := conn.ReadMessage()        if err != nil {            _ = conn.Close()        }        // å†™å…¥æ¶ˆæ¯        err = conn.WriteMessage(websocket.TextMessage, bytes)        if err != nil {            _ = conn.Close()        }    }}</code></pre><p>ç°åœ¨åŸºæœ¬ä¸Šå®ç°äº†WebSocketåŠŸèƒ½ï¼Œä½†æ˜¯websocketçš„åŸç”ŸAPIä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆCloseæ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”æ˜¯å¯é‡å…¥çš„ï¼‰ï¼Œå¹¶ä¸”å…¶ä»–æ¨¡å—æ— æ³•å¤ç”¨ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤è¿›è¡Œå°è£…ï¼š</p><ul><li>å°è£…Connectionå¯¹è±¡æè¿°ä¸€ä¸ªWebSocketè¿æ¥</li><li>ä¸ºConnectionå¯¹è±¡æä¾›çº¿ç¨‹å®‰å…¨çš„å…³é—­ã€æ¥æ”¶ã€å‘é€API</li></ul><pre><code>// main.gopackage mainimport (    "bluemiaomiao.github.io/websocket-go/service"    "fmt"    "net/http"    "github.com/gorilla/websocket")func main() {    fmt.Println("Listen localhost:8080")    http.HandleFunc("/messages", messageHandler)    _ = http.ListenAndServe("localhost:8080", nil)}func messageHandler(response http.ResponseWriter, request *http.Request) {    var upgrader = websocket.Upgrader{        // å…è®¸è·¨åŸŸ        CheckOrigin: func(resquest *http.Request) bool {            return true        },    }    // å»ºç«‹è¿æ¥    conn, err := upgrader.Upgrade(response, request, nil)    wsConn, err := service.Create(conn)    if err != nil {        return    }    // æ”¶å‘æ¶ˆæ¯    for {        // è¯»å–æ¶ˆæ¯        msg, err := wsConn.ReadOne()        if err != nil {            wsConn.Close()        }        // å†™å…¥æ¶ˆæ¯        err = wsConn.WriteOne(msg)        if err != nil {            _ = conn.Close()        }    }}</code></pre><pre><code>// service/messsage_service.gopackage serviceimport (    "errors"    "github.com/gorilla/websocket"    "sync")// å°è£…çš„è¿æ¥å¯¹è±¡// // ç”±äºwebsocketçš„Close()æ–¹æ³•æ˜¯å¯é‡å…¥çš„ï¼Œæ‰€ä»¥å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œä½†æ˜¯å…³é—­Channelçš„close()// æ–¹æ³•ä¸æ˜¯å¯é‡å…¥çš„ï¼Œå› æ­¤é€šè¿‡isClosedè¿›è¡Œåˆ¤æ–­// isClosedå¯èƒ½å‘ç”Ÿèµ„æºç«äº‰ï¼Œå› æ­¤é€šè¿‡äº’æ–¥é”é¿å…// å…³é—­websocketè¿æ¥åï¼Œä¹Ÿè¦è‡ªåŠ¨å…³é—­è¾“å…¥è¾“å‡ºæ¶ˆæ¯æµï¼Œå› æ­¤é€šè¿‡signalCloseLoopChanå®ç°type Connection struct {    conn                                   *websocket.Conn    // å…·ä½“çš„è¿æ¥å¯¹è±¡    inputStream                         chan []byte             // è¾“å…¥æµï¼Œä½¿ç”¨Channelæ¨¡æ‹Ÿ    outputStream                      chan []byte             // è¾“å‡ºæµï¼Œä½¿ç”¨chaneelæ¨¡æ‹Ÿ    signalCloseLoopChan         chan byte              // å…³é—­ä¿¡å·    isClosed                              bool                       // æ˜¯å¦è°ƒç”¨è¿‡close()æ–¹æ³•    lock                                     sync.Mutex            // ç®€å•çš„é”}// ç”¨äºåˆå§‹åŒ–ä¸€ä¸ªè¿æ¥å¯¹è±¡func Create(conn *websocket.Conn) (connection *Connection, err error) {    connection = &amp;Connection{        conn:                            conn,        inputStream:                make(chan []byte, 1000),        outputStream:              make(chan []byte, 1000),        signalCloseLoopChan: make(chan byte, 1),        isClosed:                       false,    }    // å¯åŠ¨è¯»å†™å¾ªç¯    go connection.readLoop()    go connection.writeLoop()    return}// è¯»å–ä¸€æ¡æ¶ˆæ¯func (c *Connection) ReadOne() (msg []byte, err error) {    select {    case msg = &lt;-(*c).inputStream:    case &lt;-(*c).signalCloseLoopChan:        err = errors.New("connection is closed")    }    return}// å†™å…¥ä¸€æ¡æ¶ˆæ¯func (c *Connection) WriteOne(msg []byte) (err error) {    select {    case (*c).outputStream &lt;- msg:    case &lt;-(*c).signalCloseLoopChan:        err = errors.New("connection is closed")    }    return}// å…³é—­è¿æ¥å¯¹è±¡func (c *Connection) Close() {    _ = (*c).conn.Close()    (*c).lock.Lock()    if !(*c).isClosed {        close((*c).signalCloseLoopChan)    }    (*c).lock.Unlock()}// è¯»å–å¾ªç¯func (c *Connection) readLoop() {    // ä¸åœçš„è¯»å–é•¿è¿æ¥ä¸­çš„æ¶ˆæ¯ï¼Œåªè¦å­˜åœ¨æ¶ˆæ¯å°±å°†å…¶æ”¾åˆ°é˜Ÿåˆ—ä¸­    for {        _, bytes, err := (*c).conn.ReadMessage()        if err != nil {            (*c).Close()        }        select {        case &lt;-(*c).signalCloseLoopChan:            (*c).Close()        case (*c).inputStream &lt;- bytes:        }    }}// å†™å…¥å¾ªç¯func (c *Connection) writeLoop() {    // åªè¦é˜Ÿåˆ—ä¸­å­˜åœ¨æ¶ˆæ¯ï¼Œå°±å°†å…¶å†™å…¥    var data []byte    for {        select {        case data = &lt;-(*c).outputStream:        case &lt;-(*c).signalCloseLoopChan:            (*c).Close()        }        err := (*c).conn.WriteMessage(websocket.TextMessage, data)        if err != nil {            _ = (*c).conn.Close()        }    }}</code></pre><p>è‡³æ­¤ï¼Œä½ å·²ç»å­¦ä¼šäº†å¦‚ä½•ä½¿ç”¨Goæ„å»ºWebSocketæœåŠ¡ã€‚</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Go','WebSocket','æ„å»ºåƒä¸‡çº§'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>