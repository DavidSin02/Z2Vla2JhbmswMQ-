<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Solidity位运算：与、或、非、异或、移位 | 极客快訊</title><meta property="og:title" content="Solidity位运算：与、或、非、异或、移位 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/2e0e43e516f54a7cb3c200fc7cc664e5"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b120c17.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b120c17.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b120c17.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b120c17.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b120c17.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b120c17.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b120c17.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b120c17.html><meta property="article:published_time" content="2020-10-29T21:00:27+08:00"><meta property="article:modified_time" content="2020-10-29T21:00:27+08:00"><meta name=Keywords content><meta name=description content="Solidity位运算：与、或、非、异或、移位"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/b120c17.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Solidity位运算：与、或、非、异或、移位</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p class=ql-align-justify>Solidity位操作运算有助于缩减以太坊交易的成本。本文介绍以太坊智能合约开发语言 Solidity中的位操作运算符，以及如何使用这些Solidity位操作符对合约数据执 行位操作运算，例如与、或、非、异或等，同时也介绍如何实现Soldity不支持 的取反、移位等操作。</p><p class=ql-align-justify><strong>1、Solidity位操作概述</strong></p><p class=ql-align-justify>以太坊是一台世界计算机， 虽然可能是最昂贵的那台。由于存储是最消耗gas的操作，因此时不时地需要精打细算， 进行一些位操作，就像汇编开发者在芯片固件编程时所做的一样。这可以让你对数据有 更多的控制并最终缩减交易成本。</p><p class=ql-align-justify>以太坊智能合约开发语言Solidity支持基本的位操作运算，虽然目前还不支持左/右 位移。幸运的是有等价的算数运<span>算。</span></p><p class=ql-align-justify>所有的位操作都是逐位执行的，就和你比较两个不同的数组成员一样，都会 按顺序逐位操作。注意：在位操作中0和1,分别对应false和true。</p><p class=ql-align-justify>出于简化考虑，我将使用bytes1类型（和byte一样），不过更长的数据类型也是 同样的原理。在下面的例子中我们都是用相同的两个变量a和b：</p><div class=pgc-img><img alt=Solidity位运算：与、或、非、异或、移位 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2e0e43e516f54a7cb3c200fc7cc664e5><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>在Solidity中，我们使用16进制表示的值来初始化这两个变量：</p><pre class=ql-align-right>12bytes1 a = 0xb5; // [10110101]bytes1 b = 0x56; // [01010110]</pre><p class=ql-align-justify><strong>2、与运算/AND</strong></p><p class=ql-align-justify>两个变量中都是1的位，其与计算/AND结果位才是1，否则都是0：</p><div class=pgc-img><img alt=Solidity位运算：与、或、非、异或、移位 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/720949ec447648719549dac034d938dc><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>上图中黄色部分表示计算结果，可以看到只有当两个输入变量a和b的对应位 都是1时，结果的响应位才是1。</p><p class=ql-align-justify>在Solidity中，与操作符是&：</p><pre class=ql-align-right>1a &amp; b; // 结果: 0x14 [00010100]</pre><p class=ql-align-justify><strong>3、或运算/OR</strong></p><p class=ql-align-justify>在计算或操作结果的某一位时，只要任何一个输入变量的对应位是1， 那么结果都是1：</p><div class=pgc-img><img alt=Solidity位运算：与、或、非、异或、移位 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/992876f0d4004bd78ace283ad3bee56c><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>在Solidity中，或操作符是|：</p><pre class=ql-align-right>1a | b; // 结果: 0xf7 [11110111]</pre><p class=ql-align-justify><strong>4、异或运算/XOR</strong></p><p class=ql-align-justify>在计算异或运算结果的某一位时，只有当两个输入变量的对应位不一致 时，结果才是1：</p><div class=pgc-img><img alt=Solidity位运算：与、或、非、异或、移位 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5ffcca8ba0214901a8e7cb31990e3e4e><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>在Solidity中，异或操作符时^：</p><pre class=ql-align-right>1a ^ b; // 结果: 0xe3 [11100011]</pre><p class=ql-align-justify>异或运算有趣的一点是，你把结果和任意一个输入变量再做异或运算， 就可以得到另一个输入变量：</p><pre class=ql-align-right>10xe3 ^ a; // 结果: 0x56 == b [01010110]</pre><p class=ql-align-justify><strong>5、非运算/NEG</strong></p><p class=ql-align-justify>非运算是单目运算，只需要一个输入变量，它就是取反，原来是1结果 就是0，原来是0结果就是1：</p><div class=pgc-img><img alt=Solidity位运算：与、或、非、异或、移位 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8665ed03a5f84d83b3b7daf53f68004e><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>Solidity本身并不支持非运算，不过幸运的是你可以将变量与全1值 异或，就得到同样的结果：</p><pre class=ql-align-right>1a ^ 0xff; // Result: 0x4a [01001010]</pre><p class=ql-align-justify><strong>6、移位运算/SHIFT</strong></p><p class=ql-align-justify>位移运算指的是向左或向右移动输入变量的位。</p><p class=ql-align-justify>让我们先用十进制数来举个例子。例如对于下面的数值：</p><pre class=ql-align-right>100001230</pre><p class=ql-align-justify>向左位移3位就得到：</p><pre class=ql-align-right>101230000</pre><p class=ql-align-justify>换句话说，向左移动3位其实就是将原来的数乘以10的3次方。</p><p class=ql-align-justify>同样，如果我们继续向右移动4位，结果就和将输入变量除以10的4次方一样：</p><pre class=ql-align-right>100000123</pre><p class=ql-align-justify>上面的原理对于二进制移位运算也是适用的，因此当我们向左 移N位时，就等价于乘以2的N次方；向右移M位时，就等价于除以2 的M次方。</p><p class=ql-align-justify>由于Solidity目前不支持移位运算，因此我们需要借助于算数运算 来实现同样的效果。</p><p class=ql-align-justify><strong>6.1 左移位</strong></p><div class=pgc-img><img alt=Solidity位运算：与、或、非、异或、移位 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/feeafb259f464397a4f14b9e770a3a8d><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>示例代码如下：</p><pre class=ql-align-right>1234var n = 3; var aInt = uint8(a); // Converting bytes1 into 8 bit integervar shifted = aInt * 2 ** n;bytes1(shifted); // Back to bytes. Result: 0xa8 [10101000]</pre><p class=ql-align-justify><strong>6.2 右移位</strong></p><div class=pgc-img><img alt=Solidity位运算：与、或、非、异或、移位 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b82498812cb74b7d932a8b003d698fe1><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>示例代码如下：</p><pre class=ql-align-right>1234var n = 2; var aInt = uint8(a); // Converting bytes1 into 8 bit integervar shifted = aInt / 2 ** n;bytes1(shifted); // Back to bytes. Result: 0x2d [00101101]</pre><p class=ql-align-justify><strong>7、提取前N位</strong></p><p class=ql-align-justify>我们可以使用与操作来提取变量的前N位，方法就是创建一个掩码变量， 其前N位都是1：</p><div class=pgc-img><img alt=Solidity位运算：与、或、非、异或、移位 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0e5fc762f2bc47ffa5d36605d9eeb3d7><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>示例代码如下：</p><pre class=ql-align-right>1234var n = 5;var nOnes = bytes1(2 ** n - 1); // Creates 5 1svar mask = shiftLeft(nOnes, 8 - n); // Shift left by 3 positionsa &amp; mask; // Result: 0xb0 [10110000]</pre><p class=ql-align-justify><strong>8、提取后N位</strong></p><p class=ql-align-justify>利用对2取模计算就可以提取变量的后N位，例如：</p><pre class=ql-align-right>123var n = 5;var lastBits = uint8(a) % 2 ** n;bytes1(lastBits); // Result: 0x15 [00010101]</pre><p class=ql-align-justify><strong>9、数据压缩</strong></p><p class=ql-align-justify>有了上面的基础，我们就可以使用更少的存储空间来减少交易成本。 例如，假设有两个变量其实都是只利用了4位，那么我们可以将其 压缩到一个变量里：</p><div class=pgc-img><img alt=Solidity位运算：与、或、非、异或、移位 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/05d0f2f71ec9419eaba8de58dfdfab8e><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>示例代码如下：</p><pre class=ql-align-right>123bytes1 c = 0x0d;bytes1 d = 0x07;var result = shiftLeft(c, 4) | d; // 0xd7 [11010111]</pre><p class=ql-align-justify><strong>完整源代码</strong></p><p class=ql-align-justify>下面是本文内容的完整源代码：</p><pre class=ql-align-right>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061contract BitsAndPieces {  function and(bytes1 a, bytes1 b) returns (bytes1) { return a &amp; b; }  function or(bytes1 a, bytes1 b) returns (bytes1) { return a | b; }  function xor(bytes1 a, bytes1 b) returns (bytes1) { return a ^ b; }  function negate(bytes1 a) returns (bytes1) { return a ^ allOnes(); }  function shiftLeft(bytes1 a, uint8 n) returns (bytes1) { var shifted = uint8(a) * 2 ** n; return bytes1(shifted); }  function shiftRight(bytes1 a, uint8 n) returns (bytes1) { var shifted = uint8(a) / 2 ** n; return bytes1(shifted); }  function getFirstN(bytes1 a, uint8 n) returns (bytes1) { var nOnes = bytes1(2 ** n - 1); var mask = shiftLeft(nOnes, 8 - n); // Total 8 bits return a &amp; mask; }   function getLastN(bytes1 a, uint8 n) returns (bytes1) { var lastN = uint8(a) % 2 ** n; return bytes1(lastN); }   // Sets all bits to 1 function allOnes() returns (bytes1) { return bytes1(-1); // 0 - 1, since data type is unsigned, this results in all 1s. }  // Get bit value at position function getBit(bytes1 a, uint8 n) returns (bool) { return a &amp; shiftLeft(0x01, n) != 0; }  // Set bit value at position function setBit(bytes1 a, uint8 n) returns (bytes1) { return a | shiftLeft(0x01, n); }  // Set the bit into state "false" function clearBit(bytes1 a, uint8 n) returns (bytes1) { bytes1 mask = negate(shiftLeft(0x01, n)); return a &amp; mask; } }</pre><p class=ql-align-center>原文：Solidity位操作 - 汇智网</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Solidity','位运算','移位'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>