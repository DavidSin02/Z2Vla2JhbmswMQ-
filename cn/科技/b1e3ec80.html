<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ZooKeeper很简单，整体结构文件系统很相似 | 极客快訊</title><meta property="og:title" content="ZooKeeper很简单，整体结构文件系统很相似 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/c56b8c014ddb473898ca1be9d222aee7"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b1e3ec80.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b1e3ec80.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b1e3ec80.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b1e3ec80.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b1e3ec80.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b1e3ec80.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b1e3ec80.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b1e3ec80.html><meta property="article:published_time" content="2020-11-14T21:06:33+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:33+08:00"><meta name=Keywords content><meta name=description content="ZooKeeper很简单，整体结构文件系统很相似"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/b1e3ec80.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ZooKeeper很简单，整体结构文件系统很相似</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p class=ql-align-justify>作者：Java3y</p><p class=ql-align-justify>原文：转载自微信公众号，Java3y</p><h1 class=ql-align-justify><strong>前言</strong></h1><blockquote>只有光头才能变强。文本已收录至我的GitHub仓库，欢迎Star：https://github.com/ZhongFuCheng3y/3y</blockquote><p class=ql-align-justify>上次写了一篇 什么是消息队列？以后，本来想入门一下Kafka的(装一下环境、看看Kafka一些概念啥的)。后来发现Kafka用到了ZooKeeper，而我又对ZooKeeper不了解，所以想先来学学什么是ZooKeeper，再去看看什么是Kafka。</p><p class=ql-align-justify>ZooKeeper相信大家已经听过这个词了，不知道大家对他了解多少呢？我第一次听到ZooKeeper的时候是在学Eureka的时候（外行人都能看懂的SpringCloud，错过了血亏！），同样ZooKeeper也可以作为<strong>注册中心</strong>。</p><p class=ql-align-justify>后面听到ZooKeeper的时候，是因为ZooKeeper可以作为<strong>分布式锁</strong>的一种实现。</p><p class=ql-align-justify>直至在了解Kafka的时候，发现Kafka也需要依赖ZooKeeper。Kafka使用ZooKeeper<strong>管理自己的元数据配置</strong>。</p><p class=ql-align-justify>这篇文章来写写我学习ZooKeeper的笔记，如果有错的地方希望大家可以在评论区指出。</p><h1 class=ql-align-justify><strong>一、什么是ZooKeeper</strong></h1><p class=ql-align-justify>从上面我们也可以发现，好像哪都有ZooKeeper的身影，那什么是ZooKeeper呢？我们先去<strong>官网</strong>看看介绍：</p><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c56b8c014ddb473898ca1be9d222aee7><p class=pgc-img-caption></p></div><p>官网对ZooKeeper的介绍</p><p class=ql-align-justify>官网还有另一段话：</p><blockquote>ZooKeeper: A Distributed Coordination Service for Distributed Applications</blockquote><p class=ql-align-justify>相比于官网的介绍，我其实更喜欢<strong>Wiki</strong>中对ZooKeeper的介绍：</p><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/39c8db5e5c3b499293938c4c700158c3><p class=pgc-img-caption></p></div><p>wiki介绍ZooKeeper</p><p class=ql-align-justify>(留下不懂英语的泪水)</p><p class=ql-align-justify>我简单概括一下：</p><ul><li class=ql-align-justify>ZooKeeper主要<strong>服务于分布式系统</strong>，可以用ZooKeeper来做：统一配置管理、统一命名服务、分布式锁、集群管理。</li><li class=ql-align-justify>使用分布式系统就无法避免对节点管理的问题(需要实时感知节点的状态、对节点进行统一管理等等)，而由于这些问题处理起来可能相对麻烦和提高了系统的复杂性，ZooKeeper作为一个能够<strong>通用</strong>解决这些问题的中间件就应运而生了。</li></ul><p class=ql-align-justify><br></p><h1 class=ql-align-justify><strong>二、为什么ZooKeeper能干这么多？</strong></h1><p class=ql-align-justify>从上面我们可以知道，可以用ZooKeeper来做：统一配置管理、统一命名服务、分布式锁、集群管理。</p><ul><li class=ql-align-justify>这里我们<strong>先</strong>不管统一配置管理、统一命名服务、分布式锁、集群管理每个具体的含义(后面会讲)</li></ul><p class=ql-align-justify><br></p><p class=ql-align-justify>那为什么ZooKeeper可以干那么多事？来看看ZooKeeper究竟是何方神物，在Wiki中其实也有提到：</p><blockquote>ZooKeeper nodes store their data in a hierarchical name space, much like a file system or a tree data structure</blockquote><p class=ql-align-justify>ZooKeeper的数据结构，跟Unix文件系统非常类似，可以看做是一颗<strong>树</strong>，每个节点叫做<strong>ZNode</strong>。每一个节点可以通过<strong>路径</strong>来标识，结构图如下：</p><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ce6b4cc490384410b87ac3a8464aecbb><p class=pgc-img-caption></p></div><p>ZooKeeper结构图</p><p class=ql-align-justify>那ZooKeeper这颗"树"有什么特点呢？？ZooKeeper的节点我们称之为<strong>Znode</strong>，Znode分为<strong>两种</strong>类型：</p><ul><li class=ql-align-justify><strong>短暂/临时(Ephemeral)</strong>：当客户端和服务端断开连接后，所创建的Znode(节点)<strong>会自动删除</strong></li><li class=ql-align-justify><strong>持久(Persistent)</strong>：当客户端和服务端断开连接后，所创建的Znode(节点)<strong>不会删除</strong></li></ul><blockquote>ZooKeeper和Redis一样，也是C/S结构(分成客户端和服务端)</blockquote><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5ec11ca51968485996ae5a75e490720b><p class=pgc-img-caption></p></div><p>Znode和Znode的类型</p><p class=ql-align-justify><strong>2.1 监听器</strong></p><p class=ql-align-justify>在上面我们已经简单知道了ZooKeeper的数据结构了，ZooKeeper还配合了<strong>监听器</strong>才能够做那么多事的。</p><p class=ql-align-justify><strong>常见</strong>的监听场景有以下两项：</p><ul><li class=ql-align-justify>监听Znode节点的<strong>数据变化</strong></li><li class=ql-align-justify>监听子节点的<strong>增减变化</strong></li></ul><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e161e661de364764926b23b524c5e5fe><p class=pgc-img-caption></p></div><p>监听Znode节点的数据有无变化</p><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/802b159ea98743ca9f5cd9fa052f1ef0><p class=pgc-img-caption></p></div><p>监听子节点的增减变化</p><p class=ql-align-justify>没错，通过<strong>监听+Znode节点(持久/短暂[临时])</strong>，ZooKeeper就可以玩出这么多花样了。</p><h1 class=ql-align-justify><strong>三、ZooKeeper是怎么做到的？</strong></h1><p class=ql-align-justify>下面我们来看看用ZooKeeper怎么来做：统一配置管理、统一命名服务、分布式锁、集群管理。</p><p class=ql-align-justify><strong>3.1 统一配置管理</strong></p><p class=ql-align-justify>比如我们现在有三个系统A、B、C，他们有三份配置，分别是ASystem.yml、BSystem.yml、CSystem.yml，然后，这三份配置又非常类似，很多的配置项几乎都一样。</p><ul><li class=ql-align-justify>此时，如果我们要改变其中一份配置项的信息，很可能其他两份都要改。并且，改变了配置项的信息<strong>很可能就要重启系统</strong></li></ul><p class=ql-align-justify><br></p><p class=ql-align-justify>于是，我们希望把ASystem.yml、BSystem.yml、CSystem.yml相同的配置项抽取出来成一份<strong>公用</strong>的配置common.yml，并且即便common.yml改了，也不需要系统A、B、C重启。</p><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/b0c3b512ba9d45e5933426c2c65dd98c><p class=pgc-img-caption></p></div><p>系统A、B、C都使用着这份配置</p><p class=ql-align-justify>做法：我们可以将common.yml这份配置放在ZooKeeper的Znode节点中，系统A、B、C监听着这个Znode节点有无变更，如果变更了，<strong>及时</strong>响应。</p><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7473704d9f204a7198bfd49db9889b52><p class=pgc-img-caption></p></div><p>系统A、B、C监听着ZooKeeper的节点，一旦common.yml内容有变化，及时响应</p><p class=ql-align-justify>参考资料：</p><ul><li class=ql-align-justify>基于zookeeper实现统一配置管理</li><li class="ql-align-justify ql-indent-1">https://blog.csdn.net/u011320740/article/details/78742625</li></ul><p class=ql-align-justify><br></p><p class=ql-align-justify><strong>3.2 统一命名服务</strong></p><p class=ql-align-justify>统一命名服务的理解其实跟<strong>域名</strong>一样，是我们为这某一部分的资源给它<strong>取一个名字</strong>，别人通过这个名字就可以拿到对应的资源。</p><p class=ql-align-justify>比如说，现在我有一个域名www.java3y.com，但我这个域名下有多台机器：</p><ul><li class=ql-align-justify>192.168.1.1</li><li class=ql-align-justify>192.168.1.2</li><li class=ql-align-justify>192.168.1.3</li><li class=ql-align-justify>192.168.1.4</li></ul><p class=ql-align-justify>别人访问www.java3y.com即可访问到我的机器，而不是通过IP去访问。</p><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/62df0c30125c4c38b609cecd00bc4217><p class=pgc-img-caption></p></div><p>通过名称去访问旗下的IP</p><p class=ql-align-justify><strong>3.3 分布式锁</strong></p><p class=ql-align-justify>锁的概念在这我就不说了，如果对锁概念还不太了解的同学，可参考下面的文章</p><ul><li class=ql-align-justify>Java锁？分布式锁？乐观锁？行锁？</li></ul><p class=ql-align-justify><br></p><p class=ql-align-justify>我们可以使用ZooKeeper来实现分布式锁，那是怎么做的呢？？下面来看看：</p><p class=ql-align-justify>系统A、B、C都去访问/locks节点</p><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5865d5b00c1849e193d27a067601033d><p class=pgc-img-caption></p></div><p>系统A、B、C都去访问locks节点</p><p class=ql-align-justify>访问的时候会创建<strong>带顺序号的临时/短暂</strong>(EPHEMERAL_SEQUENTIAL)节点，比如，系统A创建了id_000000节点，系统B创建了id_000002节点，系统C创建了id_000001节点。</p><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4b36dd8442c24edaa0da39a975010170><p class=pgc-img-caption></p></div><p>创建出临时带顺序号的节点</p><p class=ql-align-justify>接着，拿到/locks节点下的所有子节点(id_000000,id_000001,id_000002)，<strong>判断自己创建的是不是最小的那个节点</strong></p><ul><li class=ql-align-justify>如果是，则拿到锁。</li><li class="ql-align-justify ql-indent-1">释放锁：执行完操作后，把创建的节点给删掉</li><li class=ql-align-justify>如果不是，则监听比自己要小1的节点变化</li></ul><p class=ql-align-justify>举个例子：</p><ul><li class=ql-align-justify>系统A拿到/locks节点下的所有子节点，经过比较，发现自己(id_000000)，是所有子节点最小的。所以得到锁</li><li class=ql-align-justify>系统B拿到/locks节点下的所有子节点，经过比较，发现自己(id_000002)，不是所有子节点最小的。所以监听比自己小1的节点id_000001的状态</li><li class=ql-align-justify>系统C拿到/locks节点下的所有子节点，经过比较，发现自己(id_000001)，不是所有子节点最小的。所以监听比自己小1的节点id_000000的状态</li><li class=ql-align-justify>……</li><li class=ql-align-justify>等到系统A执行完操作以后，将自己创建的节点删除(id_000000)。通过监听，系统C发现id_000000节点已经删除了，发现自己已经是最小的节点了，于是顺利拿到锁</li><li class=ql-align-justify>….系统B如上</li></ul><p class=ql-align-justify><strong>3.4集群状态</strong></p><p class=ql-align-justify>经过上面几个例子，我相信大家也很容易想到ZooKeeper是怎么"<strong>感知</strong>"节点的动态新增或者删除的了。</p><p class=ql-align-justify>还是以我们三个系统A、B、C为例，在ZooKeeper中创建<strong>临时节点</strong>即可：</p><div class=pgc-img><img alt=ZooKeeper很简单，整体结构文件系统很相似 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/88b2a3aaee404fb2ab4aac969a76e025><p class=pgc-img-caption></p></div><p>各维护一个临时节点</p><p class=ql-align-justify>只要系统A挂了，那/groupMember/A这个节点就会删除，通过<strong>监听</strong>groupMember下的子节点，系统B和C就能够感知到系统A已经挂了。(新增也是同理)</p><p class=ql-align-justify>除了能够感知节点的上下线变化，ZooKeeper还可以实现<strong>动态选举Master</strong>的功能。(如果集群是主从架构模式下)</p><p class=ql-align-justify>原理也很简单，如果想要实现动态选举Master的功能，Znode节点的类型是带<strong>顺序号的临时节点</strong>(EPHEMERAL_SEQUENTIAL)就好了。</p><ul><li class=ql-align-justify>Zookeeper会每次选举最小编号的作为Master，如果Master挂了，自然对应的Znode节点就会删除。然后让<strong>新的最小编号作为Master</strong>，这样就可以实现动态选举的功能了。</li></ul><p class=ql-align-justify><br></p><h1 class=ql-align-justify><strong>最后</strong></h1><p class=ql-align-justify>这篇文章主要讲解了ZooKeeper的入门相关的知识，ZooKeeper通过<strong>Znode的节点类型+监听机制</strong>就实现那么多好用的功能了！</p><p class=ql-align-justify>当然了，ZooKeeper要考虑的事没那么简单的，后面有机会深入的话，我还会继续分享，希望这篇文章对大家有所帮助~</p><p><strong>Java识堂</strong>，一个高原创，高收藏，有干货的<strong>微信公众号，</strong>一起成长，一起进步，欢迎关注</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ZooKeeper','简单','整体'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>