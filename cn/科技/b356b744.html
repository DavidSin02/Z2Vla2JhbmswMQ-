<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Pytest官方教程-04-断言的编写和报告 | 极客快訊</title><meta property="og:title" content="Pytest官方教程-04-断言的编写和报告 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b356b744.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b356b744.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b356b744.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b356b744.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b356b744.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b356b744.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b356b744.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b356b744.html><meta property="article:published_time" content="2020-11-14T21:03:15+08:00"><meta property="article:modified_time" content="2020-11-14T21:03:15+08:00"><meta name=Keywords content><meta name=description content="Pytest官方教程-04-断言的编写和报告"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/b356b744.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Pytest官方教程-04-断言的编写和报告</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>[cp]Pytest官方教程-04-断言的编写和报告</p><p>断言的编写和报告</p><p>使用assert语句进行断言</p><p>pytest允许你使用标准的Pythonassert断言语句来验证测试中的期望结果和实际结果。 例如，你可以编写以下内容：</p><p># test_assert1.py文件内容 def f(): return 3 def test_function(): assert f() == 4</p><p>来断言你的函数返回一个特定的值。 如果此断言失败，你将看到函数调用的返回值：</p><p>$ pytest test_assert1.py =========================== test session starts ============================ platform linux -- Python 3.x.y, pytest-3.x.y, py-1.x.y, pluggy-0.x.y rootdir: $REGENDOC_TMPDIR, inifile: collected 1 item test_assert1.py F [100%] ================================= FAILURES ================================= ______________________________ test_function _______________________________</p><p>def test_function():</p><p>> assert f() == 4</p><p>E assert 3 == 4</p><p>E + where 3 = f()</p><p>test_assert1.py:5: AssertionError =========================</p><p>1 failed in 0.12 seconds =========================</p><p>pytest支持显示常见的包括调用，属性，比较以及二元和一元运算符子表达式的值 （参考：pytest执行Python测试失败报告示例）。 你可以在不使用繁琐的Python惯用构造样板代码的同时，不丢失断言失败的对比信息（内省信息）。</p><p>当然，你也可以像下面所示，指定断言失败的返回消息：</p><p>assert a % 2 == 0, "值为奇数，应为偶数"</p><p>这样将不会断言失败对比信息（内省信息），而只简单地在追溯信息中显示你指定的失败返回信息。</p><p>有关断言内省的更多信息，请参阅高级断言内省。</p><p>异常断言</p><p>你可以像如下所示，使用pytest.raises作为上下文管理器来进行异常断言：</p><p>import pytest def test_zero_division(): with pytest.raises(ZeroDivisionError): 1 / 0</p><p>如果需要访问实际的异常信息，你可以使用：</p><p>def test_recursion_depth():</p><p>with pytest.raises(RuntimeError) as excinfo:</p><p>def f():</p><p>f() f() assert 'maximum recursion' in str(excinfo.value)</p><p>excinfo是一个ExceptionInfo实例，它是实际异常的装饰器。 其主要属性有.type，.value及.traceback三种</p><p>版本3.0已修改</p><p>在上下文管理器中，你可以使用参数message来指定自定义失败信息：</p><p>>>> with raises(ZeroDivisionError, message="Expecting ZeroDivisionError"): ... pass ... Failed: Expecting ZeroDivisionError</p><p>如果你想编写适用于Python 2.4的测试代码，你还可以使用其他两种方法来测试预期的异常：</p><p>pytest.raises(ExpectedException, func, *args, **kwargs) pytest.raises(ExpectedException, "func(*args, **kwargs)")</p><p>两者都可以对带任意参数的函数，断言是否出现了期望的异常：ExpectedException。 即使没有异常或出现了不同的异常，报告生成器也能输出一些有用的断言信息。</p><p>注意，也可以为pytest.mark.xfail指定一个“raises”参数，当引发异常时标记用例失败：</p><p>@pytest.mark.xfail(raises=IndexError)</p><p>def test_f():</p><p>f()</p><p>对于你在代码中故意设置的异常，使用pytest.raises断言更加好用，而将@ pytest.mark.xfail与check函数一起使用对于已知未修复或依赖中的bug会更好。</p><p>此外，上下文管理器表单接受match关键字参数来测试正则表达式匹配中的异常（如unittest中的TestCase.assertRaisesRegexp方法）：</p><p>import pytest def myfunc():</p><p>raise ValueError("Exception 123 raised")</p><p>def test_match():</p><p>with pytest.raises(ValueError, match=r'.* 123 .*'): myfunc()</p><p>match变量后的正则表达式与使用re.search函数来进行匹配一致。 因此在上面的例子中，match ='123'不会引发异常。</p><p>警示断言</p><p>2.8版本新增</p><p>你可以使用pytest.warns检查代码是否引发了特定警告。</p><p>使用上下文对比</p><p>2.0版本新增</p><p>pytest可以在断言的比较中提供丰富的上下文信息。 例如：</p><p># test_assert2.py文件内容 def test_set_comparison():</p><p>set1 = set("1308")</p><p>set2 = set("8035")</p><p>assert set1 == set2</p><p>当你运行这个模块后</p><p>$ pytest test_assert2.py =========================== test session starts ============================ platform linux -- Python 3.x.y, pytest-3.x.y, py-1.x.y, pluggy-0.x.y rootdir: $REGENDOC_TMPDIR, inifile:</p><p>collected 1 item test_assert2.py F [100%] ================================= FAILURES ================================= ___________________________ test_set_comparison ____________________________</p><p>def test_set_comparison():</p><p>set1 = set("1308")</p><p>set2 = set("8035")</p><p>> assert set1 == set2</p><p>E AssertionError: assert {'0', '1', '3', '8'} == {'0', '3', '5', '8'}</p><p>E Extra items in the left set:</p><p>E '1'</p><p>E Extra items in the right set:</p><p>E '5'</p><p>E Use -v to get the full diff test_assert2.py:5: AssertionError =========================</p><p>1 failed in 0.12 seconds =========================</p><p>对大量用例进行了特定对比：</p><p>长字符串断言：显示上下文差异</p><p>长序列断言：显示第一个失败的索引</p><p>字典断言：显示不同的key-value对</p><p>有关更多示例，请参阅报告样例。</p><p>自定义断言对比信息</p><p>可以通过实现hook方法pytest_assertrepr_compare来在断言结果中添加你自己的详细说明信息。</p><p>pytest_assertrepr_compare(config, op, left, right) [源码]</p><p>返回失败断言表达式中的对比信息。</p><p>如果没有自定义对比信息，则返回None，否则返回一列字符串。 字符串将由换行符连接，但字符串中的任何换行符都将被转义。 请注意，除第一行外的所有行都将略微缩进，目的是将第一行作为摘要。</p><p>参数： config(pytest.config.Config* - pytest config 对象</p><p>例如，在conftest.py文件中添加以下钩子方法，可以为Foo对象提供了附加对比信息：</p><p># conftest.py内容 from test_foocompare import Foo def pytest_assertrepr_compare(op, left, right): if isinstance(left, Foo) and isinstance(right, Foo) and op == "==": return ['Foo实例对比:', ' 值: %s != %s' % (left.val, right.val)]</p><p>现在，在测试模块使用</p><p># test_foocompare.py内容 class Foo(object): def __init__(self, val): self.val = val def __eq__(self, other): return self.val == other.val def test_compare(): f1 = Foo(1) f2 = Foo(2) assert f1 == f2</p><p>运行这个测试模块你可以看到conftest.py文件中定义的自定义输出：</p><p>$ pytest -q test_foocompare.py</p><p>F</p><p>================================= FAILURES ================================= _______________________________ test_compare _______________________________</p><p>def test_compare():</p><p>f1 = Foo(1)</p><p>f2 = Foo(2)</p><p>> assert f1 == f2</p><p>E assert Foo实例对比:</p><p>E 值: 1 != 2</p><p>test_foocompare.py:11: AssertionError</p><p>1 failed in 0.12 seconds</p><p>高级断言内省</p><p>2.1版本新功能</p><p>报告有关失败断言的详细信息是通过在运行之前重写assert语句来实现的。 重写的断言语句将内省信息放入断言失败消息中。 pytest只重写测试收集过程直接发现的测试模块中的assert断言，因此在支持模块（非测试模块）中的断言，不会被重写。</p><p>你可以在导入模块前通过调用register_assert_rewrite手动启用断言重写（比如可以在conftest.py这样使用）。</p><p>注意</p><p>pytest通过使用导入hook方法写入新的pyc文件来重写测试模块。 通常这种结构比较清晰。 但是，如果你混乱导入，导入的hook方法可能会受到干扰。</p><p>如果是这种情况，您有两种选择：</p><p>通过将字符串PYTEST_DONT_REWRITE添加到其docstring来禁用特定模块的重写。</p><p>使用--assert = plain禁用所有模块的重写。</p><p>此外，如果无法写入新的.pyc文件（如在只读文件系统或zip文件中），重写将无提示失败。</p><p>有关进一步的信息，课参阅：本杰明彼得森写的pytest的新断言改写的幕后故事。</p><p>版本2.1新功能：添加断言重写作为备用内省技术。</p><p>版本2.1更改：引入--assert选项。 弃用--no-assert和--nomagic。</p><p>版本3.0版更改：删除--no-assert和--nomagic选项。 删除--assert = reinterp`选项。</p><p>有疑问加老师微信：xiaowanzi02620[/cp]</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Pytest','04','断言'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>