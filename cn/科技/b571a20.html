<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 | 极客快訊</title><meta property="og:title" content="抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/73b4278c40774903a2f0cfb0f6752925"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b571a20.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b571a20.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b571a20.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b571a20.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b571a20.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b571a20.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b571a20.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b571a20.html><meta property="article:published_time" content="2020-10-29T21:06:37+08:00"><meta property="article:modified_time" content="2020-10-29T21:06:37+08:00"><meta name=Keywords content><meta name=description content="抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/b571a20.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><br></p><p>目录</p><ul><li>抓包过程</li><li>以太网帧（也叫MAC帧）首部分析</li><li>IP数据包首部分析</li></ul><p><br></p><h2 class=pgc-h-arrow-right><strong>抓包过程</strong></h2><p>使用了 Wireshark 进行抓包，用两个最常用的 curl 和 ping 命令来演示抓包情况，开启抓包。</p><pre><code>## 先访问我自己的网站首页 curl https://zengzhiqin.kuaizhan.com ## 再查看我自己网站的地址 ping https://zengzhiqin.kuaizhan.com</code></pre><p>Wireshark根据 ping 命令得到的地址进行条件过滤，得到上面两个命令所得到的包，主要有 TCP（https基于tcp协议）协议和 ICMP（ping命令是基于 ICMP 协议）协议的包，如下图所示：</p><div class=pgc-img><img alt=抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/73b4278c40774903a2f0cfb0f6752925><p class=pgc-img-caption></p></div><p>抓包分析</p><h2 class=pgc-h-arrow-right><strong>以太网帧（也叫MAC帧）首部分析</strong></h2><div class=pgc-img><img alt=抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/be0e0bee9f4948139472d333af8f334b><p class=pgc-img-caption></p></div><p>MAC帧 = 6字节源mac地址 + 6字节目标mac地址 + 2字节类型 + 4字节帧检验序列FCS + 数据长度（46~1500字节）</p><p>MAC帧长度是需要在64~1518字节之间的，太长或者太短都是无效的帧。</p><p>IP数据包过来了，MAC 层会给分别使用6个字节为其加上“源mac地址”和“目标mac地址”，并且花2个字节为其指明是哪种类型的IP数据报(目前有IPV4,IPV6两种类型)，4字节“FCS帧检验序列” 负责检验帧是否有效，然后就是46~1500字节之间的IP数据报长度。</p><p>抓包里面的mac帧内容如下，选取了ping的reply类型包信息进行查看分析：</p><div class=pgc-img><img alt=抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/daea57f6e214480aa184d7e2f566378a><p class=pgc-img-caption></p></div><p>以太网帧</p><p>小补充：帧检验序列即FCS（frame check sequence）, 让接收帧的网卡或接口判断是否发生了错误。</p><p>判断过程如下：发送网卡利用多项式计算，称循环冗余校验（CRC),将计算结果写入FCS字段，接收方收到这个帧，对其做相同的CRC计算。如果计算结果与接收的FCS字段相同，则帧没有发生错误。如果不同，接收方就相信帧肯定发生了错误，并丢弃这个帧。</p><h2 class=pgc-h-arrow-right><strong>IP数据包首部分析</strong></h2><p>抓包得到的头部对应关系如下所示（1~31表示的bit，8bit=1byte）：</p><div class=pgc-img><img alt=抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/13bced70a3fb4ee592baafe0c60f1650><p class=pgc-img-caption></p></div><p>IP数据包头部</p><div class=pgc-img><img alt=抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/67cbf128c9ee4cc39112e27569296fb6><p class=pgc-img-caption></p></div><p>头部每个内容如下：</p><ul><li>版本： TCP/IP 协议版本，是ipv4,还是ipv6；</li><li>首部长度：告诉数据包，首部长度有多长，因为首部有变长部分（如图中可变部分，试想一下如果当初没有设计这个可变长度，是不需要设计这个“首部长度”的）；</li><li>服务类型：网络中的数据包有着急的，有不着急的，比如你和别人聊微信，这个包就比较着急了，如果你是在发邮件，那么点击了发送让他慢慢溜达过去也是没问题的。就相当于火车站排队，军属优先，残疾人优先，让列宁同志先走的意思；</li><li>总长度：首部+数据 的长度，总长度最大是2的16次方-1，即65535字节（上面讲到的数据链路层数据大小最大1500字节别忘了，除去IP首部的20个字节，数据链路层能接受的IP数据大小是1480字节，正因为这两货大小不一样，如果一个数据包大于了1480字节，网络层要把包送给数据链路层传输，才需要后面的分片）</li><li>标识：用途就是数据包分片之后可以根据标识的编号，将分片的包重新组装为一个完整数据包</li></ul><div class=pgc-img><img alt=抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8dd0e5351e3b4b2c82b7c5a93051b114><p class=pgc-img-caption></p></div><p>分片</p><ul><li>标志：3bit表示标志，计算机收到了一个包，那他咋知道这是一个完整的数据包，还只是一个分片呢，标志说看我的</li></ul><div class=pgc-img><img alt=抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d93cac3d0d1c4e8f8b0b58f090e803fa><p class=pgc-img-caption></p></div><p>此处单独截图抓包分析的标志内容，Reserved bit为保留了一位，没有进行设置；Don't fragement为1表示他是一个完整的数据包，不是一个片；More fragements为0表示这是最后一个分片，为1表示后面还有分片；</p><p>我curl的我的站点首页，内容是不多的，没有大于1500字节，所以不需要分片，如果我开启迅雷下载了一个很大的东西，那这个地方是需要分片的。</p><ul><li>片偏移：偏移量，标识数据包的第一个字节是整个数据包的第几个偏移量，此处抓包的片偏移量是0，因为他没有分片</li></ul><div class=pgc-img><img alt=抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1fbecf5deed5483b9d64e201f921cd37><p class=pgc-img-caption></p></div><p>片偏移</p><ul><li>生存时间ttl：Linux给数据包的默认ttl是64，Windows系统是128，Unix系统是255，每次过一个路由器那么ttl-1，每次经过一个路由器就要减1，ttl耗尽了那么这个包就自动消失了，防止路由里面出现了环路死循环了，包永不消失。</li><li>协议：标识这个包要交给谁来处理，如果是 tcp 或者 udp 那么就需要交给传输层处理，如果是ICMP，IGMP，OSPF那么就交给网络层来处理这个包。此处是tcp协议，协议号是6.</li></ul><div class=pgc-img><img alt=抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/064755311eb54a1291e8496b9224d11f><p class=pgc-img-caption></p></div><p>image</p><ul><li>首部检验和</li></ul><div class=pgc-img><img alt=抓包分析以太网帧和IP数据包，头部那么多东东用来干啥的，扫盲篇 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fa29ae8a00a54a6484e05f1a54572058><p class=pgc-img-caption></p></div><p>校验过程</p><ul><li>源地址和目标地址无需多说了</li><li>可选字段，填充：ipv6已经将这个可选的去掉了，因为可变就要可控，就要增大处理时间，这里是为了增大IP数据包的功能，但是实际上很少用到。</li></ul><p>网络里面时时刻刻有那么多的包，设计者们秉着绝不浪费一个 bit 的精神，每一个标志的设计都是精心设计的，这个时候包的首部就要绝对的精简了。这两个内容写完就很多了，下一篇我会写一个姊妹篇，抓包分析传输层的tcp三次牵手四次分手过程~~感谢观看。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'抓包','网帧','IP'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>