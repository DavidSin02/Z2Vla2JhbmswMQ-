<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Android ä¸Šå“ªä¸ªæ›´å¥½ï¼šé™¤ä»¥ 2 è¿˜æ˜¯ä½ç§» 1ï¼Ÿ | æå®¢å¿«è¨Š</title><meta property="og:title" content="Android ä¸Šå“ªä¸ªæ›´å¥½ï¼šé™¤ä»¥ 2 è¿˜æ˜¯ä½ç§» 1ï¼Ÿ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/RzDApJ2446C0Cb"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b5d9acd.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b5d9acd.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b5d9acd.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b5d9acd.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b5d9acd.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b5d9acd.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b5d9acd.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b5d9acd.html><meta property="article:published_time" content="2020-10-29T21:00:27+08:00"><meta property="article:modified_time" content="2020-10-29T21:00:27+08:00"><meta name=Keywords content><meta name=description content="Android ä¸Šå“ªä¸ªæ›´å¥½ï¼šé™¤ä»¥ 2 è¿˜æ˜¯ä½ç§» 1ï¼Ÿ"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/b5d9acd.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Android ä¸Šå“ªä¸ªæ›´å¥½ï¼šé™¤ä»¥ 2 è¿˜æ˜¯ä½ç§» 1ï¼Ÿ</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><img alt="Android ä¸Šå“ªä¸ªæ›´å¥½ï¼šé™¤ä»¥ 2 è¿˜æ˜¯ä½ç§» 1ï¼Ÿ" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RzDApJ2446C0Cb><p>ä½œè€… | Jake Wharton</p><p>è¯‘è€… | å­™è–‡ï¼Œè´£ç¼– | å¤•é¢œ</p><p>å¤´å›¾ | CSDNä¸‹è½½è‡ªè§†è§‰ä¸­å›½</p><p>å‡ºå“ | CSDNï¼ˆID:CSDNnewsï¼‰</p><p><strong>ä»¥ä¸‹ä¸ºè¯‘æ–‡ï¼š</strong></p><p>æˆ‘ä¸€ç›´åœ¨å°†AndroidXé›†åˆåº“ç§»æ¤åˆ°Kotlin multiplatformä¸Šï¼Œä»¥è¯•éªŒäºŒè¿›åˆ¶å…¼å®¹æ€§ã€æ€§èƒ½ã€å·¥å…·ä»¥åŠä¸åŒçš„å†…å­˜æ¨¡å‹ã€‚åº“ä¸­çš„æŸäº›æ•°æ®ç»“æ„ä½¿ç”¨äº†åŸºäºæ•°ç»„çš„äºŒå‰æ ‘æ¥å­˜å‚¨å…ƒç´ ã€‚Javaä»£ç ä¸­æœ‰å¤§é‡ä½ç§»æ¥æ›¿ä»£2çš„å¹‚çš„ä¹˜é™¤æ³•ã€‚å½“ç§»æ¤åˆ°Kotlinä¹‹åï¼Œè¿™äº›å°±æˆäº†ç•¥å¾®æœ‰ç‚¹åˆ«æ‰­çš„ä¸­ç¼€è¿ç®—ç¬¦ï¼Œå¯¼è‡´ä»£ç æ„å›¾è¿›ä¸€æ­¥è¢«æ··æ·†ã€‚</p><p>æˆ‘æ‰¾äº†äº›äººæ¥è°ƒæŸ¥å¯¹æŒ‰ä½ç§»ä½ï¼ˆbitwise shiftsï¼‰ä¸ä¹˜é™¤æ³•çš„çœ‹æ³•ï¼Œå¾ˆå¤šäººå¬è¯´è¿‡ç§»ä½æ€§èƒ½æ›´å¥½çš„ä¼ é—»ï¼Œä½†æ¯ä¸ªäººå¯¹å…¶çœŸå®æ€§ä»æŒæ€€ç–‘æ€åº¦ã€‚ä¸€äº›äººè®¤ä¸ºï¼Œä»£ç åœ¨CPUä¸Šè¿è¡Œä¹‹å‰æ‰€è§è¿‡çš„ä¸€ä¸ªç¼–è¯‘å™¨å¯ç”¨æ¥ä¼˜åŒ–è¿™ä¸ªæ¡ˆä¾‹ã€‚</p><p>ä¸ºäº†æ»¡è¶³æˆ‘çš„å¥½å¥‡å¿ƒï¼ˆéƒ¨åˆ†ä¹Ÿæ˜¯ä¸ºäº†é¿å…Kotlinçš„ä¸­ç¼€æŒ‰ä½è¿ç®—ç¬¦ï¼‰ï¼Œæˆ‘æ‰“ç®—å›ç­”å“ªä¸ªæ›´ä¼˜çš„é—®é¢˜ï¼Œä»¥åŠä¸€äº›ç›¸å…³çš„é—®é¢˜ã€‚é‚£ä¹ˆè¿™å°±å¼€å§‹å§ã€‚</p><img alt="Android ä¸Šå“ªä¸ªæ›´å¥½ï¼šé™¤ä»¥ 2 è¿˜æ˜¯ä½ç§» 1ï¼Ÿ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RT4Gwk56bt5iOJ><p></p><h1 toutiao-origin=h3>æœ‰äººä¼˜åŒ–å—ï¼Ÿ</h1><p>åœ¨ä»£ç è¿›å…¥CPUä¹‹å‰ï¼Œä¸»è¦ç»è¿‡ä¸‰ä¸ªç¼–è¯‘å™¨ï¼š`javac`/`kotlinc`ï¼ŒD8/R8ï¼Œä»¥åŠARTã€‚</p><img alt="Android ä¸Šå“ªä¸ªæ›´å¥½ï¼šé™¤ä»¥ 2 è¿˜æ˜¯ä½ç§» 1ï¼Ÿ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RzEPVHu8hK92pI><p>å®ƒä»¬éƒ½æœ‰æœºä¼šå¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œä½†å®ƒä»¬ä¼šè¿™æ ·åšå—ï¼Ÿ</p><p></p><h1 toutiao-origin=h3>javac</h1><pre><code>class Example {</code><code> static int multiply(int value) {</code><code> return value * 2;</code><code> }</code><code> static int divide(int value) {</code><code> return value / 2;</code><code> }</code><code> static int shiftLeft(int value) {</code><code> return value &lt;&lt; 1;</code><code> }</code><code> static int shiftRight(int value) {</code><code> return value &gt;&gt; 1;</code><code> }</code><code>}</code></pre><p>å¯ä»¥ä½¿ç”¨JDK14ä¸­çš„javacæ¥ç¼–è¯‘è¿™æ®µJavaä»£ç ï¼Œå¹¶é€šè¿‡javapæ¥æ˜¾ç¤ºç”Ÿæˆçš„å­—èŠ‚ç ã€‚</p><pre><code>$ javac Example.java</code><code>$ javap -c Example</code><code>Compiled from "Example.java"</code><code>class Example {</code><code> static int multiply(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_2</code><code> 2: imul</code><code> 3: ireturn</code><br><br><code> static int divide(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_2</code><code> 2: idiv</code><code> 3: ireturn</code><br><br><code> static int shiftLeft(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_1</code><code> 2: ishl</code><code> 3: ireturn</code><br><br><code> static int shiftRight(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_1</code><code> 2: ishr</code><code> 3: ireturn</code></pre><p>ä»¥ `iload_0` å¼€å¤´çš„æ¯ä¸ªæ–¹æ³•ä¼šåŠ è½½ç¬¬ä¸€ä¸ªå®å‚å€¼ï¼Œä¹‹åä¹˜æ³•å’Œé™¤æ³•éƒ½åŒ…å« `iconst_2` ï¼Œå®ƒä»¬åŠ è½½å¸¸é‡2ï¼Œç„¶ååˆ†åˆ«è¿è¡Œ `imul` æˆ–è€… `idiv` ï¼Œä»¥æ‰§è¡Œæ•´æ•°ä¹˜æ³•æˆ–æ•´æ•°é™¤æ³•ã€‚ç§»ä½æ–¹æ³•åœ¨`ishl`æˆ–`ishr`ä¹‹å‰åŠ è½½å¸¸é‡1ï¼Œåˆ†åˆ«æ‰§è¡Œæ•´æ•°å‘å·¦ç§»ä½å’Œæ•´æ•°å‘å³ç§»ä½ã€‚</p><p>è¿™é‡Œæ²¡æœ‰ä¼˜åŒ–ï¼Œä½†å¦‚æœä½ æœ‰å¯¹Javaæœ‰æ‰€äº†è§£ï¼Œå°±çŸ¥é“è¿™å¹¶ä¸æ„å¤–ã€‚`javac`å¹¶ä¸æ˜¯ä¸€ä¸ªä¼˜åŒ–ç¼–è¯‘å™¨ï¼Œå®ƒå°†å¤§éƒ¨åˆ†å·¥ä½œç•™ç»™äº†JVMä¸Šçš„è¿è¡Œæ—¶ç¼–è¯‘å™¨æˆ–è€…æå‰ç¼–è¯‘å™¨ã€‚</p><p></p><h1 toutiao-origin=h3>kotlinc</h1><pre><code>fun multiply(value: Int) = value * 2</code><code>fun divide(value: Int) = value / 2</code><code>fun shiftLeft(value: Int) = value shl 1</code><code>fun shiftRight(value: Int) = value shr 1</code></pre><p>ä½¿ç”¨Kotlin 1.4-M1ä¸­çš„`Kotlinc`å°†Kotlinç¼–è¯‘ä¸ºJavaå­—èŠ‚ç ï¼Œè¿™æ ·`javap`å·¥å…·å°±èƒ½å†æ¬¡ä½¿ç”¨ã€‚</p><pre><code>$ kotlinc Example.kt</code><code>$ javap -c ExampleKt</code><code>Compiled from "Example.kt"</code><code>public final class ExampleKt {</code><code> public static final int multiply(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_2</code><code> 2: imul</code><code> 3: ireturn</code><br><br><code> public static final int divide(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_2</code><code> 2: idiv</code><code> 3: ireturn</code><br><br><code> public static final int shiftLeft(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_1</code><code> 2: ishl</code><code> 3: ireturn</code><br><br><code> public static final int shiftRight(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_1</code><code> 2: ishr</code><code> 3: ireturn</code></pre><p>ä¸Javaçš„è¾“å‡ºç»“æœå®Œå…¨ä¸€è‡´ã€‚è¿™æ˜¯è¿ç”¨äº†KotlinåŸå§‹çš„JVMåç«¯ï¼Œä½†ä½¿ç”¨åŸºäºIRçš„åç«¯ï¼ˆé€šè¿‡`-Xuse-ir`ï¼‰ä¹Ÿèƒ½äº§ç”ŸåŒæ ·çš„è¾“å‡ºã€‚</p><p></p><h1 toutiao-origin=h3>D8</h1><p>æˆ‘ä»¬ä½¿ç”¨Kotlinç¤ºä¾‹ä¸­çš„Javaå­—èŠ‚ç è¾“å‡ºä½œä¸ºç”± `master`ï¼ˆåœ¨æ–‡æœ¬æ’°å†™æ—¶æ˜¯SHA `2a2bf622d`ï¼‰æ‰€æ„å»ºçš„æœ€æ–°D8çš„è¾“å…¥ã€‚</p><pre><code>$ java -jar $R8_HOME/build/libs/d8.jar \</code><code> --release \</code><code> --output . \</code><code> ExampleKt.class</code><code>$ dexdump -d classes.dex</code><code>Opened 'classes.dex', DEX version '035'</code><code>Class #0 -</code><code> Class descriptor : 'LExampleKt;'</code><code> Access flags : 0x0011 (PUBLIC FINAL)</code><code> Superclass : 'Ljava/lang/Object;'</code><code> Direct methods -</code><code> #0 : (in LExampleKt;)</code><code> name : 'divide'</code><code> type : '(I)I'</code><code> access : 0x0019 (PUBLIC STATIC FINAL)</code><code> code -</code><code>000118: |[000118] ExampleKt.divide:(I)I</code><code>000128: db00 0102 |0000: div-int/lit8 v0, v1, #int 2 // #02</code><code>00012c: 0f00 |0002: return v0</code><br><br><code> #1 : (in LExampleKt;)</code><code> name : 'multiply'</code><code> type : '(I)I'</code><code> access : 0x0019 (PUBLIC STATIC FINAL)</code><code> code -</code><code>000130: |[000130] ExampleKt.multiply:(I)I</code><code>000140: da00 0102 |0000: mul-int/lit8 v0, v1, #int 2 // #02</code><code>000144: 0f00 |0002: return v0</code><br><br><code> #2 : (in LExampleKt;)</code><code> name : 'shiftLeft'</code><code> type : '(I)I'</code><code> access : 0x0019 (PUBLIC STATIC FINAL)</code><code> code -</code><code>000148: |[000148] ExampleKt.shiftLeft:(I)I</code><code>000158: e000 0101 |0000: shl-int/lit8 v0, v1, #int 1 // #01</code><code>00015c: 0f00 |0002: return v0</code><br><br><code> #3 : (in LExampleKt;)</code><code> name : 'shiftRight'</code><code> type : '(I)I'</code><code> access : 0x0019 (PUBLIC STATIC FINAL)</code><code> code -</code><code>000160: |[000160] ExampleKt.shiftRight:(I)I</code><code>000170: e100 0101 |0000: shr-int/lit8 v0, v1, #int 1 // #01</code><code>000174: 0f00 |0002: return </code><br></pre><p>(æ³¨ï¼šè¾“å‡ºç•¥å¾®ä¿®å‰ª)</p><p>Dalvikå­—èŠ‚ç æ˜¯åŸºäºå¯„å­˜å™¨çš„ï¼Œè€Œä¸æ˜¯åƒJavaå­—èŠ‚ç é‚£æ ·åŸºäºå †æ ˆã€‚å› æ­¤ï¼Œæ¯ç§æ–¹æ³•åªæœ‰ä¸€ä¸ªå®å­—èŠ‚ç æ¥æ‰§è¡Œç›¸å…³çš„æ•´æ•°è¿ç®—ã€‚æ¯ä¸ªå¯„å­˜å™¨éƒ½ä½¿ç”¨v1å¯„å­˜å™¨ï¼Œä¹Ÿæ˜¯ç¬¬ä¸€ä¸ªå®å‚å€¼ï¼Œä»¥åŠ2æˆ–1çš„æ•´å‹å¸¸é‡ã€‚</p><p>å› æ­¤æ²¡æœ‰æ›´æ”¹è¡Œä¸ºï¼Œä½†D8ä¹Ÿä¸æ˜¯ä¸€ä¸ªä¼˜åŒ–ç¼–è¾‘å™¨ï¼ˆå°½ç®¡å®ƒå¯ä»¥æ‰§è¡Œå±€éƒ¨æ–¹æ³•çš„ä¼˜åŒ–ï¼‰ã€‚</p><p></p><h1 toutiao-origin=h3>R8</h1><p>è¦è¿è¡ŒR8ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€é¡¹è§„åˆ™ï¼Œä»¥é˜²æ­¢æˆ‘ä»¬çš„æ–¹æ³•è¢«åˆ é™¤ã€‚</p><pre><code>-keep,allowoptimization class ExampleKt {</code><code> &lt;methods&gt;;</code><code>}</code></pre><p>è¿™äº›è§„åˆ™é€šè¿‡ `--pg-conf` æ¥ä¼ é€’ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†Android APIæ¥é“¾æ¥ä½¿ç”¨ `--lib`ã€‚</p><pre><code>$ java -jar $R8_HOME/build/libs/r8.jar \</code><code> --lib $ANDROID_HOME/platforms/android-29/android.jar \</code><code> --release \</code><code> --pg-conf rules.txt \</code><code> --output . \</code><code> ExampleKt.class</code><code>$ dexdump -d classes.dex</code><code>Opened 'classes.dex', DEX version '035'</code><code>Class #0 -</code><code> Class descriptor : 'LExampleKt;'</code><code> Access flags : 0x0011 (PUBLIC FINAL)</code><code> Superclass : 'Ljava/lang/Object;'</code><code> Direct methods -</code><code> #0 : (in LExampleKt;)</code><code> name : 'divide'</code><code> type : '(I)I'</code><code> access : 0x0019 (PUBLIC STATIC FINAL)</code><code> code -</code><code>000118: |[000118] ExampleKt.divide:(I)I</code><code>000128: db00 0102 |0000: div-int/lit8 v0, v1, #int 2 // #02</code><code>00012c: 0f00 |0002: return v0</code><br><br><code> #1 : (in LExampleKt;)</code><code> name : 'multiply'</code><code> type : '(I)I'</code><code> access : 0x0019 (PUBLIC STATIC FINAL)</code><code> code -</code><code>000130: |[000130] ExampleKt.multiply:(I)I</code><code>000140: da00 0102 |0000: mul-int/lit8 v0, v1, #int 2 // #02</code><code>000144: 0f00 |0002: return v0</code><br><br><code> #2 : (in LExampleKt;)</code><code> name : 'shiftLeft'</code><code> type : '(I)I'</code><code> access : 0x0019 (PUBLIC STATIC FINAL)</code><code> code -</code><code>000148: |[000148] ExampleKt.shiftLeft:(I)I</code><code>000158: e000 0101 |0000: shl-int/lit8 v0, v1, #int 1 // #01</code><code>00015c: 0f00 |0002: return v0</code><br><br><code> #3 : (in LExampleKt;)</code><code> name : 'shiftRight'</code><code> type : '(I)I'</code><code> access : 0x0019 (PUBLIC STATIC FINAL)</code><code> code -</code><code>000160: |[000160] ExampleKt.shiftRight:(I)I</code><code>000170: e100 0101 |0000: shr-int/lit8 v0, v1, #int 1 // #01</code><code>000174: 0f00 |0002: return </code></pre><p>ä¸D8çš„è¾“å‡ºå®Œå…¨ç›¸åŒã€‚</p><p></p><h1 toutiao-origin=h3>ART</h1><p>æˆ‘ä»¬ä½¿ç”¨R8ç¤ºä¾‹ä¸­çš„Dalvikå­—èŠ‚ç è¾“å‡ºï¼Œä½œä¸ºåœ¨x86æ¨¡æ‹Ÿå™¨ä¸Šçš„Android 10ç³»ç»Ÿè¿è¡Œçš„ARTçš„è¾“å…¥ã€‚</p><pre><code>$ adb push classes.dex /sdcard/classes.dex</code><code>$ adb shell</code><code>generic_x86:/ $ su</code><code>generic_x86:/ # dex2oat --dex-file=/sdcard/classes.dex --oat-file=/sdcard/classes.oat</code><code>generic_x86:/ # oatdump --oat-file=/sdcard/classes.oat</code><code>OatDexFile:</code><code>0: LExampleKt; (offset=0x000003c0) (type_idx=1) (Initialized) (OatClassAllCompiled)</code><code> 0: int ExampleKt.divide(int) (dex_method_idx=0)</code><code> CODE: (code_offset=0x00001010 size_offset=0x0000100c size=15)...</code><code> 0x00001010: 89C8 mov eax, ecx</code><code> 0x00001012: 8D5001 lea edx, [eax + 1]</code><code> 0x00001015: 85C0 test eax, eax</code><code> 0x00001017: 0F4DD0 cmovnl/ge edx, eax</code><code> 0x0000101a: D1FA sar edx</code><code> 0x0000101c: 89D0 mov eax, edx</code><code> 0x0000101e: C3 ret</code><code> 1: int ExampleKt.multiply(int) (dex_method_idx=1)</code><code> CODE: (code_offset=0x00001030 size_offset=0x0000102c size=5)...</code><code> 0x00001030: D1E1 shl ecx</code><code> 0x00001032: 89C8 mov eax, ecx</code><code> 0x00001034: C3 ret</code><code> 2: int ExampleKt.shiftLeft(int) (dex_method_idx=2)</code><code> CODE: (code_offset=0x00001030 size_offset=0x0000102c size=5)...</code><code> 0x00001030: D1E1 shl ecx</code><code> 0x00001032: 89C8 mov eax, ecx</code><code> 0x00001034: C3 ret</code><code> 3: int ExampleKt.shiftRight(int) (dex_method_idx=3)</code><code> CODE: (code_offset=0x00001040 size_offset=0x0000103c size=5)...</code><code> 0x00001040: D1F9 sar ecx</code><code> 0x00001042: 89C8 mov eax, ecx</code><code> 0x00001044: C3 ret</code></pre><pre> (æ³¨æ„ï¼šè¾“å‡ºæœ‰å¤§å¹…ä¿®å‰ª)</pre><p>x86æ±‡ç¼–æ˜¾ç¤ºï¼ŒARTç¡®å®ä»‹å…¥å¹¶è§„èŒƒåŒ–äº†ç®—æœ¯è¿ç®—ç¬¦ä»¥ä½¿ç”¨ç§»ä½ã€‚</p><p>é¦–å…ˆï¼Œç°åœ¨`multiply`å’Œ`shiftLeftçš„`å®ç°å®Œå…¨ä¸€è‡´ã€‚å®ƒä»¬éƒ½ä½¿ç”¨`shl`æ¥æ‰§è¡Œå‘å·¦æŒ‰ä½ç§»ä½1ï¼Œæ­¤å¤–å¦‚æœæŸ¥çœ‹æ–‡ä»¶å¤¹ä¸­çš„åç§»é‡ï¼ˆæœ€å·¦è¾¹çš„åˆ—ï¼‰ï¼Œä¼šå‘ç°å®ƒä»¬æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚ARTè®¤è¯†åˆ°è¿™äº›å‡½æ•°åœ¨ç¼–è¯‘åˆ°x86æ±‡ç¼–æ—¶å…·æœ‰ç›¸åŒçš„ä¸»ä½“ï¼Œå¹¶å·²ç»åˆ é™¤äº†é‡å¤çš„æ•°æ®ã€‚</p><p>ä¸‹ä¸€æ­¥ï¼Œå°½ç®¡`divide`å’Œ`shiftRight`ä¸ä¸€æ ·ï¼Œå…¶å¯¹`sar`çš„ç”¨æ³•æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯å‘å³æŒ‰ä½ç§»ä½1ï¼Œåœ¨`divide`ä¸­çš„å››æ¡é™„åŠ æŒ‡ä»¤é€šè¿‡ç»™å€¼åŠ 1ï¼Œå…ˆäº`sar`å¤„ç†è¾“å…¥ä¸ºè´Ÿçš„æƒ…å†µï¼ˆæ³¨é‡Š1ï¼‰ã€‚</p><p>åœ¨Android 10ç³»ç»Ÿçš„Pixel 4ä¸Šè¿è¡Œç›¸åŒçš„å‘½ä»¤ï¼Œä¼šæ˜¾ç¤ºARTå¦‚ä½•å°†æ­¤ä»£ç ç¼–è¯‘åˆ°ARMæ±‡ç¼–ä¸­ï¼ˆæ³¨é‡Š2ï¼‰ã€‚</p><pre><code>OatDexFile:</code><code>0: LExampleKt; (offset=0x000005a4) (type_idx=1) (Verified) (OatClassAllCompiled)</code><code> 0: int ExampleKt.divide(int) (dex_method_idx=0)</code><code> CODE: (code_offset=0x00001009 size_offset=0x00001004 size=10)...</code><code> 0x00001008: 0fc8 lsrs r0, r1, #31</code><code> 0x0000100a: 1841 adds r1, r0, r1</code><code> 0x0000100c: 1049 asrs r1, #1</code><code> 0x0000100e: 4608 mov r0, r1</code><code> 0x00001010: 4770 bx lr</code><code> 1: int ExampleKt.multiply(int) (dex_method_idx=1)</code><code> CODE: (code_offset=0x00001021 size_offset=0x0000101c size=4)...</code><code> 0x00001020: 0048 lsls r0, r1, #1</code><code> 0x00001022: 4770 bx lr</code><code> 2: int ExampleKt.shiftLeft(int) (dex_method_idx=2)</code><code> CODE: (code_offset=0x00001021 size_offset=0x0000101c size=4)...</code><code> 0x00001020: 0048 lsls r0, r1, #1</code><code> 0x00001022: 4770 bx lr</code><code> 3: int ExampleKt.shiftRight(int) (dex_method_idx=3)</code><code> CODE: (code_offset=0x00001031 size_offset=0x0000102c size=4)...</code><code> 0x00001030: 1048 asrs r0, r1, #1</code><code> 0x00001032: 4770 bx lr</code></pre><p>åŒæ ·ï¼Œ`multiply`å’Œ`shiftLeft`éƒ½ä½¿ç”¨`lsls`æ¥æ‰§è¡Œå‘å·¦ä½ç§»ï¼Œå› æ­¤è¢«å»é‡äº†ã€‚`shiftRight`ç”¨`asrs`æ¥æ‰§è¡Œå‘å³ä½ç§»ã€‚`divide`ä¹Ÿä½¿ç”¨`asrs`æ¥æ‰§è¡Œå‘å³ä½ç§»ï¼Œä½†å®ƒä½¿ç”¨å¦ä¸€ä¸ªå‘å³ä½ç§»`lsrs`æ¥å¤„ç†è´Ÿå€¼åŠ ä¸€çš„æ“ä½œï¼ˆæ³¨é‡Š3ï¼‰ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥è‚¯å®šåœ°è¯´ï¼Œç”¨`value &lt;&lt; 1`æ¥æ›¿ä»£`value * 2`æ²¡æœ‰ä»»ä½•å¥½å¤„ï¼Œä¸è¦å†ä¸ºäº†ç®—æœ¯è¿ç®—è€Œè¿™ä¹ˆåšäº†ï¼Œä»…ä¿ç•™ç”¨äºä¸¥æ ¼çš„æŒ‰ä½è¿ç®—ã€‚</p><p>ç„¶è€Œï¼Œ`value / 2` å’Œ`value >> 1`ä»ä¼šäº§ç”Ÿä¸åŒçš„æ±‡ç¼–æŒ‡ä»¤ï¼Œå› è€Œå¯èƒ½å…·æœ‰ä¸åŒçš„æ€§èƒ½ç‰¹å¾ã€‚å¹¸è¿çš„æ˜¯ï¼Œä½¿ç”¨`value / 2`å¯é¿å…ä½¿ç”¨é€šç”¨é™¤æ³•ï¼Œå¹¶ä¸”ä»æ—§ä¸»è¦åŸºäºå‘å³ä½ç§»ï¼Œå› æ­¤å®ƒä»¬åœ¨æ€§èƒ½æ–¹é¢å·®å¼‚å¯èƒ½ä¸å¤§ã€‚</p><p></p><h1 toutiao-origin=h3>ä½ç§»ä¼šæ¯”é™¤æ³•å¿«ä¸€äº›å—ï¼Ÿ</h1><p>ä¸ºäº†ç¡®å®šé™¤æ³•å¿«è¿˜æ˜¯ä½ç§»æ›´å¿«ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Jetpack benchmarkåº“ã€‚</p><pre><code>class DivideOrShiftTest {</code><code> @JvmField @Rule val benchmark = BenchmarkRule</code><br><br><code> @Test fun divide {</code><code> val value = "4".toInt // Ensure not a constant.</code><code> var result = 0</code><code> benchmark.measureRepeated {</code><code> result = value / 2</code><code> }</code><code> println(result) // Ensure D8 keeps computation.</code><code> }</code><br><br><code> @Test fun shift {</code><code> val value = "4".toInt // Ensure not a constant.</code><code> var result = 0</code><code> benchmark.measureRepeated {</code><code> result = value shr 1</code><code> }</code><code> println(result) // Ensure D8 keeps computation.</code><code> }</code></pre><p>æˆ‘æ²¡æœ‰x86è®¾å¤‡ï¼Œä½†æœ‰ä¸€å°è¿è¡ŒAndroid 10ç³»ç»Ÿçš„åŸºäºARMçš„Pixel 3ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code>android.studio.display.benchmark=4 ns DivideOrShiftTest.divide</code><code>count=4006</code><code>mean=4</code><code>median=4</code><code>min=4</code><code>standardDeviation=0</code><br><br><code>android.studio.display.benchmark=3 ns DivideOrShiftTest.shift</code><code>count=3943</code><code>mean=3</code><code>median=3</code><code>min=3</code><code>standardDeviation=0</code></pre><p>å¯¹å¦‚æ­¤å°çš„æ•°å­—ä½¿ç”¨é™¤æ³•æˆ–ä½ç§»ä¹‹é—´çš„åŒºåˆ«å‡ è¿‘äºæ— ï¼Œæ¯•ç«Ÿå·®å¼‚å¤ªå°äº†ã€‚ä½¿ç”¨è´Ÿæ•°æ˜¾ç¤ºç»“æœå¹¶æ— å·®å¼‚ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥è‚¯å®šï¼Œç”¨`value >> 1`ä»£æ›¿`value / 2`å¹¶æ— å¥½å¤„ï¼Œä¸è¦å†ä¸ºç®—æœ¯è¿ç®—è¿™ä¹ˆåšäº†ï¼Œä»…ä¿ç•™ç”¨äºä¸¥æ ¼çš„æŒ‰ä½è¿ç®—ã€‚</p><p></p><h1 toutiao-origin=h3>D8/R8èƒ½ç”¨è¿™äº›ä¿¡æ¯æ¥ä¿å­˜APKå¤§å°å—ï¼Ÿ</h1><p>é’ˆå¯¹ä¸¤ä¸ªæ“ä½œç›¸åŒçš„è¡¨è¾¾æ–¹å¼ï¼Œæˆ‘ä»¬åº”è¯¥é€‰æ‹©æ€§èƒ½æ›´ä½³çš„ã€‚ä½†å¦‚æœä¸¤è€…æ€§èƒ½ç›¸åŒçš„è¯ï¼Œåˆ™åº”é€‰æ‹©APKæ›´å°çš„ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼ŒARTä¸­`value * 2`å’Œ`value &lt;&lt; 1`ä¼šäº§ç”Ÿç›¸åŒçš„æ±‡ç¼–ï¼Œå› æ­¤å¦‚æœåœ¨Dalvikå­—èŠ‚ç ä¸­ï¼Œä¸€ä¸ªæ¯”å¦ä¸€ä¸ªæ›´çœç©ºé—´ï¼Œæˆ‘ä»¬åº”è¯¥æ— æ¡ä»¶åœ°ä»¥æ›´å°çš„å½¢å¼å°†å…¶é‡å†™ã€‚æŸ¥çœ‹D8ä¸­çš„è¾“å‡ºï¼Œå®ƒä»¬äº§ç”Ÿçš„å­—èŠ‚ç å¤§å°ç›¸åŒï¼š</p><pre><code> #1 : (in LExampleKt;) name : 'multiply'</code><code> â‹®</code><code>000140: da00 0102 |0000: mul-int/lit8 v0, v1, #int 2 // #02</code><br><br><code> #2 : (in LExampleKt;)</code><code> name : 'shiftLeft'</code><code> â‹®</code><code>000158: e000 0101 |0000: shl-int/lit8 v0, v1, #int 1 // #01</code></pre><p>å°½ç®¡ä½¿ç”¨2çš„å¹‚æ²¡æœ‰æ”¶ç›Šï¼Œä½†åœ¨ç§»ä½ä»¥å­˜å‚¨å¸¸é‡å€¼ä¹‹å‰ï¼Œä¹˜æ³•ç”¨å®Œäº†å­—èŠ‚ç ç©ºé—´ï¼Œä¸‹é¢æ˜¯`value * 32_768`ä¸`value &lt;&lt; 15`çš„å¯¹æ¯”ï¼š</p><pre><code> #1 : (in LExampleKt;) name : 'multiply'</code><code> â‹®</code><code>000128: 1400 0080 0000 |0000: const v0, #float 0.000000 // #00008000</code><code>00012e: 9201 0100 |0003: mul-int v1, v1, v0</code><br><br><code> #2 : (in LExampleKt;)</code><code> name : 'shiftLeft'</code><code> â‹®</code><code>00015c: e000 000f |0000: shl-int/lit8 v0, v0, #int 15 // #0f</code></pre><p>æˆ‘åœ¨D8ä¸Šæäº†ä¸ªé—®é¢˜ä»¥è°ƒæŸ¥å¦‚ä½•è‡ªåŠ¨ä¼˜åŒ–æ­¤é—®é¢˜ï¼Œä½†æˆ‘å¼ºçƒˆæ€€ç–‘è¿™ç§é€‚ç”¨æƒ…å†µæ¥è¿‘äºé›¶ï¼Œå› æ­¤å¾ˆå¯èƒ½å¹¶ä¸å€¼å¾—ã€‚</p><p>D8å’ŒR8çš„è¾“å‡ºä¹Ÿå‘Šè¯‰æˆ‘ä»¬ï¼Œåœ¨Dalvikå­—èŠ‚ç æ–¹é¢ï¼Œ`value / 2`å’Œ`value >> 1`çš„ä»£ä»·æ˜¯ç›¸åŒçš„ã€‚</p><pre><code> #0 : (in LExampleKt;) name : 'divide'</code><code> â‹®</code><code>000128: db00 0102 |0000: div-int/lit8 v0, v1, #int 2 // #02</code><br><br><code> #2 : (in LExampleKt;)</code><code> name : 'shiftLeft'</code><code> â‹®</code><code>000158: e000 0101 |0000: shl-int/lit8 v0, v1,#int 1 // #01</code></pre><p>å½“å¸¸é‡è¾¾åˆ°32768æ—¶ï¼Œå…¶å­—èŠ‚ç å¤§å°ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚æ— æ¡ä»¶åœ°å°†2çš„å¹‚é™¤æ³•æ¢æˆå‘å³ä½ç§»æ°¸è¿œä¸æ˜¯å®‰å…¨çš„é€‰é¡¹ï¼Œè¿™æ˜¯å› ä¸ºè´Ÿæ•°çš„å­˜åœ¨ã€‚å¦‚æœèƒ½ä¿è¯å…¶å€¼éè´Ÿï¼Œé‚£æˆ‘ä»¬å¯ä»¥è¿™æ ·æ›¿æ¢ï¼Œä½†æ­¤æ—¶D8å’ŒR8å¹¶ä¸ä¼šè¿½è¸ªå¯èƒ½çš„æ•´æ•°å€¼èŒƒå›´ã€‚</p><p></p><h1 toutiao-origin=h3>æ— ç¬¦å·çš„â€œ2çš„å¹‚é™¤æ³•â€ä½¿ç”¨ä½ç§»å—ï¼Ÿ</h1><p>Javaå­—èŠ‚ç ç¼ºå°‘æ— ç¬¦å·çš„æ•°å­—ï¼Œä½†ä½¿ç”¨ç¬¦å·çš„å¯¹åº”éƒ¨åˆ†æ˜¯å¯ä»¥æ¨¡æ‹Ÿçš„ã€‚åœ¨Javaä¸­ï¼Œæœ‰ä¸€äº›å°†ç¬¦å·ç±»å‹å½“ä½œæ— ç¬¦å·å€¼è¿ç®—çš„é™æ€è¾…åŠ©æ–¹æ³•ã€‚Kotlinæä¾›äº†ç±»ä¼¼ `UInt` è¿™æ ·çš„ç±»å‹å®Œæˆç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†åœ¨ç±»å‹åå®Œå…¨æŠ½è±¡äº†ã€‚å¯ä»¥æƒ³è±¡çš„æ˜¯ï¼Œå½“ä½¿ç”¨é™¤ä»¥2çš„å¹‚æ—¶ï¼Œåº”å½“ä»¥ç§»ä½æ–¹å¼é‡å†™ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Kotlinæ¥ä¸ºä¸¤ç§æƒ…å†µå»ºæ¨¡ã€‚</p><pre><code>fun javaLike(value: Int) = Integer.divideUnsigned(value, 2)</code><code>fun kotlinLike(value: UInt) = value / 2U</code></pre><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä»…éœ€è€ƒè™‘ä»£ç çš„ç¼–è¯‘æ–¹å¼ã€‚æˆ‘ä»¬ä»æ™®é€šçš„ `kotlinc`å¼€å§‹ï¼ˆè¿˜æ˜¯ä»Kotlin 1.4-M1å¼€å§‹ï¼‰ã€‚</p><pre><code>$ kotlinc Example.kt</code><code>$ javap -c ExampleKt</code><code>Compiled from "Example.kt"</code><code>public final class ExampleKt {</code><code> public static final int javaLike(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_2</code><code> 2: invokestatic #12 // Method java/lang/Integer.divideUnsigned:(II)I</code><code> 5: ireturn</code><br><br><code> public static final int kotlinLike-WZ4Q5Ns(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: istore_1</code><code> 2: iconst_2</code><code> 3: istore_2</code><code> 4: iconst_0</code><code> 5: istore_3</code><code> 6: iload_1</code><code> 7: iload_2</code><code> 8: invokestatic #20 // Method kotlin/UnsignedKt."uintDivide-J1ME1BU":(II)I</code><code> 11: ireturn</code><code>}</code></pre><p>Kotlinæ— æ³•å°†å…¶è¯†åˆ«ä¸ºå¯ä½¿ç”¨`iushr`å­—èŠ‚ç çš„â€œ2çš„å¹‚é™¤æ³•â€ï¼Œæˆ‘æäº¤äº†KT-38493ä»¥è¿½è¸ªæ­¤è¡Œä¸ºçš„æ·»åŠ ã€‚</p><p>ä½¿ç”¨`-Xuse-ir`ä¸ä¼šæœ‰ä»»ä½•æ”¹å˜ï¼ˆé™¤éç§»é™¤æŸäº›è´Ÿè½½/å­˜å‚¨å™ªéŸ³ï¼‰ï¼Œç„¶è€Œä»¥Java 8ä¸ºç›®æ ‡åˆ™ä¼šæœ‰å˜åŒ–ã€‚</p><pre><code>$ kotlinc -jvm-target 1.8 Example.kt</code><code>$ javap -c ExampleKt</code><code>Compiled from "Example.kt"</code><code>public final class ExampleKt {</code><code> public static final int javaLike(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_2</code><code> 2: invokestatic #12 // Method java/lang/Integer.divideUnsigned:(II)I</code><code> 5: ireturn</code><br><br><code> public static final int kotlinLike-WZ4Q5Ns(int);</code><code> Code:</code><code> 0: iload_0</code><code> 1: iconst_2</code><code> 2: invokestatic #12 // Method java/lang/Integer.divideUnsigned:(II)I</code><code> 5: ireturn</code><code>}</code></pre><p>`Integer.divideUnsigned`æ–¹æ³•åœ¨Java 8ä¸­å¯ä»¥ä½¿ç”¨ï¼Œå› æ­¤åœ¨1.8æˆ–æ›´é«˜ç‰ˆæœ¬ä¸­è¾ƒå¤šä½¿ç”¨ï¼Œç”±äºè¿™ä¼šä½¿å¾—ä¸¤ä¸ªå‡½æ•°ä½“å®Œå…¨ç›¸åŒï¼Œæˆ‘ä»¬è¿˜æ˜¯è¿”å›æ—§è¾“å‡ºï¼Œå¯¹æ¯”çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p><p>æ¥ä¸‹æ¥æ˜¯R8ï¼Œä¸ä¸Šé¢è°ƒç”¨æ˜æ˜¾ä¸åŒï¼Œæˆ‘ä»¬å°†Kotlin stdlibä½œä¸ºè¾“å…¥å¼•å…¥ï¼ŒåŒæ—¶ç”±äº `Integer.divideUnsigned` ä»…åœ¨API 24å’Œæ›´é«˜ç‰ˆæœ¬ä¸­å¯ç”¨ï¼Œä¹Ÿä¼ é€’äº†`--min-api 24`ã€‚</p><pre><code>$ java -jar $R8_HOME/build/libs/r8.jar \</code><code> --lib $ANDROID_HOME/platforms/android-29/android.jar \</code><code> --min-api 24 \</code><code> --release \</code><code> --pg-conf rules.txt \</code><code> --output . \</code><code> ExampleKt.class kotlin-stdlib.jar</code><code>$ dexdump -d classes.dex</code><code>Opened 'classes.dex', DEX version '039'</code><code>Class #0 -</code><code> Class descriptor : 'LExampleKt;'</code><code> Access flags : 0x0011 (PUBLIC FINAL)</code><code> Superclass : 'Ljava/lang/Object;'</code><code> Direct methods -</code><code> #0 : (in LExampleKt;)</code><code> name : 'javaLike'</code><code> type : '(I)I'</code><code> access : 0x0019 (PUBLIC STATIC FINAL)</code><code> code -</code><code>0000f8: |[0000f8] ExampleKt.javaLike:(I)I</code><code>000108: 1220 |0000: const/4 v0, #int 2 // #2</code><code>00010a: 7120 0200 0100 |0001: invoke-static {v1, v0}, Ljava/lang/Integer;.divideUnsigned:(II)I // method@0002</code><code>000110: 0a01 |0004: move-result v1</code><code>000112: 0f01 |0005: return v1</code><br><br><code> #1 : (in LExampleKt;)</code><code> name : 'kotlinLike-WZ4Q5Ns'</code><code> type : '(I)I'</code><code> access : 0x0019 (PUBLIC STATIC FINAL)</code><code> code -</code><code>000114: |[000114] ExampleKt.kotlinLike-WZ4Q5Ns:(I)I</code><code>000124: 8160 |0000: int-to-long v0, v6</code><code>000126: 1802 ffff ffff 0000 0000 |0001: const-wide v2, #double 0.000000 // #00000000ffffffff</code><code>000130: c020 |0006: and-long/2addr v0, v2</code><code>000132: 1226 |0007: const/4 v6, #int 2 // #2</code><code>000134: 8164 |0008: int-to-long v4, v6</code><code>000136: c042 |0009: and-long/2addr v2, v4</code><code>000138: be20 |000a: div-long/2addr v0, v2</code><code>00013a: 8406 |000b: long-to-int v6, v0</code><code>00013c: 0f06 |000c: return v6</code></pre><p>Kotlinæœ‰è‡ªå·±çš„æ— ç¬¦å·æ•´æ•°é™¤æ³•çš„å®ç°æ–¹å¼ï¼Œå·²ç»ä¸æˆ‘ä»¬çš„å‡½æ•°å†…è”ã€‚å®ƒä¼šå°†è¾“å…¥å®å‚å’Œå¸¸é‡è½¬åŒ–ä¸ºlongsï¼Œæ‰§è¡Œlongsé™¤æ³•ï¼Œç„¶åå†è½¬å›æ•´æ•°ã€‚å½“æˆ‘ä»¬æœ€ç»ˆé€šè¿‡ARTæ¥è¿è¡Œæ—¶ï¼Œå®ƒä»¬ä¼šè½¬æˆç­‰æ•ˆçš„x86ï¼Œå› æ­¤æˆ‘ä»¬å°†ä¿ç•™æ­¤å‡½æ•°ï¼Œè¿™é‡Œä¼˜åŒ–çš„æœºä¼šå·²ç»å¤±å»äº†ã€‚</p><p>å¯¹äºJavaç‰ˆæœ¬ï¼ŒR8æ— æ³•å°†`divideUnsigned`è°ƒç”¨æ›¿æ¢æˆä½ç§»ï¼Œæˆ‘é’ˆå¯¹D8å’ŒR8æäº¤äº†issue 154712996æ¥è·Ÿè¸ªè¿™ä¸ªé—®é¢˜ã€‚</p><p>æœ€åä¸€ä¸ªä¼˜åŒ–çš„æœºä¼šæ˜¯ARTã€‚</p><pre><code>$ adb push classes.dex /sdcard/classes.dex</code><code>$ adb shell</code><code>generic_x86:/ $ su</code><code>generic_x86:/ # dex2oat --dex-file=/sdcard/classes.dex --oat-file=/sdcard/classes.oat</code><code>generic_x86:/ # oatdump --oat-file=/sdcard/classes.oat</code><code>OatDexFile:</code><code>0: LExampleKt; (offset=0x000003c0) (type_idx=1) (Initialized) (OatClassAllCompiled)</code><code> 0: int ExampleKt.javaLike(int) (dex_method_idx=0)</code><code> CODE: (code_offset=0x00001010 size_offset=0x0000100c size=63)...</code><code> 0x00001010: 85842400E0FFFF test eax, [esp + -8192]</code><code> StackMap[0] (native_pc=0x1017, dex_pc=0x0, register_mask=0x0, stack_mask=0b)</code><code> 0x00001017: 55 push ebp</code><code> 0x00001018: 83EC18 sub esp, 24</code><code> 0x0000101b: 890424 mov [esp], eax</code><code> 0x0000101e: 6466833D0000000000 cmpw fs:[0x0], 0 ; state_and_flags</code><code> 0x00001027: 0F8519000000 jnz/ne +25 (0x00001046)</code><code> 0x0000102d: E800000000 call +0 (0x00001032)</code><code> 0x00001032: 5D pop ebp</code><code> 0x00001033: BA02000000 mov edx, 2</code><code> 0x00001038: 8B85CE0F0000 mov eax, [ebp + 4046]</code><code> 0x0000103e: FF5018 call [eax + 24]</code><code> StackMap[1] (native_pc=0x1041, dex_pc=0x1, register_mask=0x0, stack_mask=0b)</code><code> 0x00001041: 83C418 add esp, 24</code><code> 0x00001044: 5D pop ebp</code><code> 0x00001045: C3 ret</code><code> 0x00001046: 64FF15E0020000 call fs:[0x2e0] ; pTestSuspend</code><code> StackMap[2] (native_pc=0x104d, dex_pc=0x0, register_mask=0x0, stack_mask=0b)</code><code> 0x0000104d: EBDE jmp -34 (0x0000102d)</code><code> 1: int ExampleKt.kotlinLike-WZ4Q5Ns(int) (dex_method_idx=1)</code><code> CODE: (code_offset=0x00001060 size_offset=0x0000105c size=67)...</code><code> â‹®</code></pre><p>ARTå†…åŒ–è°ƒç”¨ `divideUnsigned`ï¼Œå› æ­¤æˆ‘ä»¬è®©æœºå™¨è·³è‡³å¸¸è§„æ–¹æ³•çš„å®ç°ã€‚æˆ‘æäº¤äº†issue 154693569ä»¥è·Ÿè¸ªä¸ºæ— ç¬¦å·é™¤æ³•æ·»åŠ ARTå†…åŒ–çš„é—®é¢˜ã€‚</p><p>å¥½å§ï¼Œè¿™ç¡®å®è´¹äº†ä¸å°‘åŠ²ã€‚æ­å–œä½ åˆ°è¾¾æ­¤æ­¥ï¼ˆæˆ–åªæ˜¯å¿«é€Ÿç¿»åˆ°è¿™é‡Œï¼‰ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼š</p><ol><li><p>ARTå°†2çš„å¹‚ä¹˜æ³•é‡å†™ä¸ºå‘å·¦ä½ç§»ï¼Œå°†2çš„å¹‚é™¤æ³•é‡å†™ä¸ºå‘å³ä½ç§»ï¼ˆé€šè¿‡ä¸€äº›é¢å¤–çš„æŒ‡ä»¤æ¥å¤„ç†è´Ÿæ•°ï¼‰ï¼›</p></li><li><p>å‘å³ä½ç§»å’Œ2çš„å¹‚é™¤æ³•ä¹‹é—´æ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½å·®å¼‚ï¼›</p></li><li><p>Dalvikå­—èŠ‚ç ä¸­ï¼Œä½ç§»å’Œä¹˜æ³•/é™¤æ³•ä¹‹é—´æ²¡æœ‰å¤§å°å·®å¼‚ï¼›</p></li><li><p>æˆªè‡³ç›®å‰è¿˜æ²¡æœ‰äººä¼˜åŒ–æ— ç­¾åé™¤æ³•ï¼Œä½†ä¹Ÿè®¸ä½ ä¹Ÿä¸ä¼šç”¨åˆ°ã€‚</p></li></ol><p>é€šè¿‡ä»¥ä¸Šäº‹å®ï¼Œæˆ‘ä»¬å¯ä»¥å›ç­”æœ¬æ–‡é¢˜ç›®ä¸­æå‡ºçš„é—®é¢˜äº†ï¼š</p><blockquote><p>Androidä¸Šå“ªä¸ªæ›´å¥½ï¼šé™¤ä»¥2è¿˜æ˜¯ä½ç§»1ï¼Ÿ</p></blockquote><p>éƒ½ä¸å¥½ï¼å› æ­¤å°†é™¤æ³•ç”¨äºç®—æœ¯è¿ç®—ä¸­ï¼Œå¯¹äºçœŸå®çš„æŒ‰ä½æ“ä½œåªä½¿ç”¨ä½ç§»ï¼Œæˆ‘ä¼šå°†AndroidXé›†åˆç«¯å£ä»ä½ç§»åˆ‡æ¢åˆ°ä¹˜é™¤æ³•ã€‚ä¸‹æ¬¡è§ï¼</p><p>æ³¨é‡Šï¼š</p><p>1. äºŒè¿›åˆ¶ä¸­çš„-3ä¸º0b11111101ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•ä»…å‘å³ä½ç§»æ¥å®ç°é™¤ä»¥2ï¼Œç»“æœæ˜¯0b11111110ï¼Œå³-2ï¼Œè¿™æ˜¯é”™è¯¯çš„ç»“æœã€‚é€šè¿‡ç»™-3åŠ 1ï¼Œé¦–å…ˆæˆ‘ä»¬ä¼šå¾—åˆ°-2ï¼ŒäºŒè¿›åˆ¶è¡¨è¾¾æ˜¯0b11111110ï¼Œå‘å³ä½ç§»åˆ™å¾—å‡º0b11111111ï¼Œä¹Ÿå°±æ˜¯-1ï¼Œè¿™æ˜¯æ­£ç¡®çš„ç»“æœã€‚</p><p>æ ¹æ®å®é™…ä¸­çš„æŒ‡ä»¤ï¼š</p><ul><li><p>`mov eax, ecx` å°†åŸå§‹è¾“å…¥å®å‚å€¼ä¿å­˜åœ¨`eax`ä¸­ï¼›</p></li><li><p>`lea edx, [eax + 1]` ç»™è¾“å…¥å®å‚åŠ 1ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨`edx`ä¸­ï¼Œå³æˆ‘ä»¬è¦ä½ç§»çš„å¯„å­˜å™¨ï¼›</p></li><li><p>`test eax, eax`å¯¹è‡ªèº«çš„è¾“å…¥å®å‚è¿›è¡ŒæŒ‰ä½æ“ä½œï¼Œå¯¼è‡´ä¸€äº›å¯„å­˜å™¨ä¼šæ ¹æ®è¾“å…¥å®å‚çš„å±æ€§æ¥è®¾ç½®ï¼›</p></li><li><p>ä¹‹å`cmovnl/ge edx, eax`å¯èƒ½ä¼šåŸºäº`test`çš„ç»“æœï¼Œä»¥`eax` (å€¼)é‡å†™`edx` (å€¼+1)ã€‚</p></li></ul><p>ä¹‹åæŒ‡ä»¤ä¼šæ‰§è¡Œæ™®é€šçš„å‘å³ä½ç§»ï¼Œä¸ `(value &lt; 0 ? value + 1 : value) >> 1`. â†©åŸºæœ¬ç›¸åŒã€‚</p><p>2. æ„Ÿè°¢Sergey Vasilinetsæä¾›çš„ç›¸å…³å†…å®¹ï¼Œ`dex2oat`åªèƒ½åœ¨ç°ä»£Androidç‰ˆæœ¬ä¸­ä»¥rootèº«ä»½æ¥è¿è¡Œï¼Œå› æ­¤æ™®é€šçš„Androidï¼ˆå¦‚åœ¨Pixel3ä¸Šçš„ï¼‰å°±æ— æ³•è¿è¡Œã€‚â†©</p><p>3. å°±å®é™…æŒ‡ä»¤è€Œè¨€ï¼š</p><ul><li><p>`lsrs r0, r1, #31` å¯¹è¾“å…¥å®å‚è¿›è¡Œé€»è¾‘ï¼ˆå³ä¸å¯¹ç¬¦å·è¿›è¡Œæ‰©å±•ï¼‰31ä½çš„ä½ç§»åˆ°`r0`ï¼Œå¯¼è‡´è´Ÿæ•°ç»“æœä¸º1ï¼Œæ­£æ•°ç»“æœä¸º0ã€‚</p></li><li><p>`adds r1, r0, r1` ä¼šå°†å‰ä¸€æ¡æŒ‡ä»¤çš„ç»“æœä¸è¾“å…¥å®å‚ç›¸åŠ ï¼Œå®é™…ä¸Šæ˜¯ç»™è´Ÿå€¼è¾“å…¥åŠ 1ã€‚</p></li></ul><p>è‡ªæ­¤æŒ‡ä»¤ä¼šæ‰§è¡Œæ™®é€šçš„å‘å³ä½ç§»ï¼ŒåŸºæœ¬ä¸Šç­‰åŒäº`(value + (value >>> 31)) >> 1`ã€‚</p><p>åŸæ–‡é“¾æ¥ï¼š</p><p>https://jakewharton.com/which-is-better-on-android-divide-by-two-or-shift-by-one/</p><p>æœ¬æ–‡ä¸ºCSDNç¿»è¯‘æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><img alt="Android ä¸Šå“ªä¸ªæ›´å¥½ï¼šé™¤ä»¥ 2 è¿˜æ˜¯ä½ç§» 1ï¼Ÿ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/R69FpRH4d90a7d><img alt="Android ä¸Šå“ªä¸ªæ›´å¥½ï¼šé™¤ä»¥ 2 è¿˜æ˜¯ä½ç§» 1ï¼Ÿ" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/Rz2ij7Q6pwhZWh><pre><p>â˜æ½˜çŸ³å±¹ Python è€ƒè¯•æˆç»© 99 åˆ†ï¼Œç½‘å‹ï¼šè¿˜æœ‰ä¸€åˆ†æ€•ä½ éª„å‚²</p><pre><p>â˜èµ ä¹¦ | ç¨‹åºå‘˜ä¿®ç‚¼çš„åŠ¡å®å“²å­¦</p><p>â˜JavaScript æµè¡Œåº¦æœ€é«˜ï¼ŒJava å±ˆå±…ç¬¬ä¸‰ï¼| 2020 æœ€æ–°è½¯ä»¶å¼€å‘çŠ¶å†µæŠ¥å‘Š</p><p>â˜æ·±åº¦å­¦ä¹ åŸºç¡€æ€»ç»“ï¼Œæ— ä¸€å¥åºŸè¯ï¼ˆé™„å®Œæ•´æ€ç»´å¯¼å›¾ï¼‰</p><p>â˜éœ‡æƒŠï¼é˜¿é‡Œçš„ç¨‹åºå‘˜ç«Ÿè¢«ä¸€ä¸ªç®€å•çš„ SQL æŸ¥è¯¢éš¾ä½äº†ï¼</p><p>â˜å¤§å­¦ç”Ÿç¨‹åºå‘˜è¢«å‹’ç´¢æ¯”ç‰¹å¸åï¼Œç»åœ°åå‡»ï¼</p></pre></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Android','å“ªä¸ª','è¿˜æ˜¯'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>