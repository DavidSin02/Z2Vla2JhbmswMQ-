<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Wasm介绍之5：控制指令 | 火星技术帖 | 极客快訊</title><meta property="og:title" content="Wasm介绍之5：控制指令 | 火星技术帖 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/RivR6n1AU5yy8h"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b82c724a.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b82c724a.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b82c724a.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b82c724a.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b82c724a.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b82c724a.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b82c724a.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b82c724a.html><meta property="article:published_time" content="2020-11-14T21:03:14+08:00"><meta property="article:modified_time" content="2020-11-14T21:03:14+08:00"><meta name=Keywords content><meta name=description content="Wasm介绍之5：控制指令 | 火星技术帖"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/b82c724a.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Wasm介绍之5：控制指令 | 火星技术帖</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><img alt="Wasm介绍之5：控制指令 | 火星技术帖" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RivR6n1AU5yy8h><blockquote><p>免责声明：本文旨在传递更多市场信息，不构成任何投资建议。文章仅代表作者观点，不代表火星财经官方立场。</p></blockquote><p>小编：记得关注哦</p><p>来源：CoinEx公链Talk</p><img alt="Wasm介绍之5：控制指令 | 火星技术帖" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RsLNt4BDKoYvP8><p>WebAssembly（简称Wasm）控制指令一共有11条，其中<code>unreachable</code>指令（操作码<code>0x00</code>）和<code>nop</code>指令（操作码<code>0x01</code>）比较简单，不介绍。<code>call</code>指令（操作码<code>0x10</code>）已经在上一篇文章里介绍，<code>call_indirect</code>指令（操作码<code>0x11</code>）将在下一篇文章里介绍。本文重点讨论<code>block</code>（操作码<code>0x02</code>）、<code>loop</code>（操作码<code>0x03</code>）、<code>if</code>（操作码<code>0x04</code>）、<code>br</code>（操作码<code>0x0C</code>）、<code>br_if</code>（操作码<code>0x0D</code>）、<code>br_table</code>（操作码<code>0x0E</code>）和<code>return</code>（操作码<code>0x0F</code>）这7条指令。</p><p></p><h2>block</h2><p><code>block</code>指令相当于一个无参的内联（inline）函数调用。函数的返回值类型，也就是<code>block</code>指令的结果类型（Result Type，在后面的示意图中简称<code>rt</code>）编码后存储在指令的第一个立即数参数里。函数的指令（可能有很多条）编码后存储在第二个立即数参数里。<code>block</code>指令必须以<code>end</code>指令（操作码<code>0x0B</code>）结尾。由于<code>end</code>指令和后面将要介绍的<code>else</code>指令（操作码<code>0x05</code>）只起到标记作用，没有任何执行效果，所以没有把这两条指令计入控制指令。</p><p>Wasm1.0规范规定<code>block</code>指令的结果不能超过一个，所以<code>rt</code>可以用一个字节表示：<code>0x40</code>表示没有结果、<code>0x7F</code>表示<code>i32</code>类型、<code>0x7E</code>表示<code>i64</code>类型、<code>0x7D</code>表示<code>f32</code>类型、<code>0x7C</code>表示<code>f64</code>类型。根据讨论可知，<code>block</code>指令在执行时不会使用栈上已经存在的任何操作数，执行完毕后可能会在栈顶留下一个操作数，下面是它的示意图：</p><pre><code>bytecode:...][ block ][ rt ][ instrs ][ end ][...stack:|           |          |           | |           |         ➘|   ?(rt)   | # exec(instrs)|     d     |          |     d     | |     c     |          |     c     | |     b     |          |     b     |  |     a     |          |     a     | └───────────┘          └───────────┘</code></pre><p>下面是一个非常简单的WAT例子，展示了<code>block</code>指令的用法：</p><pre><code>(module  (func (result i32)    ;; ... other instructions    (block (result i32)      (i32.const 100)    )  ))</code></pre><p></p><h2>loop</h2><p><code>loop</code>指令和<code>block</code>指令非常相似，区别仅在于如何跳出控制块。后文介绍<code>br</code>指令时会进一步讨论这个区别，下面先给出一个跳转示意图：</p><pre><code>...][ block ][ rt ]...[ br ]...[ end ][...                         |        ↑                         └────────┘...][ loop ][ rt ]...[ br ]...[ end ][...       ↑               |       └───────────────┘</code></pre><p></p><h2>if</h2><p>和<code>block</code>指令类似，<code>if</code>指令也类似于一个内联函数。区别主要有两点。第一，<code>if</code>内联函数带一个<code>i32</code>类型的参数。第二，<code>if</code>内联函数带有两份代码（两条分支），中间用<code>else</code>指令隔开。<code>if</code>指令执行时，会先从栈顶弹出这个<code>i32</code>类型的参数，如果参数值不等于0，则执行分支1代码，否则执行分支2代码。下面是<code>if</code>指令的示意图：</p><pre><code>bytecode:...][ if ][ rt ][ instrs1 ][ else ][ instrs2 ][ end ][...stack:|           |          |           | |   e(i32)  |➚        ➘|   ?(rt)   | # exec(e!=0?instrs1:instrs2)|     d     |          |     d     ||     c     |          |     c     | |     b     |          |     b     |  |     a     |          |     a     | └───────────┘          └───────────┘</code></pre><p>也可以把<code>if</code>指令的<code>else</code>分支省略，但是这种情况下<code>if</code>指令不能有任何结果。下面是省略<code>else</code>分支时<code>if</code>指令的示意图：</p><pre><code>bytecode:...][ if ][ 0x40 ][ instrs1 ][ end ][...stack:|           |          |           | |   e(i32)  |➚         |           | # e==1?exec(instrs1)|     d     |          |     d     ||     c     |          |     c     | |     b     |          |     b     |  |     a     |          |     a     | └───────────┘          └───────────┘</code></pre><p>下面这个WAT例子展示了如何用<code>if</code>指令实现<code>max</code>函数：</p><pre><code>(module  (func $max (param $a i32) (param $b i32) (result i32)    (i32.gt_s (local.get $a) (local.get $b))    (if (result i32)      (then (local.get $a))      (else (local.get $b))    )  ))</code></pre><p></p><h2>br</h2><p><code>br</code>指令（可以理解为break，或者branch）可以进行无条件跳转。和传统汇编语言里的<code>JUMP</code>指令不同，<code>br</code>指令并不能跳转到任意位置，而只能跳出（相对于<code>block</code>和<code>if</code>指令而言是跳出，相对于<code>loop</code>指令而言是重新开始，后面不再强调）其他控制指令产生的控制块。<code>br</code>指令带有一个<code>u32</code>类型（32位无符号整数）的立即数参数，指定跳转的层数：0表示跳出当前循环，1代表跳出2层循环，以此类推。下面是一个WAT例子，展示了嵌套的<code>block</code>，以及<code>br</code>指令的用法：</p><pre><code>(module  (func (export "main") (result i32)    (i32.const 100) (block (result i32)      (i32.const 200) (block (result i32)          (i32.const 300) (block (result i32)           (i32.const 123) (br n)        ) (i32.add)      ) (i32.add)    ) (i32.add)  ))</code></pre><p>假设上面例子中的<code>main</code>函数已经执行到了<code>br</code>指令这里，下图展示了跳转层数分别为0、1、2、3时操作数栈的变化情况：</p><pre><code>bytecode:...][ br ][ depth ][...stack:|           |  |           |  |           |  |           |  |           ||           |  |           |  |           |  |           |  |           ||    123    |  |    123    |  |           |  |           |  |           ||    300    |  |    300    |  |    123    |  |           |  |           ||    200    |  |    200    |  |    200    |  |    123    |  |           ||    100    |  |    100    |  |    100    |  |    100    |  |    123    |└───────────┘  └───────────┘  └───────────┘  └───────────┘  └───────────┘ (before br)        n==0           n==1           n==2           n==3    </code></pre><p></p><h2>br_if</h2><p><code>br_if</code>指令从栈顶弹出一个<code>i32</code>类型的操作数，如果操作数的值为0，则不跳转，否则执行<code>br</code>逻辑。下面是<code>br_if</code>指令的示意图：</p><pre><code>bytecode:...][ br_if ][ depth ][...stack:|           |          |           | |   e(i32)  |➚         |           | |     d     |          |     ?     | # e!=0?br(depth)|     c     |          |           | |     b     |          |           |  |     a     |          |           | └───────────┘          └───────────┘</code></pre><p>下面是一个稍微复杂一些的WAT例子，展示了如何用<code>loop</code>和<code>br_if</code>指令实现<code>sum</code>函数：</p><pre><code>(module  (func $sum (param $from i32) (param $to i32) (result i32)    (local $n i32)    (loop $l      ;; $n += $from      (local.set $n (i32.add (local.get $n) (local.get $from)))      ;; $from++       (local.set $from (i32.add (local.get $from) (i32.const 1)))      ;; if $from </code></pre><p>请注意<code>loop</code>指令并不会自动循环，必须和<code>br</code>等跳转指令配合使用。</p><p></p><h2>br_table</h2><p>不管是<code>br</code>还是<code>br_if</code>指令，都只有一个立即数参数，能指定一个跳转深度。<code>br_table</code>指令打破了这种限制，可以带N+1个立即数参数，指定N+1个跳转深度。<code>br_table</code>指令执行时，会从栈顶弹出一个<code>i32</code>类型的操作数<code>n</code>。如果<code>n</code>小于或等于N，则按第<code>n</code>个深度跳转，否则按照最后一个深度跳转。下面是<code>br_table</code>指令的示意图：</p><pre><code>bytecode:...][ br_table ][ labels... ][ default ][...stack:|           |          |           | |   n(i32)  |➚         |           ||     d     |          |     ?     | # d</code></pre><p></p><h2>return</h2><p><code>return</code>指令可以认为是<code>br</code>指令的特殊形式：直接跳出最外层循环（也就是整个函数）。<code>return</code>指令没有立即数参数，不画示意图了。下面的WAT例子展示了如何用<code>block</code>、<code>br_table</code>和<code>return</code>指令实现Go等高级语言中的<code>switch-case</code>语句：</p><pre><code>(module  (func $select3 (param $n i32) (param i32 i32 i32) (result i32)    (block      (block        (block          (local.get $n)          (br_table 0 1 2)        )        (return (local.get 1))      )      (return (local.get 2))    )    (return (local.get 3))  ))</code></pre><p>如果把上面例子中定义的<code>select3</code>函数翻译成Go语言代码的话，应该是下面这样：</p><pre><code>func select3(n, a, b, c int32) int32 {  switch n {    case 0 : return a    case 1 : return b    default: return c  }}</code></pre><p>*本文由CoinEx Chain开发团队成员Chase撰写。CoinEx Chain是全球首条基于Tendermint共识协议和Cosmos SDK开发的DEX专用公链，借助IBC来实现DEX公链、智能合约链、隐私链三条链合一的方式去解决可扩展性（Scalability）、去中心化（Decentralization）、安全性（security）区块链不可能三角的问题，能够高性能的支持数字资产的交易以及基于智能合约的Defi应用。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Wasm','介绍','技术'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>