<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>头条文章--自定义方式构造Word表格中单元格区域求和子过程 | 极客快訊</title><meta property="og:title" content="头条文章--自定义方式构造Word表格中单元格区域求和子过程 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/27f6f2ef47404eb48ed10e6ee379ade8"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bc79bddb.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bc79bddb.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/bc79bddb.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bc79bddb.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bc79bddb.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/bc79bddb.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/bc79bddb.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bc79bddb.html><meta property="article:published_time" content="2020-11-14T21:06:15+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:15+08:00"><meta name=Keywords content><meta name=description content="头条文章--自定义方式构造Word表格中单元格区域求和子过程"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/bc79bddb.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>头条文章--自定义方式构造Word表格中单元格区域求和子过程</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>哈喽，各位好，今天，又准备给大家分享一个比较有用的高级办公技巧哦！希望大家认真看完下面的文章哦！什么办公技巧呢？大家看我细细道来吧。明人不说暗话，开门见山给大家直说了吧：关于word表格中数据区域的数据用后台生成公式计算的高级应用问题。该设计的亮点和特色是利用输入对话框灵活的定位计算结果单元格位置，并通过VBA后台灵活通过方法.Formula(公式参数字符串)的形式计算区域里面的数据！</p><p>下面，我们就来看看如何设计这种机制的Word文档吧。在设计上，我们分为：前端的文档上的表格设计及插入开发工具里面的ActiveX命令按钮控件；后台的功能(文档打开的一系列初始化工作、运行计算工作、清除生成结果数据、新定义一个利用公式串作为参数进行计算的子过程等)代码实现。</p><p>一、文档表格插入、表格待计算数据填入、命令按钮控件的插入。</p><p>(一)插入表格、命令按钮插入，并将表格填充必要的计算的原始数据。如下截图所示</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/27f6f2ef47404eb48ed10e6ee379ade8><p class=pgc-img-caption>图1 文档表格、控件</p></div><p>(二)设置命令按钮属性。如下图所示</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5753e9c0ecb94df7ac3bce2b728afce2><p class=pgc-img-caption>图2 命令按钮属性</p></div><p>二、用公式串实现高级计算的后台功能代码</p><p>(一)ThisDocument里面的功能代码：</p><p>Private Sub Document_Open()</p><p>Set mt = ActiveDocument.Tables(1) '表格对象mt指向表格集合Tables的第一个表格</p><p>'当每次打开word文档后，即刻寻找是否存在背景色为蓝色的单元格，如果有直接退出并且记录到c对象中去，否则什么都不做</p><p>For Each c In mt.Range.Cells</p><p>If c.Shading.BackgroundPatternColor = wdColorBlue Then</p><p>Exit For</p><p>End If</p><p>Next</p><p>End Sub</p><p>Private Sub CalcBtn_Click()</p><p>Call Run_Calculate_Work</p><p>End Sub</p><p>Private Sub ClearBtn1_Click()</p><p>Call Clear_Result_Before</p><p>End Sub</p><p>(二)插入的模块1 里面的代码：</p><p>Public mt As Table, c As Cell '定义mt为公有属性表格对象变量,定义临时c单元格为全局变量</p><p>Public i, j As Integer '定义公有属性的计算结果单元格行i、列j号(格式如：1，3)</p><p>Sub Run_Calculate_Work() '运行计算工作</p><p>Dim rg As String, Error_Prompt As String 'rg为范围字符串变量，Error_Prompt为输入框内容是否为空或格式错误提示字符串变量</p><p>Retry:</p><p>Inputbox_title = "提示：“行号”介于2--" & mt.Rows.Count & "之间,“列号”介于1--" & mt.Columns.Count & "之间"</p><p>k = InputBox("请输入结果单元格行i、列j号(格式如：1，3):", Inputbox_title)</p><p>'以下变量Error_Prompt是根据输入对话框存于k中的内容判定获取错误提示内容</p><p>Error_Prompt = IIf(Len(k) = 0, "为空！", "“" & k & "”格式错误！" & Chr(10) & "(参照输入格式形如：1，3)")</p><p>If StrPtr(k) &lt;> 0 Then</p><p>If InStr(k, "，") Or InStr(k, ",") Then</p><p>If InStr(k, "，") Then k = Replace(k, "，", ",") '将有可能输入汉字标点的逗号"，"统统强制转换为西文标点的逗号","</p><p>i = Val(Left(k, InStr(k, ",") - 1))</p><p>j = Val(Right(k, Len(k) - InStr(k, ",")))</p><p>If (i &lt;= 1 Or i > mt.Rows.Count) Or (j &lt; 1 Or j > mt.Columns.Count) Then</p><p>MsgBox "输入内容" & Error_Prompt & Chr(10) & "请重新输入！！！", vbInformation, "提示"</p><p>GoTo Retry</p><p>Else</p><p>If Not (c Is Nothing) Then Call Clear_Result_Before '根据对象是否为未指派具体实例的空对象，非空即刻清除原先的结果值</p><p>Set c = mt.Cell(i, j) '单元格对象c指向具体的mt表格对象的单元格Cell(i,j)</p><p>rg = "Cell(" & 1 & "," & 1 & ")" & ":" & "Cell(" & 1 & "," & 4 & ")"</p><p>MsgBox "计算区域是：" & rg, vbInformation, "提示"</p><p>c.Range.Text = ""</p><p>c.Shading.BackgroundPatternColor = wdColorAutomatic '将单元格c背景色填充颜色重置为无填充</p><p>Calc rg, c '调用自定义的求和过程</p><p>End If</p><p>Else</p><p>MsgBox "输入内容" & Error_Prompt & Chr(10) & "请重新输入！！！", vbInformation, "提示"</p><p>GoTo Retry</p><p>End If</p><p>Else</p><p>MsgBox "您点击列&lt;取消>按钮或&lt;X>关闭按钮！" & Chr(10) & "因而也取消了计算区域数据的操作！", vbInformation, "提示"</p><p>End If</p><p>End Sub</p><p>Sub Clear_Result_Before()</p><p>If c Is Nothing Then</p><p>MsgBox "无结果数据，清除被禁止！", vbInformation, "提示"</p><p>Else</p><p>c.Range.Text = ""</p><p>c.Shading.BackgroundPatternColor = wdColorAutomatic</p><p>c.Shading.BackgroundPatternColor = wdColorBlue '重新将c单元格着色为蓝色，以便下面消息框显示后c单元格颜色暂留</p><p>MsgBox "清除计算结果单元格Cell(" & c.RowIndex & "," & c.ColumnIndex & ")的数据成功！", vbInformation, "提示"</p><p>c.Shading.BackgroundPatternColor = wdColorAutomatic '清除c单元格着色</p><p>Set c = Nothing '将定义的单元格变量对象重新恢复为空对象(即取消其指派的具体实例单元格)</p><p>End If</p><p>End Sub</p><p>Sub Calc(rg As String, c) '构造表格区域求和计算过程</p><p>Dim rg1 As String, rg2 As String, colstr As String, c1str As String, c2str As String</p><p>Dim r1 As Integer, c1 As Integer, r2 As Integer, c2 As Integer</p><p>colstr = "abcdefghijklmnopqrstuvwxyz" 'a--z单元格的列字符串，用于取出a--z中需要的列字符</p><p>If InStr(rg, "Cell") = 0 Or InStr(rg, ":") = 0 Or InStr(rg, ",") = 0 Then</p><p>MsgBox "error!"</p><p>Else</p><p>'rg计算数据区域范围字符串分解为前后纯的单元格的两个子字符串rg1、rg2</p><p>rg1 = Left(rg, InStr(rg, ":") - 1)</p><p>rg2 = Right(rg, Len(rg) - InStr(rg, ":"))</p><p>r1 = Val(Mid(rg1, InStr(rg1, "(") + 1, Len(rg1) - InStr(rg1, ",") - 1)) '拆解出计算区域首单元格的行号</p><p>c1 = Val(Mid(rg1, InStr(rg1, ",") + 1, InStr(rg1, ")") - InStr(rg1, ",") - 1)) '拆解出计算区域首单元格的列号</p><p>r2 = Val(Mid(rg2, InStr(rg2, "(") + 1, Len(rg2) - InStr(rg2, ",") - 1)) '拆解出计算区域尾单元格的行号</p><p>c2 = Val(Mid(rg2, InStr(rg2, ",") + 1, InStr(rg2, ")") - InStr(rg2, ",") - 1)) '拆解出计算区域尾单元格的列号</p><p>'通过列查找字符串，获取首尾单元格的“列”字符</p><p>c1str = Mid(colstr, c1, 1): c2str = Mid(colstr, c2, 1)</p><p>rg = c1str & r1 & ":" & c2str & r2 '重新生成的标准格式(形如A3:E8形式的范围)字符串赋予变量rg以覆盖原先的初始值</p><p>c.Formula "=sum(" & rg & ")" '单元格对象变量通过.Formula方法带参数形式运用公式进行计算</p><p>c.Shading.BackgroundPatternColor = wdColorBlue '将单元格c背景色填充为蓝色</p><p>End If</p><p>End Sub</p><p>三、测试设计的Word高级计算功能文档</p><p>(一)准备点击计算按钮：如下图</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/935d276f03ba4bb7ad064aaeea88cfda><p class=pgc-img-caption>图3 准备开始计算</p></div><p>(二)在输入框输入计算结果单元格的行、列：如下图</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2d3cc359e1bc4f84a156c69f41f9b95b><p class=pgc-img-caption>图4 输入行列</p></div><p>(三)点确定即可看到显示计算的数据区域信息：如下图</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/31ac27ed6ed348bab61122e025db7712><p class=pgc-img-caption>图5 显示计算的数据区域信息</p></div><p>(四)点确定即刻生成计算结果数据：如下图</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/506b2b9d652b48e0aca0baa8e6e055f0><p class=pgc-img-caption>图6 生成计算的结果</p></div><p>(五)再次计算时输一个不符合规范的公式，会发现报错提示，并要求重新输入符合规范的公式：如下图</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/84aabb885ecc42b2b97c36f9b08c575b><p class=pgc-img-caption>图7 不规范的公式输入报错</p></div><p>(六)点清除结果数据按钮准备开始结果数据：如下图</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/16078d6c78f6491ebc7b9f38faab956b><p class=pgc-img-caption>图8 准备开始清除数据</p></div><p>(七)点击清除数据按钮后，原来的计算结果数据即刻被清除，同时原先结果数据单元格的背景色由蓝色恢复到无填充色状态：如下图9、图10</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/be9b9bb3e41f47d79e577718839ceb11><p class=pgc-img-caption>图9 清除数据的提示</p></div><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cfa84f1f65514fa0a8417fe67fd78836><p class=pgc-img-caption>图10 清除数据的结果</p></div><p>(八)无结果数据情况下再次试图点击清除计算结果，发现操作被禁止：如下图</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/df168d6cdf824e04865ad5c57ac3e752><p class=pgc-img-caption>图11 无结果数据清除操作被禁止</p></div><p>四、设计技术亮点小结</p><p>(一)Word文档打开后的初始化工作探测有无上一次计算过的结果数据痕迹：我们是通过探测单元格颜色是否为蓝色的机制进行判别其为上次计算的残留结果数据。关键技术代码截图如下</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2c48677fb0844a3a83c5360e878dd240><p class=pgc-img-caption>图12 探测当前文档打开的上次残留的结果数据单元格</p></div><p>(二)进行计算结果单元格的定位数据输入的规范检查约束机制：充分利用是否还有逗号？是否取出的行、列数据值是否符合输入对话框标题栏提示的要求？是否输入内容为空？是否点击了取消或者关闭按钮取消操作？……等等。代码如下截图所示</p><div class=pgc-img><img alt=头条文章--自定义方式构造Word表格中单元格区域求和子过程 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/495cb8d15bc345ae9f87d3e677997774><p class=pgc-img-caption>图13 输入框输入数据规范学术检查</p></div><p>好了，本期分享就但此结束啦！希望大家对大家高级办公有所借鉴和帮助哦！也愿大家提出更好的解决方案哦！</p><p>最后，同样谢谢大家的关注(头条号：跟我学office高级办公)、推广和点评哦！祝大家工作生活、愉快！秋凉了，大家更要注意身体哦！拜拜啦！</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'头条','--','自定义'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>