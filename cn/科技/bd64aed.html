<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>äº’è”ç½‘JAVAé¢è¯•å¸¸é—®é—®é¢˜-å¸¦ä½ èµ°å…¥AQSåŒæ­¥å™¨æºç  | æå®¢å¿«è¨Š</title><meta property="og:title" content="äº’è”ç½‘JAVAé¢è¯•å¸¸é—®é—®é¢˜-å¸¦ä½ èµ°å…¥AQSåŒæ­¥å™¨æºç  - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/b0ad8c979566419b9e645660d41304d5"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bd64aed.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bd64aed.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/bd64aed.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bd64aed.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bd64aed.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/bd64aed.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/bd64aed.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bd64aed.html><meta property="article:published_time" content="2020-10-29T20:52:26+08:00"><meta property="article:modified_time" content="2020-10-29T20:52:26+08:00"><meta name=Keywords content><meta name=description content="äº’è”ç½‘JAVAé¢è¯•å¸¸é—®é—®é¢˜-å¸¦ä½ èµ°å…¥AQSåŒæ­¥å™¨æºç "><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/bd64aed.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>äº’è”ç½‘JAVAé¢è¯•å¸¸é—®é—®é¢˜-å¸¦ä½ èµ°å…¥AQSåŒæ­¥å™¨æºç </h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><div class=pgc-img><img alt=äº’è”ç½‘JAVAé¢è¯•å¸¸é—®é—®é¢˜-å¸¦ä½ èµ°å…¥AQSåŒæ­¥å™¨æºç  onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b0ad8c979566419b9e645660d41304d5><p class=pgc-img-caption></p></div><p>AbstractQueuedSynchronizer</p><p>é˜Ÿåˆ—å¼çš„åŒæ­¥å™¨ï¼ŒAQSå®šä¹‰äº†ä¸€å¥—å¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„åŒæ­¥å™¨æ¡†æ¶ï¼Œè®¸å¤šåŒæ­¥ç±»å®ç°éƒ½ä¾èµ–äºå®ƒï¼Œå¦‚å¸¸ç”¨çš„ReentrantLock/Semaphore/CountDownLatchã€‚AQSçš„æºç å¦‚ä¸‹ï¼š</p><pre>public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer implements java.io.Serializable {  protected AbstractQueuedSynchronizer() { }  static final class Node { ........ }  private transient volatile Node head;  private transient volatile Node tail;  private volatile int state;  protected final int getState() {  return state; }  protected final void setState(int newState) { state = newState; }  protected final boolean compareAndSetState(int expect, int update) { // See below for intrinsics setup to support this return unsafe.compareAndSwapInt(this, stateOffset, expect, update); }</pre><p>ä»æºç å¯ä»¥çœ‹å‡ºï¼ŒAQSå†…éƒ¨ä½¿ç”¨ä¸€ä¸ªintæˆå‘˜å˜é‡è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¤šçº¿ç¨‹äº‰ç”¨èµ„æºè¢«é˜»å¡æ—¶ä¼šè¿›å…¥æ­¤é˜Ÿåˆ—ï¼Œå…¶ä¸­volatileä¿®é¥°äº†ä»¥ä¸‹å˜é‡ï¼Œæ¥ä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å¯è§ï¼š</p><p>1.å†…éƒ¨çŠ¶æ€state</p><p>2.ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹head</p><p>3.ç­‰å¾…é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹headã€‚</p><p>stateçš„è®¿é—®æ–¹å¼æœ‰ä¸‰ç§:</p><p>1.getState()</p><p>2.setState()</p><p>3.compareAndSetState()</p><p>å…¶ä¸­FIFOé˜Ÿåˆ—çš„å®ç°å¦‚ä¸‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸­ï¼Œé™¤äº†å­˜å‚¨äº†å½“å‰çº¿ç¨‹ï¼Œå‰åèŠ‚ç‚¹çš„å¼•ç”¨ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªwaitStatuså˜é‡ï¼Œç”¨äºæè¿°èŠ‚ç‚¹å½“å‰çš„çŠ¶æ€ï¼ˆå…±å››ç§çŠ¶æ€ï¼š1.CANCELLED å–æ¶ˆçŠ¶æ€ï¼›2.SIGNAL ç­‰å¾…è§¦å‘çŠ¶æ€ï¼›3.CONDITION ç­‰å¾…æ¡ä»¶çŠ¶æ€ï¼›4.PROPAGATE çŠ¶æ€éœ€è¦å‘åä¼ æ’­ ï¼‰</p><pre>static final class Node { static final AbstractQueuedSynchronizer.Node SHARED = new AbstractQueuedSynchronizer.Node(); static final AbstractQueuedSynchronizer.Node EXCLUSIVE = null; static final int CANCELLED = 1; static final int SIGNAL = -1; static final int CONDITION = -2; static final int PROPAGATE = -3; volatile int waitStatus; volatile AbstractQueuedSynchronizer.Node prev; volatile AbstractQueuedSynchronizer.Node next; volatile Thread thread;AbstractQueuedSynchronizer.Node nextWaiter; final boolean isShared() {  return nextWaiter == SHARED;} final AbstractQueuedSynchronizer.Node predecessor() throws NullPointerException { AbstractQueuedSynchronizer.Node p = prev;  if (p == null)  throw new NullPointerException();  else return p; }}</pre><p>AQSçš„ä¸åŒå­ç±»äº‰ç”¨å…±äº«èµ„æºçš„æ–¹å¼ä¹Ÿä¸åŒã€‚AQSå­ç±»ä¸­ï¼Œåªéœ€è¦å®ç°å…±äº«èµ„æºstateçš„è·å–ä¸é‡Šæ”¾æ–¹å¼å³å¯ï¼Œè‡³äºå…·ä½“çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—çš„ç»´æŠ¤ï¼ˆå¦‚è·å–èµ„æºå¤±è´¥å…¥é˜Ÿ/å”¤é†’å‡ºé˜Ÿç­‰ï¼‰ï¼ŒAQSå·²ç»åœ¨é¡¶å±‚å®ç°å¥½äº†ã€‚è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°æ—¶ä¸»è¦å®ç°ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š</p><pre>isHeldExclusively()ï¼šè¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒã€‚tryAcquire(int)ï¼šç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚tryRelease(int)ï¼šç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚tryAcquireShared(int)ï¼šå…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±ï¼›0è¡¨ç¤ºæˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™èµ„æºã€‚tryReleaseShared(int)ï¼šå…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼Œå¦‚æœé‡Šæ”¾åå…è®¸å”¤é†’åç»­ç­‰å¾…ç»“ç‚¹è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</pre><p>åœ¨AQSä¸­ï¼Œæœ‰ä¸¤ç§èµ„æºå…±äº«æ–¹å¼ï¼šExclusiveï¼ˆç‹¬å ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œï¼Œå¦‚ReentrantLockï¼‰å’ŒShareï¼ˆå…±äº«ï¼Œå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶æ‰§è¡Œï¼Œå¦‚Semaphore/CountDownLatchï¼‰ã€‚æ¥ä¸‹æ¥ä¸»è¦ä»‹ç»Exclusiveä¸‹æ˜¯å¦‚ä½•è·å–å’Œé‡Šæ”¾é”çš„ï¼š</p><p>é”è·å–acquire(int)</p><pre> /** * Acquires in exclusive mode, ignoring interrupts. Implemented * by invoking at least once {@link #tryAcquire}, * returning on success. Otherwise the thread is queued, possibly * repeatedly blocking and unblocking, invoking {@link * #tryAcquire} until success. This method can be used * to implement method {@link Lock#lock}. * * @param arg the acquire argument. This value is conveyed to * {@link #tryAcquire} but is otherwise uninterpreted and * can represent anything you like. */ public final void acquire(int arg) {  if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt(); }</pre><p>æ‰€ä»¥åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä¸‹æ­¥éª¤</p><p class=ql-align-justify>1.tryAcquire()å°è¯•ç›´æ¥å»è·å–èµ„æºï¼Œå¦‚æœæˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼›</p><p class=ql-align-justify>2.addWaiter()å°†è¯¥çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶æ ‡è®°ä¸ºç‹¬å æ¨¡å¼ï¼›</p><p class=ql-align-justify>3.acquireQueued()ä½¿çº¿ç¨‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­è·å–èµ„æºï¼Œä¸€ç›´è·å–åˆ°èµ„æºåæ‰è¿”å›ã€‚å¦‚æœåœ¨æ•´ä¸ªç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p><p class=ql-align-justify>4.å¦‚æœçº¿ç¨‹åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œå®ƒæ˜¯ä¸å“åº”çš„ã€‚åªæ˜¯è·å–èµ„æºåæ‰å†è¿›è¡Œè‡ªæˆ‘ä¸­æ–­selfInterrupt()ï¼Œå°†ä¸­æ–­è¡¥ä¸Šã€‚</p><p>é”é‡Šæ”¾release(int)</p><pre> /** * Releases in exclusive mode. Implemented by unblocking one or * more threads if {@link #tryRelease} returns true. * This method can be used to implement method {@link Lock#unlock}. * * @param arg the release argument. This value is conveyed to * {@link #tryRelease} but is otherwise uninterpreted and * can represent anything you like. * @return the value returned from {@link #tryRelease} */ public final boolean release(int arg) {  if (tryRelease(arg)) { Node h = head;  if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h);  return true; }  return false; }</pre><p>æ­¤æ–¹æ³•æ˜¯ç‹¬å æ¨¡å¼ä¸‹çº¿ç¨‹é‡Šæ”¾å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£ã€‚å®ƒä¼šé‡Šæ”¾æŒ‡å®šé‡çš„èµ„æºï¼Œå¦‚æœå½»åº•é‡Šæ”¾äº†ï¼ˆå³state=0ï¼‰,å®ƒä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—é‡Œçš„å…¶ä»–çº¿ç¨‹æ¥è·å–èµ„æºã€‚å®ƒè°ƒç”¨tryRelease()æ¥é‡Šæ”¾èµ„æºã€‚</p><p>å°ç»“</p><p>æœ€åå†å›é¡¾ä¸€ä¸‹AQSçš„åº”ç”¨ï¼Œä»¥åŠReentrantLockæ˜¯å¦‚ä½•å®ç°çš„</p><p>ReentrantLockä¸­stateåˆå§‹åŒ–ä¸º0ï¼Œè¡¨ç¤ºæœªé”å®šçŠ¶æ€ã€‚å½“ä¸€ä¸ªçº¿ç¨‹lock()æ—¶ï¼Œä¼šè°ƒç”¨tryAcquire()ç‹¬å è¯¥é”å¹¶å°†state+1ã€‚æ­¤åï¼Œå…¶ä»–çº¿ç¨‹å†tryAcquire()æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ°æ­¤çº¿ç¨‹unlock()åˆ°state=0ï¼ˆå³é‡Šæ”¾é”ï¼‰ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”ã€‚å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼Œè¿™ä¸ªçº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„ï¼ˆstateä¼šç´¯åŠ ï¼‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šä¹ˆæ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯stateæ˜¯èƒ½å›åˆ°é›¶æ€çš„ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨è¦ä¹ˆæ˜¯ç‹¬å æ–¹æ³•ï¼Œè¦ä¹ˆæ˜¯å…±äº«æ–¹å¼ï¼Œä»–ä»¬ä¹Ÿåªéœ€å®ç°tryAcquire-tryReleaseã€tryAcquireShared-tryReleaseSharedä¸­çš„ä¸€ç§å³å¯ã€‚ä½†AQSä¹Ÿæ”¯æŒè‡ªå®šä¹‰åŒæ­¥å™¨åŒæ—¶å®ç°ç‹¬å å’Œå…±äº«ä¸¤ç§æ–¹å¼ï¼Œå¦‚ReentrantReadWriteLockã€‚</p><p><strong>æ›´å¤šå¹²è´§å†…å®¹ï¼Œè½¬å‘+å…³æ³¨ã€‚ç§ä¿¡æˆ‘â€œèµ„æ–™â€å³å¯è·å–ã€‚</strong></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'äº’è”ç½‘','JAVA','é¢è¯•'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>