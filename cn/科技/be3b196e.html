<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>正点原子开拓者NiosII资料连载第二十六章高速示波器实验 | 极客快訊</title><meta property="og:title" content="正点原子开拓者NiosII资料连载第二十六章高速示波器实验 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/9d1edd66723f4966b44d3cab502c055f"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/be3b196e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/be3b196e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/be3b196e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/be3b196e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/be3b196e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/be3b196e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/be3b196e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/be3b196e.html><meta property="article:published_time" content="2020-10-29T21:11:00+08:00"><meta property="article:modified_time" content="2020-10-29T21:11:00+08:00"><meta name=Keywords content><meta name=description content="正点原子开拓者NiosII资料连载第二十六章高速示波器实验"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/be3b196e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>正点原子开拓者NiosII资料连载第二十六章高速示波器实验</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>1）实验平台：正点原子开拓者FPGA 开发板</p><p style=text-align:start>2）摘自《开拓者 Nios II开发指南》关注官方微信号公众号，获取更多资料：正点原子</p><p style=text-align:start>3）全套实验源码+手册+视频下载地址：http://www.openedv.com/docs/index.html</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9d1edd66723f4966b44d3cab502c055f><p class=pgc-img-caption></p></div><p><strong>第二十六章基于高速AD/DA模块的示波器实验</strong></p><p>示波器在电子测量、测试仪器中有着很广泛的应用，是观察电路实验现象、分析实验中</p><p>的问题、测量实验结果的利器。根据示波器组成原理的不同，它分为模拟示波器和数字示波</p><p>器。本章我们将使用正点原子FPGA开发板和高速AD/DA模块来实现一个数字存储示波器。</p><p>本章包括以下几个部分：</p><p>26.1 数字存储示波器简介</p><p>26.2 实验任务</p><p>26.3 硬件设计</p><p>26.4 软件设计</p><p>26.5 下载验证</p><p><strong>数字存储示波器简介</strong></p><p>模拟示波器利用电子示波管的特性，将人眼无法直接观测的交变电信号转换成图像，将</p><p>其显示在荧光屏上以便观察测量。数字存储示波器 (Digital Storage Oscilloscope，DSO)</p><p>通过高速采样及高精度AD转换, 将信号波形数字化, 然后对数字结果进行存储、处理并显</p><p>示。它在波形记录、分析和比较等方面较模拟示波器有很大的改进。</p><p>图 26.1.1是一个数字存储示波器的实物图，图 26.1.2是它的控制面板示意图。</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/46c263ae51c14d478aa23b1f06ae41a0><p class=pgc-img-caption></p></div><p>图 26.1.1 数字存储示波器实物图</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/062d842b83e24d19acea078e9939d124><p class=pgc-img-caption></p></div><p><br></p><p>图 26.1.2 示波器控制面板</p><p>从上面两幅图中我们可以看出，示波器的控制面板上有各种按钮及旋钮。也就是说DSO除</p><p>了能够显示波形及测量信号的各种参数之外，还包含了一系列的控制功能，比如触发控制、</p><p>水平、竖直方向的控制等。这些功能是为了帮助我们获取期望的触发信号，同时方便我们去</p><p>观察、分析信号波形。下面我们来介绍几组用示波器测量信号时常用的功能键：</p><p>1、</p><p>运行控制（Run Control）</p><p>（1） 自动设置（<strong>AUTO</strong>）：数字示波器一般具有自动设置的功能。根据输入的信号，</p><p>可自动调整电压倍率、时基、以及触发方式使波形以最好的形态显示。</p><p>（2） 运行/停止（<strong>RUN</strong>/<strong>STOP</strong>）：运行时可以实时观测波形的动态变化，停止时可以静</p><p>态地观察分析信号。</p><p>2、</p><p>触发控制（Trigger）</p><p>（1） 触发边沿（<strong>EDGE</strong>）：可以选择在波形的上升沿或者下降沿来触发信号的采</p><p>集、存储和显示。</p><p>（2） 触发电平（<strong>LEVEL</strong>）：可以增大或减小触发电平，信号到达触发电平的位置时</p><p>才满足触发条件。</p><p>3、</p><p>水平控制（Horizontal）</p><p>（1） 位置（<strong>POSITION</strong>）：调整信号在波形窗口的水平位置，使波形在水平方向左移</p><p>或者右移。</p><p>（2） 缩放（<strong>SCALE</strong>）：改变水平档位，即水平方向上每格所代表的时间，单位为 s/div</p><p>（秒/格）。</p><p>4、</p><p>竖直控制（Vertical）</p><p>（1） 位置（<strong>POSITION</strong>）：调整信号在波形窗口的竖直显示位置，使波形在竖直方向</p><p>上移或者下移。</p><p>（2） 缩放（<strong>SCALE</strong>）：改变竖直档位，即竖直方向上每格所代表的电压，单位为 V/div</p><p>（伏/格）。</p><p><strong>实验任务</strong></p><p>本章我们要利用正点原子高速AD/DA模块，在开拓者FPGA开发板上实现一个数字存储示波</p><p>器，利用4'3寸RGB屏显示波形和界面。要求能够测量信号的频率和峰峰值，同时实现波形的</p><p>运行控制、触发控制以及水平和竖直方向控制。</p><p><strong>硬件设计</strong></p><p>本次实验用到了正点原子高速AD/DA模块，以及4'3寸RGB TFT-LCD模块，我们在“高速AD/DA实验”以及“RGB TFT-LCD彩条显示实验”里介绍了这两个模块的硬件设计和驱动方</p><p>法。如果对这部分内容不熟悉的话，建议先参考下《开拓者FPGA开发指南》的相关章节。</p><p>首先，我们把示波器的功能实现划分为两部分，“波形的绘制”和“用户界面的绘</p><p>制”。其中由于波形的实时显示对图像的刷新速率要求较高，因此适合用硬件来实现，即采</p><p>用Verilog HDL来设计；而用户界面的绘制比较复杂，适合用软件来实现，即在嵌入式处理器</p><p>Nios II中采用C语言来设计。</p><p>在软硬件划分之后，我们来看一下整个系统的实现方案，如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/75dde612e6e848109e1524c77b82ecbd><p class=pgc-img-caption></p></div><p><br></p><p>图 26.3.1 示波器系统框图</p><p>外部的模拟信号，经过高速AD/DA模块上的模数转换器AD9280，转换成8位数字信号输入</p><p>FPGA。进入FPGA后该数字信号分成两路，一路输入到测量模块，用于测量信号的频率和峰峰</p><p>值；另外一路需要对数据进行抽样，抽取后的数据写到双口RAM中，在此过程中还要不停地判</p><p>断触发条件，一旦满足触发条件，就记录此时的RAM地址用于绘制波形。</p><p>在整个过程中，Nios II通过Avalon-MM端口控制各个模块的工作，比如读取信号的频率</p><p>和峰峰值、设置抽取过程中的抽样率、设置触发条件、以及控制波形的平移和缩放等。除此</p><p>之外，Nios II还负责完成用户界面（User Interface, UI）的绘制，并根据触摸屏输入的触</p><p>摸点座标来判断用户的按键操作。</p><p>上图中SDRAM用作UI绘制过程中的显存，RGB LCD驱动模块从显存中读出UI，并与Verilog</p><p>绘制的波形叠加后显示在屏幕上，从而完成示波器的显示部分。</p><p>整个系统的设计方案确定之后，我们还需要完成用户界面的设计。这里只是把期望的用</p><p>户界面用绘图工具给画出来，并不包括具体的实现。根据实验任务的要求，用户界面应该包含13个按键用来实现波形的控制，同时能够显示测量信号的参数。为了方便用户操作，还应</p><p>该包含示波器当前的设置信息。最终设计出来的用户界面如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/571c1ea3874f42bea0de36fffde18f3c><p class=pgc-img-caption></p></div><p><br></p><p>图 26.3.2 用户界面</p><p>上面的UI设计我们将在Nios II中采用uC/GUI来实现，这部分内容会在接下来的软件设计</p><p>中讨论，我们先对照着图 26.3.1来看一下底层硬件中各个模块的设计思路。</p><p><strong>测量模块</strong></p><p>参数测量模块param_measure负责测量输入信号的峰峰值和频率，其模块接口定义如下图</p><p>所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/dd89e86bcb2b493586a166603bcdee53><p class=pgc-img-caption></p></div><p><br></p><p>图 26.3.3 测量模块及其接口定义</p><p>模块输入端除了AD采样时钟ad_clk和采样数据ad_data之外，还有一个信号trig_level，</p><p>这个是用户所设置的触发电平。模块输出端包括信号的最大值、最小值、峰峰值（最大值减</p><p>最小值）以及信号的频率。</p><p>参数测量模块内部例化了3个子模块，如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2f9cddd7f77c4f429e0770109834b388><p class=pgc-img-caption></p></div><p><br></p><p>图 26.3.4 参数测量模块框图</p><p>3个子模块中，峰峰值测量模块（vpp_measure）和频率计模块（cymometer）分别负责测</p><p>量信号的峰峰值和频率。其中，频率计模块直接调用了我们在“频率计实验”中所设计的等</p><p>精度频率计；而峰峰值测量模块则通过不断地比较在一个信号周期内输入的AD采样值的大</p><p>小，筛选出最大值和最小值，从而计算出信号的峰峰值。</p><p>需要注意的是，等精度频率计的输入信号是高低电平（具体参考频率计实验），而AD采</p><p>样后得到的是8位数据ad_data，因此我们需要根据输入的触发电平trig_level将输入信号转</p><p>换成高低电平（脉冲）。</p><p>脉冲生成模块（pulse_gen）就是用来完成上述的过程，方法很简单，判断输入信号与触</p><p>发电平的大小：当ad_data大于trig_level时，输出的脉冲ad_pulse为高电平，反之为低电</p><p>平。如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2e73c6da058d492bb04af689a624899c><p class=pgc-img-caption></p></div><p>图 26.3.5 脉冲生成</p><p>峰峰值测量模块同样是利用pulse_gen模块所输出的脉冲ad_pulse来标识输入信号的周</p><p>期，从而筛选出每个周期内的最大值和最小值。</p><p><strong>抽取模块</strong></p><p>抽取模块decimator负责对输入的AD数据进行抽样，其模块接口定义如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/568c42bef8be49109c0796eec2660563><p class=pgc-img-caption></p></div><p><br></p><p>图 26.3.6 抽取模块及其接口定义</p><p>抽取模块的接口比较简单，根据输入端的抽样率deci_rate，输出抽取有效信号</p><p>deci_valid。实际上它的工作原理也很简单，我们只需要定义一个计数器，每次计数到所设</p><p>置的抽样率就输出一个抽取有效信号，然后从0开始重新计数。比如说抽样率为10，那么每隔</p><p>10个时钟周期就输出一个时钟周期的有效信号，也就是说AD采集到的连续十个数据中只有一</p><p>个是有效的。</p><p>那么我们抽样的目的是什么呢？因为AD的采样率比较高，本次实验里输出的AD时钟</p><p>ad_clk为30MHz。假设输入的模拟信号是频率为1MHz的正弦波，那么每个周期的信号AD可以采</p><p>到30个数据。我们屏幕上用来显示波形的区域在水平方向上有300个像素点，那么就可以显示</p><p>10个周期的信号波形，每个周期由30个点组成。</p><p>但是如果输入的模拟信号频率为1KHz，那么每个周期AD可以采到30_000个数据</p><p>（30MHz/1KHz）。如果AD得到的每个数据都用来绘制波形的话，那么满屏就只能够显示该信</p><p>号0.01个周期的波形，也就是一个周期正弦波的百分之一。此时我们在屏幕上看到的波形根</p><p>本看不出来是个正弦波，可能就是一小段斜线。</p><p>在这个时候我们就需要对AD得到的数据进行抽样，等间距地每1000个点取一个用于绘制</p><p>波形，那么每个信号周期可以抽样到30个点。这样就可以在屏幕上看到10个周期的正弦波，</p><p>此时的抽样率就是1000。如果此时抽样率是100，那么一个信号周期里刚好可以抽取300个数</p><p>据用于绘制波形，刚好铺满整个波形区域。</p><p>在抽样率从1000减小到100的过程中，屏幕上显示的波形从10个周期变成了1个周期，相</p><p>当于波形在水平方向上进行了放大，这样就方便我们观察波形的细节。同理，如果我们需要</p><p>在水平方向上缩小波形的话，就增加抽样率，这样就可以同时观察多个周期的波形。</p><p><strong>触发和存储模块</strong></p><p>触发模块负责检测信号何时满足触发条件，而存储模块则将抽取之后的AD数据存到双口</p><p>RAM中。由于这两个模块关联比较紧密，因此在本次设计中将触发模块并入存储模块</p><p>data_store中，其接口定义如下所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bb8b484d3add4e50993fba9c69c408b5><p class=pgc-img-caption></p></div><p><br></p><p>图 26.3.7 存储模块及其接口定义</p><p>数字存储示波器的一个优点就是我们可以同时观察到触发条件发生前后的信号波形。触</p><p>发条件包括触发电平（trig_level）和触发沿（trig_edge），可以看到这两个条件都是存储</p><p>模块（data_store）的输入信号。如果设置的是上升沿触发，那么在抽样后的AD数据到达触</p><p>发电平时，还要判断前一个数据是否小于触发电平。如果前一个数据小于触发电平，同时当前数据大于或等于触发电平，那么就满足触发条件。同样，如果是下降沿触发，就要判断前</p><p>一个数据是否大于触发电平。</p><p>数字存储示波器为了能够在停止运行（STOP）的时候重现波形，需要将AD得到的数据存</p><p>储起来，然后再用于绘制波形。在这里我们例化一个双口RAM用于存储AD数据，存储深度为</p><p>300，即波形显示区域的水平方向的分辨率。当抽样有效信号deci_valid拉高时，将抽样后的</p><p>数据写入RAM中，写入的地址从0开始依次累加，累加到299的时候地址归零，如此周而复始。</p><p>在这里我们需要注意的是，为了能够观察触发时刻前后的信号波形，我们需要记录触发</p><p>点数据写入RAM的地址。在达到触发条件后，我们继续存储150个数据，然后等待波形绘制结</p><p>束。这样的话，在触发点前后波形数据各占一半。为了使触发点处于波形显示区域的中间位</p><p>置，我们要根据记录的触发点数据的RAM地址，计算出当前所绘制波形的第一个点的RAM地</p><p>址，然后向后依次读出300个点，在波形显示区域里从左向右依次绘制波形。</p><p>在前面我们讲过改变抽样率的大小可以完成波形在水平方向上的缩放，那么水平方向上</p><p>的平移怎么实现呢？数据存储模块的输入端有一个h_shift信号，它指示波形在水平方向上平</p><p>移的距离。我们根据h_shift的值，改变读RAM的地址就可以了。比如波形左移的话，读RAM的</p><p>地址应该加上h_shift，相当于把右侧的波形数据显示在了当前位置；同理，波形右移的话，</p><p>读RAM的地址应该减去h_shift。</p><p><strong>绘波形模块</strong></p><p>波形绘制模块负责根据从存储模块读出的AD数据来绘制波形，其接口定义如下所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4932c07749db4ae6ba031785b9ece303><p class=pgc-img-caption></p></div><p><br></p><p>图 26.3.8 绘波形模块及其接口定义</p><p>在波形绘制模块的输入端有两个信号v_scale和v_shift，这两个信号控制着显示波形在</p><p>竖直方向上的缩放和平移。这个实现起来比较简单，我们只需要根据缩放比例（v_scale）将</p><p>从RAM中读出的AD数据进行乘、除运算，然后根据竖直方向上的平移距离（v_shift）将运算</p><p>后的数据进行加、减运算即可。</p><p>波形绘制模块例化了两个子模块，如图 26.3.9所示。其中LCD驱动模块（lcd_driver）</p><p>模块负责完成4.3寸RGB LCD的驱动，同时会输出当前像素点的座标。而LCD显示模块</p><p>（lcd_display）则根据驱动模块输出的像素点座标来控制数据请求信号（data_req）。数据</p><p>请求信号会作为RAM的读使能信号，从RAM中读出AD数据。最后显示模块根据读出的数据绘制</p><p>波形，绘制波形最简单的方法就是，判断当前像素点的纵座标是否等于读出的AD数据</p><p>（line_length），如果等于的话就把当前像素点赋值为白色（波形颜色），不等于的话就赋</p><p>值为黑色（背景色）。这种方法画出来的波形是由一个个独立的点组成的虚线，我们还要在</p><p>此基础上用直线把这些点连接起来。除此之外，我们还要考虑到波形的缩放和平移等其他的</p><p>因素。</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6da46ba06b6e4fd1babfcd51101aee35><p class=pgc-img-caption></p></div><p><br></p><p>图 26.3.9 波形绘制模块框图</p><p>需要注意的是，我们在这个模块中还完成了把波形和UI界面集成到一起的功能。在模块</p><p>的输出端口还有一个fifo_data_req信号，这个信号会从显存SDRAM中请求数据，它请求的数</p><p>据（fifo_pixel_data）就是我们所绘制的UI界面的各像素点颜色值。</p><p>我们前面在绘制波形的时候，会把波形所在的像素点赋值为白色，而背景区域赋值为黑</p><p>色。现在为了把波形和UI界面叠加起来，就要把除了波形所在的像素点之外的其他区域（包</p><p>括波形的黑色背景），赋值为从显存中读出的UI界面像素点颜色值（fifo_pixel_data）。</p><p><strong>Avalon-MM接口模块</strong></p><p>到这里我们示波器方案中有关参数测量及波形绘制的功能模块基本上就介绍完了，但是</p><p>实际上还有一个模块是没有画出来的，就是avalmm_interface模块。</p><p>前面我们介绍的模块它们都是由Nios II控制的，Nios II会向这些模块传递相应的控制</p><p>参数，比如说触发电平、抽样率、波形的缩放比例等。而avalmm_interface模块就是Nios II</p><p>处理器与这些模块之间的接口，Nios II与avalmm_interface模块按照Avalon-MM总线协议通</p><p>信，其中Nios II作为主端口（Master），而avalmm_interface模块实现了从端口（Slave）</p><p>的功能。在avalmm_interface模块中定义了一组寄存器，每个寄存器有对应的地址，Nios II</p><p>可以根据地址将控制参数按照Avalon-MM总线协议写入相应的寄存器中，然后该模块会将这些</p><p>控制参数传递到相应的各个功能模块。</p><p>avalmm_interface模块的接口定义如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f374320f41ce4a81b973bf7c5a283021><p class=pgc-img-caption></p></div><p><br></p><p>图 26.3.10 Avalon-MM 接口模块</p><p>在介绍完各功能模块后，接下来我们在软件设计部分介绍一下如何实现UI界面的绘制，以及如何利用触摸屏来实现与用户的交互。</p><p><strong>软件设计</strong></p><p>示波器的UI界面比较复杂，包括示波器的各个功能按键、波形的频率与峰峰值、水平零</p><p>点位置与垂直零点位置等。为了提高UI界面的开发效率，UI界面的绘制我们将在Nios II中采</p><p>用uC/GUI来实现，这样将会大大提高UI界面的开发效率以及降低UI界面绘制的复杂度。如果</p><p>对uC/GUI这部分内容不熟悉的话，建议先参考下《Nios II开发指南》中uC/GUI相关的章节。</p><p>Nios II除了负责完成用户界面的绘制外，还根据触摸屏输入的触摸点座标来判断用户的</p><p>按键操作，根据用户的按键操作给硬件的各个模块发送参数，从而控制波形的显示。触摸驱</p><p>动可以在Nios II中通过C语言来编写，当然也可以在硬件中通过Verilog语言来编写，我们在</p><p>“MCU TFT-LCD画板实验”中已经对电容屏的触摸驱动作了详细的讲解，并在Nios II中使用C</p><p>语言来驱动触摸屏。本次实验触摸屏的驱动是在硬件中使用Verilog语言实现，Nios II通过</p><p>Avalon-MM端口来获取触摸驱动模块输出的触摸点的座标。</p><p><strong>触摸屏驱动模块</strong></p><p>事实上，触摸屏驱动模块是在硬件设计中实现的，只不过这个模块的数据接口并没有直</p><p>接和其它模块做交互，而是通过Avalon-MM接口来向Nios II传输座标值。触摸屏驱动模块完</p><p>成对触摸屏按键的检测与触摸点座标的获取，其模块接口定义如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/58176eca57b8498e9107c7ccc0aff962><p class=pgc-img-caption></p></div><p><br></p><p>图 26.4.1 触摸屏驱动模块</p><p>需要说明的是，触摸屏驱动模块只针对4.3寸RGB LCD屏的触摸驱动，其触摸芯片为</p><p>GT9147。触摸屏驱动模块通过IIC接口检测到屏幕被按下后，会拉高touch_done信号，并输出</p><p>触摸点的个数（tp_num）以及触摸点的座标（tp1_xy~tp5_xy），不过触摸点的个数以及触摸</p><p>点的座标在本次实验并没有用到，而是通过Avalon-MM接口来向Nios II传输座标值，这样将</p><p>会大大减少Nios II和触摸屏驱动模块之间端口连接的数量。</p><p>触摸屏驱动模块例化了两个子模块，如图 26.4.2所示。其中GT9147配置模块</p><p>（gt9147_cfg）用于初始化触摸屏，即通过IIC接口对GT9147进行配置，并在配置完成后拉高</p><p>配置完成信号（cfg_done）。而GT9147驱动模块（gt9147_ctrl）负责控制触摸屏驱动的整个</p><p>流程，包括控制触摸屏初始化的开始、检测触摸屏是否被按下以及读取触摸点的座标，同时</p><p>GT9147驱动模块也实现了Avalon-MM接口从端口（Slave）的功能。</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cdc7a1af3420402682495e32034fa4bc><p class=pgc-img-caption></p></div><p><br></p><p>图 26.4.2 触摸屏模块框图</p><p>GT9147配置模块例化了以下三个模块，分别是信号切换模块（signal_switch）、IIC驱</p><p>动模块（i2c_dri_m）和i2c参数配置模块（i2c_reg_cfg），如图 26.4.3所示。</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ac1edb32e90248be8c332635d3d352e2><p class=pgc-img-caption></p></div><p>图 26.4.3 GT9147配置模块框图</p><p>需要注意的是，这里的IIC驱动模块和“EEPROM读写实验”中所使用的IIC驱动模块有些</p><p>区别，在“EEPROM读写实验”中，IIC驱动模块只支持单次读写，并不支持连续的读写。由于</p><p>触摸屏的初始化参数比较多，并且在读取触摸点座标时也会对IIC接口进行连续的读操作，因</p><p>此本次实验在此基础上，增加了对IIC接口连续读写的功能，单次操作连续读写的次数由</p><p>reg_num进行设置，这样将会大大提高IIC读写的速度。当IIC单个地址读写完成后，IIC驱动</p><p>模块会输出一个单次完成的脉冲信号（once_done）；当IIC单次操作完成后（连续地址读写</p><p>完成），会输出一个IIC操作完成的脉冲信号（i2c_done）。</p><p>IIC参数配置模块寄存了触摸屏初始化参数，共需要配置186个寄存器。当输入的配置切</p><p>换信号（cfg_switch）为高电平时，开始初始化触摸屏，并在初始化完成后拉高cfg_done信</p><p>号。</p><p>由于GT9147驱动模块的读写操作和IIC参数配置模块的初始化操作都会用到IIC接口，因</p><p>此这两个模块输出的端口信号需要先做一个选择，再连接到IIC的驱动模块中，信号选择的功</p><p>能是由信号切换模块实现的。这个模块实现的方法也比较简单，根据输入的cfg_switch信号</p><p>的高低电平进行选择。当cfg_switch为高电平时，将IIC参数配置模块的IIC操作端口信号连</p><p>接至IIC驱动模块；当cfg_switch为低电平时，将GT9147驱动模块的IIC操作端口信号连接至</p><p>IIC驱动模块。</p><p><strong>SDRAM桥控制模块</strong></p><p>Nios II采用uC/GUI绘制UI界面，将像素数据写入SDRAM中，并最终显示在 RGB LCD屏</p><p>上。这就要求SDRAM读出数据的速度比较快，因此我们使用具有突发读写能力的Avalon-MM</p><p>Pipeline Bridge IP核来和SDRAM进行数据通信。SDRAM桥控制模块从SDRAM中读出数据，将其</p><p>缓存至FIFO中，并根据FIFO中数据的个数来判断是否继续从SDRAM中读出数据。其模块接口定</p><p>义如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/643ad21e76cc4d3580db557dbec90137><p class=pgc-img-caption></p></div><p><br></p><p>图 26.4.4 SDRAM桥控制模块</p><p><strong>Qsys系统搭建</strong></p><p>在介绍完触摸驱动模块和SDRAM桥控制模块之后，接下来我们来介绍下Qsys系统环境的搭</p><p>建，如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/093070699dd94ad48738b2e7f10a222e><p class=pgc-img-caption></p></div><p>图 26.4.5 Qsys系统的搭建</p><p>Qsys系统使用的IP核，在我们前面的实验中也都有涉及，其中mm_bridge为Avalon-MM</p><p>Pipeline Bridge IP核，用于以突发的方式从SDRAM中读出数据；avalon_mm_bridge_0和</p><p>avalon_mm_bridge_1为自定义的IP核，分别用于获取触摸点座标和配置显示界面的参数，关</p><p>于自定义IP核的添加方法请参考“自定义IP核—数码管”实验章节；pio_tp_int为PIO IP</p><p>核，用于连接触摸屏模块输出的touch_done（触摸完成信号），同时该PIO IP核设置了上升</p><p>沿触发中断的功能，作为Nios II开始读取座标点的标志；pio_lcd_rst同样为PIO IP核，只</p><p>不过该IP核是作为Nios II的输出端口，用于控制LCD屏的复位；最后是添加的定时器IP核</p><p>（timer），用于定时获取硬件中波形的频率和峰峰值。</p><p>Qsys系统模块接口如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/25008170ef2e4cafbfc8a52c3a941488><p class=pgc-img-caption></p></div><p>图 26.4.6 Qsys系统模块</p><p><strong>Nios II软件设计</strong></p><p>在介绍完Qsys系统的搭建之后，最后我们再来介绍一下Nios II软件设计部分。</p><p>Nios II主要完成UI界面的绘制以及根据触摸屏输入的触摸点座标来判断用户的按键操</p><p>作。除此之外，Nios II还需要将从Avalon-MM端口中读取到的波形频率与峰峰值按照一定的</p><p>格式，显示到界面上。</p><p>需要说明的是，由于波形的缩放、触发电平的位置显示等都是由硬件实现的，为了方便</p><p>硬件实现这部分的功能，Nios II在通过Avalon-MM端口传输参数之前，要先对数据进行预处</p><p>理，以降低硬件实现的复杂性。</p><p>最终，在RGB LCD屏上显示的界面如下图所示</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5ba172727f954f0dab27d0dfeae4fa4a><p class=pgc-img-caption></p></div><p>图 26.4.7 用户界面</p><p>在前面学习了uC/GUI相关的章节之后，相信对大家来说，绘制上图中的用户界面是比较</p><p>容易的。使用GUI_DrawLine()函数实现画线的功能，GUI_DrawRect()函数实现画矩形框的功</p><p>能，GUI_DispStringAt()函数实现显示字符串的功能。图中使用的汉字、字母、数字与箭头</p><p>是由“uC-GUI-FontConvert”软件生成的字体，这里着重强调一下上升沿的字符和下降沿的</p><p>字符是如何生成的。由于字符软件中并没有这个字符，所以我们对生成的字体文件做了修</p><p>改，在字体软件中选中的字符如下图所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/10b50b8336af43e18447a274e243e372><p class=pgc-img-caption></p></div><p><br></p><p>图 26.4.8 字体软件界面</p><p>接下来对../uCGUI/Font/Chinese_ST16.c文件中“▲”和“▼”对应的代码做修改，原</p><p>始的文件和修改后的文件分别如图 26.4.9和图 26.4.10所示：</p><p><br></p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2333c08828da492b80fad1be3470f112><p class=pgc-img-caption></p></div><p>图 26.4.9 原始文件</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a00eaead619a42748c70312a542c0d6b><p class=pgc-img-caption></p></div><p><br></p><p>图 26.4.10 修改后的文件</p><p>图中只展示了上升沿字符的修改方法，下降沿字符的修改方法也是一样的。代码修改完</p><p>成后，接下来在字符显示函数中输入字符参数“▲”和“▼”时，在显示界面上看到的就会</p><p>是上升沿和下降沿了。</p><p>接下来我们看下main函数的代码，了解下Nios II执行的过程。</p><p>68 int main<strong>()</strong></p><p>69 <strong>{</strong></p><p>70 printf<strong>(</strong>"Hello from NiosII!\n"<strong>);</strong></p><p>71 IOWR_ALTERA_AVALON_PIO_DATA<strong>(</strong>PIO_LCD_RST_BASE<strong>,</strong>0<strong>);</strong> //LCD复位</p><p>72 GUI_Init<strong>();</strong> //uC/GUI初始化</p><p>73 GUI_UC_SetEncodeUTF8<strong>();</strong> //设置字体</p><p>74 GUI_SetFont<strong>(&</strong>GUI_FontChinese_ST16<strong>);</strong></p><p>75 init_tp_interrupt<strong>();</strong> //触摸中断初始化</p><p>76 Timer_initial<strong>();</strong> //定时器中断初始化</p><p>77</p><p>78 lcddev<strong>.</strong>width <strong>= </strong>480<strong>;</strong> //4.3'屏宽度</p><p>79 lcddev<strong>.</strong>height <strong>= </strong>272<strong>;</strong> //4.3'屏高度</p><p>80 IOWR_ALTERA_AVALON_PIO_DATA<strong>(</strong>PIO_LCD_RST_BASE<strong>,</strong>1<strong>);</strong> //LCD结束复位</p><p>81 Draw_Display<strong>();</strong> //绘制显示界面</p><p>82 SendCfgPara<strong>();</strong> //配置硬件参数</p><p>83 <strong>while(</strong>1<strong>){</strong></p><p>84 <strong>if(</strong>touch<strong>)</strong> //检测到触摸中断</p><p>85 <strong>{</strong></p><p>86 TouchPro<strong>(</strong>x_pos<strong>,</strong>y_pos<strong>);</strong> //触摸处理</p><p>87 touch <strong>= </strong>0<strong>;</strong> //清除触摸标志</p><p>88 <strong>}</strong></p><p>89 //定时器定时完成并且示波器正在运行</p><p>90 <strong>if(</strong>timer_flag <strong>&& </strong>dispdev<strong>.</strong>run_flag <strong>== </strong>1<strong>){</strong></p><p>91 GetDataDisp<strong>();</strong> //获取硬件数据</p><p>92 timer_flag <strong>= </strong>0<strong>;</strong> //定时器标志清零</p><p>93 <strong>}</strong></p><p>94 <strong>}</strong></p><p>95 <strong>return </strong>0<strong>;</strong></p><p>96 <strong>}</strong></p><p>在软件代码中，我们添加了两个中断，第一个是触摸屏的PIO中断，作为开始获取触摸点</p><p>座标的标志；第二个是定时器的中断，作为开始获取波形频率和峰峰值的触发信号，这里之</p><p>所以没有一直获取频率和峰峰值，是为了防止数据变化的速度太快，导致界面看不清频率和</p><p>峰峰值的情况。在代码的第75行和第76行，实现的功能是分别对触摸屏的PIO中断和定时器中</p><p>断进行初始化。</p><p>随后对LCD屏的分辨率进行设置，由于波形显示是横屏显示的，所以LCD屏的宽度和高度</p><p>分别为480和272，然后结束LCD屏的复位。接下来就开始绘制显示界面了，由Draw_Display()</p><p>函数来完成，UI的初始界面以及数值的更新显示都是由这个函数来完成的，在绘制完界面</p><p>后，需要将界面的初始化参数发送给硬件，即通过SendCfgPara()函数来实现。</p><p>接下来在while循环中判断触摸中断的标志（touch）和定时器完成标志（timer_flag）</p><p>是否为高电平。如果触摸中断标志为高电平，开始触摸点座标的处理，代码中第86行输入的</p><p>参数x_pos和y_pos，就是触摸点的x座标和y座标，TouchPro()函数根据触摸屏输入的触摸点</p><p>座标来判断用户的按键操作；当定时器完成标志为高电平时，开始获取波形频率和峰峰值，</p><p>并显示在界面上。</p><p>我们这里只简单介绍下main函数的程序，了解下Nios程序的执行过程，其它函数我们这</p><p>里不再详细赘述。需要说明的是，本次实验的UI界面是以横屏方式显示的，因此需要对LCD的</p><p>驱动文件做修改，路径为..\uCGUI\LCDDriver\LCD_driver.c，修改后的代码如下：</p><p>117 extern alt_u16 <strong>*</strong>ram<strong>;</strong></p><p>118 int addr<strong>;</strong></p><p>119</p><p>120 void LCD_DP<strong>(</strong>int x<strong>,</strong>int y<strong>,</strong>int color<strong>){</strong></p><p>121 addr <strong>= </strong>y <strong>* </strong>480 <strong>+ </strong>x<strong>;</strong></p><p>122 <strong>*(</strong>ram <strong>+ </strong>addr<strong>) = </strong>color<strong>;</strong></p><p>123 <strong>}</strong></p><p><strong>下载验证</strong></p><p>接下来我们把程序下载至开拓者开发板上，验证我们所完成的示波器的功能。</p><p>首先把高速AD/DA模块和4.3寸RGB屏连接到开拓者开发板上，然后连接电源及JTAG接口。</p><p>为了验证示波器的功能，我们在程序中利用高速AD/DA模块上的DA芯片输出了一个频率为</p><p>195.3KHz的正弦波，因此还需要用两端都是公头的杜邦线将高速AD/DA模块的DA输出与AD输入</p><p>连接起来。</p><p>接下来打开电源，先Programmer中下载本次实验所生成的qsys_gui_oscp.sof文件，然后</p><p>在Eclipse中下载qsys_gui.elf文件。下载完成后，LCD上显示的界面如下所示：</p><div class=pgc-img><img alt=正点原子开拓者NiosII资料连载第二十六章高速示波器实验 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/21b1cdb9148d469ea70e2753cd81bea6><p class=pgc-img-caption></p></div><p>图 26.5.1 示波器效果图</p><p>从上图中可以看到，我们在开拓者上所实现的示波器能够稳定地显示出正弦波，同时测</p><p>量到的频率为195.3KHz，与DA输出的正弦波频率一致。我们旋转高速AD/DA模块上的旋钮，可</p><p>以看到示波器上的波形幅度随之变化。除此之外我们依次点击屏幕上的各个按键，可以验证</p><p>示波器的各项功能均正常工作，说明本次我们基于开拓者开发板以及高速AD/DA模块所实现的</p><p>示波器下载验证成功。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'正点','开拓者','NiosII'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>