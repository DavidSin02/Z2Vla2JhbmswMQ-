<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Android View ç»˜åˆ¶æµç¨‹è¯¦è§£ | æå®¢å¿«è¨Š</title><meta property="og:title" content="Android View ç»˜åˆ¶æµç¨‹è¯¦è§£ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/63c43360ea7c492e9eccf90add48d9c1"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c018dddf.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c018dddf.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c018dddf.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c018dddf.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c018dddf.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c018dddf.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c018dddf.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c018dddf.html><meta property="article:published_time" content="2020-10-29T21:08:51+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:51+08:00"><meta name=Keywords content><meta name=description content="Android View ç»˜åˆ¶æµç¨‹è¯¦è§£"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/c018dddf.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Android View ç»˜åˆ¶æµç¨‹è¯¦è§£</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p><strong>View ç»˜åˆ¶æœºåˆ¶</strong></p><p><strong>ä¸€ã€ View æ ‘çš„ç»˜å›¾æµç¨‹</strong></p><p>å½“ Activity æ¥æ”¶åˆ°ç„¦ç‚¹çš„æ—¶å€™ï¼Œå®ƒä¼šè¢«è¯·æ±‚ç»˜åˆ¶å¸ƒå±€,è¯¥è¯·æ±‚ç”± Android framework å¤„ç†.ç»˜åˆ¶æ˜¯ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå¯¹å¸ƒå±€æ ‘è¿›è¡Œ measure å’Œ drawã€‚æ•´ä¸ª View æ ‘çš„ç»˜å›¾æµç¨‹åœ¨ViewRoot.javaç±»çš„performTraversals()å‡½æ•°å±•å¼€ï¼Œè¯¥å‡½æ•°æ‰€åš çš„å·¥ä½œå¯ç®€å•æ¦‚å†µä¸ºæ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—è§†å›¾å¤§å°(measure)ã€æ˜¯å¦éœ€è¦é‡æ–°å®‰ç½®è§†å›¾çš„ä½ç½®(layout)ã€ä»¥åŠæ˜¯å¦éœ€è¦é‡ç»˜(draw)ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><div class=pgc-img><img alt="Android View ç»˜åˆ¶æµç¨‹è¯¦è§£" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/63c43360ea7c492e9eccf90add48d9c1><p class=pgc-img-caption></p></div><p><strong>View ç»˜åˆ¶æµç¨‹å‡½æ•°è°ƒç”¨é“¾</strong></p><div class=pgc-img><img alt="Android View ç»˜åˆ¶æµç¨‹è¯¦è§£" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/18737e91946c4fccb7ddc45a5467021f><p class=pgc-img-caption></p></div><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œç”¨æˆ·ä¸»åŠ¨è°ƒç”¨ requestï¼Œåªä¼šå‡ºå‘ measure å’Œ layout è¿‡ç¨‹ï¼Œè€Œä¸ä¼šæ‰§è¡Œ draw è¿‡ç¨‹</p><p><strong>äºŒã€ æ¦‚å¿µ</strong></p><p><strong>1. measure å’Œ layout</strong></p><p>ä»æ•´ä½“ä¸Šæ¥çœ‹ Measure å’Œ Layout ä¸¤ä¸ªæ­¥éª¤çš„æ‰§è¡Œï¼š</p><div class=pgc-img><img alt="Android View ç»˜åˆ¶æµç¨‹è¯¦è§£" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/34a6986fbb0b44a29f21a31968832c56><p class=pgc-img-caption></p></div><p>æ ‘çš„éå†æ˜¯æœ‰åºçš„ï¼Œç”±çˆ¶è§†å›¾åˆ°å­è§†å›¾ï¼Œæ¯ä¸€ä¸ª ViewGroup è´Ÿè´£æµ‹ç»˜å®ƒæ‰€æœ‰çš„å­è§†å›¾ï¼Œè€Œæœ€åº•å±‚çš„ View ä¼šè´Ÿè´£æµ‹ç»˜è‡ªèº«ã€‚</p><p><strong>2. å…·ä½“åˆ†æ</strong></p><p>measure è¿‡ç¨‹ç”±measure(int, int)æ–¹æ³•å‘èµ·ï¼Œä»ä¸Šåˆ°ä¸‹æœ‰åºçš„æµ‹é‡ Viewï¼Œåœ¨ measure è¿‡ç¨‹çš„æœ€åï¼Œæ¯ä¸ªè§†å›¾å­˜å‚¨äº†è‡ªå·±çš„å°ºå¯¸å¤§å°å’Œæµ‹é‡è§„æ ¼ã€‚</p><p>layout è¿‡ç¨‹ç”±layout(int, int, int, int)æ–¹æ³•å‘èµ·ï¼Œä¹Ÿæ˜¯è‡ªä¸Šè€Œä¸‹è¿›è¡Œéå†ã€‚åœ¨è¯¥è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªçˆ¶è§†å›¾ä¼šæ ¹æ® measure è¿‡ç¨‹å¾—åˆ°çš„å°ºå¯¸æ¥æ‘†æ”¾è‡ªå·±çš„å­è§†å›¾ã€‚</p><p>measure è¿‡ç¨‹ä¼šä¸ºä¸€ä¸ª View åŠæ‰€æœ‰å­èŠ‚ç‚¹çš„ mMeasuredWidth å’Œ mMeasuredHeight å˜é‡èµ‹å€¼ï¼Œè¯¥å€¼å¯ä»¥é€šè¿‡ getMeasuredWidth()å’ŒgetMeasuredHeight()æ–¹æ³•è·å¾—ã€‚è€Œä¸”è¿™ä¸¤ä¸ªå€¼å¿…é¡»åœ¨çˆ¶è§†å›¾çº¦æŸèŒƒå›´ä¹‹å†…ï¼Œè¿™æ ·æ‰å¯ä»¥ä¿è¯æ‰€æœ‰çš„çˆ¶è§†å›¾éƒ½æ¥æ”¶æ‰€æœ‰å­è§†å›¾çš„æµ‹é‡ã€‚å¦‚æœå­è§†å›¾å¯¹äº Measure å¾—åˆ°çš„å¤§å°ä¸æ»¡æ„çš„æ—¶å€™ï¼Œçˆ¶è§†å›¾ä¼šä»‹å…¥å¹¶è®¾ç½®æµ‹é‡è§„åˆ™è¿›è¡Œç¬¬äºŒæ¬¡ measureã€‚æ¯”å¦‚ï¼Œçˆ¶è§†å›¾å¯ä»¥å…ˆæ ¹æ®æœªç»™å®šçš„ dimension å»æµ‹é‡æ¯ä¸€ä¸ªå­è§†å›¾ï¼Œå¦‚æœæœ€ç»ˆå­è§†å›¾çš„æœªçº¦æŸå°ºå¯¸å¤ªå¤§æˆ–è€…å¤ªå°çš„æ—¶å€™ï¼Œçˆ¶è§†å›¾å°±ä¼šä½¿ç”¨ä¸€ä¸ªç¡®åˆ‡çš„å¤§å°å†æ¬¡å¯¹å­è§†å›¾è¿›è¡Œ measureã€‚</p><p><strong>3. measure è¿‡ç¨‹ä¼ é€’å°ºå¯¸çš„ä¸¤ä¸ªç±»</strong></p><ul><li>ViewGroup.LayoutParams ï¼ˆView è‡ªèº«çš„å¸ƒå±€å‚æ•°ï¼‰</li><li>MeasureSpecs ç±»ï¼ˆçˆ¶è§†å›¾å¯¹å­è§†å›¾çš„æµ‹é‡è¦æ±‚ï¼‰</li></ul><p><strong>ViewGroup.LayoutParams</strong></p><p>è¿™ä¸ªç±»æˆ‘ä»¬å¾ˆå¸¸è§ï¼Œå°±æ˜¯ç”¨æ¥æŒ‡å®šè§†å›¾çš„é«˜åº¦å’Œå®½åº¦ç­‰å‚æ•°ã€‚å¯¹äºæ¯ä¸ªè§†å›¾çš„ height å’Œ widthï¼Œä½ æœ‰ä»¥ä¸‹é€‰æ‹©ï¼š</p><ul><li>å…·ä½“å€¼</li></ul><pre>MATCH_PARENT è¡¨ç¤ºå­è§†å›¾å¸Œæœ›å’Œçˆ¶è§†å›¾ä¸€æ ·å¤§(ä¸åŒ…å« padding å€¼)WRAP_CONTENT è¡¨ç¤ºè§†å›¾ä¸ºæ­£å¥½èƒ½åŒ…è£¹å…¶å†…å®¹å¤§å°(åŒ…å« padding å€¼)</pre><p>ViewGroup çš„å­ç±»æœ‰å…¶å¯¹åº”çš„ ViewGroup.LayoutParams çš„å­ç±»ã€‚æ¯”å¦‚ RelativeLayout æ‹¥æœ‰çš„ ViewGroup.LayoutParams çš„å­ç±» RelativeLayoutParamsã€‚</p><p>æœ‰æ—¶æˆ‘ä»¬éœ€è¦ä½¿ç”¨ view.getLayoutParams() æ–¹æ³•è·å–ä¸€ä¸ªè§†å›¾ LayoutParamsï¼Œç„¶åè¿›è¡Œå¼ºè½¬ï¼Œä½†ç”±äºä¸çŸ¥é“å…¶å…·ä½“ç±»å‹ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¼ºè½¬é”™è¯¯ã€‚å…¶å®è¯¥æ–¹æ³•å¾—åˆ°çš„å°±æ˜¯å…¶æ‰€åœ¨çˆ¶è§†å›¾ç±»å‹çš„ LayoutParamsï¼Œæ¯”å¦‚ View çš„çˆ¶æ§ä»¶ä¸º RelativeLayoutï¼Œé‚£ä¹ˆå¾—åˆ°çš„ LayoutParams ç±»å‹å°±ä¸º RelativeLayoutParamsã€‚</p><p><strong>MeasureSpecs</strong></p><p>æµ‹é‡è§„æ ¼ï¼ŒåŒ…å«æµ‹é‡è¦æ±‚å’Œå°ºå¯¸çš„ä¿¡æ¯ï¼Œæœ‰ä¸‰ç§æ¨¡å¼:</p><pre>UNSPECIFIED</pre><ul><li>çˆ¶è§†å›¾ä¸å¯¹å­è§†å›¾æœ‰ä»»ä½•çº¦æŸï¼Œå®ƒå¯ä»¥è¾¾åˆ°æ‰€æœŸæœ›çš„ä»»æ„å°ºå¯¸ã€‚æ¯”å¦‚ ListViewã€ScrollViewï¼Œä¸€èˆ¬è‡ªå®šä¹‰ View ä¸­ç”¨ä¸åˆ°ï¼Œ</li></ul><pre>EXACTLY</pre><ul><li>çˆ¶è§†å›¾ä¸ºå­è§†å›¾æŒ‡å®šä¸€ä¸ªç¡®åˆ‡çš„å°ºå¯¸ï¼Œè€Œä¸”æ— è®ºå­è§†å›¾æœŸæœ›å¤šå¤§ï¼Œå®ƒéƒ½å¿…é¡»åœ¨è¯¥æŒ‡å®šå¤§å°çš„è¾¹ç•Œå†…ï¼Œå¯¹åº”çš„å±æ€§ä¸º match_parent æˆ–å…·ä½“å€¼ï¼Œæ¯”å¦‚ 100dpï¼Œçˆ¶æ§ä»¶å¯ä»¥é€šè¿‡MeasureSpec.getSize(measureSpec)ç›´æ¥å¾—åˆ°å­æ§ä»¶çš„å°ºå¯¸ã€‚</li></ul><pre>AT_MOST</pre><ul><li>çˆ¶è§†å›¾ä¸ºå­è§†å›¾æŒ‡å®šä¸€ä¸ªæœ€å¤§å°ºå¯¸ã€‚å­è§†å›¾å¿…é¡»ç¡®ä¿å®ƒè‡ªå·±æ‰€æœ‰å­è§†å›¾å¯ä»¥é€‚åº”åœ¨è¯¥å°ºå¯¸èŒƒå›´å†…ï¼Œå¯¹åº”çš„å±æ€§ä¸º wrap_contentï¼Œè¿™ç§æ¨¡å¼ä¸‹ï¼Œçˆ¶æ§ä»¶æ— æ³•ç¡®å®šå­ View çš„å°ºå¯¸ï¼Œåªèƒ½ç”±å­æ§ä»¶è‡ªå·±æ ¹æ®éœ€æ±‚å»è®¡ç®—è‡ªå·±çš„å°ºå¯¸ï¼Œè¿™ç§æ¨¡å¼å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰è§†å›¾éœ€è¦å®ç°æµ‹é‡é€»è¾‘çš„æƒ…å†µã€‚</li></ul><p><strong>ä¸‰ã€ measure æ ¸å¿ƒæ–¹æ³•</strong></p><pre>measure(int widthMeasureSpec, int heightMeasureSpec)</pre><ul><li>è¯¥æ–¹æ³•å®šä¹‰åœ¨View.javaç±»ä¸­ï¼Œä¸º final ç±»å‹ï¼Œä¸å¯è¢«å¤å†™ï¼Œä½† measure è°ƒç”¨é“¾æœ€ç»ˆä¼šå›è°ƒ View/ViewGroup å¯¹è±¡çš„ onMeasure()æ–¹æ³•ï¼Œå› æ­¤è‡ªå®šä¹‰è§†å›¾æ—¶ï¼Œåªéœ€è¦å¤å†™ onMeasure() æ–¹æ³•å³å¯ã€‚</li></ul><pre>onMeasure(int widthMeasureSpec, int heightMeasureSpec)</pre><ul><li>è¯¥æ–¹æ³•å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰è§†å›¾ä¸­å®ç°æµ‹é‡é€»è¾‘çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å‚æ•°æ˜¯çˆ¶è§†å›¾å¯¹å­è§†å›¾çš„ width å’Œ height çš„æµ‹é‡è¦æ±‚ã€‚åœ¨æˆ‘ä»¬è‡ªèº«çš„è‡ªå®šä¹‰è§†å›¾ä¸­ï¼Œè¦åšçš„å°±æ˜¯æ ¹æ®è¯¥ widthMeasureSpec å’Œ heightMeasureSpec è®¡ç®—è§†å›¾çš„ width å’Œ heightï¼Œä¸åŒçš„æ¨¡å¼å¤„ç†æ–¹å¼ä¸åŒã€‚</li></ul><pre>setMeasuredDimension()</pre><ul><li>æµ‹é‡é˜¶æ®µç»ˆææ–¹æ³•ï¼Œåœ¨ onMeasure(int widthMeasureSpec, int heightMeasureSpec) æ–¹æ³•ä¸­è°ƒç”¨ï¼Œå°†è®¡ç®—å¾—åˆ°çš„å°ºå¯¸ï¼Œä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œæµ‹é‡é˜¶æ®µå³ç»“æŸã€‚è¯¥æ–¹æ³•ä¹Ÿæ˜¯å¿…é¡»è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ¥å¼‚å¸¸ã€‚åœ¨æˆ‘ä»¬åœ¨è‡ªå®šä¹‰è§†å›¾çš„æ—¶å€™ï¼Œä¸éœ€è¦å…³å¿ƒç³»ç»Ÿå¤æ‚çš„ Measure è¿‡ç¨‹çš„ï¼Œåªéœ€è°ƒç”¨setMeasuredDimension()è®¾ç½®æ ¹æ® MeasureSpec è®¡ç®—å¾—åˆ°çš„å°ºå¯¸å³å¯ï¼Œä½ å¯ä»¥å‚è€ƒ ViewPagerIndicatorçš„ onMeasure æ–¹æ³•ã€‚</li></ul><p>ä¸‹é¢æˆ‘ä»¬å– ViewGroup çš„ measureChildrenï¼ˆint widthMeasureSpec, int heightMeasureSpec) æ–¹æ³•å¯¹å¤åˆ View çš„ Measure æµç¨‹åšä¸€ä¸ªåˆ†æï¼š</p><p>MeasureChild çš„æ–¹æ³•è°ƒç”¨æµç¨‹å›¾ï¼š</p><div class=pgc-img><img alt="Android View ç»˜åˆ¶æµç¨‹è¯¦è§£" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e183341ecf634df59c4bbfd197447c81><p class=pgc-img-caption></p></div><p>æºç åˆ†æ</p><pre> /** * è¯·æ±‚æ‰€æœ‰å­ View å» measure è‡ªå·±ï¼Œè¦è€ƒè™‘çš„éƒ¨åˆ†æœ‰å¯¹å­ View çš„æµ‹ç»˜è¦æ±‚ MeasureSpec ä»¥åŠå…¶è‡ªèº«çš„ padding * è¿™é‡Œè·³è¿‡æ‰€æœ‰ä¸º GONE çŠ¶æ€çš„å­ Viewï¼Œæœ€ç¹é‡çš„å·¥ä½œæ˜¯åœ¨ getChildMeasureSpec æ–¹æ³•ä¸­å¤„ç†çš„ * * @param widthMeasureSpec å¯¹è¯¥ View çš„ width æµ‹ç»˜è¦æ±‚ * @param heightMeasureSpec å¯¹è¯¥ View çš„ height æµ‹ç»˜è¦æ±‚ */ protected void measureChildren(int widthMeasureSpec, int heightMeasureSpec) { final int size = mChildrenCount; final View[] children = mChildren; for (int i = 0; i &lt; size; ++i) { final View child = children[i]; if ((child.mViewFlags &amp; VISIBILITY_MASK) != GONE) { measureChild(child, widthMeasureSpec, heightMeasureSpec); } } } protected void measureChild(View child, int parentWidthMeasureSpec, int parentHeightMeasureSpec) { final LayoutParams lp = child.getLayoutParams();//è·å– Child çš„ LayoutParams final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,// è·å– ChildView çš„ widthMeasureSpec mPaddingLeft + mPaddingRight, lp.width); final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,// è·å– ChildView çš„ heightMeasureSpec mPaddingTop + mPaddingBottom, lp.height); child.measure(childWidthMeasureSpec, childHeightMeasureSpec); } /**  * è¯¥æ–¹æ³•æ˜¯ measureChildren ä¸­æœ€ç¹é‡çš„éƒ¨åˆ†ï¼Œä¸ºæ¯ä¸€ä¸ª ChildView è®¡ç®—å‡ºè‡ªå·±çš„ MeasureSpecã€‚ * ç›®æ ‡æ˜¯å°† ChildView çš„ MeasureSpec å’Œ LayoutParams ç»“åˆèµ·æ¥å»å¾—åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„ç»“æœã€‚ * * @param spec å¯¹è¯¥ View çš„æµ‹ç»˜è¦æ±‚ * @param padding å½“å‰ View åœ¨å½“å‰å”¯ç‹¬ä¸Šçš„ paddingandï¼Œä¹Ÿæœ‰å¯èƒ½å«æœ‰ margins * * @param childDimension åœ¨å½“å‰ç»´åº¦ä¸Šï¼ˆheight æˆ– widthï¼‰çš„å…·ä½“æŒ‡ * @return å­è§†å›¾çš„ MeasureSpec  */ public static int getChildMeasureSpec(int spec, int padding, int childDimension) { ......... // æ ¹æ®è·å–åˆ°çš„å­è§†å›¾çš„æµ‹é‡è¦æ±‚å’Œå¤§å°åˆ›å»ºå­è§†å›¾çš„ MeasureSpec return MeasureSpec.makeMeasureSpec(resultSize, resultMode);  } /** * * ç”¨äºè·å– View æœ€ç»ˆçš„å¤§å°ï¼Œçˆ¶è§†å›¾æä¾›äº†å®½ã€é«˜çš„çº¦æŸä¿¡æ¯ * ä¸€ä¸ª View çš„çœŸæ­£çš„æµ‹é‡å·¥ä½œæ˜¯åœ¨ onMeasure(int, int) ä¸­ï¼Œç”±è¯¥æ–¹æ³•è°ƒç”¨ã€‚ * å› æ­¤ï¼Œåªæœ‰ onMeasure(int, int) å¯ä»¥è€Œä¸”å¿…é¡»è¢«å­ç±»å¤å†™ * * @param widthMeasureSpec åœ¨æ°´å¹³æ–¹å‘ä¸Šï¼Œçˆ¶è§†å›¾æŒ‡å®šçš„çš„ Measure è¦æ±‚ * @param heightMeasureSpec åœ¨ç«–ç›´æ–¹å‘ä¸Šï¼Œæ§ä»¶ä¸Šçˆ¶è§†å›¾æŒ‡å®šçš„ Measure è¦æ±‚ * */ public final void measure(int widthMeasureSpec, int heightMeasureSpec) { ... onMeasure(widthMeasureSpec, heightMeasureSpec); ... } protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec), getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</pre><p><strong>å››ã€ layout ç›¸å…³æ¦‚å¿µåŠæ ¸å¿ƒæ–¹æ³•</strong></p><p>é¦–å…ˆè¦æ˜ç¡®çš„æ˜¯ï¼Œå­è§†å›¾çš„å…·ä½“ä½ç½®éƒ½æ˜¯ç›¸å¯¹äºçˆ¶è§†å›¾è€Œè¨€çš„ã€‚View çš„ onLayout æ–¹æ³•ä¸ºç©ºå®ç°ï¼Œè€Œ ViewGroup çš„ onLayout ä¸º abstract çš„ï¼Œå› æ­¤ï¼Œå¦‚æœè‡ªå®šä¹‰çš„ View è¦ç»§æ‰¿ ViewGroup æ—¶ï¼Œå¿…é¡»å®ç° onLayout å‡½æ•°ã€‚</p><p>åœ¨ layout è¿‡ç¨‹ä¸­ï¼Œå­è§†å›¾ä¼šè°ƒç”¨getMeasuredWidth()å’ŒgetMeasuredHeight()æ–¹æ³•è·å–åˆ° measure è¿‡ç¨‹å¾—åˆ°çš„ mMeasuredWidth å’Œ mMeasuredHeightï¼Œä½œä¸ºè‡ªå·±çš„ width å’Œ heightã€‚ç„¶åè°ƒç”¨æ¯ä¸€ä¸ªå­è§†å›¾çš„layout(l, t, r, b)å‡½æ•°ï¼Œæ¥ç¡®å®šæ¯ä¸ªå­è§†å›¾åœ¨çˆ¶è§†å›¾ä¸­çš„ä½ç½®ã€‚</p><p><strong>LinearLayout çš„ onLayout æºç åˆ†æ</strong></p><pre> @Override protected void onLayout(boolean changed, int l, int t, int r, int b) { if (mOrientation == VERTICAL) { layoutVertical(l, t, r, b); } else { layoutHorizontal(l, t, r, b); } } /** * éå†æ‰€æœ‰çš„å­ Viewï¼Œä¸ºå…¶è®¾ç½®ç›¸å¯¹çˆ¶è§†å›¾çš„åº§æ ‡ */ void layoutVertical(int left, int top, int right, int bottom) { for (int i = 0; i &lt; count; i++) { final View child = getVirtualChildAt(i); if (child == null) { childTop += measureNullChild(i); } else if (child.getVisibility() != GONE) {//ä¸éœ€è¦ç«‹å³å±•ç¤ºçš„ View è®¾ç½®ä¸º GONE å¯åŠ å¿«ç»˜åˆ¶ final int childWidth = child.getMeasuredWidth();//measure è¿‡ç¨‹ç¡®å®šçš„ Width final int childHeight = child.getMeasuredHeight();//measure è¿‡ç¨‹ç¡®å®šçš„ height ...ç¡®å®š childLeftã€childTop çš„å€¼ setChildFrame(child, childLeft, childTop + getLocationOffset(child), childWidth, childHeight); } } } private void setChildFrame(View child, int left, int top, int width, int height) {  child.layout(left, top, left + width, top + height); }  View.java public void layout(int l, int t, int r, int b) { ... setFrame(l, t, r, b) } /** * ä¸ºè¯¥å­ View è®¾ç½®ç›¸å¯¹å…¶çˆ¶è§†å›¾ä¸Šçš„åº§æ ‡ */ protected boolean setFrame(int left, int top, int right, int bottom) { ... }</pre><p><strong>äº”ã€ ç»˜åˆ¶æµç¨‹ç›¸å…³æ¦‚å¿µåŠæ ¸å¿ƒæ–¹æ³•</strong></p><p>å…ˆæ¥çœ‹ä¸‹ä¸ draw è¿‡ç¨‹ç›¸å…³çš„å‡½æ•°ï¼š</p><pre>View.draw(Canvas canvas)ï¼š</pre><ul><li>ç”±äº ViewGroup å¹¶æ²¡æœ‰å¤å†™æ­¤æ–¹æ³•ï¼Œå› æ­¤ï¼Œæ‰€æœ‰çš„è§†å›¾æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ View çš„ draw æ–¹æ³•è¿›è¡Œç»˜åˆ¶çš„ã€‚åœ¨è‡ªå®šä¹‰çš„è§†å›¾ä¸­ï¼Œä¹Ÿä¸åº”è¯¥å¤å†™è¯¥æ–¹æ³•ï¼Œè€Œæ˜¯å¤å†™ onDraw(Canvas) æ–¹æ³•è¿›è¡Œç»˜åˆ¶ï¼Œå¦‚æœè‡ªå®šä¹‰çš„è§†å›¾ç¡®å®è¦å¤å†™è¯¥æ–¹æ³•ï¼Œé‚£ä¹ˆè¯·å…ˆè°ƒç”¨ super.draw(canvas)å®Œæˆç³»ç»Ÿçš„ç»˜åˆ¶ï¼Œç„¶åå†è¿›è¡Œè‡ªå®šä¹‰çš„ç»˜åˆ¶ã€‚</li></ul><pre>View.onDraw()ï¼š</pre><ul><li>View çš„onDrawï¼ˆCanvasï¼‰é»˜è®¤æ˜¯ç©ºå®ç°ï¼Œè‡ªå®šä¹‰ç»˜åˆ¶è¿‡ç¨‹éœ€è¦å¤å†™çš„æ–¹æ³•ï¼Œç»˜åˆ¶è‡ªèº«çš„å†…å®¹ã€‚</li></ul><pre>dispatchDraw()</pre><ul><li>å‘èµ·å¯¹å­è§†å›¾çš„ç»˜åˆ¶ã€‚View ä¸­é»˜è®¤æ˜¯ç©ºå®ç°ï¼ŒViewGroup å¤å†™äº†dispatchDraw()æ¥å¯¹å…¶å­è§†å›¾è¿›è¡Œç»˜åˆ¶ã€‚è¯¥æ–¹æ³•æˆ‘ä»¬ä¸ç”¨å»ç®¡ï¼Œè‡ªå®šä¹‰çš„ ViewGroup ä¸åº”è¯¥å¯¹dispatchDraw()è¿›è¡Œå¤å†™ã€‚</li></ul><p>ç»˜åˆ¶æµç¨‹å›¾</p><div class=pgc-img><img alt="Android View ç»˜åˆ¶æµç¨‹è¯¦è§£" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fa6d180f1e2e4f82b2bc12fa5769cc2e><p class=pgc-img-caption></p></div><p>View.draw(Canvas) æºç åˆ†æ</p><pre>/** * Manually render this view (and all of its children) to the given Canvas. * The view must have already done a full layout before this function is * called. When implementing a view, implement * {@link #onDraw(android.graphics.Canvas)} instead of overriding this method. * If you do need to override this method, call the superclass version. * * @param canvas The Canvas to which the View is rendered.  * * æ ¹æ®ç»™å®šçš„ Canvas è‡ªåŠ¨æ¸²æŸ“ Viewï¼ˆåŒ…æ‹¬å…¶æ‰€æœ‰å­ Viewï¼‰ã€‚åœ¨è°ƒç”¨è¯¥æ–¹æ³•ä¹‹å‰å¿…é¡»è¦å®Œæˆ layoutã€‚å½“ä½ è‡ªå®šä¹‰ view çš„æ—¶å€™ï¼Œ * åº”è¯¥å»æ˜¯å®ç° onDraw(Canvas) æ–¹æ³•ï¼Œè€Œä¸æ˜¯ draw(canvas) æ–¹æ³•ã€‚å¦‚æœä½ ç¡®å®éœ€è¦å¤å†™è¯¥æ–¹æ³•ï¼Œè¯·è®°å¾—å…ˆè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ã€‚ */ public void draw(Canvas canvas) { / * Draw traversal performs several drawing steps which must be executed * in the appropriate order: * * 1. Draw the background if need * 2. If necessary, save the canvas' layers to prepare for fading * 3. Draw view's content * 4. Draw children (dispatchDraw) * 5. If necessary, draw the fading edges and restore layers * 6. Draw decorations (scrollbars for instance) */ // Step 1, draw the background, if needed if (!dirtyOpaque) { drawBackground(canvas); } // skip step 2 &amp; 5 if possible (common case) final int viewFlags = mViewFlags; if (!verticalEdges &amp;&amp; !horizontalEdges) { // Step 3, draw the content if (!dirtyOpaque) onDraw(canvas); // Step 4, draw the children dispatchDraw(canvas); // Step 6, draw decorations (scrollbars) onDrawScrollBars(canvas); if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) { mOverlay.getOverlayView().dispatchDraw(canvas); } // we're done... return; } // Step 2, save the canvas' layers ... // Step 3, draw the content if (!dirtyOpaque)  onDraw(canvas); // Step 4, draw the children dispatchDraw(canvas); // Step 5, draw the fade effect and restore layers // Step 6, draw decorations (scrollbars) onDrawScrollBars(canvas); }</pre><p>ç”±ä¸Šé¢çš„å¤„ç†è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾—å‡ºä¸€äº›ä¼˜åŒ–çš„å°æŠ€å·§ï¼šå½“ä¸éœ€è¦ç»˜åˆ¶ Layer çš„æ—¶å€™ç¬¬äºŒæ­¥å’Œç¬¬äº”æ­¥ä¼šè·³è¿‡ã€‚å› æ­¤åœ¨ç»˜åˆ¶çš„æ—¶å€™ï¼Œèƒ½çœçš„ layer å°½å¯çœï¼Œå¯ä»¥æé«˜ç»˜åˆ¶æ•ˆç‡</p><p><strong>ViewGroup.dispatchDraw() æºç åˆ†æ</strong></p><pre>dispatchDraw(Canvas canvas){... if ((flags &amp; FLAG_RUN_ANIMATION) != 0 &amp;&amp; canAnimate()) {//å¤„ç† ChildView çš„åŠ¨ç”» final boolean buildCache = !isHardwareAccelerated(); for (int i = 0; i &lt; childrenCount; i++) { final View child = children[i]; if ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE) {//åªç»˜åˆ¶ Visible çŠ¶æ€çš„å¸ƒå±€ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å»¶æ—¶åŠ è½½æ¥æé«˜æ•ˆç‡ final LayoutParams params = child.getLayoutParams(); attachLayoutAnimationParameters(child, params, i, childrenCount);// æ·»åŠ å¸ƒå±€å˜åŒ–çš„åŠ¨ç”» bindLayoutAnimation(child);//ä¸º Child ç»‘å®šåŠ¨ç”» if (cache) { child.setDrawingCacheEnabled(true); if (buildCache) { child.buildDrawingCache(true); } } } } final LayoutAnimationController controller = mLayoutAnimationController; if (controller.willOverlap()) { mGroupFlags |= FLAG_OPTIMIZE_INVALIDATE; } controller.start();// å¯åŠ¨ View çš„åŠ¨ç”»} // ç»˜åˆ¶ ChildView for (int i = 0; i &lt; childrenCount; i++) { int childIndex = customOrder ? getChildDrawingOrder(childrenCount, i) : i; final View child = (preorderedList == null) ? children[childIndex] : preorderedList.get(childIndex); if ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != null) { more |= drawChild(canvas, child, drawingTime); } }...}protected boolean drawChild(Canvas canvas, View child, long drawingTime) { return child.draw(canvas, this, drawingTime);}/** * This method is called by ViewGroup.drawChild() to have each child view draw itself. * This draw() method is an implementation detail and is not intended to be overridden or * to be called from anywhere else other than ViewGroup.drawChild(). */ boolean draw(Canvas canvas, ViewGroup parent, long drawingTime) { ... }</pre><pre>drawChild(canvas, this, drawingTime)</pre><p>ç›´æ¥è°ƒç”¨äº† View çš„child.draw(canvas, this,drawingTime)æ–¹æ³•ï¼Œæ–‡æ¡£ä¸­ä¹Ÿè¯´æ˜äº†ï¼Œé™¤äº†è¢«ViewGroup.drawChild()æ–¹æ³•å¤–ï¼Œä½ ä¸åº”è¯¥åœ¨å…¶å®ƒä»»ä½•åœ°æ–¹å»å¤å†™æˆ–è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå®ƒå±äºViewGroupã€‚è€ŒView.draw(Canvas)æ–¹æ³•æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰æ§ä»¶ä¸­å¯ä»¥å¤å†™çš„æ–¹æ³•ï¼Œå…·ä½“å¯ä»¥å‚è€ƒä¸Šè¿°å¯¹view.draw(Canvas)çš„è¯´æ˜ã€‚ä»å‚æ•°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œchild.draw(canvas, this, drawingTime)è‚¯å®šæ˜¯å¤„ç†äº†å’Œçˆ¶è§†å›¾ç›¸å…³çš„é€»è¾‘ï¼Œä½† View çš„æœ€ç»ˆç»˜åˆ¶ï¼Œè¿˜æ˜¯View.draw(Canvas)æ–¹æ³•ã€‚</p><pre>invalidate()</pre><p>è¯·æ±‚é‡ç»˜ View æ ‘ï¼Œå³ draw è¿‡ç¨‹ï¼Œå‡å¦‚è§†å›¾å‘ç”Ÿå¤§å°æ²¡æœ‰å˜åŒ–å°±ä¸ä¼šè°ƒç”¨layout()è¿‡ç¨‹ï¼Œå¹¶ä¸”åªç»˜åˆ¶é‚£äº›è°ƒç”¨äº†invalidate()æ–¹æ³•çš„ Viewã€‚</p><pre>requestLayout()</pre><p>å½“å¸ƒå±€å˜åŒ–çš„æ—¶å€™ï¼Œæ¯”å¦‚æ–¹å‘å˜åŒ–ï¼Œå°ºå¯¸çš„å˜åŒ–ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œåœ¨è‡ªå®šä¹‰çš„è§†å›¾ä¸­ï¼Œå¦‚æœæŸäº›æƒ…å†µä¸‹å¸Œæœ›é‡æ–°æµ‹é‡å°ºå¯¸å¤§å°ï¼Œåº”è¯¥æ‰‹åŠ¨å»è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå®ƒä¼šè§¦å‘measure()å’Œlayout()è¿‡ç¨‹ï¼Œä½†ä¸ä¼šè¿›è¡Œ drawã€‚</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Android','View','è¯¦è§£'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>