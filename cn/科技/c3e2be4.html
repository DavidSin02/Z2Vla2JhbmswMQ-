<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Vue created 中的异步请求的影响分析 | 极客快訊</title><meta property="og:title" content="Vue  created 中的异步请求的影响分析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/e6f8e8d25f2146e5a36832b2f195ae61"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3e2be4.html><meta property="article:published_time" content="2020-10-29T20:59:17+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:17+08:00"><meta name=Keywords content><meta name=description content="Vue  created 中的异步请求的影响分析"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/c3e2be4.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Vue created 中的异步请求的影响分析</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h3 class=pgc-h-arrow-right>背景</h3><p>最近接手了别人写的前端代码，填了两个星期的坑了。周四填的这个坑比较有意思，是关于 created 钩子和异步请求的问题，反复验证了一个小时，终于弄清楚了同步请求和异步请求对钩子执行顺序的影响。</p><p>常规思路写出的代码，还真看不出问题，但是一运行就有问题，还是值得细究的。</p><h3 class=pgc-h-arrow-right>功能描述</h3><p>有一个管理功能的主页面，它被拆解成四个子组件：</p><ol start=1><li>ChartsComp：顶部一些统计图</li><li>SearchComp： 中间条件区域</li><li>BtnComp：中间操作按钮区域</li><li>DataTableComp：底部数据列表，有一列会根据国家名称显示国旗图片</li></ol><p>主界面 XXXHome 的 created 钩子里，会初始化其他组件需要的数据：</p><div class=pgc-img><img alt="Vue  created 中的异步请求的影响分析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e6f8e8d25f2146e5a36832b2f195ae61><p class=pgc-img-caption>主界面 created 定义</p></div><h3 class=pgc-h-arrow-right>子组件中 watch 不到数据变化</h3><p>代码的前任想把所有的数据都在 Home 页面获取到，然后由子组件使用 watch 监听并使用。第一个问题发生在 getChartData 上，子组件的引用和数据使用如下：</p><div class=pgc-img><img alt="Vue  created 中的异步请求的影响分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/01a8932a5c5949dbba38c52da7d6135d><p class=pgc-img-caption>子组件数据引用</p></div><p>因为数据是在父组件中通过异步请求获取的，子组件渲染时可能没有数据，就把绘图方法放在 watch 中，监听数据变化后再触发。</p><h3 class=pgc-h-arrow-right>父子组件的 created 执行顺序</h3><p>父子组件的 created 中添加打印信息，执行顺序如下：</p><div class=pgc-img><img alt="Vue  created 中的异步请求的影响分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/154fa43e9f22487782059ea15aff4a75><p class=pgc-img-caption>父子组件的 created 执行顺序</p></div><p>从测试表现来看，父组件的所有异步请求返回后，子组件的 created 才执行。<strong>即从父到子，顺次执行</strong>。此时子组件的那几个 watch 大多数时候根本监控不到数据变化，因为传入的时候，异步响应已经返回了，数据非空，所以监听不到变化。</p><p>但是，如果直接在子组件的 created 调用绘图方法，又会出现数据不完整的问题，且具有偶发性，这一点由于时间有限、没有细探。</p><p>最保险的解决方法：在 Home 中添加一个 flag ，所有<strong>依赖异步请求数据的子组件都加一个 v-if 标识</strong>，等待数据回来后修正为真，再渲染子组件 charts v-if="isDataOk"。</p><p>组件拆解，如果仅仅是为了减少主页面的代码量，而无其他复用时，比如本文这个 ChartsCmop，就可以将数据请求放在自己的 created 中，不需要依赖父组件传入，也就不会有这个问题了。</p><h3 class=pgc-h-arrow-right>beforeCreated 和 created 的顺序</h3><p>昨天碰到一个问题，测试后发现：如果把 beforeCreated 定义为 async ，它的 await 后的代码会在 created 执行完成后才执行。感觉有些颠覆官方的介绍，所以着重研究了一下。</p><p>官方说的是先执行 beforeCreate 再执行 created ，那么 beforeCreate 中的 await 会对这个顺序产生什么影响呢？</p><p>首先，还是这个功能，它的底部数据列表，需要根据国家名称显示国旗图片。前任是在 beforeCreate 中使用 await 操作先获取到国家和图片的 base64 信息，再在 created 中获取 table 数据，代码是这样写的：</p><div class=pgc-img><img alt="Vue  created 中的异步请求的影响分析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1395f8d0537546369292309705fcfe7e><p class=pgc-img-caption>beforeCreate 和 created 定义</p></div><p>其次，这段代码看起来没问题，笔者也感觉 beforeCreate 里面用了 await 同步，应该会先执行完成，再继续执行 created 方法。结果，运行后的日志信息却是这样：</p><div class=pgc-img><img alt="Vue  created 中的异步请求的影响分析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e02f2eddf0fa44fd91161eb3958426e4><p class=pgc-img-caption>执行结果</p></div><p>第三，从执行结果来看， beforeCreated 中的 “beforeCreate finished” 是在 created 的代码执行完成后才打印的。这说明，<strong>在它等待请求响应结果期间，created 方法已经被执行了</strong>。</p><p>这种情况下 this.areas 还是默认的空数组，此时 created 的 getDataTable 方法会获取 DataTableComp 需要的数据，并完成子组件的渲染：</p><pre><code>&lt;span  :title="scope.row.countryName"&gt;       &lt;el-image :src="getCountryImg(scope.row.countryName)"  class="flagImg"/&gt;       {{ scope.row.countryName}} &lt;/span&gt;</code></pre><p>第四，getCountryImg 使用 countries 时，会引发错误。因为它渲染时，会获取国旗图片，查找 countryName 对应的信息，如果不存在，就展示第一个元素 contries[0] 的图片：</p><pre><code>getCountryImg(country) {      for (let i = 0; i &lt; this.contries.length; i += 1) {        const item = this.contries[i];        if (item.nameZh === country) {          return `data:image/jpeg;base64,${item.img64}`;        }      }      return `data:image/jpeg;base64,${this.contries[0].img64}`;    },</code></pre><p>最后，由于 DataTableComp 绘制的时候 beforeCreate 方法还没有结束，父组件传递来的 countries 是空数组，this.contries[0] 为 undefined 而引发异常：</p><div class=pgc-img><img alt="Vue  created 中的异步请求的影响分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/54e04b3f15724105b14f1abe753680c8><p class=pgc-img-caption>表面同步引起的异常</p></div><p><strong>解决办法：添加 isAreaOk 标识</strong>。初始为否，当异步请求回来后设置为真，列表组件依赖该标识 data-table-comp v-if="isAreasOk" ，子组件推迟到依赖解决后再渲染。</p><h3 class=pgc-h-arrow-right>启示录</h3><p>本文介绍 Vue 的 created 和 beforeCreate 钩子执行的两个知识点：</p><ol start=1><li>父子组件的 created 是顺次执行的，<strong>先父后子</strong>，即使父组件的 created 方法中有异步请求，也会等待所有的异步请求结束，才会执行子组件的 created 方法；</li><li>相同组件的 beforeCreate 方法先于 created 方法执行，如果 beforeCreate 中使用await 返回一个 Promise 对象，主流程不会处理，而是继续执行 created 方法。</li></ol><p>关于第二点，就是说，虽然将 beforeCreate 定义为 async ，但是 Vue 调用时应该没有 await beforeCreate() ，本质上还是异步逻辑。所以不会等待它真正执行完成，后面的 created 就会继续执行，它的 await 进入回调函数等待队列中。</p><p>关于 Vue 开发的一些知识，笔者有一篇万字文中有详细介绍，感兴趣的朋友可以看看。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Vue','created','异步'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>