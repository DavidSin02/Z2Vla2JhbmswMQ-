<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>从0到1如何构建链路监控系统？ | 极客快訊</title><meta property="og:title" content="从0到1如何构建链路监控系统？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/445911c48e5c408f9510bf37fda0c06c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c67b24a3.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c67b24a3.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c67b24a3.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c67b24a3.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c67b24a3.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c67b24a3.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c67b24a3.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c67b24a3.html><meta property="article:published_time" content="2020-11-14T21:06:12+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:12+08:00"><meta name=Keywords content><meta name=description content="从0到1如何构建链路监控系统？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/c67b24a3.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>从0到1如何构建链路监控系统？</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p class=ql-align-justify>链路监控的核心是建立多个日志的连接，今天我们从服务端与客户端两个方面，一起构建链路监控系统。</p><p class=ql-align-center><strong>&lt;1>服务端链路日志</strong></p><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/445911c48e5c408f9510bf37fda0c06c><p class=pgc-img-caption></p></div><p class=ql-align-justify><strong>1.入口层记录nginx日志</strong></p><p class=ql-align-justify>● 客户端调用接口名称以及其相关信息（request time，bodySent等等）。</p><p class=ql-align-justify>● 入口idc标记。</p><p class=ql-align-justify>● 用户唯一标记（uid）。</p><p class=ql-align-justify>● 会话sessionID，这个ID是用来标记一个请求链路的唯一标记。</p><p class=ql-align-justify>● 用户相关头信息（ua，ip等）</p><p class=ql-align-justify><strong>2.web层记录向后端请求的日志</strong></p><p class=ql-align-justify>● 客户端请求的接口的接口名。</p><p class=ql-align-justify>● 下游接口的接口名。</p><p class=ql-align-justify>● 会话sessionID。</p><p class=ql-align-justify>● 其他用户相关信息。</p><p class=ql-align-justify><strong>3.两个维度连接三个服务的日志</strong></p><p class=ql-align-justify>一个维度是是通过接口名和接口RT，另一个维度是sessionID维度。</p><p class=ql-align-justify>我们首先需要给这三层服务分别起一个日志标记，比如七层的日志我们可以起名叫l7，web服务那层叫www，下游服务层叫webinf。</p><p class=ql-align-justify>由于我们在三份日志中都记录客户端的接口名，所以我们需要在三层日志中都使用相同的key，比如这个key叫做transUrl。同时我们还需要另外一个同时都有的key，这个key是用来标记每层接口的耗时情况，我们这里命名为tranRT。</p><p class=ql-align-justify><strong>4.接口和RT维度查看整体耗时情况</strong></p><p class=ql-align-justify>我们可以通过term aggregation请求，通过对transUrl的聚合，查看每一层的RT，可以一目了然的看到各层的耗时时间。在kibana中如下图这样：</p><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/dfic-imagehandler/aca83211-278e-4fd7-a0ef-1568ae854d12><p class=pgc-img-caption></p></div><p class=ql-align-justify>由于每一层的耗时时间都包含上一层的耗时时间（七层包含web层耗时，web层耗时包含下游耗时），当下游服务出现问题时一定会对上游系统的耗时造成影响，所以我们可以通过各层的耗时来直接定位是哪一层的问题。</p><p class=ql-align-justify>另外当下游数据服务出现问题时，由于我们在webinf日志中记录了两层的数据，所以我们可以直接通过选中webinf日志中下游接口名，而过滤出对他调用的上游接口是什么（因为webinf日志中也记录了transUrl字段），以及此时web层（www日志）中的一些问题，比如如下这样：</p><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/fa0466de-ecb2-41ea-b7c5-89ec3121ff73><p class=pgc-img-caption></p></div><p class=ql-align-justify>以上是服务端记录的链路日志。那么客户端中我们需要记录什么日志呢？</p><p class=ql-align-center><strong>&lt;2> 客户端链路日志</strong></p><p class=ql-align-justify>在客户端中我们可能要记录一些更详细的性能日志，这种性能日志主要记录具体阶段的时间，比如要包含下面这些信息：</p><p class=ql-align-justify>● 本地等待时间</p><p class=ql-align-justify>● dns查询时间</p><p class=ql-align-justify>● tcp建立连接时间</p><p class=ql-align-justify>● ssl握手时间</p><p class=ql-align-justify>● 发送上行数据时间</p><p class=ql-align-justify>● 等待服务器响应时间</p><p class=ql-align-justify>● 读取header时间</p><p class=ql-align-justify>● 读取body时间</p><p class=ql-align-justify>我们也可以通过上面记录服务相关链路日志的逻辑记录客户端各个阶段的时间，同时对其进行聚合，得到如下这样的图：</p><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2f95723d17a54a43b0535a0cfe1412f7><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>我们可以通过这个图快速的判断客户端响应时间中各个阶段的耗时情况，这样不管是排查问题还是进行服务端性能优化都可以清晰的展现出来。</p><p class=ql-align-justify>除此之外再补充一些问题，比如我们现在需要对服务端各个阶段的前后两日的耗时对比，比如如下图这样：</p><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/faa2953acfbb4a2aa195375dbf8f5eaa><p class=pgc-img-caption></p></div><p class=ql-align-justify>像这样的图我们可以通过kibana中的timelion来做。</p><p class=ql-align-center><strong>&lt;3>timelion的用法</strong></p><p class=ql-align-justify>下面我简单的介绍一下timelion的用法。</p><p class=ql-align-justify>timelion底层依赖pipeline aggregations。它的语法有点类似函数式编程的语法，可以通过“.”的方式调用不同的函数来对数据集进行迭代处理。我们通过几个例子讲解一下：</p><p class=ql-align-justify><strong>1.查询</strong></p><p class=ql-align-justify>最简单的一个查询，我可以查询出来一个索引的日志量随时间变化的趋势。我们可以使用查询语句：</p><pre class=ql-align-justify>.es(index='logstash-mweibo_trace-2019.07.07')</pre><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d81834ac9313469784bd3a1f13d3b3fb><p class=pgc-img-caption></p></div><p class=ql-align-justify>同时我们也可以添加查询条件，比如我们想看某一类的数据，比如我们想看transModule字段为www的日志变化情况。我们可以使用查询语句：</p><pre class=ql-align-justify>.es(index='logstash-mweibo_trace-2019.07.07' q='transModule:www')</pre><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e774bbc3dad04ef88731f998301cef8f><p class=pgc-img-caption></p></div><p class=ql-align-justify>同时timelion还支持我们对某一个数值条件的日志进行metric计算。比如我们想看这一天中tranRT字段的平均值变化情况。我们可以使用查询语句：</p><pre class=ql-align-justify>.es(index='logstash-mweibo_trace-*' q='transModule:www',metric='avg:transRT')</pre><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4bf86de1a5d94e40959e54314275ee3e><p class=pgc-img-caption></p></div><p class=ql-align-justify>我们也可以把多个条件的时序图画在同一个图中，比如我们想分别查看transModule为l7，www，webinf的三种数据变化情况，每个查询使用“，”分隔：</p><pre>.es(index='logstash-mweibo_trace-2019.07.07' q='transModule:www'),.es(index='logstash-mweibo_trace-2019.07.07' q='transModule:webInf'),.es(index='logstash-mweibo_trace-2019.07.07' q='transModule:l7')</pre><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8d6cc6165eba4929907104e5671a0e0a><p class=pgc-img-caption></p></div><p class=ql-align-justify>如果我们看烦了直线图表，timelion也给我们提供了其他几种形式的图标，比如点图，柱状图。它们分别对应函数.points()， .bars()</p><pre class=ql-align-justify>.es(index='logstash-mweibo_trace-2019.07.07' q='transModule:webInf').points()</pre><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/37fa150fae1849d4b8b2fa8717de03b7><p class=pgc-img-caption></p></div><pre class=ql-align-justify>.es(index='logstash-mweibo_trace-2019.07.07' q='transModule:webInf').bars()</pre><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/eccea2752fbc41cdae699d72f222e23f><p class=pgc-img-caption></p></div><p class=ql-align-justify><strong>2.指定偏移量</strong></p><p class=ql-align-justify>指定偏移量可以方便我们对比不同时刻的数据，在timelion中使用offset函数进行偏移。比如我们想比较两日同一时间数据情况，可以运行如下语句：</p><pre class=ql-align-justify>.es(index='logstash-mweibo_trace-*' q='transModule:www' offset=-1d),.es(index='logstash-mweibo_trace-*' q='transModule:www')</pre><p class=ql-align-justify>这里注意一下，我们如果要比较两天的数据，首先需要有2日以上的数据，所以我们在选择数据集的时候使用的index='logstash-mweibo_trace-*'来进行模糊匹配。</p><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f542e6337bf54886acf39d639c4e4115><p class=pgc-img-caption></p></div><p class=ql-align-justify>以上是timelion比较基础的用法，我们下面来看一下比较高级的玩法。</p><p class=ql-align-justify><strong>3.数据函数转换</strong></p><p class=ql-align-justify>timelion支持divide()相除函数，add()相加函数，subtract()相减函数，multiply()相乘函数。还有一些算法函数。比如滑动平均函数（.movingaverage()或.mvavg()）。</p><p class=ql-align-justify>我们可以使用滑动平均函数对函数曲线进行降噪，得到一条相对平滑的函数曲线。比如我们对平均transRT进行降噪处理，可以使用语句：</p><pre>.es(index='logstash-mweibo_trace-*' q='transModule:www',metric='avg:transRT' ).mvavg(10)</pre><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a09c08423b644ddea609d03b20be3195><p class=pgc-img-caption></p></div><p class=ql-align-justify>其中mvavg(10)代表使用滑动窗口为10的滑动平均函数进行去燥。</p><p class=ql-align-justify>timelion还为我们提供了一些展示函数。比如label()函数。我们可以给这条曲线加一个含义，使用如下查询语句：</p><pre class=ql-align-justify>.es(index='logstash-mweibo_trace-*' q='transModule:www',metric='avg:transRT' ).mvavg(10).label("平均RT")</pre><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9179abc5677a4caba20303fcd6d891db><p class=pgc-img-caption></p></div><p class=ql-align-justify>我们也可以给我们的timelion加一个title，使用title()函数。</p><p class=ql-align-justify>我们可以给这个图起一个题目，比如我们之前那个失败率的例子，我们可以使用title()函数给它起一个名字叫做web层失败率，查询语句如下：</p><pre>.es(index='logstash-mweibo_trace-*' q='transModule:www AND wwwStatus:5*').divide(.es(index='logstash-mweibo_trace-*' q='transModule:www')).label("5xx比例").title('web服务层失败率')</pre><p class=ql-align-justify><br></p><div class=pgc-img><img alt=从0到1如何构建链路监控系统？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0bf19477908c4f86bde402da7b05f310><p class=pgc-img-caption></p></div><p class=ql-align-justify><strong>4.保存</strong></p><p class=ql-align-justify>点击save，会有两个选项，一个是save entire timelion sheet，一个是save current expressoion as Kibana dashboard pane。</p><p class=ql-align-justify>一般点击第一个保存即可。点击第二个保存，可以在dashboard看到这个timelion视图。</p><p><strong>关注微信公众号：安徽思恒信息科技有限公司,了解更多技术内容……</strong></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'构建链','路监','控系统'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>