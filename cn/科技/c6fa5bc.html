<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚ | æå®¢å¿«è¨Š</title><meta property="og:title" content="åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/37b36c91e46045098266d0264cb7f6e8"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c6fa5bc.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c6fa5bc.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c6fa5bc.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c6fa5bc.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c6fa5bc.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c6fa5bc.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c6fa5bc.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c6fa5bc.html><meta property="article:published_time" content="2020-10-29T20:59:17+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:17+08:00"><meta name=Keywords content><meta name=description content="åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/c6fa5bc.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=postTitle>åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚çš„åŒºåˆ«</h1><ul><li>åŒæ­¥æ˜¯æŒ‡ï¼šå‘é€æ–¹å‘å‡ºæ•°æ®åï¼Œç­‰æ¥æ”¶æ–¹å‘å›å“åº”ä»¥åæ‰å‘ä¸‹ä¸€ä¸ªæ•°æ®åŒ…çš„é€šè®¯æ–¹å¼ã€‚</li></ul><ul><li>å¼‚æ­¥æ˜¯æŒ‡ï¼šå‘é€æ–¹å‘å‡ºæ•°æ®åï¼Œä¸ç­‰æ¥æ”¶æ–¹å‘å›å“åº”ï¼Œæ¥ç€å‘é€ä¸‹ä¸ªæ•°æ®åŒ…çš„é€šè®¯æ–¹å¼ã€‚</li></ul><p>å³åŒæ­¥å°±æ˜¯ä¸€ä¸ªä»»åŠ¡çš„å®Œæˆéœ€è¦ä¾èµ–å¦å¤–ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œåªæœ‰ç­‰å¾…è¢«ä¾èµ–çš„ä»»åŠ¡å®Œæˆåï¼Œä¾èµ–çš„ä»»åŠ¡æ‰èƒ½ç®—å®Œæˆï¼Œè¿™æ˜¯ä¸€ç§å¯é çš„ä»»åŠ¡åºåˆ—ã€‚</p><p>æ‰€è°“å¼‚æ­¥æ˜¯ä¸éœ€è¦ç­‰å¾…è¢«ä¾èµ–çš„ä»»åŠ¡å®Œæˆï¼Œåªæ˜¯é€šçŸ¥è¢«ä¾èµ–çš„ä»»åŠ¡è¦å®Œæˆä»€ä¹ˆå·¥ä½œï¼Œä¾èµ–çš„ä»»åŠ¡ä¹Ÿç«‹å³æ‰§è¡Œï¼Œåªè¦è‡ªå·±å®Œæˆäº†æ•´ä¸ªä»»åŠ¡å°±ç®—å®Œæˆäº†ã€‚è‡³äºè¢«ä¾èµ–çš„ä»»åŠ¡æœ€ç»ˆæ˜¯å¦çœŸæ­£å®Œæˆï¼Œä¾èµ–å®ƒçš„ä»»åŠ¡æ— æ³•ç¡®å®šï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸å¯é çš„ä»»åŠ¡åºåˆ—ã€‚</p><p>å¼‚æ­¥çš„æ¦‚å¿µå’ŒåŒæ­¥ç›¸å¯¹ã€‚å½“ä¸€ä¸ªåŒæ­¥è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…è¦ä¸€ç›´ç­‰å¾…è¿”å›æ¶ˆæ¯ï¼ˆç»“æœï¼‰é€šçŸ¥åï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„æ‰§è¡Œï¼›å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°è¿”å›æ¶ˆæ¯ï¼ˆç»“æœï¼‰ã€‚å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„éƒ¨ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…ã€‚</p><p>é’ˆå¯¹ä»¥ä¸Šæè¿°ï¼Œå®é™…å·¥ç¨‹ç¼–ç¨‹ä¸­ï¼Œå…·ä½“æˆ‘ä»¬å¦‚ä½•æ ¹æ®åœºæ™¯é€‰æ‹©å’Œä½¿ç”¨åŒæ­¥å’Œå¼‚æ­¥ï¼š</p><p>å¼‚æ­¥çš„ä½¿ç”¨åœºæ™¯ï¼š</p><ul><li>ä¸æ¶‰åŠå…±äº«èµ„æºï¼Œæˆ–å¯¹å…±äº«èµ„æºåªè¯»ï¼Œå³éäº’æ–¥æ“ä½œ</li><li>æ²¡æœ‰æ—¶åºä¸Šçš„ä¸¥æ ¼å…³ç³»</li><li>ä¸éœ€è¦åŸå­æ“ä½œï¼Œæˆ–å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼æ§åˆ¶åŸå­æ€§</li><li>å¸¸ç”¨äºIOæ“ä½œç­‰è€—æ—¶æ“ä½œï¼Œå› ä¸ºæ¯”è¾ƒå½±å“å®¢æˆ·ä½“éªŒå’Œä½¿ç”¨æ€§èƒ½</li><li>ä¸å½±å“ä¸»çº¿ç¨‹é€»è¾‘</li></ul><p>åŒæ­¥çš„ä½¿ç”¨åœºæ™¯ï¼šä¸ä½¿ç”¨å¼‚æ­¥çš„æ—¶å€™</p><p>åŒæ­¥çš„å¥½å¤„ï¼š</p><ul><li>åŒæ­¥æµç¨‹å¯¹ç»“æœå¤„ç†é€šå¸¸æ›´ä¸ºç®€å•ï¼Œå¯ä»¥å°±è¿‘å¤„ç†ã€‚</li><li>åŒæ­¥æµç¨‹å¯¹ç»“æœçš„å¤„ç†å§‹ç»ˆå’Œå‰æ–‡ä¿æŒåœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡å†…ã€‚</li><li>åŒæ­¥æµç¨‹å¯ä»¥å¾ˆå®¹æ˜“æ•è·ã€å¤„ç†å¼‚å¸¸ã€‚</li><li>åŒæ­¥æµç¨‹æ˜¯æœ€å¤©ç„¶çš„æ§åˆ¶è¿‡ç¨‹é¡ºåºæ‰§è¡Œçš„æ–¹å¼ã€‚</li></ul><p>å¼‚æ­¥çš„å¥½å¤„ï¼š</p><ul><li>å¼‚æ­¥æµç¨‹å¯ä»¥ç«‹å³ç»™è°ƒç”¨æ–¹è¿”å›åˆæ­¥çš„ç»“æœã€‚</li><li>å¼‚æ­¥æµç¨‹å¯ä»¥å»¶è¿Ÿç»™è°ƒç”¨æ–¹æœ€ç»ˆçš„ç»“æœæ•°æ®ï¼Œåœ¨æ­¤æœŸé—´å¯ä»¥åšæ›´å¤šé¢å¤–çš„å·¥ä½œï¼Œä¾‹å¦‚ç»“æœè®°å½•ç­‰ç­‰ã€‚</li><li>å¼‚æ­¥æµç¨‹åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é‡Šæ”¾å ç”¨çš„çº¿ç¨‹ç­‰èµ„æºï¼Œé¿å…é˜»å¡ï¼Œç­‰åˆ°ç»“æœäº§ç”Ÿå†é‡æ–°è·å–çº¿ç¨‹å¤„ç†ã€‚</li><li>å¼‚æ­¥æµç¨‹å¯ä»¥ç­‰å¤šæ¬¡è°ƒç”¨çš„ç»“æœå‡ºæ¥åï¼Œå†ç»Ÿä¸€è¿”å›ä¸€æ¬¡ç»“æœé›†åˆï¼Œæé«˜å“åº”æ•ˆç‡ã€‚</li></ul><p>æ¥ä¸‹æ¥åŸºäºhttpè¯·æ±‚åˆ†åˆ«å®ç°åŒæ­¥å’Œå¼‚æ­¥è·å–å¤©æ°”ä¿¡æ¯çš„ç¼–ç¨‹ï¼š</p><p>è´´å‡ºæ¥ä¸€ä¸ªhttpè¯·æ±‚æ ¼å¼ï¼Œä»£ç éœ€è¦æŒ‰ç…§è¿™ä¸ªæ ¼å¼æ‹¼æ¥ç›¸å…³çš„å­—ç¬¦ä¸²ã€‚</p><div class=pgc-img><img alt=åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/37b36c91e46045098266d0264cb7f6e8><p class=pgc-img-caption></p></div><p>ä¸€ä¸ªè·å–å¤©æ°”ä¿¡æ¯çš„ç½‘ç«™APIè¯´æ˜ï¼šhttps://docs.seniverse.com/api/weather/now.html</p><div class=pgc-img><img alt=åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3266c0f2fa0246c4a80e57d3b2ca2ab7><p class=pgc-img-caption></p></div><p>httpè¯·æ±‚syncçš„ä»£ç å®ç°ï¼š</p><pre><code>#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;unistd.h&gt;#include &lt;time.h&gt;#include &lt;fcntl.h&gt;#include &lt;errno.h&gt;#include &lt;sys/types.h&gt;#include &lt;sys/socket.h&gt;#include &lt;sys/time.h&gt;#include &lt;netinet/in.h&gt;#include &lt;arpa/inet.h&gt;#include &lt;unistd.h&gt;		/* close */#include &lt;netdb.h&gt; #include &lt;sys/epoll.h&gt;#define HTTP_VERSION    "HTTP/1.1"#define USER_AGENT		"User-Agent: Mozilla/5.0 (Windows NT 5.1; rv:10.0.2) Gecko/20100101 Firefox/10.0.2\r\n"#define ENCODE_TYPE		"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"//è®¾ç½®è¿æ¥ç±»å‹ï¼Œç”±äºæ˜¯çŸ­è¿æ¥ï¼Œä¸éœ€è¦è®¾ç½®ä¸ºkeep-alive#define CONNECTION_TYPE "Connection: close\r\n"#define BUFFER_SIZE		4096struct http_request {	char *hostname;	char *resource;};struct http_request reqs[] = {	{"api.seniverse.com", "/v3/weather/now.json?key=0pyd8z7jouficcil&amp;location=beijing&amp;language=zh-Hans&amp;unit=c" },	{"api.seniverse.com", "/v3/weather/now.json?key=0pyd8z7jouficcil&amp;location=shenzhen&amp;language=zh-Hans&amp;unit=c" },};char *host_to_ip(const char *hostname) {	struct hostent *host_entry = gethostbyname(hostname);  /*******************************************************************************************************  ç”±äºgethostbynameè¿™ä¸ªå‡½æ•°ä¸å¯é‡å…¥ï¼Œå¹¶ä¸é€‚ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒä»¥åŠå…¶å®ƒå¯¹DNSè§£æé€Ÿåº¦è¦æ±‚è¾ƒé«˜çš„ç¨‹åº  åæ¥åˆå¢åŠ ä¸€ä¸ªå‡½æ•°gethostbyname_rï¼Œè§£å†³gethostbynameçš„é—®é¢˜ï¼Œä½†æ˜¯åˆç”±äºè¯¥å‡½æ•°å¯¹ipv6çš„æ”¯æŒä¸å¥½ï¼Œ  æœ€åç›®å‰æ¨èä½¿ç”¨getaddrinfo  *********************************************************************************************************/  if (host_entry) {		return inet_ntoa(*(struct in_addr*)*host_entry-&gt;h_addr_list);	} else {		return NULL;	}}int http_create_socket( char *ip) {	int sockfd = socket(AF_INET, SOCK_STREAM, 0);	struct sockaddr_in sin = {0};	sin.sin_addr.s_addr = inet_addr(ip);	sin.sin_port = htons(80);	sin.sin_family = AF_INET;	if (-1 == connect(sockfd, (struct sockaddr*)&amp;sin, sizeof(struct sockaddr_in))) {		return -1;	}	fcntl(sockfd, F_SETFL, O_NONBLOCK);	return sockfd;}char *http_send_request(int sockfd, const char *hostname, const char *resource) {	char buffer[BUFFER_SIZE] = {0};		int len = sprintf(buffer, "GET %s %s\r\n\Host: %s\r\n\%s\r\n\\r\n",		 resource, HTTP_VERSION,		 hostname,		 CONNECTION_TYPE		 );//æ‹¼æ¥httpè¯·æ±‚	send(sockfd, buffer, strlen(buffer), 0);	struct timeval tv;	tv.tv_sec = 5;	tv.tv_usec = 0;	fd_set fdread;	FD_ZERO(&amp;fdread);	FD_SET(sockfd, &amp;fdread);	char *result = malloc(sizeof(int));	result[0] = '\0';	while (1) {		int selection = select(sockfd+1, &amp;fdread, NULL, NULL, &amp;tv);		if (!selection || !(FD_ISSET(sockfd, &amp;fdread))) {			break;		} else {			len = recv(sockfd, buffer, BUFFER_SIZE, 0);			if (len == 0) break;			result = realloc(result, (strlen(result) + len + 1) * sizeof(char));			strncat(result, buffer, len);		}	}	return result;}int http_sync_client_commit(const char *hostname, const char *resource) {	char *ip = host_to_ip(hostname);//æ ¹æ®åŸŸåè·å–IPåœ°å€	int sockfd = http_create_socket(ip);//åˆ›å»ºsocketï¼Œå¹¶ä½¿ç”¨selectç›‘å¬æŸ¥è¯¢fd	char *content =  http_send_request(sockfd, hostname, resource);//å‘é€è¯·æ±‚	if (content == NULL) {		printf("have no data\n");	}	puts(content);	close(sockfd);	free(content);}int main(int argc, char *argv[]) {	int count = sizeof(reqs) / sizeof(reqs[0]);	int i = 0;	for (i = 0;i &lt; count;i ++) {		http_client_commit(reqs[i].hostname, reqs[i].resource);	}</code></pre><p>è¿è¡Œç»“æœï¼š</p><p><br></p><div class=pgc-img><img alt=åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2e77b43d06ec4505abf702d85bc9296b><p class=pgc-img-caption></p></div><p>httpè¯·æ±‚asyncçš„ä»£ç å®ç°ï¼š</p><pre><code>#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;unistd.h&gt;#include &lt;time.h&gt;#include &lt;fcntl.h&gt;#include &lt;errno.h&gt;#include &lt;sys/types.h&gt;#include &lt;sys/socket.h&gt;#include &lt;sys/time.h&gt;#include &lt;netinet/in.h&gt;#include &lt;arpa/inet.h&gt;#include &lt;unistd.h&gt;		/* close */#include &lt;netdb.h&gt; #include &lt;sys/epoll.h&gt;#define HTTP_VERSION    "HTTP/1.1"#define USER_AGENT		"User-Agent: Mozilla/5.0 (Windows NT 5.1; rv:10.0.2) Gecko/20100101 Firefox/10.0.2\r\n"#define ENCODE_TYPE		"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"#define CONNECTION_TYPE "Connection: close\r\n"#define BUFFER_SIZE		4096#define ASYNC_CLIENT_NUM		1024#define HOSTNAME_LENGTH			128typedef void (*async_result_cb)(const char *hostname, const char *result);struct ep_arg {	int sockfd;	char hostname[HOSTNAME_LENGTH];	async_result_cb cb;};struct async_context {	int epfd;	pthread_t thread_id;};struct http_request {	char *hostname;	char *resource;};struct http_request reqs[] = {	{"api.seniverse.com", "/v3/weather/now.json?key=0pyd8z7jouficcil&amp;location=beijing&amp;language=zh-Hans&amp;unit=c" },	{"api.seniverse.com", "/v3/weather/now.json?key=0pyd8z7jouficcil&amp;location=shenzhen&amp;language=zh-Hans&amp;unit=c" },};char *host_to_ip(const char *hostname) {	struct hostent *host_entry = gethostbyname(hostname);	if (host_entry) {		return inet_ntoa(*(struct in_addr*)*host_entry-&gt;h_addr_list);	} else {		return NULL;	}}int http_async_client_commit(struct async_context *ctx, const char *hostname, const char *resource, async_result_cb cb) {	char *ip = host_to_ip(hostname);	if (ip == NULL) return -1;		int sockfd = socket(AF_INET, SOCK_STREAM, 0);	struct sockaddr_in sin = {0};	sin.sin_addr.s_addr = inet_addr(ip);	sin.sin_port = htons(80);	sin.sin_family = AF_INET;	if (-1 == connect(sockfd, (struct sockaddr*)&amp;sin, sizeof(struct sockaddr_in))) {		return -1;	}	fcntl(sockfd, F_SETFL, O_NONBLOCK);	char buffer[BUFFER_SIZE] = {0};		int len = sprintf(buffer, "GET %s %s\r\n\Host: %s\r\n\%s\r\n\\r\n",		 resource, HTTP_VERSION,		 hostname,		 CONNECTION_TYPE		 );//æ‹¼æ¥httpè¯·æ±‚	int slen = send(sockfd, buffer, strlen(buffer), 0);//å‘é€è¯·æ±‚		struct ep_arg *eparg = (struct ep_arg*)calloc(1, sizeof(struct ep_arg));//åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼ŒæŠŠfdå’Œå›è°ƒå‡½æ•°æ”¾è¿›å»ï¼Œæ–¹ä¾¿epollè¿”å›çš„æ—¶å€™ï¼Œå°±å¯ä»¥å–åˆ°å¯¹åº”fdå’Œå›è°ƒå‡½æ•°ï¼Œç”¨äºå®¢æˆ·ç«¯åŒä¸€ä¸ªçº¿ç¨‹å¤„ç†æ•°æ®	if (eparg == NULL) return -1;	eparg-&gt;sockfd = sockfd;	eparg-&gt;cb = cb;	struct epoll_event ev;	ev.data.ptr = eparg;//ä¼ é€’å‚æ•°ç»™epoll	ev.events = EPOLLIN;	int ret = epoll_ctl(ctx-&gt;epfd, EPOLL_CTL_ADD, sockfd, &amp;ev); //æŠŠhttpè¯·æ±‚çš„fdåŠ å…¥åˆ°epollçš„äº‹ä»¶æ³¨å†Œå‡½æ•°	return ret;}int http_async_client_uninit(struct async_context *ctx) {	close(ctx-&gt;epfd);	pthread_cancel(ctx-&gt;thread_id);	return 0;}static void *http_async_client_callback(void *arg) {	struct async_context *ctx = (struct async_context*)arg;	int epfd = ctx-&gt;epfd;	while (1) {		struct epoll_event events[ASYNC_CLIENT_NUM] = {0};		int nready = epoll_wait(epfd, events, ASYNC_CLIENT_NUM, -1);//ç­‰å¾…å‡†å¤‡å°±ç»ªçš„fd		if (nready &lt; 0) {			if (errno == EINTR || errno == EAGAIN) {				continue;			} else {				break;			}		} else if (nready == 0) {			continue;		}		printf("nready:%d\n", nready);		int i = 0;		for (i = 0;i &lt; nready;i ++) {			struct ep_arg *data = (struct ep_arg*)events[i].data.ptr;//httpè¯·æ±‚çš„fdåŠ å…¥epollçš„äº‹ä»¶æ³¨å†Œå‡½æ•°æ—¶å€™ev.data.ptr = epargï¼Œç°åœ¨é€šè¿‡ptrè·å–å½“æ—¶ä¼ é€’çš„å‚æ•°			int sockfd = data-&gt;sockfd;						char buffer[BUFFER_SIZE] = {0};			struct sockaddr_in addr;			size_t addr_len = sizeof(struct sockaddr_in);			int n = recv(sockfd, buffer, BUFFER_SIZE, 0);//è¯»å–æ•°æ®			data-&gt;cb(data-&gt;hostname, buffer); //è°ƒç”¨å›è°ƒï¼Œå¤„ç†è¿”å›çš„æ•°æ®						int ret = epoll_ctl(epfd, EPOLL_CTL_DEL, sockfd, NULL);//å®Œæˆä¹‹åéœ€è¦ç§»é™¤ç›¸åº”çš„fd			//printf("epoll_ctl DEL --&gt; sockfd:%d\n", sockfd);			close(sockfd); /////			free(data);		}			}}struct async_context *http_async_client_init(void) {	int epfd = epoll_create(1); // åˆ›å»ºä¸€ä¸ªepollçš„å¥æŸ„	if (epfd &lt; 0) return NULL;	struct async_context *ctx = calloc(1, sizeof(struct async_context));	if (ctx == NULL) {		close(epfd);		return NULL;	}	ctx-&gt;epfd = epfd;	int ret = pthread_create(&amp;ctx-&gt;thread_id, NULL, http_async_client_callback, ctx);//åˆ›å»ºçº¿ç¨‹ï¼Œæ³¨å†Œå›è°ƒç”¨äºå¼‚æ­¥epoll fd eventsçš„ç›‘å¬æŸ¥è¯¢	if (ret) {		perror("pthread_create");		return NULL;	}	usleep(1); 	return ctx;}static void http_async_client_result_callback(const char *hostname, const char *result) {		printf("hostname:%s, result:%s\n\n\n\n", hostname, result);}int main(int argc, char *argv[]) {	struct async_context *ctx = http_async_client_init();//åˆ›å»ºepollå’Œä¸€ä¸ªçº¿ç¨‹ç”¨äºå¼‚æ­¥å¤„ç†	if (ctx == NULL) return -1;	int count = sizeof(reqs) / sizeof(reqs[0]);	int i = 0;	for (i = 0;i &lt; count;i ++) {		http_async_client_commit(ctx, reqs[i].hostname, reqs[i].resource, http_async_client_result_callback);	}	getchar();}</code></pre><p>è¿è¡Œç»“æœï¼š</p><div class=pgc-img><img alt=åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1d9cf327ccd94a3ba0edf295cf79bb7f><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'å¼‚æ­¥','è¯·æ±‚','æ±‚å’Œ'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>