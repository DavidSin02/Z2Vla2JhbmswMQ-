<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>å¼‚æ­¥ç¼–ç¨‹æå‡æœåŠ¡æ€§èƒ½ | æå®¢å¿«è¨Š</title><meta property="og:title" content="å¼‚æ­¥ç¼–ç¨‹æå‡æœåŠ¡æ€§èƒ½ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/15260210063976700d35c2d"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c81ec36.html><meta property="article:published_time" content="2020-10-29T20:50:33+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:33+08:00"><meta name=Keywords content><meta name=description content="å¼‚æ­¥ç¼–ç¨‹æå‡æœåŠ¡æ€§èƒ½"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/c81ec36.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>å¼‚æ­¥ç¼–ç¨‹æå‡æœåŠ¡æ€§èƒ½</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p>åºå¤§å¤æ‚çš„ç³»ç»Ÿé€šå¸¸ä¼šé‡‡ç”¨æœåŠ¡åŒ–ç»„ä»¶æ¥å®ç°ã€‚ç³»ç»Ÿè¶Šå¤æ‚ï¼Œç»„ä»¶ä¹‹é—´çš„ä¾èµ–å’Œè°ƒç”¨å…³ç³»ä¹Ÿä¼šè¶Šå¤æ‚ã€‚å¯¹äºå¤„äºåº•å±‚çš„åŸºç¡€æœåŠ¡ï¼Œç›´æ¥å’Œé—´æ¥çš„è°ƒç”¨æ‰€å¸¦æ¥çš„æµé‡å‹åŠ›éå¸¸å¤§ã€‚å¤„äºä¸­é—´å±‚çš„èšåˆå‹æœåŠ¡ï¼Œé¢å¯¹çš„æŒ‘æˆ˜åˆ™æ˜¯ä¾èµ–çš„æœåŠ¡å¤ªå¤šï¼Œåç«¯ä¸ªåˆ«æœåŠ¡çš„æ€§èƒ½å»¶è¿Ÿå°±ä¼šå½±å“å…¶ååé‡ã€‚æ€§èƒ½ä¼˜åŒ–æ˜¯æˆ‘ä»¬ç³»ç»Ÿç¨³å®šæ€§ä¸­çš„é‡è¦ä¸€ç¯ï¼Œè¿™å…¶ä¸­ï¼Œè°ƒç”¨æ‰€ä¾èµ–çš„RPCæœåŠ¡æˆ–åç«¯æ•°æ®æ˜¯é‡ç‚¹ä¹‹ä¸€ã€‚</p><p>ç›®å‰ï¼Œé™¤äº†ä¼ ç»ŸJDBCè¿™æ ·ä»APIåˆ°ä¸»æµé©±åŠ¨å®ç°å°±æ˜¯é˜»å¡å¼çš„ç±»åº“ä¹‹å¤–ï¼Œå…¶ä»–å¸¸ç”¨çš„RPC/HTTPæœåŠ¡ã€MQã€Redisã€Mongodbã€Kafkaç­‰ç³»ç»Ÿéƒ½æä¾›äº†æˆç†Ÿçš„åŸºäºNIOçš„å®¢æˆ·ç«¯åº“ï¼Œä¹Ÿæœ‰ç›¸åº”çš„å¼‚æ­¥APIã€‚</p><p>ä½†æ˜¯ç›®å‰äº¤æ˜“å¹³å°çš„å¤§å¤šæ•°ä¸­å°æœåŠ¡ç³»ç»Ÿï¼Œè¿˜åœ¨ä¹ æƒ¯æ€§ä½¿ç”¨ç€è¿™äº›åº“çš„åŒæ­¥APIï¼Œå¹¶ä¸èƒ½å……åˆ†çš„åˆ©ç”¨CPUï¼Œè¿™ä¹Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†ä¸€å®šçš„ä¼˜åŒ–ç©ºé—´ã€‚ä»16å¹´å¼€å§‹æˆ‘ä»¬åœ¨ä¸€äº›æ ¸å¿ƒçš„ä½†æ˜¯æœåŠ¡é€»è¾‘ç›¸å¯¹ç®€å•çš„ç³»ç»Ÿä¸­ä½¿ç”¨å¼‚æ­¥æ–¹å¼æ¥å®ç°ï¼Œè™½ç„¶æš‚æ—¶è¿˜åšä¸åˆ°å®Œå…¨çš„å¼‚æ­¥åŒ–ï¼Œä½†æ˜¯ä¹Ÿå–å¾—äº†æ¯”è¾ƒå¥½çš„æ•ˆæœã€‚è¿™ç¯‡æ–‡ç« è™½ç„¶æ›´å¤šæ˜¯ä¸€ä¸ªç®€ä»‹æ€§è´¨ï¼Œä½†æ˜¯ä¹Ÿæ¶µç›–äº†æˆ‘ä»¬åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­éœ€è¦å…³æ³¨çš„è¦ç‚¹ã€‚å¸Œæœ›å¤§å®¶èƒ½å¤Ÿä¹ æƒ¯å’Œæ‹¥æŠ±å¼‚æ­¥ç¼–ç¨‹ã€‚</p><p><strong>ä¸€ã€ç›¸å…³æ¦‚å¿µä»‹ç»</strong></p><p>åŒæ­¥(Synchronous)/å¼‚æ­¥(Asynchronous)ï¼Œé€šå¸¸æ˜¯æŒ‡å‡½æ•°è°ƒç”¨ä¸­çš„æ¶ˆæ¯é€šä¿¡çš„ä¸¤ç§ä¸åŒæ¨¡å¼ã€‚</p><p><strong>1ã€å¼‚æ­¥å’ŒåŒæ­¥çš„åŒºåˆ«</strong></p><p>å‡½æ•°è°ƒç”¨å‘ç”Ÿæ—¶ï¼Œæ¶ˆæ¯(å‚æ•°)ä»callerä¼ é€’åˆ°calleeï¼Œæ§åˆ¶æƒ(æŒ‡ä»¤æ‰§è¡Œ)ä»callerè½¬ç§»åˆ°calleeã€‚è°ƒç”¨è¿”å›æ—¶ï¼Œæ§åˆ¶æƒä»calleeè½¬ç§»åˆ°callerã€‚ä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼Œcalleeæ˜¯å¦éœ€è¦ç­‰å¾…æ‰§è¡Œå®Œæˆæ‰å°†æ§åˆ¶æƒè½¬ç§»ç»™callerã€‚</p><p>åœ¨RPCè¿™ç§æ›´å¤æ‚çš„åœºæ™¯ä¸‹ï¼Œæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ä¸åŒã€‚</p><p>â—† åŒæ­¥</p><p><img alt=å¼‚æ­¥ç¼–ç¨‹æå‡æœåŠ¡æ€§èƒ½ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15260210063976700d35c2d></p><p>1.calleeæ‰§è¡Œå®Œæˆæ‰è¿”å›</p><p>2.è¿”å›å€¼å³ç»“æœ</p><p>â—† å¼‚æ­¥</p><p><img alt=å¼‚æ­¥ç¼–ç¨‹æå‡æœåŠ¡æ€§èƒ½ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1526021006860927b1feca3></p><p>1.calleeä¸éœ€è¦æ‰§è¡Œå®Œæˆå°±å¯è¿”å›</p><p>2.callerè¦è·å–ç»“æœï¼Œéœ€è¦é€šè¿‡è½®è¯¢ã€å›è°ƒç­‰æœºåˆ¶</p><p>â—† åŒæ­¥RPC</p><p><img alt=å¼‚æ­¥ç¼–ç¨‹æå‡æœåŠ¡æ€§èƒ½ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15260210065070b97e26186></p><p>â—† å¼‚æ­¥RPC</p><p><img alt=å¼‚æ­¥ç¼–ç¨‹æå‡æœåŠ¡æ€§èƒ½ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/152602100651271869c2752></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¼‚æ­¥RPCçš„åœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç”¨äºå¤„ç†IOçš„CPUèƒ½å¾—åˆ°å……åˆ†åˆ©ç”¨ï¼Œé€šå¸¸åªéœ€è¦è¿œä½äºcallerè¯·æ±‚æ•°é‡çš„çº¿ç¨‹å°±å¯ä»¥äº†ï¼Œè¿™å°±æ˜¯å¤šè·¯å¤ç”¨ã€‚</p><p><strong>2ã€calleeæ‰§è¡Œæœºåˆ¶</strong></p><p>ä¸Šå›¾ä¸­calleeçš„background executeé€šå¸¸æ˜¯é‡‡ç”¨æ± åŒ–çº¿ç¨‹æ¥å®Œæˆçš„ï¼Œæ¯”å¦‚ThreadPoolExecutoræˆ–EventLoop1ã€‚</p><p><strong>3ã€callerè·å–æ‰§è¡Œç»“æœ</strong></p><p>callerè°ƒç”¨calleeæ—¶ï¼Œå¦‚æœéœ€è¦è·å–æ‰§è¡Œç»“æœï¼ˆæ¶ˆæ¯åŒå‘ä¼ é€’ï¼‰ï¼Œæˆ–è€…è·çŸ¥æ‰§è¡Œæ˜¯å¦å®Œæˆï¼ˆæ¶ˆæ¯å•å‘ä¼ é€’æ— è¿”å›å€¼ï¼‰ï¼Œåœ¨å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œä¸»è¦ä¾é ä¸‹é¢ä¸¤ç§æœºåˆ¶ã€‚</p><p>â—† è½®è¯¢(Polling)</p><p>æ¯”å¦‚Javaçš„Futureå°±æä¾›äº†isDone()è¿™ç§è¯¢é—®æœºåˆ¶ã€‚</p><pre>1.//Caller.java2.void call() {3. Future&lt;Void&gt; f = callee.asyncCall(param);4. // do some other things5. while(true) {6. if (f.isDone()) break;7. //do some other things or sleep or timeout8. }9.}</pre><p>æˆ–é˜»å¡ç‰ˆæœ¬</p><pre>1.//Caller.java2.void call() {3. Future&lt;Void&gt; f = callee.asyncCall(param);4. // do some other things5. f.get(timeout, TimeUnit.SECONDS);6.}</pre><p>è½®è¯¢çš„æ§åˆ¶é€»è¾‘åœ¨callerç«¯ã€‚</p><p>â—† å›è°ƒ(Callback)</p><p>callerè®¾ç½®ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä¾›calleeæ‰§è¡Œå®Œæˆåè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚å›è°ƒçš„æ§åˆ¶æ˜¯åè½¬çš„ï¼Œé€šå¸¸ç”±calleeç«¯æ§åˆ¶ã€‚</p><pre>1.//Caller.java2.void call() {3. callee.asyncCall(param, new AsyncHandler&lt;Response&lt;Message&gt;&gt;() {4. @Override public void handleResponse(Response&lt;Message&gt; response) {5. msg = response.get();6. // process the msg...7. }8. });9. // do some other things10.}</pre><p><strong>4ã€å¼‚æ­¥æ¨¡å¼çš„åœºæ™¯</strong></p><p>â—† é˜»å¡</p><p>é˜»å¡(Blocking)/éé˜»å¡(Non-Blocking)æ˜¯ç”¨æ¥æè¿°ï¼Œåœ¨ç­‰å¾…è°ƒç”¨ç»“æœæ—¶callerçº¿ç¨‹çš„çŠ¶æ€ã€‚é˜»å¡ï¼Œé€šå¸¸æ„å‘³ç€callerçº¿ç¨‹ä¸å†ä½¿ç”¨CPUæ—¶é—´ï¼Œå¤„äºå¯è¢«OSè°ƒåº¦çš„çŠ¶æ€(æ³¨æ„ä¸Javaçº¿ç¨‹çŠ¶æ€2çš„åŒºåˆ«)ã€‚ ç£ç›˜IOå’Œç½‘ç»œIOæ˜¯å¸¸è§çš„ä¼šå¼•èµ·çº¿ç¨‹é˜»å¡çš„åœºæ™¯3ã€‚å—åˆ¶äºåº•å±‚OSçš„åŒæ­¥é˜»å¡å¼IOç³»ç»Ÿå‡½æ•°ï¼Œè°ƒç”¨Java OIO(Old blocking IO) APIæ— ç–‘æ˜¯ä¼šé˜»å¡çš„ã€‚å¯¹äºDiskIOï¼ŒJava NIO2æä¾›äº†å¼‚æ­¥APIã€‚å¯¹äºSocketIOï¼ŒJava NIO2ä»¥åŠNIOæ¡†æ¶Nettyï¼Œéƒ½æä¾›äº†å¼‚æ­¥APIã€‚</p><blockquote><p>â—† Linuxæä¾›äº†å¼‚æ­¥IOç³»ç»Ÿå‡½æ•°ï¼Œåªèƒ½ç”¨äºDiskIOï¼Œè¿˜æœ‰ä¸€äº›é™åˆ¶4ï¼ŒJava NIO2 AsynchronousFileChannelå†…éƒ¨ä»ç„¶ä½¿ç”¨çº¿ç¨‹æ± +é˜»å¡å¼APIçš„å®ç°ã€‚</p><p>â—† Linuxä¸ºSocketIOå‡†å¤‡å°±ç»ªé˜¶æ®µæä¾›äº†éé˜»å¡å¼API(select/poll/epoll)ï¼Œä½†æ˜¯IOæ‰§è¡Œé˜¶æ®µä»ç„¶æ˜¯åŒæ­¥é˜»å¡çš„ï¼Œå› æ­¤ä¸»æµçš„Java NIOæ¡†æ¶çš„Reactoræ¨¡å¼å†…éƒ¨å®ç°ä½¿ç”¨äº†çº¿ç¨‹æ± ã€‚</p></blockquote><p>â—† å¹¶è¡Œ</p><p>æ¯”å¦‚éœ€è¦è°ƒç”¨å¤šä¸ªæ²¡æœ‰ä¾èµ–å…³ç³»çš„æœåŠ¡ï¼Œæˆ–è€…è®¿é—®åˆ†æ•£åœ¨å¤šä¸ªå­˜å‚¨åˆ†ç‰‡ä¸­çš„æ•°æ®ï¼Œå¦‚æœæœåŠ¡æ¥å£æˆ–æ•°æ®è®¿é—®æ¥å£å®ç°äº†å¼‚æ­¥APIï¼Œé‚£ä¹ˆå°±å¾ˆæ–¹ä¾¿å®ç°å¹¶è¡Œè°ƒç”¨ï¼Œå‡å°‘æ€»ä½“è°ƒç”¨è€—æ—¶ã€‚</p><p>â—† é€Ÿåº¦ä¸åŒ¹é…</p><p>ä½¿ç”¨ä¸­é—´é˜Ÿåˆ—è§£å¶callerå’Œcalleeçš„é€Ÿåº¦ä¸åŒ¹é…é—®é¢˜ï¼Œå‰Šå³°å¡«è°·ã€‚</p><p>â—† æ‰¹é‡</p><p>ä½¿ç”¨ä¸­é—´é˜Ÿåˆ—è§£å¶callerå’Œcalleeçš„é€Ÿåº¦ä¸åŒ¹é…é—®é¢˜ï¼Œå‰Šå³°å¡«è°·ã€‚</p><p><strong>äºŒã€å¼‚æ­¥APIçš„å‡ ç§é£æ ¼</strong></p><p><strong>1ã€Callback</strong></p><p>è¿™ä¸ªæ¯”è¾ƒä¼ ç»Ÿï¼Œæ¯”å¦‚zookeeperå®¢æˆ·ç«¯æä¾›çš„åŸºäºå›è°ƒçš„å¼‚æ­¥API:</p><pre>1.try {2. zookeeper.create(path, data, acl, createMode, new StringCallback() {3. public void processResult(int rc, String path, Object ctx, String name) {4. if (rc != KeeperException.Code.OK.intValue()) {5. // error handle6. } else {7. // success process8. // å¦‚æœéœ€è¦åœ¨æˆåŠŸåå†å‘èµ·åŸºäºå›è°ƒçš„å¼‚æ­¥è°ƒç”¨ï¼Œä¼šå½¢æˆcallback hell9. }10. }11. }, ctx);12.} catch( Throwable e) {13. // error handle</pre><blockquote><p>â—† Callbacké€šå¸¸æ˜¯æ— çŠ¶æ€çš„</p><p>â—† è¦è·å–Callbackçš„è®¡ç®—ç»“æœï¼Œé€šå¸¸éœ€è¦closure</p><p>â—† å¼‚å¸¸å¤„ç†æ¯”è¾ƒåˆ†æ•£</p><p>â—† åœ¨æœ‰å¤šä¸ªå¼‚æ­¥è°ƒç”¨é“¾çš„æ—¶å€™ï¼Œå®¹æ˜“é€ æˆCallback hell</p></blockquote><p><strong>2ã€Future/Promise</strong></p><p>Promiseæ˜¯calleeç»™callerçš„å‡­è¯ï¼Œä»£è¡¨æœªå®Œæˆä½†æ‰¿è¯ºå®Œæˆï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰çš„ç»“æœã€‚Promiseæœ¬èº«æ˜¯æœ‰çŠ¶æ€çš„ï¼Œé€šå¸¸ç”±calleeç«¯ç»´æŠ¤ã€‚å…¶çŠ¶æ€è½¬ç§»å¦‚ä¸‹ï¼ˆæœ¯è¯­å‚è€ƒPromise/A+å’ŒES6ï¼‰ï¼š</p><blockquote><p>Promiseçš„çŠ¶æ€åªèƒ½è½¬ç§»ä¸€æ¬¡ï¼Œå› æ­¤å¦‚æœæœ‰callbackï¼Œé‚£ä¹ˆ.then(callback)æˆ–.catch(callback)ä¹Ÿåªè¢«æ‰§è¡Œä¸€æ¬¡ã€‚</p></blockquote><p>JDK5çš„Futureåªèƒ½ç”¨è½®è¯¢æˆ–è€…é˜»å¡çš„æ–¹å¼è·å–ç»“æœï¼Œcallerç«¯å¤„ç†æ¯”è¾ƒç¹çã€‚Guavaçš„ListenableFutureï¼Œç‰¹åˆ«æ˜¯JDK8çš„CompletableFutureï¼Œåˆ™æ˜¯å®Œæ•´å®ç°äº†Promiseé£æ ¼çš„å¼‚æ­¥APIã€‚ ä¸ªäººè®¤ä¸ºPromiseæ˜¯æ›´å¥½çš„Callbackï¼ŒListenableFutureæ¥å£åªæ˜¯æ¯”Futureå¤šäº†ä¸€ä¸ªvoid addListener(Runnable, Executor)æ–¹æ³•ã€‚ Promiseæä¾›äº†æ¯”Callbackæ›´æ˜“ç”¨æ›´æ¸…æ™°çš„ç¼–ç¨‹æ¨¡å¼ï¼Œå°¤å…¶æ˜¯æ¶‰åŠå¤šä¸ªå¼‚æ­¥APIçš„ä¸²è¡Œè°ƒç”¨ï¼ˆchainingæˆ–pipelining )ã€ç»„åˆè°ƒç”¨ï¼ˆå¹¶è¡Œã€åˆå¹¶ï¼‰ã€å¼‚å¸¸å¤„ç†ç­‰æ–¹é¢æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ã€‚</p><blockquote><p><strong>å¼•ç”³é˜…è¯»</strong></p><p>â—† è¿™ç¯‡æ–‡ç« è°ˆåˆ°äº†Futureå’ŒPromiseçš„ç»†å¾®åŒºåˆ«ã€ç›¸å…³å†å²å’ŒæŠ€æœ¯ã€‚</p><p>â—† è¿™é‡Œæœ‰ä¸€äº›è®¨è®ºï¼šArenâ€™t promises just callbacks?,Is there really a fundamental difference between callbacks and Promises?ã€‚</p><p>â—† Promiseå€Ÿé‰´äº†å‡½æ•°å¼ä¸­çš„ä¸€äº›æ¦‚å¿µ: ä»å‡½æ•°å¼ç¼–ç¨‹åˆ°Promiseã€‚</p><p>â—† è¿™ç¯‡æ–‡ç« ç®€è¦å¯¹æ¯”äº†å‡ ç§è¯­è¨€ä¸­çš„Promiseæ¡†æ¶ã€‚</p></blockquote><p><strong>3ã€ReactiveX</strong></p><p>å…¶å®˜æ–¹ç½‘ç«™çš„ä»‹ç»</p><blockquote><p>An API for asynchronous programming with observable streams</p></blockquote><p>å…¶å…³é”®çš„æ¦‚å¿µObservableæ¯”è¾ƒPromiseæ¥è¯´ï¼š</p><p>â—† Promiseä»£è¡¨ä¸€ä¸ªå¼‚æ­¥è®¡ç®—å€¼ï¼Œè€ŒObservableä»£è¡¨ç€ä¸€ç³»åˆ—å€¼(stream)ã€‚</p><p>â—† Promiseçš„å€¼åªèƒ½äº§ç”Ÿä¸€æ¬¡ï¼Œè€ŒObservableçš„äº‹ä»¶å¯ä»¥ä¸æ–­äº§ç”Ÿã€‚å› æ­¤Rxé¦–å…ˆæµè¡Œåœ¨å‰ç«¯UIåœºæ™¯ï¼šäº‹ä»¶æ¥æºå¤šï¼Œæ•°æ®å˜åŒ–å½±å“å¤šä¸ªUIç»„ä»¶çš„å˜æ›´ã€‚</p><p>Rxçš„å­¦ä¹ æ›²çº¿æ¯”Promiseè¦é«˜å¾—å¤šï¼Œè€Œä¸”ç›®å‰Promiseé£æ ¼çš„å¼‚æ­¥ç¼–ç¨‹èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬å¤§éƒ¨åˆ†çš„æœåŠ¡ç«¯å¼€å‘åœºæ™¯ï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œä¸»è¦å…³æ³¨Promiseã€‚</p><p><strong>ä¸‰ã€Promiseåœ¨æœåŠ¡ç«¯çš„åº”ç”¨</strong></p><p>ä¸‹é¢ç©¿æ’ç€ä»¥JDK8çš„CompletableFutureå’ŒGuavaçš„ListenableFutureï¼ˆé€‚ç”¨JDK6ï¼‰ä¸ºä¾‹ä»‹ç»Promiseçš„ç”¨æ³•ã€‚</p><p><strong>1ã€ç¬¦åˆPromiseé£æ ¼çš„æ–¹æ³•ç­¾å</strong></p><p>Promiseé£æ ¼çš„æ–¹æ³•ç­¾åï¼Œæœ‰ä¸ªä¸æˆæ–‡çš„è§„åˆ™æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºå¼‚å¸¸æ˜¯Promiseå¯¹è±¡æœ¬èº«å°±èƒ½æºå¸¦çš„ä¸¤ç§çŠ¶æ€ä¹‹ä¸€ã€‚æ¯”å¦‚æˆ‘ä»¬æƒ³æŠŠä¸€ä¸ªCallbacké£æ ¼çš„å¼‚æ­¥APIåŒ…è£…æˆPromiseé£æ ¼çš„ï¼ˆé€šå¸¸åœ¨ä½¿ç”¨ä¸€ä¸ªè¾ƒè€çš„ç±»åº“æ—¶éœ€è¦è¿™æ ·çš„åŒ…è£…ï¼‰ï¼Œå¯ä»¥è¿™æ ·ï¼š</p><pre>1.//caller.java2.CompletableFuture&lt;String&gt; asyncCall(final String msg) {3. CompletableFuture&lt;String&gt; promise = new CompletableFuture&lt;&gt;();4. try {5. callee.asyncCall(msg, new Callback&lt;String&gt;() {6. public void onSuccess(String r) { promise.complete(r); }7. public void onFail(Throwable t) { promise.completeExceptionally(t); }8. });9. } catch (Throwable e) {10. promise.completeExceptionally(t);11. }12. return promise;13.}</pre><p>ä¸‹é¢æ˜¯ä½¿ç”¨ListenableFutureçš„å®ç°å¼‚æ­¥å‘é€æ¶ˆæ¯çš„APIã€‚</p><pre>1.//LocalMessageEngine.java2.static class WriteTask {3. // SettableFutureæ˜¯Guavaä¸­ä¸€ç§å¯è®¾ç½®çŠ¶æ€çš„Promiseç±»å‹ã€‚4. final SettableFuture&lt;Boolean&gt; promise = SettableFuture.create();5. final byte[] message;6. WriteTask(byte[] message) {7. this.message = message;8. }9.}10.public Producer createProducer() {11. return new Producer() {12. public ListenableFuture&lt;Boolean&gt; asyncProduce(byte[] message) {13. if (!Engine.this.started) {14. // è¿”å›å‰å·²å®Œæˆ15. return Futures.immediateFailedFuture(new IllegalStateException("Message engine was stopped or not started"));16. }17.18. WriteTask task = new WriteTask(message);19. boolean queued = writeTaskQueue.offer(task);20. if (!queued) {21. task.promise.set(Boolean.FALSE);22. }23. return task.promise;24. }25. };26.}</pre><p>ä¸Šé¢ä¸¤ä¸ªä¾‹å­ï¼Œæè¿°äº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªPromiseå¯¹è±¡è¿”å›ç»™callerï¼Œä»¥åŠå¦‚ä½•åœ¨calleeç«¯fulfillæˆ–rejectè¿™ä¸ªPromiseã€‚ä½ å¯èƒ½ä¼šå‘ç°ï¼Œè¿”å›ç»™callerä¹‹å‰Promiseæ˜¯å¯ä»¥å¤„äºå®ŒæˆçŠ¶æ€çš„ã€‚åœ¨ç»§ç»­ä¸‹é¢çš„ä½¿ç”¨ä»‹ç»å‰ï¼Œå…ˆç®€å•çš„çœ‹ä¸‹ListenableFutureå’ŒCompletableFutureçš„å‡ ä¸ªä¸»è¦APIã€‚</p><p><img alt=å¼‚æ­¥ç¼–ç¨‹æå‡æœåŠ¡æ€§èƒ½ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15260210065997b2aa4be68></p><p><strong>2ã€ä¸²è¡Œè°ƒç”¨</strong></p><p>ListenableFutureæ²¡æœ‰æä¾›thenæ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡Futuresçš„ä¸€ç³»åˆ—é™æ€æ–¹æ³•æ¥å®ç°Promiseé£æ ¼çš„APIã€‚ç”±äºä¸¤è€…æœ‰å¤§éƒ¨åˆ†çš„APIæ˜¯å¯ä»¥ç›¸äº’è½¬åŒ–çš„ï¼Œé™äºç¯‡å¹…ä¸‹é¢å°±ä¸å…¨éƒ¨æ¼”ç¤ºäº†ã€‚Promseçš„callbackå°±æ˜¯å…¶thenæˆ–catchæ–¹æ³•çš„å‡½æ•°å‹å‚æ•°ï¼Œå½“Promiseè¢«resolveæ—¶æ‰§è¡Œè¿™ä¸ªcallbackå‡½æ•°ã€‚è¿™ä¸ªcallbackå‡½æ•°çš„è¾“å…¥ï¼Œå°±æ˜¯Promiseçš„resolvedå€¼ã€‚æ ¹æ®callbackå‡½æ•°çš„è¾“å‡ºçš„ä¸åŒï¼Œéœ€è¦é‡‡å–ä¸åŒçš„thenæ–¹æ³•ã€‚</p><p>â—† callbackæ— è¾“å‡º</p><p>Futures.addCallbackå’ŒCompletableFuture.thenAcceptæ¥å—æ— è¾“å‡ºçš„callbackã€‚</p><pre>1.// Guava2.ListenableFuture&lt;QueryResult&gt; promise1 = ...;3.Futures.addCallback(promise1, new FutureCallback&lt;QueryResult&gt;() {4. public void onSuccess(QueryResult result) {5. storeInLocalCache(result);6. }7. public void onFailure(Throwable t) {8. reportError(t);9. }10.});</pre><pre>1.// CompletableFuture2.CompletableFuture&lt;QueryResult&gt; promise1 = ...;3.CompletableFuture&lt;Void&gt; promise2 = promise1.thenAccept(result -&gt; storeInLocalCache(result));4.return promise2;5.//return promise1.thenAccept(result -&gt; storeInLocalCache(result));//thenAcceptè¿”å›å¦ä¸€ä¸ªPromiseå®ä¾‹</pre><p>å…ˆå¿½ç•¥å¼‚å¸¸å¤„ç†ã€‚å¯¹æ¯”ä¸‹è¿™ç§åœºæ™¯ä¸‹çš„ListenableFutureå’ŒCompletableFutureï¼šå‰è€…é‡‡å–äº†æ›´ä¼ ç»Ÿçš„callbacké£æ ¼ï¼Œåè€…åˆ™è¿”å›ä¸€ä¸ªæ–°çš„Promiseå®ä¾‹ï¼Œcallbackè®¡ç®—å®Œæ¯•åˆ™promise2è¢«fulfilledï¼Œå¾ˆå®¹æ˜“é€šè¿‡promise2æ¥è·å–callbackæ‰§è¡Œå®Œæ¯•ä¸å¦ï¼Œä¸éœ€è¦closureã€‚</p><p>â—† callbackè¾“å‡ºä¸€ä¸ªæ™®é€šè®¡ç®—å€¼</p><p>è¿™ç§æƒ…å†µä¸‹callbackå°±æ˜¯ä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼Œè¾“å…¥æ˜¯å‰ä¸€ä¸ªPromiseçš„fulfilledå€¼ï¼Œè¾“å‡ºåˆ™ä½œä¸ºæ–°Promiseçš„fulfilledå€¼ã€‚Futures.transformå’ŒCompletableFuture.thenApplyæ¥æ”¶è¿™æ ·çš„callbackå‡½æ•°ã€‚</p><pre>1.// CompletableFuture2.CompletableFuture&lt;QueryResult&gt; queryFuture = ...;3.CompletableFuture&lt;List&lt;Row&gt;&gt; rowsFuture = queryFuture.thenApply(result -&gt; result.getRows());4.return rowsFuture;</pre><p>â—† callbackè¾“å‡ºä¸€ä¸ªå¼‚æ­¥è®¡ç®—å€¼ï¼Œå³ä¸€ä¸ªPromise</p><p>ä¹ä¸€çœ‹ï¼Œè¿™ç§æƒ…å†µä¸‹çš„è¾“å‡ºè·Ÿä¸Šä¸€ç§å¥½åƒæ²¡ä»€ä¹ˆåŒºåˆ«ã€‚ä½†å®é™…ä¸Šï¼Œè¾“å‡ºä¸€ä¸ªPromiseå€¼å’Œè¾“å‡ºä¸€ä¸ªæ™®é€šçš„å€¼æœ‰æ ¹æœ¬çš„åŒºåˆ«ã€‚è¿˜è®°å¾—å§ï¼ŒPromiseä»£è¡¨ç€ä¸€ä¸ªæœªå®Œæˆçš„å¹¶ä¸”æ‰¿è¯ºå®Œæˆçš„å€¼ã€‚é€šå¸¸è¿™ç§æƒ…å†µä¸‹ï¼Œæ„å‘³ç€callbacké‡Œè°ƒç”¨äº†å¦å¤–ä¸€ä¸ªPromiseé£æ ¼çš„å¼‚æ­¥APIã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­indexService.lookUpå’ŒdataService.readæ–¹æ³•ï¼Œç”±äºæ¶‰åŠåˆ°IOï¼Œéƒ½è®¾è®¡ä¸ºå¼‚æ­¥APIã€‚</p><pre>1.//Guava2.ListenableFuture&lt;RowKey&gt; rowKeyFuture = indexService.lookUp(query);3.AsyncFunction&lt;RowKey, QueryResult&gt; queryFunction = new AsyncFunction&lt;RowKey, QueryResult&gt;() {4. public ListenableFuture&lt;QueryResult&gt; apply(RowKey rowKey) {5. return dataService.read(rowKey);6. }7.};8.ListenableFuture&lt;QueryResult&gt; queryFuture = Futures.transformAsync(rowKeyFuture, queryFunction);9.return queryFuture;</pre><p>Futures.transformAsyncå’ŒCompletableFuture.thenComposeæ¥æ”¶è¿™æ ·çš„callbackå‡½æ•°ã€‚</p><p>è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæŸä¸ªé€»è¾‘ä¸­éœ€è¦è°ƒç”¨çš„å¤šä¸ªPromiseé£æ ¼çš„å¼‚æ­¥æ–¹æ³•ï¼ˆæ¯”å¦‚å¤šä¸ªRPCè°ƒç”¨ï¼‰ï¼Œå¹¶ä¸”æœ‰å…ˆåä¾èµ–å…³ç³»ï¼Œå³ä¸Šä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œç»“æœä½œä¸ºä¸‹ä¸€ä¸ªæ–¹æ³•çš„è¾“å…¥ã€‚å°±å¯ä»¥ç”¨thenComposeæŠŠä»–ä»¬ä¸²èµ·æ¥ã€‚</p><pre>1.//CompletableFuture2.CompletableFuture&lt;RPC4Result&gt; promise4 = rpc1.call(input) //promise13. .thenCompose(rpc1Result -&gt; rpc2.call(rpc1Result)) //promise24. .thenCompose(rpc2Result -&gt; rpc3.call(rpc2Result)) //promise35. .thenCompose(rpc3Result -&gt; rpc4.call(rpc3Result)) //promise46.return promise4;</pre><p>ä¸è¦è¢«é“¾å¼è°ƒç”¨ç»™å¿½æ‚ äº†ï¼Œä½ è¿˜æ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨æ™®é€šçš„é£æ ¼ã€‚</p><p>å•çº¯çœ‹æ¥ï¼Œä¸Šè¿°çš„ä¸²è¡Œè°ƒç”¨åœºæ™¯ä¸‹ä½¿ç”¨Promiseé£æ ¼çš„APIå¥½åƒåªæ˜¯æ¶ˆé™¤äº†Callback hellã€‚é‚£ä¹ˆé‡‡ç”¨åŒæ­¥APIå°±æ—¢æ²¡æœ‰Callback hellçš„é—®é¢˜ï¼Œåˆç¬¦åˆæ•°æ®ä¾èµ–å…³ç³»ã€‚å¯æ˜¯ï¼Œä½ ä¼šå‘ç°ï¼Œä¸Šé¢çš„ä¸¾ä¾‹ä¸­ç»“å°¾éƒ½è¿”å›äº†Promiseï¼Œå°±æ˜¯è¯´ï¼ŒåŒ…å«è¿™æ®µä»£ç çš„æ–¹æ³•è¢«è®¾è®¡ä¸ºå¼‚æ­¥APIã€‚è€Œä½¿ç”¨åŒæ­¥APIï¼Œåˆ™ä¼šå¼ºåˆ¶è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨è€…åªèƒ½ä½¿ç”¨åŒæ­¥æ–¹å¼è°ƒç”¨ã€‚</p><p><strong>3ã€å¹¶è¡Œè°ƒç”¨</strong></p><p>å¼‚æ­¥APIå¾ˆé€‚åˆå¹¶è¡Œè°ƒç”¨ã€‚calleråœ¨è°ƒç”¨å¤šä¸ªæ²¡æœ‰ä¾èµ–å…³ç³»çš„å¼‚æ­¥APIæ—¶ï¼Œå¯ä»¥å…ˆä¾æ¬¡å‘èµ·è°ƒç”¨è€Œä¸ç”¨ç­‰å¾…æ¯ä¸ªè°ƒç”¨çœŸæ­£æ‰§è¡Œå®Œæˆï¼Œä»calleeçš„è§’åº¦æ¥è®²ï¼Œæ‰§è¡Œæ˜¯å¹¶è¡Œçš„ã€‚callerå¯ä»¥å¯¹è°ƒç”¨ç»“æœè¿›è¡Œåˆå¹¶å¤„ç†ï¼Œå…³é”®æ˜¯ï¼Œåˆå¹¶ä¹Ÿæ˜¯å¼‚æ­¥é£æ ¼çš„ã€‚</p><pre>1.//Guava2.List&lt;ListenableFuture&lt;QueryResult&gt;&gt; partialPromises = new ArrayList&lt;ListenableFuture&lt;QueryResult&gt;&gt;(nodes.size());3.for (Node node : nodes) {4. partialPromises.add(lookupHandler(node).query());5.}6.ListenableFuture&lt;List&lt;Row&gt;&gt; mergedPromise = Futures.transform(Futures.allAsList(partialPromises), new Function&lt;List&lt;List&lt;Row&gt;&gt;, List&lt;Row&gt;&gt;() {7. @Override public Long apply(List&lt;List&lt;Row&gt;&gt; input) {8. return merge(input);9. }10.})11.return mergedPromise;</pre><p>Futures.allAsListæ˜¯å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰çš„promisesï¼Œè‹¥æœ‰ä¸€ä¸ªpromiseå¼‚å¸¸å®Œæˆåˆ™å°è¯•rejectå°šæœªresolvedçš„promiseã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨Futures.successfulAsListï¼ŒåŒºåˆ«åœ¨äºåè€…å¹¶ä¸ä¼šrejectå°šæœªresolvedçš„promiseã€‚CompletableFutureçš„å¯¹åº”ç‰©æ˜¯allOfå’ŒanyOfã€‚</p><p><strong>4ã€è°ƒç”¨ç¼–æ’</strong></p><p>åˆå¹¶ç»“æœè®¾è®¡ä¸ºå¼‚æ­¥é£æ ¼çš„å¥½å¤„åœ¨äºï¼Œå¾ˆæ–¹ä¾¿åšåˆå¹¶ã€ä¸²è¡Œæ··åˆè°ƒç”¨ç¼–æ’ï¼Œæ¯”å¦‚æŸä¸ªé€»è¾‘ä¸­éœ€è¦è°ƒç”¨å››ä¸ªä¸ªRPCæœåŠ¡Aã€Bã€Cã€Dï¼Œå…¶ä¸­ï¼šAçš„è¾“å‡ºä½œä¸ºBã€Cçš„è¾“å…¥ï¼ŒBã€Cå¯å¹¶è¡Œï¼ŒBã€Cçš„è¾“å‡ºåˆå¹¶åä½œä¸ºDçš„è¾“å…¥ã€‚</p><pre>1.//CompletableFuture2.CompletableFuture&lt;AResult&gt; promiseA = rpcA.call(input);3.CompletableFuture&lt;DResult&gt; promiseD = promiseA.thenCompose(aResult -&gt; {4. CompletableFuture&lt;BResult&gt; promiseB = rpcB.call(aResult);5. CompletableFuture&lt;CResult&gt; promiseC = rpcC.call(aResult);6. CompletableFuture&lt;MergedResult&gt; mergedPromise = promiseB.thenCombine(promiseC, (bResult, cResult) -&gt; {7. return merge(bResult, cResult)8. });9. return mergedPromise;10.}).thenCompose(mergedResult -&gt; rpcD.call(mergedResult));11.return promiseD;</pre><p><strong>5ã€å¼‚å¸¸å¤„ç†</strong></p><p>ä¸Šé¢æåˆ°è¿‡Callbacké£æ ¼çš„å¼‚æ­¥APIï¼Œå¼‚å¸¸å¤„ç†æ¯”è¾ƒåˆ†æ•£ã€‚è€ŒPromiseé£æ ¼çš„å¼‚å¸¸å¤„ç†åˆ™ä¼˜é›…å¾—å¤šã€‚æˆ‘ä»¬éœ€è¦è®°ä½ï¼Œå¼‚å¸¸æ˜¯Promiseæºå¸¦çš„ä¸¤ç§çŠ¶æ€ä¹‹ä¸€ã€‚é‚£ä¹ˆå¼‚å¸¸å¯ä»¥ä½œä¸ºcallbackå‡½æ•°çš„è¾“å…¥ã€‚</p><p>â—† é€šç”¨å¼‚å¸¸å¤„ç†</p><p>Futures.catchingå’ŒCompletableFuture.exceptionallyæ¥æ”¶å¼‚å¸¸å€¼ä¸ºå‚æ•°çš„callbackå‡½æ•°ã€‚</p><pre>1.//Guava2.ListenableFuture&lt;Integer&gt; fetchCounterPromise = ...;3.// Falling back to a zero counter in case an exception happens when4.// processing the RPC to fetch counters.5.ListenableFuture&lt;Integer&gt; faultTolerantPromise = Futures.catching(6. fetchCounterPromise, FetchException.class,7. new Function&lt;FetchException, Integer&gt;() {8. public Integer apply(FetchException e) {9. return 0;10. }11. });</pre><p>æˆ‘ä»¬å†çœ‹ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­ã€‚</p><pre>1.//CompletableFuture2.CompletableFuture&lt;FaultTolerantResult&gt; faultTolerantPromise = rpc1.call(input) //promise13. .thenCompose(rpc1Result -&gt; rpc2.call(rpc1Result)) //promise24. .thenCompose(rpc2Result -&gt; rpc3.call(rpc2Result)) //promise35. .thenCompose(rpc3Result -&gt; rpc4.call(rpc3Result)) //promise46. .exceptionally(err -&gt; {7. // process err8. return faultTolerantValue;9. }); //faultTolerantPromise10.return faultTolerantPromise;</pre><p>å†æé†’ä¸€éï¼Œä¸è¦è¢«é“¾å¼è°ƒç”¨è¿·æƒ‘äº†ã€‚è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œrpc1/rpc2/rpc3/rpc4éƒ½æœ‰å¯èƒ½å‘ç”Ÿå¼‚å¸¸ï¼Œä½†æˆ‘ä»¬åªéœ€è¦åœ¨æœ€åç»Ÿä¸€å¤„ç†ï¼ˆè¿”å›å¼‚å¸¸å€¼æˆ–è½¬æ¢ä¸ºä¸€ä¸ªé»˜è®¤æ­£å¸¸å€¼ï¼‰ã€‚æ¯”å¦‚rpc2å‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆrpc3/rpc4çš„é€»è¾‘ï¼ˆæ¥æ”¶æ­£å¸¸å€¼çš„callbackå‡½æ•°ï¼‰éƒ½ä¸ä¼šæ‰§è¡Œï¼Œä½†æ˜¯rpc2çš„å¼‚å¸¸ä¼šä¼ é€’ç»™promise3/promise4ã€‚</p><p>â—† æ¢å¤</p><p>å‡è®¾åœ¨è¯»å–æŸä¸ªæ•°æ®å­˜å‚¨å‘ç”Ÿå¼‚å¸¸ï¼Œæˆ‘ä»¬éœ€è¦æŸç§æ¢å¤æœºåˆ¶ï¼Œæ¯”å¦‚è¯»å–å¦ä¸€ä¸ªbackupçš„æ•°æ®å­˜å‚¨ï¼ˆæŸç§é‡è¯•ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨Futures.cachingAsyncå’ŒCompletableFuture.handleã€‚</p><pre>1.//CompletableFuture2.public &lt;V&gt; CompletableFuture&lt;V&gt; dispatch(final Command&lt;V&gt; command) {3. final CompletableFuture&lt;V&gt; dispatched = loadbalance.selectHandler().dispatch(command);4. if (maxTries &gt; 0) {5. final AtomicInteger leftTries = new AtomicInteger(maxTries);6. final BiFunction&lt;CompletableFuture&lt;V&gt;, Throwable, CompletableFuture&lt;V&gt;&gt; fallback = new BiFunction&lt;CompletableFuture&lt;V&gt;, Throwable, CompletableFuture&lt;V&gt;&gt;() {7. @Override8. public CompletableFuture&lt;V&gt; apply(CompletableFuture&lt;V&gt; input, Throwable cause) {9. if (cause == null) return input;10. if (cause instanceof RecoverableException &amp;&amp; leftTries.getAndDecrement() &gt; 0) {11. final CompletableFuture&lt;V&gt; next = loadbalance.selectHandler().dispatch(new Command&lt;V&gt;(command.type, command.args));12. return next.handle((v, err) -&gt; err).thenCompose(err -&gt; apply(next, err));13. }14. CompletableFuture&lt;V&gt; errFuture = new CompletableFuture&lt;&gt;();15. errFuture.completeExceptionally(cause);16. return errFuture;17. }18. };19. return dispatched.handle((v, err) -&gt; err).thenCompose(err -&gt; fallback.apply(dispatched, err));20. }21. return dispatched;22.}</pre><p>â—† è¶…æ—¶</p><p>Promiseæ˜¯ä¸€ä¸ªæ‰¿è¯ºå®Œæˆï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰çš„ç»“æœï¼Œä½†æ˜¯å¹¶ä¸æ‰¿è¯ºå®Œæˆæ—¶é—´ã€‚æ‰€ä»¥ï¼Œé€šå¸¸éœ€è¦ä¸€ç§è¶…æ—¶æœºåˆ¶ï¼Œå¹¸è¿çš„æ˜¯ListenableFutureå’ŒCompletableFutureéƒ½å®ç°äº†Futureæ¥å£ã€‚</p><pre>1.CompletableFuture&lt;FaultTolerantResult&gt; faultTolerantPromise = ...;2.try {3. FaultTolerantResult result = faultTolerantPromise.get(1000, TimeUnit.SECONDS);4. // process result5.} catch (TimeoutException e) {6. //å°è¯•å–æ¶ˆæ‰§è¡Œå°šæœªå¼€å§‹çš„callbackå‡½æ•°7. faultTolerantPromise.cancel(false); 8.}</pre><p><strong>å››ã€Promiseå¼‚æ­¥ç¼–ç¨‹çš„æ³¨æ„ç‚¹</strong></p><p>å¼‚æ­¥ç¼–ç¨‹æ¯”åŒæ­¥ç¼–ç¨‹å›°éš¾ã€‚å¼‚æ­¥ç¼–ç¨‹é€šå¸¸ä¸»è¦è§£å†³ä¸€å°éƒ¨åˆ†é—®é¢˜ï¼Œæ¯”å¦‚é˜»å¡ã€‚Promiseå€Ÿé‰´äº†å‡½æ•°å¼ç¼–ç¨‹çš„é£æ ¼ï¼Œå¤§é‡çš„é€»è¾‘ä¼šåˆ†æ•£åœ¨å„ç§callbackå‡½æ•°æ¥å®ç°ã€‚å› æ­¤å¯¹äºä¹ æƒ¯äº†åŒæ­¥ç¼–ç¨‹çš„OOå¼æˆ–å‘½ä»¤å¼ç¼–ç¨‹é£æ ¼çš„å¼€å‘äººå‘˜ï¼Œéœ€è¦ä¸€å®šçš„ä¹ æƒ¯æ—¶é—´ã€‚</p><p>ä¸Šé¢è°ˆåˆ°calleeæ‰§è¡Œæœºåˆ¶çš„æ—¶å€™ï¼Œè°ˆåˆ°äº†çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆcalleeè®¡ç®—å®Œæˆæ—¶ï¼Œcallbackå‡½æ•°çš„æ‰§è¡Œé€šå¸¸æ˜¯æ± ä¸­resolve Promiseçš„çº¿ç¨‹æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œå¦‚æœcalleråœ¨è®¾ç½®callbackçš„æ—¶å€™ï¼ŒPromiseå·²ç»å®Œæˆï¼Œé‚£ä¹ˆcallbackçš„æ‰§è¡Œçº¿ç¨‹åˆ™æ˜¯callerçº¿ç¨‹ã€‚å› æ­¤ï¼Œè¯·ç‰¹åˆ«å…³æ³¨callbackå‡½æ•°çš„æ‰§è¡Œçº¿ç¨‹çš„å·®åˆ«ã€‚è¯·éµå¾ªï¼š</p><p>â—† callbackå°½é‡è½»é‡</p><p>â—† callbacké¿å…é˜»å¡</p><p>â—† å¦åˆ™è¯·æŒ‡å®šæ‰§è¡Œçº¿ç¨‹</p><p>å¦‚æœcallbackæ‰§è¡Œäº†å¤§é‡çš„è®¡ç®—ï¼Œç”šè‡³æ‰§è¡Œäº†é˜»å¡å¼æ“ä½œï¼Œé‚£ä¹ˆå°±å¾ˆæœ‰å¯èƒ½é˜»å¡ä½Promiseçš„resolveçº¿ç¨‹ï¼Œé€šå¸¸è¿™ç±»çº¿ç¨‹éƒ½æ˜¯æå°‘çš„ï¼Œæ¯”å¦‚æ‰§è¡ŒIOçš„EventLoopçº¿ç¨‹ï¼Œæœ‰å¯èƒ½é€ æˆå…¶ä»–Promiseå¾—ä¸åˆ°æ‰§è¡Œã€‚</p><blockquote><p>æ‘˜è‡ªListenableFutureçš„æ–‡æ¡£ï¼š</p><p>Note: For fast, lightweight listeners that would be safe to execute in any thread, consider MoreExecutors.directExecutor. Otherwise, avoid it. Heavyweight directExecutor listeners can cause problems, and these problems can be difficult to reproduce because they depend on timing. For example:</p><p>â—† The listener may be executed by the caller of addListener. That caller may be a UI thread or other latency-sensitive thread. This can harm UI responsiveness.</p><p>â—† The listener may be executed by the thread that completes this Future. That thread may be an internal system thread such as an RPC network thread. Blocking that thread may stall progress of the whole system. It may even cause a deadlock.</p><p>â—† The listener may delay other listeners, even listeners that are not themselves directExecutor listeners.</p></blockquote><p>æˆ‘ä»¬ä¹Ÿçš„ç¡®ç¢°åˆ°è¿‡ä½¿ç”¨MoreExecutors.directExecutoræ—¶ï¼Œç”±äºç¼–å†™äº†å¤ªè¿‡å¤æ‚çš„callbacké“¾ï¼Œå¯¼è‡´çº¿ç¨‹æ­»é”çš„é—®é¢˜ã€‚</p><p>CompletableFutureå’ŒListenableFutureéƒ½æœ‰æŒ‡å®šcallbackæ‰§è¡Œçº¿ç¨‹çš„æ–¹æ³•ï¼š</p><pre>1.//ä½¿ç”¨å†…ç½®çš„é€šç”¨ForkJoinçº¿ç¨‹æ± 2.completableFuture.thenAcceptAsync(callback);3.//ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ‰§è¡Œå™¨4.completableFuture.thenAcceptAsync(callback, executor);5.//ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ‰§è¡Œå™¨6.Futures.transform(input, callback, executor);</pre><p>æ­£å› ä¸ºå¼‚æ­¥ç¼–ç¨‹çš„å¤æ‚æ€§ï¼Œå› æ­¤ç›®å‰æˆ‘ä»¬ä¹Ÿå°½é‡åœ¨ä¸šåŠ¡é€»è¾‘ç›¸å¯¹ç®€å•çš„åº”ç”¨ä¸Šè¿›è¡Œå¼‚æ­¥åŒ–æ”¹é€ ã€‚åç»­ï¼Œæˆ‘ä»¬ä¹Ÿä¼šè¯„ä¼°Quasarç­‰åç¨‹æ¡†æ¶ã€‚</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'å¼‚æ­¥','ç¼–ç¨‹','æœåŠ¡'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>