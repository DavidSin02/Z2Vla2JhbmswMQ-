<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>防火墙旁路部署参考配置 | 极客快訊</title><meta property="og:title" content="防火墙旁路部署参考配置 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/d5795d92dd0c440888c24bc670d6b289"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca09e72.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca09e72.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ca09e72.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca09e72.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca09e72.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ca09e72.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ca09e72.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca09e72.html><meta property="article:published_time" content="2020-10-29T21:08:24+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:24+08:00"><meta name=Keywords content><meta name=description content="防火墙旁路部署参考配置"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/ca09e72.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>防火墙旁路部署参考配置</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>防火墙旁路部署拓扑：</p><p><br></p><div class=pgc-img><img alt=防火墙旁路部署参考配置 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d5795d92dd0c440888c24bc670d6b289><p class=pgc-img-caption></p></div><p>拓扑描述：</p><p>防火墙使用万兆口xgbe21来做业务口，旁路部署到核心路由器，两端建立EBGP或者IBGP的邻居关系。防火墙通过宣告32位主机路由，把本地服务器的流量引入到防火墙中。防火墙对业务流清洗过后，继续使用xgbe21回注给核心路由器。为防止发生路由环路，需要配置回注策略，应用在核心路由器的XG0/0/1接口的入方向下，将回注流量转发至汇聚/网关路由器。</p><p>核心路由器与防火墙建立BGP的互联地址为172.16.10.0/30，防火墙地址为172.16.10.2，核心路由器地址为172.16.10.1.核心路由器和防火墙AS号根据实际业务需求可以不一致或者保持一致以下配置假定统一使用AS号为65530.</p><p>核心路由器配置：</p><p>1、配置与KFW-12000互联端口的地址，及BGP协议。</p><p>华为路由器配置参考：</p><p>提示符命令与描述</p><p>&lt;quidway>system//进入系统视图</p><p>[quidway]vlan 100</p><p>[quidway-vlan100]interface vlan 100</p><p>[quidway-Vlanif100]ip address 172.16.10.1 255.255.255.252</p><p>[quidway-Vlanif100]quit</p><p>[quidway]interface XG0/0/1 //进入接口视图</p><p>[quidway- XG0/0/1]port link-type access</p><p>[quidway- XG0/0/1]port default vlan 100</p><p>[quidway- XG0/0/1]quit</p><p>[quidway]bgp 65530</p><p>[quidway-bgp]peer 172.16.10.2 as-number 65530</p><p>[quidway-bgp]ipv4-family unicast</p><p>[quidway-bgp-af-ipv4]peer 172.16.10.2 enable</p><p></p><p>华三路由器BGP配置参考:</p><p>提示符命令与描述</p><p>&lt;H3C>syssystem//进入系统视图</p><p>[H3C]vlan 100</p><p>[H3C-vlan100]interface vlan 100</p><p>[H3C-Vlan-interface100]ip address 172.16.10.1 255.255.255.252</p><p>[H3C-Vlan-interface100]quit</p><p>[H3C]interface XG0/0/1 //进入接口视图</p><p>[H3C-XG0/0/1]port link-type access</p><p>[H3C-XG0/0/1]port default vlan 100</p><p>[H3C-XG0/0/1]quit</p><p>[H3C]</p><p>bgp 65530//进入bgp视图</p><p>[H3C-bgp]peer 172.16.10.2 as-number 65530</p><p>[H3C-bgp]address-familyipv4 unicast</p><p>[H3C-bgp-default-ipv4]peer 172.16.10.2 enable //激活BGP邻居</p><p></p><p>思科BGP配置指导:</p><p>提示符命令与描述</p><p>&lt;Cisco>en//进入系统视图</p><p>Cisco#conf t</p><p>Cisco(config)#vlan 100</p><p>Cisco(config-vlan)#interface vlan 100</p><p>Cisco(config-vlan)#ip address 172.16.10.1 255.255.255.252</p><p>Cisco(config-vlan)#exit</p><p>Cisco(config-if)#interface XG0/0/1 //进入接口视图</p><p>Cisco(config-if)#switchport mode access</p><p>Cisco(config-if)#switchportaccessvlan 100</p><p>Cisco(config-if)#exit</p><p>Cisco(config)#router bgp 65530 //进入BGP视图</p><p>Cisco(config-router)#neighbor 172.16.10.2 remote-as 65530</p><p></p><p>2、配置PBR策略：</p><p>防火墙在对流量进行过滤后，将流量回注给核心路由器。在采用源口回注时，需要在核心路由器连接防火墙接口的入方向应用PBR策略路由，匹配到防火墙回注的流量直接转发至汇聚/网关路由器。如果不添加PBR策略，回注的流量会再次被牵引到防火墙中，形成环路。</p><p><strong>需要注意的是，PBR的ACL中不建议使用permit any选项来匹配所有，可能会导致验证数据包无法到达客户端。</strong></p><p>华为路由器PBR配置参考：</p><p>提示符命令与描述</p><p>&lt;Huawei>system-view</p><p>[Huawei]acl number 3000</p><p>[Huawei-acl-adv-3000]rule permit ip destination 172.16.1.0 0.0.0.255</p><p>rule permit ipdestination 172.16.2.0 0.0.0.255</p><p>…...</p><p>//创建acl，匹配所有目地IP为本地服务器的流量，所有服务器地址段都需要配置，如有遗漏在对遗漏的地址进行清洗时会发生环路。</p><p>[Huawei-acl-adv-3000]quit</p><p>[Huawei]traffic classifier Huizhu //创建流分类</p><p>[Huawei-classifier-Huizhu]if-match acl 3000</p><p>[Huawei-classifier-Huizhu]quit</p><p>&lt;Huawei>traffic behavior Huizhu //创建流行为</p><p>[Huawei-behavior-Huizhu]redirect ip-nexthop x.x.x.x//设置下一跳</p><p>[Huawei-classifier-Huizhu]quit</p><p>&lt;Huawei>traffic policyHuizhu //创建策略</p><p>[Huawei-trafficpolicy-Huizhu]classifier Huizhu behavior Huizhu</p><p>[Huawei-classifier-Huizhu]quit</p><p>[Huawei]interface XGigabitEthernet 0/0/0 //在接口入方向下应用策略</p><p>[Huawei-GigabitEthernet0/0/0]traffic-policy Huizhu inbound</p><p></p><p>华三路由器PBR策略路由参考：</p><p>提示符命令与描述</p><p>&lt;H3C>system</p><p>[H3C]acl number 3000</p><p>[H3C-acl-ipv4-adv-3000]rule 5 permit ip destination 172.16.1.0 0.0.0.255</p><p>rule 10 permit ip destination 172.16.2.0 0.0.0.255</p><p>……</p><p>//创建acl，匹配所有目地IP为本地服务器的流量，所有服务器地</p><p>址段都需要配置，如有遗漏在对遗漏的地址进行清洗时会发生环路。</p><p>[H3C-acl-ipv4-adv-3000]quit</p><p>[H3C]policy-based-route Huizhu permit node 5 //创建策略路由Huizhu</p><p>[H3C-pbr-huizhu-5]if-match acl 3000</p><p>[H3C-pbr-huizhu-5]apply ip-address next-hop x.x.x.x //下一跳ip地址</p><p>[H3C]interface XGigabitEthernet 1/0/1 //在接口下应用PBR</p><p>[H3C-GigabitEthernet1/0/1]ip policy-based-route Huizhu</p><p></p><p>思科策略路由参考如下：</p><p>提示符命令与描述</p><p>Router>enable</p><p>Router#configure terminal</p><p>Router(config)#</p><p>access-list 100 permit ip 0.0.0.0 0.0.0.0 172.16.1.0 0.0.0.255</p><p>access-list 100 permit ip 0.0.0.0 0.0.0.0 172.16.2.0 0.0.0.255</p><p>……</p><p>//创建acl，匹配所有目地IP为本地服务器的流量，所有服务器地址段都需要配置，如有遗漏在对遗漏的地址进行清洗时会发生环路。</p><p>Router(config)#route-map Huizhu permit 10 //创建route-map</p><p>Router(config-route-map)#match ip address 100</p><p>Router(config-route-map)#set ip next-hop x.x.x.x//设置下一跳</p><p>Router(config)#interface XGigabitEthernet0/0/1 //在接口下调用策略路由</p><p>Router(config-if)#ip policy route-map Huizhu</p><p></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'参考','旁路','防火'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>