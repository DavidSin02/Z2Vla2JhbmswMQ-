<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>åŸºäº Kotlin å®ç°ä¸€ä¸ªç®€å•çš„ TCP è‡ªå®šä¹‰åè®® | æå®¢å¿«è¨Š</title><meta property="og:title" content="åŸºäº Kotlin å®ç°ä¸€ä¸ªç®€å•çš„ TCP è‡ªå®šä¹‰åè®® - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/dfic-imagehandler/f5dcf8ca-8735-4a93-a468-eced248ee3c9"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca58cdb.html><meta property="article:published_time" content="2020-10-29T20:50:28+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:28+08:00"><meta name=Keywords content><meta name=description content="åŸºäº Kotlin å®ç°ä¸€ä¸ªç®€å•çš„ TCP è‡ªå®šä¹‰åè®®"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/ca58cdb.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>åŸºäº Kotlin å®ç°ä¸€ä¸ªç®€å•çš„ TCP è‡ªå®šä¹‰åè®®</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>ä¸€. å¼€å‘èƒŒæ™¯</h1><blockquote><p>æƒ³è¦æˆä¸ºä¸€åä¼˜ç§€çš„Androidå¼€å‘ï¼Œä½ éœ€è¦ä¸€ä»½å®Œå¤‡çš„ çŸ¥è¯†ä½“ç³»ï¼Œåœ¨è¿™é‡Œï¼Œè®©æˆ‘ä»¬ä¸€èµ·æˆé•¿ä¸ºè‡ªå·±æ‰€æƒ³çš„é‚£æ ·~ã€‚</p></blockquote><div class=pgc-img><img alt="åŸºäº Kotlin å®ç°ä¸€ä¸ªç®€å•çš„ TCP è‡ªå®šä¹‰åè®®" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/dfic-imagehandler/f5dcf8ca-8735-4a93-a468-eced248ee3c9><p class=pgc-img-caption></p></div><p style=text-align:start>æˆ‘ä»¬çš„é¡¹ç›®éœ€è¦å¼€å‘ä¸€æ¬¾æ™ºèƒ½ç¡¬ä»¶ã€‚å®ƒç”± Web åå°å‘é€æŒ‡ä»¤åˆ°ä¸€æ¬¾æ¡Œé¢ç«¯åº”ç”¨ç¨‹åºï¼Œå†ç”±æ¡Œé¢ç¨‹åºæ¥æ§åˆ¶ä¸åŒçš„ç¡¬ä»¶è®¾å¤‡å®ç°ä¸šåŠ¡ä¸Šçš„æ“ä½œã€‚ä» Web åå°åˆ°æ¡Œé¢ç«¯æ˜¯é€šè¿‡ä¸€ä¸ª WebSocket é•¿é“¾æ¥æ¥è¿›è¡Œç»´æŠ¤ï¼Œè€Œæ¡Œé¢ç¨‹åºåˆ°å„ä¸ªç¡¬ä»¶è®¾å¤‡ä¹Ÿæ˜¯ä¸€ä¸ª TCP é•¿é“¾æ¥æ¥ç»´æŠ¤çš„ã€‚</p><p style=text-align:start>æœ¬æ–‡è®²è¿°çš„ï¼Œå…¶å®æ˜¯ä»æ¡Œé¢ç¨‹åºåˆ°å„ä¸ªç¡¬ä»¶ä¹‹é—´çš„é€šè®¯ã€‚</p><h1 class=pgc-h-arrow-right>äºŒ. è‡ªå®šä¹‰é€šè®¯åè®®</h1><p style=text-align:start>é¦–å…ˆï¼Œéœ€è¦è®¾è®¡ä¸€ä¸ªé€šç”¨çš„ TCP ç½‘ç»œåè®®ã€‚</p><p style=text-align:start>ç½‘ç»œåè®®ç»“æ„å¦‚ä¸‹</p><pre><code>     +--------------+---------------+------------+---------------+-----------+----------+     | é­”æ•°(4)       | version(1)    |åºåˆ—åŒ–æ–¹å¼(1) | command(1)    |æ•°æ®é•¿åº¦(4) |æ•°æ®(n)    |     +--------------+---------------+------------+---------------+-----------+----------+</code></pre><ul><li>é­”æ•°ï¼š4å­—èŠ‚ï¼Œæœ¬é¡¹ç›®ä¸­ä½¿ç”¨ 20200803(è¿™ä¸€å¤©ç¼–å†™çš„æ—¥å­)ï¼Œä¸ºäº†é˜²æ­¢è¯¥ç«¯å£è¢«æ„å¤–è°ƒç”¨ï¼Œæˆ‘ä»¬åœ¨æ”¶åˆ°æŠ¥æ–‡åå–å‰4ä¸ªå­—èŠ‚ä¸é­”æ•°æ¯”å¯¹ï¼Œå¦‚æœä¸ç›¸åŒåˆ™ç›´æ¥æ‹’ç»å¹¶å…³é—­è¿æ¥ã€‚</li><li>ç‰ˆæœ¬å·ï¼š1å­—èŠ‚ï¼Œä»…è¡¨ç¤ºåè®®çš„ç‰ˆæœ¬å·ï¼Œä¾¿äºåè®®å‡çº§æ—¶ä½¿ç”¨</li><li>åºåˆ—åŒ–æ–¹å¼ï¼š1å­—èŠ‚ï¼Œè¡¨ç¤ºå¦‚ä½•å°† Java å¯¹è±¡è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œä»¥åŠå¦‚ä½•ååºåˆ—åŒ–ã€‚</li><li>æŒ‡ä»¤ï¼š1å­—èŠ‚ï¼Œè¡¨ç¤ºè¯¥æ¶ˆæ¯çš„æ„å›¾ï¼ˆå¦‚æ‹ç…§ã€æ‹è§†é¢‘ã€å¿ƒè·³ã€App å‡çº§ç­‰ï¼‰ã€‚æœ€å¤šæ”¯æŒ 2^8 ç§æŒ‡ä»¤ã€‚</li><li>æ•°æ®é•¿åº¦ï¼š4å­—èŠ‚ï¼Œè¡¨ç¤ºè¯¥å­—æ®µåæ•°æ®éƒ¨åˆ†çš„é•¿åº¦ã€‚æœ€å¤šæ”¯æŒ 2^32 ä½ã€‚</li><li>æ•°æ®ï¼šå…·ä½“æ•°æ®çš„å†…å®¹ã€‚</li></ul><p style=text-align:start>æ ¹æ®ä¸Šè¿°æ‰€è®¾è®¡çš„ç½‘ç»œåè®®ï¼Œå®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±» Packetï¼š</p><pre><code>abstract class Packet {    var magic:Int? = MAGIC_NUMBER     // é­”æ•°    var version:Byte = 1              // ç‰ˆæœ¬å·ï¼Œå½“å‰åè®®çš„ç‰ˆæœ¬å·ä¸º 1    abstract val serializeMethod:Byte // åºåˆ—åŒ–æ–¹å¼    abstract val command:Byte         // Watcher è·Ÿ App ç›¸äº’é€šè®¯çš„æŒ‡ä»¤}</code></pre><p style=text-align:start>æœ‰å¤šå°‘ä¸ªæŒ‡ä»¤å°±éœ€è¦å®šä¹‰å¤šå°‘ä¸ª Packetï¼Œä¸‹é¢ä»¥å¿ƒè·³çš„ Packet ä¸ºä¾‹ï¼Œå®šä¹‰ä¸€ä¸ª HeartBeatPacketï¼š</p><pre><code>data class HeartBeatPacket(var msg:String = "ping",                           override val serializeMethod: Byte = Serialize.JSON,                           override val command: Byte = Commands.HEART_BEAT) : Packet() {}</code></pre><p style=text-align:start>HeartBeatPacket æ˜¯ç”± TCP å®¢æˆ·ç«¯å‘èµ·ï¼Œç”± TCP æœåŠ¡ç«¯æ¥æ”¶å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p style=text-align:start>æ¯ä¸ª Packet ç±»éƒ½åŒ…å«äº†è¯¥ Packet æ‰€ä½¿ç”¨çš„åºåˆ—åŒ–æ–¹å¼ã€‚</p><pre><code>/** * åºåˆ—åŒ–æ–¹å¼çš„å¸¸é‡åˆ—è¡¨ */interface Serialize {    companion object {        const val JSON: Byte = 0    }}</code></pre><p style=text-align:start>æ¯ä¸ª Packet ä¹ŸåŒ…å«äº†å…¶å¯¹åº”çš„ commandã€‚ä¸‹é¢æ˜¯ Commands æ˜¯æŒ‡ä»¤é›†ï¼Œæ”¯æŒ256ä¸ªæŒ‡ä»¤ã€‚</p><pre><code>/** * æŒ‡ä»¤é›†ï¼Œæ”¯æŒä» -128 åˆ° 127 æ€»å…± 256 ä¸ªæŒ‡ä»¤ */interface Commands {    companion object {        /**         * å¿ƒè·³åŒ…         */        const val HEART_BEAT: Byte = 0        /**         * ç™»å½•ï¼ˆApp éœ€è¦å‘Šè¯‰ Watcher ï¼šcameraPosition çš„ä½ç½®ï¼‰         */        const val LOGIN: Byte = 1        ......   }}</code></pre><p style=text-align:start>ç”±äºä½¿ç”¨è‡ªå®šä¹‰çš„åè®®ï¼Œå¿…é¡»è¦æœ‰å¯¹æŠ¥æ–‡çš„ encodeã€decodeï¼ŒPacketManager è´Ÿè´£è¿™äº›äº‹æƒ…ã€‚<br>encode æ—¶æŒ‰ç…§åè®®çš„ç»“æ„è¿›è¡Œç»„è£…æŠ¥æ–‡ï¼ŒåŒç† decode æ˜¯å…¶é€†å‘çš„è¿‡ç¨‹ã€‚</p><pre><code>/** * æŠ¥æ–‡çš„ç®¡ç†ç±»ï¼Œå¯¹æŠ¥æ–‡è¿›è¡Œ encodeã€decode */object PacketManager {    fun encode(packet: Packet):ByteBuf = encode(ByteBufAllocator.DEFAULT, packet)    fun encode(alloc:ByteBufAllocator, packet: Packet) = encode(alloc.ioBuffer(), packet)    fun encode(buf: ByteBuf, packet: Packet): ByteBuf {        val serializer = SerializerFactory.getSerializer(packet.serializeMethod)        val bytes: ByteArray = serializer.serialize(packet)        //ç»„è£…æŠ¥æ–‡:é­”æ•°ï¼ˆ4å­—èŠ‚ï¼‰+ ç‰ˆæœ¬å·ï¼ˆ1å­—èŠ‚ï¼‰+ åºåˆ—åŒ–æ–¹å¼ï¼ˆ1å­—èŠ‚ï¼‰+ æŒ‡ä»¤ï¼ˆ1å­—èŠ‚ï¼‰+ æ•°æ®é•¿åº¦ï¼ˆ4å­—èŠ‚ï¼‰+ æ•°æ®ï¼ˆNå­—èŠ‚ï¼‰        buf.writeInt(MAGIC_NUMBER)        buf.writeByte(packet.version.toInt())        buf.writeByte(packet.serializeMethod.toInt())        buf.writeByte(packet.command.toInt())        buf.writeInt(bytes.size)        buf.writeBytes(bytes)        return buf    }    fun decode(buf:ByteBuf): Packet {        buf.skipBytes(4) // é­”æ•°ç”±å•ç‹¬çš„ Handler è¿›è¡Œæ ¡éªŒ        buf.skipBytes(1)        val serializationMethod = buf.readByte()        val serializer = SerializerFactory.getSerializer(serializationMethod)        val command = buf.readByte()        val clazz = PacketFactory.getPacket(command)        val length = buf.readInt()  // æ•°æ®çš„é•¿åº¦        val bytes = ByteArray(length)   // å®šä¹‰éœ€è¦è¯»å–çš„å­—ç¬¦æ•°ç»„        buf.readBytes(bytes)        return serializer.deserialize(clazz, bytes)    }}</code></pre><h1 class=pgc-h-arrow-right>ä¸‰. TCP æœåŠ¡ç«¯</h1><p style=text-align:start>å¯åŠ¨ TCP æœåŠ¡çš„æ–¹æ³•</p><pre><code>    fun execute() {        boss = NioEventLoopGroup()        worker = NioEventLoopGroup()        val bootstrap = ServerBootstrap()        bootstrap.group(boss, worker).channel(NioServerSocketChannel::class.java)                .option(ChannelOption.SO_BACKLOG, 100)                .childOption(ChannelOption.SO_KEEPALIVE, true)                .childOption(ChannelOption.SO_REUSEADDR, true)                .childOption(ChannelOption.TCP_NODELAY, true)                .childHandler(object : ChannelInitializer&lt;NioSocketChannel&gt;() {                    @Throws(Exception::class)                    override fun initChannel(nioSocketChannel: NioSocketChannel) {                        val pipeline = nioSocketChannel.pipeline()                        pipeline.addLast(ServerIdleHandler())                        pipeline.addLast(MagicNumValidator())                        pipeline.addLast(PacketCodecHandler)                        pipeline.addLast(HeartBeatHandler)                        pipeline.addLast(ResponseHandler)                    }                })        val future: ChannelFuture = bootstrap.bind(TCP_PORT)        future.addListener(object : ChannelFutureListener {            @Throws(Exception::class)            override fun operationComplete(channelFuture: ChannelFuture) {                if (channelFuture.isSuccess) {                    logInfo(logger, "TCP Server is starting...")                } else {                    logError(logger,channelFuture.cause(),"TCP Server failed")                }            }        })    }</code></pre><p style=text-align:start>å…¶ä¸­ï¼ŒServerIdleHandlerï¼š è¡¨ç¤º 5 åˆ†é’Ÿå†…æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œåˆ™æ–­å¼€è¿æ¥ã€‚</p><pre><code>class ServerIdleHandler : IdleStateHandler(0, 0, HERT_BEAT_TIME) {    private val logger: Logger = LoggerFactory.getLogger(ServerIdleHandler::class.java)    @Throws(Exception::class)    override fun channelIdle(ctx: ChannelHandlerContext, evt: IdleStateEvent) {        logInfo(logger) {            ctx.channel().close()            "$HERT_BEAT_TIME ç§’å†…æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œåˆ™æ–­å¼€è¿æ¥"        }    }    companion object {        private const val HERT_BEAT_TIME = 300    }}</code></pre><p style=text-align:start>MagicNumValidatorï¼šç”¨äº TCP æŠ¥æ–‡çš„é­”æ•°æ ¡éªŒã€‚</p><pre><code>class MagicNumValidator : LengthFieldBasedFrameDecoder(Int.MAX_VALUE, LENGTH_FIELD_OFFSET, LENGTH_FIELD_LENGTH) {    private val logger: Logger = LoggerFactory.getLogger(this.javaClass)    @Throws(Exception::class)    override fun decode(ctx: ChannelHandlerContext, `in`: ByteBuf): Any? {        if (`in`.getInt(`in`.readerIndex()) !== MAGIC_NUMBER) { // é­”æ•°æ ¡éªŒä¸é€šè¿‡ï¼Œåˆ™å…³é—­è¿æ¥            logInfo(logger,"é­”æ•°æ ¡éªŒå¤±è´¥")            ctx.channel().close()            return null        }        return super.decode(ctx, `in`)    }    companion object {        private const val LENGTH_FIELD_OFFSET = 7        private const val LENGTH_FIELD_LENGTH = 4    }}</code></pre><p style=text-align:start>PacketCodecHandler: è§£ææŠ¥æ–‡çš„ Handlerã€‚</p><p style=text-align:start>PacketCodecHandler ç»§æ‰¿è‡ª ByteToMessageCodec ï¼Œå®ƒæ˜¯ç”¨æ¥å¤„ç† byte-to-message å’Œmessage-to-byteï¼Œä¾¿äºè§£ç å­—èŠ‚æ¶ˆæ¯æˆ POJO æˆ–ç¼–ç  POJO æ¶ˆæ¯æˆå­—èŠ‚ã€‚</p><pre><code>@ChannelHandler.Sharableobject PacketCodecHandler : MessageToMessageCodec&lt;ByteBuf, Packet&gt;() {    override fun encode(ctx: ChannelHandlerContext, msg: Packet, list: MutableList&lt;Any&gt;) {        val byteBuf = ctx.channel().alloc().ioBuffer()        PacketManager.encode(byteBuf, msg)        list.add(byteBuf)    }    override fun decode(ctx: ChannelHandlerContext, msg: ByteBuf, list: MutableList&lt;Any&gt;) {        list.add(PacketManager.decode(msg));    }}</code></pre><p style=text-align:start>HeartBeatHandlerï¼šå¿ƒè·³çš„ Handlerï¼Œæ¥æ”¶ TCP å®¢æˆ·ç«¯å‘æ¥çš„"ping"ï¼Œç„¶åç»™å®¢æˆ·ç«¯è¿”å›"pong"ã€‚</p><pre><code>@ChannelHandler.Sharableobject HeartBeatHandler : SimpleChannelInboundHandler&lt;HeartBeatPacket&gt;(){    private val logger: Logger = LoggerFactory.getLogger(this.javaClass)    override fun channelRead0(ctx: ChannelHandlerContext, msg: HeartBeatPacket) {        logInfo(logger,"æ”¶åˆ°å¿ƒè·³åŒ…ï¼š${GsonUtils.toJson(msg)}")        msg.msg = "pong" // è¿”å› pong ç»™åˆ°å®¢æˆ·ç«¯        ctx.writeAndFlush(msg)    }}</code></pre><p style=text-align:start>ResponseHandlerï¼šé€šç”¨çš„å¤„ç†æ¥æ”¶ TCP å®¢æˆ·ç«¯å‘æ¥æŒ‡ä»¤çš„ Handlerï¼Œå¯ä»¥æ ¹æ®å¯¹åº”çš„æŒ‡ä»¤å»æŸ¥è¯¢å¯¹åº”çš„ Handler å¹¶å¤„ç†å…¶å‘½ä»¤ã€‚</p><pre><code>object ResponseHandler: SimpleChannelInboundHandler&lt;Packet&gt;() {    private val logger: Logger = LoggerFactory.getLogger(this.javaClass)    private val handlerMap: ConcurrentHashMap&lt;Byte, SimpleChannelInboundHandler&lt;out Packet&gt;&gt; = ConcurrentHashMap()    init {        handlerMap[LOGIN] = LoginHandler        ......        handlerMap[ERROR] = ErrorHandler    }    override fun channelRead0(ctx: ChannelHandlerContext, msg: Packet) {        logInfo(logger,"æ”¶åˆ°å®¢æˆ·ç«¯çš„æŒ‡ä»¤: ${msg.command}")        val handler: SimpleChannelInboundHandler&lt;out Packet&gt;? = handlerMap[msg.command]        handler?.let {            logInfo(logger,"æ‰¾åˆ°å“åº”æŒ‡ä»¤çš„ Handler: ${it.javaClass.simpleName}")            it.channelRead(ctx, msg)        } ?: logInfo(logger,"æœªæ‰¾åˆ°å“åº”æŒ‡ä»¤çš„ Handler")    }    @Throws(Exception::class)    override fun channelInactive(ctx: ChannelHandlerContext) {        val insocket = ctx.channel().remoteAddress() as InetSocketAddress        val clientIP = insocket.address.hostAddress        val clientPort = insocket.port        logError(logger,"å®¢æˆ·ç«¯æ‰çº¿: $clientIP : $clientPort")        super.channelInactive(ctx)    }}</code></pre><h1 class=pgc-h-arrow-right>å››. TCP å®¢æˆ·ç«¯</h1><p style=text-align:start>æ¨¡æ‹Ÿä¸€ä¸ªå®¢æˆ·ç«¯çš„å®ç°</p><pre><code>val topLevelClass = object : Any() {}.javaClass.enclosingClassval logger: Logger = LoggerFactory.getLogger(topLevelClass)fun main() {    val worker = NioEventLoopGroup()    val bootstrap = Bootstrap()    bootstrap.group(worker).channel(NioSocketChannel::class.java)            .handler(object : ChannelInitializer&lt;SocketChannel&gt;() {                @Throws(Exception::class)                override fun initChannel(channel: SocketChannel) {                    channel.pipeline().addLast(PacketCodecHandler)                    channel.pipeline().addLast(ClientIdleHandler())                    channel.pipeline().addLast(ClientLogin())                }            })    val future: ChannelFuture = bootstrap.connect("127.0.0.1", TCP_PORT).addListener(object : ChannelFutureListener {        @Throws(Exception::class)        override fun operationComplete(channelFuture: ChannelFuture) {            if (channelFuture.isSuccess()) {                logInfo(logger,"connect to server success!")            } else {                logger.info("failed to connect the server! ")                System.exit(0)            }        }    })    try {        future.channel().closeFuture().sync()        logInfo(logger,"ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥ï¼")    } catch (e: InterruptedException) {        e.printStackTrace()    }}</code></pre><p style=text-align:start>å…¶ä¸­ï¼ŒPacketCodecHandler è·ŸæœåŠ¡ç«¯ä½¿ç”¨çš„è§£ææŠ¥æ–‡çš„ Handler æ˜¯ä¸€æ ·çš„ã€‚</p><p style=text-align:start>ClientIdleHandlerï¼šå®¢æˆ·ç«¯å®ç°å¿ƒè·³ï¼Œæ¯éš” 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ã€‚</p><pre><code>class ClientIdleHandler : IdleStateHandler(0, 0, HEART_BEAT_TIME) {    private val logger = LoggerFactory.getLogger(ClientIdleHandler::class.java)    @Throws(Exception::class)    override fun channelIdle(ctx: ChannelHandlerContext, evt: IdleStateEvent?) {        logInfo(logger,"å‘é€å¿ƒè·³....")        ctx.writeAndFlush(HeartBeatPacket())    }    companion object {        private const val HEART_BEAT_TIME = 30    }}</code></pre><p style=text-align:start>ClientLoginï¼šç™»å½•æœåŠ¡ç«¯çš„ Handlerã€‚</p><pre><code>@ChannelHandler.Sharableclass ClientLogin: ChannelInboundHandlerAdapter() {    private val logger: Logger = LoggerFactory.getLogger(this.javaClass)    @Throws(Exception::class)    override fun channelActive(ctx: ChannelHandlerContext) {        val packet: LoginPacket = LoginPacket()        logInfo(logger,"packet = ${GsonUtils.toJson(packet)}")        val byteBuf = PacketManager.encode(packet)        ctx.channel().writeAndFlush(byteBuf)    }}</code></pre><h1 class=pgc-h-arrow-right>äº”. æ€»ç»“</h1><p style=text-align:start>è¿™æ¬¡ï¼Œæˆ‘å¼€å‘çš„æ¡Œé¢ç«¯ç¨‹åºå…¶å®é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œåªéœ€æ¥æ”¶ Web åå°çš„æŒ‡ä»¤ï¼Œç„¶åè·Ÿå„ä¸ªè®¾å¤‡è¿›è¡Œäº¤äº’ã€‚</p><p style=text-align:start>æ¥æ”¶åˆ° Web ç«¯çš„æŒ‡ä»¤åï¼Œé€šè¿‡ Guava çš„ EventBus å°†æŒ‡ä»¤é€šè¿‡ TCP å‘é€ç»™å„ä¸ªè®¾å¤‡ï¼Œå‘é€æ—¶éœ€è¦è½¬åŒ–æˆå¯¹åº”çš„ Packetã€‚å› æ­¤ï¼Œæ ¸å¿ƒçš„æ¨¡å—å°±æ˜¯è¿™ä¸ª TCP è‡ªå®šä¹‰çš„åè®®ã€‚</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Kotlin','å®ç°','ä¸€ä¸ª'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>