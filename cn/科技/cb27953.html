<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Spring Cloud异步场景分布式事务怎样做？试试RocketMQ | 极客快訊</title><meta property="og:title" content="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/dfic-imagehandler/74bd8c97-1853-4c6f-9b9d-58e9dfda86b9"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb27953.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb27953.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cb27953.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb27953.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb27953.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cb27953.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cb27953.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb27953.html><meta property="article:published_time" content="2020-10-29T20:50:42+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:42+08:00"><meta name=Keywords content><meta name=description content="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/cb27953.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Spring Cloud异步场景分布式事务怎样做？试试RocketMQ</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>一、背景</strong></p><p>在微服务架构中，我们常常使用异步化的手段来提升系统的 <strong>吞吐量</strong> 和 <strong>解耦</strong> 上下游，而构建异步架构最常用的手段就是使用 消息队列(MQ) ，那异步架构怎样才能实现数据一致性呢？本文主要介绍如何使用 RocketMQ 的 事务消息 来解决一致性问题。</p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/74bd8c97-1853-4c6f-9b9d-58e9dfda86b9><p class=pgc-img-caption></p></div><p>RocketMQ是阿里巴巴开源的分布式消息中间件，目前已成为 <strong>Apache</strong> 的顶级项目。历经多次天猫双十一海量消息考验，具有高性能、低延时和高可靠等特性</p><p><strong>二、MQ选型</strong></p><p>可以看到在 <strong>业务处理</strong> 方面来说 RocketMQ 优于其他对手，而且原生支持 <strong>事务消息</strong></p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ad291a0d5be148ba935bf83a564d23a9><p class=pgc-img-caption></p></div><p>PS：业务系统用的是其他 MQ 产品但是又需要 <strong>事务消息</strong> 怎么办？学习原理自己开发实现！</p><p><strong>三、什么是事务消息</strong></p><p>例如下图的场景：生成订单记录 -> MQ -> 增加积分</p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f60ac1d9da0d45b1900ec11cef43edcf><p class=pgc-img-caption></p></div><p>我们是应该先 <strong>创建订单记录</strong> ，还是先 <strong>发送MQ消息</strong> 呢？</p><ol><li>先发送MQ消息：这个明显是不行的，因为如果消息发送成功，而订单创建失败的话是没办法把消息收回来的</li><li>先创建订单记录：如果订单创建成功后MQ消息发送失败 <strong>抛出异常</strong> ，因为两个操作都在本地事务中所以订单数据是可以 <strong>回滚</strong> 的</li></ol><p>上面的 <strong>方式二</strong> 看似没问题，但是 <strong>网络是不可靠的</strong> ！如果 MQ 的响应因为网络原因没有收到，所以在面对不确定的结果只好进行回滚；但是 MQ 端又确实是收到了这条消息的，只是回给客户端的 <strong>响应丢失</strong> 了！</p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/fb661302-e568-4930-8a7f-0d6204c39d28><p class=pgc-img-caption></p></div><p>所以 事务消息 就是用来保证 <strong>本地事务</strong> 与 <strong>MQ消息发送</strong> 的原子性！</p><p><strong>四、RocketMQ事务消息原理</strong></p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/05e0706bea0c440ba3b67b2ff958e5be><p class=pgc-img-caption></p></div><p>主要的逻辑分为两个流程：</p><ul><li><strong>事务消息发送及提交</strong> ：</li></ul><ol><li class=ql-indent-1>发送 half消息</li><li class=ql-indent-1>MQ服务端 响应消息写入结果</li><li class=ql-indent-1>根据发送结果执行 本地事务 （如果写入失败，此时half消息对业务 <strong>不可见</strong> ，本地逻辑不执行）</li><li class=ql-indent-1>根据本地事务状态执行 Commit 或者 Rollback （Commit操作生成消息索引，消息对消费者 <strong>可见</strong> ）</li></ol><ul><li><strong>回查流程</strong> ：</li></ul><ol><li class=ql-indent-1>对于长时间没有 Commit/Rollback 的事务消息（ pending 状态的消息），从服务端发起一次 <strong>回查</strong></li><li class=ql-indent-1>Producer 收到回查消息，检查回查消息对应的 本地事务状态</li><li class=ql-indent-1>根据本地事务状态，重新 Commit 或者 Rollback</li></ol><p>逻辑时序图</p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4194f1c2cae84db89f4cbfbb787d39da><p class=pgc-img-caption></p></div><p><strong>五、异步架构一致性实现思路</strong></p><p>从上面的原理可以发现 事务消息 仅仅只是保证本地事务和MQ消息发送形成整体的 原子性 ，而投递到MQ服务器后，并无法保证消费者一定能消费成功！</p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/dfic-imagehandler/fa1a1d84-f05f-4b93-a993-085a8c0c89a1><p class=pgc-img-caption></p></div><p>如果 <strong>消费端消费失败</strong> 后的处理方式，建议是记录异常信息然后 <strong>人工处理</strong> ，并不建议回滚上游服务的数据(因为两者是 <strong>解耦</strong> 的，而且 <strong>复杂度</strong> 太高)</p><p>我们可以利用 MQ 的两个特性 重试 和 死信队列 来协助消费端处理：</p><pre>重试死信队列死信队列</pre><p>因为有 重试 所以消费者需要实现 幂等性</p><p><strong>六、分布式事务场景样例</strong></p><p>下面就用刚刚提到的场景： <strong>生成订单记录 -> MQ -> 增加积分</strong> ；来简单讲一下 Spring Cloud中应该怎么做，详细代码请 <strong><em>下载demo</em> </strong>查看。</p><p><strong>6.1. 引入依赖</strong></p><p>使用 spring-cloud-stream 框架来访问 RocketMQ</p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/600d875fe8bf4cdfb0fa27d641967245><p class=pgc-img-caption></p></div><p>Spring Cloud Stream 是一个构建消息驱动的框架，通过抽象的定义实现应用与MQ消息队列之间的解耦，目前支持 RabbitMQ 、 kafka 和 RocketMQ</p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e50922a9339b4d21a5657c82e2171f25><p class=pgc-img-caption></p></div><p><strong>6.2. 开启事务消息</strong></p><p>消息生产者需要添加 transactional: true 开启 <strong>事务消息</strong></p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5a3f2aafb855416e8da699b1e62db2ca><p class=pgc-img-caption></p></div><p><strong>6.3. 订单服务发送half消息</strong></p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e526fe2ee7a04f37abb301060ff16100><p class=pgc-img-caption></p></div><p>因为开启了 事务消息 所以这里发送的是 half消息 对于消费端是 不可见 的</p><p><strong>6.4. 订单服务监听half消息</strong></p><p>使用 @RocketMQTransactionListener 注解监听 <strong>半消息</strong> ，并实现 RocketMQLocalTransactionListener 接口，该接口有两个方法</p><ul><li><strong>executeLocalTransaction</strong> ：用于提交本地事务</li><li><strong>checkLocalTransaction</strong> ：用于事务回查</li></ul><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2b2c7b24743644f6a994e1f18d64f2aa><p class=pgc-img-caption></p></div><p>如果提交事务消息失败，需等待约1分钟左右 <strong>事务回查</strong> 方法才会被调用</p><p><strong>6.5. 积分服务消费消息</strong></p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5e384353e4ac4e81818fa708288d962d><p class=pgc-img-caption></p></div><p>注意：因为有 重试 ，这里如果是真实的业务需要自行实现 幂等性</p><p><strong>6.6. 消费死信队列预警</strong></p><div class=pgc-img><img alt="Spring Cloud异步场景分布式事务怎样做？试试RocketMQ" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fcecdcf72c3d44e0afe016c9de67fddc><p class=pgc-img-caption></p></div><p>监听并消费死信队列中的消息，用于记录错误日志，并且预警通知运维人员等</p><p><strong>6.7. 测试用例</strong></p><p>demo中提供了3个接口分别测试不同的场景：</p><ul><li><strong>事务成功</strong></li><li>http://localhost:11002/success</li><li>流程如下：</li></ul><ol><li class=ql-indent-1>订单创建 <strong>成功</strong></li><li class=ql-indent-1>提交事务消息 <strong>成功</strong></li><li class=ql-indent-1>消费消息增加积分 <strong>成功</strong></li></ol><ul><li><strong>订单创建成功但提交事务消息失败</strong></li><li>http://localhost:11002/produceError</li><li>流程如下：</li></ul><ol><li class=ql-indent-1>订单创建 <strong>成功</strong></li><li class=ql-indent-1>提交事务消息 <strong>失败</strong></li><li class=ql-indent-1>事务回查(等待1分钟左右) <strong>成功</strong></li><li class=ql-indent-1>提交事务消息 <strong>成功</strong></li><li class=ql-indent-1>消费消息增加积分 <strong>成功</strong></li></ol><ul><li><strong>消费消息失败</strong></li><li>http://localhost:11002/consumeError</li><li>流程如下：</li></ul><ol><li class=ql-indent-1>订单创建 <strong>成功</strong></li><li class=ql-indent-1>提交事务消息 <strong>成功</strong></li><li class=ql-indent-1>消费消息增加积分 <strong>失败</strong></li><li class=ql-indent-1>重试消费消息 <strong>失败</strong></li><li class=ql-indent-1>进入死信队列 <strong>成功</strong></li><li class=ql-indent-1>消费死信队列的消息 <strong>成功</strong></li><li class=ql-indent-1>记录日志并发出预警 <strong>成功</strong></li></ol><p><strong>end：如果你觉得本文对你有帮助的话，记得关注点赞转发，你的支持就是我更新动力。</strong></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Spring','Cloud','异步场'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>