<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>NTP时钟同步原理及误差简析 | 极客快訊</title><meta property="og:title" content="NTP时钟同步原理及误差简析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/47120001f0e1cbb22a29"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb7fec6.html><meta property="article:published_time" content="2020-10-29T20:58:13+08:00"><meta property="article:modified_time" content="2020-10-29T20:58:13+08:00"><meta name=Keywords content><meta name=description content="NTP时钟同步原理及误差简析"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/cb7fec6.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>NTP时钟同步原理及误差简析</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>在我们某试验系统方案设计中，由于数据同步性的要求，需要将我们WP4000变频功率分析仪的时钟与客户的NI系统的时钟进行同步，对于WP4000变频功率测试系统而言，多台分析仪之间可通过同步光纤接口达到严格同步，同步时序达us级。但要求WP4000变频功率测试系统与其它系统之间保持同步，在同步性要求不是特别高的情况下，可以采用NTP时钟同步的方式进行多系统间的同步，以下就NTP时钟同步系统误差进行简析。</p><h1>一、NTP协议简介</h1><p>网络时间协议NTP(Network Time Protocol)的主要开发者是美国特拉华大学的MILLS David L教授设计实现的，由时间协议、ICMP时间戳消息及IP时间戳选项发展而来。NTP用于将计算机客户或服务器的时间与另一服务器同步，使用层次式时间分布模型。在配置时，NTP可以利用冗余服务器和多条网络路径来获得时间的高准确性和高可靠性。即使客户机在长时间无法与某一时间服务器相联系的情况下,仍可提供高准确度时间。</p><p>实际应用中，还有确保秒级精度的简单的网络时间协议SNTP(Simple Network Time Protocol)。SNTP是NTP的一个子集,主要用于那些不需要NTP的精度以较高实现复杂性的网络时间同步客户机。SNTP协议已减少了网络延时对校对准确的影响，但没有冗余服务器和校正时钟频率误差功能。</p><p>一般的计算机和嵌入式设备在时钟度方面没有明确的指标要求, 时钟精度只有10-4～10-5，每天可能误差达十几秒或更多，如果不及时校正，其累积时间误差不可忽视。许多工业控制过程需要高准确度时间，如：电力系统内众多的计算机监控系统、保护装置、故障录波器等时间同步要在ms级以内。</p><p>联网计算机同步时钟最简便的方法是网络授时。网络授时分为广域网授时和局域网授时。广域网授时精度通常能达50ms级，但有时超过500ms，这是因为每次经过的路由器路径可能不相同。现在还没有更好的办法将这种不同路径延迟的时间误差完全消除。局域网授时不存在路由器路径延迟问题，因而授时精度理论上可以提到亚毫秒级。Windows内置NTP服务，在局域网内其最高授时精度也只能达10ms级。因此，提高局域网NTP授时精度成为一个迫切需要解决的问题。</p><h1>二、NTP授时原理</h1><p>NTP最典型的授时方式是Client/Server方式。如下图1所示，客户机首先向服务器发送一个NTP 包，其中包含了该包离开客户机的时间戳T1，当服务器接收到该包时，依次填入包到达的时间戳T2、包离开的时间戳T3，然后立即把包返回给客户机。客户机在接收到响应包时，记录包返回的时间戳T4。客户机用上述4个时间参数就能够计算出2个关键参数：NTP包的往返延迟d和客户机与服务器之间的时钟偏差t。客户机使用时钟偏差来调整本地时钟，以使其时间与服务器时间一致。</p><p><img alt=NTP时钟同步原理及误差简析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/47120001f0e1cbb22a29></p><p>图1 Client/Server方式下NTP授时原理</p><p>图1中：T1为客户发送NTP请求时间戳(以客户时间为参照)；T2为服务器收到NTP请求时间戳(以服务器时间为参照)；T3为服务器回复NTP请求时间戳(以服务器时间为参照)；T4为客户收到NTP回复包时间戳(以客户时间为参照)；d1为NTP请求包传送延时，d2为NTP回复包传送延时；t为服务器和客户端之间的时间偏差，d为NTP包的往返时间。</p><p>现已经T1、T2、T3、T4，希望求得t以调整客户方时钟：</p><p><img alt=NTP时钟同步原理及误差简析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/470800024e03b1401767></p><p>....................................................式(1)</p><p>假设NPT请求和回复包传送延时相等，即d1=d2，则可解得“</p><p><img alt=NTP时钟同步原理及误差简析 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/470800024e05d4db8c07></p><p>.....................................式(2)</p><p>根据式(1)，t也可表示为：t=(T2-T1)+d1=(T2-T1)+d/2.....................式(3)</p><p>可以看出，t、d只与T2、T1差值及T3、T4差值相关，而与T2、T3差值无关，即最终的结果与服务器处理请求所需的时间无关。因此，客户端即可通过T1、T2、T3、T4计算出时差t去调整本地时钟。</p><h1>三、NTP授时精度分析</h1><p>NTP授时精度与NTP服务器与用户间的网络状况有关，主要取决于NTP包往返路由的延时对称程度，往返路由的延时不对称值最大不超过网络延时。式(2)是在假设NTP请求和回复包在网上传送延时相等，即d1=d2=d/2的情况下得出的，而d1、d2的取值范围在(0...d)间，由式(3)可以得出最大授时误差是±d/2。一般广域网的网络延时在10 ms～500ms之间;局域网的网络延时在计时操作系统内核处理延迟的情况下通常小于1ms。</p><p>假定局域网内NTP延时小于1ms，理论上授时误差小于0.5ms，但对于Windows操作系统内置的NTP客户和NTP服务，并不能达到此精度。Windows NTP时钟分辨率因操作系统和硬件不同而有所不同，时钟分辨率通常为10ms或15ms。基于Windows操作系统内置的NTP授时精度最高不超过10ms。</p><h1>四、基于NTP减少计算机时钟偏差</h1><p><strong>01、计算机时钟偏差分析</strong></p><p>通用PC机自带两类时钟源：硬件时钟和软件时钟(或称为系统时钟)。不论是硬件时钟还是软件时钟，都是由石英晶体振荡器驱动的，通过累计石英晶体振荡器输出脉冲数，换算出时间。所以计算机时钟的准确度取决于晶振频率准确度。受温度变化、电压、芯片老化等因素影响，晶振频率会发生小幅度波动，其中温度对晶振频影响最大。</p><p>由于工艺和材料的原因，同一生产线上标称频率相同的石英晶体，其实际频率是不同的，实际频率与标称频率偏差率从10-4量级到10-9量级不等。以10-4量级为例，时钟每天至少误差8.64 s。</p><p><strong>02、基于NTP减少计算机时钟频率偏差</strong></p><p>时钟频率偏差是时钟长期计时累积误差的主要原因，要提高时钟长期计时精度，必须补偿时钟频率偏差。联网的计算机可采用NTP方式,可非常方便地校准时钟频率偏差。以NTP服务器时钟为标准时间，在某一时刻设置NTP客户机时间为NTP服务器当前时间T0，经过一段时间后，NTP服务器时间为T0+tsn，NTP客户端时间为T0+tcn。因为存在时钟频率偏差，tsn与tcn并不相等。NTP客户端时间tcn需乘以时钟频率偏差系数k才等于tsn，即tsn=k×tcn，所以k=tsn/tcn。</p><p>任何晶振实际工作频率都是不稳定的，只是程度不同而已。即使温度补偿的晶振，在常温范围内(摄氏10℃～35℃)也有大约5×10-7～2×10-6的误差。晶振实际频率是受外界多种因素(温度、电压、老化等)影响而改变的。因此，时钟频率偏差系数k并非恒定不变的。每隔一定时间，NTP客户机要对时钟频率偏差系数k进行校正，才能保证计时精度。</p><h1>五、进一步提高NTP授时精度的方法</h1><p>局域网络延相对较大的原因在于时间戳一般都是在应用层加盖。为减少操作系统内核处理延时的影响提高NTP授时精度，发/收NTP包时间戳应尽量接近主机真实发/收包时刻。在不改变硬件的条件下，一个可行的办法是修改网卡驱动程序，将记录NTP包发/收时间戳从应用程序移至网卡驱动程序处，可消除操作系统内核处理延时不确定而引入的误差。这种方法在局域网中可大幅提高NTP授时精度至μs级。</p><p>为了减少温度引起晶振频率漂移对时钟准确度的影响，可以采用数字温漂补偿方法，提高时钟长期计时准确度。先测出工作温度范围内温度对应的温漂补偿系数，工作时每隔一定时间，根据实际温度查出对应补偿系数动态地修正时间。</p><p>时钟频率偏差和时钟分辨率低是局域网NTP授时精度不高的主要原因。</p><p>【原文：https://www.vfe.cc/NewsDetail-2332.aspx，转载务必带链接注明出处，未注明必追究责任!】</p><h1>相关文章:</h1><p>新能源汽车电机以及驱动器测试专家 https://www.vfe.cc/ProductShow.aspx?id=59</p><p>如何对电动汽车电源控制器实现精确测试 https://www.vfe.cc/NewsDetail-1403.aspx</p><p>电动汽车电机试验台测试系统解决方案 https://www.vfe.cc/NewsDetail-1554.aspx</p><p>如何选择电动汽车电池监测系统 https://www.vfe.cc/NewsDetail-906.aspx</p><p>新能源电动汽车动力电池测试的基本要求及检测内容https://www.vfe.cc/NewsDetail-2321.aspx</p><p>超级电容器电池 https://www.vfe.cc/NewsDetail-1556.aspx</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'NTP','时钟','及误'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>