<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>SpringBootï½œç¬¬äºŒåç« ï¼šå¼‚æ­¥å¼€å‘ä¹‹å¼‚æ­¥è¯·æ±‚ | æå®¢å¿«è¨Š</title><meta property="og:title" content="SpringBootï½œç¬¬äºŒåç« ï¼šå¼‚æ­¥å¼€å‘ä¹‹å¼‚æ­¥è¯·æ±‚ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/06812bbf96624d6a94aad8694d5f523e"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ced5638.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ced5638.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ced5638.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ced5638.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ced5638.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ced5638.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ced5638.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ced5638.html><meta property="article:published_time" content="2020-10-29T20:59:17+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:17+08:00"><meta name=Keywords content><meta name=description content="SpringBootï½œç¬¬äºŒåç« ï¼šå¼‚æ­¥å¼€å‘ä¹‹å¼‚æ­¥è¯·æ±‚"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/ced5638.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>SpringBootï½œç¬¬äºŒåç« ï¼šå¼‚æ­¥å¼€å‘ä¹‹å¼‚æ­¥è¯·æ±‚</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p>å‰è¨€</p><blockquote><p><em>å…³äºwebå¼€å‘çš„ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œåç»­æœ‰è¡¥å……æ—¶å†å¼€ç»­å†™äº†ã€‚æ¯”å¦‚webServiceæœåŠ¡ã€å‘é‚®ä»¶ç­‰ï¼Œè¿™äº›ä¸€èˆ¬ä¸Šè§‰å¾—ä¸å®Œå…¨å±äºwebå¼€å‘æ–¹é¢çš„ï¼Œè€Œä¸”ç›®å‰webServiceä½œä¸ºä¸€ä¸ªæ¥å£æ¥æä¾›æœåŠ¡çš„æœºä¼šåº”è¯¥æ¯”è¾ƒå°äº†å§ã€‚æ‰€ä»¥æœ¬ç« èŠ‚å¼€å§‹ï¼Œå¼€å§‹è®²è§£å…³äºå¼‚æ­¥å¼€å‘è¿‡ç¨‹ä¸­ä¼šä½¿ç”¨åˆ°çš„ä¸€äº›çŸ¥è¯†ç‚¹ã€‚æœ¬ç« èŠ‚å°±æ¥è®²è§£ä¸‹å¼‚æ­¥è¯·æ±‚ç›¸å…³çŸ¥è¯†ç‚¹ã€‚</em></p></blockquote><p>ä¸€ç‚¹çŸ¥è¯†</p><p>ä½•ä¸ºå¼‚æ­¥è¯·æ±‚</p><p>åœ¨Servlet 3.0ä¹‹å‰ï¼ŒServleté‡‡ç”¨Thread-Per-Requestçš„æ–¹å¼å¤„ç†è¯·æ±‚ï¼Œå³æ¯ä¸€æ¬¡Httpè¯·æ±‚éƒ½ç”±æŸä¸€ä¸ªçº¿ç¨‹ä»å¤´åˆ°å°¾è´Ÿè´£å¤„ç†ã€‚å¦‚æœä¸€ä¸ªè¯·æ±‚éœ€è¦è¿›è¡ŒIOæ“ä½œï¼Œæ¯”å¦‚è®¿é—®æ•°æ®åº“ã€è°ƒç”¨ç¬¬ä¸‰æ–¹æœåŠ¡æ¥å£ç­‰ï¼Œé‚£ä¹ˆå…¶æ‰€å¯¹åº”çš„çº¿ç¨‹å°†<strong>åŒæ­¥åœ°ç­‰å¾…<em>**</em></strong>IOæ“ä½œå®Œæˆï¼Œ è€ŒIOæ“ä½œæ˜¯<strong>éå¸¸æ…¢</strong>çš„ï¼Œæ‰€ä»¥æ­¤æ—¶çš„çº¿ç¨‹å¹¶ä¸èƒ½åŠæ—¶åœ°é‡Šæ”¾å›çº¿ç¨‹æ± ä»¥ä¾›åç»­ä½¿ç”¨ï¼Œåœ¨å¹¶å‘é‡è¶Šæ¥è¶Šå¤§çš„æƒ…å†µä¸‹ï¼Œè¿™å°†å¸¦æ¥ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚å…¶è¯·æ±‚æµç¨‹å¤§è‡´ä¸ºï¼š</p><div class=pgc-img><img alt=SpringBootï½œç¬¬äºŒåç« ï¼šå¼‚æ­¥å¼€å‘ä¹‹å¼‚æ­¥è¯·æ±‚ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/06812bbf96624d6a94aad8694d5f523e><p class=pgc-img-caption></p></div><p>è€Œåœ¨Servlet3.0å‘å¸ƒåï¼Œæä¾›äº†ä¸€ä¸ªæ–°ç‰¹æ€§ï¼š<strong>å¼‚æ­¥å¤„ç†è¯·æ±‚</strong>ã€‚å¯ä»¥<strong>å…ˆé‡Šæ”¾</strong>å®¹å™¨åˆ†é…ç»™è¯·æ±‚çš„çº¿ç¨‹ä¸ç›¸å…³èµ„æºï¼Œå‡è½»ç³»ç»Ÿè´Ÿæ‹…ï¼Œé‡Šæ”¾äº†å®¹å™¨æ‰€åˆ†é…çº¿ç¨‹çš„è¯·æ±‚ï¼Œå…¶<strong>å“åº”å°†è¢«å»¶å</strong>ï¼Œå¯ä»¥åœ¨è€—æ—¶å¤„ç†å®Œæˆï¼ˆä¾‹å¦‚é•¿æ—¶é—´çš„è¿ç®—ï¼‰æ—¶å†å¯¹å®¢æˆ·ç«¯è¿›è¡Œå“åº”ã€‚å…¶è¯·æ±‚æµç¨‹ä¸ºï¼š</p><div class=pgc-img><img alt=SpringBootï½œç¬¬äºŒåç« ï¼šå¼‚æ­¥å¼€å‘ä¹‹å¼‚æ­¥è¯·æ±‚ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e8151d8ab8e54bb192e6a7e9e3c021b4><p class=pgc-img-caption></p></div><p>åœ¨Servlet 3.0åï¼Œæˆ‘ä»¬å¯ä»¥ä»HttpServletRequestå¯¹è±¡ä¸­è·å¾—ä¸€ä¸ª<strong>AsyncContext</strong>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ„æˆäº†å¼‚æ­¥å¤„ç†çš„ä¸Šä¸‹æ–‡ï¼ŒRequestå’ŒResponseå¯¹è±¡éƒ½å¯ä»ä¸­è·å–ã€‚AsyncContextå¯ä»¥ä»å½“å‰çº¿ç¨‹ä¼ ç»™å¦å¤–çš„çº¿ç¨‹ï¼Œå¹¶åœ¨æ–°çš„çº¿ç¨‹ä¸­å®Œæˆå¯¹è¯·æ±‚çš„å¤„ç†å¹¶è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ï¼Œåˆå§‹çº¿ç¨‹ä¾¿å¯ä»¥è¿˜å›ç»™å®¹å™¨çº¿ç¨‹æ± ä»¥å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚å¦‚æ­¤ï¼Œé€šè¿‡å°†è¯·æ±‚ä»ä¸€ä¸ªçº¿ç¨‹ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹å¤„ç†çš„è¿‡ç¨‹ä¾¿æ„æˆäº†Servlet 3.0ä¸­çš„å¼‚æ­¥å¤„ç†ã€‚</p><hr><p><strong>å¤šè¯´å‡ å¥ï¼š</strong></p><p>éšç€Spring5å‘å¸ƒï¼Œæä¾›äº†ä¸€ä¸ªå“åº”å¼Webæ¡†æ¶ï¼šSpring WebFluxã€‚ä¹‹åå¯èƒ½å°±ä¸éœ€è¦Servletå®¹å™¨çš„æ”¯æŒäº†ã€‚ä»¥ä¸‹æ˜¯å…¶å…ˆåå¯¹æ¯”å›¾ï¼š</p><div class=pgc-img><img alt=SpringBootï½œç¬¬äºŒåç« ï¼šå¼‚æ­¥å¼€å‘ä¹‹å¼‚æ­¥è¯·æ±‚ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/0ad197fa49a84a0cab3c4fbe2110d30b><p class=pgc-img-caption></p></div><p>å·¦ä¾§æ˜¯ä¼ ç»Ÿçš„åŸºäºServletçš„Spring Web MVCæ¡†æ¶ï¼Œå³ä¾§æ˜¯5.0ç‰ˆæœ¬æ–°å¼•å…¥çš„åŸºäºReactive Streamsçš„Spring WebFluxæ¡†æ¶ï¼Œä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯<strong>Router Functions</strong>ï¼Œ<strong>WebFlux</strong>ï¼Œ<strong>Reactive Streams</strong>ä¸‰ä¸ªæ–°ç»„ä»¶ã€‚</p><p>å¯¹äºå…¶å‘å±•å‰æ™¯è¿˜æ˜¯æ‹­ç›®ä»¥å¾…å§ã€‚æœ‰æ—¶é—´ä¹Ÿè¯¥å»äº†è§£ä¸‹Spring5äº†ã€‚</p><hr><p>åŸç”Ÿå¼‚æ­¥è¯·æ±‚APIè¯´æ˜</p><p>åœ¨ç¼–å†™å®é™…ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹ä¸€äº›å…³äºå¼‚æ­¥è¯·æ±‚çš„apiçš„è°ƒç”¨è¯´æ˜ã€‚</p><ul><li>è·å–AsyncContextï¼šæ ¹æ®HttpServletRequestå¯¹è±¡è·å–ã€‚</li></ul><p class=ql-align-right>AsyncContext asyncContext = request.startAsync();</p><ul><li>è®¾ç½®ç›‘å¬å™¨:å¯è®¾ç½®å…¶å¼€å§‹ã€å®Œæˆã€å¼‚å¸¸ã€è¶…æ—¶ç­‰äº‹ä»¶çš„å›è°ƒå¤„ç†</li></ul><p>å…¶ç›‘å¬å™¨çš„æ¥å£ä»£ç ï¼š</p><p><strong>public</strong> <strong>interface</strong> AsyncListener <strong>extends</strong> EventListener {</p><p><strong>void</strong> onComplete(AsyncEvent event) <strong>throws</strong> IOException;</p><p><strong>void</strong> onTimeout(AsyncEvent event) <strong>throws</strong> IOException;</p><p><strong>void</strong> onError(AsyncEvent event) <strong>throws</strong> IOException;</p><p><strong>void</strong> onStartAsync(AsyncEvent event) <strong>throws</strong> IOException;</p><p>}</p><p><strong>è¯´æ˜ï¼š</strong></p><ol><li>onStartAsyncï¼šå¼‚æ­¥çº¿ç¨‹å¼€å§‹æ—¶è°ƒç”¨</li><li>onErrorï¼šå¼‚æ­¥çº¿ç¨‹å‡ºé”™æ—¶è°ƒç”¨</li><li>onTimeoutï¼šå¼‚æ­¥çº¿ç¨‹æ‰§è¡Œè¶…æ—¶è°ƒç”¨</li><li>onCompleteï¼šå¼‚æ­¥æ‰§è¡Œå®Œæ¯•æ—¶è°ƒç”¨</li></ol><p>ä¸€èˆ¬ä¸Šï¼Œæˆ‘ä»¬åœ¨è¶…æ—¶æˆ–è€…å¼‚å¸¸æ—¶ï¼Œä¼šè¿”å›ç»™å‰ç«¯ç›¸åº”çš„æç¤ºï¼Œæ¯”å¦‚è¯´è¶…æ—¶äº†ï¼Œè¯·å†æ¬¡è¯·æ±‚ç­‰ç­‰ï¼Œæ ¹æ®å„ä¸šåŠ¡è¿›è¡Œè‡ªå®šä¹‰è¿”å›ã€‚åŒæ—¶ï¼Œåœ¨å¼‚æ­¥è°ƒç”¨å®Œæˆæ—¶ï¼Œä¸€èˆ¬éœ€è¦æ‰§è¡Œä¸€äº›æ¸…ç†å·¥ä½œæˆ–è€…å…¶ä»–ç›¸å…³æ“ä½œã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯åªæœ‰åœ¨è°ƒç”¨request.startAsyncå‰å°†ç›‘å¬å™¨æ·»åŠ åˆ°AsyncContextï¼Œç›‘å¬å™¨çš„onStartAsyncæ–¹æ³•æ‰ä¼šèµ·ä½œç”¨ï¼Œè€Œè°ƒç”¨startAsyncå‰AsyncContextè¿˜ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡è°ƒç”¨startAsyncæ˜¯ä¸ä¼šè¢«ç›‘å¬å™¨ä¸­çš„onStartAsyncæ–¹æ³•æ•è·çš„ï¼Œåªæœ‰åœ¨è¶…æ—¶ååˆé‡æ–°å¼€å§‹çš„æƒ…å†µä¸‹onStartAsyncæ–¹æ³•æ‰ä¼šèµ·ä½œç”¨ã€‚</p><ul><li>è®¾ç½®è¶…æ—¶ï¼šé€šè¿‡setTimeoutæ–¹æ³•è®¾ç½®ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</li></ul><p><strong>ä¸€å®šè¦è®¾ç½®è¶…æ—¶æ—¶é—´</strong>ï¼Œä¸èƒ½æ— é™ç­‰å¾…ä¸‹å»ï¼Œä¸ç„¶å’Œæ­£å¸¸çš„è¯·æ±‚å°±ä¸€æ ·äº†ã€‚ã€‚</p><p>Servletæ–¹å¼å®ç°å¼‚æ­¥è¯·æ±‚</p><p>å‰é¢å·²ç»æåˆ°ï¼Œå¯é€šè¿‡HttpServletRequestå¯¹è±¡ä¸­è·å¾—ä¸€ä¸ª<strong>AsyncContext</strong>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ„æˆäº†å¼‚æ­¥å¤„ç†çš„ä¸Šä¸‹æ–‡ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æ¥å®é™…æ“ä½œä¸‹ã€‚</p><p>0.ç¼–å†™ä¸€ä¸ªç®€å•æ§åˆ¶å±‚</p><p>/**</p><p>* ä½¿ç”¨servletæ–¹å¼è¿›è¡Œå¼‚æ­¥è¯·æ±‚</p><p>* @author oKong</p><p>*</p><p>*/</p><p>@Slf4j</p><p>@RestController</p><p><strong>public</strong> <strong>class</strong> ServletController {</p><p>@RequestMapping("/servlet/orig")</p><p><strong>public</strong> <strong>void</strong> todo(HttpServletRequest request,</p><p>HttpServletResponse response) <strong>throws</strong> Exception {</p><p>//è¿™é‡Œæ¥ä¸ªä¼‘çœ </p><p>Thread.sleep(100);</p><p>response.getWriter().println("è¿™æ˜¯ã€æ­£å¸¸ã€‘çš„è¯·æ±‚è¿”å›");</p><p>}</p><p>@RequestMapping("/servlet/async")</p><p><strong>public</strong> <strong>void</strong> todoAsync(HttpServletRequest request,</p><p>HttpServletResponse response) {</p><p>AsyncContext asyncContext = request.startAsync();</p><p>asyncContext.addListener(<strong>new</strong> AsyncListener() {</p><p>@Override</p><p><strong>public</strong> <strong>void</strong> onTimeout(AsyncEvent event) <strong>throws</strong> IOException {</p><p>log.info("è¶…æ—¶äº†ï¼š");</p><p>//åšä¸€äº›è¶…æ—¶åçš„ç›¸å…³æ“ä½œ</p><p>}</p><p>@Override</p><p><strong>public</strong> <strong>void</strong> onStartAsync(AsyncEvent event) <strong>throws</strong> IOException {</p><p>// TODO Auto-generated method stub</p><p>log.info("çº¿ç¨‹å¼€å§‹");</p><p>}</p><p>@Override</p><p><strong>public</strong> <strong>void</strong> onError(AsyncEvent event) <strong>throws</strong> IOException {</p><p>log.info("å‘ç”Ÿé”™è¯¯ï¼š",event.getThrowable());</p><p>}</p><p>@Override</p><p><strong>public</strong> <strong>void</strong> onComplete(AsyncEvent event) <strong>throws</strong> IOException {</p><p>log.info("æ‰§è¡Œå®Œæˆ");</p><p>//è¿™é‡Œå¯ä»¥åšä¸€äº›æ¸…ç†èµ„æºçš„æ“ä½œ</p><p>}</p><p>});</p><p>//è®¾ç½®è¶…æ—¶æ—¶é—´</p><p>asyncContext.setTimeout(200);</p><p>//ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨start è¿›è¡Œå¼‚æ­¥è°ƒç”¨</p><p>// new Thread(new Runnable() {</p><p>//</p><p>// @Override</p><p>// public void run() {</p><p>// ç¼–å†™ä¸šåŠ¡é€»è¾‘</p><p>//</p><p>// }</p><p>// }).start();</p><p>asyncContext.start(<strong>new</strong> Runnable() {</p><p>@Override</p><p><strong>public</strong> <strong>void</strong> run() {</p><p><strong>try</strong> {</p><p>Thread.sleep(100);</p><p>log.info("å†…éƒ¨çº¿ç¨‹ï¼š" + Thread.currentThread().getName());</p><p>asyncContext.getResponse().setCharacterEncoding("utf-8");</p><p>asyncContext.getResponse().setContentType("text/html;charset=UTF-8");</p><p>asyncContext.getResponse().getWriter().println("è¿™æ˜¯ã€å¼‚æ­¥ã€‘çš„è¯·æ±‚è¿”å›");</p><p>} <strong>catch</strong> (Exception e) {</p><p>log.error("å¼‚å¸¸ï¼š",e);</p><p>}</p><p>//å¼‚æ­¥è¯·æ±‚å®Œæˆé€šçŸ¥</p><p>//æ­¤æ—¶æ•´ä¸ªè¯·æ±‚æ‰å®Œæˆ</p><p>//å…¶å®å¯ä»¥åˆ©ç”¨æ­¤ç‰¹æ€§ è¿›è¡Œå¤šæ¡æ¶ˆæ¯çš„æ¨é€ æŠŠè¿æ¥æŒ‚èµ·ã€‚ã€‚</p><p>asyncContext.complete();</p><p>}</p><p>});</p><p>//æ­¤æ—¶ä¹‹ç±» requestçš„çº¿ç¨‹è¿æ¥å·²ç»é‡Šæ”¾äº†</p><p>log.info("çº¿ç¨‹ï¼š" + Thread.currentThread().getName());</p><p>}</p><p>}</p><p><strong>æ³¨æ„ï¼šå¼‚æ­¥è¯·æ±‚æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ThreadPoolExecutorè‡ªå®šä¹‰ä¸ªçº¿ç¨‹æ± ã€‚</strong></p><p>1.å¯åŠ¨ä¸‹åº”ç”¨ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºå°±å¯ä»¥è·æ‚‰æ˜¯å¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œé¢äº†ã€‚åŒæ—¶ï¼Œå¯è®¾ç½®ä¸‹ç­‰å¾…æ—¶é—´ï¼Œä¹‹åå°±ä¼šè°ƒç”¨è¶…æ—¶å›è°ƒæ–¹æ³•äº†ã€‚å¤§å®¶å¯è‡ªå·±è¯•è¯•ã€‚</p><p>2018-08-15 23:03:04.082 INFO 6732 --- [nio-8080-exec-1] c.l.l.s.controller.ServletController : çº¿ç¨‹ï¼šhttp-nio-8080-exec-1</p><p>2018-08-15 23:03:04.183 INFO 6732 --- [nio-8080-exec-2] c.l.l.s.controller.ServletController : å†…éƒ¨çº¿ç¨‹ï¼šhttp-nio-8080-exec-2</p><p>2018-08-15 23:03:04.190 INFO 6732 --- [nio-8080-exec-3] c.l.l.s.controller.ServletController : æ‰§è¡Œå®Œæˆ</p><p><strong>ä½¿ç”¨è¿‡æ»¤å™¨æ—¶ï¼Œéœ€è¦åŠ å…¥asyncSupportedä¸ºtrueé…ç½®ï¼Œå¼€å¯å¼‚æ­¥è¯·æ±‚æ”¯æŒã€‚</strong></p><p class=ql-align-right>1</p><p class=ql-align-right>2</p><p>@WebServlet(urlPatterns = "/okong", asyncSupported = <strong>true</strong> )</p><p><strong>public</strong> <strong>class</strong> AsyncServlet <strong>extends</strong> HttpServlet ...</p><p><strong>é¢˜å¤–è¯ï¼š</strong>å…¶å®æˆ‘ä»¬å¯ä»¥åˆ©ç”¨åœ¨æœªæ‰§è¡ŒasyncContext.complete()æ–¹æ³•æ—¶è¯·æ±‚æœªç»“æŸè¿™ç‰¹æ€§ï¼Œå¯ä»¥åšä¸ªç®€å•çš„æ–‡ä»¶ä¸Šä¼ è¿›åº¦æ¡ä¹‹ç±»çš„åŠŸèƒ½ã€‚ä½†æ³¨æ„è¯·æ±‚æ˜¯ä¼šè¶…æ—¶çš„ï¼Œéœ€è¦è®¾ç½®è¶…æ—¶çš„æ—¶é—´ä¸‹ã€‚</p><p>Springæ–¹å¼å®ç°å¼‚æ­¥è¯·æ±‚</p><blockquote><p><em>åœ¨Springä¸­ï¼Œæœ‰å¤šç§æ–¹å¼å®ç°å¼‚æ­¥è¯·æ±‚ï¼Œæ¯”å¦‚callableã€DeferredResultæˆ–è€…WebAsyncTaskã€‚æ¯ä¸ªçš„ç”¨æ³•ç•¥æœ‰ä¸åŒï¼Œå¯æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯é€‰æ‹©ä¸åŒçš„æ–¹å¼ã€‚ä»¥ä¸‹ä¸»è¦ä»‹ç»ä¸€äº›å¸¸ç”¨çš„ç”¨æ³•</em></p></blockquote><p>Callable</p><blockquote><p><em>ä½¿ç”¨å¾ˆç®€å•ï¼Œç›´æ¥è¿”å›çš„å‚æ•°åŒ…è£¹ä¸€å±‚callableå³å¯ã€‚</em></p></blockquote><p>ç”¨æ³•</p><p>@RequestMapping("/callable")</p><p><strong>public</strong> Callable&lt;String> callable() {</p><p>log.info("å¤–éƒ¨çº¿ç¨‹ï¼š" + Thread.currentThread().getName());</p><p><strong>return</strong> <strong>new</strong> Callable&lt;String>() {</p><p>@Override</p><p><strong>public</strong> String call() <strong>throws</strong> Exception {</p><p>log.info("å†…éƒ¨çº¿ç¨‹ï¼š" + Thread.currentThread().getName());</p><p><strong>return</strong> "callable!";</p><p>}</p><p>};</p><p>}</p><p>æ§åˆ¶å°è¾“å‡ºï¼š</p><p>2018-08-15 23:32:22.317 INFO 15740 --- [nio-8080-exec-2] c.l.l.s.controller.SpringController : å¤–éƒ¨çº¿ç¨‹ï¼šhttp-nio-8080-exec-2</p><p>2018-08-15 23:32:22.323 INFO 15740 --- [ MvcAsync1] c.l.l.s.controller.SpringController : å†…éƒ¨çº¿ç¨‹ï¼šMvcAsync1</p><p>è¶…æ—¶ã€è‡ªå®šä¹‰çº¿ç¨‹è®¾ç½®</p><p>ä»æ§åˆ¶å°å¯ä»¥çœ‹è§ï¼Œå¼‚æ­¥å“åº”çš„çº¿ç¨‹ä½¿ç”¨çš„æ˜¯åä¸ºï¼šMvcAsync1çš„çº¿ç¨‹ã€‚ç¬¬ä¸€æ¬¡å†è®¿é—®æ—¶ï¼Œå°±æ˜¯MvcAsync2äº†ã€‚è‹¥é‡‡ç”¨é»˜è®¤è®¾ç½®ï¼Œä¼šæ— é™çš„åˆ›å»ºæ–°çº¿ç¨‹å»å¤„ç†å¼‚æ­¥è¯·æ±‚ï¼Œæ‰€ä»¥æ­£å¸¸éƒ½éœ€è¦é…ç½®ä¸€ä¸ªçº¿ç¨‹æ± åŠè¶…æ—¶æ—¶é—´ã€‚</p><p>ç¼–å†™ä¸€ä¸ªé…ç½®ç±»ï¼šCustomAsyncPool.java</p><p class=ql-align-right><br></p><p>@Configuration</p><p><strong>public</strong> <strong>class</strong> CustomAsyncPool <strong>extends</strong> WebMvcConfigurerAdapter{</p><p>/**</p><p>* é…ç½®çº¿ç¨‹æ± </p><p>* @return</p><p>*/</p><p>@Bean(name = "asyncPoolTaskExecutor")</p><p><strong>public</strong> ThreadPoolTaskExecutor getAsyncThreadPoolTaskExecutor() {</p><p>ThreadPoolTaskExecutor taskExecutor = <strong>new</strong> ThreadPoolTaskExecutor();</p><p>taskExecutor.setCorePoolSize(20);</p><p>taskExecutor.setMaxPoolSize(200);</p><p>taskExecutor.setQueueCapacity(25);</p><p>taskExecutor.setKeepAliveSeconds(200);</p><p>taskExecutor.setThreadNamePrefix("callable-");</p><p>// çº¿ç¨‹æ± å¯¹æ‹’ç»ä»»åŠ¡ï¼ˆæ— çº¿ç¨‹å¯ç”¨ï¼‰çš„å¤„ç†ç­–ç•¥ï¼Œç›®å‰åªæ”¯æŒAbortPolicyã€CallerRunsPolicyï¼›é»˜è®¤ä¸ºåè€…</p><p>taskExecutor.setRejectedExecutionHandler(<strong>new</strong> ThreadPoolExecutor.CallerRunsPolicy());</p><p>taskExecutor.initialize();</p><p><strong>return</strong> taskExecutor;</p><p>}</p><p>@Override</p><p><strong>public</strong> <strong>void</strong> configureAsyncSupport(<strong>final</strong> AsyncSupportConfigurer configurer) {</p><p>//å¤„ç† callableè¶…æ—¶</p><p>configurer.setDefaultTimeout(60*1000);</p><p>configurer.registerCallableInterceptors(timeoutInterceptor());</p><p>configurer.setTaskExecutor(getAsyncThreadPoolTaskExecutor());</p><p>}</p><p>@Bean</p><p><strong>public</strong> TimeoutCallableProcessor timeoutInterceptor() {</p><p><strong>return</strong> <strong>new</strong> TimeoutCallableProcessor();</p><p>}</p><p>}</p><p>è‡ªå®šä¹‰ä¸€ä¸ªè¶…æ—¶å¼‚å¸¸å¤„ç†ç±»ï¼šCustomAsyncRequestTimeoutException.java</p><p>/**</p><p>* è‡ªå®šä¹‰è¶…æ—¶å¼‚å¸¸ç±»</p><p>* @author oKong</p><p>*</p><p>*/</p><p><strong>public</strong> <strong>class</strong> CustomAsyncRequestTimeoutException <strong>extends</strong> RuntimeException {</p><p>/**</p><p>*</p><p>*/</p><p><strong>private</strong> <strong>static</strong> <strong>final</strong> <strong>long</strong> serialVersionUID = 8754629185999484614L;</p><p><strong>public</strong> CustomAsyncRequestTimeoutException(String uri){</p><p><strong>super</strong>(uri);</p><p>}</p><p>}</p><p>åŒæ—¶ï¼Œåœ¨<strong>ç»Ÿä¸€å¼‚å¸¸</strong>å¤„ç†åŠ å…¥å¯¹CustomAsyncRequestTimeoutExceptionç±»çš„å¤„ç†å³å¯ï¼Œè¿™æ ·å°±æœ‰ä¸ªç»Ÿä¸€çš„é…ç½®äº†ã€‚</p><p>ä¹‹åï¼Œå†è¿è¡Œå°±å¯ä»¥çœ‹è§ä½¿ç”¨äº†è‡ªå®šä¹‰çš„çº¿ç¨‹æ± äº†ï¼Œè¶…æ—¶çš„å¯ä»¥è‡ªè¡Œæ¨¡æ‹Ÿä¸‹ï¼š</p><p>2018-08-15 23:48:29.022 INFO 16060 --- [nio-8080-exec-1] c.l.l.s.controller.SpringController : å¤–éƒ¨çº¿ç¨‹ï¼šhttp-nio-8080-exec-1</p><p>2018-08-15 23:48:29.032 INFO 16060 --- [ oKong-1] c.l.l.s.controller.SpringController : å†…éƒ¨çº¿ç¨‹ï¼šoKong-1</p><p>DeferredResult</p><p>ç›¸æ¯”äºcallableï¼ŒDeferredResultå¯ä»¥å¤„ç†ä¸€äº›ç›¸å¯¹å¤æ‚ä¸€äº›çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ€ä¸»è¦è¿˜æ˜¯å¯ä»¥åœ¨å¦ä¸€ä¸ªçº¿ç¨‹é‡Œé¢è¿›è¡Œä¸šåŠ¡å¤„ç†åŠè¿”å›ï¼Œå³å¯åœ¨ä¸¤ä¸ªå®Œå…¨ä¸ç›¸å¹²çš„çº¿ç¨‹é—´çš„é€šä¿¡ã€‚</p><p>/**</p><p>* çº¿ç¨‹æ± </p><p>*/</p><p><strong>public</strong> <strong>static</strong> ExecutorService FIXED_THREAD_POOL = Executors.newFixedThreadPool(30);</p><p>@RequestMapping("/deferredresult")</p><p><strong>public</strong> DeferredResult&lt;String> deferredResult(){</p><p>log.info("å¤–éƒ¨çº¿ç¨‹ï¼š" + Thread.currentThread().getName());</p><p>//è®¾ç½®è¶…æ—¶æ—¶é—´</p><p>DeferredResult&lt;String> result = <strong>new</strong> DeferredResult&lt;String>(60*1000L);</p><p>//å¤„ç†è¶…æ—¶äº‹ä»¶ é‡‡ç”¨å§”æ‰˜æœºåˆ¶</p><p>result.onTimeout(<strong>new</strong> Runnable() {</p><p>@Override</p><p><strong>public</strong> <strong>void</strong> run() {</p><p>log.error("DeferredResultè¶…æ—¶");</p><p>result.setResult("è¶…æ—¶äº†!");</p><p>}</p><p>});</p><p>result.onCompletion(<strong>new</strong> Runnable() {</p><p>@Override</p><p><strong>public</strong> <strong>void</strong> run() {</p><p>//å®Œæˆå</p><p>log.info("è°ƒç”¨å®Œæˆ");</p><p>}</p><p>});</p><p>FIXED_THREAD_POOL.execute(<strong>new</strong> Runnable() {</p><p>@Override</p><p><strong>public</strong> <strong>void</strong> run() {</p><p>//å¤„ç†ä¸šåŠ¡é€»è¾‘</p><p>log.info("å†…éƒ¨çº¿ç¨‹ï¼š" + Thread.currentThread().getName());</p><p>//è¿”å›ç»“æœ</p><p>result.setResult("DeferredResult!!");</p><p>}</p><p>});</p><p><strong>return</strong> result;</p><p>}</p><p>æ§åˆ¶å°è¾“å‡ºï¼š</p><p>2018-08-15 23:52:27.841 INFO 12984 --- [nio-8080-exec-2] c.l.l.s.controller.SpringController : å¤–éƒ¨çº¿ç¨‹ï¼šhttp-nio-8080-exec-2</p><p>2018-08-15 23:52:27.843 INFO 12984 --- [pool-1-thread-1] c.l.l.s.controller.SpringController : å†…éƒ¨çº¿ç¨‹ï¼špool-1-thread-1</p><p>2018-08-15 23:52:27.872 INFO 12984 --- [nio-8080-exec-2] c.l.l.s.controller.SpringController : è°ƒç”¨å®Œæˆ</p><p><strong>æ³¨æ„ï¼šè¿”å›ç»“æœæ—¶è®°å¾—è°ƒç”¨ä¸‹setResultæ–¹æ³•ã€‚</strong></p><p><strong>é¢˜å¤–è¯ï¼šåˆ©ç”¨DeferredResultå¯å®ç°ä¸€äº›é•¿è¿æ¥çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å½“æŸä¸ªæ“ä½œæ˜¯å¼‚æ­¥æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¿å­˜è¿™ä¸ªDeferredResultå¯¹è±¡ï¼Œå½“å¼‚æ­¥é€šçŸ¥å›æ¥æ—¶ï¼Œæˆ‘ä»¬åœ¨æ‰¾å›è¿™ä¸ªDeferredResultå¯¹è±¡ï¼Œä¹‹ååœ¨setResultä¼šç»“æœå³å¯ã€‚æé«˜æ€§èƒ½ã€‚</strong></p><p>WebAsyncTask</p><p>ä½¿ç”¨æ–¹æ³•éƒ½ç±»ä¼¼ï¼Œåªæ˜¯WebAsyncTaskæ˜¯ç›´æ¥è¿”å›äº†ã€‚è§‰å¾—å°±æ˜¯å†™æ³•ä¸åŒè€Œå·²ï¼Œæ›´å¤šç»†èŠ‚å¸Œæœ›å¤§ç¥è§£ç­”ï¼</p><p>@RequestMapping("/webAsyncTask")</p><p><strong>public</strong> WebAsyncTask&lt;String> webAsyncTask() {</p><p>log.info("å¤–éƒ¨çº¿ç¨‹ï¼š" + Thread.currentThread().getName());</p><p>WebAsyncTask&lt;String> result = <strong>new</strong> WebAsyncTask&lt;String>(60*1000L, <strong>new</strong> Callable&lt;String>() {</p><p>@Override</p><p><strong>public</strong> String call() <strong>throws</strong> Exception {</p><p>log.info("å†…éƒ¨çº¿ç¨‹ï¼š" + Thread.currentThread().getName());</p><p><strong>return</strong> "WebAsyncTask!!!";</p><p>}</p><p>});</p><p>result.onTimeout(<strong>new</strong> Callable&lt;String>() {</p><p>@Override</p><p><strong>public</strong> String call() <strong>throws</strong> Exception {</p><p>// TODO Auto-generated method stub</p><p><strong>return</strong> "WebAsyncTaskè¶…æ—¶!!!";</p><p>}</p><p>});</p><p>result.onCompletion(<strong>new</strong> Runnable() {</p><p>@Override</p><p><strong>public</strong> <strong>void</strong> run() {</p><p>//è¶…æ—¶å ä¹Ÿä¼šæ‰§è¡Œæ­¤æ–¹æ³•</p><p>log.info("WebAsyncTaskæ‰§è¡Œç»“æŸ");</p><p>}</p><p>});</p><p><strong>return</strong> result;</p><p>}</p><p>æ§åˆ¶å°è¾“å‡ºï¼š</p><p>2018-08-15 23:55:02.568 INFO 2864 --- [nio-8080-exec-1] c.l.l.s.controller.SpringController : å¤–éƒ¨çº¿ç¨‹ï¼šhttp-nio-8080-exec-1</p><p>2018-08-15 23:55:02.587 INFO 2864 --- [ oKong-1] c.l.l.s.controller.SpringController : å†…éƒ¨çº¿ç¨‹ï¼šoKong-1</p><p>2018-08-15 23:55:02.615 INFO 2864 --- [nio-8080-exec-2] c.l.l.s.controller.SpringController : WebAsyncTaskæ‰§è¡Œç»“æŸ</p><p>å‚è€ƒèµ„æ–™</p><ol><li>https://blog.csdn.net/paincupid/article/details/52266905</li><li>https://docs.spring.io/spring/docs/4.3.18.RELEASE/spring-framework-reference/htmlsingle/#mvc-ann-async</li></ol><p>æ€»ç»“</p><blockquote><p><em>æœ¬ç« èŠ‚ä¸»è¦æ˜¯è®²è§£äº†å¼‚æ­¥è¯·æ±‚çš„ä½¿ç”¨åŠç›¸å…³é…ç½®ï¼Œå¦‚è¶…æ—¶ï¼Œå¼‚å¸¸ç­‰å¤„ç†ã€‚è®¾ç½®å¼‚æ­¥è¯·æ±‚æ—¶ï¼Œè®°å¾—ä¸è¦å¿˜è®°è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚</em><strong><em>å¼‚æ­¥è¯·æ±‚åªæ˜¯æé«˜äº†æœåŠ¡çš„ååé‡ï¼Œæé«˜å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æ•°ï¼Œå¹¶ä¸ä¼šåŠ å¿«å¤„ç†æ•ˆç‡çš„ï¼Œè¿™ç‚¹éœ€è¦æ³¨æ„ã€‚</em></strong><em>ã€‚ä¸‹ä¸€ç« èŠ‚ï¼Œè®²è®²ä½¿ç”¨@Asyncè¿›è¡Œå¼‚æ­¥è°ƒç”¨ç›¸å…³çŸ¥è¯†ã€‚</em></p></blockquote><p>æœ€å</p><blockquote><p><em>ç›®å‰äº’è”ç½‘ä¸Šå¾ˆå¤šå¤§ä½¬éƒ½æœ‰SpringBootç³»åˆ—æ•™ç¨‹ï¼Œå¦‚æœ‰é›·åŒï¼Œè¯·å¤šå¤šåŒ…æ¶µäº†ã€‚è‹¥æ–‡ä¸­æœ‰æ‰€é”™è¯¯ä¹‹å¤„ï¼Œè¿˜æœ›æå‡ºï¼Œè°¢è°¢ã€‚</em></p></blockquote><div class=pgc-img><img alt=SpringBootï½œç¬¬äºŒåç« ï¼šå¼‚æ­¥å¼€å‘ä¹‹å¼‚æ­¥è¯·æ±‚ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8a8cdeaee49e4ff48025779c5de9a619><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'å¼‚æ­¥','SpringBoot','å¼€å‘'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>