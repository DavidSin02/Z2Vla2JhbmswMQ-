<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>开源 | Umajs：轻量级 Node.js Web 框架 | 极客快訊</title><meta property="og:title" content="开源 | Umajs：轻量级 Node.js Web 框架 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/186828b5b34b4255903df4a9fadc6158"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cef95023.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cef95023.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cef95023.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cef95023.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cef95023.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cef95023.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cef95023.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cef95023.html><meta property="article:published_time" content="2020-11-14T21:04:29+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:29+08:00"><meta name=Keywords content><meta name=description content="开源 | Umajs：轻量级 Node.js Web 框架"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/cef95023.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>开源 | Umajs：轻量级 Node.js Web 框架</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><br></p><p style=text-align:center><strong>开源二期项目专题系列</strong></p><p style=text-align:center><strong>（二）</strong></p><p>1.开源项目名称：Umajs</p><p><br>2.GitHub地址：</p><p>https://github.com/wuba/Umajs</p><p><br>3.简介：Umajs 是58同城推出的一款轻量级 node web 框架。它的中文含义是大熊座，北斗七星都是它的组成部分；正如同 Umajs 也是由不同的 package 所组合在一起。我们希望 Umajs 的每一部分，都是优秀的、闪耀的、经受的住各种大型项目检验的。<br></p><h1 class=pgc-h-arrow-right>Umajs开源项目具备以下特点：</h1><ul><li>内置丰富的装饰器 (decorator)，提供自定义装饰器机制；</li><li>依赖注入 (IOC)，模块依赖不再需要引入和实例化；</li><li>面向切面 (AOP)，基于装饰器的 AOP 可以很方便的使用在各种方法上；</li><li>统一返回 (Result)，让编码更简单清晰；</li><li>提供插件机制，灵活扩展框架功能，兼容 Koa2 中间件；</li><li>高稳定高性能，源码 TypeScript 开发、单元测试覆盖全。</li></ul><p><br></p><p><strong>项目背景</strong></p><p>Nodejs 对于前端工程师的重要性不言而喻，它的出现使 JavaScript 成为了最受欢迎的 web 开发语言之一，各类 node web 框架层出不穷，诸如 Express、Koa 等等；但是在应用到实际业务场景时我们还需要额外做一些功能的扩展，为此相应的社区也提供了大量的中间件。</p><p>与此同时，随着 JavaScript 承担了更多的大型复杂应用的开发，TypeScript 也渐渐进入了我们的视野：做为 JavaScript 的超集，它的静态类型检查无疑是构建大型 JavaScript 项目的强大助力。<br>有鉴于此，我们推出了使用 TypeScript 开发的 node web 框架：Umajs 。这里主要和大家分享一下 Umajs 在搭建过程中的设计及其应用的介绍。</p><p><br></p><p><strong>架构设计</strong></p><div class=pgc-img><img alt="开源 | Umajs：轻量级 Node.js Web 框架" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/186828b5b34b4255903df4a9fadc6158><p class=pgc-img-caption></p></div><ul><li>用户请求达到 router；</li><li>router 解析请求穿过 plugin 中的中间件，然后到达 controller；</li><li>controller 可以通过 IOC 调用 service 和 resource；</li><li>controller、service、resource 等可以通过 AOP 的 Aspect 进行切面开发；</li><li>controller 返回 Result，Umajs 解析 Result 按 Koa 框架格式返回数据；</li><li>AOP 可以对 controller、service、resource 进行切面开发，还可以将 middleware 封装成 Aspect.around 对 controller 进行切页面开发；</li><li>中间件（middlware）有提供两种形式使用，一种是插件配置(plugin.config.ts)，一种是封装成Aspect.around 以装饰器形式使用；</li><li>Plugin 有两种形式进行扩展，一种中间件形式、一种复合形。<br></li></ul><p><strong>AOP</strong></p><p>AOP(Aspect Oriented Programming) 面向切面编程，是一种不修改原代码也能为其动态扩展功能的编程方式。</p><p><strong>Umajs 内置了以下五种切面：</strong></p><ul><li>before：在目标方法之前执行；</li><li>after：在目标方法之后执行；</li><li>around：在最开始调用时执行，会将目标方法作为参数传入，可对目标方法进行拦截；</li><li>afterThrowing：当执行目标方法出现异常时调用；</li><li>afterReturning：当目标方法有返回值之后执行，在 after 之后执行。</li></ul><p><br></p><p>切面可以作用在 class 或者 method 上；一个 class 或者 method 上可以有多个切面，执行顺序如下图所示：</p><p><br></p><div class=pgc-img><img alt="开源 | Umajs：轻量级 Node.js Web 框架" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8daacb3ed5d8466cbb22ae562a4579e7><p class=pgc-img-caption></p></div><p>使用 AOP 能够有效的隔离业务中不同部分的逻辑。例如原有目标方法如下：</p><ul><li style=text-align:right;list-style-position:inside><br></li><li style=text-align:right;list-style-position:inside><br></li><li style=text-align:right;list-style-position:inside><br></li><li style=text-align:right;list-style-position:inside><br></li></ul><pre><code>getList(params){    // do something    return list; }</code></pre><p>假设随着业务的发展，我们需要为这些方法添加埋点统计。此时我们可以通过 AOP 的方式快速扩展目标方法：</p><pre><code>@Aspect.before('report')getList(params){    // do something    return list; }</code></pre><p>相比直接修改 getList 方法，AOP 的方式分离了上报逻辑与数据获取逻辑、降低了耦合度，在保持对业务代码零侵入的情况下完成了功能的扩展。同时该上报方法能够多处复用，提高了代码的可复用性与可维护性。</p><p><br></p><p><strong>Result统一返回</strong></p><p>统一返回是 Umajs 的另一个特色。我们知道，在大多数 node web 框架中，controller 在处理完业务逻辑后以如下的方式返回处理结果：</p><p><br></p><pre><code>// 返回json数据getList(param){    // do something    ctx.body = { list };}// 返回viewindex(){    ctx.render('index.tpl');}</code></pre><p>而 Umajs 提供了如下快捷返回方式：</p><ul><li>Result.send(val, status)：快捷返回文本内容；</li><li>Result.json(data)：返回json数据；</li><li>Result.jsonp(data, callback)：以jsonp的形式返回数据；</li><li>Result.view(templatePath, data)：通过渲染模板的方式将数据返回；</li><li>Result.stream(data, fileName)：将文件以流（stream）的方式返回；</li><li>Result.download(filePath, opts)：下载文件。</li></ul><p>处理流程如下：</p><div class=pgc-img><img alt="开源 | Umajs：轻量级 Node.js Web 框架" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a2f239e271db4045a640da5c36e67827><p class=pgc-img-caption></p></div><p>Result 封装了常见的返回值快捷方式，有效的提升了开发效率。同时 Result 可以通过插件进行扩展，为业务提供更多可能性。Result 的意义不仅于快捷方式，在结合了切面、自定义装饰器等功能后，我们可以很轻松的实现对返回值的定制修改。</p><p><br></p><h1 class=pgc-h-arrow-right><strong>自定义装饰器</strong></h1><p>Umajs中大量的功能都通过内置装饰器来提供，诸如：</p><ul><li>切面装饰器：@Aspect</li><li>IOC装饰器：@Resource、@Inject</li><li>路由装饰器：@Path、@Private</li></ul><p>同时针对高频场景提供了自定义参数装饰器 createArgDecorator，例如通过该方法创建的装饰器能够快速到获取到 query 上的参数：</p><pre><code>const Query = createArgDecorator((argKey, ctx) =&gt; ctx.query[argKey]);</code></pre><p>crateArgDecorator用途不止于此，可以利用它进行参数聚合、参数校验、参数转换等等参数相关的操作。下文我们会详细介绍其强大之处。</p><p>在提供丰富的内置装饰器和自定义参数装饰器的同时，框架的使用者也可以自定义符合规范的其它类型装饰器，可以参考 TypeScript 装饰器，此处不再赘述。</p><p><br></p><h1 class=pgc-h-arrow-right><strong>应用介绍</strong></h1><p>上文介绍了Umajs的几个特色，接下来我们一起探索它们在业务场景下的应用。</p><p>业务需要根据用户ID查询该用户下的列表数据，API如下:</p><pre><code>GET /api/list?userId=userId</code></pre><p>对应的controller方法可以如下实现:</p><pre><code>getList(){    const { userId } = this.ctx.query;    const list = this.service.getListByUid(userId);    return Result.json(list)}</code></pre><p>虽然上述代码实现了查询功能，但是这种实现是不符合开发规范、存在风险的：</p><p>首先我们期望的返回值内存在状态码而不仅仅是数据；其次userId为必填项，此处应该进行参数校验；最后没有进行异常处理。</p><p>首先我们创建一个自定义的参数装饰器用于类型检查：</p><pre><code>const IdCheck = createArgDecorator((key: string, ctx: IContext) =&gt; {    const id = ctx.query[key];        if (id === undefined || id === null || id === '') {        return Result.json({            code: ErrorType.Empty,            msg: `参数 ${key} 不能为空`,        });    }    // 其它校验逻辑    return id;});export IdCheck;</code></pre><p>然后创建一个切面，该切面内实现一个用于异常处理的around切点：</p><pre><code>export default class Demo implements IAspect {    async around(proceedPoint: IProceedJoinPoint) {        try {            const { proceed, args } = proceedPoint;            const result = await proceed(...args);            return result;        } catch (e) {            // 可用 afterThrowing            return Result.json({                code: ErrorType.Error,                msg: e.toString(),            });        }    }}</code></pre><p>改造后的方法如下:</p><pre><code>@Aspect('demo')getList(@IdCheck('userid') uid)){    const list = this.service.getListByUid(uid);    return Result.json(list)}</code></pre><p>通过以上简单的示例我们可以看到：Umajs 的代码在保持业务逻辑清晰的同时，以轻量的扩展实现了参数校验、异常处理、返回值包装等等扩展功能。而这些扩展的装饰器是可以复用在其它方法上的。</p><p>对于大型的、复杂度高的工程来说，使用 Umajs 能够在获得良好开发体验的同时，大幅提升工程的可扩展性、可维护性、可复用性，从而提升开发效率。</p><p><br></p><p><strong>核心优势</strong></p><ul><li>功能强大：内置丰富的装饰器，诸如IOC 装饰器、AOP 装饰器、路由装饰器等等，也可以自定义装饰器；</li><li>扩展灵活：通过插件机制扩展框架，提供多种方式兼容 Koa 中间件；</li><li>快捷返回：框架内置了常用的返回类型，同时支持扩展；结合切面及装饰器能够覆盖绝大多数业务场景；</li><li>开发效率：Umajs内置了大量功能能够提升开发效率；同时 Koa 项目可以平滑的迁移到 Umajs。</li></ul><p><strong>未来规划</strong></p><p>Umajs会进一步的完善插件机制，使其更易于使用。未来将会增加对于模型驱动开发的支持。我们会持续关注业内的新技术、新趋势、新特性，在合适的情况下会将其引入框架。与此同时，我们会根据社区的反馈不断的完善框架。</p><p><br></p><p><strong>如何贡献&问题反馈</strong></p><p>我们向广大开发者发出诚挚的邀请，与我们一道共同建设，为 node web 开发效率的提升不断努力。您可以在 https://github.com/wuba/Umajs了解项目源码、使用方式等。同时欢迎提交 PR 或者 Issue，向我们反馈建议和问题。</p><p><br></p><p><strong>想了解更多开源项目信息？</strong></p><p><strong>与项目成员零距离交流？</strong></p><p><strong>扫码加入项目群</strong></p><div class=pgc-img><img alt="开源 | Umajs：轻量级 Node.js Web 框架" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4a58615dee1043f28edb4efd5708e341><p class=pgc-img-caption></p></div><p><strong>一切应有尽有</strong></p><div class=pgc-img><img alt="开源 | Umajs：轻量级 Node.js Web 框架" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3ca71f7e7e2e4e3488cb56c907ddc804><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="开源 | Umajs：轻量级 Node.js Web 框架" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/c12690fc341140489c5305617fdc41ab><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="开源 | Umajs：轻量级 Node.js Web 框架" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/69f038d21dfb45ce88be7791a61d4e5d><p class=pgc-img-caption></p></div><p>可添加“58技术小秘书”微信 : jishu-58<br></p><p>添加小秘书微信后由小秘书拉您进项目交流群</p><p><br></p><p><strong>作者简介：</strong></p><p><strong>王亮，58同城 本地服务技术部 前端工程师</strong></p><p><strong><br></strong></p><p><strong>团队简介：</strong></p><p><strong>Umajs团队，成员来自58集团各个BG，有着不同的业务背景，因为共同的兴趣而聚集在一起的一群前端工程师。主要维护者有：张志华 、王亮、王莹莹、江峥、薛家志、刘敏、张佳佳、 王斌、邱成林、王晓伟、 武宁、</strong><strong>要</strong><strong>嵘赫、袁崇恩。</strong></p><p><strong><br></strong></p><p><strong>推荐阅读：</strong></p><p>开源｜Magpie可视化圈选埋点实践</p><p>开源 | Picasso：sketch设计稿智能解析工具</p><p>开源｜Magpie：Magpie在安居客有料业务的落地实践</p><p>开源｜Magpie：58 跨平台技术应用及 Flutter 实践概览<br></p><p>开源｜qa_match更新啦——支持轻量级预训练、提高问答通用性</p><p><br></p><div class=pgc-img><img alt="开源 | Umajs：轻量级 Node.js Web 框架" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b82c2309c3854f0b8547d1b6914a34f8><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'开源','Umajs','轻量'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>