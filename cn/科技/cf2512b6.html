<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>NGUI扩展BBCode实现字符控制描边和阴影 | 极客快訊</title><meta property="og:title" content="NGUI扩展BBCode实现字符控制描边和阴影 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/d671517ecaa6406f996da0e3dc87bf03"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cf2512b6.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cf2512b6.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cf2512b6.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cf2512b6.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cf2512b6.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cf2512b6.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cf2512b6.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cf2512b6.html><meta property="article:published_time" content="2020-11-14T21:01:00+08:00"><meta property="article:modified_time" content="2020-11-14T21:01:00+08:00"><meta name=Keywords content><meta name=description content="NGUI扩展BBCode实现字符控制描边和阴影"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/cf2512b6.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>NGUI扩展BBCode实现字符控制描边和阴影</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><br></p><div class=pgc-img><img alt=NGUI扩展BBCode实现字符控制描边和阴影 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d671517ecaa6406f996da0e3dc87bf03><p class=pgc-img-caption></p></div><pre><code>[c=11ff11]控制[e=ffffff][c=000000]测试[c=ff0000]9[c]99[e][c][c=ff0000][e=ffff00]发光字[e][c][e=00aaff][c=FF00E3]1234[c][e]56[e=ff0000]1[e] [c=ff0000]测试版本，[e=ffff00][u]版权[e][/u]所有[c] [2020.5] </code></pre><p>主要修改了NGUIText中的ParseSymbol函数：</p><pre><code>...  // buffer中描述每段字符的描边色	static public BetterList&lt;Color&gt; mEffectColors = new BetterList&lt;Color&gt;();	static public BetterList&lt;int&gt; mEffectColorMark = new BetterList&lt;int&gt;();......static public bool ParseSymbol (string text, ref int index, BetterList&lt;Color&gt; colors, bool premultiply, 		ref int sub, ref bool bold, ref bool italic, ref bool underline, ref bool strike, ref bool ignoreColor, int parseEffectMark = 0)	{		int length = text.Length;		// 控制字符至少是3个 [c]		if (index + 3 &gt; length || text[index] != '[') return false;		char ctrlchar = text[index + 1];		if (ctrlchar == 'c')		{			// 颜色标签			if (text[index + 2] == ']')			{				if (colors != null &amp;&amp; colors.size &gt; 1)					colors.RemoveAt(colors.size - 1);				index += 3;				return true;			}			else if (index + 9 &lt; length)			{				// 新增颜色				if (text[index + 9] == ']')				{					Color c = Color.white;					if (!TryGetParseColor24(ref c, text, index + 3))						return false;					if (colors != null)					{						c.a = colors[colors.size - 1].a;						if (premultiply &amp;&amp; c.a != 1f)							c = Color.Lerp(mInvisible, c, c.a);						colors.Add(c);					}					index += 10;					return true;				}			}		}		else if (ctrlchar == 'e')		{			// 描边标签			if (text[index + 2] == ']')			{				// 取消描边标签				if (mEffectColorMark.size &gt; 0)					mEffectColorMark.Add(-parseEffectMark);				index += 3;				return true;			}			else if (index + 9 &lt; length)			{				// 新增描边颜色				if (text[index + 9] == ']')				{					if (parseEffectMark &gt; 0)					{						Color c = Color.white;						if (!TryGetParseColor24(ref c, text, index + 3))							return false;						mEffectColorMark.Add(parseEffectMark);						mEffectColors.Add(c);					}					index += 10;					return true;				}			}		}		// 特殊控制字符，不支持嵌套		if (text[index + 2] == ']')		{			switch (ctrlchar)			{				case '[':	// [[]					index += 2;					return false;				case 'b':	// [b]					bold = true;					index += 3;					return true;				case 'i':	// [i]					italic = true;					index += 3;					return true;				case 'u':	// [u]					underline = true;					index += 3;					return true;				case 's':	// [s]					strike = true;					index += 3;					return true;				case 'd':   // [d]					ignoreColor = true;					index += 3;					return true;			}		}		if (index + 4 &gt; length) return false;		// 特殊控制字符，不支持嵌套		if (text[index + 3] == ']')		{			char ch0 = text[index + 1];			char ch1 = text[index + 2];			if (ch0 == '/')			{				switch (ch1)				{					case 'b':   // [/b]						bold = false;						index += 4;						return true;					case 'i':   // [/i]						italic = false;						index += 4;						return true;					case 'u':   // [/u]						underline = false;						index += 4;						return true;					case 's':   // [/s]						strike = false;						index += 4;						return true;					case 'd':   // [/d]						ignoreColor = false;						index += 4;						return true;				}			}			else			{				// 控制alpha				if (IsHex(ch0) &amp;&amp; IsHex(ch1))				{					int a = (NGUIMath.HexToDecimal(ch0) &lt;&lt; 4) | NGUIMath.HexToDecimal(ch1);					mAlpha = a / 255f;					index += 4;					return true;				}			}		}		if (index + 5 &gt; length) return false;		if (text[index + 4] == ']')		{			char ch0 = text[index + 1];			char ch1 = text[index + 2];			char ch2 = text[index + 3];			if (ch0 == 's' &amp;&amp; ch1 == 'u' &amp;&amp; ch2 == 'b') // [sub]			{				sub = 1;				index += 5;				return true;			}			else if (ch0 == 's' &amp;&amp; ch1 == 'u' &amp;&amp; ch2 == 'p') // [sup]			{				sub = 2;				index += 5;				return true;			}		}		if (index + 6 &gt; length) return false;		if (text[index + 5] == ']')		{			char ch0 = text[index + 1];			if (ch0 == '/')			{				char ch1 = text[index + 1];				char ch2 = text[index + 2];				char ch3 = text[index + 3];				if (ch1 == 's' &amp;&amp; ch2 == 'u') 				{					if (ch3 == 'b')		// [/sub]					{						sub = 0;						index += 6;						return true;					}					else if (ch3 == 'p') // [/sup]					{						sub = 0;						index += 6;						return true;					}				}				else if (ch1 == 'u' &amp;&amp; ch2 == 'r' &amp;&amp; ch3 == 'l') // [/url]				{					index += 6;					return true;				}			}		}		// 网址链接，不固定位置的结束符 [url=www.baidu.com]要显示的文本[/url]		if (text[index + 1] == 'u' &amp;&amp; text[index + 2] == 'r' &amp;&amp; text[index + 3] == 'l' &amp;&amp; text[index + 4] == '=')		{			int closingBracket = text.IndexOf(']', index + 4);			if (closingBracket != -1)			{				index = closingBracket + 1;				return true;			}			else			{				index = text.Length;				return true;			}		}		return false;	}</code></pre><p><br></p><p>然后从UILabel的ApplyShadow中对 NGUIText.mEffectColorMark 和 NGUIText.mEffectColors 两个结果处理顶点再制</p><pre><code>public void ApplyShadow (BetterList&lt;Vector3&gt; verts, BetterList&lt;Vector2&gt; uvs, BetterList&lt;Color32&gt; cols, int start, int end, float x, float y){    ...    int maxMark = NGUIText.mEffectColorMark.size;		int maxColor = NGUIText.mEffectColors.size;		int dealMark = 0;		int finisCnt = 0, dealColorIndex = -1;		for (int i = start; i &lt; end; ++i)		{			verts.Add(verts.buffer[i]);			uvs.Add(uvs.buffer[i]);			cols.Add(cols.buffer[i]);			Vector3 v = verts.buffer[i];			v.x += x;			v.y += y;			verts.buffer[i] = v;			int mark = i - start + 1;			if (dealMark &lt; maxMark)			{				if (NGUIText.mEffectColorMark[dealMark] == -mark)				{					if (finisCnt &lt;= maxColor &amp;&amp; finisCnt &lt; dealColorIndex)					{						// 使用上一个颜色						var ecol = NGUIText.mEffectColors[dealColorIndex - finisCnt - 1];						ecol.a = c.a;						col = ecol;					}					else					{						col = c;					}					++dealMark;					// 结束一个颜色，相当于pop掉一个颜色					++finisCnt;				}				if (NGUIText.mEffectColorMark[dealMark] == mark)				{					// 生成颜色					var ecol = NGUIText.mEffectColors[++dealColorIndex];					++dealMark;					ecol.a = c.a;					col = ecol;				}			}			Color32 uc = cols.buffer[i];			if (uc.a == 255)			{				cols.buffer[i] = col;			}			else			{				Color fc = col;				fc.a = (uc.a / 255f * c.a);				if (QualitySettings.activeColorSpace == ColorSpace.Linear) fc.a = Mathf.GammaToLinearSpace(fc.a);				cols.buffer[i] = fc;			}		}}</code></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'NGUI','扩展','BBCode'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>