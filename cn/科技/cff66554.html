<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>深入浅出数据库索引 | 极客快訊</title><meta property="og:title" content="深入浅出数据库索引 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/413ce62658ef4b99963ef4043863560e"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cff66554.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cff66554.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cff66554.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cff66554.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cff66554.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cff66554.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cff66554.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cff66554.html><meta property="article:published_time" content="2020-11-14T21:02:06+08:00"><meta property="article:modified_time" content="2020-11-14T21:02:06+08:00"><meta name=Keywords content><meta name=description content="深入浅出数据库索引"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/cff66554.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>深入浅出数据库索引</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>一、索引的常见模型</strong></p><p><strong>1. 哈希表</strong></p><p>是键值对（key-value）存储结构，只要根据 key 就可以找到 value。</p><p>可以理解为一个数组，对 key 进行哈希计算，换算成一个确定的位置，把 value 放入此位置。</p><p>因为存储hash冲突的情况，多个value可能在同一个位置上，使用链表，后来的就追加到链表中。</p><p>例如存储身份证号和名字的信息：</p><div class=pgc-img><img alt=深入浅出数据库索引 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/413ce62658ef4b99963ef4043863560e><p class=pgc-img-caption></p></div><p>这种结构只适用于 <strong>等值查询 </strong>场景，如果要找某个区间的用户就需要全部扫描一遍了。</p><p><strong>2. 有序数组</strong></p><div class=pgc-img><img alt=深入浅出数据库索引 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/82855fb7d7284978969e5d60ae0d732b><p class=pgc-img-caption></p></div><p>按照身份证号递增的顺序保存。</p><p>有序数组非常适合 <strong>等值查询和范围查询 </strong>。</p><p>例如查找 [ID_X, ID_Y] 内的，先用二分法找到 ID_X，然后向右遍历，直到找到大于 ID_Y 的就结束了。</p><p>有序数组的优势是查询效率高，缺点是更新麻烦，插入一个记录就需要挪动后面所有的记录，效率低。</p><p>有序数组索引只适用于 <strong>静态存储引擎 </strong>，不会修改的数据情况。</p><p><strong>3. 搜索树</strong></p><p>先看最经典的二叉树：</p><div class=pgc-img><img alt=深入浅出数据库索引 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fca6fd235a374042bfd7b0b02edd16e7><p class=pgc-img-caption></p></div><p>二叉树中，左儿子 &lt; 父节点，父节点 &lt; 右儿子。</p><p>例如查找 ID_2，路径就是：</p><p>UserA -> UserC -> UserF -> User2</p><p>二叉树搜索效率最高，但实际数据库却不适用二叉树，因为索引是需要写到磁盘上的，例如一棵100万节点的二叉树，高度是20，一次查询需要访问20个数据块，从磁盘随机读一个数据块需要10ms左右的寻址时间，那么这个查询就需要200ms，很慢了。</p><p>所以需要使用N叉树，每个节点可以有多个儿子，儿子间从左到右递增，这样可以让查询过程访问尽量少的数据块儿。</p><p><strong>二、InnoDB 索引</strong></p><p><strong>1. 为什么使用 B+ tree 索引模型？</strong></p><p>例如插入数据：1,a,b,c,d,e。</p><p>二叉树的结构：</p><div class=pgc-img><img alt=深入浅出数据库索引 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/de912d95b37e422b82648e6d001d0ae2><p class=pgc-img-caption></p></div><p>红黑树的结构：</p><div class=pgc-img><img alt=深入浅出数据库索引 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9b9a6e40008a41c39809607213a25598><p class=pgc-img-caption></p></div><p>B+ tree 的结构：</p><div class=pgc-img><img alt=深入浅出数据库索引 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dd3f30155c5043edbf37eabd067c8f74><p class=pgc-img-caption></p></div><p>二叉树上面说过，效率太低，高度完全不可控，红黑树优化了不少，但高度仍然不可控，B+ tree 的高度恒定，而且只在叶子节点中存储数据，叶子节点间也是顺序链接的，做范围查找时非常高效。</p><p><strong>2. 为什么建议使用自增主键？</strong></p><p>涉及到1个概念：页分裂。</p><p>插入时，如果新值比现有值都大，那么只需要在后面插入即可，否则需要挪动现有数据。</p><p>如果插入目标位置的数据页满了，就要申请新的数据页，并挪动数据。</p><p>所以自增ID能够连续申请页空间，提升空间的操作效率和利用率。</p><p><strong>三、MySQL 索引的3个重要概念</strong></p><p>例如有一个表：</p><div class=pgc-img><img alt=深入浅出数据库索引 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/34fd29698bdd4c08a7c7c304bbda33e4><p class=pgc-img-caption></p></div><p>有2个索引，ID 和 k。</p><div class=pgc-img><img alt=深入浅出数据库索引 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c95add4a6ac849868ef25b6622e66749><p class=pgc-img-caption></p></div><p>InnoDB 主键索引的叶子节点存储的是行数据，非主键索引的叶子节点存储的是主键。</p><p>查询 k 在 [3,5] 区间内的所有行数据：</p><pre>select * from T where k betweet 3 and 5</pre><p>在 k 索引树上找到符合条件的，得到 ID 值，回到 ID 索引树取得行数据。</p><p>回到主键索引搜索的过程称为 <strong>回表 </strong>。</p><p><strong>1. 覆盖索引</strong></p><p>上面的查询如果改为：</p><pre>select ID from T where k betweet 3 and 5</pre><p>只查询ID这个字段，那么只搜索 k 树索引即可，不需要回表了。</p><p>索引 k 已经覆盖了我们的查询需求，这种情况称为 <strong>覆盖索引 </strong>。</p><p>覆盖索引可以显著提升查询性能，所以做优化时可以考虑是否适合使用此方式。</p><p>例如用户表，有身份证号、姓名字段，身份证号是唯一的，建了一个索引。</p><p>如果业务中有根据身份证号搜索姓名的高频需求，就可以创建一个（ <em>身份证号+姓名</em> ）的联合索引，实现覆盖索引，即使增加了索引的维护成本也是值得的。</p><p><strong>2. 最左前缀原则</strong></p><div class=pgc-img><img alt=深入浅出数据库索引 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5b0d407ee1684b32a8f4ae33fd1b64a5><p class=pgc-img-caption></p></div><p>索引项是按照字段顺序排序的。</p><p>查询“张三”时，会快速定位到 ID_4，然后向后遍历需要的结果。</p><p>查询“张%”也可以用这个索引，定位到 ID_3，向后找，直到不满足条件为止。</p><p>所以，只要满足最左前缀就可以用到索引。</p><p>涉及到一个问题：如何安排索引内的字段顺序？</p><p>需要考虑 <strong>索引的复用能力 </strong>，如果通过调整顺序，可以少维护一个索引，那么这个顺序就是优先考虑的。</p><p><strong>3. 索引下推</strong></p><p>例如用户表有字段：ID,name,age,ismale …，建有一个索引（name,age）。</p><p>现在查询：</p><pre>select * from tuser where name like '张 %' and age=10 and ismale=1;</pre><p>MySQL5.6 之前，查询过程是：</p><p>根据索引找到以“张”开头的名字的ID，然后回表，进一步判断 age 和 ismale。</p><p>在 5.6 引入了 <strong>索引下推 </strong>，在索引中找到“张”开头的以后，先在索引中判断其 age 是否符合条件，因为 age 已经在索引中，不需要回表判断了，把 age 不符合要求的先过滤掉，然后再回表判断 ismale，这就减少了回表次数，提升了查询效率。</p><p>欢迎工作一到五年的Java工程师朋友们加入Java程序员开发： 721575865</p><p>群内提供免费的Java架构学习资料（里面有高可用、高并发、高性能及分布式、Jvm性能调优、Spring源码，MyBatis，Netty,Redis,Kafka,Mysql,Zookeeper,Tomcat,Docker,Dubbo,Nginx等多个知识点的架构资料）合理利用自己每一分每一秒的时间来学习提升自己，不要再用"没有时间“来掩饰自己思想上的懒惰！趁年轻，使劲拼，给未来的自己一个交代！</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'浅出','数据库','索引'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>