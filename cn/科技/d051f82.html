<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>如何诊断Java代码中常见的数据库性能热点问题？ | 极客快訊</title><meta property="og:title" content="如何诊断Java代码中常见的数据库性能热点问题？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/15217840990949360ecee7a"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d051f82.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d051f82.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d051f82.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d051f82.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d051f82.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d051f82.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d051f82.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d051f82.html><meta property="article:published_time" content="2020-10-29T20:58:59+08:00"><meta property="article:modified_time" content="2020-10-29T20:58:59+08:00"><meta name=Keywords content><meta name=description content="如何诊断Java代码中常见的数据库性能热点问题？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/d051f82.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>如何诊断Java代码中常见的数据库性能热点问题？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>如何应用的java性能诊断和优化？看两种西药处方。如果您有更好的疗效处方，请在评审区欢迎我们。</p><p>当我帮助一些开发商或建筑师分析和优化java应用程序的性能，关键不在于调整个人的方法来保存一个或两个微秒的执行时间。虽然对于某些软件来说，微秒的优化是非常重要的，但我不认为这是眼睛。在我2015年的数百个应用程序中进行了分析，发现大多数性能和可伸缩性问题都来自于不良的体系结构决策、帧错误配置、数据库访问模式、过度日志记录以及垃圾回收所造成的内存消耗过大造成的影响。</p><p>在我看来，性能工程的基础是通过大量的观察将关键的体系结构指标、可伸缩性度量和性能指标联系起来。通过分析各结构的结果和不同负载的性能，找出系统中存在的回归缺陷或瓶颈。下图中的仪表板用作示例：</p><p><img alt=如何诊断Java代码中常见的数据库性能热点问题？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15217840990949360ecee7a></p><p>通过关联系统负载、响应时间和SQL语句执行次数，可以得到一些性能工程问题的根本原因。</p><p>顶层的称为“层分解”图，它显示了应用程序中每个逻辑组件的总执行时间，如Web服务、数据库访问、业务逻辑、Web服务器等。红色部分表示在后端Web服务上花费的时间，很明显这里产生了一个组件热点。</p><p>同时，我们也可以发现Web服务不受异常负载的影响，因为从第二个图中，应用程序处理的请求数量相对稳定。一般来说，大部分的响应时间都是在数据层中消耗的，但这并不意味着数据库本身是慢的！我理解低效的数据库访问常常是性能不佳的主要原因，因此通常将其组合起来分析SQL语句执行的次数。在本例中，可以清楚地看到它与大多数响应时间的峰值有关。</p><p>我观察到的最常见的模式是糟糕的数据库访问模式，除了服务调用、太细粒度共享坏数据访问共享、过度日志记录、垃圾收集和内存泄漏造成的崩溃以及大量的对象创建效果或应用程序。</p><p>可选的诊断工具</p><p>在本文中，我将重点讨论数据库问题，因为我非常确信您的所有应用程序都是由这些访问模式之一造成的。你可以选择各种性能诊断、跟踪或APM的工具在市场上，但我的选择是自由的dynaTrace个人许可证。Java itself also provides a variety of excellent tools, such as Java Mission Control, and so on. 许多提供数据访问功能的框架经常通过其日志输出提供各种诊断选项，如Hibernate或Spring，等等。</p><p>在这些跟踪工具的使用，通常不需要对代码做任何修改，因为他们使用JVMTI（JVM工具界面）捕捉各级代码级别的信息，甚至可以跨远程呼叫跟踪，这是分布式的（微）是非常实用的应用服务。您所要做的就是修改JVM引导命令行选项来加载这些工具。</p><p>一些工具的开发人员还提供了与IDE的集成，您只需简单地在运行时显示“打开XYZ性能诊断”即可。我在YouTube上制作了一个简单的视频指南，演示如何跟踪Eclipse中启动的应用程序。（https://www. youtube.com/watch？V = unrey8wfq-m和清单= plqt2rd0eew1bmdn54e2_m2uvbhm_wxy_6 &指数= 14）</p><p>查找数据库的性能热点</p><p>即使您发现应用程序的响应时间过长的主要原因是数据库，也不要轻易地指责数据库和DBA。数据库繁忙的原因可能如下：</p><ul class=list-paddingleft-2><li><p>数据库的使用效率太低：错误的查询设计，糟糕的应用程序逻辑，以及数据访问框架的不正确配置。</p></li><li><p>错误的数据库设计和数据结构：表关联、慢速存储视图、缺少或不正确的索引、过期的表统计信息</p></li><li><p>不恰当的数据库配置，如内存、磁盘、表空间、连接池等。</p></li></ul><p>在本文中，我将重点讨论如何最小化在应用程序端访问数据库所消耗的时间。</p><p>诊断不良的数据库访问模式</p><p>当我诊断一个问题的应用程序时，我通常检查几个数据库访问模式。我将逐一分析应用程序请求，并将这些问题放在下面的“DB问题模式”分类表中：</p><ul class=list-paddingleft-2><li><p>过多的SQL执行（多表）：执行大量（大于500）不同的SQL语句</p></li><li><p>n + 1查询问题（n + 1查询）：同一SQL语句的多个（大于20）执行</p></li><li><p>单个SQL语句执行缓慢（慢单SQL）：单个SQL语句执行时间占响应时间的80%以上。</p></li><li><p>数据驱动的问题（数据驱动）：相同的请求，因为不同的输入参数，执行不同的SQL语句</p></li><li><p>数据库繁忙（数据库重）：数据库执行的总时间占总响应时间的60%以上。</p></li><li><p>unpreprocessed声明（准备报告）：声明不预处理时相同的SQL执行</p></li><li><p>连接池资源利用（池耗竭）：因为连接太长时间（getConnection超过executestatement）</p></li><li><p>无效连接池访问（低效池访问）：访问连接池数太高（调用getConnection超过50%的executestatement电话号码）。</p></li><li><p>数据库服务服务器过载（重载数据库服务器）：来自各种应用程序的过度请求，导致数据库服务器超载</p></li></ul><p>示例1：自主设计的O / R映射生成了太多SQL</p><p>我的第一个例子是一个Web应用程序，它提供建筑物中会议室的信息。会议室的信息保存在数据库中。每当用户生成会议室信息报告时，就调用自定义数据访问层访问数据库。</p><p>在分析单个请求时，我总是检查所谓的事务流（事务流）。事务流是显示应用程序处理请求过程的可视化选项。对于会议室信息报告的要求，可以看出，请求首先转到Web服务器层（图左），然后进入应用服务层（图），然后启动对数据层的调用（图右）。这些层之间的“链接”显示了这些层之间的交互数量，例如单个请求执行了多少SQL查询。</p><p>从这个屏幕中，我们可以立即发现导致问题的前两种模式，即过多的SQL执行模式和数据库繁忙模式。让我们来分析一下。</p><p>很容易看出，这个请求生成大量SQL语句，并具有繁忙的数据库效应：它总共执行了24889个SQL语句！完成整个执行过程花费了40.27秒（占整个请求时间的66.51%）！</p><p>如果我们分析单个SQL语句，我们会看到这个请求的另一个问题，即，n + 1查询和低效的连接池访问。</p><p>通过优化数据库索引，无法解决这种不良访问模式。</p><p>我已经见过这个问题很多次了。应用程序的逻辑需要在一个对象列表上迭代，但它不能选择紧急加载的方式。它使用延迟加载。这种选择可能来自于O／R映射框架，如Hibernate或Spring，或者来自自开发的框架，如上面所示。本例采用了一种自行开发的开发方式。它将加载每个会议室对象，并通过独立的SQL查询获取每个会议室的所有属性。</p><p>每个SQL查询在连接池的JDBC连接中执行，然后在每个查询完成后返回。这也解释了为什么请求将产生12444组列出的操作，因为Sybase的JDBC驱动程序将提交这一请求每次请求连接到连接池。这就是问题所在！其它的JDBC驱动程序可能不会产生组列出的呼唤。你可以检查调用getConnection的数量，这也反映了这个问题。</p><p>对于n + 1查询本身，使用连接查询可以很容易地避免这个问题。在这个会议室和属性的示例中，可以使用以下连接查询：</p><pre>select r.*, p.*from meeting_rooms as rinner join room_properties as p on p.room_id = r.room_id</pre><p>结果是整个执行过程只有1个查询执行时间，不超过12000次！它也消除了12000通电话访问“列出”。</p><p>示例2：错误的Hibernate配置会导致太多SQL执行</p><p>据我所知，Hibernate或其他O／R映射器有很多用户。我想提醒您的是，O／R映射器提供的延迟加载和贪婪加载选项以及各种缓存层存在的原因。对于特定的用例，您需要确保您正确地使用了这些特性和选项。</p><p>在下面的示例中，延迟加载不是一个好的选择，因为加载2000个对象及其属性可能导致4000多个SQL查询。考虑到我们总是需要获取所有对象，最好的方法是加载这些对象，然后考虑缓存它们。前提是这些对象不会经常更改。</p><p>当使用诸如Hibernate或Spring的O／R映射器时，需要选择正确的加载和缓存选项。你需要了解他们是如何幕后工作的。</p><p>大多数O／R映射将通过日志记录提供优秀的诊断选项，并且还可以查看在线社区中的内容，以了解各种最佳实践。建议您阅读一系列的博客文章，Alois Reitbauer写的，谁做了它的一个很深的研究，在早期的冬眠。在本系列中，他强调了如何有效地使用缓存和加载选项。</p><p>示例3：自定义DB访问代码中使用的语句未经过预处理。</p><p>当数据库引擎完成对某条SQL语句的解析，并创建了数据访问的执行计划后，该结果会被保存在数据库中的一个缓存区域中以便重用，而无需重新解析这一语句（语句解析是数据库中最耗费CPU时间的操作）。用于在缓存中找到某个查询的键是语句的全文本。这也意味着，如果你调用了1000次相同的语句，却为其传了100个不同的参数值（例如where语句中的值），那么在缓存中就会产生1000个不同的条目，而使用了新参数的第1001次查询也必须被再次解析。这种工作方式非常低效。</p><p>因此，我们提出了预处理语句的概念：在预处理和解析之后，将一个句子存储在缓存中，并表示占位符中的变量。在这句话的实际执行，这些占位符将实际值替换，而无需解决的陈述了一遍，以便我们能找到直接从缓存执行计划。</p><p>数据库访问框架通常在这一点上做得很好，并且对查询语句进行预处理。但在自定义代码中，我发现开发人员常常忽略了这一点。在下面的示例中，只有一小部分SQL执行预处理过程：</p><p><img alt=如何诊断Java代码中常见的数据库性能热点问题？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15217840991577799cf51a8></p><p>通过对SQL执行的SQL执行已预处理的数量，unpreprocessed数据库访问是发现问题。</p><p>如果你要开发自己的数据库访问代码，再确认一下，你叫preparestatement正确。例如，如果你调用一个查询超过1次，最好是常常可以使用预处理语句。如果您选择使用框架访问数据，请再次确认这些框架的行为，在优化和执行生成的SQL时可以选择哪些配置选项。最简单的方法是实现这一监控时代executestatement和preparestatement数执行。如果为每个SQL查询重复相同的监视，很容易找到优化热点。</p><p>例4：由于一个耗时的后端SQL报告执行，连接池不能有效调整。</p><p>我经常发现一些应用程序使用默认连接池大小，如每个池的10或20个连接。开发人员总是忽略连接池大小的优化，因为它们不进行必要的大规模负载测试，也不知道有多少用户将使用这些新功能，甚至不知道并行DB访问将导致什么结果。也可能是从预发布环境到生产环境的部署，当连接池的配置信息丢失时，这将导致生产环境中应用服务器中的默认配置。</p><p>通过JMX的索引信息，便于监视连接池的使用。每个应用服务器（Tomcat、JBoss，Websphere，等等）将提供这些指标，但一些服务器需要你明确开启此功能。下图显示了一组服务器连接池的使用。您可以看到，在三个应用服务器中的三个中，“活动连接的数量”达到了最大值。</p><p>确保您正确地调整了连接池的大小，并且不要使用与您期望的负载不匹配的默认设置。</p><p>这个问题的根本原因不是访问量的峰值。在本文的开头，系统加载/响应时间/数据库执行时间表明应用程序没有生成特殊的流量峰值。据发现，每天下午2点，一个运行报告的计划在这个时候成立。它需要执行许多具有长运行时间的更新语句，每个语句使用不同的连接。这将在几分钟内阻塞其他连接，导致应用程序在正常流量下的性能问题。因为用户的请求不能得到数据库的连接。</p><p>个别SQL执行阻塞其他连接几分钟，造成池资源耗尽的问题。</p><p>如果您已经了解到有些请求将挂断连接很长一段时间，您可以选择以下选项：</p><ul class=list-paddingleft-2><li><p>将这些请求发送到单独的服务器，以避免影响其他用户</p></li><li><p>仅当它不影响其他人的时间时重新配置其执行时间。</p></li><li><p>增加连接池的大小，以确保在正常访问时有足够的连接可用。</p></li></ul><p>但是，首先必须确保这些查询是优化的。对SQL查询执行计划进行分析，以找出哪些操作是最耗时的。今天，大多数APM工具允许您以某种方式获得SQL语句的执行计划。如果没有可用的工具，最简单的方法是使用数据库命令行工具，或者咨询DBA，以便他可以帮助您生成执行计划。</p><p>通过学习SQL查询执行计划来优化SQL语句</p><p>执行计划可以显示DB引擎处理SQL语句的方式。SQL语句执行缓慢的原因是多种多样的。它不局限于缺乏索引或使用索引的方式。在许多情况下，它是由设计、结构或连接查询引起的。如果您不是SQL专家，您可以向DBA或SQL请求帮助。</p><p>生产环境中负载测试和监视的技巧和技术</p><p>除了分析所有请求并指出这些问题之外，我还将重点关注应用程序在负载下的长期趋势。除了我在本文开头展示的仪表板，我还将指出数据驱动行为的变化，并验证数据缓存操作的正确性。</p><p>检查点1：由于数据缓存的存在，对DB的访问数量应该逐渐减少。</p><p>下面的图表显示SQL语句执行的平均时间（绿色）和SQL语句执行的总次数（蓝色）。我们对应用程序进行了两小时的性能测试，以使负载保持在较高的水平。我期望的结果是，平均次数逐渐减少，总次数趋于稳定。因为，根据我的假设，从DB获得的大部分数据是静态的，或者缓存在不同的层中。</p><p>如果应用程序不满足这种期望，那么它可能是数据驱动的性能问题或缓存问题。</p><p>假设，正如我前面所展示的，在应用程序中存在一个常见的n + 1查询问题。然后，随着DB中最终用户生成的数据数量的增加，应用程序生成的SQL平均数量也会增加，因为这些查询返回的数据也会增加。因此，一定要注意这些数字。</p><p>检查点2：按类别指出SQL访问模式</p><p>示例4显示了每天下午二点执行后台报告所造成的问题。类似地，我还将注意sql访问随时间变化的模式。我的关注点不仅包括总执行时间，还包括选择、插入、更新和删除执行次数。因此，我会指出一些特殊的活动是否会在一定的时间内进行，例如通过后台工作来更新大量的数据。</p><p>通过观察总执行时间和选择、插入、更新和删除执行次数来了解应用程序的数据库访问行为。</p><p>为大量更新操作执行批处理作业需要一定的时间来完成，特别是对于包含大量行的表。如果整个表被锁定，则此表的其他请求，即使只有其中的一些请求被更新，也必须等待释放锁。您应该考虑在没有其他用户的在线时间的情况下运行这些任务，或者实现一些不同的锁定逻辑，以实现单行的锁定、更新和释放操作。</p><p>检查点3：数据库实例的运行状态</p><p>在本文中，我重点对数据库性能问题大多数与数据库服务器本身的分析速度慢是无关紧要的，但主要由最糟糕的数据库访问模式的使用（N + 1的查询，无需预处理语句等）应用程序代码或配置错误（连接池访问、数据驱动造成的低效的问题）。</p><p>但是如果我们完全忽视数据库本身，那是不明智的。因此，我总是检查关键数据库性能指标。大多数的数据库将通过特殊的系统性能表提供了丰富的信息，如Oracle将提供一些v$表和视图，访问关键绩效指标数据库（会话、等待时间、分析时间、执行时间、等）或信息表锁和运行时间慢的SQL，这些信息共享数据库实例，每个应用程序。</p><p>我通常看两个仪表盘我当数据库健康检查，你可以从这里看到这些性能指标数据表。</p><p>观察数据库是否处于健康状态，或受应用程序实例应用程序所产生的过度负载的影响。</p><p>通过使用诸如表锁之类的信息，可以确定执行中的SQL语句是否对服务器甚至对应用程序产生负面影响。</p><p>连续集成过程中数据库度量的自动检测</p><p>在我向您介绍一些关键数据库指标和用例的新思想之前，我希望首先弥补一个遗漏的主题，这就是我们应该考虑的，自动化。</p><p>我建议您不要手动执行这些检查步骤，而是通过连续集成工具检查这些指标，并将此步骤与单元测试、集成测试、REST API或其他功能测试步骤相结合。如果您设计了一组用于检查REST API或新特性的各种功能的测试用例，为什么不在每次测试执行期间捕获这些指示器呢？这种方法可以带来以下好处：</p><ol class=list-paddingleft-2><li><p>让代码评审过程关注于这些度量，而不是一遍又一遍地阅读每一行代码。</p></li><li><p>如果代码检查导致此问题，则发出通知。</p></li></ol><p>下面的屏幕截图显示了每次构建和每次测试时对这些指标的跟踪，并在异常情况下给出警告。您可以将这些指标集成到您的构建管道中，并且当代码更改受到影响时，您可以通过通知信息了解情况，然后立即修复它，并避免在将代码发布到生产环境时发生系统崩溃。</p><p>将这些指标添加到您的持续集成过程中，并观察指标的变化，以自动识别各种不良数据库访问模式！</p><p>性能问题远远超过数据库。</p><p>在这篇文章中，我们关注数据库中的热点问题。但在我的工作中，我也发现了其他领域的许多性能问题。在2015，我参加了一个项目，将集成的应用程序迁移到一个（微）服务中，在那里发现了一个巨大的峰值问题。这个问题类似于我们分析过的一些模式，比如N + 1查询问题，因为某个示例会议会调用几百次特定的后端服务。</p><p>在大多数情况下，这个问题是由不良的界面设计造成的，并没有考虑到当一个本地调用方法执行在Docker容器或云计算环境。网络问题将突然出现，包括通过网络传输的信息和新的连接池（这意味着您需要考虑线程和套接字）。这些是你必须处理的问题。</p><p><img alt=如何诊断Java代码中常见的数据库性能热点问题？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15217864063161433d1f775></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'诊断','Java','代码'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>