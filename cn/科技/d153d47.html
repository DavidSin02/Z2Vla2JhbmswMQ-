<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>详解oracle嵌套循环及实例说明 | 极客快訊</title><meta property="og:title" content="详解oracle嵌套循环及实例说明 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/d3a69f34e217494688aa91a8c14e4f41"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d153d47.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d153d47.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d153d47.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d153d47.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d153d47.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d153d47.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d153d47.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d153d47.html><meta property="article:published_time" content="2020-10-29T20:51:17+08:00"><meta property="article:modified_time" content="2020-10-29T20:51:17+08:00"><meta name=Keywords content><meta name=description content="详解oracle嵌套循环及实例说明"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/d153d47.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>详解oracle嵌套循环及实例说明</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>概述</h1><p>嵌套循环连接处理的两个数据集被称为外部循环（outer loop，也就是驱动数据源，driving row soulce ）和内部循环〔 inner loop ）。外部循环为左子节点，内部循环为右子节点。当外部循环执行一次的时候，内部循环需要针对外部循环返回的每条记录执行一次。</p><hr><h1>处理过程</h1><p>外部循环称为外表或者驱动表，而内部循环称为内表或者被驱动表。</p><div class=pgc-img><img alt=详解oracle嵌套循环及实例说明 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d3a69f34e217494688aa91a8c14e4f41><p class=pgc-img-caption>嵌套循环连接处理过程</p></div><p>嵌套循环连接有以下几点特征：</p><p>口左子节点（外部循环）只会执行一次，而右子节点（内部循环）一般会执行很多次。</p><p>口在所有数据处理完之前，就可以返回结果集的第一条记录。</p><p>口可以有效利用索引来处理限制条件与连接条件。</p><p>口支持所有类型的连接。</p><hr><h1><strong>两表连接</strong></h1><p>下面是个简单的两表嵌套循环连接的执行计划。同时也描述了如何使用提示1eading 与use_nl来强制使用嵌套循环连接。Leading提示要求先访问表tl ，也就是，它指定了哪张表作为外部循环表使用。use_nl提示指定了具体使用哪种连接方法来将内部循环返回的数据（表t2 ）与表t1 连接起来。有必要指出的是：usenl 提示并没有引用表t1 。</p><pre>SELECT /* + leading (t1) use_nl(t2) full(t1) full(t2）*/ * FROM t1 ,t2 WHERE tl.id =t2.id AND tl.n=19</pre><div class=pgc-img><img alt=详解oracle嵌套循环及实例说明 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/afff4c9c93e8450dbe4e595a7cab0520><p class=pgc-img-caption></p></div><p>NESTED LOOPS操作是一种相关联合型操作。它意味着是<span>第二个子</span>节点（内部循环）的执行是由第一个子节点（外部循环）控制的。在这个例子中，执行计划的执行过程可以总结如下。</p><p>口 通过全表扫描访问表t1 的所有记录，访问中应用限制条件n = 19 过滤数据口</p><p>口 前面一个步骤返回多少条记录，就在表t2 上执行多少次全表扫描。</p><p>无疑，当操作2 返回的记录超过1 条时，这种执行计划就不是很有效了，因此，查询优化器几乎从来不会选择它。正是因为这个原因，才必须指定两个访问提示（full）来强制查询优化器使用这个执行计划。另一方面，如果外部循环只返回一条记录，并且内部循环的选择性也很高，对表t2 进行全表扫描可能也不错。为了展示这一点，下面我们在表t1 的n 字段卜创建一个唯一索引：</p><pre>CREATE UNIQUE INDEX t1_n ON t1（n） </pre><p>有了这个索引以后，前面的语句就以下面的执行计一划执行了。由于操作3 （INDEX UNIQUE SCAN)的缘故，可以确保内部循环只会被执行一次。</p><pre>SELECT /* + leading (t1) use_nl(t2) index(t1) full(t2）*/ * FROM t1 ,t2 WHERE tl.id =t2.id AND tl.n=19</pre><div class=pgc-img><img alt=详解oracle嵌套循环及实例说明 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d8695ced7cc14268a2109882c0967875><p class=pgc-img-caption></p></div><p>如果内部循环的选择性很低，对内部循环适应索引扫描就是一个较好的选择。由于嵌套循环连接是相关联合型操作，对内部循环来讲，这个地方也可能利用到连接条件。例如，在下面的执行计划中，操作5就是利用操作3的返回值t1.id做了索引查找。</p><pre>SELECT /* + leading (t1) use_nl(t2) index(t1) index(t2）*/ * FROM t1 ,t2 WHERE tl.id =t2.id AND tl.n=19</pre><div class=pgc-img><img alt=详解oracle嵌套循环及实例说明 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c578eb4eb8934237a2d629a3a2b634d1><p class=pgc-img-caption></p></div><p>通过建立2个索引，使得性能得到最好的优化。嵌套循环适合2个选择性低的效率数据量的选择，到数据量大的时候优化器会默认选择hash join 连接，除非我们手动选择提示，并且通过索引来达到很好的效率。</p><p><strong>总的来讲，如果内部循环会执行多次，只有具有好的选择性的访问路径以及导致比较少的逻辑读的路径才有意义</strong></p><hr><h1><strong>四表连接</strong></h1><p>下面的执行计划是个典型的用嵌套循环连接实现的左深树。请注意各个表是如何通过索引进行访问的ordered 提示要求这些表按它们在FROM 子句中的顺序进行访问。use_nl提示要求后面的表与第一张表（或者前面一个操作的结果集）进行连接的时候使用嵌套循环连接。</p><pre>SELECT /* + ordered use_nl(t2 t3 t4)*/ t1.*,t2.*,t3.*,t4.* FROM t1,t2,t3,t4 WHERE t1.id = t2.t1_id AND t2.id =t3.t2_idAND t3.id =t4.t3_id AND t1.n = 19</pre><div class=pgc-img><img alt=详解oracle嵌套循环及实例说明 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/315274ea2c724503a97cf2662c36979b><p class=pgc-img-caption></p></div><p>这种执行计划的执行流程可以总结如下(不考虑使用行预取的情况):</p><pre>( 1）当读取第一条记录的时候（也就是说，不是当这条语句解析或者执行的时候），在应用了表t1 上的限制条件tl.n = 19 并取得第一条记录的时候，处理过程就开始了。( 2）表t2 基于表t1 找到的结果进行查找。数据库引擎会利用连接条件tl.id = t2.t1_id 来访问表t2。事实上．表t2 上没有任何限制条件。只有第一条满足连接条件的记录才会返回给上级操作。( 3）表t3 基于表t2 找到的结果进行查找数据库引擎也是利用连接条件t2.id =t3.t2_id 来访问表t3 。只有第一条满足连接条件的记录才会返回给上一级操作。( 4）表t4 基于表t3 找到的结果进行查找。这儿也一样，数据库引擎也是利用连接条件t3.id =t4.t3_id 来访问表t4 。满足条件的第一条记录会立即返回给客户端。( 5）后续的操作也是按照第一条记录样的行为来进行的。很明显，执行过程是在下一次匹配（也可能是表t4 里面匹配的第二条记录，如果有的话）的位置开始的。需要特别强调的是，满足条件的记录会在第一时间被返回给客户端。换句话讲，就是完全没有必要在返回第条记录之前完成整个执行过程。</pre><h1><strong>块预取</strong></h1><p>在一般情况下，当缓存没有命中的时候，基於单块处理（例如，rowid 访问、索引范围扫描）的访问路径会导致一个单块的物理读。对于嵌套循环连接来讲，特别是当有很多行数据需要处理的时候，效率会比较差。实际上很多时候，嵌套循环连接也会使用多个单块物理读来访问多个相邻的块。数据库引擎可以利用块预取功能来提高嵌套循环连接的效率。这种优化技巧的目的是，对与多个相邻的块使用一次多块物理读取，来代替多次单块物理读取。块预取对于表和索引都是适用的。无法通过查看执行计划来看出数据库引擎是否使用了块预取功能。唯一能够看到的方式是，查看服务器进程执行的物理读，特别是与物理读相关的等待事件。</p><p>口db file sequential read 是个与单块物理读取相关的事件。因此，如果这个事件出现，就意味着块预取要么没有被使用，要么是无法被使用（例如，由于请求的块己经在高速缓存中）。</p><p>口db file scattered read 是一个与多块物理读取相关的事件。因此．如果在～id 访问或者索引范围扫描中看到这个等待事件，就表明在使用块预取功能。</p><p>需要特别提示的是，我们无法控制块预取功能的使用。如何以及是否使用块预取功能是由数据库引擎决定的。</p><p>其他可选的执行计划可以用下面的执行计划来执行嵌套循环连接。</p><div class=pgc-img><img alt=详解oracle嵌套循环及实例说明 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f9f7c891685e415cb3b3d28aa9e13014><p class=pgc-img-caption></p></div><p>实际上，在Oracle 的最近几个版本中，只有当内部循环或者外部循环是基于唯一索引扫描（index unique scan ）的时候才会使用这种类型的执行计划。下面我们来看看，如果在列n 上的索引t1_n 如下面这样定义（为非唯一）时会如何：</p><pre>CREATE INDEX t1_n ON t1(n) </pre><p>当换成这个索引时，下面的执行计划将被采用。请注意，表t2 上的rowid 访问是处在不同的位置的．在前一个执行计划，它是在操作4 ，然而在后一个执行计划中，它是在操作1 。比较特别的是，row 记访问（操作1）的子操作是一个嵌套循环连接（操作2 ）。从我们的角度看，这两个执行计划做了同一件事。下面的这个执行计划可能是为了利用一些内部优化（比如块预取）。</p><div class=pgc-img><img alt=详解oracle嵌套循环及实例说明 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/bda360c189794e819b1024df3a909fcd><p class=pgc-img-caption></p></div><p>在oracle 11g 中，可能会使用下面的执行计划，而不是之前的那个。注意，虽然查询始终是一个两表连接，执行计划却含有两个嵌套循环连接！</p><div class=pgc-img><img alt=详解oracle嵌套循环及实例说明 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/661ea9e6ba2b422ea6ea6b1e1b46a778><p class=pgc-img-caption></p></div><hr><h1>oracle<strong>多结果集嵌套循环处理优化</strong></h1><pre>--性能差begin for a in (select id,name,sex,idcard from people) loop for b in (select id,name,sex,idcard from english) loop if a.idcard = b.idcard then --do something end if; end loop; end loop;end;</pre><p>优化后如下：</p><pre>--性能优：将多表合并成一个结果集，避免嵌套循环begin for a in (select p.id,p.name,p.sex,p.idcard from people p,english e where p.idcard = e.idcard) loop --do something end loop;end;</pre><hr><p>关于嵌套循环方面的内容就介绍到这了，后面会分享更多DBA方面内容，感兴趣的朋友可以关注下 ！</p><div class=pgc-img><img alt=详解oracle嵌套循环及实例说明 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/733be47f14bb4e12943f8473b48f1841><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'详解','oracle','循环及'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>