<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MySQL中是如何实现事务提交和回滚的？ | 极客快訊</title><meta property="og:title" content="MySQL中是如何实现事务提交和回滚的？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/dfic-imagehandler/0c6b8175-642c-44ff-8879-30667952a475"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1a1dec.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1a1dec.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d1a1dec.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1a1dec.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1a1dec.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d1a1dec.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d1a1dec.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1a1dec.html><meta property="article:published_time" content="2020-10-29T20:50:41+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:41+08:00"><meta name=Keywords content><meta name=description content="MySQL中是如何实现事务提交和回滚的？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/d1a1dec.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MySQL中是如何实现事务提交和回滚的？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>什么是事务</h1><div class=pgc-img><img alt=MySQL中是如何实现事务提交和回滚的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/dfic-imagehandler/0c6b8175-642c-44ff-8879-30667952a475><p class=pgc-img-caption></p></div><p style=text-align:start>事务是由数据库中一系列的访问和更新组成的逻辑执行单元</p><p style=text-align:start>事务的逻辑单元中可以是一条SQL语句，也可以是一段SQL逻辑，这段逻辑要么全部执行成功，要么全部执行失败</p><p style=text-align:start>举个最常见的例子，你早上出去买早餐，支付宝扫码付款给早餐老板，这就是一个简单的转账过程，会包含两步</p><ul><li>从你的支付宝账户扣款10元</li><li>早餐老板的账户增加10元</li></ul><p style=text-align:start>这两步其中任何一部出现问题，都会导致整个账务出现问题</p><ul><li>假如你的支付宝账户扣款10元失败，早餐老板的账户增加成功，那你就Happy了，相当于马云请你吃早餐了，O(∩_∩)O哈哈~</li><li>假如你的支付宝账户扣款10元成功，早餐老板的账户增加失败，那你就悲剧了，早餐老板不会放过你，会让你重新付款，相当于你请马云吃早餐了-_-?</li></ul><p style=text-align:start>事务就是用来保证一系列操作的原子性，上述两步操作，要么全部执行成功，要么全部执行失败</p><p style=text-align:start>数据库为了保证事务的原子性和持久性，引入了redo log和undo log</p><h1 class=pgc-h-arrow-right>redo log</h1><p style=text-align:start>redo log是重做日志，通常是物理日志，记录的是物理数据页的修改，它用来恢复提交后的物理数据页</p><div class=pgc-img><img alt=MySQL中是如何实现事务提交和回滚的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/6c36443c-981f-4c5e-8523-b65816ba489d><p class=pgc-img-caption></p></div><p style=text-align:start>如上图所示，redo log分为两部分：</p><ul><li>内存中的redo log Buffer是日志缓冲区，这部分数据是容易丢失的</li><li>磁盘上的redo log file是日志文件，这部分数据已经持久化到磁盘，不容易丢失</li></ul><p style=text-align:start>SQL操作数据库之前，会先记录重做日志，为了保证效率会先写到日志缓冲区中（redo log Buffer），再通过缓冲区写到磁盘文件中进行持久化，既然有缓冲区说明数据不是实时写到redo log file中的，那么假如redo log写到缓冲区后，此时服务器断电了，那redo log岂不是会丢失？</p><p style=text-align:start>在MySQL中可以自已控制log buffer刷新到log file中的频率，通过innodb_flush_log_at_trx_commit参数可以设置事务提交时log buffer如何保存到log file中，innodb_flush_log_at_trx_commit参数有3个值(0、1、2)，表示三种不同的方式</p><ul><li>为1表示事务每次提交都会将log buffer写入到os buffer，并调用操作系统的fsync()方法将日志写入log file，这种方式的好处是就算MySQL崩溃也不会丢数据，redo log file保存了所有已提交事务的日志，MySQL重新启动后会通过redo log file进行恢复。但这种方式每次提交事务都会写入磁盘，IO性能较差</li><li>为0表示事务提交时不会将log buffer写入到os buffer中，而是每秒写入os buffer然后调用fsync()方法将日志写入log file，这种方式在MySQL系统崩溃时会丢失大约1秒钟的数据</li><li>为2表示事务每次提交仅将log buffer写入到os buffer中，然后每秒调用fsync()方法将日志写入log file，这种方式在MySQL崩溃时也会丢失大约1秒钟的数据</li></ul><h1 class=pgc-h-arrow-right>undo log</h1><p style=text-align:start>undo log是回滚日志，用来回滚行记录到某个版本，undo log一般是逻辑日志，根据行的数据变化进行记录</p><p style=text-align:start>undo log跟redo log一样也是在SQL操作数据之前记录的，也就是SQL操作先记录日志，再进行操作数据</p><div class=pgc-img><img alt=MySQL中是如何实现事务提交和回滚的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/dfic-imagehandler/c22896dd-9c7d-4cdb-8912-8d6b59285be9><p class=pgc-img-caption></p></div><p style=text-align:start>如上图所示，SQL操作之前会先记录redo log、undo log到日志缓冲区，日志缓冲区的数据会记录到os buffer中，再通过调用fsync()方法将日志记录到log file中</p><p style=text-align:start>undo log记录的是逻辑日志，可以简单的理解为：当insert一条记录时，undo log会记录一条对应的delete语句；当update一条语句时，undo log记录的是一条与之操作相反的语句</p><p style=text-align:start>当事务需要回滚时，可以从undo log中找到相应的内容进行回滚操作，回滚后数据恢复到操作之前的状态</p><p style=text-align:start>undo日志还有一个用途就是用来控制数据的多版本（MVCC），在《InnoDB存储引擎中的锁》一文中讲到MVCC是通过读取undo日志中数据的快照来进行多版本控制的</p><p style=text-align:start>undo log是采用段(segment)的方式来记录的，每个undo操作在记录的时候占用一个undo log segment。</p><p style=text-align:start>另外，undo log也会产生redo log，因为undo log也要实现持久性保护</p><h1 class=pgc-h-arrow-right>总结一下</h1><p style=text-align:start>MySQL中是如何实现事务提交和回滚的？</p><ul><li>为了保证数据的持久性，数据库在执行SQL操作数据之前会先记录redo log和undo log</li><li>redo log是重做日志，通常是物理日志，记录的是物理数据页的修改，它用来恢复提交后的物理数据页</li><li>undo log是回滚日志，用来回滚行记录到某个版本，undo log一般是逻辑日志，根据行的数据变化进行记录</li><li>redo/undo log都是写先写到日志缓冲区，再通过缓冲区写到磁盘日志文件中进行持久化保存</li><li>undo日志还有一个用途就是用来控制数据的多版本（MVCC）</li></ul><p style=text-align:start>简单理解就是：</p><p style=text-align:start><strong>redo log是用来恢复数据的，用于保障已提交事务的持久性</strong></p><p style=text-align:start><strong>undo log是用来回滚事务的，用于保障未提交事务的原子性</strong></p><blockquote class=pgc-blockquote-abstract><p>作者：果子爸聊技术</p><p>原文链接：https://blog.csdn.net/pzjtian/article/details/107453356</p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'MySQL','中是','实现'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>