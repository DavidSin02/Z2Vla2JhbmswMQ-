<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>大神秘籍：windows中常见后门持久化方法总结 | 极客快訊</title><meta property="og:title" content="大神秘籍：windows中常见后门持久化方法总结 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/b9c9783734c64b909721ce17b334c0d3"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1b52cf4.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1b52cf4.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d1b52cf4.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1b52cf4.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1b52cf4.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d1b52cf4.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d1b52cf4.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1b52cf4.html><meta property="article:published_time" content="2020-10-29T21:12:02+08:00"><meta property="article:modified_time" content="2020-10-29T21:12:02+08:00"><meta name=Keywords content><meta name=description content="大神秘籍：windows中常见后门持久化方法总结"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/d1b52cf4.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>大神秘籍：windows中常见后门持久化方法总结</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right><strong>前言</strong></h1><p>当我们通过各种方法拿到一个服务器的权限的时候，我们下一步要做的就是后渗透了，而后门持久化也是我们后渗透很重要的一部分，下面我来总结一下windows下常见的后门持久化的方法</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b9c9783734c64b909721ce17b334c0d3><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>后门持久化</strong></h1><p>我的操作环境是：</p><p>无AV、管理员权限（提权、免杀等是后门持久化的铺垫，当然有的方法也并不是全部需要这些铺垫）</p><p>操作系统：win7，windows server 2008R2，xp</p><h1 class=pgc-h-arrow-right><strong>shift后门</strong></h1><p>这个是比较老的方式了，这里简单讲一下，在windows中有一些辅助功能，能在用户未登录系统之前可以通过组合键来启动它，类似的辅助功能有：</p><p>C:\Windows\System32\sethc.exe 粘滞键，启动快捷键：按五次shift键</p><p>C:\Windows\System32\utilman.exe 设置中心，启动快捷键：Windows+U键</p><p>在低版本的windows中，我们可以直接把setch.exe替换成我们的后门程序，下面我们把setch.exe替换为cmd.exe</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/577dd69e92704d09b614ad2b6a6cada7><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/89bec9faf5f445108ad342d34724349c><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>影像劫持</strong></h1><p>这个和shift后门差不多，只不过在低版本的windows中，我们可以简单地替换程序，但是在高版本的windows版本中替换的文件受到了系统的保护，所以这里我们要使用另外一个知识点：映像劫持。</p><p>"映像劫持"，也被称为"IFEO"（Image File Execution Options）</p><p>就是Image File Execution Options（其实应该称为"image Hijack"。）是为一些在默认系统环境中运行时可能引发错误的程序执行体提供特殊的环境设定。由于这个项主要是用来调试程序用的，对一般用户意义不大。默认是只有管理员和local system有权读写修改。</p><p><br></p><p>PS：来自百度百科</p><p><br></p><p>简单来说就是当目标程序被映像劫持时，当我们启动目标程序时，启动的是劫持后的程序而不是原来的程序</p><p>操作也很简单，在注册表的HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Option下添加一个项sethc.exe，然后在sethc.exe这个项中添加debugger键，键值为我们恶意程序的路径，如下图</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/351fb5ed745147d98336491adb931a7e><p class=pgc-img-caption></p></div><p><br></p><p>效果如下</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cf3e969ea35c4211990e992932aee06c><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>注册表自启动项</strong></h1><p>MSF的Persistence模块利用的就是写注册表自启动项来实现的，一般自启动项是这两个键：Run和RunOnce，两者的区别如下</p><p>Run：该项下的键值即为开机启动项，每一次随着开机而启动。</p><p>RunOnce：RunOnce和Run差不多，唯一的区别就是RunOnce的键值只作用一次，执行完毕后就会自动删除</p><p>常见注册表启动项键的位置：</p><p>用户级</p><p>\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</p><p><br></p><p>\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</p><p><br></p><p>系统级</p><p>\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</p><p><br></p><p>\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</p><p><br></p><p>\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run</p><p><br></p><p>\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\RunOnce</p><p><br></p><p>修改一下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/392bacff134144a5b3ad2ffb640e1e16><p class=pgc-img-caption></p></div><p><br></p><p>执行结果：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/025e6ba059ce404eb8b2cada3b2aef26><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>定时任务</strong></h1><p>windows下定时任务的命令有两个分别是：at和schtasks，他们两者主要区别是at命令在win7、08等高版本的windows中是不能将任务在前台执行的，也就是只会打开一个后台进程，而schtasks是将定时的任务在前台执行，下面我们逐个看看</p><p>at的一些参数</p><p>AT [\\computername] time [/INTERACTIVE]</p><p><br></p><p>[ /EVERY:date[,...] | /NEXT:date[,...]] "command"</p><p><br></p><p>at的执行如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/13ef99d634db401eb5b05374f3388411><p class=pgc-img-caption></p></div><p><br></p><p>schtasks一些参数：</p><p>schtasks /create /tn TaskName /tr TaskRun /sc schedule [/mo modifier] [/d day] [/m month[,month...] [/i IdleTime] [/st StartTime] [/sd StartDate] [/ed EndDate] [/s computer [/u [domain\]user /p password]] [/ru {[Domain\]User | "System"} [/rp Password]] /?</p><p>schtasks的执行如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0cb83767df9547e6abd313c0d4cbd543><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>用户登陆初始化</strong></h1><p>Userinit的作用是用户在进行登陆初始化设置时，WinLogon进程会执行指定的login scripts，所以我们可以修改它的键值来添加我们要执行的程序</p><p>注册表路径为：HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit，我们添加一个我们启动的程序，多个程序用逗号隔开</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/faa2a42464dc443b88993990e0e7ad89><p class=pgc-img-caption></p></div><p><br></p><p>效果如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/be1679bf9f314d0da390f2aac64d9715><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>Logon Scripts</strong></h1><p>Logon Scripts优先于av先执行，我们可以利用这一点来绕过av的敏感操作拦截</p><p>注册表路径为：HKEY_CURRENT_USER\Environment，创建一个键为：UserInitMprLogonScript，其键值为我们要启动的程序路径</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15e44091a53a41918334d38366d0f4b7><p class=pgc-img-caption></p></div><p><br></p><p>效果如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bf504a8da1544a689d6beb4c0ab60d42><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>屏幕保护程序</strong></h1><p>在对方开启屏幕保护的情况下，我们可以修改屏保程序为我们的恶意程序从而达到后门持久化的目的 其中屏幕保护的配置存储在注册表中，其位置为：HKEY_CURRENT_USER\Control Panel\Desktop，关键键值如下：</p><p>SCRNSAVE.EXE - 默认屏幕保护程序，我们可以把这个键值改为我们的恶意程序</p><p>ScreenSaveActive - 1表示屏幕保护是启动状态，0表示表示屏幕保护是关闭状态</p><p>ScreenSaverTimeout - 指定屏幕保护程序启动前系统的空闲事件，单位为秒，默认为900（15分钟）</p><p>设置如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2282d4a3e28e4024a286d5d825c9e249><p class=pgc-img-caption></p></div><p><br></p><p>效果图：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2e5e23a10ce2427582e6dfee13813e36><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>自启动服务</strong></h1><p>自启动服务一般是在电脑启动后在后台加载指定的服务程序，我们可以将exe文件注册为服务，也可以将dll文件注册为服务</p><p>为了方便起见我们可以直接用Metasploit来注册一个服务</p><p>meterpreter > run metsvc -A</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/4d65d6560f904ea8b9b9cf75cbb4d1e5><p class=pgc-img-caption></p></div><p><br></p><p>运行之后msf会在%TMP%目录下创建一个随机名称的文件夹，然后在该文件夹里面生成三个文件：metsvc.dll、metsvc-server.exe、metsvc.exe</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1423a329e6e948068333bbef8d1c6c88><p class=pgc-img-caption></p></div><p><br></p><p>同时会新建一个服务，其显示名称为Meterpreter，服务名称为metsvc，启动类型为"自动"，默认绑定在31337端口。</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c692a0adcad84038816baed1cc01a6a9><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/69fca3b4c50c4c498e36411b8db00ca8><p class=pgc-img-caption></p></div><p><br></p><p>如果想删除服务，可以执行</p><p>meterpreter > run metsvc -r</p><h1 class=pgc-h-arrow-right><strong>影子用户</strong></h1><p>影子用户顾名思义就是一个隐藏用户，只能通过注册表查看这个用户，其它方式是找不到这个用户的信息的</p><p>在用户名后面加一个$可以创建一个匿名用户，创建完毕后我们再把这个用户添加到administrator组</p><p>net user test$ test /add</p><p><br></p><p>net localgroup administrators test$ /add</p><p><br></p><p>可以看到net user是看不到我们创建的用户，但是计算机管理-用户和组中可以看到</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8f92bf4dd99648648f00277201838c39><p class=pgc-img-caption></p></div><p><br></p><p>所以这时候我们就需要修改一下注册表，其键位置为：HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users</p><p>注意：SAM键值默认是只能system权限修改的，所以我们要修改一下SAM键的权限，给予administrator完全控制和读取的权限</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6daa2970ebb4471badd0df460eae7179><p class=pgc-img-caption></p></div><p><br></p><p>然后我们将administrator用户对应的项中的F值复制到test$对应xiang中的F值，然后保存</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/dc74b91547eb448981e21b1053357bd4><p class=pgc-img-caption></p></div><p><br></p><p>然后我们将test$删除掉</p><p>net user test$ /del</p><p>然后再双击导出的注册表文件，然后我们再看一下</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f71ef04f83c14c5188074d9307a749ef><p class=pgc-img-caption></p></div><p><br></p><p>net user和计算机管理-用户和组中都查看不到用户了，但是我们可以用net user test$查看用户信息</p><p>这个时候我们再用net user test$ /del是删除不掉这个用户的，只能通过注册表来删除。</p><h1 class=pgc-h-arrow-right><strong>waitfor</strong></h1><p>关于waitfor手册中是这么解释的：</p><p>在系统上发送或等待信号。waitfor可用于跨网络同步计算机。</p><p>waitfor的语法</p><p>waitfor [/s &lt;Computer> [/u [&lt;Domain>\]&lt;User> [/p [&lt;Password>]]]] /si &lt;SignalName></p><p><br></p><p>waitfor [/t &lt;Timeout>] &lt;SignalName></p><p><br></p><p>参数解释：</p><p>/s &lt;Computer> 指定远程计算机的名称或IP地址，默认为本地计算机</p><p><br></p><p>/u [&lt;Domain>]&lt;user> 使用指定用户账户的凭据运行脚本。默认是使用当前用户的凭据。</p><p><br></p><p>/p &lt;Password> 指定/u参数中指定的用户账户的密码。</p><p><br></p><p>/si 发送指定激活信号。</p><p><br></p><p>/t 指定等待信号的秒数。默认为无限期等待。</p><p><br></p><p>&lt;SignalName> 指定等待或发送的信号，不区分大小写，长度不能超过225个字符</p><p><br></p><p>关于waitfor更多的信息可以看一下微软提供的手册：链接</p><p>我们来测试一下看看</p><p>waitfor test && calc 表示接收信号成功后执行计算器</p><p><br></p><p>waitfor /s 192.168.163.143 /u qiyou /p qiyou /si test</p><p><br></p><p>结果如下</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8e205d0df13b4e409b725b34dd74784a><p class=pgc-img-caption></p></div><p><br></p><p>但是这样只能执行一次，这对我们后门持久化很不利，所以我们得想办法让它持久化。</p><p>这里就要借用一下三好师傅的powershell脚本：链接，三好师傅的分析：链接</p><p>执行效果如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/4d059719d438415ca4e08b0a343c203e><p class=pgc-img-caption></p></div><p><br></p><p>该方法的优点就是能主动激活，但是缺点也明显就是只能在同一网段才能接收和发送激活信号、服务器重启之后就不行了。</p><h1 class=pgc-h-arrow-right><strong>CLR</strong></h1><p>CLR的简述（来自百度百科）</p><p>CLR(公共语言运行库,Common Language Runtime)和Java虚拟机一样也是一个运行时环境，是一个可由多种编程语言使用的运行环境。CLR的核心功能包括：内存管理、程序集加载、安全性、异常处理和线程同步，可由面向CLR的所有语言使用。并保证应用和底层操作系统之间必要的分离。CLR是.NET Framework的主要执行引擎。</p><p>需要注意的是CLR能够劫持系统中全部.net程序，而且系统默认会调用.net程序，从而导致我们的后门自动触发，这是我们后门持久化的一个好的思路，下面来实现一下</p><p>修改一下注册表，注册表路径：HKEY_CURRENT_USER\Software\Classes\CLSID\，新建子项{11111111-1111-1111-1111-111111111111}（名字随便，只要不与注册表中存在的名称冲突就行），然后再新建子项InProcServer32，新建一个键ThreadingModel，键值为：Apartment，默认的键值为我们dll的路径</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a97164c319a040cf9b84e2a569c41c34><p class=pgc-img-caption></p></div><p><br></p><p>然后在cmd下设置一下： <strong>PS：要注册为全局变量，不然只能在当前cmd窗口劫持.net程序</strong></p><p>SETX COR_ENABLE_PROFILING=1 /M</p><p><br></p><p>SETX COR_PROFILER={11111111-1111-1111-1111-111111111111} /M</p><p><br></p><p>然后执行一波，效果如下，可以看到已经成功劫持了</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5f7a25cba9e54aa783c9b6d344152dd2><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>Hijack CAccPropServicesClass and MMDeviceEnumerator</strong></h1><p>什么是COM（来自WIKI）</p><p>组件对象模型（英语：Component Object Model，缩写COM）是微软的一套软件组件的二进制接口标准。这使得跨编程语言的进程间通信、动态对象创建成为可能。COM是多项微软技术与框架的基础，包括OLE、OLE自动化、ActiveX、COM+、DCOM、Windows shell、DirectX、Windows Runtime。</p><p>这个和CRL劫持.NET程序类似，也是通过修改CLSID下的注册表键值，实现对CAccPropServicesClass和MMDeviceEnumerator的劫持，而系统很多正常程序启动时需要调用这两个实例，所以这个很适合我们的后门持久化。</p><p>经测试貌似64位系统下不行（或许是我姿势的问题），但是32位系统下可以，下面说一下32位系统利用方法：</p><p>在%APPDATA%\Microsoft\Installer\{BCDE0395-E52F-467C-8E3D-C4579291692E}\下放入我们的后门dll，重命名为test._dl</p><p>PS：如果Installer文件夹不存在，则依次创建Installer\{BCDE0395-E52F-467C-8E3D-C4579291692E}</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/13669190cd8a45d19846f9c60f42eda2><p class=pgc-img-caption></p></div><p><br></p><p>然后就是修改注册表了，在注册表位置为：HKCU\Software\Classes\CLSID\下创建项{b5f8350b-0548-48b1-a6ee-88bd00b4a5e7}，然后再创建一个子项InprocServer32，默认为我们的dll文件路径：C:\Users\qiyou\AppData\Roaming\Microsoft\Installer\{BCDE0395-E52F-467C-8E3D-C4579291692E}，再创建一个键ThreadingModel，其键值为：Apartment</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/28ea6331954046338bd6c6961a388f63><p class=pgc-img-caption></p></div><p><br></p><p>然后就是测试了，打开iexplore.exe，成功弹框</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8ea1bc9489d74124b89c7b362b06a1ca><p class=pgc-img-caption></p></div><p><br></p><p>PS：{b5f8350b-0548-48b1-a6ee-88bd00b4a5e7}对应CAccPropServicesClass，{BCDE0395-E52F-467C-8E3D-C4579291692E}对应MMDeviceEnumerator</p><h1 class=pgc-h-arrow-right><strong>劫持MruPidlList</strong></h1><p>在注册表位置为HKCU\Software\Classes\CLSID\下创建项{42aedc87-2188-41fd-b9a3-0c966feabec1}，再创建一个子项InprocServer32，默认的键值为我们的dll路径，再创建一个键ThreadingModel，其键值：Apartment</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/dea14fc720c14f3c8a4d0f1a9c9497f0><p class=pgc-img-caption></p></div><p><br></p><p>该注册表对应COM对象MruPidlList，作用于shell32.dll，而shell32.dll是Windows的32位外壳动态链接库文件，用于打开网页和文件，建立文件时的默认文件名的设置等大量功能。其中explorer.exe会调用shell32.dll，然后会加载COM对象MruPidlList，从而触发我们的dll文件</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/52a4e589f6dd4180a231a1c0f3a7b853><p class=pgc-img-caption></p></div><p><br></p><p>当用户重启时或者重新创建一个explorer.exe进程时，就会加载我们的恶意dll文件，从而达到后门持久化的效果。这里我们直接结束一个explorer.exe进程再起一个进程来看一下效果</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8f7d627676b34d36945df909a5df6004><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>office系列</strong></h1><h1 class=pgc-h-arrow-right><strong>Word WLL</strong></h1><p>把dll文件保存在%APPDATA%\Microsoft\Word\Startup，然后把后缀名改为wll PS：Startup支持启动多个wll</p><p>打开word，成功弹框</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/50607e78777948a2abbfeb681646d7ec><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>Excel XLL</strong></h1><p>Excel dll的编写可以参考三好师傅这个项目：链接 用三好师傅powershell脚本生成现成的Excel dll：链接</p><p>将生成的DLL文件复制到%appdata%\Microsoft\AddIns目录下，然后再修改一下注册表，office版本对应的注册表位置如下：</p><p>office2003 — HKEY_CURRENT_USER\Software\Microsoft\Office\11.0\</p><p><br></p><p>office2007 — HKEY_CURRENT_USER\Software\Microsoft\Office\12.0\</p><p><br></p><p>office2010 — HKEY_CURRENT_USER\Software\Microsoft\Office\14.0\</p><p><br></p><p>office2013 — HKEY_CURRENT_USER\Software\Microsoft\Office\15.0\</p><p><br></p><p>office2016 — HKEY_CURRENT_USER\Software\Microsoft\Office\16.0\</p><p><br></p><p>我这里使用的2010的，所以我们要修改的是HKEY_CURRENT_USER\Software\Microsoft\Office\14.0\Excel\Options，添加一个键OPEN，键值为：/R test.dll</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a91b8506abbd48538cf2cd4738a9bbb1><p class=pgc-img-caption></p></div><p><br></p><p>然后打开Excel，发现成功弹出计算器</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/131187af37ae441284f168b7e588b52c><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>PowerPoint VBA add-ins</strong></h1><p>用三好师傅powershell脚本生成现成的PowerPoint dll：链接</p><p>将生成的DLL文件复制到%appdata%\Microsoft\AddIns目录下，然后参考前面我给出的office版本对应的注册表位置，在HKEY_CURRENT_USER\Software\Microsoft\Office\14.0\PowerPoint下新建一个子项：AddIns，然后在AddIns下面新建一个子项test，新建一个键为Autoload，类型为DWORD，键值为：1；新建一个键为Path，类型为SZ，键值为我们dll文件的路径</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9a1f0b33c9014258911e6f62bd2af9d9><p class=pgc-img-caption></p></div><p><br></p><p>打开PowerPoint成功弹出计算器</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/49d753eb6ab84fc18b69a9630e7661cf><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>文件关联</strong></h1><p>什么是文件关联</p><p>文件关联就是将一种类型的文件与一个可以打开它的程序建立起一种依存关系。一个文件可以与多个应用程序发生关联。可以利用文件的“打开方式”进行关联选择。</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d976db655710438a8085e1258d65e972><p class=pgc-img-caption></p></div><p><br></p><p>举个例子来说，位图文件（BMP文件）在Windows中的默认关联程序是“图片”，如果将其默认关联改为用ACDSee程序来打开，那么ACDSee就成了它的默认关联程序。</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b69f46b906f442eb8bf4719230b88ba3><p class=pgc-img-caption></p></div><p><br></p><p>PS：来自百度百科</p><p><br></p><p>我们可以用assoc命令显示或修改文件扩展名关联，我们可以看一下.txt文件的关联</p><p>我们可以用ftype命令显示或修改用在文件扩展名关联中的文件类型</p><p>相关注册表</p><p>HKEY_CURRENT_USER\Software\Classe //保存了当前用户的类注册和文件扩展名信息</p><p><br></p><p>HKEY_LOCAL_MACHINE\Software\Classe //保存了系统所有用户用户的类注册和文件扩展名信息</p><p><br></p><p>HKEY_CLASS_ROOT //HKEY_CLASSES_ROOT项提供合并来自上面两个的信息的注册表的视图</p><p><br></p><p>我们以.txt为例，通过文件关联来修改它默认打开的程序。 修改\HKEY_CLASS_ROOT\txtfile\shell\open\command的默认值为我们要执行的程序</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b51b1f9eea454029b49b74b03c9655fa><p class=pgc-img-caption></p></div><p><br></p><p>效果如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7732c8aa22bf46e7a567418111e20b49><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>AppInit_DLLs</strong></h1><p>User32.dll被加载到进程时，会读取AppInit_DLLs注册表项，如果有值，调用LoadLibrary() api加载用户dll。</p><p>其注册表位置为：HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs，把AppInit_DLLs的键值设置为我们dll路径，将LoadAppInit_DLLs设置为1</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/66035e91048948e29668702140a2e182><p class=pgc-img-caption></p></div><p><br></p><p>效果如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/22ac402595b0434389bb03f45d4f5ab7><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>Netsh helper</strong></h1><p>netsh（全称：Network Shell） 是windows系统本身提供的功能强大的网络配置命令行工具，它可以添加自定的dll从而拓展其功能，我们可以使用netsh add helper yourdll.dll来添加拓展功能，添加了之后，在启动netsh的时候就会加载我们dll文件</p><p>添加自定义helper dll 关于helper dll的编写可以参考这个项目：链接</p><p>我们可以使用两种方式来添加helper：</p><p>通过cmd添加helper</p><p>netsh add helper test.dll</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c15d8f01174d4f95ade49e46666002d5><p class=pgc-img-caption></p></div><p><br></p><p>通过注册表添加helper 其位置为：HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh，创建一个键，名称随便，键值为我们dll的路径</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4b4414a5a16a4d39b38d2778d373bb4c><p class=pgc-img-caption></p></div><p><br></p><p>效果如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9772450193a14e6ebfd058323215e8fe><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>利用BITS</strong></h1><p>BITS (后台智能传送服务) 是一个 Windows 组件，它可以在前台或后台异步传输文件，为保证其他网络应用程序获得响应而调整传输速度，并在重新启动计算机或重新建立网络连接之后自动恢复文件传输。</p><p>bitsadmin是一个命令行工具，用于创建下载或上传任务并监视其进度。你可以执行bitsadmin /?或bitsadmin /HELP获取帮助列表。</p><p>常见的bitsadmin命令</p><p>bitsadmin /create [type] DisplayName //创建一个任务</p><p><br></p><p>bitsadmin /cancel &lt;Job> //删除一个任务</p><p><br></p><p>bitsadmin /list /allusers /verbose //列出所有任务</p><p><br></p><p>bitsadmin /AddFile &lt;Job> &lt;RemoteURL> &lt;LocalName> //给任务test添加一个下载文件</p><p><br></p><p>bitsadmin /SetNotifyCmdLine &lt;Job> &lt;ProgramName> [ProgramParameters] //设置在任务完成传输时或任务进入状态时将运行的命令行命令。</p><p><br></p><p>bitsadmin /Resume &lt;Job> //激活传输队列中的新任务或挂起的任务。</p><p><br></p><p>bitsadmin /cancel &lt;Job> //删除某个任务</p><p><br></p><p>bitsadmin /reset /allusers //删除所有任务</p><p><br></p><p>bitsadmin /complete &lt;Job> //完成某个任务</p><p><br></p><p>下面我们来测试一下：</p><p>bitsadmin /create test</p><p><br></p><p>bitsadmin /addfile test c:\windows\system32\calc.exe c:\Users\qiyou\Desktop\calc.exe //为了方便起见我们直接复制本地文件</p><p><br></p><p>bitsadmin /SetNotifyCmdLine test cmd.exe "cmd.exe /c calc.exe"</p><p><br></p><p>bitsadmin /resume test</p><p><br></p><p>效果如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/525a3bd9cc994840b6443f2f4d7c9c89><p class=pgc-img-caption></p></div><p><br></p><p>重启电脑之后任务还是存在</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e458de02b67b40268d63292d3275ed1b><p class=pgc-img-caption></p></div><p><br></p><p>重启电脑之后任务会再一次被激活，大概几分钟之后我们的命令会再次执行（由于时间太长了就不录制gif了）</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6793872a04dc4e51af00ae3fb8150d35><p class=pgc-img-caption></p></div><p><br></p><p>如果我们想让任务完成，可以执行bitsadmin /complete test，calc.exe也会复制到桌面上</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e8e32bfb1632432d87334a550e828fd3><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>利用inf文件实现后门</strong></h1><p>inf文件</p><p>INF文件或安装信息文件是Microsoft Windows用于安装软件和驱动程序的纯文本文件。INF文件最常用于安装硬件组件的设备驱动程序。Windows包含用于创建基于INF的安装的IExpress工具。INF文件是Windows安装程序API及其后续版本Windows Installer的一部分。</p><p><br></p><p>PS：来自WIKI</p><p><br></p><p>inf`文件的结构</p><p><br></p><p>想了解更多可以看一下微软的手册：`https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc939869(v=technet.10)#information-inf-file-entries</p><p><br></p><p>1. DefaultInstall节（来自WIKI）</p><p><br></p><p>INF文件的结构与INI文件的结构非常类似; 它包含用于指定要复制的文件，对注册表的更改等的各个部分。所有INF文件都包含一个[Version]带有Signature 键值对的部分，用于指定INF文件所针对的Windows版本。签名通常是$CHICAGO$（对于Windows 9x）或$WINDOWS NT$（对于Windows NT / 2K / XP）。其余大多数部分是用户定义的，并且包含特定于要安装的组件的信息。</p><p><br></p><p>2. DefaultInstall节（来自微软的手册）</p><p><br></p><p>RunPreSetupCommands-本节中指定的命令在安装服务配置文件之前运行。</p><p><br></p><p>RunPostSetupCommands-本节中指定的命令在安装程序完成服务配置文件后运行。</p><p><br></p><p>RunPreUnInstCommands-本节中指定的命令在卸载程序开始之前运行。</p><p><br></p><p>RunPostUnInstCommands-本节中指定的命令在卸载程序运行后运行。</p><p><br></p><p>下面举一个calc.inf弹计算器的例子</p><p>[Version]</p><p><br></p><p>Signature="$CHICAGO$"</p><p><br></p><p>AdvancedINF=2.5,"test"</p><p><br></p><p>[DefaultInstall]</p><p><br></p><p>RunPreSetupCommands=Command1</p><p><br></p><p>[Command1]</p><p><br></p><p>C:\windows\system32\calc.exe</p><p><br></p><p>命令行下执行：</p><p>rundll32.exe advpack.dll,LaunchINFSection calc.inf,DefaultInstall</p><p>效果如下：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b56c400067e248f0a5b842191795b52f><p class=pgc-img-caption></p></div><p><br></p><p>后门实现： 在注册表HKEY_CURRENT_USER\Software\Microsoft\处依次新建子项\IEAK\GroupPolicy\PendingGPOs，然后再新建几个键，如下：</p><p>键：Count，类型：REG_DWORD，键值：1</p><p>键：Path1，类型：REG_SZ，键值：C:\Users\Administrator\Desktop\test\calc.inf //这个为我们inf文件的路径，这里以上面那个inf文件例子为例</p><p>键：Section1，类型：REG_SZ，键值：DefaultInstall</p><p>如下图所示：</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/68d7763187ad45afa416a9a0b692cf51><p class=pgc-img-caption></p></div><p><br></p><p>重启电脑之后成功弹出计算器</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/69c79855d53045808c230e733191cf01><p class=pgc-img-caption></p></div><p><br></p><p>但是重启之后PendingGPOs该项就会被清除，需要我们重新修改注册表</p><p><br></p><div class=pgc-img><img alt=大神秘籍：windows中常见后门持久化方法总结 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1f6a8f9005ec4bfb9b5f2cb019a132fa><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>后记</strong></h1><p>以上就是我所总结后门持久化的所有内容了，当然还有很多方法没有在文章内提及，虽然有的方法都是老生常谈的了，但是还是在一些实战环境中屡试不爽，有一句话说的好（这句话忘记是哪位师傅说的了=。=）：<strong>知识面宽度决定攻击面广度，知识链深度决定攻击链的长度</strong></p><h1 class=pgc-h-arrow-right><strong>Reference</strong></h1><p>https://github.com/Ridter/Intranet<em>Penetration</em>Tips</p><p>https://paper.seebug.org/1007/</p><p>https://3gstudent.github.io/</p><p></p><div class=tt-column-card data-content='{"url":"","content":"","thumb_url":"http://p7.pstatp.com/large/pgc-image/6edbae9dd2d848f08332eef20de350b5","title":"Windows系统基线安全","author_description":"安界","price":9.9,"share_price":0,"sold":2,"column_id":"6844050178928820487","new_thumb_url":"http://sf6-ttcdn-tos.pstatp.com/img/pgc-image/6edbae9dd2d848f08332eef20de350b5"}'><p class=column-placeholder></p></div><p><br></p><p>原文地址：https://xz.aliyun.com/t/6461</p><p>我是安仔，一名刚入职网络安全圈的网安萌新，欢迎关注我，跟我一起成长； 欢迎大家私信回复【入群】，加入安界网大咖交流群，跟我一起交流讨论。<a class=tteditor-forum data-concern-id=1630858953410567 data-id=1630858953410567 data-name=网络安全在我身边 data-uid>#网络安全在我身边#</a><a class=tteditor-forum data-concern-id=1667099819060248 data-id=1667099819060248 data-name=安界网人才培养计划 data-uid>#安界网人才培养计划#</a><a class=tteditor-forum data-concern-id=1669559494056983 data-id=1669559494056983 data-name=小白入行网络安全 data-uid>#小白入行网络安全#</a><a class=tteditor-mention data-concern-id data-id data-name=今日头条 data-uid=3612927328>@今日头条</a><a class=tteditor-mention data-concern-id data-id data-name=头条号 data-uid=3615613886>@头条号</a></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'windows','见后门','总结'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>