<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>HashMap哲学中的数学原理，你发现了没有？ | 极客快訊</title><meta property="og:title" content="HashMap哲学中的数学原理，你发现了没有？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/c6e5680fb8e7487da90a1fadc685bf64"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d2aa03e2.html><meta property="article:published_time" content="2020-10-29T21:09:19+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:19+08:00"><meta name=Keywords content><meta name=description content="HashMap哲学中的数学原理，你发现了没有？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/d2aa03e2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>HashMap哲学中的数学原理，你发现了没有？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><ul><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6796209954379268620/?group_id=6796209954379268620" rel="noopener noreferrer" target=_blank>2020复工跳槽季，ZooKeeper灵魂27连问，这谁顶得住？</a></strong><br></li><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6793297693910237700/?group_id=6793297693910237700" rel="noopener noreferrer" target=_blank>2020“闭关”跳槽季，啃透分布式三大技术：限流、缓存、通讯</a></strong><br></li><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6792573246827921924/?group_id=6792573246827921924" rel="noopener noreferrer" target=_blank>疫情期间“闭关修炼”，吃透这本Java核心知识，跳槽面试不心慌</a></strong><br></li><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6797030379376083464/?group_id=6797030379376083464" rel="noopener noreferrer" target=_blank>字节三面远程，Java+Redis+网络+数据库+算法，轻松反杀面试官？</a></strong><br></li></ul><h1 class=pgc-h-arrow-right>tableSizeFor</h1><p>一般遇到的第一个问题就是tableSizeFor()。</p><div class=pgc-img><img alt=HashMap哲学中的数学原理，你发现了没有？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c6e5680fb8e7487da90a1fadc685bf64><p class=pgc-img-caption></p></div><p>我来解释一下这部分代码的作用：计算出大于或等于cap的第一个2的n次幂。 注意：</p><ul><li>cap参与计算之前要先-1</li><li>了解>>>、|的运算规则</li></ul><p>他这个算法大概的意思就是先无符号右移m位，再将获得的结果与原值进行 | 运算。 比如我们令cap=19,则n=18，二进制表示为10010，无符号右移1位之后是1001。 如果将其对其为16位则表示为：0000 0000 0001 0010然后与原值0000 0000 0000 1001与运算结果为：0000 0000 0001 1011后面的几轮我们以此类推即可。 详细的演算过程如下：</p><div class=pgc-img><img alt=HashMap哲学中的数学原理，你发现了没有？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3074e3237f7a4e7b9257deef19557059><p class=pgc-img-caption></p></div><p>上面的演算结果是11111，翻译为10进制就是31。</p><pre><code>return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;</code></pre><p>n &lt; MAXIMUM_CAPACITY，所以返回：31 + 1 = 32。 使用 移位 和 或 运算，巧妙的化简了问题。注意这里有一个细节就是cap-1，为什么这么做呢。假设 x = 2^n，如果我们不处理得到的结果是2 * 2^n，这里就不符合要求。大于等于 x 的第一个值应该是 x 本身。不信的话，可以动手验证一下。</p><h1 class=pgc-h-arrow-right>hash</h1><p>这里我们不讨论hashCode产生的过程，我们只关心后部分。也就是大家所谓的扰动函数。</p><pre><code>static final int hash(Object key) {    int h;    return (key == null) ? 0 :     // 我们看最后一行作用    (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);}</code></pre><p>Jdk对此做出了相应解释。</p><blockquote><p>Computes key.hashCode() and spreads (XORs) higher bits of hash</p></blockquote><p>直译就是：<strong>计算key.hashCode()并扩展哈希的更高位</strong> 有必要思考一下：为什么已经得出key的hashCode之后还要大费周章进行 移位 异或的运算呢。假设我们不进行扰动呢，能有什么影响呢。我们知道HashMap中确定元素所在数组中的位置是通过 & 运算来实现的。</p><pre><code>if ((p = tab[i = (n - 1) &amp; hash]) == null)</code></pre><p>一个key的hashCode足够大，而当前HashMap的容量不是足够大的时候，你发现了吗对该key进行定位的重大决定其实只是交给了最后几位。 假设当前容量是16，然后(n - 1) = 15，其实就是二进制的1111。无论hash有多少位，不足的我1111只管补足0即可。这时候一个非常尴尬的情况出现了。我管你hashCode多少位只要跟我1111进行 & 运算，除了最后四位前面的一律为0。也就是说hash看着位数足够多其实发挥作用的只有最后面的一部分。<strong>这样一来，两个hash只需要低位一致，高位就算多大差异他们最后一定定位再同一处</strong>。 这显然是源码作者不愿意看到的结果。其实这里高位参与运算就是为了打乱低位。这样高位不同，低位相同，定位就一定相同的僵局直接就会被打破。</p><h1 class=pgc-h-arrow-right>容量的秘密</h1><p>我们知道HshMap扩容至原来的2倍，初始容量是16，这么一来ta的容量其实永远都是2^n。在二进制中2^n的数字是极具特点的。转化成二进制之后首位为1，余位为0。<strong>那么2^n - 1之后呢，得到的结果更加有规律，一定得到全部为 1 的排列。</strong> 请你一定要记得任何数 -1 得到全部是 1 的排列那么这个数字一定是2^n</p><pre><code>final V putVal(int hash, K key, V value, boolean onlyIfAbsent,  boolean evict)    n = (tab = resize()).length;    (n - 1) &amp; hash复制代码</code></pre><p>在put()方法中想要定位，其实就是获取到Key的hash之后对当前容量求余。但是求余在计算机的世界里比较消耗性能。我们可以将hash % n转化为(n - 1) & hash。 <strong>& 的运算规则是全部为 1 结果为 1，其余结果为 0。</strong> 我们令hash的值为a b c d，(n - 1)的值为m n x y，且上述变量取值范围为[0, 1]。 & 运算结果为t x y z，最完美的情况是： 四位数值每一位都可能是 0 或者 1，那么得到的排列有2 * 2 * 2 * 2 = 16 种。我们继续假设如果m n x y其中有一个数字等于 0 呢？结果的排列就只剩下2 * 2 * 2 = 8种。出现两位为 0 的话排列就只剩下2 * 2 = 4种。 这么理论不免有些枯燥。因为我们是明确知道当前容量的。如果 n = 1110，n - 1 = 1101，相当于你数组长度为 14 时，只会出现 8 种排列，那么对应成HashMap的定位问题，就是说数组长度是 14 时，足足有 6 个位置是永远浪费的。如果存在这种大量浪费的情况，势必会导致HashMap频频扩容，损耗性能。 那怎么解决呢？怎么让所有的位置都有可能被定位，对应成上述数学模型解决方案其实就是(n - 1)所有位必须全为 1。 那如果(n - 1)所有位必须全为 1。则 n = 2^x 成立。</p><h1 class=pgc-h-arrow-right>扩容的秘密</h1><pre><code>if ((e.hash &amp; oldCap) == 0)newTab[j] = loHead;newTab[j + oldCap] = hiHead;</code></pre><p>这里我当时看的时候百思不得其解，直到我发现这里(e.hash & oldCap)不是(e.hash & (oldCap - 1))这两者天壤之别。这句代码这里的意思就是其实就是判断oldCap最高位对应e.hash相对应位置上的值是否为 1。 这个很重要因为如果对应的位置为 1，直接表示ta需要搬家，而搬到哪里去呢？数组原来位置对应的数字加上原容量即可。如果是 0，那就待在原地即可。其实这里只要二进制和数学学的好的，应该是瞬间就可以反应的过来。 扩容之后(e.hash & (newCap - 1))其实只有newCap的最高位对应的e.hash的那一位可以发挥作用，newCap最高位前面的全是0不影响结果，后面呢跟(e.hash & (oldCap - 1))的结果又一摸一样也不影响结果。还不明白，那我就偷一张图：</p><div class=pgc-img><img alt=HashMap哲学中的数学原理，你发现了没有？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2dde49bd4acf49b68641e01372fb67f9><p class=pgc-img-caption></p></div><p>要是还不明白咱就代数演示一下:<br>假设原容量n=10000，n - 1 = 1111<br>假设key.hash = 10001<br>那么ta所在的位置是 1<br><strong>然后扩容一下</strong><br>现在n=100000，n - 1 = 11111<br>那么ta所在的位置是10001</p><blockquote><p><br>作者：颜如玉<br>原文链接：https://juejin.im/post/5e5251fc6fb9a07c7d005b7c<br></p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'HashMap','哲学','数学'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>