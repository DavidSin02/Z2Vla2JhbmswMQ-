<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Linux操作系统存储子系统核心技术之硬盘与RAID | 极客快訊</title><meta property="og:title" content="Linux操作系统存储子系统核心技术之硬盘与RAID - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/12a0a3d09fd54be3b2087a5d45b798b6"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d39b51ac.html><meta property="article:published_time" content="2020-11-14T21:04:33+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:33+08:00"><meta name=Keywords content><meta name=description content="Linux操作系统存储子系统核心技术之硬盘与RAID"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/d39b51ac.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Linux操作系统存储子系统核心技术之硬盘与RAID</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>Linux操作系统的存储子系统应该是Linux中最为复杂的子系统了。其实很多子系统都认为自己是最复杂的子系统，比如内存子系统和网络子系统也这么说。无论如何，存储子系统在Linux中是比较复杂的。今天我们就介绍一下Linux的存储子系统中的硬盘与RAID的相关内容，后面再写一篇关于LVM与文件系统的内容。</p><h1 class=pgc-h-arrow-right>硬盘</h1><p>在Linux的存储子系统中，最底层的就是硬盘了。这里的硬盘并不是指我们看到的硬盘硬件，而是指在Linux内部看到的硬盘设备，或者说是块设备。如果我们在/dev目录执行以下ls命令，就可以看到很多设备。在这些设备中以sd开头的就是基于SCSI协议的硬盘。</p><div class=pgc-img><img alt=Linux操作系统存储子系统核心技术之硬盘与RAID onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/12a0a3d09fd54be3b2087a5d45b798b6><p class=pgc-img-caption>图1 Linux中的块设备</p></div><p>无论是基于SAS、iSCSI还是FC的磁盘设备，大概都是这个样子。形似dm-X的是Device Map块设备，也就是通过LVM进行管理的设备，这种设备是一种逻辑设备。</p><p>在Linux操作系统中块设备的种类很多，有本地磁盘设备、有SAN设备还有基于网络的块设备。在虚拟机中块设备又呈现为另外一种文件名，比如在Xen虚拟机中为xvdX。</p><p>虽然名称差异很大，但是在Linux操作系统内核中的实现却非常简单。在内核中任何磁盘块设备都是通过调用add_disk函数完成的。在<strong>《Linux设备驱动程序》这本书</strong>对块设备进行了详细的介绍，并且可以通过非常简单的代码实现一个自己的块设备。</p><div class=pgc-img><img alt=Linux操作系统存储子系统核心技术之硬盘与RAID onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a582c9c13da9451dac3f0eb0c8b81853><p class=pgc-img-caption>图2 最简单的块设备驱动</p></div><p>这里面有2个函数，也就是alloc_disk和add_disk。前一个函数是分配一个通用块的结构体，后者则是将该块设备添加到内核，也就是在/dev目录下生成一个“文件”。以上述代码为例，执行后会生成如下块设备。</p><blockquote><p>brw-rw---- 1 root disk 251, 0 Jun 16 09:13 /dev/sbulla</p></blockquote><p>这里我们自定义了一个设备名称sbulla。其实我们看到的SCSI设备也是这样定义的，只不过其定义名称的时候是通过sd字符。</p><p>以上述代码为例，在块设备中比较重要的地方是初始化了一个队列处理函数(sbull_full_request)。所有从上层访问该块设备的请求都会转发到该处理函数进行处理。</p><p>所有块设备都要初始化这个队列，并且提供一个请求处理函数。不同的块设备的请求处理函数略有不同。比如常见的SCSI块设备，其处理函数初始化过程如下：</p><blockquote><p>q = __scsi_alloc_queue(sdev->host, scsi_request_fn);</p></blockquote><p>而nbd（网络块设备，通过网络的方式将服务端的文件映射为客户端的块设备）设备的初始化队列的代码如下所示：</p><blockquote><p>disk->queue = blk_init_queue(do_nbd_request, &nbd_lock);</p></blockquote><p>类似的例子还很多，本文不再一一介绍。<strong>这里我们需要理解一点，核心问题在于注册处理请求的回调函数，以及通过add_disk就可以在/dev目录下面创建一个块设备。</strong></p><p><strong>另外一点，对于任何类型的块设备，无论是本地硬盘，还是经过网络的NBD和iSCSI，还是FC设备，最后都是/dev目录下的一个文件，而这个文件其实就是块设备。我们可以通过对该文件的读写实现对块设备的访问。</strong></p><h1 class=pgc-h-arrow-right>RAID</h1><p>作为普通用户使用单个硬盘是没有任何问题的，但是作为企业应用使用单个硬盘存在很大的风险。这时因为硬盘随时有可能损坏，因此我们需要一种机制来保证即使出现硬盘故障的情况下，数据不会丢失，且业务仍然可以正常工作。</p><p>RAID正是解决上述问题的技术。RAID的全称为廉价冗余磁盘阵列（Redundant Array of Inexpensive Disks），从字面可以看出其基本原理就是通过廉价的磁盘组成一组磁盘。RAID不仅仅可以通过冗余的方式解决数据可靠性的问题，还可以提高性能。其主要原理就是将请求拆分到多个物理硬盘来执行，性能自然比一个硬盘快了。</p><p>在Linux操作系统层面，其实就是<strong>将物理磁盘通过软件抽象为逻辑磁盘</strong>。以RAID1（两块磁盘存储相同的数据，在出现一块磁盘故障的情况下，数据不丢失）为例，通过Linux内核中的软件创建一个虚拟的块设备，而该块设备中记录了底层对应的物理设备及相关参数。</p><div class=pgc-img><img alt=Linux操作系统存储子系统核心技术之硬盘与RAID onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/60128e4f8d76412587f9f3e6867e6c43><p class=pgc-img-caption>图3 RAID1 示意图</p></div><p>因此，从用户层面来看就是一块普通的磁盘设备，而在底层却是2个独立的物理硬盘。当用户向逻辑磁盘写数据的时候，其中的软件会通过参数进行计算，并将数据重新定向到底层的物理设备。通过这种方法可以保证即使出现某个物理磁盘损坏，用户的数据仍然完好无损。</p><p>除了上面说的RAID1外，还有很多RAID类型。不同的RAID类型实现不同的功能。比如RAID0实现条带化，主要是提升性能；RAID1则是实现数据的冗余，防止磁盘故障导致的数据丢失；由于上述RAID只能解决一方面的问题，因此有人讲两者结合，出现了RAID10和RAID01，这样既能保证数据的可靠性，又能提升性能。</p><p>由于RAID1是一份数据写到两个设备，因此只有50%的有效数据。为了提高有效数据率，于是发明了RAID5和RAID6等类型。其中RAID5通过增加一个校验数据来保证数据的可靠性，以5块盘的RAID5为例，其中有效数占4块盘的空间，有效数据80%。但是RAID5有个问题，就是一组磁盘中只能坏一块，如果损坏的磁盘超过1块就会导致数据丢失。RAID6的算法与RAID5类似，它的特点是可以容忍2块磁盘故障。</p><p>在实现层面，Linux的RAID实现在用户态和内核态都有涉及。其中用户态主要进行RAID的管理，而内核态一方面配合用户态进行RAID管理，另外一方面则实现对IO的处理，这部分才是RAID最为核心的内容。</p><div class=pgc-img><img alt=Linux操作系统存储子系统核心技术之硬盘与RAID onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2b520f38e2e44b3e8ee60c2cbd7002ae><p class=pgc-img-caption>图4 软件架构</p></div><p>对于基于SCSI物理磁盘的RAID来说，Linux环境下整个软件架构如图4所示。其中虚线以上的为用户态的软件模块，虚线以下的为内核态的软件模块。<strong>这里比较核心的是RAID公共层，在这里主要创建md设备，该设备是一个逻辑设备，也是用户可以看到的RAID设备</strong>。其下则是具体的RAID模块，用于实现不同的RAID级别（算法）。</p><p>再往下就是通用SCSI驱动层了，也就是图中的SCSI磁盘驱动这一层的内容。该层其实是SCSI系统的上层驱动（SCSI子系统分为上中下三层）。RAID模块通过调用该层的数据访问接口就可以实现物理磁盘数据读写了。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'系统','Linux','存储子'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>