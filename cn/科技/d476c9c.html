<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>使用树莓派+DHT22做一个温湿度计 | 极客快訊</title><meta property="og:title" content="使用树莓派+DHT22做一个温湿度计 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/fabf534b38cf43ec8f9e2c277e9d61c2"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d476c9c.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d476c9c.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d476c9c.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d476c9c.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d476c9c.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d476c9c.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d476c9c.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d476c9c.html><meta property="article:published_time" content="2020-10-29T20:52:27+08:00"><meta property="article:modified_time" content="2020-10-29T20:52:27+08:00"><meta name=Keywords content><meta name=description content="使用树莓派+DHT22做一个温湿度计"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/d476c9c.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>使用树莓派+DHT22做一个温湿度计</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>先上一些照片。</p><p style=text-align:justify>硬件：树莓派+DHT22温湿度传感器（白色的那个就是）。</p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fabf534b38cf43ec8f9e2c277e9d61c2><p class=pgc-img-caption></p></div><p style=text-align:justify>网页，显示当前时间、最新一条监测记录。</p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/42bb4a79a4cc47f8a117ae4f21e9c1c5><p class=pgc-img-caption></p></div><p style=text-align:justify>传感器记录写入DB程序。</p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a8f98b1cef3e43bd81ad21c9defbb1a3><p class=pgc-img-caption></p></div><p style=text-align:justify>一个简单的查询数据程序。</p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9fdfeb506b604c94bc8f1c0bb6c7c656><p class=pgc-img-caption></p></div><p style=text-align:justify>整个程序下来，涉及了：</p><p>树莓派、DHT22温湿度传感器、Python3、SQLite3、Nginx、JQuery。</p><hr><h1 class=pgc-h-arrow-right>缘起：</h1><p>因为疫情原因，在家的时间比较长，一直是在书房工作学习。偶尔去趟客厅，现在天热，客厅朝南，又没开空调，就比较闷热潮湿。我就比较想知道客厅的温湿度。</p><p>家里倒是有个物理温湿度计，就是这玩意儿：</p><p><br></p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/85f050f1d0c9430d875728fd5432a74a><p class=pgc-img-caption></p></div><p>不过作为一个IT男，数据不数码化，总觉得很不爽，所以就动了心思买个电子温度计，家里小米的多，就想买这个：</p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/529437076ab64eaa9dbd0655cbb63454><p class=pgc-img-caption></p></div><p>但是现在穷的叮当响，又恰好翻箱底的时候，翻出了我的老树莓派——确实很老了，是很多年前，刚出来的时候买的，GPIO引脚还是26针的，配套的SD卡也找着了，因为这款没有WIFI，恰好又有富余的网线，一装系统还能运行，所以干脆就自己搞吧。</p><hr><h1 class=pgc-h-arrow-right>过程：不能放外链，大家想用就搜搜吧。</h1><p>1、安装系统：</p><p>1.1 格式化SD卡：去SD官方网站下载专门的格式化工具</p><p><br></p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f0129392a2b645d49fb0adf488fd194e><p class=pgc-img-caption></p></div><p>1.2 安装树莓派系统：</p><p style=text-align:justify>下载烧录程序</p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/48e80059c6a74f1e8f6228a0306b3af4><p class=pgc-img-caption></p></div><p>下载系统</p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d4230361c844453cb511a4d8e434181c><p class=pgc-img-caption></p></div><p>分别是：桌面+命令行版、桌面版、命令行版。我选的是第一个，回头可以在配置里将启动改为进入命令行界面。</p><p>烧录：</p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/859acffa52304a36989f5a9186ec8d24><p class=pgc-img-caption></p></div><p>这个没啥了，选系统镜像，选SD卡，写入。</p><hr><p>1.2 系统配置：</p><p>升级：</p><pre><code>sudo apt-get updatesudo apt-get dist-upgrade</code></pre><p>通过桌面首选项，可以打开VNC、SSH服务。</p><p>VNC是桌面连接，我们在电脑上用VNC Viewer可以访问树莓派桌面。</p><p>SSH是远程命令行访问，在终端上使用命令"ssh pi@树莓派IP"即可。</p><p>安装Python3.</p><p>安装Nginx、安装SQLite。</p><p>安装ufw防火墙，打开端口：</p><pre><code>sudo ufw allow 80#Nginx端口sudo ufw allow 8080#Python的HTTP服务接口sudo ufw allow 22#SSH端口sudo ufw allow 5900#VNC端口</code></pre><p>2、硬件安装：</p><p>去某宝买了DHT22温湿度传感器+杜邦线，20块钱，从汕头发过来的。</p><p>传感器一共有三个针脚“+、-、out”</p><p>我的树莓派比较老旧，只有26个针脚：</p><p><br></p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/99506c9330744222a84f264dcb3cecf4><p class=pgc-img-caption></p></div><p>如图，+接入3.3v，-接入Ground，out接入GPIO2。</p><p><strong class=highlight-text>正负极可不能接反了</strong>，会烧的。</p><hr><p>3、程序：</p><p>3.1 创建数据库、表：</p><pre><code>#!/usr/bin/pythonimport sqlite3conn=sqlite3.connect('temper.db')print("Open temperDB")c = conn.cursor()c.execute('''CREATE TABLE temper       (ID INTEGER PRIMARY KEY   autoincrement,       create_time DEFAULT (datetime('now', 'localtime')),       temp            CHAR(50)     NOT NULL,       humi        CHAR(50) NOT NULL);''')print('Table created successfully')conn.commit()conn.close()</code></pre><p>3.2 下载读取传感器相关驱动：</p><pre><code>sudo apt-get install build-essential python-devgit clone https://github.com/adafruit/Adafruit_Python_DHT.gitcd Adafruit_Python_DHTsudo python3 setup.py install</code></pre><p>3.3 每隔10分钟，读取传感器记录写入到数据库</p><pre><code>#!/usr/bin/pythonimport Adafruit_DHTfrom datetime import datetimeimport timeimport sqlite3sensor = Adafruit_DHT.DHT22#pin = 'P8_11'pin = 2def timer(n):    while True:        humidity, temperature = Adafruit_DHT.read_retry(sensor, pin)        if humidity is not None and temperature is not None:            print(datetime.now().strftime("%Y-%m-%d %H:%M:%S"))            print('温度={0:0.1f}*C  湿度={1:0.1f}%'.format(temperature, humidity))            conn = sqlite3.connect('temper.db')            c = conn.cursor()            c.execute("INSERT INTO temper (temp,humi) VALUES ("+'{0:0.1f}'.format(temperature)+","+'{0:0.1f}'.format(humidity)+")")            conn.commit()            conn.close()        else:            print('Failed to get reading. Try again!')        time.sleep(n)timer(600)</code></pre><p>3.4 Python服务端，返回JSON格式的最新记录：</p><pre><code>#!/usr/bin/pythonfrom http.server import HTTPServer, BaseHTTPRequestHandlerimport jsonimport sqlite3host = ('0.0.0.0', 8080)#开8080端口class Resquest(BaseHTTPRequestHandler):    def do_GET(self):        self.send_response(200)        self.send_header('Content-type', 'application/json')        self.send_header('Accexx-Control-Allow-Origin','*')#解决跨域问题        self.end_headers()        conn = sqlite3.connect('temper.db')        c = conn.cursor()        cursor = c.execute("SELECT *  from temper order by id desc limit 0,1")        for row in cursor:            data = {'id':row[0],'time':row[1],'temp':row[2],'humi':row[3]}        result="returnTemp("+json.dumps(data)+")"        self.wfile.write(result.encode())if __name__ == '__main__':    server = HTTPServer(host, Resquest)    print("Starting server, listen at: %s:%s" % host)    server.serve_forever()</code></pre><p>3.5 网页</p><p>编辑/var/www/html/index.nginx-debian.html</p><pre><code>&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset="UTF-8" /&gt;&lt;meta http-equiv="Access-Control-Allow-Origin" content="*" /&gt; &lt;title&gt;温湿度计&lt;/title&gt;&lt;script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.js"&gt;&lt;/script&gt;&lt;script&gt;$(function() {    var myDate = new Date;    var year = myDate.getFullYear(); //获取当前年    var mon = myDate.getMonth() + 1; //获取当前月    var date = myDate.getDate(); //获取当前日    var h = myDate.getHours();//获取当前小时数(0-23)    var m = myDate.getMinutes();//获取当前分钟数(0-59)    var s = myDate.getSeconds();//获取当前秒    var week = myDate.getDay();    var weeks = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];    console.log(year, mon, date, weeks[week])    $("#time").html("当前时间："+year + "年" + mon + "月" + date + "日" + weeks[week]+" "+h+":"+m+":"+s);    $.ajax({      url: "http://192.168.31.88:8080",//树莓派IP地址，PythonHTTP服务端口号      type: "GET",      dataType: "jsonp",//解决跨域问题      jsonpCallback:"returnTemp",//解决跨域问题      success: function (data) {      $("#data").html("记录ID："+data.id+"&lt;br/&gt;记录时间："+data.time+"&lt;br/&gt;温度："+data.temp+"°，湿度:"+data.humi+"%");      }    });})&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;span id="time"&gt;&lt;/span&gt;&lt;br/&gt;&lt;span id="data"&gt;&lt;/span&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><hr><p>4、启动：</p><p>分别启动Nginx、dht.py、serv.py</p><p>访问网页http://192.168.31.88</p><p><br></p><div class=pgc-img><img alt=使用树莓派+DHT22做一个温湿度计 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ec9ce1114d494b24a4df7a4cb703c730><p class=pgc-img-caption></p></div><hr><p>5、一些问题：</p><p>因为我毕竟是搞Java服务端开发的，用Python也只是处理一下数据，页面跨域的问题在实际工作中，运维人员就解决了，所以搞这一块有点手生，不过也是很快解决了。</p><p>本来我想让开机自启动的，但是查了不少资料，做了不少测试，总是有问题，所以暂时也不弄，就这么跑者吧。</p><hr><p>6、后续的一些规划：</p><p>因为数据都入库了，我准备使用ECharts，将历史数据做一个折线图。</p><p>另外某宝上也看了墨水屏，可以接到树莓派上，将网页上的信息展示在上面。不过那玩意儿也太贵了，4.2寸的要快200了，舍不得啊。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'树莓','DHT22','一个'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>