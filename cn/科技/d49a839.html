<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>10亿数据量只需要100MB内存，redis的位存储为什么这么牛？ | 极客快訊</title><meta property="og:title" content="10亿数据量只需要100MB内存，redis的位存储为什么这么牛？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/83b5d61029264050914e36c478977b05"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d49a839.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d49a839.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d49a839.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d49a839.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d49a839.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d49a839.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d49a839.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d49a839.html><meta property="article:published_time" content="2020-10-29T21:05:38+08:00"><meta property="article:modified_time" content="2020-10-29T21:05:38+08:00"><meta name=Keywords content><meta name=description content="10亿数据量只需要100MB内存，redis的位存储为什么这么牛？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/d49a839.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>10亿数据量只需要100MB内存，redis的位存储为什么这么牛？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>本文主要和大家分享一下redis的高级特性：<strong>bit位操作</strong>。</p><p>力求让大家<strong><u>彻底学会使用redis的bit位操作并掌握其底层实现原理</u></strong>！主要包含以下内容：</p><ol start=1><li>redis位操作命令示例</li><li>底层数据结构分析</li><li>为什么他的算法时间复杂度是O(1)?</li><li>10亿数据量需要多大的存储空间？</li><li>redis位操作适合哪些应用场景？</li></ol><blockquote><p>文章内容较长，建议大家收藏后持续阅读，点击右上角关注，获取更多技术干货文章！</p></blockquote><p>本文redis试验代码基于如下环境：</p><blockquote><p>操作系统：Mac OS 64位</p><p>版本：Redis 5.0.7 64 bit</p><p>运行模式：standalone mode</p></blockquote><h1><strong>redis位操作</strong></h1><p>reids位操作也叫位数组操作、bitmap，它提供了SETBIT、GETBIT、BITCOUNT、BITTOP四个命令用于操作二进制位数组。</p><p>先来看一波基本操作示例：</p><div class=pgc-img><img alt=10亿数据量只需要100MB内存，redis的位存储为什么这么牛？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/83b5d61029264050914e36c478977b05><p class=pgc-img-caption></p></div><p><strong>SETBIT</strong></p><p>语法：<strong>SETBIT key offset value</strong></p><p>即：<strong>命令 key 偏移量 0/1</strong></p><p>setbit命令用于写入位数组指定偏移量的二进制位设置值，偏移量从0开始计数，且只允许写入1或者0，如果写入非0和1的值则写入失败：</p><div class=pgc-img><img alt=10亿数据量只需要100MB内存，redis的位存储为什么这么牛？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7d2987883f204961a43f86a3eaf38ab5><p class=pgc-img-caption></p></div><p><strong>GETBIT</strong></p><p>语法：<strong>GETBIT key offset</strong></p><p>即：<strong>命令 key 偏移量</strong></p><p>gitbit命令用于获取位数组指定偏移量上的二进制值：</p><div class=pgc-img><img alt=10亿数据量只需要100MB内存，redis的位存储为什么这么牛？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/25fe1e005f6346f8b624ecd2ceadf56f><p class=pgc-img-caption></p></div><p><strong>BITCOUNT</strong></p><p>语法：<strong>BITCOUNT key</strong></p><p>即：<strong>命令 key</strong></p><p>bitcount命令用于获取指定key的位数组中值为1的二进制位的数量，之前我们写入了偏移量0的值为1，偏移量10 的值为1，偏移量8的值为0：</p><div class=pgc-img><img alt=10亿数据量只需要100MB内存，redis的位存储为什么这么牛？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b03b9489e4704df5a32f782347d73071><p class=pgc-img-caption></p></div><p><strong>BITOP</strong></p><p>语法：<strong>BITOP operation destkey key [key...]</strong></p><p>即：<strong>命令 操作 结果目标key key1 key2 ...</strong></p><p>bitop命令可以对多个位数组的key进行and（按位与）、or（按位或）、xor（按位异或）运算，并将运算结果设置到destkey中：</p><div class=pgc-img><img alt=10亿数据量只需要100MB内存，redis的位存储为什么这么牛？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2e126a48ac314067abe2a47d23db7d0f><p class=pgc-img-caption></p></div><h1><strong>底层数据结构分析</strong></h1><p>SDS是redis中的一种数据结构，叫做简单动态字符串（Simple Dynamic String），并且它是一种二进制安全的，在大多数的情况下redis中的字符串都用SDS来存储。</p><p>SDS的数据结构：</p><pre>struct sdshdr { #记录buff数组中已使用字节的数量 #也是SDS所保存字符串的长度 int len; #记录buff数组中未使用字节的数量 int free; #字节数组，字符串就存储在这个数组里 char buff[];}</pre><p>数据存储示例：</p><p><br></p><div class=pgc-img><img alt=10亿数据量只需要100MB内存，redis的位存储为什么这么牛？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae2c76077cce42a5936b708513f330be><p class=pgc-img-caption>图片来源《redis设计与实现》</p></div><p>SDS的优点：</p><ol start=1><li>时间复杂度为O(1)</li><li>杜绝缓冲区溢出</li><li>减少修改字符串长度时候所需的内存重分配次数</li><li>二进制安全的API操作</li><li>兼容部分C字符串函数</li></ol><p><strong>关于SDS的详细介绍请大家参阅《redis设计与实现》一文。</strong><br>redis中的位数组采用的是String字符串数据格式来存储，而字符串对象使用的正是上文说的SDS简单动态字符串数据结构。</p><div class=pgc-img><img alt=10亿数据量只需要100MB内存，redis的位存储为什么这么牛？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0aa028212db54c7fa8176ef4dfcce8c0><p class=pgc-img-caption>图片来源《redis设计与实现》</p></div><p>大家都知道的是一个字节用的是8个二进制位来存储的，也就是8个0或者1，即一个字节可以存储十进制0~127的数字，也即包含了所有的数字、英文大小写字母以及标点符号。</p><p><strong>1Byte=8bit</strong></p><p><strong>1KB=1024Byte</strong></p><p><strong>1MB=1024KB</strong></p><p><strong>1GB=1024MB</strong></p><p>位数组在redis存储世界里，每一个字节也是8位，初始都是：</p><pre>0 0 0 0 0 0 0 0</pre><p>而位操作就是在对应的offset偏移量上设置0或者1，比如将第3位设置为1，即：</p><pre>0 0 0 0 1 0 0 0#对应redis操作即：setbit key 3 1</pre><p>在此基础上，如果要在偏移量为13的位置设置1，即：</p><pre>setbit key 13 1#对应redis中的存储为：0 0 1 0 | 0 0 0 0 | 0 0 0 0 | 1 0 0 0</pre><h1><strong>时间复杂度</strong></h1><p><strong>GETBIT命令时间复杂度O(1)</strong></p><p><strong>STEBIT命令时间复杂度O(1)</strong></p><p><strong>BITCOUNT命令时间复杂度O(n)</strong></p><p><strong>BITOP命令时间复杂度O(n)、O(n2)</strong></p><p>我们来看GETBIT以及SETBIT命令的时间复杂度为什么是O(1)，当我们执行一个SETBIT key 10086 1的值的时候，reids的计算方式如下：</p><p><strong><u>获取到要写入位数组中的哪个字节</u></strong>：10086÷8=1260，需要写入到位数组的下标1260的字节</p><p><strong><u>获取要写入到这个字节的第几位</u></strong>：10086 mod 8 = 6，需要写入到这个字节的下标为6即第7位上去。</p><p>通过这两种计算方式大家可以清晰的看到，<strong>位操作的GETBIT和SETBIT都是常量计算，因此它的时间复杂度为O(1)</strong>。</p><p>而BITCOUNT命令需要对整个位数组的所有元素进行遍历算出值为1的有多少个，当然redis对于大数据了的bit执行bitcount命令会有一整套复杂的优化的算法，但是核心思路还是这个意思，无非是减少部分遍历查询次数。比如以128位为一次遍历，那么他的遍历次数就是所有的位数除以128。</p><p>BITTOP命令则是根据不同的操作有不同的执行方式。比如AND操作，则需要查看位值为1的即可。</p><h1><strong>存储空间计算</strong></h1><p>根据上面的介绍，相信大家已经知道了基于redis的位数组数据结构存储的数据占用内存大小是怎么计算的了。比如有100亿的数据，那么它需要的字节数组：</p><p><u>1000000000÷8÷1024÷1024≈119.21MB</u></p><p>也就是存储10亿的数据只需要119MB左右的内存空间，这对于现在动辄16G、32G集群版的redis，完全没有问题。</p><p>需要注意的是，如果你的数据量不大，那就不要把起始偏移量搞的很大，这样也是占空间的，比如我们只需要存储几百条数据，但是其中的偏移量却很大，这就会造成了很大的内存空间浪费。</p><h1><strong>应用场景</strong></h1><p>实际项目开发中有很多业务都适合采用redis的bit来实现。</p><p><strong>用户签到场景</strong></p><p>每天的日期字符串作为一个key，用户Id作为offset，统计每天用户的签到情况，总的用户签到数</p><p><strong>活跃用户数统计</strong></p><p>用户日活、月活、留存率等均可以用redis位数组来存储，还是以每天的日期作为key，用户活跃了就写入offset为用户id的位值1。</p><p>同理月活也是如此。</p><p><strong>用户是否在线以及总在线人数统计</strong></p><p>同样是使用一个位数组，用户的id映射偏移量，在线标识为1，下线标识为0。即可实现用户上下线查询和总在线人数的统计</p><p><strong>APP内用户的全局消息提示小红点</strong></p><p>现在大多数的APP里都有站内信的功能，当有消息的时候，则提示一个小红点，代表用户有新的消息。</p><p><strong><u>大家在平时工作中还有哪些场景运用到了redis的位操作呢？欢迎评论区一起交流使用redis位存储的经验！</u></strong></p><h1>我是java架构设计，关注我，免费阅读更多技术文章！</h1><p>相关文章推荐：</p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6764940257172390403/?group_id=6764940257172390403" target=_blank>搞清楚Spring事件机制后：Spring的源码看起来简单多了</a><br></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6763656004967072260/?group_id=6763656004967072260" target=_blank>源码解析（一）：SpringBoot是怎么启动的？（基于最新版2.2.0）</a><br></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6764034550424142349/?group_id=6764034550424142349" target=_blank>源码解析（二）：SpringBoot是如何一步步加载监听器的？</a><br></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6764405401082397196/?group_id=6764405401082397196" target=_blank>源码解析（三）：SpringBoot是怎么执行监听器的？事件驱动思想</a><br></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6765885800035910155/?group_id=6765885800035910155" target=_blank>源码解析（四）：SpringBoot创建Spring容器都做了哪些事情？</a><br></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'10','亿数','据量'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>