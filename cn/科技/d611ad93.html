<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>DNS协议详解及报文格式分析「转」 | 极客快訊</title><meta property="og:title" content="DNS协议详解及报文格式分析「转」 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/e50900c300af44348cbcd47341825485"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d611ad93.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d611ad93.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d611ad93.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d611ad93.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d611ad93.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d611ad93.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d611ad93.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d611ad93.html><meta property="article:published_time" content="2020-10-29T21:09:07+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:07+08:00"><meta name=Keywords content><meta name=description content="DNS协议详解及报文格式分析「转」"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/d611ad93.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>DNS协议详解及报文格式分析「转」</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>目录</p><ul><li>一. DNS协议理论知识 1.1. 域名结构 1.2. 域名服务器1.3. 域名解析过程</li><li>二. DNS协议报文格式 2.1 头部 2.2 正文</li><li>三. Wireshark分析DNS协议 3.1 请求报文 3.2 响应报文</li></ul><p>解BUG的过程中碰到了DNS相关的内容，折腾网站和域名邮箱时也对DNS做了一些配置，发现对一些细节有点记不清晰了，因此很有必要重新温习一下这方面的知识。学过网络的应该记得现代计算机通信的基石是TCP/IP协议，计算机A想要与计算机B进行通信，首先就必须要知道计算机B的IP地址，就像打电话一样，你给别人打电话首先必须得知道别人的电话号码吧，电话号码都不知道还搞个毛。但是问题来了，让人们去记忆这又臭又长的IP地址或是电话号码，无疑是不人道的，当然，这个小问题也并莫有难倒勤劳勇敢的人民群众。很快就发明了通讯录这个东西，用于将人名与电话号码联系起来。在计算机领域也出现了DNS(Domain Name System)，即域名系统，用于将域名解析成对应的IP地址。本文将介绍DNS协议的基本理论及其报文格式，最后给出了用Wireshark抓取DNS报文的记录。如果需要了解更为详细的内容，请参考 RFC1034 和 RFC1035。</p><hr><h3 class=pgc-h-arrow-right>一. DNS协议理论知识</h3><p><br></p><h4 class=pgc-h-arrow-right>1.1. 域名结构</h4><p>域名系统并不像电话号码通讯录那么简单，通讯录主要是单个个体在使用，同一个名字出现在不同个体的通讯录里并不会出现问题，但域名是群体中所有人都在用的，必须要保持唯一性。为了达到唯一性的目的，因特网在命名的时候采用了层次结构的命名方法。每一个域名（本文只讨论英文域名）都是一个标号序列（labels），用字母（A-Z，a-z，大小写等价）、数字（0-9）和连接符（-）组成，标号序列总长度不能超过255个字符，它由点号分割成一个个的标号（label），每个标号应该在63个字符之内，每个标号都可以看成一个层次的域名。级别最低的域名写在左边，级别最高的域名写在右边。域名服务主要是基于UDP实现的，服务器的端口号为53。</p><p>比如：本网站的域名 jocent.me，由点号分割成了两个域名jocent 和 me，其中 me是顶级域名（TLD，Top-Level Domain）， jocent是二级域名（SLD，Second Level Domain）。关于域名的层次结构，请看下面的示意图。</p><div class=pgc-img><img alt=DNS协议详解及报文格式分析「转」 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e50900c300af44348cbcd47341825485><p class=pgc-img-caption></p></div><p>注意：最开始的域名最后都是带了点号的，比如 jocent.me 搁以前的话应该是 jocent.me. ，最后面的点号表示根域名服务器，后来发现所有的网址都要加上最后的点，就简化了写法，干脆所有的都不加，但是你在网址后面加上点号也是可以正常解析的。</p><p><br></p><h4 class=pgc-h-arrow-right>1.2. 域名服务器</h4><p>有域名结构还不行，还需要有一个东西去解析域名，手机通讯录是由通讯录软件解析的，域名需要由遍及全世界的域名服务器去解析，域名服务器实际上就是装有域名系统的主机。由高向低进行层次划分，可分为以下几大类：</p><ul><li>根域名服务器： 最高层次的域名服务器，也是最重要的域名服务器，本地域名服务器如果解析不了域名就会向根域名服务器求助。全球共有13个不同IP地址的根域名服务器，它们的名称用一个英文字母命名，从a一直到m。这些服务器由各种组织控制，并由 ICANN（互联网名称和数字地址分配公司）授权，由于每分钟都要解析的名称数量多得令人难以置信，所以实际上每个根服务器都有镜像服务器，每个根服务器与它的镜像服务器共享同一个 IP 地址，中国大陆地区内只有6组根服务器镜像（F，I（3台），J，L）。当你对某个根服务器发出请求时，请求会被路由到该根服务器离你最近的镜像服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和地址，如果向根服务器发出对 “jocent.me” 的请求，则根服务器是不能在它的记录文件中找到与 “jocent.me” 匹配的记录。但是它会找到 “me” 的顶级域名记录，并把负责 “me” 地址的顶级域名服务器的地址发回给请求者。</li><li>顶级域名服务器：负责管理在该顶级域名服务器下注册的二级域名。当根域名服务器告诉查询者顶级域名服务器地址时，查询者紧接着就会到顶级域名服务器进行查询。比如还是查询"jocent.me"，根域名服务器已经告诉了查询者“me”顶级域名服务器的地址，“me”顶级域名服务器会找到 “jocent.me”的域名服务器的记录，域名服务器检查其区域文件，并发现它有与 “jocent.me” 相关联的区域文件。在此文件的内部，有该主机的记录。此记录说明此主机所在的 IP 地址，并向请求者返回最终答案。</li><li>权限域名服务器：负责一个区的域名解析工作</li><li>本地域名服务器：当一个主机发出DNS查询请求的时候，这个查询请求首先就是发给本地域名服务器的。</li></ul><div class=pgc-img><img alt=DNS协议详解及报文格式分析「转」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/644761d397ca4cb4875f0147f5b16c6f><p class=pgc-img-caption></p></div><p><br></p><h4 class=pgc-h-arrow-right>1.3. 域名解析过程</h4><p>域名解析总体可分为两大步骤，第一个步骤是本机向本地域名服务器发出一个DNS请求报文，报文里携带需要查询的域名；第二个步骤是本地域名服务器向本机回应一个DNS响应报文，里面包含域名对应的IP地址。从下面对jocent.me进行域名解析的报文中可明显看出这两大步骤。注意：第二大步骤中采用的是迭代查询，其实是包含了很多小步骤的，详情见下面的流程分析。</p><div class=pgc-img><img alt=DNS协议详解及报文格式分析「转」 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/adc8489beba4408a98fedd70ceb2984c><p class=pgc-img-caption></p></div><p>其具体的流程可描述如下：</p><ol start=1><li>主机10.74.36.90先向本地域名服务器10.74.1.11进行递归查询</li><li>本地域名服务器采用迭代查询，向一个根域名服务器进行查询</li><li>根域名服务器告诉本地域名服务器，下一次应该查询的顶级域名服务器 dns.me的IP地址</li><li>本地域名服务器向顶级域名服务器 dns.me进行查询</li><li>顶级域名服务器me告诉本地域名服务器，下一步查询权限服务器dns.jocent.me 的IP地址</li><li>本地域名服务器向权限服务器 dns.jocent.me进行查询</li><li>权限服务器 dns.jocent.me告诉本地域名服务器所查询的主机的IP地址</li><li>本地域名服务器最后把查询结果告诉 10.74.36.90</li></ol><p>其中有两个概念递归查询和迭代查询，其实在整个描述的过程中已经体现的很明显，这里再说明一下：</p><ul><li>递归查询：本机向本地域名服务器发出一次查询请求，就静待最终的结果。如果本地域名服务器无法解析，自己会以DNS客户机的身份向其它域名服务器查询，直到得到最终的IP地址告诉本机</li><li>迭代查询：本地域名服务器向根域名服务器查询，根域名服务器告诉它下一步到哪里去查询，然后它再去查，每次它都是以客户机的身份去各个服务器查询</li></ul><p>回到顶部</p><h3 class=pgc-h-arrow-right>二. DNS协议报文格式</h3><div class=pgc-img><img alt=DNS协议详解及报文格式分析「转」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3be08118bdc246c8b89cc9669f012ea7><p class=pgc-img-caption></p></div><p><br></p><h4 class=pgc-h-arrow-right>2.1 头部</h4><ol start=1><li>会话标识（2字节）：是DNS报文的ID标识，对于请求报文和其对应的应答报文，这个字段是相同的，通过它可以区分DNS应答报文是哪个请求的响应</li><li>标志（2字节）：QR（1bit）查询/响应标志，0为查询，1为响应opcode（4bit）0表示标准查询，1表示反向查询，2表示服务器状态请求AA（1bit）表示授权回答TC（1bit）表示可截断的RD（1bit）表示期望递归RA（1bit）表示可用递归rcode（4bit）表示返回码，0表示没有差错，3表示名字差错，2表示服务器错误（Server Failure）</li><li>数量字段（总共8字节）：Questions、Answer RRs、Authority RRs、Additional RRs 各自表示后面的四个区域的数目。Questions表示查询问题区域节的数量，Answers表示回答区域的数量，Authoritative namesversers表示授权区域的数量，Additional recoreds表示附加区域的数量</li></ol><p><br></p><h4 class=pgc-h-arrow-right>2.2 正文</h4><ol start=1><li>Queries区域1.1 查询名：长度不固定，且不使用填充字节，一般该字段表示的就是需要查询的域名（如果是反向查询，则为IP，反向查询即由IP地址反查域名），一般的格式如下图所示。1.2 查询类型：类型助记符说明1A由域名获得IPv4地址2NS查询域名服务器5CNAME查询规范名称6SOA开始授权11WKS熟知服务12PTR把IP地址转换成域名13HINFO主机信息15MX邮件交换28AAAA由域名获得IPv6地址252AXFR传送整个区的请求255ANY对所有记录的请求这里给一个域名，可用来模拟DNS的查询类型，可以选择不同的类型，比如A，PTR等玩一下， https://www.nslookuptool.com/chs/ 1.3 查询类：通常为1，表明是Internet数据</li><li>资源记录(RR)区域（包括回答区域，授权区域和附加区域）</li></ol><div class=pgc-img><img alt=DNS协议详解及报文格式分析「转」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/006283d49cc04442b24e5f38031c4505><p class=pgc-img-caption></p></div><p>该区域有三个，但格式都是一样的。这三个区域分别是：回答区域，授权区域和附加区域</p><p>2.1. 域名（2字节或不定长）：它的格式和Queries区域的查询名字字段是一样的。有一点不同就是，当报文中域名重复出现的时候，该字段使用2个字节的偏移指针来表示。比如，在资源记录中，域名通常是查询问题部分的域名的重复，因此用2字节的指针来表示，具体格式是最前面的两个高位是 11，用于识别指针。其余的14位从DNS报文的开始处计数（从0开始），指出该报文中的相应字节数。一个典型的例子，C00C(1100000000001100，12正好是头部的长度，其正好指向Queries区域的查询名字字段)。</p><p>2.2 查询类型：表明资源纪录的类型，见1.2节的查询类型表格所示</p><p>2.3 查询类：对于Internet信息，总是IN</p><p>2.4 生存时间（TTL）：以秒为单位，表示的是资源记录的生命周期，一般用于当地址解析程序取出资源记录后决定保存及使用缓存数据的时间，它同时也可以表明该资源记录的稳定程度，极为稳定的信息会被分配一个很大的值（比如86400，这是一天的秒数）。</p><p>2.5. 资源数据：该字段是一个可变长字段，表示按照查询段的要求返回的相关资源记录的数据。可以是Address（表明查询报文想要的回应是一个IP地址）或者CNAME（表明查询报文想要的回应是一个规范主机名）等。</p><p>回到顶部</p><h3 class=pgc-h-arrow-right>三. Wireshark分析DNS协议</h3><p>下面给出wireshark抓包的记录，感兴趣的可以根据上面介绍的协议报文格式手动解析一下，相信会有很大收获。</p><p><br></p><h4 class=pgc-h-arrow-right>3.1 请求报文</h4><div class=pgc-img><img alt=DNS协议详解及报文格式分析「转」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cef020be2efe433e96ba19a5ae307f61><p class=pgc-img-caption></p></div><p><br></p><h4 class=pgc-h-arrow-right>3.2 响应报文</h4><div class=pgc-img><img alt=DNS协议详解及报文格式分析「转」 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9e7b4b2f7bc447a5b10dea19ff43ee4e><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=DNS协议详解及报文格式分析「转」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c4e7293135cd4bc889d082e6afe60da2><p class=pgc-img-caption></p></div><p>DNS相关的命令小贴士：</p><ul><li>Windows环境下清空DNS缓存的命令是 ipconfig/flushdns 也可以通过重启DNS client 和 DHCP client 两项服务清空DNS缓存</li><li>Windows环境下可以用命令 ipconfig /displaydns 来查看DNS缓存的内容</li><li>nslookup 命令可以用来查看域名对应的IP地址，比如 nslookup jocent.me</li></ul><p>原文地址：https://blog.csdn.net/tianxuhong/article/details/74922454</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'DNS','协议','详解'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>