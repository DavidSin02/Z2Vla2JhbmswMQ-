<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？ | 极客快訊</title><meta property="og:title" content="你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/c7adc4a4b9b745c0ae541bf87a51dd85"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d6b4ad6d.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d6b4ad6d.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d6b4ad6d.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d6b4ad6d.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d6b4ad6d.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d6b4ad6d.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d6b4ad6d.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d6b4ad6d.html><meta property="article:published_time" content="2020-11-14T21:04:04+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:04+08:00"><meta name=Keywords content><meta name=description content="你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/d6b4ad6d.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>欢迎关注头条号：老顾聊技术</strong></p><p><strong>精品技术文章分享，知识的组装工</strong></p><h1>目录</h1><ol><li>前言</li><li>先更新数据库，再更新缓存</li><li>先更新缓存，再更新数据库</li><li>先删除缓存，再更新数据库</li><li>先更新数据库，再删除缓存</li><li>删除缓存失败，导致不一致</li><li>读写分离，导致不一致</li></ol><h1>前言</h1><p>在项目中缓存是经常用到的，为了减少和数据库的交互，小伙伴们利用缓存的思路如下：</p><div class=pgc-img><img alt=你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c7adc4a4b9b745c0ae541bf87a51dd85><p class=pgc-img-caption>缓存设计思路</p></div><p>我们小伙伴们有没有考虑到缓存更新的问题，小伙伴们肯定会说肯定用过啊，有数据更新时，把缓存清空掉就行了啊，下一次访问的时候服务就会把新值设置到缓存中了。这样不就行了吗？对的，在一般项目中，这样的使用就够了。<strong>那老顾带着大家看看在高并发场景下，会有什么问题？</strong></p><p>我们举例说明，就拿商品的库存作为缓存。那现在我们要更新缓存中的库存值，怎么进行操作，我们看下面几个场景：</p><h1>先更新数据库，再更新缓存</h1><p>存在的问题场景：请求A更新值为99，请求B更新值为98</p><div class=pgc-img><img alt=你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1780b0e99f824d439cb7e5f16580a1b9><p class=pgc-img-caption></p></div><p>上图流程：</p><pre>1）请求A先发起，更新数据库为99，但还没有来得及更新缓存2）请求B发起，更新数据库为98，又更新了缓存值为983）请求A这时才更新缓存的值为99</pre><p>这样数据库的值为98，但缓存的值为99，数值不一致。（不推荐）</p><h1>先更新缓存，再更新数据库</h1><p>这个流程跟上面很类似，出现的问题也很类似</p><pre>1）请求A先更新缓存为99，但还没有来得及更新数据库2）请求B更新缓存为98，又更新了数据库为983）请求A这时更新数据库为99</pre><p>这样就缓存的值为98，数据库为99导致不一致。（不推荐）</p><h1>先删除缓存，再更新数据库</h1><p>存在的问题场景：请求A更新值为99，请求B获取值</p><div class=pgc-img><img alt=你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a02fe5faa5ee44dda29fca239844089e><p class=pgc-img-caption></p></div><p>上图中请求流程：</p><pre>1）请求A更新值，先把缓存中的值删除，但还没有来得及更新数据库2）此时请求B过来查询此值，发现缓存中不存在，就到数据库中查询3）请求B在数据库中获取到值，在把值设置到缓存中。4）请求A这时才更新数据库里面的值为99</pre><p>这样就导致了缓存和数据库的不一致问题，缓存中的值一直是旧数据。（不推荐）</p><h1>先更新数据库，再删除缓存</h1><p>这个方案也是老外提出的《Cache-Aside pattern》更新缓存的策略。这种策略先保证了源头的数据一定是正确的。这种策略是不是万无一失呢，有一种非常特殊的场景</p><div class=pgc-img><img alt=你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/346aa9c195194c879292d83c963bdd14><p class=pgc-img-caption></p></div><p>上图流程：建立中缓存突然失效了</p><pre>1）请求A发起查询请求，直接到数据库查询到100，但还没有来得及去设置缓存2）请求B更新值，先更新数据库，在删除缓存3）请求A这时才设置缓存为100</pre><p>这种情况发生的不一致，是因为缓存突然失效了。而且还要保证请求B更新操作 比 请求A的查询操作还要快；才会导致不一致。<strong>这种情况概率会很少。一般要求不高的项目可以采用此方式（推荐）。</strong></p><h1>缓存删除失败，导致不一致</h1><p>这种<strong>先更新数据库，再删除缓存的策略中，</strong>因为要删除缓存，但如果缓存删除失败，就会导致数据库与缓存不一致。这个问题怎么办？我们正常想到的是利用我们MQ中间件去实现。</p><div class=pgc-img><img alt=你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/caf14923aece4c83b2d626d173530630><p class=pgc-img-caption></p></div><p>上图的流程，如果删除缓存失败，发送消息投递到消息中间件中，进入消息队列。也许有小伙伴就会问，如果消息投递失败怎么办？我们可以利用消息中间件那边的保证100%消息投递的机制（这个以后再讲）。这样就保证了即使删除消息失败，我们也会重试。</p><p><strong>不过这个方案有个问题，就是和我们应用服务的业务代码耦合的比较厉害。代码业务不清晰。</strong></p><p>那我们有没有别的方案呢，对业务没有侵入呢？</p><div class=pgc-img><img alt=你知道如何更新缓存吗？如何保证缓存和数据库双写一致性？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d30a910508504cf1b9563e328c79e9bf><p class=pgc-img-caption></p></div><p>上图中其实是利用了mysql的底层机制，binlog日志进行删除缓存，这样就不需要和业务关联，删除缓存服务是独立的。我们可以利用阿里开源的canal去操作。</p><h1>读写分离，导致不一致</h1><p>这种<strong>先更新数据库，再删除缓存的策略</strong>是不是就没有问题呢？我们来看一下另一个场景，数据库的读写分离的场景。一般中大型项目都会用到数据库的读写分离。写请求在一个库，读请求在另一个库。读写分离会有个问题，就是库与库之间会存在数据延迟，因为存在数据同步。</p><p>那我们再看一下上面的场景流程，就会有问题，因为请求B更新数据 在一个库上面，请求A去读取数据时是另一个库。</p><pre>1）请求B更新值99，删除缓存2）请求A查询值100（读库数据还没有同步），在更新到缓存中（值为100）</pre><p>这样就导致不一致，这个场景是经常出现的，不是小概率事件。那我们如何处理呢？老顾下次再介绍。</p><p><strong>总结：整个导致不一致的原因就是因为高并发情况下各个请求执行的顺序是无法确定的，不知道哪个请求先执行，哪个后执行导致。</strong></p><hr><p><strong>-End-</strong></p><p><strong>如有收获，请帮忙转发，您的鼓励是作者最大的动力，谢谢！</strong></p><p><strong>10几年的经验实战分享</strong></p><p><strong>相关微服务，分布式，高并发，高可用，企业实战，干货等原创文章正在路上</strong></p><p><strong>欢迎关注头条号：老顾聊技术</strong></p><p><strong>精品技术文章分享，知识的组装工</strong></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'缓存','保证','数据库'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>