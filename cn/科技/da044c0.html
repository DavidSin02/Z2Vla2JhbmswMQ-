<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>使用了这么久的lombok，你知道它的原理吗 | 极客快訊</title><meta property="og:title" content="使用了这么久的lombok，你知道它的原理吗 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/dcdf280face24dc1b73c4cab6b87c280"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/da044c0.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/da044c0.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/da044c0.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/da044c0.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/da044c0.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/da044c0.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/da044c0.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/da044c0.html><meta property="article:published_time" content="2020-10-29T20:50:13+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:13+08:00"><meta name=Keywords content><meta name=description content="使用了这么久的lombok，你知道它的原理吗"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/da044c0.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>使用了这么久的lombok，你知道它的原理吗</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>在日常的Java开发中，最常见的就是Javabean对象，常常一个对象中有很多，私有属性，我们需要进行setter和getter的操作，如下</p><pre><code>public class Student {        private Integer id;        private String name;        private Integer age;        private Integer sex;        private String address;        private Float score;    public Integer getId() {        return id;    }    public void setId(Integer id) {        this.id = id;    }    public String getName() {        return name;    }    public void setName(String name) {        this.name = name;    }    public Integer getAge() {        return age;    }    public void setAge(Integer age) {        this.age = age;    }    public Integer getSex() {        return sex;    }    public void setSex(Integer sex) {        this.sex = sex;    }    public String getAddress() {        return address;    }    public void setAddress(String address) {        this.address = address;    }    public Float getScore() {        return score;    }    public void setScore(Float score) {        this.score = score;    }}</code></pre><p>这样的代码，显得很臃肿，尤其是当我们再添加属性，或者修改属性名称时，都需要手动更改或新增setter和getter方法，维护起来比较麻烦，因此很多开发者在日常使用过程中，都使用lombok工具来简化相关代码，代码如下</p><pre><code>@Datapublic class Student {    private Integer id;    private String name;    private Integer age;    private Integer sex;    private String address;    private Float score;}</code></pre><h1 class=pgc-h-arrow-right>lombok工具常见使用方法</h1><p>以idea举例，我们使用lombok首先需要安装lombok插件，如下图</p><div class=pgc-img><img alt=使用了这么久的lombok，你知道它的原理吗 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/dcdf280face24dc1b73c4cab6b87c280><p class=pgc-img-caption></p></div><p>然后在使用的项目中引入依赖（以maven举例）</p><pre><code>&lt;dependency&gt;    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;    &lt;artifactId&gt;lombok&lt;/artifactId&gt;    &lt;version&gt;1.18.12&lt;/version&gt;    &lt;scope&gt;provided&lt;/scope&gt;&lt;/dependency&gt;</code></pre><p>接下来我们就可以使用lombok工具提供的注解功能，进行开发。下面对常见的lombok工具注解进行介绍：</p><pre><code>@Getter // 生成getter方法@Setter // 生成setter方法@ToString // 自动重写 toString() 方法，会印出所有变量@EqualsAndHashCode // 自动生成equals和hashcode方法@NoArgsConstructor // 生成一个没有参数的构造器@AllArgsConstructor // 生成一个包含所有参数的构造器@RequiredArgsConstructor // 生成一个包含 "特定参数" 的构造器（特定参数指的是那些有加上 final 修饰词的变量们）@Data //这个注解，等于同时加了@Getter、@Setter、@ToString、@EqualsAndHashCode、@RequiredArgsConstructor注解@Builder // 自动生成流式 set 值写法@Slf4j //自动生成该类的 log 静态常量，直接通过log写日</code></pre><p>如下图</p><div class=pgc-img><img alt=使用了这么久的lombok，你知道它的原理吗 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e4c387f38d414053bf4c723e0dfcbdf2><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>为什么使用了注解就可以做到这些功能？</h1><p>对于代码增强，一般有两种方式，一种运行时增强，例如spring的aop，在运行时，对代码做功能增强；另一种是编译器增强，即编译时，通过字节码技术，将相应的代码植入到class中，lombok就采用两编译器增强。</p><p>上面我们对student这个类，加入@Data注解，编译后，我们查看下class文件，发现getter方法、setter方法、tostring方法等都写了相关代码，如下图</p><div class=pgc-img><img alt=使用了这么久的lombok，你知道它的原理吗 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8e15723b825e4e7cb347dc8b738f23df><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=使用了这么久的lombok，你知道它的原理吗 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9a0fd9af56ab4690847fd27bbb14b3b8><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>原理</h1><p>针对运行期增强，一般基于动态代理、反射技术实现，性能相对损耗大；编译器增强，一般基于<span style="color:#404040;--tt-darkmode-color: #A3A3A3">Annotation Processing Tool（APT技术在JDK8中已经彻底删除）以及Pluggable Annotation Processing API技术。</span></p><p><span style="color:#404040;--tt-darkmode-color: #A3A3A3">因此我们主要看看Pluggable Annotation Processing API技术，</span>自从Java 6起，javac就支持“JSR 269 Pluggable Annotation Processing API”规范，只要程序实现了该API，就能在javac运行的时候得到调用。</p><p>插件化注解处理API的使用步骤大概如下：</p><pre><code>1、自定义一个Annotation Processor，需要继承javax.annotation.processing.AbstractProcessor，并覆写process方法。2、自定义一个注解，注解的元注解需要指定@Retention(RetentionPolicy.SOURCE)。3、需要在声明的自定义Annotation Processor中使用javax.annotation.processing.SupportedAnnotationTypes指定在第2步创建的注解类型的名称(注意需要全类名，"包名.注解类型名称"，否则会不生效)。4、需要在声明的自定义Annotation Processor中使用javax.annotation.processing.SupportedSourceVersion指定编译版本。5、可选操作，可以通在声明的自定义Annotation Processor中使用javax.annotation.processing.SupportedOptions指定编译参数。6、通过服务注册指定，META-INF/services/javax.annotation.processing.Processor文件中添加 前面定义AnnotationProcessor</code></pre><p>下面我们按照上面步骤来演示一下：</p><p>自定义注解解析器（此处可以通过asm字节码技术写入新方法等，本文不介绍字节码技术，有兴趣的可以研究）</p><pre><code>@SupportedAnnotationTypes(value = {"com.example.demo.plugin.Demo"})@SupportedSourceVersion(value = SourceVersion.RELEASE_8)public class AnnotationProcessor extends AbstractProcessor {    @Override    public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv) {        System.out.println("Log in AnnotationProcessor.process");        for (TypeElement typeElement : annotations) {            System.out.println(typeElement);        }        System.out.println(roundEnv);        return true;    }}</code></pre><p>自定义注解</p><pre><code>@Retention(RetentionPolicy.SOURCE)@Target(ElementType.TYPE)public @interface Demo {}</code></pre><p>使用spi注入注解解析器</p><div class=pgc-img><img alt=使用了这么久的lombok，你知道它的原理吗 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fc897a2d98284f1da04bd3ce5cf9c7c9><p class=pgc-img-caption></p></div><p>使用注解</p><div class=pgc-img><img alt=使用了这么久的lombok，你知道它的原理吗 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b21e9829546f45a48faba5ac45162af9><p class=pgc-img-caption></p></div><p>编写测试用例</p><pre><code>public class App {    public static void main( String[] args )    {        System.out.println( "Hello World!" );        Student student = new Student();    }}</code></pre><p>运行结果如下，<strong>可以看到</strong><strong>编译期</strong><strong>AnnotationProcessor生效了</strong></p><pre><code>Log in AnnotationProcessor.processcom.example.Demo[errorRaised=false, rootElements=[com.example.Demo, com.example.App, com.example.Student], processingOver=false]Log in AnnotationProcessor.process[errorRaised=false, rootElements=[], processingOver=true]</code></pre><p>注意：如果出现下列报错，可以将AnnotationProcessor先编译，或者放到jar中即可。</p><pre><code>[ERROR] Bad service configuration file, or exception thrown whileconstructing Processor object: javax.annotation.processing.Processor: Provider com.example.demo.plugin.AnnotationProcessor not found</code></pre><p><strong>Lombok便是通过Pluggable Annotation Processing API来实现代码生成的。</strong></p><p>根据上面的原理，我们查看下lombok源码，发现的确如此</p><div class=pgc-img><img alt=使用了这么久的lombok，你知道它的原理吗 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d3df2e4c0a5b491194f61fd31088c710><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'这么','lombok','原理'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>