<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº | æå®¢å¿«è¨Š</title><meta property="og:title" content="SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/b05b4b9e4256491692f94a47e5c03297"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/da90322.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/da90322.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/da90322.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/da90322.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/da90322.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/da90322.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/da90322.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/da90322.html><meta property="article:published_time" content="2020-10-29T20:59:15+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:15+08:00"><meta name=Keywords content><meta name=description content="SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/da90322.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><h1>å‰è¨€ï¼š</h1><p>Spring StateMachineæ¡†æ¶æ˜¯Spring.ioæä¾›ç»™å¼€å‘è€…ä¸€ç§å¯ä»¥ç®€åŒ–çŠ¶æ€æœºå®ç°çš„è¿‡ç¨‹ï¼Œè®©çŠ¶æ€æœºç»“æ„æ›´åŠ å±‚æ¬¡åŒ–ã€‚æœ¬æ¬¡çŠ¶æ€æœºçš„å®ç°Showcaseä¸»è¦æ˜¯æ¨¡æ‹Ÿä¸€ä¸ªå•†å“è´­ä¹°çš„åœºæ™¯ï¼Œä»ä¸‹å•åˆ°æ”¶è´§è¿™ä¸ªä¸šåŠ¡æµç¨‹ä¸‹æ‰€æ¶‰åŠçš„äº‹ä»¶ã€çŠ¶æ€æ¥æè¿°Spring StateMachineå¦‚ä½•ä½¿ç”¨ä¸è¿ä½œã€‚</p><hr><h1>æ­£æ–‡ï¼š</h1><p>ä¸‹é¢è¯¦ç»†çš„ä»‹ç»æ•´ä¸ªå®ç°è¿‡ç¨‹ï¼š</p><h1>1.åˆ›å»ºåŸºæœ¬çš„springbooté¡¹ç›®å¹¶ä¸”æ·»åŠ ä¾èµ–ï¼š</h1><p>å®Œæ•´çš„pomä¾èµ–å¦‚ä¸‹ï¼š</p><pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;1.5.3.RELEASE&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;groupId&gt;com.example&lt;/groupId&gt; &lt;artifactId&gt;statemachine&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;statemachine&lt;/name&gt; &lt;description&gt;Demo project for Spring Boot&lt;/description&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- statemachine --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.statemachine&lt;/groupId&gt; &lt;artifactId&gt;spring-statemachine-core&lt;/artifactId&gt; &lt;version&gt;1.2.0.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;!-- Test --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.statemachine&lt;/groupId&gt; &lt;artifactId&gt;spring-statemachine-test&lt;/artifactId&gt; &lt;version&gt;1.2.0.RELEASE&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt;</pre><h1>2.æ ¹æ®åœºæ™¯éœ€è¦ï¼Œè®¾è®¡äº‹ä»¶ã€çŠ¶æ€çš„å¯¹è±¡ï¼š</h1><p>äº‹ä»¶æšä¸¾ç±»</p><div class=pgc-img><img alt="SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b05b4b9e4256491692f94a47e5c03297><p class=pgc-img-caption>Events</p></div><p>Events.javaå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><pre>package com.example.statemachine.enums;/** * @package: com.example.statemachine.enums * @description: äº‹ä»¶æšä¸¾ç±» * @author: @ITè®²å› * @create: 2018-12-16 17:27 **/public enum Events { ORDERING, // ä¸‹è®¢å• PAY, // æ”¯ä»˜ä¸­ PAYED, // å·²æ”¯ä»˜ RECEIVE, // å¾…æ”¶è´§ RECEIVED, // å·²æ”¶è´§ FINISH // å®Œæˆæµç¨‹}</pre><p>çŠ¶æ€æšä¸¾ç±»ï¼š</p><div class=pgc-img><img alt="SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fd76b5335f7946898ddb0cc8c3656695><p class=pgc-img-caption>States</p></div><p>States.javaå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><pre>package com.example.statemachine.enums;/** * @package: com.example.statemachine.enums * @description: çŠ¶æ€æšä¸¾ç±» * @author: @ITè®²å› * @create: 2018-12-16 17:27 **/public enum States { MAKE_AN_ORDER, // ç”Ÿæˆè®¢å• UNPAID, // å¾…æ”¯ä»˜ PAYING, // æ”¯ä»˜ä¸­ PAYED, // å·²æ”¯ä»˜ WAITING_FOR_RECEIVE, // å¾…æ”¶è´§ CUSTOMER_RECEIVED, // å·²æ”¶è´§ DONE // è®¢å•ç»“æŸ}</pre><p><strong>è¯´æ˜ï¼š</strong></p><p>äº‹ä»¶ä¼šè§¦å‘çŠ¶æ€çš„è½¬å˜ï¼Œä¾‹å¦‚ï¼šORDERINGäº‹ä»¶å¯ä»¥å‡ºå‘çŠ¶æ€ä»MAKE_AN_ORDERè½¬å˜ä¸ºUNPAIDï¼Œåé¢å¯¹äºStateMachineçš„é…ç½®ä¸Šå°†ä¼šä½“ç°ã€‚</p><h1>3.åˆ›å»ºStateMachineçš„é…ç½®ç±»ï¼Œè¿™ä¸ªé…ç½®ç±»ä¹Ÿæ˜¯Spring Bootçš„è‡ªåŠ¨è£…é…çš„å¿…å¤‡ï¼Œä¹Ÿæ˜¯å¤§å®¶ä»xmlé…ç½®è½¬ä¸ºbeané…ç½®çš„æœ€ä¸é€‚åº”çš„åœ°æ–¹</h1><p>StateMachineConfig.javaå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><div class=pgc-img><img alt="SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/9163657951af426894ce282bc9906eab><p class=pgc-img-caption>StateMachineConfig</p></div><pre>package com.example.statemachine.config;import com.example.statemachine.enums.Events;import com.example.statemachine.enums.States;import com.example.statemachine.persist.InMemoryStateMachinePersist;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.statemachine.config.EnableStateMachine;import org.springframework.statemachine.config.EnumStateMachineConfigurerAdapter;import org.springframework.statemachine.config.builders.StateMachineStateConfigurer;import org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer;import org.springframework.statemachine.persist.DefaultStateMachinePersister;import org.springframework.statemachine.persist.StateMachinePersister;import java.util.EnumSet;/** * @package: com.example.statemachine.config * @description: çŠ¶æ€æœºé…ç½®ç±» * @author: @ITè®²å› * @create: 2018-12-16 17:17 **/@Configuration@EnableStateMachine(name="stateMachine") //å¯ä»¥é€šè¿‡è®¾ç½®åç§°æ¥å®šä¹‰è‹¥å¹²ä¸ªçŠ¶æ€æœºçš„Configï¼Œå¹¶å¯ä»¥é€šè¿‡åˆ¶å®šçŠ¶æ€æœºé…ç½®åç§°æ¥ä½¿ç”¨åˆ¶å®šçš„çŠ¶æ€æœº @EnableStateMachine(name="testMachine")public class StateMachineConfig extends EnumStateMachineConfigurerAdapter&lt;States, Events&gt; { @Autowired private InMemoryStateMachinePersist inMemoryStateMachinePersist; @Bean(name = "myPersister") public StateMachinePersister&lt;States, Events, String&gt; getPersister() { return new DefaultStateMachinePersister&lt;&gt;(inMemoryStateMachinePersist); } /** * * @title åˆå§‹åŒ–çŠ¶æ€æœºåŠåˆå§‹çŠ¶æ€ * * @description * * @see org.springframework.statemachine.config.AbstractStateMachineConfigurerAdapter#configure(org.springframework.statemachine.config.builders.StateMachineStateConfigurer) * @param states * @throws Exception */ @Override public void configure(StateMachineStateConfigurer&lt;States, Events&gt; states) throws Exception { states .withStates() .initial(States.MAKE_AN_ORDER) //åˆå§‹åŒ–çŠ¶æ€ä¸ºUNPAID .states(EnumSet.allOf(States.class)); } /** * * @title äº‹ä»¶åŠçŠ¶æ€æµè½¬é…ç½® * * @description * * @see org.springframework.statemachine.config.AbstractStateMachineConfigurerAdapter#configure(org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer) * @param transitions * @throws Exception */ @Override public void configure(StateMachineTransitionConfigurer&lt;States, Events&gt; transitions) throws Exception { transitions .withExternal() .event(Events.ORDERING) //å½“äº‹ä»¶ä¸ºORDERINGæ—¶ï¼ŒæºçŠ¶æ€ä»MAKE_AN_ORDERå˜ä¸ºUNPAID .source(States.MAKE_AN_ORDER).target(States.UNPAID) .and() .withExternal() .event(Events.PAY) //å½“äº‹ä»¶ä¸ºPAYæ—¶ï¼ŒæºçŠ¶æ€ä»UNPAIDå˜ä¸ºPAYING .source(States.UNPAID).target(States.PAYING) .and() .withExternal() .event(Events.PAYED) //å½“äº‹ä»¶ä¸ºPAYEDæ—¶ï¼ŒæºçŠ¶æ€ä»PAYINGå˜ä¸ºPAYED .source(States.PAYING).target(States.PAYED) .and() .withExternal() .event(Events.RECEIVE) //å½“äº‹ä»¶ä¸ºRECEIVEæ—¶ï¼ŒæºçŠ¶æ€ä»PAYEDå˜ä¸ºWAITING_FOR_RECEIVE .source(States.PAYED).target(States.WAITING_FOR_RECEIVE) .and() .withExternal() .event(Events.RECEIVED) //å½“äº‹ä»¶ä¸ºRECEIVEDæ—¶ï¼ŒæºçŠ¶æ€ä»WAITING_FOR_RECEIVEå˜ä¸ºCUSTOMER_RECEIVED .source(States.WAITING_FOR_RECEIVE).target(States.CUSTOMER_RECEIVED) .and() .withExternal() .event(Events.FINISH) //å½“äº‹ä»¶ä¸ºFINISHæ—¶ï¼ŒæºçŠ¶æ€ä»CUSTOMER_RECEIVEDå˜ä¸ºDONE .source(States.CUSTOMER_RECEIVED).target(States.DONE); }}</pre><p><strong>è¯´æ˜ï¼š</strong></p><p>1)æ³¨è§£ï¼š@Configurationå’Œ@EnableStateMachineï¼Œä¸€ä¸ªæ˜¯è¡¨æ˜æ­¤ç±»ä¸ºä¸€ä¸ªSpringçš„Beané…ç½®ç±»ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯è¡¨æ˜å½“å‰çš„é…ç½®æ˜¯è¦å¯ç”¨çŠ¶æ€æœºçš„è‡ªåŠ¨è£…é…ã€‚</p><p>2)çˆ¶ç±»EnumStateMachineConfigurerAdapter&lt;States,Events>ï¼Œä¸ºçŠ¶æ€æœºçš„è‡ªåŠ¨è£…é…æä¾›è‡ªå®šä¹‰çš„é…ç½®é‡å†™ï¼Œéœ€è¦é‡å†™configureæ–¹æ³•ã€‚</p><p>3)å¯ä»¥æš‚æ—¶å¿½ç•¥æœ¬ç±»ä¸­çš„å…³äºçŠ¶æ€æŒä¹…åŒ–çš„é…ç½®ï¼Œå› ä¸ºï¼Œè¿™ä¸ªé…ä¸é…ä¸å½±å“ä¸€ä¸ªçŠ¶æ€æœºShowcaseçš„å®ç°ï¼Œä¾‹å¦‚ï¼šInMemoryStateMachinePersist</p><p>4)configure(StateMachineStateConfigurer&lt;States, Events> states)throws Exception æ–¹æ³•æ˜¯ç”¨æ¥å®šä¹‰çŠ¶æ€æœºçš„åˆå§‹åŒ–çŠ¶æ€ä»¥åŠæ‰€èƒ½åŒ…å«çš„çŠ¶æ€é›†åˆã€‚</p><p>5)configure(StateMachineTransitionConfigurer&lt;States, Events> transitions)throws Exception æ–¹æ³•æ˜¯ç”¨æ¥å®šä¹‰çŠ¶æ€æœºç”±å“ªäº›äº‹ä»¶å¯¼è‡´çŠ¶æ€ä»å“ªä¸ªçŠ¶æ€è¿ç§»åˆ°å“ªä¸ªçŠ¶æ€ï¼Œå…¶ä¸­å‘½åä¸­æˆ‘ä»¬å¾ˆå®¹æ˜“ç†è§£æ¯ä¸€ä¸ªè¿ç§»åŠ¨ä½œï¼Œsourceæ˜¯æºçŠ¶æ€ï¼Œtargetæ˜¯ç›®æ ‡çŠ¶æ€ï¼Œeventä¸ºè§¦å‘äº‹ä»¶ã€‚</p><h1>4.é…ç½®äº‹ä»¶å¤„ç†è€…ï¼Œç”¨äºç›‘å¬çŠ¶æ€å˜åŒ–ï¼Œå…è®¸å½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶åˆ™æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•æ¥è¿›è¡Œç›¸å…³ä¸šåŠ¡å¤„ç†</h1><p>EventProcessor.java:</p><div class=pgc-img><img alt="SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1f581051a90141c396e16abf1d2849f0><p class=pgc-img-caption>EventProcessor</p></div><pre>package com.example.statemachine.handle;import lombok.extern.slf4j.Slf4j;import org.springframework.statemachine.annotation.OnTransition;import org.springframework.statemachine.annotation.WithStateMachine;/** * @package: com.example.statemachine.handle * @description: äº‹ä»¶å¤„ç†ç±» * @author: @ITè®²å› * @create: 2018-12-17 09:17 **/@WithStateMachine@Slf4jpublic class EventProcessor{ /** * * @title è‡ªå®šä¹‰äº‹ä»¶æ‰§è¡Œæ–¹æ³•â€”â€”1.åˆ›å»ºè®¢å• * * @description å½“çŠ¶æ€ä¸ºMAKE_AN_ORDERï¼Œå¹¶è½¬ä¸ºUNPAIDçŠ¶æ€å°±æ‰§è¡Œæ­¤æ–¹æ³• * */ @OnTransition(source="MAKE_AN_ORDER",target = "UNPAID") public void makeAnOrder() { log.info("è®¢å•å·²åˆ›å»ºï¼Œç­‰å¾…ç”¨æˆ·æ”¯ä»˜"); } /** * * @title è‡ªå®šä¹‰äº‹ä»¶æ‰§è¡Œæ–¹æ³•â€”â€”6.å®Œæˆè®¢å• * * @description å½“çŠ¶æ€ä¸ºRECEIVEDï¼Œå¹¶è½¬ä¸ºDONEçŠ¶æ€å°±æ‰§è¡Œæ­¤æ–¹æ³• * */ @OnTransition(source = "CUSTOMER_RECEIVED", target = "DONE") public void finishOrder() { log.info("è®¢å•æµç¨‹å·²å®Œæˆ"); }}</pre><p>EventProcessor2.java</p><div class=pgc-img><img alt="SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/22cd636671d4462cb0b167cfe72a71b9><p class=pgc-img-caption>EventProcessor2</p></div><pre>package com.example.statemachine.handle;import lombok.extern.slf4j.Slf4j;import org.springframework.statemachine.annotation.OnTransition;import org.springframework.statemachine.annotation.OnTransitionEnd;import org.springframework.statemachine.annotation.OnTransitionStart;import org.springframework.statemachine.annotation.WithStateMachine;/** * @package: com.example.statemachine.handle * @description: äº‹ä»¶å¤„ç†ç±» * @author: @ITè®²å› * @create: 2018-12-17 09:17 **/@WithStateMachine@Slf4jpublic class EventProcessor2 { /** * * @title è‡ªå®šä¹‰äº‹ä»¶æ‰§è¡Œæ–¹æ³•â€”â€”2.å¼€å§‹æ”¯ä»˜ * * @description å½“çŠ¶æ€ä¸ºUNPAIDï¼Œå¹¶è½¬ä¸ºPAYINGçŠ¶æ€å°±æ‰§è¡Œæ­¤æ–¹æ³• * */ @OnTransitionStart(source = "UNPAID", target = "PAYING") public void paying() { log.info("ç”¨æˆ·æ”¯ä»˜ä¸­....."); } /** * * @title è‡ªå®šä¹‰äº‹ä»¶æ‰§è¡Œæ–¹æ³•â€”â€”3.å®Œæˆæ”¯ä»˜ * * @description å½“çŠ¶æ€ä¸ºPAYINGï¼Œå¹¶è½¬ä¸ºPAYEDçŠ¶æ€å°±æ‰§è¡Œæ­¤æ–¹æ³• * */ @OnTransition(source = "PAYING", target = "PAYED") public void payed() { log.info("ç”¨æˆ·å®Œæˆæ”¯ä»˜"); } /** * * @title è‡ªå®šä¹‰äº‹ä»¶æ‰§è¡Œæ–¹æ³•â€”â€”å¹¶è¡Œ 4.1.æ”¶åˆ°æ”¯ä»˜æˆåŠŸçŸ­ä¿¡ * * @description å½“çŠ¶æ€ä¸ºPAYEDï¼Œå¹¶è½¬ä¸ºWAITING_FOR_RECEIVEçŠ¶æ€å°±æ‰§è¡Œæ­¤æ–¹æ³• * */ @OnTransitionEnd(source = "PAYED", target = "WAITING_FOR_RECEIVE") public void syncNotifyFromSMS() { log.info("æ”¶åˆ°ç”¨æˆ·æ”¯ä»˜æˆåŠŸçŸ­ä¿¡ï¼Œå‡†å¤‡å‘è´§"); } /** * * @title è‡ªå®šä¹‰äº‹ä»¶æ‰§è¡Œæ–¹æ³•â€”â€”å¹¶è¡Œ 4.2.å‘è´§ä¸­ * * @description å½“çŠ¶æ€ä¸ºPAYEDï¼Œå¹¶è½¬ä¸ºWAITING_FOR_RECEIVEçŠ¶æ€å°±æ‰§è¡Œæ­¤æ–¹æ³• * */ @OnTransitionEnd(source = "PAYED", target = "WAITING_FOR_RECEIVE") public void waitingForReceive() { log.info("ç­‰å¾…ç”¨æˆ·ç­¾æ”¶è´§å“......"); } /** * * @title è‡ªå®šä¹‰äº‹ä»¶æ‰§è¡Œæ–¹æ³•â€”â€”5.ç”¨æˆ·å®Œæˆæ”¶è´§ * * @description å½“çŠ¶æ€ä¸ºWAITING_FOR_RECEIVEï¼Œå¹¶è½¬ä¸ºRECEIVEDçŠ¶æ€å°±æ‰§è¡Œæ­¤æ–¹æ³• * */ @OnTransitionEnd(source = "WAITING_FOR_RECEIVE", target = "CUSTOMER_RECEIVED") public void received() { log.info("ç”¨æˆ·å·²ç­¾æ”¶è´§å“"); }}</pre><p><strong>è¯´æ˜:</strong></p><p>å…¶å®ä¸€ä¸ªEventProcessorç±»å°±å¯ä»¥å®Œæˆéœ€è¦çš„å¤„ç†ï¼Œä½†ä¸ºä»€ä¹ˆè¦è¿™é‡Œè¦åˆ†æˆä¸¤ä¸ªProcessorç±»æ¥å®ç°ï¼Œä¸»è¦åŸå› å°±æ˜¯æƒ³ç®€å•è®¾è®¡ä¸€ä¸‹å¯¹äºå¤„ç†è¿‡ç¨‹çš„æŠ½è±¡ï¼ŒæŠŠå¼€å§‹ä¸ç»“æŸæ”¾åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œå…·ä½“è¿‡ç¨‹æ”¾åœ¨å¦å¤–ä¸€ä¸ªç±»ä¸­ï¼›æ­¤ç±»æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><p>1)æ³¨è§£@WithStateMachineï¼Œå®šä¹‰æ­¤ç±»ä¸ºä¸€ä¸ªçŠ¶æ€ç›‘å¬è€…ï¼Œ@OnTransition(source="",target = "")ï¼Œä¸»è¦æ˜¯å®šä¹‰ä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œæ—¶æœºï¼Œä¹Ÿå°±æ˜¯å½“æºçŠ¶æ€æ˜¯Aï¼Œç›®æ ‡çŠ¶æ€æ˜¯Bæ—¶ï¼Œåˆ™æ‰§è¡Œè¿™ä¸ªæ–¹æ³•</p><p>2) ILogæ¥å£ï¼Œè¿™ä¸ªæ¥å£æ˜¯è‡ªå·±ä¸ºäº†æ–¹ä¾¿æ‰“å°æ—¥å¿—ï¼Œè‡ªå·±å°è£…çš„ä¸€ä¸ªLogback loggerçš„Handlerï¼Œå¯¹äºçŠ¶æ€æœºçš„showcaseæ²¡æœ‰å½±å“ï¼Œå„ä½å¯ä»¥ç›´æ¥å¿½ç•¥ã€‚</p><h1>5.æœ€ååˆ›å»ºä¸»å…¥å£ç±»æ¥å®Œæˆæ•´ä¸ªShowcaseçš„æµç¨‹</h1><p>StateMachineApplication.java</p><div class=pgc-img><img alt="SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/730c61941d3242c48d33f5ef2e2c6afe><p class=pgc-img-caption>StateMachineApplication</p></div><pre>package com.example.statemachine;import com.example.statemachine.enums.Events;import com.example.statemachine.enums.States;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.boot.CommandLineRunner;import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.statemachine.StateMachine;import org.springframework.statemachine.persist.StateMachinePersister;import javax.annotation.Resource;@SpringBootApplication@Slf4jpublic class StatemachineApplication implements CommandLineRunner { @Value("${spring.application.name}") private String proName; /** çŠ¶æ€æœºå¯¹è±¡ */ @Resource //ä½¿ç”¨åˆ¶å®šçš„çŠ¶æ€æœºé…ç½®è¿›è¡Œæ³¨å…¥ï¼Œä¾‹å¦‚ï¼š@Resource(name="testMachine"); è¿™æ ·å¯ä»¥æœ‰å¤šä¸ªçŠ¶æ€æœºå®ä¾‹ private StateMachine&lt;States, Events&gt; stateMachine; /** çŠ¶æ€æœºæŒä¹…åŒ– */ @Autowired private StateMachinePersister&lt;States, Events, String&gt; persist; public static void main(String[] args) { SpringApplication.run(StatemachineApplication.class, args); } /** * * @title äº‹ä»¶é©±åŠ¨ä¸šåŠ¡æµç¨‹ä¸»æ§æ–¹æ³• * * @description * 1.å¯åŠ¨çŠ¶æ€æœº * 2.å‘é€äº‹ä»¶ * 3.å°†æŸä¸€äº‹ä»¶è¿›è¡ŒæŒä¹…åŒ– * 4.æ‰“å°çŠ¶æ€æœºçš„å½“å‰çŠ¶æ€ * 5.å–å›è¢«æŒä¹…åŒ–çš„çŠ¶æ€å¹¶æ‰“å°  * * * @see org.springframework.boot.CommandLineRunner#run(java.lang.String[]) * @param args * @throws Exception */ @Override public void run(String... args) throws Exception { log.info("==========================================Project name : {}" , proName); stateMachine.start(); stateMachine.sendEvent(Events.ORDERING); stateMachine.sendEvent(Events.PAY); stateMachine.sendEvent(Events.PAYED); persist.persist(stateMachine, "MyRegion"); log.info("Store the state in MyRegion ================1: {}",stateMachine.getState().getId()); stateMachine.sendEvent(Events.RECEIVE); stateMachine.sendEvent(Events.RECEIVED); stateMachine.sendEvent(Events.FINISH); log.info("The state Now ================2: {}",stateMachine.getState().getId()); persist.restore(stateMachine, "MyRegion"); log.info("Restore the state from MyRegion ================3: {}",stateMachine.getState().getId()); }}</pre><p><strong>è¯´æ˜ï¼š</strong></p><p>åœ¨runæ–¹æ³•ä¸­ï¼Œå®šä¹‰äº†æµç¨‹çš„é©±åŠ¨å¤„ç†è¿‡ç¨‹ï¼Œå…¶ä¸­start()æ˜¯æ ¹æ®ä¹‹å‰çš„å®šä¹‰è§¦å‘çŠ¶æ€æœºå¯åŠ¨è¿™ä¸ªè®¢å•æµç¨‹ï¼Œå¹¶ä¸€æ­¥æ­¥çš„sendEventæ¥æŒç»­é©±åŠ¨ï¼Œç›´è‡³æœ€ç»ˆçš„FINISHäº‹ä»¶å‘å‡ºã€‚</p><p>æ³¨æ„å‡ ç‚¹ï¼š</p><p>1)persist.persistå’Œpersist.restoreè¿™ä¸¤ä¸ªæ–¹æ³•è°ƒç”¨æ˜¯å…³äºæŒä¹…åŒ–å’Œè·å–è¿™ä¸ªæµç¨‹çŠ¶æ€çš„ï¼Œå¯ä»¥ä¸ç”¨å…³å¿ƒï¼Œé™¤éæƒ³äº†è§£å¦‚ä½•æŒä¹…åŒ–çŠ¶æ€æœºå†…ç¬æ—¶çŠ¶æ€åŠçŠ¶æ€è·å–çš„ã€‚</p><p>2)ç›´æ¥è¿è¡Œè¿™ä¸ªMainå‡½æ•°ã€JUnitæˆ–ä½¿ç”¨mavenå®¢æˆ·ç«¯æ¥æ‰§è¡Œspring boot cliå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š clean compile spring-boot:run</p><p>è‡³æ­¤ï¼Œå°±å®Œæˆäº†ä¸€ä¸ªæ¨¡æ‹Ÿè®¢å•ä¸‹å•åœºæ™¯çš„çŠ¶æ€æœºé©±åŠ¨è¿‡ç¨‹çš„Showcaseã€‚</p><h1>6.éªŒè¯</h1><div class=pgc-img><img alt="SpringBoot é›†æˆStateMachineå®ç°çŠ¶æ€æœº" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/73b2bf94197d40138c2bb3e2440d508b><p class=pgc-img-caption>éªŒè¯</p></div><p>ç”±æ­¤å¯ä»¥çœ‹å‡ºå„ä¸ªçŠ¶æ€ä¹‹é—´çš„å˜åŒ–ï¼Œå¾ˆæ¸…æ™°äº†ã€‚å¦‚æœå„ä½åŒå­¦è¿˜æœ‰ä¸æ˜ç™½çš„åœ°æ–¹å¯ä»¥ç§ä¿¡å›å¤å“ˆï¼ŒåŒæ—¶å¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å„ä½å°ä¼™ä¼´æ‰¹è¯„æŒ‡æ•™ã€‚</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'SpringBoot','StateMachine','å®ç°'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>