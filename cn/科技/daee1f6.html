<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MySQL事务提交过程（一） | 极客快訊</title><meta property="og:title" content="MySQL事务提交过程（一） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/61f7b3575cea4b20b5e0400f9ad4d11b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/daee1f6.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/daee1f6.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/daee1f6.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/daee1f6.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/daee1f6.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/daee1f6.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/daee1f6.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/daee1f6.html><meta property="article:published_time" content="2020-10-29T20:50:41+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:41+08:00"><meta name=Keywords content><meta name=description content="MySQL事务提交过程（一）"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/daee1f6.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MySQL事务提交过程（一）</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>MySQL作为一种关系型数据库，已被广泛应用到互联网中的诸多项目中。今天我们来讨论下事务的提交过程。</p><div class=pgc-img><img alt=MySQL事务提交过程（一） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/61f7b3575cea4b20b5e0400f9ad4d11b><p class=pgc-img-caption></p></div><p>MySQL体系结构</p><p></p><p>由于mysql插件式存储架构，导致开启binlog后，事务提交实质是二阶段提交，通过两阶段提交，来保证存储引擎和二进制日志的一致。</p><p>本文仅讨论binlog未打卡状态下的提交流程，后续会讨论打开binlog选项后的提交逻辑。</p><p></p><p>测试环境</p><p>OS:WIN7</p><p>ENGINE:</p><div class=pgc-img><img alt=MySQL事务提交过程（一） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/37df50975c7b44ed8b102c9596eefab1><p class=pgc-img-caption></p></div><p>bin-log：off</p><div class=pgc-img><img alt=MySQL事务提交过程（一） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/373ea2c5715346e4af566ac61113cb3b><p class=pgc-img-caption></p></div><p>DB:</p><div class=pgc-img><img alt=MySQL事务提交过程（一） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d0f9d86d78e04229ab52f631242237fa><p class=pgc-img-caption></p></div><p></p><p>测试条件</p><pre><code>set autocommit=0;</code></pre><pre><code>-- ------------------------------ Table structure for `user`-- ----------------------------DROP TABLE IF EXISTS `user`;CREATE TABLE `user` (`id` int(20) NOT NULL,`account` varchar(20) NOT NULL,`name` varchar(20) NOT NULL,PRIMARY KEY (`id`),KEY `id` (`id`) USING BTREE,KEY `name` (`name`) USING BTREE) ENGINE=InnoDB DEFAULT CHARSET=utf8;</code></pre><p></p><p>测试语句</p><pre><code>insert into user values(1, 'sanzhang', '张三');</code></pre><pre><code>commit;</code></pre><p></p><p>一般常用的DML：Data Manipulation Language 数据操纵语言，对表的数据进行操作，（insert、update、delete ）语句 和 DCL：Data Control Language 数据库控制语言</p><p>（创建用户、删除用户、授权、取消授权）语句 和 DDL：Data Definition Language 数据库定义语言，对数据库内部的对象进行创建、删除、修改的操语句</p><p>，均是使用MySQL提供的公共接口mysql_execute_command，来执行相应的SQL语句。我们来分析下mysql_execute_command接口执行的流程：</p><pre><code>mysql_execute_command{   switch (command)   {       case SQLCOM_INSERT:                mysql_insert();                break;       case SQLCOM_UPDATE:                mysql_update();                break;       case SQLCOM_DELETE:                mysql_delete();                break;       ......   }   if thd-&gt;is_error()  //语句执行错误     trans_rollback_stmt(thd);  else    trans_commit_stmt(thd);}</code></pre><p></p><p>从上述流程中，可以看到执行任何语句，最后都会执行trans_rollback_stmt或者trans_commit_stmt，这两个分别是语句回滚和语句提交。</p><p>语句提交，对于非自动模式下，主要有两个作用：</p><p>1、释放autoinc锁，这个锁主要用来处理多个事务互斥的获取自增序列。因此，无论最后执行的是语句提交还是语句回滚，该资源都是需要立马释放掉的。</p><p>2、标识语句在事务中的位置，方便语句级回滚。执行commit后，可以进入commit流程。</p><p>现在看下具体的事务提交流程：</p><pre><code>mysql_execute_commandtrans_commit_stmtha_commit_trans(thd, FALSE);{    TC_LOG_DUMMY:ha_commit_low        ha_commit_low()               innobase_commit            {                //获取innodb层对应的事务结构                trx = check_trx_exists(thd);                if(单个语句，且非自动提交)                {                     //释放自增列占用的autoinc锁资源                     lock_unlock_table_autoinc(trx);                     //标识sql语句在事务中的位置，方便语句级回滚                     trx_mark_sql_stat_end(trx);                }                else 事务提交                {                     innobase_commit_low()                     {                          trx_commit_for_mysql();                            &lt;span style="color: #ff0000;"&gt;trx_commit&lt;/span&gt;(trx);                      }//确定事务对应的redo日志是否落盘【根据flush_log_at_trx_commit参数，确定redo日志落盘方式】                    trx_commit_complete_for_mysql(trx);trx_flush_log_if_needed_low(trx-&gt;commit_lsn);log_write_up_to(lsn);                }            }}</code></pre><pre><code>trx_commit    trx_commit_low        {            trx_write_serialisation_history            {                trx_undo_update_cleanup //供purge线程处理，清理回滚页            }            trx_commit_in_memory            {                lock_trx_release_locks //释放锁资源                trx_flush_log_if_needed(lsn) //刷日志                trx_roll_savepoints_free //释放savepoints            }        }</code></pre><p></p><p>MySQL是通过WAL方式，来保证数据库事务的一致性和持久性，即ACID特性中的C(consistent)和D(durability)。</p><p>WAL（Write-Ahead Logging）是一种实现事务日志的标准方法，具体而言就是:</p><p>1、修改记录前，一定要先写日志；</p><p>2、事务提交过程中，一定要保证日志先落盘，才能算事务提交完成。</p><p>通过WAL方式，在保证事务特性的情况下，可以提高数据库的性能。</p><p></p><p>从上述流程可以看出，提交过程中，主要做了4件事情，</p><p>1、清理undo段信息，对于innodb存储引擎的更新操作来说，undo段需要purge，这里的purge主要职能是，真正删除物理记录。在执行delete或update操作时，实际旧记录没有真正删除，只是在记录上打了一个标记，而是在事务提交后，purge线程真正删除，释放物理页空间。因此，提交过程中会将undo信息加入purge列表，供purge线程处理。</p><p>2、释放锁资源，mysql通过锁互斥机制保证不同事务不同时操作一条记录，事务执行后才会真正释放所有锁资源，并唤醒等待其锁资源的其他事务；</p><p>3、刷redo日志，前面我们说到，mysql实现事务一致性和持久性的机制。通过redo日志落盘操作，保证了即使修改的数据页没有即使更新到磁盘，只要日志是完成了，就能保证数据库的完整性和一致性；</p><p>4、清理保存点列表，每个语句实际都会有一个savepoint(保存点)，保存点作用是为了可以回滚到事务的任何一个语句执行前的状态，由于事务都已经提交了，所以保存点列表可以被清理了。</p><p></p><p>关于mysql的锁机制，purge原理，redo日志，undo段等内容，其实都是数据库的核心内容。</p><div class=pgc-img><img alt=MySQL事务提交过程（一） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a01175f8017c4ff48f1c39b8a938b61b><p class=pgc-img-caption></p></div><p>MySQL 本身不提供事务支持，而是开放了存储引擎接口，由具体的存储引擎来实现，具体来说支持 MySQL 事务的存储引擎就是 InnoDB。</p><p>存储引擎实现事务的通用方式是基于 redo log 和 undo log。</p><p>简单来说，redo log 记录事务修改后的数据, undo log 记录事务前的原始数据。</p><p>所以当一个事务执行时实际发生过程简化描述如下：</p><ol start=1><li>先记录 undo/redo log，确保日志刷到磁盘上持久存储。</li><li>更新数据记录，缓存操作并异步刷盘。</li><li>提交事务，在 redo log 中写入 commit 记录。</li></ol><p>在 MySQL 执行事务过程中如果因故障中断，可以通过 redo log 来重做事务或通过 undo log 来回滚，确保了数据的一致性。</p><p>这些都是由事务性存储引擎来完成的，但 binlog 不在事务存储引擎范围内，而是由 MySQL Server 来记录的。</p><p>那么就必须保证 binlog 数据和 redo log 之间的一致性，所以开启了 binlog 后实际的事务执行就多了一步，如下：</p><ol start=1><li>先记录 undo/redo log，确保日志刷到磁盘上持久存储。</li><li>更新数据记录，缓存操作并异步刷盘。</li><li>将事务日志持久化到 binlog。</li><li>提交事务，在 redo log 中写入commit记录。</li></ol><p>这样的话，只要 binlog 没写成功，整个事务是需要回滚的，而 binlog 写成功后即使 MySQL Crash 了都可以恢复事务并完成提交。</p><p>要做到这点，就需要把 binlog 和事务关联起来，而只有保证了 binlog 和事务数据的一致性，才能保证主从数据的一致性。</p><p>所以 binlog 的写入过程不得不嵌入到纯粹的事务存储引擎执行过程中，并以内部分布式事务（xa 事务）的方式完成两阶段提交。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'MySQL','事务','过程'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>