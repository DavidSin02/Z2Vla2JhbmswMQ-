<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç† | æå®¢å¿«è¨Š</title><meta property="og:title" content="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç† - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/d07cbed4a00b44508640b7c382aadd56"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><meta property="article:published_time" content="2020-10-29T20:50:33+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:33+08:00"><meta name=Keywords content><meta name=description content="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/dd332fa.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>Codis ç®€ä»‹</h1><p>Codis æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ Redis è§£å†³æ–¹æ¡ˆ, å¯¹äºä¸Šå±‚çš„åº”ç”¨æ¥è¯´, è¿æ¥åˆ° Codis Proxy å’Œè¿æ¥åŸç”Ÿçš„ Redis Server æ²¡æœ‰æ˜¾è‘—åŒºåˆ« (æœ‰ä¸€äº›å‘½ä»¤ä¸æ”¯æŒ), ä¸Šå±‚åº”ç”¨å¯ä»¥åƒä½¿ç”¨å•æœºçš„ Redis ä¸€æ ·ä½¿ç”¨, Codis åº•å±‚ä¼šå¤„ç†è¯·æ±‚çš„è½¬å‘, ä¸åœæœºçš„æ•°æ®è¿ç§»ç­‰å·¥ä½œ, æ‰€æœ‰åè¾¹çš„ä¸€åˆ‡äº‹æƒ…, å¯¹äºå‰é¢çš„å®¢æˆ·ç«¯æ¥è¯´æ˜¯é€æ˜çš„, å¯ä»¥ç®€å•çš„è®¤ä¸ºåè¾¹è¿æ¥çš„æ˜¯ä¸€ä¸ªå†…å­˜æ— é™å¤§çš„ Redis æœåŠ¡ã€‚</p><p><strong>Codisçš„githubï¼šhttps://github.com/CodisLabs/codis</strong></p><p><br></p><h1 class=pgc-h-arrow-right>Codisç‰¹æ€§å¦‚ä¸‹</h1><ul><li>æœ€æ–° release ç‰ˆæœ¬ä¸º codis-3.2ï¼Œcodis-server åŸºäº redis-3.2.8</li><li>æ”¯æŒ slot åŒæ­¥è¿ç§»ã€å¼‚æ­¥è¿ç§»å’Œå¹¶å‘è¿ç§»ï¼Œå¯¹ key å¤§å°æ— ä»»ä½•é™åˆ¶ï¼Œè¿ç§»æ€§èƒ½å¤§å¹…åº¦æå‡</li><li>ç›¸æ¯”0ï¼šé‡æ„äº†æ•´ä¸ªé›†ç¾¤ç»„ä»¶é€šä¿¡æ–¹å¼ï¼Œcodis-proxy ä¸ zookeeper å®ç°äº†è§£è€¦ï¼ŒåºŸå¼ƒäº†codis-config ç­‰</li><li>å…ƒæ•°æ®å­˜å‚¨æ”¯æŒ etcd/zookeeper/filesystem ç­‰ï¼Œå¯è‡ªè¡Œæ‰©å±•æ”¯æŒæ–°çš„å­˜å‚¨ï¼Œé›†ç¾¤æ­£å¸¸è¿è¡ŒæœŸé—´ï¼Œå³ä¾¿å…ƒå­˜å‚¨æ•…éšœä¹Ÿä¸å†å½±å“ codis é›†ç¾¤ï¼Œå¤§å¤§æå‡ codis-proxy ç¨³å®šæ€§</li><li>å¯¹ codis-proxy è¿›è¡Œäº†å¤§é‡æ€§èƒ½ä¼˜åŒ–,é€šè¿‡æ§åˆ¶GCé¢‘ç‡ã€å‡å°‘å¯¹è±¡åˆ›å»ºã€å†…å­˜é¢„åˆ†é…ã€å¼•å…¥ cgoã€jemalloc ç­‰ï¼Œä½¿å…¶ååè¿˜æ˜¯å»¶è¿Ÿï¼Œéƒ½å·²è¾¾åˆ° codis é¡¹ç›®ä¸­æœ€ä½³</li><li>proxy å®ç° select å‘½ä»¤ï¼Œæ”¯æŒå¤š DB</li><li>proxy æ”¯æŒè¯»å†™åˆ†ç¦»ã€ä¼˜å…ˆè¯»åŒ IP/åŒ DC ä¸‹å‰¯æœ¬åŠŸèƒ½</li><li>åŸºäº redis-sentinel å®ç°ä¸»å¤‡è‡ªåŠ¨åˆ‡æ¢</li><li>å®ç°åŠ¨æ€ pipeline ç¼“å­˜åŒºï¼ˆå‡å°‘å†…å­˜åˆ†é…ä»¥åŠæ‰€å¼•èµ·çš„ GC é—®é¢˜ï¼‰</li><li>proxy æ”¯æŒé€šè¿‡ HTTP è¯·æ±‚å®æ—¶è·å– runtime metricsï¼Œä¾¿äºç›‘æ§ã€è¿ç»´</li><li>æ”¯æŒé€šè¿‡ influxdb å’Œ statsd é‡‡é›† proxy metrics</li><li>slot auto rebalance ç®—æ³•ä»0 çš„åŸºäº max memory policy å˜æ›´æˆåŸºäº group ä¸‹ slot æ•°é‡</li><li>æä¾›äº†æ›´åŠ å‹å¥½çš„ dashboard å’Œ fe ç•Œé¢ï¼Œæ–°å¢äº†å¾ˆå¤šæŒ‰é’®ã€è·³è½¬é“¾æ¥ã€é”™è¯¯çŠ¶æ€ç­‰ï¼Œæœ‰åˆ©äºå¿«é€Ÿå‘ç°ã€å¤„ç†é›†ç¾¤æ•…éšœ</li><li>æ–°å¢ SLOTSSCAN æŒ‡ä»¤ï¼Œä¾¿äºè·å–é›†ç¾¤å„ä¸ª slot ä¸‹çš„æ‰€æœ‰ key</li><li>codis-proxy ä¸ codis-dashbaord æ”¯æŒ docker éƒ¨ç½²</li></ul><h1 class=pgc-h-arrow-right>codisæ¶æ„å¦‚ä¸‹</h1><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d07cbed4a00b44508640b7c382aadd56><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>codis ç»„ä»¶ä»‹ç»</h1><p><strong>codis server</strong>ï¼šåŸºäºredis-3.2.8 åˆ†æ”¯å¼€å‘ã€‚å¢åŠ äº†é¢å¤–çš„æ•°æ®ç»“æ„ï¼Œä»¥æ”¯æŒslotæœ‰å…³çš„æ“ä½œä»¥åŠæ•°æ®è¿ç§»æŒ‡ä»¤ã€‚å…·ä½“çš„ä¿®æ”¹å¯ä»¥å‚è€ƒæ–‡æ¡£redisçš„ä¿®æ”¹</p><p><strong>codis proxy</strong>ï¼šå®¢æˆ·ç«¯è¿æ¥çš„redisä»£ç†æœåŠ¡ï¼Œå®ç°äº†redisåè®®ã€‚é™¤éƒ¨åˆ†å‘½ä»¤ä¸æ”¯æŒä»¥å¤–ï¼ˆä¸æ”¯æŒçš„å‘½ä»¤åˆ—è¡¨ï¼‰ï¼Œè¡¨ç°çš„å’ŒåŸç”Ÿçš„redisæ²¡æœ‰åŒºåˆ«ã€‚</p><p>å¯¹äºåŒä¸€ä¸ªä¸šåŠ¡é›†ç¾¤è€Œè¨€ï¼Œå¯ä»¥åŒæ—¶éƒ¨ç½²å¤šä¸ªcodis-proxyå®ä¾‹ï¼›</p><p>ä¸åŒcodis-proxyä¹‹é—´ç”±codis-dashboardä¿è¯çŠ¶æ€åŒæ­¥ã€‚</p><p><strong>codis dashboard</strong>ï¼šé›†ç¾¤ç®¡ç†å·¥å…·ï¼Œæ”¯æŒcodis-proxyã€codis-serverçš„æ·»åŠ ã€åˆ é™¤ã€ä»¥åŠæ•°æ®è¿ç§»æ“ä½œã€‚åœ¨é›†ç¾¤çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œcodis-dashboardç»´æŠ¤é›†ç¾¤ä¸‹æ‰€æœ‰codis-proxyçš„çŠ¶æ€ä¸€è‡´æ€§ã€‚</p><p>å¯¹äºåŒä¸€ä¸ªä¸šåŠ¡é›†ç¾¤è€Œè¨€ï¼ŒåŒä¸€æ—¶åˆ»codis-dashboardåªèƒ½æœ‰0ä¸ªæˆ–è€…1ä¸ª</p><p>æ‰€æœ‰å¯¹é›†ç¾¤çš„ä¿®æ”¹éƒ½å¿…é¡»é€šè¿‡codis-dashboardå®Œæˆã€‚</p><p><strong>codis FE</strong>ï¼šé›†ç¾¤ç®¡ç†ç•Œé¢</p><p>å¤šä¸ªé›†ç¾¤å®ä¾‹å…±äº«å¯ä»¥å…±äº«åŒä¸€ä¸ªå‰ç«¯å±•ç¤ºé¡µé¢ï¼›</p><p>é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†åç«¯codis-dashboardåˆ—è¡¨ï¼Œé…ç½®æ–‡ä»¶å¯è‡ªåŠ¨æ›´æ–°ã€‚</p><p><strong>storage</strong>ï¼š</p><p>æä¾›namespaceæ¦‚å¿µï¼Œä¸åŒé›†ç¾¤ä¼šæŒ‰ç…§ä¸åŒproduct nameè¿›è¡Œç»„ç»‡ï¼›</p><p>ç›®å‰ä»…æä¾›äº†zookeeperã€etcdã€fsä¸‰ç§å®ç°ï¼Œä½†æ˜¯æä¾›äº†æŠ½è±¡çš„interfaceå¯è‡ªè¡Œæ‰©å±•ã€‚</p><p><br></p><h1 class=pgc-h-arrow-right>codis æ˜¯å¦‚ä½•åˆ†ç‰‡çš„</h1><p>Codis é‡‡ç”¨ Pre-sharding çš„æŠ€æœ¯æ¥å®ç°æ•°æ®çš„åˆ†ç‰‡, é»˜è®¤åˆ†æˆ 1024 ä¸ª slots (0-1023), å¯¹äºæ¯ä¸ªkeyæ¥è¯´, é€šè¿‡ä»¥ä¸‹å…¬å¼ç¡®å®šæ‰€å±çš„ Slot Id : SlotId = crc32(key) % 1024ã€‚</p><p>æ¯ä¸€ä¸ª slot éƒ½ä¼šæœ‰ä¸€ä¸ªä¸”å¿…é¡»æœ‰ä¸€ä¸ªç‰¹å®šçš„ server group id æ¥è¡¨ç¤ºè¿™ä¸ª slot çš„æ•°æ®ç”±å“ªä¸ª server group æ¥æä¾›ã€‚æ•°æ®çš„è¿ç§»ä¹Ÿæ˜¯ä»¥slotä¸ºå•ä½çš„ã€‚</p><p><br></p><h1 class=pgc-h-arrow-right>Codiséƒ¨ç½²</h1><h1 class=pgc-h-arrow-right>ç¯å¢ƒè¯´æ˜</h1><p>èŠ‚ç‚¹ç¼–å·IPåœ°å€æ“ä½œç³»ç»Ÿnode1192.168.28.71Centos 7.2node2192.168.28.72Centos 7.2node3192.168.28.73Centos 7.2</p><p>Codiséƒ¨ç½²æ¶æ„å¦‚ä¸‹å›¾</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/990df85e4fa645d19160f5a3b63c9976><p class=pgc-img-caption></p></div><p>codis serverä¸»ä»åˆ†å¸ƒå¦‚ä¸‹å›¾</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6f14b9c6313442d6854cb296eecfed58><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>å®‰è£…éƒ¨ç½²</h1><h1 class=pgc-h-arrow-right>zookeeper å®‰è£…</h1><p>codisçš„å…ƒæ•°æ®å­˜å‚¨ä¾èµ–zookeeperï¼Œæ‰€ä»¥åœ¨å®‰è£…codisä¹‹å‰æˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ªzookeeperç¯å¢ƒ</p><p>å®‰è£…è¿‡ç¨‹ç•¥</p><h1 class=pgc-h-arrow-right>goå®‰è£…</h1><p>ç”±äºcodisæ˜¯goè¯­è¨€å†™çš„ï¼Œæ‰€ä»¥éœ€è¦åœ¨æ¯å°codisä¸»æœºå®‰è£…goè¯­è¨€è¿è¡Œç¯å¢ƒã€‚</p><p>1ã€å®‰è£…go</p><pre><code>[root@node1 ~]# yum -y install golang</code></pre><p>2ã€è®¾ç½®goè¿è¡Œç¯å¢ƒ</p><pre><code>[root@node1 ~]# mkdir /data/go -p[root@node1 ~]# vim /etc/profileexport GOPATH=/data/goexport PATH=$PATH:$GOPATH/bin[root@node1 ~]# source /etc/profile</code></pre><p>3ã€å®‰è£…godep</p><p><br></p><pre><code>[root@node1 ~]# yum -y install git[root@node1 ~]# go get -u github.com/tools/godep &amp;&amp; which godep/data/go/bin/godep</code></pre><h1 class=pgc-h-arrow-right>codis å®‰è£…</h1><p><strong>1ã€å®‰è£…ä¾èµ–</strong></p><pre><code>yumÂ installÂ autoconfÂ automakeÂ libtoolÂ -y</code></pre><p><strong>2ã€ç¼–è¯‘å®‰è£…</strong></p><p><br></p><pre><code>mkdir -pÂ /data/go/src/github.com/CodisLabscd /data/go/src/github.com/CodisLabsgit clone https://github.com/CodisLabs/codis.git -b release3.2cd codis/make</code></pre><p><strong>3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹dashboard é…ç½®ä¿®æ”¹</strong></p><p><br></p><pre><code># vim config/dashboard.tomlcoordinator_name =Â "zookeeper"coordinator_addr =Â "192.168.28.71:2181,192.168.28.72:2181,192.168.28.73:2181"product_name =Â "xuele-codis"</code></pre><p>å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹</p><pre><code>scp config/dashboard.toml 10.1.13.172:/data/go/src/github.com/CodisLabs/codis/config/dashboard.toml</code></pre><pre><code>scp config/dashboard.toml 10.1.13.173:/data/go/src/github.com/CodisLabs/codis/config/dashboard.toml</code></pre><p><strong>4ã€codis-proxyé…ç½®</strong></p><pre><code># vim config/proxy.tomlproduct_name =Â "xuele-codis"product_auth =Â ""jodis_name =Â "zookeeper"jodis_addr =Â "192.168.28.71:2181,192.168.28.72:2181,192.168.28.73:2181"jodis_auth =Â ""jodis_timeout =Â "20s"jodis_compatible =Â true</code></pre><p>å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹</p><pre><code>scp config/proxy.toml 10.1.13.172:/data/go/src/github.com/CodisLabs/codis/config/proxy.tomlscp config/proxy.toml 10.1.13.173:/data/go/src/github.com/CodisLabs/codis/config/proxy.toml</code></pre><p><strong>5ã€codis-serveré…ç½®</strong></p><pre><code>[root@c7-node1 redis-3.2.11]# pwd/data/go/src/github.com/CodisLabs/codis/extern/redis-3.2.11[root@c7-node1 redis-3.2.11]# mkdir /data/redis[root@c7-node1 redis-3.2.11]# cp redis.conf /data/redis/redis-6379.conf[root@c7-node1 redis-3.2.11]# cp redis.conf /data/redis/redis-6380.conf[root@c7-node1 redis-3.2.11]# cp redis.conf /data/redis/redis-6381.conf</code></pre><p><strong>6ã€redisé…ç½®æ–‡ä»¶ä¿®æ”¹</strong></p><p><br></p><pre><code># vim /data/redis/redis-6379.confport 6379pidfileÂ /tmp/redis_6379.pidlogfileÂ "/tmp/redis_6379.log"dbfilename dump_6379.rdbmaxmemory 1gdir /data/redis/redis_6379ä¿®æ”¹6379ä¸º6380</code></pre><p><br></p><pre><code># vim /data/redis/redis-6380.confport 6380pidfileÂ /tmp/redis_6380.pidlogfileÂ "/tmp/redis_6380.log"dbfilename dump_6380.rdbmaxmemory 1gdir /data/redis/redis_6380</code></pre><p>ä¿®æ”¹6379ä¸º6381</p><pre><code># vim /data/redis/redis-6381.confport 6381pidfileÂ /tmp/redis_6381.pidlogfileÂ "/tmp/redis_6381.log"dbfilename dump_6381.rdbmaxmemory 1gdir /data/redis/redis_6381</code></pre><p>å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹</p><pre><code>scp /data/redis/*.conf 10.1.13.172:/data/redis/scp /data/redis/*.conf 10.1.13.173:/data/redis/</code></pre><p>ä¿®æ”¹å®Œé…ç½®æ–‡ä»¶ï¼Œè¿˜éœ€è¦åˆ›å»ºç›¸å…³ç›®å½•</p><pre><code>mkdir /data/redis/redis_6379 -pmkdir /data/redis/redis_6380 -pmkdir /data/redis/redis_6381 -p</code></pre><p><strong>7ã€æœåŠ¡å¯åŠ¨åŠåˆå§‹åŒ–é›†ç¾¤å¯åŠ¨dashboard</strong></p><p># nohup ./bin/codis-dashboard --ncpu=1 --config=config/dashboard.toml --log=dashboard.log --log-level=WARN >> /var/log/codis_dashboard.log &</p><p>å¯åŠ¨proxy</p><pre><code>nohup ./bin/codis-proxy --ncpu=1 --config=config/proxy.toml --log=proxy.log --log-level=WARN &gt;&gt;Â /var/log/codis_proxy.log &amp;</code></pre><p>å¯åŠ¨codis server</p><pre><code>nohup ./bin/codis-server /data/redis/redis-6379.conf &amp;nohup ./bin/codis-server /data/redis/redis-6380.conf &amp;nohup ./bin/codis-server /data/redis/redis-6381.conf &amp;</code></pre><p>å¯åŠ¨codis-fe</p><pre><code>nohup ./bin/codis-fe --ncpu=1 --log=fe.log --log-level=WARN --zookeeper=192.168.28.71:2181,192.168.28.72:2181,192.168.28.73:2181 --listen=192.168.28.71:8090 &amp;</code></pre><p>è®¿é—®codisç®¡ç†ç•Œé¢</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a62eab6581b648d69861b5d6153f778c><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>webç•Œé¢é…ç½®</h1><p><strong>1ã€æ·»åŠ proxy</strong></p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f9c334ab1ccf49d2ac2e6242916b615f><p class=pgc-img-caption></p></div><p><strong>2ã€æ·»åŠ groupå’Œserver</strong></p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f736c7a4cf8f41f8918f8993e1b74b24><p class=pgc-img-caption></p></div><p><strong>3ã€é€šè¿‡feåˆå§‹åŒ–solt</strong></p><p>æ–°å¢çš„é›†ç¾¤ slot çŠ¶æ€æ˜¯ offlineï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯¹å®ƒè¿›è¡Œåˆå§‹åŒ–ï¼ˆå°† 1024 ä¸ª slot åˆ†é…åˆ°å„ä¸ª groupï¼‰ï¼Œè€Œåˆå§‹åŒ–æœ€å¿«çš„æ–¹æ³•å¯é€šè¿‡ fe æä¾›çš„ rebalance all slots æŒ‰é’®æ¥åšï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç‚¹å‡»æ­¤æŒ‰é’®ï¼Œæˆ‘ä»¬å³å¿«é€Ÿå®Œæˆäº†ä¸€ä¸ªé›†ç¾¤çš„æ­å»ºã€‚</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/46e2e3fb127a4c0590e51579fd687326><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>æµ‹è¯•éªŒè¯</h1><p>é€šè¿‡è¿æ¥codis-proxyè¿›è¡ŒéªŒè¯</p><pre><code># redis-cli -h 192.168.28.71 -p 19000192.168.28.71:19000&gt; INFO# Serverredis_version:3.2.11redis_git_sha1:7191a280redis_git_dirty:0redis_build_id:a9271caacf948e7redis_mode:standaloneos:Linux 3.10.0-514.el7.x86_64 x86_64arch_bits:64multiplexing_api:epollgcc_version:4.8.5process_id:48993run_id:2f8dff0622b212a2838f232abf8a166c0f0efb25tcp_port:6379uptime_in_seconds:1369uptime_in_days:0hz:10lru_clock:7144691executable:/data/go/src/github.com/CodisLabs/codis/./bin/codis-serverconfig_file:/data/redis/redis-6379.confÂ # Clientsconnected_clients:49client_longest_output_list:0client_biggest_input_buf:0blocked_clients:0Â # Memoryused_memory:5338840used_memory_human:5.09Mused_memory_rss:13819904used_memory_rss_human:13.18Mused_memory_peak:6361912used_memory_peak_human:6.07Mtotal_system_memory:1912107008total_system_memory_human:1.78Gused_memory_lua:37888used_memory_lua_human:37.00Kmaxmemory:1000000000maxmemory_human:953.67Mmaxmemory_policy:noevictionmem_fragmentation_ratio:2.59mem_allocator:jemalloc-4.0.3Â # Persistenceloading:0rdb_changes_since_last_save:0rdb_bgsave_in_progress:0rdb_last_save_time:1533870359rdb_last_bgsave_status:okrdb_last_bgsave_time_sec:1rdb_current_bgsave_time_sec:-1aof_enabled:0aof_rewrite_in_progress:0aof_rewrite_scheduled:0aof_last_rewrite_time_sec:-1aof_current_rewrite_time_sec:-1aof_last_bgrewrite_status:okaof_last_write_status:okÂ # Statstotal_connections_received:150total_commands_processed:7126instantaneous_ops_per_sec:22total_net_input_bytes:153606total_net_output_bytes:2783917instantaneous_input_kbps:0.36instantaneous_output_kbps:8.56rejected_connections:0sync_full:1sync_partial_ok:0sync_partial_err:0expired_keys:0evicted_keys:0keyspace_hits:0keyspace_misses:0pubsub_channels:0pubsub_patterns:0latest_fork_usec:18123migrate_cached_sockets:0Â # Replicationrole:masterconnected_slaves:1slave0:ip=192.168.28.71,port=6380,state=online,offset=1373,lag=1master_repl_offset:1373repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:2repl_backlog_histlen:1372Â # CPUused_cpu_sys:1.65used_cpu_user:0.72used_cpu_sys_children:0.31used_cpu_user_children:0.00Â # Clustercluster_enabled:0Â </code></pre><p># Keyspace</p><p>è¯»å†™æ•°æ®éªŒè¯</p><pre><code>192.168.28.71:19000&gt; SET name heheOK192.168.28.71:19000&gt; GET name"hehe"webç•Œé¢éªŒè¯keyå·²ç»æ­£å¸¸å†™å…¥</code></pre><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/32de74e96d4d46c280ad18a8ead61def><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>å‹æµ‹</h1><pre><code>[root@c7-node1 codis]# ./bin/redis-benchmark -h 192.168.28.71 -p 19000 -c 100 -d 100 -t set -n 10000 -r 10000</code></pre><p>ä¸Šè¿°å‘½ä»¤çš„æ„æ€æ˜¯ï¼Œä½¿ç”¨redis-benchmarkå‹åŠ›æµ‹è¯•å‘½ä»¤è¿æ¥codisé›†ç¾¤ï¼ŒåŒæ—¶å¹¶å‘10000ä¸ªï¼ˆ-cï¼‰ï¼Œæµ‹è¯•setæ“ä½œ(-t)ï¼Œæ¯ä¸ªæµ‹è¯•æ•°æ®é›†æ˜¯100å­—èŠ‚(-d),è¯·æ±‚æ•°æ˜¯100000ï¼ˆ-nï¼‰ï¼Œä½¿ç”¨ä½¿ç”¨éšæœºæ•°æ’å…¥æ•°å€¼ï¼ˆ-rï¼‰ã€‚</p><p>æµ‹è¯•ç»“æœä¸º1ç§’å†…å®Œæˆ1ä¸‡ä¸ªsetæ“ä½œ</p><pre><code>====== SET ======Â Â 10000 requests completedÂ in 0.96 secondsÂ Â 100 parallel clientsÂ Â 100 bytes payloadÂ Â keep alive: 1å‹æµ‹åå¯ä»¥çœ‹åˆ°åˆ†åˆ°åç«¯groupçš„æ•°æ®è¿˜æ˜¯æ¯”è¾ƒå‡è¡¡çš„</code></pre><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b33742a908b64a0d919ce0ff114c6e12><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>åŸºäºredis-sentinelå®ç°ä¸»å¤‡åˆ‡æ¢</h1><p>ä¿®æ”¹sentinelé…ç½®æ–‡ä»¶</p><p><br></p><pre><code>[root@c7-node1 codis]# cat /data/redis/sentinel.confÂ port 26379bind 0.0.0.0Â pidfileÂ "/data/redis/logs/sentinel.pid"logfileÂ "/data/redis/logs/sentinel.log"dir "/data/redis/db"Â sentinel monitor codis-server-01 192.168.28.71 6379 2sentinel down-after-milliseconds codis-server-01 5000sentinel failover-timeout codis-server-01 60000sentinel parallel-syncs codis-server-01 2Â sentinel monitor codis-server-02 192.168.28.72 6380 2sentinel down-after-milliseconds codis-server-02 5000sentinel failover-timeout codis-server-02 60000sentinel parallel-syncs codis-server-02 2Â sentinel monitor codis-server-03 192.168.28.73 6381 2sentinel down-after-milliseconds codis-server-03 5000sentinel failover-timeout codis-server-03 60000sentinel parallel-syncs codis-server-03 2</code></pre><p>å¤åˆ¶sentinelé…ç½®åˆ°å…¶ä»–èŠ‚ç‚¹</p><pre><code>scp /data/redis/sentinel.conf 192.168.28.72:/data/redis/sentinel.confscp /data/redis/sentinel.conf 192.168.28.73:/data/redis/sentinel.conf</code></pre><p>åˆ›å»ºç›¸å…³ç›®å½•</p><p><br></p><pre><code>mkdir /data/redis/logs/mkdir /data/redis/db/</code></pre><p>å¯åŠ¨sentinel</p><pre><code>[root@c7-node1 codis]# pwd/data/go/src/github.com/CodisLabs/codis[root@c7-node1 codis]# nohup ./bin/redis-sentinel /data/redis/sentinel.conf &amp;codis webé¡µé¢æ·»åŠ sentinels</code></pre><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c9764a5ad2f64f958b6b27915049682e><p class=pgc-img-caption></p></div><p>é…ç½®å®Œæˆåå¯ä»¥åœ¨groupä¸­çœ‹åˆ°æ˜æ˜¾çš„HAæ ‡å¿—</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/538af1dea8324930973caee1fc41f82b><p class=pgc-img-caption></p></div><p>æ‰‹åŠ¨kill æ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹æµ‹è¯•å¯ç”¨æ€§</p><p>killæ‰192.168.28.72æœºå™¨ä¸Šçš„6380ä¸»èŠ‚ç‚¹ï¼ŒéªŒè¯ä»èŠ‚ç‚¹å¯ä»¥æ­£å¸¸è½¬ç§»</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/08d91bb1ebe4492f89438179fa5a40d2><p class=pgc-img-caption></p></div><p>éªŒè¯æ­»ä¸€å°æœºå™¨(æ‰‹åŠ¨å…³é—­192.168.28.73èŠ‚ç‚¹)ï¼Œcodisé›†ç¾¤èƒ½å¦æ­£å¸¸æä¾›æœåŠ¡</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dd5b9e90fe5a4fc4a592ac3a018fd68b><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>æ•°æ®å¹³æ»‘è¿ç§»</h1><p>redis æ•°æ® å¹³æ»‘è¿ç§»åˆ°codis ä½¿ç”¨codiså®˜æ–¹æä¾›çš„redis-portå·¥å…·ã€‚</p><p>åŸç†ï¼šredis-portæœ¬è´¨æ˜¯ä»¥slaveçš„å½¢å¼æŒ‚è½½åˆ°ç°æœ‰redisæœåŠ¡ä¸Šå»çš„</p><p>1ã€redisä¼šç”ŸæˆRDB dumpæ–‡ä»¶ç»™åšä¸ºslaveçš„redis-port</p><p>2ã€redis-portåˆ†æRDBæ–‡ä»¶ï¼Œå¹¶æ‹†åˆ†æˆkey-valueå¯¹ï¼Œé€šè¿‡slotsresteræŒ‡ä»¤å‘ç»™codis</p><p>3ã€è¿ç§»è¿‡ç¨‹ä¸­å‘ç”Ÿçš„ä¿®æ”¹ï¼Œredisä¼šå°†è¿™äº›æŒ‡ä»¤åœ¨RDB DUMPå‘é€å®Œæˆåï¼Œå†å‘ç»™redis-portï¼Œè€Œredis-portæ”¶åˆ°è¿™äº›æŒ‡ä»¤åä¸åšå¤„ç†ï¼Œè€Œç›´æ¥è½¬å‘ç»™codis</p><p>redis-port githubåœ°å€ï¼š https://github.com/CodisLabs/redis-port</p><p>ï¼ˆ1ï¼‰å®‰è£…redis-port</p><pre><code>cd /data/go/src/github.com/CodisLabsgo get -u github.com/CodisLabs/redis-portgo get github.com/cupcake/rdbcd redis-port/make</code></pre><p>æ•°æ®åŒæ­¥å‘½ä»¤</p><pre><code>./bin/redis-sync -m 192.168.201.3:6381 -t 192.168.28.71:19000</code></pre><p>å‚æ•°è¯´æ˜ï¼š</p><p>-m æºé›†ç¾¤åœ°å€å’Œç«¯å£</p><p>-t ç›®æ ‡é›†ç¾¤åœ°å€å’Œç«¯å£</p><h1 class=pgc-h-arrow-right>redis æ•°æ®æ‰©å®¹</h1><p>è¯´æ˜ï¼šæœ¬æ¬¡æ‰©å®¹æ·»åŠ 3ç»„codis-serverï¼Œæ•°æ®æ‰©å®¹æµ‹è¯•ç”±äºä¸æ¶‰åŠé«˜å¯ç”¨ç›¸å…³å†…å®¹ï¼Œæ‰€ä»¥æ‰©å®¹çš„codis serverå‡ä¸ºå•ç‚¹</p><p>ï¼ˆ1ï¼‰æŒ‰ç…§ä¹‹å‰çš„éƒ¨ç½²æ–¹å¼ï¼Œåˆ†åˆ«åœ¨ä¸‰ä¸ªèŠ‚ç‚¹å„è‡ªå¯åŠ¨äº†ä¸€ä¸ªcodis serverï¼Œç«¯å£åˆ†åˆ«ä¸º6382ï¼Œ6383ï¼Œ6384ï¼Œå¹¶åœ¨webç®¡ç†ç•Œé¢æ·»åŠ åˆ°äº†é›†ç¾¤ä¸­</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7165af05e58b4aeba3418e1a6adeb1fe><p class=pgc-img-caption></p></div><p>ï¼ˆ2ï¼‰é€šè¿‡rebalance all slotsæ¥å®ç°é›†ç¾¤çš„slotsè‡ªåŠ¨å‡è¡¡</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/522905cec74647d4b5b5572923870ea3><p class=pgc-img-caption></p></div><p>ï¼ˆ3ï¼‰ç¡®å®šæ¯ä¸ªæ–°åŠ å…¥çš„groupåˆ†é…çš„slotsã€‚</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/825f8e671a0b474eb1e591445f22c927><p class=pgc-img-caption></p></div><p>ï¼ˆ4ï¼‰åˆ†é…å®Œæˆslotæ˜¾ç¤ºå¦‚ä¸‹æ‰€ç¤º</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/10e20807e8f944f6b806d8c50d5e94d7><p class=pgc-img-caption></p></div><p>ä»groupçœ‹ï¼Œæ¯ç»„åˆ†ç‰‡çš„memoryç©ºé—´å ç”¨æƒ…å†µä¹Ÿæ˜¯å‡è¡¡çš„</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³è¿‡nginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/acfde37d614c4d73b132ca590949fa8b><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>dashboard æ•…éšœå¼‚æœºå¯åŠ¨</h1><p>codis å®˜æ–¹ä»…å…è®¸è¿è¡Œä¸€ä¸ªdashboardèŠ‚ç‚¹ï¼ŒdashboardèŠ‚ç‚¹å¯åŠ¨ä¼šåœ¨zkä¸Šæ³¨å†Œè‡ªå·±çš„èŠ‚ç‚¹ï¼ŒåŒæ—¶åœ¨ç¨‹åºæ­£å¸¸é€€å‡ºçš„æ—¶å€™åˆ æ‰å¯¹åº”çš„èŠ‚ç‚¹ï¼Œä½†å¦‚æœå¼‚å¸¸é€€å‡ºå°±ä¼šå¯¼è‡´zkçš„èŠ‚ç‚¹æ— æ³•åˆ é™¤ï¼Œåœ¨ä¸‹ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™ä¼šæŠ¥â€œzk: node already existsâ€çš„é”™è¯¯ã€‚</p><p>å¦‚æœdashboardèŠ‚ç‚¹å‡ºç°æ•…éšœï¼ŒçŸ­æ—¶é—´æ— æ³•æ¢å¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¦å¤–ä¸€å°èŠ‚ç‚¹å¯åŠ¨dashboardçš„è¯ï¼Œéœ€è¦åœ¨zookeeperä¸­åˆ é™¤èŠ‚ç‚¹çš„æ³¨å†Œä¿¡æ¯ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><pre><code># ./zkCli.shdeleteÂ /codis3/xuele-codis/topom</code></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'codis','è·³è¿‡','nginx'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>