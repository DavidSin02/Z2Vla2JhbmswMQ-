<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>彻底搞懂动态库、静态库、运行时库、引入库之间的区别 | 极客快訊</title><meta property="og:title" content="彻底搞懂动态库、静态库、运行时库、引入库之间的区别 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/3661a9b07d7e4023b848ca64e0133155"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e28f277.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e28f277.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e28f277.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e28f277.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e28f277.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e28f277.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e28f277.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e28f277.html><meta property="article:published_time" content="2020-10-29T21:04:01+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:01+08:00"><meta name=Keywords content><meta name=description content="彻底搞懂动态库、静态库、运行时库、引入库之间的区别"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/e28f277.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>彻底搞懂动态库、静态库、运行时库、引入库之间的区别</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1>定义</h1><li>运行时库：Unix中一个典型的运行时库例子就是libc，它包含标准的C函数，如，print()，exit()等等，用户能创建他们自己的运行库（在Windows中是DLL），而具体的细节依赖编译器和操作系统的。</li><li>静态库：函数和数据被编译进一个二进制文件（通常扩展名为.lib），静态库实际上是在链接时被链接到EXE的，库本身不需要与可执行文件一起发行。</li><li>动态库：用VC++创建的动态库包含两个文件，一个lib文件和一个dll文件，这个lib文件就是引入库，不是静态库，引入库有时也叫输入库或导入库。</li><div class=pgc-img><img alt=彻底搞懂动态库、静态库、运行时库、引入库之间的区别 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3661a9b07d7e4023b848ca64e0133155><p class=pgc-img-caption></p></div><p>注：windows操作系统下动态库和运行时库的扩展名都是.dll，COM组件的扩展名也是.dll，<strong>动态库的引入库和静态库的扩展名都是.lib。</strong></p><p>windows下调用动态库的方法：</p><p>1 隐式加载：即在程序中包含lib文件和.h文件，隐式链接有时称为静态加载或<strong>加载时动态链接</strong>。例如：</p><blockquote><p>#include "somedll.h"</p><p>#pragma comment( lib, "somedll.lib")</p></blockquote><p>然后就可以直接调用此dll中的函数，注意运行时仍然需要somedll.dll。</p><p>2 显示加载：使用loadlibrary，GetProcAddress,FreeLibrary,不需要.h文件和.lib文件，但是要知道函数的原型。显式链接有时称为动态加载或<strong>运行时动态链接</strong>。</p><p>3 区别：如果在进程启动时未找到 DLL，操作系统将终止使用隐式链接的进程。同样是在此情况下，使用显式链接的进程则不会被终止，并可以尝试从错误中恢复。</p><p>有关Win32 DLL，Unix共享库及普通库的详细库结构信息请参考《链接器与加载器》一书。</p><hr><h1><strong>1 确定要使用的链接方法：</strong></h1><p>有两种类型的链接：隐式链接和显式链接。</p><p><strong>隐式链接</strong></p><ol start=1><li>应用程序的代码调用导出 DLL 函数时发生隐式链接。当调用可执行文件的源代码被编译或被汇编时，DLL 函数调用在对象代码中生成一个外部函数引用。若要解析此外部引用，应用程序必须与 DLL 的创建者所提供的导入库（.LIB 文件）链接。</li><li>导入库仅包含加载 DLL 的代码和实现 DLL 函数调用的代码。在导入库中找到外部函数后，会通知链接器此函数的代码在DLL 中。要解析对 DLL 的外部引用，链接器只需向可执行文件中添加信息，通知系统在进程启动时应在何处查找 DLL 代码。</li><li>系统启动包含动态链接引用的程序时，它使用程序的可执行文件中的信息定位所需的 DLL。如果系统无法定位 DLL，它将终止进程并显示一个对话框来报告错误。否则，系统将 DLL 模块映射到进程的地址空间中。</li><li>如果任何 DLL 具有（用于初始化代码和终止代码的）入口点函数，操作系统将调用此函数。在传递到入口点函数的参数中，有一个指定用以指示 DLL 正在附带到进程的代码。如果入口点函数没有返回 TRUE，系统将终止进程并报告错误。最后，系统修改进程的可执行代码以提供 DLL 函数的起始地址。</li><li>与程序代码的其余部分一样，DLL 代码在进程启动时映射到进程的地址空间中，且仅当需要时才加载到内存中。因此，由 .def 文件用来在 Windows 的早期版本中控制加载的 PRELOAD 和 LOADONCALL 代码属性不再具有任何意义。</li></ol><p><strong>显式链接</strong><br>大部分应用程序使用隐式链接，因为这是最易于使用的链接方法。但是有时也需要显式链接。下面是一些使用显式链接的常见原因：</p><ol start=1><li>直到运行时，应用程序才知道需要加载的 DLL 的名称。例如，应用程序可能需要从配置文件获取 DLL 的名称和导出函数名。</li><li>如果在进程启动时未找到 DLL，操作系统将终止使用隐式链接的进程。同样是在此情况下，使用显式链接的进程则不会被终止，并可以尝试从错误中恢复。例如，进程可通知用户所发生的错误，并让用户指定 DLL 的其他路径。如果使用隐式链接的进程所链接到的 DLL 中有任何 DLL 具有失败的 DllMain 函数，该进程也会被终止。同样是在此情况下，使用显式链接的进程则不会被终止。</li><li>因为<strong>Windows 在应用程序加载时加载所有的 DLL，故隐式链接到许多 DLL 的应用程序启动起来会比较慢</strong>。为提高启动性能，应用程序可隐式链接到那些加载后立即需要的 DLL，并等到在需要时显式链接到其他 DLL。</li><li>显式链接下不需将应用程序与导入库链接。如果 DLL 中的更改导致导出序号更改，使用显式链接的应用程序不需重新链接（假设它们是用函数名而不是序号值调用 GetProcAddress），而使用隐式链接的应用程序必须重新链接到新的导入库。</li></ol><p>下面是需要注意的显式链接的两个缺点：</p><ol start=1><li>如果 DLL 具有 DllMain 入口点函数，则操作系统在调用 LoadLibrary 的线程上下文中调用此函数。如果由于以前调用了LoadLibrary 但没有相应地调用 FreeLibrary 函数而导致 DLL 已经附加到进程，则不会调用此入口点函数。如果 DLL 使用 DllMain 函数为进程的每个线程执行初始化，显式链接会造成问题，因为调用 LoadLibrary（或 AfxLoadLibrary）时存在的线程将不会初始化。</li><li>如果 DLL 将静态作用域数据声明为 __declspec(thread)，则在显式链接时 DLL 会导致保护错误。用 LoadLibrary 加载 DLL 后，每当代码引用此数据时 DLL 就会导致保护错误。（静态作用域数据既包括全局静态项，也包括局部静态项。）因此，创建 DLL 时应避免使用线程本地存储区，或者应（在用户尝试动态加载时）告诉 DLL 用户潜在的缺陷。</li></ol><h1><strong>2 隐式链接：</strong></h1><p>为隐式链接到 DLL，可执行文件必须从 DLL 的提供程序获取下列各项：</p><ol start=1><li>包含导出函数和/或 C++ 类的声明的头文件（.h 文件）。类、函数和数据均应具有 __declspec(dllimport)，有关更多信息，请参见 dllexport, dllimport。</li><li>要链接的导入库（.LIB files）。（生成 DLL 时链接器创建导入库。）</li><li>实际的 DLL（.dll 文件）。</li></ol><p>使用 DLL 的可执行文件必须包括头文件，此头文件包含每个源文件中的导出函数（或 C++ 类），而这些源文件包含对导出函数的调用。从编码的角度讲，导出函数的函数调用与任何其他函数调用一样。</p><p>若要生成调用可执行文件，必须与导入库链接。如果使用的是外部生成文件，请指定导入库的文件名，此导入库中列出了要链接到的其他对象 (.obj) 文件或库。</p><p>操作系统在加载调用可执行文件时，必须能够定位 DLL 文件。</p><h1><strong>3 显式链接：</strong></h1><p>在显式链接下，应用程序必须进行函数调用以在运行时显式加载 DLL。为显式链接到 DLL，应用程序必须：</p><ol start=1><li>调用 LoadLibrary（或相似的函数）以加载 DLL 和获取模块句柄。</li><li>调用 GetProcAddress，以获取指向应用程序要调用的每个导出函数的函数指针。由于应用程序是通过指针调用 DLL 的函数，编译器不生成外部引用，故无需与导入库链接。</li><li>使用完 DLL 后调用 FreeLibrary。</li></ol></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'搞懂','彻底','动态'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>