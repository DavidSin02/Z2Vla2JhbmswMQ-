<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯» | æå®¢å¿«è¨Š</title><meta property="og:title" content="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯» - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/S4RDmAJA74o9GY"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e39543b2.html><meta property="article:published_time" content="2020-11-14T20:59:53+08:00"><meta property="article:modified_time" content="2020-11-14T20:59:53+08:00"><meta name=Keywords content><meta name=description content="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/e39543b2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p>Flink ä»å…¥é—¨åˆ°ç²¾é€š ç³»åˆ—æ–‡ç« </p><p>ä½œè€…ï¼š<strong class=highlight-text toutiao-origin=span>é€å‡¯</strong>ï¼Œé˜¿é‡Œäº‘æ•°æ®åº“å®ä¹ å¼€å‘å·¥ç¨‹å¸ˆ</p><p>æ³¨ï¼šä»¥ä¸‹åˆ†æåŸºäºå¼€æº v19.15.2.2-stable ç‰ˆæœ¬è¿›è¡Œï¼Œç¤¾åŒºæœ€æ–°ç‰ˆæœ¬ä»£ç æ”¹åŠ¨è¾ƒå¤§ï¼Œä½†æ˜¯æ€»ä½“æ€è·¯æ˜¯ä¸å˜çš„ã€‚</p><p>01</p><p></p><h1 toutiao-origin=h2>ç”¨æˆ·æäº¤ä¸€æ¡æŸ¥è¯¢SQLèƒŒåå‘ç”Ÿäº†ä»€ä¹ˆ</h1><p>åœ¨ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“ä¸­ï¼ŒSQLå¤„ç†å™¨çš„ç»„ä»¶ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š</p><p><strong>â€¢ Query Parsing</strong></p><p>è´Ÿè´£è¿›è¡Œè¯æ³•å’Œè¯­æ³•åˆ†æ,æŠŠç¨‹åºä»äººç±»é«˜å¯è¯»çš„æ ¼å¼(å³SQL)è½¬åŒ–æˆæœºå™¨é«˜å¯è¯»çš„æ ¼å¼(AST,æŠ½è±¡è¯­æ³•æ ‘)ã€‚</p><p>è¯æ³•åˆ†ææŒ‡çš„æ˜¯æŠŠSQLä¸­çš„å­—ç¬¦åºåˆ—åˆ†è§£æˆä¸€ä¸ªä¸ªç‹¬ç«‹çš„è¯æ³•å•å…ƒâ€”â€”Token(&lt;ç±»å‹ï¼Œå€¼>)ã€‚</p><p>è¯­æ³•åˆ†ææŒ‡çš„æ˜¯ä»è¯æ³•åˆ†æå™¨è¾“å‡ºçš„tokenä¸­è¯†åˆ«å„ç±»çŸ­è¯­ï¼Œå¹¶æ„é€ å‡ºä¸€é¢—æŠ½è±¡è¯­æ³•æ ‘ã€‚è€ŒæŒ‰ç…§æ„é€ æŠ½è±¡è¯­æ³•æ ‘çš„æ–¹å‘ï¼Œåˆå¯ä»¥æŠŠè¯­æ³•åˆ†æåˆ†æˆè‡ªé¡¶å‘ä¸‹å’Œè‡ªåº•å‘ä¸Šåˆ†æä¸¤ç§ã€‚è€ŒClickHouseé‡‡ç”¨çš„åˆ™æ˜¯æ‰‹å†™ä¸€ä¸ªé€’å½’ä¸‹é™çš„è¯­æ³•åˆ†æå™¨ã€‚</p><p><strong>â€¢ Query Rewrite</strong></p><p>å³é€šå¸¸æˆ‘ä»¬è¯´çš„"Logical Optimizer"æˆ–åŸºäºè§„åˆ™çš„ä¼˜åŒ–å™¨(Rule-Based Optimizer,å³RBO)ã€‚</p><p>å…¶è´Ÿè´£åº”ç”¨ä¸€äº›å¯å‘å¼è§„åˆ™ï¼Œè´Ÿè´£ç®€åŒ–å’Œæ ‡å‡†åŒ–æŸ¥è¯¢ï¼Œæ— éœ€æ”¹å˜æŸ¥è¯¢çš„è¯­ä¹‰ã€‚</p><p>å¸¸è§æ“ä½œæœ‰:è°“è¯å’Œç®—å­ä¸‹æ¨ï¼Œè§†å›¾å±•å¼€ï¼Œç®€åŒ–å¸¸é‡è¿ç®—è¡¨è¾¾å¼ï¼Œè°“è¯é€»è¾‘çš„é‡å†™ï¼Œè¯­ä¹‰çš„ä¼˜åŒ–ç­‰ã€‚</p><p><strong>â€¢ Query Optimizer</strong></p><p>å³é€šå¸¸æˆ‘ä»¬æ‰€è¯´çš„"Physical Optimizer"ï¼Œè´Ÿè´£æŠŠå†…éƒ¨æŸ¥è¯¢è¡¨è¾¾è½¬åŒ–æˆä¸€ä¸ªé«˜æ•ˆçš„æŸ¥è¯¢è®¡åˆ’ï¼ŒæŒ‡å¯¼DBMSå¦‚ä½•å»å–è¡¨ï¼Œå¦‚ä½•è¿›è¡Œæ’åºï¼Œå¦‚ä½•Joinã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªæŸ¥è¯¢è®¡åˆ’å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæ•°æ®æµå›¾ï¼Œåœ¨è¿™ä¸ªæ•°æ®æµå›¾ä¸­ï¼Œè¡¨æ•°æ®ä¼šåƒåœ¨ç®¡é“ä¸­ä¼ è¾“ä¸€æ ·ï¼Œä»ä¸€ä¸ªæŸ¥è¯¢æ“ä½œç¬¦(operator)ä¼ é€’åˆ°å¦ä¸€ä¸ªæŸ¥è¯¢æ“ä½œç¬¦ã€‚</p><img alt="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/S4RDmAJA74o9GY><p>ä¸€ä¸ªæŸ¥è¯¢è®¡åˆ’</p><p><strong>â€¢ Query Executor</strong></p><p>æŸ¥è¯¢æ‰§è¡Œå™¨ï¼Œè´Ÿè´£æ‰§è¡Œå…·ä½“çš„æŸ¥è¯¢è®¡åˆ’ï¼Œä»å­˜å‚¨å¼•æ“ä¸­è·å–æ•°æ®å¹¶ä¸”å¯¹æ•°æ®åº”ç”¨æŸ¥è¯¢è®¡åˆ’å¾—åˆ°ç»“æœã€‚</p><p>æ‰§è¡Œå¼•æ“ä¹Ÿåˆ†ä¸ºå¾ˆå¤šç§ï¼Œå¦‚ç»å…¸çš„ç«å±±æ¨¡å‹(Volcano Model)ï¼Œè¿˜æœ‰ClickHouseé‡‡ç”¨çš„å‘é‡åŒ–æ‰§è¡Œæ¨¡å‹(Vectorization Model)ã€‚</p><img alt="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/S4RDmBB8AKErrl><p>(å›¾æ¥è‡ªç»å…¸è®ºæ–‡ Architecture Of Database System)</p><p>ä½†ä¸ç®¡æ˜¯ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ï¼Œè¿˜æ˜¯éå…³ç³»å‹æ•°æ®åº“ï¼ŒSQLçš„è§£æå’Œç”Ÿæˆæ‰§è¡Œè®¡åˆ’è¿‡ç¨‹éƒ½æ˜¯å¤§åŒå°å¼‚çš„ï¼Œè€Œçºµè§ˆClickHouseçš„æºä»£ç ï¼Œå¯ä»¥æŠŠç”¨æˆ·æäº¤ä¸€æ¡æŸ¥è¯¢SQLèƒŒåçš„è¿‡ç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p><p>1.æœåŠ¡ç«¯æ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„SQLè¯·æ±‚ï¼Œå…·ä½“å½¢å¼æ˜¯ä¸€ä¸ªç½‘ç»œåŒ…ï¼ŒServerçš„åè®®å±‚éœ€è¦æ‹†åŒ…æŠŠSQLè§£æå‡ºæ¥</p><p>2.Serverè´Ÿè´£åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸Network Handlerï¼Œç„¶å Parser å¯¹Queryåšè¯æ³•å’Œè¯­æ³•åˆ†æï¼Œè§£ææˆAST</p><p>3.Interpreterçš„ SyntaxAnalyzer ä¼šåº”ç”¨ä¸€äº›å¯å‘å¼è§„åˆ™å¯¹ASTè¿›è¡Œä¼˜åŒ–é‡å†™</p><p>4.Interpreterçš„<strong toutiao-origin=span> ExpressionAnalyzer </strong>æ ¹æ®ä¸Šä¸‹æ–‡ä¿¡æ¯ä»¥åŠä¼˜åŒ–é‡å†™åçš„ASTç”Ÿæˆç‰©ç†æ‰§è¡Œè®¡åˆ’</p><p>5.ç‰©ç†æ‰§è¡Œè®¡åˆ’åˆ†å‘åˆ°æœ¬åœ°æˆ–è€…åˆ†å¸ƒå¼çš„executor,å„è‡ªä»å­˜å‚¨å¼•æ“ä¸­è·å–æ•°æ®,åº”ç”¨æ‰§è¡Œè®¡åˆ’</p><p>6.ServeræŠŠæ‰§è¡Œåçš„ç»“æœä»¥Blockæµçš„å½¢å¼è¾“å‡ºåˆ°Socketç¼“å†²åŒº,Clientä»Socketä¸­è¯»å–å³å¯å¾—åˆ°ç»“æœ</p><img alt="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/S4RDmCJBLj2cxQ><p></p><h2 toutiao-origin=h3><strong class=highlight-text toutiao-origin=span>01 æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚</strong></h2><p>æˆ‘ä»¬è¦ä»¥æœåŠ¡ç«¯çš„è§†è§’æ¥å‡ºå‘ï¼Œé¦–å…ˆæ¥çœ‹server.cppå¤§æ¦‚åšä»€ä¹ˆäº‹æƒ…:</p><p>ä¸‹é¢åªæŒ‘é€‰é‡è¦çš„é€»è¾‘:</p><p>â€¢ åˆå§‹åŒ–ä¸Šä¸‹æ–‡</p><p>â€¢ åˆå§‹åŒ–Zookeeper(ClickHouseçš„å‰¯æœ¬å¤åˆ¶æœºåˆ¶éœ€è¦ä¾èµ–ZooKeeper)</p><p>â€¢ å¸¸è§„é…ç½®åˆå§‹åŒ–</p><p>â€¢ ç»‘å®šæœåŠ¡ç«¯çš„ç«¯å£ï¼Œæ ¹æ®ç½‘ç»œåè®®åˆå§‹åŒ–Handlerï¼Œå¯¹å®¢æˆ·ç«¯æä¾›æœåŠ¡</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>int Server::main<br>{<br>// åˆå§‹åŒ–ä¸Šä¸‹æ–‡<br>global_context = std::make_unique&lt;Context&gt;(Context::createGlobal);<br>global_context-&gt;setApplicationType(Context::ApplicationType::SERVER);<br><br>// zkåˆå§‹åŒ–<br>zkutil::ZooKeeperNodeCache main_config_zk_node_cache([&amp;] { return global_context-&gt;getZooKeeper; });<br><br>//å…¶ä»–configçš„åˆå§‹åŒ–<br>//...<br><br>//ç»‘å®šç«¯å£,å¯¹å¤–æä¾›æœåŠ¡<br>auto address = make_socket_address(host, port);<br>socket.bind(address, /* reuseAddress = */ true);<br><br>//æ ¹æ®ç½‘ç»œåè®®å»ºç«‹ä¸åŒçš„serverç±»å‹<br>//ç°åœ¨æ”¯æŒçš„serverç±»å‹æœ‰ï¼šHTTP,HTTPS,TCP,Interserver,mysql<br>//ä»¥TCPç‰ˆæœ¬ä¸ºä¾‹:<br>create_server("tcp_port", [&amp;](UInt16 port)<br>{<br>Poco::Net::ServerSocket socket;<br>auto address = socket_bind_listen(socket, listen_host, port);<br>servers.emplace_back(std::make_unique&lt;Poco::Net::TCPServer&gt;(<br>new TCPHandlerFactory(*this),<br>server_pool,<br>socket,<br>new Poco::Net::TCPServerParams));<br>});<br><br>//å¯åŠ¨server<br>for (auto &amp; server : servers)<br>server-&gt;start;<br><br>}</code></p></pre><p>å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚æ˜¯ç”±å„è‡ªç½‘ç»œåè®®æ‰€å¯¹åº”çš„ Handler æ¥è¿›è¡Œçš„ï¼Œserveråœ¨å¯åŠ¨çš„æ—¶å€™ Handler ä¼šè¢«åˆå§‹åŒ–å¹¶ç»‘å®šåœ¨æŒ‡å®šç«¯å£ä¸­ã€‚æˆ‘ä»¬ä»¥TCPHandlerä¸ºä¾‹ï¼Œçœ‹çœ‹æœåŠ¡ç«¯æ˜¯å¦‚ä½•å¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚çš„ï¼Œé‡ç‚¹å…³æ³¨ <strong toutiao-origin=span>TCPHandler::runImpl</strong>çš„å‡½æ•°å®ç°:</p><p>â€¢ åˆå§‹åŒ–è¾“å…¥å’Œè¾“å‡ºæµçš„ç¼“å†²åŒº</p><p>â€¢ æ¥å—è¯·æ±‚æŠ¥æ–‡ï¼Œæ‹†åŒ…</p><p>â€¢ æ‰§è¡ŒQuery(åŒ…æ‹¬æ•´ä¸ªè¯æ³•è¯­æ³•åˆ†æï¼ŒQueryé‡å†™ï¼Œç‰©ç†è®¡åˆ’ç”Ÿæˆå’Œç”Ÿæˆç»“æœ)</p><p>â€¢ æŠŠQueryç»“æœä¿å­˜åˆ°è¾“å‡ºæµï¼Œç„¶åå‘é€åˆ°Socketçš„ç¼“å†²åŒºï¼Œç­‰å¾…å‘é€å›å®¢æˆ·ç«¯</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>void TCPHandler::runImpl<br>{<br>//å®ä¾‹åŒ–å¥—æ¥å­—å¯¹åº”çš„è¾“å…¥å’Œè¾“å‡ºæµç¼“å†²åŒº<br>in = std::make_shared&lt;ReadBufferFromPocoSocket&gt;(socket);<br>out = std::make_shared&lt;WriteBufferFromPocoSocket&gt;(socket);<br><br>while (1){<br>// æ¥æ”¶è¯·æ±‚æŠ¥æ–‡<br>receivePacket;<br><br>// æ‰§è¡ŒQuery<br>state.io = executeQuery(state.query, *query_context, false, state.stage, may_have_embedded_data);<br><br>//æ ¹æ®Queryç§ç±»æ¥å¤„ç†ä¸åŒçš„Query<br>//å¤„ç†insert Query<br>processInsertQuery;<br>//å¹¶å‘å¤„ç†æ™®é€šQuery<br>processOrdinaryQueryWithProcessors;<br>//å•çº¿ç¨‹å¤„ç†æ™®é€šQuery<br>processOrdinaryQuery;<br>}<br><br>}</code></p></pre><p>é‚£CKå¤„ç†å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„Queryçš„å…·ä½“é€»è¾‘æ˜¯æ€æ ·çš„å‘¢?</p><p>æˆ‘ä»¬å¯ä»¥åœ¨</p><blockquote toutiao-origin=span>dbms/src/Interpreters/executeQuery.cpp</blockquote><p>ä¸­ä¸€æ¢ç©¶ç«Ÿ:</p><p>å…·ä½“é€»è¾‘åœ¨ executeQueryImpl å‡½æ•°ä¸­,æŒ‘é€‰æ ¸å¿ƒçš„é€»è¾‘è¿›è¡Œè®²è§£:</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>static std::tuple&lt;ASTPtr, BlockIO&gt; executeQueryImpl<br>{<br>//æ„é€ Parser<br>ParserQuery parser(end, settings.enable_debug_queries);<br>ASTPtr ast;<br><br>//æŠŠQueryè½¬åŒ–ä¸ºæŠ½è±¡è¯­æ³•æ ‘<br>ast = parseQuery(parser, begin, end, "", max_query_size);<br><br>//ç”Ÿæˆinterpreterå®ä¾‹<br>auto interpreter = InterpreterFactory::get(ast, context, stage);<br><br>// interpreterè§£æAST,ç»“æœæ˜¯BlockIO<br>res = interpreter-&gt;execute;<br><br>//è¿”å›ç»“æœæ˜¯æŠ½è±¡è¯­æ³•æ ‘å’Œè§£æåçš„ç»“æœç»„æˆçš„äºŒå…ƒç»„<br>return std::make_tuple(ast, res);<br>}</code></p></pre><p>è¯¥å‡½æ•°æ‰€åšçš„äº‹æƒ…ï¼š</p><p>â€¢ æ„å»ºParser,æŠŠQueryè§£ææˆAST(æŠ½è±¡è¯­æ³•æ ‘)</p><p>â€¢ InterpreterFactoryæ ¹æ®ASTç”Ÿæˆå¯¹åº”çš„Interpreterå®ä¾‹</p><p>â€¢ ASTæ˜¯ç”±Interpreteræ¥è§£æçš„ï¼Œæ‰§è¡Œç»“æœæ˜¯ä¸€ä¸ªBlockIO,BlockIOæ˜¯å¯¹ BlockInputStream å’Œ BlockOutputStream çš„ä¸€ä¸ªå°è£…ã€‚</p><p>æ€»ç»“:</p><p>â€¢ æœåŠ¡ç«¯è°ƒç”¨ executeQuery æ¥å¤„ç†clientå‘é€çš„Queryï¼Œæ‰§è¡Œåçš„ç»“æœä¿å­˜åœ¨stateè¿™ä¸ªç»“æ„ä½“çš„ioæˆå‘˜ä¸­ã€‚</p><p>æ¯ä¸€æ¡Queryéƒ½ä¼šå¯¹åº”ä¸€ä¸ªstateç»“æ„ä½“ï¼Œè®°å½•äº†è¿™æ¡Queryçš„idï¼Œå¤„ç†çŠ¶æ€ï¼Œå‹ç¼©ç®—æ³•ï¼ŒQueryçš„æ–‡æœ¬å’ŒQueryæ‰€å¤„ç†æ•°æ®å¯¹åº”çš„IOæµç­‰å…ƒä¿¡æ¯ã€‚</p><p>â€¢ ç„¶åæœåŠ¡ç«¯è°ƒç”¨ <strong toutiao-origin=span>processOrdinaryQuery </strong>ç­‰æ–¹æ³•æŠŠè¾“å‡ºæµç»“æœå°è£…æˆå¼‚æ­¥çš„IOæµï¼Œå‘é€åˆ°å›clientã€‚</p><img alt="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/S4RDmCtDHj5504><p></p><h2 toutiao-origin=h3><strong class=highlight-text toutiao-origin=span>02 è§£æè¯·æ±‚(Parser)</strong></h2><p>CKé€‰æ‹©é‡‡ç”¨æ‰‹å†™ä¸€ä¸ªé€’å½’ä¸‹é™çš„Parseræ¥å¯¹SQLè¿›è¡Œè§£æï¼Œç”Ÿæˆçš„ç»“æœæ˜¯è¿™ä¸ªSQLå¯¹åº”çš„æŠ½è±¡è¯­æ³•æ ‘(AST),æŠ½è±¡è¯­æ³•æ ‘ç”±è¡¨ç¤ºå„ä¸ªæ“ä½œçš„èŠ‚ç‚¹(IAST)è¡¨ç¤ºã€‚è€Œæœ¬èŠ‚ä¸»è¦ä»‹ç»ParserèƒŒåçš„æ ¸å¿ƒé€»è¾‘:</p><p>è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æçš„æ ¸å¿ƒé€»è¾‘å¯ä»¥åœ¨parseQuery.cppçš„ tryParseQuery ä¸­ä¸€è§ˆæ— ä½™ã€‚</p><p>è¯¥å‡½æ•°åˆ©ç”¨lexerå°†æ‰«æQueryå­—ç¬¦æµï¼Œå°†å…¶åˆ†å‰²ä¸ºä¸€ä¸ªä¸ªçš„Tokenï¼Œ token_iterator å³ä¸€ä¸ªTokenæµè¿­ä»£å™¨ï¼Œç„¶åparserå†å¯¹Tokenæµè¿›è¡Œè§£æç”ŸæˆASTæŠ½è±¡è¯­æ³•æ ‘ã€‚</p><pre><p><code>ASTPtr tryParseQuery<br>{<br>//Tokenä¸ºlexerè¯æ³•åˆ†æåçš„åŸºæœ¬å•ä½,è¯æ³•åˆ†æåç”Ÿæˆçš„æ˜¯Tokenæµ<br>Tokens tokens(pos, end, max_query_size);<br>IParser::Pos token_iterator(tokens);<br>ASTPtr res;<br>//Tokenæµç»è¿‡è¯­æ³•åˆ†æç”ŸæˆASTæŠ½è±¡è¯­æ³•æ ‘<br>bool parse_res = parser.parse(token_iterator, res, expected);<br>return res;<br><br>}</code></p></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°,è¯­æ³•åˆ†æçš„æ ¸å¿ƒå°±åœ¨äºparseræ‰§è¡Œçš„parseæ–¹æ³•ã€‚parse æ–¹æ³•å…·ä½“çš„å®ç°åœ¨ ParserQuery.cpp çš„ parseImpl ä¸­ã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>bool ParserQuery::parseImpl(Pos &amp; pos, ASTPtr &amp; node, Expected &amp; expected)<br>{<br>ParserQueryWithOutput query_with_output_p(enable_explain);<br>ParserInsertQuery insert_p(end);<br>ParserUseQuery use_p;<br>ParserSetQuery set_p;<br>ParserSystemQuery system_p;<br><br>bool res = query_with_output_p.parse(pos, node, expected)<br>|| insert_p.parse(pos, node, expected)<br>|| use_p.parse(pos, node, expected)<br>|| set_p.parse(pos, node, expected)<br>|| system_p.parse(pos, node, expected);<br><br>return res;<br>}</code></p></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°,è¿™ä¸ªæ–¹æ³•ç²—ç•¥åœ°æŠŠQueryåˆ†ä¸ºäº†äº”ç§,ä½†æ˜¯æœ¬è´¨ä¸Šå¯ä»¥å½’çº³ä¸ºä¸¤ç§(ç¬¬ä¸€ç§ä¸ºæœ‰ç»“æœè¾“å‡º,å¯¹åº”show,select,createç­‰è¯­å¥;ç¬¬äºŒç§ä¸ºæ— ç»“æœè¾“å‡º,å¯¹åº”insert,use,setå’Œä¸ç³»ç»Ÿç›¸å…³çš„è¯­å¥(å¦‚exit))</p><p>â€¢ QueryWithOutput</p><p>â€¢ InsertQuery</p><p>â€¢ UseQuery</p><p>â€¢ SetQuery</p><p>â€¢ SystemQuery</p><p>æ¯ä¸€ç§Queryéƒ½è‡ªå®šä¹‰äº†å…¶ä¸“å±çš„Parser,æ‰€ä»¥ä»£ç é€»è¾‘æ˜¯å½“æ¥æ”¶åˆ°ä¸€ä¸ªQueryè¾“å…¥çš„æ—¶å€™ï¼Œä¼šå°è¯•å„ç§Queryçš„Parserï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚</p><p>æˆ‘ä»¬å¯ä»¥selectè¯­å¥å¯¹åº”çš„parserè¿›è¡Œåˆ†æ:</p><p>æ ¸å¿ƒé€»è¾‘å¯ä»¥æ€»ç»“ä¸ºï¼š</p><p>1.å…ˆç»™å‡ºselectè¯­å¥ä¸­å¯èƒ½å‡ºç°çš„å…³é”®è¯</p><p>2.åœ¨è¯æ³•åˆ†æç”Ÿæˆçš„Tokenæµä¸­çˆ¬å–è¿™äº›å…³é”®è¯</p><p>3.å¦‚æœæˆåŠŸçˆ¬å–ï¼Œåˆ™ setExpression å‡½æ•°ä¼šç»„è£…è¯¥å…³é”®å­—å¯¹åº”çš„ASTèŠ‚ç‚¹</p><p>æ¯ä¸€ç§SQLè¯­å¥(å¦‚select,drop,insert,create)éƒ½æœ‰å¯¹åº”çš„ASTç±»ï¼Œå¹¶ä¸”åˆ†åˆ«åŒ…å«äº†è¿™äº›è¯­å¥ä¸­ç‰¹æœ‰çš„å…³é”®å­—ã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>bool ParserSelectQuery::parseImpl(Pos &amp; pos, ASTPtr &amp; node, Expected &amp; expected)<br>{<br>//åˆ›å»ºASTæ ‘èŠ‚ç‚¹<br>auto select_query = std::make_shared&lt;ASTSelectQuery&gt;;<br>node = select_query;<br><br>//selectè¯­å¥ä¸­ä¼šå‡ºç°çš„å…³é”®è¯<br>ParserKeyword s_select("SELECT");<br>ParserKeyword s_distinct("DISTINCT");<br>ParserKeyword s_from("FROM");<br>ParserKeyword s_prewhere("PREWHERE");<br>ParserKeyword s_where("WHERE");<br>ParserKeyword s_group_by("GROUP BY");<br>ParserKeyword s_with("WITH");<br>ParserKeyword s_totals("TOTALS");<br>ParserKeyword s_having("HAVING");<br>ParserKeyword s_order_by("ORDER BY");<br>ParserKeyword s_limit("LIMIT");<br>ParserKeyword s_settings("SETTINGS");<br>ParserKeyword s_by("BY");<br>ParserKeyword s_rollup("ROLLUP");<br>ParserKeyword s_cube("CUBE");<br>ParserKeyword s_top("TOP");<br>ParserKeyword s_with_ties("WITH TIES");<br>ParserKeyword s_offset("OFFSET");<br><br>//...<br>//ä¾æ¬¡å¯¹Tokenæµçˆ¬å–ä¸Šè¿°å…³é”®å­—<br>ParserTablesInSelectQuery.parse(pos, tables, expected)<br><br>//æ ¹æ®è¯­æ³•åˆ†æç»“æœè®¾ç½®ASTçš„Expressionå±æ€§,å¯ä»¥ç†è§£ä¸ºå¦‚æœSQLå­˜åœ¨è¯¥å…³é”®å­—,è¿™ä¸ªå…³é”®å­—éƒ½ä¼šè½¬åŒ–ä¸ºASTä¸Šçš„ä¸€ä¸ªèŠ‚ç‚¹<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::WITH, std::move(with_expression_list));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::SELECT, std::move(select_expression_list));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::TABLES, std::move(tables));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::PREWHERE, std::move(prewhere_expression));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::WHERE, std::move(where_expression));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::GROUP_BY, std::move(group_expression_list));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::HAVING, std::move(having_expression));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::ORDER_BY, std::move(order_expression_list));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::LIMIT_BY_OFFSET, std::move(limit_by_offset));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::LIMIT_BY_LENGTH, std::move(limit_by_length));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::LIMIT_BY, std::move(limit_by_expression_list));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::LIMIT_OFFSET, std::move(limit_offset));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::LIMIT_LENGTH, std::move(limit_length));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::SETTINGS, std::move(settings));<br><br>}</code></p></pre><p>æ•´ä¸ªParserçš„æµç¨‹å›¾ï¼š</p><img alt="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/S4RDmDP1wXvGlS><p></p><h2 toutiao-origin=h3><strong class=highlight-text toutiao-origin=strong>03 æ‰§è¡Œè¯·æ±‚(Interpreter)</strong></h2><p>è§£é‡Šå™¨(Interpreter)è´Ÿè´£ä»æŠ½è±¡è¯­æ³•æ ‘ä¸­åˆ›å»ºæŸ¥è¯¢æ‰§è¡Œçš„æµæ°´çº¿ï¼Œæ•´æ¡æµæ°´çº¿ä»¥ BlockInputStream å’Œ BlockOutputStream è¿›è¡Œç»„ç»‡ã€‚æ¯”æ–¹è¯´"select"æ˜¯åŸºäº"from"çš„Blockè¾“å‡ºæµæ¥è¿›è¡Œé€‰æ‹©çš„ï¼Œé€‰æ‹©åçš„ç»“æœä¹Ÿä¼šä»¥Blockè¾“å‡ºæµçš„å½¢å¼è¾“å‡ºåˆ°ç»“æœã€‚é¦–å…ˆæˆ‘ä»¬æ¥çœ‹:</p><blockquote toutiao-origin=span>dbms/src/Interpreters/InterpreterFactory.cpp</blockquote><p>æ¯ä¸€ç§Queryéƒ½ä¼šæœ‰å¯¹åº”çš„Interpreterï¼Œè¿™ä¸ªå·¥å‚æ–¹æ³•å°±æ˜¯æ ¹æ®ASTçš„ç§ç±»æ¥å®ä¾‹åŒ–å…¶å¯¹åº”çš„Interpreter,ç”±å…¶æ¥å…·ä½“æ‰§è¡Œå¯¹åº”ASTçš„æ‰§è¡Œè®¡åˆ’:</p><pre><p><code>std::unique_ptr&lt;IInterpreter&gt; InterpreterFactory::get(ASTPtr &amp; query, Context &amp; context, QueryProcessingStage::Enum stage)<br>{<br>//ä¸¾ä¸ªä¾‹å­,å¦‚æœè¯¥ASTæ˜¯ç”±selectè¯­å¥è½¬åŒ–è¿‡æ¥,<br>if (query-&gt;as&lt;ASTSelectQuery&gt;)<br>{<br>/// This is internal part of ASTSelectWithUnionQuery.<br>/// Even if there is SELECT without union, it is represented by ASTSelectWithUnionQuery with single ASTSelectQuery as a child.<br>return std::make_unique&lt;InterpreterSelectQuery&gt;(query, context, SelectQueryOptions(stage));<br>}<br>}</code></p></pre><p>æˆ‘ä»¬å°±ä»¥ <strong toutiao-origin=span>InterpreterSelectQuery</strong>ä¸ºä¾‹ï¼Œäº†è§£å…¶å®ä¾‹åŒ–çš„æ ¸å¿ƒé€»è¾‘:</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>InterpreterSelectQuery::InterpreterSelectQuery<br>{<br>//è·å–AST<br>auto &amp; query = getSelectQuery;<br><br>//å¯¹ASTåšè¿›ä¸€æ­¥è¯­æ³•åˆ†æï¼Œå¯¹è¯­æ³•æ ‘åšä¼˜åŒ–é‡å†™<br>syntax_analyzer_result = SyntaxAnalyzer(context, options).analyze(<br>query_ptr, source_header.getNamesAndTypesList, required_result_column_names, storage, NamesAndTypesList);<br><br>//æ¯ä¸€ç§Queryéƒ½ä¼šå¯¹åº”ä¸€ä¸ªç‰¹æœ‰çš„è¡¨è¾¾å¼åˆ†æå™¨,ç”¨äºçˆ¬å–ASTç”Ÿæˆæ‰§è¡Œè®¡åˆ’(æ“ä½œé“¾)<br>query_analyzer = std::make_unique&lt;SelectQueryExpressionAnalyzer&gt;(<br>query_ptr, syntax_analyzer_result, context,<br>NameSet(required_result_column_names.begin, required_result_column_names.end),<br>options.subquery_depth, !options.only_analyze);<br>}</code></p></pre><p>è¯­æ³•åˆ†æç›´æ¥ç”Ÿæˆçš„ASTè½¬åŒ–æˆæ‰§è¡Œè®¡åˆ’å¯èƒ½æ€§èƒ½ä¸Šå¹¶ä¸æ˜¯æœ€ä¼˜çš„ï¼Œå› æ­¤éœ€è¦SyntaxAnalyzer å¯¹å…¶è¿›è¡Œä¼˜åŒ–é‡å†™ï¼Œåœ¨å…¶æºç ä¸­å¯ä»¥çœ‹åˆ°å…¶æ¶‰åŠåˆ°éå¸¸å¤š <strong>åŸºè§„åˆ™</strong><strong>ä¼˜åŒ–(rule based optimization)</strong>çš„trickã€‚</p><p>SyntaxAnalyzer ä¼šé€ä¸ªé’ˆå¯¹è¿™äº›è§„åˆ™å¯¹æŸ¥è¯¢è¿›è¡Œæ£€æŸ¥ï¼Œç¡®å®šå…¶æ˜¯å¦æ»¡è¶³è½¬æ¢è§„åˆ™ï¼Œä¸€æ—¦æ»¡è¶³å°±ä¼šå¯¹å…¶è¿›è¡Œè½¬æ¢ã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>SyntaxAnalyzerResultPtr SyntaxAnalyzer::analyze<br>{<br>// å‰”é™¤å†—ä½™åˆ—<br>removeDuplicateColumns(result.source_columns);<br><br>// æ ¹æ®settingsä¸­enable_optimize_predicate_expressioné…ç½®åˆ¤æ–­æ˜¯å¦è¿›è¡Œè°“è¯ä¸‹ç§»<br>replaceJoinedTable(node);<br><br>// æ ¹æ®settingsä¸­distributed_product_modeé…ç½®é‡å†™IN ä¸ JOIN è¡¨è¾¾å¼<br>InJoinSubqueriesPreprocessor(context).visit(query);<br><br>// ä¼˜åŒ–Queryå†…éƒ¨çš„å¸ƒå°”è¡¨è¾¾å¼<br>LogicalExpressionsOptimizer.perform;<br><br>// åˆ›å»ºä¸€ä¸ªä»åˆ«ååˆ°ASTèŠ‚ç‚¹çš„æ˜ å°„å­—å…¸<br>QueryAliasesVisitor(query_aliases_data, log.stream).visit(query);<br><br>// å…¬å…±å­è¡¨è¾¾å¼çš„æ¶ˆé™¤<br>QueryNormalizer(normalizer_data).visit(query);<br><br>// æ¶ˆé™¤selectä»å¥åçš„å†—ä½™åˆ—<br>removeUnneededColumnsFromSelectClause(select_query, required_result_columns, remove_duplicates);<br><br>// æ‰§è¡Œæ ‡é‡å­æŸ¥è¯¢ï¼Œå¹¶ä¸”ç”¨å¸¸é‡æ›¿ä»£æ ‡é‡å­æŸ¥è¯¢ç»“æœ<br>executeScalarSubqueries(query, context, subquery_depth);<br><br>// å¦‚æœæ˜¯selectè¯­å¥è¿˜ä¼šåšä¸‹åˆ—ä¼˜åŒ–:<br><br>// è°“è¯ä¸‹ç§»ä¼˜åŒ–<br>PredicateExpressionsOptimizer(select_query, settings, context).optimize;<br><br>/// GROUP BY ä»å¥çš„ä¼˜åŒ–<br>optimizeGroupBy(select_query, source_columns_set, context);<br><br>/// ORDER BY ä»å¥çš„å†—ä½™é¡¹å‰”é™¤<br>optimizeOrderBy(select_query);<br><br>/// LIMIT BY ä»å¥çš„å†—ä½™åˆ—å‰”é™¤<br>optimizeLimitBy(select_query);<br><br>/// USINGè¯­å¥çš„å†—ä½™åˆ—å‰”é™¤<br>optimizeUsing(select_query);<br><br>}</code></p></pre><p>è¿™é‡ŒæŒ‘é€‰å‡ ä¸ªç®€å•ä»‹ç»ä¸€ä¸‹:</p><p>â€¢ å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤(Common Subexpression Elimination)</p><p>å¦‚æœè¡¨è¾¾å¼ x op y å…ˆå‰è¢«è®¡ç®—è¿‡ï¼Œå¹¶ä¸”ä»å…ˆå‰çš„è®¡ç®—åˆ°ç°åœ¨å…¶è®¡ç®—è¡¨è¾¾å¼å¯¹åº”çš„å€¼æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆ x op y å°±ç§°ä¸ºå…¬å…±å­è¡¨è¾¾å¼ã€‚å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤ä¼šæœç´¢æ‰€æœ‰ç›¸åŒè®¡ç®—è¡¨è¾¾å¼çš„å®ä¾‹ï¼Œå¹¶åˆ†ææ˜¯å¦å€¼å¾—ç”¨ä¿å­˜è®¡ç®—å€¼çš„å•ä¸ªå˜é‡æ¥æ›¿æ¢å®ƒä»¬ï¼Œä»¥å‡å°‘è®¡ç®—çš„å¼€é”€ã€‚</p><p>â€¢ æ ‡é‡å­æŸ¥è¯¢(Scala Subquery)çš„å¸¸é‡æ›¿æ¢</p><p>æ ‡é‡å­æŸ¥è¯¢å°±æ˜¯è¿”å›å•ä¸€å€¼çš„å­æŸ¥è¯¢ï¼Œå’Œå…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤ç›¸ä¼¼ï¼Œå¯ä»¥ç”¨å¸¸é‡æ¥æ›¿æ¢SQLä¸­æ‰€æœ‰çš„æ ‡é‡å­æŸ¥è¯¢ç»“æœä»¥å‡å°‘è®¡ç®—å¼€é”€ã€‚</p><p>â€¢ è°“è¯ä¸‹ç§»(Predicate Pushdown)</p><p>æŠŠå¤–å±‚æŸ¥è¯¢å—ä¸­çš„WHEREå­å¥çš„è°“è¯ä¸‹ç§»åˆ°è¾ƒä½å±‚æŸ¥è¯¢å—å¦‚è§†å›¾ï¼Œä»¥å°½å¯èƒ½æŠŠè¿‡æ»¤æ•°æ®çš„æ“ä½œç§»åŠ¨åˆ°é è¿‘æ•°æ®æºçš„ä½ç½®ã€‚æå‰è¿›è¡Œæ•°æ®è¿‡æ»¤èƒ½å¤Ÿå¤§å¹…å‡å°‘ç½‘ç»œä¼ è¾“æˆ–è€…å†…å­˜è¯»å–è®¿é—®çš„æ•°æ®é‡ï¼Œä»¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚</p><p>è€Œ query_analyzer çš„ä½œç”¨å¯ä»¥ç†è§£ä¸ºè§£æä¼˜åŒ–é‡å†™åçš„ASTï¼Œç„¶åå¯¹æ‰€è¦è¿›è¡Œçš„æ“ä½œç»„æˆä¸€æ¡æ“ä½œé“¾ï¼Œå³ç‰©ç†æ‰§è¡Œè®¡åˆ’ï¼Œå¦‚:</p><pre><p><code>ExpressionActionsChain chain;<br>analyzer.appendWhere(chain);<br>chain.addStep;<br>analyzer.appendSelect(chain);<br>analyzer.appendOrderBy(chain);<br>chain.finalize;</code></p></pre><p>ä¸Šè¿°ä»£ç æŠŠwhere,select,orderbyæ“ä½œéƒ½åŠ å…¥åˆ°æ“ä½œé“¾ä¸­ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ä»Storageå±‚è¯»å–Blockï¼Œå¯¹Blockæ•°æ®åº”ç”¨ä¸Šè¿°æ“ä½œé“¾çš„æ“ä½œã€‚è€Œæ‰§è¡Œçš„æ ¸å¿ƒé€»è¾‘ï¼Œå°±åœ¨å¯¹åº”Interpreterçš„ executeImpl æ–¹æ³•å®ç°ä¸­,è¿™é‡Œä»¥selectè¯­å¥çš„Interpreteræ¥äº†è§£ä¸‹è¯»å–Blockæ•°æ®å¹¶ä¸”å¯¹blockæ•°æ®è¿›è¡Œç›¸åº”æ“ä½œçš„æµç¨‹ã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>void InterpreterSelectQuery::executeImpl(TPipeline &amp; pipeline, const BlockInputStreamPtr &amp; prepared_input)<br>{<br>// å¯¹åº”Queryçš„AST<br>auto &amp; query = getSelectQuery;<br><br>AnalysisResult expressions;<br>// ç‰©ç†è®¡åˆ’ï¼Œåˆ¤æ–­è¡¨è¾¾å¼æ˜¯å¦æœ‰where,aggregate,having,order_by,litmit_byç­‰å­—æ®µ<br>expressions = analyzeExpressions(<br>getSelectQuery,<br>*query_analyzer,<br>QueryProcessingStage::FetchColumns,<br>options.to_stage,<br>context,<br>storage,<br>true,<br>filter_info);<br><br>// ä»Storageè¯»å–æ•°æ®<br>executeFetchColumns(from_stage, pipeline, sorting_info, expressions.prewhere_info, expressions.columns_to_remove_after_prewhere);<br><br>// eg:æ ¹æ®SQLçš„å…³é”®å­—åœ¨BlockStreamæµæ°´çº¿ä¸­æ‰§è¡Œç›¸åº”çš„æ“ä½œ, å¦‚where,aggregate,distinctéƒ½åˆ†åˆ«ç”±ä¸€ä¸ªå‡½æ•°è´Ÿè´£æ‰§è¡Œ<br>executeWhere(pipeline, expressions.before_where, expressions.remove_where_filter);<br><br>executeAggregation(pipeline, expressions.before_aggregation, aggregate_overflow_row, aggregate_final);<br><br>executeDistinct(pipeline, true, expressions.selected_columns);<br><br>}</code></p></pre><p>æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†æ‰§è¡Œè®¡åˆ’AnalysisResult(å³ç‰©ç†æ‰§è¡Œè®¡åˆ’)ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦ä»storageå±‚ä¸­è¯»å–æ•°æ®æ¥æ‰§è¡Œå¯¹åº”çš„æ“ä½œï¼Œæ ¸å¿ƒé€»è¾‘åœ¨<strong toutiao-origin=span> executeFetchColumns </strong>ä¸­: æ ¸å¿ƒæ“ä½œå°±æ˜¯ä»storageå±‚è¯»å–æ‰€è¦å¤„ç†åˆ—çš„Blockï¼Œå¹¶ç»„ç»‡æˆBlockStreamã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>void InterpreterSelectQuery::executeFetchColumns(<br>QueryProcessingStage::Enum processing_stage, TPipeline &amp; pipeline,<br>const SortingInfoPtr &amp; sorting_info, const PrewhereInfoPtr &amp; prewhere_info, const Names &amp; columns_to_remove_after_prewhere)<br>{<br>// å®ä¾‹åŒ–Block Stream<br>auto streams = storage-&gt;read(required_columns, query_info, context, processing_stage, max_block_size, max_streams)<br>// è¯»å–åˆ—å¯¹åº”çš„Block,å¹¶ä¸”ç»„ç»‡æˆBlock Stream<br>streams = {std::make_shared&lt;BlockInputStream&gt;(storage-&gt;getSampleBlockForColumns(required_columns))};<br>streams.back = std::make_shared&lt;ExpressionBlockInputStream&gt;(streams.back, query_info.prewhere_info-&gt;remove_columns_actions);<br>}</code></p></pre><p>è¯»å–å®ŒBlock Streamä¹‹åå°±æ˜¯å¯¹å…¶æ‰§è¡Œå„ç§executeæ“ä½œå¦‚ executeAggregation , executeWhere æ“ä½œï¼Œè¯¦è§</p><blockquote toutiao-origin=span>InterpreterSelectQuery::executeImpl</blockquote><p>çš„ä»£ç ã€‚</p><p>å› æ­¤Interpreterçš„å¤„ç†è¿‡ç¨‹å¯ä»¥æ€»ç»“ä¸º:</p><p>â€¢ å¯¹ASTè¿›è¡Œä¼˜åŒ–é‡å†™</p><p>â€¢ è§£æé‡å†™åçš„ASTå¹¶ç”Ÿæˆæ“ä½œé“¾(æ‰§è¡Œè®¡åˆ’)</p><p>â€¢ ä»å­˜å‚¨å¼•æ“ä¸­è¯»å–è¦å¤„ç†çš„Blockæ•°æ®</p><p>â€¢ å¯¹è¯»å–çš„Blockæ•°æ®åº”ç”¨æ“ä½œé“¾ä¸Šçš„æ“ä½œ</p><p>é‚£æˆ‘ä»¬è¯»å–Block Streamå¹¶è¿›è¡Œå¤„ç†åï¼Œç”Ÿæˆçš„ç»“æœå¦‚ä½•å†™å›åˆ°storageå±‚å‘¢? æˆ‘ä»¬è¿™é‡Œä»¥insertè¯­å¥çš„Interpreteræ¥äº†è§£ä¸‹:</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>BlockIO InterpreterInsertQuery::execute<br>{<br>// tableä¸ºå­˜å‚¨å¼•æ“æ¥å£<br>StoragePtr table = getTable(query);<br>BlockOutputStreamPtr out;<br><br>// ä»å­˜å‚¨å¼•æ“è¯»å–Block Stream<br>auto query_sample_block = getSampleBlock(query, table);<br>out = std::make_shared&lt;AddingDefaultBlockOutputStream&gt;(<br>out, query_sample_block, out-&gt;getHeader, table-&gt;getColumns.getDefaults, context);<br><br>//æ‰§è¡Œç»“æœå°è£…æˆBlockIO<br>BlockIO res;<br>res.out = std::move(out);<br>}</code></p></pre><p>ä¸Šé¢ä»£ç ä¸­çš„StoragePtrå®é™…ä¸Šå°±æ˜¯IStorageè¿™ä¸ªå­˜å‚¨å¼•æ“çš„æ¥å£</p><pre><p><code>using StoragePtr = std::shared_ptr&lt;IStorage&gt;;</code></p></pre><p>æ— è®ºæ˜¯å†™å…¥è¿˜æ˜¯è¯»å–æ“ä½œéƒ½æ˜¯ä¾é åº•å±‚å­˜å‚¨å¼•æ“(å¦‚MergeTree)çš„writeå’Œreadæ¥å£æ¥å®ç°çš„ï¼Œå…³äºå­˜å‚¨å¼•æ“çš„ç»†èŠ‚å®ç°è¿™é‡Œæš‚æ—¶ä¸èµ˜è¿°ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“æˆ‘ä»¬ä»å­˜å‚¨å¼•æ“æ¥å£ä¸­ä»¥æµæ–¹å¼è¯»å–Blockæ•°æ®ï¼Œè€Œç»“æœç»„ç»‡æˆBlockIOæµè¾“å‡ºã€‚Interpreterçš„æµç¨‹æ€»ç»“å¦‚ä¸‹:</p><img alt="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/S4RDmlD5SJPGhe><p></p><h2 toutiao-origin=h3><strong class=highlight-text toutiao-origin=span>04 è¿”å›è¯·æ±‚ç»“æœ</strong></h2><p><strong toutiao-origin=span>TCPHandler::runImpl</strong>ä¸­ï¼Œæ‰§è¡Œå®Œ executeQuery ä¹‹åéœ€è¦è°ƒç”¨å„ç§processQueryçš„æ–¹æ³•æ¥ç»™clientè¿”å›æ‰§è¡ŒSQLåçš„ç»“æœã€‚</p><p>æˆ‘ä»¬ä»¥ <strong toutiao-origin=span>TCPHandler::processOrdinaryQuery</strong>ä¸ºä¾‹åšç®€å•åˆ†æ:</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>void TCPHandler::processOrdinaryQuery<br>{<br>//æŠŠBlockStreamå°è£…æˆå¼‚æ­¥çš„Stream,é‚£ä¹ˆä»æµä¸­è¯»å–æ•°æ®å°†ä¼šæ˜¯å¼‚æ­¥æ“ä½œ<br>AsynchronousBlockInputStream async_in(state.io.in);<br><br>while(true){<br>Block block;<br>//ä»IOæµè¯»å–blockæ•°æ®<br>block = async_in.read;<br>//å‘é€blockæ•°æ®<br>sendData(block);<br>}<br>}</code></p></pre><p>Serverè´Ÿè´£åœ¨ sendData å‡½æ•°ä¸­æŠŠè¾“å‡ºç»“æœå†™å…¥åˆ°å¥—æ¥å­—è¾“å‡ºç¼“å†²åŒºä¸­,clientåªè¦ä»è¿™ä¸ªè¾“å‡ºç¼“å†²åŒºè¯»å–å°±èƒ½å¤Ÿå¾—åˆ°ç»“æœã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘åŠ¨é˜…è§ˆ</strong></p><pre><p><code>void TCPHandler::sendData(const Block &amp; block)<br>{<br>//åˆå§‹åŒ–OutputStreamçš„å‚æ•°<br>initBlockOutput(block);<br><br>// è°ƒç”¨BlockOutputStreamçš„writeå‡½æ•°,æŠŠBlockå†™åˆ°è¾“å‡ºæµ<br>state.block_out-&gt;write(block);<br>state.maybe_compressed_out-&gt;next;<br>out-&gt;next;<br>}</code></p></pre><p>02</p><p></p><h1 toutiao-origin=h2>ç»“è¯­</h1><p>äº†è§£ClickHouseèƒŒåSQLçš„æŸ¥è¯¢æ•´ä¸ªæµç¨‹ï¼Œä¸ä»…èƒ½è®©æ•°æ®åº“ä½¿ç”¨è€…æ›´æ¸…æ™°åœ°è®¤è¯†åˆ°å¦‚ä½•ç¼–å†™æœ€ä¼˜åŒ–çš„SQLï¼Œä¹Ÿèƒ½å¤Ÿè®©æ•°æ®åº“å†…æ ¸å¼€å‘è€…åŠ æ·±å¯¹æ•°æ®åº“ä½“ç³»ç»“æ„çš„ç†è§£ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚</p><p>æœ¬æ–‡å¹¶æ²¡æœ‰æ¶‰åŠåˆ°å¤ªæ·±å…¥çš„æŠ€æœ¯ç»†èŠ‚ï¼Œè¯¸å¦‚å‘é‡åŒ–æ‰§è¡Œå¼•æ“ï¼ŒSIMDï¼ŒåŸºäºllvmçš„åŠ¨æ€ä»£ç ç”Ÿæˆï¼Œç±»MergeTreeå­˜å‚¨å¼•æ“ç­‰CKçš„æŠ€æœ¯ç»†èŠ‚ä¹Ÿæ²¡æœ‰æåŠï¼Œåªæ˜¯ä»å®è§‚è§’åº¦ç»™è¯»è€…ä»‹ç»äº†æ‰§è¡ŒSQLèƒŒåå†…æ ¸åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚åç»­æˆ‘ä»¬ä¼šæ¨å‡ºæ›´å¤šå†…æ ¸æºç è§£è¯»æ–‡ç« ï¼Œæ•¬è¯·å…³æ³¨ã€‚</p><p><strong toutiao-origin=span>END</strong></p><pre><div><img alt="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RdIEj9hARSR1DD></div><br><div><ul><li><p>åŸºäº Apache Flink çš„å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ</p></li><li><p>å…³äºæ•°æ®ä¸­å°çš„æ·±åº¦æ€è€ƒä¸æ€»ç»“ï¼ˆå¹²å¹²è´§ï¼‰</p></li><li><p>æ—¥å¿—æ”¶é›†Agentï¼Œé˜´æš—æ½®æ¹¿çš„åœ°åº•ä¸–ç•Œ</p></li><li><p>2020 ç»§ç»­è¸è¸å®å®çš„åšå¥½è‡ªå·±</p></li></ul></div></pre><img alt="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/S0FUMtl41NrEMK><img alt="æ·±åº¦ | ä¸€æ¡æŸ¥è¯¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç é˜…è¯»" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/S0FUNTDJBxRdKz><pre><div><div><div><div><div><div><div><div><div><div><div><div><div><div><p>ä½ ç‚¹çš„æ¯ä¸ªèµï¼Œæˆ‘éƒ½å½“æˆäº†å–œæ¬¢</p></div></div></div></div></div></div></div></div></div></div></div></div></div></div></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ä¸€æ¡','æŸ¥è¯¢','SQL'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>