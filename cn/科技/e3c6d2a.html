<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ServiceMesh的关键：边车模式（sidecar） | 极客快訊</title><meta property="og:title" content="ServiceMesh的关键：边车模式（sidecar） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/46116e1cc3b442119460245c3bc79c00"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e3c6d2a.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e3c6d2a.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e3c6d2a.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e3c6d2a.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e3c6d2a.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e3c6d2a.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e3c6d2a.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e3c6d2a.html><meta property="article:published_time" content="2020-10-29T20:52:48+08:00"><meta property="article:modified_time" content="2020-10-29T20:52:48+08:00"><meta name=Keywords content><meta name=description content="ServiceMesh的关键：边车模式（sidecar）"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/e3c6d2a.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ServiceMesh的关键：边车模式（sidecar）</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><br></p><div class=pgc-img><img alt=ServiceMesh的关键：边车模式（sidecar） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/46116e1cc3b442119460245c3bc79c00><p class=pgc-img-caption></p></div><blockquote><p>不羡鸳鸯不羡仙，一行代码调半天。原创：小姐姐味道（微信公众号ID：xjjdog），欢迎分享，转载请保留出处。</p></blockquote><p>哎，又堵车了。</p><p>记性好的同学，一定记得我们那辆</p><p>敞快明亮的JMC</p><p>。拥有一辆JMC，任嘶吼的狂风穿过车窗打在脸上，是一件无比畅快的事情。</p><p>这次的车不一样。有点高级。开的猛的时候，狂风能够掀掉头盔。</p><div class=pgc-img><img alt=ServiceMesh的关键：边车模式（sidecar） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/48971b16d5cb4d02beb761313d34ab06><p class=pgc-img-caption></p></div><p>仔细观察上面的这辆车，它有三个轮子。其中左边多出来的轮子和座位，就叫做边车。它是可拆卸的，加上之后，就可以带人兜风了。</p><p>边车模式（sidecar），就像是梅超风对于陈玄风，莫邪对于干将。由于和比较前沿的ServiceMesh概念息息相关，所以很容易让人望而却步。你到网上去随便一搜，都是晦涩难懂的概念。要了解下一代微服务，提前布局，需要啃一些枯燥的知识。</p><div class=pgc-img><img alt=ServiceMesh的关键：边车模式（sidecar） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d9856ae343a443f597256749ccda5e48><p class=pgc-img-caption></p></div><p>随着我的介绍，你会发现sidecar模式，是一个高度抽象的模式。但是不要着急，这辆车形状怪异的交通工具，我们依然能够驾驭。它的概念很简单，只不过有很多使用限制。</p><h1 class=pgc-h-arrow-right>一步步升级</h1><p>注意：下面都是边车模式，只不过有的边车实在是简陋。</p><p><strong>&lt;1></strong></p><p>大家都知道，微服务是复杂的，引入了一系列的问题，服务治理显得尤关重要。比如日志收集、服务监控、服务治理等。</p><div class=pgc-img><img alt=ServiceMesh的关键：边车模式（sidecar） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/708057573f0d4fbc8a456ff373d4e680><p class=pgc-img-caption></p></div><p>比如上面这张图，我们在一个Linux服务器上，部署了四个进程。其中，web服务是最主要的进程，其他进程只是作为一些附加功能部署上去的。</p><p>其实，这三个圆圈，就是边车的功能。只要把它给挂载上，上面的服务就拥有了这些功能。</p><p>但对于这三个组件的配置，是相当复杂的。我们需要很多重复的工作。</p><p><strong>&lt;2></strong></p><div class=pgc-img><img alt=ServiceMesh的关键：边车模式（sidecar） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fa896f1b9f2c4272826322878dfdf5f6><p class=pgc-img-caption></p></div><p>上面这张图，通过将Web应用与我们的辅助应用打包在一块，进一步增强了 <strong>不可变性</strong>。拥有了容器的加持，我们就能够靠约定来简化打包和发布操作。比如，上面的各个组件就可以通过localhost直接通信。</p><p>但可惜的是，我们的这些辅助程序，都是作为docker容器里的进程去启动的，这种 <strong>富容器模式</strong> 有诸多缺陷，不符合不可变基础设施的理念，所以并不值得推荐。</p><p><strong>&lt;3></strong></p><p>k8s的Pod，在容器的基础上，进一步抽象。一个Pod中可以包含多个容器。如下图，基础服务和Web服务可以分别独自构建，最后以Pod作为载体，搭上便车就可以了。</p><div class=pgc-img><img alt=ServiceMesh的关键：边车模式（sidecar） onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/727ccd42d4b4426bbe46e54c4cc4d9d1><p class=pgc-img-caption></p></div><p>为了更加显著的看到这个过程，下面这张图以日志收集为例，介绍了两个pod，相同日志收集docker容器的拓扑图。</p><div class=pgc-img><img alt=ServiceMesh的关键：边车模式（sidecar） onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/bf39476762d443edbdccfd2b9b646df5><p class=pgc-img-caption></p></div><p>从上面的演进过程我们可以看到。边车，就是辅助或者基础程序而已。但如何方便的管理这些附加的程序，我们有不同的组织方式。只有高度的抽象层次，才能进行方便的组装与设计。</p><p><strong>&lt;4></strong></p><p>到此为止，我们可以看一下ServiceMesh经典的两张图了。</p><p>我们把Web应用（业务服务），抽象成绿色的方块。然后把辅助组件（sidecar），抽象成蓝色方块。在一个相对简单的环境中，我们的部署方式如下所示。</p><div class=pgc-img><img alt=ServiceMesh的关键：边车模式（sidecar） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4ed9540f59414153b3765a87d41d6244><p class=pgc-img-caption></p></div><p>由于辅助组件并不能单独存在，所以它们都依附在绿色的服务上面。</p><p>我们抽调服务集群的血肉（Web服务），只留下它的筋骨（sidecar），就可以获得下面这张图，这就是ServiceMesh。可以看到里面的连接线条是非常复杂的，人工不可能完成，只能依靠平台去管理。</p><div class=pgc-img><img alt=ServiceMesh的关键：边车模式（sidecar） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6a9ed7c5b4ba4e59941be2ff0c7c61d0><p class=pgc-img-caption></p></div><p>任何东西只要一上规模了，就体现了它的复杂度。这还仅仅是只有36个服务节点的拓扑图。</p><p>不要小看这一个小小的蓝色方块。它不仅仅可以是一个辅助程序，而且可以成为基础设施。现在典型的service mesh，分为`数据平面`和`控制平面`，大多数落地的企业使用proxy方式实现了数据平面，对控制平面的实现有限。</p><p>像比较流行的Istio，通过负载均衡、服务间的身份验证、监控等方法，它可以轻松地创建一个已经部署了服务的网络，而服务的代码只需很少更改甚至无需更改。通过在整个环境中部署一个特殊的 sidecar代理，为服务添加 Istio 的支持，而代理会拦截微服务之间的所有网络通信，然后使用其控制平面的功能来配置和管理 Istio。</p><p>我们看下它官方的功能描述：</p><ol start=1><li>为 HTTP、gRPC、WebSocket 和 TCP 流量自动负载均衡。</li><li>通过丰富的路由规则、重试、故障转移和故障注入对流量行为进行细粒度控制。</li><li>可插拔的策略层和配置 API，支持访问控制、速率限制和配额。</li><li>集群内（包括集群的入口和出口）所有流量的自动化度量、日志记录和追踪。</li><li>在具有强大的基于身份验证和授权的集群中实现安全的服务间通信。</li></ol><p>可以说，ServiceMesh将业务属性剥离了出去，只剩下一张大网，涵盖了所有运维和基础服务的工作。</p><p>要用它，不能说是没有代价的。其中有两点比较重要：</p><ol start=1><li>网络包通过层层的代理和转发（Ambassador模式），效率会降低，排错会变困难。</li><li>需要按照这个网格的规范进行改造，也就是写一堆适配器（Adapter模式）。</li></ol><h1 class=pgc-h-arrow-right>SpringCloud的Sidecar</h1><p>说到适配器，就不禁想起了SpringCloud的Sidecar。</p><p>Java里要说玩新概念，怎么能少的了Spring家族？SpringCloud同样有一个sidecar的组件，它的maven座标如下。</p><pre><code>&lt;dependency&gt;            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;            &lt;artifactId&gt;spring-cloud-netflix-sidecar&lt;/artifactId&gt;&lt;/dependency&gt;</code></pre><p>它做的事情，更加像一个适配器。它能把一个普通的php或者nodejs服务，伪装成一个正常的SpringCloud服务。</p><p>通过简单的配置，我们就可以让一些其他语言开发的Web应用，加入到SpringCloud体系中来。</p><p>它的使用比较简单，在此不过多介绍。</p><h1 class=pgc-h-arrow-right>End</h1><p>可以看到，我们今天的这辆车，虽然简陋，但是很高级，甚至和最前沿的ServiceMesh挂钩了。在这里，我实在是佩服计算机界的名词创造能力和抽象能力。一个简单的生产者消费者，玩出了响应式编程；一个简单的边车模式，玩出了ServicemMesh。</p><p>虽然这个东西比较新，但比起什么中台概念来，能够落地不务虚，是更加有技术说服力的。因为中台搞不死程序员，但会搞死公司。</p><p>未来还会有什么奇形怪状的交通工具呢？这是个未知数。请搭上xjjdog的轻便列车，一块探索吧。</p><blockquote><p>作者简介：小姐姐味道 (xjjdog)，一个不允许程序员走弯路的公众号。聚焦基础架构和Linux。十年架构，日百亿流量，与你探讨高并发世界，给你不一样的味道。我的个人微信xjjdog0，欢迎添加好友，进一步交流。</p><p><br></p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ServiceMesh','关键','边车'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>