<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MYSQL_多版本并发控制、存储引擎、索引简介 | 极客快訊</title><meta property="og:title" content="MYSQL_多版本并发控制、存储引擎、索引简介 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/bbd1778d213e4afe855a44f4e8c9ee6d"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e3ddae59.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e3ddae59.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e3ddae59.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e3ddae59.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e3ddae59.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e3ddae59.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e3ddae59.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e3ddae59.html><meta property="article:published_time" content="2020-11-14T21:02:06+08:00"><meta property="article:modified_time" content="2020-11-14T21:02:06+08:00"><meta name=Keywords content><meta name=description content="MYSQL_多版本并发控制、存储引擎、索引简介"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/e3ddae59.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MYSQL_多版本并发控制、存储引擎、索引简介</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1><strong>多版本并发控制</strong></h1><p>mysql的大多数事务型存储引擎实现的都不是简单的行级锁。基于提升并发性能的考虑，它们一般都同时实现了多版本并发控制。</p><p>可以认为MVCC是行级锁的一种变种，但是它很多情况下避免了加锁操作，因为开销更低。</p><p>InnoDB的MVCC，是通过在每行记录最后保存的两个隐藏的列来实现，这两个列，一个保存了行的创建时间，一个保存行的过期时间（或删除时间），当然存储的并不是实际的时间值，而是系统版本好。每开始一个新的事务，系统版本号都会自动递增。事务开始时刻的系统版本号会作为事务的版本号，用来查询到的每行版本号进行比较。</p><p>REPEATABLE READ隔离级别下，MVCC的实现：</p><ul><li>SELECT</li><li class=ql-indent-1>InnoDB之查找版本早于当前事务版本号的数据行，这样可以确保事务读取的行，要么是在事务开始前已经存在，要么是事务自身插入或者修改过的。</li><li class=ql-indent-1>行的删除版本要么未定义，要么大于当前事务版本号，这可以确保事务读取到的行在事务开始之前未被删除。</li><li>INSERT</li><li class=ql-indent-1>InnoDB为新插入的每一行保存当前系统版本号作为行版本号。</li><li>DELETE</li><li class=ql-indent-1>InnoDB为删除的每一行保存当前系统版本号作为行删除标识。</li><li>UPDATE</li><li class=ql-indent-1>InnoDB为插入一航新记录，保存当前系统版本号作为行版本号，同时保存当前系统版本号到原来的行作为行删除版本号。</li></ul><p>MVCC只在REPEATABLE READ跟READ COMMITED两个隔离级别工作。其他两个隔离级别都和MVCC不兼容。因为READ UNCOMMITED总是读取最新的数据行，而不是符合当前事务版本的数据行。而SERIALIZABLE则会对所有读取的数据的行都加锁。</p><h1><strong>存储引擎</strong></h1><p><strong>InnoDB存储引擎</strong></p><p>InnoDB是MYSQL的默认事务型引擎，也是最重要、使用最广泛的存储引擎。除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑InnoDB引擎。</p><p>InnoDB采用MVCC来支持高并发，并且实现了四个标准的隔离级别。默认级别是REPEATABLE READ（可重复读），并且通过间隙锁+MVCC策略防止幻读的实现，间隙锁使得InnoDB不仅仅锁定查询设计的行，还会对索引中的间隙进行锁定，以防止幻影行的插入。</p><p>间隙锁：当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做“间隙（GAP)”，InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁（Next-Key锁）。</p><p>参考：间隙锁（Next-Key锁）</p><p>主索引是聚簇索引，在索引中保存了数据，从而避免直接读取磁盘，因此对查询性能有很大的提升。</p><p>InnoDB内部做了很多优化，包括从磁盘读取数据时采用的可预测性预读，能够自动在内存中创建hash索引以加速度操作的自适应哈希索引，以及能够加速插入操作的插入缓冲区等。</p><p><strong>MyISAM存储引擎</strong></p><p>在mysql5.1以及之前的版本，MyISAM是默认的存储引擎。MyISAM提供了大量的特性，包括全文索引、压缩、空间函数等，但是不支持事务和行级锁，而且有一个毫无疑问的缺陷是崩溃之后无法安全恢复。</p><p>对于只读的数据、或者表比较小、可以忍受修复操作，则依然可以使用MyISAM引擎。</p><p>创建MyISAM表的时候，如果指定了DELAY_KEY_WRITE选项，在每次修改执行完成时，不会立刻将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区，只有在清理键缓冲区或者关闭表的时候才会将对应的索引块写入到磁盘。这种方式可以极大地提升写入性能，但是在数据库或者主机崩溃时会造成索引损坏，需要执行修复操作。</p><p><strong>比较</strong></p><ul><li>事务：InnoDB支持事务，MyISAM不支持事务。</li><li>锁粒度：InnoDB支持表级锁跟行级锁，而MyISAM只支持表级锁。</li><li>外键：InnoDB支持外键。</li><li>备份：InnoDB支持热备份，但需要工具。</li><li>崩溃恢复：MyISAM崩溃后发生损坏的概率比InnoDB高很多，而且恢复的速度也比较慢。</li><li>其他特性：MyISAM支持全文索引、压缩、空间函数等特性。</li></ul><p>备份的类型</p><ul><li>冷备（cold backup）：需要关mysql服务，读写请求均不允许状态下进行；</li><li>温备（warm backup）： 服务在线，但仅支持读请求，不允许写请求；</li><li>热备（hot backup）：备份的同时，业务不受影响。</li></ul><p><strong>索引</strong></p><p>索引（也叫做“键(key)”）是存储引擎用于快速查找记录中的一种数据结构。</p><p><strong>B-Tree索引</strong></p><p>大多数mysql引擎都支持这种索引。</p><p>虽然使用术语“B-Tree"，但是不同的存储引擎可能使用不同的存储结构，NDB集群存储引擎内部实际用的是T-Tree，InnoDB则使用B+Tree。</p><p>B-Tree索引能够加快访问数据的速度，因为存储引擎不需要进行全表扫描来获取需要的数据，取而代之的是从索引的根节点开始搜索，因此查找速度会快很多。</p><p>B-Tree对索引列是顺序组织存储的，很适合查找范围数据。因为索引树是有序的，所以除了用户查找，还可以用来排序和分组。</p><p>可以指定多个列作为索引列，多个索引列共同组成索引键。B-Tree索引适用于全键值、键值范围或键前缀查找，其中键前缀查找只适用与根据最左前缀查找。查找一定得按照索引的最左列开始。</p><p><strong>B-Tree索引的数据结构</strong></p><p><strong>B-Tree</strong></p><p>为了描述B-Tree，首先定义一条数据记录为二元组[key,data]，key作为记录的键值，对于不同数据记录，key是互不相同的，data为数据记录除key外的数据。</p><ul><li>所有节点具有相同的深度，也就是说B-Tree是平衡的。</li><li>一个节点中的key从左到右非递减排列。</li><li>如果某个指针的左右相邻 key 分别是 keyi 和 keyi+1，且不为 null，则该指针指向节点的所有 key 大于等于 keyi 且小于等于 keyi+1。</li></ul><p>查找算法：首先在根节点进行二分查找，如果找到则返回对应节点的data，否则在相应区间的指针指向的节点递归进行查找。</p><p>由于插入删除新的数据记录会破坏B-Tree的性质，因此在插入删除时，需要对树进行一个分裂、合并、旋转等操作以保持 B-Tree 性质。</p><div class=pgc-img><img alt=MYSQL_多版本并发控制、存储引擎、索引简介 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bbd1778d213e4afe855a44f4e8c9ee6d><p class=pgc-img-caption></p></div><p><strong>B+Tree</strong></p><p>与B-Tree相比，B+Tree有以下特点：</p><ul><li>每个节点的指针上限为2d而不是2d+1（d为B-Tree的度）。</li><li>内节点不存储data，只存储key；外节点不存储指针。</li></ul><div class=pgc-img><img alt=MYSQL_多版本并发控制、存储引擎、索引简介 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ad09b272a4064d90b1ecaa105fe9dbc2><p class=pgc-img-caption></p></div><p><strong>带有顺序访问指针的B+Tree</strong></p><p>一般在数据库系统或文件系统中使用的B+Tree结构都在经典B+Tree的基础上进行了优化，增加了顺序访问指针。</p><div class=pgc-img><img alt=MYSQL_多版本并发控制、存储引擎、索引简介 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f0f0f3def2b049ddb0293534d0374537><p class=pgc-img-caption></p></div><p>这个优化的目的是为了提供区间访问的性能，例如图中如果要查询key为18到49的所有记录。</p><p><strong>优势</strong></p><p>红黑树等平衡树也可以用来实现索引，但是文件系统及数据库系统普遍采用B-Tree作为索引结构，主要有以下两个原因：</p><ul><li>更好的检索次数：平衡树检索数据的时间复杂度等于树高h，而树高大致为O(h) = O(logN)，其中d为每个节点的出度。红黑树的出度为2，而B-Tree的出度一般都很大，红黑树的树高h明显比B-Tree打非常多，因此检索次数也就更多。B+Tree相比较B-Tree更合适外存索引，因为B+Tree内节点去掉了data域，因此可以拥有更大的出度，检索效率会更高。</li><li>利用计算机预读特性：为了减少磁盘 I/O，磁盘往往不是严格按需读取，而是每次都会预读。这样做的理论依据是计算机科学中著名的局部性原理：当一个数据被用到时，其附近的数据也通常会马上被使用。预读过程中，磁盘进行顺序读取，顺序读取不需要进行磁盘寻道，并且只需要很短的旋转时间，因此速度会非常快。操作系统一般将内存和磁盘分割成固态大小的块，每一块称为一页，内存与磁盘以页为单位交换数据。数据库系统将索引的一个节点的大小设置为页的大小，使得一次 I/O 就能完全载入一个节点，并且可以利用预读特性，相邻的节点也能够被预先载入。</li></ul><p>参考：MySQL索引背后的数据结构及算法原理</p><p><strong>哈希索引</strong></p><p>InnoDB引擎有一个特殊的功能叫“自适应哈希索引”，当某个索引值被使用得非常频繁，会在B+Tree索引之上再创建一个哈希索引，这样就让B+Tree索引具有哈希索引的一些优点，比如快速的哈希查找。</p><p>哈希索引能在O(1)时间进行查找，但是失去了有序性，它具有以下限制：</p><ul><li>哈希索引只包含哈希值跟行指针，而不存储字段值，所以不能使用索引中的值来I避免都去行。</li><li>无法用于排序与分组。</li><li>只支持精确查找，无法用于部分查找与范围查找。</li><li>当出现哈希冲突时，存储引擎必须遍历链表中的所有行指针。</li></ul><p><strong>空间数据索引（R-Tree)</strong></p><p>MyISAM表支持空间索引，可以用作地理数据存储。空间索引会从所有维度来索引数据，查询时可以根据任意维度来组合查询。</p><p>必须使用Mysql的GIS相关函数如MBRONTAINS()等来维护数据。</p><p><strong>全文索引</strong></p><p>全文索引是一种特殊类型的索引，它查找的是文本中的关键字，而不是直接比较索引中的值。查找条件使用 MATCH AGAINST，而不是普通的 WHERE。</p><p>全文索引一般使用倒排序索引实现，它记录着关键词到期所在文档的映射。</p><p>MyISAM存储引擎支持全文索引，InnoDB存储引擎在Mysql 5.6.4版本中也开始支持全文索引。</p><p><strong>索引的优点</strong></p><ul><li>大大减少了服务器需要扫描的数据行数。</li><li>帮助服务器避免进行排序和创建临时表（B+Tree索引是有序的，可以用来Order by和group by操作）。</li><li>将随机I/O变为顺序I/O（B+Tree索引是有序的，也就将相邻的数据都存储到一起）。</li></ul><p>相关文章：</p><p>MySQL数据库InnoDB存储引擎多版本控制(MVCC)实现原理分析</p><p>MySQL存储引擎简介</p><p>以上就是MYSQL_多版本并发控制、存储引擎、索引简介的详细内容，更多请关注其它相关文章！</p><p>更多技巧请《转发 + 关注》哦！</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'MYSQL','存储','简介'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>