<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ | 极客快訊</title><meta property="og:title" content="同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/061d642903b64e2381535ca2be379ae7"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e929204.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e929204.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e929204.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e929204.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e929204.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e929204.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e929204.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e929204.html><meta property="article:published_time" content="2020-10-29T21:04:30+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:30+08:00"><meta name=Keywords content><meta name=description content="同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/e929204.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>​</p><div class=pgc-img><img alt=同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/061d642903b64e2381535ca2be379ae7><p class=pgc-img-caption></p></div><p>同程艺龙的机票、火车票、汽车票、酒店相关业务已经接入了RocketMQ，用于流量高峰时候的削峰，以减少后端的压力。同时，对常规的系统进行解耦，将一些同步处理改成异步处理，每天处理的数据达1500亿条。</p><p>在近期的Apache RockeMQ Meetup上，同程艺龙机票事业部架构师查江，分享了同程艺龙的消息系统如何应对每天1500亿条的数据处理，通过此文，您将了解到：</p><p>o 同程艺龙在消息方面的使用情况；</p><p>o 消息在同程艺龙的应用场景；</p><p>o 技术上踩过哪些坑；</p><p>o 基于RocketMQ，做了哪些改进；</p><p>1 同程艺龙在消息方面的使用情况</p><div class=pgc-img><img alt=同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/11ea7a759c364882bbac667d17e78ee5><p class=pgc-img-caption></p></div><p class=ql-align-justify>RocketMQ集群分为 Name Server 和Broker两部分，Name Server用的是双主模式，一个是考虑性能，另一个是考虑安全性。 在纯数据的Broker分成很多组，每个组里面分为Master和Slave。目前，我们的机票、火车票、汽车票、酒店相关业务已经接入了RocketMQ，用于流量高峰时候的削峰，以减少后端的压力。 同时，对常规的系统进行解耦，将一些同步处理改成异步处理，每天处理的数据多达1500亿条。</p><p>选择RocketMQ的原因是：</p><p>o 接入简单，引入的Java包比较少；</p><p>o 纯Java开发，设计逻辑比较清晰；</p><p>o 整体性能稳定，在Topic数量大的情况下，可以保持性能；</p><p>2 消息在同程艺龙的应用场景</p><p><strong>退订系统</strong></p><p><strong>图中是我们退订系统中的一个应用场景。</strong>用户点击前端的退订按钮，系统首先会调用退订接口，再去调用供应商的退订接口，从而完成一个退订功能。</p><div class=pgc-img><img alt=同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/abd51a9cad6743829e15dad8168d4566><p class=pgc-img-caption></p></div><p class=ql-align-justify>如果供应商的系统接口不可靠，会导致用户退订失败;如果系统设置为同步操作，则会导致用户需要再次点击。所以，我们引入了RocketMQ，将同步改为异步。当前端用户发出退订需求时，退订系统接收到请求，记录到退订系统的数据库里面，表示这个用户正在退订。同时，通过消息引擎把这条退订消息发送到与供应商对接的系统，以调用供应商的接口。</p><p>如果接口调用成功，数据库进行标识，则表示已经退订成功。同时，­­­加了一个补偿的脚本，去数据库捞那些未退订成功的消息，进行重新退订，以此避免消息丢失引起的退订失败。</p><p><strong>房仓系统</strong></p><p><strong>第二个应用场景是我们的房仓系统。</strong>这是一个比较常规的消息使用场景，我们先从供应商处采集一些酒店的基本信息数据和详情数据，然后接入到消息系统，由后端的分销系统、最小价系统和库存系统来进行计算。同时，当供应商出现变价的情况，变价事件也会通过消息系统传递给我们的后端业务系统，以此保证数据的实时性和准确性。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b8bff203b656490da4c965108ab9fae6><p class=pgc-img-caption></p></div><p class=ql-align-justify><strong>供应库的订阅系统</strong></p><p class=ql-align-justify><strong>数据库的订阅系统也用到了消息的应用。</strong>一般情况下做数据库同步，都是通过binlog去读里面的数据，然后搬运到数据库。在搬运的过程中，我们最关注的是数据的顺序性，因此在数据库row模式的基础上，新增了一个功能，以确保每一个Queue里面的顺序是唯一的。</p><div class=pgc-img><img alt=同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/28802a027dcc408c959b17bbffa77d30><p class=pgc-img-caption></p></div><p class=ql-align-justify>虽然，Queue里面的顺序天然都是唯一的，但我们在使用上有一个特点，就是把相同ID的消息都是放在同一个Queue里面的。例如，图中右上角id1的消息，数据库主字段是id1，统一放在Queue1里面，而且是顺序的。在Queue2里，两个id3之间被两个顺序的id2间隔开来了，但实际消费读出来的时候，也会是顺序的，由此，可以用多队列的顺序来提高整体的并发度。</p><p>3 我们踩过哪些坑</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/f86e556afb86422dbaa2503bb58e2c4a><p class=pgc-img-caption></p></div><p><strong>供应商系统的场景</strong></p><p>上图中，一个MQ对应有两个消费者，他们是在同一个Group1中，起初大家都只有Topic1，这时候是正常消费的。但如果在第一个消费者里面加入一个Topic2，这时候是无法消费的或者说是消费不正常了。这是RocketMQ本身的机制引起的问题，需要在第二个消费者里面加入Topic2才能正常消费。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b4a78f443b0f421b95eecee4893460a7><p class=pgc-img-caption></p></div><p class=ql-align-justify><strong>支付交易系统的场景</strong></p><p class=ql-align-justify>另外一个是支付交易系统，这个场景下也是有两个应用，他们都是在同一Group和同一Topic下，一个是消费Tag1的数据，另一个是消费Tag2的数据。在正常情况下，启动应该是没问题的，但是有一天我们发现其中一个应用无法启动。而另外一个应用只消费Tag2的数据，由于RocketMQ的机制会把Tag1的数据拿过来，拿过来之后会把Tag1的数据丢弃，这将导致用户在支付的过程中出现支付失败的情况。</p><p class=ql-align-justify><strong>对此，我们把Tag2放到Group2里面，两个Group就不会消费相同的消息了。个人建议RocketMQ能够实现一个机制，即只接受自己的Tag消息，不接受非相关的Tag。</strong></p><div class=pgc-img><img alt=同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/22e14b67d25342b795f62f71bea55032><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><p><strong>大量老数据读取的场景</strong></p><p>在火车票消费的场景中，我们发现有200亿条老数据没有被消费。当我们消费启动的时候，RocketMQ会默认从第0个数据开始读，这时候磁盘IO飙升到100%，从而影响到其他消费端数据的读取，但这些老数据被加载后后，并没有实际作用。因此，对于大量老数据读取的改进方式是：</p><p><strong>对于新消费组，默认从LAST_OFFSET消费；</strong></p><p><strong>Broker中单Topic堆积超过1000万时，禁止消费，需联系管理员开启消费；</strong></p><p><strong>监控要到位，磁盘IO飙升时，能立刻联系到消费方处理；</strong></p><p><strong>服务端的场景</strong></p><p>CentOS 6.6中 Futex Kernel bug, 导致Name Server, Broker进程经常挂起，无法正常工作；</p><p><strong>- > 升级到6.7</strong></p><p>服务端2个线程会创建相同CommitLog放入List，导致计算消息offset错误，解析消息失败，无法消费，重启没法解决问题。</p><p><strong>- > 线程安全问题，改为单线程</strong></p><p>Pull模式下重置消费进度，导致服务端填充大量数据到Map中，broker cpu使用率飙升100%。</p><p><strong>- > Map局部变量场景用不到，删除</strong></p><p>Master建议客户端到Slave消费时，若数据还没同步到Slave, 会重置pullOffset, 导致大量重复消费。</p><p><strong>- ></strong> <strong>不重置offset</strong></p><p>同步没有MagicCode，安全组扫描同步端口时，Master解析错误，导致一些问题。</p><p><strong>- > 同步时添加magicCode校验</strong></p><p>4 基于RocketMQ，我们做了哪些改进</p><p><strong>新增客户端</strong></p><p>新增.net客户端，基于Java源代码原生开发；</p><p>新增HTTP客户端，实现部分功能，并通过Netty Server连接RocketMQ；</p><div class=pgc-img><img alt=同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/06491bb8e2d541709910c3f17b6c4600><p class=pgc-img-caption></p></div><p><strong>新增消息限流功能</strong></p><p>如果客户端代码写错产生死循环，会产生大量的重复数据，这时会把生产线程打满，导致队列溢出，严重影响我们MQ集群的稳定性，从而影响其他业务。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=同程艺龙：如何基于RocketMQ打造日均容量1500亿的消息引擎？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c22bfde667db43cfbdca7f2dd43e7266><p class=pgc-img-caption></p></div><p class=ql-align-justify>上图是限流的模型图。我们把限流功能加在Topic之前，通过限流功能可以设置rate limit和size limit等。其中rate limit是通过令牌桶算法来实现的，即每秒往桶里放多少个令牌，每秒就消费多少速度，或者是往Topic里写多少数据。以上的两个配置是支持动态修改的。</p><p><strong>后台监控</strong></p><p>我们还做了一个监控后台，用于监控消息的全链路过程，包括</p><p>o 消息全链路追踪，覆盖消息产生、消费、过期整个生命周期；</p><p>o 消息生产、消费曲线；</p><p>o 消息生产异常报警；</p><p>o 消息堆积报警，通知哪个IP消费过慢；</p><p><strong>其他功能</strong></p><p>o HTTP方式生产，消费消息；</p><p>o Topic消费权限设置，Topic只能被指定Group消费，防止线上错乱订阅；</p><p>o 支持新消费组从最新位置消费 (默认是从第一条开始消费)；</p><p>o 广播模式消费进度同步 (服务端显示进度)；</p><p class=ql-align-center><br></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'同程','艺龙','RocketMQ'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>