<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Qt编写数据可视化大屏界面电子看板12-数据库采集 | 极客快訊</title><meta property="og:title" content="Qt编写数据可视化大屏界面电子看板12-数据库采集 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/53f34eea12064020a881f5a7ebbc2b81"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/eacb57fb.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/eacb57fb.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/eacb57fb.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/eacb57fb.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/eacb57fb.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/eacb57fb.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/eacb57fb.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/eacb57fb.html><meta property="article:published_time" content="2020-10-29T21:09:58+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:58+08:00"><meta name=Keywords content><meta name=description content="Qt编写数据可视化大屏界面电子看板12-数据库采集"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/eacb57fb.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Qt编写数据可视化大屏界面电子看板12-数据库采集</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>一、前言</h1><p>数据采集是整个数据可视化大屏界面电子看板系统核心功能，没有数据源，这仅仅是个玩具UI，没啥用，当然默认做了定时器模拟数据，产生随机数据，这个可以直接配置文件修改来选择采用何种数据采集方法，总结了一下基本上会有这样几种数据源，timer-模拟数据 db-数据库采集 tcp-网络采集 http-post请求，大量的web会选择采用http作为post网络请求来获取数据，而对于本人来说，更喜欢用数据库作为数据源，这样可以避免很多扯皮的事情，比如请求出错或者得到错误的数据等，而数据库是死的，不涉及到其他任何程序的干扰，也不需要做任何对接，只要规范好数据库表和字段即可。</p><p>本系统默认采用mysql数据库，当然也支持其他数据，甚至包括了sqlite这种小众的数据库，Qt对数据库的封装也是非常完美的，反正在我使用的这些年过程中，没有发现过什么BUG或者事故，Qt提供了一个统一的数据库接口，这对于程序员来说是巨大的福音，比如查询数据库，QSqlQuery查询的结果，统一用query.value(i)或者，这个数据是通用类型，可以转换成你想要的数据类型，这样就拓展性和兼容性非常强大了。</p><p>在本系统中，各个模块的采集间隔都可以自由定义，默认5秒钟采集一次，我采用的办法是，开启一个线程，在线程中打开数据，然后提供方法插入要执行的sql语句，插入的同时记得给定标识符，以便返回结果的时候标识，这样就形成了一个万能的方法，自动排队，也不会说冲突之类的，一个类管理所有的数据库采集，文字末尾会贴出完整代码。</p><h1>二、电子看板介绍</h1><p>电子看板是目视化管理的一种表现形式，即对数据的状况一目了然地表现，主要是对于管理项目，它通过利用形象直观而又色彩适宜的各种视觉感知信息来组织现场生产活动，目视管理依据人类的生理特征，在生产现场充分利用信号灯、标识牌、符号颜色等方式来发出视觉信号，鲜明准确地刺激人的神经末梢，快速地传递信息，形象直观地将潜在的问题和浪费现象都显现出来。以便任何人都可以及时掌握管理现状和必要的情报，从而能够快速制定并实施应对措施。因此，管理看板是发现问题、解决问题的非常有效且直观的手段，是优秀的现场管理必不可少的工具之一。</p><h1>三、功能特点</h1><p>1. 整体总共分三级界面，一级界面是整体布局，二级界面是单个功能模块，三级界面是单个控件。</p><p>2. 子控件包括饼图+圆环图+曲线图+柱状图+柱状分组图+横向柱状图+横向柱状分组图+合格率控件+百分比控件+进度控件+设备状态面板+表格数据+地图控件(包括动态闪烁点+迁徙图等)+视频控件+其他控件等。</p><p>3. 二级界面可以自由拖动悬浮，支持最小化最大化关闭，响应双击自定义标题栏。</p><p>4. 数据源支持数据库采集（默认）、网络通信、网络请求等，可自由设定每个子界面的采集间隔即数据刷新频率。</p><p>5. 采用纯QWidget编写，支持Qt4.6到Qt5.12.3任何版本，支持嵌入式linux比如树莓派、香橙派、全志、imx6等。</p><p>6. 提供三个内核版本，自定义控件版本+qchart版本+echart版本。</p><p>7. 内置多套配色风格样式，默认紫色，支持任何分辨率。</p><p>8. 可设置标题+目标分辨率+布局方案，启动立即应用。</p><p>9. 可设置主背景颜色+面板颜色+十字线游标颜色。</p><p>10. 可设置多条曲线颜色，没有设置颜色的情况下内置15套精美颜色随机应用。</p><p>11. 可设置标题栏背景颜色+文字颜色。</p><p>12. 可设置曲线图表背景颜色+文字颜色+网格颜色。</p><p>13. 可设置正常颜色+警戒颜色+报警颜色+禁用颜色+百分比进度颜色。</p><p>14. 可分别设置各种字体大小，比如全局+软件名称+标题栏+子标题栏+加粗标签等。</p><p>15. 可设置标题栏高度+表头高度+行高度。</p><p>16. 曲线支持游标+悬停高亮数据点和显示值，柱状图支持顶部（可设置顶端+上部+中间+底部）显示数据，全部自适应计算位置。</p><p>17. 主界面直接鼠标右键切换布局+配色方案+关闭开启某个二级窗体。</p><p>18. 自动记忆所有子窗口的大小和位置，下次启动立即应用。</p><p>19. 动态加载布局方案菜单，可以动态新建布局、恢复布局、保存布局、另存布局等，用户可以制造任意布局。</p><p>20. 二级窗体，双击从主窗体分离出来浮动，可以自由调整大小。再次双击标题栏最大化，再次双击还原。</p><p>21. 每个模块都可以自定义采集速度，如果是数据库采集会自动排队处理。</p><h1>五、特别说明</h1><p>1. 可执行文件同级文件夹有layout+layout_1440+layout_1920，程序默认自动识别分辨率并加载对应的布局文件夹，比如1920分辨率则从layout_1920文件夹加载布局，并作为整体布局文件夹。</p><p>2. 程序默认是模拟数据，如果需要从数据库采集则修改配置文件WorkMode=db即可。</p><p>3. 如果发现布局拖动乱了，可以直接鼠标右键选择恢复布局即可，在保存布局以前。</p><p>4. 在中间地图模块鼠标右键可以弹出菜单，切换布局和配色方案等。</p><p>5. 在模块的标题栏上右键可以弹出默认的dock菜单，用来显示和隐藏各模块。</p><p>6. 软件关闭过程中会自动保存布局，下次启动以后自动应用。</p><p>7. 如果使用的默认的默认的配色方案比如紫色风格，则配置文件中的颜色全部无效，会自动应用代码中的颜色，如果需要启用自定义的颜色，则将配置文件的 Theme=81ea5b9a4e4998ce683c 即可。此时打开软件会应用配置文件中的颜色。</p><p>8. 右键菜单可以截图保存，默认命名为 配色方案名称_布局方案名称.png 保存在snap目录下。</p><p>9. 如果是XP系统请先执行fixff.cmd，用来修复ffmpeg在XP上不可用的BUG。</p><p>10. 在二级窗体的标题栏上右键弹出模块菜单，可以对单个模块打开关闭，其他地方右键全局菜单。</p><p>11. 会不定期更新程序，欢迎各位提出批评和建议。</p><h1>六、效果图</h1><div class=pgc-img><img alt=Qt编写数据可视化大屏界面电子看板12-数据库采集 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/53f34eea12064020a881f5a7ebbc2b81><p class=pgc-img-caption></p></div><h1>七、核心代码</h1><pre>#include "datadb.h"#include "quiwidget.h"QScopedPointer&lt;DataDb&gt; DataDb::self;DataDb *DataDb::Instance(){ if (self.isNull()) { static QMutex mutex; QMutexLocker locker(&amp;mutex); if (self.isNull()) { self.reset(new DataDb); } } return self.data();}DataDb::DataDb(QObject *parent) : QThread(parent){ stopped = false; dbOkLocal = false; errorCount = 0; lastCheckTimeLocal = QDateTime::currentDateTime(); checkConn = false; checkInterval = 30; dbTypeLocal = DbType_MySql; connNameLocal = "qt_sql_default_connection"; hostNameLocal = "127.0.0.1"; portLocal = 3306; dbNameLocal = "db_mysql"; userNameLocal = "root"; userPwdLocal = "root"; connect(this, SIGNAL(error(QString)), this, SLOT(doError(QString)));}DataDb::~DataDb(){ this-&gt;stop(); this-&gt;wait();}void DataDb::run(){ //打开数据库 openDb(); msleep(1000); while(!stopped) { //定时执行一次校验数据库连接是否正常 QDateTime now = QDateTime::currentDateTime(); if (checkConn &amp;&amp; lastCheckTimeLocal.secsTo(now) &gt;= checkInterval) { checkDb(); lastCheckTimeLocal = now; continue; } //如果数据库连接正常则处理数据,不正常则重连数据库 if (!dbOkLocal) { if (errorCount &gt;= 3) { closeDb(); msleep(3000); openDb(); emit debug(QString("重连本地数据库%1").arg(dbOkLocal ? "成功" : "失败")); msleep(3000); } } else { //取出队列sql语句执行 if (tags.count() &gt; 0) { //从最前面开始取 QMutexLocker locker(&amp;mutex); QString tag = tags.takeFirst(); QString sql = sqls.takeFirst(); //qDebug() &lt;&lt; TIMEMS &lt;&lt; tag &lt;&lt; sql; QSqlQuery query(dbConnLocal); if (query.exec(sql)) { QStringList data; while(query.next()) { int count = query.record().count(); for (int i = 0; i &lt; count; i++) { data &lt;&lt; query.value(i).toString(); } } emit receiveData(tag, data); } } msleep(10); } } stopped = false;}void DataDb::doError(const QString &amp;msg){ QUIHelper::showMessageBoxError(msg, 3);}bool DataDb::openDb(){ //可以自行增加其他数据库的支持 if (dbTypeLocal == DbType_Sqlite) { dbConnLocal = QSqlDatabase::addDatabase("QSQLITE", connNameLocal); dbConnLocal.setDatabaseName(dbNameLocal); } else if (dbTypeLocal == DbType_MySql) { dbConnLocal = QSqlDatabase::addDatabase("QMYSQL", connNameLocal); dbConnLocal.setConnectOptions("MYSQL_OPT_RECONNECT=1;MYSQL_OPT_CONNECT_TIMEOUT=1;MYSQL_OPT_READ_TIMEOUT=1;MYSQL_OPT_WRITE_TIMEOUT=1"); dbConnLocal.setHostName(hostNameLocal); dbConnLocal.setPort(portLocal); dbConnLocal.setDatabaseName(dbNameLocal); dbConnLocal.setUserName(userNameLocal); dbConnLocal.setPassword(userPwdLocal); } errorCount = 0; dbOkLocal = dbConnLocal.open(); if (!dbOkLocal) { emit error("打开数据库失败!请检查用户名和密码是否正确!"); } return dbOkLocal;}bool DataDb::checkDb(){ QDateTime dtStart = QDateTime::currentDateTime(); QString sql = "select 1"; QSqlQuery query(dbConnLocal); dbOkLocal = query.exec(sql); dbOkLocal ? (errorCount = 0) : errorCount++; QDateTime dtEnd = QDateTime::currentDateTime(); double ms = dtStart.msecsTo(dtEnd); emit debug(QString("检查本地数据库连接(共 %1 条/用时 %2 秒)").arg(1).arg(QString::number(ms / 1000, 'f', 3))); return dbOkLocal;}void DataDb::closeDb(){ dbConnLocal.close(); QSqlDatabase::removeDatabase(connNameLocal); dbOkLocal = false; emit debug("关闭本地数据库");}void DataDb::stop(){ stopped = true;}void DataDb::setConnInfo(DataDb::DbType dbType, const QString &amp;connName, const QString &amp;hostName, int port, const QString &amp;dbName, const QString &amp;userName, const QString &amp;userPwd){ this-&gt;dbTypeLocal = dbType; this-&gt;connNameLocal = connName; this-&gt;hostNameLocal = hostName; this-&gt;portLocal = port; this-&gt;dbNameLocal = dbName; this-&gt;userNameLocal = userName; this-&gt;userPwdLocal = userPwd;}void DataDb::setCheckConn(bool checkConn){ this-&gt;checkConn = checkConn;}void DataDb::setCheckInterval(int checkInterval){ if (checkInterval &gt; 5 &amp;&amp; this-&gt;checkInterval != checkInterval) { this-&gt;checkInterval = checkInterval; }}QSqlDatabase DataDb::getDb(){ return dbConnLocal;}bool DataDb::getOk(){ return dbOkLocal;}void DataDb::select(const QString &amp;tableName, const QString &amp;columnName, bool append){ //超过队列中最大数量限制则无需处理 QMutexLocker locker(&amp;mutex); if (tags.count() &lt; 100) { //如果是append表示追加在队列末尾,否则插到最前面优先级最高 if (append) { tags &lt;&lt; tableName; sqls &lt;&lt; QString("select %1 from %2").arg(columnName).arg(tableName); } else { tags.insert(0, tableName); sqls.insert(0, QString("select %1 from %2").arg(columnName).arg(tableName)); } }}</pre></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'看板','Qt','编写'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>