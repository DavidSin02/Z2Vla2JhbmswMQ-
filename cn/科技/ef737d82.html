<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>基于时序数据库做监控，这里有超流行的开源方案 | 极客快訊</title><meta property="og:title" content="基于时序数据库做监控，这里有超流行的开源方案 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/RcHNVefHoUVLac"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ef737d82.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ef737d82.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ef737d82.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ef737d82.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ef737d82.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ef737d82.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ef737d82.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ef737d82.html><meta property="article:published_time" content="2020-11-14T21:04:01+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:01+08:00"><meta name=Keywords content><meta name=description content="基于时序数据库做监控，这里有超流行的开源方案"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/ef737d82.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>基于时序数据库做监控，这里有超流行的开源方案</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>在微服务架构下，我们对服务进行了拆分，所以用户的每次请求不再是由某一个服务独立完成了，而是变成了多个服务一起配合完成。这种情况下，一旦请求出现异常，我们必须得知道是在哪个服务环节出了故障，就需要对每一个服务，以及各个指标都进行全面的监控。</p><p><strong>一、什么是「 监控系统 」？</strong></p><p>在微服务架构中，监控系统按照原理和作用大致可以分为三类（并非严格分类，仅从日常使用角度来看）：</p><ul><li><p>日志类（Log）；</p></li><li><p>调用链类（Tracing）；</p></li><li><p>度量类（Metrics）。</p></li></ul><p>下面来分别对这三种常见的监控模式进行说明。</p><p>1、日志类</p><p>日志类比较常见，我们的框架代码、系统环境，以及业务逻辑中一般都会产出一些日志，这些日志我们通常把它记录后统一收集起来，方便在需要的时候进行查询。</p><p>日志类记录的信息一般是一些事件、非结构化的一些文本内容。日志的输出和处理的解决方案比较多，大家熟知的有ELK Stack方案（Elasticseach + Logstash + Kibana），如图：</p><img alt=基于时序数据库做监控，这里有超流行的开源方案 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/RcHNVefHoUVLac><p>使用Beats（可选）在每台服务器上安装后，作为日志客户端收集器，然后通过Logstash进行统一的日志收集、解析、过滤等处理，再将数据发送给Elasticsearch中进行存储分析，最后使用Kibana来进行数据的展示。</p><p>当然还可以升级方案为：</p><img alt=基于时序数据库做监控，这里有超流行的开源方案 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RcHNVjCImRTCHr><p>这些方案都比较成熟，搭建起来也比较简单，除了用作监控系统以外，还可以作为日志查询系统使用，非常适用于做分析、以及问题调试使用。</p><p>2、调用链类（Tracing）</p><p>调用链类监控主要是指记录一个请求的全部流程。一个请求从开始进入，在微服务中调用不同的服务节点后，再返回给客户端，在这个过程中通过调用链参数来追寻全链路行为。通过这个方式可以很方便的知道请求在哪个环节出了故障，系统的瓶颈在哪儿。</p><p>这一类的监控一般采用CAT工具 来完成，一般在大中型项目较多用到，因为搭建起来有一定的成本。后面会有单独文章来讲解这个调用链监控系统。</p><p>这也是简单的容错方式。就是指在服务之间调用时，设置一个主动超时时间，超过了这个时间阈值后，如果“被依赖的服务”还没有返回数据的话，“调用者”就主动放弃，防止因“被依赖的服务”的故障所影响。</p><p>3、度量类（Metrics）</p><p>度量类主要采用时序数据库的解决方案。它是以事件发生时间以及当前数值的角度来记录的监控信息，是可以聚合运算的，用于查看一些指标数据和指标趋势。所以这类监控主要不是用来查问题的，主要是用来看趋势的。</p><p>Metrics一般有5种基本的度量类型：</p><ul><li><p>Gauges（度量）；</p></li><li><p>Counters（计数器）；</p></li><li><p>Histograms（直方图）；</p></li><li><p>Meters（TPS计算器）；</p></li><li><p>Timers（计时器）。</p></li></ul><p>基于时间序列数据库的监控系统是非常适合做监控告警使用的，所以现在也比较流行这个方案，如果我们要搭建一套新的监控系统，我也建议参考这类方案进行。</p><p>因此本文接下来也会重点以时间序列数据库的监控系统为主角来描述。</p><p><strong>二、「 监控系统 」<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">关注</i>的对象和指标都是什么？</strong></p><p>一般我们做「监控系统」都是需要做分层式监控的，也就是说将我们要监控的对象进行分层，一般主要分为：</p><ul><li><p>系统层：系统层主要是指CPU、磁盘、内存、网络等服务器层面的监控，这些一般也是运维同学比较<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">关注</i>的对象；</p></li><li><p>应用层：应用层指的是服务角度的监控，比如接口、框架、某个服务的健康状态等，一般是服务开发或框架开发人员<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">关注</i>的对象；</p></li><li><p>用户层：这一层主要是与用户、与业务相关的一些监控，属于功能层面的，大多数是项目经理或产品经理会比较<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">关注</i>的对象。</p></li></ul><p>知道了监控的分层后，我们再来看一下监控的指标一般有哪些：</p><ul><li><p>延迟时间：主要是响应一个请求所消耗的延迟，比如某接口的<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-3">HTTP</i>请求平均响应时间为100ms；</p></li><li><p>请求量：是指系统的容量吞吐能力，例如每秒处理多少次请求（QPS）作为指标；</p></li><li><p>错误率：主要是用来监控错误发生的比例，比如将某接口一段时间内调用时失败的比例作为指标。</p></li></ul><p><strong>三、基于时序数据库的「 监控系统 」有哪些？</strong></p><p>下面介绍几款目前业内比较流行的基于时间序列数据库的开源监控方案。</p><p>1、Prometheus</p><p>Promethes是一款2012年开源的监控框架，其本质是时间序列数据库，由Google前员工所开发。</p><p>Promethes采用拉的模式（Pull）从应用中拉取数据，并还支持Alert模块可以实现监控预警。它的性能非常强劲，单机可以消费百万级时间序列。</p><p>架构如下：</p><img alt=基于时序数据库做监控，这里有超流行的开源方案 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RcHNVlb8V2rfqc><p>从看图的左下角可以看到，Prometheus可以通过在应用里进行埋点后Pull到Prometheus Server里，如果应用不支持埋点，也可以采用exporter方式进行数据采集。</p><p>从图的左上角可以看到，对于一些定时任务模块，因为是周期性运行的，所以采用拉的方式无法获取数据，那么Prometheus也提供了一种推数据的方式，但是并不是推送到Prometheus Server中，而是中间搭建一个Pushgateway，定时任务模块将metrics信息推送到这个Pushgateway中，然后Prometheus Server再依然采用拉的方式从Pushgateway中获取数据。</p><p>需要拉取的数据既可以采用静态方式配置在Prometheus Server中，也可以采用服务发现的方式（即图的中上方Service discovery所示）。</p><p>PromQL：是Prometheus自带的查询语法，通过编写PromQL语句可以查询Prometheus里面的数据。</p><p>Alertmanager：是用于数据的预警模块，支持通过多种方式去发送预警。</p><p>WebUI：是用来展示数据和图形的，但是一般大多数是与Grafana结合，采用Grafana来展示。</p><p>2、OpenTSDB</p><p>OpenTSDB是在2010年开源的一款分布式时序数据库，当然其主要用于监控方案中。</p><p>OpenTSDB采用的是HBase的分布式存储，它获取数据的模式与Prometheus不同，采用的是推模式（Push）。</p><p>在展示层，OpenTSDB自带有WebUI视图，也可以与Grafana很好的集成，提供丰富的展示界面。</p><p>但OpenTSDB并没有自带预警模块，需要自己去开发或者与第三方组件结合使用。</p><p>可以通过下图来了解一下OpenTSDB的架构：</p><img alt=基于时序数据库做监控，这里有超流行的开源方案 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RcHNVlp6wN71Tt><p>3、InfluxDB</p><p>InfluxDB是在2013年开源的一款时序数据库，在这里我们主要还是用于做监控系统方案。它收集数据也是采用推模式（Push）。在展示层，InfluxDB也是自带WebUI，也可以与Grafana集成。</p><img alt=基于时序数据库做监控，这里有超流行的开源方案 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RcHNVm11kZ8SNS><p>以上，就是我对微服务架构中「 监控系统」的一些思考。</p><p>作者丨奎哥</p><p>来源丨不止思考（ID：bzsikao）</p><p>dbaplus社群欢迎广大技术人员投稿，投稿邮箱：editor@dbaplus.cn</p><p></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'时序','数据库','监控'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>