<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>æ··æ²Œå·¥ç¨‹å®è·µï¼šä½¿ç”¨ SMI å’Œ Linkerd è¿›è¡Œæ•…éšœæ³¨å…¥ | æå®¢å¿«è¨Š</title><meta property="og:title" content="æ··æ²Œå·¥ç¨‹å®è·µï¼šä½¿ç”¨ SMI å’Œ Linkerd è¿›è¡Œæ•…éšœæ³¨å…¥ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/175d026350cb4ac28385fb8d3ecc0c24"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f188ec7.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f188ec7.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f188ec7.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f188ec7.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f188ec7.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f188ec7.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f188ec7.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f188ec7.html><meta property="article:published_time" content="2020-10-29T20:52:47+08:00"><meta property="article:modified_time" content="2020-10-29T20:52:47+08:00"><meta name=Keywords content><meta name=description content="æ··æ²Œå·¥ç¨‹å®è·µï¼šä½¿ç”¨ SMI å’Œ Linkerd è¿›è¡Œæ•…éšœæ³¨å…¥"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/f188ec7.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>æ··æ²Œå·¥ç¨‹å®è·µï¼šä½¿ç”¨ SMI å’Œ Linkerd è¿›è¡Œæ•…éšœæ³¨å…¥</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p>åº”ç”¨ç¨‹åºæ•…éšœæ³¨å…¥æ˜¯æ··æ²Œå·¥ç¨‹çš„ä¸€ç§å½¢å¼ï¼Œåœ¨å¾®æœåŠ¡åº”ç”¨ç¨‹åºä¸­äººä¸ºåœ°å¢åŠ æŸäº›æœåŠ¡çš„é”™è¯¯ç‡ï¼Œä»¥æŸ¥çœ‹å®ƒå¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“ã€‚ä¼ ç»Ÿä¸Šï¼Œéœ€è¦åœ¨æœåŠ¡ä»£ç ä¸­æ·»åŠ æŸç§ç±»å‹çš„æ•…éšœæ³¨å…¥åº“ï¼Œæ‰èƒ½å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œæ•…éšœæ³¨å…¥ï¼Œå€¼å¾—åº†å¹¸çš„æ˜¯ï¼ŒæœåŠ¡ç½‘æ ¼æä¾›äº†ä¸€ç§æ— éœ€ä¿®æ”¹æˆ–é‡æ„æœåŠ¡çš„åº”ç”¨ç¨‹åºæ•…éšœæ³¨å…¥æ–¹æ³•ã€‚</p><div class=pgc-img><img alt="æ··æ²Œå·¥ç¨‹å®è·µï¼šä½¿ç”¨ SMI å’Œ Linkerd è¿›è¡Œæ•…éšœæ³¨å…¥" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/175d026350cb4ac28385fb8d3ecc0c24><p class=pgc-img-caption></p></div><p class=ql-align-justify>ç»“æ„è‰¯å¥½çš„å¾®æœåŠ¡åº”ç”¨ç¨‹åºæœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œå®ƒå¯ä»¥ä¼˜é›…åœ°å®¹å¿å•ç‚¹æœåŠ¡æ•…éšœã€‚å½“è¿™äº›æ•…éšœä»¥æœåŠ¡å´©æºƒçš„å½¢å¼å‡ºç°æ—¶ï¼ŒKubernetes åœ¨ä¿®å¤æœåŠ¡å´©æºƒæ•…éšœæ–¹é¢åšçš„éå¸¸å¥½ï¼Œå®ƒå¯ä»¥é€šè¿‡åˆ›å»ºæ–°çš„ Pods æ›¿æ¢å´©æºƒçš„ Pods çš„æ–¹å¼æ¥ä¿®å¤è¿™äº›æ•…éšœã€‚ç„¶è€Œï¼Œæ•…éšœä¹Ÿå¯èƒ½æ›´åŠ å¾®å¦™ï¼Œå¦‚å¯¼è‡´æœåŠ¡è¿”å›çš„é”™è¯¯ç‡å‡é«˜ã€‚å¯¹äºè¿™ç§ç±»å‹çš„æ•…éšœï¼ŒKubernetes å°±ä¸èƒ½è‡ªåŠ¨ä¿®å¤äº†ï¼Œä»ç„¶ä¼šå¯¼è‡´éƒ¨åˆ†åŠŸèƒ½ä¸§å¤±ã€‚</p><p class=ql-align-justify><strong>ä½¿ç”¨æµé‡åˆ†å‰² SMI API æ³¨å…¥é”™è¯¯</strong></p><p class=ql-align-justify>ä½¿ç”¨æœåŠ¡ç½‘æ ¼æ¥å£ï¼ˆService Mesh Interfaceï¼ŒSMIï¼‰çš„æµé‡åˆ†å‰² APIï¼ˆTraffic Split APIï¼‰å¯ä»¥è½»æ¾å®ç°åº”ç”¨ç¨‹åºæ•…éšœæ³¨å…¥ã€‚è¿™æ˜¯ä¸€ç§ä¸å®ç°æ— å…³ä¸”è·¨æœåŠ¡ç½‘æ ¼çš„æ•…éšœæ³¨å…¥æ–¹å¼ã€‚</p><p class=ql-align-justify>ä¸ºäº†å®ç°è¿™ç§å½¢å¼çš„æ•…éšœæ³¨å…¥ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ªåªè¿”å›é”™è¯¯çš„æ–°æœåŠ¡ã€‚å®ƒæ—¢å¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„æœåŠ¡ï¼Œæ¯”å¦‚ä¸€ä¸ªé…ç½®æˆè¿”å› HTTP 500 çš„ NGINX æœåŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„æœåŠ¡ï¼Œè¿”å›æˆ‘ä»¬ä¸ºäº†æµ‹è¯•æŸäº›æ¡ä»¶è€Œä¸“é—¨è®¾è®¡çš„é”™è¯¯ã€‚å…¶æ¬¡ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµé‡åˆ†å‰²èµ„æºï¼Œç”¨è¯¥èµ„æºæ¥æŒ‡å¯¼æœåŠ¡ç½‘æ ¼å°†ç›®æ ‡æœåŠ¡æµé‡æŒ‰ç…§ç™¾åˆ†æ¯”å‘é€åˆ°é”™è¯¯æœåŠ¡ä¸Šã€‚ä¾‹å¦‚ï¼Œé€šè¿‡å°† 10ï¼…çš„æœåŠ¡æµé‡å‘é€åˆ°é”™è¯¯æœåŠ¡ä¸Šï¼Œæ¥äººä¸ºåœ°å®ç°å‘è¯¥æœåŠ¡æ³¨å…¥ 10ï¼…çš„é”™è¯¯ç‡ã€‚</p><p class=ql-align-justify>æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸ªä½¿ç”¨ Linkerd ä½œä¸ºæœåŠ¡ç½‘æ ¼å®ç°çš„ç¤ºä¾‹ã€‚</p><p class=ql-align-justify>ç¤ºä¾‹</p><p class=ql-align-justify>é¦–å…ˆï¼Œæˆ‘ä»¬å®‰è£… Linkerd CLIï¼Œå¹¶å°†å®ƒéƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ä¸Šï¼š</p><pre class=ql-align-justify>&gt; curl https://run.linkerd.io/install | sh&gt; export PATH=$PATH:$HOME/.linkerd2/bin&gt; linkerd install | kubectl apply -f -&gt; linkerd check</pre><p class=ql-align-justify>ç„¶åï¼Œæˆ‘ä»¬å®‰è£…ä¸€ä¸ªâ€œbooksappâ€ç¤ºä¾‹åº”ç”¨ç¨‹åºï¼š</p><pre class=ql-align-justify>&gt; linkerd inject https://run.linkerd.io/booksapp.yml | kubectl apply -f -</pre><p class=ql-align-justify>è¯¥åº”ç”¨ç¨‹åºçš„æŸä¸ªæœåŠ¡å·²ç»é…ç½®äº†é”™è¯¯ç‡ï¼Œä½†è¿™ä¸ªç¤ºä¾‹æ˜¯ä¸ºäº†è¯´æ˜ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»»ä½•æ”¯æŒä¹Ÿå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­æ³¨å…¥é”™è¯¯ï¼Œæ‰€ä»¥ï¼Œéœ€è¦åˆ é™¤åº”ç”¨ç¨‹åºä¸­é…ç½®çš„é”™è¯¯ç‡ï¼š</p><pre class=ql-align-justify>&gt; kubectl edit deploy/authors# Find and remove these lines:# - name: FAILURE_RATE# value: "0.5"</pre><p class=ql-align-justify>æˆ‘ä»¬çœ‹åˆ°åº”ç”¨ç¨‹åºå¯ä»¥æ­£å¸¸è¿è¡Œäº†ï¼š</p><pre class=ql-align-justify>&gt; linkerd stat deployNAME MESHED SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99 TCP_CONNauthors 1/1 100.00% 6.6rps 3ms 58ms 92ms 6books 1/1 100.00% 8.0rps 4ms 81ms 119ms 6traffic 1/1 - - - - - -webapp 3/3 100.00% 7.7rps 24ms 91ms 117ms 9</pre><p class=ql-align-justify>ç°åœ¨ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé”™è¯¯æœåŠ¡ã€‚åœ¨æ­¤ï¼Œæˆ‘ä½¿ç”¨é…ç½®æˆè¿”å› HTTP 500 çŠ¶æ€ä»£ç çš„ NGINXï¼Œåˆ›å»ºä¸€ä¸ªåä¸º error-injector.yaml çš„æ–‡ä»¶ï¼š</p><pre class=ql-align-justify>apiVersion: apps/v1kind: Deploymentmetadata: name: error-injector labels: app: error-injectorspec: selector: matchLabels: app: error-injector replicas: 1 template: metadata: labels: app: error-injector spec: containers: - name: nginx image: nginx:alpine ports: - containerPort: 80 name: nginx protocol: TCP volumeMounts: - name: nginx-config mountPath: /etc/nginx/nginx.conf subPath: nginx.conf volumes: - name: nginx-config configMap: name: error-injector-config---apiVersion: v1kind: Servicemetadata: labels: app: error-injector name: error-injectorspec: clusterIP: None ports: - name: service port: 7002 protocol: TCP targetPort: nginx selector: app: error-injector type: ClusterIP---apiVersion: v1data: nginx.conf: |2  events { worker_connections 1024; }  http { server { location / { return 500; } } }kind: ConfigMapmetadata: name: error-injector-config</pre><p class=ql-align-justify>éƒ¨ç½² error-injector.yaml æ–‡ä»¶ ï¼š</p><pre class=ql-align-justify>&gt; kubectl apply -f error-injector.yaml</pre><p class=ql-align-justify>ç°åœ¨ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµé‡åˆ†å‰²èµ„æºï¼Œå®ƒä¼šå°† 10ï¼…çš„æµé‡ä»â€œbooksâ€æœåŠ¡é‡å®šå‘åˆ°â€œerror-injectorâ€é”™è¯¯æœåŠ¡ã€‚è¯¥èµ„æºæ–‡ä»¶å‘½åä¸º error-split.yamlï¼š</p><pre class=ql-align-justify>apiVersion: split.smi-spec.io/v1alpha1kind: TrafficSplitmetadata: name: error-splitspec: service: books backends: - service: books weight: 900m - service: error-injector weight: 100m</pre><p class=ql-align-justify>éƒ¨ç½² error-split.yaml æ–‡ä»¶ï¼š</p><pre class=ql-align-justify>&gt; kubectl apply -f error-split.yaml</pre><p class=ql-align-justify>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä» webapp åˆ° books çš„è°ƒç”¨é”™è¯¯ç‡ä¸º 10ï¼…ï¼š</p><pre class=ql-align-justify>&gt; linkerd routes deploy/webapp --to service/booksROUTE SERVICE SUCCESS RPS LATENCY_P50 LATENCY_P95 LATENCY_P99[DEFAULT] books 90.66% 6.6rps 5ms 80ms 96ms</pre><p class=ql-align-justify>æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•ä¼˜é›…åœ°å¤„ç†è¿™äº›æ•…éšœï¼š</p><pre class=ql-align-justify>&gt; kubectl port-forward deploy/webapp 7000 &amp;&gt; open http://localhost:7000</pre><p class=ql-align-justify>å¦‚æœå¤šåˆ·å‡ æ¬¡é¡µé¢ï¼Œæˆ‘ä»¬æœ‰æ—¶ä¼šçœ‹åˆ°å†…éƒ¨æœåŠ¡é”™è¯¯é¡µé¢ã€‚</p><div class=pgc-img><img alt="æ··æ²Œå·¥ç¨‹å®è·µï¼šä½¿ç”¨ SMI å’Œ Linkerd è¿›è¡Œæ•…éšœæ³¨å…¥" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c854ee9718ed4131904d9a7836f377e4><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>å…³äºåº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•å¤„ç†æœåŠ¡é”™è¯¯çš„ï¼Œæˆ‘ä»¬å·²ç»å­¦åˆ°äº†ä¸€äº›æœ‰ä»·å€¼çš„ä¸œè¥¿ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬é€šè¿‡ç®€å•çš„åˆ é™¤æµé‡åˆ†å‰²èµ„æºï¼Œæ¥æ¢å¤æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼š</p><pre class=ql-align-justify>&gt; kubectl delete trafficsplit/error-split</pre><p class=ql-align-justify><strong>ç»“è®º</strong></p><p class=ql-align-justify>åœ¨æœ¬æ–‡ä¸­ï¼Œé€šè¿‡ä½¿ç”¨ SMI APIï¼ˆç”± Linkerd æä¾›æ”¯æŒï¼‰åŠ¨æ€åœ°å°†ä¸€éƒ¨åˆ†æµé‡é‡å®šå‘åˆ°ç®€å•çš„â€œå§‹ç»ˆå¤±è´¥â€çš„ç›®æ ‡æœåŠ¡ï¼Œæˆ‘ä»¬æ¼”ç¤ºäº†ä¸€ç§åœ¨æœåŠ¡çº§åˆ«å¿«é€Ÿç®€ä¾¿åœ°è¿›è¡Œæ•…éšœæ³¨å…¥çš„æ–¹å¼ã€‚è¿™ç§æ–¹å¼çš„ä¼˜åŠ¿åœ¨äºï¼Œæˆ‘ä»¬ä»…é€šè¿‡ SMI API å°±å¯å®ç°æ•…éšœæ³¨å…¥ï¼Œè€Œæ— éœ€æ›´æ”¹ä»»ä½•åº”ç”¨ç¨‹åºä»£ç ã€‚</p><p class=ql-align-justify>å½“ç„¶ï¼Œæ•…éšœæ³¨å…¥æ˜¯ä¸€ä¸ªå¾ˆæ³›çš„è¯é¢˜ï¼Œè¿˜æœ‰å¾ˆå¤šæ›´å¤æ‚çš„æ•…éšœæ³¨å…¥æ–¹å¼ï¼ŒåŒ…æ‹¬è·¯ç”±å¤±è´¥ã€è®©åŒ¹é…ç‰¹å®šæ¡ä»¶çš„è¯·æ±‚å¤±è´¥ã€æˆ–è€…åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºæ‹“æ‰‘ä¸­ä¼ æ’­å•ä¸ªâ€œæ¯’ä¸¸â€è¯·æ±‚ã€‚è¿™äº›ç±»å‹çš„æ•…éšœæ³¨å…¥éœ€è¦æ¯”æœ¬æ–‡æ‰€æ¶µç›–å†…å®¹æ›´å¤šçš„æ”¯æŒæœºåˆ¶ã€‚</p><p class=ql-align-justify>Linkerd æ˜¯ä¸€ä¸ªç”±äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCloud Native Computing Foundationï¼ŒCNCFï¼‰æ‰˜ç®¡çš„ç¤¾åŒºé¡¹ç›®ã€‚Linkerd æ‰˜ç®¡åœ¨GitHubä¸Šï¼Œåœ¨Slackï¼ŒTwitterå’Œmailing listsä¸Šç¤¾åŒºä¹Ÿå¾ˆæ´»è·ƒï¼Œæ„Ÿå…´è¶£çš„å¼€å‘è€…å¯ä»¥ä¸‹è½½è¯•ç”¨ã€‚</p><div class=pgc-img><img alt="æ··æ²Œå·¥ç¨‹å®è·µï¼šä½¿ç”¨ SMI å’Œ Linkerd è¿›è¡Œæ•…éšœæ³¨å…¥" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cd39a4cbf8624c87b28676670121cef8><p class=pgc-img-caption></p></div><p class=ql-align-justify><strong>å–œæ¬¢æ–‡ç« å¯ä»¥å…³æ³¨å°ç¼–ï¼Œä¹‹åæŒç»­æ›´æ–°æ›´å¤šç²¾å½©æ–‡ç« ï¼</strong></p><p class=ql-align-justify><strong>åŸæ–‡é“¾æ¥ï¼š</strong></p><p class=ql-align-justify>https://linkerd.io/2019/07/18/failure-injection-using-the-service-mesh-interface-and-linkerd/index.html</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'å®è·µ','SMI','Linkerd'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>