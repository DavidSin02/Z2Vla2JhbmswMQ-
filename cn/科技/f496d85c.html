<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>你的Python程序还需要改进么？带给你几个Python的小建议 | 极客快訊</title><meta property="og:title" content="你的Python程序还需要改进么？带给你几个Python的小建议 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p9.pstatp.com/large/568e00031a460db4c0ab"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f496d85c.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f496d85c.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f496d85c.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f496d85c.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f496d85c.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f496d85c.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f496d85c.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f496d85c.html><meta property="article:published_time" content="2020-11-14T20:55:07+08:00"><meta property="article:modified_time" content="2020-11-14T20:55:07+08:00"><meta name=Keywords content><meta name=description content="你的Python程序还需要改进么？带给你几个Python的小建议"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/f496d85c.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>你的Python程序还需要改进么？带给你几个Python的小建议</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>分享前还是先分享自己的Python学习交流群：666468218</h1><h1>群内不定时分享干货，包括最新的python企业案例学习资料和零基础入门教程，欢迎初学和进阶中的小伙伴入群学习交流</h1><p><strong>分集连载，各位看官可以搜索“Python一Devil”观看《改善Python程序的多个建议》系列</strong></p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/568e00031a460db4c0ab></p><h1>第 4 章 库</h1><p><strong>掌握字符串的基本用法</strong></p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/568b00053e79a088261f></p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/568e00030907855966a1></p><p>下面来介绍一些易混淆的地方：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/568e00030b86811edf3d></p><p><strong>按需选择 sort() 或者 sorted()</strong></p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/568c000551a8203edcdd></p><p>所以如果实际过程中需要保留原有列表，可以使用sorted()。sort()不需要复制原有列表，消耗内存较小，效率较高。同时传入参数key比传入参数cmp效率要高，cmp传入的函数在整个排序过程中会调用多次，而key针对每个元素仅作一次处理。</p><p><strong>使用 copy 模块深拷贝对象</strong></p><ul class=list-paddingleft-2><li><p>浅拷贝（shallow copy）：构造一个新的复合对象并将从原对象中发现的引用插入该对象中。工厂函数、切片操作、copy 模块中的 copy 操作都是浅拷贝</p></li><li><p>深拷贝（deep copy）：针对引用所指向的对象继续执行拷贝，因此产生的对象不受其它引用对象操作的影响。深拷贝需要依赖 copy 模块的 deepcopy() 操作</p></li></ul><p>在 python 中，标识一个对象唯一身份的是：对象的id(内存地址)，对象类型，对象值，而浅拷贝就是创建一个具有相同类型，相同值但不同id的新对象。因此使用浅拷贝的典型使用场景是：对象自身发生改变的同时需要保持对象中的值完全相同，比如 list 排序：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/568d00038bc65db36931></p><p>深拷贝不仅仅拷贝了原始对象自身，也对其包含的值进行拷贝，它会递归的查找对象中包含的其他对象的引用，来完成更深层次拷贝。因此，深拷贝产生的副本可以随意修改而不需要担心会引起原始值的改变：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/568c00055465c2638109></p><p>使用 _copy_ 和 __deepcopy__ 可以完成对一个对象拷贝的定制。</p><p><strong>使用 Counter 进行计数统计</strong></p><p>常见的计数统计可以使用dict、defaultdict、set和list，不过 Python 提供了一个更优雅的方式：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/568b000545d033a968f7></p><p>Counter 类属于字典类的子类，是一个容器对象，用来统计散列对象，支持+、-、&、|，其中&和|分别返回两个 Counter 对象各元素的最小值和最大值。</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/56890005fd689f14f095></p><p><strong>深入掌握 ConfigParser</strong></p><p>几乎所有的应用程序都会读取配置文件，ini是一种比较常见的文件格式：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/568c000555e939260822></p><p>Python 提供标准库 ConfigParser 来支持它：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/568b000546afbff84a5d></p><p>再来看个SQLAlchemy配置文件的例子：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/568b000546e3edf07161></p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/56880005b5edac8ac325></p><p><strong>使用 argparse 处理命令行参数</strong></p><p>Python 标准库中有几种关于处理命令行的方案：getopt、optparse、argparse。</p><p>现阶段最好用的参数处理是argparse：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/568a0005e272b2877990></p><p>关于命令行参数，我记得有个第三方库超好用，好久贴个教程出来。</p><p><strong>使用 pandas 处理大型 CSV 文件</strong></p><p>CSV 作为一种逗号分隔型值的纯文本格式文件，常用于数据库数据的导入导出，数据分析中记录的存储。Python 中的 csv 模块提供了对 CSV 的支持。</p><p>列出一些常用的 API：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/568e000312d14dce9c31></p><p>当然，处理 CSV 还有更好的选择，那就是大名鼎鼎的 Pandas，它提供两种基本的数据结构：Series 和 DataFrame。这里有个 Pandas 的教程，值得一看。</p><p><strong>一般情况下使用 ElementTree 解析 XML</strong></p><p>给一个较好的学习教程，下面直接看例子吧：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/5689000600d4be416df7></p><p><strong>理解模块 pickle 优劣</strong></p><p>pickle 是较为通用的序列化模块，其中两个主要的函数dump()和load()分别用来进行对象的序列化和反序列化：</p><ul class=list-paddingleft-2><li><p>pickle.dump(obj, file[, protocol])</p></li><li><p>load(file)</p></li></ul><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/568c00055a09054b3b1c></p><p>它还有个C语言的实现 cPickle，性能较好。但 pickle 限制较多：比如不能保证原子性操作，存在安全问题，跨语言兼容性不好等。</p><p><strong>序列化的另一个不错的选择 JSON</strong></p><p>这个应该不用多做介绍了吧，书中讲得比较浅，又来放链接（逃...</p><p><strong>使用 traceback 获取栈信息</strong></p><p>当发生异常，开发人员往往需要看到现场信息，trackback 模块可以满足这个需求，先列几个常用的：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/5689000602d9f72e60c1></p><p>traceback 模块获取异常相关的数据是通过sys.exc_info()得到的，该函数返回异常类型type、异常value、调用和堆栈信息traceback组成的元组。</p><p>同时 inspect 模块也提供了获取 traceback 对象的接口。</p><p><strong>使用 logging 记录日志信息</strong></p><p>仅仅将信息输出到控制台是远远不够的，更为常见的是使用日志保存程序运行过程中的相关信息，如运行时间、描述信息以及错误或者异常发生时候的特定上下文信息。Python 提供 logging 模块提供了日志功能，将日志分为 5 个级别：</p><p>Level使用情形DEBUG详细的信息，在追踪问题的时候使用INFO正常的信息WARNING一些不可预见的问题发生，或者将要发生，如磁盘空间低等，但不影响程序的运行ERROR由于某些严重的问题，程序中的一些功能受到影响CRITICAL严重的错误，或者程序本身不能够继续运行</p><p>logging.basicConfig([**kwargs]) 提供对日志系统的基本配置：</p><p>格式描述filename指定 FileHandler 的文件名，而不是默认的 StreamHandlerfilemode打开文件的模式，同 open 函数中的同名参数，默认为 'a'format输出格式字符串datefmt日期格式level设置根 logger 的日志级别stream指定 StreamHandler。这个参数若与 filename 冲突，忽略 stream</p><p>下面结合 traceback 和 logging 来记录程序运行过程中的异常：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/56890006042595e33fb1></p><p>logging 模块让我们可以很方便地控制日志信息，如loggging.disable()传入一个日志级别会禁用该级别或比级别更低的日志消息，默认是全部禁用。大致我们常用的日志记录就这些了。</p><p><strong>使用 threading 模块编写多线程程序</strong></p><p>由于 GIL 的存在，让 Python 多线程编程在多核处理器中无法发挥优势，但在一些使用场景下使用多线程仍然比较好，如等待外部资源返回，或建立反应灵活的用户界面，或多用户程序等。</p><p>Python3 提供了两个模块：_thread和threading。_thread提供了底层的多线程支持，使用比较复杂，下面我们重点说说threading。</p><p>Python 多线程支持用两种方式来创建线程：一种通过继承 Thread 类，重写它的run()方法；另一种是创建一个 threading.Thread 对象，在它的初始化函数__init__()中将可调用对象作为参数传入。</p><p>threading模块中不仅有 Lock 指令锁，RLock 可重入指令锁，还支持条件变量 Condition、信号量 Semaphore、BoundedSemaphore 以及 Event 事件等。</p><p>下面有一个比较经典的例子来理解多线程：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/568a0005e81cf5a3e4e6></p><p>分析：threading 模块支持线程守护，我们可以通过setDaemon()来设置线程的daemon属性，当其属性为True时，表明主线程的退出可以不用等待子线程完成，反之，daemon属性为False时所有的非守护线程结束后主线程才会结束，那运行结果为：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/568d0003964aedaa9072></p><p>继续修改代码，当我们在#3处加入t.join()，此方法能够阻塞当前上下文环境，直到调用该方法的线程终止或到达指定的 timeout，此时在运行程序：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/568c00055d9a7da602df></p><p>当我们把music函数的休眠时间改为 4 秒，再次运行程序：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/5689000605c8b46fe3d2></p><p>此时我们就可以发现多线程的威力了，music虽然增加了 3 秒，然而总的运行时间仍然为 10 秒。</p><p><strong>使用 Queue 使多线程编程更加安全</strong></p><p>线程间的同步和互斥，线程间数据的共享等这些都是涉及线程安全要考虑的问题。纵然 Python 中提供了众多的同步和互斥机制，如 mutex、condition、event 等，但同步和互斥本身就不是一个容易的话题，稍有不慎就会陷入死锁状态或者威胁线程安全。</p><p>如何保证线程安全呢？我们先来看看 Python 中的 Queue 模块：</p><ul class=list-paddingleft-2><li><p>Queue.Queue(maxsize)：先进先出，maxsize 为队列大小，其值为非正数的时候为无限循环队列</p></li><li><p>Queue.LifoQueue(maxsize)：后进先出，相当于栈</p></li><li><p>Queue.PriorityQueue(maxsize)：优先级队列</p></li></ul><p>以上队列所支持的方法：</p><ul class=list-paddingleft-2><li><p>Queue.qsize()：返回近似的队列大小。当该值 > 0 的时候并不保证并发执行的时候 get() 方法不被阻塞，同样，对于 put() 方法有效。</p></li><li><p>Queue.empty()：队列为空的时候返回 True，否则返回 False</p></li><li><p>Queue.full()：当设定了队列大小的情况下，如果队列满则返回 True，否则返回 False</p></li><li><p>Queue.put(item[, block[, timeout]])：往队列中添加元素 item，block 设置为 False 的时候，如果队列满则抛出 Full 异常。如果 block 设置为 True，timeout 为 None 的时候则会一直等待直到有空位置，否则会根据 timeout 的设定超时后抛出 Full 异常</p></li><li><p>Queue.put_nowait(item)：等于 put(item, False).block 设置为 False 的时候，如果队列空则抛出 Empty 异常。如果 block 设置为 True、timeout 为 None 的时候则会一直等到有元素可用，否则会根据 timeout 的设定超时后抛出 Empty 异常</p></li><li><p>Queue.get([block[, timeout]])：从队列中删除元素并返回该元素的值</p></li><li><p>Queue.get_nowait()：等价于 get(False)</p></li><li><p>Queue.task_done()：发送信号表明入列任务已经完成，经常在消费者线程中用到</p></li><li><p>Queue.join()：阻塞直至队列中所有的元素处理完毕</p></li></ul><p>首先 Queue 中的队列和 collections.deque 所表示的队列并不一样，前者用于不同线程之间的通信，内部实现了线程的锁机制，后者是数据结构上的概念，支持 in 方法。</p><p>Queue 模块实现了多个生产者多个消费者的队列，当多线程之间需要信息安全的交换的时候特别有用，因此这个模块实现了所需要的锁原语，为 Python 多线程编程提供了有力的支持，它是线程安全的。</p><p>先来看一个简单的例子：</p><p><img alt=你的Python程序还需要改进么？带给你几个Python的小建议 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/568b00054f0b7a6a78bd></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Python','改进么','带给'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>