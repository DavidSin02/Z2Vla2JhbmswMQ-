<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>å¤§å‹åˆ†å¸ƒå¼ç”µå•†ç³»ç»Ÿæ ¸å¿ƒè®¢å•ä¸šåŠ¡æ¶æ„å®è·µ | æå®¢å¿«è¨Š</title><meta property="og:title" content="å¤§å‹åˆ†å¸ƒå¼ç”µå•†ç³»ç»Ÿæ ¸å¿ƒè®¢å•ä¸šåŠ¡æ¶æ„å®è·µ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f9dff1b.html><meta property="article:published_time" content="2020-10-29T21:05:04+08:00"><meta property="article:modified_time" content="2020-10-29T21:05:04+08:00"><meta name=Keywords content><meta name=description content="å¤§å‹åˆ†å¸ƒå¼ç”µå•†ç³»ç»Ÿæ ¸å¿ƒè®¢å•ä¸šåŠ¡æ¶æ„å®è·µ"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/f9dff1b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>å¤§å‹åˆ†å¸ƒå¼ç”µå•†ç³»ç»Ÿæ ¸å¿ƒè®¢å•ä¸šåŠ¡æ¶æ„å®è·µ</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p>èƒŒæ™¯</p><p>æŸæŸåœ¨ä¸€å®¶åœ¨çº¿è´­ç‰©å•†åŸå·¥ä½œï¼Œæœ€è¿‘æ¥äº†ä¸€ä¸ªæ–°éœ€æ±‚ï¼Œéœ€è¦ä»–è´Ÿè´£å¼€å‘ä¸€ä¸ªå•†å“ç§’æ€æ¨¡å—ï¼Œè€Œä¸”éœ€æ±‚å¾ˆç´§æ€¥ï¼Œè€æ¿è¦æ±‚å¿…é¡»å°½å¿«ä¸Šçº¿ã€‚</p><p>æ–¹æ¡ˆ</p><p>æŸæŸä¸€å¼€å§‹æ˜¯è¿™ä¹ˆåšçš„ï¼Œç›´æ¥ç”¨æ•°æ®åº“é”è¿›è¡Œæ§åˆ¶ï¼Œè·å–ç§’æ€å•†å“æ•°é‡å¹¶åŠ é”ï¼Œå¦‚æœæ•°é‡å¤§äºé›¶åˆ™æˆåŠŸï¼Œå¦åˆ™ç§’æ€å¤±è´¥ã€‚</p><pre><code>@Override@Transactionalpublic Result startSeckilDBPCC_ONE(long seckillId, long userId) {    //è·å–ç§’æ€å•†å“æ•°é‡å¹¶åŠ é”    String nativeSql = &#34;SELECT number FROM seckill WHERE seckill_id=? FOR UPDATE&#34;;    Object object =  dynamicQuery.nativeQueryObject(nativeSql, new Object[]{seckillId});    Long number =  ((Number) object).longValue();    if(number&gt;0){        nativeSql = &#34;UPDATE seckill  SET number=number-1 WHERE seckill_id=?&#34;;        dynamicQuery.nativeExecuteUpdate(nativeSql, new Object[]{seckillId});        SuccessKilled killed = new SuccessKilled();        killed.setSeckillId(seckillId);        killed.setUserId(userId);        killed.setState((short)0);        killed.setCreateTime(new Timestamp(new Date().getTime()));        dynamicQuery.save(killed);        return Result.ok(SeckillStatEnum.SUCCESS);    }else{        return Result.error(SeckillStatEnum.END);    }}</code></pre><p>å†™äº†å¹¶å‘çº¿ç¨‹ï¼Œè·‘äº†ä¸€ä¸‹ï¼Œæ²¡é—®é¢˜ï¼Œæå®šï¼ä½†æ˜¯ï¼ŒæŸæŸè½¬å¤´ä¸€æƒ³ï¼Œè€æ¿æ›¾ç»è¯´è¿‡ï¼Œè¿™æ¬¡æ´»åŠ¨å®£ä¼ åŠ›åº¦å¾ˆå¤§ï¼Œæœ‰å¯èƒ½ä¼šæœ‰å¾ˆå¤šç”¨æˆ·å‚ä¸æ´»åŠ¨ã€‚æ°å¥½é¡¹ç›®ä¸­ä½¿ç”¨äº† Redis ä½œä¸ºç¼“å­˜ï¼Œä½•ä¸å€Ÿç”¨ä¸€ä¸‹ Redis çš„å‘å¸ƒè®¢é˜…åŠŸèƒ½ï¼Œå®ç°ç§’æ€é˜Ÿåˆ—ï¼Œä»è€Œå‡è½»åç«¯æ•°æ®åº“çš„è®¿é—®å‹åŠ›ï¼Œæå‡æœåŠ¡æ€§èƒ½ï¼è¿™å¯æ˜¯ä¸ªå‡èŒåŠ è–ªï¼Œå½“ä¸Šæ€»ç»ç†ï¼Œå‡ºä»»CTOï¼Œè¿å¨¶ç™½å¯Œç¾çš„å¥½æœºä¼šã€‚è¯´å¹²å°±å¹²ï¼Œå¤åˆ¶ã€é»è´´ä¸€æŠŠæ’¸ï¼Œå¾ˆå¿«æŸæŸå°±æŠŠæ¶ˆæ¯é˜Ÿåˆ—æ–¹æ¡ˆæå®šäº†ã€‚</p><p>image</p><p>äº‹æ•…</p><p>å¼€å‘ã€æµ‹è¯•ã€ä¸Šçº¿ä¸€æ¡é¾™ï¼Œæ´»åŠ¨å¼€å§‹äº†ï¼Œç§’æ€å•†å“æ˜¯ 100 éƒ¨è‹¹æœæ‰‹æœºï¼Œæ´»åŠ¨ç»“æŸä»¥åï¼Œå±…ç„¶äº§ç”Ÿäº† 106 ä¸ªè®¢å•ï¼è€æ¿å¾ˆç”Ÿæ°”ï¼Œåæœå¾ˆä¸¥é‡ï¼Œè¿™ä¸ªé”…å¿…é¡»æœ‰äººå¾—èƒŒï¼Œå“å¾—æŸæŸèµ¶ç´§ä»”ç»†å¤æŸ¥å¤åˆ¶ç²˜è´´çš„ä»£ç ã€‚</p><p>ç›‘å¬é…ç½® RedisSubListenerConfig ï¼š</p><pre><code>@Configurationpublic class RedisSubListenerConfig {    //åˆå§‹åŒ–ç›‘å¬å™¨    @Bean    RedisMessageListenerContainer container(RedisConnectionFactory connectionFactory,            MessageListenerAdapter listenerAdapter) {        RedisMessageListenerContainer container = new RedisMessageListenerContainer();        container.setConnectionFactory(connectionFactory);        container.addMessageListener(listenerAdapter, new PatternTopic(&#34;seckill&#34;));        return container;    }    //åˆ©ç”¨åå°„æ¥åˆ›å»ºç›‘å¬åˆ°æ¶ˆæ¯ä¹‹åçš„æ‰§è¡Œæ–¹æ³•    @Bean    MessageListenerAdapter listenerAdapter(RedisConsumer redisReceiver) {        return new MessageListenerAdapter(redisReceiver, &#34;receiveMessage&#34;);    }   //ä½¿ç”¨é»˜è®¤çš„å·¥å‚åˆå§‹åŒ–redisæ“ä½œæ¨¡æ¿    @Bean    StringRedisTemplate template(RedisConnectionFactory connectionFactory) {        return new StringRedisTemplate(connectionFactory);    }}</code></pre><pre><code>ç”Ÿäº§è€… RedisSenderï¼š/** * ç”Ÿäº§è€… */@Servicepublic class RedisSender {    @Autowired    private StringRedisTemplate stringRedisTemplate;    public void sendChannelMess(String channel, String message) {        stringRedisTemplate.convertAndSend(channel, message);    }}æ¶ˆè´¹è€… RedisConsumerï¼š/** * æ¶ˆè´¹è€… */@Servicepublic class RedisConsumer {        @Autowired    private ISeckillService seckillService;    @Autowired    private RedisUtil redisUtil;        public void receiveMessage(String message) {        //æ”¶åˆ°é€šé“çš„æ¶ˆæ¯ä¹‹åæ‰§è¡Œç§’æ€æ“ä½œ        String[] array = message.split(&#34;;&#34;);        if(redisUtil.getValue(array[0])==null){//controlå±‚å·²ç»åˆ¤æ–­äº†ï¼Œå…¶å®è¿™é‡Œä¸éœ€è¦å†åˆ¤æ–­äº†            Result result = seckillService.startSeckilDBPCC_TWO(Long.parseLong(array[0]), Long.parseLong(array[1]));            if(result.equals(Result.ok(SeckillStatEnum.SUCCESS))){                WebSocketServer.sendInfo(array[0], &#34;ç§’æ€æˆåŠŸ&#34;);//æ¨é€ç»™å‰å°            }else{                WebSocketServer.sendInfo(array[0], &#34;ç§’æ€å¤±è´¥&#34;);//æ¨é€ç»™å‰å°                redisUtil.cacheValue(array[0], &#34;ok&#34;);//ç§’æ€ç»“æŸ            }        }else{            WebSocketServer.sendInfo(array[0], &#34;ç§’æ€å¤±è´¥&#34;);//æ¨é€ç»™å‰å°        }    }}æ•°æ®å±‚ä»£ç ï¼š@Override@Transactionalpublic Result startSeckil(long seckillId,long userId) {        //ç”±äºä½¿ç”¨äº†é˜Ÿåˆ—ï¼ŒæŸæŸè¿™é‡Œæ²¡ç”¨æ•°æ®åº“é”        String nativeSql = &#34;SELECT number FROM seckill WHERE seckill_id=?&#34;;        Object object =  dynamicQuery.nativeQueryObject(nativeSql, new Object[]{seckillId});        Long number =  ((Number) object).longValue();        if(number&gt;0){            //æ‰£åº“å­˜            nativeSql = &#34;UPDATE seckill  SET number=number-1 WHERE seckill_id=?&#34;;            dynamicQuery.nativeExecuteUpdate(nativeSql, new Object[]{seckillId});            //åˆ›å»ºè®¢å•            SuccessKilled killed = new SuccessKilled();            killed.setSeckillId(seckillId);            killed.setUserId(userId);            killed.setState((short)0);            Timestamp createTime = new Timestamp(new Date().getTime());            killed.setCreateTime(createTime);            dynamicQuery.save(killed);            //æ”¯ä»˜            return Result.ok(SeckillStatEnum.SUCCESS);        }else{            return Result.error(SeckillStatEnum.END);        }}</code></pre><p>æŸæŸé‡æ–°å®¡è¯»äº†ä»£ç ï¼Œä¸€å¼€å§‹æŸæŸè§‰å¾—æ—¢ç„¶ä½¿ç”¨äº†é˜Ÿåˆ—ï¼Œæ•°æ®åº“å±‚é¢å°±æ²¡å¿…è¦ç”¨æ•°æ®åº“é”äº†ï¼Œç„¶åå»æ‰äº† for updateï¼Œå¾ˆæ˜¾ç„¶é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œã€‚å¯¼è‡´è¶…å–çš„å› ç´ åªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯å¤šçº¿ç¨‹å¹¶å‘æŠ¢å èµ„æºï¼Œå¦‚æœä¸šåŠ¡é€»è¾‘æ²¡æœ‰åšç›¸åº”çš„æªæ–½ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´è¶…å–ã€‚</p><p>å›åˆ°ä»£ç æ¥çœ‹ï¼Œè™½ç„¶ç§’æ€ç”¨æˆ·è¿›å…¥äº†é˜Ÿåˆ—ï¼Œä½†æ˜¯ RedisConsumer ç«¯æœ‰å¯èƒ½æ˜¯å¤šçº¿ç¨‹å¤„ç†é˜Ÿåˆ—æ•°æ®ï¼ŒæŸæŸä¸ºäº†éªŒè¯æƒ³æ³•ï¼Œåœ¨æ¶ˆè´¹ç«¯åŠ å…¥äº†ä»¥ä¸‹ä»£ç æ¥æ‰“å°çº¿ç¨‹åç§°ã€‚</p><p>Thread th=Thread.currentThread(); System.out.println("Tread name:"+th.getName()); å†æ¬¡è¿è¡Œä»»åŠ¡ï¼Œæœä¸å…¶ç„¶ï¼Œæ¯ä¸ªç§’æ€ç”¨æˆ·éƒ½å¼€å¯äº†ä¸€ä¸ªçº¿ç¨‹å¤„ç†ä»»åŠ¡ï¼š</p><p>Tread name:container-1 Tread name:container-2 Tread name:container-3 Tread name:container-4 Tread name:container-5 Tread name:container-6 ...... å„ä½çœ‹å®˜åˆ°è¿™é‡Œï¼Œçº¿ç´¢å·²ç»å¾ˆæ˜ç¡®äº†ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ¶ˆè´¹ç«¯æ”¹é€ æˆå•çº¿ç¨‹å¤„ç†ï¼Œé—®é¢˜å°±è¿åˆƒè€Œè§£äº†ã€‚</p><p>è§£å†³æ–¹æ¡ˆ</p><p>ä½¿ç”¨ Redis æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå‡ºç°è¶…å–é—®é¢˜æ˜¯å› ä¸ºRedisMessageListenerContainer çš„é»˜è®¤ä½¿ç”¨çº¿ç¨‹æ± æ˜¯SimpleAsyncTaskExecutorï¼Œæ¯æ¬¡æ¶ˆè´¹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œè¿™æ ·å°±ä¼šæœ‰å¤§é‡çš„æ–°çº¿ç¨‹è¢«åˆ›å»ºã€‚æœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è·Ÿè¿›æºç ï¼Œäº†è§£æ›´å¤šè¯¦ç»†å†…å®¹ã€‚</p><p>ç›‘å¬é…ç½® RedisSubListenerConfig æ”¹é€ ä¸º ï¼š</p><pre><code>@BeanRedisMessageListenerContainer container(RedisConnectionFactory connectionFactory,            MessageListenerAdapter listenerAdapter) {        RedisMessageListenerContainer container = new RedisMessageListenerContainer();        container.setConnectionFactory(connectionFactory);        container.addMessageListener(listenerAdapter, new PatternTopic(&#34;seckill&#34;));        /**         * å¦‚æœä¸å®šä¹‰çº¿ç¨‹æ± ï¼Œæ¯ä¸€æ¬¡æ¶ˆè´¹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœä¸šåŠ¡å±‚é¢ä¸åšé™åˆ¶ï¼Œå°±ä¼šå¯¼è‡´ç§’æ€è¶…å–ã€‚         * æ­¤å¤„æ„Ÿè°¢ç½‘å‹ DIscord         */        ThreadFactory factory = new ThreadFactoryBuilder()                .setNameFormat(&#34;redis-listener-pool-%d&#34;).build();        Executor executor = new ThreadPoolExecutor(                1,                1,                5L,                TimeUnit.SECONDS,                new LinkedBlockingQueue&lt;&gt;(1000),                factory);        container.setTaskExecutor(executor);        return container;}ç„¶åæµ‹è¯•æ”¹é€ æ•ˆæœï¼šTread name:redis-listener-pool-0Tread name:redis-listener-pool-0Tread name:redis-listener-pool-0......</code></pre><p><br></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'ç”µå•†ç³»ç»Ÿ','å•ä¸šåŠ¡æ¶æ„','å®è·µ'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>