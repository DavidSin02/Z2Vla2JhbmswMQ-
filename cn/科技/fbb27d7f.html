<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Redisç»“åˆAQSå®ç°Javaç‰ˆçš„å¯é‡å…¥åˆ†å¸ƒå¼é” | æå®¢å¿«è¨Š</title><meta property="og:title" content="Redisç»“åˆAQSå®ç°Javaç‰ˆçš„å¯é‡å…¥åˆ†å¸ƒå¼é” - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/fc01434c4f24445293d68f0f8778c76f"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fbb27d7f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fbb27d7f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fbb27d7f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fbb27d7f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fbb27d7f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fbb27d7f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fbb27d7f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fbb27d7f.html><meta property="article:published_time" content="2020-11-14T20:55:06+08:00"><meta property="article:modified_time" content="2020-11-14T20:55:06+08:00"><meta name=Keywords content><meta name=description content="Redisç»“åˆAQSå®ç°Javaç‰ˆçš„å¯é‡å…¥åˆ†å¸ƒå¼é”"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/fbb27d7f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è®¯ Geek Bank</a></h1><p class=description>ä¸ºä½ å¸¦æ¥æœ€å…¨çš„ç§‘æŠ€çŸ¥è¯† ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Redisç»“åˆAQSå®ç°Javaç‰ˆçš„å¯é‡å…¥åˆ†å¸ƒå¼é”</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><div class=pgc-img><img alt=Redisç»“åˆAQSå®ç°Javaç‰ˆçš„å¯é‡å…¥åˆ†å¸ƒå¼é” onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fc01434c4f24445293d68f0f8778c76f></div><h1>å‰è¨€</h1><p>å¯¹äºjavaçš„å•è¿›ç¨‹åº”ç”¨æ¥è¯´ï¼Œå­˜åœ¨èµ„æºç«äº‰çš„åœºæ™¯å¯ä»¥ä½¿ç”¨synchronizedå…³é”®å­—å’ŒLockæ¥å¯¹èµ„æºè¿›è¡ŒåŠ é”ï¼Œä½¿æ•´ä¸ªæ“ä½œå…·æœ‰åŸå­æ€§ã€‚ä½†æ˜¯å¯¹äºå¤šè¿›ç¨‹æˆ–è€…åˆ†å¸ƒå¼çš„åº”ç”¨æ¥è¯´ï¼Œä¸Šé¢æåˆ°çš„é”ä¸å…±äº«ï¼Œåšä¸åˆ°äº’ç›¸é€šè®¯ï¼Œæ‰€ä»¥å°±éœ€è¦åˆ†å¸ƒå¼é”æ¥è§£å†³é—®é¢˜äº†ã€‚</p><p>åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥è¿›å…¥æ­£é¢˜ï¼Œä¸‹é¢ç»“åˆAQSå’ŒRedisæ¥å®ç°åˆ†å¸ƒå¼é”ã€‚</p><p>ä»£ç ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯å‚è€ƒReentrantLockæ¥å®ç°çš„ï¼Œæ‰€ä»¥è¯»è€…å¯ä»¥å…ˆå»äº†è§£ä¸€ä¸‹ReentranLockå’ŒAQS</p><p>å‚é˜…ï¼š</p><p>http://www.importnew.com/27477.html</p><p>http://cmsblogs.com/?p=2210</p><h1>åŠ é”</h1><p>@Override</p><p>protected boolean tryAcquire(int acquires) throws AcquireLockTimeoutException {</p><p>final Thread current = Thread.currentThread();</p><p>int c = getState();</p><p>if (c == 0) {</p><p>if (!hasQueuedPredecessors() &&</p><p>compareAndSetState(0, 1)) { // æ ‡æ³¨1</p><p>setExclusiveOwnerThread(current);</p><p>// å¦‚æœæ˜¯çº¿ç¨‹è¢«ä¸­æ–­å¤±è´¥çš„è¯ï¼Œè¿”å›falseï¼Œå¦‚æœè¶…æ—¶å¤±è´¥çš„è¯ï¼Œæ•è·å¼‚å¸¸</p><p>return tryAcquireRedisLock(TimeUnit.MILLISECONDS.toNanos(redisLockTimeout));</p><p>}</p><p>//å¯é‡å…¥</p><p>} else if (current == getExclusiveOwnerThread()) { //æ ‡æ³¨2</p><p>int nextc = c + acquires;</p><p>if (nextc &lt; 0) {</p><p>throw new Error("Maximum lock count exceeded");</p><p>}</p><p>setState(nextc);</p><p>return true;</p><p>}</p><p>return false;</p><p>}</p><p>ä¸‹é¢ä¼šæŠŠè¿›ç¨‹å†…çš„é”ç§°ä¸ºè¿›ç¨‹é”ï¼Œå¦‚æœæœ‰æ›´ä¸“ä¸šçš„æè¿°æ–¹æ³•çš„è¯ï¼Œæ¬¢è¿æŒ‡å‡ºã€‚</p><p>å¯¹ä¸Šé¢çš„æ­¥éª¤åˆ†æï¼š</p><p>1. é¦–å…ˆçœ‹æ ‡æ³¨1ï¼Œé€šè¿‡compareAndSetStateè·å–åˆ°è¿›ç¨‹é”ï¼Œåªæœ‰è·å–åˆ°è¿›ç¨‹é”ï¼Œæ‰æœ‰èµ„æ ¼å»ç«äº‰redisé”ï¼Œ è¿™æ ·çš„å¥½å¤„å°±æ˜¯å¯¹äºåŒä¸€ä¸ªè¿›ç¨‹é‡Œé¢çš„æ‰€æœ‰åŠ é”è¯·æ±‚ï¼Œåœ¨æŸä¸€ä¸ªæ—¶åˆ»åªæœ‰ä¸€ä¸ªè¯·æ±‚èƒ½å»è¯·æ±‚è·å–redisé”ï¼Œæœ‰æ•ˆé™ä½redisçš„å‹åŠ›ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯æŠŠéƒ¨åˆ†ç«äº‰äº¤ç»™è¿›ç¨‹è‡ªå·±å»è§£å†³äº†ï¼Œä¹Ÿå°±æ˜¯å…ˆç«äº‰è¿›ç¨‹é”ã€‚</p><p>2. å†çœ‹æ ‡æ³¨2ï¼Œèƒ½è¿›è¡Œåˆ°è¿™ä¸€æ­¥ï¼Œé¦–å…ˆèƒ½ç¡®ä¿å·²ç»è·å–äº†è¿›ç¨‹é”ï¼Œä½†æ˜¯æ˜¯å¦ä¸€å®šè·å–äº†redisé”äº†å‘¢ï¼Œä¸ä¸€å®šï¼Œæ‰€ä»¥åœ¨tryAcquireRedisLockçš„è¿‡ç¨‹ä¸­å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œä¸€å®šè¦ä¿è¯ä½¿ç”¨finallyä»£ç å—æŠŠè¿›ç¨‹é”é‡Šæ”¾æ‰ï¼Œé¿å…è¯¯ä»¥ä¸ºå·²ç»åŒæ—¶è·å–äº†è¿›ç¨‹é”å’Œredisé”ã€‚</p><h1>è·å–redisé”</h1><p>private final boolean tryAcquireRedisLock(long nanosTimeout) {</p><p>if (nanosTimeout &lt;= 0L) {</p><p>return false;</p><p>}</p><p>final long deadline = System.nanoTime() + nanosTimeout;</p><p>int count = 0;</p><p>boolean interrupted = false;</p><p>Jedis jedis = null;</p><p>try {</p><p>jedis = redisHelper.getJedisInstance();</p><p>while (true) {</p><p>nanosTimeout = deadline - System.nanoTime();</p><p>if (nanosTimeout &lt;= 0L) {</p><p>throw new AcquireLockTimeoutException();</p><p>}</p><p>String value = String.format(valueFormat, Thread.currentThread().getId());</p><p>//é¿å…ç³»ç»Ÿå®•æœºé”ä¸é‡Šæ”¾ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´</p><p>String response = jedis.set(lockKey, value, NX, PX, redisLockTimeout);</p><p>if (OK.equals(response)) {</p><p>//å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­åŒæ—¶ä¹Ÿæ˜¯å¤±è´¥çš„</p><p>return !interrupted;</p><p>}</p><p>// è¶…è¿‡å°è¯•æ¬¡æ•°</p><p>if (count > RETRY_TIMES && nanosTimeout > SPIN_FOR_TIMEOUT_THRESHOLD && parkAndCheckInterrupt()) {</p><p>interrupted = true;</p><p>}</p><p>count++;</p><p>}</p><p>} finally {</p><p>redisHelper.returnResouce(jedis);</p><p>}</p><p>}</p><p>final boolean parkAndCheckInterrupt() {</p><p>LockSupport.parkNanos(TimeUnit.NANOSECONDS.toNanos(PARK_TIME));</p><p>return Thread.interrupted();</p><p>}</p><p>åˆ†æï¼š</p><p>1. ä¸ºäº†é¿å…è·å–redisé”çš„è¿‡ç¨‹æ— ä¼‘æ­¢çš„è¿è¡Œä¸‹å»ï¼Œä½¿ç”¨è¶…æ—¶ç­–ç•¥ï¼Œå¦‚æœè¶…æ—¶äº†ï¼Œç›´æ¥è¿”å›å¤±è´¥</p><p>2. å¦‚æœè¿˜åœ¨æœ‰æ•ˆæ—¶é—´å†…ï¼Œåˆ™é€šè¿‡è‡ªæ—‹ä¸æ–­å°è¯•è·å–é”ï¼Œå¦‚æœè¶…è¿‡äº†å°è¯•æ¬¡æ•°ï¼Œæš‚æ—¶æŒ‚èµ·ï¼Œè®©å‡ºæ—¶é—´ç‰‡ï¼Œä½†æ˜¯ä¸å¯ä»¥æŒ‚èµ·å¤ªé•¿çš„æ—¶é—´ï¼Œå‡ ä¸ªæ—¶é—´ç‰‡å†…ä¸ºå¥½ã€‚</p><h1>è§£é”</h1><p>//RedisDistributedLock.java</p><p>@Override</p><p>public void unlock() {</p><p>sync.unlock();</p><p>}</p><p>//Sync.java</p><p>public void unlock() {</p><p>release(1);</p><p>}</p><p>@Override</p><p>protected final boolean tryRelease(int releases) {</p><p>int c = getState() - releases;</p><p>if (Thread.currentThread() != getExclusiveOwnerThread())</p><p>throw new IllegalMonitorStateException();</p><p>boolean free = false;</p><p>if (c == 0) {</p><p>Jedis jedis = null;</p><p>try {</p><p>jedis = redisHelper.getJedisInstance();</p><p>String value = String.format(valueFormat, Thread.currentThread().getId());</p><p>jedis.eval(UNLOCK_SCRIPT, Arrays.asList(lockKey), Arrays.asList(value));</p><p>} finally {</p><p>redisHelper.returnResouce(jedis);</p><p>}</p><p>free = true;</p><p>setExclusiveOwnerThread(null);</p><p>}</p><p>setState(c);</p><p>return free;</p><p>}</p><p>åˆ†æï¼š</p><p>1. å¯ä»¥æ³¨æ„åˆ°valueåœ¨åŠ é”å’Œè§£é”çš„è¿‡ç¨‹éƒ½æœ‰ï¼Œè¿™ä¸ªvalueæ˜¯ç”¨æ¥æ ‡è¯†é”çš„å”¯ä¸€æ€§çš„ï¼Œé¿å…åˆ«çš„è¿›ç¨‹è¯¯åˆ äº†è¯¥é”ã€‚</p><p>private final UUID uuid = UUID.randomUUID();</p><p>private final String valueFormat = "%d:" + uuid.toString();</p><h1>éªŒè¯</h1><p>@Override</p><p>public void run() {</p><p>SqlSession session = MybatisHelper.instance.openSession(true);</p><p>try {</p><p>KeyGeneratorMapper generatorMapper = session.getMapper(KeyGeneratorMapper.class);</p><p>KeyFetchRecordMapper recordMapper = session.getMapper(KeyFetchRecordMapper.class);</p><p>while (true) {</p><p>try {</p><p>lock.lock();</p><p>KeyGenerator keyGenerator = generatorMapper.select(1);</p><p>if (keyGenerator.getKey() >= MAX_KEY) {</p><p>System.exit(0);</p><p>}</p><p>recordMapper.insert(new KeyFetchRecord(keyGenerator.getKey(), server));</p><p>generatorMapper.increase(1, 1);</p><p>session.commit();</p><p>} catch (RuntimeException e) {</p><p>e.printStackTrace();</p><p>continue;</p><p>} finally {</p><p>lock.unlock();</p><p>}</p><p>}</p><p>} finally {</p><p>session.close();</p><p>}</p><p>}</p><p>å¼€å¯5ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹5ä¸ªçº¿ç¨‹ï¼Œè¿›è¡Œè·å–ä¸€ä¸ªkeyå€¼ï¼Œè·å–åˆ°ååŠ 1ï¼Œç„¶åè®°å½•åˆ°æ•°æ®åº“ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸è¦æ˜¯åŸå­çš„ï¼Œå› ä¸ºæŠŠæ²¡æœ‰åŸå­æ€§çš„è¿‡ç¨‹å˜æˆæœ‰åŸå­æ€§çš„è¿‡ç¨‹ï¼Œæ‰è¯æ˜äº†è¿™ä¸ªé”çš„æœ‰æ•ˆæ€§ã€‚</p><h1>ç»“æœå¦‚ä¸‹</h1><div class=pgc-img><img alt=Redisç»“åˆAQSå®ç°Javaç‰ˆçš„å¯é‡å…¥åˆ†å¸ƒå¼é” onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f66948d9fbec4ed783260fea6a55feae></div><div class=pgc-img><img alt=Redisç»“åˆAQSå®ç°Javaç‰ˆçš„å¯é‡å…¥åˆ†å¸ƒå¼é” onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/709528fc82694db98923b27b23820c4d></div><p>æ²¡æœ‰é‡å¤çš„key,æˆåŠŸï¼</p><p><strong>è¯¦ç»†å®ç°</strong></p><p>https://github.com/dhhua/common-util/tree/master/util-lock</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'Redis','ç»“åˆ','AQS'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>