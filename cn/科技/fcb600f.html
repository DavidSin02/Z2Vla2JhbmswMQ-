<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>SpringBoot自定义错误页面 | 极客快訊</title><meta property="og:title" content="SpringBoot自定义错误页面 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/17a417ace8b24067bdb1d528e6bc6be2"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fcb600f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fcb600f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fcb600f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fcb600f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fcb600f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fcb600f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fcb600f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fcb600f.html><meta property="article:published_time" content="2020-10-29T21:04:55+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:55+08:00"><meta name=Keywords content><meta name=description content="SpringBoot自定义错误页面"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/fcb600f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>SpringBoot自定义错误页面</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">SpringBoot请求错误如404可能看到如下页面：</span></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/17a417ace8b24067bdb1d528e6bc6be2><p class=pgc-img-caption></p></div><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999"><br>有时可能需要自定义错误页面针对不同的http.status,如404/400。</span></p><h1 class=pgc-h-arrow-right><strong><span style="color:#35b378;--tt-darkmode-color: #35B378">【1】解决方法</span></strong></h1><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">① 注册错误页面</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">如下所示：</span></p><pre><code>@Componentpublic class ErrorPageConfig implements ErrorPageRegistrar {    @Override    public void registerErrorPages(ErrorPageRegistry registry) {        ErrorPage error400Page = new ErrorPage(HttpStatus.BAD_REQUEST, "/error/404");        ErrorPage error404Page = new ErrorPage(HttpStatus.NOT_FOUND, "/error/404");        ErrorPage error500Page = new ErrorPage(HttpStatus.INTERNAL_SERVER_ERROR, "/error/500");        registry.addErrorPages(error400Page,error404Page,error500Page);    }}</code></pre><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">② controller进行拦截</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">然后你只需要写个controller拦截不同请求然后跳到不同的自定义错误页面即可，如下所示：</span></p><pre><code>@RequestMapping("/error/{status}")public String errorPage(@PathVariable Integer status){    switch (status){        case 401:        case 400:return "/error/404";        case 500:return "/error/500";        default:return "/error/default";    }}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">那么原理呢？</span></p><h1 class=pgc-h-arrow-right><strong><span style="color:#35b378;--tt-darkmode-color: #35B378">【2】原理讲解</span></strong></h1><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">① 启动SpringBoot,注册错误页面</span></h1><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">如下图所示，启动项目时候</span><span style="color:#4d4d4d;--tt-darkmode-color: #999999">再</span><span style="color:#4d4d4d;--tt-darkmode-color: #999999">onRefresh方法中会创建一个WebServer，继而获取ServletWebServerFactory。<br></span></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/91eddc54888145afbe81dd38af9f57ad><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">1.1AbstractAutowireCapableBeanFactory.applyBeanPostProcessorsBeforeInitialization</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">在创建bean-tomcatServletWebServerFactory时会调用AbstractAutowireCapableBeanFactory.applyBeanPostProcessorsBeforeInitialization,如下所示：</span></p><pre><code>@Overridepublic Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName) throws BeansException {Object result = existingBean;for (BeanPostProcessor processor : getBeanPostProcessors()) { Object current = processor.postProcessBeforeInitialization(result, beanName); if (current == null) {  return result; } result = current;}return result;}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">该方法会获取bean后置处理器，然后循环遍历调用每个bean后置处理器的postProcessBeforeInitialization方法。</span></p><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">1.2 ErrorPageRegistrarBeanPostProcessor.postProcessBeforeInitialization</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">当遍历到ErrorPageRegistrarBeanPostProcessor时会调用其postProcessBeforeInitialization方法，方法源码如下所示：</span></p><pre><code>@Overridepublic Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException { if (bean instanceof ErrorPageRegistry) {  postProcessBeforeInitialization((ErrorPageRegistry) bean); } return bean;}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">方法会判断当前bean是否ErrorPageRegistry类型，如果是，则调用postProcessBeforeInitialization方法，源码如下所示：</span></p><pre><code>private void postProcessBeforeInitialization(ErrorPageRegistry registry) { for (ErrorPageRegistrar registrar : getRegistrars()) {  registrar.registerErrorPages(registry); }}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">该方法会获取Registrars，然后循环遍历调用每一个注册器的registerErrorPages方法。获取注册其源码如下所示：</span></p><pre><code>private Collection&lt;ErrorPageRegistrar&gt; getRegistrars() { if (this.registrars == null) {  // Look up does not include the parent context  this.registrars = new ArrayList&lt;&gt;(    this.beanFactory.getBeansOfType(ErrorPageRegistrar.class, false, false).values());  this.registrars.sort(AnnotationAwareOrderComparator.INSTANCE);  this.registrars = Collections.unmodifiableList(this.registrars); } return this.registrars;}</code></pre><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">故而，当我们的ErrorPageConfig 实现了ErrorPageRegistrar时，会被检测到并执行registerErrorPages方法。<br></span></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f2acf0716f764b8588ed95460a50b43c><p class=pgc-img-caption></p></div><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999"><br></span></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ebf0d787620348d5bf6f47723bec3562><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">② 把错误页面放到StandardContext.errorPageSupport中</span></h1><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">StandardContext是什么？我们可以看下如下类继承示意图。<br></span></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c5efd62c68654576a57ee060423d7563><p class=pgc-img-caption></p></div><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">在①中我们提到会注册错误页面</span><span style="color:#c7254e;--tt-darkmode-color: #C7254E"><span style="background-color:#f9f2f4;--tt-darkmode-bgcolor: #C2BCBE">registrar.registerErrorPages(registry);</span></span>，如下图所示此时的registry为TomcatServletWebServerFactory：<br></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fe9984a0acf0444cbe00df175cb42deb><p class=pgc-img-caption></p></div><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">我们再来看下TomcatServletWebServerFactory继承示意图(可以看到其父类AbstractConfigurableWebServerFactory实现了ErrorPageRegistry接口)：<br></span></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/18765abf12a345fd8f6acb028b97ffb7><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">2.1 AbstractConfigurableWebServerFactory.addErrorPages</span></h1><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">方法源码如下：</span></p><pre><code>@Overridepublic void addErrorPages(ErrorPage... errorPages) { Assert.notNull(errorPages, "ErrorPages must not be null"); this.errorPages.addAll(Arrays.asList(errorPages));}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">也就说错误页面现在被放到了属性</span><span style="color:#c7254e;--tt-darkmode-color: #C7254E"><span style="background-color:#f9f2f4;--tt-darkmode-bgcolor: #C2BCBE">private Set&lt;ErrorPage> errorPages = new LinkedHashSet&lt;>();</span></span>中。</p><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">2.2 TomcatServletWebServerFactory.configureContext</span></h1><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">创建完TomcatServletWebServerFactory后会调用configureContext方法，如下图所示：<br></span></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9f92456aaf744aa0937c33a86fd06f64><p class=pgc-img-caption></p></div><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999"><br>在configureContext方法中会获取错误页面然后逐个调用StandardContext.addErrorPage方法添加到其</span><span style="color:#c7254e;--tt-darkmode-color: #C7254E"><span style="background-color:#f9f2f4;--tt-darkmode-bgcolor: #C2BCBE">ErrorPageSupport errorPageSupport</span></span>中。</p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">configureContext方法中遍历错误页面如下所示：</span></p><pre><code>for (ErrorPage errorPage : getErrorPages()) { org.apache.tomcat.util.descriptor.web.ErrorPage tomcatErrorPage = new org.apache.tomcat.util.descriptor.web.ErrorPage(); tomcatErrorPage.setLocation(errorPage.getPath()); tomcatErrorPage.setErrorCode(errorPage.getStatusCode()); tomcatErrorPage.setExceptionType(errorPage.getExceptionName()); context.addErrorPage(tomcatErrorPage);}</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">StandardContext.addErrorPage方法源码如下所示：</span></p><pre><code>@Override public void addErrorPage(ErrorPage errorPage) {     // Validate the input parameters     if (errorPage == null)         throw new IllegalArgumentException             (sm.getString("standardContext.errorPage.required"));     String location = errorPage.getLocation();     if ((location != null) &amp;&amp; !location.startsWith("/")) {         if (isServlet22()) {             if(log.isDebugEnabled())                 log.debug(sm.getString("standardContext.errorPage.warning",                              location));             errorPage.setLocation("/" + location);         } else {             throw new IllegalArgumentException                 (sm.getString("standardContext.errorPage.error",                               location));         }     }//调用errorPageSupport.add     errorPageSupport.add(errorPage);     fireContainerEvent("addErrorPage", errorPage); }</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">ErrorPageSupport.add方法如下所示：</span></p><pre><code>public void add(ErrorPage errorPage) {     String exceptionType = errorPage.getExceptionType();     if (exceptionType == null) {         statusPages.put(Integer.valueOf(errorPage.getErrorCode()), errorPage);     } else {         exceptionPages.put(exceptionType, errorPage);     } }</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">通过该方法可以看到，不止可以通过HTTP状态码定义错误页面，还可以通过异常类型进行定义。</span></p><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">那么ErrorPageSupport、statusPages、exceptionPages分别是什么呢？我们看下图示意：<br></span></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/565704a33eed4c588ee4c4970d8779f4><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><span style="color:#4f4f4f;--tt-darkmode-color: #979797">③ 错误页面如何被用到</span></h1><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999">在ResourceHttpRequestHandler.handleRequest方法处理请求时，找不到资源会调用</span><span style="color:#c7254e;--tt-darkmode-color: #C7254E"><span style="background-color:#f9f2f4;--tt-darkmode-bgcolor: #C2BCBE">response.sendError</span></span>方法：<br></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3796e031aa06495693df31eb1b1778c1><p class=pgc-img-caption></p></div><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999"><br>这里只需要关注这一点，无需关注细节，我们继续往下走。。。。一直走到StandardHostValve.status方法。</span></p><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">StandardHostValve.status中会对响应状态码进行处理。</span></p><pre><code>private void status(Request request, Response response) {     int statusCode = response.getStatus();     // Handle a custom error page for this status code     Context context = request.getContext();     if (context == null) {         return;     }     /* Only look for error pages when isError() is set.      * isError() is set when response.sendError() is invoked. This      * allows custom error pages without relying on default from      * web.xml.      */     if (!response.isError()) {         return;     }//这里会从errorPageSupport.find(errorCode)获取到错误页//根据错误码，比如404从statusPages获取对应的ErrorPage对象     ErrorPage errorPage = context.findErrorPage(statusCode);     if (errorPage == null) {         // Look for a default error page         errorPage = context.findErrorPage(0);     }     if (errorPage != null &amp;&amp; response.isErrorReportRequired()) {         response.setAppCommitted(false);         request.setAttribute(RequestDispatcher.ERROR_STATUS_CODE,                           Integer.valueOf(statusCode));         String message = response.getMessage();         if (message == null) {             message = "";         }         request.setAttribute(RequestDispatcher.ERROR_MESSAGE, message);         request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,                 errorPage.getLocation());         request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,                 DispatcherType.ERROR);         Wrapper wrapper = request.getWrapper();         if (wrapper != null) {             request.setAttribute(RequestDispatcher.ERROR_SERVLET_NAME,                               wrapper.getName());         }         request.setAttribute(RequestDispatcher.ERROR_REQUEST_URI,                              request.getRequestURI());                              //这里很重要，将会尝试跳转到我们自定义错误请求页面         if (custom(request, response, errorPage)) {             response.setErrorReported();             try {                 response.finishResponse();             } catch (ClientAbortException e) {                 // Ignore             } catch (IOException e) {                 container.getLogger().warn("Exception Processing " + errorPage, e);             }         }     } }</code></pre><p style=text-align:start><span style="color:#4d4d4d;--tt-darkmode-color: #999999">如下图所示，在StandardHostValve.custom方法中将会调用ApplicationDispatcher.forwar进行请求转发。</span></p><div class=pgc-img><img alt=SpringBoot自定义错误页面 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/08876ba39cb343c887a38c5e6436d34e><p class=pgc-img-caption></p></div><p style=text-align:justify><br></p><p style=text-align:justify>版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。</p><p style=text-align:justify>本文链接：</p><p style=text-align:justify>https://blog.csdn.net/j080624/article/details/109197726</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'SpringBoot','义错','误页'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>