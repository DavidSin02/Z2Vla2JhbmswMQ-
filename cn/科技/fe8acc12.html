<!doctype html><html lang=cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>渗透人员福利：曝光黑客构造GIF动图邪恶链接攻击全过程 | 极客快訊</title><meta property="og:title" content="渗透人员福利：曝光黑客构造GIF动图邪恶链接攻击全过程 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="cn"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/408c6eaf305c4dde9460074bede9a7af"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fe8acc12.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fe8acc12.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fe8acc12.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fe8acc12.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fe8acc12.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fe8acc12.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fe8acc12.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fe8acc12.html><meta property="article:published_time" content="2020-11-14T21:00:28+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:28+08:00"><meta name=Keywords content><meta name=description content="渗透人员福利：曝光黑客构造GIF动图邪恶链接攻击全过程"><meta name=author content="极客快訊"><meta property="og:url" content="/cn/%E7%A7%91%E6%8A%80/fe8acc12.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快讯 Geek Bank</a></h1><p class=description>为你带来最全的科技知识 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>渗透人员福利：曝光黑客构造GIF动图邪恶链接攻击全过程</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=cn/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><br></p><div class=pgc-img><img alt=渗透人员福利：曝光黑客构造GIF动图邪恶链接攻击全过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/408c6eaf305c4dde9460074bede9a7af><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>域名劫持</h1><p>有了"authtoken"和"skypetoken"后，就能通过Teams API接口发起API请求，实现消息发送、读取，创建群组、添加移除新用户或更改群组用户权限等。但还需要一个条件，由于"authtoken"和"skypetoken"只会发送到teams.microsoft.com和其相关的域名中，所以，成功的利用条件是teams.microsoft.com和其相关子域名存在域名劫持。恰巧的是，经过测试，我们发现以下两个teams.microsoft.com的子域名存在可劫持漏洞：</p><blockquote class=pgc-blockquote-abstract><p>aadsync-test.teams.microsoft.com</p><p>data-dev.teams.microsoft.com</p></blockquote><p>如果攻击者劫持了上述两个域名，就能窃取到受害者发往Microsoft Teams服务端的cookie，然后通过其中的"authtoken"生成"skypetoken"，就能对受害者账户数据的窃取。但该利用中还存在：</p><blockquote class=pgc-blockquote-abstract><p>1、攻击者需要为上述可被劫持的子域名发布一个证书，因为"authtoken"被标记为了secure，只能通过https通道传递。但对于攻击者来说，这并不算是一个问题，因为域名已经可以劫持了，只要能上传相应文件到指定的路径下，证书颁布机构即能发布有效证书；</p><p>2、如何利用该漏洞方法实现Microsoft Teams账户劫持，如果可能的话，最好不要用恶意链接的方式，因为这种方法已经被用烂了，稍微有点安全意识的人都不会上当。</p></blockquote><p>为此，我们设计了一种不一样的手法。</p><h1 class=pgc-h-arrow-right>构造邪恶的GIF</h1><p>如前所述，Microsoft Teams在跨域的Teams和Skype账户中进行图片分享或浏览时，用"authtoken" 来验证用户身份然后加载图片，因此，我们可以通过Microsoft Teams群聊，向受害者发送一张"src"属性指向上述两个可被劫持的子域名的图片，当受害者打开该图片后，其浏览器就会向攻击者劫持的子域名发送包括"authtoken"的Cookie。</p><p>这样一来，攻击者就能获取受害者的"authtoken"，然后生成"skypetoken"，进而窃取到受害者的所有数据信息。</p><div class=pgc-img><img alt=渗透人员福利：曝光黑客构造GIF动图邪恶链接攻击全过程 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5f90d4e70fcf44d9942da8b957c36ac6><p class=pgc-img-caption></p></div><p>攻击就是如下这么简单：受害者只需在Microsoft Teams账户中浏览一张正常的GIF，即可中招！子域名劫持+Cookie窃取=账户劫持。虽然这种攻击场景大多限于内部，但也会引入外部因素，如邀请第三方人员或局外人加入视频会议等。</p><div class=pgc-img><img alt=渗透人员福利：曝光黑客构造GIF动图邪恶链接攻击全过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b189ab76fe0243639f852f34e83ea46c><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>形成类似蠕虫的攻击利用（Worm-like Vulnerability）</h1><p>该漏洞利用最大最可怕的一点就在于能在群组中广泛传播，类似蠕虫一样，受害者看到的是一张经过构造的正常图片，每个受害者账户都会称为一个扩散点，影响所有群组用户，并且，这种图片分享传播也有可能被传播给其它公司群组，形成更快更有效的攻击步骤。POC视频参考：</p><p><u>https://www.cyberark.com/threat-research-blog/beware-of-the-gif-account-takeover-vulnerability-in-microsoft-teams/</u></p><p>除此之外，我们还写了一个脚本，可以跑出受害者的所有会话信息并保存在本地，如下图所示：</p><div class=pgc-img><img alt=渗透人员福利：曝光黑客构造GIF动图邪恶链接攻击全过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4b154b812c8340c1a5505eff47d991c9><p class=pgc-img-caption></p></div><p>CyberArk发现了该漏洞，影响范围波及客户端和网页版的app用户。该团队发现该漏洞后在3月23日报送给微软，微软在4月20日发布的更新中修复了该漏洞。</p><p>从CyberArk安全人员Omer Tsarfati可以得知，一旦黑客给目标对象发送GIF恶意图像，那么他们就可以接管用户账号，获取机密信息、会议行程、竞争数据、密码、隐私、商业计划等等。</p><p>Microsoft Teams是类似Zoom的一款视频会议软件，在COVID19期间也是见证了用户视频使用需求的崛起，世界范围的企业、学生、政府雇员都必须使用视频会议软件来进行工作和社交。</p><h1 class=pgc-h-arrow-right>的域名接管漏洞</h1><p>该漏洞是在Microsoft Teams处理图像资源身份验证方式时出现的。每次打开应用程序时，都会在此过程中创建访问令牌，JSON Web令牌（JWT），从而使用户可以查看个人或其他人在对话中共享的图像。该令牌也成为"skype令牌"，即" skypetoken_asm"的cookie，这不仅仅限于访问图像，还有其他用途。</p><p>Teams使用多个API端点与服务进行通信，并将用户操作发送到相关API端点，此时则需要进行身份验证来匹配操作和用户身份。常用方式是发送访问令牌，而Teams在图像方面出现问题。比如用户身份验证不是基于Cookie，加载图像则比身份验证更为复杂。</p><p>为了解决此问题，有一种方法可以使用JavaScript代码作为Blob提取图像内容，然后将IMG标签的src属性设置为创建的Blob。在某些情况下，Teams使用浏览器的常规资源加载，这意味着Teams只是将URI的" src"属性设置为HTML IMG标签</p><blockquote class=pgc-blockquote-abstract><p>&lt;img ng-show ="！giphyCtrl.playVideo" ng-src ="</p><p>https://media2.giphy.com/media/gB4KWtd3uSsJq/giphy.GIF" height =" 240" width ="</p><p>480" load-image-handler src ="</p><p>https://media2.giphy.com/media/gB4KWtd3uSsJq/giphy.GIF"></p></blockquote><p>为了限制访问权限，微软又建立了一个名为" authtoken"和" skypetoken_asm"的cookie。</p><p>这就是问题所在，研究人员能够获得一个authtoken cookie，该cookie授予对资源服务器（api.spaces.skype.com）的访问权限，并使用它来创建上述的" skype令牌"，因此他们具有很大的不受限制的权限，可以发送消息、阅读消息、创建群组、添加新用户或从群组中删除用户，甚至通过Teams API更改群组中的权限。</p><p>由于authtoken cookie设置为发送到team.microsoft.team或其任何子域，因此研究人员发现了两个容易受到攻击的子域（aadsync-test.teams.microsoft.com和data-dev.teams.microsoft.com），这两个子域容易发生接管攻击。</p><p>研究人员说："如果攻击者以某种方式迫使用户访问已被接管的子域，则受害者的浏览器会将此Cookie发送到攻击者的服务器，并且攻击者（在收到authtoken之后）可以创建一个Skype令牌。完成所有这些操作后，攻击者可以窃取受害者团队的账户数据。"</p><div class=pgc-img><img alt=渗透人员福利：曝光黑客构造GIF动图邪恶链接攻击全过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/670ce29b15394d5380833558b10c7dd3><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>GIF恶意图像载入</h1><p>Teams设置" authtoken" cookie的原因是对用户进行身份验证，方便在Teams和Skype的域中加载图像。现在，攻击者感染子域，可以利用这个漏洞发送恶意GIF图片给群聊成员或者特定用户，当用户查看时，浏览器会尝试加载图像，并将authtoken cookie发送到受感染的子域。</p><div class=pgc-img><img alt=渗透人员福利：曝光黑客构造GIF动图邪恶链接攻击全过程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6465b484f0bd4ec2a8fb62d2845b0348><p class=pgc-img-caption></p></div><p>然后，攻击者可以使用此authtoken cookie创建一个Skype令牌，从而访问所有受害者的数据。只要交互涉及聊天界面，例如邀请电话会议进行潜在的工作面试，任何人都可以发起攻击。</p><blockquote class=pgc-blockquote-abstract><p>受害者永远不会知道自己受到了攻击，这使得利用此漏洞变得隐秘而危险。</p></blockquote><p>利用该漏洞最可怕之处在于其会自动传播，类似蠕虫病毒。</p><p>在COVID19这个特殊时期，基于环境的变化，全球用户对视频会议软件需求激增，不管上文所述的Teams GIF入侵也好，还是前段时间引发热议的"Zoom轰炸"也好，视频会议软件也开始是黑客发动攻击青睐的对象。</p><p>因此，企业也要更加防范这个领域可能遭受的风险，比如网络监听、服务器或流量攻击、身份冒充、会议内容数据窃取或篡改等。</p><h1 class=pgc-h-arrow-right>最后</h1><p>so 2020.4.20 微软释放补丁 over。。。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>'渗透','人员','构造'</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-146415161-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>