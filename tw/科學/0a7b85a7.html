<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Linuxå…§æ ¸å­¸ç¿’014â€”â€”é€²ç¨‹èª¿åº¦(ä¸‰) | æå®¢å¿«è¨Š</title><meta property="og:title" content="Linuxå…§æ ¸å­¸ç¿’014â€”â€”é€²ç¨‹èª¿åº¦(ä¸‰) - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/dfic-imagehandler/955a771b-0d01-4f97-8b1f-8575d578bd06"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/0a7b85a7.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/0a7b85a7.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/0a7b85a7.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/0a7b85a7.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/0a7b85a7.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/0a7b85a7.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/0a7b85a7.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/0a7b85a7.html><meta property="article:published_time" content="2020-11-14T20:53:31+08:00"><meta property="article:modified_time" content="2020-11-14T20:53:31+08:00"><meta name=Keywords content><meta name=description content="Linuxå…§æ ¸å­¸ç¿’014â€”â€”é€²ç¨‹èª¿åº¦(ä¸‰)"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E5%AD%B8/0a7b85a7.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Linuxå…§æ ¸å­¸ç¿’014â€”â€”é€²ç¨‹èª¿åº¦(ä¸‰)</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E5%AD%B8.html>ç§‘å­¸</a></span></div><div class=post-content><p><br></p><div class=pgc-img><img alt=Linuxå…§æ ¸å­¸ç¿’014â€”â€”é€²ç¨‹èª¿åº¦(ä¸‰) onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/955a771b-0d01-4f97-8b1f-8575d578bd06><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right>Linuxèª¿åº¦ç®—æ³•</h1><p>åœ¨Linuxä¸­ï¼Œèª¿åº¦å™¨æ˜¯ä»¥æ¨¡å¡Šæ–¹å¼æä¾›çš„ï¼Œé€™æ¨£å¯ä»¥å…è¨±ä¸åŒé¡å‹çš„é€²ç¨‹æœ‰é‡å°æ€§åœ°é¸æ“‡èª¿åº¦ç®—æ³•ã€‚é€™ç¨®æ¨¡å¡ŠåŒ–çµæ§‹ç¨±ç‚ºèª¿åº¦å™¨é¡ï¼Œå…¶å…è¨±å¤šç¨®ä¸åŒçš„å¯å‹•æ…‹æ·»åŠ çš„èª¿åº¦ç®—æ³•ä¸¦å­˜ï¼Œèª¿åº¦å±¬æ–¼è‡ªå·±ç¯„ç–‡çš„é€²ç¨‹ã€‚æ¯å€‹èª¿åº¦å™¨æœ‰ä¸€å€‹å„ªå…ˆç´šï¼ŒåŸºç¤èª¿åº¦å™¨æœƒä¾å„ªå…ˆç´šéæ­·èª¿åº¦é¡ï¼Œæ“æœ‰æœ€é«˜å„ªå…ˆç´šçš„èª¿åº¦å™¨é¡é¸æ“‡å°‡è¦åŸ·è¡Œçš„ç¨‹åºã€‚</p><p>CFSå°±æ˜¯ä¸€å€‹èª¿åº¦å™¨é¡ï¼Œåœ¨Linuxä¸­ç¨±ç‚ºSCHED_NORMALï¼Œå…¶å…·é«”å®šç¾©åœ¨Linux2.6.34/kernel/sched_fair.cä¸­ã€‚</p><p>CFSçš„ç†å¿µå¾ˆç°¡å–®ï¼šé€²ç¨‹èª¿åº¦çš„æ•ˆæœæ‡‰å¦‚åŒç³»çµ±å…·å‚™ä¸€å€‹ç†æƒ³ä¸­çš„å®Œç¾å¤šä»»å‹™è™•ç†å™¨ã€‚å³æ¯å€‹é€²ç¨‹å¯ç²å¾—1/nçš„è™•ç†å™¨æ™‚é–“(nç‚ºå¯é‹è¡Œçš„é€²ç¨‹æ•¸é‡)ã€‚ä½†æ˜¯ï¼Œç”±æ–¼èª¿åº¦æ™‚é€²ç¨‹æ¶ä½”çš„é–‹éŠ·ï¼Œæ¯”å¦‚ï¼šé€²ç¨‹æ›å…¥ã€é€²ç¨‹æ›å‡ºã€ç·©å­˜å½±éŸ¿ç­‰ï¼Œç†æƒ³æ¨¡å‹æ˜¯ç„¡æ³•å¯¦ç¾çš„ã€‚å› æ­¤ï¼ŒCFSå……åˆ†è€ƒæ…®äº†é¡å¤–é–‹éŠ·ï¼Œç¢ºä¿äº†ç³»çµ±æ€§èƒ½ä¸å—å½±éŸ¿ã€‚CFSçš„åšæ³•æ˜¯ï¼šå…è¨±æ¯å€‹é€²ç¨‹é‹è¡Œä¸€æ®µæ™‚é–“ï¼Œå¾ªç’°è¼ªè½‰ï¼Œé¸æ“‡é‹è¡Œæœ€å°‘çš„é€²ç¨‹ä½œç‚ºä¸‹ä¸€å€‹é‹è¡Œé€²ç¨‹ï¼Œè€Œä¸æ˜¯åˆ†é…æ¯å€‹é€²ç¨‹ä»¥æ™‚é–“ç‰‡ã€‚niceå€¼åœ¨CFSä¸­è¢«ä½œç‚ºé€²ç¨‹ç²å¾—è™•ç†å™¨é‹è¡Œæ¯”å¾—æ¬Šé‡(é«˜niceå€¼ï¼Œä½å„ªå…ˆç´šï¼Œä½è™•ç†å™¨ä½¿ç”¨æ¬Šé‡)ã€‚ç•¶å¯é‹è¡Œé€²ç¨‹æ•¸é‡éå¤šæ™‚ï¼Œå®ƒå€‘å„è‡ªæ‰€ç²å¾—çš„è™•ç†å™¨ä½¿ç”¨æ¯”å’Œæ™‚é–“ç‰‡éƒ½è¶¨æ–¼0ï¼ŒCFSç‚ºæ­¤è¨­ç«‹äº†æœ€å°ç²’åº¦ï¼Œé»˜èªå€¼ç‚º1msã€‚</p><p>ç¸½çµï¼šä»»ä½•é€²ç¨‹æ‰€ç²å¾—çš„è™•ç†å™¨æ™‚é–“æ˜¯ç”±å®ƒè‡ªå·±å’Œå…¶ä»–æ‰€æœ‰å¯é‹è¡Œé€²ç¨‹niceå€¼çš„ç›¸å°æ¯”ä¾‹æ±ºå®šçš„ã€‚</p><h1 class=pgc-h-arrow-right>Linuxèª¿åº¦çš„å¯¦ç¾</h1><p>CFSå…·é«”å¯¦ç¾ä½æ–¼kernel/schde_fair.cï¼Œå…¶ä¸­éœ€è¦é‡é»é—œæ³¨çš„æ˜¯å››å€‹çµ„æˆéƒ¨åˆ†ï¼š</p><ol start=1><li>æ™‚é–“è¨˜è³¬</li><li>é€²ç¨‹é¸æ“‡</li><li>èª¿åº¦å™¨å…¥å£</li><li>ç¡çœ å’Œå–šé†’</li></ol><h1 class=pgc-h-arrow-right>æ™‚é–“è¨˜è³¬</h1><p>é¡¯ç„¶ï¼Œæ‰€æœ‰çš„èª¿åº¦å™¨éƒ½å¿…é ˆè¨˜éŒ„é€²ç¨‹çš„é‹è¡Œæ™‚é–“ã€‚CFSä¸­ä½¿ç”¨ä¸€å€‹çµæ§‹é«”sched_entityä¾†è¨˜éŒ„é€²ç¨‹é‹è¡Œä¿¡æ¯ï¼Œå…¶å®šç¾©åœ¨Linux2.6.34/include/linux/sched.h#L1090ï¼š</p><pre><code>/* * CFS stats for a schedulable entity (task, task-group etc) * * Current field usage histogram: * *     4 se-&gt;block_start *     4 se-&gt;run_node *     4 se-&gt;sleep_start *     6 se-&gt;load.weight */struct sched_entity {    struct load_weight  load;       /* for load-balancing */    struct rb_node      run_node;    struct list_head    group_node;    unsigned int        on_rq;    u64         exec_start;    u64         sum_exec_runtime;    u64         vruntime;    u64         prev_sum_exec_runtime;    u64         last_wakeup;    u64         avg_overlap;    u64         nr_migrations;    u64         start_runtime;    u64         avg_wakeup;#ifdef CONFIG_SCHEDSTATS    u64         wait_start;    u64         wait_max;    u64         wait_count;    u64         wait_sum;    u64         iowait_count;    u64         iowait_sum;    u64         sleep_start;    u64         sleep_max;    s64         sum_sleep_runtime;    u64         block_start;    u64         block_max;    u64         exec_max;    u64         slice_max;    u64         nr_migrations_cold;    u64         nr_failed_migrations_affine;    u64         nr_failed_migrations_running;    u64         nr_failed_migrations_hot;    u64         nr_forced_migrations;    u64         nr_wakeups;    u64         nr_wakeups_sync;    u64         nr_wakeups_migrate;    u64         nr_wakeups_local;    u64         nr_wakeups_remote;    u64         nr_wakeups_affine;    u64         nr_wakeups_affine_attempts;    u64         nr_wakeups_passive;    u64         nr_wakeups_idle;#endif#ifdef CONFIG_FAIR_GROUP_SCHED    struct sched_entity *parent;    /* rq on which this entity is (to be) queued: */    struct cfs_rq       *cfs_rq;    /* rq "owned" by this entity/group: */    struct cfs_rq       *my_q;#endif};</code></pre><p>ä¸‹åŠéƒ¨åˆ†çš„æˆå“¡è®Šé‡éœ€è¦è¨­ç½®äº†CONFIG_SCHEDSTATSå’ŒCONFIG_FAIR_GROUP_SCHEDæ™‚æ‰æœƒå•Ÿç”¨ï¼Œé‡é»é—œæ³¨å‰åŠéƒ¨åˆ†å³å¯ã€‚</p><p>èª¿åº¦å™¨å¯¦é«”çµæ§‹æ˜¯ä½œç‚ºä¸€å€‹åç‚ºseçš„æˆå“¡è®Šé‡ï¼ŒåµŒå…¥åœ¨é€²ç¨‹æè¿°ç¬¦struct task_structä¸­çš„ã€‚</p><div class=pgc-img><img alt=Linuxå…§æ ¸å­¸ç¿’014â€”â€”é€²ç¨‹èª¿åº¦(ä¸‰) onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4ddbf236434348f2bad9b0d6e701eb41><p class=pgc-img-caption></p></div><p>2019-02-10_203619.png</p><p><strong>è™›æ“¬å¯¦æ™‚</strong></p><p>sched_entityä¸­çš„u64 vruntimeæˆå“¡è¨˜éŒ„é€²ç¨‹çš„è™›æ“¬é‹è¡Œæ™‚é–“ï¼Œå–®ä½ç‚ºnsã€‚CFSä½¿ç”¨vruntimeè®Šé‡ä¾†è¨˜éŒ„ä¸€å€‹ç¨‹åºé‹è¡Œäº†å¤šä¹…ä»¥åŠé‚„èƒ½é‹è¡Œå¤šä¹…ï¼Œå®šç¾©åœ¨Linux2.6.34/kernel/sched_fair.c#L518çš„å‡½æ•¸update_currå¯¦ç¾äº†è©²è¨˜è³¬åŠŸèƒ½ï¼š</p><pre><code>static void update_curr(struct cfs_rq *cfs_rq){    struct sched_entity *curr = cfs_rq-&gt;curr;    u64 now = rq_of(cfs_rq)-&gt;clock;    unsigned long delta_exec;    if (unlikely(!curr))        return;    /*     * Get the amount of time the current task was running     * since the last time we changed load (this cannot     * overflow on 32 bits):     */    delta_exec = (unsigned long)(now - curr-&gt;exec_start);    if (!delta_exec)        return;    __update_curr(cfs_rq, curr, delta_exec);    curr-&gt;exec_start = now;    if (entity_is_task(curr)) {        struct task_struct *curtask = task_of(curr);        trace_sched_stat_runtime(curtask, delta_exec, curr-&gt;vruntime);        cpuacct_charge(curtask, delta_exec);        account_group_exec_runtime(curtask, delta_exec);    }}</code></pre><p>update_curr()è¨ˆç®—äº†ç•¶å‰é€²ç¨‹çš„åŸ·è¡Œæ™‚é–“ï¼Œä¸¦å°‡å…¶å­˜æ”¾åœ¨è®Šé‡delta_execç¸½ï¼Œç„¶å¾Œå°‡èˆ‡é‹è¡Œæ™‚é–“å‚³éçµ¦__update_curr()ï¼Œç”±å…¶æ ¹æ“šç•¶å‰å¯é‹è¡Œé€²ç¨‹ç¸½æ•¸å°é‹è¡Œæ™‚é–“é€²è¡ŒåŠ æ¬Šè¨ˆç®—ï¼Œæœ€çµ‚å°‡æ¬Šé‡å€¼èˆ‡ç•¶å‰é€²ç¨‹çš„vruntimeç›¸åŠ ã€‚</p><p>æ³¨ï¼š__update_curr()å‡½æ•¸å®šç¾©åœ¨update_curr()å‡½æ•¸ä¸Šæ–¹</p><pre><code>/* * Update the current task's runtime statistics. Skip current tasks that * are not in our scheduling class. */static inline void__update_curr(struct cfs_rq *cfs_rq, struct sched_entity *curr,          unsigned long delta_exec){    unsigned long delta_exec_weighted;    schedstat_set(curr-&gt;exec_max, max((u64)delta_exec, curr-&gt;exec_max));    curr-&gt;sum_exec_runtime += delta_exec;    schedstat_add(cfs_rq, exec_clock, delta_exec);    delta_exec_weighted = calc_delta_fair(delta_exec, curr);    curr-&gt;vruntime += delta_exec_weighted;    update_min_vruntime(cfs_rq);}</code></pre><p>update_curr()æ˜¯ç”±ç³»çµ±å®šæ™‚å™¨é€±æœŸæ€§èª¿ç”¨çš„ï¼Œå› æ­¤vruntimeå¯ä»¥æº–ç¢ºåœ°æ¸¬é‡çµ¦å®šé€²ç¨‹çš„é‹è¡Œæ™‚é–“ï¼Œä¸”å¯ä»¥çŸ¥é“ä¸‹ä¸€é¡é‹è¡Œçš„é€²ç¨‹ã€‚</p><h1 class=pgc-h-arrow-right>é€²ç¨‹é¸æ“‡</h1><p>CFSéœ€è¦é¸æ“‡ä¸‹ä¸€å€‹é€²ç¨‹é‹è¡Œæ™‚ï¼Œå®ƒæœƒæŒ‘é¸ä¸€å€‹å…·æœ‰æœ€å°vruntimeçš„é€²ç¨‹ã€‚CFSä½¿ç”¨äº†ç´…é»‘æ¨¹ä¾†çµ„ç¹”å¯é‹è¡Œé€²ç¨‹éšŠåˆ—ï¼Œé—œæ–¼ç´…é»‘æ¨¹å¯ä»¥åƒè€ƒé€™ç¯‡æ–‡ç« ã€‚ç´…é»‘æ¨¹æ˜¯ä¸€å€‹è‡ªå¹³è¡¡äºŒå‰æœç´¢æ¨¹ï¼Œä»¥æ¨¹ç¯€é»å½¢å¼å­˜å„²æ•¸æ“šï¼Œé€™äº›æ•¸æ“šå°æ‡‰ä¸€å€‹éµå€¼ï¼Œå¯é€šééµå€¼å¿«é€Ÿæª¢ç´¢ç¯€é»ä¸Šçš„æ•¸æ“šã€‚</p><p>å‡è¨­å­˜åœ¨ä¸€å€‹ç´…é»‘æ¨¹å­˜å„²äº†ç³»çµ±ä¸­æ‰€æœ‰çš„å¯é‹è¡Œé€²ç¨‹ï¼Œå…¶ä¸­çš„ç¯€é»éµå€¼ç‚ºå¯é‹è¡Œé€²ç¨‹çš„è™›æ“¬é‹è¡Œæ™‚é–“ã€‚CFSé¸æ“‡vruntimeæœ€å°çš„ï¼Œå³æ¨¹ä¸­æœ€å·¦å´çš„è‘‰å­ç¯€é»ï¼Œå¯ä»¥å¾æ¨¹çš„æ ¹ç¯€é»ä¸€ç›´æ²¿å·¦å´å­ç¯€é»å‘ä¸‹æ‰¾ç›´åˆ°è‘‰å­ç¯€é»ã€‚å¯¦ç¾è©²éç¨‹çš„å‡½æ•¸ç‚º__pick_next_entity()ï¼Œå…¶å®šç¾©åœ¨Linux2.6.34/source/kernel/sched_fair.c#L377ã€‚</p><pre><code>static struct sched_entity *__pick_next_entity(struct cfs_rq *cfs_rq){    struct rb_node *left = cfs_rq-&gt;rb_leftmost;    if (!left)        return NULL;    return rb_entry(left, struct sched_entity, run_node);}</code></pre><p>æ³¨ï¼šå…¶å¯¦__pick_next_entity()å‡½æ•¸æœ¬èº«ä¸¦ä¸æœƒéæ­·æ¨¹æ‰¾åˆ°æœ€å·¦å­ç¯€é»ï¼Œå› ç‚ºè©²å€¼å·²ç¶“ç·©å­˜åœ¨rb_leftmostä¸­äº†ã€‚</p><p><strong>åŠ å…¥é€²ç¨‹</strong></p><p>CFSå…ˆrbtree(ç´…é»‘æ¨¹)ä¸­åŠ å…¥å¯åŸ·è¡Œé€²ç¨‹ç™¼ç”Ÿåœ¨é€²ç¨‹è®Šç‚ºå¯åŸ·è¡Œç‹€æ…‹æˆ–è€…æ˜¯é€šéfork()èª¿ç”¨ç¬¬ä¸€æ¬¡å‰µå»ºé€²ç¨‹æ˜¯ï¼Œenqueue_entity()å‡½æ•¸å¯¦ç¾äº†è©²éç¨‹ï¼š</p><pre><code>static voidenqueue_entity(struct cfs_rq *cfs_rq, struct sched_entity *se, int flags){    /*     * Update the normalized vruntime before updating min_vruntime     * through callig update_curr().     */    if (!(flags &amp; ENQUEUE_WAKEUP) || (flags &amp; ENQUEUE_MIGRATE))        se-&gt;vruntime += cfs_rq-&gt;min_vruntime;    /*     * Update run-time statistics of the 'current'.     */    update_curr(cfs_rq);    account_entity_enqueue(cfs_rq, se);    if (flags &amp; ENQUEUE_WAKEUP) {        place_entity(cfs_rq, se, 0);        enqueue_sleeper(cfs_rq, se);    }    update_stats_enqueue(cfs_rq, se);    check_spread(cfs_rq, se);    if (se != cfs_rq-&gt;curr)        __enqueue_entity(cfs_rq, se);}</code></pre><p>è©²å‡½æ•¸æ›´æ–°é‹è¡Œæ™‚é–“å’Œå…¶ä»–ä¸€äº›çµ±è¨ˆæ•¸æ“šï¼Œç„¶å¾Œèª¿ç”¨__enqueue_entity()é€²è¡Œæ’å…¥æ“ä½œï¼š</p><pre><code>/* * Enqueue an entity into the rb-tree: */static void __enqueue_entity(struct cfs_rq *cfs_rq, struct sched_entity *se){    struct rb_node **link = &amp;cfs_rq-&gt;tasks_timeline.rb_node;    struct rb_node *parent = NULL;    struct sched_entity *entry;    s64 key = entity_key(cfs_rq, se);    int leftmost = 1;    /*     * Find the right place in the rbtree:     */    while (*link) {        parent = *link;        entry = rb_entry(parent, struct sched_entity, run_node);        /*         * We dont care about collisions. Nodes with         * the same key stay together.         */        if (key &lt; entity_key(cfs_rq, entry)) {            link = &amp;parent-&gt;rb_left;        } else {            link = &amp;parent-&gt;rb_right;            leftmost = 0;        }    }    /*     * Maintain a cache of leftmost tree entries (it is frequently     * used):     */    if (leftmost)        cfs_rq-&gt;rb_leftmost = &amp;se-&gt;run_node;    rb_link_node(&amp;se-&gt;run_node, parent, link);    rb_insert_color(&amp;se-&gt;run_node, &amp;cfs_rq-&gt;tasks_timeline);}</code></pre><p><strong>åˆªé™¤é€²ç¨‹</strong></p><p>åˆªé™¤é€²ç¨‹ç™¼ç”Ÿåœ¨é€²ç¨‹å µå¡æˆ–è€…çµ‚æ­¢æ™‚ï¼š</p><pre><code>static voiddequeue_entity(struct cfs_rq *cfs_rq, struct sched_entity *se, int sleep){    /*     * Update run-time statistics of the 'current'.     */    update_curr(cfs_rq);    update_stats_dequeue(cfs_rq, se);    if (sleep) {#ifdef CONFIG_SCHEDSTATS        if (entity_is_task(se)) {            struct task_struct *tsk = task_of(se);            if (tsk-&gt;state &amp; TASK_INTERRUPTIBLE)                se-&gt;sleep_start = rq_of(cfs_rq)-&gt;clock;            if (tsk-&gt;state &amp; TASK_UNINTERRUPTIBLE)                se-&gt;block_start = rq_of(cfs_rq)-&gt;clock;        }#endif    }    clear_buddies(cfs_rq, se);    if (se != cfs_rq-&gt;curr)        __dequeue_entity(cfs_rq, se);    account_entity_dequeue(cfs_rq, se);    update_min_vruntime(cfs_rq);    /*     * Normalize the entity after updating the min_vruntime because the     * update can refer to the -&gt;curr item and we need to reflect this     * movement in our normalized position.     */    if (!sleep)        se-&gt;vruntime -= cfs_rq-&gt;min_vruntime;}</code></pre><p>å¯¦éš›åˆªé™¤å·¥ä½œç”±__dequeue_entity()å®Œæˆã€‚</p><pre><code>static void __dequeue_entity(struct cfs_rq *cfs_rq, struct sched_entity *se){    if (cfs_rq-&gt;rb_leftmost == &amp;se-&gt;run_node) {        struct rb_node *next_node;        next_node = rb_next(&amp;se-&gt;run_node);        cfs_rq-&gt;rb_leftmost = next_node;    }    rb_erase(&amp;se-&gt;run_node, &amp;cfs_rq-&gt;tasks_timeline);}</code></pre><h1 class=pgc-h-arrow-right>èª¿åº¦å™¨å…¥å£</h1><p>èª¿åº¦å™¨å…¥å£æ™‚å‡½æ•¸schedule()ï¼Œè©²å‡½æ•¸å®šç¾©åœ¨Linux2.6.34/kernel/sched.c#L3698ä¸­ã€‚schedule()æ™‚å…§æƒ¡åŒ–å…¶ä»–éƒ¨åˆ†èª¿ç”¨é€²ç¨‹èª¿åº¦å™¨çš„å…¥å£ï¼Œå…¶é€šå¸¸å’Œä¸€å€‹å…·é«”çš„èª¿åº¦é¡ç›¸é—œè¯ã€‚</p><pre><code>/* * schedule() is the main scheduler function. */asmlinkage void __sched schedule(void){    struct task_struct *prev, *next;    unsigned long *switch_count;    struct rq *rq;    int cpu;need_resched:    preempt_disable();    cpu = smp_processor_id();    rq = cpu_rq(cpu);    rcu_sched_qs(cpu);    prev = rq-&gt;curr;    switch_count = &amp;prev-&gt;nivcsw;    release_kernel_lock(prev);need_resched_nonpreemptible:    schedule_debug(prev);    if (sched_feat(HRTICK))        hrtick_clear(rq);    raw_spin_lock_irq(&amp;rq-&gt;lock);    update_rq_clock(rq);    clear_tsk_need_resched(prev);    if (prev-&gt;state &amp;&amp; !(preempt_count() &amp; PREEMPT_ACTIVE)) {        if (unlikely(signal_pending_state(prev-&gt;state, prev)))            prev-&gt;state = TASK_RUNNING;        else            deactivate_task(rq, prev, 1);        switch_count = &amp;prev-&gt;nvcsw;    }    pre_schedule(rq, prev);    if (unlikely(!rq-&gt;nr_running))        idle_balance(cpu, rq);    put_prev_task(rq, prev);    next = pick_next_task(rq);    if (likely(prev != next)) {        sched_info_switch(prev, next);        perf_event_task_sched_out(prev, next);        rq-&gt;nr_switches++;        rq-&gt;curr = next;        ++*switch_count;        context_switch(rq, prev, next); /* unlocks the rq */        /*         * the context switch might have flipped the stack from under         * us, hence refresh the local variables.         */        cpu = smp_processor_id();        rq = cpu_rq(cpu);    } else        raw_spin_unlock_irq(&amp;rq-&gt;lock);    post_schedule(rq);    if (unlikely(reacquire_kernel_lock(current) &lt; 0)) {        prev = rq-&gt;curr;        switch_count = &amp;prev-&gt;nivcsw;        goto need_resched_nonpreemptible;    }    preempt_enable_no_resched();    if (need_resched())        goto need_resched;}</code></pre><h1 class=pgc-h-arrow-right>ç¡çœ å’Œå–šé†’</h1><p>ç¡çœ (è¢«é˜»å¡)çš„é€²ç¨‹ç„¡æ³•åŸ·è¡Œï¼ŒåŸå› æ˜¯å…¶åœ¨ç­‰å¾…ä¸€äº›æ™‚é–“ç™¼ç”Ÿï¼Œæ¯”å¦‚ï¼šæ–‡ä»¶I/Oï¼Œç¶²çµ¡è«‹æ±‚ç­‰ã€‚ä¼‘çœ ä¸­çš„é€²ç¨‹æœ‰å…©å€‹ç›¸é—œçš„é€²ç¨‹ç‹€æ…‹ï¼šTASK_INTERRUPTIBLEå’ŒTASK_UNINTERRUPTIBLEã€‚å€åˆ¥åœ¨æ–¼è™•æ–¼TASK_UNINTERRUPTIBLEçš„é€²ç¨‹æœƒå¿½ç•¥ä¿¡è™Ÿï¼Œè€Œè™•æ–¼TASK_INTERRUPTIBLEçš„é€²ç¨‹æœƒè¢«ä¿¡è™Ÿå–šé†’ä¸¦éŸ¿æ‡‰ä¿¡è™Ÿã€‚æ­¤å¤–ï¼Œå…©ç¨®ç‹€æ…‹çš„é€²ç¨‹éƒ½ä½æ–¼ä¸€å€‹ç­‰å¾…éšŠåˆ—ä¸Šç­‰å¾…äº‹ä»¶ç™¼ç”Ÿï¼Œä¸èƒ½é‹è¡Œã€‚</p><p><strong>å–šé†’</strong></p><p>å–šé†’é€šéwake_up()å‡½æ•¸å®Œæˆï¼Œå®ƒæœƒå–šé†’æŒ‡å®šçš„ç­‰å¾…éšŠåˆ—ä¸Šçš„æ‰€æœ‰é€²ç¨‹ã€‚</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Linux</a></li><li><a>æ ¸å­¸ç¿’</a></li><li><a>014</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/286d1d05.html alt=Linuxæ€éº¼æ¨£ç·¨è­¯cç¨‹åºæ–‡ä»¶(ç·¨è­¯æœ€æ–°ç‰ˆffmpegç‚ºä¾‹) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/67e5890abdc3408c9e6e28c61ce6c847 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/286d1d05.html title=Linuxæ€éº¼æ¨£ç·¨è­¯cç¨‹åºæ–‡ä»¶(ç·¨è­¯æœ€æ–°ç‰ˆffmpegç‚ºä¾‹)>Linuxæ€éº¼æ¨£ç·¨è­¯cç¨‹åºæ–‡ä»¶(ç·¨è­¯æœ€æ–°ç‰ˆffmpegç‚ºä¾‹)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7e4b1039.html alt=Linuxç”¨æˆ¶ã€ç”¨æˆ¶çµ„èˆ‡æ–‡æª”å±¬æ€§ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/54f39d7a23d64846b3fee43d438f13bb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7e4b1039.html title=Linuxç”¨æˆ¶ã€ç”¨æˆ¶çµ„èˆ‡æ–‡æª”å±¬æ€§>Linuxç”¨æˆ¶ã€ç”¨æˆ¶çµ„èˆ‡æ–‡æª”å±¬æ€§</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bcacd8fd.html alt=Linuxç³»çµ±â€”â€”ç”¨æˆ¶ã€ç”¨æˆ¶çµ„ã€æ¬Šé™å’Œæ–‡ä»¶å±¬æ€§ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bcacd8fd.html title=Linuxç³»çµ±â€”â€”ç”¨æˆ¶ã€ç”¨æˆ¶çµ„ã€æ¬Šé™å’Œæ–‡ä»¶å±¬æ€§>Linuxç³»çµ±â€”â€”ç”¨æˆ¶ã€ç”¨æˆ¶çµ„ã€æ¬Šé™å’Œæ–‡ä»¶å±¬æ€§</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dad48786.html alt=Linuxä½µç™¼æœå‹™å™¨æ¨¡å‹ä¸€ã€å¤šé€²ç¨‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dad48786.html title=Linuxä½µç™¼æœå‹™å™¨æ¨¡å‹ä¸€ã€å¤šé€²ç¨‹>Linuxä½µç™¼æœå‹™å™¨æ¨¡å‹ä¸€ã€å¤šé€²ç¨‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e1360dd4.html alt=ã€ŒLinuxã€é«˜ä½µç™¼æœå‹™å™¨æ¨¡å‹ï¼ˆå¤šé€²ç¨‹å’Œå¤šç·šç¨‹å¯¦ä¾‹æ¨¡å‹ï¼‰ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/170e1596c32348f39d6ace1f327e45d5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e1360dd4.html title=ã€ŒLinuxã€é«˜ä½µç™¼æœå‹™å™¨æ¨¡å‹ï¼ˆå¤šé€²ç¨‹å’Œå¤šç·šç¨‹å¯¦ä¾‹æ¨¡å‹ï¼‰>ã€ŒLinuxã€é«˜ä½µç™¼æœå‹™å™¨æ¨¡å‹ï¼ˆå¤šé€²ç¨‹å’Œå¤šç·šç¨‹å¯¦ä¾‹æ¨¡å‹ï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2806cf4d.html alt=åµŒå…¥å¼Linuxç·¨ç¨‹â€”â€”ç¨‹åºå“¡å°ç™½ä¸æ‡‚çš„é€²ç¨‹ã€ä¿¡è™Ÿé‡ã€ä½µç™¼ã€äº’æ–¥ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6fea5f2744614de3884ab26fa09e5a40 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2806cf4d.html title=åµŒå…¥å¼Linuxç·¨ç¨‹â€”â€”ç¨‹åºå“¡å°ç™½ä¸æ‡‚çš„é€²ç¨‹ã€ä¿¡è™Ÿé‡ã€ä½µç™¼ã€äº’æ–¥>åµŒå…¥å¼Linuxç·¨ç¨‹â€”â€”ç¨‹åºå“¡å°ç™½ä¸æ‡‚çš„é€²ç¨‹ã€ä¿¡è™Ÿé‡ã€ä½µç™¼ã€äº’æ–¥</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d3d9f3d8.html alt=ææ‡‚Linuxå…§å­˜ç®¡ç†ï¼Œåƒ…æ­¤ä¸€ç¯‡ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/0ae3e7cee0234c4cb9cdef0039d2c4d0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d3d9f3d8.html title=ææ‡‚Linuxå…§å­˜ç®¡ç†ï¼Œåƒ…æ­¤ä¸€ç¯‡>ææ‡‚Linuxå…§å­˜ç®¡ç†ï¼Œåƒ…æ­¤ä¸€ç¯‡</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/838d476c.html alt=Linuxå…§æ ¸çš„æ•´é«”æ¶æ§‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a7aaf296a7c14809b8c0ce535a02205d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/838d476c.html title=Linuxå…§æ ¸çš„æ•´é«”æ¶æ§‹>Linuxå…§æ ¸çš„æ•´é«”æ¶æ§‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7102c077.html alt=ä»€éº¼Linuxï¼ŒLinuxå…§æ ¸åŠLinuxæ“ä½œç³»çµ±ï¼Œæ•´é«”æ¶æ§‹ä»‹ç´¹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/af09f220163b49399261735b49fe1790 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7102c077.html title=ä»€éº¼Linuxï¼ŒLinuxå…§æ ¸åŠLinuxæ“ä½œç³»çµ±ï¼Œæ•´é«”æ¶æ§‹ä»‹ç´¹>ä»€éº¼Linuxï¼ŒLinuxå…§æ ¸åŠLinuxæ“ä½œç³»çµ±ï¼Œæ•´é«”æ¶æ§‹ä»‹ç´¹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7e66a0e7.html alt=Linuxç¶²çµ¡ç·¨ç¨‹â€”â€”UDPå»£æ’­è©³è§£ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a2667182b3d34b2e98e8503a00af90fd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7e66a0e7.html title=Linuxç¶²çµ¡ç·¨ç¨‹â€”â€”UDPå»£æ’­è©³è§£>Linuxç¶²çµ¡ç·¨ç¨‹â€”â€”UDPå»£æ’­è©³è§£</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6b48b90b.html alt=Linuxç³»çµ±å¸¸ç”¨å‘½ä»¤å¤§å…¨ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6b48b90b.html title=Linuxç³»çµ±å¸¸ç”¨å‘½ä»¤å¤§å…¨>Linuxç³»çµ±å¸¸ç”¨å‘½ä»¤å¤§å…¨</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/47743f68.html alt=åµŒå…¥å¼Linuxé–‹ç™¼ã€ŠCèªè¨€å°ˆé¡Œ(äºŒï¼šæœ‰è¶£çš„åŸºæœ¬æ•¸æ“šé¡å‹)ã€‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/44355de4180a4af4beeda86cd1696601 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/47743f68.html title=åµŒå…¥å¼Linuxé–‹ç™¼ã€ŠCèªè¨€å°ˆé¡Œ(äºŒï¼šæœ‰è¶£çš„åŸºæœ¬æ•¸æ“šé¡å‹)ã€‹>åµŒå…¥å¼Linuxé–‹ç™¼ã€ŠCèªè¨€å°ˆé¡Œ(äºŒï¼šæœ‰è¶£çš„åŸºæœ¬æ•¸æ“šé¡å‹)ã€‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d2f8e01a.html alt="Linux C å­—ç¬¦ä¸²å‡½æ•¸ sprintf()ã€snprintf() è©³è§£" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d2f8e01a.html title="Linux C å­—ç¬¦ä¸²å‡½æ•¸ sprintf()ã€snprintf() è©³è§£">Linux C å­—ç¬¦ä¸²å‡½æ•¸ sprintf()ã€snprintf() è©³è§£</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e7646f9b.html alt=Linuxé«˜ç´šç¶²çµ¡ç·¨ç¨‹ç¯‡-UDPä¸ŸåŒ…å•é¡Œç¸½çµ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e7646f9b.html title=Linuxé«˜ç´šç¶²çµ¡ç·¨ç¨‹ç¯‡-UDPä¸ŸåŒ…å•é¡Œç¸½çµ>Linuxé«˜ç´šç¶²çµ¡ç·¨ç¨‹ç¯‡-UDPä¸ŸåŒ…å•é¡Œç¸½çµ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b95dde80.html alt=LinuxæŠ€å·§ï¼šåœ¨ä»£ç¢¼ä¸­è¨­ç½®çµ‚ç«¯å­—ç¬¦é¡¯ç¤ºé¡è‰²å’Œç§»å‹•å…‰æ¨™ä½ç½® class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/9bde2c83315847498e4b848f524e429c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b95dde80.html title=LinuxæŠ€å·§ï¼šåœ¨ä»£ç¢¼ä¸­è¨­ç½®çµ‚ç«¯å­—ç¬¦é¡¯ç¤ºé¡è‰²å’Œç§»å‹•å…‰æ¨™ä½ç½®>LinuxæŠ€å·§ï¼šåœ¨ä»£ç¢¼ä¸­è¨­ç½®çµ‚ç«¯å­—ç¬¦é¡¯ç¤ºé¡è‰²å’Œç§»å‹•å…‰æ¨™ä½ç½®</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>