<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>IPFS協議層深入分析7——交換層1GetBlocks | 极客快訊</title><meta property="og:title" content="IPFS協議層深入分析7——交換層1GetBlocks - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/1533007652323959f3fb18c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/0ffd10da.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/0ffd10da.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/0ffd10da.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/0ffd10da.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/0ffd10da.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/0ffd10da.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/0ffd10da.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/0ffd10da.html><meta property="article:published_time" content="2020-11-14T20:50:25+08:00"><meta property="article:modified_time" content="2020-11-14T20:50:25+08:00"><meta name=Keywords content><meta name=description content="IPFS協議層深入分析7——交換層1GetBlocks"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E5%AD%B8/0ffd10da.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>IPFS協議層深入分析7——交換層1GetBlocks</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E5%AD%B8.html>科學</a></span></div><div class=post-content><div><div class=pgc-img><img alt=IPFS協議層深入分析7——交換層1GetBlocks onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1533007652323959f3fb18c><p class=pgc-img-caption></p></div><p>首先來確定一下數據交換層需要對上層協議提供的基本功能，上圖是IPFS的交換層接口設計，他要求具體的交換層實現者需要提供查找數據和交換數據的功能，這些都是交換層需要滿足的最小功能集合。</p><p>接下來我們逐個接口講解器實現邏輯，首先我們講解獲取指定一組key對應的數據接口:GetBlocks</p><div class=pgc-img><img alt=IPFS協議層深入分析7——交換層1GetBlocks onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/153300765250765c8032965><p class=pgc-img-caption></p></div><p>上圖是GetBlocks()接口的第一步，就是將獲取一組key對應的data這個請求發送到數據交換層的不同組件中去，通知各個模塊，新的任務到來。</p><p>第一步，首先將所有的key交給PubSub模塊，將所有的key加入到一個叫做notification Queue的訂閱隊列中，這個訂閱隊列是一個管道組，管道組的長度依據key的個數來決定。管理這個管道隊列是一個循環協程。每當有訂閱的key對應的數據block到來，那麼就生成一個從want list刪除的請求，將已經獲得的數據對應的key從want list刪除，如圖中的步驟4表示的數據方向。</p><p>第二步，將本組key打包成一個請求數據項加入到Incoming Queue中，這是一個請求緩存，大小固定為10，專門用來存儲獲取數據的請求和取消數據請求的請求。這個隊列的使用在接下來的小節中還會繼續講到。他的作用是起到一個緩存關於數據的請求的作用。</p><p>第三步，將這一組key的第0個元素作為findkeys Queue的元素插入，該隊列的長度為32固定大小。該隊列的詳細使用方式接下來會進行詳細的解釋。</p><p>第五步，從Incoming Queue中將各項操作取出，判斷一下操作類型，根據數據的ID，我們有key-value的map，map中的每一項都是一個消息隊列，如果操作類型是增加，則將操作類型中攜帶的key加入到隊列，如果是刪除，怎根據key將數據從消息隊列中刪除。這裡需要指出的是，本步驟中使用的run loop會對兩類want list進行操作，一個是普通的want list，一個廣播式的want list。廣播式的want list存儲的是沒有制定查詢節點的待查key數據，普通的want list是由發起者指定查詢節點對象，來查找固定的key數組。</p><div class=pgc-img><img alt=IPFS協議層深入分析7——交換層1GetBlocks onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1533007652636e82bf99ee8><p class=pgc-img-caption></p></div><p>對於普通的want list列表，有一個協程定時從列表中隨機選擇一個key加入到Findkeys Queue中，對於Findkeys Queue，有一個協程專門管理這個隊列，它將其中一個元素取出之後，訪問數據交換協議的網絡接口，詢問網絡，有哪些節點能夠提供關於該元素（該元素中存有數據對應的key值）的數據，這個網絡接口會調用底層的路由層來查找對應的節點。</p><p>網絡接口返回關於某一key的數據提供者列表，這些列表存儲的元素是Peer Info，這些信息是用於網絡層(網絡層是最底層，之後是路由層，然後才是本節講的數據交換層，不熟悉的同學可以查看之前的章節)建立數據連接的基本信息。數據交換層有一個host對象，該對象用於管理與數據交換層與網絡層之間的網絡鏈接信息。通過該對象，數據交換層與返回的所有網絡層節點直接建立鏈接。</p><p>總結，本節主要站在一個接受GetBlocks()接口命令的節點來分析其處理流程，重點描述了當接收到這樣的指令之後，節點通知各個隊列來緩存這個指令並進行全網數據查詢，並與相關的節點建立直接網絡層鏈接，下一節我們將站在數據提供者或者數據中轉者的角度來分析整個獲取數據的過程如何實現的。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>IPFS</a></li><li><a>協議層</a></li><li><a>交換層</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E5%AD%B8/764797b1.html alt="IPFS協議層深入分析8——交換層2 Provide Blocks" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1533311834958210fa0a301 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/764797b1.html title="IPFS協議層深入分析8——交換層2 Provide Blocks">IPFS協議層深入分析8——交換層2 Provide Blocks</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ce279131.html alt=IPFS在安全性、傳輸速度、信息永久存儲等方面相對於HTTP有優勢 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ce279131.html title=IPFS在安全性、傳輸速度、信息永久存儲等方面相對於HTTP有優勢>IPFS在安全性、傳輸速度、信息永久存儲等方面相對於HTTP有優勢</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/f6c3bd90.html alt=如何根據不同工作協議層，劃分第二、第三、第四層交換機 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ba291da5dc584f0eb1c4193e756fa035 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/f6c3bd90.html title=如何根據不同工作協議層，劃分第二、第三、第四層交換機>如何根據不同工作協議層，劃分第二、第三、第四層交換機</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>