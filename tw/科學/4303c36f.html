<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>用sql寫迭代算法-用spark sql劃分連通圖 | 极客快訊</title><meta property="og:title" content="用sql寫迭代算法-用spark sql劃分連通圖 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/5d1eb1a757ad4146b8c82cbe81bd9c67"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/4303c36f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/4303c36f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/4303c36f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/4303c36f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/4303c36f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/4303c36f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/4303c36f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/4303c36f.html><meta property="article:published_time" content="2020-11-14T20:53:56+08:00"><meta property="article:modified_time" content="2020-11-14T20:53:56+08:00"><meta name=Keywords content><meta name=description content="用sql寫迭代算法-用spark sql劃分連通圖"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E5%AD%B8/4303c36f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>用sql寫迭代算法-用spark sql劃分連通圖</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E5%AD%B8.html>科學</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>一、問題描述</h1><h2 class=pgc-h-arrow-right>1.1 問題場景化描述</h2><p>小時候你可能遇到過這種情況，一不小心在遊戲廳惹到了別人，然後就約放學後校門口等著，結果兩人都找了一自己認識的小團體在校門口對峙，緊張的氣氛中，有的人發現對面的團體中有認識的人，結果約架變成了約燒烤，兩個團體都互相認識了。</p><p>如果每個人都有個標籤，貼在身上，比如都叫“XX幫”，就能避免約架的流程是吧。</p><h2 class=pgc-h-arrow-right>1.2 問題概念模型</h2><p>上面的問題，我們用圖來表示。圖是由節點和邊構成，點就是某個同學，邊就代表是否認識。給你一個圖，將圖中互相認識的人都打上同一個標籤，也就是處於同一個連通圖的節點打上同一個標籤。</p><p>比如下圖所示的一個圖，有9個點，很多條邊。</p><div class=pgc-img><img alt="用sql寫迭代算法-用spark sql劃分連通圖" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5d1eb1a757ad4146b8c82cbe81bd9c67><p class=pgc-img-caption></p></div><h2 class=pgc-h-arrow-right>1.3 問題物理模型</h2><p>在hive數據表relation中，存儲兩兩的關係：</p><p>user:string , friend:string</p><p>比如1.2的圖就可以表示成下表</p><p>userfriendv0v6v1v6v1v4v2v4v2v5v3v5v3v6v7v9v8v7v8v9v8v10</p><p>問題就變成了生成一張表名為user_group，記錄每個user的標籤。</p><p>user:string , group:string</p><h1 class=pgc-h-arrow-right>二、解決方案</h1><h2 class=pgc-h-arrow-right>2.1 場景化解決方案</h2><p>為了解決這個問題：</p><ol start=1><li>首先第一天每個人都成立一個以自己為幫主的幫派，在自己肩上貼上幫主名字。</li><li>然後第二天大家都去上學，觀察自己認識的人中都加入了哪些幫派，偷偷記下來，放學回到家，就把記下來的幫主姓名按字母順序排序，加入排第一個的幫派，第二天去上學的時候貼上幫主名字。</li><li>這樣很多天之後，大家發現認識的人都統一了幫主。</li></ol><p>約架時兩幫人說出自己的幫主，幫主不一樣大家肯定都互相不認識的，直接打就是。</p><h2 class=pgc-h-arrow-right>2.2 解決方案概念模型</h2><p>這就是社群發現，可以使用標籤傳播算法（LAP）：每一輪將標籤按邊的權值傳播到臨近節點，每個節點收到傳播過來的標籤後更新自己的標籤，經過多輪傳播直到收斂。</p><p>具體就不多說了，感興趣的同學可以搜索一下。</p><h2 class=pgc-h-arrow-right>2.3 sql物理實現</h2><p>基於1.3的表我們有下面的解法:</p><ul><li>由於是無向圖，得把反向關係的數據補全，構造表all_relation:</li></ul><pre><code>spark.sql("""select user,friend as groupfrom relationunion select friend as user, user as groupfrom relation""").registerTempTable("all_relation")</code></pre><ul><li>計算標籤的更新路徑</li></ul><pre><code>while True:    # 每個人把認識的人的幫主都記下來，選幫主    propagation_map = spark.sql("""    select distinct user as source,       least(user, min(group)) target,      count(1) c    from all_relation    group by user    having source!=target    """).cache()        #如果每個人認識的人中都只公認了只有一個幫主就不再計算    propagation_count = propagation_map.filter("c&gt;1").count()    if(propagation_count==0):        break    propagation_map.registerTempTable("propagation_map")    # 更新認識的人的幫主    all_relation = spark.sql("""    select distinct all_relation.user,        nvl(propagation_map.target,all_relation.group) group    from all_relation    left join propagation_map    on all_relation.group=propagation_map.source    """).registerTempTable("all_relation")</code></pre><ul><li>結果就是 all_relation 這張表</li></ul><h1 class=pgc-h-arrow-right>三、一些思考</h1><ol start=1><li>這個模式和比特幣的共識模式很像，都是先建立一套規則讓每個節點按照這個規則操作，最後能讓所有節點達成共識。</li><li>sql這樣的模式和一般的通用語言不一樣，天生帶有並行性。</li><li>對於本文的這種描述方式大家覺得咋樣。</li></ol><p>歷史文章推薦：</p><p>https://www.toutiao.com/c/user/108314434662/#mid=1619075457860612</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>sql</a></li><li><a>spark</a></li><li><a>劃分</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/7478c50a.html alt=洞室劃分——按洞室開挖尺寸和斷面大小（搞水工的有福了） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1532777123971fa2d188f4f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7478c50a.html title=洞室劃分——按洞室開挖尺寸和斷面大小（搞水工的有福了）>洞室劃分——按洞室開挖尺寸和斷面大小（搞水工的有福了）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7359747f.html alt=BIM模型精度怎麼劃分的?LOD等級有哪些？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/56214b744cc54ee595bc0bf7bbb00d56 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7359747f.html title=BIM模型精度怎麼劃分的?LOD等級有哪些？>BIM模型精度怎麼劃分的?LOD等級有哪些？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/667a7734.html alt=數控加工中心的加工精度如何劃分等級 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/67f0350a1d3248d4be88e7c8feb5186e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/667a7734.html title=數控加工中心的加工精度如何劃分等級>數控加工中心的加工精度如何劃分等級</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fe9c40a4.html alt=數控加工中心的加工精度如何劃分等級，你知道嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/da7a96afccf246f19b6997c7e89daa08 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fe9c40a4.html title=數控加工中心的加工精度如何劃分等級，你知道嗎？>數控加工中心的加工精度如何劃分等級，你知道嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c52d2abd.html alt=邊坡工程安全等級的劃分及應用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/358ef8681556409fa79b0f6c40060c66 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c52d2abd.html title=邊坡工程安全等級的劃分及應用>邊坡工程安全等級的劃分及應用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/acae6787.html alt=分享一個有趣的sql--獲取一個表的所有字段名並用逗號分割 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8f0992a747ac43e588b4b650aecf66b8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/acae6787.html title=分享一個有趣的sql--獲取一個表的所有字段名並用逗號分割>分享一個有趣的sql--獲取一個表的所有字段名並用逗號分割</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/57a7ca6f.html alt=中國目前軍銜劃分 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/da5d00019f7cd5ba4713 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/57a7ca6f.html title=中國目前軍銜劃分>中國目前軍銜劃分</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/315bd4b7.html alt=星辰變中各等級劃分 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e3493206568443218da2745a34664704 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/315bd4b7.html title=星辰變中各等級劃分>星辰變中各等級劃分</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ee848d4d.html alt=神仙的十二等級劃分標準，看完真的長知識 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3aaac493c34e4ca29e38f79124f228a9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ee848d4d.html title=神仙的十二等級劃分標準，看完真的長知識>神仙的十二等級劃分標準，看完真的長知識</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1d9f8353.html alt=行政級別是如何劃分的？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15422501264334a0861a51f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1d9f8353.html title=行政級別是如何劃分的？>行政級別是如何劃分的？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d3b81abc.html alt=列車進路的劃分原則，是怎樣的？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/20e5d93d-475e-4464-8342-ca5bdae06d61 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d3b81abc.html title=列車進路的劃分原則，是怎樣的？>列車進路的劃分原則，是怎樣的？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a1c6aa19.html alt="sql server複製技術，本地發佈和本地訂閱數據庫實時同步" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/461e076113c740a9815aa1609d522354 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a1c6aa19.html title="sql server複製技術，本地發佈和本地訂閱數據庫實時同步">sql server複製技術，本地發佈和本地訂閱數據庫實時同步</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4d6fa253.html alt=走勢劃分有一些基本的問題需要選邊站隊 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4d6fa253.html title=走勢劃分有一些基本的問題需要選邊站隊>走勢劃分有一些基本的問題需要選邊站隊</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/057b5975.html alt=電磁波的頻段劃分 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ea6e239d1cc340be9f2175859a0b12ca style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/057b5975.html title=電磁波的頻段劃分>電磁波的頻段劃分</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b34ab02d.html alt=sql查詢重複記錄、刪除重複記錄方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b34ab02d.html title=sql查詢重複記錄、刪除重複記錄方法>sql查詢重複記錄、刪除重複記錄方法</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>