<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Frida之文件操作 | 极客快訊</title><meta property="og:title" content="Frida之文件操作 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/2ebe58a30dd547fa9d48c448f2114294"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/9a91fac3.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/9a91fac3.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/9a91fac3.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/9a91fac3.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/9a91fac3.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/9a91fac3.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/9a91fac3.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/9a91fac3.html><meta property="article:published_time" content="2020-10-29T21:13:10+08:00"><meta property="article:modified_time" content="2020-10-29T21:13:10+08:00"><meta name=Keywords content><meta name=description content="Frida之文件操作"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E5%AD%B8/9a91fac3.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Frida之文件操作</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E5%AD%B8.html>科學</a></span></div><div class=post-content><p>在前面的文章中介紹了數據庫的操作，這篇文章主要介紹文件的操作。</p><p style=text-align:start>當你在使用程序的時候，可以動態修改程序的文件操作，其實是很恐怖的，比如，本來是往文件中寫入100元錢，但是經過動態修改後變成了0元，據此可以腦洞大開一下。 @[toc]</p><h1 class=pgc-h-arrow-right>基礎概念</h1><h1 class=pgc-h-arrow-right>Linux下文件描述符</h1><p style=text-align:start>一個Linux進程啟動後，會在內核空間創建一個PCB進程控制塊，PCB是一個進程的私有財產。這個PCB中有一個已打開文件描述符表，記錄著所有該進程打開的文件描述符以及對應的file結構體地址。</p><p style=text-align:start>默認情況下，啟動一個Linux進程後，會打開三個文件，分別是標準輸入、標準輸出、標準錯誤分別使用了0、1 、2號文件描述符。</p><p>當該進程使用函數open打開一個新的文件時，一般會在內核空間申請一個file結構體，並且把3號文件描述符對應的file指針指向file結構體。</p><div class=pgc-img><img alt=Frida之文件操作 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2ebe58a30dd547fa9d48c448f2114294><p class=pgc-img-caption></p></div><p>v-node table entry是虛擬文件系統對應的文件節點，i-node是磁盤文件系統對應的文件節點。通過這兩個節點就能找到最終的磁盤文件。 舉個例子：</p><pre><code>#include &lt;unistd.h&gt;#include &lt;fcntl.h&gt;#include &lt;stdio.h&gt;int main(int argc,char *argv[]){   int fd = open("./1.c",O_RDWR);   printf("fd=%d\n",fd);}</code></pre><p style=text-align:start>程序運行結果是: fd=3</p><p style=text-align:start>每一個進程只有一個process table entry，一般情況下默認使用 fd 0、fd1、fd2，新打開的文件1.c將使用fd 3，後續的文件描述符的值以此類推。</p><p><strong>文件描述符含義</strong>0標準輸入1標準輸出2標準錯誤輸出</p><h1 class=pgc-h-arrow-right>JavaScript Promise對象</h1><p style=text-align:start>ECMAscript 6 原生提供了 Promise 對象。Promise 對象代表了未來將要發生的事件，用來傳遞異步操作的消息。</p><pre><code>var myFirstPromise = new Promise(function(resolve, reject){    //當異步代碼執行成功時，我們才會調用resolve(...), 當異步代碼失敗時就會調用reject(...)    //在本例中，我們使用setTimeout(...)來模擬異步代碼，實際編碼時可能是XHR請求或是HTML5的一些API方法.    setTimeout(function(){        resolve("歡迎關注我的微信公眾號:無情劍客!"); //代碼正常執行！    }, 250);});myFirstPromise.then(function(successMessage){    //successMessage的值是上面調用resolve(...)方法傳入的值.    //successMessage參數不一定非要是字符串類型，這裡只是舉個例子    document.write("Yay! " + successMessage);});</code></pre><p style=text-align:start>Promise簡化了對error的處理，上面的代碼我們也可以這樣寫：</p><pre><code>promise.then(onFulfilled).catch(onRejected)</code></pre><p style=text-align:start>更多Promise的內容，後續會專門介紹。</p><h1 class=pgc-h-arrow-right>Android Activity生命週期</h1><p>為了在 Activity 生命週期的各個階段之間導航轉換，Activity 類提供六個核心回調：onCreate()、onStart()、onResume()、onPause()、onStop() 和 onDestroy()。當 Activity 進入新狀態時，系統會調用其中每個回調。</p><div class=pgc-img><img alt=Frida之文件操作 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cfcef8ce50c041eb83ed6af3de6c4d86><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>文件和流</h1><h1 class=pgc-h-arrow-right>文件File</h1><ul><li>new File(filePath, mode): open or create the file at filePath with the mode string specifying how it should be opened. For example "wb" to open the file for writing in binary mode (this is the same format as fopen() from the C standard library).</li><li>write(data): synchronously write data to the file, where data is either a string or a buffer as returned by NativePointer#readByteArray</li><li>flush(): flush any buffered data to the underlying file</li><li>close(): close the file. You should call this function when you’re done with the file unless you are fine with this happening when the object is garbage-collected or the script is unloaded. 舉個例子，hook Activity的onResume函數，當回調onResume函數的時候，先通過File操作向'/data/data/com.lingpao.lpcf622b/files/chat/test.txt'這個文件中寫入'hello world'，最後調用系統的onResume回調。這裡只是舉例，實際情況可能需要保存一些重要的數據或者修改一些重要的數據。</li></ul><pre><code>import frida,sysdef on_message(message, data):    if message['type'] == 'send':        print(" {0}".format(message['payload']))    else:        print(message)passsession = frida.get_usb_device().attach("com.lingpao.lpcf622b")jscode = """if(Java.available){    Java.perform(function(){          var Activity = Java.use('android.app.Activity');         Activity.onResume.implementation = function () {                send('onResume() got called! ');                var file = new File('/data/data/com.lingpao.lpcf622b/files/chat/test.txt', 'wb');                file.write('hello world');                file.flush();                file.close();                this.onResume();         };    });}"""script = session.create_script(jscode)script.on("message", on_message)print(' Start attach')script.load()sys.stdin.read()</code></pre><h1 class=pgc-h-arrow-right>輸入流InputStream</h1><p style=text-align:start>All methods are fully <strong>asynchronous</strong> and return <strong>Promise</strong> objects.</p><ul><li>close(): close the stream, releasing resources related to it. Once the stream is closed, all other operations will fail. Closing a stream multiple times is allowed and will not result in an error.</li><li>read(size): read up to size bytes from the stream. The returned Promise receives an ArrayBuffer up to size bytes long. End of stream is signalled through an empty buffer.</li><li>readAll(size): keep reading from the stream until exactly size bytes have been consumed. The returned Promise receives an <strong>ArrayBuffer</strong> that is exactly size bytes long. Premature error or end of stream results in the Promise getting rejected with an error, where the Error object has a partialData property containing the incomplete data.</li></ul><p style=text-align:start>在類Unix系統中，獲取輸入流的方式:</p><ul><li>new UnixInputStream(fd[, options]): create a new InputStream from the specified file descriptor fd. You may also supply an options object with autoClose set to true to make the stream close the underlying file descriptor when the stream is released, either through close() or future garbage-collection.</li></ul><p style=text-align:start>在Windwos平臺下，獲取輸入流的方式:</p><ul><li>new Win32InputStream(handle[, options]): create a new InputStream from the specified handle, which is a Windows HANDLE value. You may also supply an options object with autoClose set to true to make the stream close the underlying handle when the stream is released, either through close() or future garbage-collection.</li></ul><p style=text-align:start>Android是基於Linux系統的，所以屬於類Unix系統，具體代碼示例，在前面的文章中對Intercepter進行了介紹，這裡對open函數進行替換，對打開的文件讀取輸入流。</p><pre><code>var openPtr = Module.getExportByName(null, 'open');var open = new NativeFunction(openPtr, 'int', ['pointer', 'int']);Interceptor.replace(openPtr, new NativeCallback(function (pathPtr, flags) {  var path = pathPtr.readUtf8String();  console.log('Opening "' + path + '"');  var fd = open(pathPtr, flags); if (fd &gt; 0){    var input = new UnixInputStream(fd);    var promise = input.read(1000);    promise.then(function(result){      console.log(' burning'+hexdump(result,{lenght:1000}));    }).catch(function(error){      console.log(' fail:'+error);    }); }  console.log('Got fd: ' + fd);  return fd;}, 'int', ['pointer', 'int']));</code></pre><p>運行結果如下。</p><div class=pgc-img><img alt=Frida之文件操作 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e4e216cde8804b18b908b54a65a16e87><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>輸出流OutputStream</h1><p style=text-align:start>All methods are fully <strong>asynchronous</strong> and return <strong>Promise</strong> objects.</p><ul><li>close(): close the stream, releasing resources related to it. Once the stream is closed, all other operations will fail. Closing a stream multiple times is allowed and will not result in an error.</li><li>write(data): try to write data to the stream. The data value is either an ArrayBuffer or an array of integers between 0 and 255. The returned Promise receives a Number specifying how many bytes of data were written to the stream.</li><li>writeAll(data): keep writing to the stream until all of data has been written. The data value is either an ArrayBuffer or an array of integers between 0 and 255. Premature error or end of stream results in an error, where the Error object has a partialSize property specifying how many bytes of data were written to the stream before the error occurred.</li><li>writeMemoryRegion(address, size): try to write size bytes to the stream, reading them from address, which is a NativePointer. The returned Promise receives a Number specifying how many bytes of data were written to the stream.</li></ul><p style=text-align:start>在類Unix系統中，獲取輸出流的方式:</p><ul><li>new UnixOutputStream(fd[, options]): create a new OutputStream from the specified file descriptor fd. You may also supply an options object with autoClose set to true to make the stream close the underlying file descriptor when the stream is released, either through close() or future garbage-collection.</li></ul><p style=text-align:start>在Windwos平臺下，獲取輸出流的方式:</p><ul><li>new Win32OutputStream(handle[, options]): create a new OutputStream from the specified handle, which is a Windows HANDLE value. You may also supply an options object with autoClose set to true to make the stream close the underlying handle when the stream is released, either through close() or future garbage-collection.</li></ul><p style=text-align:start>具體使用，可參考InputStream的使用。</p><h1 class=pgc-h-arrow-right>輸入輸出流</h1><p style=text-align:start>輸入和輸出都是相對的。高中物理講過火車上的人，以車做參考系，人是靜止的，但是如果以樹做參考系人是運動的，那末輸入輸出的參考系是什麼？</p><p style=text-align:start>內存。往內存中寫就是輸入，從內存中向文件中寫就是輸出。</p><h1 class=pgc-h-arrow-right>寫在最後</h1><p style=text-align:start>預告一下，下篇Frida的文章說網絡，網絡的本質其實還是文件。</p><h1 class=pgc-h-arrow-right>公眾號</h1><p style=text-align:start>更多Frida相關的內容，歡飲關注我的微信公眾號:無情劍客。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Frida</a></li><li><a>文件</a></li><li><a>操作</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/438a5238.html alt=環境管理體系程序文件-文件控制程序 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/aaa460951e4e4b358966a6652c1d361f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/438a5238.html title=環境管理體系程序文件-文件控制程序>環境管理體系程序文件-文件控制程序</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e0ffb976.html alt=不合格、糾正措施程序文件（ISO9001程序文件範本） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e0ffb976.html title=不合格、糾正措施程序文件（ISO9001程序文件範本）>不合格、糾正措施程序文件（ISO9001程序文件範本）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/16c259de.html alt=什麼是程序文件？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/16c259de.html title=什麼是程序文件？>什麼是程序文件？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a8c41b36.html alt=今天聊聊程序的文件的概念 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a8c41b36.html title=今天聊聊程序的文件的概念>今天聊聊程序的文件的概念</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9cd79f8d.html alt=程序文件-ISO9001 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/2e673ba29f5545fd8aea4073e1c638c3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9cd79f8d.html title=程序文件-ISO9001>程序文件-ISO9001</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4526bc23.html alt=程序文件沒有用？管理全靠你盯著？也許是你對程序文件有誤解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/25f214b9-177d-4e1e-8ccd-1c3fe7c07fe5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4526bc23.html title=程序文件沒有用？管理全靠你盯著？也許是你對程序文件有誤解>程序文件沒有用？管理全靠你盯著？也許是你對程序文件有誤解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c81e50df.html alt=程序文件流程圖 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/3a0300041dc3570ffec5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c81e50df.html title=程序文件流程圖>程序文件流程圖</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/48fac9bc.html alt=管理體系程序文件之文件控制程序 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/48fac9bc.html title=管理體系程序文件之文件控制程序>管理體系程序文件之文件控制程序</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ffde15b2.html alt=質量管理體系程序文件--文件控制程序 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/c4afea2228a24b0e81d79d622e633652 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ffde15b2.html title=質量管理體系程序文件--文件控制程序>質量管理體系程序文件--文件控制程序</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e68a385b.html alt=如何挑選合適的文件櫃？跟美格利生一起來看看 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9e0a2460d3344937bd8219a679ee2353 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e68a385b.html title=如何挑選合適的文件櫃？跟美格利生一起來看看>如何挑選合適的文件櫃？跟美格利生一起來看看</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/02c33c9e.html alt=文件櫃定製有哪些方面需注意呢 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/966ef4ec8b7749b080bb564832a55c13 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/02c33c9e.html title=文件櫃定製有哪些方面需注意呢>文件櫃定製有哪些方面需注意呢</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/64e0caa9.html alt=文件櫃的主要用途都有哪些呢 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/92909af8e5014e79bfa05c7a05cafcfa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/64e0caa9.html title=文件櫃的主要用途都有哪些呢>文件櫃的主要用途都有哪些呢</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e4c8c7f6.html alt=選擇哪種文件櫃儲存文件好呢 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7b59db2e366841b6b757a77467e16b50 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e4c8c7f6.html title=選擇哪種文件櫃儲存文件好呢>選擇哪種文件櫃儲存文件好呢</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9621c7b8.html alt=都有哪些材質的文件櫃？各有什麼特點？這篇文章助你選對文件櫃 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/473ff5d12cb54f328e1d64db1d28fb33 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9621c7b8.html title=都有哪些材質的文件櫃？各有什麼特點？這篇文章助你選對文件櫃>都有哪些材質的文件櫃？各有什麼特點？這篇文章助你選對文件櫃</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/10f6efe5.html alt=鋼製文件櫃的價格是多少呢？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4f025bc54b77411ab5582ba4f9fc70f2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/10f6efe5.html title=鋼製文件櫃的價格是多少呢？>鋼製文件櫃的價格是多少呢？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>