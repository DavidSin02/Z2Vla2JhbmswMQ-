<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>僅需這一篇，吃透負載均衡 | 极客快訊</title><meta property="og:title" content="僅需這一篇，吃透負載均衡 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/15254882999416c80866253"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/a8c0b11.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/a8c0b11.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/a8c0b11.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/a8c0b11.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/a8c0b11.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/a8c0b11.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/a8c0b11.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/a8c0b11.html><meta property="article:published_time" content="2020-10-29T21:03:57+08:00"><meta property="article:modified_time" content="2020-10-29T21:03:57+08:00"><meta name=Keywords content><meta name=description content="僅需這一篇，吃透負載均衡"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E5%AD%B8/a8c0b11.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>僅需這一篇，吃透負載均衡</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E5%AD%B8.html>科學</a></span></div><div class=post-content><img alt=僅需這一篇，吃透負載均衡 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15254882999416c80866253><p>在對分佈式系統的「高可用」有了一個初步瞭解之後，我們也認識到「負載均衡」是「高可用」的核心所在。那麼，本篇文章我們將通過圖文並茂的方式，來描述出每一種負載均衡策略的完整樣貌。</p><p><strong>一、負載均衡是什麼</strong></p><p>由一個獨立的統一入口來收斂流量，再做二次分發的過程就是「負載均衡」，它的本質和「分佈式系統」一樣，是「分治」。</p><p>如果大家習慣了開車的時候用一些導航軟件，我們會發現，導航軟件的推薦路線方案會有一個數量的上限，比如3條、5條。</p><p>其實，它也起到了一個類似「負載均衡」的作用，因為如果只能取Top3的通暢路線，自然擁堵嚴重的路線就無法推薦給你了，使得車流的壓力被分攤到了相對空閒的路線上。</p><p>在軟件系統中也是一樣的道理，為了避免流量分攤不均，造成局部節點負載過大（如CPU吃緊等），所以引入一個獨立的統一入口來做類似上面的“導航”的工作。但是，軟件系統中的「負載均衡」與導航的不同在於，導航是一個柔性策略，最終還是需要使用者做選擇，而前者則不同。</p><p>怎麼均衡的背後是策略在起作用，而策略的背後是由某些算法或者說邏輯來組成的。比如，導航中的算法屬於「路徑規劃」範疇，在這個範疇內又細分為「靜態路徑規劃」和「動態路徑規劃」，並且，在不同的分支下還有各種具體計算的算法實現，如Dijikstra、A*等。</p><p>同樣的，在軟件系統中的負載均衡，也有很多算法或者說邏輯在支撐著這些策略，巧的是也有靜態和動態之分。</p><p><strong>二、常用負載均衡策略圖解</strong></p><p>下面來羅列一下日常工作中最常見的5種策略。</p><p><strong>1、輪詢</strong></p><img alt=僅需這一篇，吃透負載均衡 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RATl0JS7fkUqni><p>這是最常用也最簡單的策略，平均分配，人人都有、一人一次。大致的代碼如下：</p><p>int globalIndex = 0; //注意是全局變量，不是局部變量。</p><p>try</p><p>{</p><p>return servers[globalIndex];</p><p>}</p><p>finally</p><p>{</p><p>globalIndex++;</p><p>if (globalIndex == 3)</p><p>globalIndex = 0;</p><p>}</p><p>2、加權輪詢</p><img alt=僅需這一篇，吃透負載均衡 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RATl0Jp51iX7K0><p>在輪詢的基礎上，增加了一個權重的概念。權重是一個泛化後的概念，可以用任意方式來體現，本質上是能者多勞的思想。比如，可以根據宿主的性能差異配置不同的權重。大致的代碼如下：</p><p>int matchedIndex = -1;</p><p>int total = 0;</p><p>for (int i = 0; i &lt; servers.Length; i++)</p><p>{</p><p>servers[i].cur_weight += servers[i].weight;//①每次循環的時候做自增（步長=權重值）</p><p>total += servers[i].weight;//②將每個節點的權重值累加到彙總值中</p><p>if (matchedIndex == -1 || servers[matchedIndex].cur_weight &lt; servers[i].cur_weight) //③如果 當前節點的自增數 > 當前待返回節點的自增數，則覆蓋。</p><p>{</p><p>matchedIndex = i;</p><p>servers[matchedIndex].cur_weight -= total;//④被選取的節點減去②的彙總值，以降低下一次被選舉時的初始權重值。</p><p>return servers[matchedIndex];</p><p>這段代碼的過程如下圖的表格。“”中的數字就是自增數，代碼中的cur_weight。</p><img alt=僅需這一篇，吃透負載均衡 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/R6nXLXVCA1Lskt><p>值得注意的是，加權輪詢本身還有不同的實現方式，雖說最終的比例都是2：1：2。</p><p>但是在請求送達的先後順序上可以有所不同。比如「5-4，3，2-1」和上面的案例相比，最終比例是一樣的，但是效果不同，「5-4，3，2-1」更容易產生併發問題，導致服務端擁塞，且這個問題隨著權重數字越大越嚴重。例如，10：5：3的結果是「18-17-16-15-14-13-12-11-10-9，8-7-6-5-4，3-2-1」。</p><p>3、最少連接數</p><img alt=僅需這一篇，吃透負載均衡 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/RATl0K28nG5vBK><p>這是一種根據實時的負載情況，進行動態負載均衡的方式。維護好活動中的連接數量，然後取最小的返回即可。大致的代碼如下：</p><p>var matchedServer = servers.orderBy(e => e.active_conns).first;</p><p>matchedServer.active_conns += 1;</p><p>return matchedServer;</p><p>//在連接關閉時還需對active_conns做減1的動作。</p><p>4、最快響應</p><img alt=僅需這一篇，吃透負載均衡 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RATl0KBI1YeqQY><p>這也是一種動態負載均衡策略，它的本質是根據每個節點對過去一段時間內的響應情況來分配，響應越快分配的越多。具體的運作方式也有很多，上圖的這種可以理解為：將最近一段時間的請求耗時的平均值記錄下來，結合前面的「加權輪詢」來處理，所以等價於2：1：3的加權輪詢。</p><p>題外話：一般來說，同機房下的延遲基本沒什麼差異，響應時間的差異主要在服務的處理能力上。</p><p>如果在跨地域（例：浙江->上海，還是浙江->北京）的一些請求處理中運用，大多數情況會使用定時「ping」的方式來獲取延遲情況，因為是OSI的L3轉發，數據更乾淨，準確性更高。</p><p>5、Hash法</p><img alt=僅需這一篇，吃透負載均衡 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RATl0SgFclNwO2><p>Hash法的負載均衡與之前的幾種不同在於，它的結果是由客戶端決定的。通過客戶端帶來的某個標識經過一個標準化的散列函數進行打散分攤。</p><p>上圖中的散列函數運用的是最簡單粗暴的「取餘法」。</p><p>題外話：散列函數除了取餘之外，還有諸如「變基」、「摺疊」、「平方取中法」等等，此處不做展開，有興趣的小夥伴可自行查閱資料。</p><p>另外，被求餘的參數其實可以是任意的，只要最終轉化成一個整數參與運算即可。最常用的應該是用來源IP地址作為參數，這樣可以確保相同的客戶端請求儘可能落在同一臺服務器上。</p><p><strong>三、常用負載均衡策略優缺點和適用場景</strong></p><p>我們知道，沒有完美的事物，負載均衡策略也是一樣。上面列舉的這些最常用的策略也有各自的優缺點和適用場景，我稍作了整理，如下：</p><img alt=僅需這一篇，吃透負載均衡 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/R6nXLubJ6Xi3Ip><p>這些負載均衡算法之所以常用也是因為簡單，想要更優的效果，必然就需要更高的複雜度。比如，可以將簡單的策略組合使用、或者通過更多維度的數據採樣來綜合評估、甚至是基於進行數據挖掘後的預測算法來做。</p><p><strong>四、用健康探測來保障高可用</strong></p><p>不管是什麼樣的策略，都難免會遇到機器故障或者程序故障的情況。所以要確保負載均衡能更好的起到效果，還需要結合一些「健康探測」機制。定時的去探測服務端是不是還能連上，響應是不是超出預期的慢。</p><p>如果節點屬於“不可用”的狀態的話，需要將這個節點臨時從待選取列表中移除，以提高可用性。一般常用的「健康探測」方式有3種。</p><p>1、HTTP探測</p><p>使用Get/Post的方式請求服務端的某個固定的URL，判斷返回的內容是否符合預期。一般使用Http狀態碼、Response中的內容來判斷。</p><p>2、TCP探測</p><p>基於TCP的三次握手機制來探測指定的IP+端口。最佳實踐可以借鑑阿里雲的SLB機制，如下圖：</p><img alt=僅需這一篇，吃透負載均衡 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RATl0Sx75Qwxfe><p>值得注意的是，為了儘早釋放連接，在三次握手結束後立馬跟上RST來中斷TCP連接。</p><p>3、UDP探測</p><p>可能有部分應用使用的是UDP協議。在此協議下可以通過報文來進行探測指定的IP+端口。最佳實踐同樣可以借鑑阿里雲的SLB機制，如下圖：</p><img alt=僅需這一篇，吃透負載均衡 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RATl0T6BJPiujJ><p>結果的判定方式是：在服務端沒有返回任何信息的情況下，默認正常狀態；否則會返回一個ICMP的報錯信息。</p><p><strong>五、結語</strong></p><p>用一句話來概括負載均衡的本質是：</p><p>將請求或者說流量，以期望的規則分攤到多個操作單元上進行執行。</p><p>通過它可以實現橫向擴展（Scale Out），將冗餘的作用發揮為「高可用」。另外，還可以物盡其用，提升資源使用率。</p><p>作者：Zachary_Fan</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>僅需</a></li><li><a>負載</a></li><li><a>吃透</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/6bd5e8d8.html alt=吉時利源表——支持千倍以上負載電容的靈敏測試 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d45f59d224f344c183dafefd743ed936 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6bd5e8d8.html title=吉時利源表——支持千倍以上負載電容的靈敏測試>吉時利源表——支持千倍以上負載電容的靈敏測試</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7f01d3f2.html alt=吃透Java集合系列二：Collection與其子接口 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/691aeb05fb314dfa98f57c29c5694b6b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7f01d3f2.html title=吃透Java集合系列二：Collection與其子接口>吃透Java集合系列二：Collection與其子接口</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a33dda26.html alt=線纜太長負載太遠，負載端電壓難測量？三種方法幫你搞定 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RnULLHVDmh39E7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a33dda26.html title=線纜太長負載太遠，負載端電壓難測量？三種方法幫你搞定>線纜太長負載太遠，負載端電壓難測量？三種方法幫你搞定</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d5111308.html alt=僅需1小時50分！西安南至安康明年1月10日起開行直達特快列車 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/RloJRN7CXQbi9j style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d5111308.html title=僅需1小時50分！西安南至安康明年1月10日起開行直達特快列車>僅需1小時50分！西安南至安康明年1月10日起開行直達特快列車</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a88886f4.html alt=感性負載，容性負載和阻性負載之間的關係和特性 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/66a80000b68174e92239 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a88886f4.html title=感性負載，容性負載和阻性負載之間的關係和特性>感性負載，容性負載和阻性負載之間的關係和特性</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e8f30e3c.html alt=發電機組間負載功率的分配及影響 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/30b14c986a044a72ad2a2adf4720f315 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e8f30e3c.html title=發電機組間負載功率的分配及影響>發電機組間負載功率的分配及影響</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/28f96c5f.html alt="電工閒談（二） 來聊聊負載這回事兒" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/28f96c5f.html title="電工閒談（二） 來聊聊負載這回事兒">電工閒談（二） 來聊聊負載這回事兒</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a248950f.html alt=降低變壓器負載損耗的分析與措施 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/e9d5d01a0e374a6ca29c09c5d5b072b9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a248950f.html title=降低變壓器負載損耗的分析與措施>降低變壓器負載損耗的分析與措施</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7994f9e1.html alt="一致性 Hash 在負載均衡中的應用" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/9fd8a7da6a1f4b2ba7ab057233eaf65a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7994f9e1.html title="一致性 Hash 在負載均衡中的應用">一致性 Hash 在負載均衡中的應用</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/f0626fd5.html alt=故宮獸像負載的文化與歷史 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RKp1VrT1IvIqqX style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/f0626fd5.html title=故宮獸像負載的文化與歷史>故宮獸像負載的文化與歷史</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/8ddbcb31.html alt=僅需22分鐘，新冠病毒試劑盒研製成功，背後企業剛獲8千萬投資 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/5cd65e3a872b439e80991855a7b38c7c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/8ddbcb31.html title=僅需22分鐘，新冠病毒試劑盒研製成功，背後企業剛獲8千萬投資>僅需22分鐘，新冠病毒試劑盒研製成功，背後企業剛獲8千萬投資</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8da59534.html alt=鈷鐵氧體納米粒子負載電紡碳纖維用於活化過氧單硫酸鹽的催化劑 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/c45c0da1754c4f03b18ba5bca90a8552 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8da59534.html title=鈷鐵氧體納米粒子負載電紡碳纖維用於活化過氧單硫酸鹽的催化劑>鈷鐵氧體納米粒子負載電紡碳纖維用於活化過氧單硫酸鹽的催化劑</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9f2d08c.html alt=別讓“跑焦”毀所有！僅需這一項設置，即可顯著改善鏡頭對焦精度 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/491412152de74f77b767b4ea760b6f70 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9f2d08c.html title=別讓“跑焦”毀所有！僅需這一項設置，即可顯著改善鏡頭對焦精度>別讓“跑焦”毀所有！僅需這一項設置，即可顯著改善鏡頭對焦精度</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b675f12.html alt=高壓開關櫃負載絕緣測試存在的問題及對策 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7bc62cdb96bc4f8ea0edc312f6b51fdf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b675f12.html title=高壓開關櫃負載絕緣測試存在的問題及對策>高壓開關櫃負載絕緣測試存在的問題及對策</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/276b9f3.html alt=什麼是假負載，在開關電源當中有什麼作用？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1529417905182a0b47befbc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/276b9f3.html title=什麼是假負載，在開關電源當中有什麼作用？>什麼是假負載，在開關電源當中有什麼作用？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>