<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>宜信微服務架構落地及其演進｜分享實錄 | 极客快訊</title><meta property="og:title" content="宜信微服務架構落地及其演進｜分享實錄 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/6a00c7615d33412187af0ad04d29d039"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/b0936139.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/b0936139.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/b0936139.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/b0936139.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/b0936139.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/b0936139.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/b0936139.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/b0936139.html><meta property="article:published_time" content="2020-11-14T20:51:10+08:00"><meta property="article:modified_time" content="2020-11-14T20:51:10+08:00"><meta name=Keywords content><meta name=description content="宜信微服務架構落地及其演進｜分享實錄"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E5%AD%B8/b0936139.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>宜信微服務架構落地及其演進｜分享實錄</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E5%AD%B8.html>科學</a></span></div><div class=post-content><p>摘要：本文主要介紹宜信微服務架構的基礎設施建設，及如何更好地服務與賦能實際業務。</p><blockquote><p>內容來源：宜信技術學院第8期技術沙龍-線上直播|宜信微服務架構落地及其演進</p><p>主講人：宜信高級架構師 & 宜信科技中心基礎研發部SIA微服務網關負責人王佩華</p></blockquote><h2 class=pgc-h-arrow-right>一、應用服務架構演進及微服務架構介紹</h2><h3 class=pgc-h-arrow-right>1.1 應用架構的演進歷程</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6a00c7615d33412187af0ad04d29d039><p class=pgc-img-caption></p></div><p><br></p><p>應用服務架構一直處於不斷演進的過程中，上圖通過對比5種比較主流的架構模式，展示應用架構的演進歷程和變化。</p><ul><li>單體架構（All in One）。在業務發展初期，為了快速落地應用，滿足客戶需求，一般會使用All in One的單體架構。單體架構的特點是：所有模塊都耦合在一個進程裡，系統完全封閉且很複雜，牽一髮動全局。</li><li>豎井式架構（Vertical Application）。隨著業務的增長，單體架構越來越臃腫，我們對系統做了垂直化的拆分，應用架構進入第二階段即豎井式架構。豎井式架構，就是根據業務屬性將一個大的單體拆分成一些不同的模塊或子系統，子系統之間沒有直接關聯。豎井式架構依然存在緊耦合的問題，系統也是完全封閉的，且存在大量的重複代碼拷貝及模塊功能需大量重複造輪子的情況。</li></ul><p>單體架構和豎井式架構都是圍繞web容器打包及部署的架構模式，隨著業務的快速發展，要求實現服務的快速迭代和快速交付，應用架構也由此演進為以服務為中心的架構模式。主流的面向服務的架構模式有：RPC架構、ESB中心化架構和微服務架構。</p><ul><li>RPC架構。RPC架構在現在的應用系統中還是比較常見的架構模式，適用於高併發場景，性能比較好。Dubbo就是一個典型的RPC架構。RPC架構也存在一些問題：通過共享分佈式對象實現遠程方法調用，如果在其中一個對象裡添加一個屬性，就會對共享對象的生產者與消費者產生影響，所以RPC架構也是緊耦合的模式，系統交互採用RPC私有TCP協議，服務生產者和消費者存在強代碼依賴，異構系統集成不友好。</li><li>ESB中心化架構。ESB中心化架構實現了鬆耦合，依賴於ESB消息總線技術實現異構系統的信息交互和集成集中式架構管理，因此它雖然是面向服務的，但它本質上依舊是一箇中心化的架構。其優勢在於：基於WebService技術，重量級的消息通訊機制，我們稱之為“智能管道啞終端”，當團隊規模比較大、要實現異構系統集成時，它可以提供統一的解決方案和技術實現方式，快速集成異構系統對外服務。ESB中心化架構的問題也比較明顯：中心化架構難以滿足靈活性的服務迭代和需求交付。</li><li>微服務架構。微服務架構實現了系統解耦和持續集成，有清晰的服務邊界，粒度相對ESB架構和傳統SOA架構來說更小，使用輕量級的通訊機制交互，具備更強的擴展性和彈性，能夠更靈活、更快響應業務變化。</li></ul><p>通過上述對比，我們不難發現，應用服務架構是在不斷演進的，而且其演進背後存在一定的邏輯，服務架構的演進主要取決於以下2個維度：</p><ul><li>業務維度，技術架構是由業務發展所處的時期和階段決定的，技術架構要能夠解決業務發展過程中的痛點。在進行架構選型時，需要考慮這個架構是否能滿足當前業務的需求，業務需求能否隨著架構的演進實現增量式的迭代。</li><li>技術維度，一方面要滿足非功能需求，使得業務快速跟上技術生態的發展；另一方面出於商業的技術考量，比如去IOE、 去V、 採用開源的技術解決方案的需求，逐漸完成服務底層使用的商業軟件的技術隔離，滿足業務快速交付。</li></ul><h3 class=pgc-h-arrow-right>1.2 微服務架構的定義</h3><p>關於微服務的定義，此處引用ThoughtWorks首席科學家Martin Fowler給出的描述。</p><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3088f0090b6e4e12864ed98693d825d2><p class=pgc-img-caption></p></div><p>其中以下特性值得特別注意：</p><ul><li>微服務架構是一種架構模式，提倡將單⼀應⽤程序劃分成⼀組⼩的服務。</li><li>服務之間採用輕量級的通信機制。</li><li>服務可以獨立部署。</li><li>應當儘量避免統⼀的、集中式的服務管理機制。</li><li>具體的⼀個服務可以選擇合適的語⾔、⼯具對其進⾏構建。</li></ul><p>Martin Fowler對於微服務架構的表述更偏向學術上的定義，沒有給出明確的落地標準或規範，只是提供了一些構建微服務架構的原則。</p><h4 class=pgc-h-arrow-right>1）面向開發者和業務實現</h4><ul><li>拆分成粒度小的服務。</li><li>各自獨立的進程實現服務運行隔離。</li><li>服務運行通過輕量級的基於HTTP協議的RESTful API的通信機制進行。</li><li>服務關注圍繞業務領域之上構建。</li></ul><h4 class=pgc-h-arrow-right>2）面向服務的交付和運維</h4><ul><li>在服務交付方式上，強調可獨立部署。</li><li>支持去中心化的設計，服務一般不需要集中化的管理。</li></ul><h3 class=pgc-h-arrow-right>1.3 如何篩選微服務</h3><p>微服務架構模式有如此多的優點，那是不是所有的業務都要採用這種架構模式呢？又該如何篩選微服務？</p><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/09de299a58c5440e97a5e86b9c131207><p class=pgc-img-caption></p></div><p><br></p><p>左邊圖中，橫座標代表系統複雜度、縱座標代表開發生產力、藍色線表示微服務架構、綠色線表示單體架構。由圖可知，當項目複雜度較低時，單體架構的生產力更高；隨著項目複雜度越來越高，單體架構的生產力逐漸下降，微服務架構的生產力則顯著提高。</p><h4 class=pgc-h-arrow-right>1）3種場景可以考慮使用微服務（Are you tall enough? ）</h4><ul><li>規模大，團隊超過10人。</li><li>業務複雜度高，系統超過5個子模塊。</li><li>需要長期演進，項目週期超過半年。</li></ul><h4 class=pgc-h-arrow-right>2）其他因素篩選微服務</h4><ul><li>軟件功能變化頻繁，以快速迭代、縮短交付週期為核心的業務。</li><li>模塊有獨立的生命週期，微服務強調服務複用，減少重複造輪子，實現降本增效。</li><li>有獨立的隔離性需求和擴展性需求（容錯）。</li><li>簡化的外部依賴。比如Facade模式場景，後端系統使用統一的對外暴露的形式提供服務。</li></ul><h3 class=pgc-h-arrow-right>1.4 如何拆分構建微服務</h3><p>鑑別出哪些業務需要使用微服務架構模式後，需要決定如何拆分和構建微服務。</p><p><br></p><h4 class=pgc-h-arrow-right><br></h4><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4bdd747f9f3c41b5be8dfe58d78a9343><p class=pgc-img-caption></p></div><h4 class=pgc-h-arrow-right>1）服務拆分</h4><p>如何進行服務拆分，是在微服務過程中業務方經常會問到的問題。</p><p>其實很多團隊已經開始在做一些微服務化的工作，比如把大的工程拆分成不同的模塊或子系統，這種對業務模塊進行的靜態劃分，相當於已經完成了微服務改造的第一步拆分。</p><p>上圖是DDD（領域驅動設計）的開發模式，如果業務方案已經確定採用微服務的架構模式，在整個工程領域我們傾向於使用DDD模式來對業務架構和服務進行拆分。</p><p>DDD是基於領域模型的建模而不是數據庫表驅動的建模，需要我們對業務領域有深刻的洞察，瞭解服務的邊界和上下文信息傳遞。</p><p>康威定律指出：在微服務架構和設計系統組織，其產生的設計等價於組織間的溝通結構。就是說微服務架構不僅是技術上的演進，同時對使用技術的組織提出了要求，拆分的服務是我們和服務之間的溝通方式。</p><h4 class=pgc-h-arrow-right>2）微服務構建</h4><p>我們採用微服務的12因子作為微服務建設的架構原則。微服務的12因子也叫雲原生12因子，它提供了一種業務上雲或微服務改造的最佳實踐。重點介紹其中幾個因子：</p><ul><li>基準代碼，建議項目使用一份基準代碼、多份部署。項目在拆分時可能會存在多份基準代碼，造成大量重複性的不同版本的代碼共存的現象。在進行微服務構建時，需要把公共服務和公共代碼抽取出來，統一支撐不同版本的業務。</li><li>顯式依賴，顯式聲明依賴關係。對於 Java 程序，在 Gradle 或者Maven中寫明依賴關係；</li><li>配置，在環境中存儲配置。根據當前的環境變量決定使用什麼樣的配置文件。</li><li>後端服務，把後端服務當成一個附加資源。</li><li>構建、發佈、運行的分離機制，強調服務和構建在運行時，不可以直接修改運行中的代碼，而是需要通過構建發佈流程統一發布。</li><li>無狀態進程，以一個或多個無狀態的進程運行應用。</li></ul><h3 class=pgc-h-arrow-right>1.5 微服務架構2種建設思路</h3><p>微服務看起來非常好，但其實是需要一個技術體系或平臺體系來支撐的，如果沒有這樣一個服務架構平臺體系的建設，不推薦使用微服務。</p><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9c4b24d9aa6b427f99cf75d9e392492e><p class=pgc-img-caption></p></div><p><br></p><p>微服務架構建設分為2種思路：SDK模式、ServiceMesh模式。</p><h4 class=pgc-h-arrow-right>1）SDK模式</h4><p>典型代表是SpringCloud，SpringCloud是基於SpringBoot的一整套實現微服務的框架。SDK模式的底層運行平臺可以是PaaS平臺，也可以是Kuberneters平臺或Docker容器。</p><ul><li>優勢：面向應用和開發人員，定製化、協議支持靈活，適合完全自治的服務狀態，方便線下調試，對操作系統平臺無依賴。</li><li>缺點：應用需引入額外SDK依賴包，SDK本身佔用內存及系統資源，對業務是侵入性的；需要構建微服務基礎設施做業務能力支撐；需要使用SideCar模式實現異構系統集成。</li></ul><h4 class=pgc-h-arrow-right>2）ServiceMesh模式</h4><p>Istio 是ServiceMesh模式的典型代表。ServiceMesh模式的優缺點與SDK模式正好相反。</p><ul><li>優勢：不需要額外引入SDK依賴包，對應用無侵入，且對Kubernetes天然友好支持。</li><li>缺點：部署比較複雜，對底層系統有一定的依賴；通訊協議類型支持受限，需要依賴Mesh平臺兼容。</li></ul><h2 class=pgc-h-arrow-right>二、SpringCloud微服務生態體系介紹</h2><p>SpringCloud是基於SpringBoot發展而來的一整套成熟的微服務架構解決方案。SpringCloud具有以下優勢：</p><ul><li>面向開發者，以開發者為中心，開發者生態友好。</li><li>以Java技術棧為主要開發語言，代碼可複用，微服務轉型成本低。</li><li>基礎設施完備，提供端到端的微服務架構解決方案。</li><li>有很多大廠做背書，如Pivital、Netflix,、alibaba等公司都是其生態和源代碼貢獻者，技術經歷過大規模商業應用的考驗。</li></ul><h3 class=pgc-h-arrow-right>2.1 SpringCloud的技術生態</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/743448e3b360456aab817375ab7371b1><p class=pgc-img-caption></p></div><p>SpringCloud本身也是一個逐漸演進的架構模式：最早是基於IOC/AOP的編程思想產生的；然後在Spring的基礎上發展出SpringBoot，基於註解的方式實現快速的應用開發；後來在SpringBoot的基礎上開發出SpringCloud底層微服務構架。</p><p>上圖展示了SpringCloud的技術生態，SpringCloud技術棧包含了很多技術模塊，比如Ribbon、Zuul、Eureka、SpringCloud Stream等，這些技術模塊共同組成了SpringCloud生態圈，為開發者提供豐富的微服務架構基礎設施支撐。</p><h3 class=pgc-h-arrow-right>2.2 微服務和SpirngCloud架構的複雜性</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/51ec6c89318c4f4bac8a65c77d6c0545><p class=pgc-img-caption></p></div><p>微服務和SpirngCloud的架構是比較複雜的，如配置管理、服務註冊與發現、API網關、打包部署調度、安全、服務故障自愈、流量控制和彈性伸縮等非功能需求，都是微服務需要包含的架構模塊。上圖中藍色字表示SpirngCloud、Kubernetes等用來解決雲原生和微服務架構問題的技術方案。</p><p>從圖中可以看出微服務架構的複雜性，要想實現一套微服務架構來支撐和交付業務，需要在底層封裝很多基礎組件，構建一套底層基礎架構來隔離底層的非功能需求，做到讓業務系統無感知、平滑地對外提供服務。</p><h2 class=pgc-h-arrow-right>三、宜信微服務架構和SIA網關的4種模式</h2><p>SpringCloud提供的框架或基礎設施是一個半成品，我們在SpirngCloud的基礎上進行了二次開發，抽象和封裝了一些微服務架構的通用基礎設施平臺，不同的業務團隊共享這些基礎設施，降低技術學習和接入成本，讓業務團隊更專注於業務邏輯的實現，聚焦業務開發。</p><h3 class=pgc-h-arrow-right>3.1 宜信微服務架構</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ee3be112fd2c4579bb1547ab917854f9><p class=pgc-img-caption></p></div><p>上圖所示為宜信的微服務架構：</p><ul><li>微服務網關，sia-gateway使用了去中心化的網關接入方案。</li><li>元數據服務層，用Eureka-plus和sia-config對註冊中心Eureka和配置中心做了增強與優化。</li><li>任務管理，基於微服務的思想，開發和開源了微服務任務調度平臺SIA-TASK。</li><li>容器平臺，實現了快速的自動化構建、部署和服務編排。</li><li>DevOps，微服務的交付頻率、速度比較快，需要有持續集成、持續開發工具和手段來保障項目質量和服務正常運行，對此我們有自研的UAVStack監控系統、自動化測試系統等工具鏈。</li></ul><h3 class=pgc-h-arrow-right>3.2 SIA微服務網關架構</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/318b395aecfc4caa85dde3e0b7937894><p class=pgc-img-caption></p></div><p>有別於其他的架構模式，微服務架構裡出現了一個重要的基礎設施變化-增加了微服務網關模塊。網關主要解決的問題是：服務拆分之後，每一個服務粒度都比較小，服務之間的交互會呈現網狀的結構，需要一個聚合的節點來聚合這些微服務。</p><p>因此我們在SpringCloud微服務架構的基礎上二次開發出SIA微服務網關，如圖所示，重點介紹其中的2個核心模塊：</p><ul><li>網關組，網關組裡封裝了兩種網關：同步網關和異步網關。</li><li>OAM，自助式網關管理平臺，所有業務節點的生命週期管理都通過這個模塊來進行。</li></ul><h3 class=pgc-h-arrow-right>3.3 SIA微服務網關的4種模式</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4ff41c70a60044c98f9ac231f1a16905><p class=pgc-img-caption></p></div><p>SIA微服務網關的4種模式：同步託管式、同步註解式、異步託管式、異步註解式。</p><h4 class=pgc-h-arrow-right>1）同步託管式</h4><p>採用單一源碼庫進行代碼管理，交付方式是容器交付，去中心化的設計。目前大部分生產環境和業務都採用同步託管模式。</p><ul><li>優點：網關交付對業務方完全透明；只要在容器平臺申請一個網關資源，就可以得到網關服務；基於Filter開發運維簡單，容量小。</li><li>缺點：定製化不夠強。</li></ul><h4 class=pgc-h-arrow-right>2）同步註解式</h4><p>在跟業務團隊對接時，我們發現很多業務系統已經實現了一些獨特的業務邏輯，難以遷移到網關，所以我們採用一種比較兼容的註解的方式去適應這些業務邏輯，在原有項目的基礎上加一個註解，將它們納入到整個網關管理體系中來。同步註解式是基於SpringCloud-Zuul 1實現的分佈式微網關體系，管理業務方源碼庫，根據業務方環境進行交付。</p><ul><li>優點：對項目的控制力比較強，業務團隊獨立運維，支持擴展定製化；基於Filter開發運維簡單，容量小。</li><li>場景：業務定製化場景比較多。如果要加載初始化、加大資源，或對業務的Filter攔截機制有定製化需求，都可以用同步註解模式。</li></ul><p>SpringCloud和Zuul使用的後端技術是基於Servlet，其線程處理模型是一個請求對應一個線程，當請求量過多，線程棧溢出，就會佔用非常多的資源，導致網關無法提供額外的線程資源來處理新進來的請求。因此我們採用了SpringCloud自研的SCG技術方案。</p><p>SpringCloud-Gateway基於Netty和反應式編程模式，採用收斂式的線程處理模型，只要用少數線程就可以處理高併發的流量請求。目前已經實現了基於SpringCloud-Gateway的異步模式，當同步模式在線上運行過程中出現資源透支的情況，就選擇使用異步模式。異步模式也分為2種：異步託管式、異步註解式。</p><h3 class=pgc-h-arrow-right>3）異步託管式</h3><p>通過單一源碼庫進行代碼管理，採用容器交付。主要使用場景是流量型，如果業務多對高併發、高吞吐場景，建議使用異步託管式。</p><h4 class=pgc-h-arrow-right>4）異步註解式</h4><p>如果想在異步網關基礎上做定製開發，可以使用異步註解的模式。</p><p>網關的4種模式來源於業務的需求：為兼容業務已有邏輯演進出註解模式；當出現性能瓶頸、資源浪費時，採用異步模式應對高併發流量。</p><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/532c1ec713de469ea64e825f77634fed><p class=pgc-img-caption></p></div><p>上圖是網關測試環境的一個截圖， 包括上述4種模式。每一個小方格代表業務的一個網關組，方格中的小圓圈代表它屬於哪一種網關。業務系統在選擇網關模式時要做一個判斷：訴求是支持業務的快速集成，還是對流量有一定要求。</p><h3 class=pgc-h-arrow-right>3.4 SIA微網關的核心Feature</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/37c2665e79ff4fe5acb653676d8cb5bd><p class=pgc-img-caption></p></div><p>如圖將SIA微網關的核心Feature分成2個層面：</p><ul><li>數據面，負責數據包的處理邏輯。路由轉發、負載均衡、灰度發佈、日誌審計、熔斷限流等都是從數據層面對流量進行管理。</li><li>控制面，負責服務粒度上的管理。統一視圖管理、多租戶管理、註冊中心、配置管理、路由組件綁定等是從控制層面來保障和管理服務。</li></ul><h3 class=pgc-h-arrow-right>3.5 SIA微網關對微服務的生命週期管理</h3><p>微服務網關貫穿了整個微服務生命週期的管理。</p><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/06d676136be54e929069734f8b82d4fd><p class=pgc-img-caption></p></div><p>SIA微服務網關的功能包括：</p><ul><li>Swagger UI、模塊複用對應服務文檔中心模塊的功能。</li><li>動態路由、共享能力集中在分佈式網關節點。</li><li>日誌管理、管控組件是網關Master提供的功能。</li></ul><p>各功能模塊對應的生命週期：</p><ul><li>服務文檔中心，對應整個軟件生命週期的初期開發和設計階段，網關提供一個個統一的API視圖，前端和後臺可以通過Swagger UI來聯調開發。</li><li>分佈式網關節點，在開發和部署階段會涉及到一些共享能力的部署和運行。</li><li>網關Master，在運維階段通過自動化運維提高運維效率；在管理方面，提供數據統計的功能，生成數據報告用於管控。</li></ul><p>SIA微服務網關作用於軟件生命週期的各個階段，通過標準協同、業務測試/前端後端溝通、服務模塊複用、可視化管理、數據統計管控等實現業務的統一融合、降本增效。</p><h3 class=pgc-h-arrow-right>3.6 總結：微服務架構與中臺&後臺</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/772f7de87f77485396d58efd29a68a5b><p class=pgc-img-caption></p></div><p>2016年，Gartner 發佈了一個關於應用變化速率的報告《Pace-Layered Application Strategy》，以應用變化速率為標準將業務應用分為三層：</p><ul><li>SOI-敏態業務：比如互聯網業務，需求變更快，要求快速迭代 、快速交付。</li><li>SOR-穩態業務： 比如傳統業務，變更週期⻓、變化頻率低、變化成本高、變化⻛險高。</li><li>SOD-中臺業務： 齒輪匹配失衡，中臺就像是在前臺與後臺之間添加的⼀組“變速⻮輪”，將前臺與後臺的速率進行匹配，提升⽤戶響應力。</li></ul><p>中臺的目標是圍繞業務組織進行可複用能力的有機整合，協助業務落地實施、改造、試錯、轉型，提升組織效率，降低系統成本。</p><p>中臺和微服務有什麼關係呢？微服務架構是面向開發的架構，很多基礎服務可以沉澱到微服務架構裡，同時，微服務架構把中臺的能力快速釋放出來，滿足敏態業務快速變更的業務需求。</p><h2 class=pgc-h-arrow-right>四、應用場景及典例分析</h2><h3 class=pgc-h-arrow-right>4.1 分解&聚合</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d604f6fc170c489c8e6275dac6d6138b><p class=pgc-img-caption></p></div><p><br></p><p>上圖是路由管理裡的一個截圖，當一個大的單體或不同的服務要對外提供統一服務時，可以把服務聚合到網關上；同時一個巨型應用也可以通過網關分解成微服務。</p><h3 class=pgc-h-arrow-right>4.2 複用&個性化</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fa51208e48144575a9852e47f737ab74><p class=pgc-img-caption></p></div><p>微服務架構中有很多非功能需求，或者說是技術導向型的需求，包括日誌管理、限流、藍綠部署、版本管理等，可以通過組件的方式下沉到網關上，業務系統通過將服務與組件綁定實現對組件功能的複用。</p><p>我們還提供了一個插件機制，當業務有獨特的需求，可以根據其業務邏輯在網關上進行功能的個性化定製。</p><h3 class=pgc-h-arrow-right>4.3 API&契約</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a87d668c59b34159aba4be9edc305514><p class=pgc-img-caption></p></div><p>在開發或前後端聯調時，前後端可以通過網關服務文檔中心的Swagger UI功能模塊訪問後端服務調用接口的分析。</p><p>只要在後端服務之上加一個Swagger註解，網關就可以把所有對外暴露的服務抓取出來，這相當於是一種契約式的開發。</p><h3 class=pgc-h-arrow-right>4.4 容錯&保護</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/972b1ba1f81641a0bf5af70f528fa6eb><p class=pgc-img-caption></p></div><p>我們對網關應用做了容錯和保護機制，當然這也是SpringCloud本身自帶的一個技術模塊，我們的容錯機制是基於SpringCloud的Hystrix實現的，當發現後端服務調用請求一直在返回錯誤時，會開啟熔斷，避免由於一直髮送錯誤請求導致雪崩的情況發生。</p><p>除此之外，我們還會採用Guava限流的方式對服務進行保護。在大促或秒殺的場景下，會有大量請求進來，這時會通過限流來保護服務的穩定。</p><h3 class=pgc-h-arrow-right>4.5 監控&治理</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d9ece640a0fd445a8e68c5cd280cbe23><p class=pgc-img-caption></p></div><p>宜信微服務架構平臺有一個很重要的功能是網關服務運行狀態和後端連接狀態可觀測，提供了很多監控方面的功能組件，如圖所示，可以統計當前請求的頻率、服務健康度。</p><p>預警方面重點介紹網關拓撲圖。當請求失敗，當前鏈路出現異常，通過網關拓撲圖可以快速跟蹤和判斷業務系統哪個節點出現問題，然後對有問題的節點進行摘除或其他操作。</p><p>我們的網關運行在Docker平臺上，Docker平臺在出現問題或重啟之後日誌會丟失，我們的日誌系統會把日誌歸集，存儲到ES中，便於對歷史日誌溯源。</p><h3 class=pgc-h-arrow-right>4.6 統計&分析</h3><p><br></p><div class=pgc-img><img alt=宜信微服務架構落地及其演進｜分享實錄 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/66166f45e554450a8916dab17eb8b340><p class=pgc-img-caption></p></div><p>網關中有一個組件叫“監控統計”，這個模塊默認是不打開的，如果你想對請求做延時，或者想看請求的明細調用情況，可以通過組件管理中打開這個組件，對容器的請求做統計和分析。監控統計組件會對當前請求的最大延遲、最小延遲、失敗個數、平均延遲進行排序，一目瞭然。</p><h2 class=pgc-h-arrow-right>五、微服務化架構建設遇到的問題</h2><h3 class=pgc-h-arrow-right>5.1 設計初期的問題</h3><h4 class=pgc-h-arrow-right>1）如何隔離業務網關，同時有統一的管理視圖？</h4><p>構建微服務網關初期，業務同事比較關注我們的業務網關和別人的網關是否存在耦合問題，他的業務請求是否會影響到我。我們選用去中心的網關設計方式，同時通過OAM實現對所有網關節點的統一管理。</p><h4 class=pgc-h-arrow-right>2）平臺型系統建設初期是否要考慮同步異步網關融合？</h4><p>我們的微服務網關是按照DDD領域驅動模式來建設的，沒有把網關綁定在某一個特殊的技術實現上，而是把它作為一個抽象封裝來統一管理後端的節點，如果換一種技術實現也不會影響到前端業務的正常工作。因此在架構建設初期要考慮清楚你的業務系統和後端技術架構之間是否解耦。</p><h3 class=pgc-h-arrow-right>5.2 使用開源方案的問題</h3><h4 class=pgc-h-arrow-right>3）開源系統本身的bug</h4><p>雖然每一種開源方案在開源之前都經過了長時間的考驗，但其實依然可能存在bug，基於這些開源方案進行二次開發時仍可能遇到一些坑，我們會不斷對開源系統進行bug修復和功能增強。</p><h4 class=pgc-h-arrow-right>4）系統的性能問題</h4><p>Zuul本身存在性能瓶頸，當出現性能問題時，我們考慮是不是要用線程收斂的模式來增強網關的性能。</p><h3 class=pgc-h-arrow-right>5.3 上線生產運維方面的問題</h3><h4 class=pgc-h-arrow-right>5）如何克服Eureka註冊中心的CAP問題？</h4><p>在網關應用中會遇到Eureka的CAP問題，因為Eureka消息註冊以可用性（Availability）優先，在一致性（Consistency）上相對較弱。為解決這個問題，我們基於Eureka的特點提供SynchSpeed服務，如果業務需要保證狀態一致性，可以開啟這個服務。</p><h4 class=pgc-h-arrow-right>6）SpringCloud與SpirngBoot不同版本的兼容問題？ K8S平臺與微服務註冊中心狀態同步？</h4><p>這兩個問題是指當雲容器平臺的狀態發生變更，卻沒有及時通知到註冊中心，導致服務在兩個平臺的狀態不一致，這就需要做上下文關聯繫統（StakeHolder）的整合。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>宜信</a></li><li><a>務架構</a></li><li><a>演進</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E5%AD%B8/3170684d.html alt=從架構的演進之路，一起聊聊微服務架構 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4b93a47d192b42449ab8d6ef274f7bdd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/3170684d.html title=從架構的演進之路，一起聊聊微服務架構>從架構的演進之路，一起聊聊微服務架構</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/604d6a24.html alt=光通信傳送網的發展與演進 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/37ec00024ce9c81c7060 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/604d6a24.html title=光通信傳送網的發展與演進>光通信傳送網的發展與演進</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9be3efd7.html alt=數字化演進：從互聯網+到全鏈路數字化 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/6c7d0a20c6454717944d6921ce56a06e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9be3efd7.html title=數字化演進：從互聯網+到全鏈路數字化>數字化演進：從互聯網+到全鏈路數字化</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/17b21f70.html alt=深入理解微服務架構spring的各個知識點（面試必問知識點） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/b970816462884435bec0b1a8fc618b0b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/17b21f70.html title=深入理解微服務架構spring的各個知識點（面試必問知識點）>深入理解微服務架構spring的各個知識點（面試必問知識點）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a46b181d.html alt=古代書寫材料的演進與魏晉史學的發展 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/f658572243034c679691e700acd6f17d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a46b181d.html title=古代書寫材料的演進與魏晉史學的發展>古代書寫材料的演進與魏晉史學的發展</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d54e0b8c.html alt=從網絡架構演進的前世今生詳解5G各NF網絡功能體 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/56c5f01170a843fea40bd4f1a164b677 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d54e0b8c.html title=從網絡架構演進的前世今生詳解5G各NF網絡功能體>從網絡架構演進的前世今生詳解5G各NF網絡功能體</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4a22d3c2.html alt=數據管理的演進：從響應業務到創造業務 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RRq5QDz4CJOKdP style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4a22d3c2.html title=數據管理的演進：從響應業務到創造業務>數據管理的演進：從響應業務到創造業務</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3f02242c.html alt="從算法到硬件，一文讀懂2019年 AI如何演進" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e7e072df7712458da3a6fba4d39a238d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3f02242c.html title="從算法到硬件，一文讀懂2019年 AI如何演進">從算法到硬件，一文讀懂2019年 AI如何演進</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f2b42fdf.html alt="解析｜從算法到硬件，一文讀懂2019年 AI如何演進" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/5be6472e671640b0979b272bc917141b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f2b42fdf.html title="解析｜從算法到硬件，一文讀懂2019年 AI如何演進">解析｜從算法到硬件，一文讀懂2019年 AI如何演進</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cec715b8.html alt=深入聊聊微服務架構的身份認證問題「轉」 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/f2dd2ce800384b23b0223080c34eea42 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cec715b8.html title=深入聊聊微服務架構的身份認證問題「轉」>深入聊聊微服務架構的身份認證問題「轉」</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/07172ae4.html alt=宜信開源｜拆解大數據總線平臺DBus的系統架構 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4cc17ffc7a754fb3855226f663d85c90 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/07172ae4.html title=宜信開源｜拆解大數據總線平臺DBus的系統架構>宜信開源｜拆解大數據總線平臺DBus的系統架構</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/18ecd0cd.html alt="API 演進的正確方式" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3029dbe3879e4107b46de48e15603e1b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/18ecd0cd.html title="API 演進的正確方式">API 演進的正確方式</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/21f88840.html alt=趙晶：論日本中國古文書學研究之演進——以唐代告身研究為例 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RXLgj3DF3H344d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/21f88840.html title=趙晶：論日本中國古文書學研究之演進——以唐代告身研究為例>趙晶：論日本中國古文書學研究之演進——以唐代告身研究為例</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/016fe72e.html alt="Slack 技術演進模式：在正確的時間採用革命性的技術" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/32fbc482f5ab4eb283b17c68f3e92e00 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/016fe72e.html title="Slack 技術演進模式：在正確的時間採用革命性的技術">Slack 技術演進模式：在正確的時間採用革命性的技術</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/5ad27ed6.html alt=中國改革理論的演進邏輯 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ce407cc4b89b427a8508ccb3679ee058 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/5ad27ed6.html title=中國改革理論的演進邏輯>中國改革理論的演進邏輯</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>