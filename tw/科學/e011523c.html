<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ | 极客快訊</title><meta property="og:title" content="硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/98a87e846b1d47f68d03a1784220203f"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/e011523c.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/e011523c.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/e011523c.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/e011523c.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/e011523c.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/e011523c.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/e011523c.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/e011523c.html><meta property="article:published_time" content="2020-11-14T20:51:53+08:00"><meta property="article:modified_time" content="2020-11-14T20:51:53+08:00"><meta name=Keywords content><meta name=description content="硬核分享：遊戲中迷人天空的顏色是如何製作出來的？"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E5%AD%B8/e011523c.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>硬核分享：遊戲中迷人天空的顏色是如何製作出來的？</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E5%AD%B8.html>科學</a></span></div><div class=post-content><p>以下文章來源於騰訊遊戲學院 ，作者spaceoddity42</p><p><br></p><p>騰訊遊戲學院由騰訊互動娛樂發起，致力於打造遊戲知識分享和交流平臺，專注建設遊戲職業培訓和發展體系。學院通過提供遊戲類專業培訓課程、建設遊戲職業發展通道、開展豐富的校園活動及行業活動，幫助在校生和遊戲從業者提升職業競爭力，成就遊戲創想夢。</p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/98a87e846b1d47f68d03a1784220203f><p class=pgc-img-caption></p></div><p>轉載請註明文章來源於騰訊遊戲學院</p><p><br></p><p><em>文丨spaceoddity42 騰訊互動娛樂 工程師</em></p><p><br></p><p>幾個世紀以來，天空一直是許多藝術家迷戀的主題，他們試圖儘可能準確地描繪其顏色。同樣的，在遊戲開發中，天空渲染對於遊戲開發者也一直是一個迷人的主題，本文理論部分譯自scratchapixel，介紹了天空渲染的理論基礎，並在此基礎上了建立相應的數學模型，最後在ShaderToy上通過Pixel Shader來實現相應的算法。</p><p><br></p><p>本章我們將學習大氣散射，推薦先閱讀體積渲染和次表面散射的內容（詳見www.scratchapixel.com），它們和本主題包含類似的概念，大氣散射可以看作是體積渲染的擴展。</p><p><br></p><p><strong>1、大氣散射的理論基礎</strong></p><p><br></p><p><strong>1.1 介紹</strong></p><p><br></p><p>幾個世紀以來，天空一直是許多藝術家迷戀的主題，他們試圖儘可能準確地描繪其顏色。在19世紀到20世紀之前，許多物理學家和數學家痴迷於弄清楚是什麼導致天空在日落和日出時呈現橙色，白天呈現藍色。從歷史上看，大氣散射的發現歸功於瑞利（又名John Strutt，獲得諾貝爾獎的英國物理學家），其主要工作是在19世紀產生的（瑞利接替了劍橋大學的麥克斯韋，後者因其在電磁方面的貢獻而聞名，計算機圖形很大一部分的研究與麥克斯韋的工作有關，瑞利還和普朗克研究了黑體）。大氣散射也會對物體的外觀產生影響，這種效應被稱為空氣透視（繪畫中多稱為大氣透視），被萊昂納多達芬奇首次觀察、研究和應用在他的畫作中（事實上，這種技術可以在達芬奇作品之前的繪畫作品中找到）。隨著物體和觀察者之間的距離增加，物體的顏色被大氣的顏色所取代（對於天空來說，它通常在白天呈現藍色，日出和日落時呈現紅橙色）。這是一個重要的視覺線索，因為人們通過比較它們相對於彼此有多藍來判斷場景中物體的距離。在（數字）繪畫中，空氣透視可以極大地幫助增加圖像的深度（大腦可以更容易地處理比另一個更遠的物體），如下為達芬奇畫作複製品（注意後面的岩石的顏色受到大氣的影響）。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e1f5c4463d0f49319ba419ff70b6fcef><p class=pgc-img-caption></p></div><p><br></p><p>在計算機圖形學史上，Nishita在1993年發表了一篇開創性的論文”Display of the Earth Taking into account Atmospheric Scattering”，他在這篇論文中描述了一種模擬天空顏色的算法，有趣的是他的這篇論文和他在1996年寫的關於同一主題的另一篇論文"Display Method of the Sky Color Taking into Account Multiple Scattering"不完全是關於大氣模擬，更多是關於從外太空看到的地球的真實渲染（包括渲染海洋表面、雲層和大陸）。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b239ccefa2bc44e69a051f2a7fb6e644><p class=pgc-img-caption></p></div><p>Figure 1: Top, a real photograph of the Earth from outer space. Bottom, a simulation using Nishita's model. These images have been copied from the paper "Display of the Earth taking into account Atmospheric Scattering" written by Nishita in 1993 (c) Siggraph.</p><p><br></p><p>這提醒了我們在這些年裡，計算機圖形技術的發展是由製造業推動的，用於精確模擬其產品或提供3D虛擬訓練環境，而不是娛樂行業（電影和遊戲）。Nishita描述的模擬天空的技術從他的時代以來沒有太大變化，在該領域的大部分研究都集中在GPU上實現Nishita的算法，而模擬質量沒有任何明顯改善（更多關注的是速度和實時仿真）。在1999年發表於Siggraph的一篇論文”A Practical Analytic Model for Daylight”中，Preetham等人描述了另一種天空模型，正如其標題所示，這是一個分析模型，它提供了對天空顏色的精確模擬，但它比Nishita提出的技術有更多限制（例如，該模型僅適用於位於地面上的觀察者）。值得一提的是Jensen等人在2011年Siggraph上發表的一篇模擬夜空的論文”A Physically-Based Nightsky Model”，本章將給出Nishita模型的實現。</p><p><br></p><p>在後面小節中，我們將描述各種現象，它們組合在一起呈現天空的顏色，然後我們將展示Nishita的算法如何模擬這些現象，一旦我們在程序中實現了該模型，我們可以輕鬆擴展該技術以模擬空氣透視，通過改變模型的參數，我們還可以創建外星天空。</p><p><br></p><p><strong>1.2 大氣模型</strong></p><p><br></p><p>大氣層是行星周圍的一層氣體，由於行星的引力，大氣層保持在適當的位置，大氣層的主要關注點是它的厚度和成分（組成大氣層的不同成分）。地球大氣層厚度約為100km（由卡門線劃定，卡門線是公認的外太空與地球大氣層的分界線），它由氧氣、氮氣、氬氣（瑞利發現的氣體）、二氧化碳和水蒸氣組成。然而，在模擬中，我們將使用60km的厚度（我們只考慮在地球大氣的前兩層，對流層和平流層中的散射）。如果你閱讀有關體積渲染的內容（建議首先看這部分內容再來看本篇內容），你將知道光子在與粒子碰撞時會散射。當光在某個方向上穿過一個體積（大氣）時，光子在與粒子碰撞時會往其他方向上偏轉，這種現象稱為散射。光被粒子散射的頻率取決於粒子的性質（主要是它們的大小）和它們的密度（單位體積中有多少粒子/分子）。我們現在已經知道了地球大氣層的分子大小，我們也知道它們的濃度/密度。我們將使用這些科學測量數據來進行大氣散射模擬。地球周圍大氣層的另一個重要方面是這些顆粒的密度隨高度的增加而減小。換句話說，比如在海平面上每單位立方體空氣中的分子比海洋上方2公里多。這是一個重要的事實，因為散射量取決於我們剛剛提到的分子密度。當光在大氣層中從上層傳播到地面時，我們需要沿著光線按固定間隔對大氣密度進行採樣，並根據這些樣本位置處的大氣密度計算散射量（我們將使用數值積分，下一步會詳細解釋）。大多數論文（包括Nishita的論文）都假設大氣密度隨高度呈指數下降。換句話說，它可以用以下形式的簡單方程建模：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/618fdbdd51224508b229d520841266e1><p class=pgc-img-caption></p></div><p><br></p><p>其中density(0)是海平面的空氣密度，h是我們測量大氣密度時的高度（海拔高度），H是大氣密度均勻時的大氣厚度（在科學論文中，H被稱為大氣標高，大氣密度每經過一段距離H其值就減少為原來的值的1/e，H取決於溫度）。一些論文聲稱這個模型是一個很好的近似，但是其他一些人聲稱它不準確，並且更喜歡將天空密度模擬為一系列同心層，每個同心層由它們的厚度和密度決定。（論文出處未知）</p><p><br></p><p>將天空密度建模為一系列層（在Nishita的論文中稱為球殼）從計算的角度來看具有優勢。由於我們將沿著光線朝著觀察者的路徑執行數值積分，在密度高的大氣中採集的樣本比在密度低的情況下采集的樣本更重要，因此沿著光線執行“固定步長”積分將導致收斂性差。如今計算機速度如此之快以至於我們可以通過固定步長來強制執行此計算，但在Nishita那個時候，優化算法是必要的。因此，Nishita提出了一個模型，其中大氣層用一系列球形殼體表示，在低海拔使用較小間隔，在高海拔使用較長間隔。但請注意，在論文中發表的圖表中，層的厚度似乎非常像按指數形式變化的，這並不令人驚訝，因為每個殼的半徑在Nishita的模型中由空氣分子的密度分佈精確確定。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7aab62ebf021401886496904bcd2cbaf><p class=pgc-img-caption></p></div><p><br></p><p>大氣層由小顆粒（空氣分子）組成，小顆粒也會在低空與較大的顆粒混合，稱為氣溶膠。這些顆粒可以是由風揚起的灰塵或沙子，也可以是因為空氣汙染而存在的任何顆粒。它們肯定會對大氣的外觀產生影響，特別是因為它們不像空氣分子那樣散射光線。空氣分子對光的散射稱為瑞利散射，氣溶膠對光的散射稱為米氏散射。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2fe0721858a54e54a32dcab2518f95e0><p class=pgc-img-caption></p></div><p>Figure 2: aerosols present in the atmosphere are responsible for haze.</p><p><br></p><p>簡而言之，瑞利散射（空氣分子散射光）是造成天空藍色（以及日出和日落時的紅橙色）的原因，而米氏散射（氣溶膠散射光）通常是造成汙染城市上方白灰色霧霾的原因（陰霾掩蓋了天空的清晰度，見圖2）。如果沒有提到使用者需要指定行星和天空的半徑，模型將是不完整的，這些數字將用於計算沿觀察者和光線方向上樣本位置的高度。對於地球，我們將使用Re = 6360 km（e代表地球）和Ra = 6420 km（a代表大氣層）。該模型中與距離相關的所有距離和參數應在同一單位系統中表示（km、m等）。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15670e2690074d229772a98c108d69fc><p class=pgc-img-caption></p></div><p>Figure 3: a simple graphical representation of the atmospheric model we will be using in this lesson. It is defined by the radius of the planet (Re) and the radius of the atmosphere (Ra). The atmosphere is made of aerosols (mainly present at low altitude) and air molecules. Density of particles decreases exponentially with altitude. This diagram is not to scale.</p><p><br></p><p>對於大氣模型，這可能是棘手的，因為行星的大小可能很大。對於這樣的尺寸，公里通常是更合適的選擇。然而，散射係數非常小，並且它們更容易用米或毫米（對於光波長甚至用納米）來表示。選擇一個好的單位也是因為浮點數精度的限制（也就是說，如果數字太大或太小，計算機對這些數字的浮點表示可能會變得不準確，從而導致計算錯誤）。模型的輸入參數可以用不同的單位表示，並由程序內部轉換。</p><p><br></p><p>最後，我們通過指定天空的主要照明來源是太陽這一點來完成我們對模型的描述，太陽離地球太遠，我們可以假設所有到達大氣層的光線都是相互平行的，我們將進一步展示這種假設如何簡化模型的實現。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/db571038605e4e15b358d6b2f09d0d75><p class=pgc-img-caption></p></div><p>Figure 4: the sun is so far away from the Earth, that each light ray reaching the Earth's atmosphere can be considered as being parallel to each other.<br></p><p><br></p><p><strong>1.3 瑞利散射</strong></p><p><br></p><p>瑞利在19世紀晚期發現了空氣分子對光的散射。他特別指出，這種現象具有強烈的波長依賴性，更準確地說，空氣分子散射的藍光比綠光和紅光更多（ps：更容易散射藍光）。這種形式的散射和他提出的計算由分子（例如我們在大氣中找到的分子）組成的體積的散射係數的方程，僅適用於尺寸遠小於構成可見光的波長的顆粒（粒子應至少比散射波長小十分之一）。可見光的波長在380到780 nm之間變化，440,550和680分別被認為是藍色，綠色和紅色光的波長峰值，我們將在本文的其餘部分使用這些值。瑞利散射方程提供了計算已知分子密度的體積的散射係數。在關於大氣散射的文獻中，散射係數由希臘字母β（beta）表示。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/562987561f634ae2a1a3301ff5d19620><p class=pgc-img-caption></p></div><p><br></p><p>上標S用於標識散射，下標R用於標識瑞利（用於將這些係數與米氏散射係數區分開）。在這個等式中，h是高度，λ是波長，N是海平面的分子密度，n是空氣的折射率，是大氣標高。在我們的模擬中，我們將使用=8km（如果需要，請參見網上的大氣標高以獲得更精確的測量數據）。正如你所看到的，具有短波長的光（例如藍光）的β值比長波長的光（紅色）更高，這解釋了白天天空呈現藍色的原因。當來自太陽的光穿過大氣層時，相比綠色和紅色光，藍色光更多地向觀察者散射。為什麼在日出和日落時會出現紅橙色？在此種情況下（日出、日落時），相比於太陽高於頭部（天頂位置）時,來自太陽的光必須在大氣層中行進更長部分以到達觀察者的位置。那距離相當長，大部分藍光在到達觀察者的位置之前已經散開，而一些不像藍光一樣散射的紅光仍然存在。因此，日出和日落時的天空呈現紅橙色（有時可以是紫色或略帶綠色）。我們可以使用一個N，n的測量值來計算β，但是我們將使用在海平面的散射係數的預計算值（波長440、550和680nm，對應的散射係數分別是：</p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/57a86e16f567410e82405032e573ee9a><p class=pgc-img-caption></p></div><p>、</p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/b3d339e7e88743a88ad1aad51ea60999><p class=pgc-img-caption></p></div><p>、</p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/31fc608fb4ff4e178acde1356e626d64><p class=pgc-img-caption></p></div><p>，注意藍光的散射係數大於綠光和紅光的散射係數）。通過應用方程的指數部分（右項），我們可以調整任何給定高度h的這些係數。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e8c72b55cab642bfb5d4bb70071e52a6><p class=pgc-img-caption></p></div><p><br></p><p>Nishita的論文和我們在本篇中提到的其他論文的主要問題之一是他們要麼沒有給出N，n等的值來生成論文中顯示的圖像。在使用測量數據時，論文的作者通常不會引用它們的來源。在海平面上尋找分子密度的科學數據並不容易，如果你有任何關於此主題的有用鏈接或信息，你可以向我們提供，我們希望收到你的來信。我們在本篇中使用的海平面散射係數可以在兩篇論文中找到："Efficient Rendering of Atmospheric Phenomena", by Riley et al. and "Precomputed Atmospheric Scattering" by Bruneton et al.</p><p><br></p><p>我們不會詳細介紹空氣密度，但可以在互聯網上找到有關此問題的有趣信息。在本篇中，我們真正需要的是海平面的平均散射係數，它們可以很好地重建天空的顏色，但是學習如何計算這些係數將會讓任何想要更好地控制大氣模型的好奇讀者感興趣。</p><p><br></p><p>如果你閱讀有關體積渲染的內容，你將會知道用於渲染參與介質的物理模型是散射係數，吸收係數和相函數，它描述光在與粒子碰撞時散射的程度和方向。到目前為止，在本篇中，我們只給出了地球大氣層的散射係數值（並解釋瞭如何計算）。對於大氣散射，通常認為吸收係數可忽略不計，換句話說，我們將假設大氣不吸收光。還記得在體積渲染的內容中，我們在渲染參與介質時使用的物理模型中需要的衰減係數是吸收係數和散射係數的總和，因此（因為吸收係數為零）衰減係數可以表示為：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a58fc4e59744462db613014767e85133><p class=pgc-img-caption></p></div><p><br></p><p>瑞利相函數看起來像這樣：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0eee2a2febe049e6824620379a46807c><p class=pgc-img-caption></p></div><p><br></p><p>其中μ是光與視線方向之間角度的餘弦（見圖8）。</p><p><br></p><p><strong>1.4 米氏散射</strong></p><p><br></p><p>米氏散射在某種程度上類似於瑞利散射，但適用於尺寸大於散射波長的粒子（比如我們在地球大氣層的低海拔地區發現的氣溶膠）。如果我們將瑞利方程應用於氣溶膠，不會得到令人信服的圖像。渲染散射係數的米氏方程如下所示：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/535e5ab012804b2593cb124cfa65b411><p class=pgc-img-caption></p></div><p><br></p><p>下標M標識米氏散射，注意，對於米氏散射存在特定的大氣標高，其通常設定為1.2km。與瑞利散射相反，我們不需要方程來計算米氏散射係數。我們將使用海平面測量值來代替。對於米氏散射，我們將使用：</p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b0077de4bb674b349cee76823f549edc><p class=pgc-img-caption></p></div><p>。氣溶膠的密度也隨著海拔高度呈指數下降，同瑞利散射類似，我們將通過在方程（由大氣標高調製）的右邊包含一個指數項來模擬這種效應。米氏相函數方程是：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/58e2e5751c4b46d6904e83a0436ef3ad><p class=pgc-img-caption></p></div><p><br></p><p>米氏相函數包括控制介質各向異性的項g（瑞利相函數不包括），氣溶膠具有很強的前向指向性，一些論文使用g=0.76（我們也將使用這個值作為我們的默認值）。</p><p><br></p><p><strong>1.5 光學深度的概念</strong></p><p><br></p><p>在實現算法之前，我們將把所有零散部分放在一起。首先，我們應該注意到，天空只不過是圍繞實心球體的球形體積。因為它只是一個體積，為了渲染天空，我們可以使用光線步進算法，這是最常用的渲染參與介質的技術。我們在關於體積渲染的課程中詳細研究了該算法。當我們渲染一個體積時，觀察者（或相機）可以在體積內部或外部。</p><p><br></p><p>當相機在體積內時，我們需要找到觀察光線離開體積的點，當它在體積外時，我們需要找到觀察光線進入和離開體積的點。因為天空是一個球體，我們將使用光線與球體相交測試的方式來計算這些點。我們通過使用地面作為參考來測試相機位於大氣層內部或外部。如果此高度大於大氣厚度，則攝像機位於大氣層之外，並且觀察光線可能在兩個地方與大氣層相交。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/525de0d0b8bc484abc896e2eb6a954fd><p class=pgc-img-caption></p></div><p>Figure 6: the camera can either be inside the atmosphere or outside. When it is inside, we are only interested in the intersection point between the camera ray and the atmosphere. When the camera is outside it can intersect the atmosphere in two points.</p><p><br></p><p>現在我們假設攝像機在地面上（或高出地面一米），但該算法適用於任意攝像機位置。讓我們假設我們有一個觀察光線（對應於幀中的一個像素），我們知道這條光線與大氣層上邊緣相交的位置。我們此時需要解決的問題是找出有多少光線在沿著觀察者的方向上傳播。正如我們在下圖中看到的那樣，我們的相機或觀察者不太可能直視太陽（那樣會傷害你的眼睛）。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/900ac79214cb4e8ab893b5297fcbfcc8><p class=pgc-img-caption></p></div><p>Figure 7: single scattering is responsible for the sky color. A viewer is rarely directly looking at the sun (which is dangerous). However when we are looking away from the sun the atmosphere has a color which is the result of blue light from the sunlight being scattered in the direction of the observer's eyes.</p><p><br></p><p>如果你朝天空的方向看，你不應該看到任何東西，因為你正在看空曠的空間（天體之間的空間）。然而，事實是你會看到藍色，這是由來自太陽的光進入大氣並被觀察方向上的空氣分子偏轉引起的。換句話說，沿著觀察方向沒有來自太陽的直射光（除非觀察方向直接指向太陽），但是來自太陽的光被大氣散射，一些光線最終沿著你的眼睛方向行進。這種現象稱為單次散射（在體積渲染內容中對此進行了解釋）。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/22d8c9aafacf473eaf93c08c37811d3e><p class=pgc-img-caption></p></div><p>Figure 8: to compute the sky color we first trace a ray from Pc to Pa and then integrate the amount of light coming from the sun (with direction L) that is reflected back along that ray (V).</p><p><br></p><p>到目前為止我們知道什麼？我們知道，為了渲染幀中一個像素對應的天空顏色，我們將首先從點Pc（相機位置）向感興趣的方向上投射觀察光線（V）。我們將計算此光線與大氣相交的點Pa。最後，我們需要計算由於單次散射而沿著該光線傳播的光量。該值可以使用我們在體積渲染內容中研究的體積渲染方程來計算：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/af656e35b1144111b36f64ab680709e6><p class=pgc-img-caption></p></div><p><br></p><p>其中T是點Pc和X（沿觀察方向的樣本位置）之間的透射率。L是體積中位置X處的光量。它所說的是，在Pc到達觀察者的光總量等於沿著觀察方向V散射的所有太陽光。該量可以通過將沿V的各個位置（X）的光相加來獲得，這種技術稱為數值積分。我們沿著光線採集的樣本越多，結果越好，但計算所需的時間越長。等式中的透射率項（T）解釋了在每個樣本位置（X）處沿觀察者方向V散射的光從X行進到Pc時也會衰減。</p><p><br></p><p>回想一下體積渲染的內容，當光線從體積中的一個點移動到另一個點時因吸收和散射，光線會衰減。我們稱Pb點的光量為Lb，從Pb到達Pa點的光量為La。存在參與介質的情況下，La（從Pb接收的光）將低於Lb。透射率表示La與Lb之比，因此T在0到1的範圍內。透射率的方程看起來像這樣：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/cc13331fd86c4ec1afe9c121b1b2e5dd><p class=pgc-img-caption></p></div><p><br></p><p>簡單來說，這個等式意味著我們需要測量沿著路徑光線Pa-Pb在不同樣本位置處的大氣的衰減βe，將這些值加起來，將它們乘以長度段ds（即距離Pa-Pb除以使用的樣本數量） ，取該值的負值並將其提供給指數函數。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cb550f335d53450383a38381a80a0008><p class=pgc-img-caption></p></div><p>Figure 9: as light (Lb) travels from Pb to Pa, it gets attenuated because of out-scattering and absorption. The result is La. Transmittance is the amount of light received at Pa from Pb, after it was attenuated while traveling through the atmosphere (that is T=La/Lb).</p><p><br></p><p>回到我們所說的關於瑞利散射的內容，你會記得βs（我們將以此計算βe）可以用海平面上的散射係數來計算，該散射係數由高度h與大氣標高（H）比值的指數函數來計算。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/aaf5628bfa064e4197897683752c6e2e><p class=pgc-img-caption></p></div><p><br></p><p>對於瑞利散射，可以忽略吸收，散射係數我們可以寫作：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4d7877992ad1406c9c6aa81695b57394><p class=pgc-img-caption></p></div><p><br></p><p>你可以將βe（0）移出積分（因為它是常數），透射率方程重新寫為：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a4704b2fb199433aa33d56c606c107c6><p class=pgc-img-caption></p></div><p><br></p><p>指數函數內的和可以看作Pa和Pb之間的平均密度值，並且方程本身在文獻中通常稱為點Pa-Pb之間的大氣的光學深度。</p><p><br></p><p><strong>1.6 將陽光加起來</strong></p><p><br></p><p>最後，我們將使用前一段中介紹的渲染方程來計算天空顏色，讓我們再寫一遍：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5fc977be6855439d97764ffbe3691733><p class=pgc-img-caption></p></div><p><br></p><p>我們已經解釋瞭如何計算透射率，現在讓我們看看Lsun（X）這個量，並解釋如何評估它的值。Lsun（X）對應於在樣本位置X處沿觀察方向散射的太陽光量。為了評估它，首先我們需要計算到達X的光量，直接取陽光強度是不夠的，實際上，如果光線在Ps點進入大氣層，它也會在行進到X過程中衰減。因此，我們需要使用與我們用於計算沿著從Pa到Pc的觀察方向傳播的光的衰減的方程相似的方程來計算這種衰減（等式1）：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/65ab1b26ac504ef196106b51a6c03063><p class=pgc-img-caption></p></div><p>Equation 1<br></p><p><br></p><p>從技術上講，對於沿著觀察射線的每個採樣位置X，我們將需要在太陽光方向（L）上投射光線並找到該光線與大氣相交的位置（Ps）。然後，我們將使用與觀察射線相同的數值積分技術來評估等式1中的透射率（或光學深度）項。將光線切割成段，並評估每個光段中心的大氣密度。構建計算天空顏色的算法的最後一個要素是根據光線方向本身和視線方向來計算在觀察方向上散射的光量。這是相函數的作用，瑞利散射和米氏散射有各自的相函數，我們在之前提到過它們。如果你需要了解相函數，請閱讀體積渲染相關內容。簡而言之，相函數是描述來自方向L的光在方向V上散射多少的函數。米氏相函數包含一個額外項g，稱為平均餘弦（可能還有其他名稱），它定義光是否主要沿前向（L）或後向（-L）散射。對於前向散射，g在[0：1]範圍內，而後向散射g在[-1：0]範圍內。當g等於零時，光在所有方向上均勻散射，我們說散射是各向同性的。對於米氏散射，我們將g設置為0.76。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/75bd1cdc2c2346b085549ac060a05366><p class=pgc-img-caption></p></div><p><br></p><p>最後，我們需要考慮這樣的事實，例如，瑞利散射的藍光主要沿著視線方向散射。為了反映這一點，我們將前一個方程的結果乘以散射係數（βs），這給出了方程的光量部分的完整方程。但是回想一下βs隨高度而變化（它的值是高度的函數），其中h是X相對於地面的高度（更精確地說是海平面）：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5fa625e9ca5e409d827fa4d9158b85d0><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/75da28ccd1ee4bc3a0b9d5fad2e301c9><p class=pgc-img-caption></p></div><p><br></p><p>對於地球大氣而言，太陽是天空中唯一的光源，但是，為了寫出前一個方程的通用形式，我們應該考慮光可能來自多個方向的事實。在科研論文中，你通常會看到這個等式被寫為4π的積分，它描述了傳入方向的範圍。這個更通用的方程也可以考慮了地面反射的陽光（多次散射），我們將在本章中忽略這些多次散射的陽光。</p><p><br></p><p><strong>1.7 計算天空顏色</strong></p><p><br></p><p>把所有的元素拼接在一起我們得到以下方程（方程2和方程3）：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/92aaf4e20f014b40b7e60560b04f8008><p class=pgc-img-caption></p></div><p>Equation 2</p><p style=text-align:center><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/06ccacb655b14ac2a85ccc59d5c82a0b><p class=pgc-img-caption></p></div><p>Equation 3</p><p><br></p><p>將方程3代入方程2得到以下方程：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/73c7a01fa3e5432699e4f55caffe031f><p class=pgc-img-caption></p></div><p><br></p><p>相函數的結果以及陽光強度是恆定的，我們可以將這兩項移到積分外：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/92c1a129816a446c8cd1c3a9abc8605a><p class=pgc-img-caption></p></div><p>Equation 4<br></p><p><br></p><p>這是用於渲染特定視角和光照方向的天空顏色的最終方程。因此，它並不複雜，但對它的計算要求更高，因為我們計算積分並對指數函數進行多次調用（通過透射率項）。另外，你需要記住它們的天空顏色實際上是瑞利和米氏散射的結果。因此，對於每種散射類型，我們需要計算兩次這個方程：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ff2b0b11316d4873bbd8fe1a7bcb45f7><p class=pgc-img-caption></p></div><p><br></p><p>在微積分中，兩個底數相同的指數函數的乘積可用法則計算，即底數不變指數相加。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f2c2866153b64091949ff72f614c91d5><p class=pgc-img-caption></p></div><p><br></p><p>我們可以利用這個屬性（我們計算一個指數而不是兩個）並重新編寫方程4中兩個透射項的乘法：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/27abaaa477034a9b81820ee34b1fa603><p class=pgc-img-caption></p></div><p>Equation 5</p><p><br></p><p><strong>2、大氣散射的GPU編碼實現</strong></p><p><br></p><p>在第一部分中已經介紹了相應的理論基礎，在這部分我們將在GPU中實現對天空顏色的模擬。由於原文中給出的代碼是在CPU中實現的，輸出最終的圖片需要一定時間且不方便調試預覽，因此我們利用ShaderToy在GPU中實現，方便修改參數並實時預覽最終模擬的效果，最終效果如下視頻所示，可以看到隨著太陽接近地平線，靠近地平線位置的天空呈現紅色和橙色，另外也可在ShaderToy中看到該實現</p><p>（https://www.shadertoy.com/view/3sSfDz）：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0049f7818bc84027a346a8ff9ffb2b60><p class=pgc-img-caption></p></div><p style=text-align:center>Figure 9</p><p><br></p><p>下面開始介紹實現部分，首先是座標系的建立，想象一下中午你東西向躺在草坪上，太陽在天空正上方，你戴著墨鏡直視太陽，以視線直視方向為y軸正方向，雙臂展開從左手到右手的方向為x軸正方向，從你的腳底到頭頂的方向為z軸正方向，座標軸的原點在地心，以此建立一個左手座標系。在此座標系下平躺著朝著正上方用魚眼相機每隔一定時間拍攝一次照片，至太陽落山為止，最終將圖像序列按創建時間順序壓縮成視頻，便得到和如上視頻中類似的效果。為了模擬魚眼效果，需要將單位正方形內的點集映射到單位半球面（不是嚴格的半球面，有一部分點在半球面以下，關於平面點集到半球面點集的映射，可參考《Ray Tracing from the Ground Up》中有關內容）上，然後從相機位置處向半球面上的這些點發射射線計算每個點上最終的顏色值。</p><p><br></p><p>在ShaderToy中，屏幕從左到右為x正向，從下到上為y正向，uv的x和y分量取值範圍為「0，1」，但屏幕的長寬不同，屏幕長度大於寬度，這意味著同一把尺子分別與x和y軸平行時投影得到的度量不同，x值會更大些，為了消除這種不一致，需要將uv值的y分量乘以屏幕的長寬比，然後利用球面座標系的角度和座標的轉換公式得到單位正方形內的點對應的單位半球面上的點，viewScale是為了對面畫整體進行縮放，類似於FOV的作用。</p><p>vec2 uv =(2.*fragCoord/iResolution.xy1.)*vec2(iResolution.x/iResolution.y,1.);</p><p>float viewScale = 1.;</p><p>vec2 p = uv*viewScale;</p><p><br></p><p>注意屏幕的xy平面相當於上面建立的座標系的xz平面，因此我們可以做如下映射：</p><p>//單位正方形內的點映射到半球面上</p><p>float z2 = p.x*p.x+p.y*p.y;</p><p>float phi = atan(p.y,p.x);</p><p>float theta = acos(1.-z2);</p><p>vec3 dir = vec3(sin(theta)*cos(phi),</p><p>cos(theta),</p><p>sin(theta)*sin(phi));</p><p>ray r = ray(vec3(0.,earthRadius+1.,0.),dir);</p><p>color = getIncidentLight(r);</p><p>fragColor = vec4(color,1.);</p><p><br></p><p>我們將相機位置放置在(0.,earthRadius+1.0,0.)處，將屏幕座標中單位正方形內的點映射到新建立的座標系中單位半球面上的點，然後從相機位置處向半球面上各個已映射的點發射射線。由於模擬的是正午到日落的動態效果，需要更新太陽的位置，假設太陽從正午到日落沿著我們建立的座標軸的x軸旋轉了90度，則可以對太陽光的方向做如下更新：</p><p><br></p><p>//sun position</p><p>float rotSpeedFactor = 3.;</p><p>mat3 sunRot = rotate_around_x(-abs(sin(u_time/rotSpeedFactor))*90.);</p><p>sunDir *= sunRot;</p><p>沿x軸旋轉的變換矩陣可由如下輔助函數得到：</p><p>//繞x軸的旋轉矩陣</p><p>mat3 rotate_around_x(const in float degrees)</p><p>{</p><p>float angle = radians(degrees);</p><p>float _sin = sin(angle);</p><p>float _cos = cos(angle);</p><p>return mat3(1.,0.,0.,</p><p>0.,_cos,-_sin,</p><p>0.,_sin,_cos);</p><p>}</p><p><br></p><p>接著我們定義一些宏和常量：</p><p>#define PI 3.14159265359</p><p>#define USE_HENYEY 1</p><p>#define u_res iResolution</p><p>#define u_time iTime</p><p>vec3 sunDir = vec3(0.,1.,0.);</p><p>float sunPower = 20.;</p><p>const float earthRadius = 6360e3;</p><p>const float atmosphereRadius = 6420e3;</p><p>const int numSamples = 16;</p><p>const int numSamplesLight = 8;//光線與大氣層頂端交點到採樣點的採樣數量</p><p>const float hR = 7994.;//rayleigh</p><p>const float hM = 1200.;//mie</p><p>const vec3 betaR = vec3(5.5e-6,13.0e-6,22.4e-6);//rayleigh</p><p>const vec3 betaM = vec3(21e-6);//mie</p><p><br></p><p>然後定義射線和球的struct以及射線與球相交檢測以及計算相交點的輔助函數：</p><p>struct ray</p><p>{</p><p>vec3 origin;</p><p>vec3 direction;</p><p>};</p><p>struct sphere</p><p>{</p><p>vec3 center;</p><p>float radius;</p><p>};</p><p>//表示大氣層的球</p><p>const sphere atmosphere = sphere(vec3(0.,0.,0.),atmosphereRadius);</p><p>//計算射線與球是否相交以及交點</p><p>bool raySphereIntersect(const in ray r,const in sphere s,inout float t0,inout float t1)</p><p>{</p><p>vec3 oc = r.origin-s.center;</p><p>float a = dot(r.direction,r.direction);</p><p>float b = dot(oc,r.direction);</p><p>float c = dot(oc,oc)-s.radius*s.radius;</p><p>float discriminant = b*b-(a*c);</p><p>if(discriminant>0.0)</p><p>{</p><p>float tmp = sqrt(discriminant);</p><p>t0 = -b-tmp;</p><p>t1 = -b+tmp;</p><p>return true;</p><p>}</p><p>return false;</p><p>}</p><p><br></p><p>另外瑞利和米氏以及schlick相函數的定義如下：</p><p>//----------------phase function----------------</p><p>float rayleighPhaseFunc(float mu)</p><p>{ return 3.*(1.+mu*mu)/(16.*PI);</p><p>}</p><p>const float g = 0.76;</p><p>float henyeyGreensteinPhaseFunc(float mu)</p><p>{</p><p>return (1.-g*g)/((4.*PI)*pow(1.+g*g-2.*g*mu,1.5));</p><p>}</p><p>const float k = 1.55*g-0.55*(g*g*g);</p><p>float schlickPhaseFunc(float mu)</p><p>{</p><p>return (1.-k*k)/(4.*PI*(1.+k*mu)*(1.+k*mu));</p><p>}</p><p>//----------------phase function----------------</p><p><br></p><p>相函數定義為粒子在各個方向上的實際散射能，與粒子散射為各向同性時該方向的散射能之比，輸出是一個無量綱的值。可以通過desmos上的henyeyGreensteinPhaseFunction的圖像來配合理解。</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2f9a64ab3bde418da33e007c3d29798d><p class=pgc-img-caption></p></div><p><br></p><p>由於理論中提到最終的顏色值是由積分公式計算得到的，積分區間是一個連續的區間，因此只能通過離散採樣的方式計算累加和得到近似結果。</p><p>//計算光學深度</p><p>bool getSunLight(const in ray r,inout float opticalDepthR,inout float opticalDepthM)</p><p>{</p><p>float t0,t1;</p><p>raySphereIntersect(r,atmosphere,t0,t1);</p><p>float marchPos = 0.;</p><p>float marchStep = t1/float(numSamplesLIght);</p><p>for(int i = 0;i&lt;numSamplesLIght;i++)</p><p>{</p><p>//相鄰兩個採樣點的中點</p><p>vec3 s =r.origin+r.direction*(marchPos+0.5*marchStep);</p><p>float height = length(s)-earthRadius;</p><p>if(height&lt;0.)</p><p>return false;</p><p>opticalDepthR += exp(-height/hR)*marchStep;</p><p>opticalDepthM += exp(-height/hM)*marchStep;</p><p>marchPos += marchStep;</p><p>}</p><p>return true;</p><p>}</p><p>vec3 getIncidentLight(const in ray r)</p><p>{</p><p>float t0,t1;</p><p>if(!raySphereIntersect(r,atmosphere,t0,t1))</p><p>{</p><p>return vec3(0.);</p><p>}</p><p>float marchStep = t1/float(numSamples);</p><p>float mu = dot(r.direction,sunDir);</p><p>float phaseR = rayleighPhaseFunc(mu);</p><p>float phaseM =</p><p>#if USE_HENYEY</p><p>henyeyGreensteinPhaseFunc(mu);</p><p>#else</p><p>schlickPhaseFunc(mu);</p><p>#endif</p><p>float opticalDepthR = 0.;</p><p>float opticalDepthM = 0.;</p><p></p><p>vec3 sumR = vec3(0.);</p><p>vec3 sumM = vec3(0.);</p><p>float marchPos = 0.;</p><p>for(int i=0;i&lt;numSamples;i++)</p><p>{</p><p>vec3 s = r.origin+r.direction*(marchPos+0.5*marchStep);</p><p>float height = length(s)-earthRadius;</p><p>//計算光學深度累加和</p><p>float hr = exp(-height/hR)*marchStep;</p><p>float hm = exp(-height/hM)*marchStep;</p><p>opticalDepthR += hr;</p><p>opticalDepthM += hm;</p><p></p><p>ray lightRay = ray(s,sunDir);</p><p>float opticalDepthLightR = 0.;</p><p>float opticalDepthLightM = 0.;</p><p>bool bOverGround = getSunLight(lightRay,opticalDepthLightR,opticalDepthLightM);</p><p>if(bOverGround)</p><p>{</p><p>vec3 t = betaR*(opticalDepthR+opticalDepthLightR)+</p><p>betaM*1.1*(opticalDepthM+opticalDepthLightM);</p><p>vec3 attenuation = exp(-t);</p><p>sumR += hr*attenuation;</p><p>sumM += hm*attenuation;</p><p>}</p><p>marchPos += marchStep;</p><p>}</p><p>return sunPower*(sumR*phaseR*betaR+sumM*phaseM*betaM);</p><p>}</p><p><br></p><p>通過調整瑞利散射係數或米氏散射係數，可以得到一些alien planet atmosphere的效果，如下所示：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d59f283fd8394c699e46ad77a7f8a3a8><p class=pgc-img-caption></p></div><p><br></p><p>此外，如果從相機位置處向成像平面發射射線計算著色，可得到如下渲染效果，比較接近unity中默認場景的天空顏色：</p><p><br></p><div class=pgc-img><img alt=硬核分享：遊戲中迷人天空的顏色是如何製作出來的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dbd81902bbe74517abb642064b227d0e><p class=pgc-img-caption></p></div><p><br></p><p>大氣渲染相關的技術點很多，本文僅實現了單次散射，對於多次散射、相函數推導、優化等相關主題未有涉及，在實時渲染中還有其他簡化模型以及各種trick來渲染天空。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>硬核</a></li><li><a>遊戲</a></li><li><a>顏色</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E9%81%8A%E6%88%B2/5e7baebc.html alt=逃離塔科夫遊戲評測：這遊戲怎麼這麼硬核？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6e9b1a5cab4344eeb4728426ba0d81b2 style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/5e7baebc.html title=逃離塔科夫遊戲評測：這遊戲怎麼這麼硬核？>逃離塔科夫遊戲評測：這遊戲怎麼這麼硬核？</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/13a55f3.html alt=死亡懲罰爆炸的硬核遊戲！為一場戰爭，玩家足足燒掉200多萬？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/73b38588729e4fbbab26d04034c43212 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/13a55f3.html title=死亡懲罰爆炸的硬核遊戲！為一場戰爭，玩家足足燒掉200多萬？>死亡懲罰爆炸的硬核遊戲！為一場戰爭，玩家足足燒掉200多萬？</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/2c90105.html alt=讓孩子哭著“打”遊戲“看”電視，這屆家長的硬核懲罰方式太好笑了哈哈哈哈哈哈 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RYeNADd3wEaHzp style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/2c90105.html title=讓孩子哭著“打”遊戲“看”電視，這屆家長的硬核懲罰方式太好笑了哈哈哈哈哈哈>讓孩子哭著“打”遊戲“看”電視，這屆家長的硬核懲罰方式太好笑了哈哈哈哈哈哈</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/75735682.html alt=不愧是騰訊！光靠遊戲一天血賺4.6億人民幣，你貢獻了多少？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/cc290697431a45ef916ee0c90f6ad0f6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/75735682.html title=不愧是騰訊！光靠遊戲一天血賺4.6億人民幣，你貢獻了多少？>不愧是騰訊！光靠遊戲一天血賺4.6億人民幣，你貢獻了多少？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bcc63183.html alt=「超硬核科普」鼠標的發展歷史，中國人發明的鼠標滾輪 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ac7fb5fb22b8449392a90146180d194f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bcc63183.html title=「超硬核科普」鼠標的發展歷史，中國人發明的鼠標滾輪>「超硬核科普」鼠標的發展歷史，中國人發明的鼠標滾輪</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/53b9bc9f.html alt=遊戲中讓女生瞬間“變軟”的4個行為，只要你敢做，她秒變乖乖女 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/55e72a47e1d1440dbd8309d0733d0879 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/53b9bc9f.html title=遊戲中讓女生瞬間“變軟”的4個行為，只要你敢做，她秒變乖乖女>遊戲中讓女生瞬間“變軟”的4個行為，只要你敢做，她秒變乖乖女</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c83129f5.html alt="顏色取樣器搭配曲線工具 完成照片色彩統一" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/7b25f6f8b4cd4c07a7b4baa8ac16fd29 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c83129f5.html title="顏色取樣器搭配曲線工具 完成照片色彩統一">顏色取樣器搭配曲線工具 完成照片色彩統一</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a23e4abd.html alt=初中化學常見物質的顏色和元素彙總，建議收藏！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1541675934064af019f1271 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a23e4abd.html title=初中化學常見物質的顏色和元素彙總，建議收藏！>初中化學常見物質的顏色和元素彙總，建議收藏！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1adf2386.html alt=熱血傳奇：遊戲衰落原因之一，永遠化不了的裝備 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/cf98bb665d4948c8aa1b2e266a6f8b29 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1adf2386.html title=熱血傳奇：遊戲衰落原因之一，永遠化不了的裝備>熱血傳奇：遊戲衰落原因之一，永遠化不了的裝備</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6c476abf.html alt="硬核航空 FAG公司用於航宇軸承的壽命計算方法" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/034ea8ed652c4ccfb55292e01084573f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6c476abf.html title="硬核航空 FAG公司用於航宇軸承的壽命計算方法">硬核航空 FAG公司用於航宇軸承的壽命計算方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a7be4199.html alt=硬核：激光結構光的原理、設計和類型詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RvXexXME6SXKyZ style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a7be4199.html title=硬核：激光結構光的原理、設計和類型詳解>硬核：激光結構光的原理、設計和類型詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3127ea3b.html alt=大廠硬核乾貨！深入分析彈性動效的應用及原理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/9d3fcf924c8e43bf92b4e6820af0176c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3127ea3b.html title=大廠硬核乾貨！深入分析彈性動效的應用及原理>大廠硬核乾貨！深入分析彈性動效的應用及原理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6e572fcc.html alt="Win10專題 | 十分硬核的Windows 10精簡教程（用戶文件篇）" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/24d10164-2cf8-4f4e-a53d-18a1e5b1f85d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6e572fcc.html title="Win10專題 | 十分硬核的Windows 10精簡教程（用戶文件篇）">Win10專題 | 十分硬核的Windows 10精簡教程（用戶文件篇）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ad41459b.html alt=一座“硬核”煤化工智能工廠 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/9c682fde45fa46a696a2cd4819b73900 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ad41459b.html title=一座“硬核”煤化工智能工廠>一座“硬核”煤化工智能工廠</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f991d897.html alt=硬核防護！除了口罩，騎行防護裝備有哪些？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/RqEDMWP2fRnMGM style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f991d897.html title=硬核防護！除了口罩，騎行防護裝備有哪些？>硬核防護！除了口罩，騎行防護裝備有哪些？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>