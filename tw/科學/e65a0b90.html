<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>數據庫的性能優化的一些思考 | 极客快訊</title><meta property="og:title" content="數據庫的性能優化的一些思考 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/e65a0b90.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/e65a0b90.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/e65a0b90.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/e65a0b90.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/e65a0b90.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/e65a0b90.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/e65a0b90.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/e65a0b90.html><meta property="article:published_time" content="2020-11-14T20:50:52+08:00"><meta property="article:modified_time" content="2020-11-14T20:50:52+08:00"><meta name=Keywords content><meta name=description content="數據庫的性能優化的一些思考"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E5%AD%B8/e65a0b90.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>數據庫的性能優化的一些思考</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E5%AD%B8.html>科學</a></span></div><div class=post-content><p>1，服務器目前的架構 cpu 內存 io 網絡</p><p>一主 -》 多從(14) 主服務器宕機 切換從服務器慢</p><p>監控指標 ：qps和tps (慢sql佔用cpu時間太長,每個sql只能是一個cpu執行,qps超高造成阻塞)</p><p>併發量和cpu使用率 (連接數被佔滿，cpu資源耗盡出現宕機)</p><p>磁盤IO</p><p>網卡IO</p><p>大表(千萬行數據,文件10g數據,查詢條件複雜)</p><p>查詢慢容易產生慢sql，產生大量的磁盤IO，更改列會很慢，建立索引時間長，主從延遲大</p><p>ddl操作會長時間鎖表，造成主從延遲，正常數據會被阻塞，大量的鏈接超時</p><p>分庫分表：主鍵選擇 跨分區數據查詢和統計</p><p>數據歸檔：時間點的選擇(歷史數據的查詢做單獨的入口，分離冷熱數據，歷史數據的統計和計算數據做異步處理)</p><p>歸檔操作的方式選擇</p><p>大事務(關係型數據庫的特性，原子性操作，原子性 一致性 隔離性 持久性)</p><p>要麼全部成功要麼失敗回滾，</p><p>事務操作前和操作後完整性不能被破壞，</p><p>事務未提交之前對事務的操作不可見(未提交讀，已提交讀(默認隔離級別)，可重複讀(mysql默認)，可串行化)</p><p>事務執行完之後持久化到磁盤不會丟失</p><p>運行時間比較長，操作數據比較多的事務叫做大事務</p><p>鎖定的數據太多，造成大量的阻塞和鎖超時</p><p>回滾所需的時間比較長</p><p>執行時間比較長，主從同步延遲太大</p><p></p><p>避免一次處理太多數據(分批處理)</p><p>移除不必要的select操作</p><p></p><p>2，影響性能的幾個方面</p><p>硬件</p><p>服務器系統</p><p>存儲引擎(插件式的存儲引擎選擇)</p><p>myisam 不支持事務，表級鎖</p><p>innodb 事務，行級鎖 ACID特性</p><p>數據庫配置參數</p><p>表結構的設計和sql語句</p><p>3，硬件的影響</p><p>cpu 頻率和核數,</p><p>mysql單條sql無法使用多個cpu，qps:每秒處理sql數量，核數比處理能力重要</p><p>內存大小</p><p>內存的io大於磁盤很多 熱數據 > 可用內存數據</p><p>myisam 把索引緩存在內存中，數據通過操作系統緩存</p><p>innodb 同時緩存 數據和索引到內存</p><p>讀減少磁盤io，寫減少磁盤io</p><p>磁盤IO和網絡資源</p><p>存儲大小，傳輸速度，訪問時間，主軸轉速，物理尺寸</p><p>RAID技術：磁盤冗餘隊列，小磁盤組成大磁盤，提供數據冗餘保持數據完整性</p><p>RAID0 沒有冗餘和數據修復能力，多個磁盤串聯在一起，併發寫入，容量相加</p><p>RAID1 磁盤鏡像，生成數據備份鏡像，併發寫同時備份，磁盤冗餘，容量減少50%</p><p>RAID5 奇偶校驗磁盤陣列，任何數據失效都可以從奇偶校驗塊中重建</p><p>READ10 分片鏡像 RAID1+READ0</p><p></p><p>固態硬盤SSD， PCIE SSD 比機械盤有更好的隨機讀寫的性能，更好的支持併發，更容易損壞</p><p>SSD SATA接口 直接替換傳統磁盤，同樣支持RAID技術</p><p>PCI-E SSD 無法使用SATA接口，需要獨特的驅動配置，貴性能更好</p><p></p><p>適用於大量隨機IO，解決單線程負載的IO瓶頸</p><p>網絡存儲NAS和SAN</p><p>SAN -》服務器-》SAN 通過光纖訪問服務器</p><p>緩存 大量順序讀寫 隨機讀寫慢</p><p>NAS 使用網絡連接，通過文件協議 NFS和SMB訪問</p><p>網絡設備 (延遲和帶寬)</p><p>高性能高代開網絡接口設備</p><p>多個網卡綁定增加可用性和帶寬</p><p>網絡隔離 內外網隔離 業務隔離</p><p></p><p>總結，64位架構運行在64位系統</p><p>併發高的場景cpu核數比頻率重要，cpu密集型和複雜sql頻率越高越好</p><p>選擇主辦能使用的最高內存，儘可能的大</p><p>IO子系統 PCIe-》SSD-〉Raid10-》磁盤-〉SAN</p><p>3，服務器的影響</p><p>mysql比較常見的運行到linux，window對大小寫不敏感，強制使用小寫</p><p>window FreeBSD Solaris Linux</p><p></p><p>centos 參數優化</p><p>/etc/sysctl.conf</p><p>net.core.somaxconn=65535</p><p>net.core.netdev_max_backlog=65535</p><p>net.ipv4.tcp_max_syn_backlog=65535</p><p></p><p>net.ipv4.tcp_fin_timeout=10</p><p>net.ipv4.tcp_tw_reuse=1</p><p>net.ipv4.tcp_tw_recycle=1</p><p></p><p>net.core.wmem_default=87380</p><p>net.core.wmem_max=16777216</p><p>net.core.rmem_default=87380</p><p>net.core.rmem_max=16777216</p><p></p><p>net.ipv4.tcp_keepalive_time=120</p><p>net.ipv4.tcp_keepalive_intvl=30</p><p>net.ipv4.tcp_keepalive_probes=3</p><p></p><p>kernel.shmmax=429497295</p><p>vm.swappiness=0</p><p></p><p>/etc/security/limit.conf</p><p>* soft nofile 65535</p><p>* hard nofile 65535</p><p></p><p>/sys/block/devname/queue/scheduler</p><p>磁盤調度策略</p><p></p><p>文件系統</p><p>windows (FAT NTFS)</p><p>linux(EXT3 EXT4 XFS)</p><p></p><p>4,mysql架構</p><p>插件式存儲引擎，數據處理和存儲相分離</p><p>cs結構</p><p>客戶端(java php c ODBC JDBC),負責連接處理，授權認證，安全等，一個連接智能化用到一個cpu，所有的操作都是在一個線程操作</p><p>服務層 連接管理()->查詢緩存-》查詢解析-〉查詢優化 所有跨存儲引擎的功能都在這一層</p><p>存儲引擎層 針對於表的，不這對庫文件</p><p>myisam： mysql5.5只前的默認存儲引擎，</p><p>系統表,臨時表(排序分組操作，數量超過一定大小，由查詢優化器建立臨時表)使用的存儲引擎。</p><p>MYD和MYI兩個文件存儲數據，frm存儲表結構。</p><p>表級別鎖，讀寫混合的併發性不好；</p><p>表修復check table tablename；repair table tablename；</p><p>全文索引(mysql5.7之前唯一原生支持全文索引的引擎)，對text和blog的前500字符的前綴索引</p><p>支持表數據壓縮(myisampack),壓縮表的只讀表不能插入和更新</p><p>mysql5.0之前單表最大4G(MAX_Rows AVG_ROW)LENGTH),mysql5.0之後最大256TB</p><p>使用場景：非事務應用，只讀類型的併發性好，空間類應用(空間函數 5.0之前的必選)</p><p>Innodb：mysql默認存儲引擎，表空間存儲數據,（innodb_file_per_table: on 獨立表空間 .ibd , off系統表空間 ibdataX)</p><p>.frm和表空間文件</p><p>系統表空間無法簡單收縮文件大小造成磁盤碎片，獨立表空間使用optimize table命令重建表空間收縮文件系統</p><p>系統表空間產生IO瓶頸，獨立表空間可以同時刷新多個文件數據，mysql5.6之後默認獨立表空間</p><p>frm存儲的是服務器層的數據字典跟引擎無關的，系統表空間存放引擎相關的數據字典，回滾段</p><p>事務型存儲引擎ACID，redolog和undolog實現；行級鎖，在存儲引擎層實現，服務層不可見</p><p>鎖(管理共享資源的併發訪問，實現事務隔離)，共享鎖(讀鎖)，獨佔鎖(寫鎖)</p><p>阻塞：等待其他的鎖釋放資源，慢查詢產生大量的阻塞</p><p>死鎖：事務相互佔用資源，系統自動識別死鎖，並釋放佔用資源較少的事務，使得事務繼續運行</p><p>show engine innodb status ；//狀態檢測</p><p>除了5.7之前的空間應用和全文索引情況都要默認innodb引擎</p><p></p><p>CSV存儲引擎 存儲文件.csv文件，一文件方式存儲，myisam和innodb是二進制文件存儲的</p><p>.frm表結構 .csv存儲表數據內容 .csm存儲表的元數據 數據量 表狀態等</p><p>所有的列不能是null，不支持索引，不適合做發表和在線處理數據，可以直接對數據進行編輯</p><p>適合做數據交換中間表</p><p>Archive 以zlib對錶數據進行壓縮，佔用更少的磁盤IO和存儲空間，數據問價 .frm和.arz文件</p><p>只支持insert和select操作，行級鎖，專用的緩衝區，支持高併發插入，只支持自增ID建立索引</p><p>適合 日誌和數據採集的應用</p><p>memory引擎 數據存儲在內存中，表結構保持在磁盤，也叫HEAP引擎</p><p>支持HASH(默認)和BTREE索引，等於查詢時hash索引快，btree索引做範圍查找快</p><p>所有字段都是固定長度 varchar(10)=char(10)</p><p>不支持blog和text字段類型</p><p>表級鎖，併發性能有影響，max_heap_table_size決定最大表數據</p><p></p><p>系統自動創建: tmp-table-size 或 max-heap-table-size</p><p>1,超過限制使用myisam臨時表 2,未超過現在使用memory臨時表</p><p>主動創建： create temporary table</p><p></p><p>適用於映射表查找表，保存分析數據的中間表 緩存週期性聚合結果表</p><p>federated引擎 提供遠程訪問mysql服務器上表的功能,本地不存儲數據，本地保存表結構和遠程服務器的連接信息</p><p>默認mysql禁止使用，性能不好。</p><p>設置federated=1開啟;</p><p>適用於 手動統計分析查詢</p><p></p><p>存儲引擎選擇，沒有特殊需求innodb是最佳選擇</p><p>事務支持:innodb最穩定，select和insert 選myisam insert選archive</p><p>備份：innodb有在線熱備份方案，mysqldump不是熱備份(會加鎖的邏輯備份)</p><p>崩潰恢復 innodb比myisam好很多</p><p>特殊引擎特性需求</p><p>mysql服務器配置</p><p>mysql配置文件 my.conf</p><p>參數作用域 全局set global 參數=值</p><p>會話 set session 參數=值</p><p>內存相關參數：可使用內存上限(單進程運行)</p><p>每個sql連接的使用內存</p><p>(sort_buffer_size 需要排序的sql會分配這部分內存)</p><p>(join_buffer_size 每個線程使用的連接緩衝區，每個連表分配一個)</p><p>(read_buffer_size 讀緩衝區 全表掃描myisam時分配，4k的倍數)</p><p>(read_rnd_buffer_size 索引緩衝區)</p><p>緩存池分配的內存</p><p>innodb_buffer_poll_size 緩存索引和數據，延遲寫入(合併多個寫入一起寫入磁盤)</p><p>總內存 - 單個線程內存*連接數 -系統保留內存 建議服務器內存的75%</p><p>key_buffer_size 主要是myisam用，緩存索引，數據依賴操作系統緩存</p><p>IO相關的配置參數：性能 安全 做平衡 貴啊</p><p>innodb：innodb_log_file_size * innodb_log_files_in_group = 事務日誌總大小</p><p>innodb_log_buffer_size 事務日誌緩衝區秒級持久化</p><p>innodb_flush_log_at_trx_commit 0秒級寫入chach並flush到磁盤</p><p>1每次事務提交都寫入cache並flush到磁盤</p><p>2每次都寫入cache，每秒flush到磁盤</p><p>innodb_flush_method=O_DIRECT 操作系統不緩存數據</p><p>innodb_file_per_table =1 innodb的表空間</p><p>innodb_foublewrite = 1 雙寫緩存，避免葉沒寫完整就寫到文件中</p><p>myisam：delay_key_write OFF ON ALL</p><p>安全相關配置：</p><p>expire_log_days 指定binlog自動清理的天數</p><p>max_allowed_packet 控制mysql可接收的包的大小</p><p>skip_name_resolve 禁用DNS查找</p><p>syadate_is_now 確保sysdate()返回確定日期</p><p>read_only 禁止super全縣用戶的寫權限</p><p>skip_slave_start 禁止slave自動恢復</p><p>sql_mode 設置mysql使用的sql模式</p><p>(strict_trans_tables, no_engine_subtitution,no_zero_date,no_zero_in_date,only_full_group_by)</p><p>其他配置的影響</p><p>sysc_binlog 默認為0 ，操作系統決定什麼時候刷新binlog;1，每次事務都會有寫binlog操作</p><p>tmp_table_size 和 max_heap_table_size 內存臨時表的大小，超過就會生產磁盤臨時表</p><p>max_connections 控制最大連接數</p><p>結構設計和sql優化</p><p>表的列太多，由於插件式引擎設計，mysql的服務層和引擎層是分離的，在引擎層的api和服務器層需要緩存格式來拷貝數據，然後在服務器層解析轉換成各個列。</p><p>關聯太多的表 10個是極限</p><p>OLTP環境不恰當使用分區表</p><p>外鍵的使用 保證數據完整性，效率低，修改和備份時候，要檢查約束，額外的鎖的開銷</p><p></p><p>總結：數據庫結構設計 和 sql優化 > 數據庫的存儲引擎和參數配置 > 系統參數的優化 > 硬件的升級</p><p><br></p><p>5，mysql性能測試</p><p>基準測試 直接簡單，易於比較，評估服務器處理能力，不涉及邏輯處理</p><p>壓力測試 正式業務數據進行測試，獲得真實的業務系統的壓力</p><p>指標：TPS QPS 響應時間(最大 最小平均 響應時間 各個時間百分比) 併發請求數量(同時操作的數量 不是同時存在的進程)</p><p>收集信息：cpu使用率 IO 網絡流量 狀態 計數器信息等</p><p>工具：ab，mysqlslap(mysql5.1之後自帶)，sysbench ,Super Smack</p><p></p><p>6，表結構設計對性能的影響</p><p>良好的數據庫邏輯設計和物理設計是數據庫良好性能的jichu</p><p>目標：減少數據的冗餘，避免數據的依賴維護異常，節約數據的存儲空間，提高查詢效率</p><p>步驟：需求分析(存儲需求，處理需求，安全性和完整性)</p><p>邏輯設計(設計數據的邏輯存儲結構，數據實體之間的邏輯關係，解決數據冗餘，維護數據異常)</p><p>物理設計(表結構的設計)</p><p>維護優化(根據實際業務情況進行索引，存儲結構的優化)</p><p></p><p>表邏輯設計 範式+反範式結合 = 高性能</p><p>範式：...... 減少冗餘，體積小，更新快</p><p>查詢關聯表多，查詢效率低；索引優化更加困難</p><p>反範式化: 空間換時間，更加方便查詢條件的設計，提高查詢效率,減少關聯表，更好的索引優化(覆蓋索引等)</p><p>物理設計</p><p>命名規範：庫，表，字段的命名規範，不能用大小寫區分，可讀性，表意義的表達，完整單詞</p><p>存儲引擎：沒特殊要求就用innodb，上邊寫過各個引擎的使用場景</p><p>表字段：合適的數據類型</p><p>數字》日期〉二進制》字符 (字符的比較排序等是根據字符集排序規則相關的，數字二進制日期等不用二進制大小可以直接比較)</p><p>同時佔用空間越小越好(數據處理以頁為單位的 innodb是16k，列越小每頁的數據量就越多)</p><p>tinnyint 1字節 -128，128 0，255</p><p>smallint 2字節</p><p>mediuint 3字節</p><p>int 4字節</p><p>bigint 8字節</p><p></p><p>float 4字節</p><p>double 8個字節</p><p>decimal 每4字節存儲9個數字，小數點佔一個字節</p><p></p><p>varchar 變長字符串，只佔用必要的存儲空間</p><p>額外的字節存儲字符串長度，列的長度超過255需要兩個字節存儲字符串長度，最大就是65535長度，所以不可能用3個字節</p><p>使用最小符合需求的長度(改變長度會鎖表，5.7之後不超過255不會鎖表)</p><p>varchar(5)和varchar(200)性能比較，mysql在加載數據到內存中使用的是固定寬度，緩存和內存臨時表的時候消耗的內存比較多</p><p>適合存儲長度比較分散的數據，很少被更新的數據(字符長度變化，可能引起存儲頁的分裂,產生磁盤碎片)，多字節字符集</p><p>char 固定寬度字符串，末尾的空格會被過濾刪除，最大寬度255</p><p>適合存儲長度比較集中，長度短小的字符串，經常被更新的字符列</p><p>日期類型 datetime類型 以yyyy-mm-dd hh:mm:ss 存儲，與時區無關，佔用8個字節存儲空間</p><p>date 和 time 類型</p><p>timestamp類型 時間戳，顯示格式yyyy-mm-dd hh:mm:ss，只佔用4個字節，依賴時區，自動修改更新</p><p>存儲空間比字符串少，日期可以對比，日期函數方便計算；不要用int來代替timestamp存儲時間，並沒有什麼好處</p><p>7，mysql架構設計</p><p>主從複製：分擔mysql的讀負載，高可用，災難恢復備份，通過二進制日誌同步數據，異步處理，有延遲</p><p>二進制日誌增量進行復制，不需要太多帶寬，基於行的複製在大批量修改時會帶來帶寬壓力</p><p>mysql的二進制日誌，慢查詢日誌，通用日誌屬於服務層日誌，innodb的重做日誌和回滾日誌屬於引擎層日誌</p><p>二進制日誌：記錄了mysql數據庫的修改事件，增刪改事件和表結構變化</p><p>binlog_format=STATEMENT 基於段的日誌格式，記錄sql和上下文信息，日誌量少，節約磁盤和網絡io</p><p>但是使用非確定性函數，導致上下文信息無法確定的情況時無法複製的、</p><p>binlog_format=ROW 基於行的日誌格式 默認格式 官方推薦，記錄每行數據的修改</p><p>更加安全的複製，複製的效率高，降低主從延遲時間</p><p>日誌的量比較大，binlog_row_image = FULL | MINIMAL | NOBLOB</p><p>binlog_format=MIXED 混合行和段的日誌格式 系統根據sql內容一定的算法確定</p><p></p><p>主從複製過程:</p><p>1,開啟主服務器二進制日誌，主服務器將寫入更新寫入二進制日誌</p><p>2,從服務器讀取主服務器二進制增量寫入到relay_log中，io線程，轉儲線程</p><p>3,從服務器重新執行relay_log的內容</p><p>基於日誌的複製建立過程：初始化從庫數據(mysqldump 等工具)-》啟動複製(指定 master 用戶 密碼 二進制文件 偏移量)</p><p>基於GTID的複製：GTID全局事務ID，每個主庫上提交的事務生成唯一ID，從服務器會告訴主服務器已執行的事務的GTID值，主庫會告訴從哪些GTID事務沒有被執行。</p><p>故障處理麻煩，沒有skip衝突的操作</p><p>GTID = source_id:transsction_id</p><p>參考:https://www.jianshu.com/p/169315f2124a?utm_source=oschina-app</p><p></p><p>mysql5.7之後支持多主多從</p><p>一主多從 mysql5.7之前一直支持</p><p>配置簡單，</p><p>多個從庫分擔讀負載，分擔主庫的讀負載</p><p>不同的業務使用不同的從庫，不同的業務使用不同的索引</p><p>雙主複製 互為主從</p><p>容易產生衝突，儘量分開每個庫操作的表</p><p>主備複製 高可用方案</p><p>一臺mysql只讀，做熱備份，主庫故障才會切換成主服務器</p><p>一臺mysql做主服務器，切換後作為備份服務器的從庫</p><p>主從延遲 主從延遲不可避免</p><p>主庫寫入二進制的時間(大事務)，控制事務的大小，分割成小事務</p><p>二進制的傳輸時間(日誌量，磁盤IO，網絡帶寬)，設置給予MIXED的日誌格式</p><p>從庫重放sql，單線程串行處理重放sql(主庫的併發寫入從庫變成串行),mysql5.6後支持單庫的多線程複製</p><p>mysql5,7支持邏輯時鐘的多線程複製</p><p>主從複製中斷</p><p>數據損壞丟失，主從的二進制日誌損壞</p><p>從庫數據被修改，造成數據衝突</p><p>不唯一的server_id,server_uuid</p><p></p><p>高可用 High Availability 縮短故障和系統維護的停機時間，提高可用性</p><p>服務器磁盤空間耗盡，性能糟糕的sql，表結構索引沒有優化，人為操作失誤，主從故障等</p><p>建立完整的監控系統，備份數據的恢復測試，及時歸檔和清理不需要的數據</p><p>增加系統的冗餘，避免單點故障，主從切換故障轉移</p><p></p><p>單點故障</p><p>利用SUN共享存儲或DRDB磁盤鏡像解決mysql單點故障</p><p>多寫集群(pxc)或NDB集群解決單點故障</p><p>主從複製來解決單點故障</p><p>MMM(perl):監控管理mysql主主複製的拓撲，切換主備服務器的切換和故障轉移，提供讀寫虛擬ip</p><p>同一時間只有一臺主mysql對外服務，其他的事只讀模式</p><p>監控主從中斷，延遲過大時，進程故障轉移</p><p>MHA(perl) : 監控主從複製的拓撲，切換主從服務器完成故障轉移</p><p>監控主服務器是否可用，不可以就從眾多的從服務器選舉出一個做主服務器</p><p>讀寫分離 負載均衡</p><p>寫操作在主服務器進行，讀操作在多個從庫進行負載均衡</p><p>程序實現讀寫分離，更靈活控制連接主從數據庫，直接連接效率高，但是增加工作量程序複雜，人為控制容易出錯</p><p>讀寫中間件實現 mysql-proxy maxScale 根據語法分析解析出時讀操作還是寫操作，存儲過程等直接算主操作，多程序透明，節約開發成本；但是增加了中間層，對查詢效率損耗很大，對延遲敏感的業務無法在主庫執行</p><p>負載均衡：程序輪循，軟件(LVS Haproxy MaxScale) ，硬件F5等</p><p></p><p>8，索引查詢的優化</p><p>索引作用是快速查找到需要的數據(太多，太少的索引都會損耗性能)，mysql在存儲引擎層實現的索引，不同的存儲引擎索引的使用是不一樣的；減少存儲引擎掃描的數據量(innodb的每次io以頁為單位默認16k)，幫助排序避免臨時表的產生，把隨機i 哦轉變為順序io。</p><p>同時，索引會增加更新插入成本，要維護索引和統計信息，innodb引入了插入緩存把多次插入操作合併操作；同時mysql的查詢優化器會分析索引選擇合適的索引，太多的索引也會增加查詢優化器的時間。</p><p></p><p>b-tree索引：以B+樹的結構存儲數據，是一個平衡查找樹。能加快查找數據的速度，更加合適範圍查找</p><p>每個葉子到根的距離是相同的，每個節點按照鍵值的大小順序存放</p><p>全值匹配查詢，匹配最左前綴查詢，匹配列前綴的查詢，匹配範圍值的查詢，精確匹配左前列並範圍匹配下一列，索引覆蓋，order by 排等；</p><p>not in, != ,&lt;> 等否定查詢在b-tree不會用到索引(網上查的待求證 跟引擎有關)</p><p>索引列上不能使用表達式和函數</p><p>innodb 索引最大大小不能超過767個字節，myisam是1000個字節，大字符串要使用前綴索引，前綴索引就要考慮到索引的選擇性</p><p>聯合索引 mysql5.0之前一條sql只能使用到一個列上的索引；mysql5.0之後引入了索引合併，可以合併多個列上的索引進行過濾，但是需要更多的內存和磁盤IO來緩存這些索引獲取的數據，聯合索引更好；</p><p>列的順序:經常被使用的列優先，選擇性高的列優先，寬度小的列優先</p><p>覆蓋索引 除了where條件之外，可以直接通過索引獲取查詢的數據，也就沒必要去讀取數據行的數據了，避免innodb主鍵索引的二次查詢，避免myisam的系統調用</p><p></p><p>hash索引：基於hash表實現，只有查詢精確匹配到hash索引所有的列才會用到索引，存儲引擎會為每一行計算hash碼，hash索引存儲的就是hash碼，就是說查找會很快，必須二次查找；存儲順序是按照hash碼的大小存儲的，不能用於排序、範圍查找等；hash衝突</p><p></p><p>索引優化排序：通過索引掃描數據，索引的順序和order by字段完全一致，排序方向也要完全一致，連表查詢必須在主表中</p><p>索引優化鎖：減少鎖定的行數量，加快處理速度，加快行釋放的速度</p><p></p><p>刪除重複和冗餘的索引，查找不會被使用的索引，更新索引的統計信息，減少索引碎片(analyze table table_name, optimize table會鎖表)</p><p></p><p>9，sql查詢的優化</p><p>獲取性能有問題的sql：通過用戶反饋，慢日誌獲取，實時獲取性能有問題的sql</p><p>慢日誌 開銷主要是磁盤的IO和磁盤存儲空間</p><p>慢查詢開啟 slow_query_log</p><p>慢查詢日誌存儲路徑 slow_query_log_file</p><p>慢查詢日誌sql時間伐值 long_query_time</p><p>是否記錄未使用索引的sql log_queries_not_using_indexes</p><p>mysqldumpslow ，pt-query-digest慢日誌分析工具</p><p>實時獲取有問題的sql show processlist</p><p>infomation_schema 數據庫下的processlist表:SELECT user, host, time, command, time FROM [mysql|information_schema].processlist WHERE user = 'me' and state IS NOT NULL;</p><p></p><p>mysql的執行sql的生命週期分析</p><p>客戶端通過mysql的接口發送sql給服務器</p><p>這個影響微乎其微</p><p></p><p>服務器檢查查詢緩存是否命中該sql，命中則直接返回結果</p><p>打開查詢緩存，優先查詢緩存是否命中，通過一個大小寫敏感的hash查找實現，hash是全值匹配，所以sql必須完全一樣，每次更新查詢緩存涉及的表時緩存都會被刷新，而且在緩存查詢是否命中時候會對緩存加鎖，在併發高和讀寫太頻繁的系統中很可能是降低查詢處理效率</p><p>query_cache_type = ON | OFF | DEMAND</p><p>query_cache_size 查詢緩存內存大小1024 * n</p><p>query_cache_limit 查詢緩存可存儲的最大值</p><p>query_cache_wlock_invalidate 數據表鎖住是否返回緩存中的數據 默認關閉</p><p>query_cache_min_res_unit 查詢緩存分配的內存最小單位</p><p>在sql上加sql_no_cache 不去查詢緩存</p><p></p><p>服務器對sql進行解析，預處理，優化器生成執行計劃</p><p>mysql的解析器通過關鍵字對mysql進行語句解析，使用mysql的語法規則和解析查詢，生成一顆解析樹</p><p>預處理是進一步檢查解析樹是否合法(查詢中涉及的表和數據列是否存在，名字別名歧義等)</p><p>查詢優化器生成查詢計劃，一條sql可用有很多執行方式，優化器會對每種執行方式存儲引擎提供的統計信息進行比較，找到成本最低的計劃；可能重新定義表的關聯順序，將外連接轉化為內連接，等價變換，將表達式轉換為常數表達式，子查詢轉換為關聯表</p><p>索引太多會導致優化器耗時太多；</p><p>存儲引擎提供的統計信息不準確、執行計劃的成本骨斷可能並不是實際執行計劃的成本，服務層並不知道存儲層的所有信息，那些數據是在內存中還是磁盤上，那些數據是順序讀還是隨機讀，就會錯誤的選擇讀區數據少的執行計劃</p><p>優化器認為的最優結果可能不是想要的(執行時間，資源利用最少)</p><p>優化器不會考慮併發問題，也就是鎖的問題對執行的影響</p><p>優化器會基於一些固定的規則生成執行計劃，不會考慮執行成本</p><p></p><p>根據執行計劃，調用引擎api查詢數據</p><p>這個影響微乎其微</p><p>返回客戶端結果</p><p>這個影響微乎其微</p><p></p><p>獲取sql執行各個階段的時間 profile(官方要廢棄) performance_schema(mysql5.5官方推薦的性能分析存儲引擎)</p><p>set profile = 1</p><p>執行sql</p><p>show profiles;</p><p>show profile for query N;</p><p>show profile cpu for query N;</p><p>...</p><p></p><p>開啟performance_schema 會記錄所有sql的階段執行時間監控</p><p>update `setup_instruments` SET enabled='YES' where NAME like 'stage&&#39;;</p><p>update `setup_consumers` SET enabled='YES' where NAME like 'event%';</p><p>sql執行優化</p><p>大表的數據修改要分批次處理，中間有間隔時間</p><p>大表結構的修改(表中的字段類型和寬度)會鎖表，先從從服務器修改，再主從切換，再修改老的主服務器再切換回來；</p><p>(pt-online-change-schamel)</p><p>not in 和 &lt;> 等優化 ，使用連表等方式重寫sql</p><p>使用匯總表優化查詢</p><p></p><p>10，分庫分表</p><p>分擔數據庫的讀負載，可用做主從讀寫分離；數據量激增，數據庫的性能急劇下降，可用把服務器拆分</p><p>把一個實例的多個庫分到不同的數據庫</p><p>把一個實例中一個庫中不同的表拆分到多個庫</p><p>表水平拆分到不同的實例中</p><p>分區鍵的選擇，儘量避免跨分片查詢發生，儘可能平均分配數據到分片中，熱數據也要平均</p><p>分區鍵的hash值取模來分片，範圍分片，分區鍵和分片的映射表來分配數據</p><p>redis生成全局id並緩存</p><p></p><p>11，數據庫監控</p><p>數據庫的穩定性決定系統的穩定性，監控軟件有nagios和zabbix等。</p><p>可用性聯通監控 mysqladmin -umonitor_user -p -h ping</p><p>telnet ip db_port</p><p>代碼模擬真實應用連接數據庫</p><p>監控數據庫連接數</p><p>數據庫性能監控 QPS和TPS</p><p></p><p>數據庫的併發數量監控</p><p></p><p>數據庫的innodb的阻塞監控</p><p></p><p>主從複製的監控</p><p>pt-table-checksum</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>數據庫</a></li><li><a>優化</a></li><li><a>思考</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/a3c371fa.html alt=從原理到優化，深入淺出數據庫索引 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b59d88e0563642728dd6294e09a8a0af style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a3c371fa.html title=從原理到優化，深入淺出數據庫索引>從原理到優化，深入淺出數據庫索引</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3d54fe0b.html alt="深度研究自然梯度優化，從入門到放棄 | Deep Reading" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/2cc1b8ef47a5458190c22d26d8bd164c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3d54fe0b.html title="深度研究自然梯度優化，從入門到放棄 | Deep Reading">深度研究自然梯度優化，從入門到放棄 | Deep Reading</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html alt=MySQL數據庫的事務管理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/152203544367254a708f807 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html title=MySQL數據庫的事務管理>MySQL數據庫的事務管理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dc1a27dd.html alt="詳解Oracle 數據庫啟動過程" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/1538236609349861be8e044 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dc1a27dd.html title="詳解Oracle 數據庫啟動過程">詳解Oracle 數據庫啟動過程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ad3f3a1e.html alt="數據庫技術：MySQL 基礎和 SQL 入門，單表、約束和事務" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/107897c16ae7461caa62dd375b631afe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ad3f3a1e.html title="數據庫技術：MySQL 基礎和 SQL 入門，單表、約束和事務">數據庫技術：MySQL 基礎和 SQL 入門，單表、約束和事務</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8ff1c7a8.html alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/dfic-imagehandler/8f370516-d41a-4803-84ba-2c01e4637c8b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8ff1c7a8.html title=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理>解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/18681b55.html alt=PHP鏈接數據庫操作教程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3b10e2d3b35043f8ae9cb1823878b66a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/18681b55.html title=PHP鏈接數據庫操作教程>PHP鏈接數據庫操作教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8e1b3755.html alt=裝完系統必做的優化，更改用戶文件和軟件安裝默認路徑，你知道嗎 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8d349042865d40cf9b8f1e91e2537426 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8e1b3755.html title=裝完系統必做的優化，更改用戶文件和軟件安裝默認路徑，你知道嗎>裝完系統必做的優化，更改用戶文件和軟件安裝默認路徑，你知道嗎</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d0518503.html alt=優化營商環境“大家談”︱擔當職責使命，貢獻公安力量 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RHnAsqqAQHVKXV style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d0518503.html title=優化營商環境“大家談”︱擔當職責使命，貢獻公安力量>優化營商環境“大家談”︱擔當職責使命，貢獻公安力量</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f3e06bc8.html alt=熱血傳奇的第二個數據庫，怪物數據庫參數值解析教程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/875b193ef0954c6286e409e03cff93de style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f3e06bc8.html title=熱血傳奇的第二個數據庫，怪物數據庫參數值解析教程>熱血傳奇的第二個數據庫，怪物數據庫參數值解析教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cd4899a4.html alt="引進打樁“神器”  優化施工工藝海濱路東西延伸工程順利推進" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/48a3decd487848809296b7f0b9a0b15c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cd4899a4.html title="引進打樁“神器”  優化施工工藝海濱路東西延伸工程順利推進">引進打樁“神器”  優化施工工藝海濱路東西延伸工程順利推進</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d47d6214.html alt=記一次生產環境數據庫連接超時自動回收問題及解決方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ceb8e16a0c0648fc9359e41485d1a3d0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d47d6214.html title=記一次生產環境數據庫連接超時自動回收問題及解決方法>記一次生產環境數據庫連接超時自動回收問題及解決方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8654883c.html alt=項目實踐中的一些性能優化指南 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8c9ad977831f4b6bbaaf2e1b4651b667 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8654883c.html title=項目實踐中的一些性能優化指南>項目實踐中的一些性能優化指南</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4bcf71f1.html alt=如何優化一個投資組合的omega比率？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/RzQabD49vAZW1Y style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4bcf71f1.html title=如何優化一個投資組合的omega比率？>如何優化一個投資組合的omega比率？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fafaed1a.html alt=潮汕僑批數據庫如何運作？怎樣使用？這篇文章告訴你 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/810e00032cf230d0faa7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fafaed1a.html title=潮汕僑批數據庫如何運作？怎樣使用？這篇文章告訴你>潮汕僑批數據庫如何運作？怎樣使用？這篇文章告訴你</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>