<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>時序分析與預測完全指南 | 极客快訊</title><meta property="og:title" content="時序分析與預測完全指南 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/RZDC2FSBoz7Nc6"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/f8595f1.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/f8595f1.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/f8595f1.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/f8595f1.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/f8595f1.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/f8595f1.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e5%ad%b8/f8595f1.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e5%ad%b8/f8595f1.html><meta property="article:published_time" content="2020-10-29T21:02:27+08:00"><meta property="article:modified_time" content="2020-10-29T21:02:27+08:00"><meta name=Keywords content><meta name=description content="時序分析與預測完全指南"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E5%AD%B8/f8595f1.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>時序分析與預測完全指南</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E5%AD%B8.html>科學</a></span></div><div class=post-content><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC2FSBoz7Nc6><p>無論我們是想預測金融市場的趨勢還是用電量，時間都是我們模型中必須考慮的一個重要因素。例如，預測一天中什麼時候會出現用電高峰是很有趣的，可以以此為依據調整電價或發電量。</p><p>輸入時間序列。時間序列只是按時間順序排列的一系列數據點。在時間序列中，時間往往是獨立變量，其目標通常是預測未來。</p><p>然而，在處理時間序列時，還有一些其他因素會發揮作用。</p><p>它是靜止的嗎？</p><p>有季節性嗎？</p><p>目標變量是否自相關？</p><p>在這篇文章中，我將介紹時間序列的不同特徵，以及我們如何對它們進行建模才能獲得準確的預測。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC2FmCTHI4HC><p>預測未來是困難的</p><p><strong>自相關</strong></p><p>通俗地說，自相關是觀測值之間的相似度，它是觀測值之間時間滯後的函數。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC2G180rPCRy><p>自相關示例</p><p>上面是一個自相關的例子。仔細觀察，你會發現第一個值和第 24 個值具有很高的自相關性。同樣，第 12 個值和第 36 個觀測值也高度相關。這意味著我們將在每 24 個時間單位中找到一個非常相似的值。</p><p>注意，這個圖看起來像正弦函數。這是季節性的徵兆，你可以通過在上面的圖中找到 24 小時的週期來找到它的價值。</p><p><strong>季節性</strong></p><p>季節性是指週期性波動。例如，白天的用電量高，晚上的用電量低，或者聖誕節期間的在線銷售額增加，節後銷售再次放緩。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC2GEBX3ZTTc><p>季節性示例</p><p>如你所見，每天都有明顯的季節性。每天晚上，你都會看到一個高峰，最低點出現在每天的開始和結束。</p><p>記住，如果季節性是滿足正弦函數的，它也可以從自相關圖中推導出來。簡單地看一下週期，它給出了季節的長度。</p><p><strong>平穩性</strong></p><p>平穩性是時間序列的一個重要特徵。如果時間序列的統計性質不隨時間變化，則稱其為平穩的。換句話說，它有不變的均值和方差，協方差不隨時間變化。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC2GSG44bF01><p>平穩過程示例</p><p>再看上面的圖，我們看到上面的過程是平穩的，平均值和方差不會隨時間變化。</p><p>通常，股票價格不是一個平穩的過程，因為我們可能會看到一個增長的趨勢，或者，其波動性可能會隨著時間的推移而增加（這意味著方差正在變化）。</p><p>理想情況下，我們需要一個用於建模的固定時間序列。當然，不是所有的都是平穩的，但是我們可以通過做不同的變換，使它們保持平穩。</p><p><strong>如何測試過程是否平穩</strong></p><p>你可能已經注意到在上圖的標題「Dickey-Fuller」。這是我們用來確定時間序列是否穩定的統計測試。</p><p>在不討論 Dickey-Fuller 測試的技術特性的情況下，它檢測了單位根是否存在空假設。</p><p>如果是，則 P>0，並且過程不是平穩的。</p><p>否則，p=0，無效假設被拒絕，過程被認為是平穩的。</p><p>例如，下面的過程不是平穩的。請注意為什麼平均值不隨時間變化。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC2divFxXQj><p>非平穩過程示例</p><p><strong>時間序列建模</strong></p><p>有很多方法可以模擬時間序列來進行預測。在此，我將介紹：</p><ul><li><p>移動平均</p></li><li><p>指數平滑</p></li><li><p>ARIMA</p></li></ul><p><strong>移動平均</strong></p><p>移動平均模型可能是最簡單的時間序列建模方法。這個模型簡單來說就是，下一個值是所有過去值的平均值。</p><p>雖然很簡單，但是這個模型的效果可能好到出乎意料，它代表了一個好的起點。</p><p>否則，移動平均值可用於識別數據中有趣的趨勢。我們可以定義一個窗口來應用移動平均模型來平滑時間序列，並突出不同的趨勢。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC2e14Oof853><p>24 小時窗口上的移動平均值示例</p><p>在上面的圖中，我們將移動平均模型應用於一個 24 小時窗口。綠線平滑了時間序列，我們可以看到 24 小時內有 2 個峰值。</p><p>當然，窗口越長，趨勢就越平滑。下面是一個較小窗口上移動平均值的示例。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC2eF4PWwy6v><p>12 小時窗口上的移動平均值示例</p><p><strong>指數平滑</strong></p><p>指數平滑使用與移動平均相似的邏輯，但這次，對每個觀測值分配了不同的遞減權重。換言之，離現在的時間距離越遠，觀察結果的重要性就越低。</p><p>在數學上，指數平滑表示為：</p><p>指數平滑表達式</p><p>這裡，alpha 是一個平滑因子，它的值介於 0 和 1 之間。它決定了之前觀測值的權重下降的速度。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC2elJ9Rhydq><p>指數平滑示例</p><p>在上面的圖中，深藍色線表示時間序列的指數平滑，平滑係數為 0.3，而橙色線表示平滑係數為 0.05。</p><p>如你所見，平滑因子越小，時間序列就越平滑。這是有意義的，因為當平滑因子接近 0 時，我們接近移動平均模型。</p><p><strong>雙指數平滑</strong></p><p>當時間序列中存在趨勢時，使用雙指數平滑。在這種情況下，我們使用這種技術，它只是指數平滑的兩次遞歸使用。</p><p>數學公式為：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC2oFIxpwe2j><p>雙指數平滑表達式</p><p>這裡，beta 是趨勢平滑因子，它的值介於 0 和 1 之間。</p><p>下面，你可以看到 alpha 和 beta 的不同值如何影響時間序列的形狀。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC2oY5lJXGIO><p>雙指數平滑示例</p><p><strong>三指數平滑</strong></p><p>該方法通過添加季節平滑因子來擴展雙指數平滑。當然，如果你注意到時間序列中的季節性，這很有用。</p><p>在數學上，三指數平滑表示為：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC2okDwkUDkw><p>三指數平滑表達式</p><p>其中 gamma 是季節平滑因子，L 是季節長度。</p><p><strong>季節性差分自迴歸滑動平均模型（SARIMA）</strong></p><p>SARIMA 實際上是簡單模型的組合，可以生成一個複雜的模型，該模型可以模擬具有非平穩特性和季節性的時間序列。</p><p>首先，我們得到了自迴歸模型 AR(p)。這基本上是時間序列對自身的迴歸。在這裡，我們假設當前值依賴於它以前的值，並且有一定的滯後。它採用一個表示最大滯後的參數 p。為了找到它，我們查看了部分自相關圖，在此之後大部分滯後並不顯著。</p><p>在下面的例子中，p 的值是 4。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC2ow2zkClQ><p>部分自相關圖示例</p><p>然後，我們添加移動平均模型 MA(q)。這需要一個參數 q，它代表自相關圖上那些滯後不顯著的最大滯後。</p><p>下圖中，q 為 4。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC2pBBc3OZYk><p>自相關圖示例</p><p>之後，我們添加整合順序 I(d)。參數 d 表示使序列平穩所需的差異數。</p><p>最後，我們添加最後一部分：季節性 S(P, D, Q, s)，其中 S 只是季節的長度。此外，這裡要求參數 P 和 Q 與 p 和 q 相同，但用於季節部分。最後，D 是季節整合的順序，表示從系列中刪除季節性所需的差異數量。</p><p>綜合起來，我們得到了 SARIMA(p, d, q)(P, D, Q, s) 模型。</p><p>要注意的是：在用 SARIMA 建模之前，我們必須對時間序列進行轉換，以消除季節性和任何非平穩行為。</p><p>這是一個很好的理論！讓我們在第一個項目中應用上面討論的技術。</p><p>我們將想辦法預測一家公司的股票價格。現在，預測股票價格幾乎是不可能的。然而，這仍然是一個有趣的練習，它將是一個很好的來實踐我們所學到知識的方法。</p><p><strong>項目 1：股票價格預測</strong></p><p>我們將利用 New Germany Fund（GF）的歷史股價來預測未來五個交易日的收盤價。</p><p>你可以在這裡獲取數據集和資料。</p><p>像往常一樣，我強烈推薦你動手編碼！啟動你的筆記本，我們開始吧！</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC306INJrN4e><p>你絕不會因為這個項目而發財</p><p><strong>導入數據</strong></p><blockquote><p>import numpy as np</p><p>import pandas as pd</p><p>import matplotlib.pyplot as plt</p><p>import seaborn as sns</p><p>sns.set</p><br><p>from sklearn.metrics import r2_score, median_absolute_error, mean_absolute_error</p><p>from sklearn.metrics import median_absolute_error, mean_squared_error, mean_squared_log_error</p><br><p>from scipy.optimize import minimize</p><p>import statsmodels.tsa.api as smt</p><p>import statsmodels.api as sm</p><br><p>from tqdm import tqdm_notebook</p><br><p>from itertools import product</p><br><p>def mean_absolute_percentage_error(y_true, y_pred):</p><p>return np.mean(np.abs((y_true - y_pred) / y_true)) * 100</p><br><p>import warnings</p><p>warnings.filterwarnings('ignore')</p><br><p>%matplotlib inline</p><br><p>DATAPATH = 'data/stock_prices_sample.csv'</p><br><p>data = pd.read_csv(DATAPATH, index_col=['DATE'], parse_dates=['DATE'])</p><p>data.head(10)</p></blockquote><p>首先，我們導入一些庫，這些庫將在整個分析過程中都會用到。此外，我們用平均百分比誤差（MAPE）作為我們的誤差度量。</p><p>然後，我們導入數據集，排在前十的是：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC30S5Qv884d><p>數據集的前 10 個條目</p><p>正如你所看到的，我們有一些關於 New Germany Fund (GF) 不同股票的數據。此外，我們還有一個關於當天信息的數據，但我們只需要當天結束（EOD）時的股票信息。</p><p><strong>數據清洗</strong></p><blockquote><p>data = data[data.TICKER != 'GEF']</p><p>data = data[data.TYPE != 'Intraday']</p><br><p>drop_cols = ['SPLIT_RATIO', 'EX_DIVIDEND', 'ADJ_FACTOR', 'ADJ_VOLUME', 'ADJ_CLOSE', 'ADJ_LOW', 'ADJ_HIGH', 'ADJ_OPEN', 'VOLUME', 'FREQUENCY', 'TYPE', 'FIGI']</p><br><p>data.drop(drop_cols, axis=1, inplace=True)</p><br><p>data.head</p></blockquote><p>首先，我們刪除不需要的條目。</p><p>然後，我們刪除不需要的列，因為我們只想關注股票的收盤價。</p><p>如果預覽數據集，則應該看到的是：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC30l691ucpQ><p>清洗後的數據集</p><p>令人驚歎！我們準備好進行探索性數據分析了！</p><p><strong>探索性數據分析（EDA）</strong></p><blockquote><p># Plot closing price</p><br><br><p>plt.figure(figsize=(17, 8))</p><p>plt.plot(data.CLOSE)</p><p>plt.title('Closing price of New Germany Fund Inc (GF)')</p><p>plt.ylabel('Closing price ($)')</p><p>plt.xlabel('Trading day')</p><p>plt.grid(False)</p><p>plt.show</p></blockquote><p>我們繪製數據集整個時間段的收盤價。</p><p>你將會得到：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC30xAJ86Ort><p>New Germany Fund （GF）收盤價</p><p>很明顯，你看到的不是一個平穩的過程，很難判斷是否有某種季節性。</p><p><strong>移動平均</strong></p><p>讓我們使用移動平均模型來平滑我們的時間序列。為此，我們將使用一個輔助函數，該函數將在指定的時間窗口上運行移動平均模型，並繪製結果平滑曲線：</p><blockquote><p>def plot_moving_average(series, window, plot_intervals=False, scale=1.96):</p><br><p>rolling_mean = series.rolling(window=window).mean</p><br><p>plt.figure(figsize=(17,8))</p><p>plt.title('Moving average\n window size = {}'.format(window))</p><p>plt.plot(rolling_mean, 'g', label='Rolling mean trend')</p><br><p>#Plot confidence intervals for smoothed values</p><p>if plot_intervals:</p><p>mae = mean_absolute_error(series[window:], rolling_mean[window:])</p><p>deviation = np.std(series[window:] - rolling_mean[window:])</p><p>lower_bound = rolling_mean - (mae + scale * deviation)</p><p>upper_bound = rolling_mean + (mae + scale * deviation)</p><p>plt.plot(upper_bound, 'r--', label='Upper bound / Lower bound')</p><p>plt.plot(lower_bound, 'r--')</p><br><p>plt.plot(series[window:], label='Actual values')</p><p>plt.legend(loc='best')</p><p>plt.grid(True)</p><br><p>#Smooth by the previous 5 days (by week)</p><p>plot_moving_average(data.CLOSE, 5)</p><br><p>#Smooth by the previous month (30 days)</p><p>plot_moving_average(data.CLOSE, 30)</p><br><p>#Smooth by previous quarter (90 days)</p><p>plot_moving_average(data.CLOSE, 90, plot_intervals=True)</p></blockquote><p>使用5天的時間窗口，我們得到：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/RZDC31ACkUHgJ2><p>上一個交易周的平滑曲線</p><p>如你所見，我們幾乎看不到趨勢，因為它太接近實際曲線。讓我們看看上個月和上個季度的平滑處理結果。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC3DCBSlltqp><p>上個月（30 天前）的平滑曲線</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC3DO9NP1VIu><p>按上一季度（90 天）平滑</p><p>現在更容易發現趨勢。請注意，30 天和 90 天的趨勢圖在末尾顯示一條向下的曲線。這意味著股票可能在接下來的幾天內會下跌。</p><p><strong>指數平滑</strong></p><p>現在，讓我們用指數平滑來看看它是否能獲得更好的趨勢。</p><blockquote><p>def exponential_smoothing(series, alpha):</p><br><p>result = [series[0]] # first value is same as series</p><p>for n in range(1, len(series)):</p><p>result.append(alpha * series[n] + (1 - alpha) * result[n-1])</p><p>return result</p><br><p>def plot_exponential_smoothing(series, alphas):</p><br><p>plt.figure(figsize=(17, 8))</p><p>for alpha in alphas:</p><p>plt.plot(exponential_smoothing(series, alpha), label="Alpha {}".format(alpha))</p><p>plt.plot(series.values, "c", label = "Actual")</p><p>plt.legend(loc="best")</p><p>plt.axis('tight')</p><p>plt.title("Exponential Smoothing")</p><p>plt.grid(True);</p><br><p>plot_exponential_smoothing(data.CLOSE, [0.05, 0.3])</p></blockquote><p>這裡，我們使用 0.05 和 0.3 作為平滑因子的值。當然你也可以嘗試其他值，看看結果如何。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC3DeAxDT12a><p>指數平滑</p><p>如您所見，alpha 值 0.05 平滑了曲線，同時剔除了大部分向上和向下的趨勢。</p><p>現在，讓我們使用雙指數平滑。</p><p><strong>雙指數平滑</strong></p><blockquote><p>def double_exponential_smoothing(series, alpha, beta):</p><br><p>result = [series[0]]</p><p>for n in range(1, len(series)+1):</p><p>if n == 1:</p><p>level, trend = series[0], series[1] - series[0]</p><p>if n >= len(series): # forecasting</p><p>value = result[-1]</p><p>else:</p><p>value = series[n]</p><p>last_level, level = level, alpha * value + (1 - alpha) * (level + trend)</p><p>trend = beta * (level - last_level) + (1 - beta) * trend</p><p>result.append(level + trend)</p><p>return result</p><br><p>def plot_double_exponential_smoothing(series, alphas, betas):</p><br><p>plt.figure(figsize=(17, 8))</p><p>for alpha in alphas:</p><p>for beta in betas:</p><p>plt.plot(double_exponential_smoothing(series, alpha, beta), label="Alpha {}, beta {}".format(alpha, beta))</p><p>plt.plot(series.values, label = "Actual")</p><p>plt.legend(loc="best")</p><p>plt.axis('tight')</p><p>plt.title("Double Exponential Smoothing")</p><p>plt.grid(True)</p><br><p>plot_double_exponential_smoothing(data.CLOSE, alphas=[0.9, 0.02], betas=[0.9, 0.02])</p></blockquote><p>你將得到：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC3Dp9MToSHI><p>雙指數平滑</p><p>同樣，用不同的 α 和 β 組合進行實驗，以獲得更好的曲線。</p><p><strong>建模</strong></p><p>如前所述，我們必須將序列轉換為一個平穩的過程，以便對其進行建模。因此，讓我們應用 Dickey-Fuller 測試來看看它是否是一個平穩的過程：</p><blockquote><p>def tsplot(y, lags=None, figsize=(12, 7), syle='bmh'):</p><br><p>if not isinstance(y, pd.Series):</p><p>y = pd.Series(y)</p><br><p>with plt.style.context(style='bmh'):</p><p>fig = plt.figure(figsize=figsize)</p><p>layout = (2,2)</p><p>ts_ax = plt.subplot2grid(layout, (0,0), colspan=2)</p><p>acf_ax = plt.subplot2grid(layout, (1,0))</p><p>pacf_ax = plt.subplot2grid(layout, (1,1))</p><br><p>y.plot(ax=ts_ax)</p><p>p_value = sm.tsa.stattools.adfuller(y)[1]</p><p>ts_ax.set_title('Time Series Analysis Plots\n Dickey-Fuller: p={0:.5f}'.format(p_value))</p><p>smt.graphics.plot_acf(y, lags=lags, ax=acf_ax)</p><p>smt.graphics.plot_pacf(y, lags=lags, ax=pacf_ax)</p><p>plt.tight_layout</p><br><p>tsplot(data.CLOSE, lags=30)</p><br><p># Take the first difference to remove to make the process stationary</p><p>data_diff = data.CLOSE - data.CLOSE.shift(1)</p><br><p>tsplot(data_diff[1:], lags=30)</p></blockquote><p>你將看到：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC3E0HDKpG5Y><p>通過 DickeyFuller 測試，時間序列是非平穩的。另外，從自相關圖來看，我們發現它似乎沒有明顯的季節性。</p><p>因此，為了消除高度自相關並使過程穩定，讓我們取第一個差異（代碼塊中的第 23 行）。我們簡單地用一天的滯後時間減去時間序列，得到：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC3JzumcYdY><p>令人驚歎的！我們的序列現在是平穩的，可以開始建模了！</p><p><strong>SARIMA</strong></p><blockquote><p>#Set initial values and some bounds</p><p>ps = range(0, 5)</p><p>d = 1</p><p>qs = range(0, 5)</p><p>Ps = range(0, 5)</p><p>D = 1</p><p>Qs = range(0, 5)</p><p>s = 5</p><br><p>#Create a list with all possible combinations of parameters</p><p>parameters = product(ps, qs, Ps, Qs)</p><p>parameters_list = list(parameters)</p><p>len(parameters_list)</p><br><p># Train many SARIMA models to find the best set of parameters</p><p>def optimize_SARIMA(parameters_list, d, D, s):</p><p>"""</p><p>Return dataframe with parameters and corresponding AIC</p><br><p>parameters_list - list with (p, q, P, Q) tuples</p><p>d - integration order</p><p>D - seasonal integration order</p><p>s - length of season</p><p>"""</p><br><p>results =</p><p>best_aic = float('inf')</p><br><p>for param in tqdm_notebook(parameters_list):</p><p>try: model = sm.tsa.statespace.SARIMAX(data.CLOSE, order=(param[0], d, param[1]),</p><p>seasonal_order=(param[2], D, param[3], s)).fit(disp=-1)</p><p>except:</p><p>continue</p><br><p>aic = model.aic</p><br><p>#Save best model, AIC and parameters</p><p>if aic</p><p>best_model = model</p><p>best_aic = aic</p><p>best_param = param</p><p>results.append([param, model.aic])</p><br><p>result_table = pd.DataFrame(results)</p><p>result_table.columns = ['parameters', 'aic']</p><p>#Sort in ascending order, lower AIC is better</p><p>result_table = result_table.sort_values(by='aic', ascending=True).reset_index(drop=True)</p><br><p>return result_table</p><br><p>result_table = optimize_SARIMA(parameters_list, d, D, s)</p><br><p>#Set parameters that give the lowest AIC (Akaike Information Criteria)</p><p>p, q, P, Q = result_table.parameters[0]</p><br><p>best_model = sm.tsa.statespace.SARIMAX(data.CLOSE, order=(p, d, q),</p><p>seasonal_order=(P, D, Q, s)).fit(disp=-1)</p><br><p>print(best_model.summary)</p></blockquote><p>現在，對於 SARIMA，我們首先定義一些參數值的範圍，以生成 p, q, d, P, Q, D, s 的所有可能組合的列表。</p><p>現在，在上面的代碼單元中，我們有 625 種不同的組合！我們將嘗試每種組合，並訓練 SARIMA，以便找到性能最佳的模型。這可能需要一些時間，具體多長時間取決於計算機的處理能力。</p><p>完成後，我們將輸出最佳模型的摘要，你將看到：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC3KG5iLuEEh><p>令人驚歎！最後，我們預測未來五個交易日的收盤價，並評估模型的 MAPE。</p><p>在這種情況下，有一個 0.79% 的 MAPE，這是非常好的！</p><p><strong>將預測價格與實際數據進行比較</strong></p><blockquote><p># Make a dataframe containing actual and predicted prices</p><p>comparison = pd.DataFrame({'actual': [18.93, 19.23, 19.08, 19.17, 19.11, 19.12],</p><p>'predicted': [18.96, 18.97, 18.96, 18.92, 18.94, 18.92]},</p><p>index = pd.date_range(start='2018-06-05', periods=6,))</p><br><p>#Plot predicted vs actual price</p><br><p>plt.figure(figsize=(17, 8))</p><p>plt.plot(comparison.actual)</p><p>plt.plot(comparison.predicted)</p><p>plt.title('Predicted closing price of New Germany Fund Inc (GF)')</p><p>plt.ylabel('Closing price ($)')</p><p>plt.xlabel('Trading day')</p><p>plt.legend(loc='best')</p><p>plt.grid(False)</p><p>plt.show</p></blockquote><p>現在，為了將我們的預測與實際數據進行比較，我們從雅虎財務（YahooFinance）獲取財務數據並創建一個數據框架。</p><p>然後，我們繪出曲線，看看我們與實際收盤價的差距有多大：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC3KT2yJQATU><p>預計值和實際收盤價比較</p><p>我們的預測似乎有點偏離。事實上，預測價格很平穩，這意味著我們的模型可能表現不佳。</p><p>當然，這不是因為我們的程序，而是因為預測股票價格基本上是不可能的。</p><p>從第一個項目開始，我們學習了在使用 SARIMA 建模之前平滑時間序列的整個過程。</p><p>現在，讓我們介紹一下 Facebook 的 Prophet。它是一個在 python 和 r 中都可用的預測工具。該工具幫助生成高質量的預測。</p><p>讓我們看看如何在第二個項目中使用它！</p><p><strong>項目2-使用 Prophet 預測空氣質量</strong></p><p>標題說明了一切：我們將使用 Prophet 來幫助我們預測空氣質量！</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC3KfCyCT9g7><p><strong>導入數據</strong></p><blockquote><p>import warnings</p><p>warnings.filterwarnings('ignore')</p><br><p>import numpy as np</p><p>import pandas as pd</p><p>from scipy import stats</p><p>import statsmodels.api as sm</p><p>import matplotlib.pyplot as plt</p><br><p>%matplotlib inline</p><br><p>DATAPATH = 'data/AirQualityUCI.csv'</p><br><p>data = pd.read_csv(DATAPATH, sep=';')</p><p>data.head</p></blockquote><p>打印出前五行：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC3Ks4JiB91e><p>如你所見，數據集包含有關不同氣體濃度的信息。每天隔一個小時記錄一次。</p><p>如果更深入地研究數據集，會發現有許多值 -200 的實例。當然，負濃度是沒有意義的，所以我們需要在建模前清洗數據。</p><p><strong>數據清洗與特徵工程</strong></p><blockquote><p># Make dates actual dates</p><p>data['Date'] = pd.to_datetime(data['Date'])</p><br><p># Convert measurements to floats</p><p>for col in data.iloc[:,2:].columns:</p><p>if data[col].dtypes == object:</p><p>data[col] = data[col].str.replace(',', '.').astype('float')</p><br><p># Compute the average considering only the positive values</p><p>def positive_average(num):</p><p>return num[num > -200].mean</p><br><p># Aggregate data</p><p>daily_data = data.drop('Time', axis=1).groupby('Date').apply(positive_average)</p><br><p># Drop columns with more than 8 NaN</p><p>daily_data = daily_data.iloc[:,(daily_data.isna().sum()</p><br><p># Remove rows containing NaN values</p><p>daily_data = daily_data.dropna()</p><br><p># Aggregate data by week</p><p>weekly_data = daily_data.resample('W').mean()</p><br><p># Plot the weekly concentration of each gas</p><p>def plot_data(col):</p><p>plt.figure(figsize=(17, 8))</p><p>plt.plot(weekly_data[col])</p><p>plt.xlabel('Time')</p><p>plt.ylabel(col)</p><p>plt.grid(False)</p><p>plt.show</p><br><p>for col in weekly_data.columns:</p><p>plot_data(col)</p></blockquote><p>在這裡，我們首先分析日期列，將其轉換為日期類型。</p><p>然後，我們把所有的測量值轉換成浮點數。</p><p>之後，我們用每天的平均值來彙總數據。</p><p>我們還有一些需要刪除的 NAN。</p><p>最後，我們按周彙總數據，這將提供一個更平滑的分析趨勢。</p><p>我們可以畫出每種化學物質濃度的趨勢。這裡，我們展示了 NOx。</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/RZDC3Sc8XMRthq><p>NOx 濃度</p><p>氮氧化物是非常有害的，因為它們會形成煙霧和酸雨，同時也會形成細顆粒和臭氧。這些都會對健康產生不利影響，因此氮氧化物的濃度是空氣質量的一個關鍵特徵。</p><p><strong>建模</strong></p><blockquote><p># Drop irrelevant columns</p><p>cols_to_drop = ['PT08.S1(CO)', 'C6H6(GT)', 'PT08.S2(NMHC)', 'PT08.S4(NO2)', 'PT08.S5(O3)', 'T', 'RH', 'AH']</p><br><p>weekly_data = weekly_data.drop(cols_to_drop, axis=1)</p><br><p># Import Prophet</p><p>from fbprophet import Prophet</p><p>import logging</p><br><p>logging.getLogger.setLevel(logging.ERROR)</p><br><p># Change the column names according to Prophet's guidelines</p><p>df = weekly_data.reset_index</p><p>df.columns = ['ds', 'y']</p><p>df.head</p><br><p># Split into a train/test set</p><p>prediction_size = 30</p><p>train_df = df[:-prediction_size]</p><br><p># Initialize and train a model</p><p>m = Prophet</p><p>m.fit(train_df)</p><br><p># Make predictions</p><p>future = m.make_future_dataframe(periods=prediction_size)</p><p>forecast = m.predict(future)</p><p>forecast.head</p><br><p># Plot forecast</p><p>m.plot(forecast)</p><br><p># Plot forecast's components</p><p>m.plot_components(forecast)</p><br><p># Evaluate the model</p><p>def make_comparison_dataframe(historical, forecast):</p><p>return forecast.set_index('ds')[['yhat', 'yhat_lower', 'yhat_upper']].join(historical.set_index('ds'))</p><br><p>cmp_df = make_comparison_dataframe(df, forecast)</p><p>cmp_df.head</p><br><p>def calculate_forecast_errors(df, prediction_size):</p><br><p>df = df.copy</p><br><p>df['e'] = df['y'] - df['yhat']</p><p>df['p'] = 100 * df['e'] / df['y']</p><br><p>predicted_part = df[-prediction_size:]</p><br><p>error_mean = lambda error_name: np.mean(np.abs(predicted_part[error_name]))</p><br><p>return {'MAPE': error_mean('p'), 'MAE': error_mean('e')}</p><br><p>for err_name, err_value in calculate_forecast_errors(cmp_df, prediction_size).items:</p><p>print(err_name, err_value)</p><br><p># Plot forecast with upper and lower bounds</p><p>plt.figure(figsize=(17, 8))</p><p>plt.plot(cmp_df['yhat'])</p><p>plt.plot(cmp_df['yhat_lower'])</p><p>plt.plot(cmp_df['yhat_upper'])</p><p>plt.plot(cmp_df['y'])</p><p>plt.xlabel('Time')</p><p>plt.ylabel('Average Weekly NOx Concentration')</p><p>plt.grid(False)</p><p>plt.show</p></blockquote><p>我們將只關注氮氧化物濃度。因此，我們刪除所有其他不相關的列。</p><p>然後，我們導入 Prophet。</p><p>Prophet 要求日期列命名為 ds，特徵列命名為 y，因此我們進行了適當的更改。</p><p>此時，我們的數據如下：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC3StG3ciKx5><p>然後，我們定義一個訓練集。為此，我們將保留最後 30 個條目進行預測和驗證。</p><p>之後，我們簡單地初始化 Prophet，將模型與數據匹配，並進行預測！</p><p>你會看到：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RZDC3T6uCvFGj><p>這裡，yhat 代表預測值，yhat_lower 和 yhat_upper 分別代表預測值的下限和上限。</p><p>Prophet 讓你可以輕鬆繪製預測圖，我們得到：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC3TK27Rr0FR><p>NOx 濃度預測</p><p>如你所見，Prophet 只是用一條直線來預測未來的 NOx 濃度。</p><p>然後，我們檢查時間序列是否具有某些有趣的特性，例如季節性：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC3TWxWyPdU><p>在這裡，Prophet 沒有發現季節性的趨勢。</p><p>通過計算模型的平均絕對百分誤差（MAPE）和平均絕對誤差（MAE）來評估模型的性能，我們發現 MAPE 為 13.86%，MAE 為 109.32，這還不錯！記住，我們根本沒有對模型進行微調。</p><p>最後，我們只需繪製預測的上限和下限：</p><img alt=時序分析與預測完全指南 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RZDC3ZZ6w3ptCJ><p>每週 NOx 平均濃度預測</p><p>恭喜你達到目的！這篇文章很長，但內容豐富。你學會了如何強有力地分析和建模時間序列，並將你的知識應用到兩個不同的項目中。我希望你覺得這篇文章有用。</p><p>via：https://towardsdatascience.com/the-complete-guide-to-time-series-analysis-and-forecasting-70d476bfe775</p><p>雷鋒網雷鋒網雷鋒網</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>時序</a></li><li><a>預測</a></li><li><a>指南</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/1e410983.html alt=(Python)時序預測的七種方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/66b00004e736363da6cd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1e410983.html title=(Python)時序預測的七種方法>(Python)時序預測的七種方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8f767a2e.html alt=丙烯：半年行情分析總結及預測 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/S3SJgeN5ypM7PE style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8f767a2e.html title=丙烯：半年行情分析總結及預測>丙烯：半年行情分析總結及預測</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dd24912b.html alt=風電功率預測方法和準確性提升方案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/5f2a2cfa2c6b41f8b257a551ed5321f0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dd24912b.html title=風電功率預測方法和準確性提升方案>風電功率預測方法和準確性提升方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/727b86f0.html alt=七星彩20037期5月15日預測圖規 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/513cf55cfe3a45fbb084d1ef3f325b01 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/727b86f0.html title=七星彩20037期5月15日預測圖規>七星彩20037期5月15日預測圖規</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f882bb79.html alt=分享5月15日七星彩規律分析預測圖規給大家參考 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/0f24154c13af4e87ae863f3c65a5e9f2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f882bb79.html title=分享5月15日七星彩規律分析預測圖規給大家參考>分享5月15日七星彩規律分析預測圖規給大家參考</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/56f7a4bb.html alt=七星彩20043期5月29日預測圖規 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/317bf787208243a0aef875f94a62d797 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/56f7a4bb.html title=七星彩20043期5月29日預測圖規>七星彩20043期5月29日預測圖規</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/81bdd963.html alt=七星彩20044期5月31日預測圖規 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/d3913728ea9645b2a1b1402e9d5639c7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/81bdd963.html title=七星彩20044期5月31日預測圖規>七星彩20044期5月31日預測圖規</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a9716ebb.html alt=七星彩20049期6月14日預測圖規 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a5224065e1b6476d84ab324931b49c38 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a9716ebb.html title=七星彩20049期6月14日預測圖規>七星彩20049期6月14日預測圖規</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/04486bed.html alt=七星彩20051期6月19日預測圖規 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/bce617f909d945ef914079493e6c5ec8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/04486bed.html title=七星彩20051期6月19日預測圖規>七星彩20051期6月19日預測圖規</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b0f253ec.html alt=七星彩20053期6月23日預測圖規 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7410c85b79e147a4935875f7b965af2e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b0f253ec.html title=七星彩20053期6月23日預測圖規>七星彩20053期6月23日預測圖規</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e67b0784.html alt=七星彩20054期6月26日預測圖規 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/696d38ff58a6420fa47c481081d9057e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e67b0784.html title=七星彩20054期6月26日預測圖規>七星彩20054期6月26日預測圖規</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/388785a7.html alt=七星彩20057期7月3日預測圖規 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/674b016775844f28872d054532972092 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/388785a7.html title=七星彩20057期7月3日預測圖規>七星彩20057期7月3日預測圖規</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1c01abea.html alt=七星彩20061期7月11日預測圖規 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4a56596ce3f5474b9bea84feb30bf9d0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1c01abea.html title=七星彩20061期7月11日預測圖規>七星彩20061期7月11日預測圖規</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6f2b9e5c.html alt=自我保護指南 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RSAP0RrBuRac6c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6f2b9e5c.html title=自我保護指南>自我保護指南</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/84212c94.html alt=解密：市場是如何被準確預測的 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/15296338811936d465f4770 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/84212c94.html title=解密：市場是如何被準確預測的>解密：市場是如何被準確預測的</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>