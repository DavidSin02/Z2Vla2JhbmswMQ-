<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>JVM 垃圾收集器細節補充 | 极客快訊</title><meta property="og:title" content="JVM 垃圾收集器細節補充 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/97bc94b0a276433a809abd99b14bd724"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/030e9343.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/030e9343.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/030e9343.html><meta property="article:published_time" content="2020-10-29T21:10:13+08:00"><meta property="article:modified_time" content="2020-10-29T21:10:13+08:00"><meta name=Keywords content><meta name=description content="JVM 垃圾收集器細節補充"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/030e9343.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>JVM 垃圾收集器細節補充</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>禁用 System.gc()</h1><p>System.gc() 會顯式直接觸發 Full GC，同時對老年代和新生代進行回收。JVM 的內存回收都是自動的，一般情況下不需要我們手動觸發 GC。因此如果要在程序中禁用，可以通過-XX:+DisableExplicitGC禁用。當程序中使用了System.gc()，就相當於調用了一個空函數。</p><h1>對象何時進入老年代</h1><p>一般情況下，新創建的對象會出現在新生代的 Eden區。對於存活時間長的對象，進入老年代的情況有以下2種：</p><ul><li>普通對象晉升老年代</li></ul><p>JVM 中提供了 -XX:MaxTenuringThreshold=15 這個參數來指定，普通對象晉升老年代經歷的GC的最大次數。這個參數值默認是15，當然對象往往不到15次GC就已經進入了老年代。</p><p>晉升中還有一個比較重要的參數，-XX:TargetSurvivorRatio=50。它用來指定suvivor區的使用率達到50%時（默認值），觸發晉升老年代。</p><ul><li>大對象直接進入老年代</li></ul><p>通常來說，我們對於Java項目的堆分配，老年代會佔到一大半的容量。所以當新生代（Eden/Survivor）容量不足時，新創建的大對象會直接進入老年代。</p><p>我們可以通過 -XX:PretenureSizeThreshold （單位字節）來指定直接晉升老年代的對象大小。但是在測試時往往會出現以下情況，對象達到設置大小並未進入老年代。這是因為JVM在使用內存空間時，會優先使用一塊TLAB的區域。</p><p>TLAB（Thread Local Allocation Buffer）是線程本地分配緩存。它佔用了 Eden區的空間，JVM 會為每一個Java線程分配一塊 TLAB空間。啟用參數是：-XX:+UseTLAB （JVM默認開啟）。</p><h1>對象分配簡要流程</h1><p>我們所熟知的是對象是在對上分配的，但是對象的分配大致會經歷以下幾個流程。首先會嘗試在棧上分配，棧上分配的對象會隨著方法塊的執行結束，而自動被回收。如果失敗了，則會嘗試TLAB分配。如果再失敗了，則會檢查是否滿足直接進入老年代的條件，滿足則在老年代分配。如果不滿足，則在Eden區分配。簡要流程如下所示：</p><div class=pgc-img><img alt="JVM 垃圾收集器細節補充" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/97bc94b0a276433a809abd99b14bd724><p class=pgc-img-caption>對象分配簡要流程</p></div><h1>finalize() 對 GC 的影響</h1><p>finalize() 方法類似於C++中的析構函數，它在對象即將被GC回收器回收的時候執行1次。但是儘量不要使用finalize()對資源進行釋放，儘量不要重寫該方法，原因如下：</p><ul><li>finalize() 可能會造成對象復活</li><li>執行時間是沒有保障的，它完全由 GC線程決定。極端情況下，如果不發生GC，finalize() 將不會執行</li><li>如寫的不好，則有可能嚴重影響 GC 性能</li></ul><p>finalize() 是由 FinalizerThread 線程處理的。每個即將被回收的並且包含有finalize()方法的對象，都會被在正式回收前加入 FinalizerThread 的執行隊列（為 ReferenceQueue 引用隊列）。</p><p>FinalizerThread 的工作過程和FinalizerThread執行隊列關係如下所示：</p><div class=pgc-img><img alt="JVM 垃圾收集器細節補充" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cc277b9da55c4f699fbfc3aeae7fd09f><p class=pgc-img-caption>FinalizerThread 的工作過程</p></div><h1>​​​​​​​常用 GC 參數整理</h1><p><strong>串行收集器相關</strong></p><ul><li>-XX:+UseSerialGC：在新生代和老年代使用串行收集器。</li><li>-XX:SurvivorRatio：設置Eden區和Survivor區的比例。設置為8，則兩個Survivor區與一個Eden區的比值為2:8，一個Survivor區佔整個年輕代的1/10。</li><li>-XX:PretenureSizeThreshold：設置大對象進入老年代的閥值（單位字節）。</li><li>-XX:MaxTenuringThreshold：設置進入老年代年齡的最大值，每一次新生代GC都會加1（默認15）。</li></ul><p><strong>並行 GC 相關</strong></p><ul><li>-XX:+UseParNewGC：新生代使用並行收集器。</li><li>-XX:+UseParallelOldGC：老年代使用並行回收。</li><li>-XX:ParallelGCThreads：設置用戶GC的線程數。通常情況下可以和CPU個數相同，但CPU較多的情況下，可以相對設置小一些。</li><li>-XX:MaxGCPauseMillis：設置GC最大停頓時間。</li><li>-XX:GCTimeRatio：設置吞吐量大小。取值0-100之間的整數。如設置為n，則系統花費不超過1/(n+1)的時間用於GC。</li><li>-XX:+UseAdaptiveSizePolicy：打開自適應GC策略。這種模式下，JVM的各個參數都將會被動態調整，以達到堆大小、吞吐量和停頓時間的平衡。</li></ul><p><strong>CMS 相關</strong></p><ul><li>-XX:+UseConcMarkSweepGC：新生代使用並行回收器，老年代使用CMS+串行回收。</li><li>-XX:ParallelCMSThreads：設定CMS的線程數量。</li><li>-XX:CMSInitiatingOccupancyFraction：設置CMS收集器在老年代使用多少後觸發GC，默認68%。</li><li>-XX:+UseCMSCompactAtFullCollection：設置CMS收集器在完成垃圾收集後，是否要進行一次碎片整理。</li><li>-XX:CMSFullGCsBeforeCompaction：設定進行多少次CMS回收後，進行一次內存壓縮。</li><li>-XX:+CMSClassUnloadingEnabled：允許對元數據區進行回收。</li><li>-XX:CMSInitiatingPermOccupancyFraction：當永久區使用率達到這一百分比時，啟動CMS回收。（前提是CMSClassUnloadingEnabled開啟）</li><li>-XX:UseCMSInitiatingOccupancyOnly：表示只在達到閥值的時候才進行CMS回收。</li><li>-XX:+CMSIncrementalMode：使用增量模式，比較適合單CPU。JDK8中廢棄，JDK9中已移除。</li></ul><p><strong>G1 相關</strong></p><ul><li>-XX:+UseG1GC：使用G1收集器。</li><li>-XX:MaxGCPauseMillis：設置最大停頓時間。</li><li>-XX:GCPauseIntervalMillis：設置停頓間隔時間。</li></ul><p><strong>TLAB 相關</strong></p><ul><li>-XX:+UseTLAB：開啟TLAB分配。</li><li>-XX:+PrintTLAB：打印TLAB相關分配信息。</li><li>-XX:TLABSize：設置TLAB大小。</li><li>-XX:+ResizeTLAB：自動調整TLAB大小。</li></ul><p><strong>其他</strong></p><ul><li>-XX:+DisableExplicitGC：禁用顯示GC。</li><li>-XX:+ExplicitGCInvokesConcurrent：使用併發的方式處理顯示GC。</li></ul><hr><p>參考：《實戰Java虛擬機》</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>收集器</a></li><li><a>JVM</a></li><li><a>細節</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/816b04b7.html alt=從JVM層面帶你分析Java的Object類源碼第一部分 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/816b04b7.html title=從JVM層面帶你分析Java的Object類源碼第一部分>從JVM層面帶你分析Java的Object類源碼第一部分</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2179e644.html alt=皇室戰爭：部落戰2.0細節，戰隊可容納200人，新選卡模式上線 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/62c35fe8d8a14a769f32844042206ae7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2179e644.html title=皇室戰爭：部落戰2.0細節，戰隊可容納200人，新選卡模式上線>皇室戰爭：部落戰2.0細節，戰隊可容納200人，新選卡模式上線</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1330fc4d.html alt=細節關乎生命！水泥罐車失控衝撞對向車道大貨車 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/98c15e2c8c3c44c683ae1c642991fcd2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1330fc4d.html title=細節關乎生命！水泥罐車失控衝撞對向車道大貨車>細節關乎生命！水泥罐車失控衝撞對向車道大貨車</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1403d46a.html alt=迷你世界新手挖礦最需要注意的細節，最後一個至關重要 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/153580836578920ced53e70 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1403d46a.html title=迷你世界新手挖礦最需要注意的細節，最後一個至關重要>迷你世界新手挖礦最需要注意的細節，最後一個至關重要</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8c0b6207.html alt=甲減要長期服用優甲樂？注意做好4個細節，可減少藥物副作用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e6f3d10ef078429896ee118b906a65b4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8c0b6207.html title=甲減要長期服用優甲樂？注意做好4個細節，可減少藥物副作用>甲減要長期服用優甲樂？注意做好4個細節，可減少藥物副作用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f7d6b056.html alt=防水層施工技術細節要點 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1e87044b217c474ba2c3330e9ccec129 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f7d6b056.html title=防水層施工技術細節要點>防水層施工技術細節要點</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0f5e7d7c.html alt=混凝土澆築方案，總有你不知道的那些細節！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/b44667ae3f574a7390e9c2596bb824eb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0f5e7d7c.html title=混凝土澆築方案，總有你不知道的那些細節！>混凝土澆築方案，總有你不知道的那些細節！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c1dbdfe3.html alt=新房裝修安裝筒燈，5個細節讓你家更安全！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/7f928770c4c24fbdafa6d949cc146738 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c1dbdfe3.html title=新房裝修安裝筒燈，5個細節讓你家更安全！>新房裝修安裝筒燈，5個細節讓你家更安全！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d6bfc6d9.html alt="汽車漏水不要慌 注意到這些細節都是小問題" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/78f1843d0a194391bf90f4e1003b3d2b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d6bfc6d9.html title="汽車漏水不要慌 注意到這些細節都是小問題">汽車漏水不要慌 注意到這些細節都是小問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/97a7ecda.html alt=搬家需要多少錢？搬家都要注意哪些細節 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RZxndQC3jP5J8T style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/97a7ecda.html title=搬家需要多少錢？搬家都要注意哪些細節>搬家需要多少錢？搬家都要注意哪些細節</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/97122076.html alt=詳細細節來了，川航3U8633航班備降事件調查結果公佈 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/S0nNhXAD2TxJ9z style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/97122076.html title=詳細細節來了，川航3U8633航班備降事件調查結果公佈>詳細細節來了，川航3U8633航班備降事件調查結果公佈</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2de29a4a.html alt=比亞迪駕乘安全細節及應急使用技巧 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/39b90001d9e6f9fbe845 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2de29a4a.html title=比亞迪駕乘安全細節及應急使用技巧>比亞迪駕乘安全細節及應急使用技巧</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7cde2a02.html alt=素描柱體和球體需要注意的一些細節問題-第六講 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153990918303950a85047ef style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7cde2a02.html title=素描柱體和球體需要注意的一些細節問題-第六講>素描柱體和球體需要注意的一些細節問題-第六講</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5a1cce7c.html alt=重視這6個關鍵細節，企業數據管理工作才會更加科學、完善！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/f271c57b-0259-49f6-be9d-03d734260efa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5a1cce7c.html title=重視這6個關鍵細節，企業數據管理工作才會更加科學、完善！>重視這6個關鍵細節，企業數據管理工作才會更加科學、完善！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d1f57b19.html alt=根管充填的操作方法及相關細節 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ffabd428e89a4eaa868c3c889eb8a455 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d1f57b19.html title=根管充填的操作方法及相關細節>根管充填的操作方法及相關細節</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>