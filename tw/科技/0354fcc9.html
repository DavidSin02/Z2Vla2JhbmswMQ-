<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>這可能是最通俗易懂的方式講解ARM中斷原理以及中斷嵌套 | 极客快訊</title><meta property="og:title" content="這可能是最通俗易懂的方式講解ARM中斷原理以及中斷嵌套 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/dfic-imagehandler/0544061d-fcb9-479e-9805-221cc8270f14"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0354fcc9.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0354fcc9.html><meta property="article:published_time" content="2020-10-29T21:09:37+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:37+08:00"><meta name=Keywords content><meta name=description content="這可能是最通俗易懂的方式講解ARM中斷原理以及中斷嵌套"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/0354fcc9.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>這可能是最通俗易懂的方式講解ARM中斷原理以及中斷嵌套</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>幾天前一個學生問我ARM中斷嵌套的問題，我才發現原來在我心中理所當然的事對學生來說理解實屬不易。</p><p>ARM有七種模式，我們這裡只討論SVC、IRQ和FIQ模式。<br></p><div class=pgc-img><img alt=這可能是最通俗易懂的方式講解ARM中斷原理以及中斷嵌套 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/0544061d-fcb9-479e-9805-221cc8270f14><p class=pgc-img-caption></p></div><p><br>我們可以假設ARM核心有兩根中斷引腳（實際上是看不見的），一根叫 irq pin, 一根叫fiq pin。在ARM的cpsr中，有一個I位和一個F位，分別用來禁止IRQ和FIQ。</p><p>當I位和F位為0時，irq pin上有中斷信號過來時，就會打斷arm的當前工作，並且切換到IRQ模式下，跳到相應的異常向量表（vector)位置去執行代碼。這個過程是自動的，但是返回到被中斷打斷的地方就得您親自動手。</p><p>當你跳到異常向量表，處於IRQ的模式的時候，此時如果irq pin上面又來中斷信號，此時ARM是不會理你的，irq pin就像祕書，ARM核心就像老闆，老闆本來在做事，然後來了一個客戶，祕書打斷它，讓客戶進去。而此時再來一個客戶，要麼祕書不斷去敲門問，要麼客戶走人。老闆第一個客戶沒有會見完，不會理你。<br>但是有一種情況例外，當ARM處在IRQ模式，這個時候fiq pin來了一箇中斷信號，fiq pin是什麼？快速中斷，好比公安局的來查刑事案件，才不管老闆是不是在會見客戶，直接打斷，進入到fiq模式，跳到相應的fiq的異常向量表處去執行代碼。那如果當ARM處理FIQ模式，fiq pin又來中斷信號，也就是又一批公安來了，那沒戲，都是執法人員，你打不斷我。如果此時irq pin來了呢？來了也不理，正在辦案，還敢來妨礙公務。</p><p><br></p><div class=pgc-img><img alt=這可能是最通俗易懂的方式講解ARM中斷原理以及中斷嵌套 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/abc3015a-dba4-4777-9edd-312b7c111040><p class=pgc-img-caption></p></div><p><br>所以得出一個結論： <strong>IRQ模式只能被FIQ模式打斷，FIQ模式下誰也打不斷</strong>。<br>在打不斷的情況下，irq pin 或fiq pin隨便你怎麼發中斷信號，都是白髮。<br>所以<strong>除了fiq能打斷irq以外，根本沒有所謂中斷嵌套的情況</strong>。<br>但是再怎麼說irq pin 和fiq pin加起來也就2根引腳，這麼多中斷源，怎麼辦呢？不可能誰來了都直接敲門吧。<br>接下來該說誰來給irq pin或者 fiq pin發信號。從上文可以看到，可能是老闆客戶，也可能是公安。在ARM中，這個事情由中斷控制器管理。<br>拿最簡單的2410/2440的中斷控制器舉例，中斷控制器加一個子中斷控制器，還有一個外部中斷控制器管理了50多箇中斷資源，說穿了有50多個腳。這些腳除了外部中斷都是規定了功能的，比如WDT、LCD、DMA等，這個功能不能改，因為2410/2440內部硬件連線已經決定了。<br>當WDT和DMA中斷都到來時，會被送到SRCPND寄存器中，兩個中斷都在裡面，到底把哪一個送給ARM呢？這個時候先看INTMOD，也就是中斷模式寄存器：哪個中斷被設置成快速中斷，哪個就被送上去；如果兩個都被設置為快速中斷呢？這不可能，因為<strong>同一時間只能有一箇中斷可以被設成快速中斷</strong>。所以，如果有快速中斷，這個時候直接給fiq pin發中斷信號，打斷ARM。<br>要是沒有快速中斷呢，這個時候就看INTMSK，看WDT和DMA有沒有被屏蔽，如果DMA在INTMSK被屏蔽，只有WDT繼續向上送，如果都沒有屏蔽，那麼他們兩個同時進入優先級寄存器PRIORITY，在這裡根據優先級設置，一定會分出一個高一個低的優先級出來，優先級高的那個被送到INTPND寄存器，所以INTPND隨時隨地有且只有一箇中斷在裡面。只要INTPND裡面有中斷，irq pin就不會一直不斷給ARM發中斷信號，當第一次發的時候，中斷了ARM，這個時候ARM進入相應的異常向量並處於IRQ模式。</p><p>此時，INTPND仍然不斷的通過irq pin向ARM發中斷信號，但是此時ARM已經處於IRQ模式，不會理睬你。當你中斷處理完，要退出IRQ模式，這個時候要小心，如果退出IRQ模式之前不清除INTPND裡面的中斷位，剛退出IRQ模式，又會被中斷，因為INTPND一直在發中斷信號。所以在退出IRQ模式前一定要清除INTPND裡面的中斷位<strong>。</strong></p><p><br></p><div class=pgc-img><img alt=這可能是最通俗易懂的方式講解ARM中斷原理以及中斷嵌套 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/dfic-imagehandler/2d3f38c7-5e25-4bdf-ab73-e3049ee76cbd><p class=pgc-img-caption></p></div><p><br></p><p>光清除INTPND裡面的位還不行，因為SRCPND裡面WDT和DMA的中斷在，當你剛清除完INTPND，結果SRCPND裡面又選了一箇中斷出來送到INTPND裡面。所以正確的處理方法是<strong>退出IRQ模式之前，先清除SRCPND裡相應的中斷位，再清除INTPND裡相應的位。</strong>請注意，SRCPND裡面可能有多個位，所以清除你已處理過的中斷就行，而INTPND裡面只可能有一位，直接清掉即可。</p><p>再說說Linux的情況。<strong>Linux不用FIQ，只用到了IRQ</strong>。但是我們有時候一箇中斷需要處理很長時間，我們需要佔用IRQ模式那麼長的時間嗎？不需要，linux在IRQ模式下只是簡單的記錄是什麼中斷，馬上切換回SVC模式，換句話說，<strong>linux的中斷處理都是在SVC模式下處理的。</strong></p><p>那麼中斷號是怎麼來的呢？它在ARM上固定死了，相應的中斷號只有一個辦法得到：查詢irqs.h 。先用一箇中斷號註冊一箇中斷處理程序，當中斷髮生的時候，Linux怎麼知道是我這個中斷號發生的中斷呢？在處理中斷的時候，先讀取INTPND，根據需要再讀取EINTPEND或SUBSRCPND計算出一箇中斷號，相應的處理算法在get_irq_nr_base這個宏中。irqs.h中的中斷號就是根據這個算法把每個中斷號算出來的。</p><p><br><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6848454170815496716/?group_id=6848454170815496716" rel="noopener noreferrer" target=_blank>「基礎知識普及」ARM與X86 CPU架構區別</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6848158330179813899/?group_id=6848158330179813899" rel="noopener noreferrer" target=_blank>ARM指令adr adrl ldr mov簡單科普</a></p><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/c/user/66995122454/#mid=1576400294145038" rel="noopener noreferrer" target=_blank>瞭解更多</a></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>中斷</a></li><li><a>講解</a></li><li><a>ARM</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/d8234770.html alt=關於齒輪常識由淺及深講解透徹，推薦收藏！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4e18dad6a34c44ed850916d34339092b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d8234770.html title=關於齒輪常識由淺及深講解透徹，推薦收藏！>關於齒輪常識由淺及深講解透徹，推薦收藏！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/189fa616.html alt=驅動橋設計講解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/eb89bb6bddcb4755b82277febac75960 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/189fa616.html title=驅動橋設計講解>驅動橋設計講解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6cfd4e0e.html alt="Spring 核心知識講解，太簡單啦" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6cfd4e0e.html title="Spring 核心知識講解，太簡單啦">Spring 核心知識講解，太簡單啦</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2aa5a357.html alt=大白話講解php多態應用實例 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2aa5a357.html title=大白話講解php多態應用實例>大白話講解php多態應用實例</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e71fb88c.html alt=和麵、揉麵技巧，視頻詳細講解，10年和麵經驗，全部告訴你 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8cd49cb368f1488b8c4a65a3fe556d75 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e71fb88c.html title=和麵、揉麵技巧，視頻詳細講解，10年和麵經驗，全部告訴你>和麵、揉麵技巧，視頻詳細講解，10年和麵經驗，全部告訴你</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/30a56352.html alt=師傅領進門，修行在個人，講解6個經典電路圖，其他的能看懂嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3325db5f83a54fd988f8e001fb22b247 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/30a56352.html title=師傅領進門，修行在個人，講解6個經典電路圖，其他的能看懂嗎？>師傅領進門，修行在個人，講解6個經典電路圖，其他的能看懂嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e44d7784.html alt="查找算法 史上最簡單清晰的紅黑樹講解" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/6c3900031930ed9fb441 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e44d7784.html title="查找算法 史上最簡單清晰的紅黑樹講解">查找算法 史上最簡單清晰的紅黑樹講解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c67e6cfe.html alt=java反射機制的講解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9ad2c92f100a4d2e8213dcf70d4781c0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c67e6cfe.html title=java反射機制的講解>java反射機制的講解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/abb4a186.html alt="這應該是全網講解JAVA 異常處理最全的文章了" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b29b2b140f7e4922b0f2ecdff264f228 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/abb4a186.html title="這應該是全網講解JAVA 異常處理最全的文章了">這應該是全網講解JAVA 異常處理最全的文章了</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c60a2936.html alt=防錯法，五大部分詳細講解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c74e008722e848e8b5a3509084a256d8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c60a2936.html title=防錯法，五大部分詳細講解>防錯法，五大部分詳細講解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/be66b380.html alt=汽車剎車原理講解，常見的剎車裝置有鼓式剎車和盤式剎車二種型式 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/3fa0f153327746519f0ed2d51c0ab03a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/be66b380.html title=汽車剎車原理講解，常見的剎車裝置有鼓式剎車和盤式剎車二種型式>汽車剎車原理講解，常見的剎車裝置有鼓式剎車和盤式剎車二種型式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/36ab4a12.html alt=「講解」常見的電工材料在變壓器絕緣上的應用詳解！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1533035714536e9550e5296 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/36ab4a12.html title=「講解」常見的電工材料在變壓器絕緣上的應用詳解！>「講解」常見的電工材料在變壓器絕緣上的應用詳解！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/489dd660.html alt=一文講解二叉樹的遍歷 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/f13672b41fdb4bceb8f7e32c2b461a28 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/489dd660.html title=一文講解二叉樹的遍歷>一文講解二叉樹的遍歷</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/51cb7bc3.html alt=WPS表格快捷鍵講解大全1（區域選取）！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/20f66cbf-8f34-4e08-bd46-a2c22252b906 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/51cb7bc3.html title=WPS表格快捷鍵講解大全1（區域選取）！>WPS表格快捷鍵講解大全1（區域選取）！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/04b2cff7.html alt=圖文講解基坑支擋結構設計、計算和施工 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/bdd7c61eaabc441688abc82fc1710b34 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/04b2cff7.html title=圖文講解基坑支擋結構設計、計算和施工>圖文講解基坑支擋結構設計、計算和施工</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>