<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MySQL5.7事務提交過程以及無損複製源碼解析-愛可生 | 极客快訊</title><meta property="og:title" content="MySQL5.7事務提交過程以及無損複製源碼解析-愛可生 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/f166615b238b45c3b2ad8b0877ec6845"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/05bb30f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/05bb30f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/05bb30f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/05bb30f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/05bb30f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/05bb30f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/05bb30f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/05bb30f.html><meta property="article:published_time" content="2020-10-29T20:50:41+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:41+08:00"><meta name=Keywords content><meta name=description content="MySQL5.7事務提交過程以及無損複製源碼解析-愛可生"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/05bb30f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MySQL5.7事務提交過程以及無損複製源碼解析-愛可生</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>大家都知道在mysql中，在事務真正commit之前，會將事務的binlog日誌寫入到binlog 文件中，在mysql的5.7版本中，提供了所謂的無損複製的功能，該功能作用--就是在主庫的事務對其他的會話線程可見之前，就將該事務的日誌同步到從庫，保證了事務可以安全地無丟失地複製到從庫。</p><p>下面我們從源碼來分析mysql的事務提交以及事務在何時將binlog複製到從庫的。</p><p>MYSQL_BIN_LOG::ordered_commit，這個是事務在binlog階段提交的核心函數，通過該函數，實現了事務日誌寫入binlog文件，以及觸發dump線程將binlog發送到slave，在最後的步驟，將事務設置為提交狀態。</p><p>我們來分析MYSQL_BIN_LOG::ordered_commit這個函數的核心過程，該函數位於binlog.cc文件中。</p><ol start=1><li><strong>源碼解析</strong></li></ol><p>MYSQL_BIN_LOG::ordered_commit，這個函數，核心步驟如下：</p><p><br></p><h2 class=pgc-h-arrow-right>1.1 <strong>第一步驟：flush</strong></h2><p>Stage#1: flushing transactions to binary log:</p><p>步驟1 ：將事務的日誌寫入binlog文件的buffer中，函數如下：</p><p>process_flush_stage_queue(&total_bytes,&do_rotate, &wait_queue);</p><p><br></p><p>從5.6開始，mysql引入了group commit 的概念，這樣可以避免每個事務提交都會鎖定一次binlog.另外，還有一個用處，就是mysql的5.7的基於logical_clock的並行複製。在一個組裡面（其實是一個隊列），這一組隊列的頭事務是相同的，因此這一組事務的last_committed（上一組的最後一個提交的事務）的事務也是同一個。我們都知道，last_committed相同的事務，是可以在從庫並行relay（重演）的。該函數process_flush_stage_queue的作用，就是將commit隊列中的線程一個一個的取出，然後執行子函數 flush_thread_caches(head);循環的代碼如下：將各自線程中的binlog cache寫入到binlog中。</p><p>/* Flush thread caches to binary log. */</p><p>for (THD *head= first_seen ; head ; head = head->next_to_commit)</p><p>{</p><p>std::pair&lt;int,my_off_t>result= flush_thread_caches(head);</p><p>total_bytes+= result.second;</p><p>if(flush_error == 1)</p><p>flush_error= result.first;</p><p>#ifndef DBUG_OFF</p><p>no_flushes++;</p><p>#endif</p><p>}</p><p><br></p><h2 class=pgc-h-arrow-right>1.2 <strong>第二步驟SYNC to disk</strong></h2><p>Stage#2: Syncing binary log file to disk</p><p>第二步：將binlog file中cache的部分寫入disk.但這個步驟參數sync_binlog起決定性的作用。</p><p>我們來看看源碼，除了這些還有哪些細節步驟，聽完源碼分析之後，你應該有新的收穫與理解。</p><p>在執行真正的將binlog寫到磁盤之前，會進行一個等待，函數如下：</p><p>stage_manager.wait_count_or_timeout(opt_binlog_group_commit_sync_no_delay_count,</p><p>opt_binlog_group_commit_sync_delay,</p><p>Stage_manager::SYNC_STAGE);</p><p>等待的時間由mysql參數文件中的binlog_group_commit_sync_delay，binlog_group_commit_sync_no_delay_count 這兩參數共同決定，第一個表示該事務組提交之前總共等待累積到多少個事務，第二個參數則表示該事務組總共等待多長時間後進行提交，任何一個條件滿足則進行後續操作。因為有這個等待，可以讓更多事務的binlog通過一次寫binlog文件磁盤來完成提交，從而獲得更高的吞吐量。</p><p><br></p><p>接下來，就是執行sync_binlog_file，該函數會用到mysql參數文件中sync_binlog參數的值，如果為0，則不進行寫磁盤操作，由操作系統決定什麼時候刷盤，如果為1，則強制進行寫磁盤操作。</p><p><br></p><p>再接下來，執行update_binlog_end_pos函數，用來更新binlog文件的最後的位置binlog_end_pos，該binlog_end_pos是一個全局的變量。在執行更新該位置之前，先得找到最後一個提交事務的線程（因為是group commit,多個事務排隊提交的機制）。因為已經將要提交事務的線程組成了一個鏈表，通過從頭到尾找，可以找到最後一個線程。代碼如下：</p><p><br></p><p>if(update_binlog_end_pos_after_sync)</p><p>{</p><p>THD*tmp_thd= final_queue;</p><p><br></p><p>while(tmp_thd->next_to_commit != NULL)</p><p>tmp_thd= tmp_thd->next_to_commit;</p><p><br></p><p>update_binlog_end_pos(tmp_thd->get_trans_pos());</p><p>}</p><p><br></p><p>接下來，我們來看一下這個函數update_binlog_end_pos，這個函數很簡單，傳入一個pos,然後將其賦值給全局變量binlog_end_pos，接下來就是最核心的一行代碼，signal_update()，發送binlog更新的信號，因此從主庫同步binlog到從庫的dump線程，會接收到這個binlog已有更新的信號，然後啟動dump binlog的流程。</p><p>函數update_binlog_end_pos的完整代碼如下。</p><p>void update_binlog_end_pos(my_off_tpos)</p><p>{</p><p>lock_binlog_end_pos();</p><p>if (pos >binlog_end_pos)</p><p>binlog_end_pos= pos;</p><p>signal_update();</p><p>unlock_binlog_end_pos();</p><p>}</p><h2 class=pgc-h-arrow-right>1.3 <strong>semisync</strong></h2><p>通過上面的步驟介紹，我們看到，在binlog文件的最新位置更新的時候，就已經通過signal_update函數發送信號給binlog的dump線程，該線程就可以將事務的binlog同步到從庫，從庫接收到日誌之後，就可以relay日誌，實現了主從同步。因此，再次重複說明一下，按照上面的解釋，在事務真正提交完成之前就開始發送了binlog已經更新的信號，dump線程收到信號，即可以進行binlog的同步。而semisync的作用是什麼呢？</p><p><br></p><p>實際上，有沒有semisync機制，上面介紹的mysql的有關事務提交中關於binlog的流程都是一樣的，semisync的作用，只是主從之間的一個確認過程，主庫等待從庫返回相關位置的binlog已經同步到從庫的確認，（而實際實現則是等待dump線程給用戶會話線程一個回覆），沒有得到確認之前（或者等待時間達到timeout），事務提交則在該函數（步驟）上等待直至獲得返回。具體執行binlog已經同步到某個位置的的確認函數為repl_semi_report_binlog_sync，函數如下：</p><p>intrepl_semi_report_binlog_sync(Binlog_storage_param *param,</p><p>constchar *log_file,</p><p>my_off_t log_pos)</p><p>{</p><p>if(rpl_semi_sync_master_wait_point == WAIT_AFTER_SYNC)</p><p>returnrepl_semisync.commitTrx(log_file, log_pos);</p><p>return 0;</p><p>}</p><p>通過觀察上述函數，我們可以看到有個rpl_semi_sync_master_wait_point變量與WAIT_AFTER_SYNC比較，如果不相等，則直接返回，直接返回則表示不需要在此時此刻確認binlog是否已經同步，而這個變量的取值來自於半同步參數semi_sync_master_wait_point的初始設置，我們可以設置為after_sync與after_commit。這兩個參數含義的區別是：after_sync是在將binlog sync到disk之後（具體是否真正sync由參數sync_binlog的值決定）進行日誌同步確認，而after_commit是將事務完成在innodb裡面提交之後再進行binlog的同步確認。兩者確認的時間點不同，after_sync要早於after_commit.</p><p><br></p><p>接下來，我們來看repl_semisync.commitTrx 這個函數，這個函數有兩個傳入參數，一個是binlog文件，一個binlog文件的位移。我們來看這個函數的含義吧。算了，還是直接用源碼的註釋來解釋吧。</p><div class=pgc-img><img alt=MySQL5.7事務提交過程以及無損複製源碼解析-愛可生 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f166615b238b45c3b2ad8b0877ec6845><p class=pgc-img-caption></p></div><p>上面的註釋說得相當清楚，就是該commiTRX函數會等待binlog-dump返回已經同步到該位置的報告，如果還沒有同步到該位置，則繼續等待，直到超時返回。</p><p><br></p><p>當會話線程收到該函數的返回時，事務的提交過程繼續往下走，直至在innodb真正提交。</p><p><br></p><p><strong>總結</strong></p><p>通過上述對mysql的事務提交過程中的前段分析，應該可以瞭解semi-sync的同步機制與異步機制的區別，semi-sync的主從同步機制與異步機制在同步的處理方式上無任何區別，唯一的區別就是semi-sync在事務提交中段（假如設置為after_sync）或者提交後的階段（after_commit）, 有一個驗證該事務涉及的binlog是否已經同步到從庫，而這個同步驗證，會拉長整個事務的提交時間，因為事務提交在數據庫中幾乎是串行（如果按group commit為一個單位，就算是完全地串行），是影響mysql吞吐量的關鍵點，當這個關鍵點被拉長，所以對全局的影響就被放大。雖然僅僅多了這麼一個確認的動作，但當主庫處於semi-sync的同步狀態與異步狀態的吞吐量相比，相差了好幾倍。上述解釋就是其真正的原因。</p><div class=pgc-img><img alt=MySQL5.7事務提交過程以及無損複製源碼解析-愛可生 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2f67b60e5c8b4325bc9682afe1a0053d><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>MySQL5.7</a></li><li><a>事務</a></li><li><a>過程</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/daee1f6.html alt=MySQL事務提交過程（一） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/61f7b3575cea4b20b5e0400f9ad4d11b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/daee1f6.html title=MySQL事務提交過程（一）>MySQL事務提交過程（一）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fbc594e1.html alt=合金凝固過程微觀組織相場法研究 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/815da49f86474de38004007ee7edc7a5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fbc594e1.html title=合金凝固過程微觀組織相場法研究>合金凝固過程微觀組織相場法研究</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fb52eed9.html alt=鋼結構施工過程中，為什麼H型鋼樑翼緣要避免開孔 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c7617005bf7449efacd678a2fc77917e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fb52eed9.html title=鋼結構施工過程中，為什麼H型鋼樑翼緣要避免開孔>鋼結構施工過程中，為什麼H型鋼樑翼緣要避免開孔</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e7798a22.html alt=機組停運操作過程步驟 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/53ef0002c8b15a5051c9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e7798a22.html title=機組停運操作過程步驟>機組停運操作過程步驟</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html alt="MySQL 事務處理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html title="MySQL 事務處理">MySQL 事務處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html alt=MySQL——事務(Transaction)詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/29d4c92c9c2344838eb72ef948cf08fa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html title=MySQL——事務(Transaction)詳解>MySQL——事務(Transaction)詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html alt=MySQL數據庫的事務管理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/152203544367254a708f807 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html title=MySQL數據庫的事務管理>MySQL數據庫的事務管理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8293e598.html alt=MySQl事務最全詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c61163c863114226b14bb3760da19e4d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8293e598.html title=MySQl事務最全詳解>MySQl事務最全詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/011d2da0.html alt=MySql併發與事務的處理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/f13d8a1e-5e60-4b48-90bc-3c26e312a208 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/011d2da0.html title=MySql併發與事務的處理>MySql併發與事務的處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4ab1dd0d.html alt=Mysql事務 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4ab1dd0d.html title=Mysql事務>Mysql事務</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cb944fe7.html alt=Mysql事務詳解(一文讀懂數據庫事務) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/cb7ba6cbda8c44438d9d3d7c57bd25b9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cb944fe7.html title=Mysql事務詳解(一文讀懂數據庫事務)>Mysql事務詳解(一文讀懂數據庫事務)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e9d6f488.html alt="SQL Server中的事務（附有實例）" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/21e047bd6e3c41fba0beac7ef3f1ce4e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e9d6f488.html title="SQL Server中的事務（附有實例）">SQL Server中的事務（附有實例）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bb071e7e.html alt="SQL 事務機制-transaction" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3231427d97bf4a04b148360fea032241 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bb071e7e.html title="SQL 事務機制-transaction">SQL 事務機制-transaction</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/44c014a1.html alt=SpringBoot事務詳細簡介 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/44c014a1.html title=SpringBoot事務詳細簡介>SpringBoot事務詳細簡介</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/24b98634.html alt=SqlServer使用事務注意事項，高級程序員必背 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/24b98634.html title=SqlServer使用事務注意事項，高級程序員必背>SqlServer使用事務注意事項，高級程序員必背</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>