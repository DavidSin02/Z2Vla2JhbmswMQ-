<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一文帶你瞭解靜態庫和動態庫 | 极客快訊</title><meta property="og:title" content="一文帶你瞭解靜態庫和動態庫 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/8edd4f4f0e7441aaba2040878790e575"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0bcf267.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0bcf267.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0bcf267.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0bcf267.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0bcf267.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0bcf267.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0bcf267.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0bcf267.html><meta property="article:published_time" content="2020-10-29T21:04:01+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:01+08:00"><meta name=Keywords content><meta name=description content="一文帶你瞭解靜態庫和動態庫"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/0bcf267.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一文帶你瞭解靜態庫和動態庫</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8edd4f4f0e7441aaba2040878790e575><p class=pgc-img-caption>關注後你就是我的人了</p></div><h1><strong>前言</strong></h1><p>我們在編寫代碼的時候經常用到已有的接口，他們是以庫的形式提供給我們使用的，而常見形式有兩種，一種常以.a為後綴，為靜態庫；另一種以.so為後綴，為動態庫。那麼這兩種庫有什麼區別呢？</p><p>說明：本文主要說明Linux下的情況，windows不涉及。</p><h1><strong>目標文件</strong></h1><p>在解釋靜態庫和動態庫之前，需要簡單瞭解一下什麼是目標文件。目標文件常常按照特定格式來組織，在linux下，它是ELF格式（Executable Linkable Format，可執行可鏈接格式），而在windows下是PE（Portable Executable，可移植可執行）。</p><p>而通常目標文件有三種形式：</p><ul><li class=ql-align-justify>可執行目標文件。即我們通常所認識的，可直接運行的二進制文件。</li><li class=ql-align-justify>可重定位目標文件。包含了二進制的代碼和數據，可以與其他可重定位目標文件合併，並創建一個可執行目標文件。</li><li class=ql-align-justify>共享目標文件。它是一種在加載或者運行時進行鏈接的特殊可重定位目標文件。</li></ul><p>我們來看一個簡單實例：</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/9e8ccbb18ddb499a82078b46c9534bed><p class=pgc-img-caption></p></div><p>代碼計算e的2次方並打印結果。由於代碼中用到了exp函數，它位於數學庫libm.so或者libm.a中，因此編譯時需要加上-lm。</p><p>生成可重定位目標文件main.o:</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d042f6c5912649929fbd4ce8c8b1ff4e><p class=pgc-img-caption></p></div><p>通過上面的命令將main.c生成為可重定位目標文件。通過readelf命令也可以看出來：Type為REL (Relocatable file)。</p><p>觀察共享目標文件libm.so：</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6a54f5f47b1042c3978b8c8bec756a12><p class=pgc-img-caption></p></div><p>不同系統中libm.so的位置可能不一樣，你可以通過locate命令來查找。locate命令的用法可參考《Linux中的文件查找技巧》。從結果可以看到，libm.so是共享目標文件（Shared object file）。</p><p>查看可執行目標文件main：</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4bab388fe4ff4fb8a43896333f07c4d2><p class=pgc-img-caption></p></div><p>這裡必須要強調一點，<strong>如果使用到的函數沒有在libc庫中，那麼你就需要指定要鏈接的庫</strong>，本文中需要鏈接libm.so或libm.a。可以看到，最終生成的main類型是Executable file，即可執行目標文件。</p><h1><strong>什麼是靜態庫</strong></h1><p>前面所提到可重定位目標文件以一種特定的方式打包成一個單獨的文件，並且在鏈接生成可執行文件時，從這個單獨的文件中“拷貝”它自己需要的內容到最終的可執行文件中。這個單獨的文件，稱為靜態庫。linux中通常以.a(archive)為後綴</p><p>還是拿前面的例子來說，我們使用靜態鏈接構建我們的可執行文件：</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b8977648f48a43d28343f9c1329ca1a6><p class=pgc-img-caption></p></div><p>在這個過程中，就會用到系統中的靜態庫libm.a。這個過程做了什麼呢？首先第一條命令會將main.c編譯成<strong>可重定位目標文件</strong>main.o，第二條命令的static參數，告訴鏈接器應該使用靜態鏈接，-lm參數表明鏈接libm.a這個庫（類似的，如果要鏈接libxxx.a,使用-lxxx即可）。由於main.c中使用了libm.a中的exp函數，因此鏈接時，會將libm.a中需要的代碼“拷貝”到最終的可執行文件main中。</p><p>特別注意，必須把-lm放在後面。放在最後時它是這樣的一個解析過程：</p><ul><li class=ql-align-justify>鏈接器從左往右掃描可重定位目標文件和靜態庫</li><li class=ql-align-justify>掃描main.o時，發現一個未解析的符號exp，記住這個未解析的符號</li><li class=ql-align-justify>掃描libm.a，找到了前面未解析的符號，因此提取相關代碼</li><li class=ql-align-justify>最終沒有任何未解析的符號，編譯鏈接完成</li></ul><p>那如果將-lm放在前面，又是怎樣的情況呢？</p><ul><li class=ql-align-justify>鏈接器從左往右掃描可重定位目標文件和靜態庫</li><li class=ql-align-justify>掃描libm.a，由於前面沒有任何未解析的符號，因此不會提取任何代碼</li><li class=ql-align-justify>掃描main.o，發現未解析的符號exp</li><li class=ql-align-justify>掃描結束，還有一個未解析的符號，因此編譯鏈接報錯</li></ul><p>如果把-lm放在前面，編譯結果如下：</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/df385d6895a741409007c5d05abab621><p class=pgc-img-caption></p></div><p>我們看看最終生成的文件大小</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/133d2b33354a4188b59babbaa3dd37e9><p class=pgc-img-caption></p></div><p>生成的可執行文件大小為988k。</p><p>由於最終生成的可執行文件中已經包含了exp相關的二進制代碼，因此這個可執行文件在一個沒有libm.a的linux系統中也能正常運行。</p><h1><strong>什麼是動態庫</strong></h1><p>動態庫和靜態庫類似，但是它並不在鏈接時將需要的二進制代碼都“拷貝”到可執行文件中，而是僅僅“拷貝”一些重定位和符號表信息，這些信息可以在程序運行時完成真正的鏈接過程。linux中通常以.so（shared object）作為後綴。</p><p>通常我們編譯的程序默認就是實用動態鏈接：</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e70634a1e87c4cdea8b88c7fc28215f7><p class=pgc-img-caption></p></div><p>我們來看最終生成的文件大小：</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e79d3fa1fed4441b8b4e92a099523615><p class=pgc-img-caption></p></div><p>可以看到，通過動態鏈接的程序<strong>只有8.5k</strong>！</p><p>另外我們還可以通過ldd命令來觀察可執行文件鏈接了哪些動態庫：</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0d3125adc50e419fa739e9e9540854fb><p class=pgc-img-caption></p></div><p>正因為我們並沒有把libm.so中的二進制代碼“拷貝”可執行文件中，我們的程序在其他沒有上面的動態庫時，將無法正常運行。</p><h1><strong>有什麼區別</strong></h1><p>到這裡我們大致瞭解了靜態庫和動態庫的區別了，靜態庫被使用目標代碼最終和可執行文件在一起（它只會有自己用到的），而動態庫與它相反，它的目標代碼在運行時或者加載時鏈接。正是由於這個區別，會導致下面所介紹的這些區別。</p><h1><strong>可執行文件大小不一樣</strong></h1><p>從前面也可以觀察到，靜態鏈接的可執行文件要比動態鏈接的可執行文件要大得多，因為它將需要用到的代碼從二進制文件中“拷貝”了一份，而動態庫僅僅是複製了一些重定位和符號表信息。</p><h1><strong>佔用磁盤大小不一樣</strong></h1><p>如果有多個可執行文件，那麼靜態庫中的同一個函數的代碼就會被複制多份，而動態庫只有一份，因此使用靜態庫佔用的磁盤空間相對比動態庫要大。</p><h1><strong>擴展性與兼容性不一樣</strong></h1><p>如果靜態庫中某個函數的實現變了，那麼可執行文件必須重新編譯，而對於動態鏈接生成的可執行文件，只需要更新動態庫本身即可，不需要重新編譯可執行文件。正因如此，使用動態庫的程序方便升級和部署。</p><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/aec2200e-4fcc-40f5-975f-d35eb5341103><p class=pgc-img-caption></p></div><h1><strong>依賴不一樣</strong></h1><p>靜態鏈接的可執行文件不需要依賴其他的內容即可運行，而動態鏈接的可執行文件必須依賴動態庫的存在。所以如果你在安裝一些軟件的時候，提示某個動態庫不存在的時候也就不奇怪了。</p><p>即便如此，系統中一班存在一些大量公用的庫，所以使用動態庫並不會有什麼問題。</p><h1><strong>複雜性不一樣</strong></h1><p>相對來講，動態庫的處理要比靜態庫要複雜，例如，如何在運行時確定地址？多個進程如何共享一個動態庫？當然，作為調用者我們不需要關注。另外動態庫版本的管理也是一項技術活。這也不在本文的討論範圍。</p><h1><strong>加載速度不一樣</strong></h1><p>由於靜態庫在鏈接時就和可執行文件在一塊了，而動態庫在加載或者運行時才鏈接，因此，對於同樣的程序，靜態鏈接的要比動態鏈接加載更快。所以選擇靜態庫還是動態庫是空間和時間的考量。但是通常來說，犧牲這點性能來換取程序在空間上的節省和部署的靈活性時值得的。再加上<strong>局部性原理</strong>，犧牲的性能並不多。</p><p><strong>總結</strong></p><p>靜態庫和動態庫具體是何如鏈接的已經超出了本文的介紹範圍，本文僅簡單介紹了一些靜態庫和動態庫的區別，另外文中提到的在其他的linux系統，也指的是同樣處理器架構的系統。但是瞭解這些基本信息，就能夠幫助我們解決很多編譯問題了。</p><hr><div class=pgc-img><img alt=一文帶你瞭解靜態庫和動態庫 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7811dfc3401c484a97e32433138de5f6><p class=pgc-img-caption></p></div><p>以上就是小編為大家分享的所有內容，有想了解更多資訊或相關知識，可以關注公眾號；程序員大咖（CodePush）</p><p>技術文章原創，最新視頻分享等等，一大批乾貨正在路上，想看的朋友記得點關注哦</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>瞭解靜態</a></li><li><a>庫和動</a></li><li><a>態庫</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>