<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>æ‰‹å¯«AOPå¯¦ç¾éç¨‹ | æå®¢å¿«è¨Š</title><meta property="og:title" content="æ‰‹å¯«AOPå¯¦ç¾éç¨‹ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/6ac9667b9b064f57903047a4156004fd"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0be61162.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0be61162.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0be61162.html><meta property="article:published_time" content="2020-11-14T21:04:29+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:29+08:00"><meta name=Keywords content><meta name=description content="æ‰‹å¯«AOPå¯¦ç¾éç¨‹"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/0be61162.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>æ‰‹å¯«AOPå¯¦ç¾éç¨‹</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right><strong>ä¸€.æ‰‹å¯«Aopå‰åŸºç¤çŸ¥è­˜</strong></h1><p style=text-align:start><strong>1.aopæ˜¯ä»€éº¼ï¼Ÿ</strong></p><p style=text-align:start>é¢å‘åˆ‡é¢ç·¨ç¨‹(AOP)ï¼šæ˜¯ä¸€ç¨®ç·¨ç¨‹ç¯„å¼ï¼Œæä¾›å¾å¦ä¸€å€‹è§’åº¦ä¾†è€ƒæ…®ç¨‹åºçµæ§‹å¾è€Œå®Œå–„é¢å‘å°è±¡ç·¨ç¨‹(OOP)ã€‚</p><pre><code>åœ¨é€²è¡ŒOOPé–‹ç™¼æ™‚ï¼Œéƒ½æ˜¯åŸºæ–¼å°çµ„ä»¶ï¼ˆæ¯”å¦‚é¡ï¼‰é€²è¡Œé–‹ç™¼ï¼Œç„¶å¾Œå°çµ„ä»¶é€²è¡Œçµ„åˆï¼ŒOOPæœ€å¤§å•é¡Œå°±æ˜¯ç„¡æ³•è§£è€¦çµ„ä»¶é€²è¡Œé–‹ç™¼ï¼Œè€ŒAOPå°±æ˜¯ç‚ºäº†å…‹æœé€™å€‹å•é¡Œè€Œå‡ºç¾çš„ï¼Œå®ƒä¾†é€²è¡Œé€™ç¨®è€¦åˆçš„åˆ†é›¢ã€‚</code></pre><p style=text-align:start>AOPç‚ºé–‹ç™¼è€…æä¾›ä¸€ç¨®é€²è¡Œæ©«åˆ‡é—œæ³¨é»ï¼ˆæ¯”å¦‚æ—¥èªŒé—œæ³¨é»æ©«åˆ‡äº†æ”¯ä»˜é—œæ³¨é»ï¼‰åˆ†é›¢ä¸¦ç¹”å…¥çš„æ©Ÿåˆ¶ï¼ŒæŠŠæ©«åˆ‡é—œæ³¨é»åˆ†é›¢ï¼Œç„¶å¾Œé€šéæŸç¨®æŠ€è¡“ç¹”å…¥åˆ°ç³»çµ±ä¸­ï¼Œå¾è€Œç„¡è€¦åˆçš„å®Œæˆäº†æˆ‘å€‘çš„åŠŸèƒ½ã€‚</p><p style=text-align:start><strong>2.aopèƒ½å¹¹ä»€éº¼ï¼Ÿ</strong></p><p style=text-align:start>AOPä¸»è¦ç”¨æ–¼æ©«åˆ‡é—œæ³¨é»å’Œç¹”å…¥ï¼Œå› æ­¤éœ€è¦ç†è§£æ©«åˆ‡é—œæ³¨é»å’Œç¹”å…¥ï¼š</p><ul><li><strong>é—œæ³¨é»ï¼š</strong>å¯ä»¥èªç‚ºæ˜¯æ‰€é—œæ³¨çš„ä»»ä½•æ±è¥¿ï¼Œæ¯”å¦‚ä¸Šé‚Šçš„æ”¯ä»˜çµ„ä»¶ï¼›</li><li><strong>é—œæ³¨é»åˆ†é›¢ï¼š</strong>å°‡å•é¡Œç´°åŒ–å¾è€Œå–®ç¨éƒ¨åˆ†ï¼Œå³å¯ä»¥ç†è§£ç‚ºä¸å¯å†åˆ†å‰²çš„çµ„ä»¶ï¼Œå¦‚ä¸Šé‚Šçš„æ—¥èªŒçµ„ä»¶å’Œæ”¯ä»˜çµ„ä»¶ï¼›</li><li><strong>æ©«åˆ‡é—œæ³¨é»ï¼š</strong>ä¸€å€‹çµ„ä»¶ç„¡æ³•å®Œæˆéœ€è¦çš„åŠŸèƒ½ï¼Œéœ€è¦å…¶ä»–çµ„ä»¶å”ä½œå®Œæˆï¼Œå¦‚æ—¥èªŒçµ„ä»¶æ©«åˆ‡æ–¼æ”¯ä»˜çµ„ä»¶ï¼›</li><li><strong>ç¹”å…¥ï¼š</strong>æ©«åˆ‡é—œæ³¨é»åˆ†é›¢å¾Œï¼Œéœ€è¦é€šéæŸç¨®æŠ€è¡“å°‡æ©«åˆ‡é—œæ³¨é»èåˆåˆ°ç³»çµ±ä¸­å¾è€Œå®Œæˆéœ€è¦çš„åŠŸèƒ½ï¼Œå› æ­¤éœ€è¦ç¹”å…¥ï¼Œ<strong>ç¹”å…¥å¯èƒ½åœ¨ç·¨è­¯æœŸã€åŠ è¼‰æœŸã€é‹è¡ŒæœŸ</strong>ç­‰é€²è¡Œã€‚</li></ul><p style=text-align:start>æ©«åˆ‡é—œæ³¨é»å¯èƒ½åŒ…å«å¾ˆå¤šï¼Œæ¯”å¦‚éæ¥­å‹™çš„ï¼šæ—¥èªŒã€äº‹å‹™è™•ç†ã€ç·©å­˜ã€æ€§èƒ½çµ±è¨ˆã€æ¬Šé™æ§åˆ¶ç­‰ç­‰é€™äº›éæ¥­å‹™çš„åŸºç¤åŠŸèƒ½ï¼›é‚„å¯èƒ½æ˜¯æ¥­å‹™çš„ï¼šå¦‚æŸå€‹æ¥­å‹™çµ„ä»¶æ©«åˆ‡æ–¼å¤šå€‹æ¨¡å¡Šã€‚</p><div class=pgc-img><img alt=æ‰‹å¯«AOPå¯¦ç¾éç¨‹ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6ac9667b9b064f57903047a4156004fd><p class=pgc-img-caption></p></div><p style=text-align:start>é¢å‘åˆ‡é¢æ–¹å¼ï¼Œå…ˆå°‡æ©«åˆ‡é—œæ³¨é»åˆ†é›¢ï¼Œå†å°‡æ©«åˆ‡é—œæ³¨é»ç¹”å…¥åˆ°æ”¯ä»˜ç³»çµ±ä¸­ï¼š</p><div class=pgc-img><img alt=æ‰‹å¯«AOPå¯¦ç¾éç¨‹ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/557f8b6c787540898eed0d182bf51a02><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=æ‰‹å¯«AOPå¯¦ç¾éç¨‹ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0be8633c1b704eefba4009b5115ee1d9><p class=pgc-img-caption></p></div><p style=text-align:start><strong>3.aopçš„å„ªé»ï¼Ÿ</strong></p><ul><li>å®Œå–„OOPï¼›</li><li>é™ä½çµ„ä»¶å’Œæ¨¡å¡Šä¹‹é–“çš„è€¦åˆæ€§ï¼›</li><li>ä½¿ç³»çµ±å®¹æ˜“æ“´å±•ï¼›</li><li>è€Œä¸”ç”±æ–¼é—œæ³¨é»åˆ†é›¢å¾è€Œå¯ä»¥ç²å¾—çµ„ä»¶çš„æ›´å¥½è¤‡ç”¨ã€‚</li></ul><h1 class=pgc-h-arrow-right><strong>äºŒ.aopåº•å±¤å¯¦ç¾åŸç†ï¼šä»£ç†æ¨¡å¼</strong></h1><p style=text-align:start>é—œæ–¼éœæ…‹ä»£ç†æ¨¡å¼ï¼Œè©³æƒ…è«‹åƒé–±æˆ‘å¦ä¸€ç‰‡åšå®¢ï¼š</p><p style=text-align:start>https://www.cnblogs.com/tc971121/p/13474638.html</p><h1 class=pgc-h-arrow-right><strong>ä¸‰.æ‰‹å¯«aopä¸»è¦å¯¦ç¾éç¨‹</strong></h1><p style=text-align:start><strong>1.å®šç¾©é…ç½®æ¨™è¨˜</strong></p><p style=text-align:start>@Aspectï¼šé…ç½®æ¨™è¨˜æ©«åˆ‡å°è±¡ï¼ˆæ–¹æ³•ï¼‰çš„åœ°å€</p><p style=text-align:start>@Orderï¼šé…ç½®æ¨™è¨˜æ©«åˆ‡çš„é †åº</p><p style=text-align:start>@Aspect/@Order</p><pre><code>@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)public @interface Aspect {    String pointcut();}</code></pre><pre><code>@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)public @interface Order {    /**     * æ§åˆ¶é¡çš„åŸ·è¡Œé †åºï¼Œå€¼è¶Šå°å„ªå…ˆç´šè¶Šé«˜     */    int value();}</code></pre><p style=text-align:start><strong>2.å®šç¾©é»˜èªåˆ‡é¢é¡</strong></p><pre><code>package org.simplespring.aop.aspect;import java.lang.reflect.Method;/** * å®šç¾©é»˜èªåˆ‡é¢é¡ */public abstract class DefaultAspect {    /**     * äº‹å‰æ””æˆª     * @param targetClass è¢«ä»£ç†çš„ç›®æ¨™é¡     * @param method è¢«ä»£ç†çš„ç›®æ¨™æ–¹æ³•     * @param args è¢«ä»£ç†çš„ç›®æ¨™æ–¹æ³•å°æ‡‰çš„åƒæ•¸åˆ—è¡¨     * @throws Throwable     */    public void before(Class&lt;?&gt; targetClass, Method method, Object[] args) throws Throwable{    }    /**     * äº‹å¾Œæ””æˆª     * @param targetClass è¢«ä»£ç†çš„ç›®æ¨™é¡     * @param method è¢«ä»£ç†çš„ç›®æ¨™æ–¹æ³•     * @param args è¢«ä»£ç†çš„ç›®æ¨™æ–¹æ³•å°æ‡‰çš„åƒæ•¸åˆ—è¡¨     * @param returnValue è¢«ä»£ç†çš„ç›®æ¨™æ–¹æ³•åŸ·è¡Œå¾Œçš„è¿”å›å€¼     * @throws Throwable     */    public Object afterReturning(Class&lt;?&gt; targetClass, Method method, Object[] args, Object returnValue) throws Throwable{        return returnValue;    }    /**     *     * @param targetClass è¢«ä»£ç†çš„ç›®æ¨™é¡     * @param method è¢«ä»£ç†çš„ç›®æ¨™æ–¹æ³•     * @param args è¢«ä»£ç†çš„ç›®æ¨™æ–¹æ³•å°æ‡‰çš„åƒæ•¸åˆ—è¡¨     * @param e è¢«ä»£ç†çš„ç›®æ¨™æ–¹æ³•æ‹‹å‡ºçš„ç•°å¸¸     * @throws Throwable     */    public void afterThrowing(Class&lt;?&gt; targetClass, Method method, Object[] args,  Throwable e) throws Throwable{    }}</code></pre><p style=text-align:start><strong>3.å®šç¾©åˆ‡é¢ç¹”å…¥å™¨</strong></p><p style=text-align:start><strong>æ ¸å¿ƒæµç¨‹ï¼š</strong></p><p style=text-align:start>1.ç²å–æ‰€æœ‰çš„åˆ‡é¢é¡</p><p style=text-align:start>2.éæ­·å®¹å™¨ç®¡ç†çš„é¡3.ç¯©é¸å‡ºåŒ¹é…å®¹å™¨ç®¡ç†é¡çš„åˆ‡é¢aspectlist4.å˜—è©¦é€²è¡ŒAspectçš„ç¹”å…¥ ç”Ÿæˆå‹•æ…‹ä»£ç†å°è±¡ ä¸¦æ›¿æ›beancontainerä¸­åŸå…ˆclasså°æ‡‰æ‰€å°æ‡‰çš„å¯¦ä¾‹å°è±¡</p><pre><code>package org.simplespring.aop;import org.simplespring.aop.annotation.Aspect;import org.simplespring.aop.annotation.Order;import org.simplespring.aop.aspect.AspectInfo;import org.simplespring.aop.aspect.DefaultAspect;import org.simplespring.core.BeanContainer;import org.simplespring.util.ValidationUtil;import java.util.ArrayList;import java.util.List;import java.util.Set;/** * @Classname AspectWeaver * @Description åˆ‡é¢ç¹”å…¥å™¨ * @Date 2020/8/8 19:43 * @Created by zhangtianci */public class AspectWeaver {    /**     * æ“æœ‰ä¸€å€‹beanå®¹å™¨     */    private BeanContainer beanContainer;    public AspectWeaver(){        beanContainer = BeanContainer.getInstance();    }    /**     * 1.ç²å–æ‰€æœ‰çš„åˆ‡é¢é¡     * 2.éæ­·å®¹å™¨è£¡çš„é¡     * 3.ç¯©é¸å‡ºåŒ¹é…é¡çš„åˆ‡é¢aspect     * 4.å˜—è©¦é€²è¡ŒAspectçš„ç¹”å…¥ ç”Ÿæˆå‹•æ…‹ä»£ç†å°è±¡     */    public void doAop() {        //1.ç²å–æ‰€æœ‰çš„åˆ‡é¢é¡        Set&lt;Class&lt;?&gt;&gt; aspectSet = beanContainer.getClassesByAnnotation(Aspect.class);        if(ValidationUtil.isEmpty(aspectSet)){return;}        //2.æ‹¼è£AspectInfoList        List&lt;AspectInfo&gt; aspectInfoList = packAspectInfoList(aspectSet);        //3.éæ­·å®¹å™¨è£¡çš„é¡        Set&lt;Class&lt;?&gt;&gt; classSet = beanContainer.getClasses();        for (Class&lt;?&gt; targetClass: classSet) {            //æ’é™¤AspectClassè‡ªèº«            if(targetClass.isAnnotationPresent(Aspect.class)){                continue;            }            //4.ç²—ç¯©ç¬¦åˆæ¢ä»¶çš„Aspect            List&lt;AspectInfo&gt; roughMatchedAspectList  = collectRoughMatchedAspectListForSpecificClass(aspectInfoList, targetClass);            //5.å˜—è©¦é€²è¡ŒAspectçš„ç¹”å…¥            wrapIfNecessary(roughMatchedAspectList,targetClass);        }    }    private void wrapIfNecessary(List&lt;AspectInfo&gt; roughMatchedAspectList, Class&lt;?&gt; targetClass) {        if(ValidationUtil.isEmpty(roughMatchedAspectList)){return;}        //å‰µå»ºå‹•æ…‹ä»£ç†å°è±¡        AspectListExecutor aspectListExecutor = new AspectListExecutor(targetClass, roughMatchedAspectList);        Object proxyBean = ProxyCreator.createProxy(targetClass, aspectListExecutor);        beanContainer.addBean(targetClass, proxyBean);    }    private List&lt;AspectInfo&gt; collectRoughMatchedAspectListForSpecificClass(List&lt;AspectInfo&gt; aspectInfoList, Class&lt;?&gt; targetClass) {        List&lt;AspectInfo&gt; roughMatchedAspectList = new ArrayList&lt;&gt;();        for(AspectInfo aspectInfo : aspectInfoList){            //ç²—ç¯©            if(aspectInfo.getPointcutLocator().roughMatches(targetClass)){                roughMatchedAspectList.add(aspectInfo);            }        }        return roughMatchedAspectList;    }    private List&lt;AspectInfo&gt; packAspectInfoList(Set&lt;Class&lt;?&gt;&gt; aspectSet) {        List&lt;AspectInfo&gt; aspectInfoList = new ArrayList&lt;&gt;();        for(Class&lt;?&gt; aspectClass : aspectSet){            if (verifyAspect(aspectClass)){                Order orderTag = aspectClass.getAnnotation(Order.class);                Aspect aspectTag = aspectClass.getAnnotation(Aspect.class);                DefaultAspect defaultAspect = (DefaultAspect) beanContainer.getBean(aspectClass);                //åˆå§‹åŒ–è¡¨é”å¼å®šä½å™¨                PointcutLocator pointcutLocator = new PointcutLocator(aspectTag.pointcut());                AspectInfo aspectInfo = new AspectInfo(orderTag.value(), defaultAspect, pointcutLocator);                aspectInfoList.add(aspectInfo);            } else {                //ä¸éµå®ˆè¦ç¯„å‰‡ç›´æ¥æ‹‹å‡ºç•°å¸¸                throw new RuntimeException("@Aspect and @Order must be added to the Aspect class, and Aspect class must extend from DefaultAspect");            }        }        return aspectInfoList;    }    //æ¡†æ¶ä¸­ä¸€å®šè¦éµå®ˆçµ¦Aspecté¡æ·»åŠ @Aspectå’Œ@Orderæ¨™ç±¤çš„è¦ç¯„ï¼ŒåŒæ™‚ï¼Œå¿…é ˆç¹¼æ‰¿è‡ªDefaultAspect.class    //æ­¤å¤–ï¼Œ@Aspectçš„å±¬æ€§å€¼ä¸èƒ½æ˜¯å®ƒæœ¬èº«    private boolean verifyAspect(Class&lt;?&gt; aspectClass) {        return aspectClass.isAnnotationPresent(Aspect.class) &amp;&amp;                aspectClass.isAnnotationPresent(Order.class) &amp;&amp;                DefaultAspect.class.isAssignableFrom(aspectClass);    }}</code></pre><p style=text-align:start>åˆ‡é¢ä¿¡æ¯åŒ…è£é¡ï¼ˆå¢å¼·çš„å‹•ä½œ/å¢å¼·å°è±¡åœ°å€/æ©«åˆ‡é †åºï¼‰</p><pre><code>package org.simplespring.aop.aspect;import lombok.AllArgsConstructor;import lombok.Getter;import org.simplespring.aop.PointcutLocator;@AllArgsConstructor@Getterpublic class AspectInfo {    private int orderIndex;    private DefaultAspect aspectObject;    private PointcutLocator pointcutLocator;}</code></pre><p style=text-align:start>æ¡ç”¨cglibå‹•æ…‹çš„å¯¦ç¾æ–¹å¼ï¼š</p><p style=text-align:start>å¯¦ç¾net.sf.cglib.proxy.MethodInterceptoræ¥å£ï¼Œå®šç¾©ä»£ç†å¾Œæ–¹æ³•çš„å‹•ä½œï¼ˆç›¸ç•¶æ–¼å¯¦ç¾jdkå‹•æ…‹ä»£ç†ä¸­çš„InvocationHandleræ¥å£ï¼‰</p><pre><code>package org.simplespring.aop;import lombok.Getter;import net.sf.cglib.proxy.MethodInterceptor;import net.sf.cglib.proxy.MethodProxy;import org.simplespring.aop.aspect.AspectInfo;import org.simplespring.util.ValidationUtil;import java.lang.reflect.Method;import java.util.Collections;import java.util.Comparator;import java.util.Iterator;import java.util.List;public class AspectListExecutor implements MethodInterceptor {    //è¢«ä»£ç†çš„é¡    private Class&lt;?&gt; targetClass;    //æ’å¥½åºçš„Aspectåˆ—è¡¨    @Getter    private List&lt;AspectInfo&gt;sortedAspectInfoList;    public AspectListExecutor(Class&lt;?&gt; targetClass, List&lt;AspectInfo&gt; aspectInfoList){        this.targetClass = targetClass;        this.sortedAspectInfoList = sortAspectInfoList(aspectInfoList);    }    /**     * æŒ‰ç…§orderçš„å€¼é€²è¡Œå‡åºæ’åºï¼Œç¢ºä¿orderå€¼å°çš„aspectå…ˆè¢«ç¹”å…¥     *     * @param aspectInfoList     * @return     */    private List&lt;AspectInfo&gt; sortAspectInfoList(List&lt;AspectInfo&gt; aspectInfoList) {        Collections.sort(aspectInfoList, new Comparator&lt;AspectInfo&gt;() {            @Override            public int compare(AspectInfo o1, AspectInfo o2) {                //æŒ‰ç…§å€¼çš„å¤§å°é€²è¡Œå‡åºæ’åº                return o1.getOrderIndex() - o2.getOrderIndex();            }        });        return aspectInfoList;    }    @Override    public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable {        Object returnValue = null;        collectAccurateMatchedAspectList(method);        if(ValidationUtil.isEmpty(sortedAspectInfoList)){            returnValue = methodProxy.invokeSuper(proxy, args);            return returnValue;        }        //1.æŒ‰ç…§orderçš„é †åºå‡åºåŸ·è¡Œå®Œæ‰€æœ‰Aspectçš„beforeæ–¹æ³•        invokeBeforeAdvices(method, args);        try{            //2.åŸ·è¡Œè¢«ä»£ç†é¡çš„æ–¹æ³•            returnValue = methodProxy.invokeSuper(proxy, args);            //3.å¦‚æœè¢«ä»£ç†æ–¹æ³•æ­£å¸¸è¿”å›ï¼Œå‰‡æŒ‰ç…§orderçš„é †åºé™åºåŸ·è¡Œå®Œæ‰€æœ‰Aspectçš„afterReturningæ–¹æ³•            returnValue = invokeAfterReturningAdvices(method, args, returnValue);        } catch (Exception e){            //4.å¦‚æœè¢«ä»£ç†æ–¹æ³•æ‹‹å‡ºç•°å¸¸ï¼Œå‰‡æŒ‰ç…§orderçš„é †åºé™åºåŸ·è¡Œå®Œæ‰€æœ‰Aspectçš„afterThrowingæ–¹æ³•            invokeAfterThrowingAdvides(method, args, e);        }        return returnValue;    }    private void collectAccurateMatchedAspectList(Method method) {        if(ValidationUtil.isEmpty(sortedAspectInfoList)){return;}        Iterator&lt;AspectInfo&gt; it = sortedAspectInfoList.iterator();        while (it.hasNext()){            AspectInfo aspectInfo = it.next();            if(!aspectInfo.getPointcutLocator().accurateMatches(method)){                it.remove();            }        }    }    //4.å¦‚æœè¢«ä»£ç†æ–¹æ³•æ‹‹å‡ºç•°å¸¸ï¼Œå‰‡æŒ‰ç…§orderçš„é †åºé™åºåŸ·è¡Œå®Œæ‰€æœ‰Aspectçš„afterThrowingæ–¹æ³•    private void invokeAfterThrowingAdvides(Method method, Object[] args, Exception e) throws Throwable {        for (int i =  sortedAspectInfoList.size() - 1; i &gt;=0 ; i--){            sortedAspectInfoList.get(i).getAspectObject().afterThrowing(targetClass, method, args, e);        }    }    //3.å¦‚æœè¢«ä»£ç†æ–¹æ³•æ­£å¸¸è¿”å›ï¼Œå‰‡æŒ‰ç…§orderçš„é †åºé™åºåŸ·è¡Œå®Œæ‰€æœ‰Aspectçš„afterReturningæ–¹æ³•    private Object invokeAfterReturningAdvices(Method method, Object[] args, Object returnValue) throws Throwable {        Object result = null;        for (int i =  sortedAspectInfoList.size() - 1; i &gt;=0 ; i--){            result = sortedAspectInfoList.get(i).getAspectObject().afterReturning(targetClass, method, args, returnValue);        }        return result;    }    //1.æŒ‰ç…§orderçš„é †åºå‡åºåŸ·è¡Œå®Œæ‰€æœ‰Aspectçš„beforeæ–¹æ³•    private void invokeBeforeAdvices(Method method, Object[] args) throws Throwable {        for(AspectInfo aspectInfo : sortedAspectInfoList){            aspectInfo.getAspectObject().before(targetClass, method, args);        }    }}</code></pre><p style=text-align:start>å‰µå»ºä»£ç†é¡ï¼š</p><pre><code>package org.simplespring.aop;import net.sf.cglib.proxy.Enhancer;import net.sf.cglib.proxy.MethodInterceptor;public class ProxyCreator {    /**     * å‰µå»ºå‹•æ…‹ä»£ç†å°è±¡ä¸¦è¿”å›     * @param targetClass è¢«ä»£ç†çš„Classå°è±¡     * @param methodInterceptor æ–¹æ³•æ””æˆªå™¨     * @return     */    public static Object createProxy(Class&lt;?&gt; targetClass, MethodInterceptor methodInterceptor){        return Enhancer.create(targetClass, methodInterceptor);    }}</code></pre><p style=text-align:start>è§£æAspectè¡¨é”å¼ä¸¦ä¸”å®šä½è¢«ç¹”å…¥çš„ç›®æ¨™å·¥å…·é¡ï¼š</p><pre><code>package org.simplespring.aop;import org.aspectj.weaver.tools.PointcutExpression;import org.aspectj.weaver.tools.PointcutParser;import org.aspectj.weaver.tools.ShadowMatch;import java.lang.reflect.Method;/** * è§£æAspectè¡¨é”å¼ä¸¦ä¸”å®šä½è¢«ç¹”å…¥çš„ç›®æ¨™ */public class PointcutLocator {    /**     * Pointcutè§£æå™¨ï¼Œç›´æ¥çµ¦å®ƒè³¦å€¼ä¸ŠAspectjçš„æ‰€æœ‰è¡¨é”å¼ï¼Œä»¥ä¾¿æ”¯æŒå°çœ¾å¤šè¡¨é”å¼çš„è§£æ     */    private PointcutParser pointcutParser= PointcutParser.getPointcutParserSupportingSpecifiedPrimitivesAndUsingContextClassloaderForResolution(            PointcutParser.getAllSupportedPointcutPrimitives()    );    /**     * è¡¨é”å¼è§£æå™¨     */    private PointcutExpression pointcutExpression;    public PointcutLocator(String expression){        this.pointcutExpression = pointcutParser.parsePointcutExpression(expression);    }    /**     * åˆ¤æ–·å‚³å…¥çš„Classå°è±¡æ˜¯å¦æ˜¯Aspectçš„ç›®æ¨™ä»£ç†é¡ï¼Œå³åŒ¹é…Pointcutè¡¨é”å¼(åˆç¯©)     *     * @param targetClass ç›®æ¨™é¡     * @return æ˜¯å¦åŒ¹é…     */    public boolean roughMatches(Class&lt;?&gt; targetClass){        //couldMatchJoinPointsInTypeæ¯”è¼ƒå‘ï¼Œåªèƒ½æ ¡é©—within        //ä¸èƒ½æ ¡é©— (execution(ç²¾ç¢ºåˆ°æŸå€‹é¡é™¤å¤–), call, get, set)ï¼Œé¢å°ç„¡æ³•æ ¡é©—çš„è¡¨é”å¼ï¼Œç›´æ¥è¿”å›true        return pointcutExpression.couldMatchJoinPointsInType(targetClass);    }    /**     * åˆ¤æ–·å‚³å…¥çš„Methodå°è±¡æ˜¯å¦æ˜¯Aspectçš„ç›®æ¨™ä»£ç†æ–¹æ³•ï¼Œå³åŒ¹é…Pointcutè¡¨é”å¼(ç²¾ç¯©)     * @param method     * @return     */    public boolean accurateMatches(Method method){        ShadowMatch shadowMatch = pointcutExpression.matchesMethodExecution(method);        if(shadowMatch.alwaysMatches()){            return true;        } else{            return false;        }    }}</code></pre><p style=text-align:start>ç¸½çµå¯¦ç¾aopçš„ä¸»è¦æµç¨‹ï¼š</p><p style=text-align:start><strong>1.å®šç¾©é…ç½®æ¨™è¨˜</strong></p><p style=text-align:start><strong>2.å®šç¾©é»˜èªåˆ‡é¢é¡</strong></p><p style=text-align:start><strong>3.å®šç¾©åˆ‡é¢ç¹”å…¥å™¨</strong></p><p style=text-align:start><strong>æ ¸å¿ƒæµç¨‹ï¼š</strong></p><p style=text-align:start>1.ç²å–æ‰€æœ‰çš„åˆ‡é¢é¡</p><p style=text-align:start>2.éæ­·å®¹å™¨ç®¡ç†çš„é¡3.ç¯©é¸å‡ºåŒ¹é…å®¹å™¨ç®¡ç†é¡çš„åˆ‡é¢aspectlist4.å˜—è©¦é€²è¡ŒAspectçš„ç¹”å…¥ ç”Ÿæˆå‹•æ…‹ä»£ç†å°è±¡ ä¸¦æ›¿æ›beancontainerä¸­åŸå…ˆclasså°æ‡‰æ‰€å°æ‡‰çš„å¯¦ä¾‹å°è±¡</p><p style=text-align:start><strong>4.å…¶ä»–é¡ï¼šåˆ‡é¢ä¿¡æ¯åŒ…è£é¡/InvocationHandlerå¯¦ç¾é¡/å‰µå»ºä»£ç†å¯¦ä¾‹é¡/è§£æAspectè¡¨é”å¼å·¥å…·é¡ç­‰ã€‚</strong></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>æ‰‹å¯«</a></li><li><a>AOP</a></li><li><a>å¯¦ç¾</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/f09ac34c.html alt=å½©è‰²é›»å­æ›¸åœ¨å»£å·ç‡å…ˆå¯¦ç¾é‡ç”¢ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RkPMb9G6tipobr style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f09ac34c.html title=å½©è‰²é›»å­æ›¸åœ¨å»£å·ç‡å…ˆå¯¦ç¾é‡ç”¢>å½©è‰²é›»å­æ›¸åœ¨å»£å·ç‡å…ˆå¯¦ç¾é‡ç”¢</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2d12804e.html alt=[ç©è½‰MySQLä¹‹ä¹]MySQLå¯¦ç¾ACIDä¹‹åŸå­æ€§ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/bdb044d821f74107a3fd9119fc34c642 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2d12804e.html title=[ç©è½‰MySQLä¹‹ä¹]MySQLå¯¦ç¾ACIDä¹‹åŸå­æ€§>[ç©è½‰MySQLä¹‹ä¹]MySQLå¯¦ç¾ACIDä¹‹åŸå­æ€§</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html alt="ã€Œè­¯ã€ Spring çš„åˆ†ä½ˆå¼äº‹å‹™å¯¦ç¾â€”ä½¿ç”¨å’Œä¸ä½¿ç”¨ XAâ€”ç¬¬äºŒéƒ¨åˆ†" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html title="ã€Œè­¯ã€ Spring çš„åˆ†ä½ˆå¼äº‹å‹™å¯¦ç¾â€”ä½¿ç”¨å’Œä¸ä½¿ç”¨ XAâ€”ç¬¬äºŒéƒ¨åˆ†">ã€Œè­¯ã€ Spring çš„åˆ†ä½ˆå¼äº‹å‹™å¯¦ç¾â€”ä½¿ç”¨å’Œä¸ä½¿ç”¨ XAâ€”ç¬¬äºŒéƒ¨åˆ†</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e41fd8de.html alt="æ’«é †å„é …é˜²æ±›å·¥ä½œå¯¦ç¾â€œå…­åˆ°ä½â€ ç¢ºä¿å…¨å¸‚å®‰å…¨åº¦æ±›" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e41fd8de.html title="æ’«é †å„é …é˜²æ±›å·¥ä½œå¯¦ç¾â€œå…­åˆ°ä½â€ ç¢ºä¿å…¨å¸‚å®‰å…¨åº¦æ±›">æ’«é †å„é …é˜²æ±›å·¥ä½œå¯¦ç¾â€œå…­åˆ°ä½â€ ç¢ºä¿å…¨å¸‚å®‰å…¨åº¦æ±›</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f22ee5ad.html alt="Redis è¨­è¨ˆèˆ‡å¯¦ç¾ : Lua è…³æœ¬" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f22ee5ad.html title="Redis è¨­è¨ˆèˆ‡å¯¦ç¾ : Lua è…³æœ¬">Redis è¨­è¨ˆèˆ‡å¯¦ç¾ : Lua è…³æœ¬</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/56e2a065.html alt=é€™ä½å¤§å”åœ¨éš¨æ©Ÿçš„å½©ç¥¨ä¸Šå¯¦ç¾äº†90%çš„ä¸­çç‡ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/50ab0003166decded7e4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/56e2a065.html title=é€™ä½å¤§å”åœ¨éš¨æ©Ÿçš„å½©ç¥¨ä¸Šå¯¦ç¾äº†90%çš„ä¸­çç‡>é€™ä½å¤§å”åœ¨éš¨æ©Ÿçš„å½©ç¥¨ä¸Šå¯¦ç¾äº†90%çš„ä¸­çç‡</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cf633068.html alt="Java å¤šæ…‹çš„å¯¦ç¾æ©Ÿåˆ¶ï¼Œçœ‹äº†éƒ½èªªå¥½" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9d3b0e55813d46b4982ae7d9b81d1802 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cf633068.html title="Java å¤šæ…‹çš„å¯¦ç¾æ©Ÿåˆ¶ï¼Œçœ‹äº†éƒ½èªªå¥½">Java å¤šæ…‹çš„å¯¦ç¾æ©Ÿåˆ¶ï¼Œçœ‹äº†éƒ½èªªå¥½</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d0662f03.html alt="å»£è¥¿éµè·¯å‡ºæµ·å¤§é€šé“ å…¨é¢å¯¦ç¾é›»æ°£åŒ–é‹ç‡Ÿ" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d0662f03.html title="å»£è¥¿éµè·¯å‡ºæµ·å¤§é€šé“ å…¨é¢å¯¦ç¾é›»æ°£åŒ–é‹ç‡Ÿ">å»£è¥¿éµè·¯å‡ºæµ·å¤§é€šé“ å…¨é¢å¯¦ç¾é›»æ°£åŒ–é‹ç‡Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c78a6fe2.html alt=HashMapçš„åº•å±¤å¯¦ç¾ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/0f9ffe95e10e4ff5804a8fd9cf591cfc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c78a6fe2.html title=HashMapçš„åº•å±¤å¯¦ç¾>HashMapçš„åº•å±¤å¯¦ç¾</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7c3d9f70.html alt=æ–°ç©çš„æ··åˆææ–™æˆ–æœ‰åŠ©æ–¼å¯¦ç¾é«˜æ•ˆçš„ä¸‹ä¸€ä»£é¡¯ç¤ºå™¨ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/47050004da4f36dcec1b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7c3d9f70.html title=æ–°ç©çš„æ··åˆææ–™æˆ–æœ‰åŠ©æ–¼å¯¦ç¾é«˜æ•ˆçš„ä¸‹ä¸€ä»£é¡¯ç¤ºå™¨>æ–°ç©çš„æ··åˆææ–™æˆ–æœ‰åŠ©æ–¼å¯¦ç¾é«˜æ•ˆçš„ä¸‹ä¸€ä»£é¡¯ç¤ºå™¨</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8d93e49d.html alt=æ•™ç¨‹ï¼šæ¡ç”¨æ¢¯åº¦ä¸‹é™ç®—æ³•å¯¦ç¾ç·šæ€§è¿´æ­¸ï¼ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1537162000876f4501fb1c4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8d93e49d.html title=æ•™ç¨‹ï¼šæ¡ç”¨æ¢¯åº¦ä¸‹é™ç®—æ³•å¯¦ç¾ç·šæ€§è¿´æ­¸ï¼>æ•™ç¨‹ï¼šæ¡ç”¨æ¢¯åº¦ä¸‹é™ç®—æ³•å¯¦ç¾ç·šæ€§è¿´æ­¸ï¼</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e8e17d90.html alt=é‡è¦çªç ´ï¼ä¸­åœ‹ç§‘å­¸å®¶å¯¦ç¾åŸºåº•ç´°èƒç™Œ4.1ç§’äººå·¥æ™ºèƒ½ç²¾æº–è­˜åˆ¥ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RtbWBYL9koJMmN style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e8e17d90.html title=é‡è¦çªç ´ï¼ä¸­åœ‹ç§‘å­¸å®¶å¯¦ç¾åŸºåº•ç´°èƒç™Œ4.1ç§’äººå·¥æ™ºèƒ½ç²¾æº–è­˜åˆ¥>é‡è¦çªç ´ï¼ä¸­åœ‹ç§‘å­¸å®¶å¯¦ç¾åŸºåº•ç´°èƒç™Œ4.1ç§’äººå·¥æ™ºèƒ½ç²¾æº–è­˜åˆ¥</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1b218e68.html alt=åœ–åƒæ‹¼æ¥ç®—æ³•åŠå¯¦ç¾ï¼ˆä¸€ï¼‰ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1534489824878547eee8fc2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1b218e68.html title=åœ–åƒæ‹¼æ¥ç®—æ³•åŠå¯¦ç¾ï¼ˆä¸€ï¼‰>åœ–åƒæ‹¼æ¥ç®—æ³•åŠå¯¦ç¾ï¼ˆä¸€ï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c9eb3d63.html alt=PHPå¯¦ç¾å„ç¨®ç¶“å…¸ç®—æ³•è©³è§£ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15357595091626cf296dc3e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c9eb3d63.html title=PHPå¯¦ç¾å„ç¨®ç¶“å…¸ç®—æ³•è©³è§£>PHPå¯¦ç¾å„ç¨®ç¶“å…¸ç®—æ³•è©³è§£</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/740f5b7b.html alt=PHPæ€éº¼å¯¦ç¾åˆ†é åŠŸèƒ½ï¼Ÿï¼ˆåœ–æ–‡+è¦–é »æ•™ç¨‹ï¼‰ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e81c52a014dd4c34adcbfb26482bd690 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/740f5b7b.html title=PHPæ€éº¼å¯¦ç¾åˆ†é åŠŸèƒ½ï¼Ÿï¼ˆåœ–æ–‡+è¦–é »æ•™ç¨‹ï¼‰>PHPæ€éº¼å¯¦ç¾åˆ†é åŠŸèƒ½ï¼Ÿï¼ˆåœ–æ–‡+è¦–é »æ•™ç¨‹ï¼‰</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>