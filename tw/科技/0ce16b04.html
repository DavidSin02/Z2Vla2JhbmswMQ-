<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>從 0 到 1：構建強大且易用的規則引擎 | 极客快訊</title><meta property="og:title" content="從 0 到 1：構建強大且易用的規則引擎 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/cecdf8ce69a24e28b45b2780157798c4"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0ce16b04.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0ce16b04.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0ce16b04.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0ce16b04.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0ce16b04.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0ce16b04.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0ce16b04.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0ce16b04.html><meta property="article:published_time" content="2020-11-14T20:59:53+08:00"><meta property="article:modified_time" content="2020-11-14T20:59:53+08:00"><meta name=Keywords content><meta name=description content="從 0 到 1：構建強大且易用的規則引擎"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/0ce16b04.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>從 0 到 1：構建強大且易用的規則引擎</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>2016年07月恰逢美團點評的業務進入“下半場”，需要我們在各個環節優化體驗、提升效率、降低成本。技術團隊需要怎麼做來適應這個變化？這個問題直接影響著之後的工作思路。</p><p><br></p><p>美團外賣的CRM業務步入成熟期，規則類需求幾乎撐起了這個業務所有需求的半邊天。一方面規則唯一不變的是“多變”，另一方面開發團隊對“規則開發”的感受是乏味、疲憊和缺乏技術含量。如何解決規則開發的效率問題，最大化解放開發團隊成為目前的一個KPI。</p><p><br></p><p>規則引擎作為常見的維護策略規則的框架很快進入我的思路。它能將業務決策邏輯從系統邏輯中抽離出來，使兩種邏輯可以獨立於彼此而變化，這樣可以明顯降低兩種邏輯的維護成本。</p><p><br></p><p>分析規則引擎如何設計正是本文的主題，過程中也簡單介紹了實現方案。</p><p><br></p><p>案例</p><p><br></p><p>首先回顧幾個美團點評的業務場景。通過這些場景大家能更好地理解什麼是規則，規則的邊界是什麼。在每個場景後面都介紹了業務系統現在使用的解決方案以及主要的優缺點。</p><h2 class=pgc-h-arrow-right><br></h2><h3 class=pgc-h-arrow-right><strong>門店信息校驗</strong></h3><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>場景</strong></h3><p><br></p><p>美團點評合併前的美團平臺事業部中，門店信息入口作為門店信息的第一道關卡，有一個很重要的職責，就是質量控制，其中第一步就是針對一些字段的校驗規則。</p><p><br></p><p>下面從流程的角度看下門店信息入口業務裡校驗門店信息的規則模型（已簡化），如下圖。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cecdf8ce69a24e28b45b2780157798c4><p class=pgc-img-caption></p></div><p><br></p><p>規則主體包括3部分：</p><ul><li>分支條件。分支內邏輯條件為“==”和“&lt;”。</li><li>簡單計算規則。如：字符串長度。</li><li>業務定製計算規則。如：逆地址解析、經緯度反算等。</li></ul><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>方案——硬編碼</strong></h3><p><br></p><p>由於歷史原因，門店信息校驗採用了硬編碼的方式，偽代碼如下：</p><pre><code>if (StringUtil.isBlank(fieldA)    || StringUtil.isBlank(fieldB)    || StringUtil.isBlank(fieldC)    || StringUtil.isBlank(fieldD)) {    return ResultDOFactory.createResultDO(Code.PARAM_ERROR, "門店參數缺少必填項");}if (fieldA.length() &lt; 10) {    return ResultDOFactory.createResultDO(Code.PARAM_ERROR, "門店名稱長度不能少於10個字符");}if (!isConsistent(fieldB, fieldC, fieldD)) {    return ResultDOFactory.createResultDO(Code.PARAM_ERROR, "門店xxx地址、行政區和經緯度不一致");}</code></pre><p><br></p><p>優點</p><ul><li>當規則較少、變動不頻繁時，開發效率最高。</li><li>穩定性較佳：語法級別錯誤不會出現，由編譯系統保證。</li></ul><p><br></p><p>缺點</p><ul><li>規則迭代成本高：對規則的少量改動就需要走全流程（開發、測試、部署）。</li><li>當存量規則較多時，可維護性差。</li><li>規則開發和維護門檻高：規則對業務分析人員不可見。業務分析人員有規則變更需求後無法自助完成開發，需要由開發人員介入開發。</li></ul><h2 class=pgc-h-arrow-right><br></h2><h3 class=pgc-h-arrow-right><strong>門店審核流程</strong></h3><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>場景</strong></h3><p><br></p><p>流程控制中心（負責在運行時根據輸入參數選擇不同的流程節點從而構建一個流程實例）會根據輸入門店信息中的渠道來源和品牌等特徵確定本次審核（不）走哪些節點，其中選擇策略的模型如下圖。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a2ed1aa799874d12a25871208502b2e0><p class=pgc-img-caption></p></div><p><br></p><p>規則主體是分支條件：</p><ul><li>分支條件主體是“==”，參與計算的參數是固定值和用戶輸入實體的屬性（比如：渠道來源和品牌類型）。</li></ul><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>方案——開源Drools從入門到放棄</strong></h3><p><br></p><p>經過一系列調研團隊選擇基於開源規則引擎Drools來配置流程中審核節點的選擇策略。使用Drools後的規則配置流程如下圖。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0ed0d13956b247fbabe255880f8d2df1><p class=pgc-img-caption></p></div><p><br></p><p>上圖中DSL即是規則主體，規則內容如下：</p><pre><code>rule "1.1"    when        poi : POI( source == 1 &amp;&amp; brandType == 1 )    then            System.out.println( "1.1 matched" );            poi.setPassedNodes(1);endrule "1.2"    when        poi : POI( source == 1 &amp;&amp; brandType == 2 )    then            System.out.println( "1.2 matched" );endrule "2.1"    when        poi : POI( source == 2 &amp;&amp; brandType == 1 )    then            System.out.println( "2.1 matched" );            poi.setPassedNodes(2);endrule "2.2"    when        poi : POI( source == 2 &amp;&amp; brandType == 2 )    then            System.out.println( "2.2 matched" );            poi.setPassedNodes(3);end</code></pre><p><br></p><p>在實踐中，我們發現Drools方案有以下幾個優缺點：</p><p><br></p><p>優點</p><ul><li>策略規則和執行邏輯解耦方便維護。</li></ul><p><br></p><p>缺點</p><ul><li>業務分析師無法獨立完成規則配置：由於規則主體DSL是編程語言（支持Java, Groovy, Python），因此仍然需要開發工程師維護。</li><li>規則規模變大以後也會變得不好維護，相對硬編碼的優勢便不復存在。</li><li>規則的語法僅適合扁平的規則，對於嵌套條件語義（then裡嵌套when...then子句）的規則只能將條件進行笛卡爾積組合以後進行配置，不利於維護。</li></ul><p><br></p><p>由於Drools的問題較多，最後這個方案還是放棄了。</p><h2 class=pgc-h-arrow-right><br></h2><h3 class=pgc-h-arrow-right><strong>績效指標計算</strong></h3><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>場景</strong></h3><p><br></p><p>美團外賣業務發展非常迅速，績效指標規則需要快速迭代才能緊跟業務發展步伐。績效考核頻率是一個月一次，因此績效規則的迭代頻率也是每月一次。因為績效規則系統是硬編碼實現，因此開發團隊需要投入大量的人力滿足規則更新需求。</p><p><br></p><p>2016年10月底我受績效團隊委託成立一個項目組，開發部署了一套績效指標配置系統，系統上線直接減少了產品經理和技術團隊70%的工作量。</p><p>下面我們首先分析下績效指標計算的規則模型，如下圖。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8b9dc2ffd5694ed58e353f53c3e678ed><p class=pgc-img-caption></p></div><p><br></p><p>規則主體是結構化數據處理邏輯：</p><ul><li>規則邏輯是從若干數據源獲取數據，然後進行一系列聚合處理（可以採用結構化查詢SQL語句+少量代碼實現），最後輸出到目標數據源。</li></ul><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>方案——業務定製規則引擎</strong></h3><p><br></p><p>績效規則主體是數據處理，但我們認為數據處理同樣屬於規則的範疇，因此我們將其放在本文進行分析。</p><p><br></p><p>下圖是績效指標配置系統。觸發器負責定時驅動引擎進行計算；視圖負責給商業分析師提供規則配置界面，規則表達能力取決於視圖；引擎負責將配置的規則解析成Spark原語進行計算。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d9a31ca2af1048c09a372181736f17a0><p class=pgc-img-caption></p></div><p><br></p><p>優點</p><ul><li>規則配置門檻低：視圖和引擎內部數據模型完全貼合績效業務模型，因此業務分析師很容易上手。</li><li>系統支持規則熱部署。</li></ul><p><br></p><p>缺點</p><ul><li>適用範圍有限：因為視圖和引擎的設計完全基於績效業務模型，因此很難低成本修改後推廣到別的業務。</li></ul><p><br></p><p>探索全新設計</p><p><br></p><p>“案例”一節中三種落地方案的問題總結如下：</p><ul><li>硬編碼迭代成本高。</li><li>Drools維護門檻高。視圖對非技術人員不友好，即使對於技術人員來說維護成本也不比硬編碼低。</li><li>績效定製引擎表達能力有限且擴展性差，無法推廣到別的業務。</li></ul><p><br></p><p>由於“高效配置規則”是業務里長期存在的剛需，且行業內又缺乏符合需求的解決方案，2017年02月我在團隊內部設立了一個虛擬小組專門負責規則引擎的設計研發。引擎設計指標是要覆蓋工作中基礎的規則迭代需求（包括但不限於“案例”一節中的多個場景），同時針對“案例”一節中已有解決方案揚長避短。下面分3節來重現這個項目的設計過程。首先“需求模型”一節會基於“案例”一節的場景嘗試抽象出規則模型，同時提煉出系統設計大綱。然後“Maze框架”一節會基於需求模型設計一個規則引擎。最後“Maze框架能力模型”一節會介紹Maze框架的特點。</p><h2 class=pgc-h-arrow-right><br></h2><h2 class=pgc-h-arrow-right><strong>需求模型</strong></h2><p><br></p><p>對規則引擎來說，世界皆規則。通過“案例”一節的分析，我們對規則以及規則引擎該如何構建的思路正逐漸變得清晰，下面兩節分別定義規則數據模型和規則引擎的系統模型，目標是對“Maze框架”一節中的規則引擎產品進行框架性指導。</p><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>規則數據模型</strong></h3><p><br></p><p>規則本質是一個函數，由n個輸入、1個輸出和函數計算邏輯3部分組成。</p><blockquote><p>y = f（x1, x2, …, xn）</p></blockquote><p><br></p><p>具體結合“案例”一節中的場景我們梳理出的規則模型如下圖所示。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/25b8c1e47bc5480484c91ce401772014><p class=pgc-img-caption></p></div><p><br></p><p>主要由三部分構成：</p><ul><li>FACT對象：用戶輸入的事實對象，作為決策因子使用。</li><li>規則：LHS（Left Hand Side）部分即條件分支邏輯。RHS（Right Hand Side）部分即執行邏輯。LHS和RHS部分是由一個或多個模式構成的。模式是規則內最小單位。模式的輸入參數可以是另一個模式或FACT對象（比如邏輯與運算[參數1] && [參數2]中參數1可以是另一個表達式）。模式需要支持以下3種類別：</li><ul><li>客戶定義方法：FACT對象的實例方法、靜態方法。</li><li>常規表達式：邏輯運算、算數運算、關係運算、對象屬性處理等。</li><li>結構化查詢。</li></ul><li>結果對象：規則處理完畢後的結果。需要支持自定義類型或者簡單類型（Integer、Long、Float、Double、Short、String、Boolean等）。</li></ul><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>系統模型</strong></h3><p><br></p><p>我們需要設計一個系統能配置、加載、解釋執行上節中的數據模型，另外設計時還需要規避“案例”一節3個方案的缺點。最終我們定義瞭如下圖所示的系統模型。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c116114896fe4f68be7e9739186fc0f5><p class=pgc-img-caption></p></div><p><br></p><p>主要由3個模塊構成。</p><ul><li>知識庫：負責提供配置視圖和模式因子。知識庫之所以叫“知識”庫一個很重要的特徵是知識庫可以低成本擴展知識。知識擴展包括視圖和模式的添加，視圖和模式有一對一映射關係，比如我們在界面上展示一個如：一樣的視圖，則一定有一個模式$參數1 > $參數2與之對應。</li><ul><li>一方面降低操作門檻。</li><li>一方面約束用戶輸入，保證輸入合法性。</li><li>視圖：用於業務分析師等非技術背景的人員配置規則。作用兩方面：</li><li>模式：構成規則的最小單位，不可拆分，可以直接被規則引擎執行。</li></ul><li>資源管理器：負責管理規則。</li><ul><li>版本管理：支持規則迭代更新、回滾和灰度等功能。</li><li>依賴管理：負責將規則解析為模式樹。為了最大限度地增強規則的表達能力，每一個模式設計都很“原子”，這樣如果想配置一個完整語義的規則，則必須由多個子規則共同構成，因此規則之間會有樹形依賴關係。如$參數1 + $參數2 > $參數3這樣的規則便是由多個模式“複合”而成，則他的依賴關係如下所示。</li></ul></ul><pre><code>             最終結果           /** 變量模式 */                |                |              中間結果 &gt; $參數3  /** 關係運算模式 */                |                |         $參數1 + $參數2        /** 算數運算模式 */</code></pre><ul><li>規則引擎：負責執行規則。</li><ul><li>調度器：根據規則的依賴關係以及硬件資源驅動模式執行器執行模式，目標是達到最大吞吐或最低延遲。</li><li>模式執行器：負責直接執行模式。執行器可以根據業務的表達能力需求選擇基於Drools、Aviator等第三方引擎，甚至可以基於ANTLR定製。</li></ul></ul><h2 class=pgc-h-arrow-right><br></h2><h3 class=pgc-h-arrow-right><strong>Maze框架</strong></h3><p><br></p><p>基於"需求模型"一節的定義，我們開發了Maze框架（Maze是迷宮的意思，寓意：迷宮一樣複雜的規則）。</p><p><br></p><p>Maze框架分兩個引擎：MazeGO（策略引擎）和MazeQL（結構化數據處理引擎）。其中MazeGO內解析到結構化數據處理模式會調用SQLC驅動MazeQL完成計算（比如：從數據庫裡查詢某個BD的月交易額，如果交易額超過30萬則執行A邏輯否則執行B邏輯，這個語義的規則即需要執行結構化查詢），MazeQL內解析到策略計算模式會調用VectorC驅動MazeGO進行計算（比如：有一張訂單表，其中第一列是商品ID，第二列是商品購買數量，第三列是此商品的單價，我們需要計算每類商品的總價則需要對結構化查詢到的結果的每一行執行第二列 * 第三列這樣的策略模式計算）。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5cb5f2591d2f4ef3a82412fdd1fcb786><p class=pgc-img-caption></p></div><p><br></p><p>名詞解釋：</p><ul><li>VectorC指向量計算，針對矩陣的行列進行計算。有三種計算方式：</li><li>針對一行的多列進行策略計算。</li><li>針對一列進行計算。</li><li>針對分組聚合（GroupBy）後的每一組內的列進行運算。</li><li>SQLC指結構化查詢。擁有執行SQL的能力。</li></ul><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>MazeGO</strong></h3><p><br></p><p>MazeGO核心主要由3部分構成：資源管理器、知識庫和MazeGO引擎。另外兩個輔助模塊是流量控制器和規則效果分析模塊。基本構成如下圖。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/163586e3cd954190b1789df9a3e1b6e0><p class=pgc-img-caption></p></div><p><br></p><p>3個核心模塊（引擎、知識庫和資源管理器）的職責見“需求模型”一節中“系統模型”一節。下面只介紹下和“系統模型”不同的部分。</p><ol start=1><li>MazeGO引擎：</li><li>預加載規則實例。首先為了避免訪問規則時需要實時執行遠程調用而造成較大的時延，另外規則並不是時刻發生變更沒有必要每次訪問時拉取一次最新版本，基於以上兩個原因規則管理模塊會在引擎初始化階段將有效版本的規則實例緩存在本地並且監聽規則變更事件（監聽可以基於ZooKeeper實現）。</li><li>預編譯規則實例。因為規則每次編譯執行會導致性能問題，因此會在引擎初始化和規則有變更這兩個時機將增量版本的規則預編譯成可執行代碼。</li><li>規則管理模塊。職責如下：</li><li>流量控制器：負責不同版本規則的調度。方便業務方修改規則後，灰度部分流量到新規則。</li><li>規則效果分析：規則新增或修改後，業務方需要分析效果。本模塊會提供：規則內部執行路徑、運行時參數和結果的鏡像數據，數據可以存儲在hbase上。</li></ol><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>MazeQL</strong></h3><p><br></p><p>MazeQL核心主要由3部分構成：配置中心、MazeQL引擎和平臺。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4facb2a8ab4f41a6a213d96535eb796b><p class=pgc-img-caption></p></div><p><br></p><ol start=1><li>MazeQL引擎：</li><li>調度器。SQLC和VectorC類規則大多由多個規則組合而成（對於SQLC而言可以將依賴的規則簡單的理解為子查詢），因此也需要和“系統模型”一節一樣的調度管理，實現層面完全一致。</li><li>QL驅動器。驅動平臺進行規則計算。因為任務的實際執行平臺有多種（會在下一個“平臺”部分介紹），因此QL驅動器也有多種實現。</li><li>預加載規則實例。首先為了避免訪問規則時需要實時執行遠程調用而造成較大的時延，另外規則並不是時刻發生變更沒有必要每次訪問時拉取一次最新版本，基於以上兩個原因規則管理模塊會在引擎初始化階段將有效版本的規則實例緩存在本地並且監聽規則變更事件（監聽可以基於ZooKeeper實現）。</li><li>預解析規則實例。因為規則每次解析執行會導致性能（大對象）問題，因此會在引擎初始化階段解析為運行時可用的調度棧幀。</li><li>規則管理模塊。職責如下：</li><li>運行時模塊。分為調度器和QL驅動器。</li><li>平臺：負責實際執行規則邏輯。分兩種運行模式：一種是以嵌入式方式運行在客戶端進程內部，好處是實時性更好，時延更低，適合小批量數據處理；另一種是以遠程方式運行在Spark平臺，適合離線大規模數據處理。</li><li>嵌入式模式下是基於Mysql和Derby等實時性較好的數據庫實現的。</li><li>在Spark平臺上是基於Spark SQL實現的。</li><li>QL執行器。負責執行結構化查詢邏輯。兩種不同的運行模式下QL執行器在執行SQL模式時會選擇兩種不同的QL執行器實現，兩種實現分別是：</li><li>配置中心：提供規則配置視圖。</li><li>版本管理。同“系統模型”一節。</li><li>數據源綁定。即是定義參與計算的SQL邏輯中使用到的數據源，便於系統進行管理。</li><li>結構查詢定義。即是定義SQL規則，這是主體規則內容。</li><li>向量計算定義。定義VectorC類計算（VectorC見“Maze框架”章節開頭的介紹）。</li></ol><h2 class=pgc-h-arrow-right><br></h2><h3 class=pgc-h-arrow-right><strong>Maze框架能力模型</strong></h3><p><br></p><p>Maze框架是一個適用於非技術背景人員，支持複雜規則的配置和計算引擎。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/220bd92478f5468a88501996a6a93118><p class=pgc-img-caption></p></div><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>規則迭代安全性</strong></h3><p><br></p><p>規則支持熱部署：系統通過版本控制，可以灰度一部分流量，增加上線信心。</p><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right>規則表達能力</h3><p><br></p><p>框架的表達能力覆蓋絕大部分代碼表達能力。下面用偽代碼的形式展示下Maze框架的規則部分具有的能力。</p><pre><code>// 輸入N個FACT對象function(Fact[] facts) {      // 從FACT對象裡提取模式        String xx= facts[0].xx;      // 從某個數據源獲取特徵數據，SQLC數據處理能力遠超sql語言本身能力，SQLC具有編程+SQL的混合能力    List&lt;Fact&gt; moreFacts = connection.executeQuery("select * from xxx where xx like '%" + xx + "%');      // 對特徵數據和FACT對象應用用戶自定義計算模式    UserDefinedClass userDefinedObj = userDefinedFuntion(facts, moreFacts);      // 使用系統內置表達式模式處理特徵                          int compareResult = userDefinedObj.getFieldXX().compare(XX);    // 聲明用戶自定義對象            UserDefinedResultClass userDefinedResultObj = new UserDefinedResultClass();      // 使用系統內置條件語句模式處理特徵                                  if (compareResult  == 0) {            userDefinedResultObj.setCompareResult(Boolean.FALSE);    } else if (compareResult &gt; 0) {        userDefinedResultObj.setCompareResult(Boolean.FALSE);    } else {        userDefinedResultObj.setCompareResult(Boolean.TRUE);    }    // 將結果返回給客戶    return userDefinedResultObj;        }</code></pre><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>規則執行效率</strong></h3><p><br></p><p>執行效率分三方面：</p><ol start=1><li>引擎的調度模塊會確保吞吐優先，並且調度併發度等系統配置可以根據資源情況調整。</li><li>引擎運行過程中沒有遠程通信開銷。</li><li>引擎執行代碼實現編譯或解析後執行，運行效率較高。</li></ol><h3 class=pgc-h-arrow-right><br></h3><h3 class=pgc-h-arrow-right><strong>規則接入成本</strong></h3><h4 class=pgc-h-arrow-right><br></h4><h4 class=pgc-h-arrow-right><strong>開發人員</strong><strong>接入</strong></h4><ol start=1><li>首先，開發人員在項目工程裡導入一個MazeGO jar包。</li><li>然後，開發人員在項目工程裡需要調用計算規則的地方引入MazeGO client（如下代碼片段）。 // 初始化MazeGO client，建議在本應用程序的初始化階段執行<br>MazeGOReactor reactor = new MazeGOReactor();<br>reactor.setMazeIds(Arrays.asList(&lt;mazeId>));<br>reactor.init();<br>// 調用MazeGO client執行規則<br>reactor.go(&lt;mazeId>, &lt;fact>);<br>// 銷燬MazeGO client，建議在本應用程序的銷燬階段執行<br>reactor.destroy();</li></ol><h4 class=pgc-h-arrow-right><br></h4><h4 class=pgc-h-arrow-right><strong>規則配置</strong></h4><p><br></p><p>規則配置基本實現由業務分析師、產品經理或運營人員自助完成。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d2d73902bba246be9441a637601509d6><p class=pgc-img-caption></p></div><p><br></p><p>業務分析師在MazeGO上配置規則的視圖如下圖所示。</p><p><br></p><div class=pgc-img><img alt="從 0 到 1：構建強大且易用的規則引擎" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b4e9db8658cd4ee58aac198b1276a5b8><p class=pgc-img-caption></p></div><p>總結</p><p><br></p><p>本文開頭介紹了幾個工作中的規則使用場景，順帶引出了多個不同的解決方案，最後介紹了Maze框架的設計，基本上展現了我們對這個框架思考和設計的整個過程。</p><p><br></p><blockquote><p>作者簡介</p><p>張寧，美團點評技術專家。2015年加入美團，先後在美團數據中心、外賣CRM等業務線工作，目前在外賣技術部，負責代理商和CRM效能相關業務，致力於通過技術手段提升商務拓展團隊的工作效率、降低客戶關係維護成本。</p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>構建強</a></li><li><a>大且</a></li><li><a>規則</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/5b8eb959.html alt=小心非常美觀的不規則凸型設計空間 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/f270e446-9481-449b-8681-76c0a1d78e5e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5b8eb959.html title=小心非常美觀的不規則凸型設計空間>小心非常美觀的不規則凸型設計空間</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6224d4fa.html alt=基金“買入賣出”的規則 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c3cda6f978b94e0db2f01247f5f6e3b1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6224d4fa.html title=基金“買入賣出”的規則>基金“買入賣出”的規則</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e8faf4b9.html alt=從貨幣基金開始(4)貨幣基金的交易規則（買入、賣出規則） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/abd02d25fd604c78b9c7dd8705cf0d5c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e8faf4b9.html title=從貨幣基金開始(4)貨幣基金的交易規則（買入、賣出規則）>從貨幣基金開始(4)貨幣基金的交易規則（買入、賣出規則）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bd584a6e.html alt=工程造價預算規則技巧，造價員必備基礎 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/f2d5ebc5ff4743708693e819368d63eb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bd584a6e.html title=工程造價預算規則技巧，造價員必備基礎>工程造價預算規則技巧，造價員必備基礎</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/96000ad2.html alt=職場規則：健康發展的三必與兩不 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/dfic-imagehandler/8f5de6c6-6cb6-4c45-bc40-429e6d8401be style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/96000ad2.html title=職場規則：健康發展的三必與兩不>職場規則：健康發展的三必與兩不</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4e591557.html alt=什麼是規則？什麼是庫？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/0e18bf22744f4ccea55c41d4aae6b97f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4e591557.html title=什麼是規則？什麼是庫？>什麼是規則？什麼是庫？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7ad0cc7a.html alt=新三板轉板規則來了！精選層企業可赴科創板、創業板上市，掛牌滿一年可申請轉板！來看五大焦點 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7ad0cc7a.html title=新三板轉板規則來了！精選層企業可赴科創板、創業板上市，掛牌滿一年可申請轉板！來看五大焦點>新三板轉板規則來了！精選層企業可赴科創板、創業板上市，掛牌滿一年可申請轉板！來看五大焦點</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d369a6a1.html alt=科學作圖的十條規則 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/f749c2eca05e4a3eb3ff5f1fc7e4a13d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d369a6a1.html title=科學作圖的十條規則>科學作圖的十條規則</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/02a95ae2.html alt=平行志願填報的規則和技巧 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/02a95ae2.html title=平行志願填報的規則和技巧>平行志願填報的規則和技巧</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e0d71bbb.html alt=PCB設計中的基本佈線規則 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/afa1f4ae4bf54ac787dc15d271c5220c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e0d71bbb.html title=PCB設計中的基本佈線規則>PCB設計中的基本佈線規則</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4e69acf8.html alt=海上交通規則，不知道的來了解下 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/d0d56e8a-82d4-49c9-915a-f544b08d3c8c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4e69acf8.html title=海上交通規則，不知道的來了解下>海上交通規則，不知道的來了解下</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/63d0f8f4.html alt="首域金融外匯交易規則 約定俗成的首域交易竅門" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RFroSsh23QPTSY style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/63d0f8f4.html title="首域金融外匯交易規則 約定俗成的首域交易竅門">首域金融外匯交易規則 約定俗成的首域交易竅門</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/20750cf4.html alt=中國象棋比賽規則 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/20750cf4.html title=中國象棋比賽規則>中國象棋比賽規則</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7bdc2e62.html alt=淺談詩與詞的格律規則 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1da987534de342389b42f08a382ce58b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7bdc2e62.html title=淺談詩與詞的格律規則>淺談詩與詞的格律規則</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c76bcc61.html alt=私域流量增長規則 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/24ec4030837f4ad09eab0599e1b3e8d7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c76bcc61.html title=私域流量增長規則>私域流量增長規則</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>