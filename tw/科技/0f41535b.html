<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>linux中斷處理原理分析 | 极客快訊</title><meta property="og:title" content="linux中斷處理原理分析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/669c7a39bbff469299275a067db11edd"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0f41535b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0f41535b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0f41535b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0f41535b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0f41535b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0f41535b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0f41535b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0f41535b.html><meta property="article:published_time" content="2020-10-29T21:09:37+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:37+08:00"><meta name=Keywords content><meta name=description content="linux中斷處理原理分析"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/0f41535b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>linux中斷處理原理分析</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><pre>本文乃fireaxe原創，使用GPL發佈，可以自由拷貝，轉載。但轉載請保持文檔的完整性，並註明原作者及原鏈接。內容可任意使用，但對因使用該內容引起的後果不做任何保證。作者：fireaxe_hq@hotmail.com博客：fireaxe.blog.chinaunix.net</pre><p>Tasklet作為一種新機制，顯然可以承擔更多的優點。正好這時候SMP越來越火了，因此又在tasklet中加入了SMP機制，保證同種中斷只能在一個cpu上執行。在軟中斷時代，顯然沒有這種考慮。因此同一種中斷可以在兩個cpu上同時執行，很可能造成衝突。Linux中斷下半部處理有三種方式：軟中斷、tasklet、工作隊列。</p><p>曾經有人問我為什麼要分這幾種，該怎麼用。當時用書上的東西蒙混了過去，但是自己明白自己實際上是不懂的。最近有時間了，於是試著整理一下linux的中斷處理機制，目的是起碼從原理上能夠說得通。</p><p><strong>一、最簡單的中斷機制</strong></p><p>最簡單的中斷機制就是像芯片手冊上講的那樣，在中斷向量表中填入跳轉到對應處理函數的指令，然後在處理函數中實現需要的功能。類似下圖：</p><div class=pgc-img><img alt=linux中斷處理原理分析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/669c7a39bbff469299275a067db11edd><p class=pgc-img-caption></p></div><p>這種方式在原來的單片機課程中常常用到，一些簡單的單片機系統也是這樣用。</p><p>它的好處很明顯，簡單，直接。</p><p><strong>二、下半部</strong></p><p>中斷處理函數所作的第一件事情是什麼？答案是屏蔽中斷（或者是什麼都不做，因為常常是如果不清除IF位，就等於屏蔽中斷了），當然只屏蔽同一種中斷。之所以要屏蔽中斷，是因為新的中斷會再次調用中斷處理函數，導致原來中斷處理現場的破壞。即，破壞了interrupt context。</p><p>隨著系統的不斷複雜，中斷處理函數要做的事情也越來越多，多到都來不及接收新的中斷了。於是發生了中斷丟失，這顯然不行，於是產生了新的機制：分離中斷接收與中斷處理過程。中斷接收在屏蔽中斷的情況下完成；中斷處理在時能中斷的情況下完成，這部分被稱為中斷下半部。</p><div class=pgc-img><img alt=linux中斷處理原理分析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c29b80320fd744c5a0ec475e21204874><p class=pgc-img-caption></p></div><p>從上圖中看，只看int0的處理。Func0為中斷接收函數。中斷只能簡單的觸發func0，而func0則能做更多的事情，它與funcA之間可以使用隊列等緩存機制。當又有中斷髮生時，func0被觸發，然後發送一箇中斷請求到緩存隊列，然後讓funcA去處理。</p><p>由於func0做的事情是很簡單的，所以不會影響int0的再次接收。而且在func0返回時就會使能int0，因此funcA執行時間再長也不會影響int0的接收。</p><p><strong>三、軟中斷</strong></p><p>下面看看linux中斷處理。作為一個操作系統顯然不能任由每個中斷都各自為政，統一管理是必須的。</p><p>我們不可中斷部分的共同部分放在函數do_IRQ中，需要添加中斷處理函數時，通過request_irq實現。下半部放在do_softirq中，也就是軟中斷，通過open_softirq添加對應的處理函數。</p><div class=pgc-img><img alt=linux中斷處理原理分析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ba8f20d03f484c3d8b7c17f602d81572><p class=pgc-img-caption></p></div><p><strong>四、tasklet</strong></p><p>舊事物跟不上歷史的發展時，總會有新事物出現。</p><p>隨著中斷數的不停增加，軟中斷不夠用了，於是下半部又做了進化。</p><p>軟中斷用輪詢的方式處理。假如正好是最後一種中斷，則必須循環完所有的中斷類型，才能最終執行對應的處理函數。顯然當年開發人員為了保證輪詢的效率，於是限制中斷個數為32個。</p><p>為了提高中斷處理數量，順道改進處理效率，於是產生了tasklet機制。</p><p>Tasklet採用無差別的隊列機制，有中斷時才執行，免去了循環查表之苦。</p><div class=pgc-img><img alt=linux中斷處理原理分析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/12f4c24a9d934db99248e385b6c86457><p class=pgc-img-caption></p></div><p>總結下tasklet的優點：</p><p>（1）無類型數量限制；</p><p>（2）效率高，無需循環查表；</p><p>（3）支持SMP機制；</p><p><strong>五、工作隊列</strong></p><p>前面的機制不論如何折騰，有一點是不會變的。它們都在中斷上下文中。什麼意思？說明它們不可掛起。而且由於是串行執行，因此只要有一個處理時間較長，則會導致其他中斷響應的延遲。為了完成這些不可能完成的任務，於是出現了工作隊列。工作隊列說白了就是一組內核線程，作為中斷守護線程來使用。多箇中斷可以放在一個線程中，也可以每個中斷分配一個線程。</p><p>工作隊列對線程作了封裝，使用起來更方便。</p><p>因為工作隊列是線程，所以我們可以使用所有可以在線程中使用的方法。</p><div class=pgc-img><img alt=linux中斷處理原理分析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/76ab512e7f9f4c44995dbc30f454b6f7><p class=pgc-img-caption></p></div><p>Tasklet其實也不一定是在中斷上下文中執行，它也有可能在線程中執行。</p><p>假如中斷數量很多，而且這些中斷都是自啟動型的（中斷處理函數會導致新的中斷產生），則有可能cpu一直在這裡執行中斷處理函數，會導致用戶進程永遠得不到調度時間。</p><p>為了避免這種情況，linux發現中斷數量過多時，會把多餘的中斷處理放到一個單獨的線程中去做，就是ksoftirqd線程。這樣又保證了中斷不多時的響應速度，又保證了中斷過多時不會把用戶進程餓死。</p><p>問題是我們不能保證我們的tasklet或軟中斷處理函數一定會在線程中執行，所以還是不能使用進程才能用的一些方法，如放棄調度、長延時等。</p><p><strong>六、使用方式總結</strong></p><p>Request_irq掛的中斷函數要儘量簡單，只做必須在屏蔽中斷情況下要做的事情。</p><p>中斷的其他部分都在下半部中完成。</p><p>軟中斷的使用原則很簡單，永遠不用。它甚至都不算是一種正是的中斷處理機制，而只是tasklet的實現基礎。</p><p>工作隊列也要少用，如果不是必須要用到線程才能用的某些機制，就不要使用工作隊列。其實對於中斷來說，只是對中斷進行簡單的處理，大部分工作是在驅動程序中完成的。所以有什麼必要非使用工作隊列呢？</p><p>除了上述情況，就要使用tasklet。</p><p>即使是下半部，也只是作必須在中斷中要做的事情，如保存數據等，其他都交給驅動程序去做。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>linux</a></li><li><a>中斷</a></li><li><a>處理</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/8fc4961a.html alt=Linux中斷處理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/59a9811eea6b458e9c75fc84249c8beb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8fc4961a.html title=Linux中斷處理>Linux中斷處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/70eb09f7.html alt=三菱PLC的中斷處理，如何正確的理解中斷的功能 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/f513a0c7db0c4af6b20dc932e0294eb9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/70eb09f7.html title=三菱PLC的中斷處理，如何正確的理解中斷的功能>三菱PLC的中斷處理，如何正確的理解中斷的功能</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dbfe10e6.html alt=中斷處理流程（硬件層，系統層） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/tos-cn-i-0022/e84364f92a864e78b26ea1b63caf964e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dbfe10e6.html title=中斷處理流程（硬件層，系統層）>中斷處理流程（硬件層，系統層）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5872af9.html alt=Linux中斷機制：硬件處理，初始化和中斷處理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1534258428582a2d6399914 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5872af9.html title=Linux中斷機制：硬件處理，初始化和中斷處理>Linux中斷機制：硬件處理，初始化和中斷處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/10c7d8fd.html alt=神州泰嶽：公司在自然語言處理領域的基礎技術研究和應用落地均走在行業前列 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/10c7d8fd.html title=神州泰嶽：公司在自然語言處理領域的基礎技術研究和應用落地均走在行業前列>神州泰嶽：公司在自然語言處理領域的基礎技術研究和應用落地均走在行業前列</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html alt="MySQL 事務處理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html title="MySQL 事務處理">MySQL 事務處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/011d2da0.html alt=MySql併發與事務的處理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/f13d8a1e-5e60-4b48-90bc-3c26e312a208 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/011d2da0.html title=MySql併發與事務的處理>MySql併發與事務的處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d3c48fcc.html alt=Spring聲明式事務處理的實現原理，來自面試官的窮追拷問 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d3c48fcc.html title=Spring聲明式事務處理的實現原理，來自面試官的窮追拷問>Spring聲明式事務處理的實現原理，來自面試官的窮追拷問</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/efc2a519.html alt=你知道MySQL的事務處理和隔離級別嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/efc2a519.html title=你知道MySQL的事務處理和隔離級別嗎？>你知道MySQL的事務處理和隔離級別嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/160af1cf.html alt=牆面基層處理有哪些基本步驟 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RZdKr6O1pG4jKu style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/160af1cf.html title=牆面基層處理有哪些基本步驟>牆面基層處理有哪些基本步驟</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bf790e4b.html alt=地面基層處理是什麼意思？地面基層清理方法及注意事項有哪些 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/339700cdb9c04fdd98fcc3e95cdc166c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bf790e4b.html title=地面基層處理是什麼意思？地面基層清理方法及注意事項有哪些>地面基層處理是什麼意思？地面基層清理方法及注意事項有哪些</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/44c6d5cb.html alt=豎向鋼筋位移施工加固處理措施 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a7d965c73c1542978ae9091d6bf34aa9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/44c6d5cb.html title=豎向鋼筋位移施工加固處理措施>豎向鋼筋位移施工加固處理措施</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6720a0ac.html alt=殷佔堂：再談日本垃圾處理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9d101ab3a11348a9ad723bf8df3accb4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6720a0ac.html title=殷佔堂：再談日本垃圾處理>殷佔堂：再談日本垃圾處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3844d7f0.html alt=幹熄焦事故處理及案例分析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4f2463465a6a4c5fb2e8f708400ba596 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3844d7f0.html title=幹熄焦事故處理及案例分析>幹熄焦事故處理及案例分析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c33990cd.html alt=幹熄焦常見故障及處理方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c4733b279b994389b8d95831dbfa98d0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c33990cd.html title=幹熄焦常見故障及處理方法>幹熄焦常見故障及處理方法</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>