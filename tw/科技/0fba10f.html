<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>STM32CubeMX + HAL庫學習「附工程源碼」 | 极客快訊</title><meta property="og:title" content="STM32CubeMX + HAL庫學習「附工程源碼」 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/e620008aa2cb428bb9e7bdf9c2bb9f0d"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/0fba10f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/0fba10f.html><meta property="article:published_time" content="2020-10-29T20:50:02+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:02+08:00"><meta name=Keywords content><meta name=description content="STM32CubeMX + HAL庫學習「附工程源碼」"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/0fba10f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>STM32CubeMX + HAL庫學習「附工程源碼」</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">STM32CubeMX + HAL</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">- 一些說明</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- 底層配置</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- Cube基本使用</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- HAL庫函數</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- 中斷回調函數</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- 外設對應時鐘</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">- 配置示例</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- 小編有話說</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- RTC</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- SDIO + FATFS</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- SDRAM</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- LTDC + DMA2D</span></p><p><span style="color:#4183c4;--tt-darkmode-color: #4183C4">-- 待補充...</span></p><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">STM32CubeMX + HAL</span></strong></h1><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">一些說明</span></strong></h1><h1 class=pgc-h-arrow-right><span style="color:#34495e;--tt-darkmode-color: #809CB9">底層配置</span></h1><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">使用</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">STM32CubeMX</span></span>代碼生成工具，不用關注底層配置的細節，真舒服。</p><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">使用教程：</span></p><pre><code>https://sxf1024.lanzoui.com/b09rf2dwj 密碼:bgvi</code></pre><p style=text-align:start><em><span style="color:#34495e;--tt-darkmode-color: #809CB9">雖然</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Cube+HAL</span></span>很舒服，但新手不建議用。最好還是先去學一下標準庫怎麼用，有個大致概念後，再來學這一套。</em></p><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Cube基本使用</span></strong></h1><ol start=0><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">新建工程</span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">選擇芯片</span></li><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，選擇</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">RCC(HSE：Crystal/Ceramic Resonator)</span></span>、<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SYS(Debug：Serial Wiire)</span></span></li><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，配置時鐘樹</span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e620008aa2cb428bb9e7bdf9c2bb9f0d><p class=pgc-img-caption></p></div><ol start=5><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Project Manager</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，配置工程輸出項</span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3b4d456040fb433bb89101bdeab99f7d><p class=pgc-img-caption></p></div><ol start=6><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，選擇功能(若是選</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">GPIO</span></span>相關，可以直接在<strong>Pinout view</strong>選擇；若是其他功能，可以在左邊<strong>Categories</strong>打開，會自動配置引腳)、設置<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Parameter Settings/NVIC</span></span>等</li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cb8f0a363942488f9b379317018c253b><p class=pgc-img-caption></p></div><ol start=7><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">GENERATE CODE</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，生成工程，用KEIL打開編輯</span></li></ol><hr><h1 class=pgc-h-arrow-right><span style="color:#34495e;--tt-darkmode-color: #809CB9">HAL庫函數</span></h1><ul><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">函數形式：均以</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL_</span></span>開頭</li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">尋找過程：在驅動文件</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">stm32f4xx_hal_XXX.c</span></span>或其<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">.h</span></span>文件中找函數定義，一般在靠後位置</li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">其他說明：</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL</span></span>庫並沒有把所有的操作都封裝成凼數。對於底層的<strong>寄存器操作</strong>(如讀取捕獲/比較寄存器)，還有修改外設的某個<strong>配置參數</strong>(如改變輸入捕獲的極性)，<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL</span></span>庫會使用<strong>宏定義</strong>來實現。而且會用<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">__HAL_</span></span>作為這類宏定義的<strong>前綴</strong>。<strong>獲取</strong>某個參數，宏定義中一般會有<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">_GET</span></span>；而<strong>設置</strong>某個參數的，宏定義中就會有<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">_SET</span></span>。在開發過程中，如果遇到<strong>寄存器</strong>級別或者<strong>更小範圍</strong>的操作時，可以到該外設的<strong>頭文件</strong>中查找，一般都能找到相應的宏定義。<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL</span></span>庫函數<strong>第一個參數</strong>一般都是<strong>句柄</strong>(一個包含了當前對象絕大部分狀態的結構體)，雖然增加了開銷，但是用起來便捷了非常多。</li></ul><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">中斷回調函數</span></strong></h1><ul><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">函數形式：</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL_XXX_XXXCallback()</span></span>。</li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">尋找過程：中斷文件</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">stm32f4xx_it.c</span></span> - > 中斷函數<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">XXX_IRQHandler(void)</span></span> -> HAL庫中斷函數<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL_XXX_IRQHandler(GPIO_PIN_13)</span></span> -> 回調函數<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL_XXX_XXXCallback()</span></span></li></ul><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">外設對應時鐘</span></strong></h1><ol start=0><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">隨便進入一個</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">外設初始化函數</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，如</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">MX_GPIO_Init()</span></span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">隨便進入一個</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">時鐘</span></strong><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">使能</span></strong><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">函數</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，如</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">__HAL_RCC_GPIOC_CLK_ENABLE()</span></span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">隨便進入一個</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">RCC宏定義</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，如</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">RCC_AHB1ENR_GPIOCEN</span></span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">或者直接進入</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">stm32f429xx.h</span></span>文件</li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">裡面有所有</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">外設與時鐘</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">對應關係，如</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">RCC_AHB1ENR_DMA1EN</span></span></li></ol><p style=text-align:start><br></p><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">配置示例</span></strong></h1><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">小編有話說</span></strong></h1><ul><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">例子源碼：https://sxf1024.lanzoui.com/b09rf535a 密碼:bf5q</span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">如果配置過程中，參數不知道怎麼設置，可以去標準庫例程(如野火、正點原子)中看對應的參數是什麼</span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">Cube軟件只是幫你配置了底層，一些初始化代碼還是需要自己手動加的，如SDRAM充電初始化、讀寫函數等</span></li></ul><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">RTC</span></strong></h1><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8c51381268564547a14271bfeb1fc985><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4e5792bac9524ea086b1c962b14a981f><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6f63b569bfce47539e8d1f5d49db8c22><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5066cd85e6d94c039e575f6bf6f5777f><p class=pgc-img-caption></p></div><pre><code> RTC_DateTypeDef sDate; RTC_TimeTypeDef sTime;   uint8_t second_tmp = 0;  HAL_RTC_GetTime(&amp;hrtc, &amp;sTime, RTC_FORMAT_BIN); // 讀取時間 HAL_RTC_GetDate(&amp;hrtc, &amp;sDate, RTC_FORMAT_BIN); // 讀取日期 if(second_tmp != sTime.Seconds) { // 讀取秒     second_tmp = sTime.Seconds;     printf("20%d%d-%d%d-%d%d\r\n",             sDate.Year/10%10, sDate.Year%10,             sDate.Month/10%10, sDate.Month%10,             sDate.Date/10%10, sDate.Date%10);     printf("%d%d:%d%d:%d%d\r\n",             sTime.Hours/10%10, sTime.Hours%10,             sTime.Minutes/10%10, sTime.Minutes%10,             sTime.Seconds/10%10, sTime.Seconds%10); }</code></pre><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">SDIO + FATFS</span></strong></h1><ol start=0><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">選擇SDIO功能，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Connectivity -> SDIO -> Mode: SD 4bit Wide bus -> 勾選NVIC</span></span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5a8674331b2a4dc7a21885eaf1e447c7><p class=pgc-img-caption></p></div><ol start=2><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">配置SDIO時鐘，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，SDIO模塊輸入要求為</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">48MHz</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，系統提示可以自動設置時鐘問題，選擇</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Yes</span></span>。SDIO時鐘分頻係數<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">CLKDIV</span></span>，計算公式為<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDIO_CK=48MHz/(CLKDIV+2)</span></span>也可手動修改時鐘配置。</li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cbdc16dbfb5f423686d919ca51f440cc><p class=pgc-img-caption></p></div><ol start=3><li><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">啟用文件系統中間件</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Middleware -> FATFS</span></span>，模式選擇SD卡，配置文件系統：如果要支持中文文件名，則配置<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">CODE_PAGE</span></span>為<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Simplified Chinese</span></span>如果要支持長文件名，則要使能<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">USE_LEN</span></span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/356246528f8c49af90e28433f3d6120c><p class=pgc-img-caption></p></div><ol start=4><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">繼續上面界面，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Advanced Settings</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">勾選</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Use dma template</span></span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c67a989a4c2e4b67a84f225ca2647cdc><p class=pgc-img-caption></p></div><ol start=5><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">設置DMA傳輸，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Connectivity -> SDIO-> DMA Settings</span></span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d902def23f294bc48cbcc5a048ad7cab><p class=pgc-img-caption></p></div><ol start=6><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">配置NVIC，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Clock Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">System Core -> NVIC</span></span>。</li></ol><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">注意，SDIO</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">中斷</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">優先級</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">必須高於</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">DMA2 stream3和DMA2 stream6的</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">中斷</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">優先級</span></p><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/f6592e62676d4926a8efa7baac8d3957><p class=pgc-img-caption></p></div><ol start=7><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">堆棧設置，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Progect Manager -> Project -> Linker Settings</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，加大堆棧大小（注意：由於剛才設置長文件名動態緩存存儲在堆中，故需要增大堆大小，如果不修改則程序運行時</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">堆</span><span style="color:#34495e;--tt-darkmode-color: #809CB9">會生成溢出，程序進入硬件錯誤中斷(HardFault)，死循環）。</span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fa3828a8a3c94e319c56af3d945aaf4c><p class=pgc-img-caption></p></div><ol start=8><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">生成工程，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">GENERATE CODE</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9"> ，用KEIL打開</span></li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/17e994632de64271abade2ba84b4ad28><p class=pgc-img-caption></p></div><pre><code> UINT bw; retSD = f_mount(&amp;SDFatFS, SDPath, 0); if(retSD != FR_OK) {     printf("Mount Error :%d\r\n", retSD); } retSD = f_open(&amp;SDFile, "0:/test.txt", FA_CREATE_ALWAYS | FA_WRITE); if(retSD != FR_OK){     printf("Open Error :%d\r\n", retSD); } retSD = f_write(&amp;SDFile, "abcde", 5, &amp;bw); if(retSD != FR_OK){     printf("Write Error :%d\r\n", retSD); } f_close(&amp;SDFile); retSD = f_open(&amp;SDFile, "0:/test.txt", FA_READ); char buff[10] = {0}; retSD = f_read(&amp;SDFile, buff, 5, &amp;bw); if(retSD == FR_OK){     printf("%s\r\n", buff); } f_close(&amp;SDFile);</code></pre><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">SDRAM</span></strong></h1><ol start=0><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">開啟FMC功能，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">Pinout&Configuration</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9"> ，</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Connectivity -> FMC -> SDRAM2</span></span><strong>SDRAM1</strong>的起始地址為<strong>0XC0000000</strong>，<strong>SDRAM2</strong>的起始地址為<strong>0XD0000000</strong>。一般SDRAM都含有<strong>4</strong>個bank。<strong>Configuration</strong>中的參數可從SDRAM的<strong>數據手冊</strong>上找到。</li></ol><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4faecbd80de042f98b97b61267f8aa5a><p class=pgc-img-caption></p></div><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">各個選項的配置(只做解釋，不對應上圖)：</span></p><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Clock and chip enable</span></span>：<strong>FMC_SDCKE0</strong> 和<strong>FMC_SDCLK0</strong>對應的存儲區域1 的地址範圍是<strong>0xC000 0000-0xCFFF FFFF</strong>；而<strong>FMC_SDCKE1</strong> 和<strong>FMC_SDCLK1</strong> 對應的存儲區域2 的地址範圍是<strong>0xD000 0000- 0xDFFF FFFF</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Bank</span></span>由硬件連接決定需要選擇<strong>SDRAM bank 2</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Column bit number</span></span>表示列數，<strong>8位</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Row bit number</span></span>表示行數，<strong>12位</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">CAS latency</span></span>表示CAS潛伏期，即上面說的CL，該配置需要與之後的SDRAM模式寄存器的配置相同，這裡先配置為<strong>2 memory clock cycles</strong>(對於SDRAM時鐘超過133MHz的，則需要配置為3 memory clock cycles)</li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Write protection</span></span> 表示寫保護，一般配置為<strong>Disabled</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM common clock</span></span>為SDRAM 時鐘配置，可選HCLK的2分頻\3分頻\不使能SDCLK時鐘。前面主頻配置為216MHz，SDRAM common clock設置為<strong>2分頻</strong>，那SDCLK時鐘為108MHz，每個時鐘週期為9.25ns</li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM common burst read</span></span> 表示突發讀，這裡選擇使能</li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM common read pipe delay</span></span> 表示CAS潛伏期後延遲多少個時鐘在進行讀數據，這裡選擇<strong>0 HCLK clock cycle</strong></li><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Load mode register to active delay</span></span> 加載模式寄存器命令和激活或刷新命令之間的延遲，按存儲器時鐘週期計</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/311f286bfb0b4ef5b59faa67802953e5><p class=pgc-img-caption></p></div><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Exit self-refresh delay</span></span>從發出自刷新命令到發出激活命令之間的延遲，按存儲器時鐘週期數計查數據手冊知道其最小值為70ns，由於我們每個時鐘週期為9.25ns，所以設為<strong>8</strong> (70÷9.25，向上取整)</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c62ed21dc6e64f9cb0098b8d2f849d29><p class=pgc-img-caption></p></div><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM common row cycle delay</span></span>刷新命令和激活命令之間的延遲，以及兩個相鄰刷新命令之間的延遲， 以存儲器時鐘週期數表示查數據手冊知道其最小值為63ns，由於我們每個時鐘週期為9.25ns，所以設為<strong>7</strong> (63÷9.25，向上取整)</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/94cf33a34b3c44caae104b664814af37><p class=pgc-img-caption></p></div><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Write recovery time</span></span>寫命令和預充電命令之間的延遲，按存儲器時鐘週期數計</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/31ee9a90a7f04a3d9418b3607429e9ed><p class=pgc-img-caption></p></div><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM common row precharge delay</span></span>預充電命令與其它命令之間的延遲，按存儲器時鐘週期數計查數據手冊知道其最小值為15ns，由於我們每個時鐘週期為9.25ns，所以設為<strong>2</strong> (15÷9.25，向上取整)</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b60e4fa85ad742bfb16ac0a53b34978f><p class=pgc-img-caption></p></div><ul><li><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Row to column delay</span></span>激活命令與讀/寫命令之間的延遲，按存儲器時鐘週期數計查數據手冊知道其最小值為15ns，由於我們每個時鐘週期為9.25ns，所以這裡本應該設為<strong>2</strong> (15÷9.25，向上取整)但要注意，時序必須滿足以下式子：TWR ≥ TRAS - TRCDTWR ≥ TRC - TRCD - TRP其中：TWR = <strong>Write recovery</strong> <strong>time</strong> = 2TRAS = <strong>Self refresh time</strong> = 5TRC = <strong>SDRAM common row cycle delay</strong> = 7TRP = <strong>SDRAM common row precharge delay</strong> = 2TRCD = <strong>Row to column delay</strong>所以這裡<strong>Row to column delay</strong>應該取3</li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a67f890d1d064719b78baadbc8f6019a><p class=pgc-img-caption></p></div><ol start=2><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">生成代碼，</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">GENERATE CODE</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">， 用KEIL打開</span></li></ol><pre><code> uint8_t temp[100]__attribute__((at(0xD0000000)));    for(int i=0;i&lt;100;i++){     temp[i] = i; } for(int i=0;i&lt;100;i++){     printf("%d  ", temp[i]); }</code></pre><ol start=3><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">到這裡只是藉助Cube完成了引腳配置，還需要SDRAM初始化操作和讀寫函數，可從官方例程裡獲取，路徑：C:\Users\10617\STM32Cube\Repository\STM32Cube_FW_F4_V1.25.0\Drivers\BSP\STM32F429I-Discovery\XXX</span></li></ol><pre><code> /*****************************SDRAM使能函數******************************/  /**   * @brief  對SDRAM芯片進行初始化配置   * @param  None.    * @retval None.   */ static void USER_SDRAM_ENABLE(void) {     FMC_SDRAM_CommandTypeDef Command;        __IO uint32_t tmpmrd =0;      /* Step 1:  Configure a clock configuration enable command */   Command.CommandMode             = FMC_SDRAM_CMD_CLK_ENABLE;   Command.CommandTarget           = FMC_SDRAM_CMD_TARGET_BANK2;   Command.AutoRefreshNumber       = 1;   Command.ModeRegisterDefinition  = 0;    /* Send the command */   HAL_SDRAM_SendCommand(&amp;hsdram1, &amp;Command, SDRAM_TIMEOUT);    /* Step 2: Insert 100 us minimum delay */    /* Inserted delay is equal to 1 ms due to systick time base unit (ms) */   HAL_Delay(1);    /* Step 3: Configure a PALL (precharge all) command */    Command.CommandMode             = FMC_SDRAM_CMD_PALL;   Command.CommandTarget           = FMC_SDRAM_CMD_TARGET_BANK2;   Command.AutoRefreshNumber       = 1;   Command.ModeRegisterDefinition  = 0;    /* Send the command */   HAL_SDRAM_SendCommand(&amp;hsdram1, &amp;Command, SDRAM_TIMEOUT);        /* Step 4: Configure an Auto Refresh command */    Command.CommandMode             = FMC_SDRAM_CMD_AUTOREFRESH_MODE;   Command.CommandTarget           = FMC_SDRAM_CMD_TARGET_BANK2;   Command.AutoRefreshNumber       = 4;   Command.ModeRegisterDefinition  = 0;    /* Send the command */   HAL_SDRAM_SendCommand(&amp;hsdram1, &amp;Command, SDRAM_TIMEOUT);      /* Step 5: Program the external memory mode register */   tmpmrd = (uint32_t)SDRAM_MODEREG_BURST_LENGTH_2          |                      SDRAM_MODEREG_BURST_TYPE_SEQUENTIAL   |                      SDRAM_MODEREG_CAS_LATENCY_3           |                      SDRAM_MODEREG_OPERATING_MODE_STANDARD |                      SDRAM_MODEREG_WRITEBURST_MODE_SINGLE;      Command.CommandMode             = FMC_SDRAM_CMD_LOAD_MODE;   Command.CommandTarget           = FMC_SDRAM_CMD_TARGET_BANK2;   Command.AutoRefreshNumber       = 1;   Command.ModeRegisterDefinition  = tmpmrd;    /* Send the command */   HAL_SDRAM_SendCommand(&amp;hsdram1, &amp;Command, SDRAM_TIMEOUT);      /* Step 6: Set the refresh rate counter */   /* Set the device refresh rate */   HAL_SDRAM_ProgramRefreshRate(&amp;hsdram1, REFRESH_COUNT);  } /*****************************使能函數結束******************************/</code></pre><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">或者以我的野火</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">STM32F429IGT6</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">的版本SDRAM為</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">8M</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，源碼鏈接：</span></p><pre><code>https://sxf1024.lanzoui.com/b09rf535a 密碼:bf5q</code></pre><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">添加到工程</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">Core</span></span>路徑下，然後在KEIL中初始化操作：</p><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">(注意這個</span><span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">SDRAM_InitSequence();</span></span><strong>不能</strong>加在<span style="color:#e96900;--tt-darkmode-color: #E96900"><span style="background-color:#f8f8f8;--tt-darkmode-bgcolor: #191919">HAL_SDRAM_MspInit()</span></span>後面!!! 因為它這裡還沒FMC初始化完成!!!! 加在這裡是<strong>沒有用的</strong>！！！)</p><pre><code> #include "bsp_sdram.h" MX_FMC_Init(); SDRAM_InitSequence();  SDRAM_Test();</code></pre><hr><h1 class=pgc-h-arrow-right><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">LTDC + DMA2D</span></strong></h1><p style=text-align:start><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">務必在上面SDRAM配置成功後，再來搞這個！！！</span></strong></p><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">詳細教程看這個：</span></p><pre><code>https://zzttzz.gitee.io/blog/posts/7109b92c</code></pre><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">但他給的源碼還</span><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">有點問題</span></strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">，運行處理沒效果。</span></p><p style=text-align:start><span style="color:#34495e;--tt-darkmode-color: #809CB9">我提供的源碼鏈接：</span></p><pre><code>https://sxf1024.lanzoui.com/b09rf535a 密碼:bf5q</code></pre><p style=text-align:start><strong><span style="color:#34495e;--tt-darkmode-color: #809CB9">注意：</span></strong></p><ul><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">我跟他的配置有點不一樣，我的是：Pixel Clock Plparity：Normal InputDMA2D要開一下中斷，等級可以不用很高。如果不開的話，有可能會傳圖時候卡住。LCD-TFT時鐘：25MHz</span></li><li><span style="color:#34495e;--tt-darkmode-color: #809CB9">層 1 = layer 0，層 2 = layer 1</span></li></ul><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/4cd9cb716d6a41cdb194e0547976b32c><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/222e401254c74aa696c8ec3595dfe16a><p class=pgc-img-caption></p></div><p style=text-align:start><br></p><h1 class=pgc-h-arrow-right><span style="color:#34495e;--tt-darkmode-color: #809CB9">更多待補充...</span></h1><div class=pgc-img><img alt="STM32CubeMX + HAL庫學習「附工程源碼」" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2b54e7a6e55b4b428089851e6c6cda9e><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>STM32CubeMX</a></li><li><a>HAL</a></li><li><a>庫學習</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>