<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹å‹™æ¶ˆæ¯æºç¢¼ä»‹ç´¹(ä¹¾è²¨) | æå®¢å¿«è¨Š</title><meta property="og:title" content="ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹å‹™æ¶ˆæ¯æºç¢¼ä»‹ç´¹(ä¹¾è²¨) - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/9893da5524c1439f8a11cb24322c57a9"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/15b0178.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/15b0178.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/15b0178.html><meta property="article:published_time" content="2020-10-29T20:50:42+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:42+08:00"><meta name=Keywords content><meta name=description content="ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹å‹™æ¶ˆæ¯æºç¢¼ä»‹ç´¹(ä¹¾è²¨)"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/15b0178.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹å‹™æ¶ˆæ¯æºç¢¼ä»‹ç´¹(ä¹¾è²¨)</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><h1><strong>å‰è¨€</strong></h1><p>å¾—ç›Šæ–¼MQå‰Šå³°å¡«è°·ï¼Œç³»çµ±è§£è€¦ï¼Œæ“ä½œç•°æ­¥ç­‰åŠŸèƒ½ç‰¹æ€§ï¼Œåœ¨äº’è¯ç¶²è¡Œæ¥­ï¼Œå¯ä»¥èªªæœ‰åˆ†ä½ˆå¼æœå‹™çš„åœ°æ–¹ï¼ŒMQéƒ½å¾€å¾€ä¸æœƒç¼ºå¸­ã€‚ç”±é˜¿é‡Œè‡ªç ”çš„RocketMQæ›´æ˜¯ç¶“æ­·äº†å¤šå¹´çš„é›™åä¸€é«˜ä½µç™¼æŒ‘æˆ°ï¼Œå…¶ä¸­4.3.0ç‰ˆæœ¬æ¨å‡ºäº†äº‹å‹™æ¶ˆæ¯çš„æ–°ç‰¹æ€§ï¼Œæœ¬æ–‡å°RocketMQ 4.5.0ç‰ˆæœ¬äº‹å‹™æ¶ˆæ¯ç›¸é—œçš„æºç¢¼è·Ÿè¹¤ä»‹ç´¹ï¼Œé€šéé–±è®€è®€è€…å¯ä»¥çŸ¥é“ï¼š</p><ul><li>äº‹å‹™æ¶ˆæ¯è§£æ±ºä»€éº¼æ¨£çš„å•é¡Œ</li><li>äº‹å‹™æ¶ˆæ¯çš„å¯¦ç¾åŸç†åŠå…¶è¨­è¨ˆäº®é»</li></ul><div class=pgc-img><img alt=ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹å‹™æ¶ˆæ¯æºç¢¼ä»‹ç´¹(ä¹¾è²¨) onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9893da5524c1439f8a11cb24322c57a9><p class=pgc-img-caption>RocketMQ</p></div><h1><strong>è§£æ±ºä»€éº¼å•é¡Œ</strong></h1><p>å‡è¨­æˆ‘æ‰€åœ¨çš„ç³»çµ±ç¾åœ¨æœ‰é€™æ¨£ä¸€å€‹å ´æ™¯ï¼š</p><p>æœ¬åœ°é–‹å•Ÿæ•¸æ“šåº«äº‹å‹™é€²è¡Œæ‰£æ¬¾æ“ä½œï¼ŒæˆåŠŸå¾Œç™¼é€MQæ¶ˆæ¯çµ¦åº«å­˜ä¸­å¿ƒé€²è¡Œç™¼è²¨ã€‚</p><p>æœ‰äººæœƒæƒ³åˆ°é–‹å•Ÿmybatisäº‹å‹™å¯¦ç¾ï¼ŒæŠŠæœ¬åœ°äº‹å‹™å’ŒMQæ¶ˆæ¯æ”¾åœ¨ä¸€èµ·ä¸å°±è¡Œäº†å—ï¼Ÿå¦‚æœMQç™¼é€æˆåŠŸï¼Œå°±æäº¤äº‹å‹™ï¼Œç™¼é€å¤±æ•—å°±å›æ»¾äº‹å‹™ï¼Œæ•´å¥—æ“ä½œä¸€æ°£å‘µæˆã€‚</p><pre>transaction{ æ‰£æ¬¾(); boolean success = ç™¼é€MQ();	if(success){ commit(); }else{ rollBack(); }}</pre><p>çœ‹ä¼¼æ²’ä»€éº¼å•é¡Œï¼Œä½†æ˜¯<strong>ç¶²çµ¡æ˜¯ä¸å¯é </strong>çš„ã€‚å‡è¨­MQè¿”å›éä¾†çš„éŸ¿æ‡‰å› ç‚ºç¶²çµ¡åŸå› é²é²æ²’æœ‰æ”¶åˆ°ï¼Œæ‰€ä»¥åœ¨é¢å°ä¸ç¢ºå®šçš„MQè¿”å›çµæœåªå¥½é€²è¡Œå›æ»¾ã€‚ä½†æ˜¯MQ æœå‹™å™¨åˆç¢ºå¯¦æ˜¯æ”¶åˆ°äº†é€™æ¢æ¶ˆæ¯çš„ï¼Œåªæ˜¯çµ¦å®¢æˆ¶ç«¯çš„éŸ¿æ‡‰ä¸Ÿå¤±äº†ï¼Œæ‰€ä»¥å°è‡´çš„çµæœå°±æ˜¯æ‰£æ¬¾å¤±æ•—ï¼ŒæˆåŠŸç™¼è²¨ã€‚</p><div class=pgc-img><img alt=ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹å‹™æ¶ˆæ¯æºç¢¼ä»‹ç´¹(ä¹¾è²¨) onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9e038ea88e9648df9dbeb07dbf872fdb><p class=pgc-img-caption></p></div><p>æ—¢ç„¶MQæ¶ˆæ¯çš„ç™¼é€ä¸èƒ½å’Œæœ¬åœ°äº‹å‹™å¯«åœ¨ä¸€èµ·ï¼Œé‚£å¦‚ä½•ä¾†ä¿è­‰å…¶æ•´é«”å…·æœ‰åŸå­æ€§çš„éœ€æ±‚å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ä»Šå¤©æˆ‘å€‘ä»‹ç´¹çš„ä¸»è§’ï¼š<strong>äº‹å‹™æ¶ˆæ¯</strong>ã€‚</p><h1><strong>æ¦‚è¦½</strong></h1><div class=pgc-img><img alt=ä¸€å®šèƒ½çœ‹æ‡‚çš„RocketMQäº‹å‹™æ¶ˆæ¯æºç¢¼ä»‹ç´¹(ä¹¾è²¨) onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3a59f4ec00334086aa34d4af730812c9><p class=pgc-img-caption></p></div><p>ç¸½é«”è€Œè¨€RocketMQäº‹å‹™æ¶ˆæ¯åˆ†ç‚ºå…©æ¢ä¸»ç·š</p><ol><li><strong>å®šæ™‚ä»»å‹™ç™¼é€æµç¨‹</strong>ï¼šç™¼é€half message(åŠæ¶ˆæ¯)ï¼ŒåŸ·è¡Œæœ¬åœ°äº‹å‹™ï¼Œç™¼é€äº‹å‹™åŸ·è¡Œçµæœ</li><li><strong>å®šæ™‚ä»»å‹™å›æŸ¥æµç¨‹</strong>ï¼šMQæœå‹™å™¨å›æŸ¥æœ¬åœ°äº‹å‹™ï¼Œç™¼é€äº‹å‹™åŸ·è¡Œçµæœ</li></ol><p>å› æ­¤æœ¬æ–‡ä¹Ÿé€šéé€™å…©æ¢ä¸»ç·šå°æºç¢¼é€²è¡Œåˆ†æ</p><h1><strong>æºç¢¼åˆ†æ</strong></h1><p><strong>åŠæ¶ˆæ¯ç™¼é€æµç¨‹</strong></p><p><strong>æœ¬åœ°æ‡‰ç”¨(client)</strong></p><p>åœ¨æœ¬åœ°æ‡‰ç”¨ç™¼é€äº‹å‹™æ¶ˆæ¯çš„æ ¸å¿ƒé¡æ˜¯TransactionMQProducerï¼Œè©²é¡é€šéç¹¼æ‰¿DefaultMQProducerä¾†è¤‡ç”¨å¤§éƒ¨åˆ†ç™¼é€æ¶ˆæ¯ç›¸é—œçš„é‚è¼¯ï¼Œé€™å€‹é¡çš„ä»£ç¢¼é‡éå¸¸å°‘åªæœ‰100ä¾†è¡Œï¼Œä¸‹é¢æ˜¯é€™å€‹é¡çš„sendMessageTransactionæ–¹æ³•</p><pre>@Overridepublic TransactionSendResult sendMessageInTransaction(final Message msg, final Object arg) throws MQClientException { if (null == this.transactionListener) { throw new MQClientException("TransactionListener is null", null); } return this.defaultMQProducerImpl.sendMessageInTransaction(msg, null, arg);}</pre><p>é€™å€‹æ–¹æ³•åšäº†å…©ä»¶äº‹ï¼Œ</p><ol><li>æª¢æŸ¥transactionListeneræ˜¯å¦å­˜åœ¨</li><li>èª¿ç”¨çˆ¶é¡åŸ·è¡Œäº‹å‹™æ¶ˆæ¯ç™¼é€</li></ol><p>TransactionListeneråœ¨äº‹å‹™æ¶ˆæ¯æµç¨‹ä¸­èµ·åˆ°è‡³é—œé‡è¦çš„ä½œç”¨ï¼Œä¸€èµ·çœ‹çœ‹é€™å€‹æ¥å£</p><pre>public interface TransactionListener { /** * When send transactional prepare(half) message succeed, this method will be invoked to execute local transaction. * * @param msg Half(prepare) message * @param arg Custom business parameter * @return Transaction state */ LocalTransactionState executeLocalTransaction(final Message msg, final Object arg); /** * When no response to prepare(half) message. broker will send check message to check the transaction status, and this * method will be invoked to get local transaction status. * * @param msg Check message * @return Transaction state */ LocalTransactionState checkLocalTransaction(final MessageExt msg);}</pre><p>æ¥å£è¨»é‡‹èªªçš„å¾ˆæ˜ç™½ï¼Œé…åˆä¸Šé¢çš„æ¦‚è¦½åœ–ä¾†çœ‹å°±æ˜¯ï¼ŒexecuteLocalTransactionæ–¹æ³•å°æ‡‰çš„å°±æ˜¯<strong>åŸ·è¡Œæœ¬åœ°äº‹å‹™</strong>æ“ä½œï¼ŒcheckLocalTransactionå°æ‡‰çš„å°±æ˜¯<strong>å›æŸ¥æœ¬åœ°äº‹å‹™</strong>æ“ä½œã€‚ä¸‹é¢æ˜¯DefaultMQProduceré¡çš„sendMessageInTransactionæ–¹æ³•æºç¢¼</p><pre>public TransactionSendResult sendMessageInTransaction(final Message msg, final LocalTransactionExecuter localTransactionExecuter, final Object arg) throws MQClientException { ... SendResult sendResult = null; MessageAccessor.putProperty(msg, MessageConst.PROPERTY_TRANSACTION_PREPARED, "true"); MessageAccessor.putProperty(msg, MessageConst.PROPERTY_PRODUCER_GROUP, this.defaultMQProducer.getProducerGroup()); 						... sendResult = this.send(msg); 						... switch (sendResult.getSendStatus()) { case SEND_OK: { 		... localTransactionState = transactionListener.executeLocalTransaction(msg, arg); ... break; case FLUSH_DISK_TIMEOUT: case FLUSH_SLAVE_TIMEOUT: case SLAVE_NOT_AVAILABLE: localTransactionState = LocalTransactionState.ROLLBACK_MESSAGE; break; default: break; } 						... this.endTransaction(sendResult, localTransactionState, localException);								...}</pre><p>ç‚ºäº†ä½¿æºç¢¼çš„é‚è¼¯æ›´åŠ ç›´è§€ï¼Œç­†è€…ç²¾ç°¡äº†æ ¸å¿ƒä»£ç¢¼ã€‚sendMessageInTransactionæ–¹æ³•ä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…</p><ol><li>çµ¦æ¶ˆæ¯æ‰“ä¸Šäº‹å‹™æ¶ˆæ¯ç›¸é—œçš„æ¨™è¨˜ï¼Œç”¨æ–¼MQæœå‹™ç«¯å€åˆ†æ™®é€šæ¶ˆæ¯å’Œäº‹å‹™æ¶ˆæ¯</li><li>ç™¼é€åŠæ¶ˆæ¯(half message)</li><li>ç™¼é€æˆåŠŸå‰‡ç”±transactionListeneråŸ·è¡Œæœ¬åœ°äº‹å‹™</li><li>åŸ·è¡ŒendTransactionæ–¹æ³•ï¼Œå¦‚æœ<strong>åŠæ¶ˆæ¯ç™¼é€å¤±æ•—</strong>æˆ–<strong>æœ¬åœ°äº‹å‹™åŸ·è¡Œå¤±æ•—</strong>å‘Šè¨´æœå‹™ç«¯æ˜¯åˆªé™¤åŠæ¶ˆæ¯ï¼Œ<strong>åŠæ¶ˆæ¯ç™¼é€æˆåŠŸ</strong>ä¸”<strong>æœ¬åœ°äº‹å‹™åŸ·è¡ŒæˆåŠŸ</strong>å‰‡å‘Šè¨´æœå‹™ç«¯ç”Ÿæ•ˆåŠæ¶ˆæ¯ã€‚</li></ol><p>ç™¼é€åŠæ¶ˆæ¯æµç¨‹ï¼ŒClientç«¯ä»£ç¢¼åˆ°é€™è£¡å·®ä¸å¤šå°±çµæŸäº†ï¼Œæ¥ä¸‹ä¾†çœ‹çœ‹RocketMQ Serverç«¯æ˜¯å¦‚ä½•è™•ç†çš„</p><p><strong>RocketMQ Server</strong></p><p>Serveråœ¨æ¥æ”¶åˆ°æ¶ˆæ¯éå¾Œæœƒé€²è¡Œä¸€äº›é ˜åŸŸå°è±¡çš„è½‰åŒ–å’Œæ˜¯å¦æ”¯æŒäº‹å‹™æ¶ˆæ¯çš„æ¬Šé™æ ¡é©—ï¼Œå°ç†è§£äº‹å‹™æ¶ˆæ¯ç”¨è™•ä¸å¤§ï¼Œæ­¤è™•å°±çœç•¥å°æ—ææœ«ç¯€çš„ä»‹ç´¹äº†ã€‚ä¸‹é¢æ˜¯TransactionalMessageBridgeé¡è™•ç†half messageçš„æºç¢¼</p><pre>public PutMessageResult putHalfMessage(MessageExtBrokerInner messageInner) { return store.putMessage(parseHalfMessageInner(messageInner));}private MessageExtBrokerInner parseHalfMessageInner(MessageExtBrokerInner msgInner) { MessageAccessor.putProperty(msgInner, MessageConst.PROPERTY_REAL_TOPIC, msgInner.getTopic()); MessageAccessor.putProperty(msgInner, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msgInner.getQueueId())); msgInner.setSysFlag( MessageSysFlag.resetTransactionValue(msgInner.getSysFlag(), MessageSysFlag.TRANSACTION_NOT_TYPE)); msgInner.setTopic(TransactionalMessageUtil.buildHalfTopic()); msgInner.setQueueId(0); msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgInner.getProperties())); return msgInner;}</pre><p>é€™å…©å€‹æ–¹æ³•ä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p><pre>public class Message implements Serializable { private static final long serialVersionUID = 8445773977080406428L; private String topic; private int flag; private Map&lt;String, String&gt; properties; private byte[] body; private String transactionId;}</pre><ol><li>å°‡æ¶ˆæ¯çš„topicï¼ŒqueueIdæ”¾é€²æ¶ˆæ¯é«”è‡ªèº«çš„mapè£¡é€²è¡Œç·©å­˜</li><li>å°‡æ¶ˆæ¯çš„topic è¨­ç½®ç‚ºâ€œRMQ_SYS_TRANS_OP_HALF_TOPICâ€ï¼ŒqueueIdè¨­ç½®ç‚º0</li><li>å°‡æ¶ˆæ¯å¯«å…¥ç£ç›¤æŒä¹…åŒ–</li></ol><p>å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„äº‹å‹™åŠæ¶ˆæ¯éƒ½æœƒè¢«æ”¾é€²åŒä¸€å€‹topicçš„åŒä¸€å€‹queueè£¡é¢ï¼Œé€šéå°topicçš„å€åˆ†ï¼Œå¾è€Œé¿å…äº†åŠæ¶ˆæ¯è¢«consumerçµ¦æ¶ˆè²»åˆ°</p><p>Serverå°‡åŠæ¶ˆæ¯æŒä¹…åŒ–å¾Œç„¶å¾Œæœƒç™¼é€çµæœçµ¦æˆ‘å€‘æœ¬åœ°çš„æ‡‰ç”¨ç¨‹åºã€‚åˆ°äº†é€™è£¡Serverç«¯å°åŠæ¶ˆæ¯çš„è™•ç†å°±çµæŸäº†ï¼Œç·Šæ¥è‘—çš„æ˜¯å®šæ™‚ä»»å‹™çš„ç™»å ´ã€‚</p><p><strong>å®šæ™‚ä»»å‹™å›æŸ¥æµç¨‹</strong></p><p><strong>RocketMQ Server</strong></p><p>å®šæ™‚ä»»å‹™æ˜¯ä¸€å€‹å«TransactionalMessageServiceé¡çš„ç·šç¨‹ï¼Œä¸‹é¢æ˜¯è©²é¡çš„checkæ–¹æ³•</p><pre>@Overridepublic void check(long transactionTimeout, int transactionCheckMax, AbstractTransactionalMessageCheckListener listener) { ... if (!putBackHalfMsgQueue(msgExt, i)) { continue; } listener.resolveHalfMsg(msgExt); } 									...}</pre><p>checkæ–¹æ³•éå¸¸é•·ï¼Œçœç•¥çš„ä»£ç¢¼å¤§è‡´éƒ½æ˜¯å°åŠæ¶ˆæ¯é€²è¡Œéæ¿¾(å¦‚è¶…é72å°æ™‚çš„äº‹å‹™æ¶ˆæ¯ï¼Œå°±è¢«ç®—ä½œéæœŸ)ï¼Œåªä¿ç•™ç¬¦åˆæ¢ä»¶çš„åŠæ¶ˆæ¯å°å…¶é€²è¡Œå›æŸ¥ã€‚</p><p>å…¶ä¸­å¾ˆæœ‰æ„æ€çš„æ˜¯putBackHalfMsgQueueæ–¹æ³•ï¼Œå› ç‚ºæ¯æ¬¡æŠŠåŠæ¶ˆæ¯å¾ç£ç›¤æ‹‰åˆ°å…§å­˜è£¡é€²è¡Œè™•ç†éƒ½æœƒå°å…¶å±¬æ€§é€²è¡Œæ”¹è®Š(ä¾‹å¦‚TRANSACTION_CHECK_TIMESï¼Œé€™æ˜¯æ˜¯å¦ä¸Ÿæ£„äº‹å‹™æ¶ˆæ¯çš„é—œéµä¿¡æ¯)ï¼Œæ‰€ä»¥åœ¨ç™¼é€å›æŸ¥æ¶ˆæ¯ä¹‹å‰éœ€è¦å°åŠæ¶ˆæ¯å†æ¬¡æ”¾é€²ç£ç›¤ã€‚RocketMQæ¡å–çš„æ–¹æ³•æ˜¯åŸºæ–¼æœ€æ–°çš„ç‰©ç†åç§»é‡<strong>é‡æ–°å¯«å…¥</strong>ï¼Œè€Œä¸æ˜¯å°åŸæœ‰çš„åŠæ¶ˆæ¯é€²è¡Œ<strong>ä¿®æ”¹</strong>ï¼Œå…¶ä¸­çš„ç›®çš„å°±æ˜¯RocketMQçš„å­˜å„²è¨­è¨ˆæ¡ç”¨é †åºå¯«ï¼Œå¦‚æœå»ä¿®æ”¹æ¶ˆæ¯ ï¼Œç„¡æ³•åšåˆ°é«˜æ€§èƒ½ã€‚</p><p>ä¸‹é¢æ˜¯resolveHalfMsgæ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯é–‹å•Ÿä¸€å€‹ç·šç¨‹ç„¶å¾Œç™¼é€checkæ¶ˆæ¯ã€‚</p><pre>public void resolveHalfMsg(final MessageExt msgExt) { executorService.execute(new Runnable() { @Override public void run() { try { sendCheckMessage(msgExt); } catch (Exception e) { LOGGER.error("Send check message error!", e); } } });}</pre><p><strong>æœ¬åœ°æ‡‰ç”¨(client)</strong></p><p>ä¸‹é¢æ˜¯DefaultMQProducerImplçš„checkTransactionStateæ–¹æ³•ï¼Œæ˜¯æœ¬åœ°æ‡‰ç”¨å°å›æŸ¥æ¶ˆæ¯çš„è™•ç†é‚è¼¯</p><pre>@Overridepublic void checkTransactionState(final String addr, final MessageExt msg, final CheckTransactionStateRequestHeader header) { Runnable request = new Runnable() { ... @Override public void run() { ... TransactionListener transactionListener = getCheckListener(); ... localTransactionState = transactionListener.checkLocalTransaction(message); ...  this.processTransactionState( localTransactionState, group, exception);  }  private void processTransactionState( ... DefaultMQProducerImpl.this.mQClientFactory.getMQClientAPIImpl().endTransactionOneway(brokerAddr, thisHeader, remark, 3000); ... } }; this.checkExecutor.submit(request);}</pre><p>ç²¾ç°¡ä»£ç¢¼é‚è¼¯å¾Œå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°</p><ul><li>é–‹å•Ÿä¸€å€‹ç·šç¨‹ä¾†åŸ·è¡Œå›æŸ¥çš„é‚è¼¯</li><li>é€šéåŸ·è¡ŒtransactionListenerçš„checkLocalTransactionæ–¹æ³•ä¾†ç²å–æœ¬åœ°äº‹å‹™åŸ·è¡Œçš„çµæœ</li></ul><p><strong>RocketMQ Server</strong></p><p>RocketMQ æœå‹™å™¨åœ¨æ”¶åˆ°Clientç™¼éä¾†çš„Commitæ¶ˆæ¯å¾Œæœƒ</p><p>è®€å‡ºåŠæ¶ˆæ¯â€”â€”>æ¢å¾©topicç­‰åŸæ¶ˆæ¯é«”çš„ä¿¡æ¯â€”â€”>å’Œæ™®é€šæ¶ˆæ¯ä¸€æ¨£å†æ¬¡å¯«å…¥ç£ç›¤â€”â€”>åˆªé™¤ä¹‹å‰çš„åŠæ¶ˆæ¯</p><p>å¦‚æœæ˜¯Rollbackæ¶ˆæ¯å‰‡ç›´æ¥åˆªé™¤ä¹‹å‰çš„åŠæ¶ˆæ¯</p><p>åˆ°æ­¤ï¼Œæ•´æ¢RocketMQ äº‹å‹™æ¶ˆæ¯çš„èª¿ç”¨éˆå°±çµæŸäº†</p><h1><strong>æ€è€ƒ</strong></h1><p><strong>1. åˆ†ä½ˆå¼äº‹å‹™ç­‰æ–¼äº‹å‹™æ¶ˆæ¯å—ï¼Ÿ</strong></p><p>å…©è€…ä¸¦æ²’æœ‰é—œä¿‚ï¼Œäº‹å‹™æ¶ˆæ¯åƒ…åƒ…ä¿è­‰æœ¬åœ°äº‹å‹™å’ŒMQæ¶ˆæ¯ç™¼é€å½¢æˆæ•´é«”çš„åŸå­æ€§ï¼Œè€ŒæŠ•éåˆ°MQæœå‹™å™¨å¾Œï¼Œæ¶ˆè²»è€…æ˜¯å¦èƒ½ä¸€å®šæ¶ˆè²»æˆåŠŸæ˜¯ç„¡æ³•ä¿è­‰çš„ã€‚</p><p><strong>2. æºç¢¼è¨­è¨ˆä¸Šæœ‰ä»€éº¼äº®é»å—ï¼Ÿ</strong></p><p>é€šéå°æ•´æ¢éˆè·¯æºç¢¼çš„å­¸ç¿’ç†è§£ç™¼ç¾é‚„æ˜¯æœ‰ä¸å°‘äº®é»çš„</p><ul><li>serverç«¯å›æŸ¥æ¶ˆæ¯çš„ç™¼é€ï¼Œclientç«¯å›æŸ¥æ¶ˆæ¯é‚è¼¯çš„è™•ç†ï¼Œclientç«¯commit/rollbackæ¶ˆæ¯çš„æäº¤éƒ½æ˜¯ç”¨äº†ç•°æ­¥é€²è¡Œï¼Œå¯ä»¥èªªèƒ½ç•°æ­¥çš„åœ°æ–¹éƒ½ç”¨äº†ç•°æ­¥ï¼Œé€šéç•°æ­¥+é‡è©¦çš„æ–¹å¼ä¿è­‰äº†åœ¨åˆ†ä½ˆå¼ç’°å¢ƒä¸­å³ä½¿çŸ­æš«çš„ç¶²çµ¡ç‹€æ³ä¸è‰¯å¥½ï¼Œä¹Ÿä¸æœƒå½±éŸ¿æ•´é«”é‚è¼¯ã€‚</li><li>å¼•å…¥TransactionListenerï¼ŒçœŸæ­£åšåˆ°äº†é–‹é–‰åŸå‰‡ä»¥åŠä¾è³´å€’ç½®åŸå‰‡ï¼Œé¢å‘æ¥å£ç·¨ç¨‹ã€‚æ•´é«”æ“´å±•æ€§åšå¾—éå¸¸å¥½ï¼Œä½¿ç”¨è€…åªéœ€è¦ç·¨å¯«è‡ªå·±çš„Listenerå°±å¯ä»¥åšåˆ°äº‹å‹™æ¶ˆæ¯çš„ç™¼é€ï¼Œéå¸¸æ–¹ä¾¿</li><li>TransactionMQProduceré€šéç¹¼æ‰¿DefaultMQProduceræ¥µå¤§åœ°è¤‡ç”¨äº†é—œæ–¼ç™¼é€æ¶ˆæ¯ç›¸é—œçš„é‚è¼¯</li></ul><p><strong>3. æºç¢¼è¨­è¨ˆä¸Šæœ‰ä»€éº¼ä¸è¶³å—ï¼Ÿ</strong></p><p>RocketMQä½œç‚ºä¸€æ¬¾æ¥µå…¶æˆåŠŸçš„æ¶ˆæ¯ä¸­é–“ä»¶ï¼Œè¦ç™¼ç¾ä¸è¶³ä¸æ˜¯é‚£éº¼å®¹æ˜“äº†ï¼Œç­†è€…è«‡å¹¾é»çœ‹æ³•</p><ul><li>sendMessageIntransactionç­‰äº‹å‹™ç›¸é—œçš„æ–¹æ³•è¢«åŠƒåˆ†åœ¨äº†DefaultMQProducerè£¡é¢ï¼Œå¾å…§èšçš„è§’åº¦ä¾†èªªé€™æ˜¯è·Ÿäº‹å‹™ç›¸é—œçš„ç™¼é€æ¶ˆæ¯æ–¹æ³•æ‡‰è©²è¢«åŠƒåˆ†åœ¨TransactionMQProducerã€‚</li><li>æ‰€æœ‰topicçš„åŠæ¶ˆæ¯éƒ½æœƒå¯«åœ¨topicç‚ºRMQ_SYS_TRANS_OP_HALF_TOPICçš„åŠæ¶ˆæ¯éšŠåˆ—è£¡ï¼Œä¸¦ä¸”æ¯æ¢åŠæ¶ˆæ¯ï¼Œåœ¨æ•´å€‹éˆè·¯è£¡æœƒè¢«å¯«å¤šæ¬¡ï¼Œå¦‚æœä½µç™¼å¾ˆå¤§ä¸”å¤§éƒ¨åˆ†æ¶ˆæ¯éƒ½æ˜¯äº‹å‹™æ¶ˆæ¯çš„è©±ï¼Œå¯é æ€§æœƒå­˜åœ¨å•é¡Œã€‚</li></ul></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>RocketMQ</a></li><li><a>äº‹å‹™</a></li><li><a>æºç¢¼</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E9%81%8A%E6%88%B2/3ff1309.html alt="åŸºæ–¼RocketMQåˆ†ä½ˆå¼äº‹å‹™ - å®Œæ•´ç¤ºä¾‹" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/pgc-image/388a9665bf45413eb391e47c6d10ca12 style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/3ff1309.html title="åŸºæ–¼RocketMQåˆ†ä½ˆå¼äº‹å‹™ - å®Œæ•´ç¤ºä¾‹">åŸºæ–¼RocketMQåˆ†ä½ˆå¼äº‹å‹™ - å®Œæ•´ç¤ºä¾‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3c09a7c2.html alt=ç¶²ç«™æºç¢¼ï¼Œæœå‹™å™¨ï¼ŒåŸŸåä¸‰è€…æ˜¯ä»€éº¼é—œä¿‚ï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/S1xQDgS3bmZd8q style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3c09a7c2.html title=ç¶²ç«™æºç¢¼ï¼Œæœå‹™å™¨ï¼ŒåŸŸåä¸‰è€…æ˜¯ä»€éº¼é—œä¿‚ï¼Ÿ>ç¶²ç«™æºç¢¼ï¼Œæœå‹™å™¨ï¼ŒåŸŸåä¸‰è€…æ˜¯ä»€éº¼é—œä¿‚ï¼Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html alt="MySQL äº‹å‹™è™•ç†" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html title="MySQL äº‹å‹™è™•ç†">MySQL äº‹å‹™è™•ç†</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html alt=MySQLâ€”â€”äº‹å‹™(Transaction)è©³è§£ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/29d4c92c9c2344838eb72ef948cf08fa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html title=MySQLâ€”â€”äº‹å‹™(Transaction)è©³è§£>MySQLâ€”â€”äº‹å‹™(Transaction)è©³è§£</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html alt=MySQLæ•¸æ“šåº«çš„äº‹å‹™ç®¡ç† class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/152203544367254a708f807 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html title=MySQLæ•¸æ“šåº«çš„äº‹å‹™ç®¡ç†>MySQLæ•¸æ“šåº«çš„äº‹å‹™ç®¡ç†</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8293e598.html alt=MySQläº‹å‹™æœ€å…¨è©³è§£ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c61163c863114226b14bb3760da19e4d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8293e598.html title=MySQläº‹å‹™æœ€å…¨è©³è§£>MySQläº‹å‹™æœ€å…¨è©³è§£</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/011d2da0.html alt=MySqlä½µç™¼èˆ‡äº‹å‹™çš„è™•ç† class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/f13d8a1e-5e60-4b48-90bc-3c26e312a208 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/011d2da0.html title=MySqlä½µç™¼èˆ‡äº‹å‹™çš„è™•ç†>MySqlä½µç™¼èˆ‡äº‹å‹™çš„è™•ç†</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4ab1dd0d.html alt=Mysqläº‹å‹™ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4ab1dd0d.html title=Mysqläº‹å‹™>Mysqläº‹å‹™</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cb944fe7.html alt=Mysqläº‹å‹™è©³è§£(ä¸€æ–‡è®€æ‡‚æ•¸æ“šåº«äº‹å‹™) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/cb7ba6cbda8c44438d9d3d7c57bd25b9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cb944fe7.html title=Mysqläº‹å‹™è©³è§£(ä¸€æ–‡è®€æ‡‚æ•¸æ“šåº«äº‹å‹™)>Mysqläº‹å‹™è©³è§£(ä¸€æ–‡è®€æ‡‚æ•¸æ“šåº«äº‹å‹™)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e9d6f488.html alt="SQL Serverä¸­çš„äº‹å‹™ï¼ˆé™„æœ‰å¯¦ä¾‹ï¼‰" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/21e047bd6e3c41fba0beac7ef3f1ce4e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e9d6f488.html title="SQL Serverä¸­çš„äº‹å‹™ï¼ˆé™„æœ‰å¯¦ä¾‹ï¼‰">SQL Serverä¸­çš„äº‹å‹™ï¼ˆé™„æœ‰å¯¦ä¾‹ï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bb071e7e.html alt="SQL äº‹å‹™æ©Ÿåˆ¶-transaction" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3231427d97bf4a04b148360fea032241 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bb071e7e.html title="SQL äº‹å‹™æ©Ÿåˆ¶-transaction">SQL äº‹å‹™æ©Ÿåˆ¶-transaction</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/44c014a1.html alt=SpringBootäº‹å‹™è©³ç´°ç°¡ä»‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/44c014a1.html title=SpringBootäº‹å‹™è©³ç´°ç°¡ä»‹>SpringBootäº‹å‹™è©³ç´°ç°¡ä»‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/24b98634.html alt=SqlServerä½¿ç”¨äº‹å‹™æ³¨æ„äº‹é …ï¼Œé«˜ç´šç¨‹åºå“¡å¿…èƒŒ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/24b98634.html title=SqlServerä½¿ç”¨äº‹å‹™æ³¨æ„äº‹é …ï¼Œé«˜ç´šç¨‹åºå“¡å¿…èƒŒ>SqlServerä½¿ç”¨äº‹å‹™æ³¨æ„äº‹é …ï¼Œé«˜ç´šç¨‹åºå“¡å¿…èƒŒ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/090306a0.html alt="[Spring] æ·±å…¥ç­è§£äº‹å‹™åŸç†" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/a8c6dbd7c51741f5a76262e8e2c7a670 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/090306a0.html title="[Spring] æ·±å…¥ç­è§£äº‹å‹™åŸç†">[Spring] æ·±å…¥ç­è§£äº‹å‹™åŸç†</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html alt="ã€Œè­¯ã€ Spring çš„åˆ†ä½ˆå¼äº‹å‹™å¯¦ç¾â€”ä½¿ç”¨å’Œä¸ä½¿ç”¨ XAâ€”ç¬¬äºŒéƒ¨åˆ†" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html title="ã€Œè­¯ã€ Spring çš„åˆ†ä½ˆå¼äº‹å‹™å¯¦ç¾â€”ä½¿ç”¨å’Œä¸ä½¿ç”¨ XAâ€”ç¬¬äºŒéƒ¨åˆ†">ã€Œè­¯ã€ Spring çš„åˆ†ä½ˆå¼äº‹å‹™å¯¦ç¾â€”ä½¿ç”¨å’Œä¸ä½¿ç”¨ XAâ€”ç¬¬äºŒéƒ¨åˆ†</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>