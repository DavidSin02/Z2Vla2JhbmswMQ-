<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>超詳細的FreeRTOS移植全教程——基於stm32 | 极客快訊</title><meta property="og:title" content="超詳細的FreeRTOS移植全教程——基於stm32 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/75da9e40c2604f39877a41d2bb424f0c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/160d0f4.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/160d0f4.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/160d0f4.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/160d0f4.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/160d0f4.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/160d0f4.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/160d0f4.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/160d0f4.html><meta property="article:published_time" content="2020-10-29T20:53:12+08:00"><meta property="article:modified_time" content="2020-10-29T20:53:12+08:00"><meta name=Keywords content><meta name=description content="超詳細的FreeRTOS移植全教程——基於stm32"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/160d0f4.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>超詳細的FreeRTOS移植全教程——基於stm32</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>準備</p><p>在移植之前，我們首先要獲取到FreeRTOS的官方的源碼包。這裡我們提供兩個下載鏈接:</p><blockquote><p>一個是官網：http://www.freertos.org/</p><p>另外一個是代碼託管網站：https://sourceforge.net/projects/freertos/files/FreeRTOS/</p></blockquote><p>這裡我們演示如何在代碼託管網站裡面下載。打開網站鏈接之後，我們選擇FreeRTOS的最新版本V9.0.0（2016年），儘管現在FreeRTOS的版本已經更新到V10.0.1了，但是我們還是選擇V9.0.0，因為內核很穩定，並且網上資料很多，因為V10.0.0版本之後是亞馬遜收購了FreeRTOS之後才出來的版本，主要添加了一些雲端組件，我們本書所講的FreeRTOS是實時內核，採用V9.0.0版本足以。</p><p>簡單介紹FreeRTOS</p><p>FreeRTOS包含Demo例程和內核源碼（比較重要，我們就需要提取該目錄下的大部分文件）。<strong>Source</strong>文件夾裡面包含的是FreeRTOS內核的源代碼，我們移植FreeRTOS的時候就需要這部分源代碼；<strong>Demo</strong> 文件夾裡面包含了FreeRTOS官方為各個單片機移植好的工程代碼，FreeRTOS為了推廣自己，會給各種半導體廠商的評估板寫好完整的工程程序，這些程序就放在Demo這個目錄下，這部分Demo非常有參考價值。</p><div class=pgc-img><img alt=超詳細的FreeRTOS移植全教程——基於stm32 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/75da9e40c2604f39877a41d2bb424f0c></div><p>Source文件夾</p><p>這裡我們再重點分析下FreeRTOS/ Source文件夾下的文件，①和③包含的是FreeRTOS的通用的頭文件和C文件，這兩部分的文件試用於各種編譯器和處理器，是通用的。需要移植的頭文件和C文件放在②portblle這個文件夾。</p><div class=pgc-img><img alt=超詳細的FreeRTOS移植全教程——基於stm32 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9ce584d1e4794d6fb05e47327334237c></div><p>portblle文件夾，是與編譯器相關的文件夾，在不同的編譯器中使用不同的支持文件。①中的KEIL就是我們就是我們使用的編譯器，其實KEIL裡面的內容跟RVDS裡面的內容一樣，所以我們只需要③RVDS文件夾裡面的內容即可，裡面包含了各種處理器相關的文件夾，從文件夾的名字我們就非常熟悉了，我們學習的STM32有M0、M3、M4等各種系列，FreeRTOS是一個軟件，單片機是一個硬件，FreeRTOS要想運行在一個單片機上面，它們就必須關聯在一起。MemMang文件夾下存放的是跟內存管理相關的源文件。</p><div class=pgc-img><img alt=超詳細的FreeRTOS移植全教程——基於stm32 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d9bf183be5474ea8882995ca83104909></div><p>移植過程</p><p>提取源碼</p><ol><li>首先在我們的STM32裸機工程模板根目錄下新建一個文件夾，命名為“FreeRTOS”，並且在FreeRTOS文件夾下新建兩個空文件夾，分別命名為“src”與“port”，src文件夾用於保存FreeRTOS中的核心源文件，也就是我們常說的‘.c文件’，port文件夾用於保存內存管理以及處理器架構相關代碼，這些代碼FreeRTOS官方已經提供給我們的，直接使用即可，在前面已經說了，FreeRTOS是軟件，我們的開發版是硬件，軟硬件必須有橋樑來連接，這些與處理器架構相關的代碼，可以稱之為RTOS硬件接口層，它們位於FreeRTOS/Source/Portable文件夾下。</li><li>打開FreeRTOS V9.0.0源碼，在“FreeRTOSv9.0.0FreeRTOSSource”目錄下找到所有的‘.c文件’，將它們拷貝到我們新建的src文件夾中，</li></ol><div class=pgc-img><img alt=超詳細的FreeRTOS移植全教程——基於stm32 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/20a58452c3734e93bf8e9daa86ce743d></div><ol><li>打開FreeRTOS V9.0.0源碼，在“FreeRTOSv9.0.0FreeRTOSSourceportable”目錄下找到“MemMang”文件夾與“RVDS”文件夾，將它們拷貝到我們新建的port文件夾中</li></ol><div class=pgc-img><img alt=超詳細的FreeRTOS移植全教程——基於stm32 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bea10aaebf1549cba81f2272388a748f></div><ol><li>打開FreeRTOS V9.0.0源碼，在“FreeRTOSv9.0.0 FreeRTOSSource”目錄下找到“include”文件夾，它是我們需要用到FreeRTOS的一些頭文件，將它直接拷貝到我們新建的FreeRTOS文件夾中，完成這一步之後就可以看到我們新建的FreeRTOS文件夾已經有3個文件夾，這3個文件夾就包含FreeRTOS的核心文件，至此，FreeRTOS的源碼就提取完成。</li></ol><div class=pgc-img><img alt=超詳細的FreeRTOS移植全教程——基於stm32 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6d174d27cba840ce99b0fbbad4668b2a></div><p>添加到工程</p><p><strong>添加FreeRTOSConfig.h文件</strong>FreeRTOSConfig.h文件是FreeRTOS的工程配置文件，因為FreeRTOS是可以裁剪的實時操作內核，應用於不同的處理器平臺，用戶可以通過修改這個FreeRTOS內核的配置頭文件來裁剪FreeRTOS的功能，所以我們把它拷貝一份放在user這個文件夾下面。打開FreeRTOSv9.0.0源碼，在“FreeRTOSv9.0.0FreeRTOSDemo”文件夾下面找到“CORTEXSTM32F103Keil”這個文件夾，雙擊打開，在其根目錄下找到這個“FreeRTOSConfig.h”文件，然後拷貝到我們工程的user文件夾下即可，等下我們需要對這個文件進行修改。</p><p><strong>創建工程分組</strong>接下來我們在mdk裡面新建FreeRTOS/src和FreeRTOS/port兩個組文件夾，其中FreeRTOS/src用於存放src文件夾的內容，FreeRTOS/port用於存放portMemMang文件夾 與portRVDSARM_CM3文件夾的內容。然後我們將工程文件中FreeRTOS的內容添加到工程中去，按照已經新建的分組添加我們的FreeRTOS工程源碼。在FreeRTOS/port分組中添加MemMang文件夾中的文件只需選擇其中一個即可，我們選擇“heap_4.c”，這是FreeRTOS的一個內存管理源碼文件。添加完成後：</p><div class=pgc-img><img alt=超詳細的FreeRTOS移植全教程——基於stm32 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/732e097ba22f4d71bcac0d808cb204be></div><p><strong>添加頭文件路徑</strong>FreeRTOS的源碼已經添加到開發環境的組文件夾下面，編譯的時候需要為這些源文件指定頭文件的路徑，不然編譯會報錯。FreeRTOS的源碼裡面只有FreeRTOSinclude和FreeRTOSportRVDSARM_CM3這兩個文件夾下面有頭文件，只需要將這兩個頭文件的路徑在開發環境裡面指定即可。同時我們還將FreeRTOSConfig.h這個頭文件拷貝到了工程根目錄下的user文件夾下，所以user的路徑也要加到開發環境裡面。</p><div class=pgc-img><img alt=超詳細的FreeRTOS移植全教程——基於stm32 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b3d516221566492f9b9d4c5f3c6ff183></div><p>修改FreeRTOSConfig.h</p><p>FreeRTOSConfig.h是直接從demo文件夾下面拷貝過來的，該頭文件對裁剪整個FreeRTOS所需的功能的宏均做了定義，有些宏定義被使能，有些宏定義被失能，一開始我們只需要配置最簡單的功能即可。要想隨心所欲的配置FreeRTOS的功能，我們必須對這些宏定義的功能有所掌握，下面我們先簡單的介紹下這些宏定義的含義，然後再對這些宏定義進行修改。</p><p>#ifndef FREERTOS_CONFIG_H</p><p>#define FREERTOS_CONFIG_H</p><p>#include "stm32f10x.h"</p><p>#include "bsp_usart.h"</p><p>//針對不同的編譯器調用不同的stdint.h文件</p><p>#if defined(__ICCARM__) || defined(__CC_ARM) || defined(__GNUC__)</p><p>#include &lt;stdint.h></p><p>extern uint32_t SystemCoreClock;</p><p>#endif</p><p>//斷言</p><p>#define vAssertCalled(char,int) printf("Error:%s,%d\r\n",char,int)</p><p>#define configASSERT(x) if((x)==0) vAssertCalled(__FILE__,__LINE__)</p><p>/************************************************************************</p><p>* FreeRTOS基礎配置配置選項</p><p>*********************************************************************/</p><p>/* 置1：RTOS使用搶佔式調度器；置0：RTOS使用協作式調度器（時間片）</p><p>*</p><p>* 注：在多任務管理機制上，操作系統可以分為搶佔式和協作式兩種。</p><p>* 協作式操作系統是任務主動釋放CPU後，切換到下一個任務。</p><p>* 任務切換的時機完全取決於正在運行的任務。</p><p>*/</p><p>#define configUSE_PREEMPTION 1</p><p>//1使能時間片調度(默認式使能的)</p><p>#define configUSE_TIME_SLICING 1</p><p>/* 某些運行FreeRTOS的硬件有兩種方法選擇下一個要執行的任務：</p><p>* 通用方法和特定於硬件的方法（以下簡稱“特殊方法”）。</p><p>*</p><p>* 通用方法：</p><p>* 1.configUSE_PORT_OPTIMISED_TASK_SELECTION 為 0 或者硬件不支持這種特殊方法。</p><p>* 2.可以用於所有FreeRTOS支持的硬件</p><p>* 3.完全用C實現，效率略低於特殊方法。</p><p>* 4.不強制要求限制最大可用優先級數目</p><p>* 特殊方法：</p><p>* 1.必須將configUSE_PORT_OPTIMISED_TASK_SELECTION設置為1。</p><p>* 2.依賴一個或多個特定架構的彙編指令（一般是類似計算前導零[CLZ]指令）。</p><p>* 3.比通用方法更高效</p><p>* 4.一般強制限定最大可用優先級數目為32</p><p>* 一般是硬件計算前導零指令，如果所使用的，MCU沒有這些硬件指令的話此宏應該設置為0！</p><p>*/</p><p>#define configUSE_PORT_OPTIMISED_TASK_SELECTION 1</p><p>/* 置1：使能低功耗tickless模式；置0：保持系統節拍（tick）中斷一直運行</p><p>* 假設開啟低功耗的話可能會導致下載出現問題，因為程序在睡眠中,可用以下辦法解決</p><p>*</p><p>* 下載方法：</p><p>* 1.將開發版正常連接好</p><p>* 2.按住復位按鍵，點擊下載瞬間鬆開復位按鍵</p><p>*</p><p>* 1.通過跳線帽將 BOOT 0 接高電平(3.3V)</p><p>* 2.重新上電，下載</p><p>*</p><p>* 1.使用FlyMcu擦除一下芯片，然後進行下載</p><p>* STMISP -> 清除芯片(z)</p><p>*/</p><p>#define configUSE_TICKLESS_IDLE 0</p><p>/*</p><p>* 寫入實際的CPU內核時鐘頻率，也就是CPU指令執行頻率，通常稱為Fclk</p><p>* Fclk為供給CPU內核的時鐘信號，我們所說的cpu主頻為 XX MHz，</p><p>* 就是指的這個時鐘信號，相應的，1/Fclk即為cpu時鐘週期；</p><p>*/</p><p>#define configCPU_CLOCK_HZ (SystemCoreClock)</p><p>//RTOS系統節拍中斷的頻率。即一秒中斷的次數，每次中斷RTOS都會進行任務調度</p><p>#define configTICK_RATE_HZ (( TickType_t )1000)</p><p>//可使用的最大優先級</p><p>#define configMAX_PRIORITIES (32)</p><p>//空閒任務使用的堆棧大小</p><p>#define configMINIMAL_STACK_SIZE ((unsigned short)128)</p><p>//任務名字字符串長度</p><p>#define configMAX_TASK_NAME_LEN (16)</p><p>//系統節拍計數器變量數據類型，1表示為16位無符號整形，0表示為32位無符號整形</p><p>#define configUSE_16_BIT_TICKS 0</p><p>//空閒任務放棄CPU使用權給其他同優先級的用戶任務</p><p>#define configIDLE_SHOULD_YIELD 1</p><p>//啟用隊列</p><p>#define configUSE_QUEUE_SETS 1</p><p>//開啟任務通知功能，默認開啟</p><p>#define configUSE_TASK_NOTIFICATIONS 1</p><p>//使用互斥信號量</p><p>#define configUSE_MUTEXES 1</p><p>//使用遞歸互斥信號量</p><p>#define configUSE_RECURSIVE_MUTEXES 1</p><p>//為1時使用計數信號量</p><p>#define configUSE_COUNTING_SEMAPHORES 1</p><p>/* 設置可以註冊的信號量和消息隊列個數 */</p><p>#define configQUEUE_REGISTRY_SIZE 10</p><p>#define configUSE_APPLICATION_TASK_TAG 0</p><p>/*****************************************************************</p><p>FreeRTOS與內存申請有關配置選項</p><p>*****************************************************************/</p><p>//支持動態內存申請</p><p>#define configSUPPORT_DYNAMIC_ALLOCATION 1</p><p>//支持靜態內存</p><p>#define configSUPPORT_STATIC_ALLOCATION 0</p><p>//系統所有總的堆大小</p><p>#define configTOTAL_HEAP_SIZE ((size_t)(36*1024))</p><p>/***************************************************************</p><p>FreeRTOS與鉤子函數有關的配置選項</p><p>**************************************************************/</p><p>/* 置1：使用空閒鉤子（Idle Hook類似於回調函數）；置0：忽略空閒鉤子</p><p>*</p><p>* 空閒任務鉤子是一個函數，這個函數由用戶來實現，</p><p>* FreeRTOS規定了函數的名字和參數：void vApplicationIdleHook(void )，</p><p>* 這個函數在每個空閒任務週期都會被調用</p><p>* 對於已經刪除的RTOS任務，空閒任務可以釋放分配給它們的堆棧內存。</p><p>* 因此必須保證空閒任務可以被CPU執行</p><p>* 使用空閒鉤子函數設置CPU進入省電模式是很常見的</p><p>* 不可以調用會引起空閒任務阻塞的API函數</p><p>*/</p><p>#define configUSE_IDLE_HOOK 0</p><p>/* 置1：使用時間片鉤子（Tick Hook）；置0：忽略時間片鉤子</p><p>*</p><p>*</p><p>* 時間片鉤子是一個函數，這個函數由用戶來實現，</p><p>* FreeRTOS規定了函數的名字和參數：void vApplicationTickHook(void )</p><p>* 時間片中斷可以週期性的調用</p><p>* 函數必須非常短小，不能大量使用堆棧，</p><p>* 不能調用以”FromISR" 或 "FROM_ISR”結尾的API函數</p><p>*/</p><p>/*xTaskIncrementTick函數是在xPortSysTickHandler中斷函數中被調用的。因此，vApplicationTickHook()函數執行的時間必須很短才行*/</p><p>#define configUSE_TICK_HOOK 0</p><p>//使用內存申請失敗鉤子函數</p><p>#define configUSE_MALLOC_FAILED_HOOK 0</p><p>/*</p><p>* 大於0時啟用堆棧溢出檢測功能，如果使用此功能</p><p>* 用戶必須提供一個棧溢出鉤子函數，如果使用的話</p><p>* 此值可以為1或者2，因為有兩種棧溢出檢測方法 */</p><p>#define configCHECK_FOR_STACK_OVERFLOW 0</p><p>/********************************************************************</p><p>FreeRTOS與運行時間和任務狀態收集有關的配置選項</p><p>**********************************************************************/</p><p>//啟用運行時間統計功能</p><p>#define configGENERATE_RUN_TIME_STATS 0</p><p>//啟用可視化跟蹤調試</p><p>#define configUSE_TRACE_FACILITY 0</p><p>/* 與宏configUSE_TRACE_FACILITY同時為1時會編譯下面3個函數</p><p>* prvWriteNameToBuffer()</p><p>* vTaskList(),</p><p>* vTaskGetRunTimeStats()</p><p>*/</p><p>#define configUSE_STATS_FORMATTING_FUNCTIONS 1</p><p>/********************************************************************</p><p>FreeRTOS與協程有關的配置選項</p><p>*********************************************************************/</p><p>//啟用協程，啟用協程以後必須添加文件croutine.c</p><p>#define configUSE_CO_ROUTINES 0</p><p>//協程的有效優先級數目</p><p>#define configMAX_CO_ROUTINE_PRIORITIES ( 2 )</p><p>/***********************************************************************</p><p>FreeRTOS與軟件定時器有關的配置選項</p><p>**********************************************************************/</p><p>//啟用軟件定時器</p><p>#define configUSE_TIMERS 1</p><p>//軟件定時器優先級</p><p>#define configTIMER_TASK_PRIORITY (configMAX_PRIORITIES-1)</p><p>//軟件定時器隊列長度</p><p>#define configTIMER_QUEUE_LENGTH 10</p><p>//軟件定時器任務堆棧大小</p><p>#define configTIMER_TASK_STACK_DEPTH (configMINIMAL_STACK_SIZE*2)</p><p>/************************************************************</p><p>FreeRTOS可選函數配置選項</p><p>************************************************************/</p><p>#define INCLUDE_xTaskGetSchedulerState 1</p><p>#define INCLUDE_vTaskPrioritySet 1</p><p>#define INCLUDE_uxTaskPriorityGet 1</p><p>#define INCLUDE_vTaskDelete 1</p><p>#define INCLUDE_vTaskCleanUpResources 1</p><p>#define INCLUDE_vTaskSuspend 1</p><p>#define INCLUDE_vTaskDelayUntil 1</p><p>#define INCLUDE_vTaskDelay 1</p><p>#define INCLUDE_eTaskGetState 1</p><p>#define INCLUDE_xTimerPendFunctionCall 1</p><p>//#define INCLUDE_xTaskGetCurrentTaskHandle 1</p><p>//#define INCLUDE_uxTaskGetStackHighWaterMark 0</p><p>//#define INCLUDE_xTaskGetIdleTaskHandle 0</p><p>/******************************************************************</p><p>FreeRTOS與中斷有關的配置選項</p><p>******************************************************************/</p><p>#ifdef __NVIC_PRIO_BITS</p><p>#define configPRIO_BITS __NVIC_PRIO_BITS</p><p>#else</p><p>#define configPRIO_BITS 4</p><p>#endif</p><p>//中斷最低優先級</p><p>#define configLIBRARY_LOWEST_INTERRUPT_PRIORITY 15</p><p>//系統可管理的最高中斷優先級</p><p>#define configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY 5</p><p>#define configKERNEL_INTERRUPT_PRIORITY ( configLIBRARY_LOWEST_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS) ) /* 240 */</p><p>#define configMAX_SYSCALL_INTERRUPT_PRIORITY ( configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS) )</p><p>/****************************************************************</p><p>FreeRTOS與中斷服務函數有關的配置選項</p><p>****************************************************************/</p><p>#define xPortPendSVHandler PendSV_Handler</p><p>#define vPortSVCHandler SVC_Handler</p><p>/* 以下為使用Percepio Tracealyzer需要的東西，不需要時將 configUSE_TRACE_FACILITY 定義為 0 */</p><p>#if ( configUSE_TRACE_FACILITY == 1 )</p><p>#include "trcRecorder.h"</p><p>#define INCLUDE_xTaskGetCurrentTaskHandle 1 // 啟用一個可選函數（該函數被 Trace源碼使用，默認該值為0 表示不用）</p><p>#endif</p><p>#endif /* FREERTOS_CONFIG_H */</p><p>修改stm32f10x_it.c</p><p>SysTick中斷服務函數是一個非常重要的函數，FreeRTOS所有跟時間相關的事情都在裡面處理，SysTick就是FreeRTOS的一個心跳時鐘，驅動著FreeRTOS的運行，就像人的心跳一樣，假如沒有心跳，我們就相當於“死了”，同樣的，FreeRTOS沒有了心跳，那麼它就會卡死在某個地方，不能進行任務調度，不能運行任何的東西，因此我們需要實現一個FreeRTOS的心跳時鐘，FreeRTOS幫我們實現了SysTick的啟動的配置：在port.c文件中已經實現vPortSetupTimerInterrupt()函數，並且FreeRTOS通用的SysTick中斷服務函數也實現了：在port.c文件中已經實現xPortSysTickHandler()函數，所以移植的時候只需要我們在stm32f10xit.c文件中實現我們對應（STM32）平臺上的SysTickHandler()函數即可。FreeRTOS為開發者考慮得特別多，PendSVHandler()與SVCHandler()這兩個很重要的函數都幫我們實現了，在在port.c文件中已經實現xPortPendSVHandler()與vPortSVCHandler()函數，防止我們自己實現不了，那麼在stm32f10xit.c中就需要我們註釋掉PendSVHandler()與SVC_Handler()這兩個函數了。</p><p>//void SVC_Handler(void)</p><p>//{</p><p>//}</p><p>//void PendSV_Handler(void)</p><p>//{</p><p>//}</p><p>extern void xPortSysTickHandler(void);</p><p>//systick中斷服務函數</p><p>void SysTick_Handler(void)</p><p>{</p><p>#if (INCLUDE_xTaskGetSchedulerState == 1 )</p><p>if (xTaskGetSchedulerState() != taskSCHEDULER_NOT_STARTED)</p><p>{</p><p>#endif /* INCLUDE_xTaskGetSchedulerState */</p><p>xPortSysTickHandler();</p><p>#if (INCLUDE_xTaskGetSchedulerState == 1 )</p><p>}</p><p>#endif /* INCLUDE_xTaskGetSchedulerState */</p><p>}</p><p>創建任務</p><p>這裡，我們創建一個單任務，任務使用的棧和任務控制塊是在創建任務的時候FreeRTOS動態分配的。任務必須是一個死循環，否則任務將通過LR返回，如果LR指向了非法的內存就會產生HardFault_Handler，而FreeRTOS指向一個死循環，那麼任務返回之後就在死循環中執行，這樣子的任務是不安全的，所以避免這種情況，任務一般都是死循環並且無返回值的。<strong>並且每個任務循環主體中應該有阻塞任務的函數，否則就會餓死比它優先級更低的任務！！！</strong></p><p>/* FreeRTOS頭文件 */</p><p>#include "FreeRTOS.h"</p><p>#include "task.h"</p><p>/* 開發板硬件bsp頭文件 */</p><p>#include "bsp_led.h"</p><p>static void AppTaskCreate(void);/* AppTask任務 */</p><p>/* 創建任務句柄 */</p><p>static TaskHandle_t AppTask_Handle = NULL;</p><p>int main(void)</p><p>{</p><p>BaseType_t xReturn = pdPASS;/* 定義一個創建信息返回值，默認為pdPASS */</p><p>/* 開發板硬件初始化 */</p><p>BSP_Init();</p><p>/* 創建AppTaskCreate任務 */</p><p>xReturn = xTaskCreate((TaskFunction_t )AppTask, /* 任務入口函數 */</p><p>(const char* )"AppTask",/* 任務名字 */</p><p>(uint16_t )512, /* 任務棧大小 */</p><p>(void* )NULL,/* 任務入口函數參數 */</p><p>(UBaseType_t )1, /* 任務的優先級 */</p><p>(TaskHandle_t* )&AppTask_Handle);/* 任務控制塊指針 */</p><p>/* 啟動任務調度 */</p><p>if(pdPASS == xReturn)</p><p>vTaskStartScheduler(); /* 啟動任務，開啟調度 */</p><p>else</p><p>return -1;</p><p>while(1); /* 正常不會執行到這裡 */</p><p>}</p><p>static void AppTask(void* parameter)</p><p>{</p><p>while (1)</p><p>{</p><p>LED1_ON;</p><p>vTaskDelay(500); /* 延時500個tick */</p><p>LED1_OFF;</p><p>vTaskDelay(500); /* 延時500個tick */</p><p>}</p><p>}</p><h1>關注我</h1><p>更多資料歡迎關注“物聯網IoT開發”公眾號</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>超詳細</a></li><li><a>FreeRTOS</a></li><li><a>stm32</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/a62a3dde.html alt=超詳細排線教程，不會排線的快來學習臨摹，學會排線很簡單，收藏 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ea4c696b1fc84db7bbf4b14ec19001fd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a62a3dde.html title=超詳細排線教程，不會排線的快來學習臨摹，學會排線很簡單，收藏>超詳細排線教程，不會排線的快來學習臨摹，學會排線很簡單，收藏</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a93ac160.html alt=超詳細的素描頭像結構解析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153397416564989f4872ceb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a93ac160.html title=超詳細的素描頭像結構解析>超詳細的素描頭像結構解析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7b7d17b0.html alt=（乾貨）超詳細的水彩繪畫教程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/dff999e4a4ba4847acecfb6ce2153739 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7b7d17b0.html title=（乾貨）超詳細的水彩繪畫教程>（乾貨）超詳細的水彩繪畫教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/74e62337.html alt=教你學鉤針：超詳細的鉤針換線方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/593f0003a21cfa1fab35 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/74e62337.html title=教你學鉤針：超詳細的鉤針換線方法>教你學鉤針：超詳細的鉤針換線方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9d6c7107.html alt=【超詳細】綜合佈線常用術語 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ef74026782434fedbd769ebea5e7b6d3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9d6c7107.html title=【超詳細】綜合佈線常用術語>【超詳細】綜合佈線常用術語</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6e1619f8.html alt=歐姆定律｜超詳細的知識點撥和習題演練 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1543798018270d304f1be33 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6e1619f8.html title=歐姆定律｜超詳細的知識點撥和習題演練>歐姆定律｜超詳細的知識點撥和習題演練</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c971ce30.html alt=超詳細！歐姆定律的易錯易混專題講解+專題訓練 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3091862292d74e0fa3e5458e82bffaca style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c971ce30.html title=超詳細！歐姆定律的易錯易混專題講解+專題訓練>超詳細！歐姆定律的易錯易混專題講解+專題訓練</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a5bfc206.html alt=超詳細│開關電源高頻變壓器製作全過程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/3129ee862f2f4ea99943d3e6e6db5f10 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a5bfc206.html title=超詳細│開關電源高頻變壓器製作全過程>超詳細│開關電源高頻變壓器製作全過程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/445e93fb.html alt=超詳細「氣管插管」步驟教程，新手入門就看這個！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7922456dd2e547d69cb8444a4e20d023 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/445e93fb.html title=超詳細「氣管插管」步驟教程，新手入門就看這個！>超詳細「氣管插管」步驟教程，新手入門就看這個！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0cb2d685.html alt=摩托車引擎拆裝，超詳細DIY記錄汽缸頭組裝 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/dfdb27e5636b4bd18b76fdb430815375 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0cb2d685.html title=摩托車引擎拆裝，超詳細DIY記錄汽缸頭組裝>摩托車引擎拆裝，超詳細DIY記錄汽缸頭組裝</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/79fa408e.html alt=超詳細的常用會計分錄，建議收藏 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1b4bf8b685024465ac8f03c7f51119dc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/79fa408e.html title=超詳細的常用會計分錄，建議收藏>超詳細的常用會計分錄，建議收藏</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fa573f50.html alt=超詳細的焊接操作步驟（焊接培訓教學步驟） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d2fc5ff13fee46708cad937a82b92a5c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fa573f50.html title=超詳細的焊接操作步驟（焊接培訓教學步驟）>超詳細的焊接操作步驟（焊接培訓教學步驟）</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/2e789f3f.html alt=超詳細！在瀋陽再也不怕迷路了，這條微信比地圖還管用！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/65c7000dd2a9b2176289 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/2e789f3f.html title=超詳細！在瀋陽再也不怕迷路了，這條微信比地圖還管用！>超詳細！在瀋陽再也不怕迷路了，這條微信比地圖還管用！</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/8b3fd85f.html alt=一份超詳細的殺蟲劑資料 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1531455292862a06bc560bc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/8b3fd85f.html title=一份超詳細的殺蟲劑資料>一份超詳細的殺蟲劑資料</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/919b5c59.html alt=超詳細的鋼筋直螺紋連接三維技術交底 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/2e17168258e74865b86d9ded650b9860 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/919b5c59.html title=超詳細的鋼筋直螺紋連接三維技術交底>超詳細的鋼筋直螺紋連接三維技術交底</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>