<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>深入學習MySQL事務：ACID特性的實現原理「轉」 | 极客快訊</title><meta property="og:title" content="深入學習MySQL事務：ACID特性的實現原理「轉」 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/cdc702d66d6943499997d11e931425eb"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/175f9730.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/175f9730.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/175f9730.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/175f9730.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/175f9730.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/175f9730.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/175f9730.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/175f9730.html><meta property="article:published_time" content="2020-11-14T21:08:11+08:00"><meta property="article:modified_time" content="2020-11-14T21:08:11+08:00"><meta name=Keywords content><meta name=description content="深入學習MySQL事務：ACID特性的實現原理「轉」"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/175f9730.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>深入學習MySQL事務：ACID特性的實現原理「轉」</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>事務是MySQL等關係型數據庫區別於NoSQL的重要方面，是保證數據一致性的重要手段。<strong>本文將首先介紹MySQL事務相關的基礎概念，然後介紹事務的ACID特性，並分析其實現原理。</strong></p><p><br></p><div class=tt-column-card data-content='{"new_thumb_url": "http://sf1-ttcdn-tos.pstatp.com/img/pgc-image/6575399823564fd9a12d3df367b27135", "title": "\u7528\u5b9e\u4f8b\u6df1\u5ea6\u63ed\u79d8spring5\u6838\u5fc3\u539f\u7406 ", "url": "", "price": 108, "column_id": "6765741896099692808", "content": "", "author_description": "\u67b6\u6784\u5e08\u7b14\u8bb0", "share_price": 43.2, "thumb_url": "http://p2.pstatp.com/large/pgc-image/6575399823564fd9a12d3df367b27135", "sold": 4}'><p class=column-placeholder></p></div><p><br></p><p>MySQL博大精深，文章疏漏之處在所難免，歡迎批評指正。</p><h1 class=pgc-h-arrow-right>一、基礎概念</h1><p>事務（Transaction）是訪問和更新數據庫的程序執行單元；事務中可能包含一個或多個sql語句，這些語句要麼都執行，要麼都不執行。作為一個關係型數據庫，MySQL支持事務，本文介紹基於MySQL5.6。</p><p>首先回顧一下MySQL事務的基礎知識。</p><h2 class=pgc-h-arrow-right>1. 邏輯架構和存儲引擎</h2><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/cdc702d66d6943499997d11e931425eb><p class=pgc-img-caption></p></div><p>圖片來源：https://blog.csdn.net/fuzhongmin05/article/details/70904190</p><p>如上圖所示，MySQL服務器邏輯架構從上往下可以分為三層：</p><p>（1）第一層：處理客戶端連接、授權認證等。</p><p>（2）第二層：服務器層，負責查詢語句的解析、優化、緩存以及內置函數的實現、存儲過程等。</p><p>（3）第三層：存儲引擎，負責MySQL中數據的存儲和提取。<strong>MySQL中服務器層不管理事務，事務是由存儲引擎實現的。</strong>MySQL支持事務的存儲引擎有InnoDB、NDB Cluster等，其中InnoDB的使用最為廣泛；其他存儲引擎不支持事務，如MyIsam、Memory等。</p><p>如無特殊說明，後文中描述的內容都是基於InnoDB。</p><h2 class=pgc-h-arrow-right>2. 提交和回滾</h2><p>典型的MySQL事務是如下操作的：</p><p>1</p><p>2</p><p>3</p><p>start transaction;</p><p>…… #一條或多條sql語句</p><p>commit;</p><p>其中start transaction標識事務開始，commit提交事務，將執行結果寫入到數據庫。如果sql語句執行出現問題，會調用rollback，回滾所有已經執行成功的sql語句。當然，也可以在事務中直接使用rollback語句進行回滾。</p><p><strong>自動提交</strong></p><p>MySQL中默認採用的是自動提交（autocommit）模式，如下所示：</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fa001bcdbe0c48d09ec44000cbfb0fd7><p class=pgc-img-caption></p></div><p>在自動提交模式下，如果沒有start transaction顯式地開始一個事務，那麼每個sql語句都會被當做一個事務執行提交操作。</p><p>通過如下方式，可以關閉autocommit；需要注意的是，autocommit參數是針對連接的，在一個連接中修改了參數，不會對其他連接產生影響。</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/55dee26e78f24574af3264b88bab0bbc><p class=pgc-img-caption></p></div><p>如果關閉了autocommit，則所有的sql語句都在一個事務中，直到執行了commit或rollback，該事務結束，同時開始了另外一個事務。</p><p><strong>特殊操作</strong></p><p>在MySQL中，存在一些特殊的命令，如果在事務中執行了這些命令，會馬上強制執行commit提交事務；如DDL語句(create table/drop table/alter/table)、lock tables語句等等。</p><p>不過，常用的select、insert、update和delete命令，都不會強制提交事務。</p><h2 class=pgc-h-arrow-right>3. ACID特性</h2><p>ACID是衡量事務的四個特性：</p><ul><li>原子性（Atomicity，或稱不可分割性）</li><li>一致性（Consistency）</li><li>隔離性（Isolation）</li><li>持久性（Durability）</li></ul><p>按照嚴格的標準，只有同時滿足ACID特性才是事務；但是在各大數據庫廠商的實現中，真正滿足ACID的事務少之又少。例如MySQL的NDB Cluster事務不滿足持久性和隔離性；InnoDB默認事務隔離級別是可重複讀，不滿足隔離性；Oracle默認的事務隔離級別為READ COMMITTED，不滿足隔離性……<strong>因此與其說ACID是事務必須滿足的條件，不如說它們是衡量事務的四個維度。</strong></p><p>下面將詳細介紹ACID特性及其實現原理；為了便於理解，介紹的順序不是嚴格按照A-C-I-D。</p><h1 class=pgc-h-arrow-right>二、原子性</h1><h2 class=pgc-h-arrow-right>1. 定義</h2><p>原子性是指一個事務是一個不可分割的工作單位，其中的操作要麼都做，要麼都不做；如果事務中一個sql語句執行失敗，則已執行的語句也必須回滾，數據庫退回到事務前的狀態。</p><h2 class=pgc-h-arrow-right>2. 實現原理：undo log</h2><p>在說明原子性原理之前，首先介紹一下MySQL的事務日誌。MySQL的日誌有很多種，如二進制日誌、錯誤日誌、查詢日誌、慢查詢日誌等，此外InnoDB存儲引擎還提供了兩種事務日誌：redo log(重做日誌)和undo log(回滾日誌)。其中redo log用於保證事務持久性；undo log則是事務原子性和隔離性實現的基礎。</p><p>下面說回undo log。實現原子性的關鍵，是當事務回滾時能夠撤銷所有已經成功執行的sql語句。<strong>InnoDB實現回滾，靠的是undo log：當事務對數據庫進行修改時，InnoDB會生成對應的undo log；如果事務執行失敗或調用了rollback，導致事務需要回滾，便可以利用undo log中的信息將數據回滾到修改之前的樣子。</strong></p><p>undo log屬於邏輯日誌，它記錄的是sql執行相關的信息。當發生回滾時，InnoDB會根據undo log的內容做與之前相反的工作：對於每個insert，回滾時會執行delete；對於每個delete，回滾時會執行insert；對於每個update，回滾時會執行一個相反的update，把數據改回去。</p><p>以update操作為例：當事務執行update時，其生成的undo log中會包含被修改行的主鍵(以便知道修改了哪些行)、修改了哪些列、這些列在修改前後的值等信息，回滾時便可以使用這些信息將數據還原到update之前的狀態。</p><h1 class=pgc-h-arrow-right>三、持久性</h1><h2 class=pgc-h-arrow-right>1. 定義</h2><p>持久性是指事務一旦提交，它對數據庫的改變就應該是永久性的。接下來的其他操作或故障不應該對其有任何影響。</p><h2 class=pgc-h-arrow-right>2. 實現原理：redo log</h2><p>redo log和undo log都屬於InnoDB的事務日誌。下面先聊一下redo log存在的背景。</p><p>InnoDB作為MySQL的存儲引擎，數據是存放在磁盤中的，但如果每次讀寫數據都需要磁盤IO，效率會很低。為此，InnoDB提供了緩存(Buffer Pool)，Buffer Pool中包含了磁盤中部分數據頁的映射，作為訪問數據庫的緩衝：當從數據庫讀取數據時，會首先從Buffer Pool中讀取，如果Buffer Pool中沒有，則從磁盤讀取後放入Buffer Pool；當向數據庫寫入數據時，會首先寫入Buffer Pool，Buffer Pool中修改的數據會定期刷新到磁盤中（這一過程稱為刷髒）。</p><p>Buffer Pool的使用大大提高了讀寫數據的效率，但是也帶了新的問題：如果MySQL宕機，而此時Buffer Pool中修改的數據還沒有刷新到磁盤，就會導致數據的丟失，事務的持久性無法保證。</p><p>於是，redo log被引入來解決這個問題：當數據修改時，除了修改Buffer Pool中的數據，還會在redo log記錄這次操作；當事務提交時，會調用fsync接口對redo log進行刷盤。如果MySQL宕機，重啟時可以讀取redo log中的數據，對數據庫進行恢復。redo log採用的是WAL（Write-ahead logging，預寫式日誌），所有修改先寫入日誌，再更新到Buffer Pool，保證了數據不會因MySQL宕機而丟失，從而滿足了持久性要求。</p><p>既然redo log也需要在事務提交時將日誌寫入磁盤，為什麼它比直接將Buffer Pool中修改的數據寫入磁盤(即刷髒)要快呢？主要有以下兩方面的原因：</p><p>（1）刷髒是隨機IO，因為每次修改的數據位置隨機，但寫redo log是追加操作，屬於順序IO。</p><p>（2）刷髒是以數據頁（Page）為單位的，MySQL默認頁大小是16KB，一個Page上一個小修改都要整頁寫入；而redo log中只包含真正需要寫入的部分，無效IO大大減少。</p><h2 class=pgc-h-arrow-right>3. redo log與binlog</h2><p>我們知道，在MySQL中還存在binlog(二進制日誌)也可以記錄寫操作並用於數據的恢復，但二者是有著根本的不同的：</p><p>（1）作用不同：redo log是用於crash recovery的，保證MySQL宕機也不會影響持久性；binlog是用於point-in-time recovery的，保證服務器可以基於時間點恢復數據，此外binlog還用於主從複製。</p><p>（2）層次不同：redo log是InnoDB存儲引擎實現的，而binlog是MySQL的服務器層(可以參考文章前面對MySQL邏輯架構的介紹)實現的，同時支持InnoDB和其他存儲引擎。</p><p>（3）內容不同：redo log是物理日誌，內容基於磁盤的Page；binlog的內容是二進制的，根據binlog_format參數的不同，可能基於sql語句、基於數據本身或者二者的混合。</p><p>（4）寫入時機不同：binlog在事務提交時寫入；redo log的寫入時機相對多元：</p><ul><li>前面曾提到：當事務提交時會調用fsync對redo log進行刷盤；這是默認情況下的策略，修改innodb_flush_log_at_trx_commit參數可以改變該策略，但事務的持久性將無法保證。</li><li>除了事務提交時，還有其他刷盤時機：如master thread每秒刷盤一次redo log等，這樣的好處是不一定要等到commit時刷盤，commit速度大大加快。</li></ul><h1 class=pgc-h-arrow-right>四、隔離性</h1><h2 class=pgc-h-arrow-right>1. 定義</h2><p><strong>與原子性、持久性側重於研究事務本身不同，隔離性研究的是不同事務之間的相互影響。</strong>隔離性是指，事務內部的操作與其他事務是隔離的，併發執行的各個事務之間不能互相干擾。嚴格的隔離性，對應了事務隔離級別中的Serializable (可串行化)，但實際應用中出於性能方面的考慮很少會使用可串行化。</p><p></p><p>隔離性追求的是併發情形下事務之間互不干擾。簡單起見，我們僅考慮最簡單的讀操作和寫操作(暫時不考慮帶鎖讀等特殊操作)，那麼隔離性的探討，主要可以分為兩個方面：</p><ul><li>(一個事務)寫操作對(另一個事務)寫操作的影響：鎖機制保證隔離性</li><li>(一個事務)寫操作對(另一個事務)讀操作的影響：MVCC保證隔離性</li></ul><h2 class=pgc-h-arrow-right>2. 鎖機制</h2><p>首先來看兩個事務的寫操作之間的相互影響。隔離性要求同一時刻只能有一個事務對數據進行寫操作，InnoDB通過鎖機制來保證這一點。</p><p>鎖機制的基本原理可以概括為：事務在修改數據之前，需要先獲得相應的鎖；獲得鎖之後，事務便可以修改數據；該事務操作期間，這部分數據是鎖定的，其他事務如果需要修改數據，需要等待當前事務提交或回滾後釋放鎖。</p><p><strong>行鎖與表鎖</strong></p><p>按照粒度，鎖可以分為表鎖、行鎖以及其他位於二者之間的鎖。表鎖在操作數據時會鎖定整張表，併發性能較差；行鎖則只鎖定需要操作的數據，併發性能好。但是由於加鎖本身需要消耗資源(獲得鎖、檢查鎖、釋放鎖等都需要消耗資源)，因此在鎖定數據較多情況下使用表鎖可以節省大量資源。MySQL中不同的存儲引擎支持的鎖是不一樣的，例如MyIsam只支持表鎖，而InnoDB同時支持表鎖和行鎖，且出於性能考慮，絕大多數情況下使用的都是行鎖。</p><p><strong>如何查看鎖信息</strong></p><p>有多種方法可以查看InnoDB中鎖的情況，例如：</p><p>1</p><p>2</p><p>select * from information_schema.innodb_locks; #鎖的概況</p><p>show engine innodb status; #InnoDB整體狀態，其中包括鎖的情況</p><p>下面來看一個例子：</p><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>#在事務A中執行：</p><p>start transaction;</p><p>update account SET balance = 1000 where id = 1;</p><p>#在事務B中執行：</p><p>start transaction;</p><p>update account SET balance = 2000 where id = 1;</p><p>此時查看鎖的情況：</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2c4db0e9c29043f1bdfa18a43fbc5a49><p class=pgc-img-caption></p></div><p>show engine innodb status查看鎖相關的部分：</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c23f38234ae447779cecd59db4bbd125><p class=pgc-img-caption></p></div><p>通過上述命令可以查看事務24052和24053佔用鎖的情況；其中lock_type為RECORD，代表鎖為行鎖(記錄鎖)；lock_mode為X，代表排它鎖(寫鎖)。</p><p>除了排它鎖(寫鎖)之外，MySQL中還有共享鎖(讀鎖)的概念。由於本文重點是MySQL事務的實現原理，因此對鎖的介紹到此為止，後續會專門寫文章分析MySQL中不同鎖的區別、使用場景等，歡迎關注。</p><p></p><p>介紹完寫操作之間的相互影響，下面討論寫操作對讀操作的影響。</p><h2 class=pgc-h-arrow-right>3. 髒讀、不可重複讀和幻讀</h2><p>首先來看併發情況下，讀操作可能存在的三類問題：</p><p>（1）髒讀：當前事務(A)中可以讀到其他事務(B)未提交的數據（髒數據），這種現象是髒讀。舉例如下（以賬戶餘額表為例）：</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e9684996d1254a219906c19b6c519177><p class=pgc-img-caption></p></div><p>（2）不可重複讀：在事務A中先後兩次讀取同一個數據，兩次讀取的結果不一樣，這種現象稱為不可重複讀。髒讀與不可重複讀的區別在於：前者讀到的是其他事務未提交的數據，後者讀到的是其他事務已提交的數據。舉例如下：</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cfcfdc80b1b74746a689ce9a8d1ebec0><p class=pgc-img-caption></p></div><p>（3）幻讀：在事務A中按照某個條件先後兩次查詢數據庫，兩次查詢結果的條數不同，這種現象稱為幻讀。不可重複讀與幻讀的區別可以通俗的理解為：前者是數據變了，後者是數據的行數變了。舉例如下：</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/678a10337dcd4d6faf87546ba30d0aba><p class=pgc-img-caption></p></div><h2 class=pgc-h-arrow-right>4. 事務隔離級別</h2><p>SQL標準中定義了四種隔離級別，並規定了每種隔離級別下上述幾個問題是否存在。一般來說，隔離級別越低，系統開銷越低，可支持的併發越高，但隔離性也越差。隔離級別與讀問題的關係如下：</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/70242603d94343078cac270502cf7549><p class=pgc-img-caption></p></div><p>在實際應用中，<strong>讀未提交</strong>在併發時會導致很多問題，而性能相對於其他隔離級別提高卻很有限，因此使用較少。<strong>可串行化</strong>強制事務串行，併發效率很低，只有當對數據一致性要求極高且可以接受沒有併發時使用，因此使用也較少。因此在大多數數據庫系統中，默認的隔離級別是<strong>讀已提交(如Oracle)</strong>或<strong>可重複讀（後文簡稱RR）</strong>。</p><p>可以通過如下兩個命令分別查看全局隔離級別和本次會話的隔離級別：</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9485aab6f9f84b30b008daf41036f8a8><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7902ffe315c341848a1170fb6c0d0acd><p class=pgc-img-caption></p></div><p>InnoDB默認的隔離級別是RR，後文會重點介紹RR。需要注意的是，在SQL標準中，RR是無法避免幻讀問題的，但是InnoDB實現的RR避免了幻讀問題。</p><h2 class=pgc-h-arrow-right>5. MVCC</h2><p>RR解決髒讀、不可重複讀、幻讀等問題，使用的是MVCC：MVCC全稱Multi-Version Concurrency Control，即多版本的併發控制協議。下面的例子很好的體現了MVCC的特點：在同一時刻，不同的事務讀取到的數據可能是不同的(即多版本)——在T5時刻，事務A和事務C可以讀取到不同版本的數據。</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b309ae1fd84c4cea8a575591cdf5aeaf><p class=pgc-img-caption></p></div><p>MVCC最大的優點是讀不加鎖，因此讀寫不衝突，併發性能好。InnoDB實現MVCC，多個版本的數據可以共存，主要是依靠數據的隱藏列(也可以稱之為標記位)和undo log。其中數據的隱藏列包括了該行數據的版本號、刪除時間、指向undo log的指針等等；當讀取數據時，MySQL可以通過隱藏列判斷是否需要回滾並找到回滾需要的undo log，從而實現MVCC；隱藏列的詳細格式不再展開。</p><p>下面結合前文提到的幾個問題分別說明。</p><p>（1）髒讀</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c724024676024cd2b653f325ceb48ea3><p class=pgc-img-caption></p></div><p>當事務A在T3時間節點讀取zhangsan的餘額時，會發現數據已被其他事務修改，且狀態為未提交。此時事務A讀取最新數據後，根據數據的undo log執行回滾操作，得到事務B修改前的數據，從而避免了髒讀。</p><p>（2）不可重複讀</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7197f092e166499b9b03a7610b2d04b7><p class=pgc-img-caption></p></div><p>當事務A在T2節點第一次讀取數據時，會記錄該數據的版本號（數據的版本號是以row為單位記錄的），假設版本號為1；當事務B提交時，該行記錄的版本號增加，假設版本號為2；當事務A在T5再一次讀取數據時，發現數據的版本號（2）大於第一次讀取時記錄的版本號（1），因此會根據undo log執行回滾操作，得到版本號為1時的數據，從而實現了可重複讀。</p><p>（3）幻讀</p><p>InnoDB實現的RR通過next-key lock機制避免了幻讀現象。</p><p><strong>next-key lock是行鎖的一種，實現相當於record lock(記錄鎖) + gap lock(間隙鎖)；其特點是不僅會鎖住記錄本身(record lock的功能)，還會鎖定一個範圍(gap lock的功能)。</strong>當然，這裡我們討論的是不加鎖讀：此時的next-key lock並不是真的加鎖，只是為讀取的數據增加了標記（標記內容包括數據的版本號等）；準確起見姑且稱之為類next-key lock機制。還是以前面的例子來說明：</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b80a10deb16d4b49b0809900c429b795><p class=pgc-img-caption></p></div><p>當事務A在T2節點第一次讀取0&lt;id&lt;5數據時，標記的不只是id=1的數據，而是將範圍(0,5)進行了標記，這樣當T5時刻再次讀取0&lt;id&lt;5數據時，便可以發現id=4的數據比之前標記的版本號更高，此時再結合undo log執行回滾操作，避免了幻讀。</p><h2 class=pgc-h-arrow-right>6. 總結</h2><p>概括來說，InnoDB實現的RR，通過鎖機制、數據的隱藏列、undo log和類next-key lock，實現了一定程度的隔離性，可以滿足大多數場景的需要。不過需要說明的是，RR雖然避免了幻讀問題，但是畢竟不是Serializable，不能保證完全的隔離，下面是一個例子，大家可以自己驗證一下。</p><div class=pgc-img><img alt=深入學習MySQL事務：ACID特性的實現原理「轉」 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ffe4d435eaa64c7d8b0858db14f0173a><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>五、一致性</h1><h2 class=pgc-h-arrow-right>1. 基本概念</h2><p>一致性是指事務執行結束後，<strong>數據庫的完整性約束沒有被破壞，事務執行的前後都是合法的數據狀態。</strong>數據庫的完整性約束包括但不限於：實體完整性（如行的主鍵存在且唯一）、列完整性（如字段的類型、大小、長度要符合要求）、外鍵約束、用戶自定義完整性（如轉賬前後，兩個賬戶餘額的和應該不變）。</p><h2 class=pgc-h-arrow-right>2. 實現</h2><p>可以說，一致性是事務追求的最終目標：前面提到的原子性、持久性和隔離性，都是為了保證數據庫狀態的一致性。此外，除了數據庫層面的保障，一致性的實現也需要應用層面進行保障。</p><p>實現一致性的措施包括：</p><ul><li>保證原子性、持久性和隔離性，如果這些特性無法保證，事務的一致性也無法保證</li><li>數據庫本身提供保障，例如不允許向整形列插入字符串值、字符串長度不能超過列的限制等</li><li>應用層面進行保障，例如如果轉賬操作只扣除轉賬者的餘額，而沒有增加接收者的餘額，無論數據庫實現的多麼完美，也無法保證狀態的一致</li></ul><h1 class=pgc-h-arrow-right>六、總結</h1><p>下面總結一下ACID特性及其實現原理：</p><ul><li>原子性：語句要麼全執行，要麼全不執行，是事務最核心的特性，事務本身就是以原子性來定義的；實現主要基於undo log</li><li>持久性：保證事務提交後不會因為宕機等原因導致數據丟失；實現主要基於redo log</li><li>隔離性：保證事務執行儘可能不受其他事務影響；InnoDB默認的隔離級別是RR，RR的實現主要基於鎖機制、數據的隱藏列、undo log和類next-key lock機制</li><li>一致性：事務追求的最終目標，一致性的實現既需要數據庫層面的保障，也需要應用層面的保障</li></ul><h1 class=pgc-h-arrow-right>參考文獻</h1><p>《MySQL技術內幕：InnoDB存儲引擎》</p><p>《高性能MySQL》</p><p>《MySQL運維內參》</p><p>https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_acid</p><p>https://dev.mysql.com/doc/refman/5.6/en/innodb-next-key-locking.html</p><p>http://blog.sina.com.cn/s/blog_499740cb0100ugs7.html</p><p>https://mp.weixin.qq.com/s/2dwGBTmu_da2x-HiHlN0vw</p><p>http://www.cnblogs.com/chenpingzhao/p/5065316.html</p><p>https://juejin.im/entry/5ba0a254e51d450e735e4a1f</p><p>http://hedengcheng.com/?p=771</p><p><br></p><div class=tt-column-card data-content='{"new_thumb_url": "http://sf3-ttcdn-tos.pstatp.com/img/pgc-image/7ed9f0d429394e0b98dce4c9737c05a6", "title": "\u5b9e\u6218redis--\u5927\u5e08\u5e26\u4f60\uff0c\u4ee5\u6218\u4ee3\u7ec3", "url": "", "price": 39, "column_id": "6756075730490114311", "content": "", "author_description": "\u67b6\u6784\u5e08\u7b14\u8bb0", "share_price": 6.24, "thumb_url": "http://p8.pstatp.com/large/pgc-image/7ed9f0d429394e0b98dce4c9737c05a6", "sold": 1}'><p class=column-placeholder></p></div><p><br></p><p>原文地址：https://www.cnblogs.com/kismetv/p/10331633.html</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>學習</a></li><li><a>MySQL</a></li><li><a>事務</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html alt="MySQL 事務處理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html title="MySQL 事務處理">MySQL 事務處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c9091681.html alt="MySQL 學習筆記" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c9091681.html title="MySQL 學習筆記">MySQL 學習筆記</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html alt=MySQL——事務(Transaction)詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/29d4c92c9c2344838eb72ef948cf08fa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html title=MySQL——事務(Transaction)詳解>MySQL——事務(Transaction)詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html alt=MySQL數據庫的事務管理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/152203544367254a708f807 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html title=MySQL數據庫的事務管理>MySQL數據庫的事務管理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7d322f7b.html alt=MySQL系列-第14篇：事務詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a5b520dd476345e2b3aac97a8fcb77d5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7d322f7b.html title=MySQL系列-第14篇：事務詳解>MySQL系列-第14篇：事務詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/efc2a519.html alt=你知道MySQL的事務處理和隔離級別嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/efc2a519.html title=你知道MySQL的事務處理和隔離級別嗎？>你知道MySQL的事務處理和隔離級別嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cf061a5c.html alt="我對 MySQL 鎖、事務、MVCC 的一些認識" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/5d6e32482c364fe3b5f9436a30671330 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cf061a5c.html title="我對 MySQL 鎖、事務、MVCC 的一些認識">我對 MySQL 鎖、事務、MVCC 的一些認識</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4959ed6a.html alt="技術分享 | MySQL 的嵌套事務、自治事務與鏈式事務" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4959ed6a.html title="技術分享 | MySQL 的嵌套事務、自治事務與鏈式事務">技術分享 | MySQL 的嵌套事務、自治事務與鏈式事務</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0482a52.html alt="MySQL 事務的四種隔離級別，研讀完了你能吊打面試官" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1a7cb2436dec4249b34a8c79cdb17e9c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0482a52.html title="MySQL 事務的四種隔離級別，研讀完了你能吊打面試官">MySQL 事務的四種隔離級別，研讀完了你能吊打面試官</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dacc263.html alt=MySQL數據庫中的事務以及創建表的注意事項 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dacc263.html title=MySQL數據庫中的事務以及創建表的注意事項>MySQL數據庫中的事務以及創建表的注意事項</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/daee1f6.html alt=MySQL事務提交過程（一） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/61f7b3575cea4b20b5e0400f9ad4d11b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/daee1f6.html title=MySQL事務提交過程（一）>MySQL事務提交過程（一）</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/720ab20.html alt=MySQL事務管理的介紹（附示例） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/720ab20.html title=MySQL事務管理的介紹（附示例）>MySQL事務管理的介紹（附示例）</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/e6b01ca.html alt=數據庫事務系列－MySQL跨行事務模型 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/dfic-imagehandler/64c5efca-90a2-44e0-99ff-f3cfd727679e style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/e6b01ca.html title=數據庫事務系列－MySQL跨行事務模型>數據庫事務系列－MySQL跨行事務模型</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dc2af9c9.html alt=機器學習筆記(七)——初識邏輯迴歸、不同方法推導梯度公式 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/13adbab9c7f94c7fa81d49a98861b051 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dc2af9c9.html title=機器學習筆記(七)——初識邏輯迴歸、不同方法推導梯度公式>機器學習筆記(七)——初識邏輯迴歸、不同方法推導梯度公式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e214e6d7.html alt=深度學習/機器學習入門數學知識整理（二）梯度與導數，泰勒展開 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1540372101455de0fb74774 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e214e6d7.html title=深度學習/機器學習入門數學知識整理（二）梯度與導數，泰勒展開>深度學習/機器學習入門數學知識整理（二）梯度與導數，泰勒展開</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>