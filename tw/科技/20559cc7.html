<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>基於Canal和Kafka實現MySQL的Binlog近實時同步 | 极客快訊</title><meta property="og:title" content="基於Canal和Kafka實現MySQL的Binlog近實時同步 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/dafc2ca594c643728ee9361b349265ae"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/20559cc7.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/20559cc7.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/20559cc7.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/20559cc7.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/20559cc7.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/20559cc7.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/20559cc7.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/20559cc7.html><meta property="article:published_time" content="2020-11-14T21:00:58+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:58+08:00"><meta name=Keywords content><meta name=description content="基於Canal和Kafka實現MySQL的Binlog近實時同步"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/20559cc7.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>基於Canal和Kafka實現MySQL的Binlog近實時同步</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>作者：Throwable</p><h2 class=heading>前提</h2><p>近段時間，業務系統架構基本完備，數據層面的建設比較薄弱，因為筆者目前工作重心在於搭建一個小型的數據平臺。優先級比較高的一個任務就是需要近實時同步業務系統的數據（包括保存、更新或者軟刪除）到一個另一個數據源，持久化之前需要清洗數據並且構建一個相對合理的便於後續業務數據統計、標籤系統構建等擴展功能的數據模型。基於當前團隊的資源和能力，優先調研了Alibaba開源中間件Canal的使用。</p><p><br></p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/dafc2ca594c643728ee9361b349265ae><p class=pgc-img-caption></p></div><p><br></p><p>這篇文章簡單介紹一下如何快速地搭建一套Canal相關的組件。</p><h2 class=heading>關於Canal</h2><h3 class=heading>簡介</h3><p>下面的簡介和下一節的原理均來自於Canal項目的README：</p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/969b5fe5dfc14744870ccae0a9e78c58><p class=pgc-img-caption></p></div><p>Canal[kə'næl]，譯意為水道/管道/溝渠，主要用途是基於MySQL數據庫增量日誌解析，提供增量數據訂閱和消費。早期阿里巴巴因為杭州和美國雙機房部署，存在跨機房同步的業務需求，實現方式主要是基於業務trigger獲取增量變更。從 2010 年開始，業務逐步嘗試數據庫日誌解析獲取增量變更進行同步，由此衍生出了大量的數據庫增量訂閱和消費業務。</p><p>基於日誌增量訂閱和消費的業務包括：</p><ul><li>數據庫鏡像</li><li>數據庫實時備份</li><li>索引構建和實時維護（拆分異構索引、倒排索引等）</li><li>業務Cache刷新</li><li>帶業務邏輯的增量數據處理</li></ul><h3 class=heading>Canal的工作原理</h3><p>MySQL主備複製原理：</p><p><br></p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4de3b09b89e74cb789e4b02070568158><p class=pgc-img-caption></p></div><p><br></p><ul><li>MySQL的Master實例將數據變更寫入二進制日誌（binary log，其中記錄叫做二進制日誌事件binary log events，可以通過show binlog events進行查看）</li><li>MySQL的Slave實例將master的binary log events拷貝到它的中繼日誌（relay log）</li><li>MySQL的Slave實例重放relay log中的事件，將數據變更反映它到自身的數據</li></ul><p>Canal的工作原理如下：</p><ul><li>Canal模擬MySQL Slave的交互協議，偽裝自己為MySQL Slave，向MySQL Master發送dump協議</li><li>MySQL Master收到dump請求，開始推送binary log給Slave（即Canal）</li><li>Canal解析binary log對象（原始為byte流），並且可以通過連接器發送到對應的消息隊列等中間件中</li></ul><h3 class=heading>關於Canal的版本和部件</h3><p>截止筆者開始編寫本文的時候（2020-03-05），Canal的最新發布版本是v1.1.5-alpha-1（2019-10-09發佈的），最新的正式版是v1.1.4（2019-09-02發佈的）。其中，v1.1.4主要添加了鑑權、監控的功能，並且做了一些列的性能優化，此版本集成的連接器是Tcp、Kafka和RockerMQ。而v1.1.5-alpha-1版本已經新增了RabbitMQ連接器，但是此版本的RabbitMQ連接器暫時不能定義連接RabbitMQ的端口號，不過此問題已經在master分支中修復（具體可以參看源碼中的CanalRabbitMQProducer類的提交記錄）。換言之，v1.1.4版本中目前能使用的內置連接器只有Tcp、Kafka和RockerMQ三種，如果想嚐鮮使用RabbitMQ連接器，可以選用下面的兩種方式之一：</p><ul><li>選用v1.1.5-alpha-1版本，但是無法修改RabbitMQ的port屬性，默認為5672。</li><li>基於master分支自行構建Canal。</li></ul><p>目前，Canal項目的活躍度比較高，但是考慮到功能的穩定性問題，筆者建議選用穩定版本在生產環境中實施，當前可以選用v1.1.4版本，<strong>本文的例子用選用的就是v1.1.4版本，配合Kafka連接器使用</strong>。Canal主要包括三個核心部件：</p><ul><li>canal-admin：後臺管理模塊，提供面向WebUI的Canal管理能力。</li><li>canal-adapter：適配器，增加客戶端數據落地的適配及啟動功能，包括REST、日誌適配器、關係型數據庫的數據同步（表對錶同步）、HBase數據同步、ES數據同步等等。</li><li>canal-deployer：發佈器，核心功能所在，包括binlog解析、轉換和發送報文到連接器中等等功能都由此模塊提供。</li></ul><p>一般情況下，canal-deployer部件是必須的，其他兩個部件按需選用即可。</p><h2 class=heading>部署所需的中間件</h2><p>搭建一套可以用的組件需要部署MySQL、Zookeeper、Kafka和Canal四個中間件的實例，下面簡單分析一下部署過程。選用的虛擬機系統是CentOS7。</p><h3 class=heading>安裝MySQL</h3><p>為了簡單起見，選用yum源安裝（官方鏈接是https://dev.mysql.com/downloads/repo/yum）：</p><p><br></p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/71b780cac0f44cc2923c3c6db7b92944><p class=pgc-img-caption></p></div><p><br></p><p>::: info mysql80-community-release-el7-3雖然包名帶了mysql80關鍵字，其實已經集成了MySQL主流版本5.6、5.7和8.x等等的最新安裝包倉庫 :::</p><p>選用的是最新版的MySQL8.x社區版，下載CentOS7適用的rpm包：</p><pre><code>cd /data/mysqlwget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm// 下載完畢之後sudo rpm -Uvh mysql80-community-release-el7-3.noarch.rpm</code></pre><p>此時列舉一下yum倉庫裡面的MySQL相關的包：</p><pre><code>[root@localhost mysql]# yum repolist all | grep mysqlmysql-cluster-7.5-community/x86_64 MySQL Cluster 7.5 Community   disabledmysql-cluster-7.5-community-source MySQL Cluster 7.5 Community - disabledmysql-cluster-7.6-community/x86_64 MySQL Cluster 7.6 Community   disabledmysql-cluster-7.6-community-source MySQL Cluster 7.6 Community - disabledmysql-cluster-8.0-community/x86_64 MySQL Cluster 8.0 Community   disabledmysql-cluster-8.0-community-source MySQL Cluster 8.0 Community - disabledmysql-connectors-community/x86_64  MySQL Connectors Community    enabled:    141mysql-connectors-community-source  MySQL Connectors Community -  disabledmysql-tools-community/x86_64       MySQL Tools Community         enabled:    105mysql-tools-community-source       MySQL Tools Community - Sourc disabledmysql-tools-preview/x86_64         MySQL Tools Preview           disabledmysql-tools-preview-source         MySQL Tools Preview - Source  disabledmysql55-community/x86_64           MySQL 5.5 Community Server    disabledmysql55-community-source           MySQL 5.5 Community Server -  disabledmysql56-community/x86_64           MySQL 5.6 Community Server    disabledmysql56-community-source           MySQL 5.6 Community Server -  disabledmysql57-community/x86_64           MySQL 5.7 Community Server    disabledmysql57-community-source           MySQL 5.7 Community Server -  disabledmysql80-community/x86_64           MySQL 8.0 Community Server    enabled:    161mysql80-community-source           MySQL 8.0 Community Server -  disabled</code></pre><p>編輯/etc/yum.repos.d/mysql-community.repo文件（[mysql80-community]塊中enabled設置為1，其實默認就是這樣子，不用改，如果要選用5.x版本則需要修改對應的塊）：</p><pre><code>[mysql80-community]name=MySQL 8.0 Community Serverbaseurl=http://repo.mysql.com/yum/mysql-8.0-community/el/7/$basearch/enabled=1gpgcheck=1gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql</code></pre><p>然後安裝MySQL服務：</p><pre><code>sudo yum install mysql-community-server</code></pre><p>這個過程比較漫長，因為需要下載和安裝5個rpm安裝包（或者是所有安裝包組合的壓縮包mysql-8.0.18-1.el7.x86_64.rpm-bundle.tar）。如果網絡比較差，也可以直接從官網手動下載後安裝：</p><p><br></p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6b7b87630ee04b41b5221133a5af75ce><p class=pgc-img-caption></p></div><p><br></p><pre><code>// 下載下面5個rpm包 common --&gt; libs --&gt; libs-compat --&gt; client --&gt; servermysql-community-commonmysql-community-libsmysql-community-libs-compatmysql-community-clientmysql-community-server// 強制安裝rpm -ivh mysql-community-common-8.0.18-1.el7.x86_64.rpm --force --nodepsrpm -ivh mysql-community-libs-8.0.18-1.el7.x86_64.rpm --force --nodepsrpm -ivh mysql-community-libs-compat-8.0.18-1.el7.x86_64.rpm --force --nodepsrpm -ivh mysql-community-client-8.0.18-1.el7.x86_64.rpm --force --nodepsrpm -ivh mysql-community-server-8.0.18-1.el7.x86_64.rpm --force --nodeps</code></pre><p>安裝完畢之後，啟動MySQL服務，然後搜索MySQL服務的root賬號的臨時密碼用於首次登陸（mysql -u root -p）：</p><pre><code>// 啟動服務，關閉服務就是service mysqld stopservice mysqld start// 查看臨時密碼 cat /var/log/mysqld.log[root@localhost log]# cat /var/log/mysqld.log 2020-03-02T06:03:53.996423Z 0 [System] [MY-013169] [Server] /usr/sbin/mysqld (mysqld 8.0.18) initializing of server in progress as process 227802020-03-02T06:03:57.321447Z 5 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: &gt;kjYaXENK6li2020-03-02T06:04:00.123845Z 0 [System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.18) starting as process 22834// 登錄臨時root用戶，使用臨時密碼[root@localhost log]# mysql -u root -p</code></pre><p>接下來做下面的操作：</p><ul><li>修改root用戶的密碼：ALTER USER 'root'@'localhost' IDENTIFIED BY 'QWqw12!@';（注意密碼規則必須包含大小寫字母、數字和特殊字符）</li><li>更新root的host，切換數據庫use mysql;，指定host為%以便可以讓其他服務器遠程訪問UPDATE USER SET HOST = '%' WHERE USER = 'root';</li><li>賦予'root'@'%'用戶，所有權限，執行GRANT ALL PRIVILEGES ON *.* TO 'root'@'%';</li><li>改變root'@'%用戶的密碼校驗規則以便可以使用Navicat等工具訪問：ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'QWqw12!@';</li></ul><p><br></p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/25e8556a69604d4d9e8575b64dbe8b3d><p class=pgc-img-caption></p></div><p><br></p><p>操作完成之後，就可以使用root用戶遠程訪問此虛擬機上的MySQL服務。最後確認是否開啟了binlog（注意一點是MySQL8.x默認開啟binlog）SHOW VARIABLES LIKE '%bin%';：</p><p><br></p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4aa6d8b4465d49f2b0903f0cc8201adf><p class=pgc-img-caption></p></div><p><br></p><p>最後在MySQL的Shell執行下面的命令，新建一個用戶名canal密碼為QWqw12!@的新用戶，賦予REPLICATION SLAVE和 REPLICATION CLIENT權限：</p><pre><code>CREATE USER canal IDENTIFIED BY 'QWqw12!@';GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'canal'@'%';FLUSH PRIVILEGES;ALTER USER 'canal'@'%' IDENTIFIED WITH mysql_native_password BY 'QWqw12!@';</code></pre><p>切換回去root用戶，創建一個數據庫test：</p><pre><code>CREATE DATABASE `test` CHARSET `utf8mb4` COLLATE `utf8mb4_unicode_ci`;</code></pre><h3 class=heading>安裝Zookeeper</h3><p>Canal和Kafka集群都依賴於Zookeeper做服務協調，為了方便管理，一般會獨立部署Zookeeper服務或者Zookeeper集群。筆者這裡選用2020-03-04發佈的3.6.0版本：</p><pre><code>midkr /data/zk# 創建數據目錄midkr /data/zk/datacd /data/zkwget http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.6.0/apache-zookeeper-3.6.0-bin.tar.gztar -zxvf apache-zookeeper-3.6.0-bin.tar.gzcd apache-zookeeper-3.6.0-bin/confcp zoo_sample.cfg zoo.cfg &amp;&amp; vim zoo.cfg</code></pre><p>把zoo.cfg文件中的dataDir設置為/data/zk/data，然後啟動Zookeeper：</p><pre><code>[root@localhost conf]# sh /data/zk/apache-zookeeper-3.6.0-bin/bin/zkServer.sh start/usr/bin/javaZooKeeper JMX enabled by defaultUsing config: /data/zk/apache-zookeeper-3.6.0-bin/bin/../conf/zoo.cfgStarting zookeeper ... STARTED</code></pre><p>這裡注意一點，要啟動此版本的Zookeeper服務必須本地安裝好JDK8+，這一點需要自行處理。啟動的默認端口是2181，啟動成功後的日誌如下：</p><p><br></p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/543903be42b74908819c43e17de120a2><p class=pgc-img-caption></p></div><p><br></p><h3 class=heading>安裝Kafka</h3><p>Kafka是一個高性能分佈式消息隊列中間件，它的部署依賴於Zookeeper。筆者在此選用2.4.0並且Scala版本為2.13的安裝包：</p><pre><code>mkdir /data/kafkamkdir /data/kafka/datawget http://mirrors.tuna.tsinghua.edu.cn/apache/kafka/2.4.0/kafka_2.13-2.4.0.tgztar -zxvf kafka_2.13-2.4.0.tgz</code></pre><p>由於解壓後/data/kafka/kafka_2.13-2.4.0/config/server.properties配置中對應的zookeeper.connect=localhost:2181已經符合需要，不必修改，需要修改日誌文件的目錄log.dirs為/data/kafka/data。然後啟動Kafka服務：</p><pre><code>sh /data/kafka/kafka_2.13-2.4.0/bin/kafka-server-start.sh /data/kafka/kafka_2.13-2.4.0/config/server.properties</code></pre><p><br></p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/548bd02dfbae4c0f88490da266b4a8e4><p class=pgc-img-caption></p></div><p><br></p><p>這樣啟動一旦退出控制檯就會結束Kafka進程，可以添加-daemon參數用於控制Kafka進程後臺不掛斷運行。</p><pre><code>sh /data/kafka/kafka_2.13-2.4.0/bin/kafka-server-start.sh -daemon /data/kafka/kafka_2.13-2.4.0/config/server.properties</code></pre><h3 class=heading>安裝和使用Canal</h3><p>終於到了主角登場，這裡選用Canal的v1.1.4穩定發佈版，只需要下載deployer模塊：</p><pre><code>mkdir /data/canalcd /data/canal# 這裡注意一點，Github在國內被牆，下載速度極慢，可以先用其他下載工具下載完再上傳到服務器中wget https://github.com/alibaba/canal/releases/download/canal-1.1.4/canal.deployer-1.1.4.tar.gztar -zxvf canal.deployer-1.1.4.tar.gz</code></pre><p>解壓後的目錄如下：</p><pre><code>- bin   # 運維腳本- conf  # 配置文件  canal_local.properties  # canal本地配置，一般不需要動  canal.properties        # canal服務配置  logback.xml             # logback日誌配置  metrics                 # 度量統計配置  spring                  # spring-實例配置，主要和binlog位置計算、一些策略配置相關，可以在canal.properties選用其中的任意一個配置文件  example                 # 實例配置文件夾，一般認為單個數據庫對應一個獨立的實例配置文件夾    instance.properties   # 實例配置，一般指單個數據庫的配置- lib   # 服務依賴包- logs  # 日誌文件輸出目錄</code></pre><p>在開發和測試環境建議把logback.xml的日誌級別修改為DEBUG方便定位問題。這裡需要關注canal.properties和instance.properties兩個配置文件。canal.properties文件中，需要修改：</p><ul><li>去掉canal.instance.parser.parallelThreadSize = 16這個配置項的<strong>註釋</strong>，也就是啟用此配置項，和實例解析器的線程數相關，不配置會表現為阻塞或者不進行解析。</li><li>canal.serverMode配置項指定為kafka，可選值有tcp、kafka和rocketmq（master分支或者最新的的v1.1.5-alpha-1版本，可以選用rabbitmq），默認是kafka。</li><li>canal.mq.servers配置需要指定為Kafka服務或者集群Broker的地址，這裡配置為127.0.0.1:9092。</li></ul><blockquote><p>canal.mq.servers在不同的canal.serverMode有不同的意義。 kafka模式下，指Kafka服務或者集群Broker的地址，也就是bootstrap.servers rocketmq模式下，指NameServer列表 rabbitmq模式下，指RabbitMQ服務的Host和Port</p></blockquote><p>其他配置項可以參考下面兩個官方Wiki的鏈接：</p><ul><li>Canal-Kafka-RocketMQ-QuickStart</li><li>AdminGuide</li></ul><p>instance.properties一般指一個數據庫實例的配置，Canal架構支持一個Canal服務實例，處理多個數據庫實例的binlog異步解析。instance.properties需要修改的配置項主要包括：</p><ul><li>canal.instance.mysql.slaveId需要配置一個和Master節點的服務ID完全不同的值，這裡筆者配置為654321。</li><li>配置數據源實例，包括地址、用戶、密碼和目標數據庫： canal.instance.master.address，這裡指定為127.0.0.1:3306。 canal.instance.dbUsername，這裡指定為canal。 canal.instance.dbPassword，這裡指定為QWqw12!@。 新增canal.instance.defaultDatabaseName，這裡指定為test（需要在MySQL中建立一個test數據庫，見前面的流程）。</li><li>Kafka相關配置，這裡暫時使用靜態topic和單個partition： canal.mq.topic，這裡指定為test，<strong>也就是解析完的binlog結構化數據會發送到Kafka的命名為test的topic中</strong>。 canal.mq.partition，這裡指定為0。</li></ul><p>配置工作做好之後，可以啟動Canal服務：</p><pre><code>sh /data/canal/bin/startup.sh # 查看服務日誌tail -100f /data/canal/logs/canal/canal# 查看實例日誌  -- 一般情況下，關注實例日誌即可tail -100f /data/canal/logs/example/example.log</code></pre><p>啟動正常後，見實例日誌如下：</p><p><br></p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5d899e1984b5448a97c88876f8f44b69><p class=pgc-img-caption></p></div><p><br></p><p>在test數據庫創建一個訂單表，並且執行幾個簡單的DML：</p><pre><code>use `test`;CREATE TABLE `order`(    id          BIGINT UNIQUE PRIMARY KEY AUTO_INCREMENT COMMENT '主鍵',    order_id    VARCHAR(64)    NOT NULL COMMENT '訂單ID',    amount      DECIMAL(10, 2) NOT NULL DEFAULT 0 COMMENT '訂單金額',    create_time DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',    UNIQUE uniq_order_id (`order_id`)) COMMENT '訂單表';INSERT INTO `order`(order_id, amount) VALUES ('10086', 999);UPDATE `order` SET amount = 10087 WHERE order_id = '10086';DELETE  FROM `order` WHERE order_id = '10086';</code></pre><p>這個時候，可以利用Kafka的kafka-console-consumer或者Kafka Tools查看test這個topic的數據：</p><pre><code>sh /data/kafka/kafka_2.13-2.4.0/bin/kafka-console-consumer.sh --bootstrap-server 127.0.0.1:9092 --from-beginning --topic test</code></pre><p><br></p><div class=pgc-img><img alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/86a283a62c6d4cf3a87cabf4085ea0c1><p class=pgc-img-caption></p></div><p><br></p><p>具體的數據如下：</p><pre><code>// test數據庫建庫腳本{"data":null,"database":"`test`","es":1583143732000,"id":1,"isDdl":false,"mysqlType":null,"old":null,"pkNames":null,"sql":"CREATE DATABASE `test` CHARSET `utf8mb4` COLLATE `utf8mb4_unicode_ci`","sqlType":null,"table":"","ts":1583143930177,"type":"QUERY"}// order表建表DDL{"data":null,"database":"test","es":1583143957000,"id":2,"isDdl":true,"mysqlType":null,"old":null,"pkNames":null,"sql":"CREATE TABLE `order`\n(\n    id          BIGINT UNIQUE PRIMARY KEY AUTO_INCREMENT COMMENT '主鍵',\n    order_id    VARCHAR(64)    NOT NULL COMMENT '訂單ID',\n    amount      DECIMAL(10, 2) NOT NULL DEFAULT 0 COMMENT '訂單金額',\n    create_time DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',\n    UNIQUE uniq_order_id (`order_id`)\n) COMMENT '訂單表'","sqlType":null,"table":"order","ts":1583143958045,"type":"CREATE"}// INSERT{"data":[{"id":"1","order_id":"10086","amount":"999.0","create_time":"2020-03-02 05:12:49"}],"database":"test","es":1583143969000,"id":3,"isDdl":false,"mysqlType":{"id":"BIGINT","order_id":"VARCHAR(64)","amount":"DECIMAL(10,2)","create_time":"DATETIME"},"old":null,"pkNames":["id"],"sql":"","sqlType":{"id":-5,"order_id":12,"amount":3,"create_time":93},"table":"order","ts":1583143969460,"type":"INSERT"}// UPDATE{"data":[{"id":"1","order_id":"10086","amount":"10087.0","create_time":"2020-03-02 05:12:49"}],"database":"test","es":1583143974000,"id":4,"isDdl":false,"mysqlType":{"id":"BIGINT","order_id":"VARCHAR(64)","amount":"DECIMAL(10,2)","create_time":"DATETIME"},"old":[{"amount":"999.0"}],"pkNames":["id"],"sql":"","sqlType":{"id":-5,"order_id":12,"amount":3,"create_time":93},"table":"order","ts":1583143974870,"type":"UPDATE"}// DELETE{"data":[{"id":"1","order_id":"10086","amount":"10087.0","create_time":"2020-03-02 05:12:49"}],"database":"test","es":1583143980000,"id":5,"isDdl":false,"mysqlType":{"id":"BIGINT","order_id":"VARCHAR(64)","amount":"DECIMAL(10,2)","create_time":"DATETIME"},"old":null,"pkNames":["id"],"sql":"","sqlType":{"id":-5,"order_id":12,"amount":3,"create_time":93},"table":"order","ts":1583143981091,"type":"DELETE"}</code></pre><p>可見Kafka的名為test的topic已經寫入了對應的結構化binlog事件數據，可以編寫消費者監聽Kafka對應的topic然後對獲取到的數據進行後續處理。</p><h2 class=heading>小結</h2><p>這篇文章大部分篇幅用於介紹其他中間件是怎麼部署的，這個問題側面說明了Canal本身部署並不複雜，它的配置文件屬性項比較多，但是實際上需要自定義和改動的配置項是比較少的，也就是說明了它的運維成本和學習成本並不高。後面會分析基於結構化binlog事件做ELT和持久化相關工作以及Canal的生產環境可用級別HA集群的搭建。</p><blockquote><p>來源：掘金 鏈接：https://juejin.im/post/5e6a6746f265da575c16d678</p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Canal</a></li><li><a>Kafka</a></li><li><a>實現</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/41e067fa.html alt="Canal 如何實現數據庫庫事務的一致性" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/c46cdca193864806be3dd7d81af2ccaf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/41e067fa.html title="Canal 如何實現數據庫庫事務的一致性">Canal 如何實現數據庫庫事務的一致性</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5c087c4.html alt=消息中間件：Kafka冪等性原理及實現剖析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4d0f8561c45c48fca5c067226e6cc913 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5c087c4.html title=消息中間件：Kafka冪等性原理及實現剖析>消息中間件：Kafka冪等性原理及實現剖析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f09ac34c.html alt=彩色電子書在廣州率先實現量產 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RkPMb9G6tipobr style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f09ac34c.html title=彩色電子書在廣州率先實現量產>彩色電子書在廣州率先實現量產</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2d12804e.html alt=[玩轉MySQL之九]MySQL實現ACID之原子性 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/bdb044d821f74107a3fd9119fc34c642 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2d12804e.html title=[玩轉MySQL之九]MySQL實現ACID之原子性>[玩轉MySQL之九]MySQL實現ACID之原子性</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html alt="「譯」 Spring 的分佈式事務實現—使用和不使用 XA—第二部分" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html title="「譯」 Spring 的分佈式事務實現—使用和不使用 XA—第二部分">「譯」 Spring 的分佈式事務實現—使用和不使用 XA—第二部分</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e41fd8de.html alt="撫順各項防汛工作實現“六到位” 確保全市安全度汛" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e41fd8de.html title="撫順各項防汛工作實現“六到位” 確保全市安全度汛">撫順各項防汛工作實現“六到位” 確保全市安全度汛</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f22ee5ad.html alt="Redis 設計與實現 : Lua 腳本" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f22ee5ad.html title="Redis 設計與實現 : Lua 腳本">Redis 設計與實現 : Lua 腳本</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/56e2a065.html alt=這位大叔在隨機的彩票上實現了90%的中獎率 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/50ab0003166decded7e4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/56e2a065.html title=這位大叔在隨機的彩票上實現了90%的中獎率>這位大叔在隨機的彩票上實現了90%的中獎率</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cf633068.html alt="Java 多態的實現機制，看了都說好" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9d3b0e55813d46b4982ae7d9b81d1802 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cf633068.html title="Java 多態的實現機制，看了都說好">Java 多態的實現機制，看了都說好</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d0662f03.html alt="廣西鐵路出海大通道 全面實現電氣化運營" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d0662f03.html title="廣西鐵路出海大通道 全面實現電氣化運營">廣西鐵路出海大通道 全面實現電氣化運營</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c78a6fe2.html alt=HashMap的底層實現 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/0f9ffe95e10e4ff5804a8fd9cf591cfc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c78a6fe2.html title=HashMap的底層實現>HashMap的底層實現</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a171e528.html alt=如何快速全面掌握Kafka？5000字吐血整理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RreaNY7GvCqWFq style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a171e528.html title=如何快速全面掌握Kafka？5000字吐血整理>如何快速全面掌握Kafka？5000字吐血整理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7c3d9f70.html alt=新穎的混合材料或有助於實現高效的下一代顯示器 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/47050004da4f36dcec1b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7c3d9f70.html title=新穎的混合材料或有助於實現高效的下一代顯示器>新穎的混合材料或有助於實現高效的下一代顯示器</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8d93e49d.html alt=教程：採用梯度下降算法實現線性迴歸！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1537162000876f4501fb1c4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8d93e49d.html title=教程：採用梯度下降算法實現線性迴歸！>教程：採用梯度下降算法實現線性迴歸！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e8e17d90.html alt=重要突破！中國科學家實現基底細胞癌4.1秒人工智能精準識別 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RtbWBYL9koJMmN style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e8e17d90.html title=重要突破！中國科學家實現基底細胞癌4.1秒人工智能精準識別>重要突破！中國科學家實現基底細胞癌4.1秒人工智能精準識別</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>