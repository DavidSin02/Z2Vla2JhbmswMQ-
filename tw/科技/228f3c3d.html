<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 | 极客快訊</title><meta property="og:title" content="還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/297b94665d5249589e96e7c427acc207"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/228f3c3d.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/228f3c3d.html><meta property="article:published_time" content="2020-11-14T21:06:12+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:12+08:00"><meta name=Keywords content><meta name=description content="還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/228f3c3d.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>自SpringCloud問世以來，微服務以席捲之勢風靡全球，企業架構都在從傳統SOA向微服務轉型。然而微服務這把雙刃劍在帶來各種優勢的同時，也給運維、性能監控、錯誤的排查帶來的極大的困難。</p><p style=text-align:start>在大型項目中，服務架構會包含數十乃至上百個服務節點。往往一次請求會設計到多個微服務，想要排查一次請求鏈路中經過了哪些節點，每個節點的執行情況如何，就成為了亟待解決的問題。於是分佈式系統的APM管理系統應運而生。</p><h1 class=pgc-h-arrow-right><strong>什麼是APM系統？</strong></h1><p style=text-align:start>APM系統可以幫助理解系統行為、用於分析性能問題的工具，以便發生故障的時候，能夠快速定位和解決問題，這就是APM系統，全稱是（<strong>A</strong>pplication <strong>P</strong>erformance <strong>M</strong>onitor）。</p><p style=text-align:start>谷歌公開的論文提到的Google Dapper可以說是最早的APM系統了，給google的開發者和運維團隊幫了大忙，所以谷歌公開論文分享了Dapper。</p><p style=text-align:start>而後，很多的技術公司基於這篇論文的原理，設計開發了很多出色的APM框架，例如Pinpoint、SkyWalking等。</p><p style=text-align:start>而SpringCloud官網也集成了一套這樣的系統：Spring Cloud Sleuth，結合Zipkin。</p><p style=text-align:start>APM的基本原理</p><p style=text-align:start>目前大部分的APM系統都是基於Google的Dapper原理實現，我們簡單來看看Dapper中的概念和實現原理。</p><p style=text-align:start>先來看一次請求調用示例：</p><ol start=1><li>服務集群中包括：前端（A），兩個中間層（B和C），以及兩個後端（D和E）</li><li>當用戶發起一個請求時，首先到達前端A服務，然後A分別對B服務和C服務進行RPC調用；</li><li>B服務處理完給A做出響應，但是C服務還需要和後端的D服務和E服務交互之後再返還給A服務，最後由A服務來響應用戶的請求；</li></ol><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/297b94665d5249589e96e7c427acc207><p class=pgc-img-caption></p></div><p style=text-align:start>如何才能實現跟蹤呢？</p><p style=text-align:start>Google的Dapper設計了下面的幾個概念用來記錄請求鏈路：</p><pre><code>Span：請求中的基本工作單元，每一次鏈路調用（RPC、Rest、數據庫調用）都會創建一個Span。大概結構如下：type Span struct { TraceID int64 // 用於標示一次完整的請求id Name string // 單元名稱 ID int64 // 當前這次調用span_id ParentID int64 // 上層服務的span_id,最上層服務parent_id為null，代表根服務 Annotation []Annotation // 註釋，用於記錄調用中的詳細信息，例如時間}</code></pre><ul><li>Trace：一次完整的調用鏈路，包含多個Span的樹狀結構，具有唯一的TraceID</li></ul><p style=text-align:start>一次請求的每個鏈路，通過spanId、parentId就能串聯起來：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15b0f233c8d74295816fec1dd879e3dc><p class=pgc-img-caption></p></div><p style=text-align:start>當然，從請求到服務器開始，服務器返回response結束，每個span存在相同的唯一標識trace_id。</p><h1 class=pgc-h-arrow-right><strong>APM的篩選標準</strong></h1><p style=text-align:start>目前主流的APM框架都會包含下列幾個組件來完成鏈路信息的收集和展示：</p><ul><li>探針（Agent）：負責在客戶端程序運行時搜索服務調用鏈路信息，發送給收集器</li><li>收集器（Collector）：負責將數據格式化，保存到存儲器</li><li>存儲器（Storage）：保存數據</li><li>UI界面（WebUI）：統計並展示收集到的信息</li></ul><p style=text-align:start>因此，要篩選一款合格的APM框架，就是對比各個組件的使用差異，主要對比項：</p><ul><li><strong>探針的性能</strong></li></ul><p style=text-align:start>主要是agent對服務的吞吐量、CPU和內存的影響。如果探針在收集微服務運行數據時，對微服務的運行產生了比較大的性能影響，相信沒什麼人願意使用。</p><ul><li><strong>collector的可擴展性</strong></li></ul><p style=text-align:start>能夠水平擴展以便支持大規模服務器集群，保證收集器的高可用特性。</p><ul><li><strong>全面的調用鏈路數據分析</strong></li></ul><p style=text-align:start>數據的分析要<strong>快</strong> ，分析的維度儘可能<strong>多</strong>。跟蹤系統能提供足夠快的信息反饋，就可以對生產環境下的異常狀況做出快速反應，最好提供代碼級別的可見性以便輕鬆定位失敗點和瓶頸。</p><ul><li><strong>對於開發透明，容易開關</strong></li></ul><p style=text-align:start>即也作為業務組件，應當儘可能少入侵或者無入侵其他業務系統，對於使用方透明，減少開發人員的負擔。</p><ul><li><strong>完整的調用鏈應用拓撲</strong></li></ul><p style=text-align:start>自動檢測應用拓撲，幫助你搞清楚應用的架構</p><p style=text-align:start>接下來，我們就對比下目前比較常見的三種APM框架的各項指標，分別是：</p><ul><li>ZIPkin：由Twitter公司開源，開放源代碼分佈式的跟蹤系統，用於收集服務的定時數據，以解決微服務架構中的延遲問題，包括：數據的收集、存儲、查找和展現。</li><li>Pinpoint：一款對Java編寫的大規模分佈式系統的APM工具，由韓國人開源的分佈式跟蹤組件。</li><li>Skywalking：國產的優秀APM組件，是一個對JAVA分佈式應用程序集群的業務運行情況進行追蹤、告警和分析的系統。現在是Apache的頂級項目之一</li></ul><p style=text-align:start>三者對比如下：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3eeda4c399884cfc8c10759dea30d9e3><p class=pgc-img-caption></p></div><p style=text-align:start>可見，zipkin的探針性能、開發透明性、數據分析能力都不佔優，實在是下下之選。</p><p style=text-align:start>而pinpoint在數據分析能力、開發透明性上有較大的優勢,不過Pinpoint的部署相對比較複雜，需要的硬件資源較高。</p><p style=text-align:start>Skywalking的探針性能和開發透明性上具有較大優勢，數據分析能力上也還不錯，重要的是其部署比較方便靈活，比起Pinpoint更適合中小型企業使用。</p><p style=text-align:start>因此，本文會帶著大家學習Skywalking的使用。</p><h1 class=pgc-h-arrow-right><strong>Skywalking介紹</strong></h1><p style=text-align:start><strong>SkyWalking</strong> 創建於2015年，提供分佈式追蹤功能。從5.x開始，項目進化為一個完成功能的Application Performance Management系統。 他被用於追蹤、監控和診斷分佈式系統，特別是使用微服務架構，雲原生或容積技術。提供以下主要功能：</p><ul><li>分佈式追蹤和上下文傳輸</li><li>應用、實例、服務性能指標分析</li><li>根源分析</li><li>應用拓撲分析</li><li>應用和服務依賴分析</li><li>慢服務檢測</li><li>性能優化</li></ul><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0dde17a79ce3440b9f81fa24a2dec7bc><p class=pgc-img-caption></p></div><p style=text-align:start>主要的特徵：</p><ul><li>多語言探針或類庫</li><ul><li>Java自動探針，追蹤和監控程序時，不需要修改源碼。</li><li>社區提供的其他多語言探針</li><ul><li>.NET Core</li><li>Node.js</li></ul></ul><li>多種後端存儲： ElasticSearch， H2</li><li>支持<br>OpenTracing</li><ul><li>Java自動探針支持和OpenTracing API協同工作</li></ul><li>輕量級、完善功能的後端聚合和分析</li><li>現代化Web UI</li><li>日誌集成</li><li>應用、實例和服務的告警</li></ul><h1 class=pgc-h-arrow-right><strong>Skywalking的安裝</strong></h1><p style=text-align:start>先來看下Skywalking的官方給出的結構圖：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15d06efdf7bb4ac5b8a692e25347d898><p class=pgc-img-caption></p></div><p style=text-align:start>大致分四個部分：</p><ul><li>skywalking-oap-server：就是<strong>O</strong>bservability <strong>A</strong>nalysis <strong>P</strong>latformd的服務，用來收集和處理探針發來的數據</li><li>skywalking-UI：就是skywalking提供的Web UI 服務，圖形化方式展示服務鏈路、拓撲圖、trace、性能監控等</li><li>agent：探針，獲取服務調用的鏈路信息、性能信息，發送到skywalking的OAP服務</li><li>Storage：存儲，一般選擇elasticsearch</li></ul><p style=text-align:start>Skywalking支持windows或者Linux環境部署。這裡我們選擇在Linux下安裝Skywalking，大家要<strong>先確保自己的Linux環境中有elasticsearch在啟動中</strong>。</p><p style=text-align:start>接下來的安裝分為三步：</p><ul><li>下載安裝包</li><li>安裝Skywalking的OAP服務和WebUI</li><li>在服務中部署探針</li></ul><h1 class=pgc-h-arrow-right><strong>下載安裝包</strong></h1><p style=text-align:start>安裝包可以在Skywalking的官網下載，</p><p style=text-align:start>目前最新版本是8.0.1版本：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/270cdf368fa944d1a1b2d4a93f53372e><p class=pgc-img-caption></p></div><p style=text-align:start>下載好的安裝包：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/68e66eda628844808370e3ddeda9ad2a><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>安裝OAP服務和WebUI</strong></h1><h1 class=pgc-h-arrow-right><strong>安裝</strong></h1><p style=text-align:start>將下載好的安裝包解壓到Linux的某個目錄下：</p><pre><code>tar xvf apache-skywalking-apm-es7-8.0.1.tar.gz</code></pre><p style=text-align:start>然後對解壓好的文件夾重命名：</p><pre><code>mv apache-skywalking-apm-es7 skywalking</code></pre><p style=text-align:start>進入解壓好的目錄：</p><pre><code>cd skywalking</code></pre><p style=text-align:start>查看目錄結構：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/93bad577a191492b93f7f6936541f4d7><p class=pgc-img-caption></p></div><p style=text-align:start>幾個關鍵的目錄：</p><ul><li>agent：探針</li><li>bin：啟動腳本</li><li>config：配置文件</li><li>logs：日誌</li><li>oap-libs：依賴</li><li>webapp：WebUI</li></ul><p style=text-align:start>這裡要修改config目錄中的application.yml文件，詳細配置見官網。</p><h1 class=pgc-h-arrow-right><strong>配置</strong></h1><p style=text-align:start>進入config目錄，修改application.yml，主要是把存儲方案從h2改為elasticsearch</p><p style=text-align:start>可以直接使用下面的配置：</p><pre><code>cluster:  selector: ${SW_CLUSTER:standalone}  standalone:core:  selector: ${SW_CORE:default}  default:    role: ${SW_CORE_ROLE:Mixed} # Mixed/Receiver/Aggregator    restHost: ${SW_CORE_REST_HOST:0.0.0.0}    restPort: ${SW_CORE_REST_PORT:12800}    restContextPath: ${SW_CORE_REST_CONTEXT_PATH:/}    gRPCHost: ${SW_CORE_GRPC_HOST:0.0.0.0}    gRPCPort: ${SW_CORE_GRPC_PORT:11800}    gRPCSslEnabled: ${SW_CORE_GRPC_SSL_ENABLED:false}    gRPCSslKeyPath: ${SW_CORE_GRPC_SSL_KEY_PATH:""}    gRPCSslCertChainPath: ${SW_CORE_GRPC_SSL_CERT_CHAIN_PATH:""}    gRPCSslTrustedCAPath: ${SW_CORE_GRPC_SSL_TRUSTED_CA_PATH:""}    downsampling:      - Hour      - Day      - Month    # Set a timeout on metrics data. After the timeout has expired, the metrics data will automatically be deleted.    enableDataKeeperExecutor: ${SW_CORE_ENABLE_DATA_KEEPER_EXECUTOR:true} # Turn it off then automatically metrics data delete will be close.    dataKeeperExecutePeriod: ${SW_CORE_DATA_KEEPER_EXECUTE_PERIOD:5} # How often the data keeper executor runs periodically, unit is minute    recordDataTTL: ${SW_CORE_RECORD_DATA_TTL:3} # Unit is day    metricsDataTTL: ${SW_CORE_RECORD_DATA_TTL:7} # Unit is day    # Cache metric data for 1 minute to reduce database queries, and if the OAP cluster changes within that minute,    # the metrics may not be accurate within that minute.    enableDatabaseSession: ${SW_CORE_ENABLE_DATABASE_SESSION:true}    topNReportPeriod: ${SW_CORE_TOPN_REPORT_PERIOD:10} # top_n record worker report cycle, unit is minute    # Extra model column are the column defined by in the codes, These columns of model are not required logically in aggregation or further query,    # and it will cause more load for memory, network of OAP and storage.    # But, being activated, user could see the name in the storage entities, which make users easier to use 3rd party tool, such as Kibana-&gt;ES, to query the data by themselves.    activeExtraModelColumns: ${SW_CORE_ACTIVE_EXTRA_MODEL_COLUMNS:false}    # The max length of service + instance names should be less than 200    serviceNameMaxLength: ${SW_SERVICE_NAME_MAX_LENGTH:70}    instanceNameMaxLength: ${SW_INSTANCE_NAME_MAX_LENGTH:70}    # The max length of service + endpoint names should be less than 240    endpointNameMaxLength: ${SW_ENDPOINT_NAME_MAX_LENGTH:150}storage:  selector: ${SW_STORAGE:elasticsearch7}  elasticsearch7:    nameSpace: ${SW_NAMESPACE:""}    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:localhost:9200}    protocol: ${SW_STORAGE_ES_HTTP_PROTOCOL:"http"}    trustStorePath: ${SW_STORAGE_ES_SSL_JKS_PATH:""}    trustStorePass: ${SW_STORAGE_ES_SSL_JKS_PASS:""}    dayStep: ${SW_STORAGE_DAY_STEP:1} # Represent the number of days in the one minute/hour/day index.    user: ${SW_ES_USER:""}    password: ${SW_ES_PASSWORD:""}    secretsManagementFile: ${SW_ES_SECRETS_MANAGEMENT_FILE:""} # Secrets management file in the properties format includes the username, password, which are managed by 3rd party tool.    indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS_NUMBER:1} # The index shards number is for store metrics data rather than basic segment record    superDatasetIndexShardsFactor: ${SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR:5} # Super data set has been defined in the codes, such as trace segments. This factor provides more shards for the super data set, shards number = indexShardsNumber * superDatasetIndexShardsFactor. Also, this factor effects Zipkin and Jaeger traces.    indexReplicasNumber: ${SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:0}    # Batch process setting, refer to https://www.elastic.co/guide/en/elasticsearch/client/java-api/5.5/java-docs-bulk-processor.html    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:1000} # Execute the bulk every 1000 requests    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:10} # flush the bulk every 10 seconds whatever the number of requests    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:2} # the number of concurrent requests    resultWindowMaxSize: ${SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000}    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:5000}    segmentQueryMaxSize: ${SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200}    profileTaskQueryMaxSize: ${SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200}    advanced: ${SW_STORAGE_ES_ADVANCED:""}  h2:    driver: ${SW_STORAGE_H2_DRIVER:org.h2.jdbcx.JdbcDataSource}    url: ${SW_STORAGE_H2_URL:jdbc:h2:mem:skywalking-oap-db}    user: ${SW_STORAGE_H2_USER:sa}    metadataQueryMaxSize: ${SW_STORAGE_H2_QUERY_MAX_SIZE:5000}receiver-sharing-server:  selector: ${SW_RECEIVER_SHARING_SERVER:default}  default:    authentication: ${SW_AUTHENTICATION:""}receiver-register:  selector: ${SW_RECEIVER_REGISTER:default}  default:receiver-trace:  selector: ${SW_RECEIVER_TRACE:default}  default:    sampleRate: ${SW_TRACE_SAMPLE_RATE:10000} # The sample rate precision is 1/10000. 10000 means 100% sample in default.    slowDBAccessThreshold: ${SW_SLOW_DB_THRESHOLD:default:200,mongodb:100} # The slow database access thresholds. Unit ms.​receiver-jvm:  selector: ${SW_RECEIVER_JVM:default}  default:​receiver-clr:  selector: ${SW_RECEIVER_CLR:default}  default:​receiver-profile:  selector: ${SW_RECEIVER_PROFILE:default}  default:​service-mesh:  selector: ${SW_SERVICE_MESH:default}  default:​istio-telemetry:  selector: ${SW_ISTIO_TELEMETRY:default}  default:​envoy-metric:  selector: ${SW_ENVOY_METRIC:default}  default:    acceptMetricsService: ${SW_ENVOY_METRIC_SERVICE:true}    alsHTTPAnalysis: ${SW_ENVOY_METRIC_ALS_HTTP_ANALYSIS:""}​prometheus-fetcher:  selector: ${SW_PROMETHEUS_FETCHER:default}  default:    active: ${SW_PROMETHEUS_FETCHER_ACTIVE:false}​receiver_zipkin:  selector: ${SW_RECEIVER_ZIPKIN:-}  default:    host: ${SW_RECEIVER_ZIPKIN_HOST:0.0.0.0}    port: ${SW_RECEIVER_ZIPKIN_PORT:9411}    contextPath: ${SW_RECEIVER_ZIPKIN_CONTEXT_PATH:/}​receiver_jaeger:  selector: ${SW_RECEIVER_JAEGER:-}  default:    gRPCHost: ${SW_RECEIVER_JAEGER_HOST:0.0.0.0}    gRPCPort: ${SW_RECEIVER_JAEGER_PORT:14250}​query:  selector: ${SW_QUERY:graphql}  graphql:    path: ${SW_QUERY_GRAPHQL_PATH:/graphql}​alarm:  selector: ${SW_ALARM:default}  default:​telemetry:  selector: ${SW_TELEMETRY:none}  none:  prometheus:    host: ${SW_TELEMETRY_PROMETHEUS_HOST:0.0.0.0}    port: ${SW_TELEMETRY_PROMETHEUS_PORT:1234}​configuration:  selector: ${SW_CONFIGURATION:none}  none:  grpc:    host: ${SW_DCS_SERVER_HOST:""}    port: ${SW_DCS_SERVER_PORT:80}    clusterName: ${SW_DCS_CLUSTER_NAME:SkyWalking}    period: ${SW_DCS_PERIOD:20}  apollo:    apolloMeta: ${SW_CONFIG_APOLLO:http://106.12.25.204:8080}    apolloCluster: ${SW_CONFIG_APOLLO_CLUSTER:default}    apolloEnv: ${SW_CONFIG_APOLLO_ENV:""}    appId: ${SW_CONFIG_APOLLO_APP_ID:skywalking}    period: ${SW_CONFIG_APOLLO_PERIOD:5}  zookeeper:    period: ${SW_CONFIG_ZK_PERIOD:60} # Unit seconds, sync period. Default fetch every 60 seconds.    nameSpace: ${SW_CONFIG_ZK_NAMESPACE:/default}    hostPort: ${SW_CONFIG_ZK_HOST_PORT:localhost:2181}    # Retry Policy    baseSleepTimeMs: ${SW_CONFIG_ZK_BASE_SLEEP_TIME_MS:1000} # initial amount of time to wait between retries    maxRetries: ${SW_CONFIG_ZK_MAX_RETRIES:3} # max number of times to retry  etcd:    period: ${SW_CONFIG_ETCD_PERIOD:60} # Unit seconds, sync period. Default fetch every 60 seconds.    group: ${SW_CONFIG_ETCD_GROUP:skywalking}    serverAddr: ${SW_CONFIG_ETCD_SERVER_ADDR:localhost:2379}    clusterName: ${SW_CONFIG_ETCD_CLUSTER_NAME:default}  consul:    # Consul host and ports, separated by comma, e.g. 1.2.3.4:8500,2.3.4.5:8500    hostAndPorts: ${SW_CONFIG_CONSUL_HOST_AND_PORTS:1.2.3.4:8500}    # Sync period in seconds. Defaults to 60 seconds.    period: ${SW_CONFIG_CONSUL_PERIOD:1}    # Consul aclToken    aclToken: ${SW_CONFIG_CONSUL_ACL_TOKEN:""}​exporter:  selector: ${SW_EXPORTER:-}  grpc:    targetHost: ${SW_EXPORTER_GRPC_HOST:127.0.0.1}    targetPort: ${SW_EXPORTER_GRPC_PORT:9870}​</code></pre><p style=text-align:start><br></p><h1 class=pgc-h-arrow-right><strong>啟動</strong></h1><p style=text-align:start>要確保已經啟動了elasticsearch，並且防火牆開放8080、11800、12800端口。</p><p style=text-align:start>進入bin目錄，執行命令即可運行：</p><pre><code>./startup.sh</code></pre><p style=text-align:start>默認的UI端口是8080</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7e2843bafa9d4261a1f5ab500f86552b><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>部署微服務探針</strong></h1><p style=text-align:start>現在，Skywalking的服務端已經啟動完成，我們還需要在微服務中加入服務探針，來收集數據。</p><h1 class=pgc-h-arrow-right><strong>解壓</strong></h1><p style=text-align:start>首先，將課前資料給的壓縮包解壓：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/bde980cd851d4faf8af0b364ffa2db83><p class=pgc-img-caption></p></div><p style=text-align:start>將其中的agent解壓到某個目錄，不要出現中文，可以看到其結構如下：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fe5578fff9964df581421a37f06d5656><p class=pgc-img-caption></p></div><p style=text-align:start>其中有一個skywalking-agent.jar就是一我們要用的探針。</p><h1 class=pgc-h-arrow-right><strong>配置</strong></h1><p style=text-align:start>如果是運行一個jar包，可以在運行時輸入參數來指定探針：</p><pre><code>java -jar xxx.jar -javaagent:C:/lesson/skywalking-agent/skywalking-agent.jar -Dskywalking.agent.service_name=ly-registry -Dskywalking.collector.backend_service=192.168.150.101:11800</code></pre><p style=text-align:start>本例中，我們用開發工具來運行和配置。</p><p style=text-align:start>使用IDEA開發工具打開一個你的項目，在IDEA工具中，選擇要修改的啟動項，點擊右鍵，選擇Edit Configuration：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6e491af19d014b408dee0782b58bcf90><p class=pgc-img-caption></p></div><p style=text-align:start>然後在彈出的窗口中，點擊Environment，選擇VM options後面對應的展開按鈕：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a46019ea2a9a45f996011ad2ca7139f4><p class=pgc-img-caption></p></div><p style=text-align:start>在展開的輸入框中，輸入下面的配置：</p><pre><code>-javaagent:C:/lesson/skywalking-agent/skywalking-agent.jar-Dskywalking.agent.service_name=ly-registry-Dskywalking.collector.backend_service=192.168.150.101:11800</code></pre><p style=text-align:start>注意：</p><ul><li>-javaagent:C:/lesson/skywalking-agent/skywalking-agent.jar：配置的是skywalking-agent.jar這個包的位置，要修改成你自己存放的目錄</li><li>-Dskywalking.agent.service_name=ly-registry：是當前項目的名稱，需要分別修改為ly-registry、ly-gateway、ly-item-service</li><li>-Dskywalking.collector.backend_service=192.168.150.101:11800：是Skywalking的OPA服務地址，採用的是GRPC通信，因此端口是11800，不是8080</li></ul><h1 class=pgc-h-arrow-right><strong>啟動</strong></h1><p style=text-align:start>Skywalking的探針會在項目啟動前對class文件進行修改，完成探針植入，對業務代碼<strong>零侵入</strong>，所以我們只需要啟動項目，即可生效了。</p><p style=text-align:start>啟動項目，然後對項目中的的業務接口訪問，探針就開始工作了。</p><h1 class=pgc-h-arrow-right><strong>WebUI界面</strong></h1><p style=text-align:start>訪問：192.168.150.101:8080可以看到統計數據已經出來了：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f63c4896bc9b4a60a5c714bf537ea8fe><p class=pgc-img-caption></p></div><p style=text-align:start>服務實例的性能監控：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/63de56bf28734aeca858c557bbfc0788><p class=pgc-img-caption></p></div><p style=text-align:start>服務拓撲圖：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/87d1f0999fca42508f66510c379f25cf><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/889bc84e0d614579ac3c74f3a557d83f><p class=pgc-img-caption></p></div><p style=text-align:start>某次請求的鏈路追蹤信息：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/cc03466c5dba49f5a29464b9fd70d7fd><p class=pgc-img-caption></p></div><p style=text-align:start>表格視圖：</p><div class=pgc-img><img alt=還在用Zipkin分佈式服務鏈路追蹤？來試試這個吧 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8fcf8a58c8de4628b9a143b0aba412d3><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>還在</a></li><li><a>Zipkin</a></li><li><a>服務鏈</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/c618e23b.html alt=虹吸式馬桶的種類有哪些？你還在為不知道選哪種而苦惱嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RNyjN9vAulrrXD style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c618e23b.html title=虹吸式馬桶的種類有哪些？你還在為不知道選哪種而苦惱嗎？>虹吸式馬桶的種類有哪些？你還在為不知道選哪種而苦惱嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cea55527.html alt="多列數據合併一列，還在用數據透視就out了，用=號只要三步完成" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/7aa6ee1b961f467e8090ed56f45c110f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cea55527.html title="多列數據合併一列，還在用數據透視就out了，用=號只要三步完成">多列數據合併一列，還在用數據透視就out了，用=號只要三步完成</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1b683477.html alt=看車還在只看外觀嗎？老司機教你點實在的，看這6個發動機參數 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1533117447462aeabb80278 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1b683477.html title=看車還在只看外觀嗎？老司機教你點實在的，看這6個發動機參數>看車還在只看外觀嗎？老司機教你點實在的，看這6個發動機參數</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/41722098.html alt=明朝第一段子手，臨死前竟還在開玩笑？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/Rkgp4zPCCSUmdk style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/41722098.html title=明朝第一段子手，臨死前竟還在開玩笑？>明朝第一段子手，臨死前竟還在開玩笑？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a23ee376.html alt=這個暑期，你還在回憶她？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1532944743742883a3bf8f9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a23ee376.html title=這個暑期，你還在回憶她？>這個暑期，你還在回憶她？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8289db50.html alt=還在糾結怎麼選鑄造用球化劑孕育劑？不用愁乾貨來了 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1d2d1d8a450e4522a1b523bab45c3a88 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8289db50.html title=還在糾結怎麼選鑄造用球化劑孕育劑？不用愁乾貨來了>還在糾結怎麼選鑄造用球化劑孕育劑？不用愁乾貨來了</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2fe16525.html alt=六月畢業季，你還在為哪份工作而糾結嗎？一份鏈家新人訓，請接好 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/6cd7fa1a56cf43afb4b38b4427e971ab style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2fe16525.html title=六月畢業季，你還在為哪份工作而糾結嗎？一份鏈家新人訓，請接好>六月畢業季，你還在為哪份工作而糾結嗎？一份鏈家新人訓，請接好</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8881266c.html alt="還在用 if else？試試策略模式吧" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RcOtMMX2P9Kha3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8881266c.html title="還在用 if else？試試策略模式吧">還在用 if else？試試策略模式吧</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/93abed88.html alt=我的世界：還在盲目挖礦？去海底試試，不僅怪物少，而且礦物多 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/175ede27499047218441ffc22585fd94 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/93abed88.html title=我的世界：還在盲目挖礦？去海底試試，不僅怪物少，而且礦物多>我的世界：還在盲目挖礦？去海底試試，不僅怪物少，而且礦物多</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6d56b349.html alt=你還在用嗎？鑄造用煤粉粘土砂的這些弊端不容忽視 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/bfde558fc25642479007c14876e7828d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6d56b349.html title=你還在用嗎？鑄造用煤粉粘土砂的這些弊端不容忽視>你還在用嗎？鑄造用煤粉粘土砂的這些弊端不容忽視</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/68e9b1cd.html alt=還在裝修上瞎花錢？帶上激光測距筆，每一丈自己來精準測量 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/392604cf8e0a4159a4b7e80b0a76baa3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/68e9b1cd.html title=還在裝修上瞎花錢？帶上激光測距筆，每一丈自己來精準測量>還在裝修上瞎花錢？帶上激光測距筆，每一丈自己來精準測量</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8845b2f0.html alt=還在擔心論文寫不出來，推薦你用“狗屁不通文章生成器” class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d57b32204e8041f58ba2460270893cea style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8845b2f0.html title=還在擔心論文寫不出來，推薦你用“狗屁不通文章生成器”>還在擔心論文寫不出來，推薦你用“狗屁不通文章生成器”</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b1f2f5bb.html alt=還在糾結機械鍵盤和薄膜鍵盤買哪個？機械鍵盤與普通鍵盤二三事 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5f95c6e1886e4c35991fdb84d44339ad style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b1f2f5bb.html title=還在糾結機械鍵盤和薄膜鍵盤買哪個？機械鍵盤與普通鍵盤二三事>還在糾結機械鍵盤和薄膜鍵盤買哪個？機械鍵盤與普通鍵盤二三事</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/24d1299f.html alt=你還在為電腦主板的M.2接口不夠用而發愁？技嘉新款四路M.2轉接卡 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d1da275ceb3d407d807404843d906c51 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/24d1299f.html title=你還在為電腦主板的M.2接口不夠用而發愁？技嘉新款四路M.2轉接卡>你還在為電腦主板的M.2接口不夠用而發愁？技嘉新款四路M.2轉接卡</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/29f63c70.html alt=你還在用不合格消防泵嗎，告訴你該如何選擇一臺合格的消防泵 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/65ad7512-8adb-4e2d-93f1-58ddbc53bb8c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/29f63c70.html title=你還在用不合格消防泵嗎，告訴你該如何選擇一臺合格的消防泵>你還在用不合格消防泵嗎，告訴你該如何選擇一臺合格的消防泵</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>