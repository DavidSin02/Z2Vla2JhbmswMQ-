<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>mysql、redis、mongodb都是怎麼實現 “附近的人” 功能的？ | 极客快訊</title><meta property="og:title" content="mysql、redis、mongodb都是怎麼實現 “附近的人” 功能的？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/755adf1b67cc4dcabb1650fc140b4e3e"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/229ec9a.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/229ec9a.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/229ec9a.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/229ec9a.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/229ec9a.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/229ec9a.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/229ec9a.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/229ec9a.html><meta property="article:published_time" content="2020-10-29T20:53:21+08:00"><meta property="article:modified_time" content="2020-10-29T20:53:21+08:00"><meta name=Keywords content><meta name=description content="mysql、redis、mongodb都是怎麼實現 “附近的人” 功能的？"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/229ec9a.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>mysql、redis、mongodb都是怎麼實現 “附近的人” 功能的？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>引言</h1><p>昨天一位公眾號粉絲和我討論了一道面試題，個人覺得比較有意義，這裡整理了一下分享給大家，願小夥伴們面試路上少踩坑。面試題目比較簡單：“讓你實現一個附近的人功能，你有什麼方案？”，這道題其實主要還是考察大家對於技術的廣度，本文介紹幾種方案，給大家一點思路，避免在面試過程中語塞而影響面試結果，如有不嚴謹之處，還望親人們溫柔指正！</p><p>“附近的人” 功能生活中是比較常用的，像外賣app附近的餐廳，共享單車app裡附近的車輛。既然常用面試被問的概率就很大，所以下面依次來分析基於mysql數據庫、Redis、 MongoDB實現的 “附近的人” 功能。</p><div class=pgc-img><img alt="mysql、redis、mongodb都是怎麼實現 “附近的人” 功能的？" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/755adf1b67cc4dcabb1650fc140b4e3e><p class=pgc-img-caption></p></div><p>在這裡插入圖片描述</p><p><br><strong>科普</strong>：世界上標識一個位置，通用的做法就使用經、緯度。經度的範圍在 (-180, 180]，緯度的範圍 在(-90, 90]，緯度正負以赤道為界，北正南負，經度正負以本初子午線 (英國格林尼治天文臺) 為界，東正西負。比如：望京摩托羅拉大廈的經、緯度（116.49141，40.01229）全是正數，就是因為我國位於東北半球。</p><p><br></p><hr><h1 class=pgc-h-arrow-right>一、“附近的人”原理</h1><p>“附近的人” 也就是常說的 LBS (Location Based Services，基於位置服務)，它圍繞用戶當前地理位置數據而展開的服務，為用戶提供精準的增值服務。</p><p>“附近的人” 核心思想如下：</p><ol start=1><li>以 “我” 為中心，搜索附近的用戶</li><li>以 “我” 當前的地理位置為準，計算出別人和 “我” 之間的距離</li><li>按 “我” 與別人距離的遠近排序，篩選出離我最近的用戶或者商店等在這裡插入圖片描述</li></ol><h1 class=pgc-h-arrow-right>二、什麼是GeoHash算法？</h1><p>在說 “附近的人” 功能的具體實現之前，先來認識一下GeoHash 算法，因為後邊會一直和它打交道。定位一個位置最好的辦法就是用經、緯度標識，但經、緯度它是二維的，在進行位置計算的時候還是很麻煩，如果能通過某種方法將二維的經、緯度數據轉換成一維的數據，那麼比較起來就要容易的多，因此GeoHash算法應運而生。</p><p>GeoHash算法將二維的經、緯度轉換成一個字符串，例如：下圖中9個GeoHash字符串代表了9個區域，每一個字符串代表了一矩形區域。而這個矩形區域內其他的點（經、緯度）都用同一個GeoHash字符串表示。</p><div class=pgc-img><img alt="mysql、redis、mongodb都是怎麼實現 “附近的人” 功能的？" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/59915f7a362347bc9fa5f51cb2437e98><p class=pgc-img-caption></p></div><p>在這裡插入圖片描述</p><p><strong>比如</strong>：WX4ER區域內的用戶搜索附近的餐廳數據，由於這區域內用戶的GeoHash字符串都是WX4ER，故可以把WX4ER當作key，餐廳信息作為value進行緩存；而如果不使用GeoHash算法，區域內的用戶請求餐廳數據，用戶傳來的經、緯度都是不同的，這樣緩存不僅麻煩且數據量巨大。</p><p>GeoHash字符串越長，表示的位置越精確，字符串長度越長代表在距離上的誤差越小。下圖geohash碼精度表：</p><p><strong>geohash碼長度寬度高度</strong>15,009.4km4,992.6km21,252.3km624.1km3156.5km156km439.1km19.5km54.9km4.9km61.2km609.4m7152.9m152.4m838.2m19m94.8m4.8m101.2m59.5cm1114.9cm14.9cm123.7cm1.9cm</p><p>而且字符串越相似表示距離越相近，字符串前綴匹配越多的距離越近。比如：下邊的經、緯度就代表了三家距離相近的餐廳。</p><p><strong>商戶經緯度Geohash字符串</strong>串串香116.402843,39.999375wx4er9v火鍋116.3967,39.99932wx4ertk烤肉116.40382,39.918118wx4erfe</p><p>讓大家簡單瞭解什麼是GeoHash算法，方便後邊內容展開，GeoHash算法內容比較高深，感興趣的小夥伴自行深耕一下，這裡不佔用過多篇幅（其實是我懂得太膚淺，哭唧唧~）。</p><h1 class=pgc-h-arrow-right>三、基於Mysql</h1><p>此種方式是純基於mysql實現的，未使用GeoHash算法。</p><h1 class=pgc-h-arrow-right>1、設計思路</h1><p>以用戶為中心，假設給定一個500米的距離作為半徑畫一個圓，這個圓型區域內的所有用戶就是符合用戶要求的 “附近的人”。但有一個問題是圓形有弧度啊，直接搜索圓形區域難度太大，根本無法用經、緯度直接搜索。</p><p>但如果在圓形外套上一個正方形，通過獲取用戶經、緯度的最大最小值（經、緯度 + 距離），再根據最大最小值作為篩選條件，就很容易將正方形內的用戶信息搜索出來。</p><p>那麼問題又來了，<strong>多出來一些面積腫麼辦？</strong></p><p>我們來分析一下，多出來的這部分區域內的用戶，到圓點的距離一定比圓的半徑要大，那麼我們就計算用戶中心點與正方形內所有用戶的距離，篩選出所有距離小於等於半徑的用戶，圓形區域內的所用戶即符合要求的“附近的人”。</p><div class=pgc-img><img alt="mysql、redis、mongodb都是怎麼實現 “附近的人” 功能的？" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/07e0e9119d7a47ceb63f5bf06e99d75a><p class=pgc-img-caption></p></div><p>在這裡插入圖片描述</p><h1 class=pgc-h-arrow-right>2、利弊分析</h1><p>純基於 mysql 實現 “附近的人”，優點顯而易見就是簡單，只要建一張表存下用戶的經、緯度信息即可。缺點也很明顯，需要大量的計算兩個點之間的距離，非常影響性能。</p><h1 class=pgc-h-arrow-right>3、實現</h1><p>創建一個簡單的表用來存放用戶的經、緯度屬性。</p><pre><code>1CREATE TABLE `nearby_user` (2  `id` int(11) NOT NULL AUTO_INCREMENT,3  `name` varchar(255) DEFAULT NULL COMMENT '名稱',4  `longitude` double DEFAULT NULL COMMENT '經度',5  `latitude` double DEFAULT NULL COMMENT '緯度',6  `create_time` datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '創建時間',7  PRIMARY KEY (`id`)8) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</code></pre><p>計算兩個點之間的距離，用了一個三方的類庫，畢竟自己造的輪子不是特別圓，還有可能是方的，啊哈哈哈~</p><pre><code>1&lt;dependency&gt;2     &lt;groupId&gt;com.spatial4j&lt;/groupId&gt;3     &lt;artifactId&gt;spatial4j&lt;/artifactId&gt;4     &lt;version&gt;0.5&lt;/version&gt;5&lt;/dependency&gt;</code></pre><p>獲取到外接正方形後，以正方形的最大最小經、緯度值搜索正方形區域內的用戶，再剔除超過指定距離的用戶，就是最終的附近的人。</p><pre><code> 1    private SpatialContext spatialContext = SpatialContext.GEO;     2 3    /** 4     * 獲取附近 x 米的人 5     * 6     * @param distance 搜索距離範圍 單位km 7     * @param userLng  當前用戶的經度 8     * @param userLat  當前用戶的緯度 9     */10    @GetMapping("/nearby")11    public String nearBySearch(@RequestParam("distance") double distance,12                               @RequestParam("userLng") double userLng,13                               @RequestParam("userLat") double userLat) {14        //1.獲取外接正方形15        Rectangle rectangle = getRectangle(distance, userLng, userLat);16        //2.獲取位置在正方形內的所有用戶17        List&lt;User&gt; users = userMapper.selectUser(rectangle.getMinX(), rectangle.getMaxX(), rectangle.getMinY(), rectangle.getMaxY());18        //3.剔除半徑超過指定距離的多餘用戶19        users = users.stream()20            .filter(a -&gt; getDistance(a.getLongitude(), a.getLatitude(), userLng, userLat) &lt;= distance)21            .collect(Collectors.toList());22        return JSON.toJSONString(users);23    }2425    private Rectangle getRectangle(double distance, double userLng, double userLat) {26        return spatialContext.getDistCalc()27            .calcBoxByDistFromPt(spatialContext.makePoint(userLng, userLat), 28                                 distance * DistanceUtils.KM_TO_DEG, spatialContext, null);29    }</code></pre><p>由於用戶間距離的排序是在業務代碼中實現的，可以看到SQL語句也非常的簡單。</p><pre><code>1    &lt;select id="selectUser" resultMap="BaseResultMap"&gt;2        SELECT * FROM user3        WHERE 1=14        and (longitude BETWEEN ${minlng} AND ${maxlng})5        and (latitude BETWEEN ${minlat} AND ${maxlat})6    &lt;/select&gt;7</code></pre><h1 class=pgc-h-arrow-right>四、Mysql + GeoHash</h1><h1 class=pgc-h-arrow-right>1、設計思路</h1><p>這種方式的設計思路更簡單，在存用戶位置信息時，根據用戶經、緯度屬性計算出相應的geohash字符串。<strong>注意</strong>：在計算geohash字符串時，需要指定geohash字符串的精度，也就是geohash字符串的長度，<strong>參考上邊的geohash精度表</strong>。</p><p>當需要獲取附近的人，只需用當前用戶geohash字符串，數據庫通過WHERE geohash Like 'geocode%' 來查詢geohash字符串相似的用戶，然後計算當前用戶與搜索出的用戶距離，篩選出所有距離小於等於指定距離（附近500米）的，即附近的人。</p><h1 class=pgc-h-arrow-right>2、利弊分析</h1><p>利用GeoHash算法實現“附近的人”有一個問題，由於geohash算法將地圖分為一個個矩形，對每個矩形進行編碼，得到geohash字符串。可我當前的點與鄰近的點很近，但恰好我們分別在兩個區域，明明就在眼前的點偏偏搜不到，實實在在的燈下黑。</p><p><strong>如何解決這一問題？</strong></p><p>為了避免類似鄰近兩點在不同區域內，我們就需要同時獲取當前點（WX4G0）所在區域附近 8個區域的geohash碼，一併進行篩選比較。</p><div class=pgc-img><img alt="mysql、redis、mongodb都是怎麼實現 “附近的人” 功能的？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/af8d25d6208d4982b7264ba80aaa84e9><p class=pgc-img-caption></p></div><p>在這裡插入圖片描述</p><h1 class=pgc-h-arrow-right>3、實現</h1><p>同樣要設計一張表存用戶的經、緯度信息，但區別是要多一個geo_code字段，存放geohash字符串，此字段通過用戶經、緯度屬性計算出。使用頻繁的字段建議加上索引。</p><pre><code> 1CREATE TABLE `nearby_user_geohash` ( 2  `id` int(11) NOT NULL AUTO_INCREMENT, 3  `name` varchar(255) DEFAULT NULL COMMENT '名稱', 4  `longitude` double DEFAULT NULL COMMENT '經度', 5  `latitude` double DEFAULT NULL COMMENT '緯度', 6  `geo_code` varchar(64) DEFAULT NULL COMMENT '經緯度所計算的geohash碼', 7  `create_time` datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '創建時間', 8  PRIMARY KEY (`id`), 9  KEY `index_geo_hash` (`geo_code`)10) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</code></pre><p>首先根據用戶經、緯度信息，在指定精度後計算用戶座標的geoHash碼，再獲取到用戶周邊8個方位的geoHash碼在數據庫中搜索用戶，最後過濾掉超出給定距離（500米內）的用戶。</p><pre><code> 1 private SpatialContext spatialContext = SpatialContext.GEO; 2 3    /*** 4     * 添加用戶 5     * @return 6     */ 7    @PostMapping("/addUser") 8    public boolean add(@RequestBody UserGeohash user) { 9        //默認精度12位10        String geoHashCode = GeohashUtils.encodeLatLon(user.getLatitude(),user.getLongitude());11        return userGeohashService.save(user.setGeoCode(geoHashCode).setCreateTime(LocalDateTime.now()));12    }131415/**16     * 獲取附近指定範圍的人17     *18     * @param distance 距離範圍（附近多遠的用戶） 單位km19     * @param len      geoHash的精度（幾位的字符串）20     * @param userLng  當前用戶的經度21     * @param userLat  當前用戶的緯度22     * @return json23     */24    @GetMapping("/nearby")25    public String nearBySearch(@RequestParam("distance") double distance,26                               @RequestParam("len") int len,27                               @RequestParam("userLng") double userLng,28                               @RequestParam("userLat") double userLat) {293031        //1.根據要求的範圍，確定geoHash碼的精度，獲取到當前用戶座標的geoHash碼32        GeoHash geoHash = GeoHash.withCharacterPrecision(userLat, userLng, len);33        //2.獲取到用戶周邊8個方位的geoHash碼34        GeoHash[] adjacent = geoHash.getAdjacent();3536        QueryWrapper&lt;UserGeohash&gt; queryWrapper = new QueryWrapper&lt;UserGeohash&gt;()37            .likeRight("geo_code",geoHash.toBase32());38        Stream.of(adjacent).forEach(a -&gt; queryWrapper.or().likeRight("geo_code",a.toBase32()));3940        //3.匹配指定精度的geoHash碼41        List&lt;UserGeohash&gt; users = userGeohashService.list(queryWrapper);42        //4.過濾超出距離的43        users = users.stream()44                .filter(a -&gt;getDistance(a.getLongitude(),a.getLatitude(),userLng,userLat)&lt;= distance)45                .collect(Collectors.toList());46        return JSON.toJSONString(users);47    }484950    /***51     * 球面中，兩點間的距離52     * @param longitude 經度153     * @param latitude  緯度154     * @param userLng   經度255     * @param userLat   緯度256     * @return 返回距離，單位km57     */58    private double getDistance(Double longitude, Double latitude, double userLng, double userLat) {59        return spatialContext.calcDistance(spatialContext.makePoint(userLng, userLat),60                spatialContext.makePoint(longitude, latitude)) * DistanceUtils.DEG_TO_KM;61    }</code></pre><h1 class=pgc-h-arrow-right>五、Redis + GeoHash</h1><p>Redis 3.2版本以後，基於geohash和數據結構Zset提供了地理位置相關功能。通過上邊兩種mysql的實現方式發現，附近的人功能是明顯的讀多寫少場景，所以用redis性能更會有很大的提升。</p><h1 class=pgc-h-arrow-right>1、設計思路</h1><p>redis 實現附近的人功能主要通過Geo模塊的六個命令。</p><ul><li>GEOADD：將給定的位置對象（緯度、經度、名字）添加到指定的key;</li><li>GEOPOS：從key裡面返回所有給定位置對象的位置（經度和緯度）;</li><li>GEODIST：返回兩個給定位置之間的距離;</li><li>GEOHASH：返回一個或多個位置對象的Geohash表示;</li><li>GEORADIUS：以給定的經緯度為中心，返回目標集合中與中心的距離不超過給定最大距離的所有位置對象;</li><li>GEORADIUSBYMEMBER：以給定的位置對象為中心，返回與其距離不超過給定最大距離的所有位置對象。</li></ul><p>以GEOADD 命令和GEORADIUS 命令簡單舉例：</p><pre><code>1GEOADD key longitude latitude member [longitude latitude member ...]</code></pre><p>其中，key為集合名稱，member為該經緯度所對應的對象。</p><p>GEOADD 添加多個商戶“火鍋店”位置信息：</p><pre><code>1GEOADD hotel 119.98866180732716    30.27465803229662 火鍋店</code></pre><p>GEORADIUS 根據給定的經緯度為中心，獲取目標集合中與中心的距離不超過給定最大距離（500米內）的所有位置對象，也就是“附近的人”。</p><pre><code>1GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [ASC|DESC] [COUNT count] [STORE key] [STORedisT key]</code></pre><p>範圍單位：m | km | ft | mi --> 米 | 千米 | 英尺 | 英里。</p><ul><li>WITHDIST：在返回位置對象的同時，將位置對象與中心之間的距離也一併返回。距離的單位和用戶給定的範圍單位保持一致。</li><li>WITHCOORD：將位置對象的經度和維度也一併返回。</li><li>WITHHASH：以 52 位有符號整數的形式，返回位置對象經過原始 geohash 編碼的有序集合分值。這個選項主要用於底層應用或者調試，實際中的作用並不大。</li><li>ASC | DESC：從近到遠返回位置對象元素 | 從遠到近返回位置對象元素。</li><li>COUNT count：選取前N個匹配位置對象元素。（不設置則返回所有元素）</li><li>STORE key：將返回結果的地理位置信息保存到指定key。</li><li>STORedisT key：將返回結果離中心點的距離保存到指定key。</li></ul><p>例如下邊命令：獲取當前位置周邊500米內的所有飯店。</p><pre><code>1GEORADIUS hotel 119.98866180732716    30.27465803229662 500 m WITHCOORD</code></pre><p>Redis內部使用有序集合(zset)保存用戶的位置信息，zset中每個元素都是一個帶位置的對象，元素的score值為通過經、緯度計算出的52位geohash值。</p><h1 class=pgc-h-arrow-right>2、利弊分析</h1><p>redis實現附近的人效率比較高，集成也比較簡單，而且還支持對距離排序。不過，結果存在一定的誤差，要想讓結果更加精確，還需要手動將用戶中心位置與其他用戶位置計算距離後，再一次進行篩選。</p><h1 class=pgc-h-arrow-right>3、實現</h1><p>以下就是Java redis實現版本，代碼非常的簡潔。</p><pre><code> 1 @Autowired 2    private RedisTemplate&lt;String, Object&gt; redisTemplate; 3 4    //GEO相關命令用到的KEY 5    private final static String KEY = "user_info"; 6 7    public boolean save(User user) { 8        Long flag = redisTemplate.opsForGeo().add(KEY, new RedisGeoCommands.GeoLocation&lt;&gt;( 9                user.getName(), 10                new Point(user.getLongitude(), user.getLatitude()))11        );12        return flag != null &amp;&amp; flag &gt; 0;13    }1415    /**16     * 根據當前位置獲取附近指定範圍內的用戶17     * @param distance 指定範圍 單位km ，可根據{@link org.springframework.data.geo.Metrics} 進行設置18     * @param userLng 用戶經度19     * @param userLat 用戶緯度20     * @return21     */22    public String nearBySearch(double distance, double userLng, double userLat) {23        List&lt;User&gt; users = new ArrayList&lt;&gt;();24        // 1.GEORADIUS獲取附近範圍內的信息25        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;Object&gt;&gt; reslut = 26            redisTemplate.opsForGeo().radius(KEY, 27                        new Circle(new Point(userLng, userLat), new Distance(distance, Metrics.KILOMETERS)),28                        RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs()29                                .includeDistance()30                                .includeCoordinates().sortAscending());31        //2.收集信息，存入list32        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;Object&gt;&gt;&gt; content = reslut.getContent();33        //3.過濾掉超過距離的數據34        content.forEach(a-&gt; users.add(35                new User().setDistance(a.getDistance().getValue())36                .setLatitude(a.getContent().getPoint().getX())37                .setLongitude(a.getContent().getPoint().getY())));38        return JSON.toJSONString(users);39    }</code></pre><h1 class=pgc-h-arrow-right>六、MongoDB + 2d索引</h1><h1 class=pgc-h-arrow-right>1、設計思路</h1><p>MongoDB實現附近的人，主要是通過它的兩種地理空間索引 2dsphere 和 2d。 兩種索引的底層依然是基於Geohash來進行構建的。但與國際通用的Geohash還有一些不同，具體參考官方文檔。</p><p>2dsphere 索引僅支持球形表面的幾何形狀查詢。</p><p>2d 索引支持平面幾何形狀和一些球形查詢。雖然2d 索引支持某些球形查詢，但 2d 索引對這些球形查詢時，可能會出錯。所以球形查詢儘量選擇 2dsphere索引。</p><p>儘管兩種索引的方式不同，但只要座標跨度不太大，這兩個索引計算出的距離相差幾乎可以忽略不計。</p><h1 class=pgc-h-arrow-right>2、實現</h1><p>首先插入一批位置數據到MongoDB， collection為起名 hotel，相當於MySQL的表名。兩個字段name名稱，location 為經、緯度數據對。</p><pre><code> 1db.hotel.insertMany([ 2 {'name':'hotel1',  location:[115.993121,28.676436]}, 3 {'name':'hotel2',  location:[116.000093,28.679402]}, 4 {'name':'hotel3',  location:[115.999967,28.679743]}, 5 {'name':'hotel4',  location:[115.995593,28.681632]}, 6 {'name':'hotel5',  location:[115.975543,28.679509]}, 7 {'name':'hotel6',  location:[115.968428,28.669368]}, 8 {'name':'hotel7',  location:[116.035262,28.677037]}, 9 {'name':'hotel8',  location:[116.024770,28.68667]},10 {'name':'hotel9',  location:[116.002384,28.683865]},11 {'name':'hotel10', location:[116.000821,28.68129]},12])</code></pre><p>接下來我們給 location 字段創建一個2d索引，索引的精度通過bits來指定，bits越大，索引的精度就越高。</p><pre><code>1db.coll.createIndex({'location':"2d"}, {"bits":11111})</code></pre><p>用geoNear命令測試一下， near 當前座標（經、緯度），spherical 是否計算球面距離，distanceMultiplier地球半徑，單位是米，默認6378137， maxDistance 過濾條件（指定距離內的用戶），開啟弧度需除distanceMultiplier，distanceField 計算出的兩點間距離，字段別名（隨意取名）。</p><pre><code>1db.hotel.aggregate({2    $geoNear:{3        near: [115.999567,28.681813], // 當前座標4        spherical: true, // 計算球面距離5        distanceMultiplier: 6378137, // 地球半徑,單位是米,那麼的除的記錄也是米6        maxDistance: 2000/6378137, // 過濾條件2000米內，需要弧度7        distanceField: "distance" // 距離字段別名8    }9})</code></pre><p>看到結果中有符合條件的數據，還多出一個字段distance 剛才設置的別名，代表兩點間的距離。</p><pre><code>1{ "_id" : ObjectId("5e96a5c91b8d4ce765381e58"), "name" : "hotel10", "location" : [ 116.000821, 28.68129 ], "distance" : 135.60095397487655 }2{ "_id" : ObjectId("5e96a5c91b8d4ce765381e51"), "name" : "hotel3", "location" : [ 115.999967, 28.679743 ], "distance" : 233.71915803517447 }3{ "_id" : ObjectId("5e96a5c91b8d4ce765381e50"), "name" : "hotel2", "location" : [ 116.000093, 28.679402 ], "distance" : 273.26317035334176 }4{ "_id" : ObjectId("5e96a5c91b8d4ce765381e57"), "name" : "hotel9", "location" : [ 116.002384, 28.683865 ], "distance" : 357.5791936927476 }5{ "_id" : ObjectId("5e96a5c91b8d4ce765381e52"), "name" : "hotel4", "location" : [ 115.995593, 28.681632 ], "distance" : 388.62555058249967 }6{ "_id" : ObjectId("5e96a5c91b8d4ce765381e4f"), "name" : "hotel1", "location" : [ 115.993121, 28.676436 ], "distance" : 868.6740526419927 }</code></pre><h1 class=pgc-h-arrow-right>總結</h1><p>本文重點並不是在具體實現，旨在給大家提供一些設計思路，面試中可能你對某一項技術瞭解的並不深入，但如果你的知識面寬，可以從多方面說出多種設計的思路，能夠侃侃而談，那麼會給面試官極大的好感度，拿到offer的概率就會高很多。而且“附近的人” 功能使用的場景比較多，尤其是像電商平臺應用更為廣泛，所以想要進大廠的同學，這類的知識點還是應該有所瞭解的。</p><hr><p>代碼實現借鑑了一位大佬的開源項目，這裡有前三種實現方式的demo，感興趣的小夥伴可以學習一下，GitHub地址：https://github.com/larscheng/larscheng-learning-demo/tree/master/NearbySearch，。</p><p><br></p><h1 class=pgc-h-arrow-right>感悟</h1><p>從正式成為一名程序員的那天起，註定要進行沒有止境的學習，想要進階高級或者專家，就要堅持每天都高效的學習，不要給自己的懶惰找藉口，“什麼我也想學習可是又沒有資源”，這次我給你整理好了，我看你還有啥理由！<strong>私信回覆【666】送你</strong></p><div class=pgc-img><img alt="mysql、redis、mongodb都是怎麼實現 “附近的人” 功能的？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/35f4606f036a4ad0a8bc5dd3a588f45b><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="mysql、redis、mongodb都是怎麼實現 “附近的人” 功能的？" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/24556cc7583542e785355cfe3173111a><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>mysql</a></li><li><a>redis</a></li><li><a>mongodb</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/6e8f3f2e.html alt=連mysql鎖的機制都不瞭解，怎麼做架構師 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1533476323070887266574f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6e8f3f2e.html title=連mysql鎖的機制都不瞭解，怎麼做架構師>連mysql鎖的機制都不瞭解，怎麼做架構師</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/89184519.html alt="mysql 創建表，查看錶，修改表名字，指定引擎和字符集" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/3e173dc6-28ba-4101-8576-c70b1d96b5d5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/89184519.html title="mysql 創建表，查看錶，修改表名字，指定引擎和字符集">mysql 創建表，查看錶，修改表名字，指定引擎和字符集</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/65535165.html alt=mysql教程:MySQL多表查詢大全,18個示例總有你需要的 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/43cf07c314554ea0887eaa8fd25c178f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/65535165.html title=mysql教程:MySQL多表查詢大全,18個示例總有你需要的>mysql教程:MySQL多表查詢大全,18個示例總有你需要的</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/78fdddee.html alt=mysql快速複製表結構的幾種方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/78fdddee.html title=mysql快速複製表結構的幾種方法>mysql快速複製表結構的幾種方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b923e71e.html alt=mysql數據庫主從複製拓撲結構 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/6c3e00007aa0307b6043 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b923e71e.html title=mysql數據庫主從複製拓撲結構>mysql數據庫主從複製拓撲結構</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/53471e9b.html alt=mysql異步複製與半同步複製的架構原理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/4e7b00019c175cf0ab61 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/53471e9b.html title=mysql異步複製與半同步複製的架構原理>mysql異步複製與半同步複製的架構原理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/83ffff02.html alt="redis緩存穿透, 緩存雪崩, 熱點緩存以及緩存雙寫一致性問題" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/83ffff02.html title="redis緩存穿透, 緩存雪崩, 熱點緩存以及緩存雙寫一致性問題">redis緩存穿透, 緩存雪崩, 熱點緩存以及緩存雙寫一致性問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5b4a6f12.html alt="mysql explain 詳解" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/43d249c02fa64e4192cc7d6f1aa4a748 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5b4a6f12.html title="mysql explain 詳解">mysql explain 詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f665872d.html alt="「數據庫」 redis入門到實戰" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f665872d.html title="「數據庫」 redis入門到實戰">「數據庫」 redis入門到實戰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/449e7e42.html alt=redis使用場景與可重入分佈式鎖介紹（乾貨） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e19c82bdf324454bae6b198a62186529 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/449e7e42.html title=redis使用場景與可重入分佈式鎖介紹（乾貨）>redis使用場景與可重入分佈式鎖介紹（乾貨）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d7f6ac99.html alt=你的redis分佈式可重入鎖是怎麼設計的(python實現） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/19325eb39de0464e81ae82d3555d1126 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d7f6ac99.html title=你的redis分佈式可重入鎖是怎麼設計的(python實現）>你的redis分佈式可重入鎖是怎麼設計的(python實現）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/82d776a7.html alt=關於redis集群模式，你知道哪些？_一點課堂(多岸學院) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/0355f8749a1f486f80e838ce0e5cdf95 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/82d776a7.html title=關於redis集群模式，你知道哪些？_一點課堂(多岸學院)>關於redis集群模式，你知道哪些？_一點課堂(多岸學院)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1f6b6fd4.html alt="​mysql AB 複製技術(主從),曉桂科技分享mysql_04/06" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1f6b6fd4.html title="​mysql AB 複製技術(主從),曉桂科技分享mysql_04/06">​mysql AB 複製技術(主從),曉桂科技分享mysql_04/06</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ac2bdaa8.html alt="從零開始手寫 redis(13) HashMap源碼詳解" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e2fd616e0a2e438aa897f2e87f3fda25 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ac2bdaa8.html title="從零開始手寫 redis(13) HashMap源碼詳解">從零開始手寫 redis(13) HashMap源碼詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b742c02.html alt=mysql數據庫配置文件不知道怎麼配置？用這個工具一鍵生成 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ba423cf17bd744678ac6fb53908cd305 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b742c02.html title=mysql數據庫配置文件不知道怎麼配置？用這個工具一鍵生成>mysql數據庫配置文件不知道怎麼配置？用這個工具一鍵生成</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>