<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>「轉」事務已提交，數據卻丟了，為啥 | 极客快訊</title><meta property="og:title" content="「轉」事務已提交，數據卻丟了，為啥 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/cc1dcd8a92284540bec485ed0a024bc3"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25383dd.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25383dd.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/25383dd.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25383dd.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25383dd.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/25383dd.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/25383dd.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/25383dd.html><meta property="article:published_time" content="2020-10-29T20:50:42+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:42+08:00"><meta name=Keywords content><meta name=description content="「轉」事務已提交，數據卻丟了，為啥"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/25383dd.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>「轉」事務已提交，數據卻丟了，為啥</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>有個星球水友提問：</p><p>沈老師，我們有一次MySQL崩潰，重啟後發現有些已經提交的事務對數據的修改丟失了，不是說事務能保證ACID特性麼，想問下什麼情況下可能導致“事務已經提交，數據卻丟失”呢？</p><p></p><p>這個問題有點複雜，且容我系統性梳理下思路，先從<strong>redo log</strong>說起吧。</p><p>畫外音：水友問的是MySQL，支持事務的是InnoDB，本文以InnoDB為例展開敘述，其他數據庫不是很瞭解，但估計原理是相同的。</p><p></p><p><strong>為什麼要有redo log？</strong></p><p>事務提交後，必須將事務對數據頁的修改刷(fsync)到磁盤上，才能保證事務的ACID特性。</p><p></p><p>這個刷盤，是一個隨機寫，隨機寫性能較低，如果每次事務提交都刷盤，會極大影響數據庫的性能。</p><p></p><p><strong>隨機寫性能差，有什麼優化方法呢？</strong></p><p>架構設計中有兩個常見的優化方法：</p><p>（1）先寫日誌(write log first)，將隨機寫<strong>優化為</strong>順序寫；</p><p>（2）將每次寫<strong>優化為</strong>批量寫；</p><p>這兩個優化，數據庫都用上了。</p><p></p><p>先說第一個優化，將對數據的修改先順序寫到日誌裡，這個日誌就是redo log。</p><p></p><p>假如某一時刻，數據庫崩潰，還沒來得及將數據頁刷盤，數據庫重啟時，會重做redo log裡的內容，以保證已提交事務對數據的影響被刷到磁盤上。</p><p></p><p>一句話，redo log是為了保證已提交事務的ACID特性，同時能夠提高數據庫性能的技術。</p><p></p><p>既然redo log能保證事務的ACID特性，那為什麼還會出現，水友提問中出現的“數據庫奔潰，丟數據”的問題呢？一起看下redo log的實現細節。</p><p></p><p><strong>redo log的三層架構？</strong></p><div class=pgc-img><img alt=「轉」事務已提交，數據卻丟了，為啥 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cc1dcd8a92284540bec485ed0a024bc3><p class=pgc-img-caption></p></div><p>花了一個醜圖，簡單說明下redo log的三層架構：</p><ul class=list-paddingleft-2><li><strong>粉色</strong>，是InnoDB的一項很重要的內存結構(In-Memory Structure)，日誌緩衝區(Log Buffer)，這一層，是MySQL應用程序用戶態</li><li><strong>屎黃色</strong>，是操作系統的緩衝區(OS cache)，這一層，是OS內核態</li><li><strong>藍色</strong>，是落盤的日誌文件</li></ul><p></p><p><strong>redo log最終落盤的步驟如何？</strong></p><p><strong>首先</strong>，事務提交的時候，會寫入Log Buffer，這裡調用的是MySQL自己的函數WriteRedoLog；</p><p></p><p><strong>接著</strong>，只有當MySQL發起系統調用寫文件write時，Log Buffer裡的數據，才會寫到OS cache。注意，MySQL系統調用完write之後，就認為文件已經寫完，如果不flush，什麼時候落盤，是操作系統決定的；</p><p>畫外音：有時候打日誌，明明printf了，tail -f卻看不到，就是這個原因，這個細節在《明明打印到文件了，為啥tail -f看不到》一文裡說過，此處不再展開。</p><p></p><p><strong>最後</strong>，由操作系統（當然，MySQL也可以主動flush）將OS cache裡的數據，最終fsync到磁盤上；</p><p></p><p><strong>操作系統為什麼要緩衝數據到OS cache裡，而不直接刷盤呢？</strong></p><p>這裡就是將“每次寫”優化為“批量寫”，以提高操作系統性能。</p><p></p><p><strong>數據庫為什麼要緩衝數據到Log Buffer裡，而不是直接write呢？</strong></p><p>這也是“每次寫”優化為“批量寫”思路的體現，以提高數據庫性能。</p><p>畫外音：這個優化思路，非常常見，高併發的MQ落盤，高併發的業務數據落盤，都可以使用。</p><p></p><p>redo log的三層架構，MySQL做了一次批量寫優化，OS做了一次批量寫優化，確實能極大提升性能，<strong>但有什麼副作用嗎？</strong></p><p>畫外音：有優點，必有缺點。</p><p></p><p>這個<strong>副作用</strong>，就是可能丟失數據：</p><p>（1）事務提交時，將redo log寫入Log Buffer，就會認為事務提交成功；</p><p><br>（2）如果寫入Log Buffer的數據，write入OS cache之前，數據庫崩潰，就會出現數據丟失；<br></p><p>（3）如果寫入OS cache的數據，fsync入磁盤之前，操作系統奔潰，也可能出現數據丟失；</p><p>畫外音：如上文所說，應用程序系統調用完write之後（不可能每次write後都立刻flush，這樣寫日誌很蠢），就認為寫成功了，操作系統何時fsync，應用程序並不知道，如果操作系統崩潰，數據可能丟失。</p><p></p><p>任何脫離業務的技術方案都是耍流氓：</p><p>（1）有些業務允許低效，但不允許一丁點數據丟失；</p><p>（2）有些業務必須高性能高吞吐，能夠容忍少量數據丟失；</p><p><strong>MySQL是如何折衷的呢？</strong></p><p></p><p>MySQL有一個參數：</p><p>innodb_flush_log_at_trx_commit</p><p>能夠控制事務提交時，刷redo log的策略。</p><p></p><p>目前有<strong>三種策略</strong>：</p><div class=pgc-img><img alt=「轉」事務已提交，數據卻丟了，為啥 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3cfca6992da240d7a88fe2bb23d045f8><p class=pgc-img-caption></p></div><p><strong>策略一：最佳性能</strong>(innodb_flush_log_at_trx_commit=0)</p><p>每隔一秒，才將Log Buffer中的數據批量write入OS cache，同時MySQL主動fsync。</p><p>這種策略，如果數據庫奔潰，有一秒的數據丟失。</p><p></p><p><strong>策略二：強一致</strong>(innodb_flush_log_at_trx_commit=1)</p><p>每次事務提交，都將Log Buffer中的數據write入OS cache，同時MySQL主動fsync。</p><p>這種策略，是InnoDB的默認配置，為的是保證事務ACID特性。</p><p></p><p><strong>策略三：折衷</strong>(innodb_flush_log_at_trx_commit=2)</p><p>每次事務提交，都將Log Buffer中的數據write入OS cache；</p><p>每隔一秒，MySQL主動將OS cache中的數據批量fsync。</p><p>畫外音：磁盤IO次數不確定，因為操作系統的fsync頻率並不是MySQL能控制的。</p><p>這種策略，如果操作系統奔潰，最多有一秒的數據丟失。</p><p>畫外音：因為OS也會fsync，MySQL主動fsync的週期是一秒，所以最多丟一秒數據。<br></p><div class=pgc-img><img alt=「轉」事務已提交，數據卻丟了，為啥 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3cfca6992da240d7a88fe2bb23d045f8><p class=pgc-img-caption></p></div><p>講了這麼多，回到水友的提問上來，數據庫崩潰，重啟後丟失了數據，有很大的可能，是將innodb_flush_log_at_trx_commit參數設置為0了，這位水友最好和DBA一起檢查一下InnoDB的配置。</p><p></p><p>可能有水友要問，<strong>高併發的業務，InnoDB運用哪種刷盤策略最合適？</strong></p><p><br>高併發業務，行業最佳實踐，是使用<strong>第三種折衷配置</strong>（=2），這是因為：</p><p>（1）配置為2和配置為0，性能差異並不大，因為將數據從Log Buffer拷貝到OS cache，雖然跨越用戶態與內核態，但畢竟只是內存的數據拷貝，速度很快；</p><p>（2）配置為2和配置為0，安全性差異巨大，操作系統崩潰的概率相比MySQL應用程序崩潰的概率，小很多，設置為2，只要操作系統不奔潰，也絕對不會丟數據。<br><strong>總結</strong><br>一、為了保證事務的ACID特性，理論上每次事務提交都應該刷盤，但此時效率很低，有兩種優化方向：<br>（1）隨機寫優化為順序寫；<br>（2）每次寫優化為批量寫；<br>二、redo log是一種順序寫，它有三層架構：<br>（1）MySQL應用層：Log Buffer<br>（2）OS內核層：OS cache<br>（3）OS文件：log file<br>三、為了滿足不用業務對於吞吐量與一致性的需求，MySQL事務提交時刷redo log有三種策略：<br>（1）0：每秒write一次OS cache，同時fsync刷磁盤，性能好；<br>（2）1：每次都write入OS cache，同時fsync刷磁盤，一致性好；<br>（3）2：每次都write入OS cache，每秒fsync刷磁盤，折衷；<br>四、高併發業務，行業內的最佳實踐，是：<br>innodb_flush_log_at_trx_commit=2<br><strong>知其然，知其所以然</strong>，希望大家有收穫。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>事務</a></li><li><a>數據</a></li><li><a>丟了</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/ba1aff4.html alt=事務已提交，數據卻丟了，趕緊檢查下這個配置 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/f6a8adb4-c882-47eb-a2c0-5fdc0d791b11 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ba1aff4.html title=事務已提交，數據卻丟了，趕緊檢查下這個配置>事務已提交，數據卻丟了，趕緊檢查下這個配置</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3a51f795.html alt=一千多買的蘋果耳機，隔天就丟了，是我本人。 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/639e1d75460a4ca3a89f1a5bddadf0f3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3a51f795.html title=一千多買的蘋果耳機，隔天就丟了，是我本人。>一千多買的蘋果耳機，隔天就丟了，是我本人。</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html alt="MySQL 事務處理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html title="MySQL 事務處理">MySQL 事務處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html alt=MySQL——事務(Transaction)詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/29d4c92c9c2344838eb72ef948cf08fa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html title=MySQL——事務(Transaction)詳解>MySQL——事務(Transaction)詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html alt=MySQL數據庫的事務管理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/152203544367254a708f807 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html title=MySQL數據庫的事務管理>MySQL數據庫的事務管理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8293e598.html alt=MySQl事務最全詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c61163c863114226b14bb3760da19e4d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8293e598.html title=MySQl事務最全詳解>MySQl事務最全詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/011d2da0.html alt=MySql併發與事務的處理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/f13d8a1e-5e60-4b48-90bc-3c26e312a208 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/011d2da0.html title=MySql併發與事務的處理>MySql併發與事務的處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4ab1dd0d.html alt=Mysql事務 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4ab1dd0d.html title=Mysql事務>Mysql事務</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cb944fe7.html alt=Mysql事務詳解(一文讀懂數據庫事務) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/cb7ba6cbda8c44438d9d3d7c57bd25b9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cb944fe7.html title=Mysql事務詳解(一文讀懂數據庫事務)>Mysql事務詳解(一文讀懂數據庫事務)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e9d6f488.html alt="SQL Server中的事務（附有實例）" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/21e047bd6e3c41fba0beac7ef3f1ce4e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e9d6f488.html title="SQL Server中的事務（附有實例）">SQL Server中的事務（附有實例）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bb071e7e.html alt="SQL 事務機制-transaction" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3231427d97bf4a04b148360fea032241 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bb071e7e.html title="SQL 事務機制-transaction">SQL 事務機制-transaction</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/44c014a1.html alt=SpringBoot事務詳細簡介 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/44c014a1.html title=SpringBoot事務詳細簡介>SpringBoot事務詳細簡介</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/24b98634.html alt=SqlServer使用事務注意事項，高級程序員必背 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/24b98634.html title=SqlServer使用事務注意事項，高級程序員必背>SqlServer使用事務注意事項，高級程序員必背</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/090306a0.html alt="[Spring] 深入瞭解事務原理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/a8c6dbd7c51741f5a76262e8e2c7a670 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/090306a0.html title="[Spring] 深入瞭解事務原理">[Spring] 深入瞭解事務原理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html alt="「譯」 Spring 的分佈式事務實現—使用和不使用 XA—第二部分" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html title="「譯」 Spring 的分佈式事務實現—使用和不使用 XA—第二部分">「譯」 Spring 的分佈式事務實現—使用和不使用 XA—第二部分</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>