<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>基於solr的空間檢索-詳細實現原理 | 极客快訊</title><meta property="og:title" content="基於solr的空間檢索-詳細實現原理 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/15396016389479731877f40"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2555281.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2555281.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2555281.html><meta property="article:published_time" content="2020-10-29T21:08:06+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:06+08:00"><meta name=Keywords content><meta name=description content="基於solr的空間檢索-詳細實現原理"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/2555281.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>基於solr的空間檢索-詳細實現原理</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>空間搜索，又名Spatial Search，基於空間搜索技術，可以做到：</p><p>1）對Point（經緯度）和其他的幾何圖形建索引</p><p>2）根據距離排序</p><p>3）根據矩形，圓形或者其他的幾何形狀過濾搜索結果</p><p>在Solr中，空間搜索主要基於GeoHash和Cartesian Tiers 2個概念來實現：</p><p>GeoHash算法</p><p>通過GeoHash算法，可以將經緯度的二維座標變成一個可排序、可比較的的字符串編碼。</p><p>在編碼中的每個字符代表一個區域，並且前面的字符是後面字符的父區域。其算法的過程如下：</p><p><strong>根據經緯度計算GeoHash二進制編碼</strong></p><p>地球緯度區間是[-90,90]， 如某緯度是39.92324，可以通過下面算法對39.92324進行逼近編碼:</p><p>1）區間[-90,90]進行二分為[-90,0),[0,90]，稱為左右區間，可以確定39.92324屬於右區間[0,90]，給標記為1；</p><p>2）接著將區間[0,90]進行二分為 [0,45),[45,90]，可以確定39.92324屬於左區間 [0,45)，給標記為0；</p><p>3）遞歸上述過程39.92324總是屬於某個區間[a,b]。隨著每次迭代區間[a,b]總在縮小，並越來越逼近39.928167；</p><p>4）如果給定的緯度（39.92324）屬於左區間，則記錄0，如果屬於右區間則記錄1，這樣隨著算法的進行會產生一個序列1011 1000 1100 0111 1001，序列的長度跟給定的區間劃分次數有關。</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15396016389479731877f40><p class=pgc-img-caption></p></div><p>同理，地球經度區間是[-180,180]，對經度116.3906進行編碼的過程也類似：</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539601638933be2a0fa47d><p class=pgc-img-caption></p></div><p><strong>組碼</strong></p><p>通過上述計算，緯度產生的編碼為1011 1000 1100 0111 1001，經度產生的編碼為1101 0010 1100 0100 0100。偶數位放經度，奇數位放緯度，把2串編碼組合生成新串：11100 11101 00100 01111 00000 01101 01011 00001。</p><p>最後使用用0-9、b-z（去掉a, i, l, o）這32個字母進行base32編碼，首先將11100 11101 00100 01111 00000 01101 01011 00001轉成十進制 28，29，4，15，0，13，11，1，十進制對應的編碼就是wx4g0ec1。同理，將編碼轉換成經緯度的解碼算法與之相反，具體不再贅述。</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1539601638931390bb06fc5><p class=pgc-img-caption></p></div><p>由上可知，字符串越長，表示的範圍越精確。當GeoHash base32編碼長度為8時，精度在19米左右，而當編碼長度為9時，精度在2米左右，編碼長度需要根據數據情況進行選擇。不過從GeoHash的編碼算法中可以看出它的一個缺點，位於邊界兩側的兩點，雖然十分接近，但編碼會完全不同。實際應用中，可以同時搜索該點所在區域的其他八個區域的點，即可解決這個問題。</p><p>Cartesian Tiers 笛卡爾層</p><p>笛卡爾分層模型的思想是將經緯度轉換成更大粒度的分層網格，該模型創建了很多的地理層，每一層在前一層的基礎上細化切分粒度，每一個網格被分配一個ID，代表一個地理位置。</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/15396016389231d10231d32><p class=pgc-img-caption></p></div><p>每層以2的平方遞增，所以第一層為4個網格，第二層為16 個，所以整個地圖的經緯度將在每層的網格中體現：</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1539601638875c50a9d0ee4><p class=pgc-img-caption></p></div><p>那麼如何構建這樣的索引結構呢，其實很簡單，只需要對應笛卡爾層的層數來構建域即可,一個域或座標對應多個tiers層次。也即是tiers0->field_0，tiers1->field_1,tiers2-field_2,……，tiers19->field_19。（一般20層即可）。每個對應笛卡爾層次的域將根據當前這條記錄的經緯度通過笛卡爾算法計算出歸屬於當前層的網格，然後將gridId（網格唯一標示）以term的方式存入索引。這樣每條記錄關於笛卡爾0-19的域將都會有一個gridId對應起來。但是查詢的時候一般是需要查周邊的地址，那麼可能周邊的範圍超過一個網格的範圍，那麼實際操作過程是根據經緯度和一個距離確定出需要涉及查詢的從19-0（從高往低查）若干層對應的若干網格的數據。那麼一個經緯度周邊地址的查詢只需要如下圖圓圈內的數據：</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153960163887294a9094af3><p class=pgc-img-caption></p></div><p>由上可知，基於Cartesian Tier的搜索步驟為：</p><p>1、根據Cartesian Tier層獲得座標點的地理位置gridId</p><p>2、與系統索引gridId匹配計算</p><p>3、計算結果集與目標座標點的距離返回特定範圍內的結果集合</p><p>使用笛卡爾層，能有效縮減少過濾範圍，快速定位座標點。</p><h1>基於Solr的空間搜索實踐</h1><p>在Solr中，針對上述的2種原理提供了不同的索引方式去實現，分別是GeohashPrefixTree類和QuadPrefixTree類，其中GeohashPrefixTree對應GeoHash算法(也採用了笛卡爾層的分層思想)，QuadPrefixTree對應笛卡爾層的實現。</p><p>GeohashPrefixTree與QuadPrefixTree都繼承SpatialPrefixTree這個前綴樹基類，都使用了分層策略，主要索引和查詢邏輯⼀樣。不同點在於它們的maxLevels不一樣，獲取子cell的方式不一樣，GeohashPrefixTree有32個子cell(編碼為0-z)，QuadPrefixTree 只有有4個子cell(編碼為ABCD。A：左上，B：右上，C：左下，D：右下)。</p><p>而在Solr中，默認是使用GeohashPrefixTree的方式，索引下面重點介紹geohash的方式。利用Solr來實現空間搜索主要分為2部分：</p><p>1）索引的構建</p><p>2）查詢</p><p>索引構建</p><p><strong>Step1 定義空間索引類型和字段</strong></p><p>在Solr中提供了scheme.xml文件用來定義索引類型和字段，如下所示：</p><pre>&lt;fieldType name="location_rpt" class="solr.SpatialRecursivePrefixTreeFieldType" spatialContextFactory="com.spatial4j.core.context.jts.JtsSpatialContextFactory" distErrPct="0.025" maxDistErr="0.000009" units="degrees"/&gt; &lt;field name=”poi_location_p" type="location_rpt" indexed="true" stored="true" multiValued=”false"/&gt; </pre><p>對於重要的屬性說明如下：</p><p>SpatialRecursivePrefixTreeFieldType</p><p>用於深度遍歷前綴樹的FieldType，主要用於獲得基於Lucene中的RecursivePrefixTreeStrategy。</p><p>JtsSpatialContextFactory</p><p>當有Polygon多邊形或者linestrings線段時，會使用jts(需要把jts.jar放到solr服務的lib下)，而基本形狀使用SpatialContext (spatial4j的類)。</p><p>distErrPct</p><p>定義非Point圖形的精度，範圍在0-0.5之間。該值決定了非Point的圖形索引或查詢時的level(如geohash模式時就是geohash編碼的長度)。當為0時取maxLevels，即精度最大,精度越大將花費更多的空間和時間去建索引。</p><p>geo</p><p>默認為true，值為true的情況下座標基於球面座標系，採用Geohash的方式；值為false的情況下座標基於2D平面的座標系，採用Euclidean/Cartesian的方式。</p><p>worldBounds</p><p>世界座標值：”minX minY maxX maxY”。 geo=true即geohash模式時，該值默認為”-180 -90 180 90”。geo=false即quad時，該值為Java double類型的正負邊界，此時需要指定該值，設置成”-180 -90 180 90”。</p><p>distCalculator</p><p>設置距離計算算法，geo=true默認是haversine，geo=false默認是cartesian(笛卡爾計算方式)，值可以為"lawOfCosines"(餘弦定理), "vincentySphere"(文森特球面公式) 或 "cartesian^2"。</p><p>prefixTree</p><p>Solr將地球映射為網格，prefixTree定義了網格的實現方式，每個網格在下一層中可以分解成多個子網格，geo=true prefixTree只能取GeoHash，geo=false prefixTree可取quad(quadTree一種四分樹地理位置索引，對應笛卡爾分層策略)</p><p>maxDistErr/maxLevels</p><p>maxDistErr定義了索引數據的最高層maxLevels，上述定義為0.000009，根據GeohashUtils.lookupHashLenForWidthHeight(0.000009, 0.000009)算出編碼長度為11位，精度在1米左右，直接決定了Point索引的term數。</p><p>maxLevels優先級高於maxDistErr,即有maxLevels的話maxDistErr失效。詳見SpatialPrefixTreeFactory.init()方法。</p><p>不過一般使用maxDistErr。</p><p>units</p><p>單位是degrees，不適用於geofilt, bbox, or geodist（單位為km）</p><p><strong>Step2 構建索引</strong></p><p>構建索引代碼示例（在美團主要使用Point類型的索引）：</p><pre>doc.setField(”poi_location_p", "32.52162,120.31778") //point類型或者doc.setField("poi_location_p", "POLYGON((120.35330414772034 31.58268495951037,120.35190939903259 31.57923921490961,120.35330414772034 31.58268495951037))") //多邊形類型</pre><p>構建流程：</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/153960163909277d6829cfb><p class=pgc-img-caption></p></div><p>下面主要說明Point類型的term創建過程。</p><p>1、將空間索引域的shapeStr解析成相應的Shape（這裡指Point，複雜Shape如Polygon要使用JTS中的WTKReader來解析）。</p><p>2、創建索引域,具體過程參考org.apache.lucene.spatial.prefix.RecursivePrefixTreeStrategy中的createIndexableFields方法。</p><p>a、根據distErrPct字段，計算距離的誤差值，對於Point來說默認為0（而對於非Point類型來說，是通過外包矩形中心點到矩形頂點的距離再乘以distErrPct來計算誤差值的）</p><pre>double distErr = SpatialArgs.calcDistanceFromErrPct(shape, distErrPct, ctx); public static double calcDistanceFromErrPct(Shape shape, double distErrPct, SpatialContext ctx) { if (distErrPct &lt; 0 || distErrPct &gt; 0.5) { throw new IllegalArgumentException("distErrPct " + distErrPct + " must be between [0 to 0.5]"); } if (distErrPct == 0 || shape instanceof Point) { return 0; } Rectangle bbox = shape.getBoundingBox(); //Compute the distance from the center to a corner. Because the distance // to a bottom corner vs a top corner can vary in a geospatial scenario, // take the closest one (greater precision). Point ctr = bbox.getCenter(); double y = (ctr.getY() &gt;= 0 ? bbox.getMaxY() : bbox.getMinY()); double diagonalDist = ctx.getDistCalc().distance(ctr, bbox.getMaxX(), y); return diagonalDist * distErrPct;}</pre><p>b、根據上述計算出的誤差值，得到索引的geohash編碼長度，對於Point類型來說值為maxLevels。</p><pre>public int getLevelForDistance(double dist) { if (dist == 0) return maxLevels;//short circuit final int level = GeohashUtils.lookupHashLenForWidthHeight(dist, dist); return Math.max(Math.min(level, maxLevels), 1);}</pre><p>c、根據編碼長度得到滿足所有條件的cells（每個cell表示一個前綴值），並將Cells都放在CellTokenStream中，同時構建索引域。Point類型每個Cell表示geohash的一個前綴值。</p><pre>public List&lt;Cell&gt; getCells(Point p, int detailLevel, boolean inclParents){ Cell cell = getCell(p, detailLevel); if (!inclParents) { return Collections.singletonList(cell); }  String endToken = cell.getTokenString(); assert endToken.length() == detailLevel; List&lt;Cell&gt; cells = new ArrayList&lt;Cell&gt;(detailLevel); for (int i = 1; i &lt; detailLevel; i++) { cells.add(getCell(endToken.substring(0, i))); } cells.add(cell); return cells;} Field field = new Field(getFieldName(), new CellTokenStream(cells.iterator()), FIELD_TYPE);</pre><p>3、構建存取域存儲索引</p><pre>if (field.stored()) { if (shapeStr == null) shapeStr = shapeToString(shape); result.add(new StoredField(field.getName(), shapeStr));}</pre><p>4、結果</p><p>如經緯度41.79452,123.41555，對應的geohash為wxrvb2kqexu（maxLevels=11）, 則其對應的term有11個（如w、wx、wxr、wxrv…）。</p><p>查詢</p><p>查詢語法示例：</p><pre>q={!geofilt pt=45.15,-93.85 sfield=poi_location_p d=5 score=distance}q={!bbox pt=45.15,-93.85 sfield=poi_location_p d=5 score=distance}q=poi_location_p:"Intersects(-74.093 41.042 -69.347 44.558)" //a bounding box (not in WKT) q=poi_location_p:"Intersects(POLYGON((-10 30, -40 40, -10 -20, 40 20, 0 0, -10 30)))" //a WKT example </pre><p>涉及到的字段說明：</p><p><strong>字段含義</strong>q查詢條件，如 q=poi_id:134567fq過濾條件，如 fq=store_name:農業fl返回字段，如fl=poi_id，store_namept座標點，如pt=54.729696,-98.525391d搜索半徑，如 d=10表示10km範圍內sfield指定座標索引字段，如sfield=geodefType指定查詢類型 可以取 dismax和edismax，edismax支持boos函數相乘作用，dismax是通過累加方式計算最後的score.qf指定權重字段：qf=store_name^10+poi_location_p^5score排序字段 根據qf定義的字段defType定義的方式計算得到score排序輸出</p><p>其中有幾種常見的Solr支持的幾何操作：</p><p>WITHIN：在內部</p><p>CONTAINS：包含關係</p><p>DISJOINT：不相交</p><p>Intersects：相交（存在交集）</p><p>在美團CRM中，空間搜索日常常見的需求主要分為2類：</p><p>1. 範圍搜索（在美團CRM中對應周邊商家搜索）</p><p>範圍搜索支持2種範圍確定方式：</p><ul><li>geofilt方式：根據搜索半徑過濾結果，返回以pt為圓心d為半徑的圓內所有點,如左圖所示返回圓形內所有點</li><li>bbox方式：根據具體的域過濾結果，不僅返回以pt為圓心d為半徑的圓內所有點，還包括域內其他點，返回矩形框內所有點，如右圖所示：</li></ul><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539601639027a9393bb249><p class=pgc-img-caption></p></div><ul><li></li></ul><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153960163907026d394244d><p class=pgc-img-caption></p></div><ul><li><br></li></ul><p>範圍搜索的情況很多，下面列舉一些常用場景的查詢語法：</p><ul><li>不需要排序的場景</li></ul><pre> fq={!geofilt pt=45.15,-93.85 sfield=geo d=5}   fq={!bbox pt=45.15,-93.85 sfield=geo d=5} </pre><ul><li>需要排序的場景,較複雜</li></ul><p>1) 按距離排序，距離越近排名越高，加上score=distance，其中distance是索引點到座標點之間的弧度值，系統根據弧度值排序。</p><pre>&amp;fl=*,score&amp;sort=score asc&amp;q={!geofilt score=distance sfield=poi_location_p pt=54.729696,-98.525391 d=10}。</pre><p>2) 按距離排序，距離越遠排名越高，加上score=reciDistance，其中reciDistance 範圍是0~1 採用倒數的方式計算，故與distance的排序剛好相反</p><pre>&amp;fl=*,score&amp;sort=score asc&amp;q={!geofilt score=reciDistance sfield=poi_location_p pt=54.729696,-98.525391 d=10} </pre><p>3) 距離僅作排序不做過濾，在條件中設置filter=false，其中d只是確定形狀的作用,不起限制作用。</p><pre>&amp;fl=*,score&amp;sort=score asc&amp;q={!geofilt score=distance filter=false sfield=poi_location_p pt=54.729696,-98.525391 d=10}</pre><p>4) 結合關鍵詞查詢和距離排序，此時關鍵字只能作為過濾條件（fq）不能作為查詢條件，僅作為過濾域。</p><pre>&amp;fl=*,score&amp; fq=store_name:農業&amp;sort=score asc&amp;q={!geofilt score=distance sfield=poi_location_p pt=54.729696,-98.525391 d=10}</pre><p>5) 當關鍵字和距離都作為排序條件時，可以用qf參數設置權重</p><pre>&amp;fl=*,score&amp; fq=store_name:農業&amp;sort=score asc&amp;q={!geofilt score=distance sfield=poi_location_p pt=54.729696,-98.525391 d=10} &amp;defType=dismax&amp;qf=store_name^10+poi_location_p^5</pre><p>2.圖形搜索（在美團CRM中對應地圖模式搜索）</p><p>在美團CRM中主要有以下幾種場景：</p><p>1) 直線附近1km商家搜索</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15396016391257ac61e5d13><p class=pgc-img-caption></p></div><pre>&amp;fl=*,score&amp;sort=score asc&amp;q=poi_location_p:"Intersects(LINESTRING(116.38263702392578 39.86653357724533,116.4935302734375 39.8578370694061) d=1</pre><p>2) 正常多邊形範圍內的商家</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539601639135643145c22e><p class=pgc-img-caption></p></div><pre>&amp;fl=*,score&amp;sort=score asc&amp;q=poi_location_p:"Intersects(POLYGON ((116.37714385986328 39.88392328618825,116.46709442138672 39.86627006289872,116.40392303466797 39.83358644035512,116.33525848388672 39.85124807212413,116.37714385986328 39.88392328618825))) distErrPct=0</pre><p>3）複雜（如自相交）多邊形範圍內的商家</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153960163922739da1cdf95><p class=pgc-img-caption></p></div><p>對於這種自相交的多邊形，Solr默認認為是非法的，會拋出類似這樣的異常：</p><p>com.spatial4j.core.exception.InvalidShapeException: Self-intersection at or near point (116.4272689819336 39.875755941712825, NaN)，因此在將參數傳入solr前，需要基於標準 Douglas-Peucker Algorithm 算法對多邊形進行處理，處理後能去掉自相交的部分，效果如示意圖所示：</p><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539601639237bc3ac851aa><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=基於solr的空間檢索-詳細實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539601639234cd77392d98><p class=pgc-img-caption></p></div><p>處理後，自相交的部分變為3和6兩個點。當然經過處理後的多邊形數據會損失一些精確度。</p><p>簡化前：</p><pre>POLYGON((116.4272689819336 39.875755941712825,116.50142669677734 39.84966661865515,116.4059829711914 39.83068633533497,116.48357391357422 39.8873480121113,116.47808074951172 39.827258780634594,116.47773742675781 39.8177661982179,116.41319274902344 39.87048617098581,116.4272689819336 39.875755941712825))</pre><p>簡化後：</p><pre>POLYGON ((116.4272689819336 39.875755941712825,116.45455487823865 39.866156528285366, 116.48357391357422 39.8873480121113, 116.48079281261445 39.85692579689432,116.50142669677734 39.84966661865515,116.47973485573046 39.84535290095104,116.47808074951172 39.827258780634594,116.47773742675781 39.8177661982179,116.45096720829837 39.8396320628827,116.4059829711914 39.83068633533497,116.43551562011505 39.85225289138226,116.41319274902344 39.87048617098581,116.4272689819336 39.875755941712825)）</pre><p>簡化後查詢語法變為：</p><pre>&amp;fl=*,score&amp;sort=score asc&amp;q=poi_location_p:"Intersects(POLYGON ((116.4272689819336 39.875755941712825,116.45455487823865 39.866156528285366, 116.48357391357422 39.8873480121113, 116.48079281261445 39.85692579689432,116.50142669677734 39.84966661865515,116.47973485573046 39.84535290095104,116.47808074951172 39.827258780634594,116.47773742675781 39.8177661982179,116.45096720829837 39.8396320628827,116.4059829711914 39.83068633533497,116.43551562011505 39.85225289138226,116.41319274902344 39.87048617098581,116.4272689819336 39.875755941712825)) distErrPct=0</pre><p>無論是範圍查詢還是圖形搜索，他們的查詢基本流程都類似，主要分為下面2步：</p><p>1、解析查詢，生成Query樹：獲得相應的QParse（SpatialFilterQParser）, 對查詢串進行語法解析，獲得查詢串的各個參數，並且獲得相應的查詢Query（包括相應的Filter），其中也計算了查詢Shape的一些屬性，如最大索引長度detailLevel。</p><pre> Query result = null; if (type instanceof SpatialQueryable) { double radius = localParams.getDouble(SpatialParams.SPHERE_RADIUS, DistanceUtils.EARTH_MEAN_RADIUS_KM); SpatialOptions opts = new SpatialOptions(pointStr, dist, sf, measStr, radius); opts.bbox = bbox; result = ((SpatialQueryable)type).createSpatialQuery(this, opts); }</pre><p>2、查詢：SolrIndexSearch.search()進行創建Weight樹和Score樹，利用不同的filter和score策略得到符合條件的docIdSet。而對於幾種不同的幾何圖形關係，Solr提供了幾種不同的filter類來計算，這些filter都繼承AbstractPrefixTreeFilter類，簡單來說就是獲取與查詢Shape相交的所有子Cell，然後再與term進行匹配的過程。</p><h1>總結</h1><p>本文詳細分析了空間搜索的原理以及基於Solr的實踐，隨著移動互聯網時代的到來以及lbs技術的普及，空間搜索技術的應用場景會越來越多，同時隨著美團的不斷髮展壯大，越來越多的商家會加入美團這個平臺，對於空間搜索的挑戰也將越來越大，此文僅僅作為拋磚引玉，空間搜索技術還有很多值得深入挖掘的地方。</p><h1>參考</h1><p>http://tech.meituan.com/solr-spatial-search.html</p><p>http://ju.outofmemory.cn/entry/94794</p><p>個人例子：</p><p>首先在配置文件 db-data-config.xml 裡包含以下字段</p><p>concat(Latitude,',',Longitude) as product_pos</p><p>schema.xml</p><pre>&lt;field name="product_pos" type="location" indexed="true" stored="true" multiValued="false" required="false"/&gt;&lt;field name="product_pos_rpt" type="location_rpt" indexed="true" stored="true" multiValued="false" required="false"/&gt;	&lt;copyField source="product_pos" dest="product_pos_rpt"/&gt;&lt;fieldType name="location" class="solr.LatLonType" subFieldSuffix="_coordinate"/&gt; &lt;fieldType name="location_rpt" class="solr.SpatialRecursivePrefixTreeFieldType" geo="true" distErrPct="0.025" maxDistErr="0.001" distanceUnits="kilometers" /&gt;</pre><p>solrj</p><pre>query.addFilterQuery("{!geofilt}"); //距離過濾函數query.set("sfield", "product_pos_rpt"); //經緯度的字段query.set("pt", latitude + "," + longitude); //當前經緯度query.set("d", 500); //就近500公里//	query.setFields(" distance:geodist() "); //取distance為別名query.addField(" distance:geodist() ");query.set("sort", "geodist() asc"); //根據距離排序</pre></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>solr</a></li><li><a>空間</a></li><li><a>檢索</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/806a019.html alt=PostGIS空間檢索之面選 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/78a3d0de6fa34f17ab9c5a02dadc7d22 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/806a019.html title=PostGIS空間檢索之面選>PostGIS空間檢索之面選</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0fa8bcd.html alt=空間檢索-Geohash算法實現原理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/499b081f160049b49fd0cdc2d53d35aa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0fa8bcd.html title=空間檢索-Geohash算法實現原理>空間檢索-Geohash算法實現原理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/305e8231.html alt=虛擬製作技術打破空間邊界，激發更多可能性的創作！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d33b7efa54554bbb8f27afd5701355bc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/305e8231.html title=虛擬製作技術打破空間邊界，激發更多可能性的創作！>虛擬製作技術打破空間邊界，激發更多可能性的創作！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5de88116.html alt=上市六年的傑德，空間大，性價比高，為啥停產了呢？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8a81b5dd60ed406bba30dbe108377487 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5de88116.html title=上市六年的傑德，空間大，性價比高，為啥停產了呢？>上市六年的傑德，空間大，性價比高，為啥停產了呢？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b5f32826.html alt="滬鋅 上行空間有限" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b5f32826.html title="滬鋅 上行空間有限">滬鋅 上行空間有限</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b8cd4bdd.html alt=世界上最小的島僅306平方米，空間狹小，但看過的人紛紛點贊 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1538292099335ebf0db619d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b8cd4bdd.html title=世界上最小的島僅306平方米，空間狹小，但看過的人紛紛點贊>世界上最小的島僅306平方米，空間狹小，但看過的人紛紛點贊</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/140bc2aa.html alt="靈魂藝術空間·保利和樂國際藝術中心 | PONE ARCHITECTURE" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/787a4b90536245ec85c2c3f4756155a0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/140bc2aa.html title="靈魂藝術空間·保利和樂國際藝術中心 | PONE ARCHITECTURE">靈魂藝術空間·保利和樂國際藝術中心 | PONE ARCHITECTURE</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/12532ae5.html alt=北京愛馬思藝術中心，以“共生”為理念的空間設計 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/c92340875ce04ec8a68d2fd9f6639912 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/12532ae5.html title=北京愛馬思藝術中心，以“共生”為理念的空間設計>北京愛馬思藝術中心，以“共生”為理念的空間設計</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7d369518.html alt="WWW 2020 | 用於圖像檢索的等距離等分佈三元組損失函數" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/Rw8d6J11AAULRN style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7d369518.html title="WWW 2020 | 用於圖像檢索的等距離等分佈三元組損失函數">WWW 2020 | 用於圖像檢索的等距離等分佈三元組損失函數</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f5a10632.html alt=面向中國空間治理現代化的科技強國適應策略 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/S0u6kSn2WSAxwl style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f5a10632.html title=面向中國空間治理現代化的科技強國適應策略>面向中國空間治理現代化的科技強國適應策略</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f31fa2b4.html alt=海域空間立體分層使用面對的現實困境與制度完善 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/14f202aaa65c4b14837b2389e798f948 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f31fa2b4.html title=海域空間立體分層使用面對的現實困境與制度完善>海域空間立體分層使用面對的現實困境與制度完善</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bd9088ca.html alt=空間眾包中的在線移動微任務分配 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7795eac1703145769fcd0f52cb1dc294 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bd9088ca.html title=空間眾包中的在線移動微任務分配>空間眾包中的在線移動微任務分配</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/32ef0cc6.html alt=新中式窗簾的美，中式家居空間不可缺少的 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/15309412866127cd65c1eab style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/32ef0cc6.html title=新中式窗簾的美，中式家居空間不可缺少的>新中式窗簾的美，中式家居空間不可缺少的</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/77fbe8c4.html alt=仲愷高新區：在全市率先搭建區域性空間數據應用平臺 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RU1SzmvDzciOny style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/77fbe8c4.html title=仲愷高新區：在全市率先搭建區域性空間數據應用平臺>仲愷高新區：在全市率先搭建區域性空間數據應用平臺</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6a60821b.html alt=空間向量的正交分解及其座標表示 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/2035980f4f3f4d43a51d80670db41031 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6a60821b.html title=空間向量的正交分解及其座標表示>空間向量的正交分解及其座標表示</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>