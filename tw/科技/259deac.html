<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>現代IM系統中的消息系統架構 - 模型篇 | 极客快訊</title><meta property="og:title" content="現代IM系統中的消息系統架構 - 模型篇 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/47ed26dda4cf485181aca7e987f6738e"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/259deac.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/259deac.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/259deac.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/259deac.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/259deac.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/259deac.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/259deac.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/259deac.html><meta property="article:published_time" content="2020-10-29T21:04:30+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:30+08:00"><meta name=Keywords content><meta name=description content="現代IM系統中的消息系統架構 - 模型篇"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/259deac.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>現代IM系統中的消息系統架構 - 模型篇</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1><strong>前言</strong></h1><p>在架構篇中我們介紹了現代IM消息系統的架構，介紹了Timeline的抽象模型以及基於Timeline模型構建的一個支持『消息漫遊』、『多端同步』和『消息檢索』多種高級功能的消息系統的典型架構。架構篇中為了簡化讀者對Tablestore Timeline模型的理解，概要性的對Timeline的基本邏輯模型做了介紹，以及對消息系統中消息的多種同步模式、存儲和索引的基本概念做了一個科普。</p><p>本篇文章是對架構篇的一個補充，會對Tablestore的Timeline模型做一個非常詳盡的解讀，讓讀者能夠深入到實現層面瞭解Timeline的基本功能以及核心組件。最後我們還是會基於IM消息系統這個場景，來看如何基於Tablestore Timeline實現IM場景下消息同步、存儲和索引等基本功能。</p><h1><strong>Timeline模型</strong></h1><p>Timeline模型以『簡單』為設計目標，核心模塊構成比較清晰明瞭，主要包括：</p><ul><li>Store：Timeline存儲庫，類似數據庫的表的概念。</li><li>Identifier：用於區分Timeline的唯一標識。</li><li>Meta：用於描述Timeline的元數據，元數據描述採用free-schema結構，可自由包含任意列。</li><li>Queue：一個Timeline內所有Message存儲在Queue內。</li><li>Message：Timeline內傳遞的消息體，也是一個free-schema的結構，可自由包含任意列。</li><li>Index：包含Meta Index和Message Index，可對Meta或Message內的任意列自定義索引，提供靈活的多條件組合查詢和搜索。</li></ul><p><strong>Timeline Store</strong></p><div class=pgc-img><img alt="現代IM系統中的消息系統架構 - 模型篇" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/47ed26dda4cf485181aca7e987f6738e><p class=pgc-img-caption></p></div><p>Timeline Store是Timeline的存儲庫，對應於數據庫內表的概念。上圖是Timeline Store的結構圖，Store內會存儲所有的Timeline數據。Timeline是一個面向海量消息的數據模型，同時用於消息存儲庫和同步庫，需要滿足多種要求：</p><ul><li><strong>支撐海量數據存儲</strong>：對於消息存儲庫來說，如果需要消息永久存儲，則隨著時間的積累，數據規模會越來越大，需要存儲庫能應對長時間積累的海量消息數據存儲，需要能達到PB級容量。</li><li><strong>低存儲成本</strong>：消息數據的冷熱區分是很明顯的，大部分查詢都會集中在熱數據，所以對於冷數據需要有一個比較低成本的存儲方式，否則隨著時間的積累數據量不斷膨脹，存儲成本會非常大。</li><li><strong>數據生命週期管理</strong>：不管是對於消息數據的存儲還是同步，數據都需要定義生命週期。存儲庫是用於在線存儲消息數據本身，通常需要設定一個較長週期的保存時間。而同步庫是用於寫擴散模式的在線或離線推送，通常設定一個較短的保存時間。</li><li><strong>極高的寫入吞吐</strong>：各類場景下的消息系統，除了類似微博、頭條這種類型的Feeds流系統，像絕大部分即時通訊或朋友圈這類消息場景，通常是採用寫擴散的消息同步模式，寫擴散要求底層存儲具備極高的寫入吞吐能力，以應對消息洪峰。</li><li><strong>低延遲的讀</strong>：消息系統通常是應用在在線場景，所以對於查詢要求低延遲。</li></ul><p>Tablestore Timeline的底層是基於LSM存儲引擎的分佈式數據庫，LSM的最大優勢就是對寫入非常友好，天然適合消息寫擴散的模式。同時對查詢也做了極大優化，例如熱數據進緩存、bloom filter等等。數據表採用Range Partition的分區模式，能提供水平擴展的服務能力，以及能自動探測並處理熱點分區的負載均衡策略。為了滿足同步庫和存儲庫對存儲的不同要求，也提供了一些靈活的自定義配置，主要包括：</p><ul><li>Time to live（數據生命週期）：可自定義數據生命週期，例如永久保存，或者保存N天。</li><li>Storage type（存儲類型）：自定義存儲類型，對存儲庫來說，HDD是最好的選擇，對同步庫來說，SSD是最好的選擇。</li></ul><p><strong>Timeline Module</strong></p><div class=pgc-img><img alt="現代IM系統中的消息系統架構 - 模型篇" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3f6f4cb7828b4471a9875939bebeb309><p class=pgc-img-caption></p></div><p>Timeline Store內能存儲海量的Timeline，單個Timeline的詳細結構圖如上，可以看到Timeline主要包含了三大部分：</p><ul><li>Timeline Meta：元數據部分，用於描述Timeline，包括：</li><li class=ql-indent-1><strong>Identifier</strong>：用於唯一標識Timeline，可包含多個字段。</li><li class=ql-indent-1><strong>Meta</strong>：用於描述Timeline的元數據，可包含任意個數任意類型的字段。</li><li class=ql-indent-1><strong>Meta Index</strong>：元數據索引，可對元數據內任意屬性列建索引，支持多字段條件組合查詢和檢索。</li><li>Timeline Queue：用於存儲和同步消息的隊列，隊列中元素由兩部分組成：</li><li class=ql-indent-1><strong>Sequence Id</strong>：順序ID，隊列中用於定位Message的位點信息，在隊列中順序ID保持遞增。</li><li class=ql-indent-1><strong>Message</strong>：隊列中承載消息的實體，包含了消息的完整內容。</li><li>Timeline Data：Timeline的數據部分就是Message，Message主要包含：</li><li class=ql-indent-1><strong>Message</strong>：消息實體，其內部也可以包含任意數量任意類型字段。</li><li class=ql-indent-1><strong>Message Index</strong>：消息數據索引，可對消息實體內任意列做索引，支持多字段條件組合查詢和檢索。</li></ul><h1><strong>IM消息系統建模</strong></h1><div class=pgc-img><img alt="現代IM系統中的消息系統架構 - 模型篇" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b1d55d4f667943588aafca1a10911e90><p class=pgc-img-caption></p></div><p>以一個簡易版IM系統為例，來看如何基於Tablestore Timeline模型建模。按照上圖中的例子，存在A、B、C三個用戶，A與B發生單聊，A與C發生單聊，以及A、B、C組成一個群聊，來看下在這個場景下消息同步、存儲以及讀寫流程分別如何基於Tablestore Timeline建模。</p><p><strong>消息同步模型</strong></p><p>消息同步選擇寫擴散模型，能完全利用Tablestore Timeline的優勢，以及針對IM消息場景讀多寫少的特性，通過寫擴散來平衡讀寫，均衡整個系統的資源。寫擴散模型下，每個接收消息的個體均擁有一個收件箱，所有需要同步至該個體的消息需要投遞到其收件箱內。圖上例子中，A、B、C三個用戶分別擁有收件箱，每個用戶不同的設備端，均從同一個收件箱內拉取新消息。</p><p><strong>消息同步庫</strong></p><p>收件箱存儲在同步庫內，同步庫中每個收件箱對應一個Timeline。根據圖上的例子，總共存在3個Timeline作為收件箱。每個消息接收端保存有本地最新拉取的消息的SequenceID，每次拉取新消息均是從該SequenceID開始拉取消息。對同步庫的查詢會比較頻繁，通常是對最新消息的查詢，所以要求熱數據儘量緩存在內存中，能提供高併發低延遲的查詢。所以對同步庫的配置，一般是需要SSD存儲。消息如果已經同步到了所有的終端，則代表收件箱內的該消息已經被消費完畢，理論上可以清理。但設計上來說不做主動清理，而是給數據定義一個較短的生命週期來自動過期，一般定義為一週或者兩週。數據過期之後，如果仍要同步拉取新消息，則需要退化到讀擴散的模式，從存儲庫中拉取消息。</p><p><strong>消息存儲庫</strong></p><p>消息存儲庫中保存有每個會話的消息，每個會話的發件箱對應一個Timeline。發件箱內的消息支持按會話維度拉取消息，例如瀏覽某個會話內的歷史消息則通過讀取發件箱完成。一般來說，新消息通過在線推送或者查詢同步庫可投遞到各個接收端，所以對存儲庫的查詢會相對來說較少。而存儲庫用於長期存儲消息，例如永久存儲，相對同步庫來說數據量會較大。所以存儲庫的選擇一般是HDD，數據生命週期根據消息需要保存的時間來定，通常是一個較長的時間。</p><p><strong>消息索引庫</strong></p><p>消息索引庫依附於存儲庫，使用了Timeline的Message Index，可以對存儲庫內的消息進行索引，例如對文本內容的全文索引、收件人、發件人以及發送時間的索引等，能支持全文檢索等高級查詢和搜索。</p><h1><strong>總結</strong></h1><p>本篇文章主要對Tablestore Timeline模型進行了詳解，介紹了Timeline各模塊包括Store、Meta、Queue、Data和Index等，最後以一個簡單的IM場景舉例如何基於Timeline來建模。在下一篇實現篇中，會直接基於Tablestore Timeline來實現一個簡易版的支持單聊、群聊、元數據管理以及消息檢索的IM系統，敬請期待。</p><p>作者：木洛</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>系統</a></li><li><a>現代</a></li><li><a>IM</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/031eafc4.html alt=電廠直流系統調試方案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/5e8200036f19e04c25bf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/031eafc4.html title=電廠直流系統調試方案>電廠直流系統調試方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fc3b4b2c.html alt=一文讀懂智能客服：發展歷程、系統搭建、市場推廣 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RbYMTZ55OrJUgU style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fc3b4b2c.html title=一文讀懂智能客服：發展歷程、系統搭建、市場推廣>一文讀懂智能客服：發展歷程、系統搭建、市場推廣</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/51410370.html alt=生活垃圾焚燒發電及蒸汽系統優化改造項目公告 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RcblrbTDBokV23 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/51410370.html title=生活垃圾焚燒發電及蒸汽系統優化改造項目公告>生活垃圾焚燒發電及蒸汽系統優化改造項目公告</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b4913b56.html alt=電驅動橋系統或加快電氣化進程，多個案例共同說明問題 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1539571595921bc5b27eff6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b4913b56.html title=電驅動橋系統或加快電氣化進程，多個案例共同說明問題>電驅動橋系統或加快電氣化進程，多個案例共同說明問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9a7b7719.html alt=基於混沌系統的偽隨機數發生器設計 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9a7b7719.html title=基於混沌系統的偽隨機數發生器設計>基於混沌系統的偽隨機數發生器設計</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b1aaba56.html alt=現代簡約風格石膏板吊頂樣式參考 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e76b42d7a9874cbb9c0e7170310c1ab4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b1aaba56.html title=現代簡約風格石膏板吊頂樣式參考>現代簡約風格石膏板吊頂樣式參考</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/99558abe.html alt=win10系統打印機打印不了顯示已暫停的解決方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/10d0de369d4746c7a0c220ff59bd2470 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/99558abe.html title=win10系統打印機打印不了顯示已暫停的解決方法>win10系統打印機打印不了顯示已暫停的解決方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2564328d.html alt=虛設投資交易系統吸引投資 成都破獲一特大團夥詐騙案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2564328d.html title=虛設投資交易系統吸引投資 成都破獲一特大團夥詐騙案>虛設投資交易系統吸引投資 成都破獲一特大團夥詐騙案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e4b6c065.html alt=全球定位系統（GPS），不只是導航 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/S7sY2h8G8GOmul style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e4b6c065.html title=全球定位系統（GPS），不只是導航>全球定位系統（GPS），不只是導航</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f75e014c.html alt=謹記！短線王者交易系統，學會極大概率提高買入與賣出的時機！掌握終身獲益無窮！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RL8KN4P57T39Db style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f75e014c.html title=謹記！短線王者交易系統，學會極大概率提高買入與賣出的時機！掌握終身獲益無窮！>謹記！短線王者交易系統，學會極大概率提高買入與賣出的時機！掌握終身獲益無窮！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0ad4f2c9.html alt="焦爐系統停電 —— 應急操作" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8ca2e135770644bfb97620aad1b362c0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0ad4f2c9.html title="焦爐系統停電 —— 應急操作">焦爐系統停電 —— 應急操作</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/75270289.html alt=win10系統如何使用返回桌面快捷鍵 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/822a8f5c52e1461a94e116d0e24871f0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/75270289.html title=win10系統如何使用返回桌面快捷鍵>win10系統如何使用返回桌面快捷鍵</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a435b80f.html alt=從操作系統（Windows）的角度討論中斷和異常機制 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/95371ea9a81e4e32b3cf7591d4dbbc83 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a435b80f.html title=從操作系統（Windows）的角度討論中斷和異常機制>從操作系統（Windows）的角度討論中斷和異常機制</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/093fe492.html alt=企業標準-管路系統裝配工藝規範 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ab245e924a004753b625eeb6495dd2ca style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/093fe492.html title=企業標準-管路系統裝配工藝規範>企業標準-管路系統裝配工藝規範</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d90a8756.html alt=高速公路護欄的系統原理及相關特點是什麼？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1528092476460dc0d2f2b49 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d90a8756.html title=高速公路護欄的系統原理及相關特點是什麼？>高速公路護欄的系統原理及相關特點是什麼？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>