<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>有返回結果的異步任務Futrue與Callable | 极客快訊</title><meta property="og:title" content="有返回結果的異步任務Futrue與Callable - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/c821aa0756ac422d80dc7be1c8dfa260"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2a653a7.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2a653a7.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2a653a7.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2a653a7.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2a653a7.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2a653a7.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2a653a7.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2a653a7.html><meta property="article:published_time" content="2020-10-29T20:59:18+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:18+08:00"><meta name=Keywords content><meta name=description content="有返回結果的異步任務Futrue與Callable"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/2a653a7.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>有返回結果的異步任務Futrue與Callable</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>上一篇講解了線程池execute方法詳細執行過程，execute接受Runnable參數但沒有返回執行結果，在需要有執行結果的地方就不太適用了。</p><h1 class=pgc-h-arrow-right>異步任務有返回值</h1><p>如果出現一個計算量稍大用時較長而後面需要結果的情況，可以先把這個任務提交到另外的線程異步執行，主線程仍然繼續做運行等到需要計算結果的時候再來獲取，但是提供異步計算Runnable或者說線程Thread都不返回結果。</p><p>但Java中提供了Future與Callable來實現可以獲取異步執行結果的一套框架，在上一篇文章中<strong>線程池的execute方法沒有返回值，但是線程池提供的submit方法支持返回值，而submit利用Future與Callable實現</strong>。</p><h1 class=pgc-h-arrow-right>Future與Callable簡單解釋</h1><p>Callable接口聲明瞭一個方法call提供一個泛型的返回結果，</p><p>Future接口聲明瞭5個接口：</p><p>cancel方法：取消任務，如果任務取消成功則返回true，如果任務取消失敗則返回false。參數mayInterruptIfRunning表示是否允許取消正在執行卻沒有執行完畢的任務，如果設置true，則表示可以取消正在執行過程中的任務。如果任務已經完成，則都返回false。；。</p><p>isCancelled方法：表示任務是否已經被取消。</p><p>isDone方法：表示任務是否已經完成，若任務完成，則返回true；</p><p>get()方法：用來獲取任務結果，這個方法會阻塞線程，會一直等到任務執行完畢才返回；get(long timeout, TimeUnit unit)方法如果在指定時間內，還沒獲取到結果，就直接返回null。</p><h1 class=pgc-h-arrow-right>再看線程池的submit</h1><p>線程池提供了三個submit都繼承至AbstractExecutorService的實現，源碼如下圖：</p><div class=pgc-img><img alt=有返回結果的異步任務Futrue與Callable onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c821aa0756ac422d80dc7be1c8dfa260><p class=pgc-img-caption></p></div><p>三個方法接受不同的參數，但都會作為newTaskFor方法的參數生成一個RunnableFuture類的對象，所以最關鍵在於RunnableFuture類。</p><p>而RunnableFuture也簡單是一個接口並且繼承了Runnable與Future，所以它可以被當作Runnable用在線程池的execute方法中，而同時又擁有Future的所有功能。</p><p>而submit通過newTaskFor生成的實際上是RunnableFuture子類，通過看源碼實際上生成的是RunnableFuture的實現類FutureTask，最終的關鍵就是FutureTask類。</p><h1 class=pgc-h-arrow-right>最關鍵類FutureTask詳解</h1><p><strong>FutureTask實現RunnableFuture，RunnableFuture繼承Runnable與Future，所以可以當作Runnable在線程池中使用，作為execute方法的參數，同時它也是Future的真正實現者</strong>，它的關鍵屬性如下圖：</p><div class=pgc-img><img alt=有返回結果的異步任務Futrue與Callable onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5c11009aa09a40b38a1e4cdadeed670a><p class=pgc-img-caption></p></div><p>前面提到的Future幾個方法在FutureTask中得到了實現，實現也很簡單，源碼如上圖FutureTask維護一個狀態state，來表示任務狀態取消、中斷、完成等。</p><p>我們都是通過Future的get方法來獲取結果，而FutureTask對get方法實現也簡單：</p><p>首先判斷state的狀態，如果大於3則拋出異常；</p><p>等於3則說明已經完成會執行Thread.yield()讓出CPU；</p><p>小於3則說明任務還沒有完成，<strong>就會把線程組裝成WaitNode加入到waiters中，並中斷當前線程</strong>；</p><p><br></p><p>從上一篇知道execute最終是執行參數的run方法，在這裡也就是FutureTask的run方法執行過程如下：</p><p>首先執行callable的call方法獲取到返回結果；</p><p>CAS方式把狀態從0設置為1；</p><p>如果設置成功（保證線程安全）把結果賦值給outcome；</p><p>第四步把狀態從1設置為2，表示完成；</p><p><strong>最後喚醒waiters鏈表中的線程</strong>。</p><h1 class=pgc-h-arrow-right>總結</h1><p>可以看到有返回結果的異步實現最終依賴FutureTask，它同時實現了Runnable與Future，擁有一個Callable屬性。<strong>get方法根據FutureTask的狀態會把線程掛起並放到等待鏈表中</strong>了。</p><p>同時它可以被用到線程池中被執行，在線程池中最後會調用它的run方法，<strong>run方法會調用Callable的call方法也就是真正計算的方法，返回結果後會修改FutureTask的狀態並喚醒等待鏈表的線程</strong>。</p><p>線程池的submit方法還支持Runnable參數，但是FutureTask執行的是Callable的call方法，那麼Runnable中的run是怎麼轉換成Callable的call方法呢？</p><p>實際上也很簡單，<strong>採用適配器模式</strong>，建一個Callable的子類RunnableAdapter，它保存一個Runnable屬性，RunnableAdapter的call方法調用Runnable的run方法，至於返回的結果為null或者自己傳一個結果。</p><p>所以要實現有返回結果的異步任務，要麼實現Callable並實現call方法，或者創建一個Runnable的實現類也行。</p><p>Java程序員日常學習筆記，如理解有誤歡迎各位交流討論！</p><div class=pgc-img><img alt=有返回結果的異步任務Futrue與Callable onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f652a9cd53d44f52be44156c203ab1e8><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>結果</a></li><li><a>異步</a></li><li><a>任務</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/14d8bcde.html alt=計算結果告訴你，地球移動的到底有多快？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/15297363659259b132365cc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/14d8bcde.html title=計算結果告訴你，地球移動的到底有多快？>計算結果告訴你，地球移動的到底有多快？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f97d341c.html alt=使用易語言控制檯製作（任務管理器）系統進程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153036512103769cec6250b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f97d341c.html title=使用易語言控制檯製作（任務管理器）系統進程>使用易語言控制檯製作（任務管理器）系統進程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b2c32845.html alt="交近6萬學炒股結果虧慘 頂點財經被證監會重罰" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1526951015343660970e267 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b2c32845.html title="交近6萬學炒股結果虧慘 頂點財經被證監會重罰">交近6萬學炒股結果虧慘 頂點財經被證監會重罰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/be77f3c3.html alt=一小時，核酸快速檢測出結果！愛心企業為嵩明捐獻檢測設備！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/f3c82dc1b8f54de5a49e697c061c4750 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/be77f3c3.html title=一小時，核酸快速檢測出結果！愛心企業為嵩明捐獻檢測設備！>一小時，核酸快速檢測出結果！愛心企業為嵩明捐獻檢測設備！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ece3c332.html alt=新生兒篩查結果異常，怎麼辦？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/dfic-imagehandler/3ed82e20-a7b2-4793-a4dc-2077af748562 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ece3c332.html title=新生兒篩查結果異常，怎麼辦？>新生兒篩查結果異常，怎麼辦？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9215af22.html alt=“十一”超7成白領在旅途中工作，職場上該如何有效指派任務？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/27492ce76b7d45a1a1b935e56c695b22 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9215af22.html title=“十一”超7成白領在旅途中工作，職場上該如何有效指派任務？>“十一”超7成白領在旅途中工作，職場上該如何有效指派任務？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f9db061d.html alt=三相異步電動機絕緣處理的目的及方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/3c439a15bdf64f1f975914c96a2c66e7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f9db061d.html title=三相異步電動機絕緣處理的目的及方法>三相異步電動機絕緣處理的目的及方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b44410f0.html alt=異步電機典型結構簡述 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/15349080656472f5dd62512 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b44410f0.html title=異步電機典型結構簡述>異步電機典型結構簡述</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c2cb8d92.html alt=繞組5大基本名詞解析與三相異步電動機繞組及其聯接方法介紹 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/56930005e593537411b9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c2cb8d92.html title=繞組5大基本名詞解析與三相異步電動機繞組及其聯接方法介紹>繞組5大基本名詞解析與三相異步電動機繞組及其聯接方法介紹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b3e098cc.html alt=單相異步電機如何轉起來？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/66c6000099c8d7f13f98 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b3e098cc.html title=單相異步電機如何轉起來？>單相異步電機如何轉起來？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6e45cf25.html alt=男子拔牙結果被拔錯，主任：40歲後還要拔的，男子：60歲還自己脫落了呢 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/65c9be31c8fc498699580bc31a9bffb2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6e45cf25.html title=男子拔牙結果被拔錯，主任：40歲後還要拔的，男子：60歲還自己脫落了呢>男子拔牙結果被拔錯，主任：40歲後還要拔的，男子：60歲還自己脫落了呢</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/51fefa66.html alt=迄今為止把同步/異步/阻塞/非阻塞講的這麼清楚的好文章 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/28ca13300b9f4d55bd5af3f9156f8874 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/51fefa66.html title=迄今為止把同步/異步/阻塞/非阻塞講的這麼清楚的好文章>迄今為止把同步/異步/阻塞/非阻塞講的這麼清楚的好文章</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ff896430.html alt=重複測量方差分析的操作教程及結果解讀 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/S6hUPSj3GayfxB style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ff896430.html title=重複測量方差分析的操作教程及結果解讀>重複測量方差分析的操作教程及結果解讀</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f1d32f3f.html alt=javascript中的宏任務與微任務 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/664e98c4-c156-458f-a172-5502c246e157 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f1d32f3f.html title=javascript中的宏任務與微任務>javascript中的宏任務與微任務</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7e41f2a4.html alt=從EventLoop到宏任務與微任務 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/79a6de2f384a4574920524c200fb5949 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7e41f2a4.html title=從EventLoop到宏任務與微任務>從EventLoop到宏任務與微任務</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>