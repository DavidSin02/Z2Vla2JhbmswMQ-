<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>分庫分表就能無限擴容嗎，解釋得太好了 | 极客快訊</title><meta property="og:title" content="分庫分表就能無限擴容嗎，解釋得太好了 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/1c0dbcd58e4d40a790f510be224a5262"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2baafeb.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2baafeb.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2baafeb.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2baafeb.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2baafeb.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2baafeb.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2baafeb.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2baafeb.html><meta property="article:published_time" content="2020-10-29T21:06:50+08:00"><meta property="article:modified_time" content="2020-10-29T21:06:50+08:00"><meta name=Keywords content><meta name=description content="分庫分表就能無限擴容嗎，解釋得太好了"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/2baafeb.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>分庫分表就能無限擴容嗎，解釋得太好了</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><blockquote><p>專注於Java領域優質技術號，歡迎關注</p></blockquote><p>作者：莫那·魯道</p><h1 class=ql-align-center><strong>前言</strong></h1><p class=ql-align-justify>像我這樣的菜鳥，總會有各種疑問，剛開始是對 JDK API 的疑問，對 NIO 的疑問，對 JVM 的疑問，當工作幾年後，對服務的可用性，可擴展性也有了新的疑問，什麼疑問呢？其實是老生常談的話題：服務的擴容問題。</p><h1 class=ql-align-justify>正常情況下的服務演化之路</h1><p class=ql-align-justify>讓我們從最初開始。</p><ol><li class=ql-align-justify>單體應用 每個創業公司基本都是從類似 SSM 和 SSH 這種架構起來的，沒什麼好講的，基本每個程序員都經歷過。</li><li class=ql-align-justify>RPC 應用 當業務越來越大，我們需要對服務進行水平擴容，擴容很簡單，只要保證服務是無狀態的就可以了，如下圖：</li></ol><p class=ql-align-justify><br></p><div class=pgc-img><img alt=分庫分表就能無限擴容嗎，解釋得太好了 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1c0dbcd58e4d40a790f510be224a5262><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>當業務又越來越大，我們的服務關係錯綜複雜，同時，有很多服務訪問都是不需要連接 DB 的，只需要連接緩存即可，那麼就可以做成分離的，減少 DB 寶貴的連接。如下圖：</p><div class=pgc-img><img alt=分庫分表就能無限擴容嗎，解釋得太好了 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1d4b06687f6347db9e0bdf7018f570f1><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>我相信大部分公司都是在這個階段。Dubbo 就是為了解決這個問題而生的。</p><p class=ql-align-justify>如果你的公司產品很受歡迎，業務繼續高速發展，數據越來越多，SQL 操作越來越慢，那麼數據庫就會成為瓶頸，那麼你肯定會想到分庫分表，不論通過 ID hash 或者 range 的方式都可以。如下圖：</p><div class=pgc-img><img alt=分庫分表就能無限擴容嗎，解釋得太好了 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ab60991ac3624bbbb504a1bb0caefc6d><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>這下應該沒問題了吧。任憑你用戶再多，併發再高，我只要無限擴容數據庫，無限擴容應用，就可以了。</p><p class=ql-align-justify>這也是本文的標題，分庫分表就能解決無限擴容嗎？</p><p class=ql-align-justify>實際上，像上面的架構，並不能解決。</p><p class=ql-align-justify>其實，這個問題和 RPC 的問題有點類似：數據庫連接過多！</p><p class=ql-align-justify>通常，我們的 RPC 應用由於是使用中間件進行訪問數據庫，應用實際上是不知道到底要訪問哪個數據庫的，訪問數據庫的規則由中間件決定，例如 sharding JDBC。這就導致，這個應用必須和所有的數據庫連接，就像我們上面的架構圖一樣，一個 RPC 應用需要和 3 個 mysql 連接，如果是 30 個 RPC 應用，每個 RPC 的數據庫連接池大小是8 ，每個 mysql 需要維護 240 個連接，我們知道，mysql 默認連接數是 100，最大連接數是 16384，也就是說，假設每個應用的連接池大小是 8 ，超過 2048 個應用就無法再繼續連接了，也就無法繼續擴容了。</p><p class=ql-align-justify>注意，由於每個物理庫有很多邏輯庫，再加上微服務運動如火如荼， 2048 並沒有看起來那麼大。</p><p class=ql-align-justify>也許你說，我可以通過前面加一個 proxy 來解決連接數的問題，實際上，代理的性能也會成為問題，為什麼？代理的連接數也是不能超過 16384 的，如果併發超過 16384，變成 163840，那麼 proxy 也解決不了問題。</p><p class=ql-align-justify>怎麼辦？讓我們再看看上面的架構圖：</p><div class=pgc-img><img alt=分庫分表就能無限擴容嗎，解釋得太好了 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9c0384e291904e17b242480eb33efaf5><p class=pgc-img-caption></p></div><p class=ql-align-justify>我們發現，問題是出在“每個 RPC 應用都要連所有的庫”，導致擴容應用的同時，每個數據庫連接數就要增加。就算增加數據庫，也不能解決連接數的問題。</p><p class=ql-align-justify>那怎麼辦呢？</p><h1 class=ql-align-center><strong>單元化</strong></h1><p class=ql-align-justify>單元化，聽起來高大上，通常在一些 XXX 大會上，分享“關於兩地三中心”，“三地五中心”，“異地多活”等等牛逼的名詞的時候，單元化也會一起出現。</p><p class=ql-align-justify>這裡我們不討論那麼牛逼的，就只說“數據庫連接數過多” 的問題。</p><p class=ql-align-justify>實際上，思路很簡單：我們不讓應用連接所有的數據庫就可以了。</p><p class=ql-align-justify>假設我們根據 range 分成了 10 個庫，現在有 10 個應用，我們讓每個應用只連一個庫，當應用增多變成 20個，數據庫的連接不夠用了，我們就將 10 個庫分成 20 個庫，這樣，無論你應用擴容到多少個，都可以解決數據庫連接數過多的問題。</p><p class=ql-align-justify>注意：做這件事的前提是：你必須保證，訪問你這個應用的 request 請求的數據庫一定是在這個應用的。s</p><p class=ql-align-justify>換個說法，當用戶從 DNS 那裡進來的時候，就知道自己要去那個應用了，所以，規則在 DNS 之前就定好了，雖然這有點誇張，但肯定在進應用之前就知道要去哪個庫了。</p><p class=ql-align-justify>所以，這通常需要一個規則，例如通過用戶 ID hash，由配置中心廣播 hash 規則。這樣，所有的組件都能保持一致的規則，從而正確的訪問到數據庫。如下圖：</p><div class=pgc-img><img alt=分庫分表就能無限擴容嗎，解釋得太好了 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/62db2f2cfa0a46d6ae035f2cf71605fa><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify>到這裡，我們終於解決了無限擴容的問題。</p><h1 class=ql-align-center><strong>最後</strong></h1><p class=ql-align-justify>本文從單體應用開始，逐步講述了一個正常後臺的演進歷程，知道了分庫分表並不能解決“無限擴容” 的問題，只有單元化才能解決這問題。而單元化則帶來更多的複雜性。但是好處不言而喻。</p><p class=ql-align-justify>單元化帶來的更多的思路。</p><p class=ql-align-justify>有了單元化，解決了無限擴容的問題，但是我們還沒有考慮單點的問題，即服務的可用性。要知道，我們這裡的數據庫都是單點的。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>分庫</a></li><li><a>無限</a></li><li><a>擴容</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/6f447ad9.html alt="創意無限 和美風華" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/SFWkXcW313DBbQ style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6f447ad9.html title="創意無限 和美風華">創意無限 和美風華</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/19088f7a.html alt=倒計時！長益擴容高速橋樑荷載試驗完成，本月底將建成通車 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/25aa150111424147a43a7612b7e990fd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/19088f7a.html title=倒計時！長益擴容高速橋樑荷載試驗完成，本月底將建成通車>倒計時！長益擴容高速橋樑荷載試驗完成，本月底將建成通車</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0e48345a.html alt=魅族擴容服務又來了：最低199元存儲容量翻倍到底值不值？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e5fa4b95265b4cca9f029345db860051 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0e48345a.html title=魅族擴容服務又來了：最低199元存儲容量翻倍到底值不值？>魅族擴容服務又來了：最低199元存儲容量翻倍到底值不值？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e16dc726.html alt=64GB不再是乞丐版！手機擴容其實很簡單 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ReVVysK9rD0OlD style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e16dc726.html title=64GB不再是乞丐版！手機擴容其實很簡單>64GB不再是乞丐版！手機擴容其實很簡單</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/71562116.html alt=操作不懂技術就可以做小程序無限生成平臺的創業項目實操教程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/dfic-imagehandler/08bc73de-7bf1-405e-935f-f51dea3e3558 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/71562116.html title=操作不懂技術就可以做小程序無限生成平臺的創業項目實操教程>操作不懂技術就可以做小程序無限生成平臺的創業項目實操教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/63842fff.html alt=宇宙沒有空氣阻力，飛船為何不能無限加速，連1％光速都無法達到 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/188ba431bf9e44a9a7c8ec5602da88a1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/63842fff.html title=宇宙沒有空氣阻力，飛船為何不能無限加速，連1％光速都無法達到>宇宙沒有空氣阻力，飛船為何不能無限加速，連1％光速都無法達到</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b5cad7a9.html alt=原子彈和氫彈都有核當量上限，無限的核爆炸威力反而使用意義不大 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6aa725684b9d4c2dbdcdf2b34e16d4dd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b5cad7a9.html title=原子彈和氫彈都有核當量上限，無限的核爆炸威力反而使用意義不大>原子彈和氫彈都有核當量上限，無限的核爆炸威力反而使用意義不大</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/f3c2ae8f.html alt=西安各區優質房源無限升值 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/f4ecbbdad0c940ef9daadee57b26ef81 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/f3c2ae8f.html title=西安各區優質房源無限升值>西安各區優質房源無限升值</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/cc29b346.html alt=亞索摘去無限火力最垃圾英雄稱號，繼承者竟然是他？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/2ee200039bce1996d583 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/cc29b346.html title=亞索摘去無限火力最垃圾英雄稱號，繼承者竟然是他？>亞索摘去無限火力最垃圾英雄稱號，繼承者竟然是他？</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/86d2ddd4.html alt=廣州：釋放智慧生活無限想象 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/729eb214bbce43aead4463e1a2f90ddc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/86d2ddd4.html title=廣州：釋放智慧生活無限想象>廣州：釋放智慧生活無限想象</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/114d5512.html alt=這就是為什麼引力的速度不可能是無限的原因 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/86d57345573f41ccb86feed6b2dd1aef style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/114d5512.html title=這就是為什麼引力的速度不可能是無限的原因>這就是為什麼引力的速度不可能是無限的原因</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/5f06c3bf.html alt=曾經風光無限的保本基金迎來退市潮 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1534730924059f43c979ca9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/5f06c3bf.html title=曾經風光無限的保本基金迎來退市潮>曾經風光無限的保本基金迎來退市潮</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/ba687d3f.html alt=新型沼氣前景無限 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/ba687d3f.html title=新型沼氣前景無限>新型沼氣前景無限</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/9068146b.html alt=補益類市場擴容，壯腰健腎增速高達60%！連鎖藥店如何分得一杯羹？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1526796328368d435e5d607 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/9068146b.html title=補益類市場擴容，壯腰健腎增速高達60%！連鎖藥店如何分得一杯羹？>補益類市場擴容，壯腰健腎增速高達60%！連鎖藥店如何分得一杯羹？</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/6b5f9f66.html alt=英雄聯盟無限火力不滅之握的版本即將歸來，平均每局加1500血量 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/13b49d193d3843c48d239812ca28f0a6 style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/6b5f9f66.html title=英雄聯盟無限火力不滅之握的版本即將歸來，平均每局加1500血量>英雄聯盟無限火力不滅之握的版本即將歸來，平均每局加1500血量</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>