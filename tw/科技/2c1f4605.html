<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>面試：如何保證緩存與數據庫的雙寫一致性？ | 极客快訊</title><meta property="og:title" content="面試：如何保證緩存與數據庫的雙寫一致性？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/dfic-imagehandler/cb653c36-6808-4f69-be82-df4f21a4a39c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2c1f4605.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2c1f4605.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2c1f4605.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2c1f4605.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2c1f4605.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2c1f4605.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2c1f4605.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2c1f4605.html><meta property="article:published_time" content="2020-11-14T21:04:04+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:04+08:00"><meta name=Keywords content><meta name=description content="面試：如何保證緩存與數據庫的雙寫一致性？"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/2c1f4605.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>面試：如何保證緩存與數據庫的雙寫一致性？</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>只要用緩存，就可能會涉及到緩存與數據庫雙存儲雙寫，你只要是雙寫，就一定會有數據一致性的問題</p><div class=pgc-img><img alt=面試：如何保證緩存與數據庫的雙寫一致性？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/dfic-imagehandler/cb653c36-6808-4f69-be82-df4f21a4a39c><p class=pgc-img-caption></p></div><p>那麼，如何解決一致性問題？</p><p>一般來說，如果允許緩存可以稍微的跟數據庫偶爾有不一致的情況，也就是說如果你的系統不是嚴格要求 <strong>緩存 + 數據庫</strong> 必須保持一致性的話，最好不要做這個方案。即：讀請求和寫請求串行化，串到一個內存隊列裡去。</p><p>串行化可以保證一定不會出現不一致的情況，但是它也會導致系統的吞吐量大幅度降低，用比正常情況下多幾倍的機器去支撐線上請求。</p><p><strong>Cache Aside Pattern</strong></p><p>最經典的緩存+數據庫讀寫的模式，就是 Cache Aside Pattern。</p><p>讀的時候，先讀緩存，緩存沒有的話，就讀數據庫，然後取出數據後放入緩存，同時返回響應。更新的時候，先更新數據庫，然後再刪除緩存。</p><p>為什麼是刪除緩存，而不是更新緩存？</p><p>原因很簡單，很多時候，在複雜點的緩存場景，緩存不單單是數據庫中直接取出來的值。</p><p>比如可能更新了某個表的一個字段，然後其對應的緩存，是需要查詢另外兩個表的數據並進行運算，才能計算出緩存最新的值的。</p><p>另外更新緩存的代價有時候是很高的。是不是每次修改數據庫的時候，都一定要將其對應的緩存更新一份？</p><p>也許有的場景是這樣，但是對於比較複雜的緩存數據計算的場景，就不是這樣了。</p><p>如果你頻繁修改一個緩存涉及的多個表，緩存也頻繁更新。但是問題在於，這個緩存到底會不會被頻繁訪問到？</p><p>舉個栗子，一個緩存涉及的表的字段，在 1 分鐘內就修改了 20 次，或者是 100 次，那麼緩存更新 20 次、100 次；但是這個緩存在 1 分鐘內只被讀取了 1 次，有大量的冷數據。</p><p>實際上，如果你只是刪除緩存的話，那麼在 1 分鐘內，這個緩存不過就重新計算一次而已，開銷大幅度降低，用到緩存才去算緩存。</p><p>其實刪除緩存，而不是更新緩存，就是一個<strong> lazy 計算</strong>的思想，不要每次都重新做複雜的計算，不管它會不會用到，而是讓它到需要被使用的時候再重新計算。</p><p>像 mybatis，hibernate，都有懶加載思想。查詢一個部門，部門帶了一個員工的 list，沒有必要說每次查詢部門，都裡面的 1000 個員工的數據也同時查出來。</p><p>80% 的情況，查這個部門，就只是要訪問這個部門的信息就可以了。先查部門，同時要訪問裡面的員工，那麼這個時候只有在你要訪問裡面的員工的時候，才會去數據庫裡面查詢 1000 個員工。</p><p>最初級的緩存不一致問題及解決方案</p><p>問題：先修改數據庫，再刪除緩存。如果刪除緩存失敗了，那麼會導致數據庫中是新數據，緩存中是舊數據，數據就出現了不一致。</p><p><strong>解決思路</strong>：先刪除緩存，再修改數據庫。如果數據庫修改失敗了，那麼數據庫中是舊數據，緩存中是空的，那麼數據不會不一致。</p><p>因為讀的時候緩存沒有，則讀數據庫中舊數據，然後更新到緩存中。</p><p>比較複雜的數據不一致問題分析</p><p>數據發生了變更，先刪除了緩存，然後要去修改數據庫，還沒來得及修改，一個請求過來，去讀緩存，發現緩存空了，去查詢數據庫，查到了修改前的舊數據，放到了緩存中。隨後數據變更的程序完成了數據庫的修改。</p><p>完了，數據庫和緩存中的數據不一樣了。。。</p><p>為什麼上億流量高併發場景下，緩存會出現這個問題？</p><p>只有在對一個數據在併發的進行讀寫的時候，才可能會出現這種問題。其實如果說你的併發量很低的話，特別是讀併發很低，每天訪問量就 1 萬次，那麼很少的情況下，會出現剛才描述的<span>那種</span>不一致的場景。</p><p>但是問題是，如果每天的是上億的流量，每秒併發讀是幾萬，每秒只要有數據更新的請求，就可能會出現上述的數據庫+緩存不一致的情況。</p><p><strong>解決方案如下：</strong></p><p>更新數據的時候，根據數據的唯一標識，將操作路由之後，發送到一個 jvm 內部隊列中。</p><p>讀取數據的時候，如果發現數據不在緩存中，那麼將重新讀取數據+更新緩存的操作，根據唯一標識路由之後，也發送同一個 jvm 內部隊列中。</p><p>一個隊列對應一個工作線程，每個工作線程串行拿到對應的操作，然後一條一條的執行。</p><p>這樣的話，一個數據變更的操作，先刪除緩存，然後再去更新數據庫，但是還沒完成更新。</p><p>此時如果一個讀請求過來，讀到了空的緩存，那麼可以先將緩存更新的請求發送到隊列中，此時會在隊列中積壓，然後同步等待緩存更新完成。</p><p>這裡有一個<strong>優化點</strong>，一個隊列中，其實多個更新緩存請求串在一起是沒意義的，因此可以做過濾</p><p>如果發現隊列中已經有一個更新緩存的請求了，那麼就不用再放個更新請求操作進去了，直接等待前面的更新操作請求完成即可。</p><p>待那個隊列對應的工作線程完成了上一個操作的數據庫的修改之後，才會去執行下一個操作，也就是緩存更新的操作，此時會從數據庫中讀取最新的值，然後寫入緩存中。</p><p>如果請求還在等待時間範圍內，不斷輪詢發現可以取到值了，那麼就直接返回；如果請求等待的時間超過一定時長，那麼這一次直接從數據庫中讀取當前的舊值。</p><p>高併發的場景下，該解決方案要注意的問題：</p><p><strong>1、讀請求長時阻塞</strong></p><p>由於讀請求進行了非常輕度的異步化，所以一定要注意讀超時的問題，每個讀請求必須在超時時間範圍內返回。</p><p>該解決方案，最大的風險點在於，可能數據更新很頻繁，導致隊列中積壓了大量更新操作在裡面，然後讀請求會發生大量的超時，最後導致大量的請求直接走數據庫。務必通過一些模擬真實的測試，看看更新數據的頻率是怎樣的。</p><p>另外一點，因為一個隊列中，可能會積壓針對多個數據項的更新操作，因此需要根據自己的業務情況進行測試，可能需要部署多個服務，每個服務分攤一些數據的更新操作。</p><p>如果一個內存隊列裡積壓 100 個商品的庫存修改操作，每個庫存修改操作要耗費 10ms 去完成，那麼最後一個商品的讀請求，可能等待 10 * 100 = 1000ms = 1s 後，才能得到數據，這個時候就導致讀請求的長時阻塞。</p><p>因此，一定要根據實際業務系統的運行情況，去進行一些壓力測試和模擬線上環境，去看看最繁忙的時候，內存隊列可能會積壓多少更新操作，可能會導致最後一個更新操作對應的讀請求，會 hang 多少時間。</p><p>如果讀請求在 200ms 返回，如果你計算過後，哪怕是最繁忙的時候，積壓 10 個更新操作，最多等待 200ms，那還可以的。</p><p>如果一個內存隊列中可能積壓的更新操作特別多，那麼你就要加機器，讓每個機器上部署的服務實例處理更少的數據，那麼每個內存隊列中積壓的更新操作就會越少。</p><p>其實根據之前的項目經驗，一般來說，數據的寫頻率是很低的，因此實際上正常來說，在隊列中積壓的更新操作應該是很少的。</p><p>像這種針對讀高併發、讀緩存架構的項目，一般來說寫請求是非常少的，每秒的 QPS 能到幾百就不錯了。</p><p>實際粗略測算一下，如果一秒有 500 的寫操作，分成 5 個時間片，每 200ms 就 100 個寫操作，放到 20 個內存隊列中，每個內存隊列，可能就積壓 5 個寫操作。</p><p>每個寫操作性能測試後，一般是在 20ms 左右就完成，那麼針對每個內存隊列的數據的讀請求，也就最多 hang 一會兒，200ms 以內肯定能返回了。</p><p>經過剛才簡單的測算，我們知道，單機支撐的寫 QPS 在幾百是沒問題的，如果寫 QPS 擴大了 10 倍，那麼就擴容機器，擴容 10 倍的機器，每個機器 20 個隊列。</p><p><strong>2、讀請求併發量過高</strong></p><p>這裡還必須做好壓力測試，確保恰巧碰上上述情況的時候，還有一個風險，就是突然間大量讀請求會在幾十毫秒的延時 hang 在服務上，看服務能不能扛的住，需要多少機器才能扛住最大的極限情況的峰值。</p><p>但是因為並不是所有的數據都在同一時間更新，緩存也不會同一時間失效，所以每次可能也就是少數數據的緩存失效了，然後那些數據對應的讀請求過來，併發量應該也不會特別大。</p><p><strong>3、多服務實例部署的請求路由</strong></p><p>可能這個服務部署了多個實例，那麼必須保證說，執行數據更新操作，以及執行緩存更新操作的請求，都通過 Nginx 服務器路由到相同的服務實例上。</p><p>比如說，對同一個商品的讀寫請求，全部路由到同一臺機器上。可以自己去做服務間的按照某個請求參數的 hash 路由，也可以用 Nginx 的 hash 路由功能等等。</p><p><strong>4、熱點商品的路由問題，導致請求的傾斜</strong></p><p>萬一某個商品的讀寫請求特別高，全部打到相同的機器的相同的隊列裡面去了，可能會造成某臺機器的壓力過大。</p><p>因為只有在商品數據更新的時候才會清空緩存，然後才會導致讀寫併發，所以要根據業務系統去看，如果更新頻率不是太高的話，這個問題的影響並不是特別大，但是可能某些機器的負載會高一些。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>面試</a></li><li><a>保證</a></li><li><a>緩存</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/d6b4ad6d.html alt=你知道如何更新緩存嗎？如何保證緩存和數據庫雙寫一致性？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c7adc4a4b9b745c0ae541bf87a51dd85 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d6b4ad6d.html title=你知道如何更新緩存嗎？如何保證緩存和數據庫雙寫一致性？>你知道如何更新緩存嗎？如何保證緩存和數據庫雙寫一致性？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c53d08ba.html alt=如何保證數據庫和緩存的雙寫一致性？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4b019f823cd84b72a0ac1d7b7d54e259 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c53d08ba.html title=如何保證數據庫和緩存的雙寫一致性？>如何保證數據庫和緩存的雙寫一致性？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f1086463.html alt=面試必知Redis面試題—緩存雪崩+穿透+緩存與數據庫雙寫一致問題 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/53ecc71093ef411499a588ebbe940a1c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f1086463.html title=面試必知Redis面試題—緩存雪崩+穿透+緩存與數據庫雙寫一致問題>面試必知Redis面試題—緩存雪崩+穿透+緩存與數據庫雙寫一致問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/677306ff.html alt=面試總結：關於MySQL事務的10個問題常見面試問答 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/1669c986-315c-4339-a5a0-a918a47f2e57 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/677306ff.html title=面試總結：關於MySQL事務的10個問題常見面試問答>面試總結：關於MySQL事務的10個問題常見面試問答</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6fb70ed7.html alt=這6個電路圖掌握了，保證能搞電的你頓悟不少！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/eb964a84eb9b423496c324a5cddb22e5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6fb70ed7.html title=這6個電路圖掌握了，保證能搞電的你頓悟不少！>這6個電路圖掌握了，保證能搞電的你頓悟不少！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/adc31f83.html alt=Java面試知識點總結⑥——算法與數據結構_一點課堂（多岸學院） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/68ac43b98fa343f2874d08bacae73ee8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/adc31f83.html title=Java面試知識點總結⑥——算法與數據結構_一點課堂（多岸學院）>Java面試知識點總結⑥——算法與數據結構_一點課堂（多岸學院）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cdbf5cb4.html alt=面試中常被問到的Hash表，你瞭解嗎 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/dfic-imagehandler/ba5ea1b5-dee5-4145-8f0d-8eee90a5eba6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cdbf5cb4.html title=面試中常被問到的Hash表，你瞭解嗎>面試中常被問到的Hash表，你瞭解嗎</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2eecc1b9.html alt=面試再問ThreadLocal，別說你不會 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3a95ff3cd79a456d9221f66851f8c2f9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2eecc1b9.html title=面試再問ThreadLocal，別說你不會>面試再問ThreadLocal，別說你不會</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d1d10456.html alt=面試總結-Java高級篇 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/4afe0004abfd4a7bb3c5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d1d10456.html title=面試總結-Java高級篇>面試總結-Java高級篇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b10623ce.html alt=你不得不知道的HashMap面試連環炮 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/278ed0687f4d436f9cb8389a38b1603e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b10623ce.html title=你不得不知道的HashMap面試連環炮>你不得不知道的HashMap面試連環炮</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ae15b401.html alt="有關 HashMap 面試會問的一切" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/25263d0d73a143bab5e44096efdd931d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ae15b401.html title="有關 HashMap 面試會問的一切">有關 HashMap 面試會問的一切</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3e2c89d5.html alt="面試官：為什麼 HashMap 的加載因子是0.75？" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/15a700f4ff6a4082a566db903915ea1b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3e2c89d5.html title="面試官：為什麼 HashMap 的加載因子是0.75？">面試官：為什麼 HashMap 的加載因子是0.75？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/95a57792.html alt=面試官：100萬個成員的數組取第一個和最後一個有性能差距嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5d61204d36a64ca9864df863782072b0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/95a57792.html title=面試官：100萬個成員的數組取第一個和最後一個有性能差距嗎？>面試官：100萬個成員的數組取第一個和最後一個有性能差距嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2af63da0.html alt=保證防滲土工膜質量需從材料源頭把關 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/923326a00e514a0089c04e8f89de879d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2af63da0.html title=保證防滲土工膜質量需從材料源頭把關>保證防滲土工膜質量需從材料源頭把關</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8db576a1.html alt=面試必問，進程和線程概念詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/31f152f300834172b846a27e904440e1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8db576a1.html title=面試必問，進程和線程概念詳解>面試必問，進程和線程概念詳解</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>