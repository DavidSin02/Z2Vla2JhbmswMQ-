<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>面試再問ThreadLocal，別說你不會 | 极客快訊</title><meta property="og:title" content="面試再問ThreadLocal，別說你不會 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/3a95ff3cd79a456d9221f66851f8c2f9"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2eecc1b9.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2eecc1b9.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2eecc1b9.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2eecc1b9.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2eecc1b9.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2eecc1b9.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2eecc1b9.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2eecc1b9.html><meta property="article:published_time" content="2020-11-14T21:07:43+08:00"><meta property="article:modified_time" content="2020-11-14T21:07:43+08:00"><meta name=Keywords content><meta name=description content="面試再問ThreadLocal，別說你不會"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/2eecc1b9.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>面試再問ThreadLocal，別說你不會</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><pre>作者：堅持就是勝利來源：https://juejin.im/post/5d427f306fb9a06b122f1b94</pre><p>ThreadLocal是什麼</p><p>以前面試的時候問到ThreadLocal總是一臉懵逼，只知道有這個哥們，不瞭解他是用來做什麼的，更不清楚他的原理了。表面上看他是和多線程，線程同步有關的一個工具類，但其實他與線程同步機制無關。<strong>線程同步機制是多個線程共享同一個變量，而ThreadLocal是為每個線程創建一個單獨的變量副本，每個線程都可以改變自己的變量副本而不影響其它線程所對應的副本。</strong></p><p>官方API上是這樣介紹的：該類提供了線程局部(thread-local)變量。這些變量不同於它們的普通對應物，因為訪問某個變量（通過其 get 或 set 方法）的每個線程都有自己的局部變量，它獨立於變量的初始化副本。ThreadLocal實例通常是類中的 private static 字段，它們希望將狀態與某一個線程（例如，用戶 ID 或事務 ID）相關聯。</p><p>ThreadLocal的API</p><p>ThreadLocal定義了四個方法:</p><ul><li class=ql-align-justify>get():返回此線程局部變量當前副本中的值</li><li class=ql-align-justify>set(T value):將線程局部變量當前副本中的值設置為指定值</li><li class=ql-align-justify>initialValue():返回此線程局部變量當前副本中的初始值</li><li class=ql-align-justify>remove():移除此線程局部變量當前副本中的值</li></ul><p>ThreadLocal還有一個特別重要的靜態內部類ThreadLocalMap，該類才是實現線程隔離機制的關鍵。get()、set()、remove()都是基於該內部類進行操作，ThreadLocalMap用鍵值對方式存儲每個線程變量的副本，key為當前的ThreadLocal對象，value為對應線程的變量副本。</p><p>試想，每個線程都有自己的ThreadLocal對象，也就是都有自己的ThreadLocalMap，對自己的ThreadLocalMap操作，當然是互不影響的了，這就不存在線程安全問題了，所以ThreadLocal是以空間來交換安全性的解決思路。</p><p>使用實例</p><p>假設每個線程都需要一個計數值記錄自己做某件事做了多少次，各線程運行時都需要改變自己的計數值而且相互不影響，那麼ThreadLocal就是很好的選擇，這裡ThreadLocal裡保存的當前線程的局部變量的副本就是這個計數值。</p><div class=pgc-img><img alt=面試再問ThreadLocal，別說你不會 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3a95ff3cd79a456d9221f66851f8c2f9><p class=pgc-img-caption></p></div><p>運行結果：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=面試再問ThreadLocal，別說你不會 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5f5d8c816ac745d79b1498d282713118><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>解決SimpleDateFormat的線程安全</p><p>我們知道SimpleDateFormat在多線程下是存在線程安全問題的，那麼將SimpleDateFormat作為每個線程的局部變量的副本就是每個線程都擁有自己的SimpleDateFormat，就不存在線程安全問題了。</p><pre>public class SimpleDateFormatDemo { private static final String DATE_FORMAT = "yyyy-MM-dd HH:mm:ss"; private static ThreadLocal&lt;DateFormat&gt; threadLocal = new ThreadLocal&lt;&gt;(); /** * 獲取線程的變量副本，如果不覆蓋initialValue方法，第一次get將返回null,故需要創建一個DateFormat，放入threadLocal中 * @return */ public DateFormat getDateFormat() { DateFormat df = threadLocal.get(); if (df == null) { df = new SimpleDateFormat(DATE_FORMAT); threadLocal.set(df); } return df; } public static void main(String [] args) { SimpleDateFormatDemo formatDemo = new SimpleDateFormatDemo(); MyRunnable myRunnable1 = new MyRunnable(formatDemo); MyRunnable myRunnable2 = new MyRunnable(formatDemo); MyRunnable myRunnable3 = new MyRunnable(formatDemo); Thread thread1= new Thread(myRunnable1); Thread thread2= new Thread(myRunnable2); Thread thread3= new Thread(myRunnable3); thread1.start(); thread2.start(); thread3.start(); } public static class MyRunnable implements Runnable { private SimpleDateFormatDemo dateFormatDemo; public MyRunnable(SimpleDateFormatDemo dateFormatDemo) { this.dateFormatDemo = dateFormatDemo; } @Override public void run() { System.out.println(Thread.currentThread().getName()+" 當前時間："+dateFormatDemo.getDateFormat().format(new Date())); } }}</pre><p>運行結果：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=面試再問ThreadLocal，別說你不會 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/90f6c6812e814deda1746c15fa813d26><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>源碼分析</p><p>ThreadLocalMap</p><p>ThreadLocalMap內部是利用Entry來進行key-value的存儲的。</p><pre>static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; { /** The value associated with this ThreadLocal. */ Object value; Entry(ThreadLocal&lt;?&gt; k, Object v) { super(k); value = v; } }</pre><p>上面源碼中key就是ThreadLocal，value就是值，Entry繼承WeakReference，所以Entry對應key的引用（ThreadLocal實例）是一個弱引用。</p><p>set(ThreadLocal key, Object value)</p><div class=pgc-img><img alt=面試再問ThreadLocal，別說你不會 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2097cc9cda4b4494a3076655a39ab408><p class=pgc-img-caption></p></div><p>這個set操作和集合Map解決散列衝突的方法不同，集合Map採用的是鏈地址法，這裡採用的是開放定址法（線性探測）。set()方法中的replaceStaleEntry()和cleanSomeSlots()，這兩個方法可以清除掉key ==null的實例，防止內存洩漏。</p><p>getEntry()</p><pre>private Entry getEntry(ThreadLocal&lt;?&gt; key) { int i = key.threadLocalHashCode &amp; (table.length - 1); Entry e = table[i]; if (e != null &amp;&amp; e.get() == key) return e; else return getEntryAfterMiss(key, i, e); }</pre><p>由於採用了開放定址法，當前keu的散列值和元素在數組中的索引並不是一一對應的，首先取一個猜測數（key的散列值），如果所對應的key是我們要找的元素，那麼直接返回，否則調用getEntryAfterMiss</p><pre>private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) { Entry[] tab = table; int len = tab.length; while (e != null) { ThreadLocal&lt;?&gt; k = e.get(); if (k == key) return e; if (k == null) expungeStaleEntry(i); else i = nextIndex(i, len); e = tab[i]; } return null; }</pre><p>這裡一直在探測尋找下一個元素，知道找的元素的key是我們要找的。這裡當key==null時，調用expungeStaleEntry有利於GC的回收，用於防止內存洩漏。</p><p>ThreadLocal為什麼會內存洩漏</p><p>ThreadLocalMap的key為ThreadLocal實例，他是一個弱引用，我們知道弱引用有利於GC的回收，當key == null時，GC就會回收這部分空間，但value不一定能被回收，因為他和Current Thread之間還存在一個強引用的關係。由於這個強引用的關係，會導致value無法回收，如果線程對象不消除這個強引用的關係，就可能會出現OOM。有些時候，我們調用ThreadLocalMap的remove()方法進行顯式處理。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=面試再問ThreadLocal，別說你不會 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/286e781e7dc14ebeaa09414d519af46f><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>總結</p><p>ThreadLocal不是用來解決共享變量的問題，也不是協調線程同步，他是為了方便各線程管理自己的狀態而引用的一個機制。</p><p>每個ThreadLocal內部都有一個ThreadLocalMap,他保存的key是ThreadLocal的實例，他的值是當前線程的局部變量的副本的值。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>面試</a></li><li><a>再問</a></li><li><a>ThreadLocal</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/677306ff.html alt=面試總結：關於MySQL事務的10個問題常見面試問答 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/1669c986-315c-4339-a5a0-a918a47f2e57 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/677306ff.html title=面試總結：關於MySQL事務的10個問題常見面試問答>面試總結：關於MySQL事務的10個問題常見面試問答</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/adc31f83.html alt=Java面試知識點總結⑥——算法與數據結構_一點課堂（多岸學院） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/68ac43b98fa343f2874d08bacae73ee8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/adc31f83.html title=Java面試知識點總結⑥——算法與數據結構_一點課堂（多岸學院）>Java面試知識點總結⑥——算法與數據結構_一點課堂（多岸學院）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1c9afde0.html alt="一起來談談ThreadLocal 原理吧！你需要了解！" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/499a403f2b63464db8e3e12298c1a3e5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1c9afde0.html title="一起來談談ThreadLocal 原理吧！你需要了解！">一起來談談ThreadLocal 原理吧！你需要了解！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a915e749.html alt=多線程之ThreadLocal的那些事 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/58bb67505b204eef816b6e3b75935246 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a915e749.html title=多線程之ThreadLocal的那些事>多線程之ThreadLocal的那些事</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ef5bd4a5.html alt=從源碼角度來剖析ThreadLocal到底有沒有內存洩漏？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/67412c6e1bba450b9581452ab0e56e4c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ef5bd4a5.html title=從源碼角度來剖析ThreadLocal到底有沒有內存洩漏？>從源碼角度來剖析ThreadLocal到底有沒有內存洩漏？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4bac2fc4.html alt=這4種ThreadLocal你都知道嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/02621283c0574fd79fbb6ff5ea971384 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4bac2fc4.html title=這4種ThreadLocal你都知道嗎？>這4種ThreadLocal你都知道嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cdbf5cb4.html alt=面試中常被問到的Hash表，你瞭解嗎 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/dfic-imagehandler/ba5ea1b5-dee5-4145-8f0d-8eee90a5eba6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cdbf5cb4.html title=面試中常被問到的Hash表，你瞭解嗎>面試中常被問到的Hash表，你瞭解嗎</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d1d10456.html alt=面試總結-Java高級篇 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/4afe0004abfd4a7bb3c5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d1d10456.html title=面試總結-Java高級篇>面試總結-Java高級篇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b10623ce.html alt=你不得不知道的HashMap面試連環炮 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/278ed0687f4d436f9cb8389a38b1603e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b10623ce.html title=你不得不知道的HashMap面試連環炮>你不得不知道的HashMap面試連環炮</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ae15b401.html alt="有關 HashMap 面試會問的一切" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/25263d0d73a143bab5e44096efdd931d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ae15b401.html title="有關 HashMap 面試會問的一切">有關 HashMap 面試會問的一切</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3e2c89d5.html alt="面試官：為什麼 HashMap 的加載因子是0.75？" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/15a700f4ff6a4082a566db903915ea1b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3e2c89d5.html title="面試官：為什麼 HashMap 的加載因子是0.75？">面試官：為什麼 HashMap 的加載因子是0.75？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/95a57792.html alt=面試官：100萬個成員的數組取第一個和最後一個有性能差距嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5d61204d36a64ca9864df863782072b0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/95a57792.html title=面試官：100萬個成員的數組取第一個和最後一個有性能差距嗎？>面試官：100萬個成員的數組取第一個和最後一個有性能差距嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8db576a1.html alt=面試必問，進程和線程概念詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/31f152f300834172b846a27e904440e1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8db576a1.html title=面試必問，進程和線程概念詳解>面試必問，進程和線程概念詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d2fb2eaa.html alt="不怕面試被問了！二叉樹算法大盤點 | 原力計劃" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RseEOGoFGbwiHH style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d2fb2eaa.html title="不怕面試被問了！二叉樹算法大盤點 | 原力計劃">不怕面試被問了！二叉樹算法大盤點 | 原力計劃</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8f670109.html alt="別再翻了，百度大牛整理的面試二叉樹有這 11 個就夠了~" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/dcd72bc8778d44e6bffbf74b1e60ca72 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8f670109.html title="別再翻了，百度大牛整理的面試二叉樹有這 11 個就夠了~">別再翻了，百度大牛整理的面試二叉樹有這 11 個就夠了~</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>