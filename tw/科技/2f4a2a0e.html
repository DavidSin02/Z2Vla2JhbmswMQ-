<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Canal探究 | 极客快訊</title><meta property="og:title" content="Canal探究 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/21195268939c4bf18e20ee9b7222c8f3"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2f4a2a0e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2f4a2a0e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2f4a2a0e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2f4a2a0e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2f4a2a0e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2f4a2a0e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/2f4a2a0e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/2f4a2a0e.html><meta property="article:published_time" content="2020-10-29T21:09:58+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:58+08:00"><meta name=Keywords content><meta name=description content="Canal探究"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/2f4a2a0e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Canal探究</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal主要用途是基於 MySQL 數據庫增量日誌解析，提供增量數據訂閱和消費。</span></p><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">應用場景：</span></strong></h1><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">異構數據同步</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">數據庫實時備份</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">業務cache刷新</span></li></ul><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">原理</span></strong></h1><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal模擬成mysql slave向master發送dump請求，收到binlog數據進行解析</span></p><div class=pgc-img><img alt=Canal探究 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/21195268939c4bf18e20ee9b7222c8f3><p class=pgc-img-caption></p></div><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">slave同步master原理：</span></p><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">master將改變記錄到二進制日誌(binary log)中（這些記錄叫做二進制日誌事件，binary log events，可以通過show binlog events進行查看）</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">slave將binary log events拷貝到它的中繼日誌(relay log)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">slave重做中繼日誌中的事件，將改變反映它自己的數據</span></li></ul><div class=pgc-img><img alt=Canal探究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5cd58b9a986840daa97ba4e505c5e287><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">架構</span></strong></h1><div class=pgc-img><img alt=Canal探究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/34ea9dba399347248bbf85d526f450b1><p class=pgc-img-caption></p></div><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">server代表一個canal運行實例，對應於一個jvm</span></p><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">instance對應一個數據隊列，一個destination，相當於一個數據庫實例變更的監聽，1個server對應1-n個instance</span></p><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">instance模塊：</span></p><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">eventParser (數據源接入，模擬slave協議和master進行交互，協議解析)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">eventSink (Parser和Store</span><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">鏈接</span><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">器，進行數據過濾，加工，分發的工作)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">eventStore (數據存儲)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">metaManager (增量訂閱&消費信息管理器)</span></li></ul><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">EventParser</span></strong></h1><div class=pgc-img><img alt=Canal探究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5858458cde1f47dc910d1bb836ae4f91><p class=pgc-img-caption></p></div><ol start=1><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Connection獲取上一次解析成功的位置 (如果第一次啟動，則獲取初始指定的位置或者是當前數據庫的binlog位點)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Connection建立鏈接，發送BINLOG_DUMP指令</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Mysql開始推送Binaly Log</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">接收到的Binaly Log的通過Binlog parser進行協議解析，補充一些特定信息</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">傳遞給EventSink模塊進行數據存儲，是一個阻塞操作，直到存儲成功</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">存儲成功後，定時記錄Binaly Log位置</span></li></ol><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">EventSink</span></strong></h1><div class=pgc-img><img alt=Canal探究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/84ea836792604f7e869c6ec5889f1ce9><p class=pgc-img-caption></p></div><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">數據過濾：支持通配符的過濾模式，表名，字段內容等</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">數據路由/分發：解決1:n (1個parser對應多個store的模式)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">數據</span><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">歸併</span><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">：解決n:1 (多個parser對應1個store)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">數據加工：在進入store之前進行額外的處理，比如join</span></li></ul><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">EventStore</span></strong></h1><div class=pgc-img><img alt=Canal探究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2d649fb46a6e4dac996b8229f1d94b3f><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Instance設計</span></strong></h1><div class=pgc-img><img alt=Canal探究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/98ad7f236c99455696717dd13f5cab6f><p class=pgc-img-caption></p></div><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">instance代表了一個實際運行的數據隊列，包括了EventPaser,EventSink,EventStore等組件。抽象了CanalInstanceGenerator，主要是考慮配置的管理方式：</span></p><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">manager方式：提供http方式，可以和公司內部web console/manager系統進行對接。</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">spring方式：基於spring xml + properties進行定義，通過spring配置</span></li></ul><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Spring配置</span></strong></h1><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">spring配置的原理是將整個配置抽象為兩部分：</span></p><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">xxxx-instance.xml (canal組件的配置定義，可以在多個instance配置中共享，在canal.properties中配置)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">xxxx.properties (每個instance通道都有各自一份定義，因為每個mysql的ip，帳號，密碼等信息不會相同)</span></li></ul><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">通過spring的PropertyPlaceholderConfigurer通過機制將其融合，生成一份instance實例對象，每個instance對應的組件都是相互獨立的，互不影響</span></p><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">properties配置文件</span></strong></h1><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">properties配置分為兩部分：</span></p><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal.properties (系統根配置文件，配置destinations，註冊IP，啟動端口)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">instance.properties (instance級別的配置文件，每個instance一份，配置數據庫信息，監聽的表)</span></li></ul><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal.properties介紹：</span></p><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal配置主要分為兩部分定義：</span></p><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">instance列表定義 (列出當前server上有多少個instance，每個instance的加載方式是spring/manager等)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">common參數定義，比如可以將instance.properties的公用參數，抽取放置到這裡，這樣每個instance啟動的時候就可以共享. 【instance.properties配置定義優先級高於canal.properties】</span></li></ul><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal如何維護一份增量訂閱&消費的關係信息：</span></strong></h1><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">解析位點 (parse模塊會記錄，上一次解析binlog到了什麼位置，對應組件為：CanalLogPositionManager)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">消費位點 (canal server在接收了客戶端的ack後，就會記錄客戶端提交的最後位點，對應的組件為：CanalMetaManager)</span></li></ul><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">對應的兩個位點組件，目前都有幾種實現：</span></p><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">memorymemory-instance.xml中使用，所有的組件(parser , sink , store)都選擇了內存版模式，記錄位點的都選擇了memory模式，重啟後又會回到初始位點進行解析速度最快，依賴最少(不需要zookeeper)場景：一般應用在quickstart，或者是出現問題後，進行數據分析的場景，不應該將其應用於生產環境</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">zookeeper</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">mixed</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">period：default-instance.xml中使用，集合了zookeeper+memory模式，store選擇了內存模式，其餘的parser/sink依賴的位點管理選擇了持久化模式，目前持久化的方式主要是寫入zookeeper，保證數據集群共享支持HA，可用於生產環境，集群化部署</span></li></ul><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">一份 instance.xml 中有一份或者多份 instance 定義，優先</span><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">以</span><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313"> destination 名字查找對應的 instance bean 定義，如果沒有，則按默認的名字 “instance” 查找 instance 對象,例如 xxxx-instance.xml 中定義 id 分別為 instance-1, instance-2 的兩個 bean. 這兩個 bean 將為同名的 instance 提供自定義的 eventParser , evnetSink , evnetStore , metaManager，alarmHandler.如果沒有自定義這些 bean, 就使用 id="instance" 的 bean 來配置 canal instance.</span></p><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">一份 instance bean 定義，需要包含 eventParser , evnetSink , evnetStore , metaManager，alarmHandler 的5個模塊定義，( alarmHandler 主要是一些報警機制處理，因為簡單沒展開，可擴展)</span></p><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">instance.xml設計初衷：</span></p><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">允許進行自定義擴展，比如實現了基於數據庫的位點管理後，可以自定義一份自己的instance.xml，整個canal設計中最大的靈活性在於此</span></p><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">HA模式配置</span></strong></h1><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal的ha分為兩部分：</span></p><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal server: 不同server上的instance要求同一時間只能有一個處於running，其他的處於standby狀態，不然就是對mysql dump的重複請求。這裡是instance/destination級別的負載均衡，而不是server</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal client: 為了保證有序性，一份instance同一時間只能由一個canal client進行get/ack/rollback操作，否則客戶端接收無法保證有序。</span></li></ul><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">整個HA機制的控制主要是依賴了zookeeper的幾個特性，watcher和EPHEMERAL節點(和session生命週期綁定)</span></p><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Canal Server:</span></p><div class=pgc-img><img alt=Canal探究 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/c239c402304c4b32911ff4be6a25157f><p class=pgc-img-caption></p></div><ol start=1><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal server要啟動某個canal instance時都先向zookeeper進行一次嘗試啟動判斷 (實現：創建EPHEMERAL節點，誰創建成功就允許誰啟動)</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">創建zookeeper節點成功後，對應的canal server就啟動對應的canal instance，沒有創建成功的canal instance就會處於standby狀態</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">一旦zookeeper發現canal server A創建的節點消失後，立即通知其他的canal server再次進行步驟1的操作，重新選出一個canal server啟動instance.</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal client每次進行connect時，會首先向zookeeper詢問當前是誰啟動了canal instance，然後和其建立鏈接，一旦鏈接不可用，會重新嘗試connect.</span></li></ol><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Canal Client的方式和canal server方式類似，也是利用zookeeper的搶佔EPHEMERAL節點的方式進行控制.</span></p><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal丟失數據的情況：</span></strong></h1><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">正常情況下，在canal server/client掛掉或切換的情況下不會丟失數據，因為zk會持久化server解析binlog及clinet消費數據的位置，重啟時會重新讀取。以下情況可能會丟失數據：</span></p><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">zk保存的元數據被人為修改，如server解析binlog及clinet消費數據的位置</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">client使用get方法而非getWithoutAck，如果client消費數據時掛掉，server會認為這部分數據已經被消費而丟失</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">MySQL binlog非正常運維，比如binglog遷移、重命名、丟失等</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">切換MySQL源，比如原來基於M1實例，後來M1因為某種原因失效，那麼Canal將數據源切換為M2，而且M1和M2可能binlog數據存在不一致</span></li></ul><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Canal性能分析</span></strong></h1><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal處理數據流程為master-parse-sink-store-comsume，整個流程中都是單線程、串行、阻塞式的。如果批量insert、update、delete，都可能導致大量的binlog產生，也會加劇Master與slave之間數據同步的延遲。（寫入頻繁）。</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">如果client消費的效能較低，比如每條event執行耗時很長。這會導致數據變更的消息ACK較慢，那麼對於Canal而言也將阻塞sotre，沒有有足夠的空間存儲新消息進而堵塞parse解析binlog。</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Canal本身非常輕量級，主要性能開支就是在binlog解析，其轉發、存儲、提供消費者服務等都很簡單。它本身不負責數據存儲。原則上，canal解析效率幾乎沒有負載，canal的本身的延遲，取決於其與slave之間的網絡IO。</span></li></ul><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Canal導致重複消費</span></strong></h1><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Canal instance初始化時，根據“消費者的Cursor”來確定binlog的起始位置，但是Cursor在ZK中的保存是滯後的（間歇性刷新），所以Canal instance獲得的起始position一定不會大於消費者真實</span><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">已見</span><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">的position。</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">Consumer端，因為某種原因的rollback，也可能導致一個batch內的所有消息重發，此時可能導致重複消費。</span></li></ul><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">因此Consumer端需要保持冪等，對於重複數據可以進行校驗或者replace。對於非冪等操作，比如累加、計費，需要慎重。</span></p><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">destination的消費問題</span></strong></h1><p style=text-align:start><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">一個destination無法被多個client直接並行消費，解決方案：</span></p><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">client收到消息以後轉發到kafka或者MQ中，後繼的其他Consumer只與kafka或者MQ接入</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">一個Canal中使用多個destination，它們對應相同的MySQL源</span></li></ul><p><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">參考：</span></p><p><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">https://github.com/alibaba/canal/wiki/AdminGuide</span></p><p><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">https://www.bookstack.cn/read/canal-v1.1.4/10a3a22ce51cd92e.md</span></p><p><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">https://blog.csdn.net/guanfengliang1988/article/details/107357853</span></p><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">對於canal設計的一些思考</span></strong></h1><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">對於canal的高可用，通過zk保證server和client同一時間只能</span><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">有</span><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">一個節點工作server能不能根據數據id進行分片讀取，提高讀取數據的性能，類似kafka的設計，應該是不能的。因為parser向master發起dump請求得到的是字節流，無法獲取原始數據。那能不能一個parser對應多個sink再放入store。沒必要，因為canal的性能瓶頸在canal與數據庫的網絡IO，解析及sink是很快的。客戶端能不能多個節點同時工作，從一個destination消費數據。如果不保證數據成功消費及有序性是可以的。如果某一client消費數據失敗，當前store的設計（環形結構保存數據）無法做到回滾。如果一個destination分多個隊列由client消費，只能保證數據局部有序，同時設計複雜。</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">當前store的數據保存在內存中，是否有必要持久化到文件類似於logstash的數據也是保存在內存中，官方文檔說會支持，但沒有也可以，因為持久化會影響整體性能，通過zk存儲client的消費位置會保證數據至少被消費一次。</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">store保存的數據受到大小和條數的限制，當達到限制時，sink會堵塞parser，不會撐爆內存</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">canal與logstahs，kafka的一些比較</span></li></ul><h1 class=pgc-h-arrow-right><strong><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">對以後寫公共組件的一些啟示：</span></strong></h1><ul><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">支持多種配置方式如配置文件，http，並可動態生效</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">通過協調服務保證系統的高可用</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">暴露服務監控指標至prometheus</span></li><li><span style="background-color:#fefefe;--tt-darkmode-bgcolor: #131313">獲取數據的方式：達到一定數量或時間</span></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Canal</a></li><li><a>探究</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/ab1019fd.html alt=探究:三角變換之角變換 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/701c67af7f3f495fb8c94aebe31b44ee style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ab1019fd.html title=探究:三角變換之角變換>探究:三角變換之角變換</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b63696f9.html alt=透水混凝土性能與工程應用探究（上） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/830aeb2306a0460fb006e6d30c041c8c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b63696f9.html title=透水混凝土性能與工程應用探究（上）>透水混凝土性能與工程應用探究（上）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d34e3096.html alt=探究——電容嘯叫的原因揭祕 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7054ac22e32c45b4b4e2cd1beb8a06af style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d34e3096.html title=探究——電容嘯叫的原因揭祕>探究——電容嘯叫的原因揭祕</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/20559cc7.html alt=基於Canal和Kafka實現MySQL的Binlog近實時同步 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/dafc2ca594c643728ee9361b349265ae style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/20559cc7.html title=基於Canal和Kafka實現MySQL的Binlog近實時同步>基於Canal和Kafka實現MySQL的Binlog近實時同步</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/56521b36.html alt=姚姓家族探究 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/56521b36.html title=姚姓家族探究>姚姓家族探究</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c73093ce.html alt=探究給排水設計中注意的問題 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c73093ce.html title=探究給排水設計中注意的問題>探究給排水設計中注意的問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bcece155.html alt=AES算法探究 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/30b11cc3568848a58763b3414f755bfd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bcece155.html title=AES算法探究>AES算法探究</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/41e067fa.html alt="Canal 如何實現數據庫庫事務的一致性" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/c46cdca193864806be3dd7d81af2ccaf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/41e067fa.html title="Canal 如何實現數據庫庫事務的一致性">Canal 如何實現數據庫庫事務的一致性</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7bfc9810.html alt=試題探究：同構問題探究 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ce0c47e5013646c59820b9535ca4ea37 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7bfc9810.html title=試題探究：同構問題探究>試題探究：同構問題探究</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/513c162.html alt=關於復二次型的進一步探究（一） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/413aabd364f541a8aed054200130bd4d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/513c162.html title=關於復二次型的進一步探究（一）>關於復二次型的進一步探究（一）</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/90d5bd3.html alt=深入蘭花瓣形理論探究 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/66a500016f3c8d73d140 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/90d5bd3.html title=深入蘭花瓣形理論探究>深入蘭花瓣形理論探究</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/722887e.html alt="中考化學重點複習——實驗探究題 類型五 金屬性質的相關探究" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c3435089bad64a2cae3c327c43a2d9b6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/722887e.html title="中考化學重點複習——實驗探究題 類型五 金屬性質的相關探究">中考化學重點複習——實驗探究題 類型五 金屬性質的相關探究</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/574a317.html alt=大宇：匈奴武士探究 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/pgc-image/bbf9dc9aeac041a980689ef285ec7d1c style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/574a317.html title=大宇：匈奴武士探究>大宇：匈奴武士探究</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/1b11f0c.html alt=【探究】《長安十二時辰》裡，古人究竟是如何防火的？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/1b11f0c.html title=【探究】《長安十二時辰》裡，古人究竟是如何防火的？>【探究】《長安十二時辰》裡，古人究竟是如何防火的？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>