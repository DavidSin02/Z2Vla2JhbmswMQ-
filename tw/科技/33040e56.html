<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一次代碼優化實踐，模板方法+策略+工廠方法模式（技術乾貨） | 极客快訊</title><meta property="og:title" content="一次代碼優化實踐，模板方法+策略+工廠方法模式（技術乾貨） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/cecb4bc3ea6e47dab7e55448316f96ce"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33040e56.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33040e56.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/33040e56.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33040e56.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33040e56.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/33040e56.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/33040e56.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/33040e56.html><meta property="article:published_time" content="2020-11-14T21:00:09+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:09+08:00"><meta name=Keywords content><meta name=description content="一次代碼優化實踐，模板方法+策略+工廠方法模式（技術乾貨）"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/33040e56.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一次代碼優化實踐，模板方法+策略+工廠方法模式（技術乾貨）</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right><strong>前言</strong></h1><p>好久沒分享工作總結啦，今天來一份代碼優化總結。用模板方法+策略+工廠方法模式優化了代碼，耐心點看完，應該對大家有幫助的~</p><p><strong>作者：「公眾號：撿田螺的小男孩」</strong></p><h1 class=pgc-h-arrow-right><strong>優化代碼前</strong></h1><p>先來了解一下類似的業務場景，簡言之，就是：多個商戶接入我們系統，都是走一個類似的流程通過http請求出去的。</p><div class=pgc-img><img alt=一次代碼優化實踐，模板方法+策略+工廠方法模式（技術乾貨） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cecb4bc3ea6e47dab7e55448316f96ce><p class=pgc-img-caption></p></div><p>優化前，每個公司對應一個句柄服務，偽代碼如下：</p><pre><code>// 商戶A處理句柄CompanyAHandler implements RequestHandler {   Resp hander(req){   //查詢商戶信息   queryMerchantInfo();   //加簽   signature();   // http請求（走代理）   httpRequestbyProxy()   // 驗籤   verify();   }}// 商戶B處理句柄CompanyBHandler implements RequestHandler {   Resp hander(Rreq){   //查詢商戶信息   queryMerchantInfo();   //加簽   signature();   // http請求（不走代理）   httpRequestbyDirect();   // 驗籤   verify();    }}// 商戶C處理句柄CompanyBHandler implements RequestHandler {   Resp hander(Rreq){   //查詢商戶信息   queryMerchantInfo();   // webservice 方式調用   requestByWebservice();   }}</code></pre><h1 class=pgc-h-arrow-right><strong>優化代碼思路</strong></h1><p>我的優化代碼思路，是有<strong>「重複代碼，先把它抽出來，或者公用變量，或者公用方法，</strong><strong>伸著</strong><strong>公用類」</strong>。所以呢，查詢商戶信息呀，加簽呀，http請求呀先全部各抽成一個公用方法。你細心點會發現，連每個Handler處理過程都很類似的，大概都是查詢商戶信息+加簽+http請求+驗籤，於是呢，可以直接把它們抽象成一個公用類呀~在這裡就要引入模板方法模式咯</p><h1 class=pgc-h-arrow-right><strong>模板方法模式</strong></h1><pre><code>在模板模式（Template Pattern）中，一個抽象類公開定義了執行它的方法的方式/模板。它的子類可以按需要重寫方法實現，但調用將以抽象類中定義的方式進行。這種類型的設計模式屬於行為型模式。</code></pre><p>既然每個Handler處理，都是類似的流程，那<strong>「定義一個抽象類，把查詢商戶信息，加簽，http請求，驗籤什麼的，都放到裡面去，儼然一個模板一樣」</strong>。然後，因為有些商戶走http代理，有些又沒走代理，怎麼辦呢? 定義<strong>「一個抽象方法，給子類實現」</strong>嘛，因為能共用就放到父類（當前的抽象類），不能共用就放到子類嘛~代碼如下：</p><pre><code>abstract class AbstractCompanyCommonService implements ICompanyCommonService {      //模板方法     Resp handlerTempPlate(req){            //查詢商戶信息           queryMerchantInfo();           // 加簽           signature();           //http 請求           if(isRequestByProxy()){              httpProxy();            }else{              httpDirect();             }            // 驗籤            verifySinature();     }      // Http是否走代理      abstract boolean isRequestByProxy();}</code></pre><p>子類商戶A實現：</p><pre><code>CompanyAServiceImpl extends AbstractCompanyCommonService{    Resp hander(req){      return handlerTempPlate(req);    }    //公司A是走代理的    boolean isRequestByProxy(){       return true;    }</code></pre><p>子類商戶B實現：</p><pre><code>CompanyBServiceImpl extends AbstractCompanyCommonService{    Resp hander(req){      return handlerTempPlate(req);    }    //公司B是不走代理的    boolean isRequestByProxy(){       return false;    }</code></pre><h1 class=pgc-h-arrow-right><strong>策略模式</strong></h1><p>心細的讀者會發現，甚至提出疑問，<strong>「你的商戶C的服務實現跟你定義的公用模板，不太一樣呢」</strong>，那當然，實際開發中，不跟你定義的模板一樣太常見了，需求是產品提的嘛，又不是根據你模板提的，是代碼服務於需求的。好了，不多說啦，我使用了策略模式，來優化這個問題。</p><pre><code>在策略模式（Strategy Pattern）中，一個類的行為或其算法可以在運行時更改。這種類型的設計模式屬於行為型模式。</code></pre><p>策略模式理解起來其好抽象對不對？我個人理解，其實策略模式就是定義一個方法（所謂算法），給子類自己去實現。實際上就是<strong>「定義個方法/接口，讓子類自己去實現」</strong>。看代碼吧：</p><pre><code>// 定義一個方法，把策略交給子類去實現。interface ICompanyCommonService{  Resp hander(req);}</code></pre><p>前面商戶A和商戶B還是不變，使用抽象類AbstractCompanyCommonService的模板，模板不滿足商戶C，商戶C只能自己去實現咯，各個子類自己去實現的行為，就是策略模式的體現呢，如下：</p><pre><code>CompanyCServiceImpl extends AbstractCompanyCommonService{    Res hander(req){       //查詢商戶信息       queryMerchantInfo();       requestByWebservice();        }    //隨意了，你都不走模板了    boolean isRequestByProxy(){       return false;    }</code></pre><h1 class=pgc-h-arrow-right><strong>工廠方法模式</strong></h1><p>商戶A、B、C服務怎麼被管理呢，之前分別給A，B，C服務實現handler的，現在好了，都不知道怎麼管理了，怎麼知道調用哪個呢？別慌，解決方案是<strong>「工廠方法模式」</strong>。</p><pre><code>在工廠模式中，我們在創建對象時不會對客戶端暴露創建邏輯，並且是通過使用一個共同的接口來指向新創建的對象。</code></pre><p>工廠方法模式具體實現就是：接口定義一個枚舉，每個服務實現都重新實現枚舉，設置唯一標誌枚舉，再交給spring容器管理。看代碼咯：</p><pre><code>interface ICompanyCommonService{  Resp hander(req);  CompanyEnum getCompanyEnum();}CompanyAServiceImpl extends AbstractCompanyCommonService{    Resp hander(req){      return handlerTempPlate(req);    }    //公司A是走代理的    boolean isRequestByProxy(){       return true;    }    CompanyEnum getCompanyEnum(){     return CompanyEnum.A;    }     CompanyBServiceImpl extends AbstractCompanyCommonService{    Resp hander(req){      return handlerTempPlate(req);    }    //公司B是不走代理的    boolean isRequestByProxy(){       return false;    }    CompanyEnum getCompanyEnum(){     return CompanyEnum.B;    } </code></pre><p>來來來，工廠方法模式出爐咯：</p><pre><code>@Componentpublic class CompanyServiceFactory implements ApplicationContextAware {    private static Map&lt;CompanyEnum, ICompanyCommonService&gt; map = new HashMap&lt;&gt;();    @Override    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {        Map&lt;String, ICompanyCommonService&gt; tempMap = applicationContext.getBeansOfType(ICompanyCommonService.class);        tempMap.values().forEach(iCompanyCommonService -&gt;                map.put(iCompanyCommonService.getCompanyEnum(), iCompanyCommonService));    }    public Resp handler(req) {        return map.get(CompanyEnum.getCompanyEnum(req.getCompanyFlag()).hander(req);    }}</code></pre><h1 class=pgc-h-arrow-right><strong>最後建議</strong></h1><p>最後，不要為了使用設計模式生搬硬套，而是優化代碼過程中，發現這個設計模式剛好適用，才去用的哈。附上最後的代碼咯：</p><pre><code>@Servicepublic class CompanyHandler implements RequestHandler  {   @Autowire   private CompanyServiceFactory companyServiceFactory;      Resp hander(req){    return companyServiceFactory.handler(req);  }}</code></pre><p>如果覺得本文對你有幫助，可以轉發關注支持一下</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>代碼</a></li><li><a>優化</a></li><li><a>實踐</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/8654883c.html alt=項目實踐中的一些性能優化指南 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8c9ad977831f4b6bbaaf2e1b4651b667 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8654883c.html title=項目實踐中的一些性能優化指南>項目實踐中的一些性能優化指南</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b6acbddb.html alt=「壓鑄實踐」大截面ZA27鋅合金蝸輪的雙重擠壓鑄造應用案例 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/972374c8b24644389e188cb290249f17 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b6acbddb.html title=「壓鑄實踐」大截面ZA27鋅合金蝸輪的雙重擠壓鑄造應用案例>「壓鑄實踐」大截面ZA27鋅合金蝸輪的雙重擠壓鑄造應用案例</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3d54fe0b.html alt="深度研究自然梯度優化，從入門到放棄 | Deep Reading" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/2cc1b8ef47a5458190c22d26d8bd164c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3d54fe0b.html title="深度研究自然梯度優化，從入門到放棄 | Deep Reading">深度研究自然梯度優化，從入門到放棄 | Deep Reading</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b096e432.html alt=餐飲業的共益實踐案例：是什麼留住了海底撈的員工？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3253c0fd3b54497282e5ebfb67cc350c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b096e432.html title=餐飲業的共益實踐案例：是什麼留住了海底撈的員工？>餐飲業的共益實踐案例：是什麼留住了海底撈的員工？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c9ad6a3e.html alt=（1-2我們的第一段PHP代碼）php基礎php學習基礎實例代碼操作教程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/b707f4e4acce41bda439262a966603f8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c9ad6a3e.html title=（1-2我們的第一段PHP代碼）php基礎php學習基礎實例代碼操作教程>（1-2我們的第一段PHP代碼）php基礎php學習基礎實例代碼操作教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8ece3d8b.html alt=溼法鋅冶煉氟、氯現在走向及生產實踐 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/c6ec0692-63fe-42f8-8df3-b0a6226ca1a5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8ece3d8b.html title=溼法鋅冶煉氟、氯現在走向及生產實踐>溼法鋅冶煉氟、氯現在走向及生產實踐</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8e1b3755.html alt=裝完系統必做的優化，更改用戶文件和軟件安裝默認路徑，你知道嗎 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8d349042865d40cf9b8f1e91e2537426 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8e1b3755.html title=裝完系統必做的優化，更改用戶文件和軟件安裝默認路徑，你知道嗎>裝完系統必做的優化，更改用戶文件和軟件安裝默認路徑，你知道嗎</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/130bed32.html alt=「理論實踐」地方人大常委會研究室工作的實踐與思考 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/R9AiF6fHzZIbrG style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/130bed32.html title=「理論實踐」地方人大常委會研究室工作的實踐與思考>「理論實踐」地方人大常委會研究室工作的實踐與思考</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d0518503.html alt=優化營商環境“大家談”︱擔當職責使命，貢獻公安力量 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RHnAsqqAQHVKXV style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d0518503.html title=優化營商環境“大家談”︱擔當職責使命，貢獻公安力量>優化營商環境“大家談”︱擔當職責使命，貢獻公安力量</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3998ae89.html alt=服務治理最佳實踐：如何依據參數值進行服務路由、鑑權、限流？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/3f6fb254f0cc4ba390695e1d561d4a5c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3998ae89.html title=服務治理最佳實踐：如何依據參數值進行服務路由、鑑權、限流？>服務治理最佳實踐：如何依據參數值進行服務路由、鑑權、限流？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/389d4437.html alt="Python常用算法學習(5) 樹二叉樹（原理+代碼）-最全總結" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d3d5fd4ef98c4a8e8dc9095eeef052a6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/389d4437.html title="Python常用算法學習(5) 樹二叉樹（原理+代碼）-最全總結">Python常用算法學習(5) 樹二叉樹（原理+代碼）-最全總結</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f4e78a26.html alt=二叉樹的算法代碼，一篇文章全搞定！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f4e78a26.html title=二叉樹的算法代碼，一篇文章全搞定！>二叉樹的算法代碼，一篇文章全搞定！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cd4899a4.html alt="引進打樁“神器”  優化施工工藝海濱路東西延伸工程順利推進" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/48a3decd487848809296b7f0b9a0b15c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cd4899a4.html title="引進打樁“神器”  優化施工工藝海濱路東西延伸工程順利推進">引進打樁“神器”  優化施工工藝海濱路東西延伸工程順利推進</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/873415c9.html alt=錯誤代碼大全2，時刻掌握計算機的故障原因！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/152937668211718b8850640 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/873415c9.html title=錯誤代碼大全2，時刻掌握計算機的故障原因！>錯誤代碼大全2，時刻掌握計算機的故障原因！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/45c8b4b0.html alt=關於“神祕代碼”的含義 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c040bb33daee4d30bc48cb70d5bf8ee1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/45c8b4b0.html title=關於“神祕代碼”的含義>關於“神祕代碼”的含義</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>