<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>聊聊時序數據存儲系統的容量管理 | 极客快訊</title><meta property="og:title" content="聊聊時序數據存儲系統的容量管理 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/eabef88687b944ba88d26e49f7d9b140"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3428e473.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3428e473.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3428e473.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3428e473.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3428e473.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3428e473.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3428e473.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3428e473.html><meta property="article:published_time" content="2020-10-29T21:10:40+08:00"><meta property="article:modified_time" content="2020-10-29T21:10:40+08:00"><meta name=Keywords content><meta name=description content="聊聊時序數據存儲系統的容量管理"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/3428e473.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>聊聊時序數據存儲系統的容量管理</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p class=ql-align-justify><br></p><div class=pgc-img><img alt=聊聊時序數據存儲系統的容量管理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/eabef88687b944ba88d26e49f7d9b140><p class=pgc-img-caption></p></div><p class=ql-align-justify><br></p><p class=ql-align-justify><strong>乾貨概覽</strong></p><p class=ql-align-justify>容量管理是系統可用性運維的重要環節之一。通常來說，容量管理包含容量度量、容量規劃和過載保護三個過程。容量度量首先要確定系統容量的衡量標準，通過一定方法得到各模塊的流量承載能力（包括額定負載、極限負載和冗餘度），從而得到系統整體容量。容量規劃是基於SLA可用性要求，確定資源在時間上的需求規劃。過載保護是根據容量衡量和規劃結果進行的外圍系統設計，以保障業務在滿足SLA的前提下，穩定處理高於額定負載的請求。</p><p class=ql-align-justify>百度Noah平臺的時序數據存儲系統（TSDB），承載了百度諸多核心業務的監控數據存儲與查詢需求，日均寫入點數以萬億記，查詢請求高達數十億次。在如此大的請求場景下，建設一套完善的容量管理機制，有效的度量TSDB系統的容量能力，合理規劃系統容量發展，及時發現系統的容量風險，有效應對容量過載場景，是非常困難又非常重要的。本文主要介紹TSDB系統容量度量、容量規劃方面的內容。在接下來的後續文章中會詳細介紹過載保護方面的一些實踐。</p><p class=ql-align-justify><strong>容量度量—容量管理的基礎</strong></p><p class=ql-align-justify><strong>設定容量指標</strong></p><p class=ql-align-justify>容量是系統對業務承載能力的量化，一般我們使用可量化的性能指標來衡量系統的容量。通常來說有下面三種：</p><ol><li class=ql-align-justify>吞吐量（Throughput）：指系統單位時間內處理的請求總數。請求可以是讀寫請求，也可以是數據處理請求，對應著QPS（Query Per Second）和RPS（Request Per Second）兩類；</li><li class=ql-align-justify>併發數（Concurrency）：同一時間內能夠處理的請求數目；</li><li class=ql-align-justify>系統延遲（Latency）：指系統完成一個請求所花費的時間。</li></ol><p class=ql-align-justify>在多併發系統中，可以把這三者的關係簡化為：吞吐量＝併發數／系統延遲。對於單併發系統，吞吐量就是系統延遲的倒數。</p><p class=ql-align-justify>至於具體使用哪一個性能指標來衡量系統容量能力，需要根據不同的業務場景來判斷。在多數場景下，我們考量的都是吞吐量（QPS或RPS），當然對於實際的業務場景，QPS、RPS的定義會略有區別。在Noah監控場景下，主要是監控數據（時序數據）的寫入和查詢，每個請求會對應多個itemCollection，而一個itemCollection中帶有多個監控數據點。因此，我們使用PPS（Point Per Second）作為TSDB系統的QPS指標來衡量系統的容量能力。</p><p class=ql-align-justify><strong>獲取容量數據</strong></p><p class=ql-align-justify>獲取容量數據的方法有容量估算和壓測兩種。容量估算指通過各子模塊的運行指標，使用資源建模計算的方式匯聚計算出全系統的容量數據。例如下圖，模塊A為整個系統的入口模塊，入流量為x，他有兩個下游B和C，分別承載y和z的流量。首先，通過資源消耗（瓶頸資源）與流量的折算關係估算出每個模塊的容量分為X，Y，Z，例如在資源消耗50％的時候，流量是1KQPS，可以預測系統達到極限負載的情況下容量為2KQPS（只考慮系統為線性系統）。接著通過假設流量在各個模塊的等比例放大/縮減，計算出整個系統的容量為min（X，xY/y，xZ/z），即整個系統的容量由子模塊的最小容量決定。這種計算方式存在兩個誤差來源，一是資源消耗與流量增長並非完全線性，二是各模塊間未必完全解耦導致模塊之間的流量增長並非等比例。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=聊聊時序數據存儲系統的容量管理 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d895b6b4f0cf42eabc0bd9f975a08afa><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify>實際應用上更廣泛的做法是通過壓測來獲取相對準確的容量數據。壓測方法一般分為線上壓測和線下壓測。線上壓測是直接對線上服務進行真實流量的壓力測試以獲得整個系統的容量，精度較高，但成本較大，且可能會對線上服務的穩定性造成影響。線下壓測首先需要部署與線上環境完全一致或等比例縮放的系統，再通過壓測得到線下系統的容量，最後通過等比例折算的方式獲得線上實際生產環境的全系統容量。搭建一套與線上完全一致的線下系統用於壓測，投入的成本過大。如果僅僅是線上集群的等比例小規模集群，壓測的數據準確性又無法保證。</p><p class=ql-align-justify>我們在對監控的計算-存儲(Astream-TSDB)系統實施壓測時採取了折中的方案，雖然是線上壓測，但壓測的對象是線上規模相近的熱備集群。監控系統計算存儲集群的示意圖如下所示。Agent將同樣的兩份數據發往跨地域的兩個計算集群，由計算集群計算後分別發往同地域的TSDB集群，查詢端通過流量切換可選擇在兩個集群進行數據查詢。兩個集群在物理上隔離，所以對備集群的壓測帶來線上系統可用性風險的概率大大降低。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=聊聊時序數據存儲系統的容量管理 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ce3caaf21f554945a39a5557b4f3662c><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify>具體的壓測方案，我們還需要考慮以下三個方面：發壓端，壓測預案，數據汙染。</p><ol><li class=ql-align-justify>發壓端主要考慮的是如何構造流量壓力的問題。一方面，我們希望發壓端有足夠大的併發，能模擬系統在超高壓力下的性能表現；另一方面，我們希望壓測的壓力能真實模擬線上實際的流量。為了完美解決這兩個問題，我們的壓測平臺LTP使用流量回放來構造發壓數據。其基本原理是對服務的流量進行拷貝，並以實時或離線的方式將流量的副本分發到發壓機上。同時流量回放也支持比例加壓，或者流量成分的過濾和修改操作。</li><li class=ql-align-justify>在壓測方案的設計中，應儘量保證壓測子系統與線上系統的隔離，以減少對線上的影響。壓測預案考慮的是當壓測造成系統故障時，我們需要具備有效的止損預案，比如中斷髮壓預案、流量切換預案和集群恢復預案等等。</li><li class=ql-align-justify>對於存儲系統來說，不得不面對的一個問題是寫入的髒數據問題。這部分壓測的髒數據是不希望被用戶獲取的。解決的辦法還是儘量從業務上隔離壓測系統，具體採用的方法可以是給發壓的數據單獨打上壓測的標籤，壓測結束後單獨刪除；也可以在查詢端做壓測數據的區分。</li></ol><p class=ql-align-justify><strong>容量建模—建立容量水位機制</strong></p><p class=ql-align-justify>上述我們所說的系統容量值其實指的是系統所能承受住的極限負載，是不帶任何冗餘的。這個值無法保證系統的高可用性，因為線上稍有退化，甚至是計算的誤差，都會導致基於這個值做的一切預警無效。為了避免各種因素的影響，我們可以給容量加上冗餘，這部分冗餘容量用來抵禦系統的流量突增、性能退化、容量計算誤差等等場景。所以我們可以認為極限容量*（1-Buffer）才是系統的容量，也叫額定容量。我們建立的容量報表，也是基於該值。建立系統及子模塊的容量水位報表，可以定期巡檢線上服務容量狀態，及時發現容量瓶頸。並且，我們還對核心服務的容量水位設置閾值報警，一旦系統容量到達容量水位預警值將自動執行服務彈性擴容，保障系統穩定運行。</p><p class=ql-align-justify><strong>容量規劃</strong></p><p class=ql-align-justify>隨著業務量的快速增長，我們不得不考慮的問題是未來整個集群的容量需求為多少，當前集群距離目標容量還需擴容多少。有了容量數據後，我們就可以通過下面的計算回答這個問題。</p><p>假設線上服務流量歷史上月增幅X，冗餘度要求為R，當前極限容量為C，線上有M個實例，則N個月後容量需求為</p><div class=pgc-img><img alt=聊聊時序數據存儲系統的容量管理 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/8aa86415aaa44cf68fcf9bfaed52abfd><p class=pgc-img-caption></p></div><p>，需求的實例數目為</p><div class=pgc-img><img alt=聊聊時序數據存儲系統的容量管理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1ee5b3ee758c4c9bad778c7326d81c37><p class=pgc-img-caption></p></div><p>。其中，實際的流量增長並非線性，更科學的計算可以通過非線性的流量曲線去擬合。</p><p class=ql-align-justify><strong>總結</strong></p><p class=ql-align-justify>容量管理是系統運維不可或缺的部分，而建立容量數據是容量管理中最為基礎、重要的一環。基於準確的容量數據有利於更有效的做容量規劃和優化分析。以上是Noah在容量管理方面落地的一些粗淺經驗，如有不當之處，歡迎指正。</p><p>姜澤，百度高級運維工程師</p><p>來源：本文轉自公眾號”AIOps 智能運維“。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>時序</a></li><li><a>數據存</a></li><li><a>儲系統</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/467cab41.html alt=攜程如何基於ARIMA時序分析做業務量的預測 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/0c45d5443d654c53a11fc201076e9a0b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/467cab41.html title=攜程如何基於ARIMA時序分析做業務量的預測>攜程如何基於ARIMA時序分析做業務量的預測</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/05ff72c4.html alt=數據存儲磁帶應該如何利用，更能發揮它們的價值 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/daaf336a9a1647a684f5e5dfed5ac678 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/05ff72c4.html title=數據存儲磁帶應該如何利用，更能發揮它們的價值>數據存儲磁帶應該如何利用，更能發揮它們的價值</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1e410983.html alt=(Python)時序預測的七種方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/66b00004e736363da6cd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1e410983.html title=(Python)時序預測的七種方法>(Python)時序預測的七種方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5b2d587e.html alt=5分鐘瞭解阿里時序時空數據庫 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5b2d587e.html title=5分鐘瞭解阿里時序時空數據庫>5分鐘瞭解阿里時序時空數據庫</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9b81513f.html alt="AAAI 2020 | 時序轉化為圖用於可解釋可推理異常檢測" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/84687f1f92e44688be84805b1ca42cb4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9b81513f.html title="AAAI 2020 | 時序轉化為圖用於可解釋可推理異常檢測">AAAI 2020 | 時序轉化為圖用於可解釋可推理異常檢測</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/51371207.html alt=DBengine排名第一時序數據庫——阿里雲數據庫InfluxDB正式商業化 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8fed1db0f05a46d0845d4ae8fceded1c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/51371207.html title=DBengine排名第一時序數據庫——阿里雲數據庫InfluxDB正式商業化>DBengine排名第一時序數據庫——阿里雲數據庫InfluxDB正式商業化</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/51718fda.html alt=FPGA基礎之時序設計 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b67909f181e2497f883a202aadca9129 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/51718fda.html title=FPGA基礎之時序設計>FPGA基礎之時序設計</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a793e5aa.html alt=什麼是時序數據庫？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a793e5aa.html title=什麼是時序數據庫？>什麼是時序數據庫？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b1e1ee49.html alt=十分鐘讓你看懂時序數據庫 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/45d1d3313c644396bf29f249b2fce90b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b1e1ee49.html title=十分鐘讓你看懂時序數據庫>十分鐘讓你看懂時序數據庫</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/52db9979.html alt="基於 Python 的時序模型——AMIRA模型" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1531801339038572a99eb47 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/52db9979.html title="基於 Python 的時序模型——AMIRA模型">基於 Python 的時序模型——AMIRA模型</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ef737d82.html alt=基於時序數據庫做監控，這裡有超流行的開源方案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/RcHNVefHoUVLac style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ef737d82.html title=基於時序數據庫做監控，這裡有超流行的開源方案>基於時序數據庫做監控，這裡有超流行的開源方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6f84f228.html alt=工業互聯網中時序數據處理面臨的新挑戰 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/R69W6Xi3fVD45d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6f84f228.html title=工業互聯網中時序數據處理面臨的新挑戰>工業互聯網中時序數據處理面臨的新挑戰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c9a0268c.html alt=時序數據庫的技術和架構演進 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/122f6b0b368f4313b7efe62c811270ff style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c9a0268c.html title=時序數據庫的技術和架構演進>時序數據庫的技術和架構演進</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/55686102.html alt="時序數據庫連載系列: 時序數據庫一哥InfluxDB之存儲機制解析" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/bee309a50ea64a2ea56fbd698279eff2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/55686102.html title="時序數據庫連載系列: 時序數據庫一哥InfluxDB之存儲機制解析">時序數據庫連載系列: 時序數據庫一哥InfluxDB之存儲機制解析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2aa8e0f7.html alt=時序數據庫連載系列：時序數據庫那些事 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/125534ddebc242d5ad4694adcd1602aa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2aa8e0f7.html title=時序數據庫連載系列：時序數據庫那些事>時序數據庫連載系列：時序數據庫那些事</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>