<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>JAVA線程安全及性能的優化筆記(三)——Volatile關鍵字 | 极客快訊</title><meta property="og:title" content="JAVA線程安全及性能的優化筆記(三)——Volatile關鍵字 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/62d649c2284b437aa978f17b98b38630"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3f0ff269.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3f0ff269.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3f0ff269.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3f0ff269.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3f0ff269.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3f0ff269.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/3f0ff269.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/3f0ff269.html><meta property="article:published_time" content="2020-11-14T20:59:56+08:00"><meta property="article:modified_time" content="2020-11-14T20:59:56+08:00"><meta name=Keywords content><meta name=description content="JAVA線程安全及性能的優化筆記(三)——Volatile關鍵字"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/3f0ff269.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>JAVA線程安全及性能的優化筆記(三)——Volatile關鍵字</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>前期回顧：</h1><p><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6812853871497445899/?group_id=6812853871497445899" rel="noopener noreferrer" target=_blank>JAVA線程安全及性能的優化筆記(二)——Synchronized關鍵字</a></p><hr><h1 class=pgc-h-arrow-right>本期正文：</h1><p>volatile是java提供的一種同步手段，只不過它是輕量級的同步，為什麼這麼說？因為volatile只能保證多線程的內存可見性，不能保證多線程的執行有序性。而最徹底的同步要保證有序性和可見性，例如synchronized。任何被volatile修飾的變量，都不拷貝副本到工作內存，任何修改都能及時寫在主存。因此對於valatile修飾的變量的修改，所有線程馬上就能看到，但是volatile不能保證對變量的修改時有序的。什麼意思呢？</p><pre><code>publicclassVolatileTest{	publicvolatileinta;	publicvoidadd(intcount){		a=a+count;	}}</code></pre><p>當一個VolatileTest對象被多個線程共享，a的值不一定是正確的，因為a=a+count包含了好幾部操作，而此時多個線程的執行是無序的，因為沒有任何機制來保證多個線程的執行有序性和原子性。volatile存在的意義是，任何線程對a的修改，都會馬上被其他線程讀取到，因為直接操作主存，沒有線程對工作內存和主存的同步。所以，volatile的使用場景是有限的，在有限的一些情況下可以使用volatile變量代替鎖。要使用volatile變量提供理想的線程安全，必須同時滿足下面兩個條件：</p><ol start=1><li>對變量的寫操作不依賴於當前值</li><li>該變量沒有包含在具有其他變量的不變式中</li></ol><p>volatile只保證了可見性，所以volatile適合直接賦值的場景。</p><pre><code>publicclassVolatileTest{	publicvolatileinta;	publicvoidseta(inta){		this.a=a;	}}</code></pre><p>在沒有volatile聲明時，多線程環境下，a的最終值不一定是正確的，因為this.a=a;涉及到給a賦值和將a同步回主存的步驟，這個順序可能被打亂。如果用volatile聲明瞭，讀取主存副本到工作內存和同步a到主存的步驟，相當於是一個原子操作。所以簡單來說，volatile適合這種場景：一個變量被多個線程共享，線程直接給這個變量賦值。這是一種很簡單的同步場景，這時候使用volatile的開銷將會非常小。</p><p>站內很多人都問我，所謂線程的“工作內存”到底是個什麼東西？有的人認為是線程的棧，其實這種理解是不正確的。看看JLS(java語言規範)對線程工作內存的描述，線程的workingmemory只是cpu的寄存器和告訴緩存的抽象描述。</p><p>可能很多人都覺得莫名其妙，說JVM的內存模型，怎麼會扯到cpu上去呢？此時，我認為很有必要闡述下，免得很多人看的不明不白的。先拋開java虛擬機不談，我們都知道，現在的計算機，cpu在計算的時候，並不總是從內存讀取數據，它的數據讀取順序優先級是：寄存器—高速緩存—內存。線程消耗的是cpu，線程計算的時候，原始的數據來自內存，在計算過程中，有些數據可能被頻繁讀取，這些數據被存儲在寄存器和高速緩存中，當線程計算完後，這些緩存的數據在適當的時候應該寫會內存。當多個線程同時讀寫某個內存數據時，就會產生多線程併發問題，涉及到三個特徵：原子性，有序性，可見性。在《線程安全總結》這篇文章中，為了理解方便，我把原子性和有序性統一叫做“多線程執行有序性”。支持多線程的平臺都會面臨這種問題，運行在多線程平臺上支持多線程的語言應該提供解決該問題的方案。</p><p>那麼我們看看JVM，JVM是一個虛擬的計算機，它也會面臨多線程併發問題，java程序運行在虛擬機平臺上，java程序員不可能直接去控制底層線程對寄存器高速緩存內存之間的同步，那麼java從語法層面，應該給開發人員提供一種解決方案，這個方案就是諸如synchronized，volatile，鎖機制(如同步塊，就緒隊列，阻塞隊列)等等。這些方案只是語法層面的，但我們要從本質上去理解它，不能僅僅知道一個synchronized可以保證同步就完了。在這裡我說的是jvm的內存模型，是動態的，面向多線程併發的，沿襲JSL的”workingmemory”的說法，只是不想閒扯到太多底層細節，因為《線程安全總結》這篇文章在說明怎樣從語法層而去理解java線程同步，知道各個關鍵字的使用場景。</p><p>今天有人問我，那java的線程不是有棧嗎？難道棧不是工作內存嗎？工作內存這四個字得放到具體的場景中區描述，方能體現它具體的意義，在描述JVM的線程同步時，工作內存指的是寄存器和高速緩存的抽象描述，具體請自行參閱JLS。上面講的都是動態的內存模型，甚至已經超出了JVM的範圍，那麼JVM的內存靜態存儲是怎樣劃分的？今天還有人問我，jvm的內存模型不是有eden區嗎？也不見得你提起。我跟他說，這是兩個角度去看的，甚至是不同的範圍，動態的線程同步的內存模型，涵蓋了cpu，寄存器，高速緩存，內存；jvm的靜態內存存儲模型只是一種對內存的物理劃分而已，它只侷限在內存，而且只侷限在jvm的內存。那麼線程棧，eden區都僅僅在jvm內存。</p><p>說說jvm的線程棧和有個朋友反覆跟我糾結的eden區吧。jvm的內存，被劃分了很多的區域</p><p><strong>1. 程序計數器</strong></p><p>每一個java線程都有一個線程計數器來用於保存程序執行到當前方法的哪一個指令。</p><p><strong>2. 線程棧</strong></p><p>線程的每個方法被執行的時候，都會同時創建一個幀(Frame)</p><p>用於存儲本地變臉表、操作棧、動態鏈接、方法出入口等信息。每個方法的調用至完成，就意味著一個幀在VM棧中的入棧至出棧的過程。如果線程請求的棧深度大於虛擬機所允許的深度，講拋出StackOverflowError異常；如果VM棧可以動態擴展（VMSpec中允許固定長度的VM棧），當擴展時無法申請到足夠內存則拋出OutOfMemoryError異常。</p><p><strong>3. 本地方法棧</strong></p><p><strong>4. 堆</strong></p><p>每個線程的棧都是該線程私有的，堆則是所有線程共享的。當我們new一個對象時，該對象就被分配到了堆中。但是堆，並不是一個簡單的概念，堆區又劃分了很多區域，問為什麼堆劃分了這麼多區域，這是為了JVM的內存垃圾收集，似乎越扯越遠了，扯到垃圾收集了，現在的jvm的gc都是按代收集，堆區大致被分為三大塊：新生代、舊生代、持久代(虛擬的)；新生代又分為eden區，s0區，s1區。新建一個對象時，基本小的對象，生命週期短的對象都會放在新生代的eden區中，eden區滿時，有一個小範圍的gc(minorgc)，整個新生代滿時，會有一個大範圍的gc(majorgc)，講新生代裡的部分對象轉到舊生代裡。</p><p><strong>5. 方法區</strong></p><p>其實就是永久代(PermanentGeneration)，方法區中存放了每個Class的結構信息，包括常量池、字段描述、方法描述等等。VMSpace描述中對這個區域的限制非常寬鬆，除了和Java堆一樣不需要連續的內存，也可以選擇固定大小或者可擴展外，甚至可以選擇不現實垃圾收集。相對來說，垃圾收集行為在這個區域是相對比較少發生的，但並不是某些描述那樣永久代不會發生GC(至少對當前主流的商業JVM實現來說是如此)，這裡的GC主要是對常量池的回收和對類的卸載，雖然回收的”成績”一般也比較差強人意，尤其是類卸載，條件相當苛刻</p><p><strong>6. 常量池</strong></p><p>Class文件中除了有類的版本、字段、方法、接口等描述信息外，還有一項信息是常量表(constant_pooltable)，用於存放編譯期已可知的常量，這部分內容將在類加載後進入方法區(永久代)存放。但是Java語言並不要求常量一定只有編譯期預置入Class的常量表的內容才能進入方法區常量池，運行期間也可將新內容放入常量池(最典型的String.intern()方法)</p><h1 class=pgc-h-arrow-right>未完待續</h1><p><strong>推薦閱讀：</strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6811403312651305483/?group_id=6811403312651305483" rel="noopener noreferrer" target=_blank>阿里8年Java架構師感悟——寫給還在迷茫中的朋友</a></p><li><strong>針對於Java程序員，筆者最近整理了一些面試真題，思維導圖，程序人生等PDF學習資料；</strong></li><li><strong>關注私信我"86"，即可獲取！</strong></li><li><strong>希望讀到這的您能點個小贊和關注下我，以後還會更新技術乾貨，謝謝您的支持！</strong></li><div class=pgc-img><img alt=JAVA線程安全及性能的優化筆記(三)——Volatile關鍵字 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/62d649c2284b437aa978f17b98b38630><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>JAVA</a></li><li><a>線程</a></li><li><a>優化</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/3d54fe0b.html alt="深度研究自然梯度優化，從入門到放棄 | Deep Reading" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/2cc1b8ef47a5458190c22d26d8bd164c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3d54fe0b.html title="深度研究自然梯度優化，從入門到放棄 | Deep Reading">深度研究自然梯度優化，從入門到放棄 | Deep Reading</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a90a489a.html alt=JAVA中多態的概念和應用，通過案例分析成員變量、方法的訪問特點 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15310942260931dda577a75 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a90a489a.html title=JAVA中多態的概念和應用，通過案例分析成員變量、方法的訪問特點>JAVA中多態的概念和應用，通過案例分析成員變量、方法的訪問特點</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9cfcdd6f.html alt=《JAVA編程思想》5分鐘速成：第8章（多態） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/399a29d93fde48fca4bae44dffbced07 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9cfcdd6f.html title=《JAVA編程思想》5分鐘速成：第8章（多態）>《JAVA編程思想》5分鐘速成：第8章（多態）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6f585f1e.html alt=JAVA入門到大神（玩轉正則表達式） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6f585f1e.html title=JAVA入門到大神（玩轉正則表達式）>JAVA入門到大神（玩轉正則表達式）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8a3d9e7a.html alt=「JAVA」從格式化輸出到掃描輸入，深究Java正則表達式匹配之道 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/ea11259e-5098-451f-b989-4e3169a16a1c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8a3d9e7a.html title=「JAVA」從格式化輸出到掃描輸入，深究Java正則表達式匹配之道>「JAVA」從格式化輸出到掃描輸入，深究Java正則表達式匹配之道</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e2ad303f.html alt=給JAVA開發人員的正則表達式入門課 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/5d620d422d0a4855924c5bcbf8ba483a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e2ad303f.html title=給JAVA開發人員的正則表達式入門課>給JAVA開發人員的正則表達式入門課</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8e1b3755.html alt=裝完系統必做的優化，更改用戶文件和軟件安裝默認路徑，你知道嗎 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8d349042865d40cf9b8f1e91e2537426 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8e1b3755.html title=裝完系統必做的優化，更改用戶文件和軟件安裝默認路徑，你知道嗎>裝完系統必做的優化，更改用戶文件和軟件安裝默認路徑，你知道嗎</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fd0a9e51.html alt=JAVA怎麼處理異常 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/dfic-imagehandler/6cf507ab-d41c-4bb0-bef0-6def0eb1fef8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fd0a9e51.html title=JAVA怎麼處理異常>JAVA怎麼處理異常</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d0518503.html alt=優化營商環境“大家談”︱擔當職責使命，貢獻公安力量 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RHnAsqqAQHVKXV style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d0518503.html title=優化營商環境“大家談”︱擔當職責使命，貢獻公安力量>優化營商環境“大家談”︱擔當職責使命，貢獻公安力量</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/77f5407e.html alt="PHP 線程，進程和併發" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7a700a857098411d884a928d6b5f5e01 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/77f5407e.html title="PHP 線程，進程和併發">PHP 線程，進程和併發</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4c41a9dd.html alt=一文讀懂什麼是進程、線程、協程（建議收藏） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/6ba8b142-925e-418e-b20c-71e8f3c20663 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4c41a9dd.html title=一文讀懂什麼是進程、線程、協程（建議收藏）>一文讀懂什麼是進程、線程、協程（建議收藏）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ab6b08d6.html alt=併發最基本要理解的進程、線程、協程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3f756a3627164d4f93883dd7c0e0bac5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ab6b08d6.html title=併發最基本要理解的進程、線程、協程>併發最基本要理解的進程、線程、協程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/79e23cb7.html alt=如何理解：程序、進程、線程、併發、並行、高併發？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b101e22357854a56abf29c0745b5d9c9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/79e23cb7.html title=如何理解：程序、進程、線程、併發、並行、高併發？>如何理解：程序、進程、線程、併發、並行、高併發？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cf2fb099.html alt=看一遍就懂進程線程、同步異步、阻塞非阻塞、併發並（建議收藏） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/12861a08-8f52-48c2-9b25-46df51894677 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cf2fb099.html title=看一遍就懂進程線程、同步異步、阻塞非阻塞、併發並（建議收藏）>看一遍就懂進程線程、同步異步、阻塞非阻塞、併發並（建議收藏）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c40a49b9.html alt=線程與進程的區別以及對多線程併發的理解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/813488ac38be43b29140e4917ff1e0b5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c40a49b9.html title=線程與進程的區別以及對多線程併發的理解>線程與進程的區別以及對多線程併發的理解</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>