<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一文讀懂什麼是進程、線程、協程（建議收藏） | 极客快訊</title><meta property="og:title" content="一文讀懂什麼是進程、線程、協程（建議收藏） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/dfic-imagehandler/6ba8b142-925e-418e-b20c-71e8f3c20663"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4c41a9dd.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4c41a9dd.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4c41a9dd.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4c41a9dd.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4c41a9dd.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4c41a9dd.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/4c41a9dd.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/4c41a9dd.html><meta property="article:published_time" content="2020-11-14T21:06:37+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:37+08:00"><meta name=Keywords content><meta name=description content="一文讀懂什麼是進程、線程、協程（建議收藏）"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/4c41a9dd.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一文讀懂什麼是進程、線程、協程（建議收藏）</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/6ba8b142-925e-418e-b20c-71e8f3c20663><p class=pgc-img-caption></p></div><h1><strong>進程</strong></h1><p>我們都知道計算機的核心是CPU，它承擔了所有的計算任務；而操作系統是計算機的管理者，它負責任務的調度、資源的分配和管理，統領整個計算機硬件；應用程序則是具有某種功能的程序，程序是運行於操作系統之上的。</p><p>進程是一個具有一定獨立功能的程序在一個數據集上的一次動態執行的過程，是操作系統進行資源分配和調度的一個獨立單位，是應用程序運行的載體。進程是一種抽象的概念，從來沒有統一的標準定義。</p><p>進程一般由程序、數據集合和進程控制塊三部分組成。</p><ul><li>程序用於描述進程要完成的功能，是控制進程執行的指令集；</li><li>數據集合是程序在執行時所需要的數據和工作區；</li><li>程序控制塊(Program Control Block，簡稱PCB)，包含進程的描述信息和控制信息，是進程存在的唯一標誌。</li></ul><p>進程具有的特徵：</p><ul><li>動態性：進程是程序的一次執行過程，是臨時的，有生命期的，是動態產生，動態消亡的；</li><li>併發性：任何進程都可以同其他進程一起併發執行；</li><li>獨立性：進程是系統進行資源分配和調度的一個獨立單位；</li><li>結構性：進程由程序、數據和進程控制塊三部分組成。</li></ul><h1><strong>線程</strong></h1><p>在早期的操作系統中並沒有線程的概念，進程是能擁有資源和獨立運行的最小單位，也是程序執行的最小單位。任務調度採用的是時間片輪轉的搶佔式調度方式，而進程是任務調度的最小單位，每個進程有各自獨立的一塊內存，使得各個進程之間內存地址相互隔離。</p><p>後來，隨著計算機的發展，對CPU的要求越來越高，進程之間的切換開銷較大，已經無法滿足越來越複雜的程序的要求了。於是就發明了線程。</p><p>線程是程序執行中一個單一的順序控制流程，是程序執行流的最小單元，是處理器調度和分派的基本單位。一個進程可以有一個或多個線程，各個線程之間共享程序的內存空間(也就是所在進程的內存空間)。一個標準的線程由線程ID、當前指令指針(PC)、寄存器和堆棧組成。而進程由內存空間(代碼、數據、進程空間、打開的文件)和一個或多個線程組成。</p><p>（讀到這裡可能有的讀者迷糊，感覺這和Java的內存空間模型不太一樣，但如果你深入的讀過《深入理解Java虛擬機》這本書的話你就會恍然大悟）</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7e299833879042ae961418a5bc87e24d><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>如上圖，在任務管理器的進程一欄裡，有道詞典和有道雲筆記就是進程，而在進程下又有著多個執行不同任務的線程。</p><h1><strong>任務調度</strong></h1><p>線程是什麼？要理解這個概念，需要先了解一下操作系統的一些相關概念。大部分操作系統(如Windows、Linux)的任務調度是採用時間片輪轉的搶佔式調度方式。</p><p>在一個進程中，當一個線程任務執行幾毫秒後，會由操作系統的內核（負責管理各個任務）進行調度，通過硬件的計數器中斷處理器，讓該線程強制暫停並將該線程的寄存器放入內存中，通過查看線程列表決定接下來執行哪一個線程，並從內存中恢復該線程的寄存器，最後恢復該線程的執行，從而去執行下一個任務。</p><p>上述過程中，任務執行的那一小段時間叫做時間片，任務正在執行時的狀態叫運行狀態，被暫停的線程任務狀態叫做就緒狀態，意為等待下一個屬於它的時間片的到來。</p><p>這種方式保證了每個線程輪流執行，由於CPU的執行效率非常高，時間片非常短，在各個任務之間快速地切換，給人的感覺就是多個任務在“同時進行”，這也就是我們所說的併發(別覺得併發有多高深，它的實現很複雜，但它的概念很簡單，就是一句話：多個任務同時執行)。多任務運行過程的示意圖如下：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a43778253ba5448cb5f313c28abe1a88><p class=pgc-img-caption>操作系統中的任務調度</p></div><h1><strong>進程與線程的區別</strong></h1><p>前面講了進程與線程，但可能你還覺得迷糊，感覺他們很類似。的確，進程與線程有著千絲萬縷的關係，下面就讓我們一起來理一理：</p><ol><li>線程是程序執行的最小單位，而進程是操作系統分配資源的最小單位；</li><li>一個進程由一個或多個線程組成，線程是一個進程中代碼的不同執行路線；</li><li>進程之間相互獨立，但同一進程下的各個線程之間共享程序的內存空間(包括代碼段、數據集、堆等)及一些進程級的資源(如打開文件和信號)，某進程內的線程在其它進程不可見；</li><li>調度和切換：線程上下文切換比進程上下文切換要快得多。</li></ol><p>線程與進程關係的示意圖：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0f156b7525bc430e862d7d23fa5250cb><p class=pgc-img-caption>進程與線程的資源共享關係</p></div><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ef659d04b5724bab8e7bf62a58199c85><p class=pgc-img-caption>單線程與多線程的關係</p></div><p class=ql-align-center><br></p><p>總之，線程和進程都是一種抽象的概念，線程是一種比進程更小的抽象，線程和進程都可用於實現併發。</p><p>在早期的操作系統中並沒有線程的概念，進程是能擁有資源和獨立運行的最小單位，也是程序執行的最小單位。它相當於一個進程裡只有一個線程，進程本身就是線程。所以線程有時被稱為輕量級進程(Lightweight Process，LWP）。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2a735052306547e8acf50a33dd9cabec><p class=pgc-img-caption>早期的操作系統只有進程，沒有線程</p></div><p>後來，隨著計算機的發展，對多個任務之間上下文切換的效率要求越來越高，就抽象出一個更小的概念——線程，一般一個進程會有多個(也可是一個)線程。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/94a49ce004654ce18d950bf304546004><p class=pgc-img-caption>線程的出現，使得一個進程可以有多個線程</p></div><p class=ql-align-center><br></p><h1><strong>多線程與多核</strong></h1><p>上面提到的時間片輪轉的調度方式說一個任務執行一小段時間後強制暫停去執行下一個任務，每個任務輪流執行。很多操作系統的書都說“同一時間點只有一個任務在執行”。那有人可能就要問雙核處理器呢？難道兩個核不是同時運行嗎？</p><p>其實“同一時間點只有一個任務在執行”這句話是不準確的，至少它是不全面的。那多核處理器的情況下，線程是怎樣執行呢？這就需要了解內核線程。</p><p>多核(心)處理器是指在一個處理器上集成多個運算核心從而提高計算能力，也就是有多個真正並行計算的處理核心，每一個處理核心對應一個內核線程。</p><p>內核線程（Kernel Thread，KLT）就是直接由操作系統內核支持的線程，這種線程由內核來完成線程切換，內核通過操作調度器對線程進行調度，並負責將線程的任務映射到各個處理器上。一般一個處理核心對應一個內核線程，比如單核處理器對應一個內核線程，雙核處理器對應兩個內核線程，四核處理器對應四個內核線程。</p><p>現在的電腦一般是雙核四線程、四核八線程，是採用超線程技術將一個物理處理核心模擬成兩個邏輯處理核心，對應兩個內核線程，所以在操作系統中看到的CPU數量是實際物理CPU數量的兩倍，如你的電腦是雙核四線程，打開“任務管理器\性能”可以看到4個CPU的監視器，四核八線程可以看到8個CPU的監視器。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5a011ae006a84069999ee497171875b3><p class=pgc-img-caption>雙核四線程在Windows8下查看的結果</p></div><p class=ql-align-center><br></p><p>超線程技術就是利用特殊的硬件指令，把一個物理芯片模擬成兩個邏輯處理核心，讓單個處理器都能使用線程級並行計算，進而兼容多線程操作系統和軟件，減少了CPU的閒置時間，提高的CPU的運行效率。這種超線程技術(如雙核四線程)由處理器硬件的決定，同時也需要操作系統的支持才能在計算機中表現出來。</p><p>程序一般不會直接去使用內核線程，而是去使用內核線程的一種高級接口——輕量級進程（Lightweight Process，LWP），輕量級進程就是我們通常意義上所講的線程，也被叫做用戶線程。由於每個輕量級進程都由一個內核線程支持，因此只有先支持內核線程，才能有輕量級進程。用戶線程與內核線程的對應關係有三種模型：一對一模型、多對一模型、多對多模型，在這以4個內核線程、3個用戶線程為例對三種模型進行說明。</p><h1><strong>一對一模型</strong></h1><p>對於一對一模型來說，一個用戶線程就唯一地對應一個內核線程(反過來不一定成立，一個內核線程不一定有對應的用戶線程)。這樣，如果CPU沒有采用超線程技術(如四核四線程的計算機)，一個用戶線程就唯一地映射到一個物理CPU的內核線程，線程之間的併發是真正的併發。一對一模型使用戶線程具有與內核線程一樣的優點，一個線程因某種原因阻塞時其他線程的執行不受影響；此處，一對一模型也可以讓多線程程序在多處理器的系統上有更好的表現。</p><p>但一對一模型也有兩個缺點：</p><ol><li>許多操作系統限制了內核線程的數量，因此一對一模型會使用戶線程的數量受到限制；</li><li>許多操作系統內核線程調度時，上下文切換的開銷較大，導致用戶線程的執行效率下降。</li></ol><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/eb1fe1d6c67240b484967f229bc38687><p class=pgc-img-caption>一對一模型</p></div><h1><strong>多對一模型</strong></h1><p>多對一模型將多個用戶線程映射到一個內核線程上，線程之間的切換由用戶態的代碼來進行，系統內核感受不到線程的實現方式。用戶線程的建立、同步、銷燬等都在用戶態中完成，不需要內核的介入。因此相對一對一模型，多對一模型的線程上下文切換速度要快許多；此外，多對一模型對用戶線程的數量幾乎無限制。</p><p>但多對一模型也有兩個缺點：</p><ol><li>如果其中一個用戶線程阻塞，那麼其它所有線程都將無法執行，因為此時內核線程也隨之阻塞了；</li><li>在多處理器系統上，處理器數量的增加對多對一模型的線程性能不會有明顯的增加，因為所有的用戶線程都映射到一個處理器上了。</li></ol><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/be73056eab6746b892473bd6d61a7cda><p class=pgc-img-caption>多對一模型</p></div><h1><strong>多對多模型</strong></h1><p>多對多模型結合了一對一模型和多對一模型的優點，將多個用戶線程映射到多個內核線程上。由線程庫負責在可用的可調度實體上調度用戶線程，這使得線程的上下文切換非常快，因為它避免了系統調用。但是增加了複雜性和優先級倒置的可能性，以及在用戶態調度程序和內核調度程序之間沒有廣泛（且高昂）協調的次優調度。</p><p>多對多模型的優點有：</p><ol><li>一個用戶線程的阻塞不會導致所有線程的阻塞，因為此時還有別的內核線程被調度來執行；</li><li>多對多模型對用戶線程的數量沒有限制；</li><li>在多處理器的操作系統中，多對多模型的線程也能得到一定的性能提升，但提升的幅度不如一對一模型的高。</li></ol><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15b03438871743f38f21375546021d33><p class=pgc-img-caption>多對多模型</p></div><p class=ql-align-center><br></p><p>在現在流行的操作系統中，大都採用多對多的模型。</p><h1><strong>查看進程與線程</strong></h1><p>一個應用程序可能是多線程的，也可能是多進程的，如何查看呢？在Windows下我們只須打開任務管理器就能查看一個應用程序的進程和線程數。按“Ctrl+Alt+Del”或右鍵快捷工具欄打開任務管理器。</p><p>查看進程數和線程數：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6a99376746d641a6a8799fb7083c646d><p class=pgc-img-caption>查看線程數和進程數</p></div><p class=ql-align-center><br></p><p>在“進程”選項卡下，我們可以看到一個應用程序包含的線程數。如果一個應用程序有多個進程，我們能看到每一個進程，如在上圖中，Google的Chrome瀏覽器就有多個進程。同時，如果打開了一個應用程序的多個實例也會有多個進程，如上圖中我打開了兩個cmd窗口，就有兩個cmd進程。如果看不到線程數這一列，可以再點擊“查看\選擇列”菜單，增加監聽的列。</p><p>查看CPU和內存的使用率：</p><p>在性能選項卡中，我們可以查看CPU和內存的使用率，根據CPU使用記錄的監視器的個數還能看出邏輯處理核心的個數，如我的雙核四線程的計算機就有四個監視器。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2ddf605d7a614494ab6a871242a311ab><p class=pgc-img-caption>查看CPU和內存的使用率</p></div><p><strong>線程的生命週期</strong></p><p>當線程的數量小於處理器的數量時，線程的併發是真正的併發，不同的線程運行在不同的處理器上。但當線程的數量大於處理器的數量時，線程的併發會受到一些阻礙，此時並不是真正的併發，因為此時至少有一個處理器會運行多個線程。</p><p>在單個處理器運行多個線程時，併發是一種模擬出來的狀態。操作系統採用時間片輪轉的方式輪流執行每一個線程。現在，幾乎所有的現代操作系統採用的都是時間片輪轉的搶佔式調度方式，如我們熟悉的Unix、Linux、Windows及macOS等流行的操作系統。</p><p>我們知道線程是程序執行的最小單位，也是任務執行的最小單位。在早期只有進程的操作系統中，進程有五種狀態，創建、就緒、運行、阻塞(等待)、退出。早期的進程相當於現在的只有單個線程的進程，那麼現在的多線程也有五種狀態，現在的多線程的生命週期與早期進程的生命週期類似。</p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/30cb82a276524bf8a1064c3271c997e9><p class=pgc-img-caption>早期進程的生命週期</p></div><p>進程在運行過程有三種狀態：就緒、運行、阻塞，創建和退出狀態描述的是進程的創建過程和退出過程。</p><ul><li>創建：進程正在創建，還不能運行。操作系統在創建進程時要進行的工作包括分配和建立進程控制塊表項、建立資源表格並分配資源、加載程序並建立地址空間；</li><li>就緒：時間片已用完，此線程被強制暫停，等待下一個屬於它的時間片到來；</li><li>運行：此線程正在執行，正在佔用時間片；</li><li>阻塞：也叫等待狀態，等待某一事件(如IO或另一個線程)執行完；</li><li>退出：進程已結束，所以也稱結束狀態，釋放操作系統分配的資源。</li></ul><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/536c19c03f5b4e689a644a2a9c34d813><p class=pgc-img-caption>線程的生命週期</p></div><p class=ql-align-center><br></p><ul><li>創建：一個新的線程被創建，等待該線程被調用執行；</li><li>就緒：時間片已用完，此線程被強制暫停，等待下一個屬於它的時間片到來；</li><li>運行：此線程正在執行，正在佔用時間片；</li><li>阻塞：也叫等待狀態，等待某一事件(如IO或另一個線程)執行完；</li><li>退出：一個線程完成任務或者其他終止條件發生，該線程終止進入退出狀態，退出狀態釋放該線程所分配的資源。</li></ul><h1><strong>協程</strong></h1><p>協程，英文Coroutines，是一種基於線程之上，但又比線程更加輕量級的存在，這種由程序員自己寫程序來管理的輕量級線程叫做『用戶空間線程』，具有對內核來說不可見的特性。</p><p>因為是自主開闢的異步任務，所以很多人也更喜歡叫它們纖程（Fiber），或者綠色線程（GreenThread）。正如一個進程可以擁有多個線程一樣，一個線程也可以擁有多個協程。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=一文讀懂什麼是進程、線程、協程（建議收藏） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6c2d8f6855384338a272783660c05452><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><h1><strong>協程的目的</strong></h1><p>在傳統的J2EE系統中都是基於每個請求佔用一個線程去完成完整的業務邏輯（包括事務）。所以系統的吞吐能力取決於每個線程的操作耗時。如果遇到很耗時的I/O行為，則整個系統的吞吐立刻下降，因為這個時候線程一直處於阻塞狀態，如果線程很多的時候，會存在很多線程處於空閒狀態（等待該線程執行完才能執行），造成了資源應用不徹底。</p><p>最常見的例子就是JDBC（它是同步阻塞的），這也是為什麼很多人都說數據庫是瓶頸的原因。這裡的耗時其實是讓CPU一直在等待I/O返回，說白了線程根本沒有利用CPU去做運算，而是處於空轉狀態。而另外過多的線程，也會帶來更多的ContextSwitch開銷。</p><p>對於上述問題，現階段行業裡的比較流行的解決方案之一就是單線程加上異步回調。其代表派是node.js以及Java裡的新秀Vert.x。</p><p>而協程的目的就是當出現長時間的I/O操作時，通過讓出目前的協程調度，執行下一個任務的方式，來消除ContextSwitch上的開銷。</p><h1><strong>協程的特點</strong></h1><ol><li>線程的切換由操作系統負責調度，協程由用戶自己進行調度，因此減少了上下文切換，提高了效率。</li><li>線程的默認Stack大小是1M，而協程更輕量，接近1K。因此可以在相同的內存中開啟更多的協程。</li><li>由於在同一個線程上，因此可以避免競爭關係而使用鎖。</li><li>適用於被阻塞的，且需要大量併發的場景。但不適用於大量計算的多線程，遇到此種情況，更好實用線程去解決。</li></ol><h1><strong>協程的原理</strong></h1><p>當出現IO阻塞的時候，由協程的調度器進行調度，通過將數據流立刻yield掉（主動讓出），並且記錄當前棧上的數據，阻塞完後立刻再通過線程恢復棧，並把阻塞的結果放到這個線程上去跑，這樣看上去好像跟寫同步代碼沒有任何差別，這整個流程可以稱為coroutine，而跑在由coroutine負責調度的線程稱為Fiber。比如Golang裡的 go關鍵字其實就是負責開啟一個Fiber，讓func邏輯跑在上面。</p><p>由於協程的暫停完全由程序控制，發生在用戶態上；而線程的阻塞狀態是由操作系統內核來進行切換，發生在內核態上。</p><p>因此，協程的開銷遠遠小於線程的開銷，也就沒有了ContextSwitch上的開銷。</p><h1><strong>協程和線程的比較</strong></h1><p><strong>比較項線程協程</strong>佔用資源初始單位為1MB,固定不可變初始一般為 2KB，可隨需要而增大調度所屬由 OS 的內核完成由用戶完成切換開銷涉及模式切換(從用戶態切換到內核態)、16個寄存器、PC、SP...等寄存器的刷新等只有三個寄存器的值修改 - PC / SP / DX.性能問題資源佔用太高，頻繁創建銷燬會帶來嚴重的性能問題資源佔用小,不會帶來嚴重的性能問題數據同步需要用鎖等機制確保數據的一直性和可見性不需要多線程的鎖機制，因為只有一個線程，也不存在同時寫變量衝突，在協程中控制共享資源不加鎖，只需要判斷狀態就好了，所以執行效率比多線程高很多。</p><h1>關注我，後續更多幹貨奉上！</h1></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>什麼</a></li><li><a>進程</a></li><li><a>線程</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/77f5407e.html alt="PHP 線程，進程和併發" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7a700a857098411d884a928d6b5f5e01 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/77f5407e.html title="PHP 線程，進程和併發">PHP 線程，進程和併發</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ab6b08d6.html alt=併發最基本要理解的進程、線程、協程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3f756a3627164d4f93883dd7c0e0bac5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ab6b08d6.html title=併發最基本要理解的進程、線程、協程>併發最基本要理解的進程、線程、協程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/79e23cb7.html alt=如何理解：程序、進程、線程、併發、並行、高併發？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b101e22357854a56abf29c0745b5d9c9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/79e23cb7.html title=如何理解：程序、進程、線程、併發、並行、高併發？>如何理解：程序、進程、線程、併發、並行、高併發？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cf2fb099.html alt=看一遍就懂進程線程、同步異步、阻塞非阻塞、併發並（建議收藏） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/12861a08-8f52-48c2-9b25-46df51894677 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cf2fb099.html title=看一遍就懂進程線程、同步異步、阻塞非阻塞、併發並（建議收藏）>看一遍就懂進程線程、同步異步、阻塞非阻塞、併發並（建議收藏）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c40a49b9.html alt=線程與進程的區別以及對多線程併發的理解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/813488ac38be43b29140e4917ff1e0b5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c40a49b9.html title=線程與進程的區別以及對多線程併發的理解>線程與進程的區別以及對多線程併發的理解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3f2bf674.html alt=進程、線程、協程的選擇與文件併發操作 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/622e63700f544942809d9a374757630e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3f2bf674.html title=進程、線程、協程的選擇與文件併發操作>進程、線程、協程的選擇與文件併發操作</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5fc01cfc.html alt=進程、線程的概念、區別和聯繫；併發、並行概念、區別和聯繫 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5fc01cfc.html title=進程、線程的概念、區別和聯繫；併發、並行概念、區別和聯繫>進程、線程的概念、區別和聯繫；併發、並行概念、區別和聯繫</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6b8a6681.html alt=進程與線程的區別和併發編程要素 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6b8a6681.html title=進程與線程的區別和併發編程要素>進程與線程的區別和併發編程要素</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d0b69a5b.html alt=高併發和高性能系統中進程、線程、協程、隊列（如何調度的） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/f41e7ed497b44b618a1df64c6aaa2295 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d0b69a5b.html title=高併發和高性能系統中進程、線程、協程、隊列（如何調度的）>高併發和高性能系統中進程、線程、協程、隊列（如何調度的）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b97e222b.html alt=進程、線程、並行與併發 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5e04293de8fb49f19388e78a9812cce4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b97e222b.html title=進程、線程、並行與併發>進程、線程、並行與併發</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9911d0f.html alt=程序，進程，線程與併發和並行設計實現 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/165d54ca-9361-4365-9d4b-12a56bebfc33 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9911d0f.html title=程序，進程，線程與併發和並行設計實現>程序，進程，線程與併發和並行設計實現</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/399bf08.html alt="線程，進程，協程， 併發，並行，同步，異步概念解析" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/41ca5e6e9b914e628478b8262ae96e43 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/399bf08.html title="線程，進程，協程， 併發，並行，同步，異步概念解析">線程，進程，協程， 併發，並行，同步，異步概念解析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bdedb94f.html alt=科普貼！丨你知道港珠澳大橋為什麼是彎的嗎！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d84b472b45474058bfd6bd4b87450f53 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bdedb94f.html title=科普貼！丨你知道港珠澳大橋為什麼是彎的嗎！>科普貼！丨你知道港珠澳大橋為什麼是彎的嗎！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/52ecc739.html alt=科普！看完這篇文章，你就知道港珠澳大橋為什麼是彎的了！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8f0b8a6daf6e4f9bab21e7c06cbc9111 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/52ecc739.html title=科普！看完這篇文章，你就知道港珠澳大橋為什麼是彎的了！>科普！看完這篇文章，你就知道港珠澳大橋為什麼是彎的了！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8bbd5f8a.html alt=長知識！什麼是榫卯結構？為什麼現代建築當中不常見了？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1537941825042b6f495fa56 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8bbd5f8a.html title=長知識！什麼是榫卯結構？為什麼現代建築當中不常見了？>長知識！什麼是榫卯結構？為什麼現代建築當中不常見了？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>