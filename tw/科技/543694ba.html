<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一般人不知道的線程間數據交換Exchanger | 极客快訊</title><meta property="og:title" content="一般人不知道的線程間數據交換Exchanger - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/df26ce3a590f4daba6b29648f36e3ae7"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/543694ba.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/543694ba.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/543694ba.html><meta property="article:published_time" content="2020-11-14T21:00:06+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:06+08:00"><meta name=Keywords content><meta name=description content="一般人不知道的線程間數據交換Exchanger"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/543694ba.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一般人不知道的線程間數據交換Exchanger</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>線程間的數據共享除了定義一個共享數據然後各個線程去訪問這種方式外，還可以使用Exchanger交換數據。</p><h1 class=pgc-h-arrow-right>簡單案例</h1><p>首先看看Exchanger的運用，Exchanger最簡單的測試代碼，如下圖：</p><div class=pgc-img><img alt=一般人不知道的線程間數據交換Exchanger onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/df26ce3a590f4daba6b29648f36e3ae7><p class=pgc-img-caption></p></div><p>對應打印的結果如下：</p><p>線程2創建對象java.lang.Object@3f6d4362</p><p>線程1創建對象java.lang.Object@c986ad7</p><p>線程2得到的類java.lang.Object@c986ad7</p><p>線程1得到的類java.lang.Object@3f6d4362</p><p>可以看出來線程2創建的對象與線程1得到的線程是同一個對象，也就是他們指向的是同一個引用。</p><h1 class=pgc-h-arrow-right>Exchanger源碼分析</h1><p>Exchanger只提供了兩個exchange方法，一個是隻帶交換的數據參數，另外一個不僅有數據參數，還有時間限制，這也從側面說明exchange是一個阻塞線程的方法，並且可以指定阻塞時間，這裡我們先分析下不帶時間參數的exchange方法，源碼分析主流程如下圖：</p><div class=pgc-img><img alt=一般人不知道的線程間數據交換Exchanger onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5f8d684e8d294b5bbdeff1c540d47d25><p class=pgc-img-caption></p></div><p>左邊是exchange方法的代碼流程圖，比較簡單可以明顯的看出來主要依靠兩個方法slotExchange與arenaExchange方法，流程主要有兩步，<strong>首先嚐試從slotExchange方法獲取值，如果獲取為null則再從arenaExchange方法獲取，當返回還是null時則拋出中斷異常，否則最終返回結果</strong>。</p><h1 class=pgc-h-arrow-right>slotExchange源碼分析</h1><p>上圖中右邊的分析圖是slotExchange方法的主要代碼圖，再分析這個方法前先說明一下Exchanger的一個內部類Node,Node有7個屬性，這裡先說明三個屬性item（創建node線程要交換出去的值）、match（創建node線程要獲取的值）、parked（創建node的線程）；每個線程再執行到Exchanger方法後都會創建一個Node。</p><p>理解這個基本概念後，再來快速過一下slotExchange方法流程，方法包含兩個循環，第一個循環分析如下：</p><p>首先判斷Exchanger的slot是否為null，<strong>如果不為空則嘗試修改slot值為null,如果修改成功則返回slot的item,並設置slot的match，並喚醒slot的線程，交換成功</strong>。如果設置失敗則說明有其他線程正在修改slot，即存在競爭，這是會判斷機器的CPU數，如果大於1則會初始化Exchanger的Node[] arena（這個是下個方法說明），進入下一個循環。</p><p>如果slot為null則判斷arena是否為null，如果不為null則直接返回null，表示由arenaExchange去執行。</p><p>如果都不是則嘗試當前線程的node的item設置為要交換的值，同時嘗試設置為slot，設置成功則跳出循環，失敗則進入下次循環；</p><p><br></p><p><strong>第一個循環主要包含兩步，如果slot不為null則嘗試交換值，交換成功就返回，否則就嘗試設置slot的值，設置成功就跳出循環</strong>；在cpu是多個的情況下又存在競爭的情況下會再arenaExchange去處理。</p><p>這個循環如果跳出來了則說明設置slot成功，那麼當前線程只需要等待node的match不為null就行，<strong>所以第二個循環的判斷條件就是node的match不為null，如果為null就掛起，當喚醒的時候再判斷，直到node的match不為null則返回match的值。</strong></p><h1 class=pgc-h-arrow-right>分析arenaExchange方法</h1><p>在slotExchange方法中會在存在競爭修改slot並且運行程序的機器的CPU大於1時會初始化Node[] arena屬性，在第二次修改slot還存在競爭失敗時就會返回null,這個時候就到了arenaExchange方法上場了。</p><p><strong>arenaExchange也是一個for的無限循環，每次取出當前線程的Node來獲取進行處理，這裡再介紹node一個屬性index,用來標記node</strong><strong>再</strong><strong>arena數組的位置</strong>，處理流程的簡單分析如下：</p><p>首先根據node的index獲取j（計算方法：index&lt;&lt;7+ABASE(1&lt;&lt;7的常量)，原因後面特別說明），如果不為null則嘗試修改arena的第j項為null，如果成功則返回arena[j]的node的item的值，並設置match，最後喚醒node保存的線程。</p><p>第二步如果node為null則把當前線程的node的item設置為要交換出去的值，然後嘗試修改arena[j]的值為當前線程的node，如果修改成功則循環判斷match的值，當不為null則返回值，否則判斷線程中斷等條件後則掛起線程，等喚醒再判斷。</p><p>第三步也就是node不為null，但是在第一步更新失敗後，會根據node的bound與Exchange的bound等對比，計算index的值，有時會增長有時會減少，然後進入下一個循環判斷。</p><p>總結這三步主要目的如下，<strong>首先是嘗試從arena找一個節點來交換數據，如果交換成功則喚醒對應的線程並返回交換結果，如果交換失敗則更新index，再次嘗試尋找並交換，如果在找到的arena[j]為null則嘗試新建一個node並保存進arena，掛起線程等待喚醒</strong>。</p><p>對之前的arena的j特別說明，把index擴大再作為數組的索引，原因是內存在加載數組一個元素時會把附近的也加載，而修改過後會把加載出來的設置為過期，為了避免這種浪費在數組間隔一定位置在設置值。</p><h1 class=pgc-h-arrow-right>總結</h1><p>Exchanger利用一個Node類型的屬性slot實現線程間的交換，如果slot為null則初始化一個並設置item為需要交換的值，然後掛起，當其他線程進來的時候看到slot為null則取出node的item值，然後把自己要交換的值設置進match上，然後喚醒node中線程。</p><p>利用一個屬性也夠了，但是在併發的情況下吞吐量並不高，所以又建了一個Node的數組arena，線程在arena一個個找不為null的值，嘗試修改直到修改成功，則獲取node的item，再設置match並喚醒線程。如果找到的為null則自己主動new一個node並設置item,然後掛起等待喚醒。</p><p><br></p><p>Java程序員日常學習筆記，如理解有誤歡迎各位交流討論！</p><div class=pgc-img><img alt=一般人不知道的線程間數據交換Exchanger onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/fd903d7d90574f57af18c224be17a56c><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>程間</a></li><li><a>數據</a></li><li><a>交換</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/611f4508.html alt=BIM模型數據主要有哪些交換方式與方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/8b3a0009c04f47dba125fac42117633d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/611f4508.html title=BIM模型數據主要有哪些交換方式與方法>BIM模型數據主要有哪些交換方式與方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5d9900a2.html alt=Flink中的數據抽象及數據交換過程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/1b7a1014-7ea5-421b-808e-c41398f5e4aa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5d9900a2.html title=Flink中的數據抽象及數據交換過程>Flink中的數據抽象及數據交換過程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a44e688d.html alt=共建安全高效的證通數據交換存儲平臺 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/6e00e2a126624cd3a04003e09f129836 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a44e688d.html title=共建安全高效的證通數據交換存儲平臺>共建安全高效的證通數據交換存儲平臺</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5a8ee1e1.html alt=加大數據交換，服務社會治理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/52356fef840348268d722f9e09041d09 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5a8ee1e1.html title=加大數據交換，服務社會治理>加大數據交換，服務社會治理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/aabf6c20.html alt=大容量數據交換，該選擇什麼移動存儲設備？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a0645b75449e4f86b44ec2301e660ac4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/aabf6c20.html title=大容量數據交換，該選擇什麼移動存儲設備？>大容量數據交換，該選擇什麼移動存儲設備？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4abcc1ec.html alt=完善和高效的數據交換管理平臺 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/95bd84cca48a4510bdf677846e255dda style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4abcc1ec.html title=完善和高效的數據交換管理平臺>完善和高效的數據交換管理平臺</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/781bd8ae.html alt="成都成華：搭建數據交換中心 推進移動辦公辦案平臺建設_正義網" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/781bd8ae.html title="成都成華：搭建數據交換中心 推進移動辦公辦案平臺建設_正義網">成都成華：搭建數據交換中心 推進移動辦公辦案平臺建設_正義網</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/89963e6e.html alt=數據安全交換協議來了，或將推動AI大步邁向3.0時代 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/SErvipbBeWotcr style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/89963e6e.html title=數據安全交換協議來了，或將推動AI大步邁向3.0時代>數據安全交換協議來了，或將推動AI大步邁向3.0時代</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/75154d57.html alt=試驗數據交換共享技術研究 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1f294f46e217463ca5ba719dfd99dcf3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/75154d57.html title=試驗數據交換共享技術研究>試驗數據交換共享技術研究</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/259011ee.html alt=跨網數據交換的5種方式介紹 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/46b9311b886d482780b49bd6285a6eee style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/259011ee.html title=跨網數據交換的5種方式介紹>跨網數據交換的5種方式介紹</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/b7000f2a.html alt=數據中心網絡交換設備架構之戰 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15209294584692e19f49375 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/b7000f2a.html title=數據中心網絡交換設備架構之戰>數據中心網絡交換設備架構之戰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3fdedd1.html alt="'數據共享'和'數據交換'，這兩種服務平臺在推廣仍有下方面困難" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/21d8c0770c0944d495e1516d8bcb6c70 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3fdedd1.html title="'數據共享'和'數據交換'，這兩種服務平臺在推廣仍有下方面困難">'數據共享'和'數據交換'，這兩種服務平臺在推廣仍有下方面困難</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/28c16cf.html alt=中巴海關數據交換已啟動，低價報關將受嚴懲！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RDa53wtC87XbSB style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/28c16cf.html title=中巴海關數據交換已啟動，低價報關將受嚴懲！>中巴海關數據交換已啟動，低價報關將受嚴懲！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6d19a57.html alt="如何使用 Protobuf 做數據交換" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1f3e86b7f46045efaa41d194ae4b0638 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6d19a57.html title="如何使用 Protobuf 做數據交換">如何使用 Protobuf 做數據交換</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1209c08.html alt=如何有效的進行數據交換管理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/fbb3bc2be1e04318bc25ab6d95ff4d03 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1209c08.html title=如何有效的進行數據交換管理>如何有效的進行數據交換管理</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>