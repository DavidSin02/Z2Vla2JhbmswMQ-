<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>å‹•æ‰‹å­¸ç¿’TCPï¼šTCPé€£æ¥å»ºç«‹èˆ‡çµ‚æ­¢ï¼Œå®ƒæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­° | æå®¢å¿«è¨Š</title><meta property="og:title" content="å‹•æ‰‹å­¸ç¿’TCPï¼šTCPé€£æ¥å»ºç«‹èˆ‡çµ‚æ­¢ï¼Œå®ƒæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­° - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/2213ae70bb254bdcb7c9305d0a560b20"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5b8b8a5.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5b8b8a5.html><meta property="article:published_time" content="2020-10-29T20:50:28+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:28+08:00"><meta name=Keywords content><meta name=description content="å‹•æ‰‹å­¸ç¿’TCPï¼šTCPé€£æ¥å»ºç«‹èˆ‡çµ‚æ­¢ï¼Œå®ƒæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­°"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/5b8b8a5.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>å‹•æ‰‹å­¸ç¿’TCPï¼šTCPé€£æ¥å»ºç«‹èˆ‡çµ‚æ­¢ï¼Œå®ƒæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­°</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p>TCPæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­°ï¼Œä»»ä½•ä¸€æ–¹åœ¨ç™¼é€æ•¸æ“šä¹‹å‰ï¼Œéƒ½å¿…é ˆå…ˆåœ¨é›™æ–¹ä¹‹é–“å»ºç«‹ä¸€æ¢é€£æ¥ã€‚æ‰€ä»¥ï¼Œæœ¬æ–‡å°±ä¸»è¦çœ‹çœ‹TCPé€£æ¥çš„å»ºç«‹å’Œçµ‚æ­¢ã€‚</p><p>åœ¨é–‹å§‹ä»‹ç´¹TCPé€£æ¥ä¹‹å‰ï¼Œå…ˆä¾†çœ‹çœ‹TCPæ•¸æ“šåŒ…çš„é¦–éƒ¨ï¼Œé¦–éƒ¨è£¡é¢æœ‰å¾ˆå¤šé‡è¦çš„å­—æ®µï¼Œåœ¨æˆ‘å€‘å¯¦ç¾ç¨‹åºçš„æ™‚å€™éœ€è¦é€²è¡Œè¨­ç½®ã€‚</p><h1>TCPçš„é¦–éƒ¨</h1><p>åœ¨OSIä¸ƒå±¤æ¨¡å‹ä¸­ï¼Œä¸Šå±¤çš„æ•¸æ“šåŒ…éƒ½æœƒä½œç‚ºä¸‹å±¤æ•¸æ“šåŒ…çš„æ•¸æ“šéƒ¨åˆ†ï¼ˆpayloadï¼‰ã€‚</p><p>ä¹Ÿå°±æ˜¯èªªï¼Œç•¶æ§‹é€ TCPæ•¸æ“šåŒ…çš„æ™‚å€™ï¼ŒæœƒæŠŠæ‡‰ç”¨å±¤çš„æ•¸æ“šåŒ…ä½œç‚ºTCPåŒ…çš„æ•¸æ“šéƒ¨åˆ†ï¼Œç„¶å¾ŒåŠ ä¸ŠTCPé ­æ§‹æˆTCPæ•¸æ“šåŒ…ï¼›åŒæ¨£ï¼Œç•¶æ§‹é€ IPæ•¸æ“šåŒ…çš„æ™‚å€™ï¼Œæ•´å€‹TCPåŒ…å°±æœƒè¢«ç•¶ä½œæ•¸æ“šéƒ¨åˆ†ï¼Œç„¶å¾ŒåŠ ä¸ŠIPé ­æ§‹æˆIPæ•¸æ“šåŒ…ã€‚</p><div class=pgc-img><img alt=å‹•æ‰‹å­¸ç¿’TCPï¼šTCPé€£æ¥å»ºç«‹èˆ‡çµ‚æ­¢ï¼Œå®ƒæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­° onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2213ae70bb254bdcb7c9305d0a560b20></div><p>TCPé ­çš„æ•¸æ“šæ ¼å¼å¦‚ä¸‹ï¼Œåœ¨ä¸åŒ…æ‹¬å¯é¸å­—æ®µçš„æƒ…æ³ä¸‹ï¼Œä¸€èˆ¬TCPé ­æœƒä½”ç”¨20å€‹å­—ç¯€ã€‚</p><div class=pgc-img><img alt=å‹•æ‰‹å­¸ç¿’TCPï¼šTCPé€£æ¥å»ºç«‹èˆ‡çµ‚æ­¢ï¼Œå®ƒæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­° onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6f2c33f651c44c8fa261039e49333852></div><p><strong>åœ¨TCPé¦–éƒ¨ä¸­ï¼Œæœ‰å¹¾å€‹å­—æ®µæ˜¯éœ€è¦é—œæ³¨ä¸€ä¸‹ï¼š</strong></p><ul><li>åœ¨TCPé¦–éƒ¨ä¸­æ²’æœ‰æºå’Œç›®æ¨™çš„IPã€MACåœ°å€ï¼ˆIPå’ŒMACåœ°å€åˆ†åˆ¥æ˜¯ç¶²çµ¡å±¤å’Œéˆè·¯å±¤é¦–éƒ¨çš„ä¿¡æ¯ï¼‰ï¼Œåªæœ‰æºå’Œç›®æ¨™çš„ç«¯å£</li><li>Sequence Numberæ˜¯åŒ…çš„åºè™Ÿï¼Œç¶²çµ¡å±¤ï¼ˆIPå±¤ï¼‰çš„å‚³è¼¸æ˜¯ä¸å¯é çš„ï¼Œå¯èƒ½ç”¢ç”ŸåŒ…äº‚åºï¼Œæ‰€ä»¥é€™å€‹éœ€è¦å¯ä»¥è§£æ±ºç¶²çµ¡åŒ…äº‚åºçš„å•é¡Œ</li><li>Acknowledgement Numberç”¨ä¾†ç¢ºèªæ”¶åˆ°æ•¸æ“šåŒ…çš„ç¢ºèªåºè™Ÿï¼Œç‚ºTCPçš„å‚³è¼¸æä¾›äº†å¯é æ€§ä¿è­‰</li><li>TCP FlagsåŒ…æ‹¬äº†8å€‹bitï¼Œé€šéå°é€™äº›bitçš„è¨­ç½®ï¼Œå¯ä»¥ä»£è¡¨ä¸åŒé¡å‹çš„TCPæ•¸æ“šåŒ…</li></ul><p>ä¸‹é¢å°±çœ‹çœ‹TCPé€£æ¥çš„å»ºç«‹å’Œçµ‚æ­¢ã€‚</p><h1>TCPé€£æ¥å»ºç«‹</h1><p>TCPé€£æ¥å»ºç«‹çš„éç¨‹è¢«ç¨±ç‚ºä¸‰æ¬¡æ¡æ‰‹éç¨‹ï¼š</p><ol><li>é€£æ¥å»ºç«‹ç™¼èµ·ç«¯ç™¼é€[SYN]åŒ…ï¼Œè©²ç«¯å°‡ä¸»å‹•æ‰“é–‹ï¼ˆactive openï¼‰</li><li>æ¥æ”¶ç«¯å°‡ç™¼é€[SYN, ACK]åŒ…ï¼Œè©²ç«¯å°‡è¢«å‹•æ‰“é–‹ï¼ˆpassive openï¼‰ï¼ŒACKæ¨™èªŒè¡¨ç¤ºå°æ”¶åˆ°çš„[SYN]åŒ…çš„ç¢ºèª</li><li>é€£æ¥å»ºç«‹ç™¼èµ·ç«¯ç™¼é€[ACK]åŒ…ç¢ºèª[SYN, ACK]åŒ…</li></ol><div class=pgc-img><img alt=å‹•æ‰‹å­¸ç¿’TCPï¼šTCPé€£æ¥å»ºç«‹èˆ‡çµ‚æ­¢ï¼Œå®ƒæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­° onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/52b3e6184085488b8a6680a0259c8f69></div><h1>Initial Sequence Number</h1><p>é€£æ¥å»ºç«‹éç¨‹ä¸­ï¼Œä¸€å€‹é‡è¦çš„å·¥ä½œå°±æ˜¯åˆå§‹åŒ–Sequence Numberï¼Œé€šä¿¡çš„é›™æ–¹åœ¨å»ºç«‹é€£æ¥çš„éç¨‹ä¸­äº’ç›¸é€šçŸ¥å°æ–¹è‡ªå·±çš„åˆå§‹Sequence Numberï¼ˆISNï¼šInitial Sequence Numberï¼‰ã€‚ISNä¸æ˜¯å›ºå®šçš„ï¼ŒISNè·Ÿæ™‚é˜ç¶å®šï¼Œæ ¹æ“šç‰¹å®šçš„é–“éš”è‡ªå¢ï¼Œç›´åˆ°è¶…é2^32ï¼Œåˆå¾0é–‹å§‹ã€‚</p><p>SYNå…¨ç¨±å°±æ˜¯Synchronize Sequence Numberï¼Œé€šéseqåºè™Ÿï¼ŒTCPå°±å¯ä»¥ä¿è­‰æ•¸æ“šåŒ…çš„é †åºï¼›é€šéackåºè™Ÿï¼ŒTCPå°±æœ‰äº†å¯é æ€§ã€‚</p><h1>é€£æ¥å»ºç«‹æ³¨æ„é»</h1><p>åœ¨å»ºç«‹TCPé€£æ¥çš„éç¨‹ä¸­ï¼Œæœ‰ä»¥ä¸‹å…©é»éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p><ol><li>[SYN]æ¨™èªŒçš„æ•¸æ“šåŒ…æœƒä½¿ç”¨æ¶ˆè€—ä¸€å€‹åºè™Ÿï¼Œæ‰€ä»¥å°ç«¯çš„ç¢ºèªè™Ÿï¼ˆackï¼‰æ˜¯ç•¶å‰åºè™Ÿï¼ˆseqï¼‰åŠ ä¸€</li><li>ç•¶è¢«å‹•æ‰“é–‹ç«¯ç™¼é€[ACK]ç¢ºèªåŒ…çš„æ™‚å€™ï¼ŒåŒæ™‚è¨­ç½®äº†[SYN]æ¨™èªŒï¼Œæ‰€ä»¥TCPé€£æ¥å»ºç«‹çš„éç¨‹åªéœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œè€Œä¸æ˜¯å››æ¬¡</li></ol><h1>TCPé€£æ¥çµ‚æ­¢</h1><p>TCPé€£æ¥çµ‚æ­¢çš„éç¨‹è¢«ç¨±ç‚ºå››æ¬¡æ®æ‰‹éç¨‹ï¼Œä»¥ä¸‹åœ–ç‚ºä¾‹ï¼š</p><ol><li>é€£æ¥çµ‚æ­¢ç«¯ï¼ˆclientï¼‰ç™¼é€[FIN, ACK] åŒ…ï¼Œé—œé–‰clientåˆ°serveræ–¹å‘çš„æ•¸æ“šç™¼é€é€šè·¯</li><li>serverç«¯ç™¼é€[ACK]åŒ…ä¾†ç¢ºèªä¾†è‡ªclientçš„[FIN, ACK] åŒ…</li><li>serverç«¯ç™¼é€[FIN, ACK] åŒ…ï¼Œé—œé–‰serveråˆ°clientæ–¹å‘çš„æ•¸æ“šç™¼é€é€šè·¯</li><li>clientç«¯ç™¼é€[ACK]åŒ…ä¾†ç¢ºèªä¾†è‡ªserverçš„[FIN, ACK] åŒ…ï¼Œåˆ°æ­¤TCPé€£æ¥é—œé–‰</li></ol><div class=pgc-img><img alt=å‹•æ‰‹å­¸ç¿’TCPï¼šTCPé€£æ¥å»ºç«‹èˆ‡çµ‚æ­¢ï¼Œå®ƒæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­° onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3bacf62a29ee4c08939ed6de4f5db07b></div><h1>é€£æ¥çµ‚æ­¢æ³¨æ„é»</h1><p>åœ¨å»ºç«‹TCPé€£æ¥çš„éç¨‹ä¸­ï¼Œæœ‰ä»¥ä¸‹å…©é»éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p><ul><li>[FIN]æ¨™èªŒçš„æ•¸æ“šåŒ…æœƒä½¿ç”¨æ¶ˆè€—ä¸€å€‹åºè™Ÿï¼Œæ‰€ä»¥å°ç«¯çš„ç¢ºèªè™Ÿï¼ˆackï¼‰æ˜¯ç•¶å‰åºè™Ÿï¼ˆseqï¼‰åŠ ä¸€</li><li>èˆ‡å»ºç«‹é€£æ¥æ™‚çš„ä¸‰æ¬¡ æ¡æ‰‹ä¸åŒï¼Œçµ‚æ­¢é€£æ¥éœ€è¦å››æ¬¡æ®æ‰‹å› ç‚ºTCPé€£æ¥æ˜¯å…¨é›™å·¥çš„ï¼Œæ¯å€‹æ–¹å‘éƒ½å¿…é ˆå–®ç¨é€²è¡Œé—œé–‰ã€‚ç•¶ä¸€æ–¹å®Œæˆå®ƒçš„æ•¸æ“šç™¼é€ä»»å‹™å¾Œå°±èƒ½ç™¼é€ä¸€å€‹FINä¾†çµ‚æ­¢é€™å€‹æ–¹å‘çš„é€£æ¥ã€‚æ”¶åˆ°ä¸€å€‹ FINåªæ„å‘³è‘—é€™ä¸€æ–¹å‘ä¸Šæ²’æœ‰æ•¸æ“šæµå‹•ï¼Œä½†æ˜¯TCPé€£æ¥åœ¨æ”¶åˆ°ä¸€å€‹FINå¾Œä»èƒ½ç™¼é€æ•¸æ“š</li></ul><h1>TCPé€£æ¥å¯¦é©—</h1><p>å¥½äº†ï¼Œç­è§£äº†TCPé€£æ¥å»ºç«‹å’Œçµ‚æ­¢çš„åŸºæœ¬çŸ¥è­˜å¾Œï¼Œå°±å¯ä»¥é€šéPcap.Netä¾†é€²è¡ŒTCPé€£æ¥å»ºç«‹å’Œçµ‚æ­¢çš„å¯¦é©—äº†ã€‚</p><p>å»ºç«‹é€£æ¥ä»£ç¢¼çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>clientç¨‹åºä½¿ç”¨ä¸€å€‹åˆå§‹çš„seqåºè™Ÿï¼ˆ100ï¼‰ï¼Œç„¶å¾Œç”Ÿæˆä½µç™¼é€ä¸€å€‹å¸¶[SYN]æ¨™èªŒçš„TCPåŒ…</li><li>clientå°‡æœŸå¾…ä¾†è‡ªæœå‹™ç«¯çš„[SYN, ACK]åŒ…</li><li>ç•¶æ”¶åˆ°[SYN, ACK]åŒ…ä¹‹å¾Œï¼Œclientéœ€è¦ç”Ÿæˆä½µç™¼é€ä¸€å€‹[ACK]åŒ…é€²è¡Œç¢ºèªï¼Œé€™å€‹[ACK]åŒ…çš„ackè™Ÿæ˜¯[SYN, ACK]åŒ…seqè™ŸåŠ ä¸€</li></ol><p>çµ‚æ­¢é€£æ¥ä»£ç¢¼çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>clientç¨‹åºdelay 10ç§’é˜ï¼Œç„¶å¾Œç™¼é€[FIN, ACK]åŒ…é—œé–‰clientåˆ°serverçš„é€šè·¯ï¼Œç¹¼çºŒä½¿ç”¨å…¨å±€çš„seqè™Ÿ</li><li>clientå°‡æœŸå¾…ä¾†è‡ªæœå‹™ç«¯çš„[ACK]åŒ…ï¼Œä»¥åŠ[FIN, ACK]åŒ…</li><li>æœ€å¾Œclientç™¼é€[ACK]åŒ…ï¼Œseqè™Ÿéœ€è¦åŠ ä¸€ï¼Œå› ç‚º[FIN]æ¨™èªŒçš„åŒ…å°‡æ¶ˆè€—ä¸€å€‹åºè™Ÿï¼ŒTCPé€£æ¥çµ‚æ­¢å®Œæˆ</li></ol><p>ä¸»ç¨‹åºå¦‚ä¸‹ï¼Œç™¼é€TCPé€£æ¥å»ºç«‹å’Œçµ‚æ­¢è«‹æ±‚ï¼Œæ¯å€‹è«‹æ±‚ç™¼é€å¾Œéƒ½ç”¨PacketHandlerè™•ç†æ”¶åˆ°çš„åŒ…ï¼š</p><p>communicator.SendPacket(Utils.BuildTcpPacket(endPointInfo, TcpControlBits.Synchronize, null));</p><p>PacketHandler(communicator, endPointInfo);</p><p>// delay 10 secs, then client to send Fin</p><p>Thread.Sleep(10000);</p><p>communicator.SendPacket(Utils.BuildTcpPacket(endPointInfo, TcpControlBits.Fin | TcpControlBits.Acknowledgment));</p><p>PacketHandler(communicator, endPointInfo);</p><p>ç¨‹åºçš„ä¸»è¦é‚è¼¯åœ¨PacketHandlerä¸­ï¼Œé€™å€‹å‡½æ•¸æ ¹æ“šæ”¶åˆ°çš„ä¸åŒTCPåŒ…çš„é¡å‹å®Œæˆä¸åŒçš„é‚è¼¯ï¼Œç”¢ç”Ÿä½µç™¼é€ä¸åŒé¡å‹çš„åŒ…ã€‚</p><p>ä¾‹å¦‚ï¼Œç•¶PacketHandleræ¥æ”¶åˆ°ä¾†è‡ªæœå‹™ç«¯çš„[SYN, ACK]åŒ…å¾Œï¼Œè™•ç†å‡½æ•¸å°±æœƒç”Ÿæˆä½µç™¼é€ä¸€å€‹[ACK]ç¢ºèªåŒ…ã€‚ä¹Ÿå°±æ˜¯èªªï¼ŒPacketHandlerçš„é‚è¼¯å°±æ˜¯å¯¦ç¾äº†TCPé€£æ¥å»ºç«‹å’Œçµ‚æ­¢çš„é‚è¼¯ã€‚</p><p>private static void PacketHandler(PacketCommunicator communicator, EndPointInfo endPointInfo)</p><p>{</p><p>Packet packet = null;</p><p>bool running = true;</p><p>do</p><p>{</p><p>PacketCommunicatorReceiveResult result = communicator.ReceivePacket(out packet);</p><p>switch (result)</p><p>{</p><p>case PacketCommunicatorReceiveResult.Timeout:</p><p>// Timeout elapsed</p><p>continue;</p><p>case PacketCommunicatorReceiveResult.Ok:</p><p>bool isRecvedPacket = (packet.Ethernet.IpV4.Destination.ToString() == endPointInfo.SourceIp) ? true : false;</p><p>if (isRecvedPacket)</p><p>{</p><p>switch (packet.Ethernet.IpV4.Tcp.ControlBits)</p><p>{</p><p>case (TcpControlBits.Synchronize | TcpControlBits.Acknowledgment):</p><p>Utils.PacketInfoPrinter(packet);</p><p>Packet ack4SynAck = Utils.BuildTcpResponsePacket(packet, TcpControlBits.Acknowledgment);</p><p>communicator.SendPacket(ack4SynAck);</p><p>break;</p><p>case (TcpControlBits.Fin | TcpControlBits.Acknowledgment):</p><p>Utils.PacketInfoPrinter(packet);</p><p>Packet ack4FinAck = Utils.BuildTcpResponsePacket(packet, TcpControlBits.Acknowledgment);</p><p>communicator.SendPacket(ack4FinAck);</p><p>break;</p><p>case TcpControlBits.Acknowledgment:</p><p>Utils.PacketInfoPrinter(packet);</p><p>break;</p><p>default:</p><p>Utils.PacketInfoPrinter(packet);</p><p>break;</p><p>}</p><p>}</p><p>else</p><p>{</p><p>switch (packet.Ethernet.IpV4.Tcp.ControlBits)</p><p>{</p><p>case (TcpControlBits.Fin | TcpControlBits.Acknowledgment):</p><p>Utils.PacketInfoPrinter(packet);</p><p>break;</p><p>case TcpControlBits.Synchronize:</p><p>Utils.PacketInfoPrinter(packet);</p><p>break;</p><p>case TcpControlBits.Acknowledgment:</p><p>Utils.PacketInfoPrinter(packet);</p><p>running = false;</p><p>break;</p><p>default:</p><p>Utils.PacketInfoPrinter(packet);</p><p>break;</p><p>}</p><p>}</p><p>break;</p><p>default:</p><p>throw new InvalidOperationException("The result " + result + " should never be reached here");</p><p>}</p><p>} while (running);</p><p>}</p><p>åœ¨PacketHandlerå‡½æ•¸ä¸­ç”¨åˆ°äº†BuildTcpResponsePacketé€™å€‹å‡½æ•¸ï¼Œé€™å€‹å‡½æ•¸æ ¹æ“šæ”¶åˆ°çš„TCPåŒ…ï¼Œä¾†æ§‹å»ºresponseåŒ…ã€‚</p><p>é€™å€‹å‡½æ•¸æœ‰ä¸‹é¢å¹¾å€‹æ³¨æ„é»ï¼š</p><ul><li>è©²å‡½æ•¸æœƒæ ¹æ“šæ”¶åˆ°çš„åŒ…ï¼Œè¨­ç½®responseåŒ…çš„æºå’Œç›®çš„åœ°å€</li><li>è©²å‡½æ•¸æœƒæ¥å—PacketHandlerå‚³éä¾†çš„TCP flagsï¼Œä¸¦è¨­ç½®åˆ°TCPé¦–éƒ¨ä¸­</li><li>è©²å‡½æ•¸çš„å¦ä¸€å€‹é‡è¦éƒ¨åˆ†å°±æ˜¯æœƒè¨ˆç®—ä¸¦è¨­ç½®TCPé¦–éƒ¨ä¸­çš„seqè™Ÿackè™Ÿï¼Œé€™ä¸€é»å¾ˆé‡è¦</li></ul><p>public static Packet BuildTcpResponsePacket(Packet packet, TcpControlBits tcpControlBits)</p><p>{</p><p>EthernetLayer ethernetHeader = new EthernetLayer</p><p>{</p><p>Source = new MacAddress(packet.Ethernet.Destination.ToString()),</p><p>Destination = new MacAddress(packet.Ethernet.Source.ToString()),</p><p>EtherType = EthernetType.None, // Will be filled automatically.</p><p>};</p><p>IpV4Layer ipHeader = new IpV4Layer</p><p>{</p><p>Source = new IpV4Address(packet.Ethernet.IpV4.Destination.ToString()),</p><p>CurrentDestination = new IpV4Address(packet.Ethernet.IpV4.Source.ToString()),</p><p>Fragmentation = IpV4Fragmentation.None,</p><p>HeaderChecksum = null, // Will be filled automatically.</p><p>Identification = 123,</p><p>Options = IpV4Options.None,</p><p>Protocol = null, // Will be filled automatically.</p><p>Ttl = 100,</p><p>TypeOfService = 0,</p><p>};</p><p>TcpLayer tcpHeader = new TcpLayer</p><p>{</p><p>SourcePort = packet.Ethernet.IpV4.Tcp.DestinationPort,</p><p>DestinationPort = packet.Ethernet.IpV4.Tcp.SourcePort,</p><p>Checksum = null, // Will be filled automatically.</p><p>SequenceNumber = seqNum = packet.Ethernet.IpV4.Tcp.AcknowledgmentNumber,</p><p>AcknowledgmentNumber = ackNum = packet.Ethernet.IpV4.Tcp.SequenceNumber + (uint)((packet.Ethernet.IpV4.Tcp.Payload.Length > 0) ? packet.Ethernet.IpV4.Tcp.Payload.Length : 1),</p><p>ControlBits = tcpControlBits,</p><p>Window = windowSize,</p><p>UrgentPointer = 0,</p><p>Options = TcpOptions.None,</p><p>};</p><p>PacketBuilder builder = new PacketBuilder(ethernetHeader, ipHeader, tcpHeader);</p><p>return builder.Build(DateTime.Now);</p><p>}</p><h1>é‹è¡Œæ•ˆæœ</h1><p>æ‰“é–‹Wiresharkç›£è½"VirtualBox Host-Only Network"ç¶²å¡ï¼Œä¸¦è¨­ç½®filterç‚º"port 8081"ã€‚</p><p>ç„¶å¾Œé‹è¡Œç¨‹åºï¼Œé€šéconsoleå¯ä»¥çœ‹åˆ°å®¢æˆ¶ç«¯ç™¼é€çš„åŒ…ï¼Œä»¥åŠæœå‹™ç«¯è¿”å›çš„åŒ…ï¼Œé€šéé€™äº›åŒ…å®Œæˆäº†TCPé€£æ¥çš„å»ºç«‹å’Œçµ‚æ­¢ã€‚</p><div class=pgc-img><img alt=å‹•æ‰‹å­¸ç¿’TCPï¼šTCPé€£æ¥å»ºç«‹èˆ‡çµ‚æ­¢ï¼Œå®ƒæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­° onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/22a89c80460443b3889c134c8d43e75a></div><p>ä¸‹é¢æ˜¯Wiresharkä¸­é¡¯ç¤ºçš„çµæœï¼ŒWiresharkæ¯”è¼ƒå‹å¥½ï¼Œæœƒé¡¯ç¤ºç›¸å°seqè™Ÿï¼Œæ‰€ä»¥çœ‹åˆ°çš„éƒ½æ˜¯å¾0é–‹å§‹ç·¨è™Ÿã€‚</p><p>æ³¨æ„seqè™Ÿå’Œackè™Ÿçš„è®ŠåŒ–ï¼Œ[SYN]å’Œ[FIN]æ¨™èªŒçš„TCPåŒ…éƒ½æœƒæ¶ˆè€—ä¸€å€‹åºè™Ÿã€‚</p><div class=pgc-img><img alt=å‹•æ‰‹å­¸ç¿’TCPï¼šTCPé€£æ¥å»ºç«‹èˆ‡çµ‚æ­¢ï¼Œå®ƒæ˜¯ä¸€å€‹é¢å‘é€£æ¥çš„å”è­° onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2a16e7e8b6d4497bbe1b7c3841e6a89d></div><h1>ç¸½çµ</h1><p>æœ¬æ–‡ä»‹ç´¹äº†TCPé¦–éƒ¨ï¼Œé€šéè¨­ç½®TCPé¦–éƒ¨ä¸­çš„[SYN]æ¨™èªŒï¼Œå¯ä»¥æ§‹é€ TCPé€£æ¥å»ºç«‹è«‹æ±‚åŒ…ï¼›é€šéè¨­ç½®[FIN]æ¨™èªŒï¼Œå¯ä»¥æ§‹é€ TCPé€£æ¥çµ‚æ­¢è«‹æ±‚åŒ…ã€‚</p><p>æ–‡ä¸­ä½¿ç”¨Pcap.Netæ§‹å»ºäº†ä¸€å€‹ç°¡å–®çš„å®¢æˆ¶ç«¯ï¼Œå®Œæˆäº†å‘æœå‹™å™¨å»ºç«‹ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰å’Œçµ‚æ­¢ï¼ˆå››æ¬¡æ®æ‰‹ï¼‰é€£æ¥çš„éç¨‹ã€‚</p><p>é€šéé€™å€‹å¯¦é©—ï¼Œä¸€å®šæœƒå°TCPé€£æ¥çš„å»ºç«‹å’Œçµ‚æ­¢æœ‰ä¸€å€‹æ¯”è¼ƒç›´è§€çš„èªè­˜ã€‚</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>TCP</a></li><li><a>é€£æ¥</a></li><li><a>å‹•æ‰‹</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/522b6842.html alt=TCPç‚ºä»€éº¼å»ºç«‹é€£æ¥éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œè€Œæ–·é–‹é€£æ¥å‰‡éœ€è¦å››æ¬¡ï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c07e68d15eb44728a2a07eed84b29ed5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/522b6842.html title=TCPç‚ºä»€éº¼å»ºç«‹é€£æ¥éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œè€Œæ–·é–‹é€£æ¥å‰‡éœ€è¦å››æ¬¡ï¼Ÿ>TCPç‚ºä»€éº¼å»ºç«‹é€£æ¥éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œè€Œæ–·é–‹é€£æ¥å‰‡éœ€è¦å››æ¬¡ï¼Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/717b53a.html alt=é—œæ–¼TCPçš„åŸºæ–¼é€£æ¥å’ŒUDPçš„ç„¡é€£æ¥æœ€é€šä¿—çš„è§£é‡‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/4346000190e67e8679a4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/717b53a.html title=é—œæ–¼TCPçš„åŸºæ–¼é€£æ¥å’ŒUDPçš„ç„¡é€£æ¥æœ€é€šä¿—çš„è§£é‡‹>é—œæ–¼TCPçš„åŸºæ–¼é€£æ¥å’ŒUDPçš„ç„¡é€£æ¥æœ€é€šä¿—çš„è§£é‡‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ae238299.html alt=é«˜å±¤é‹¼çµæ§‹æ¨‘èˆ‡æŸ±çš„é€£æ¥ç¯€é»èˆ‡è¨ˆç®—é©—ç®— class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/e976358e501d4dc0917c60b90f6a7cfb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ae238299.html title=é«˜å±¤é‹¼çµæ§‹æ¨‘èˆ‡æŸ±çš„é€£æ¥ç¯€é»èˆ‡è¨ˆç®—é©—ç®—>é«˜å±¤é‹¼çµæ§‹æ¨‘èˆ‡æŸ±çš„é€£æ¥ç¯€é»èˆ‡è¨ˆç®—é©—ç®—</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4449cb61.html alt=é‹¼çµæ§‹å·¥ç¨‹çš„æ°´å¹³åŠ å‹è‚‹å¦‚ä½•é€£æ¥è¨­ç½® class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/59abdca6f05e4015ac29f938dc07ef0f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4449cb61.html title=é‹¼çµæ§‹å·¥ç¨‹çš„æ°´å¹³åŠ å‹è‚‹å¦‚ä½•é€£æ¥è¨­ç½®>é‹¼çµæ§‹å·¥ç¨‹çš„æ°´å¹³åŠ å‹è‚‹å¦‚ä½•é€£æ¥è¨­ç½®</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8860a0b7.html alt=é‹¼çµæ§‹æ¨‘æŸ±é€£æ¥ç¯€é»æ§‹é€ è©³è§£ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8ded2130dce04921b14b52574828903d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8860a0b7.html title=é‹¼çµæ§‹æ¨‘æŸ±é€£æ¥ç¯€é»æ§‹é€ è©³è§£>é‹¼çµæ§‹æ¨‘æŸ±é€£æ¥ç¯€é»æ§‹é€ è©³è§£</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/930d4222.html alt=é€£æ¥è®Šé€Ÿç®±å’Œé©…å‹•æ©‹å…¨é å®ƒï¼Œé‡å¡å‚³å‹•è»¸é€™äº›å¸¸è¦‹æ•…éšœä½ ç­è§£å—ï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4307dc4471e440f8a7d7ecde585f6165 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/930d4222.html title=é€£æ¥è®Šé€Ÿç®±å’Œé©…å‹•æ©‹å…¨é å®ƒï¼Œé‡å¡å‚³å‹•è»¸é€™äº›å¸¸è¦‹æ•…éšœä½ ç­è§£å—ï¼Ÿ>é€£æ¥è®Šé€Ÿç®±å’Œé©…å‹•æ©‹å…¨é å®ƒï¼Œé‡å¡å‚³å‹•è»¸é€™äº›å¸¸è¦‹æ•…éšœä½ ç­è§£å—ï¼Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/78c87167.html alt=å¥§è¿ªA7è»Šè¼‰é›»è·¯èˆ‡ç¶²çµ¡é€£æ¥ä¹‹ç¶²çµ¡é€£æ¥ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d34213e3b03545bd8e87ab074b54ca0f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/78c87167.html title=å¥§è¿ªA7è»Šè¼‰é›»è·¯èˆ‡ç¶²çµ¡é€£æ¥ä¹‹ç¶²çµ¡é€£æ¥>å¥§è¿ªA7è»Šè¼‰é›»è·¯èˆ‡ç¶²çµ¡é€£æ¥ä¹‹ç¶²çµ¡é€£æ¥</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9334bf46.html alt=ç„¡ç·šç¶²æ©‹çš„é€£æ¥æ–¹å¼æœ‰å“ªäº›ï¼Ÿå¤šæ¢å¯¬å¸¶å¦‚ä½•ç–ŠåŠ ï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/37716df4aae74dea9be705ae817bbfec style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9334bf46.html title=ç„¡ç·šç¶²æ©‹çš„é€£æ¥æ–¹å¼æœ‰å“ªäº›ï¼Ÿå¤šæ¢å¯¬å¸¶å¦‚ä½•ç–ŠåŠ ï¼Ÿ>ç„¡ç·šç¶²æ©‹çš„é€£æ¥æ–¹å¼æœ‰å“ªäº›ï¼Ÿå¤šæ¢å¯¬å¸¶å¦‚ä½•ç–ŠåŠ ï¼Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/441e32c5.html alt=æ“°ç·Šå¾®èª²å ‚ï½œæ“°ç·Šç­–ç•¥â€”â€”èºæ “é€£æ¥çš„åˆ†é¡ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1529806969192cd5df56477 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/441e32c5.html title=æ“°ç·Šå¾®èª²å ‚ï½œæ“°ç·Šç­–ç•¥â€”â€”èºæ “é€£æ¥çš„åˆ†é¡>æ“°ç·Šå¾®èª²å ‚ï½œæ“°ç·Šç­–ç•¥â€”â€”èºæ “é€£æ¥çš„åˆ†é¡</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6ee693cf.html alt=æ±½è»Šç·Šå›ºå¤¾ç·ŠåŠ›é€£æ¥èˆ‡æµ®å‹•é€£æ¥æ–¹å¼ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/53e4c792b9574a9d8de76618044346f4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6ee693cf.html title=æ±½è»Šç·Šå›ºå¤¾ç·ŠåŠ›é€£æ¥èˆ‡æµ®å‹•é€£æ¥æ–¹å¼>æ±½è»Šç·Šå›ºå¤¾ç·ŠåŠ›é€£æ¥èˆ‡æµ®å‹•é€£æ¥æ–¹å¼</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/74139071.html alt=ç›´èºç´‹é‹¼ç­‹é€£æ¥æŠ€è¡“äº¤åº• class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/d79599de2d2c4a5bb9751057c007c971 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/74139071.html title=ç›´èºç´‹é‹¼ç­‹é€£æ¥æŠ€è¡“äº¤åº•>ç›´èºç´‹é‹¼ç­‹é€£æ¥æŠ€è¡“äº¤åº•</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6783c3dc.html alt=èºç´‹é€£æ¥å¤±æ•ˆå½¢å¼åŠå…¶æ§åˆ¶æ–¹æ³• class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4f0664ec369740f996df1648ec98832f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6783c3dc.html title=èºç´‹é€£æ¥å¤±æ•ˆå½¢å¼åŠå…¶æ§åˆ¶æ–¹æ³•>èºç´‹é€£æ¥å¤±æ•ˆå½¢å¼åŠå…¶æ§åˆ¶æ–¹æ³•</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e8831f2f.html alt=é‹¼ç­‹ç›´èºç´‹å¥—ç­’é€£æ¥æ–½å·¥å·¥è—æ¨™æº– class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/046c5f17712e498fb4d86c4bb55ca656 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e8831f2f.html title=é‹¼ç­‹ç›´èºç´‹å¥—ç­’é€£æ¥æ–½å·¥å·¥è—æ¨™æº–>é‹¼ç­‹ç›´èºç´‹å¥—ç­’é€£æ¥æ–½å·¥å·¥è—æ¨™æº–</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bbcbc39b.html alt=é‹¼çµæ§‹èºæ “é€£æ¥è¨­è¨ˆä»¥åŠå‹•ä½œæ•ˆæœè¦æ±‚ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15369699652450943fcede0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bbcbc39b.html title=é‹¼çµæ§‹èºæ “é€£æ¥è¨­è¨ˆä»¥åŠå‹•ä½œæ•ˆæœè¦æ±‚>é‹¼çµæ§‹èºæ “é€£æ¥è¨­è¨ˆä»¥åŠå‹•ä½œæ•ˆæœè¦æ±‚</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0d267808.html alt=ä½ çŸ¥é“èºæ “çš„é€£æ¥åŸç†å—ï¼Ÿå¿«æ‰“é–‹ä¾†çœ‹ä¸€çœ‹å§ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/363b47db6ac14a48b5857f75eae98b00 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0d267808.html title=ä½ çŸ¥é“èºæ “çš„é€£æ¥åŸç†å—ï¼Ÿå¿«æ‰“é–‹ä¾†çœ‹ä¸€çœ‹å§>ä½ çŸ¥é“èºæ “çš„é€£æ¥åŸç†å—ï¼Ÿå¿«æ‰“é–‹ä¾†çœ‹ä¸€çœ‹å§</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>