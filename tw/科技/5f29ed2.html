<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>高性能線程間消息傳遞庫Disruptor | 极客快訊</title><meta property="og:title" content="高性能線程間消息傳遞庫Disruptor - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/37450e36f66249f7b616999d755f7317"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5f29ed2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5f29ed2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5f29ed2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5f29ed2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5f29ed2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5f29ed2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/5f29ed2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/5f29ed2.html><meta property="article:published_time" content="2020-10-29T21:04:29+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:29+08:00"><meta name=Keywords content><meta name=description content="高性能線程間消息傳遞庫Disruptor"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/5f29ed2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>高性能線程間消息傳遞庫Disruptor</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1><strong>一、概述</strong></h1><p>LMAX Disruptor是一個高性能的線程間消息傳遞庫。它源於LMAX對併發性，性能和非阻塞算法的研究，如今構成了其Exchange基礎架構的核心部分。</p><p>理解Disruptor是什麼的最好方法是將它與目前已經的很好理解和非常相似的東西進行比較，例如與Java的BlockingQueue進行對比。與隊列一樣，Disruptor的目的是在同一進程內的線程之間移動數據（例如消息或事件）。但是，Disruptor相比隊列提供了一些關鍵功能，它們是：</p><ul><li>同一個消息會向所有消費者都發送-多播能力，與消費者依賴圖有關（Multicast events to consumers, with consumer dependency graph）。</li><li>為事件（events）預先分配內存，避免gc與內存分配開銷。</li><li>可選擇無鎖(lock-free)，基於CAS多個生產者不會競爭通一個元素，實現無鎖操作元素。</li><li>緩存行填充，避免偽共享</li><li>使用兩階段協議，讓多個線程可用同時修改不同元素，注意，讀取時候只能讀取到先提交的元素。</li></ul><h1><strong>二、核心概念</strong></h1><p>在我們理解Disruptor如何工作前，我們先看看Disruptor中的核心術語的介紹，或者說是DDD中描述的域對象</p><ul><li>Ring Buffer: 環形緩衝區通常被認為是Disruptor的核心，但是從3.0開始，Ring Buffer僅負責存儲和更新通過Disruptor的數據（事件）。對於一些高級用例，可以完全由用戶替換。</li><li>Sequence: Disruptor使用Sequences作為識別特定組件所在位置的方法。每個消費者（EventProcessor）都像Disruptor本身一樣維護一個Sequence。大多數併發代碼依賴於這些Sequence值的移動，因此Sequence支持AtomicLong的許多當前功能。事實上，3版本與2之間唯一真正的區別是序列包含額外的功能，以防止Sequence和其他值之間出現偽共享。</li><li>Sequencer: Sequencer是Disruptor的真正核心。該接口的2個實現（單生產者，多生產者）實現了所有併發算法，用於在生產者和消費者之間快速，正確地傳遞數據。</li><li>Sequence Barrier: 序列屏障（Sequence Barrier）由Sequencer產生，幷包含對Sequencer中主要發佈的序列Sequence和任何依賴消費者的序列Sequence的引用。它包含確定是否有任何可供消費者處理的事件的邏輯。</li><li>Wait Strategy: 等待策略，確定消費者如何等待生產者將事件放入Disruptor。</li><li>Event: 從生產者傳遞給消費者的數據單位。事件沒有特定的代碼表示，因為它完全由用戶定義。</li><li>EventProcessor: 用於處理來自Disruptor的事件的主事件循環，並擁有消費者序列的所有權。有一個名為BatchEventProcessor的實現，它包含事件循環的有效實現，並將回調到使用的提供的EventHandler接口實現（在線程池內運行BatchEventProcessor的run方法）。</li><li>EventHandler: 由用戶實現並代表Disruptor的消費者的接口。</li><li>Producer: 調用Disruptor以將事件放入隊列的用戶代碼。這個概念在代碼中也沒有表示。</li></ul><p>為了將這些元素置於上下文中，下面是LMAX如何在其高性能核心服務中使用Disruptor的示例，例如：exchange(交易系統)。如下圖Disruptor和其一系列依賴的消費者。</p><div class=pgc-img><img alt=高性能線程間消息傳遞庫Disruptor onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/37450e36f66249f7b616999d755f7317><p class=pgc-img-caption></p></div><p>c1,c2對同一個元素處理完畢後在進行c3處理。</p><p>每個消費者持有自己的當前消費序號，寫入時候要看序號最小的消費者序號，c3消費時候要看c1,c2最小的序號。</p><p>每個EventHandler被包裹到對於的BatchEventProcessor中，BatchEventProcessor是一個事件處理循環，類似NIOevenloop,每個BatchEventProcessor被分到線程池裡面一個固定線程來執行。BatchEventProcessor發現後可用元素後，就調用EventHandler發射出元素。</p><div class=pgc-img><img alt=高性能線程間消息傳遞庫Disruptor onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a3d4c9dcdbe643808651169d63be83cf><p class=pgc-img-caption></p></div><p>如上圖c1,c2,c3共享同一個ringbuffer，讀寫都是同一個ringbuffer.</p><p>如上圖c1,c2（EventHandler）分別被自己的BatchEventProcessor包裹，但是其共享同一個SequenceBarrier，c1,c2讀取元素時候要調用EventHandler的waitfor來判斷是否有可以讀取的元素。</p><p>c3被自己的BatchEventProcessor包裹，其有自己的SequenceBarrier，並且持有其依賴的前面的所有消費者的引用。</p><p>c3消費元素時候要看其依賴的所有消費者，看其是否都消費了某一個元素，如果是其才可以消費。</p><h1><strong>三、多播事件-Multicast Events</strong></h1><p>這是Java中隊列和Disruptor之間最大的行為差異。當您有多個消費者在同一個Disruptor上監聽事件時候，所有事件都會發布給所有消費者，而Java隊列中的每個事件只會發送給某一個消費者。 Disruptor的行為旨在用於需要對同一數據進行獨立的多個並行操作的情況。來自LMAX的規範示例是我們有三個操作，即日誌記錄（將輸入數據寫入持久性日誌文件），複製（將輸入數據發送到另一臺機器以確保存在數據的遠程副本）和業務邏輯（真正的處理工作）。</p><p>使用WorkerPool也可以執行Executor樣式的事件處理，其中通過並行處理不同事件來實現可伸縮。請注意，它是在現有的Disruptor類之上進行的，並且不會使用相同的第一類支持進行處理，因此它可能不是實現該特定目標的最有效方法。</p><p>查看圖1.可以看到有3個事件處理程序監聽（JournalConsumer，ReplicationConsumer和ApplicationConsumer）到Disruptor，這些事件處理程序中的每一個都將接收Disruptor中可用的所有消息（按相同的順序）。這允許每個消費者的工作並行運行。</p><h1><strong>四、消費者依賴圖-Consumer Dependency Graph</strong></h1><p>為了支持並行處理行為的實際應用，有必要支持消費者之間的協調。返回參考上述示例，必須防止業務邏輯消費者在日記和複製消費者完成其任務之前取得進展。我們稱這個概念為門控gating，或者更準確地說，這種行為的超集特徵稱為門控。門控發生在兩個地方。首先，我們需要確保生產者不會超過消費者。這是通過RingBuffer.addGatingConsumers（）將相關的消費者添加到Disruptor來處理的。其次，先前提到的情況是通過構造一個SequenceBarrier，其包含組元的Sequences，其必須首先完成他們的處理</p><p>參考圖1，有3個消費者正在監聽來自Ring Buffer的事件。此示例中有一個依賴關係圖。 ApplicationConsumer依賴於JournalConsumer和ReplicationConsumer。這意味著JournalConsumer和ReplicationConsumer可以彼此並行自由運行。從ApplicationConsumer的SequenceBarrier到JournalConsumer和ReplicationConsumer的序列的連接可以看到依賴關係。值得注意的是Sequencer與下游消費者之間的關係。它的一個作用是確保發佈不包裝Ring Buffer。要做到這一點，下游消費者中沒有一個可能具有低於環形緩衝區序列的序列，而不是環形緩衝區的大小。但是，使用依賴關係圖可以進行有趣的優化。由於ApplicationConsumers Sequence保證小於或等於JournalConsumer和ReplicationConsumer（這是該依賴關係所確保的），因此Sequencer只需要查看ApplicationConsumer的Sequence。在更一般的意義上，Sequencer只需要知道作為依賴關係樹中葉節點的使用者的序列。</p><h1><strong>五、事件預分配-Event Preallocation</strong></h1><p>Disruptor的目標之一是在低延遲環境中使用。在低延遲系統中，必須減少或移除內存分配。在基於Java的系統中，目的是減少由於垃圾收集導致的系統停頓（在低延遲C / C ++系統中，由於存在於內存分配器上的爭用，大量內存分配也存在問題）。</p><p>為了支持這一點，用戶可以預先分配Disruptor中事件所需的存儲空間。在構造期間，EventFactory由用戶提供，並將在Disruptor的Ring Buffer中為每個條目調用。將新數據發佈到Disruptor時，API將允許用戶獲取構造的對象，以便他們可以調用方法或更新該存儲對象上的字段。 Disruptor保證這些操作只要正確實現就是併發安全的。</p><h1><strong>六、可選的無鎖-Optionally Lock-free</strong></h1><p>低延遲期望推動的另一個關鍵實現細節是廣泛使用無鎖算法來實現Disruptor。所有內存可見性和正確性保證都是使用內存屏障（體現為volatile）和/或CAS操作實現的。只有一個情況需要實際鎖定並且在BlockingWaitStrategy中。這僅僅是為了使用條件變量，以便在等待新事件到達時前parked消費線程。許多低延遲系統將使用忙等待busy-wait 來避免使用條件可能引起的抖動，但是大量在系統繁忙等待的操作可能導致性能顯著下降，尤其是在CPU資源嚴重受限的情況下。例如。虛擬化環境中的Web服務器。</p><div class=tt-column-card data-content='{"new_thumb_url": "http://sf1-ttcdn-tos.pstatp.com/img/pgc-image/156154482609605e3db01c4", "title": "\u5206\u5e03\u5f0fRPC\u6846\u67b6Dubbo\u5185\u6838\u539f\u7406\u5256\u6790", "distribution_user_id": 1624358660504589, "price": 29.9, "column_id": "6706788500336804110", "share_price": 2.39, "author_description": "\u683c\u5c40\u591a", "thumb_url": "http://p7.pstatp.com/large/pgc-image/156154482609605e3db01c4", "sold": 31}'></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>線程間</a></li><li><a>傳遞</a></li><li><a>Disruptor</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/5df1266.html alt=高性能線程間消息傳遞庫Disruptor概述 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/258a533914264f00a8d1cea6e202284b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5df1266.html title=高性能線程間消息傳遞庫Disruptor概述>高性能線程間消息傳遞庫Disruptor概述</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2186376d.html alt=茶人樸素思想：歸真生活，傳遞能量 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/1c6500029bd29fefd470 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2186376d.html title=茶人樸素思想：歸真生活，傳遞能量>茶人樸素思想：歸真生活，傳遞能量</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3e8e1144.html alt=榜樣力量，傳遞房有道優秀正能量！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/152489945116301e19f64c3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3e8e1144.html title=榜樣力量，傳遞房有道優秀正能量！>榜樣力量，傳遞房有道優秀正能量！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/54e16615.html alt=念念分享｜古代書信的傳遞方式和禮儀格式，乾貨收藏！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15296378197524515bbfcfd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/54e16615.html title=念念分享｜古代書信的傳遞方式和禮儀格式，乾貨收藏！>念念分享｜古代書信的傳遞方式和禮儀格式，乾貨收藏！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/acfb9119.html alt=C++向函數傳遞參數的三種方式：傳值、指針、引用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/80f1df27-02c4-45cc-a3ff-bd6923e864f8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/acfb9119.html title=C++向函數傳遞參數的三種方式：傳值、指針、引用>C++向函數傳遞參數的三種方式：傳值、指針、引用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e2f0d3b3.html alt=C｜從形參與實參的內存地址區別值傳遞與址傳遞 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e2f0d3b3.html title=C｜從形參與實參的內存地址區別值傳遞與址傳遞>C｜從形參與實參的內存地址區別值傳遞與址傳遞</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b1d3de7a.html alt=在Python中如何傳遞任意數量的實參 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/6d9e31fb31954359a87e5f10805c146b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b1d3de7a.html title=在Python中如何傳遞任意數量的實參>在Python中如何傳遞任意數量的實參</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/68200806.html alt=面試官：兄弟，說說Java到底是值傳遞還是引用傳遞 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8427a88278d4440e90b95ad363ecad34 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/68200806.html title=面試官：兄弟，說說Java到底是值傳遞還是引用傳遞>面試官：兄弟，說說Java到底是值傳遞還是引用傳遞</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d2e58c38.html alt=人際關係信息的效果傳遞|語言溝通與非語言溝通行為 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/43839ddcfd834f65a905c74d87188bbe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d2e58c38.html title=人際關係信息的效果傳遞|語言溝通與非語言溝通行為>人際關係信息的效果傳遞|語言溝通與非語言溝通行為</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/52728d4b.html alt="鋪就仁愛之路 傳遞慈善之光——北京市仁愛慈善基金會“淶水送溫暖”活動側記" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/53010015f4757e7bebce style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/52728d4b.html title="鋪就仁愛之路 傳遞慈善之光——北京市仁愛慈善基金會“淶水送溫暖”活動側記">鋪就仁愛之路 傳遞慈善之光——北京市仁愛慈善基金會“淶水送溫暖”活動側記</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/27a6a0cd.html alt=下肢力學的“傳遞者”股四頭肌 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/6ad417bb-6958-4607-9fd3-6ff71b8f546c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/27a6a0cd.html title=下肢力學的“傳遞者”股四頭肌>下肢力學的“傳遞者”股四頭肌</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/b88848ef.html alt=傳遞愛和溫暖，李喆將第一手下在這兒 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/18bf569b403e493ca5c69d319e8a3038 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/b88848ef.html title=傳遞愛和溫暖，李喆將第一手下在這兒>傳遞愛和溫暖，李喆將第一手下在這兒</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/3b565bd0.html alt="濰坊公交：拾金不昧好榜樣 傳遞社會正能量" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/S1yPRJ6HNCqgh0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/3b565bd0.html title="濰坊公交：拾金不昧好榜樣 傳遞社會正能量">濰坊公交：拾金不昧好榜樣 傳遞社會正能量</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5f60ae3c.html alt=java中，可以通過傳遞超類方法中使用的參數的子類來覆蓋方法嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/2befa93523904481ada1fe7a1df6f511 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5f60ae3c.html title=java中，可以通過傳遞超類方法中使用的參數的子類來覆蓋方法嗎？>java中，可以通過傳遞超類方法中使用的參數的子類來覆蓋方法嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8d3ba864.html alt="九江小夥一次跨越大洋的愛心傳遞 與法國危重患者配型成功" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/de7cc1649cce4ee7afe968be480f1da8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8d3ba864.html title="九江小夥一次跨越大洋的愛心傳遞 與法國危重患者配型成功">九江小夥一次跨越大洋的愛心傳遞 與法國危重患者配型成功</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>