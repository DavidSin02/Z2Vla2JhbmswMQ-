<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>WordPress 5.0.0 曝出遠程代碼執行 | 极客快訊</title><meta property="og:title" content="WordPress 5.0.0 曝出遠程代碼執行 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/6c8d00b0d4dd4cc0bd38c4689c70d5c2"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/663853d.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/663853d.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/663853d.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/663853d.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/663853d.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/663853d.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/663853d.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/663853d.html><meta property="article:published_time" content="2020-10-29T21:08:07+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:07+08:00"><meta name=Keywords content><meta name=description content="WordPress 5.0.0 曝出遠程代碼執行"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/663853d.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>WordPress 5.0.0 曝出遠程代碼執行</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p class=ql-align-center><br></p><div class=pgc-img><img alt="WordPress 5.0.0 曝出遠程代碼執行" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6c8d00b0d4dd4cc0bd38c4689c70d5c2><p class=pgc-img-caption></p></div><p>近期，外網的RIPSTECH安全研究人員曝出WordPress的遠程代碼執行，是通過目錄遍歷和本地文件包含這兩個漏洞組合而成。這個漏洞在WordPress的核心代碼中存在時間超過了6年。</p><h1>影響</h1><div class=pgc-img><img alt="WordPress 5.0.0 曝出遠程代碼執行" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3c1668ac44944fcfaafe8647cb6e8509><p class=pgc-img-caption></p></div><p>要利用這個漏洞，攻擊者必須在目標站點擁有author權限，能夠登錄後臺。而RIPSTECH同時也表示，他們還發現了一個WordPress的權限漏洞，能夠使任何人登錄到WordPress網站，目前該漏洞還沒披露。</p><p>相關視頻：https://v.youku.com/v_show/id_XNDA3MTY2MDU1Ng==.html?spm=a2h3j.8428770.3416059.1</p><h1>版本號</h1><p>目前只有5.0.0受影響，4.9.9和5.0.1版本中的某一個安全補丁使該漏洞無效，但目錄遍歷漏洞依然存在。</p><p>但是，如果WordPress站點上的某個插件沒有正確處理Post me ta，都有可能使網站不安全。而在過去的幾個月內，RIPSTECH已經觀測有數百萬活躍量的插件存在這種問題。</p><p>而根據WordPress下載頁面的數據，約有33%的網站使用了該插件。綜合考慮，潛在的受到該漏洞影響的網站的數量級為百萬。</p><h1>背景</h1><p>當圖像上傳到WordPress時，首先會保存到wp-content/uploads。WordPress同時也會在數據庫中創建和保存圖像的內部引用，以記錄跟蹤圖片元信息，如上傳時間等。</p><p>此元信息在數據庫中作為Post me ta進行存儲。每一條都是一個鍵值對，分配一個特定的ID。</p><pre>Example Post me ta reference to an uploaded image ‘evil.jpg’MariaDB [wordpress]&gt; SELECT * FROM wp_postme ta WHERE post_ID = 50;+---------+-------------------------+----------------------------+| post_id | me ta_key| me ta_value |+---------+-------------------------+----------------------------+| 50 | _wp_attached_file | evil.jpg || 50 | _wp_attachment_me tadata | a:5:{s:5:"width";i:450 ... |...+---------+-------------------------+----------------------------+</pre><p>在上面的例子中，圖像被分配post_ID50。如果用戶希望使用或編輯該圖像，WordPress將在wp-content/uploads文件夾下查找數據庫中_wp_attached_file值所對應的圖片。</p><p>核心問題-Post me ta會被覆蓋</p><p>WordPress 4.9.9和5.0.1之前的版本中的這些Post me ta的問題在於可以被修改為任意值。</p><p>當圖像的相關信息被更新（例如，它的描述被更改）時，將調用edit_post()函數。而此函數直接作用於$_POST數組。</p><pre>function edit_post( $post_data = null ) { if ( empty($postarr) ) $postarr = &amp;$_POST; ⋮ if ( ! empty( $postarr['me ta_input'] ) ) { foreach ( $postarr['me ta_input'] as $field =&gt; $value ) { update_post_me ta( $post_ID, $field, $value ); } }</pre><p>從上可以看到，你可以注入任何數據到Post me ta，並且沒有安全檢查。所以攻擊者可以更新_wp_attached_file的值。由於WordPress處理圖像時並不會重命名文件，只會更改文件。這就將導致稍後介紹的目錄遍歷。</p><p>通過修改Post me ta進行目錄遍歷</p><p>目錄遍歷發生在wp_crop_image()函數中，該函數用於裁剪圖像。</p><p>當該函數運行時，需要輸入圖像的ID（$attachment_id），並從數據庫中獲取相應的_wp_attached_file。</p><p>但是，由於edit_post()的缺陷，$src_file可以被設為任何值。</p><pre>function wp_crop_image( $attachment_id, $src_x, ...) { $src_file = $file = get_post_me ta( $attachment_id, '_wp_attached_file' ); ⋮</pre><p>下一步中，WordPress必須確保圖像存在並加載它。WordPress有兩種加載圖像的方法。第一種方法是簡單的在wp-content/uploads目錄查找由_wp_attached_file所規定的文件名。</p><p>如果該方法失敗，WordPress將嘗試從自己的服務器下載圖像。為此，它將生成一個下載URL，並且包含wp-content/uploads和_wp_attached_file的值。</p><p>舉個例子：如果存儲在_wp_attached_file的值為evil.jpg，那麼Wordpress將首先尋找文件wp-content/uploads/evil.jpg；如果找不到，它將嘗試從以下URL下載文件：https://targetserver.com/wp-content/uploads/evil.jpg</p><p>嘗試下載圖像而不是在本地查找圖像的原因是，當訪問特定URL時，某個插件可能會動態生成圖像。</p><p>請注意，這套流程無任何安全防護。WordPress只會將上傳目錄和用戶控制輸入$src_file連接起來。</p><p>一旦WordPress通過wp_get_image_editor()成功加載了一個有效的圖像，它就將裁剪該圖像。</p><pre> ⋮if ( ! file_exists( "wp-content/uploads/" . $src_file ) ) { // If the file doesn't exist, attempt a URL fopen on the src link. // This can occur with certain file replication plugins. $uploads = wp_get_upload_dir(); $src = $uploads['ba seurl'] . "/" . $src_file; } else { $src = "wp-content/uploads/" . $src_file; }$editor = wp_get_image_editor( $src );⋮ </pre><p>然後，被裁剪後的圖像被保存迴文件系統（不管它是否被下載），文件名是由攻擊者控制的$src_file。系統對文件名字符串所做的唯一修改是在文件名前加上cropped-。例如上文的evil.jpg，被裁剪後的文件名是cropped-evil.jpg。</p><p>接著，wordPress通過wp_mkdir_p()在目標路徑中創建新目錄。</p><p>最後使用圖像編輯的save()方法將其寫入文件系統。save()方法也無安全檢查。</p><pre>⋮$src = $editor-&gt;crop( $src_x, $src_y, $src_w, $src_h, $dst_w, $dst_h, $src_abs );$dst_file = str_replace( ba sename( $src_file ), 'cropped-' . ba sename( $src_file ), $src_file );wp_mkdir_p( dirname( $dst_file ) );$result = $editor-&gt;save( $dst_file );</pre><p>想法</p><p>雖然將文件加載到圖像編輯器中沒有執行任何安全檢查。但是，如果文件不是有效的圖像，圖像編輯器將觸發異常。第一個假設可行的攻擊手段是，裁剪不在上傳目錄的圖像。</p><p>如果WordPress沒有在上傳文件夾找到，就會試圖下載圖像，這就會導致遠程代碼執行。</p><div class=pgc-img><img alt="WordPress 5.0.0 曝出遠程代碼執行" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2c44357d568f4f1eab177926e43c8f20><p class=pgc-img-caption></p></div><p>將_wp_attached_file設置為evil.jpg?shell.php，這使WordPress會發出請求https://targetserver.com/wp-content/uploads/evil.jpg?shell.php。此請求將返回一個有效的圖像文件，文件名是evil.jpg?shell.php。</p><p>但是，儘管圖像編輯器的save()方法不會進行安全檢查，但它會將要加載的圖像的mime類型附加到新文件名中。在這種情況下，得到的文件名將是evil.jpg?cropped-shell.php.jpg。</p><p>當然，我們仍可以使用evil.jpg?/../../evil.jpg來將圖像保存在任何目錄。</p><h1>利用</h1><p>每個WordPress主題只位於WordPress的wp-content/themes目錄下的一個目錄。例如，如果博客訪問者想要查看博客文章，WordPress會在當前活動主題的目錄中查找post.php文件。如果找到模板，它將include()。</p><p>為了擁有額外的自定義內容，可能需要WordPress包含一個上傳的自定義模板。為此，用戶必須在數據庫中設置Post me ta中的_wp_page_template，例如文件名。這裡唯一的限制是要包含的文件必須位於當前活動主題的目錄中。</p><p>通常，用戶無法訪問此目錄，也無法上載任何文件。但是，通過利用上述目錄遍歷，就可以把包含惡意代碼的圖像放入當前使用主題的目錄中。然後，攻擊者使用前面的方法更改_wp_attached_file，以include()惡意圖像。最後，攻擊者成功進行任意遠程代碼。</p><p>製作惡意圖像-GD vs Imagick</p><p>WordPress支持兩個PHP圖像編輯擴展：GD和Imagick。它們之間的區別在於Imagick不會剝離圖像的exif元數據，而這其中可以存儲PHP代碼。GD會壓縮編輯每個圖像，並剝離所有exif元數據。</p><p>但是，通過製作包含精心製作的像素的圖像，仍然可以進行利用。在我們研究php的GD擴展的內部結構時，還在libgd中發現了一個內存破壞缺陷。（CVE-2019-69772）。</p><p>本文由白帽彙整理並翻譯，不代表白帽匯任何觀點和立場</p><p>來源：https://nosec.org/home/detail/2261.html</p><p>白帽匯從事信息安全，專注於安全大數據、企業威脅情報。</p><p>公司產品：FOFA-網絡空間安全搜索引擎、FOEYE-網絡空間檢索系統、NOSEC-安全訊息平臺。</p><p>為您提供：網絡空間測繪、企業資產收集、企業威脅情報、應急響應服務。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>WordPress</a></li><li><a>5.0</a></li><li><a>曝出</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/8b617d65.html alt=平行製造與工業5.0：從虛擬製造到智能製造 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3bb1de73f512485bad7f0bf25a4bc4ba style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8b617d65.html title=平行製造與工業5.0：從虛擬製造到智能製造>平行製造與工業5.0：從虛擬製造到智能製造</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/53fdfa30.html alt=WordPress主題添加菜單圖標圖文教程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5f5865b6e87a47ccb9581e87a8469dda style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/53fdfa30.html title=WordPress主題添加菜單圖標圖文教程>WordPress主題添加菜單圖標圖文教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fb0626d7.html alt="使用WordPress的Kyma plugin同Kyma斷開連接的實現" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/2af12909354143cabd587327cfc51f54 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fb0626d7.html title="使用WordPress的Kyma plugin同Kyma斷開連接的實現">使用WordPress的Kyma plugin同Kyma斷開連接的實現</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b88e65b8.html alt=曝氣池曝氣頭曝出的氣泡很大是什麼原因？點擊瞭解詳情 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4d64b883d77540388e242e7f8d2d3996 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b88e65b8.html title=曝氣池曝氣頭曝出的氣泡很大是什麼原因？點擊瞭解詳情>曝氣池曝氣頭曝出的氣泡很大是什麼原因？點擊瞭解詳情</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9f65cd4.html alt="WordPress緩存插件WP Super Cache下載和設置教程" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6e0f0609bd0c409799270440bccb70d9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9f65cd4.html title="WordPress緩存插件WP Super Cache下載和設置教程">WordPress緩存插件WP Super Cache下載和設置教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0a50522.html alt=四個大牌VPN被曝出cookie存儲不安全漏洞 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/53523d3880d54f06b7030523fe22dc5c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0a50522.html title=四個大牌VPN被曝出cookie存儲不安全漏洞>四個大牌VPN被曝出cookie存儲不安全漏洞</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/03be013.html alt=日本知名男星被曝出軌未成年，老婆身世淒涼惹人心疼 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b26e1bdcc894478c8a8af1ab759690d8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/03be013.html title=日本知名男星被曝出軌未成年，老婆身世淒涼惹人心疼>日本知名男星被曝出軌未成年，老婆身世淒涼惹人心疼</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4ab05af.html alt="許魏洲方曝出和節目組聊天記錄 力證護膝上有針" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153831833944571b47d1e8f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4ab05af.html title="許魏洲方曝出和節目組聊天記錄 力證護膝上有針">許魏洲方曝出和節目組聊天記錄 力證護膝上有針</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/06ae6df.html alt=央視曝出：中國第四代反隱身雷達亮相，美軍F22戰機將無處遁形 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3803e0611ccd4908a22002567f4ac077 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/06ae6df.html title=央視曝出：中國第四代反隱身雷達亮相，美軍F22戰機將無處遁形>央視曝出：中國第四代反隱身雷達亮相，美軍F22戰機將無處遁形</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0af9820.html alt=白宮又一猛料被曝出，一高級官員9月就入院，病情嚴重未對外公開 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/2455c6a33fad442b8eb7fe894574f335 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0af9820.html title=白宮又一猛料被曝出，一高級官員9月就入院，病情嚴重未對外公開>白宮又一猛料被曝出，一高級官員9月就入院，病情嚴重未對外公開</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8ff1283.html alt=安卓系統曝出高危漏洞，超90%用戶設備被波及 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p9.pstatp.com/large/pgc-image/c2834e824ce84a85b2527134972b7063 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8ff1283.html title=安卓系統曝出高危漏洞，超90%用戶設備被波及>安卓系統曝出高危漏洞，超90%用戶設備被波及</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/f819dc2.html alt=iG副總裁藏馬被曝出一手攬權，禁止輔助輪換。宮鬥成了？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/pgc-image/7b96c95501ff49f4a8e0e8117d653710 style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/f819dc2.html title=iG副總裁藏馬被曝出一手攬權，禁止輔助輪換。宮鬥成了？>iG副總裁藏馬被曝出一手攬權，禁止輔助輪換。宮鬥成了？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>