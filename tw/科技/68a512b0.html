<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） | 极客快訊</title><meta property="og:title" content="「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/RjuOLYb9D9t9tm"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/68a512b0.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/68a512b0.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/68a512b0.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/68a512b0.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/68a512b0.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/68a512b0.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/68a512b0.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/68a512b0.html><meta property="article:published_time" content="2020-11-14T20:59:43+08:00"><meta property="article:modified_time" content="2020-11-14T20:59:43+08:00"><meta name=Keywords content><meta name=description content="「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算）"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/68a512b0.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算）</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>前面的文章提到過PCIe總線（Gen1&Gen2）採用了8b/10b編碼，因此其有效數據速率為物理線路上的速率的80%。即Gen1的有效速率為2.0Gbps=2.5Gbps*80%，而Gen2的有效速率為4Gbps=5Gbps*80%。</p><p>如果以數據包的Data Payload為真實有效數據，來計算得話，實際應用中的有效速率會更低。因為，數據包的包頭、包尾（LCRC和ECRC等）、數據鏈路層添加的包編號等等；用於Ack/Nak和Flow Control等的DLLP；用於鏈路訓練和Skip的Order Sets等都會影響真實的有效速率。</p><p>這一篇文章，將來詳細地聊一聊，如何粗略地估算一個PCIe總線的真實有效速率。</p><p><strong>注：</strong>由於設備反應時間、數據處理時間、不確定的<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-4">插入</i>等待時間等等原因，無法從理論上，準確無誤地計算出一個PCIe總線的真實有效速率。</p><p><strong>注：</strong>關於8b/10b編碼，前面的文章中已經詳細地介紹過了，這裡就不再重複了。</p><p>對於任意的一個TLP來說，除了Data Payload，還有物理層添加的包頭（1 Byte）、數據鏈路層添加的包編號（2 Bytes）、事務層添加的包頭（12 or 16 Bytes）、事務層添加的ECRC（4Bytes，可選的）、數據鏈路層添加的LCRC（4Bytes）和物理層添加的包尾（1 Byte）。具體如下圖所示：</p><img alt=「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RjuOLYb9D9t9tm><p>如果以3DW的事務層包頭來計算，且不添加ECRC，則該TLP至少含有20 Bytes的額外數據（除了Data Payload之外的）。我們姑且稱之為TLP Overhead。</p><p><strong>注：</strong>32bits地址的TLP是3DW包頭，而<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-2">64</i>bits地址的TLP是4DW包頭，具體請參考前面的文章。</p><p>如果只從TLP Overhead考慮的話，顯然每個TLP包含的Data Payload的量越大，真實有效速率越高。然而，實際應用中卻並非如此，因為鏈路上的其他因素也在影響實際的真實有效速率。PCIe Spec規定，任何TLP都不允許被Order Sets或者DLLP打斷。也就是說，Skip Order Sets和FC DLLP、Ack/Nak DLLP都只能在兩個TLP之間發送。換一句話說，Data Payload越大，TLP的也就越長，為了保證正常通信，兩個TLP之間的時間間隔也就越大。這就是為什麼Data Payload越大，但真實有效速率卻未必會越高的原因。</p><p>除了TLP Overhead之外，前面文章介紹的Ack/Nak機制和Flow Control機制都是需要花費時間的。這裡我們分別稱其所消耗的時間為Link Protocol Overhead和Flow Control Protocol Overhead。具體這裡就不詳細，介紹了，請參考之前的文章。</p><p><strong>注：</strong>顯然，更低頻率的Flow Control Update，會一定程度上提高真實有效速率，但這需要更大的Rx Buffer，從而帶來更高的硬件成本開銷。一般情況下，PCIe設備都應當遵循Spec所定義的FC Update週期計算方式，具體可可參考前面的文章：http://blog.chinaaet<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-6">.com</i>/justlxy/p/5100053465</p><p>-----------------------------------------------------------------------------------------------------</p><p>除了前面介紹的TLP Overhead、Link Protocol Overhead和Flow Control Protocol Overhead之外，另一個影響真實有效速率的關鍵因素便是Max_Payload_Size，以及Read_Completion_Boundary（RCB）。</p><p>雖然PCIe Spec規定，TLP的Data Payload最高可達4096 Bytes，但同時也規定了PCIe體系結構中，所有的設備，都必須使用相同的Max_Payload_Size值。換一句話說，整個總線的Max_Payload_Size值必須使用總線體系結構中所有設備所支持的最小的Max_Payload_Size值。具體如下圖所示：</p><img alt=「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/RjuOLYp3f83o65><p><strong>注：</strong>每個設備中的Function的所支持的最大的Max_Payload_Size值應當是相同的。</p><p><strong>注：</strong>每個設備所支持的Max_Payload_Size最大值信息，存在於Device Capability Register中。</p><p>Max_Payload_Size值的設置是在PCIe總線枚舉和配置的過程中完成的，軟件確定了Max_Payload_Size的值後，會將該值寫入到每個設備的Device Control Register中。</p><p>在不考慮Ack/Nak機制和Flow Control機制等因素的情況下，真實有效速率可以這樣計算：</p><img alt=「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RjuOLYzFat8JSR><p>則有：</p><img alt=「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RjuOLZ730FjsZL><img alt=「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RjuOLZGIz3Efex><p>以128 Bytes的Max_Payload_Size為例，不考慮Ack/Nak機制和Flow Control機制等因素的情況下，理論極限真實有效速率如下：</p><img alt=「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RjuOLoMA2XZXWO><p>其中，1720Mb/s = 86% * 2000Mbps。（x1 Gen1）</p><p><strong>注：</strong>讀操作還需要考慮RCB等因素，後面會詳細介紹。表格裡的數據是在假設RCB為<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-2">64</i> Bytes的情況下得到的，因此其計算方法為：<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-2">64</i>/(<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-2">64</i>+20)=76%。</p><p>-----------------------------------------------------------------------------------------------------</p><p>針對讀操作，還有一個Ma<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">xi</i>mun Read Request Size（即最大讀請求）的概念，在PCIe總線配置的過程中，該值會被寫入到每個設備的Device Control Register中。PCIe Spec規定，Ma<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">xi</i>mun Read Request Size的值可以超過Max_Payload_Size，例如，可以向Max_Payload_Size為128 Bytes的設備，一次請求讀512 Bytes的數據。此時，一次請求會對應多個返回的Completion。</p><p>然而，Ma<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">xi</i>mun Read Request Size的值也並非越大越好，該值設置的過大，會導致某個PCIe設備獨佔整個系統帶寬的時間過長。但是如果Ma<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-1">xi</i>mun Read Request Size設置的過小，則需要發起多個讀請求操作。</p><p>Read Completion Boundary（RCB）確定了針對讀請求返回的每個Completion的Data Payload的最大值，一般為<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-2">64</i> Bytes或者128 Bytes（由系統或者軟件設置）。當然，Completion的Data Payload值，是可以小於RCB的。以<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-2">64</i> Bytes 的RCB和一次讀256 Bytes的請求為例，可能的情況如下圖所示：</p><img alt=「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RjuOLoY2NiN4OH><p><strong>注：</strong>目前，大部分的Root都固定地使用<i class="chrome-extension-mutihighlight chrome-extension-mutihighlight-style-2">64</i> Bytes的RCB，儘管Max_Payload_Size的值可能是128或者更大。</p><p>-----------------------------------------------------------------------------------------------------</p><p>最後，以幾個例子，來回顧一下上面的內容。</p><img alt=「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/RjuOLoi6MJqdPx><img alt=「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/RjuOLorBTt4ldM><img alt=「博文連載」PCIe掃盲——PCIe總線性能評估（有效數據速率估算） onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RjuOLp0Bxc5upF><p>參考文獻：</p><p>1、Xilinx. Understanding Performance of PCI Express Systems</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>PCIe</a></li><li><a>連載</a></li><li><a>掃盲</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/d86194bf.html alt=「博文連載」PCIe掃盲——PCIe總線數據鏈路層入門 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/6f9b0007cf22469b47ad style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d86194bf.html title=「博文連載」PCIe掃盲——PCIe總線數據鏈路層入門>「博文連載」PCIe掃盲——PCIe總線數據鏈路層入門</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/358821ab.html alt=「Excel-掃盲」如何針對某列設置累計求和公式？既單元格引用介紹 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/99a4ee88db6f44f7a13fd13ea0b466fd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/358821ab.html title=「Excel-掃盲」如何針對某列設置累計求和公式？既單元格引用介紹>「Excel-掃盲」如何針對某列設置累計求和公式？既單元格引用介紹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d9bdecf6.html alt=算法連載之散列表 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c9323a98b84a4165a88fc30ed2f2a422 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d9bdecf6.html title=算法連載之散列表>算法連載之散列表</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f9293337.html alt=連載——以西部各省為例，全方位解析腳手架工程，附實例（十六） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153006208901602aece2ad6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f9293337.html title=連載——以西部各省為例，全方位解析腳手架工程，附實例（十六）>連載——以西部各省為例，全方位解析腳手架工程，附實例（十六）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/65c598c3.html alt=連載——砌築工程全解，內附定額應用案例及計算公式（十七） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1530146694308a9e0e6056d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/65c598c3.html title=連載——砌築工程全解，內附定額應用案例及計算公式（十七）>連載——砌築工程全解，內附定額應用案例及計算公式（十七）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bec1198b.html alt=《紅塵青春》（連載6） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/590b760ce4a345409e7027742991da24 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bec1198b.html title=《紅塵青春》（連載6）>《紅塵青春》（連載6）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0efdfc9f.html alt=磨刀不誤砍柴工：在職培訓的安排（非人連載系列八） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d64392a56105407589bd1e431f0bec40 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0efdfc9f.html title=磨刀不誤砍柴工：在職培訓的安排（非人連載系列八）>磨刀不誤砍柴工：在職培訓的安排（非人連載系列八）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bb73efce.html alt=「連載」綏中老物件，未被遺忘的時光——風箱 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/67d8b1b73b6643cabf6ce653cc3617db style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bb73efce.html title=「連載」綏中老物件，未被遺忘的時光——風箱>「連載」綏中老物件，未被遺忘的時光——風箱</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8063d86e.html alt="PCIe Gen3/Gen4接收端鏈路均衡測試—實踐篇" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e5732dbbfafc4fbda49be57da81e07d8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8063d86e.html title="PCIe Gen3/Gen4接收端鏈路均衡測試—實踐篇">PCIe Gen3/Gen4接收端鏈路均衡測試—實踐篇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/244e73df.html alt="PCIe Gen3/Gen4接收端鏈路均衡測試—理論篇" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/deea7ea0ffcd4a4e9985f2106a9f6cf5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/244e73df.html title="PCIe Gen3/Gen4接收端鏈路均衡測試—理論篇">PCIe Gen3/Gen4接收端鏈路均衡測試—理論篇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/18500f33.html alt="PCIe Gen3/Gen4接收端鏈路均衡測試（上篇：理論篇）" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/Rzs72cR34YYB3t style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/18500f33.html title="PCIe Gen3/Gen4接收端鏈路均衡測試（上篇：理論篇）">PCIe Gen3/Gen4接收端鏈路均衡測試（上篇：理論篇）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bb7db633.html alt="PCIe Gen3/Gen4接收端鏈路均衡測試（下篇：實踐篇）" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RzxxF1A1CuI2xT style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bb7db633.html title="PCIe Gen3/Gen4接收端鏈路均衡測試（下篇：實踐篇）">PCIe Gen3/Gen4接收端鏈路均衡測試（下篇：實踐篇）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/55686102.html alt="時序數據庫連載系列: 時序數據庫一哥InfluxDB之存儲機制解析" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/bee309a50ea64a2ea56fbd698279eff2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/55686102.html title="時序數據庫連載系列: 時序數據庫一哥InfluxDB之存儲機制解析">時序數據庫連載系列: 時序數據庫一哥InfluxDB之存儲機制解析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2aa8e0f7.html alt=時序數據庫連載系列：時序數據庫那些事 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/125534ddebc242d5ad4694adcd1602aa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2aa8e0f7.html title=時序數據庫連載系列：時序數據庫那些事>時序數據庫連載系列：時序數據庫那些事</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ff19c995.html alt=汽車英文縮寫掃盲 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3fa7546b598d4f4994c34212cf486c13 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ff19c995.html title=汽車英文縮寫掃盲>汽車英文縮寫掃盲</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>