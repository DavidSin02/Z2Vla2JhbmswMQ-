<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思 | 极客快訊</title><meta property="og:title" content="程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/913668674f0d4e629060e223c434f97b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/691f963e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/691f963e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/691f963e.html><meta property="article:published_time" content="2020-11-14T21:02:06+08:00"><meta property="article:modified_time" content="2020-11-14T21:02:06+08:00"><meta name=Keywords content><meta name=description content="程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/691f963e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>在上一章節中分析HashMap內部實現基本點，HashMap初始化，HashMap擴容。本章對Hash衝突，樹化，線程安全內容繼續剖析。</p><div class=pgc-img><img alt=程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/913668674f0d4e629060e223c434f97b><p class=pgc-img-caption></p></div><h1><strong>分析目錄：</strong></h1><p>HashMap內部實現基本點分析；</p><p>容量（capcity）；負載係數（load factor）；</p><p>HashMap初始化；</p><p>HashMap擴容；</p><p>Hash衝突；</p><p>樹化；</p><p>線程安全；</p><div class=pgc-img><img alt=程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dac9dfa4faec4dd992e4b612c864ae67><p class=pgc-img-caption></p></div><h1>Hash衝突分析：</h1><p>前面提到HashMap 數據結構是 數組 + 鏈表 + 紅黑樹；</p><p>當HashMap中添加一個數據的時候，需要通過key計算Hash值，通過Hash值計算數組存放的索引，不同的Key 通過Hash算法計算可能會出現相同的值，所以如果通過數組存放數據的時候地址會出現衝突，而HashMap的出現就是為了解決Hash衝突。</p><p><strong>計算Hash值源代碼：</strong></p><pre>static final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);}</pre><p>通過傳入的Key獲取計算hash值，然後調用圖1 putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict)方法進行插入。</p><p>通過n = tab.length，p = tab[i = (n - 1) & hash] ；</p><p>通過(n - 1) & hash計算出數組的索引；</p><p>通過位運算消耗資源更少，效率更高，還避免了hashcode為負數的情況。</p><div class=pgc-img><img alt=程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cd5c92e9532e4925a037ebf0576d6ed8><p class=pgc-img-caption>圖1</p></div><p><strong>哈希衝突概念：</strong></p><p>哈希衝突是指哈希函數算的數據存放地址被別的數據佔用了。不同的Hash函數實現會影響發生哈希衝突率。</p><div class=pgc-img><img alt=程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/bf9b8fb757bc4dd6a1f293c48c34deb7><p class=pgc-img-caption>put操作</p></div><pre>transient Node&lt;K,V&gt;[] table;</pre><p>HashMap中的數組通過源代碼我們知道它雖然是數組，但是它是通過Hash算法將數據放入數據中，就是一個Hash表結構。</p><p><strong>哈希表概念：</strong></p><p>哈希表是通過散列技術實現的，散列技術是指在數據存儲位置和它的關鍵字（Key）之間建立對應關係，使每一個關鍵字（key）都對應一個存儲位置。在查找的數據的過程中，只需要通過這個對應關係找到給定值key的映射關係。只要集合中存在關鍵字和key相等的記錄，則可以找到存儲位置。我們把這種對應關係 稱為散列函數或哈希函數。簡單的理解就是在指定的區域內為房間編排個門牌號，我們需要找房間的時候通過鑰匙（key）上編號知道門牌號，然後找到房間。</p><div class=pgc-img><img alt=程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d09341e1a29549e3a305c772fb81994a><p class=pgc-img-caption>hash表樣式</p></div><p>所以採用散列技術將記錄存儲在一塊連續的存儲空間中，這塊連續的存儲空間稱為哈希表，所得的存儲地址稱為哈希地址或散列地址，HashMap中的數組就是哈希表，也叫Hash桶。</p><p><strong>為什麼要使用哈希表？</strong></p><p>普通的數組以及鏈表在查詢指定元素的時候，需要從開始遍歷，時間複雜度為O(n)。</p><p>哈希表能夠根據元素本身計算Hash值直接找到元素指定位置，時間複雜度為O（1）；所以哈希表它在查詢和刪除、插入性能上會比數組和鏈表要快很多。</p><p><strong>當衝突後怎麼辦？帶著問題繼續看</strong></p><div class=pgc-img><img alt=程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/dd1abb2792594882ae687a60fa54b16c><p class=pgc-img-caption>圖2</p></div><h1>HashMap樹化</h1><p>Jdk1.8引入了紅黑樹數據結構，這個主要是為了解決<strong>大量hash衝突</strong>而引入的，當發生hash衝突的時候，會將數據存入鏈表後面；當hash衝突量比較大的時候，鏈表長度會比較長，導致查詢比較慢，所有使用紅黑樹的形式。</p><p>如圖2，static final int TREEIFY_THRESHOLD = 8;所以當鏈表長度大於8的時候，會將鏈表轉換成紅黑樹存儲，鏈表查詢的複雜度是O(n)，紅黑樹時間複雜度變成了O（n/2），所以查詢性能提升了許多。</p><p><strong>樹化代碼分析：</strong></p><div class=pgc-img><img alt=程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/933ec535508a4b3e8284e83dff506dea><p class=pgc-img-caption>樹化代碼</p></div><pre>fnal void treeifyBin(Node&lt;K,V&gt;[] tab, int hash) {int n, index; Node&lt;K,V&gt; e;if (tab == null || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)resize();else if ((e = tab[index = (n - 1) &amp; hash]) != null) {//樹化邏輯}}</pre><p>上面是的 treeifyBin（）方法示意，可以理解為，當 bin 的數量大於 TREEIFY_THRESHOLD 時：</p><p>*如果容量小於MIN_TREEIFY_CAPACITY，只會進行簡單的擴容。</p><p>*如果容量大於MIN_TREEIFY_CAPACITY ，則會進行樹化改造。</p><p><strong>性能疑問</strong></p><p>可能會有人疑問，維護紅黑樹需要性能的，這樣會不會性能反而下降了。我個人理解發生大量衝突後更新數據的頻率是小於查詢數據的頻率的，而且鏈表插入一條新數據和紅黑樹插入一條新數據時間差距就是可能需要重新維護紅黑樹結構上，綜合下來就可以JDK1.8用紅黑樹性能確實提升不少。</p><div class=pgc-img><img alt=程序員練級之路，高薪程序員必會知識，Hash衝突，樹化是什麼意思 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/eb92e4eb51574226a5150093f8c98f29><p class=pgc-img-caption>Map結構圖，來源楊曉峰</p></div><h1>線程安全</h1><p>HashMap不支持線程的同步，即任一時刻可以有多個線程同時寫HashMap都可能會導致數據的不一致或出現其他錯誤。</p><p><strong>使用建議：</strong></p><p>如果需要同步使用ConcurrentHashMap類，相較於HashTable鎖住的是對象整體， ConcurrentHashMap基於lock實現鎖分段技術。ConcurrentHashMap不僅保證了多線程運行環境下的數據訪問安全性，而且性能上有長足的提升。</p><p><strong>最後疑問：</strong></p><p>我們都HashMap不是線程安全的，所以你有想過會在哪些情況不安全嗎？</p><p>如：HashMap需要擴容，多個線程在這個時候同時操作會導致意想不到情況，可能會導致數據丟失，數據錯誤。</p><p>你還能想到其他不安全場景嗎？歡迎在下發評論和大家一起分享！</p><blockquote><p>還會繼續更新Java相關技術文章哦，歡迎圍觀哦！</p><p>作者：喵小北vlog</p><p>文章參考內容：</p><p>通讀了大約20餘篇網上相關HashMap博客文章；</p><p>JDK1.8_Api</p><p>Oracle 楊曉峰java核心36講</p><p>JDK1.8源代碼</p><p>JAVA編程思想</p></blockquote></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>程序</a></li><li><a>員練級</a></li><li><a>必會</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/87ec6d9d.html alt=管理評審程序（IAO9001程序文件範本） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/87ec6d9d.html title=管理評審程序（IAO9001程序文件範本）>管理評審程序（IAO9001程序文件範本）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0fd25820.html alt=質量管理體系程序文件-FMEA程序 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0fd25820.html title=質量管理體系程序文件-FMEA程序>質量管理體系程序文件-FMEA程序</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e0ffb976.html alt=不合格、糾正措施程序文件（ISO9001程序文件範本） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e0ffb976.html title=不合格、糾正措施程序文件（ISO9001程序文件範本）>不合格、糾正措施程序文件（ISO9001程序文件範本）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/16c259de.html alt=什麼是程序文件？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/16c259de.html title=什麼是程序文件？>什麼是程序文件？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a8c41b36.html alt=今天聊聊程序的文件的概念 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a8c41b36.html title=今天聊聊程序的文件的概念>今天聊聊程序的文件的概念</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9cd79f8d.html alt=程序文件-ISO9001 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/2e673ba29f5545fd8aea4073e1c638c3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9cd79f8d.html title=程序文件-ISO9001>程序文件-ISO9001</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e56d2fb8.html alt=程序文件主要包括哪些內容？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e56d2fb8.html title=程序文件主要包括哪些內容？>程序文件主要包括哪些內容？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4526bc23.html alt=程序文件沒有用？管理全靠你盯著？也許是你對程序文件有誤解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/25f214b9-177d-4e1e-8ccd-1c3fe7c07fe5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4526bc23.html title=程序文件沒有用？管理全靠你盯著？也許是你對程序文件有誤解>程序文件沒有用？管理全靠你盯著？也許是你對程序文件有誤解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c81e50df.html alt=程序文件流程圖 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/3a0300041dc3570ffec5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c81e50df.html title=程序文件流程圖>程序文件流程圖</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/300f6ba5.html alt=程序文件的管理主要有哪些方面的內容？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/300f6ba5.html title=程序文件的管理主要有哪些方面的內容？>程序文件的管理主要有哪些方面的內容？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5ad5161d.html alt=食品企業程序文件範本 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/6cb0d535ec904fa2ac5d54a06cea18b4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5ad5161d.html title=食品企業程序文件範本>食品企業程序文件範本</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c8f329d0.html alt=一個合格的程序員必會Hash詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/0139af5bf4374f9583277f384c9c343c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c8f329d0.html title=一個合格的程序員必會Hash詳解>一個合格的程序員必會Hash詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9acfbb8b.html alt=EXCEL必會的基本操作 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1a21c3c391e44695a302bc1f3bdcb88e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9acfbb8b.html title=EXCEL必會的基本操作>EXCEL必會的基本操作</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4bbdc7e2.html alt="工程師必知必會select count()你知多少？一文讀懂" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/cfac7557a83047469f3de4270e371eaa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4bbdc7e2.html title="工程師必知必會select count()你知多少？一文讀懂">工程師必知必會select count()你知多少？一文讀懂</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/de818256.html alt=冷軋鋁板帶軋製應用程序 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/cfeb1fbb32af416da7f01fa6f92af053 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/de818256.html title=冷軋鋁板帶軋製應用程序>冷軋鋁板帶軋製應用程序</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>