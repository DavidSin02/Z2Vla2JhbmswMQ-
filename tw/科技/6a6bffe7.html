<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>簡單使用python多進程併發下載大量圖片 | 极客快訊</title><meta property="og:title" content="簡單使用python多進程併發下載大量圖片 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/1539696513135d6d300d7f0"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6a6bffe7.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6a6bffe7.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6a6bffe7.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6a6bffe7.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6a6bffe7.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6a6bffe7.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/6a6bffe7.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/6a6bffe7.html><meta property="article:published_time" content="2020-11-14T21:06:37+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:37+08:00"><meta name=Keywords content><meta name=description content="簡單使用python多進程併發下載大量圖片"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/6a6bffe7.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>簡單使用python多進程併發下載大量圖片</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>如果有大量圖片想要下載，肯定希望速度越快越好，那麼就要使用多任務。</p><div class=pgc-img><img alt=簡單使用python多進程併發下載大量圖片 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539696513135d6d300d7f0><p class=pgc-img-caption></p></div><p>python支持多線程和多進程。但是解釋器中的GIL鎖導致任何Python線程執行前，必須先獲得GIL鎖，然後，每執行100條字節碼，解釋器就自動釋放GIL鎖，讓別的線程有機會執行。所以多線程並不能達到理想的效果。</p><p>使用多進程的話，mutilprocessing是個很好用的庫。如果是一個進程一個進程的創建，使用其中的Process類；如果是大量的，要使用其中的Pool類。如果涉及到進程間的通訊，還要使用其中Queue類、Pipes類。</p><p>綜合考慮，選用Pool。</p><p>首先要獲取所有圖片的url（這一步也可以使用多進程），然後創建Pool，其中的子進程從前往後讀取url，然後將圖片信息保存到本地。</p><p>其中主要的兩個函數如下所示，在save_pictures(urls)裡面創建容量為40的Pool對象（默認情況下是和系統的CPU核數相同，可用通過multiprocessing.cput_count()來得知此數值），然後不停創建子進程，進行下載任務。p.close()表示不能再增加子進程，p.join()表示要等到所有子進程任務都完成後才會繼續往下執行。</p><p>在save_pic(pic_url,filename)函數中進行單進程的下載圖片操作。使用url lib.urlretrieve(url,filename,reporthook,data)函數來下載，這個函數是一塊一塊下載的，比較方便。report hook回調函數可以用來計算下載進度，此處沒有使用。具體實現方法可以看源碼。</p><div class=pgc-img><img alt=簡單使用python多進程併發下載大量圖片 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539696474371f537f0427a><p class=pgc-img-caption></p></div><p>![Uploading 屏幕快照 下午12.52.52_787403.png . . .]](http://upload-images.jianshu.io/upload_images/207122-73a0facdefd1b687.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</p><p>在主函數中，通過以下形式來計算耗時。</p><p>d1 = datetime.datetime.now()</p><p>save_pictures(result)</p><p>d2 = datetime.datetime.now()</p><p>這是簡單的一個多進程和單進程的對比結果。實際中是開了40個進程，下載了5000+張圖片，共5.56G。</p><p>#單任務，urlopen：0:15:26.152427 38 pictures 38.1MB 42.12kb/s</p><p>#8進程，urlretrieve：0:09:47.217917 38 pictures 38.1MB 66.46kb/s</p><p>#40進程，urlretrieve：1:43:06.125514 5.56G 943.38kb/s</p><p>其實可以從Mac的活動監視器中看到實時的網絡下載速度，半夜三更時40個進程可以達到4M/s。所以說對於處理這種重複大量的任務，一定要選用多任務。</p><p>然而代碼不是一下子就寫成這樣的，即使這個場景一點都不復雜。</p><p>首先第一次跑的時候，跑了一個晚上都沒下載完，我查看了下文件的修改時間，發現都是第二天早上，猜測某個部分循環錯誤，導致文件不停地重新下載寫入。後來的確發現是某個地方多了個循環，導致每個圖片能多下載一百多次。</p><p>後來發現剛開始下載很快，然後就慢得不可思議。同時還有個現象就是在下載之前創建目錄，只能創建一部分就停止了，也就是說下載循環停止了。後來我把創建目錄分離，防止受到下載圖片任務的影響。慢的原因，我懷疑是之前Pool對象創建有問題，導致大量子進程被創建，然後又因為通訊超時、進程太多導致調度困難等等。這個問題後來改了代碼後就不再出現，也就沒有深挖。</p><p>再跑的時候跑完了，但是有的圖片下載完全，有的就下載了部分，剩下的都是黑塊，並且這種現象不是零星出現，而是大規模出現。還有的圖片根本打不開，只有1k或者2k。</p><p>這種現象我懷疑是超時導致的，因為urlretrieve並沒有超時設置參數，所以通過socket.setdefaulttimeout(30)來強制設置。同時使用異常處理來處理超時時的循環操作，採用的結構如下。</p><p>（</p><p>while:</p><p>try:</p><p>...</p><p>except ...:</p><p>...</p><p>else:</p><p>...</p><p>）</p><p>然而這種現象並沒有消除，後來我嘗試使用terminal來複現這些照片的下載流程時發現，還會拋出其他的一些錯誤，主要的原因是我要下載的這個服務器不太穩定，一不小心就訪問失敗了（我懷疑是由於我的大量進程訪問導致的）。所以看我的save_pic函數中是有2個except的，一個單獨處理socket.timeout異常，另一個用來處理其他異常。</p><p>其實這種現象沒經驗的話是很難判斷的，因為我設置的是30s超時，那麼按照理想情況，所有正在下載的圖片在文件系統的修改時間應該都在30s之內，只有下載好了的才會超過這個時間。然而實際情況那些只下載了部分的圖片的修改時間也是好幾分鐘之前了。查看打印消息，也發現這些圖片只有try部分的沒有else部分的也沒有except socket.timeout部分。</p><p>那為什麼打印消息中沒有拋出的異常信息，程序沒有崩潰？我覺得由於是子進程出錯，所以並不會對主進程造成影響導致。</p><p>所以說，異常處理一定要對每種場景都包括，要有對默認出錯的處理方法，特別是多進程時，無聲無息被kill，讓人摸不著頭腦。</p><p>另外還犯了一個錯，就是在except中把urllib.urlretrieve也寫到下面，這樣導致在except中出異常時，不再能夠處理異常。後續把urlretrieve只放到try中，其他的except只進行打印和計數，然後讓循環來幫我重新下載。</p><p>修改完畢後基本跑通，各種異常信息都能夠打印出來並處理，整體無比和諧，除了個別圖片依然是1k或2k的大小，查了下網頁代碼，發現是bug，也就不作理會了。</p><p>總結：多任務很好用，異常處理要用心。</p><div class=pgc-img><img alt=簡單使用python多進程併發下載大量圖片 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1539696524893c9e1f714df><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>簡單</a></li><li><a>python</a></li><li><a>進程</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/01920188.html alt=python乾貨｜python多進程併發 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153075082008107d9bdbb84 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/01920188.html title=python乾貨｜python多進程併發>python乾貨｜python多進程併發</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d7504b3a.html alt=python併發編程：進程的創建和結束 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d7504b3a.html title=python併發編程：進程的創建和結束>python併發編程：進程的創建和結束</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/51e434ad.html alt=新手用雲服務器快速搭建個人網站簡單教程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/51e434ad.html title=新手用雲服務器快速搭建個人網站簡單教程>新手用雲服務器快速搭建個人網站簡單教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/61d5b89d.html alt=場面描寫很簡單，讓語文老師舉例，教會你好用的寫作技巧和方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/a12e06c3-dac8-4ef1-a44b-bbf85671edb2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/61d5b89d.html title=場面描寫很簡單，讓語文老師舉例，教會你好用的寫作技巧和方法>場面描寫很簡單，讓語文老師舉例，教會你好用的寫作技巧和方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ecbd05fe.html alt="比搶錢還要簡單！蘋果上架Mac Pro配件：四個輪子要五千塊" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5e07933580e64355abbbcac953abfc3d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ecbd05fe.html title="比搶錢還要簡單！蘋果上架Mac Pro配件：四個輪子要五千塊">比搶錢還要簡單！蘋果上架Mac Pro配件：四個輪子要五千塊</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b3994691.html alt=世界發展進程中的耀眼篇章 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RCLmM9dF1KnwoT style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b3994691.html title=世界發展進程中的耀眼篇章>世界發展進程中的耀眼篇章</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9ababaae.html alt=初中科學元素的簡單分類每日一練含答案解析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/cc6f0300765348b3a57404a617d32c99 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9ababaae.html title=初中科學元素的簡單分類每日一練含答案解析>初中科學元素的簡單分類每日一練含答案解析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e4707da0.html alt=高中化學物質分類竟如此簡單，你還記得多少？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/b73cc7c22bc14eb9af43cf76f66e5d70 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e4707da0.html title=高中化學物質分類竟如此簡單，你還記得多少？>高中化學物質分類竟如此簡單，你還記得多少？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f8c3b92d.html alt=python安全開發軍規之四：使用安全的隨機數生成器 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/bbda123b84db44148aca9d3e26ddf119 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f8c3b92d.html title=python安全開發軍規之四：使用安全的隨機數生成器>python安全開發軍規之四：使用安全的隨機數生成器</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e27caade.html alt=python基礎知識，多態實例講解以及多態的作用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/2506d9fe7f6641a6a12c35a35a9335db style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e27caade.html title=python基礎知識，多態實例講解以及多態的作用>python基礎知識，多態實例講解以及多態的作用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c56ee116.html alt=小猿圈python學習-三大特性之多態 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ad0e8e3777854337abeb7c779ad79a04 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c56ee116.html title=小猿圈python學習-三大特性之多態>小猿圈python學習-三大特性之多態</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ec613168.html alt=十大世界足球先生，認識四位以上的人都不簡單 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8bf0e55d0e30483abc88ce0fa1ac279d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ec613168.html title=十大世界足球先生，認識四位以上的人都不簡單>十大世界足球先生，認識四位以上的人都不簡單</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/35c96373.html alt=14種家常哨子面的做法，美味不油膩，簡單易學又實用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1ef1a62cd3ad4bf9b000021a38952cb4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/35c96373.html title=14種家常哨子面的做法，美味不油膩，簡單易學又實用>14種家常哨子面的做法，美味不油膩，簡單易學又實用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dacdca28.html alt=媽媽教的剪刀面做法，無保留分享，簡單又實用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/2e3e5ec81da04a70bf4d1fe077acb24c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dacdca28.html title=媽媽教的剪刀面做法，無保留分享，簡單又實用>媽媽教的剪刀面做法，無保留分享，簡單又實用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bd7a84b7.html alt=鑑別被追尾車就是這麼簡單！這4個方法你都瞭解嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a51a16723af8485ab69705c547ea4fd8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bd7a84b7.html title=鑑別被追尾車就是這麼簡單！這4個方法你都瞭解嗎？>鑑別被追尾車就是這麼簡單！這4個方法你都瞭解嗎？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>