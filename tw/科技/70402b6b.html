<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>對話框窗口過程的另外一種實現方法 | 极客快訊</title><meta property="og:title" content="對話框窗口過程的另外一種實現方法 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/22ebb7b6d51f4de59abd3728621d1002"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/70402b6b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/70402b6b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/70402b6b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/70402b6b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/70402b6b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/70402b6b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/70402b6b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/70402b6b.html><meta property="article:published_time" content="2020-11-14T21:01:56+08:00"><meta property="article:modified_time" content="2020-11-14T21:01:56+08:00"><meta name=Keywords content><meta name=description content="對話框窗口過程的另外一種實現方法"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/70402b6b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>對話框窗口過程的另外一種實現方法</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>蠍子</h1><p>在之前的一篇關於對話框返回值的文章中，有人建議說可以使用另外一種不同的搞法：也即直接調用DefDlgProc這個API函數(就類似於窗口消息過程中調用默認的消息處理函數DefWindowProc一樣，而不是直接返回TRUE或者FALSE。</p><h1 class=pgc-h-arrow-right>那，讓我們試試唄</h1><p>實際上，我們準備試它兩次。今天我會使用上述所說的方法，過幾天，我還會演示另外一種完全不一樣的做法。這兩種做法中，都包含同一個的內部理念，而剩下的其他部分只是為了讓這個理念能順利跑起來的輔助結構而已。</p><p>這個所謂的第一種方法，實際上是使用了一種遞歸式調用手法，它嘗試在對話框窗口過程中調用DefDlgProc，從而觸發一種默認的消息處理流程。這種技巧需要設立一個標誌，使用這個標誌可以能夠打破遞歸調用，從而退出無限循環。</p><p>因為通常你的對話框對象裡已經有了一些數據成員了，所以，再添加一個數據成員應該不是什麼大問題。</p><h1 class=pgc-h-arrow-right>上面所說的內部理念是：打破遞歸循環調用鏈</h1><p>DefDlgProc會調用對話框窗口過程來判斷主程序的意圖。當你想讓Windows執行默認的消息處理時，你就會遞歸地調用DefDlgProc：在DefDlgProc這個函數的內部，它會回過頭來，調用你的對話框窗口過程來判斷你是否會希望覆蓋默認的處理流程。</p><p>通過檢測這個遞歸調用並返回FALSE，對DefDlgProc的遞歸調用就會執行默認處理並返回它的處理結果。</p><p>現在，你得到了默認消息處理的結果，你可以在返回之前修改它，然後調用鏈返回到外層的DefDlgProc，它會將這個值作為消息處理的最終處理結果。</p><p>如果有人喜歡看圖的話，可以看看下面這個圖：</p><div class=pgc-img><img alt=對話框窗口過程的另外一種實現方法 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/22ebb7b6d51f4de59abd3728621d1002><p class=pgc-img-caption></p></div><p>基於上面的這個流程圖，你應該能夠自己寫出對應的代碼來。下面是我寫的一個版本，我姑且把它稱作是一個”WndProc-Like”的對話框。</p><div class=pgc-img><img alt=對話框窗口過程的另外一種實現方法 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/044cfc84f4aa49c2b95f9fbc3dee41d7><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=對話框窗口過程的另外一種實現方法 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/691399dff32b4d4c9f7b2562673d93f3><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>讓我們過一過上面的代碼</h1><p>我將WLDlgProc聲明為了虛方法，如果一個子類繼承了WLDialogBox，則這個子類的窗口過程會被s_DlgProc調用，我們認為子類可能會在它們自己的窗口過程中執行自定義的行為。在基類的中，我們調用了DefDlgProcEx（這是個宏，來自windowsx.h頭文件）來作為消息處理的默認方式（它的確做了許多髒活）。</p><p>是的，你想的沒錯，這個技法從1992年就已經被Microsoft公佈出來了。如果你查看一下DefDlgProcEx這個宏的實現代碼，就會發現，它會將檢測遞歸調用的標誌設置為TRUE，然後調用會觸發遞歸調用的DefDlgProc。</p><p>本來我是想著再實現一份WLDefDlgProc的，它會調用DefDlgProcEx並且WLDlgProc會調用WLDefDlgProc。(在第一版中，我的確是這麼做的)。但是，我最終沒有選擇這樣做，我主要是不想有人跳過對基類WLDefDlgProc的調用。</p><p>如果你希望對消息進行默認的處理，則只需要將調用轉發給基類的WLDefDlgProc即可。</p><p>s_DlgProc是所有Wndproc對話框實例的對話框窗口過程。當收到WM_INITDIALOG消息的時候，它會初始化自身，這樣後面收到的消息就能準確地知道具體是哪個窗口實例負責處理此消息。</p><p>接下來，我們使用了CheckDlgRecursion這個宏(也是來自windowsx.h)。這個宏會檢查遞歸調用標誌，如果標誌為TRUE，則它會將它設置為FALSE並立即返回FALSE，這樣就可以打破遞歸調用循環了。</p><p>如果標誌為FALSE，它會調用WLDlgProc這個方法(子類很有可能會重寫這個方法)，然後設置對話框窗口過程的返回值並返回。</p><p>SetDlgMsgResult這個宏也來自於windowsx.h：它保存返回值到DWLP_MSGRESULT中並返回TRUE。除非出現一些特殊的消息，在這種情況下，它會直接返回，而不設置DWLP_MSGRESULT。<strong>對64位應用開發者的溫馨提醒</strong>：當前實現的這個宏裡有一個Bug。表達式[(BOOL)(result)]應該改為[(INT_PTR)(result)]，這樣返回值的高32位就不會被截斷了。</p><p>最後一個方法是DoModal，它會初始化遞歸調用標誌並顯示對話框。</p><p>下面是一個使用了上面這個類的一個例子：</p><div class=pgc-img><img alt=對話框窗口過程的另外一種實現方法 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6d5461671ac948fb9478428e975a2b59><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=對話框窗口過程的另外一種實現方法 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bac383d3f0a5468fb158f0cecc005847><p class=pgc-img-caption></p></div><p>為了演示返回一個自定義的返回值，我重寫了WM_SETCURSOR消息處理函數，這樣當鼠標位於標題欄時，會顯示一個自定義的光標。對於演示目的來說，這個代碼已經足夠達到目的了。</p><h1 class=pgc-h-arrow-right>請注意如下的兩個方面</h1><p>我們通過調用__super::WLDlgProc來調用了默認的消息處理函數。在Visual C++擴展中，__super可以用來在子類中解析對基類的引用。這個關鍵字十分有用，因為它可以幫助開發者快速將調用轉發給類的上一層基類。如果你希望將調動轉發給基類的基類，則可以使用如下的技法：<strong>__super::__super::WLDlgProc</strong></p><p>如果你使用的編譯器不支持__super關鍵字，則可以使用如下的typedef來間接實現：</p><p><strong>typedef WLDialogBox super;</strong></p><p>然後使用super::WLDlgProc就可以調用基類方法了。</p><p>實際上，在VC開發團隊將__super關鍵字添加到產品中之前，我就是這樣做的，可能是習慣了吧。</p><h1 class=pgc-h-arrow-right>課後練習</h1><p>遞歸調用標誌真的有必要作為每個對話框示例的數據成員嗎？可以將它設置為全局變量的嗎？</p><h1 class=pgc-h-arrow-right>問題答案</h1><p>遞歸調用標誌不需要作為每個對話框示例的數據成員。只需要保證它的生命週期足夠長，以至於可以及時檢測到遞歸調用。</p><p>但是，將它設置為全局變量也不是個好主意，因為可能在對DefDlgProc的遞歸調用中會同時有兩個線程。</p><p>所以，倒是可以考慮使用TLV(Thread Local Variable)來存儲這個變量，如果你希望使用C語言而不是C++類來實現的話。</p><p><br></p><div class=pgc-img><img alt=對話框窗口過程的另外一種實現方法 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8e70b3b737cb4ba8abdb42dae189bff1><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>對話</a></li><li><a>過程</a></li><li><a>一種</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/fbc594e1.html alt=合金凝固過程微觀組織相場法研究 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/815da49f86474de38004007ee7edc7a5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fbc594e1.html title=合金凝固過程微觀組織相場法研究>合金凝固過程微觀組織相場法研究</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fb52eed9.html alt=鋼結構施工過程中，為什麼H型鋼樑翼緣要避免開孔 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c7617005bf7449efacd678a2fc77917e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fb52eed9.html title=鋼結構施工過程中，為什麼H型鋼樑翼緣要避免開孔>鋼結構施工過程中，為什麼H型鋼樑翼緣要避免開孔</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f4df1c1a.html alt="有一種音頻編碼技術叫MQA，聲音質感優於TIDAL HiFi（CD等級）" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/6383bc881ccf4674aa3074a767f7f743 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f4df1c1a.html title="有一種音頻編碼技術叫MQA，聲音質感優於TIDAL HiFi（CD等級）">有一種音頻編碼技術叫MQA，聲音質感優於TIDAL HiFi（CD等級）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2161eb1b.html alt=一種可以除去砷的綠色方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2161eb1b.html title=一種可以除去砷的綠色方法>一種可以除去砷的綠色方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/30ef85ba.html alt=「今日賓川」有一種青春叫軍訓，那些年我們一起軍訓的日子 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1534765722006c4a614cbda style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/30ef85ba.html title=「今日賓川」有一種青春叫軍訓，那些年我們一起軍訓的日子>「今日賓川」有一種青春叫軍訓，那些年我們一起軍訓的日子</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6facd8bb.html alt=一種限滑可鎖的差速器總成-託森差速器 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/377c51f9d3b3443796bd2aeacc50bf97 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6facd8bb.html title=一種限滑可鎖的差速器總成-託森差速器>一種限滑可鎖的差速器總成-託森差速器</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e7798a22.html alt=機組停運操作過程步驟 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/53ef0002c8b15a5051c9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e7798a22.html title=機組停運操作過程步驟>機組停運操作過程步驟</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5ec4d0cb.html alt="上海光機所提出一種基於濾波PRBS信號相位調製的線寬展寬方法，實現光纖激光<5GHz線寬1.27kW輸出" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ea110b92b2c84fa8bbf54234ec0e1ee3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5ec4d0cb.html title="上海光機所提出一種基於濾波PRBS信號相位調製的線寬展寬方法，實現光纖激光<5GHz線寬1.27kW輸出">上海光機所提出一種基於濾波PRBS信號相位調製的線寬展寬方法，實現光纖激光&lt;5GHz線寬1.27kW輸出</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0e7787ae.html alt="陳邕  素描既是一種獨立的藝術表現形式" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/0967d56ed7a845338717c864fefa6729 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0e7787ae.html title="陳邕  素描既是一種獨立的藝術表現形式">陳邕  素描既是一種獨立的藝術表現形式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b8d8afb7.html alt=裝修過程中選擇礦棉吸音板的優勢和注意事項介紹 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RLaLWeTJ8TBdtS style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b8d8afb7.html title=裝修過程中選擇礦棉吸音板的優勢和注意事項介紹>裝修過程中選擇礦棉吸音板的優勢和注意事項介紹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d616c72c.html alt="中基協洪磊：完善過程信用管理 為私募股權基金營造更好展業空間" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d616c72c.html title="中基協洪磊：完善過程信用管理 為私募股權基金營造更好展業空間">中基協洪磊：完善過程信用管理 為私募股權基金營造更好展業空間</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bdd041e0.html alt="洪磊：完善過程信用管理 為私募股權基金營造更好展業空間" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RC14TUiH4M1j7I style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bdd041e0.html title="洪磊：完善過程信用管理 為私募股權基金營造更好展業空間">洪磊：完善過程信用管理 為私募股權基金營造更好展業空間</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/820826d1.html alt="洪磊：完善過程信用管理 為私募股權基金營造更好展業空間｜財富管理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RC8uE9EFb8wU97 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/820826d1.html title="洪磊：完善過程信用管理 為私募股權基金營造更好展業空間｜財富管理">洪磊：完善過程信用管理 為私募股權基金營造更好展業空間｜財富管理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/25d2deec.html alt=中基協：強化過程自律，落實信義義務，建設更加高效的私募行業 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/25d2deec.html title=中基協：強化過程自律，落實信義義務，建設更加高效的私募行業>中基協：強化過程自律，落實信義義務，建設更加高效的私募行業</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bf1b008b.html alt=世界上有一種動物的耙耙是方形的 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/6823/2478391326 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bf1b008b.html title=世界上有一種動物的耙耙是方形的>世界上有一種動物的耙耙是方形的</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>