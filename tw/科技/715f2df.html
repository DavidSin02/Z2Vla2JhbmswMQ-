<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>liteos 中斷機制（四） | 极客快訊</title><meta property="og:title" content="liteos 中斷機制（四） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/f559c14c75124ca59da5623eef479055"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/715f2df.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/715f2df.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/715f2df.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/715f2df.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/715f2df.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/715f2df.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/715f2df.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/715f2df.html><meta property="article:published_time" content="2020-10-29T20:50:02+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:02+08:00"><meta name=Keywords content><meta name=description content="liteos 中斷機制（四）"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/715f2df.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>liteos 中斷機制（四）</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>1. 概述</h1><p>中斷是指出現需要時， CPU暫停執行當前程序，轉而執行新程序的過程。即在程序運行過程中，系統出現了一個必須由CPU立即處理的事務，此時， CPU暫時中止當前程序的執行轉而處理這個事務，這個過程就叫做中斷。</p><p>眾多周知， CPU的處理速度比外設的運行速度快很多，外設可以在沒有CPU介入的情況下完成一定的工作，但某些情況下需要CPU為其做一定的工作。</p><p>通過中斷機制，在外設不需要CPU介入時， CPU可以執行其它任務，而當外設需要CPU時通過產生中斷信號使CPU立即中斷當前任務來響應中斷請求。這樣可以使CPU避免把大量時間耗費在等待，查詢外設狀態的操作上，因此將大大提高系統實時性以及執行效率。</p><p>Huawei LiteOS的中斷支持：</p><ul><li>中斷初始化。</li><li>中斷創建。</li><li>開/關中斷。</li><li>恢復中斷。</li><li>中斷使能。</li><li>中斷屏蔽。</li></ul><p>Huawei LiteOS的中斷機制支持中斷共享。</p><h1>1.1 中斷的介紹</h1><p>與中斷相關的硬件可以劃分為三類：設備、中斷控制器、 CPU本身。 設備：發起中斷的源，當設備需要請求CPU時，產生一箇中斷信號，該信號連接至中斷控制器。</p><p>中斷控制器：中斷控制器是CPU眾多外設中的一個，它一方面接收其它外設中斷引腳的輸入，另一方面，它會發出中斷信號給CPU。可以通過對中斷控制器編程實現對中斷源的優先級、觸發方式、打開和關閉源等設置操作。常用的中斷控制器有VIC（Vector Interrupt Controller）和GIC（General Interrupt Controller），在ARM Cortex-A7中使用的中斷控制器是GIC。</p><p>CPU： CPU會響應中斷源的請求，中斷當前正在執行的任務，轉而執行中斷處理程序。</p><h1>1.2 和中斷相關的名詞解釋</h1><p>中斷號：每個中斷請求信號都會有特定的標誌，使得計算機能夠判斷是哪個設備提出的中斷請求，這個標誌就是中斷號。</p><p>中斷請求：“緊急事件”需向CPU提出申請（發一個電脈衝信號），要求中斷，及要求CPU暫停當前執行的任務，轉而處理該“緊急事件”，這一申請過程稱為中斷申 請。</p><p>中斷優先級：為使系統能夠及時響應並處理所有中斷，系統根據中斷時間的重要性和緊迫程度，將中斷源分為若干個級別，稱作中斷優先級。 Huawei LiteOS中所有的中斷源優先級相同，不支持中斷嵌套或搶佔。</p><p>中斷處理程序：當外設產生中斷請求後， CPU暫停當前的任務，轉而響應中斷申請，即執行中斷處理程序。</p><p>中斷觸發：中斷源發出並送給CPU控制信號，將接口卡上的中斷觸發器置“1”，表明該中斷源產生了中斷，要求CPU去響應該中斷,CPU暫停當前任務，執行相應的中斷處理程序。</p><p>中斷觸發類型：外部中斷申請通過一個物理信號發送到GIC，可以是電平觸發或邊沿觸發。</p><p>中斷向量：中斷服務程序的入口地址。</p><p>中斷向量表：存儲中斷向量的存儲區，中斷向量與中斷號對應，中斷向量在中斷向量表中按照中斷號順序存儲。</p><p>中斷共享：當外設較少時，可以實現一個外設對應一箇中斷號，但為了支持更多的硬件設備，可以讓多個設備共享一箇中斷號，共享同一個中斷的中斷處理程序形成一個鏈表，當外部設備產生中斷申請時，系統會遍歷中斷號對應的中斷處理程序鏈表。</p><p>中斷底半部：中斷處理程序耗時應儘可能短，以滿足中斷的快速響應，為了平衡中斷處理程序的性能與工作量，將中斷處理程序分解為兩部分：頂半部和底半部。</p><p>頂半部完成儘可能少的比較緊急的任務，它往往只是簡單地讀取寄存器中的中斷狀態並清除中斷標誌位即進行“登記工作”，將耗時的底半部處理程序掛到系統的底半部執行隊列中去。</p><h1>1.3 運作機制</h1><p>Huawei LiteOS的中斷機制支持中斷共享：</p><p>中斷共享的實現依賴於鏈表，對應每一箇中斷號創建一個鏈表，鏈表節點中包含註冊的中斷處理函數和函數入參。當對同一中斷號多次創建中斷時，將中斷處理函數和函數入參添加到中斷號對應的鏈表中，因此當硬件產生中斷時，通過中斷號查找到其對應的結構體鏈表，遍歷執行鏈表中的中斷處理函數。</p><p>Huawei LiteOS的中斷機制支持中斷底半部：</p><p>中斷底半部的實現基於workqueue，在中斷處理程序中將工作分為頂半部和底半部，底半部處理程序與work關聯，並掛載到合法workqueue上。系統空閒時執行workqueue中的work上的底半部程序。</p><h1>2. 開發指導</h1><h1>2.1 使用場景</h1><p>當有中斷請求產生時， CPU暫停當前的任務，轉而去響應外設請求。根據需要，用戶通過中斷申請，註冊中斷處理程序，可以指定CPU響應中斷請求時所執行的具體操作。</p><h1>2.2 功能</h1><p>Huawei LiteOS 系統中的中斷模塊為用戶提供下面幾種功能。</p><div class=pgc-img><img alt="liteos 中斷機制（四）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f559c14c75124ca59da5623eef479055><p class=pgc-img-caption></p></div><h1>2.3 HWI錯誤碼</h1><p>對創建中斷存在失敗可能性的操作返回對應的錯誤碼，以便快速定位錯誤原因。</p><div class=pgc-img><img alt="liteos 中斷機制（四）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3605f05024344b509a2cab23a0aa528d><p class=pgc-img-caption></p></div><h1>2.4 開發流程</h1><ol><li>修改配置項</li></ol><ul><li class=ql-indent-1>打開硬中斷裁剪開關： OS_INCLUDE_HWI定義為YES.</li><li class=ql-indent-1>配置硬中斷使用最大數： OS_HWI_MAX_USED_NUM.</li></ul><ol><li>調用中斷初始化Los_HwiInit接口。</li><li>調用中斷創建接口LOS_HwiCreate創建中斷</li><li>調用hal_interrupt_unmask接口使能指定中斷。</li><li>調用hal_interrupt_mask接口屏蔽指定中斷。</li></ol><h1>3. 編程實例</h1><h1>3.1 實例描述</h1><p>本實例實現如下功能。</p><ol><li>關中斷</li><li>中斷創建</li><li>中斷使能</li><li>中斷恢復</li><li>中斷屏蔽</li></ol><h1>3.2 編程示例</h1><p>前提條件：</p><ul><li>在los_config.h中，將OS_INCLUDE_HWI定義為YES。</li><li>在los_config.h中，設置最大硬中斷個數OS_HWI_MAX_USED_NUM。</li></ul><p>代碼實現如下：</p><pre>#include "los_hwi.h"#include "los_typedef.h"#define HWI_NUM_INT50 50void uart_irqhandle(int irq,void *dev){printf("\n int the func uart_irqhandle \n");}void hwi_test(){ int a = 1; UINTPTR uvIntSave; uvIntSave = LOS_IntLock(); LOS_HwiCreate(HWI_NUM_INT50, 0,0,uart_irqhandle,NULL);//創建中斷 hal_interrupt_unmask(HWI_NUM_INT50); LOS_IntRestore(uvIntSave); hal_interrupt_mask(HWI_NUM_INT50);}</pre></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>liteos</a></li><li><a>中斷</a></li><li><a>機制</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/2035c3a3.html alt=聊聊什麼是中斷機制？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ff28505b2bc94e53a9ab304c09d250c8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2035c3a3.html title=聊聊什麼是中斷機制？>聊聊什麼是中斷機制？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bb071e7e.html alt="SQL 事務機制-transaction" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3231427d97bf4a04b148360fea032241 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bb071e7e.html title="SQL 事務機制-transaction">SQL 事務機制-transaction</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5f4c6dc1.html alt=事務機制和鎖機制 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5a547c8c402142cca7ed81d05fe0e3e3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5f4c6dc1.html title=事務機制和鎖機制>事務機制和鎖機制</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6e8f3f2e.html alt=連mysql鎖的機制都不瞭解，怎麼做架構師 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1533476323070887266574f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6e8f3f2e.html title=連mysql鎖的機制都不瞭解，怎麼做架構師>連mysql鎖的機制都不瞭解，怎麼做架構師</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3ad79c04.html alt=什麼是多態機制？Java語言是如何實現多態的？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/d61f4356-80bf-4d14-8d12-f4a6fdca887c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3ad79c04.html title=什麼是多態機制？Java語言是如何實現多態的？>什麼是多態機制？Java語言是如何實現多態的？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/34b07b6f.html alt=天津疫情防控落實“戰時機制”各區黨政主要負責同志停止假期狀態，立即到崗就位 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/34b07b6f.html title=天津疫情防控落實“戰時機制”各區黨政主要負責同志停止假期狀態，立即到崗就位>天津疫情防控落實“戰時機制”各區黨政主要負責同志停止假期狀態，立即到崗就位</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8c21d419.html alt="深入理解 Java 併發核心機制，看完後好爽" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/832db421a3364a20a62c93127ea6e862 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8c21d419.html title="深入理解 Java 併發核心機制，看完後好爽">深入理解 Java 併發核心機制，看完後好爽</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/297117d9.html alt=市稅務局創新制度機制爭創“模範機關” class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d879650a7d06416c90fb7286175f1f59 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/297117d9.html title=市稅務局創新制度機制爭創“模範機關”>市稅務局創新制度機制爭創“模範機關”</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ce33eab5.html alt="機制砂 | 大家知多少？" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/54b1eea319b842bcb8483f4056798bec style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ce33eab5.html title="機制砂 | 大家知多少？">機制砂 | 大家知多少？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/095e0499.html alt=機制砂市價多少錢一噸？一方機制砂折算成噸大概多少？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/2b6d9a5dccf246aeaba80b2a1ecb9f0a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/095e0499.html title=機制砂市價多少錢一噸？一方機制砂折算成噸大概多少？>機制砂市價多少錢一噸？一方機制砂折算成噸大概多少？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5dcd6724.html alt=幾種基於可靠性指標的容量支持機制分析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RZYfwddDNSSyQW style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5dcd6724.html title=幾種基於可靠性指標的容量支持機制分析>幾種基於可靠性指標的容量支持機制分析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c67e6cfe.html alt=java反射機制的講解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9ad2c92f100a4d2e8213dcf70d4781c0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c67e6cfe.html title=java反射機制的講解>java反射機制的講解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/496f3f6a.html alt=劣質機制砂產生的4類原因分析！工藝設計和設備選型非常重要 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7737ac36f58f40a98a798a5cbf5d5295 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/496f3f6a.html title=劣質機制砂產生的4類原因分析！工藝設計和設備選型非常重要>劣質機制砂產生的4類原因分析！工藝設計和設備選型非常重要</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ff1f42a9.html alt=多進程高併發、低時延、高可靠機制在緩存twemproxy代理中的應用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/f31195000b32401b8a5173b87a78fb6f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ff1f42a9.html title=多進程高併發、低時延、高可靠機制在緩存twemproxy代理中的應用>多進程高併發、低時延、高可靠機制在緩存twemproxy代理中的應用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cc850e6c.html alt="乾貨 | 一文讀懂關於機制砂的25個問題" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ddbce23af5e3487f8e5d2fd05226eedf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cc850e6c.html title="乾貨 | 一文讀懂關於機制砂的25個問題">乾貨 | 一文讀懂關於機制砂的25個問題</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>