<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>分佈式的系統核心是什麼——日誌 | 极客快訊</title><meta property="og:title" content="分佈式的系統核心是什麼——日誌 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/1538985938333694a26db5e"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/743dcbd.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/743dcbd.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/743dcbd.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/743dcbd.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/743dcbd.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/743dcbd.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/743dcbd.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/743dcbd.html><meta property="article:published_time" content="2020-10-29T21:05:04+08:00"><meta property="article:modified_time" content="2020-10-29T21:05:04+08:00"><meta name=Keywords content><meta name=description content="分佈式的系統核心是什麼——日誌"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/743dcbd.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>分佈式的系統核心是什麼——日誌</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>什麼是日誌?</p><p>日誌就是按照時間順序追加的、完全有序的記錄序列，其實就是一種特殊的文件格式，文件是一個字節數組，而這裡日誌是一個記錄數據，只是相對於文件來說，這裡每條記錄都是按照時間的相對順序排列的，可以說日誌是最簡單的一種存儲模型，讀取一般都是從左到右，例如消息隊列，一般是線性寫入log文件，消費者順序從offset開始讀取。</p><p>由於日誌本身固有的特性，記錄從左向右開始順序插入，也就意味著左邊的記錄相較於右邊的記錄“更老”, 也就是說我們可以不用依賴於系統時鐘，這個特性對於分佈式系統來說相當重要。</p><div class=pgc-img><img alt=分佈式的系統核心是什麼——日誌 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1538985938333694a26db5e><p class=pgc-img-caption></p></div><p>日誌的應用</p><p><strong>日誌在數據庫中的應用</strong></p><p>日誌是什麼時候出現已經無從得知，可能是概念上來講太簡單。在數據庫領域中日誌更多的是用於在系統crash的時候同步數據以及索引等，例如MySQL中的redo log，redo log是一種基於磁盤的數據結構，用於在系統掛掉的時候保證數據的正確性、完整性，也叫預寫日誌，例如在一個事物的執行過程中，首先會寫redo log，然後才會應用實際的更改，這樣當系統crash後恢復時就能夠根據redo log進行重放從而恢復數據(在初始化的過程中，這個時候不會還沒有客戶端的連接)。日誌也可以用於數據庫主從之間的同步，因為本質上，數據庫所有的操作記錄都已經寫入到了日誌中，我們只要將日誌同步到slave，並在slave重放就能夠實現主從同步，這裡也可以實現很多其他需要的組件，我們可以通過訂閱redo log 從而拿到數據庫所有的變更，從而實現個性化的業務邏輯，例如審計、緩存同步等等。</p><p><strong>日誌在分佈式系統中的應用</strong></p><div class=pgc-img><img alt=分佈式的系統核心是什麼——日誌 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1538985938372d598c9f64a><p class=pgc-img-caption></p></div><p>分佈式系統服務本質上就是關於狀態的變更，這裡可以理解為狀態機，兩個獨立的進程(不依賴於外部環境，例如系統時鐘、外部接口等)給定一致的輸入將會產生一致的輸出並最終保持一致的狀態，而日誌由於其固有的順序性並不依賴系統時鐘，正好可以用來解決變更有序性的問題。</p><p>我們利用這個特性實現解決分佈式系統中遇到的很多問題。例如RocketMQ中的備節點，主broker接收客戶端的請求，並記錄日誌，然後實時同步到salve中，slave在本地重放，當master掛掉的時候，slave可以繼續處理請求，例如拒絕寫請求並繼續處理讀請求。日誌中不僅僅可以記錄數據，也可以直接記錄操作，例如SQL語句。</p><div class=pgc-img><img alt=分佈式的系統核心是什麼——日誌 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15389859383597becbcdbd7><p class=pgc-img-caption></p></div><p>日誌是解決一致性問題的關鍵數據結構，日誌就像是操作序列，每一條記錄代表一條指令，例如應用廣泛的Paxos、Raft協議，都是基於日誌構建起來的一致性協議。</p><div class=pgc-img><img alt=分佈式的系統核心是什麼——日誌 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1538985938381423007f572><p class=pgc-img-caption></p></div><p>日誌在Message Queue中的應用</p><p>日誌可以很方便的用於處理數據之間的流入流出，每一個數據源都可以產生自己的日誌，這裡數據源可以來自各個方面，例如某個事件流(頁面點擊、緩存刷新提醒、數據庫binlog變更)，我們可以將日誌集中存儲到一個集群中，訂閱者可以根據offset來讀取日誌的每條記錄，根據每條記錄中的數據、操作應用自己的變更。</p><p>這裡的日誌可以理解為消息隊列，消息隊列可以起到異步解耦、限流的作用。為什麼說解耦呢？因為對於消費者、生產者來說，兩個角色的職責都很清晰，就負責生產消息、消費消息，而不用關心下游、上游是誰，不管是來數據庫的變更日誌、某個事件也好，對於某一方來說我根本不需要關心，我只需要關注自己感興趣的日誌以及日誌中的每條記錄。</p><div class=pgc-img><img alt=分佈式的系統核心是什麼——日誌 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15389859384185905e537dd><p class=pgc-img-caption></p></div><p>我們知道數據庫的QPS是一定的，而上層應用一般可以橫向擴容，這個時候如果到了雙11這種請求突然的場景，數據庫會吃不消，那麼我們就可以引入消息隊列，將每個隊數據庫的操作寫到日誌中，由另外一個應用專門負責消費這些日誌記錄並應用到數據庫中，而且就算數據庫掛了，當恢復的時候也可以從上次消息的位置繼續處理(RocketMQ和Kafka都支持Exactly Once語義)，這裡即使生產者的速度異於消費者的速度也不會有影響，日誌在這裡起到了緩衝的作用，它可以將所有的記錄存儲到日誌中，並定時同步到slave節點，這樣消息的積壓能力能夠得到很好的提升，因為寫日誌都是有master節點處理，讀請求這裡分為兩種，一種是tail-read，就是說消費速度能夠跟得上寫入速度的，這種讀可以直接走緩存，而另一種也就是落後於寫入請求的消費者，這種可以從slave節點讀取，這樣通過IO隔離以及操作系統自帶的一些文件策略，例如pagecache、緩存預讀等，性能可以得到很大的提升。</p><p>在此我向大家推薦一個架構學習交流群。交流學習群號：874811168裡面會分享一些資深架構師錄製的視頻錄像：有Spring，MyBatis，Netty源碼分析，高併發、高性能、分佈式、微服務架構的原理，JVM性能優化、分佈式架構等這些成為架構師必備的知識體系。還能領取免費的學習資源，目前受益良多。</p><div class=pgc-img><img alt=分佈式的系統核心是什麼——日誌 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15389859384352e84438a9b><p class=pgc-img-caption></p></div><p>分佈式系統中可橫向擴展是一個相當重要的特性，加機器能解決的問題都不是問題。那麼如何實現一個能夠實現橫向擴展的消息隊列呢? 假如我們有一個單機的消息隊列，隨著topic數目的上升，IO、CPU、帶寬等都會逐漸成為瓶頸，性能會慢慢下降，那麼這裡如何進行性能優化呢?</p><p>1.topic/日誌分片，本質上topic寫入的消息就是日誌的記錄，那麼隨著寫入的數量越多，單機會慢慢的成為瓶頸，這個時候我們可以將單個topic分為多個子topic，並將每個topic分配到不同的機器上，通過這種方式，對於那些消息量極大的topic就可以通過加機器解決，而對於一些消息量較少的可以分到到同一臺機器或不進行分區</p><p>2.group commit，例如Kafka的producer客戶端，寫入消息的時候，是先寫入一個本地內存隊列，然後將消息按照每個分區、節點彙總，進行批量提交，對於服務器端或者broker端，也可以利用這種方式，先寫入pagecache，再定時刷盤，刷盤的方式可以根據業務決定，例如金融業務可能會採取同步刷盤的方式。</p><p>3.規避無用的數據拷貝</p><p>4.IO隔離</p><div class=pgc-img><img alt=分佈式的系統核心是什麼——日誌 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1538985938458837fdfeaa9><p class=pgc-img-caption></p></div><p>結語</p><p>日誌在分佈式系統中扮演了很重要的角色，是理解分佈式系統各個組件的關鍵，隨著理解的深入，我們發現很多分佈式中間件都是基於日誌進行構建的，例如Zookeeper、HDFS、Kafka、RocketMQ、Google Spanner等等，甚至於數據庫，例如Redis、MySQL等等，其master-slave都是基於日誌同步的方式，依賴共享的日誌系統，我們可以實現很多系統: 節點間數據同步、併發更新數據順序問題(一致性問題)、持久性(系統crash時能夠通過其他節點繼續提供服務)、分佈式鎖服務等等，相信慢慢的通過實踐、以及大量的論文閱讀之後，一定會有更深層次的理解。</p><p><strong>喜歡的朋友點點關注 後臺私信回覆“java”即可免費獲取JAVA資料一份</strong></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>系統</a></li><li><a>什麼</a></li><li><a>日誌</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/ed538d9e.html alt=什麼是分佈式操作系統，分佈式操作系統有哪些特點？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/61cfa33b-ac3e-462d-83a2-c6b78757e9fa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ed538d9e.html title=什麼是分佈式操作系統，分佈式操作系統有哪些特點？>什麼是分佈式操作系統，分佈式操作系統有哪些特點？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b52ff792.html alt=什麼是分佈式系統！以及分佈式系統架構的優缺點 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RSbrXx83dpwdLU style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b52ff792.html title=什麼是分佈式系統！以及分佈式系統架構的優缺點>什麼是分佈式系統！以及分佈式系統架構的優缺點</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cd468b3c.html alt=什麼是分佈式系統，如何學習分佈式系統 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/7bd535c5-ee76-4743-a46f-44883c831431 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cd468b3c.html title=什麼是分佈式系統，如何學習分佈式系統>什麼是分佈式系統，如何學習分佈式系統</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5f68b0a9.html alt=到底什麼是分佈式系統？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RSW9RN8IBjI8Rq style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5f68b0a9.html title=到底什麼是分佈式系統？>到底什麼是分佈式系統？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fe2fa86e.html alt=什麼是文件系統？嵌入式Linux中的根文件系統？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b34a937fa0ae45708600f114cd0f7e04 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fe2fa86e.html title=什麼是文件系統？嵌入式Linux中的根文件系統？>什麼是文件系統？嵌入式Linux中的根文件系統？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1ed36c87.html alt=飛機和系統安全性中的“可用性”和“完整性”是什麼意思？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/4ad700031e9c54565454 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1ed36c87.html title=飛機和系統安全性中的“可用性”和“完整性”是什麼意思？>飛機和系統安全性中的“可用性”和“完整性”是什麼意思？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7022912.html alt=什麼是操作系統，操作系統都有哪些？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/9113e93c7ffc45908f24f3815f20997c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7022912.html title=什麼是操作系統，操作系統都有哪些？>什麼是操作系統，操作系統都有哪些？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8d2c78c.html alt=磁盤中的“系統”、“其他”究竟是什麼？該怎麼清除？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/0d1e455c231a413190a09c192133d600 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8d2c78c.html title=磁盤中的“系統”、“其他”究竟是什麼？該怎麼清除？>磁盤中的“系統”、“其他”究竟是什麼？該怎麼清除？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3accc15.html alt=科普：什麼是操作系統? class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/b32fc417399b48acbb26c1352d612f11 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3accc15.html title=科普：什麼是操作系統?>科普：什麼是操作系統?</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/974c1d1.html alt=「不懂就問」什麼是液壓系統的開式系統 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/19b054ccacc6496980bf8d508e9d965d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/974c1d1.html title=「不懂就問」什麼是液壓系統的開式系統>「不懂就問」什麼是液壓系統的開式系統</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7d9d178.html alt=CRM系統的核心是什麼？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4a78af0ffa0d437a9047fb9aad4b58d1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7d9d178.html title=CRM系統的核心是什麼？>CRM系統的核心是什麼？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ca820f5.html alt=什麼是OA系統，什麼是工單系統，有啥區別？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a7305e2ef7f5424782fdc52a34cb293b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ca820f5.html title=什麼是OA系統，什麼是工單系統，有啥區別？>什麼是OA系統，什麼是工單系統，有啥區別？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3569e09.html alt=什麼是設計系統？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/1c473e8618a44ee7b968d837c0a8a946 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3569e09.html title=什麼是設計系統？>什麼是設計系統？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6feb00d.html alt=「系統架構」什麼是容器？什麼是控制反轉？什麼是依賴注入？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/25947c9f36f14589bd3b3908877f2cf9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6feb00d.html title=「系統架構」什麼是容器？什麼是控制反轉？什麼是依賴注入？>「系統架構」什麼是容器？什麼是控制反轉？什麼是依賴注入？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d059e23.html alt=什麼是網絡操作系統，與普通操作系統有什麼區別 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d059e23.html title=什麼是網絡操作系統，與普通操作系統有什麼區別>什麼是網絡操作系統，與普通操作系統有什麼區別</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>