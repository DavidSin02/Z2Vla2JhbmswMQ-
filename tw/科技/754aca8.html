<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus | æå®¢å¿«è¨Š</title><meta property="og:title" content="Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/153260587912802d119c482"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/754aca8.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/754aca8.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/754aca8.html><meta property="article:published_time" content="2020-10-29T21:04:29+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:29+08:00"><meta name=Keywords content><meta name=description content="Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/754aca8.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p><strong>èƒŒæ™¯</strong></p><p>å°æ–¼Androidç³»çµ±ä¾†èªªï¼Œæ¶ˆæ¯å‚³éæ˜¯æœ€åŸºæœ¬çš„çµ„ä»¶ï¼Œæ¯ä¸€å€‹Appå…§çš„ä¸åŒé é¢ï¼Œä¸åŒçµ„ä»¶éƒ½åœ¨é€²è¡Œæ¶ˆæ¯å‚³éã€‚æ¶ˆæ¯å‚³éæ—¢å¯ä»¥ç”¨æ–¼Androidå››å¤§çµ„ä»¶ä¹‹é–“çš„é€šä¿¡ï¼Œä¹Ÿå¯ç”¨æ–¼ç•°æ­¥ç·šç¨‹å’Œä¸»ç·šç¨‹ä¹‹é–“çš„é€šä¿¡ã€‚å°æ–¼Androidé–‹ç™¼è€…ä¾†èªªï¼Œç¶“å¸¸ä½¿ç”¨çš„æ¶ˆæ¯å‚³éæ–¹å¼æœ‰å¾ˆå¤šç¨®ï¼Œå¾æœ€æ—©ä½¿ç”¨çš„Handlerã€BroadcastReceiverã€æ¥å£å›èª¿ï¼Œåˆ°è¿‘å¹¾å¹´æµè¡Œçš„é€šä¿¡ç¸½ç·šé¡æ¡†æ¶EventBusã€RxBusã€‚Androidæ¶ˆæ¯å‚³éæ¡†æ¶ï¼Œç¸½åœ¨ä¸æ–·çš„æ¼”é€²ä¹‹ä¸­ã€‚</p><p><strong>å¾EventBusèªªèµ·</strong></p><p>EventBusæ˜¯ä¸€å€‹Androidäº‹ä»¶ç™¼ä½ˆ/è¨‚é–±æ¡†æ¶ï¼Œé€šéè§£è€¦ç™¼ä½ˆè€…å’Œè¨‚é–±è€…ç°¡åŒ–Androidäº‹ä»¶å‚³éã€‚EventBuså¯ä»¥ä»£æ›¿Androidå‚³çµ±çš„Intentã€Handlerã€Broadcastæˆ–æ¥å£å›èª¿ï¼Œåœ¨Fragmentã€Activityã€Serviceç·šç¨‹ä¹‹é–“å‚³éæ•¸æ“šï¼ŒåŸ·è¡Œæ–¹æ³•ã€‚</p><p>EventBusæœ€å¤§çš„ç‰¹é»å°±æ˜¯ç°¡æ½”ã€è§£è€¦ã€‚åœ¨æ²’æœ‰EventBusä¹‹å‰æˆ‘å€‘é€šå¸¸ç”¨å»£æ’­ä¾†å¯¦ç¾ç›£è½ï¼Œæˆ–è€…è‡ªå®šç¾©æ¥å£å‡½æ•¸å›èª¿ï¼Œæœ‰çš„å ´æ™¯æˆ‘å€‘ä¹Ÿå¯ä»¥ç›´æ¥ç”¨Intentæ”œå¸¶ç°¡å–®æ•¸æ“šï¼Œæˆ–è€…åœ¨ç·šç¨‹ä¹‹é–“é€šéHandlerè™•ç†æ¶ˆæ¯å‚³éã€‚ä½†ç„¡è«–æ˜¯å»£æ’­é‚„æ˜¯Handleræ©Ÿåˆ¶é é ä¸èƒ½æ»¿è¶³æˆ‘å€‘é«˜æ•ˆçš„é–‹ç™¼ã€‚EventBusç°¡åŒ–äº†æ‡‰ç”¨ç¨‹åºå…§å„çµ„ä»¶é–“ã€çµ„ä»¶èˆ‡å¾Œè‡ºç·šç¨‹é–“çš„é€šä¿¡ã€‚EventBusä¸€ç¶“æ¨å‡ºï¼Œä¾¿å—åˆ°å»£å¤§é–‹ç™¼è€…çš„æ¨å´‡ã€‚</p><p>ç¾åœ¨çœ‹ä¾†ï¼ŒEventBusçµ¦Androidé–‹ç™¼è€…ä¸–ç•Œå¸¶ä¾†äº†ä¸€ç¨®æ–°çš„æ¡†æ¶å’Œæ€æƒ³ï¼Œå°±æ˜¯æ¶ˆæ¯çš„ç™¼ä½ˆå’Œè¨‚é–±ã€‚é€™ç¨®æ€æƒ³åœ¨å…¶å¾Œå¾ˆå¤šæ¡†æ¶ä¸­éƒ½å¾—åˆ°äº†æ‡‰ç”¨ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153260587912802d119c482><p class=pgc-img-caption></p></div><p>åœ–ç‰‡æ‘˜è‡ªEventBus GitHubä¸»é </p><p><strong>ç™¼ä½ˆ/è¨‚é–±æ¨¡å¼</strong></p><p>è¨‚é–±ç™¼ä½ˆæ¨¡å¼å®šç¾©äº†ä¸€ç¨®â€œä¸€å°å¤šâ€çš„ä¾è³´é—œä¿‚ï¼Œè®“å¤šå€‹è¨‚é–±è€…å°è±¡åŒæ™‚ç›£è½æŸä¸€å€‹ä¸»é¡Œå°è±¡ã€‚é€™å€‹ä¸»é¡Œå°è±¡åœ¨è‡ªèº«ç‹€æ…‹è®ŠåŒ–æ™‚ï¼Œæœƒé€šçŸ¥æ‰€æœ‰è¨‚é–±è€…å°è±¡ï¼Œä½¿å®ƒå€‘èƒ½å¤ è‡ªå‹•æ›´æ–°è‡ªå·±çš„ç‹€æ…‹ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1532605879208bb17a1c8b4><p class=pgc-img-caption></p></div><p><strong>RxBusçš„å‡ºç¾</strong></p><p>RxBusä¸æ˜¯ä¸€å€‹åº«ï¼Œè€Œæ˜¯ä¸€å€‹æ–‡ä»¶ï¼Œå¯¦ç¾åªæœ‰çŸ­çŸ­30è¡Œä»£ç¢¼ã€‚RxBusæœ¬èº«ä¸éœ€è¦éå¤šåˆ†æï¼Œå®ƒçš„å¼·å¤§å®Œå…¨ä¾†è‡ªæ–¼å®ƒåŸºæ–¼çš„RxJavaæŠ€è¡“ã€‚éŸ¿æ‡‰å¼ç·¨ç¨‹ï¼ˆReactive Programmingï¼‰æŠ€è¡“é€™å¹¾å¹´ç‰¹åˆ¥ç«ï¼ŒRxJavaæ˜¯å®ƒåœ¨Javaä¸Šçš„å¯¦ä½œã€‚RxJavaå¤©ç”Ÿå°±æ˜¯ç™¼ä½ˆ/è¨‚é–±æ¨¡å¼ï¼Œè€Œä¸”å¾ˆå®¹æ˜“è™•ç†ç·šç¨‹åˆ‡æ›ã€‚æ‰€ä»¥ï¼ŒRxBusæ†‘è—‰å€å€30è¡Œä»£ç¢¼ï¼Œå°±æ•¢æŒ‘æˆ°EventBusâ€œæ±Ÿæ¹–è€å¤§â€çš„åœ°ä½ã€‚</p><p><strong>RxBusåŸç†</strong></p><p>åœ¨RxJavaä¸­æœ‰å€‹Subjecté¡ï¼Œå®ƒç¹¼æ‰¿Observableé¡ï¼ŒåŒæ™‚å¯¦ç¾äº†Observeræ¥å£ï¼Œå› æ­¤Subjectå¯ä»¥åŒæ™‚æ“”ç•¶è¨‚é–±è€…å’Œè¢«è¨‚é–±è€…çš„è§’è‰²ï¼Œæˆ‘å€‘ä½¿ç”¨Subjectçš„å­é¡PublishSubjectä¾†å‰µå»ºä¸€å€‹Subjectå°è±¡ï¼ˆPublishSubjectåªæœ‰è¢«è¨‚é–±å¾Œæ‰æœƒæŠŠæ¥æ”¶åˆ°çš„äº‹ä»¶ç«‹åˆ»ç™¼é€çµ¦è¨‚é–±è€…ï¼‰ï¼Œåœ¨éœ€è¦æ¥æ”¶äº‹ä»¶çš„åœ°æ–¹ï¼Œè¨‚é–±è©²Subjectå°è±¡ï¼Œä¹‹å¾Œå¦‚æœSubjectå°è±¡æ¥æ”¶åˆ°äº‹ä»¶ï¼Œå‰‡æœƒç™¼å°„çµ¦è©²è¨‚é–±è€…ï¼Œæ­¤æ™‚Subjectå°è±¡å……ç•¶è¢«è¨‚é–±è€…çš„è§’è‰²ã€‚</p><p>å®Œæˆäº†è¨‚é–±ï¼Œåœ¨éœ€è¦ç™¼é€äº‹ä»¶çš„åœ°æ–¹å°‡äº‹ä»¶ç™¼é€çµ¦ä¹‹å‰è¢«è¨‚é–±çš„Subjectå°è±¡ï¼Œå‰‡æ­¤æ™‚Subjectå°è±¡ä½œç‚ºè¨‚é–±è€…æ¥æ”¶äº‹ä»¶ï¼Œç„¶å¾Œæœƒç«‹åˆ»å°‡äº‹ä»¶è½‰ç™¼çµ¦è¨‚é–±è©²Subjectå°è±¡çš„è¨‚é–±è€…ï¼Œä»¥ä¾¿è¨‚é–±è€…è™•ç†ç›¸æ‡‰äº‹ä»¶ï¼Œåˆ°é€™è£¡å°±å®Œæˆäº†äº‹ä»¶çš„ç™¼é€èˆ‡è™•ç†ã€‚</p><p>æœ€å¾Œå°±æ˜¯å–æ¶ˆè¨‚é–±çš„æ“ä½œäº†ï¼ŒRxJavaä¸­ï¼Œè¨‚é–±æ“ä½œæœƒè¿”å›ä¸€å€‹Subscriptionå°è±¡ï¼Œä»¥ä¾¿åœ¨åˆé©çš„æ™‚æ©Ÿå–æ¶ˆè¨‚é–±ï¼Œé˜²æ­¢å…§å­˜æ´©æ¼ï¼Œå¦‚æœä¸€å€‹é¡ç”¢ç”Ÿå¤šå€‹Subscriptionå°è±¡ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ä¸€å€‹CompositeSubscriptionå­˜å„²èµ·ä¾†ï¼Œä»¥é€²è¡Œæ‰¹é‡çš„å–æ¶ˆè¨‚é–±ã€‚</p><p><strong>RxBusæœ‰å¾ˆå¤šå¯¦ç¾ï¼Œå¦‚ï¼š</strong></p><blockquote><p>AndroidKnife/RxBusï¼ˆhttps://github.com/AndroidKnife/RxBusï¼‰</p><p>Blankj/RxBusï¼ˆhttps://github.com/Blankj/RxBusï¼‰</p></blockquote><p>å…¶å¯¦æ­£å¦‚å‰é¢æ‰€èªªçš„ï¼ŒRxBusçš„åŸç†æ˜¯å¦‚æ­¤ç°¡å–®ï¼Œæˆ‘å€‘è‡ªå·±éƒ½å¯ä»¥å¯«å‡ºä¸€å€‹RxBusçš„å¯¦ç¾ï¼š</p><p><strong>åŸºæ–¼RxJava1çš„RxBuså¯¦ç¾ï¼š</strong></p><blockquote><p>public final class RxBus {</p><p>private final Subject&lt;Object, Object> bus;</p><p>private RxBus() {</p><p>bus = new SerializedSubject&lt;>(PublishSubject.create());</p><p>}</p><p>private static class SingletonHolder {</p><p>private static final RxBus defaultRxBus = new RxBus();</p><p>}</p><p>public static RxBus getInstance() {</p><p>return SingletonHolder.defaultRxBus;</p><p>}</p><p>/*</p><p>* ç™¼é€</p><p>*/</p><p>public void post(Object o) {</p><p>bus.onNext(o);</p><p>}</p><p>/*</p><p>* æ˜¯å¦æœ‰Observableè¨‚é–±</p><p>*/</p><p>public boolean hasObservable() {</p><p>return bus.hasObservers();</p><p>}</p><p>/*</p><p>* è½‰æ›ç‚ºç‰¹å®šé¡å‹çš„Obserbale</p><p>*/</p><p>public &lt;T> Observable&lt;T> toObservable(Class&lt;T> type) {</p><p>return bus.ofType(type);</p><p>}</p><p>}</p></blockquote><p><strong>åŸºæ–¼RxJava2çš„RxBuså¯¦ç¾ï¼š</strong></p><blockquote><p>public final class RxBus2 {</p><p>private final Subject&lt;Object> bus;</p><p>private RxBus2() {</p><p>// toSerialized method made bus thread safe</p><p>bus = PublishSubject.create().toSerialized();</p><p>}</p><p>public static RxBus2 getInstance() {</p><p>return Holder.BUS;</p><p>}</p><p>private static class Holder {</p><p>private static final RxBus2 BUS = new RxBus2();</p><p>}</p><p>public void post(Object obj) {</p><p>bus.onNext(obj);</p><p>}</p><p>public &lt;T> Observable&lt;T> toObservable(Class&lt;T> tClass) {</p><p>return bus.ofType(tClass);</p><p>}</p><p>public Observable&lt;Object> toObservable() {</p><p>return bus;</p><p>}</p><p>public boolean hasObservers() {</p><p>return bus.hasObservers();</p><p>}</p><p>}</p></blockquote><p><strong>å¼•å…¥LiveDataBusçš„æƒ³æ³•</strong></p><p><strong>å¾LiveDataè«‡èµ·</strong></p><p>LiveDataæ˜¯Android Architecture Componentsæå‡ºçš„æ¡†æ¶ã€‚LiveDataæ˜¯ä¸€å€‹å¯ä»¥è¢«è§€å¯Ÿçš„æ•¸æ“šæŒæœ‰é¡ï¼Œå®ƒå¯ä»¥æ„ŸçŸ¥ä¸¦éµå¾ªActivityã€Fragmentæˆ–Serviceç­‰çµ„ä»¶çš„ç”Ÿå‘½é€±æœŸã€‚æ­£æ˜¯ç”±æ–¼LiveDataå°çµ„ä»¶ç”Ÿå‘½é€±æœŸå¯æ„ŸçŸ¥ç‰¹é»ï¼Œå› æ­¤å¯ä»¥åšåˆ°åƒ…åœ¨çµ„ä»¶è™•æ–¼ç”Ÿå‘½é€±æœŸçš„æ¿€æ´»ç‹€æ…‹æ™‚æ‰æ›´æ–°UIæ•¸æ“šã€‚</p><p>LiveDataéœ€è¦ä¸€å€‹è§€å¯Ÿè€…å°è±¡ï¼Œä¸€èˆ¬æ˜¯Observeré¡çš„å…·é«”å¯¦ç¾ã€‚ç•¶è§€å¯Ÿè€…çš„ç”Ÿå‘½é€±æœŸè™•æ–¼STARTEDæˆ–RESUMEDç‹€æ…‹æ™‚ï¼ŒLiveDataæœƒé€šçŸ¥è§€å¯Ÿè€…æ•¸æ“šè®ŠåŒ–ï¼›åœ¨è§€å¯Ÿè€…è™•æ–¼å…¶ä»–ç‹€æ…‹æ™‚ï¼Œå³ä½¿LiveDataçš„æ•¸æ“šè®ŠåŒ–äº†ï¼Œä¹Ÿä¸æœƒé€šçŸ¥ã€‚</p><p><strong>LiveDataçš„å„ªé»</strong></p><ul><li><strong>UIå’Œå¯¦æ™‚æ•¸æ“šä¿æŒä¸€è‡´ï¼Œ</strong>å› ç‚ºLiveDataæ¡ç”¨çš„æ˜¯è§€å¯Ÿè€…æ¨¡å¼ï¼Œé€™æ¨£ä¸€ä¾†å°±å¯ä»¥åœ¨æ•¸æ“šç™¼ç”Ÿæ”¹è®Šæ™‚ç²å¾—é€šçŸ¥ï¼Œæ›´æ–°UIã€‚</li><li><strong>é¿å…å…§å­˜æ´©æ¼ï¼Œ</strong>è§€å¯Ÿè€…è¢«ç¶å®šåˆ°çµ„ä»¶çš„ç”Ÿå‘½é€±æœŸä¸Šï¼Œç•¶è¢«ç¶å®šçš„çµ„ä»¶éŠ·ç‡¬ï¼ˆdestroyï¼‰æ™‚ï¼Œè§€å¯Ÿè€…æœƒç«‹åˆ»è‡ªå‹•æ¸…ç†è‡ªèº«çš„æ•¸æ“šã€‚</li><li><strong>ä¸æœƒå†ç”¢ç”Ÿç”±æ–¼Activityè™•æ–¼stopç‹€æ…‹è€Œå¼•èµ·çš„å´©æ½°ï¼Œ</strong>ä¾‹å¦‚ï¼šç•¶Activityè™•æ–¼å¾Œè‡ºç‹€æ…‹æ™‚ï¼Œæ˜¯ä¸æœƒæ”¶åˆ°LiveDataçš„ä»»ä½•äº‹ä»¶çš„ã€‚</li><li><strong>ä¸éœ€è¦å†è§£æ±ºç”Ÿå‘½é€±æœŸå¸¶ä¾†çš„å•é¡Œï¼Œ</strong>LiveDataå¯ä»¥æ„ŸçŸ¥è¢«ç¶å®šçš„çµ„ä»¶çš„ç”Ÿå‘½é€±æœŸï¼Œåªæœ‰åœ¨æ´»èºç‹€æ…‹æ‰æœƒé€šçŸ¥æ•¸æ“šè®ŠåŒ–ã€‚</li><li><strong>å¯¦æ™‚æ•¸æ“šåˆ·æ–°ï¼Œ</strong>ç•¶çµ„ä»¶è™•æ–¼æ´»èºç‹€æ…‹æˆ–è€…å¾ä¸æ´»èºç‹€æ…‹åˆ°æ´»èºç‹€æ…‹æ™‚ç¸½æ˜¯èƒ½æ”¶åˆ°æœ€æ–°çš„æ•¸æ“šã€‚</li><li><strong>è§£æ±ºConfiguration Changeå•é¡Œï¼Œ</strong>åœ¨å±å¹•ç™¼ç”Ÿæ—‹è½‰æˆ–è€…è¢«å›æ”¶å†æ¬¡å•Ÿå‹•ï¼Œç«‹åˆ»å°±èƒ½æ”¶åˆ°æœ€æ–°çš„æ•¸æ“šã€‚</li></ul><p>è«‡ä¸€è«‡Android Architecture Components</p><p>Android Architecture Componentsçš„æ ¸å¿ƒæ˜¯Lifecycleã€LiveDataã€ViewModel ä»¥åŠ Roomï¼Œé€šéå®ƒå¯ä»¥éå¸¸å„ªé›…çš„è®“æ•¸æ“šèˆ‡ç•Œé¢é€²è¡Œäº¤äº’ï¼Œä¸¦åšä¸€äº›æŒä¹…åŒ–çš„æ“ä½œï¼Œé«˜åº¦è§£è€¦ï¼Œè‡ªå‹•ç®¡ç†ç”Ÿå‘½é€±æœŸï¼Œè€Œä¸”ä¸ç”¨æ“”å¿ƒå…§å­˜æ´©æ¼çš„å•é¡Œã€‚</p><ul><li><strong>Room</strong></li><li>ä¸€å€‹å¼·å¤§çš„SQLiteå°è±¡æ˜ å°„åº«ã€‚</li><li><strong>ViewModel</strong></li><li>ä¸€é¡å°è±¡ï¼Œå®ƒç”¨æ–¼ç‚ºUIçµ„ä»¶æä¾›æ•¸æ“šï¼Œåœ¨è¨­å‚™é…ç½®ç™¼ç”Ÿè®Šæ›´æ™‚ä¾èˆŠå¯ä»¥å­˜æ´»ã€‚</li><li><strong>LiveData</strong> ä¸€å€‹å¯æ„ŸçŸ¥ç”Ÿå‘½é€±æœŸã€å¯è¢«è§€å¯Ÿçš„æ•¸æ“šå®¹å™¨ï¼Œå®ƒå¯ä»¥å­˜å„²æ•¸æ“šï¼Œé‚„æœƒåœ¨æ•¸æ“šç™¼ç”Ÿæ”¹è®Šæ™‚é€²è¡Œæé†’ã€‚</li><li><strong>Lifecycle</strong></li><li>åŒ…å«LifeCycleOwerå’ŒLifecycleObserverï¼Œåˆ†åˆ¥æ˜¯ç”Ÿå‘½é€±æœŸæ‰€æœ‰è€…å’Œç”Ÿå‘½é€±æœŸæ„ŸçŸ¥è€…ã€‚</li></ul><p><strong>Android Architecture Componentsçš„ç‰¹é»</strong></p><ul><li><strong>æ•¸æ“šé©…å‹•å‹ç·¨ç¨‹</strong></li><li>è®ŠåŒ–çš„æ°¸é æ˜¯æ•¸æ“šï¼Œç•Œé¢ç„¡éœ€æ›´æ”¹ã€‚</li><li><strong>æ„ŸçŸ¥ç”Ÿå‘½é€±æœŸï¼Œé˜²æ­¢å…§å­˜æ´©æ¼</strong></li><li><strong>é«˜åº¦è§£è€¦</strong></li><li>æ•¸æ“šï¼Œç•Œé¢é«˜åº¦åˆ†é›¢ã€‚</li><li><strong>æ•¸æ“šæŒä¹…åŒ–</strong></li><li>æ•¸æ“šã€ViewModelä¸èˆ‡ UIçš„ç”Ÿå‘½é€±æœŸæ›é‰¤ï¼Œä¸æœƒå› ç‚ºç•Œé¢çš„é‡å»ºè€ŒéŠ·ç‡¬ã€‚</li></ul><p><strong>é‡é»ï¼šç‚ºä»€éº¼ä½¿ç”¨LiveDataæ§‹å»ºæ•¸æ“šé€šä¿¡ç¸½ç·šLiveDataBus</strong></p><p><strong>ä½¿ç”¨LiveDataçš„ç†ç”±</strong></p><ul><li><strong>LiveDataå…·æœ‰çš„é€™ç¨®å¯è§€å¯Ÿæ€§å’Œç”Ÿå‘½é€±æœŸæ„ŸçŸ¥çš„èƒ½åŠ›ï¼Œä½¿å…¶éå¸¸é©åˆä½œç‚ºAndroidé€šä¿¡ç¸½ç·šçš„åŸºç¤æ§‹ä»¶ã€‚</strong></li><li><strong>ä½¿ç”¨è€…ä¸ç”¨é¡¯ç¤ºèª¿ç”¨åè¨»å†Šæ–¹æ³•ã€‚</strong></li><li>ç”±æ–¼LiveDataå…·æœ‰ç”Ÿå‘½é€±æœŸæ„ŸçŸ¥èƒ½åŠ›ï¼Œæ‰€ä»¥LiveDataBusåªéœ€è¦èª¿ç”¨è¨»å†Šå›èª¿æ–¹æ³•ï¼Œè€Œä¸éœ€è¦é¡¯ç¤ºçš„èª¿ç”¨åè¨»å†Šæ–¹æ³•ã€‚é€™æ¨£å¸¶ä¾†çš„å¥½è™•ä¸åƒ…å¯ä»¥ç·¨å¯«æ›´å°‘çš„ä»£ç¢¼ï¼Œè€Œä¸”å¯ä»¥å®Œå…¨æœçµ•å…¶ä»–é€šä¿¡ç¸½ç·šé¡æ¡†æ¶ï¼ˆå¦‚EventBusã€RxBusï¼‰å¿˜è¨˜èª¿ç”¨åè¨»å†Šæ‰€å¸¶ä¾†çš„å…§å­˜æ´©æ¼çš„é¢¨éšªã€‚</li></ul><p><strong>ç‚ºä»€éº¼è¦ç”¨LiveDataBusæ›¿ä»£EventBuså’ŒRxBus</strong></p><ul><li><strong>LiveDataBusçš„å¯¦ç¾åŠå…¶ç°¡å–®</strong>ï¼Œç›¸å°EventBusè¤‡é›œçš„å¯¦ç¾ï¼ŒLiveDataBusåªéœ€è¦ä¸€å€‹é¡å°±å¯ä»¥å¯¦ç¾ã€‚</li><li><strong>LiveDataBuså¯ä»¥æ¸›å°APKåŒ…çš„å¤§å°</strong>ï¼Œç”±æ–¼LiveDataBusåªä¾è³´Androidå®˜æ–¹Android Architecture Componentsçµ„ä»¶çš„LiveDataï¼Œæ²’æœ‰å…¶ä»–ä¾è³´ï¼Œæœ¬èº«å¯¦ç¾åªæœ‰ä¸€å€‹é¡ã€‚ä½œç‚ºæ¯”è¼ƒï¼ŒEventBus JARåŒ…å¤§å°ç‚º57kbï¼ŒRxBusä¾è³´RxJavaå’ŒRxAndroidï¼Œå…¶ä¸­RxJava2åŒ…å¤§å°2.2MBï¼ŒRxJava1åŒ…å¤§å°1.1MBï¼ŒRxAndroidåŒ…å¤§å°9kbã€‚ä½¿ç”¨LiveDataBuså¯ä»¥å¤§å¤§æ¸›å°APKåŒ…çš„å¤§å°ã€‚</li><li><strong>LiveDataBusä¾è³´æ–¹æ”¯æŒæ›´å¥½</strong>ï¼ŒLiveDataBusåªä¾è³´Androidå®˜æ–¹Android Architecture Componentsçµ„ä»¶çš„LiveDataï¼Œç›¸æ¯”RxBusä¾è³´çš„RxJavaå’ŒRxAndroidï¼Œä¾è³´æ–¹æ”¯æŒæ›´å¥½ã€‚</li><li><strong>LiveDataBuså…·æœ‰ç”Ÿå‘½é€±æœŸæ„ŸçŸ¥</strong>ï¼ŒLiveDataBuså…·æœ‰ç”Ÿå‘½é€±æœŸæ„ŸçŸ¥ï¼Œåœ¨Androidç³»çµ±ä¸­ä½¿ç”¨èª¿ç”¨è€…ä¸éœ€è¦èª¿ç”¨åè¨»å†Šï¼Œç›¸æ¯”EventBuså’ŒRxBusä½¿ç”¨æ›´ç‚ºæ–¹ä¾¿ï¼Œä¸¦ä¸”æ²’æœ‰å…§å­˜æ´©æ¼é¢¨éšªã€‚</li></ul><p><strong>LiveDataBusçš„è¨­è¨ˆå’Œæ¶æ§‹</strong></p><p><strong>LiveDataBusçš„çµ„æˆ</strong></p><ul><li><strong>æ¶ˆæ¯</strong></li><li>æ¶ˆæ¯å¯ä»¥æ˜¯ä»»ä½•çš„Objectï¼Œå¯ä»¥å®šç¾©ä¸åŒé¡å‹çš„æ¶ˆæ¯ï¼Œå¦‚Booleanã€Stringã€‚ä¹Ÿå¯ä»¥å®šç¾©è‡ªå®šç¾©é¡å‹çš„æ¶ˆæ¯ã€‚</li><li><strong>æ¶ˆæ¯é€šé“</strong></li><li>LiveDataæ‰®æ¼”äº†æ¶ˆæ¯é€šé“çš„è§’è‰²ï¼Œä¸åŒçš„æ¶ˆæ¯é€šé“ç”¨ä¸åŒçš„åå­—å€åˆ†ï¼Œåå­—æ˜¯Stringé¡å‹çš„ï¼Œå¯ä»¥é€šéåå­—ç²å–åˆ°ä¸€å€‹LiveDataæ¶ˆæ¯é€šé“ã€‚</li><li><strong>æ¶ˆæ¯ç¸½ç·š</strong></li><li>æ¶ˆæ¯ç¸½ç·šé€šéå–®ä¾‹å¯¦ç¾ï¼Œä¸åŒçš„æ¶ˆæ¯é€šé“å­˜æ”¾åœ¨ä¸€å€‹HashMapä¸­ã€‚</li><li><strong>è¨‚é–±</strong></li><li>è¨‚é–±è€…é€šégetChannelç²å–æ¶ˆæ¯é€šé“ï¼Œç„¶å¾Œèª¿ç”¨observeè¨‚é–±é€™å€‹é€šé“çš„æ¶ˆæ¯ã€‚</li><li><strong>ç™¼ä½ˆ</strong></li><li>ç™¼ä½ˆè€…é€šégetChannelç²å–æ¶ˆæ¯é€šé“ï¼Œç„¶å¾Œèª¿ç”¨setValueæˆ–è€…postValueç™¼ä½ˆæ¶ˆæ¯ã€‚</li></ul><p><strong>LiveDataBusåŸç†åœ–</strong></p><div class=pgc-img><img alt=Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1532605879297c275574cb1><p class=pgc-img-caption></p></div><p><strong>LiveDataBusçš„å¯¦ç¾</strong></p><p><strong>ç¬¬ä¸€å€‹å¯¦ç¾ï¼š</strong></p><blockquote><p>public final class LiveDataBus {</p><p>private final Map&lt;String, MutableLiveData&lt;Object>> bus;</p><p>private LiveDataBus() {</p><p>bus = new HashMap&lt;>();</p><p>}</p><p>private static class SingletonHolder {</p><p>private static final LiveDataBus DATA_BUS = new LiveDataBus();</p><p>}</p><p>public static LiveDataBus get() {</p><p>return SingletonHolder.DATA_BUS;</p><p>}</p><p>public &lt;T> MutableLiveData&lt;T> getChannel(String target, Class&lt;T> type) {</p><p>if (!bus.containsKey(target)) {</p><p>bus.put(target, new MutableLiveData&lt;>());</p><p>}</p><p>return (MutableLiveData&lt;T>) bus.get(target);</p><p>}</p><p>public MutableLiveData&lt;Object> getChannel(String target) {</p><p>return getChannel(target, Object.class);</p><p>}</p><p>}</p></blockquote><p>çŸ­çŸ­äºŒåè¡Œä»£ç¢¼ï¼Œå°±å¯¦ç¾äº†ä¸€å€‹é€šä¿¡ç¸½ç·šçš„å…¨éƒ¨åŠŸèƒ½ï¼Œä¸¦ä¸”é‚„å…·æœ‰ç”Ÿå‘½é€±æœŸæ„ŸçŸ¥åŠŸèƒ½ï¼Œä¸¦ä¸”ä½¿ç”¨èµ·ä¾†ä¹ŸåŠå…¶ç°¡å–®ï¼š</p><p><strong>è¨»å†Šè¨‚é–±ï¼š</strong></p><blockquote><p>LiveDataBus.get().getChannel("key_test", Boolean.class)</p><p>.observe(this, new Observer&lt;Boolean>() {</p><p>@Override</p><p>public void onChanged(@Nullable Boolean aBoolean) {</p><p>}</p><p>});</p></blockquote><p><strong>ç™¼é€æ¶ˆæ¯ï¼š</strong></p><blockquote><p>LiveDataBus.get().getChannel("key_test").setValue(true);</p></blockquote><p>æˆ‘å€‘ç™¼é€äº†ä¸€å€‹åç‚º"key_test"ï¼Œå€¼ç‚ºtrueçš„äº‹ä»¶ã€‚</p><p>é€™å€‹æ™‚å€™è¨‚é–±è€…å°±æœƒæ”¶åˆ°æ¶ˆæ¯ï¼Œä¸¦ä½œç›¸æ‡‰çš„è™•ç†ï¼Œéå¸¸ç°¡å–®ã€‚</p><p><strong>å•é¡Œå‡ºç¾</strong></p><p>å°æ–¼LiveDataBusçš„ç¬¬ä¸€ç‰ˆå¯¦ç¾ï¼Œæˆ‘å€‘ç™¼ç¾ï¼Œåœ¨ä½¿ç”¨é€™å€‹LiveDataBusçš„éç¨‹ä¸­ï¼Œè¨‚é–±è€…æœƒæ”¶åˆ°è¨‚é–±ä¹‹å‰ç™¼ä½ˆçš„æ¶ˆæ¯ã€‚å°æ–¼ä¸€å€‹æ¶ˆæ¯ç¸½ç·šä¾†èªªï¼Œé€™æ˜¯ä¸å¯æ¥å—çš„ã€‚ç„¡è«–EventBusæˆ–è€…RxBusï¼Œè¨‚é–±æ–¹éƒ½ä¸æœƒæ”¶åˆ°è¨‚é–±ä¹‹å‰ç™¼å‡ºçš„æ¶ˆæ¯ã€‚å°æ–¼ä¸€å€‹æ¶ˆæ¯ç¸½ç·šï¼ŒLiveDataBuså¿…é ˆè¦è§£æ±ºé€™å€‹å•é¡Œã€‚</p><p><strong>å•é¡Œåˆ†æ</strong></p><p>æ€éº¼è§£æ±ºé€™å€‹å•é¡Œå‘¢ï¼Ÿå…ˆåˆ†æä¸‹åŸå› ï¼š</p><p>ç•¶LifeCircleOwnerçš„ç‹€æ…‹ç™¼ç”Ÿè®ŠåŒ–çš„æ™‚å€™ï¼Œæœƒèª¿ç”¨LiveData.ObserverWrapperçš„activeStateChangedå‡½æ•¸ï¼Œå¦‚æœé€™å€‹æ™‚å€™ObserverWrapperçš„ç‹€æ…‹æ˜¯activeï¼Œå°±æœƒèª¿ç”¨LiveDataçš„dispatchingValueã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15326058791517f12641571><p class=pgc-img-caption></p></div><p>åœ¨LiveDataçš„dispatchingValueä¸­ï¼Œåˆæœƒèª¿ç”¨LiveDataçš„considerNotifyæ–¹æ³•ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15326058792210910f8b537><p class=pgc-img-caption></p></div><p>åœ¨LiveDataçš„considerNotifyæ–¹æ³•ä¸­ï¼Œç´…æ¡†ä¸­çš„é‚è¼¯æ˜¯é—œéµï¼Œå¦‚æœObserverWrapperçš„mLastVersionå°æ–¼LiveDataçš„mVersionï¼Œå°±æœƒå»å›èª¿mObserverçš„onChangedæ–¹æ³•ã€‚è€Œæ¯å€‹æ–°çš„è¨‚é–±è€…ï¼Œå…¶versionéƒ½æ˜¯-1ï¼ŒLiveDataä¸€æ—¦è¨­ç½®éå…¶versionæ˜¯å¤§æ–¼-1çš„ï¼ˆæ¯æ¬¡LiveDataè¨­ç½®å€¼éƒ½æœƒä½¿å…¶versionåŠ 1ï¼‰ï¼Œé€™æ¨£å°±æœƒå°è‡´LiveDataBusæ¯è¨»å†Šä¸€å€‹æ–°çš„è¨‚é–±è€…ï¼Œé€™å€‹è¨‚é–±è€…ç«‹åˆ»æœƒæ”¶åˆ°ä¸€å€‹å›èª¿ï¼Œå³ä½¿é€™å€‹è¨­ç½®çš„å‹•ä½œç™¼ç”Ÿåœ¨è¨‚é–±ä¹‹å‰ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/153260587914599287f92a0><p class=pgc-img-caption></p></div><p><strong>å•é¡ŒåŸå› ç¸½çµ</strong></p><p>å°æ–¼é€™å€‹å•é¡Œï¼Œç¸½çµä¸€ä¸‹ç™¼ç”Ÿçš„æ ¸å¿ƒåŸå› ã€‚å°æ–¼LiveDataï¼Œå…¶åˆå§‹çš„versionæ˜¯-1ï¼Œç•¶æˆ‘å€‘èª¿ç”¨äº†å…¶setValueæˆ–è€…postValueï¼Œå…¶vesionæœƒ+1ï¼›å°æ–¼æ¯ä¸€å€‹è§€å¯Ÿè€…çš„å°è£ObserverWrapperï¼Œå…¶åˆå§‹versionä¹Ÿç‚º-1ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œæ¯ä¸€å€‹æ–°è¨»å†Šçš„è§€å¯Ÿè€…ï¼Œå…¶versionç‚º-1ï¼›ç•¶LiveDataè¨­ç½®é€™å€‹ObserverWrapperçš„æ™‚å€™ï¼Œå¦‚æœLiveDataçš„versionå¤§æ–¼ObserverWrapperçš„versionï¼ŒLiveDataå°±æœƒå¼·åˆ¶æŠŠç•¶å‰valueæ¨é€çµ¦Observerã€‚</p><p><strong>å¦‚ä½•è§£æ±ºé€™å€‹å•é¡Œ</strong></p><p>æ˜ç™½äº†å•é¡Œç”¢ç”Ÿçš„åŸå› ä¹‹å¾Œï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹æ€éº¼æ‰èƒ½è§£æ±ºé€™å€‹å•é¡Œã€‚å¾ˆé¡¯ç„¶ï¼Œæ ¹æ“šä¹‹å‰çš„åˆ†æï¼Œåªéœ€è¦åœ¨è¨»å†Šä¸€å€‹æ–°çš„è¨‚é–±è€…çš„æ™‚å€™æŠŠWrapperçš„versionè¨­ç½®æˆè·ŸLiveDataçš„versionä¸€è‡´å³å¯ã€‚</p><p>é‚£éº¼æ€éº¼å¯¦ç¾å‘¢ï¼Œçœ‹çœ‹LiveDataçš„observeæ–¹æ³•ï¼Œä»–æœƒåœ¨æ­¥é©Ÿ1å‰µå»ºä¸€å€‹LifecycleBoundObserverï¼ŒLifecycleBoundObserveræ˜¯ObserverWrapperçš„æ´¾ç”Ÿé¡ã€‚ç„¶å¾Œæœƒåœ¨æ­¥é©Ÿ2æŠŠé€™å€‹LifecycleBoundObserveræ”¾å…¥ä¸€å€‹ç§æœ‰Mapå®¹å™¨mObserversä¸­ã€‚ç„¡è«–ObserverWrapperé‚„æ˜¯LifecycleBoundObserveréƒ½æ˜¯ç§æœ‰çš„æˆ–è€…åŒ…å¯è¦‹çš„ï¼Œæ‰€ä»¥ç„¡æ³•é€šéç¹¼æ‰¿çš„æ–¹å¼æ›´æ”¹LifecycleBoundObserverçš„versionã€‚</p><p>é‚£éº¼èƒ½ä¸èƒ½å¾Mapå®¹å™¨mObserversä¸­å–åˆ°LifecycleBoundObserverï¼Œç„¶å¾Œå†æ›´æ”¹versionå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé€šéæŸ¥çœ‹SafeIterableMapçš„æºç¢¼æˆ‘å€‘ç™¼ç¾æœ‰ä¸€å€‹protectedçš„getæ–¹æ³•ã€‚å› æ­¤ï¼Œåœ¨èª¿ç”¨observeçš„æ™‚å€™ï¼Œæˆ‘å€‘å¯ä»¥é€šéåå°„æ‹¿åˆ°LifecycleBoundObserverï¼Œå†æŠŠLifecycleBoundObserverçš„versionè¨­ç½®æˆå’ŒLiveDataä¸€è‡´å³å¯ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/153260587956410d5916b87><p class=pgc-img-caption></p></div><p>å°æ–¼éç”Ÿå‘½é€±æœŸæ„ŸçŸ¥çš„observeForeveræ–¹æ³•ä¾†èªªï¼Œå¯¦ç¾çš„æ€è·¯æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯å…·é«”çš„å¯¦ç¾ç•¥æœ‰ä¸åŒã€‚observeForeverçš„æ™‚å€™ï¼Œç”Ÿæˆçš„wrapperä¸æ˜¯LifecycleBoundObserverï¼Œè€Œæ˜¯AlwaysActiveObserverï¼ˆæ­¥é©Ÿ1ï¼‰ï¼Œè€Œä¸”æˆ‘å€‘ä¹Ÿæ²’æœ‰æ©Ÿæœƒåœ¨observeForeverèª¿ç”¨å®Œæˆä¹‹å¾Œå†å»æ›´æ”¹AlwaysActiveObserverçš„versionï¼Œå› ç‚ºåœ¨observeForeveræ–¹æ³•é«”å…§ï¼Œæ­¥é©Ÿ3çš„èªå¥ï¼Œå›èª¿å°±ç™¼ç”Ÿäº†ã€‚</p><div class=pgc-img><img alt=Androidæ¶ˆæ¯ç¸½ç·šçš„æ¼”é€²ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1532605879463daf62b18de><p class=pgc-img-caption></p></div><p>é‚£éº¼å°æ–¼observeForeverï¼Œå¦‚ä½•è§£æ±ºé€™å€‹å•é¡Œå‘¢ï¼Ÿæ—¢ç„¶æ˜¯åœ¨èª¿ç”¨å…§å›èª¿çš„ï¼Œé‚£éº¼æˆ‘å€‘å¯ä»¥å¯«ä¸€å€‹ObserverWrapperï¼ŒæŠŠçœŸæ­£çš„å›èª¿çµ¦åŒ…è£èµ·ä¾†ã€‚æŠŠObserverWrapperå‚³çµ¦observeForeverï¼Œé‚£éº¼åœ¨å›èª¿çš„æ™‚å€™æˆ‘å€‘å»æª¢æŸ¥èª¿ç”¨æ£§ï¼Œå¦‚æœå›èª¿æ˜¯observeForeveræ–¹æ³•å¼•èµ·çš„ï¼Œé‚£éº¼å°±ä¸å›èª¿çœŸæ­£çš„è¨‚é–±è€…ã€‚</p><p><strong>LiveDataBusæœ€çµ‚å¯¦ç¾</strong></p><blockquote><p>public final class LiveDataBus {</p><p>private final Map&lt;String, BusMutableLiveData&lt;Object>> bus;</p><p>private LiveDataBus() {</p><p>bus = new HashMap&lt;>();</p><p>}</p><p>private static class SingletonHolder {</p><p>private static final LiveDataBus DEFAULT_BUS = new LiveDataBus();</p><p>}</p><p>public static LiveDataBus get() {</p><p>return SingletonHolder.DEFAULT_BUS;</p><p>}</p><p>public &lt;T> MutableLiveData&lt;T> with(String key, Class&lt;T> type) {</p><p>if (!bus.containsKey(key)) {</p><p>bus.put(key, new BusMutableLiveData&lt;>());</p><p>}</p><p>return (MutableLiveData&lt;T>) bus.get(key);</p><p>}</p><p>public MutableLiveData&lt;Object> with(String key) {</p><p>return with(key, Object.class);</p><p>}</p><p>private static class ObserverWrapper&lt;T> implements Observer&lt;T> {</p><p>private Observer&lt;T> observer;</p><p>public ObserverWrapper(Observer&lt;T> observer) {</p><p>this.observer = observer;</p><p>}</p><p>@Override</p><p>public void onChanged(@Nullable T t) {</p><p>if (observer != null) {</p><p>if (isCallOnObserve()) {</p><p>return;</p><p>}</p><p>observer.onChanged(t);</p><p>}</p><p>}</p><p>private boolean isCallOnObserve() {</p><p>StackTraceElement[] stackTrace = Thread.currentThread().getStackTrace();</p><p>if (stackTrace != null && stackTrace.length > 0) {</p><p>for (StackTraceElement element : stackTrace) {</p><p>if ("android.arch.lifecycle.LiveData".equals(element.getClassName()) &&</p><p>"observeForever".equals(element.getMethodName())) {</p><p>return true;</p><p>}</p><p>}</p><p>}</p><p>return false;</p><p>}</p><p>}</p><p>private static class BusMutableLiveData&lt;T> extends MutableLiveData&lt;T> {</p><p>private Map&lt;Observer, Observer> observerMap = new HashMap&lt;>();</p><p>@Override</p><p>public void observe(@NonNull LifecycleOwner owner, @NonNull Observer&lt;T> observer) {</p><p>super.observe(owner, observer);</p><p>try {</p><p>hook(observer);</p><p>} catch (Exception e) {</p><p>e.printStackTrace();</p><p>}</p><p>}</p><p>@Override</p><p>public void observeForever(@NonNull Observer&lt;T> observer) {</p><p>if (!observerMap.containsKey(observer)) {</p><p>observerMap.put(observer, new ObserverWrapper(observer));</p><p>}</p><p>super.observeForever(observerMap.get(observer));</p><p>}</p><p>@Override</p><p>public void removeObserver(@NonNull Observer&lt;T> observer) {</p><p>Observer realObserver = null;</p><p>if (observerMap.containsKey(observer)) {</p><p>realObserver = observerMap.remove(observer);</p><p>} else {</p><p>realObserver = observer;</p><p>}</p><p>super.removeObserver(realObserver);</p><p>}</p><p>private void hook(@NonNull Observer&lt;T> observer) throws Exception {</p><p>//get wrapper's version</p><p>Class&lt;LiveData> classLiveData = LiveData.class;</p><p>Field fieldObservers = classLiveData.getDeclaredField("mObservers");</p><p>fieldObservers.setAccessible(true);</p><p>Object objectObservers = fieldObservers.get(this);</p><p>Class&lt;?> classObservers = objectObservers.getClass();</p><p>Method methodGet = classObservers.getDeclaredMethod("get", Object.class);</p><p>methodGet.setAccessible(true);</p><p>Object objectWrapperEntry = methodGet.invoke(objectObservers, observer);</p><p>Object objectWrapper = null;</p><p>if (objectWrapperEntry instanceof Map.Entry) {</p><p>objectWrapper = ((Map.Entry) objectWrapperEntry).getValue();</p><p>}</p><p>if (objectWrapper == null) {</p><p>throw new NullPointerException("Wrapper can not be bull!");</p><p>}</p><p>Class&lt;?> classObserverWrapper = objectWrapper.getClass().getSuperclass();</p><p>Field fieldLastVersion = classObserverWrapper.getDeclaredField("mLastVersion");</p><p>fieldLastVersion.setAccessible(true);</p><p>//get livedata's version</p><p>Field fieldVersion = classLiveData.getDeclaredField("mVersion");</p><p>fieldVersion.setAccessible(true);</p><p>Object objectVersion = fieldVersion.get(this);</p><p>//set wrapper's version</p><p>fieldLastVersion.set(objectWrapper, objectVersion);</p><p>}</p><p>}</p><p>}</p></blockquote><p><strong>è¨»å†Šè¨‚é–±ï¼š</strong></p><blockquote><p>LiveDataBus.get()</p><p>.with("key_test", String.class)</p><p>.observe(this, new Observer&lt;String>() {</p><p>@Override</p><p>public void onChanged(@Nullable String s) {</p><p>}</p><p>});</p></blockquote><p><strong>ç™¼é€æ¶ˆæ¯ï¼š</strong></p><blockquote><p>LiveDataBus.get().with("key_test").setValue(s);</p></blockquote><p><strong>æºç¢¼èªªæ˜</strong></p><p>LiveDataBusçš„æºç¢¼å¯ä»¥ç›´æ¥æ‹·è²ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å‰å¾€ä½œè€…çš„GitHubå€‰åº«æŸ¥çœ‹ä¸‹è¼‰ï¼š</p><blockquote><p>https://github.com/JeremyLiao/LiveDataBus</p></blockquote><p><strong>ç¸½çµ</strong></p><p>æœ¬æ–‡æä¾›äº†ä¸€å€‹æ–°çš„æ¶ˆæ¯ç¸½ç·šæ¡†æ¶â€”â€”LiveDataBusã€‚è¨‚é–±è€…å¯ä»¥è¨‚é–±æŸå€‹æ¶ˆæ¯é€šé“çš„æ¶ˆæ¯ï¼Œç™¼ä½ˆè€…å¯ä»¥æŠŠæ¶ˆæ¯ç™¼ä½ˆåˆ°æ¶ˆæ¯é€šé“ä¸Šã€‚åˆ©ç”¨LiveDataBusï¼Œä¸åƒ…å¯ä»¥å¯¦ç¾æ¶ˆæ¯ç¸½ç·šåŠŸèƒ½ï¼Œè€Œä¸”å°æ–¼è¨‚é–±è€…ï¼Œä»–å€‘ä¸éœ€è¦é—œå¿ƒä½•æ™‚å–æ¶ˆè¨‚é–±ï¼Œæ¥µå¤§æ¸›å°‘äº†å› ç‚ºå¿˜è¨˜å–æ¶ˆè¨‚é–±é€ æˆçš„å…§å­˜æ´©æ¼é¢¨éšªã€‚</p><p><strong>ä½œè€…ç°¡ä»‹</strong></p><p>æµ·äº®ï¼Œç¾åœ˜é«˜ç´šå·¥ç¨‹å¸«ï¼Œ2017å¹´åŠ å…¥ç¾åœ˜ï¼Œç›®å‰ä¸»è¦è² è²¬ç¾åœ˜è¼•æ”¶éŠ€ã€ç¾åœ˜æ”¶éŠ€é›¶å”®ç‰ˆç­‰Appçš„ç›¸é—œæ¥­å‹™åŠæ¨¡å¡Šé–‹ç™¼å·¥ä½œã€‚</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Android</a></li><li><a>ç¸½ç·š</a></li><li><a>æ¼”é€²</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/1a3ee55d.html alt=è‡ºé”PLCã€ä¼ºæœã€ç¸½ç·šåœ¨å¤šç·šåˆ‡å‰²æ©Ÿæ’ç·šæ‡‰ç”¨ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/81b4f47eaf02436d85835d3a63750236 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1a3ee55d.html title=è‡ºé”PLCã€ä¼ºæœã€ç¸½ç·šåœ¨å¤šç·šåˆ‡å‰²æ©Ÿæ’ç·šæ‡‰ç”¨>è‡ºé”PLCã€ä¼ºæœã€ç¸½ç·šåœ¨å¤šç·šåˆ‡å‰²æ©Ÿæ’ç·šæ‡‰ç”¨</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c1058aa2.html alt="Android Qä¸‹ANGLEåœ–å½¢å¼•æ“æ€§èƒ½æ¸¬è©¦  ã€Œè¾²æ­¥ç¥¥ã€" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RXTy8D7HmsBWr1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c1058aa2.html title="Android Qä¸‹ANGLEåœ–å½¢å¼•æ“æ€§èƒ½æ¸¬è©¦  ã€Œè¾²æ­¥ç¥¥ã€">Android Qä¸‹ANGLEåœ–å½¢å¼•æ“æ€§èƒ½æ¸¬è©¦ ã€Œè¾²æ­¥ç¥¥ã€</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/604d6a24.html alt=å…‰é€šä¿¡å‚³é€ç¶²çš„ç™¼å±•èˆ‡æ¼”é€² class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/37ec00024ce9c81c7060 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/604d6a24.html title=å…‰é€šä¿¡å‚³é€ç¶²çš„ç™¼å±•èˆ‡æ¼”é€²>å…‰é€šä¿¡å‚³é€ç¶²çš„ç™¼å±•èˆ‡æ¼”é€²</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9be3efd7.html alt=æ•¸å­—åŒ–æ¼”é€²ï¼šå¾äº’è¯ç¶²+åˆ°å…¨éˆè·¯æ•¸å­—åŒ– class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/6c7d0a20c6454717944d6921ce56a06e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9be3efd7.html title=æ•¸å­—åŒ–æ¼”é€²ï¼šå¾äº’è¯ç¶²+åˆ°å…¨éˆè·¯æ•¸å­—åŒ–>æ•¸å­—åŒ–æ¼”é€²ï¼šå¾äº’è¯ç¶²+åˆ°å…¨éˆè·¯æ•¸å­—åŒ–</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0ac13623.html alt="Android 11åŠ å…¥æ–°åŠŸèƒ½ï¼šé•·æœŸä¸ç”¨çš„APPè‡ªå‹•é—œé–‰æ•æ„Ÿæ¬Šé™" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/Rx4J9h84rlZBze style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0ac13623.html title="Android 11åŠ å…¥æ–°åŠŸèƒ½ï¼šé•·æœŸä¸ç”¨çš„APPè‡ªå‹•é—œé–‰æ•æ„Ÿæ¬Šé™">Android 11åŠ å…¥æ–°åŠŸèƒ½ï¼šé•·æœŸä¸ç”¨çš„APPè‡ªå‹•é—œé–‰æ•æ„Ÿæ¬Šé™</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/192b9f57.html alt="Androidç‰ˆFirefox 81å°‡å¼•å…¥å¯è‡ªå‹•é—œé–‰èˆŠæ¨™ç±¤é çš„é¸é …" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/SA9N6CXIS75NYa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/192b9f57.html title="Androidç‰ˆFirefox 81å°‡å¼•å…¥å¯è‡ªå‹•é—œé–‰èˆŠæ¨™ç±¤é çš„é¸é …">Androidç‰ˆFirefox 81å°‡å¼•å…¥å¯è‡ªå‹•é—œé–‰èˆŠæ¨™ç±¤é çš„é¸é …</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e3073c3d.html alt="Androidç«¯Firefox 81å¯å®šæ™‚é—œé–‰ä¸ä½¿ç”¨çš„æ¨™ç±¤é " class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/S9x6jJb18axAim style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e3073c3d.html title="Androidç«¯Firefox 81å¯å®šæ™‚é—œé–‰ä¸ä½¿ç”¨çš„æ¨™ç±¤é ">Androidç«¯Firefox 81å¯å®šæ™‚é—œé–‰ä¸ä½¿ç”¨çš„æ¨™ç±¤é </a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/355ed5a4.html alt=åœ¨Androidä¸­çš„å·¥å…·æ¬„ä¸­æ·»åŠ èœå–® class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a3572ad9d9fb487d8927f703f18179a0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/355ed5a4.html title=åœ¨Androidä¸­çš„å·¥å…·æ¬„ä¸­æ·»åŠ èœå–®>åœ¨Androidä¸­çš„å·¥å…·æ¬„ä¸­æ·»åŠ èœå–®</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b37aac89.html alt=ã€å­¸ç¿’ç­†è¨˜ã€‘Androidé–‹ç™¼ä¹‹kotlinèªè¨€ï¼ˆä¸€ï¼‰ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ee3f9c8348ae4de58a5f62922d2042e1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b37aac89.html title=ã€å­¸ç¿’ç­†è¨˜ã€‘Androidé–‹ç™¼ä¹‹kotlinèªè¨€ï¼ˆä¸€ï¼‰>ã€å­¸ç¿’ç­†è¨˜ã€‘Androidé–‹ç™¼ä¹‹kotlinèªè¨€ï¼ˆä¸€ï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/514f2fe0.html alt=Androidé€²éšä¹‹è·¯ä¹‹ç¶²çµ¡ç·¨ç¨‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/R6GseWQ6pTbxvr style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/514f2fe0.html title=Androidé€²éšä¹‹è·¯ä¹‹ç¶²çµ¡ç·¨ç¨‹>Androidé€²éšä¹‹è·¯ä¹‹ç¶²çµ¡ç·¨ç¨‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d258b9eb.html alt="å¾¹åº•å‡çµAndroid æ‡‰ç”¨å¾Œè‡ºæ´»å‹• è®“ä»–å€‘ä¸è€—é›»ã€ä¸è¯ç¶²ã€ä¸å•Ÿå‹•" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/e4fd87bc-b2e5-40e2-841d-2e3dc5f9a2b9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d258b9eb.html title="å¾¹åº•å‡çµAndroid æ‡‰ç”¨å¾Œè‡ºæ´»å‹• è®“ä»–å€‘ä¸è€—é›»ã€ä¸è¯ç¶²ã€ä¸å•Ÿå‹•">å¾¹åº•å‡çµAndroid æ‡‰ç”¨å¾Œè‡ºæ´»å‹• è®“ä»–å€‘ä¸è€—é›»ã€ä¸è¯ç¶²ã€ä¸å•Ÿå‹•</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a46b181d.html alt=å¤ä»£æ›¸å¯«ææ–™çš„æ¼”é€²èˆ‡é­æ™‰å²å­¸çš„ç™¼å±• class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/f658572243034c679691e700acd6f17d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a46b181d.html title=å¤ä»£æ›¸å¯«ææ–™çš„æ¼”é€²èˆ‡é­æ™‰å²å­¸çš„ç™¼å±•>å¤ä»£æ›¸å¯«ææ–™çš„æ¼”é€²èˆ‡é­æ™‰å²å­¸çš„ç™¼å±•</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d54e0b8c.html alt=å¾ç¶²çµ¡æ¶æ§‹æ¼”é€²çš„å‰ä¸–ä»Šç”Ÿè©³è§£5Gå„NFç¶²çµ¡åŠŸèƒ½é«” class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/56c5f01170a843fea40bd4f1a164b677 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d54e0b8c.html title=å¾ç¶²çµ¡æ¶æ§‹æ¼”é€²çš„å‰ä¸–ä»Šç”Ÿè©³è§£5Gå„NFç¶²çµ¡åŠŸèƒ½é«”>å¾ç¶²çµ¡æ¶æ§‹æ¼”é€²çš„å‰ä¸–ä»Šç”Ÿè©³è§£5Gå„NFç¶²çµ¡åŠŸèƒ½é«”</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fc7b0de9.html alt=ç¸½ç·šæ§åˆ¶ç›¤ã€å¤šç·šæ§åˆ¶ç›¤çš„å€åˆ¥åŠæ‡‰ç”¨-ç«ç½è‡ªå‹•å ±è­¦ç³»çµ± class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/71b4fd2b0652481e9818bdf50bb6fdce style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fc7b0de9.html title=ç¸½ç·šæ§åˆ¶ç›¤ã€å¤šç·šæ§åˆ¶ç›¤çš„å€åˆ¥åŠæ‡‰ç”¨-ç«ç½è‡ªå‹•å ±è­¦ç³»çµ±>ç¸½ç·šæ§åˆ¶ç›¤ã€å¤šç·šæ§åˆ¶ç›¤çš„å€åˆ¥åŠæ‡‰ç”¨-ç«ç½è‡ªå‹•å ±è­¦ç³»çµ±</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/68b758a4.html alt="è¨Šé£›è¼¸å…¥æ³•Android V9.1.9465 é‡ç£…å‡ç´šæ‹¼éŸ³æ‰‹å¯«A.I.å¼•æ“" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/RiF18Oh9i8jWPd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/68b758a4.html title="è¨Šé£›è¼¸å…¥æ³•Android V9.1.9465 é‡ç£…å‡ç´šæ‹¼éŸ³æ‰‹å¯«A.I.å¼•æ“">è¨Šé£›è¼¸å…¥æ³•Android V9.1.9465 é‡ç£…å‡ç´šæ‹¼éŸ³æ‰‹å¯«A.I.å¼•æ“</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>