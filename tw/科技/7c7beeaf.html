<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文 | 极客快訊</title><meta property="og:title" content="入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/9cc70e53ffca4c35b6ea8146e5065e7c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/7c7beeaf.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/7c7beeaf.html><meta property="article:published_time" content="2020-11-14T21:00:23+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:23+08:00"><meta name=Keywords content><meta name=description content="入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/7c7beeaf.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>今天超子和大家一起構建一下MQTT協議中的CONNECT報文連接騰訊的物聯網開發平臺，只有CONNECT報文成功之後才能進行後面的通信。</p><p>我們直入主題，首先是CONNECT報文的固定報頭0x10 ??，??是剩餘長度，只有我們確定了可變報頭和負載的長度後才能計算出來，所以一會再說。</p><p>CONNECT報文中的可變報頭用來設置信息和各種功能，騰訊物聯網平臺和阿里雲的一樣，所以直接把阿里雲的可變報頭拿過來就行，簡化的16進制書寫，去掉0x，結果如下：</p><p>00 04 4D 51 54 54 04 C2 00 64</p><p>CONNECT報文中的負載包含客戶端ID，用戶名和密碼這3個非常重要的信息，首先我們要總結下各個信息對應於騰訊雲物聯網平臺的什麼內容。</p><p>客戶端ID：產品ID +設備名稱</p><p>用戶名：產品ID +設備名稱+分號+ 21010406 +分號+78945 +分號+2147483647</p><p>密碼：這個比較麻煩，需要先對設備祕鑰進行base64解碼，解碼後的數據再作為密鑰對用戶名進行hmacsha1加密，加密後的密文就是MQTT協議CONNECT報文中負載的密碼了</p><p>我們一起來找一下相關的信息在什麼地方。</p><div class=pgc-img><img alt=入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9cc70e53ffca4c35b6ea8146e5065e7c><p class=pgc-img-caption></p></div><p>首先登錄騰訊雲物聯網開發平臺，超子在上一篇文章介紹瞭如何新建項目和產品。然後進入我們建立好的項目內，點擊我們建立的產品。</p><p>《<a class=pgc-link data-content=mp href="https://www.toutiao.com/i6818907510808773124/?group_id=6818907510808773124" rel="noopener noreferrer" target=_blank>新手入門騰訊物聯網開發平臺，如何建立項目產品？簡單詳細上手快</a>》</p><div class=pgc-img><img alt=入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/0225ac3b48d54effa84f839a5b572e36><p class=pgc-img-caption></p></div><p>進入產品詳情頁後，我們選擇第4步的設備調試，點擊紅圈中的新建設備，因為設備是連接平臺的終端。</p><div class=pgc-img><img alt=入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a2dd32118a7440b1bb7c1fd077ebf3a2><p class=pgc-img-caption></p></div><p>我們給設備起一個名稱就行，然後點擊保存。</p><div class=pgc-img><img alt=入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b5e967a04c894960af44b9e4a32bedf7><p class=pgc-img-caption></p></div><p>設備建立成功後，在設備列表可以看到剛才建立的D001，然後我們點擊設備，進入設備詳情頁面。</p><div class=pgc-img><img alt=入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2fcd46f8da53416a93239e3066c3cf48><p class=pgc-img-caption></p></div><p>上圖中的3個信息，就是構建客戶端ID，用戶名和密碼需要用到的內容。</p><p>先看客戶端ID，結構是產品ID +設備名稱，就是65NJZ04A1BD001，然後換成16進制是36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31，長度是14，按照MQTT的格式要求，我們還要在最前面加入2個字節表示長度14，那麼最終的16進制，簡化書寫，去掉0x結果如下：</p><p>00 0E 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31</p><p>接著構建用戶名，產品ID +設備名稱+分號+ 21010406 +分號+78945 +分號+2147483647，就是65NJZ04A1BD001;21010406;78945;2147483647，然後換成16進制是36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 3B 32 31 30 31 30 34 30 36 3B 37 38 39 34 35 3B 32 31 34 37 34 38 33 36 34 37，長度是40，然後按照MQTT的格式要求，我們還要在最前面加入2個字節表示長度40，那麼最終的16進制，簡化書寫，去掉0x結果如下：</p><p>00 28 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 3B 32 31 30 31 30 34 30 36 3B 37 38 39 34 35 3B 32 31 34 37 34 38 33 36 34 37</p><p>最後構建密碼，先對ZmLVuCs4H/zX6E63+i2Ung==設備密鑰進行base64解碼，解碼後換成16進制是66 62 D5 B8 2B 38 1F FC D7 E8 4E B7 FA 2D 94 9E，然後再作為密鑰對用戶名進行hmacsha1加密，加密後的結果，換成16進制是31 34 31 33 36 31 32 61 30 61 31 65 37 32 62 66 32 31 39 32 36 30 31 39 30 66 35 38 65 61 32 64 39 37 64 61 61 30 36 38 3B 68 6D 61 63 73 68 61 31，長度是49，我們還要在最前面加入2個字節表示長度49，那麼最終的16進制，簡化書寫，去掉0x結果如下：</p><p>00 31 31 34 31 33 36 31 32 61 30 61 31 65 37 32 62 66 32 31 39 32 36 30 31 39 30 66 35 38 65 61 32 64 39 37 64 61 61 30 36 38 3B 68 6D 61 63 73 68 61 31</p><p>到此整個負載就搞定了，接下來我們把客戶端ID+用戶名+密碼連接起來構成負載信息，簡化16進制，去掉0x結果如下：</p><p>00 0E 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 00 28 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 3B 32 31 30 31 30 34 30 36 3B 37 38 39 34 35 3B 32 31 34 37 34 38 33 36 34 37 00 31 31 34 31 33 36 31 32 61 30 61 31 65 37 32 62 66 32 31 39 32 36 30 31 39 30 66 35 38 65 61 32 64 39 37 64 61 61 30 36 38 3B 68 6D 61 63 73 68 61 31</p><p>我們一起數一下，整個負載部分共計109個字節 。剩餘長度=可變報頭+負載=10+109=119，119/128=0，一個字節就能搞定，換成16進制就是0x77，最後我們把固定報頭、可變報頭和負載同連接起來，簡化16進制，去掉0x的最終結果如下所示：</p><p>10 77 00 04 4D 51 54 54 04 C2 00 64 00 0E 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 00 28 36 35 4E 4A 5A 30 34 41 31 42 44 30 30 31 3B 32 31 30 31 30 34 30 36 3B 37 38 39 34 35 3B 32 31 34 37 34 38 33 36 34 37 00 31 31 34 31 33 36 31 32 61 30 61 31 65 37 32 62 66 32 31 39 32 36 30 31 39 30 66 35 38 65 61 32 64 39 37 64 61 61 30 36 38 3B 68 6D 61 63 73 68 61 31</p><p>到此CONNECT報文構建完畢，我們用網絡助手實測一下，騰訊雲物聯網開發平臺提供的是域名，端口號是1883，那麼網絡助手中，遠程主機地址就是</p><p>iotcloud-mqtt.gz.tencentdevices.com:1883</p><p>我們實際測試一下CONNECT報文，看看設備是不是在線了。</p><div class=pgc-img><img alt=入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fb6a5e541b614fe2a441f52cc9b93294><p class=pgc-img-caption></p></div><p>發送CONNECT報文後，服務器回覆我們的CONNACK報文中，我們看最後1個字節是0x00，說明我們的CONNECT報文正確。</p><div class=pgc-img><img alt=入門騰訊物聯網開發平臺，如何構建MQTT協議CONNECT報文 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/73c20aff88644f978822b5aa75b8f399><p class=pgc-img-caption></p></div><p>CONNECT報文成功發送後，我們再看設備列表，對應的D001設備的狀態已經顯示在線了。CONNECT報文中我們設置的keep alive的時間是100s，按協議標準要求，1.5倍時間也就是150s內，沒有數據發送的話，服務器可以把我們踢下來。如果我們沒有什麼數據要發送的話，可以通過發送PING報文，來保持連接，不被踢下來。</p><p>今天我們就把CONNECT報文搞定了，任務圓滿完成。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>入門</a></li><li><a>騰訊物</a></li><li><a>聯網</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/35a190b6.html alt=新手入門騰訊物聯網開發平臺，如何建立項目產品？簡單詳細上手快 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/59aad044a64e4326b2dba8689527b1d7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/35a190b6.html title=新手入門騰訊物聯網開發平臺，如何建立項目產品？簡單詳細上手快>新手入門騰訊物聯網開發平臺，如何建立項目產品？簡單詳細上手快</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/21c3352b.html alt=騰訊物聯網開發平臺入門操作，如何使用MQTT協議上傳溫度溼度數據 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3cf69e74fb5847a6ad4d2e1a751b9a19 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/21c3352b.html title=騰訊物聯網開發平臺入門操作，如何使用MQTT協議上傳溫度溼度數據>騰訊物聯網開發平臺入門操作，如何使用MQTT協議上傳溫度溼度數據</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6fe27eab.html alt="前端 | HTML入門基礎知識-網頁" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e7a0b61194f445b8b9e5ae330961d2ea style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6fe27eab.html title="前端 | HTML入門基礎知識-網頁">前端 | HTML入門基礎知識-網頁</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bd1884ae.html alt="上海高速公路聯網收費系統升級 ETC車輛將實現出口費額顯示" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/392af29caddd40db9ef52bfb00fece58 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bd1884ae.html title="上海高速公路聯網收費系統升級 ETC車輛將實現出口費額顯示">上海高速公路聯網收費系統升級 ETC車輛將實現出口費額顯示</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/19664ba8.html alt=EXCEL入門基礎：對行和列選定數據求和 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1f03f82096d240dd92410709f3e19eb9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/19664ba8.html title=EXCEL入門基礎：對行和列選定數據求和>EXCEL入門基礎：對行和列選定數據求和</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b8332e33.html alt=貴陽開始高速公路聯網收費系統實車測試 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/75706ec9525b4c6b861c78f9c3ce7f73 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b8332e33.html title=貴陽開始高速公路聯網收費系統實車測試>貴陽開始高速公路聯網收費系統實車測試</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5abb53a8.html alt=工程造價從入門到精通：造價員全能圖解+工程算量表，限時分享！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/49834ccb43ed42cb9a54c9827c3ab134 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5abb53a8.html title=工程造價從入門到精通：造價員全能圖解+工程算量表，限時分享！>工程造價從入門到精通：造價員全能圖解+工程算量表，限時分享！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1a5f8d5f.html alt=工程造價：入門知識全套講義，30章600頁，精通造價首選之作 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9e1b335c343a455f8777dd3144fc1c35 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1a5f8d5f.html title=工程造價：入門知識全套講義，30章600頁，精通造價首選之作>工程造價：入門知識全套講義，30章600頁，精通造價首選之作</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2d4007c7.html alt=“黑客”入門學習之“Windows組策略” class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ea21244d5f5c420ebef29650f3fafd1c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2d4007c7.html title=“黑客”入門學習之“Windows組策略”>“黑客”入門學習之“Windows組策略”</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9d08c7e6.html alt=PHP入門教程，5天86節課助力小白變大神！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/4366000004d4c98fd587 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9d08c7e6.html title=PHP入門教程，5天86節課助力小白變大神！>PHP入門教程，5天86節課助力小白變大神！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/923fd40e.html alt=Thinkphp6快速入門一 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/c4331ddc0ffb4c94a4aa80be95178354 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/923fd40e.html title=Thinkphp6快速入門一>Thinkphp6快速入門一</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3d2ce3d6.html alt="php新手入門教程， 最全最完整的教學視頻課程" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/666a38216ab04790a716bb1451c7fe44 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3d2ce3d6.html title="php新手入門教程， 最全最完整的教學視頻課程">php新手入門教程， 最全最完整的教學視頻課程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/07454552.html alt=「素描入門」基礎不紮實，從排線練起 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15252166717297d7af296ee style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/07454552.html title=「素描入門」基礎不紮實，從排線練起>「素描入門」基礎不紮實，從排線練起</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/07c706e2.html alt=「素描入門」素描排線的繪畫技法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1530098801296ab58189790 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/07c706e2.html title=「素描入門」素描排線的繪畫技法>「素描入門」素描排線的繪畫技法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a993b442.html alt=素描入門丨你說線條或者排線，容易嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1536648317995f32cedaa40 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a993b442.html title=素描入門丨你說線條或者排線，容易嗎？>素描入門丨你說線條或者排線，容易嗎？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>