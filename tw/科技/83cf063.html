<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>毫秒級從百億大表任意維度篩選數據，是怎麼做到的…… | 极客快訊</title><meta property="og:title" content="毫秒級從百億大表任意維度篩選數據，是怎麼做到的…… - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/16f94cabeb6c451d97112789493bf5a3"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/83cf063.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/83cf063.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/83cf063.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/83cf063.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/83cf063.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/83cf063.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/83cf063.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/83cf063.html><meta property="article:published_time" content="2020-10-29T21:08:06+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:06+08:00"><meta name=Keywords content><meta name=description content="毫秒級從百億大表任意維度篩選數據，是怎麼做到的……"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/83cf063.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>毫秒級從百億大表任意維度篩選數據，是怎麼做到的……</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1>1、業務背景</h1><p>隨著閒魚業務的發展，用戶規模達到數億級，用戶維度的數據指標，達到上百個之多。如何從億級別的數據中，快速篩選出符合期望的用戶人群，進行精細化人群運營，是技術需要解決的問題。業界的很多方案常常需要分鐘級甚至小時級才能生成查詢結果。本文提供了一種解決大數據場景下的高效數據篩選、統計和分析方法，從億級別數據中，任意組合查詢條件，篩選需要的數據，做到毫秒級返回。</p><h1>2、技術選型分析</h1><p>從技術角度分析，我們這個業務場景有如下特點：</p><ol><li>需要支持任意維度的組合(and/or)嵌套查詢，且要求低延遲；</li><li>數據規模大，至少億級別，且需要支持不斷擴展；</li><li>單條數據指標維度多，至少上百，且需要支持不斷增加；</li><li>綜合分析，這是一個典型的OLAP場景。</li></ol><p>2.1 OLTP與OLAP</p><p>下面簡單對比下OLTP和OLAP：</p><p>OLTP OLAP 定義 聯機事務處理 聯機分析處理 應用場景 日常業務操作 分析決策，報表統計 事務要求 需要支持事務 無需事務支持 常用數據操作 讀/寫高併發 查詢為主，併發要求相對低 實時性要求 高 要求不嚴格 DB大小 MB-GB GB-TB 數據行數 幾萬到幾百萬 億級別甚至幾十億上百億 數據列數 幾十至上百列 百級別至千級別 最常見的數據庫，如MySql、Oracle等，都採用行式存儲，比較適合OLTP。如果用MySql等行數據庫來實現OLAP，一般都會碰到兩個瓶頸：</p><ol><li>數據量瓶頸：mysql比較適合的數據量級是百萬級，再多的話，查詢和寫入性能會明顯下降。因此，一般會採用分庫分表的方式，把數據規模控制在百萬級。</li><li>查詢效率瓶頸：mysql對於常用的條件查詢，需要單獨建立索引或組合索引。非索引字段的查詢需要掃描全表，性能下降明顯。</li></ol><p>綜上分析，我們的應用場景，並不適合採用行存儲數據庫，因此我們重點考慮列存數據庫。</p><p>2.2 行式存儲與列式存儲</p><p>下面簡單對比一下行式存儲與列式存儲的特點：</p><p>行式存儲 列式存儲 存儲特點 同一行數據一起存儲 同一列數據一起存儲 讀取優點 一次性讀取整行數據快捷 讀取單列數據快捷 讀取缺點 單列讀取，也需要讀取整行數據 整行查詢，需要重組數據 數據更新特點 INSERT/UPDATE比較方便 INSERT/UPDATE比較麻煩 索引 需要單獨對查詢列建索引 每一列都可以作為索引 壓縮特點 同一行數據差異大，壓縮比率低 一列數據由於相似性，壓縮比率高 行存適合近線數據分析，比如要求查詢表中某幾條符合條件的記錄的所有字段的場景。列存適合用於數據的統計分析。考慮如下場景：一個用於存放用戶的表中有20個字段，而我們要統計用戶年齡的平均值，如果是行存，則要全表掃描，遍歷所有行。但如果是列存，數據庫只要定位到年齡這一列，然後只掃描這一列的數據就可以得到所有的年齡，計算平均值，性能上相比行存理論上就會快20倍。</p><p>而在列存數據庫中，比較常見的是HBase。HBase應用的核心設計重點是rowkey的設計，一般要把常用的篩選條件，組合設計到rowkey中，通過rowkey的get(單條記錄)或者scan(範圍)查詢。因此HBase比較適合有限查詢條件下的非結構化數據存儲。而我們的場景，由於所有字段都需要作為篩選條件，所以本質上還是需要結構化存儲，且要求查詢低延遲，因此也無法使用HBase。</p><p>我們綜合考慮集團內多款列式存儲的DB產品(ADS/PostgreSQL/HBase/HybridDB)，綜合評估讀寫性能、穩定性、語法完備程度及開發和部署成本，我們選擇了HybridDB for MySQL計算規格來構建人群圈選引擎。</p><p>2.3 HybridDB for MySQL計算規格介紹</p><p>HybridDB for MySQL計算規格對我們的這個場景而言，核心能力主要有：</p><ol><li>任意維度智能組合索引(使用方無需單獨自建索引)</li><li>百億大表查詢毫秒級響應</li><li>MySql BI生態兼容，完備SQL支持</li><li>空間檢索、全文檢索、複雜數據類型(多值列、JSON)支持</li></ol><p>那麼，HybridDB for MySQL計算規格是如何做到大數據場景下的任意維度組合查詢的毫秒級響應的呢？</p><ul><li>首先是HybridDB的高性能列式存儲引擎，內置於存儲的謂詞計算能力，可以利用各種統計信息快速跳過數據塊實現快速篩選；</li><li>第二是HybridDB的智能索引技術，在大寬表上一鍵自動全索引並根據列索引智能組合出各種謂詞條件進行過濾；</li><li>第三是高性能MPP+DAG的融合計算引擎，兼顧高併發和高吞吐兩種模式實現了基於pipeline的高性能向量計算，並且計算引擎和存儲緊密配合，讓計算更快；</li><li>第四是HybridDB支持各種數據建模技術例如星型模型、雪花模型、聚集排序等，業務適度數據建模可以實現更好的性能指標。</li></ul><p>綜合來說，HybridDB for MySQL計算規格是以SQL為中心的多功能在線實時倉庫系統，很適合我們的業務場景，因此我們在此之上構建了我們的人群圈選底層引擎。</p><h1>3、業務實現</h1><p>在搭建了人群圈選引擎之後，我們重點改造了我們的消息推送系統，作為人群精細化運營的一個重要落地點。</p><p>3.1 閒魚消息推送簡介</p><p>消息推送(PUSH)是信息觸達用戶最快捷的手段。閒魚比較常用的PUSH方式，是先離線計算好PUSH人群、準備好對應PUSH文案，然後在第二天指定的時間推送。一般都是週期性的PUSH任務。但是臨時性的、需要立刻發送、緊急的PUSH任務，就需要BI同學介入，每個PUSH任務平均約需要佔用BI同學半天的開發時間，且操作上也比較麻煩。本次我們把人群圈選系統與原有的PUSH系統打通，極大地改善了此類PUSH的準備數據以及發送的效率，解放了開發資源。</p><p>3.2 系統架構</p><div class=pgc-img><img alt=毫秒級從百億大表任意維度篩選數據，是怎麼做到的…… onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/16f94cabeb6c451d97112789493bf5a3><p class=pgc-img-caption></p></div><p>離線數據層：用戶維度數據，分散在各個業務系統的離線表中。我們通過離線T+1定時任務，把數據彙總導入到實時計算層的用戶大寬表中。</p><p>實時計算層：根據人群的篩選條件，從用戶大寬表中，查詢符合的用戶數量和用戶ID列表，為應用系統提供服務。</p><p>人群圈選前臺系統：提供可視化的操作界面。運營同學選擇篩選條件，保存為人群，用於分析或者發送PUSH。每一個人群，對應一個SQL存儲。類似於：</p><p>select count(*) from user_big_table where column1> 1 and column2 in ('a','b') and ( column31=1 or column32=2)</p><p>同時，SQL可以支持任意字段的多層and/or嵌套組合。</p><p>用SQL保存人群的方式，當用戶表中的數據變更時，可以隨時執行SQL，獲取最新的人群用戶，來更新人群。</p><p>閒魚PUSH系統：從人群圈選前臺系統中獲取人群對應的where條件，再從實時計算層，分頁獲取用戶列表，給用戶發送PUSH。在實現過程中，我們重點解決了分頁查詢的性能問題。</p><p>分頁查詢性能優化方案：</p><p>在分頁時，當人群的規模很大(千萬級別)時，頁碼越往後，查詢的性能會有明顯下降。因此，我們採用把人群數據增加行號、導出到MySql的方式，來提升性能。表結構如下：</p><ul><li>批次號 人群ID 行號 用戶ID 1001 1 1 123 1001 1 2 234 1001 1 3 345 1001 1 4 456 批次號：人群每導出一次，就新加一個批次號，批次號為時間戳，遞增。</li><li>行號：從1開始遞增，每一個批次號對應的行號都是從1到N。</li></ul><p>我們為"人群ID"+"批次號"+"行號"建組合索引，分頁查詢時，用索引查詢的方式替換分頁的方式，從而保證大頁碼時的查詢效率。</p><p>另外，為此額外付出的導出數據的開銷，得益於HybridDB強大的數據導出能力，數據量在萬級別至百萬級別，耗時在秒級至幾十秒級別。綜合權衡之後，採用了本方案。</p><h1>4、PUSH系統改造收益</h1><div class=pgc-img><img alt=毫秒級從百億大表任意維度篩選數據，是怎麼做到的…… onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8052adb352c345eeb72853e6a65c6f57><p class=pgc-img-caption></p></div><p>人群圈選系統為閒魚精細化用戶運營提供了強有力的底層能力支撐。同時，圈選人群，也可以應用到其他的業務場景，比如首頁焦點圖定投等需要分層用戶運營的場景，為閒魚業務提供了很大的優化空間。</p><p>本文實現了海量多維度數據中組合查詢的秒級返回結果，是一種OLAP場景下的通用技術實現方案。同時介紹了用該技術方案改造原有業務系統的一個應用案例，取得了很好的業務結果，可供類似需求或場景的參考。</p><h1>5、未來</h1><p>人群圈選引擎中的用戶數據，我們目前是T+1導入的。這是考慮到人群相關的指標，變化頻率不是很快，且很多指標(比如用戶標籤)都是離線T+1計算的，因此T+1的數據更新頻度是可以接受的。後續我們又基於HybridDB構建了更為強大的商品圈選引擎。閒魚商品數據相比用戶數據，變化更快。一方面用戶隨時會更新自己的商品，另一方面，由於閒魚商品單庫存(售出即下架)的特性，以及其他原因，商品狀態會隨時變更。因此我們的選品引擎，應該儘快感知到這些數據的變化，並在投放層面做出實時調整。我們基於HybridDB(存儲)和實時計算引擎，構建了更為強大的“馬赫”實時選品系統。後續即將推出“馬赫”的系列文章，有興趣的同學可以關注。另外如果對本文中的具體技術實現(細節)有任何問題，請聯繫我們。謝謝。</p><p>參考資料：</p><p>HybridDB for MySQL介紹： https://www.aliyun.com/product/petadata</p><p>作者：閒魚技術-才思</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>百億大表</a></li><li><a>維度</a></li><li><a>篩選數</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/c381b959.html alt=物理密度和維度兩個概念的闡述 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/342b847695e9452ea98e6fcd1828b562 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c381b959.html title=物理密度和維度兩個概念的闡述>物理密度和維度兩個概念的闡述</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9dab4f31.html alt=從三個維度訓練口才，就能快速提高你的語言表達能力 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/4934eb76-719f-4562-86e9-2377677bf1d5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9dab4f31.html title=從三個維度訓練口才，就能快速提高你的語言表達能力>從三個維度訓練口才，就能快速提高你的語言表達能力</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ac5faa21.html alt=技術分享：四個全新維度，高效優化你的HTTP性能 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/8d0df2bf-ac95-4f50-afa6-e2494069d42f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ac5faa21.html title=技術分享：四個全新維度，高效優化你的HTTP性能>技術分享：四個全新維度，高效優化你的HTTP性能</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/c62353ac.html alt=我的世界：mc新增第4維度“天啟之境”，一封信戳中了我的淚點 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3aba451400be426dad08c4d3027164d1 style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/c62353ac.html title=我的世界：mc新增第4維度“天啟之境”，一封信戳中了我的淚點>我的世界：mc新增第4維度“天啟之境”，一封信戳中了我的淚點</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cc2c8ef8.html alt=從不同維度認識有趣的小型核反應堆 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RRcJRaG2PLJ35A style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cc2c8ef8.html title=從不同維度認識有趣的小型核反應堆>從不同維度認識有趣的小型核反應堆</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/af6d112.html alt=業務分析師必須要了解的維度建模過程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/25860d94634040bf83f8b8f7ebf844ed style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/af6d112.html title=業務分析師必須要了解的維度建模過程>業務分析師必須要了解的維度建模過程</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/3866234.html alt=四個維度，讓廚房操作檯更加實用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/50ae0001e55cae3f753e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/3866234.html title=四個維度，讓廚房操作檯更加實用>四個維度，讓廚房操作檯更加實用</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>