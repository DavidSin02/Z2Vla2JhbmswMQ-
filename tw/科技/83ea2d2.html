<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>用普通權限的域帳戶獲得域環境中所有DNS解析記錄 | 极客快訊</title><meta property="og:title" content="用普通權限的域帳戶獲得域環境中所有DNS解析記錄 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/5135b71af62746ddbdd11009cc871e55"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/83ea2d2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/83ea2d2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/83ea2d2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/83ea2d2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/83ea2d2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/83ea2d2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/83ea2d2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/83ea2d2.html><meta property="article:published_time" content="2020-10-29T21:08:07+08:00"><meta property="article:modified_time" content="2020-10-29T21:08:07+08:00"><meta name=Keywords content><meta name=description content="用普通權限的域帳戶獲得域環境中所有DNS解析記錄"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/83ea2d2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>用普通權限的域帳戶獲得域環境中所有DNS解析記錄</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>DNS區域傳送對安全研究人員來說是一種非常經典的攻擊角度。這意味著區域網絡內有可能存在一個配置不安全的DNS服務器，任意匿名用戶都可<span>給它</span>發送指令，獲得區域網絡內所有域名數據。但是，相信沒有多少人知道如果內網網絡使用了活動目錄所集成的DNS，任何內網用戶都有權限查詢所有的DNS記錄。</p><p>本文章將介紹基於上述情況的手動查詢DNS記錄的方法，以及一種可以自動執行該操作的工具。</p><h1>背景</h1><p>就個人而言，每當我要開始一個新的滲透任務時，通常會先了解整體網絡佈局、網絡中涉及的軟件、敏感數據的位置。但是，如果網絡中的服務器名稱不含功能描述，只是單純的00001，00002，00003，那麼我就很難理出頭緒，不知從哪開始著手。</p><p>假設使用EyeWitness之類的工具進行掃描，你就會在返回中看到大量默認的Apache/IIS頁面，因為大多數站點都配置為監聽DNS名稱而不是IP地址。此時你如果知道DNS記錄，可能就會發現SRV00001.company.local和gitlab.company.local指向同一個IP，這個IP上可能存放著大量源碼。</p><p>綜上所述，我認為活動目錄中DNS記錄是具有很高的價值的。為此我還編寫了一個可以轉儲這些DNS記錄的小工具。你既可以直接在網絡中的主機運行它，也可以通過SOCKS隧道利用。</p><h1>開端</h1><p>我之所以研究域環境中的DNS記錄，主要是受到Kevin Robertson關於ADIDNS研究的啟發。當我使用ADSI Edit時，試圖找出活動目錄如何在LDAP中的區域（zone）存儲DNS記錄時，突然看到了域中有關DNS記錄的概述。此時我感到非常驚訝，但Kevin向我指出，mubix早在2013年就寫過這方面的文章了。因此，早在2013年，就有PowerShell腳本可以提取DNS記錄，但它並沒有完全符合我的要求，所以我決定編寫一個Python腳本，再加入一些功能。</p><pre>@3xocyte也用Python編寫了一個類似的腳本。</pre><h1>“隱藏的”DNS記錄</h1><p>在LDAP中查詢DNS記錄的主要方法是選擇dnsNode類的所有對象執行查詢操作，你會看到DNS區域中的所有實體。當我使用過濾器執行查詢時(objectClass=dnsNode)，只會返回非常有限的結果。要知道，即使我手動瀏覽DNS區域，都可以看到更多記錄：</p><div class=pgc-img><img alt=用普通權限的域帳戶獲得域環境中所有DNS解析記錄 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5135b71af62746ddbdd11009cc871e55><p class=pgc-img-caption></p></div><p>很多對象的objectClass都不可見，這是因為計算機DNS記錄的默認權限（我認為其他記錄也不是通過活動目錄DNS頁面創建的）不會允許所有用戶查看其內容。再加上IP地址實際作為這些對象的屬性來存儲，因此無法查看這些記錄中的IP地址。</p><p>但是，在默認情況下，任何用戶都可以創建新的DNS記錄，任何用戶也可以列出DNS區域的子對象。總而言之，我們知道哪裡有記錄，只是無法使用LDAP查詢它。</p><div class=pgc-img><img alt=用普通權限的域帳戶獲得域環境中所有DNS解析記錄 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/60f09f6bdd2e43099a381c4c4244dae1><p class=pgc-img-caption></p></div><p>不過，一旦我們通過枚舉LDAP知道了一條記錄，就可以直接使用DNS查詢它（因為執行常規DNS查詢不需要特權）。這樣我們就可以解析區域中的所有記錄。</p><h1>adidnsdump</h1><p>要使用adidnsdump，你可以從我的GitHub（https://github.com/dirkjanm/adidnsdump）獲取，它能枚舉DNS區域中的所有記錄。首先，使用參數--print-zones顯示當前域中的所有區域。注意，並非所有的區域都很意義，例如轉發，緩存等區域不會包含域的所有記錄。如果找到這種區域，最好查詢一下它們實際所屬的域。下面的命令顯示我搭建的測試域中只有默認區域：</p><pre>user@localhost:~/adidnsdump$ adidnsdump -u icorp\\testuser --print-zones icorp-dc.internal.corpPassword: [-] Connecting to host...[-] Binding to host[+] Bind OK[-] Found 2 domain DNS zones: internal.corp RootDNSServers[-] Found 2 forest DNS zones: ..TrustAnchors _msdcs.internal.corp</pre><p>如果我們為工具指定區域，我們將獲得所有記錄。其中會顯示哪些可以列出來，但不能讀取的記錄（即上述所謂的“隱藏”DNS記錄），會表示為問號。這些記錄會全部被保存到名為records.csv的文件中。</p><div class=pgc-img><img alt=用普通權限的域帳戶獲得域環境中所有DNS解析記錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/52e0b27f675a428b97d7daceb55ba1ee><p class=pgc-img-caption></p></div><p>要解析這些未知記錄，可使用參數-r，該標誌將對所有未知記錄執行A查詢。此時你會發現，之前的?突然有了記錄：</p><div class=pgc-img><img alt=用普通權限的域帳戶獲得域環境中所有DNS解析記錄 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/931718bf65a14ea5a17dfdf80a0f1b1d><p class=pgc-img-caption></p></div><p>如果你是通過代理連接操作，你可以使用參數--dns-tcp，通過TCP執行DNS查詢。</p><h1>防禦措施</h1><p>為了安全起見，你可以提高記錄的查詢權限，刪除普通人的“List content”權限，但這可能會產生負面影響，所以我不建議那樣做。通過某些軟件監控DNS查詢動作或啟用DNS區域審計可能是解決這類問題的最好方法。</p><h1>工具</h1><p>adidnsdump可以通過GitHub和PyPI（pip install adidnsdump）安裝使用。最後的結果會轉儲到CSV文件，你可以自己把文件轉換為其他格式。</p><p>本文由白帽彙整理並翻譯，不代表白帽匯任何觀點和立場</p><p>來源：https://nosec.org/home/detail/2527.html</p><p>原文：https://dirkjanm.io/getting-in-the-zone-dumping-active-directory-dns-with-adidnsdump/</p><p>白帽匯從事信息安全，專注於安全大數據、企業威脅情報。</p><p>公司產品：FOFA-網絡空間安全搜索引擎、FOEYE-網絡空間檢索系統、NOSEC-安全訊息平臺。</p><p>為您提供：網絡空間測繪、企業資產收集、企業威脅情報、應急響應服務。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>權限</a></li><li><a>帳戶</a></li><li><a>獲得域</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/c4007f5c.html alt=基於芯片仿真器的程序訪問權限配置方案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RfcQ7YoHQMBFqo style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c4007f5c.html title=基於芯片仿真器的程序訪問權限配置方案>基於芯片仿真器的程序訪問權限配置方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/e592e74.html alt=國開行迴應棚改貸款：審查權限在總行審批權限在分行 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15319577919508c60a9943f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/e592e74.html title=國開行迴應棚改貸款：審查權限在總行審批權限在分行>國開行迴應棚改貸款：審查權限在總行審批權限在分行</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/65f9194.html alt=大幅下放用地審批權限，釋放什麼信號？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/65f9194.html title=大幅下放用地審批權限，釋放什麼信號？>大幅下放用地審批權限，釋放什麼信號？</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/4ac8b14.html alt=工行上收信用卡授信審批權限 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RS6XMaF80vx9lm style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/4ac8b14.html title=工行上收信用卡授信審批權限>工行上收信用卡授信審批權限</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/99cbd79.html alt=農村宅基地審批權限直接下放到鄉鎮人民政府批准 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/99cbd79.html title=農村宅基地審批權限直接下放到鄉鎮人民政府批准>農村宅基地審批權限直接下放到鄉鎮人民政府批准</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/763f244.html alt=最低生活保障管理辦法出臺，審批權限全面下放 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/763f244.html title=最低生活保障管理辦法出臺，審批權限全面下放>最低生活保障管理辦法出臺，審批權限全面下放</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/cec2f82.html alt=榆次區下放長壽優待金審核權限 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/cec2f82.html title=榆次區下放長壽優待金審核權限>榆次區下放長壽優待金審核權限</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/eadd87e.html alt="詳解Yearning  SQL審核平臺權限規劃--基於用戶的細粒度權限" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a8ed3617e1984183a15fe9fa883862e8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/eadd87e.html title="詳解Yearning  SQL審核平臺權限規劃--基於用戶的細粒度權限">詳解Yearning SQL審核平臺權限規劃--基於用戶的細粒度權限</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/a019651.html alt="遷安審批權限下放事項 居唐山市縣區首位" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/a019651.html title="遷安審批權限下放事項 居唐山市縣區首位">遷安審批權限下放事項 居唐山市縣區首位</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>