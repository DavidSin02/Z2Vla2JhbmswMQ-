<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Netty學習問題總結 | 极客快訊</title><meta property="og:title" content="Netty學習問題總結 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/14050106b4e74c4699917cf53ab1bf62"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/876514d6.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/876514d6.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/876514d6.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/876514d6.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/876514d6.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/876514d6.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/876514d6.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/876514d6.html><meta property="article:published_time" content="2020-10-29T21:09:07+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:07+08:00"><meta name=Keywords content><meta name=description content="Netty學習問題總結"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/876514d6.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Netty學習問題總結</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>本篇記錄了Netty學習過程中想到的問題和自己的一些思考，對於應用層的協議也有了更好的理解，所以在此做一個記錄。</p><div class=pgc-img><img alt=Netty學習問題總結 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/14050106b4e74c4699917cf53ab1bf62><p class=pgc-img-caption></p></div><p><strong>一、HTTP協議分包</strong></p><p>TCP是作為面來流的協議，所以需要應用層協議自己去分包。常見的分包格式如下：</p><ol><li>定長： 比如100字節每個報文，不足的前面補0，這時候每次取消息就取到100字節算整包)</li><li>分隔符： 換行符其實是一種特別的分隔符，每次讀取到分隔符就知道一個包讀取完畢)</li><li>指明長度： 比如前兩個字節為長度字段，先讀取兩個字節，知道了需要多少字節，讀取到對應的字節就是一個整包了</li></ol><p>然而HTTP協議格式並不是上面的簡單的一種，它結合了2和3兩種來進行分包，因為請求和響應報文格式一樣，所以這裡針對請求報文進行說明。我們知道HTTP分為請求行，請求頭，請求體。</p><p><strong>HTTP報文格式</strong>：</p><pre> generic-message = start-line *(message-header CRLF) CRLF [ message-body ]</pre><div class=pgc-img><img alt=Netty學習問題總結 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/85a5f0a8906a4814b0239a5627136fbf><p class=pgc-img-caption></p></div><p><strong>報文讀取過程</strong></p><ul><li>讀取請求行：每個HTTP請求的第一行作為請求行，所以知道讀取到CRLF就說明結束了</li><li>讀取請求頭：請求頭有多行，行數不是固定的，他的結尾是根據連續的兩個CRLF來判斷的，在message-body之前會有一個CRLF</li><li>讀取請求體：對於POST等帶有請求體的方法來說，請求體的長度是不固定的，這時候請求頭中會有個Content-Length字段說明了請求體的長度，所以只要讀取完Content-Length個字節，整個HTTP請求報文也就得到了</li></ul><p><strong>關於報文分割一點備註</strong>：早期的HTTP 1.0時代，因為它每次請求都會經歷tcp的三次握手連接過程，所以它是通過連接的關閉來判斷報文已經讀取完畢，但是這裡還有一個問題，如果這個連接關閉時因為服務端的錯誤引起的那客戶端就無法區分了。到了HTTP 1.1，因為很多請求會重用一個連接，所以需要用到Content-Length這個字段來做分包。另外還有一種不需要Content-Length的方法就是請求頭中Transfer-Encoding為chunked，這是一種分塊傳輸，在壓縮傳輸，動態內容生成等響應在一開始長度未知的場景下很有用。他的報文分割也很簡單，詳情參見：分塊傳輸編碼</p><p><strong>二、WebSocket協議分包</strong></p><p>理解了HTTP協議的分包，WebSocket的協議也容易理解，道理都是想通的。一開始在谷歌的時候一直搜索不到相關的報文，最後搜索WebSocket數據幀才搜到了結果(搜索是門技巧啊)。我最關注的是opcode字段，因為在用WebSocket的時候就用到了這個字段來判斷是什麼幀類型。第二是Payload len字段，這是一個變長字段，為了節省字節數，含義如下：</p><ol><li>如果數據長度小於等於125的話，那麼該7位用來表示實際數據長度。</li><li>如果數據長度為126到65535(2的16次方)之間，該7位值固定為126，也就是 1111110，往後擴展2個字節(16為，第三個區塊表示)，用於存儲數據的實際長度。</li><li>如果數據長度大於65535， 該7位的值固定為127，也就是 1111111 ，往後擴展8個字節(64位)，用於存儲數據實際長度。</li></ol><p>WebSocket RFC中websocket報文格式</p><pre> 0 1 2 3 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 +-+-+-+-+-------+-+-------------+-------------------------------+ |F|R|R|R| opcode|M| Payload len | Extended payload length | |I|S|S|S| (4) |A| (7) | (16/64) | |N|V|V|V| |S| | (if payload len==126/127) | | |1|2|3| |K| | | +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - + | Extended payload length continued, if payload len == 127 | + - - - - - - - - - - - - - - - +-------------------------------+ | |Masking-key, if MASK set to 1 | +-------------------------------+-------------------------------+ | Masking-key (continued) | Payload Data | +-------------------------------- - - - - - - - - - - - - - - - + : Payload Data continued ... : + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - + | Payload Data continued ... | +---------------------------------------------------------------+</pre><p><strong>三、HTTP和WebSocket協議共用一個端口的問題</strong></p><p>之前對這個現象十分不理解，很多Web服務器例如Tomcat都支持HTTP和WebSocket共用一個端口，他是怎麼做到的？</p><p>其實理解了報文的解析就很容易理解了，HTTP和WebSocket協議的下層都是TCP連接，他們是應用層連接，所以在處理TCP的字節流時，可以先獲取幾個字節，如果前幾個字節解析出來是GET，POST等HTTP協議的用到的，那麼就根據HTTP報文的分包規則獲取一個HTTP報文然後流轉到後端處理。如果是WebSocket協議就根據WebSocket報文來解析然後做響應的處理。</p><p>補充：很多的協議棧都是以魔數打頭，這樣就更容易實現同端口多協議的支持，如Dubbo協議棧前兩個字節是魔數，只需要判斷報文的前兩個字節就知道是不是Dubbo協議了，Dubbo協議棧頭報文如下圖</p><div class=pgc-img><img alt=Netty學習問題總結 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0b1fdd9df81e4ddf9f3965d2fce11811><p class=pgc-img-caption></p></div><p><strong>四、TIME WAIT狀態佔用了什麼資源</strong></p><p>我們知道TCP四次揮手時主動發起方會經歷一個TIME WAIT狀態，也正是因為這個原因我們儘量讓客戶端主動關閉連接。對於這個狀態有人說是佔用了文件描述符，有人說是端口，那麼究竟是佔用了什麼資源？</p><p>根據我自己的實驗，Windows系統下，TIME WAIT狀態佔用了端口，該端口不能作為客戶端端口使用，但仍然可以作為服務端端口使用。實驗端口：服務端8080，客戶端6060 。情況如下：</p><ol><li>客戶端主動關閉，客戶端重啟時報BindException，服務端用6060端口仍可正常啟動</li><li>服務端主動關閉，服務端重啟正常，客戶端重啟也正常，但是如果停掉服務端8080，客戶端用6060報BindException</li></ol><p>實驗代碼如下，可根據需要自己修改試驗：</p><p><strong>服務端主動關閉</strong>：</p><pre>public class ServerSocketCloseTest { public static void main(String[] args) throws IOException, InterruptedException { Runnable runnable = () -&gt; { try { ServerSocket serverSocket = null; serverSocket = new ServerSocket(8080, 10); while (true) { Socket accept = serverSocket.accept(); accept.close(); } } catch (IOException e) { e.printStackTrace(); } }; new Thread(runnable).start(); Socket socket = new Socket(InetAddress.getLocalHost(), 8080, InetAddress.getLocalHost(), 6060); Thread.sleep(1000); socket.close(); System.in.read(); }}</pre><p><strong>客戶端主動關閉場景</strong></p><pre>public class ClientSocketCloseTest { public static void main(String[] args) throws IOException, InterruptedException { Runnable runnable = () -&gt; { try { ServerSocket serverSocket = new ServerSocket(8080, 10); while (true) { Socket accept = serverSocket.accept(); Thread.sleep(1000); accept.close(); } } catch (IOException | InterruptedException e) { e.printStackTrace(); } }; new Thread(runnable).start(); Socket socket = new Socket(InetAddress.getLocalHost(), 8080, InetAddress.getLocalHost(), 6060); socket.close(); Thread.sleep(1000); System.in.read(); }}</pre><p>結論：處於TIME WAIT狀態下的端口不能作為客戶端端口使用。對於服務端端口沒有影響，服務端是仍然是可以正常綁定，接收到客戶端連接後本地端口和監聽端口是同一個所以不存在端口占用。另外通過查閱資料，TIME WAIT是釋放了文件描述符，但是TCP連接的五元組並未釋放，還佔用一定的內存。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Netty</a></li><li><a>學習</a></li><li><a>問題</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/6775da78.html alt=行動學習“欣賞式探詢”教會你如何發現問題背後的問題 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/594000061d8e5411e469 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6775da78.html title=行動學習“欣賞式探詢”教會你如何發現問題背後的問題>行動學習“欣賞式探詢”教會你如何發現問題背後的問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/33697c6.html alt=帶著問題去學習，學霸有如掃描儀將知識高效存入大腦，一個字快 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/be2b44129184476b82e4939740a59d21 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/33697c6.html title=帶著問題去學習，學霸有如掃描儀將知識高效存入大腦，一個字快>帶著問題去學習，學霸有如掃描儀將知識高效存入大腦，一個字快</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2f87337a.html alt=收不到交警便民通知？可能是這裡出了問題 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/bdf88511c83f431c9f75609d9e44d585 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2f87337a.html title=收不到交警便民通知？可能是這裡出了問題>收不到交警便民通知？可能是這裡出了問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8db1a012.html alt=問題408:在變壓器送電前後怎樣檢測差動保護裝置？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e7912ea051664f678d2616da1c042a37 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8db1a012.html title=問題408:在變壓器送電前後怎樣檢測差動保護裝置？>問題408:在變壓器送電前後怎樣檢測差動保護裝置？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dc2af9c9.html alt=機器學習筆記(七)——初識邏輯迴歸、不同方法推導梯度公式 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/13adbab9c7f94c7fa81d49a98861b051 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dc2af9c9.html title=機器學習筆記(七)——初識邏輯迴歸、不同方法推導梯度公式>機器學習筆記(七)——初識邏輯迴歸、不同方法推導梯度公式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e214e6d7.html alt=深度學習/機器學習入門數學知識整理（二）梯度與導數，泰勒展開 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1540372101455de0fb74774 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e214e6d7.html title=深度學習/機器學習入門數學知識整理（二）梯度與導數，泰勒展開>深度學習/機器學習入門數學知識整理（二）梯度與導數，泰勒展開</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f3767255.html alt=講透機器學習中的梯度下降 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5c80301e53424671bc22755be2e4ee33 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f3767255.html title=講透機器學習中的梯度下降>講透機器學習中的梯度下降</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ac12f3a1.html alt=直流鍋爐給水控制學習 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/eba10edcc8d14d9f8cde6fd5b212d90e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ac12f3a1.html title=直流鍋爐給水控制學習>直流鍋爐給水控制學習</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a1bc38f3.html alt=HTMLCSS學習筆記（六）——元素類型 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/bdb5988349894ce9bf568c6418f85b7d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a1bc38f3.html title=HTMLCSS學習筆記（六）——元素類型>HTMLCSS學習筆記（六）——元素類型</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/97886d06.html alt="web前端（從零開始），每天更新學習筆記 HTML5元素分類" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/46d70004fcd55e1ddad3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/97886d06.html title="web前端（從零開始），每天更新學習筆記 HTML5元素分類">web前端（從零開始），每天更新學習筆記 HTML5元素分類</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c9091681.html alt="MySQL 學習筆記" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c9091681.html title="MySQL 學習筆記">MySQL 學習筆記</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/175f9730.html alt=深入學習MySQL事務：ACID特性的實現原理「轉」 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/cdc702d66d6943499997d11e931425eb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/175f9730.html title=深入學習MySQL事務：ACID特性的實現原理「轉」>深入學習MySQL事務：ACID特性的實現原理「轉」</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f6b2ef73.html alt=如何學習模擬IC設計？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f6b2ef73.html title=如何學習模擬IC設計？>如何學習模擬IC設計？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c56ee116.html alt=小猿圈python學習-三大特性之多態 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ad0e8e3777854337abeb7c779ad79a04 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c56ee116.html title=小猿圈python學習-三大特性之多態>小猿圈python學習-三大特性之多態</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/84e317ac.html alt=檢測虛設問題，應當採取強有力的措施加以解決 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/115bad769be144f19346317e77eed4b3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/84e317ac.html title=檢測虛設問題，應當採取強有力的措施加以解決>檢測虛設問題，應當採取強有力的措施加以解決</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>