<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Java NIO(8) : 異步模型之狀態機 | 极客快訊</title><meta property="og:title" content="Java NIO(8) : 異步模型之狀態機 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/1522223705458c14ec4daaf"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8829489.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8829489.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8829489.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8829489.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8829489.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8829489.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8829489.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8829489.html><meta property="article:published_time" content="2020-10-29T20:59:15+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:15+08:00"><meta name=Keywords content><meta name=description content="Java NIO(8) : 異步模型之狀態機"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/8829489.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Java NIO(8) : 異步模型之狀態機</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>本節課是小密圈《進擊的Java新人》第十七週第四課。今天我們主要講解異步模型。</p><p>我們之前講過，阻塞和非阻塞IO的區別，今天來講一下同步和異步的區別。異步是啥，其實我也說不好，因為有多種說法相互矛盾，這個定義很難下。我只能大概描述一下，大家領會意思。(同樣是很權威的幾本書，包括操作系統教程，對於異步的定義都是不同的，有人把IO多路複用歸為異步，有人把它歸為同步。我個人傾向於歸為異步，理由後面會講)</p><p>同步（synchronization），這個概念，我更傾向於使用操作系統中的定義：</p><blockquote>是指在互斥的基礎上（大多數情況），通過其它機制實現訪問者對資源的有序訪問。在大多數情況下，同步已經實現了互斥，特別是所有寫入資源的情況必定是互斥的。少數情況是指可以允許多個訪問者同時訪問資源。它表達了任務間的直接制約關係，A要繼續執行需要B完成某一個操作操作才能繼續進行。</blockquote><p>用人話來說，就是兩個人幹活，有好多道工序，1，2，3，4，5，必須順序地一件件地做。我負責1，2，4，你負責3，5。在我幹完1，2之前，你什麼也不做，就等著，當我幹完1，2了，通知你幹活了，你再接著幹3，我等著你幹完以後通知我，我接著幹4，然後我幹完了再通知你，你接著幹5，最後完成整個工作。</p><p>對於現實世界來說，這是個很簡單的模型。比如我幹活的時候，你可以看視頻，刷知乎，聊微信。等我幹好了，喊你一聲，我就去刷知乎了。很簡單的事情。</p><p>但在計算機上就麻煩了。對應對計算機上來說，主要要回答三個問題：“我”和“你”是什麼？怎麼相互通知工序做完了？等待的時候就傻等著嗎？</p><p>我們一個個回答，“我”和“你”其實就是執行單元的抽象，它可以是進程，也可以是線程，還可以是協程，這三個程一個比一個輕量。我們今天就只拿線程來舉例，兩個線程可以是在同一個物理機上，同一個進程內，也可以是在不同進程內，甚至可以在不同機器上。今天就以服務端和客戶端模型來說明，這兩個線程不是運行在同一個物理機上的。</p><p>第二個問題，如何通訊？這個容易回答了，使用socket進行網絡通訊。</p><p>第三個問題，線程在等待另一個線程完成工作之前，只能傻等嗎？這是我們今天要著重解答的問題，我個人認為傻等的情況就是同步，可以一邊等一邊再做點其他事的情況就是異步。從這個角度來理解的話，我傾向於把IO多路複用歸到異步模型中去。</p><p>舉個例子</p><p>我現在要寫一個客戶端，向服務端發送兩個隨機數，第一個數代表被除數，第二個數代表除數，然後服務端會在收到第一個數以後，向客戶端報告收到被除數，收到第二個數以後做一個除法運算，並且將商發送回客戶端。客戶端我使用了阻塞式讀寫實現了同步模型：</p><pre>public class EpollClient { public static void main(String[] args) { try { SocketChannel socketChannel = SocketChannel.open(); socketChannel.connect(new InetSocketAddress("127.0.0.1", 8000)); ByteBuffer writeBuffer = ByteBuffer.allocate(32); ByteBuffer readBuffer = ByteBuffer.allocate(32); byte[] buf = new byte[32]; Random r = new Random(); int d = 0; d = r.nextInt(1000); System.out.println(d); writeBuffer.put(String.valueOf(d).getBytes()); writeBuffer.flip(); socketChannel.write(writeBuffer); socketChannel.read(readBuffer); readBuffer.flip(); System.out.println(new String(readBuffer.array())); // 這樣的客戶端是個大麻煩，說好了要發送數據，結果睡起覺來了 try { Thread.sleep(5000); } catch (InterruptedException e) { e.printStackTrace(); } writeBuffer.clear(); d = r.nextInt(10); System.out.println(d); writeBuffer.put(String.valueOf(d).getBytes()); writeBuffer.flip(); socketChannel.write(writeBuffer); readBuffer.clear(); socketChannel.read(readBuffer); readBuffer.flip(); readBuffer.get(buf, 0, readBuffer.remaining()); System.out.println(new String(buf)); socketChannel.close(); } catch (IOException e) { } }}</pre><p>代碼雖然長，但是很簡單，發一個隨機數，接受服務端的報告，休眠5秒鐘。醒過來以後，繼續發送第二個數。可想而知，如果使用阻塞式接口，服務端的線程會在read方法裡休眠，直到客戶端發送完數據為止。客戶端的睡會使得服務端也跟著休眠了，服務端就不能再做其他事情了。最重要的是，不能再響應其他客戶端的請求了（假如我們有1萬個客戶端同時發起請求）。</p><p>第一個辦法，為每一個客戶端連接，開一個線程，這可以解決一部分問題。服務端多開一些線程，一個線程休眠了，再有其他連接到達，我們再開一個線程就可以了。但是我們知道線程是一種很寶貴的資源，而且佔據內存開銷很大。雖然這是一個簡單有效的方案，但還是不能解決問題。</p><p>我們前三節課重點講了Selector，我們可以使用Selector來解決這個問題。</p><pre>public class EpollServer { public static void main(String[] args) { try { ServerSocketChannel ssc = ServerSocketChannel.open(); ssc.socket().bind(new InetSocketAddress("127.0.0.1", 8000)); ssc.configureBlocking(false); Selector selector = Selector.open(); ssc.register(selector, SelectionKey.OP_ACCEPT); ByteBuffer readBuff = ByteBuffer.allocate(1024); ByteBuffer writeBuff = ByteBuffer.allocate(128); writeBuff.put("received".getBytes()); writeBuff.flip(); while (true) { int nReady = selector.select(); Set&lt;SelectionKey&gt; keys = selector.selectedKeys(); Iterator&lt;SelectionKey&gt; it = keys.iterator(); while (it.hasNext()) { SelectionKey key = it.next(); it.remove(); if (key.isAcceptable()) { SocketChannel socketChannel = ssc.accept(); socketChannel.configureBlocking(false); SelectionKey connectionKey = socketChannel.register(selector, SelectionKey.OP_READ); connectionKey.attach(new EpollTask(socketChannel, connectionKey)); } else if (key.isReadable()) { SocketChannel socketChannel = (SocketChannel) key.channel(); readBuff.clear(); socketChannel.read(readBuff); readBuff.flip(); EpollTask conn = (EpollTask)key.attachment(); conn.onRead(getInt(readBuff)); key.interestOps(SelectionKey.OP_WRITE); } else if (key.isWritable()) { writeBuff.rewind(); SocketChannel socketChannel = (SocketChannel) key.channel(); EpollTask conn = (EpollTask)key.attachment(); key.interestOps(SelectionKey.OP_READ); conn.onWrite(); } } } } catch (IOException e) { e.printStackTrace(); } } public static int getInt(ByteBuffer buf) { int r = 0; while (buf.hasRemaining()) { r *= 10; r += buf.get() - '0'; } return r; }}</pre><p>這裡面用到的EpollTask是這樣定義的：</p><pre>public class EpollTask { private SocketChannel socketChannel; private SelectionKey key; private int state; private int dividend; private int divisor; private int result; private ByteBuffer writeBuffer; public EpollTask(SocketChannel socketChannel, SelectionKey key) { this.socketChannel = socketChannel; writeBuffer = ByteBuffer.allocate(64); this.key = key; } public void onRead(int data) { if (state == 0) { dividend = data; System.out.println(dividend); state = 1; } else if (state == 2) { divisor = data; System.out.println(divisor); if (divisor == 0) result = Integer.MAX_VALUE; else result = dividend / divisor; state = 3; } else { throw new RuntimeException("wrong state " + state); } } public void onWrite() { try { if (state == 1) { writeBuffer.clear(); writeBuffer.put("divident".getBytes()); writeBuffer.flip(); socketChannel.write(writeBuffer); state = 2; } else if (state == 3) { writeBuffer.clear(); writeBuffer.put(String.valueOf(result).getBytes()); writeBuffer.flip(); socketChannel.write(writeBuffer); socketChannel.close(); key.cancel(); state = 4; } } catch (IOException e) { e.printStackTrace(); } }}</pre><p>這就是一個狀態機模型的例子。我們的服務端雖然只有一個線程，但是當多個客戶端來連接的時候，仍然可以快速響應。也就是說，ABC三臺客戶端去連接服務端的時候，在等待A繼續發第二個數過來的時候，服務端仍然有能力去讀取B和C的第一個數。運行一下，看結果：</p><p>服務端：</p><p><img alt="Java NIO(8) : 異步模型之狀態機" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1522223705458c14ec4daaf></p><p>客戶端A：</p><p><img alt="Java NIO(8) : 異步模型之狀態機" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1522223705328c9d742ed14></p><p>客戶端B：</p><p><img alt="Java NIO(8) : 異步模型之狀態機" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1522223705355af9a0134ce></p><p>客戶端C：</p><p><img alt="Java NIO(8) : 異步模型之狀態機" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15222237054282f83522dae></p><p>可以看到，服務端接受數據的順序是A的第一個數，B的第一個數，C的第一個數，然後是A的第二個數，B二，C二。換句話說，服務端在等待A的時候，可以同時去做其他的任務。所以，我個人是傾向於將IO多路複用歸類開異步模型。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Java</a></li><li><a>NIO</a></li><li><a>異步</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/8ca81088.html alt="Java NIO通信框架在電信領域的實踐" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/15346469062094e0715f5be style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8ca81088.html title="Java NIO通信框架在電信領域的實踐">Java NIO通信框架在電信領域的實踐</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f74b39f.html alt="Java 異步編程導論" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3c356b1aa9b4416ca7b35a07f3033e13 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f74b39f.html title="Java 異步編程導論">Java 異步編程導論</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/325007f.html alt="教你如何用 Java 實現異步調用" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/325007f.html title="教你如何用 Java 實現異步調用">教你如何用 Java 實現異步調用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/630242c.html alt=認識Java異步編程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e1e2b766f8f9413597586d35d1739683 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/630242c.html title=認識Java異步編程>認識Java異步編程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/48ba24d7.html alt=深入淺出：Java事務原理和應用兼JDBC事務詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/3c5e0002a8059c1311aa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/48ba24d7.html title=深入淺出：Java事務原理和應用兼JDBC事務詳解>深入淺出：Java事務原理和應用兼JDBC事務詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b8bda645.html alt=「Java」隨機數詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/b471807e699b44c2b1dedc580ea3f3af style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b8bda645.html title=「Java」隨機數詳解>「Java」隨機數詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/816b04b7.html alt=從JVM層面帶你分析Java的Object類源碼第一部分 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/816b04b7.html title=從JVM層面帶你分析Java的Object類源碼第一部分>從JVM層面帶你分析Java的Object類源碼第一部分</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cf633068.html alt="Java 多態的實現機制，看了都說好" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9d3b0e55813d46b4982ae7d9b81d1802 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cf633068.html title="Java 多態的實現機制，看了都說好">Java 多態的實現機制，看了都說好</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/12498348.html alt="Java 編譯時多態和運行時多態" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/1531535784468c357213ffe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/12498348.html title="Java 編譯時多態和運行時多態">Java 編譯時多態和運行時多態</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d60e504d.html alt=Java基礎之多態，動態綁定多態的代碼案例，簡單卻很重要 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ab338c7287fe4649a96227987579c844 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d60e504d.html title=Java基礎之多態，動態綁定多態的代碼案例，簡單卻很重要>Java基礎之多態，動態綁定多態的代碼案例，簡單卻很重要</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bb876e43.html alt=Java特性之一：多態詳解，學java不求人 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/39a700034bab2e1401a3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bb876e43.html title=Java特性之一：多態詳解，學java不求人>Java特性之一：多態詳解，學java不求人</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/234d55fa.html alt=Java開發課程（十）——面向對象5、多態 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/df3621e51e4242fd90731dd013472f12 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/234d55fa.html title=Java開發課程（十）——面向對象5、多態>Java開發課程（十）——面向對象5、多態</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/96d2083b.html alt=「Java三分鐘」Java三大特性——多態理解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/6a9b8965-0a4c-4cb4-9389-6cbbda0e9d93 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/96d2083b.html title=「Java三分鐘」Java三大特性——多態理解>「Java三分鐘」Java三大特性——多態理解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b96b5bf9.html alt=如何正確認識Java多態 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d2896b2f39694d39957b901a62cfe7fb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b96b5bf9.html title=如何正確認識Java多態>如何正確認識Java多態</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8a7023ee.html alt="Java 常見的49個錯誤及避免方法！翻譯作業：碼農網-小峰" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/3c5a0001a9e3fd1b8a13 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8a7023ee.html title="Java 常見的49個錯誤及避免方法！翻譯作業：碼農網-小峰">Java 常見的49個錯誤及避免方法！翻譯作業：碼農網-小峰</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>