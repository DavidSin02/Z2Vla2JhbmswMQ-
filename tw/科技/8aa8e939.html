<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MySQL 傳統複製中常見故障處理和結構優化案例分析 | 极客快訊</title><meta property="og:title" content="MySQL 傳統複製中常見故障處理和結構優化案例分析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/c993e94407a64d11a011fbe9f2793025"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8aa8e939.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8aa8e939.html><meta property="article:published_time" content="2020-11-14T21:04:04+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:04+08:00"><meta name=Keywords content><meta name=description content="MySQL 傳統複製中常見故障處理和結構優化案例分析"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/8aa8e939.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MySQL 傳統複製中常見故障處理和結構優化案例分析</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>雖然MySQL5.7 的主從複製已經很穩定了，但在備庫可讀寫的情況下，總是會出現部分數據不一致的情況，例如常見的1062、1032和1050錯誤。下面就介紹下這類報錯的常見處理方法和常見主從複製結構的調整。</p><p>環境描述</p><p>一</p><ul class=ul-level-0><li>1、mysql 5.7 以上，</li><li>2、binlog format 是row格式（5.7默認）</li><li>3、傳統複製（生產強烈推薦使用gtid）</li><li>4、log-bin , log_slave_updates 開啟</li><li>5、複製結構：101：3306> 103:3306 > 104:3306</li></ul><p>常見主從複製報錯</p><p>二</p><p>1、表重複錯誤： 1050</p><p>從庫已經有T2表，再在主庫上創建T2. 處理原則：以主庫為準，在從庫上drop t2。 然後重啟slave。</p><p>注意： 在db裡的操作都會記錄到binlog中，如果不想被記錄到binlog中，可以先set sql_log_bin=0.drop完成後，再 set sql_log_bin=1即可。</p><p>從5.7 開始，有super read only。</p><div class=pgc-img><img alt="MySQL 傳統複製中常見故障處理和結構優化案例分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c993e94407a64d11a011fbe9f2793025><p class=pgc-img-caption></p></div><p>處理方法：</p><p>從庫操作：</p><p>set sql_log_bin=0；</p><p>drop table t2;</p><p>set sql_log_bin=1;</p><p>start slave;</p><p>show slave status;</p><p>2、主鍵衝突： 1062</p><div class=pgc-img><img alt="MySQL 傳統複製中常見故障處理和結構優化案例分析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/513e7061090a46a98a515bdf74b0e0ff><p class=pgc-img-caption></p></div><p>處理方法：</p><p>從庫操作：</p><blockquote><p>set sql_log_bin=0；</p><p>delete from t2 where id =2;</p><p>set sql_log_bin=1;</p><p>start slave;</p><p>show slave status;</p></blockquote><p>3、主庫上更新後，從庫找不到記錄 ：1032</p><div class=pgc-img><img alt="MySQL 傳統複製中常見故障處理和結構優化案例分析" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/31b512eb8d1b4a3fb0097b4573a73b3c><p class=pgc-img-caption></p></div><p>這時需要解析主庫的binlog，把從庫的數據補回來。</p><div class=pgc-img><img alt="MySQL 傳統複製中常見故障處理和結構優化案例分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d7e27ff6c3fa401ea06357b007a17aa2><p class=pgc-img-caption></p></div><p>這裡就能看到從庫丟失的那條記錄。然後在從庫補充這條記錄即可。</p><p>處理方法：</p><p>從庫操作：</p><blockquote><p>set sql_log_bin=0；</p><p>insert into t2 (id) values (2);</p><p>set sql_log_bin=1;</p><p>start slave;</p><p>show slave status;</p></blockquote><p>4、主庫上delete後，從庫找不到記錄： 1032</p><div class=pgc-img><img alt="MySQL 傳統複製中常見故障處理和結構優化案例分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6e28635e00ee49ba9586ad484d4f7abc><p class=pgc-img-caption></p></div><p>想看某段pos內執行過的sql： 主庫執行：</p><blockquote><p><br></p></blockquote><pre><code>mysqlbinlog --base64-output=decode-rows -v --start-position=2465 --stop-position=2748 mysql-bin.000050 &gt; 50.sql</code></pre><p>輸出如下：</p><blockquote><p><br></p></blockquote><pre><code>### DELETE FROM `wubx`.`wubx`### WHERE###   @1=2###   @2='wubx'ROLLBACK /* added by mysqlbinlog */ /*!*/; </code></pre><p>注意這裡的rollback。如果以後基於binlog和時間點的恢復。這條數據會被rollback掉，造成一條數據的丟失。所以如果想保留這條數據，需要找到commit的位置，或者下個pos的位置。</p><p>處理方法：</p><p>從庫操作：</p><blockquote><p>slave stop;</p><p>SET GLOBAL SQL_SLAVE_SKIP_COUNTER = 1 #跳過一個事務</p><p>slave start</p></blockquote><p>常見覆制結構調整</p><p>三</p><p>1、一主一從，添加從庫</p><blockquote><p><br></p></blockquote><pre><code>st=&gt;operation: M 101:3306e=&gt;endop=&gt;operation: S1 103:3306 st-&gt;op-&gt;op1</code></pre><p>調整為，級聯或星型結構</p><blockquote><p><br></p></blockquote><pre><code>st=&gt;operation: M 101:3306e=&gt;endop=&gt;operation: S1 103:3306op1=&gt;operation: S11 104:3306 st-&gt;op-&gt;op1</code></pre><p>2、級聯複製調整</p><p><strong>從103.3306 dump數據</strong></p><blockquote><p><br></p></blockquote><pre><code>mysqldump --single-transaction --master-data=2 -uroot -p123456  -A -S /tmp/mysql3306.sock</code></pre><p><strong>104 導入數據</strong></p><blockquote><p><br></p></blockquote><pre><code>mysql -S /tmp/mysql3306.sock -uroot -p123456 &lt; /tmp/1203.sql</code></pre><p><strong>change 104 到103</strong></p><blockquote><p><br></p></blockquote><pre><code>change master to master_host='192.168.56.103', master_user='repl', master_password='repl4slave', master_port=3306, MASTER_LOG_FILE='mysql-bin.000001', MASTER_LOG_POS=4138, master_connect_retry=10;</code></pre><p><strong>101 插入測試數據</strong></p><blockquote><p><br></p></blockquote><pre><code>insert into t2 values (200);</code></pre><p><strong>101 持續insert</strong></p><blockquote><p><br></p></blockquote><pre><code>for ((i=1;i&lt;=1000000;i++))domysql -S /tmp/mysql3306.sock -uroot -p123456 -e "insert into enmo.t2 values($i)"done</code></pre><p><strong>關閉103 主機，並檢查104 slave 狀態</strong></p><div class=pgc-img><img alt="MySQL 傳統複製中常見故障處理和結構優化案例分析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3514db9272cd4991a8fa7ee8f8a8489e><p class=pgc-img-caption></p></div><p><strong>主從的binlog 都會記錄主庫的server id 和timestamp信息。可以根據這2個信息去定位相應的pos信息。</strong></p><p>101:3306</p><div class=pgc-img><img alt="MySQL 傳統複製中常見故障處理和結構優化案例分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5f30419856304f4594264aea3afe40db><p class=pgc-img-caption></p></div><p>104:3306</p><div class=pgc-img><img alt="MySQL 傳統複製中常見故障處理和結構優化案例分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fba122e6b2644ababfa4b6b215145ded><p class=pgc-img-caption></p></div><p>這裡可以看到101 結束 insert 1419後，並commit的 pos 是387204，所以104 change 的pos 可以選擇到387204這裡。但是如果104沒有把1419 這條記錄commit的話，就要選擇101 開始 insert 1419 這個事務之間的pos：387020.</p><p><strong>104 change 到101</strong></p><blockquote><p><br></p></blockquote><pre><code>change master to master_host='192.168.56.103', master_user='repl', master_password='repl4slave', master_port=3306,  MASTER_LOG_FILE='mysql-bin.000093', MASTER_LOG_POS=387204, master_connect_retry=10;</code></pre><p>作者介紹</p><p>張燦 雲和恩墨技術顧問</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>MySQL</a></li><li><a>傳統</a></li><li><a>處理</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html alt="MySQL 事務處理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html title="MySQL 事務處理">MySQL 事務處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/efc2a519.html alt=你知道MySQL的事務處理和隔離級別嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/efc2a519.html title=你知道MySQL的事務處理和隔離級別嗎？>你知道MySQL的事務處理和隔離級別嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/17a36096.html alt=傳統廣播與數字廣播的區別 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e39a9b4cac0347d8829c87ee93f86af4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/17a36096.html title=傳統廣播與數字廣播的區別>傳統廣播與數字廣播的區別</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/903f1434.html alt=能力提升培訓第一場——傳統計算機視覺方法分析圖像 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/941f6c2fe7be4498b2d596bcac598104 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/903f1434.html title=能力提升培訓第一場——傳統計算機視覺方法分析圖像>能力提升培訓第一場——傳統計算機視覺方法分析圖像</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/10c7d8fd.html alt=神州泰嶽：公司在自然語言處理領域的基礎技術研究和應用落地均走在行業前列 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/10c7d8fd.html title=神州泰嶽：公司在自然語言處理領域的基礎技術研究和應用落地均走在行業前列>神州泰嶽：公司在自然語言處理領域的基礎技術研究和應用落地均走在行業前列</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c9091681.html alt="MySQL 學習筆記" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c9091681.html title="MySQL 學習筆記">MySQL 學習筆記</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html alt=MySQL——事務(Transaction)詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/29d4c92c9c2344838eb72ef948cf08fa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html title=MySQL——事務(Transaction)詳解>MySQL——事務(Transaction)詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a79ba4c0.html alt=MySQL事務隔離級別 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/2d4e804a44534da997212c94ea61e90c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a79ba4c0.html title=MySQL事務隔離級別>MySQL事務隔離級別</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html alt=MySQL數據庫的事務管理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/152203544367254a708f807 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html title=MySQL數據庫的事務管理>MySQL數據庫的事務管理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/011d2da0.html alt=MySql併發與事務的處理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/f13d8a1e-5e60-4b48-90bc-3c26e312a208 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/011d2da0.html title=MySql併發與事務的處理>MySql併發與事務的處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2d12804e.html alt=[玩轉MySQL之九]MySQL實現ACID之原子性 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/bdb044d821f74107a3fd9119fc34c642 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2d12804e.html title=[玩轉MySQL之九]MySQL實現ACID之原子性>[玩轉MySQL之九]MySQL實現ACID之原子性</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/156d2a92.html alt="圖解MySQL | 「原理解析」 MySQL組提交(group commit)" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e5444e9094614d6b88bd3fc8ac0524fb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/156d2a92.html title="圖解MySQL | 「原理解析」 MySQL組提交(group commit)">圖解MySQL | 「原理解析」 MySQL組提交(group commit)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7d322f7b.html alt=MySQL系列-第14篇：事務詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a5b520dd476345e2b3aac97a8fcb77d5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7d322f7b.html title=MySQL系列-第14篇：事務詳解>MySQL系列-第14篇：事務詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d95e4e3f.html alt=MySQL進階之InnoDB事務原子性實現原理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/e1d208ac-c0ed-4238-bce5-e4b3760228c3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d95e4e3f.html title=MySQL進階之InnoDB事務原子性實現原理>MySQL進階之InnoDB事務原子性實現原理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d3c48fcc.html alt=Spring聲明式事務處理的實現原理，來自面試官的窮追拷問 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d3c48fcc.html title=Spring聲明式事務處理的實現原理，來自面試官的窮追拷問>Spring聲明式事務處理的實現原理，來自面試官的窮追拷問</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>