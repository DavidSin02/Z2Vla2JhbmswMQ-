<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>MongoDB雲上災備：如何快速複製阿里異地災備、多活架構 | 极客快訊</title><meta property="og:title" content="MongoDB雲上災備：如何快速複製阿里異地災備、多活架構 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/15348464211881fc66bb425"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8ab616ca.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ab616ca.html><meta property="article:published_time" content="2020-10-29T21:09:57+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:57+08:00"><meta name=Keywords content><meta name=description content="MongoDB雲上災備：如何快速複製阿里異地災備、多活架構"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/8ab616ca.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>MongoDB雲上災備：如何快速複製阿里異地災備、多活架構</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>摘要</strong>： MongoDB雲上災備BLS產品正式發佈</p><h1>1. 背景</h1><p>當前的數據庫系統生態中，大部分系統都支持多個節點實例間的數據同步機制 ，如Mysql Master/Slave主從同步，Redis AOF主從同步等，MongoDB更是支持3節點(及以上)ReplicaSet同步，上述機制很好的支撐了一個邏輯單元的數據冗餘及HA。</p><p>跨邏輯單元(3節點實例、主從實例)，甚至跨單元、跨數據中心的數據同步，在業務層有時候就顯得很重要，可以支持同城多機房的負載均衡，多機房的互備，甚至是異地多數據中心容災(比如 光纖被挖斷、地震等小概率事件)和多活。</p><p>基於以上背景，雲數據庫MongoDB版本正式推出MongoDB實例間的雙向同步產品<strong>“MongoDB雲上災備”</strong>（也稱BLS），助力企業快速複製阿里巴巴異地災備、多活架構。</p><p>產品地址</p><h1>2. 產品介紹</h1><p>“MongoDB雲上災備”通過從源數據庫拉取Oplog（Operations Log）數據（其是MongoDB的日誌，所有對數據庫的修改操作都會保存到oplog中），然後將其傳輸到目的數據庫進行回放實現複製的目的。我們通過構造兩條複製鏈路實現雙向同步的功能，基於此，可以實現災備和多活的功能。</p><div class=pgc-img><img alt=MongoDB雲上災備：如何快速複製阿里異地災備、多活架構 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/15348464211881fc66bb425><p class=pgc-img-caption></p></div><p>上圖給出了整體複製同步的流程。目前，“MongoDB雲上災備”支持的源、目的數據庫類型為ReplicaSet副本集，Sharding模式即將上線，不支持單節點模式。為了減緩主節點的壓力，系統從備（Secondary）上拉取Oplog。</p><p><strong>全量加增量</strong></p><p>同步模型採用全量+增量的方式：在創建時會對源數據庫進行全量同步，後續的修改通過增量來同步。</p><p><strong>雙活以及多活模型</strong></p><p>由於複製是異步模式，所以對於雙活/多活模式，由用戶保證不會對同一個唯一鍵同時修改，因為同時修改將可能導致數據錯亂。目前衝突策略可以為覆蓋或者忽略。後續將會上線校驗程序，在用戶操作相同唯一鍵時提供接口報錯。</p><p><strong>高效性保證</strong></p><p>同步延遲因地域和網絡不同而不同，理論TPS能夠接近20萬（每秒傳輸20萬條oplog）。為了保證批量傳輸的高效性，數據發送存在緩存機制，所以少量數據的同步時延可能超過5秒。</p><ul><li>源數據庫並行拉取，解決衝突依賴</li><li>並行發往Kafka通道</li><li>目的端在解決依賴的同時並行寫入數據庫</li></ul><p><strong>環形複製</strong></p><p>為了防止環形複製（數據從源複製到目的，又從目的複製到源），在Oplog日誌中打入gid解決該問題。</p><p><strong>可靠性傳輸</strong></p><p>支持斷點續傳，實例重啟時數據同步不受影響。</p><p><strong>高可用</strong></p><p>鏈路同步具有高可用性，如果同步進程掛掉，會有備進程啟動接管服務。</p><p><strong>限制說明</strong></p><ul><li>DDL語句同步暫未開放，所以如果修改了源、目的數據的索引操作，無法同步。</li><li>目的數據庫需要創建，暫不支持在2個已有MongoDB實例之間直接搭通道。</li><li>當前只支持雙活功能(2個MongoDB實例之間同步數據)，後續會上線多活功能(多個MongoDB實例之間同步數據)。</li></ul><h1>3. 架構</h1><p>在“MongoDB雲上災備”產品中，主要有3大組件：</p><ul><li>BLS Manager。中心控制模塊，負責Collector、Receiver的調度、監控等任務。</li><li>BLS Collector。數據採集模塊，負責從源MongoDB數據庫拉取Oplog數據後發送到Kafka通道。</li><li>BLS Receiver。數據回放模塊，負責從Kafka通道中獲取數據，然後寫入目的MongoDB數據庫。</li></ul><p>下圖展示了系統的整體架構圖。</p><div class=pgc-img><img alt=MongoDB雲上災備：如何快速複製阿里異地災備、多活架構 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15348464210819d8c6a0a82><p class=pgc-img-caption></p></div><h1>4. 用戶使用案例</h1><p>高德地圖 App是國內首屈一指的地圖及導航應用，阿里雲MongoDB數據庫服務為該應用提供了部分功能的存儲支撐，存儲億級別數據。現在高德使用國內三中心的策略，通過地理位置等信息路由最近中心提升服務質量，業務方(高德地圖)通過用戶路由到三個城市數據中心，如下圖所示，機房數據之間無依賴計算。數據在不同中心的同步通過“MongoDB雲上災備”產品實現。</p><div class=pgc-img><img alt=MongoDB雲上災備：如何快速複製阿里異地災備、多活架構 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1534846421211c37b37fe43><p class=pgc-img-caption></p></div><p>這三個城市地理上從北到南橫跨了整個中國 ，這對多數據中心如何做好複製、容災提出了挑戰，如果某個地域的機房、網絡出現問題，可以平滑的將流量切換到另一個地方，做到用戶幾乎無感知？</p><p>目前策略是，拓撲採用機房兩兩互聯方式，每個機房的數據都通過“MongoDB雲上災備”異步地將數據同步到另外兩個機房。然後通過高德的路由層，將用戶請求路由到不同的數據中心，讀寫均發送在同一個數據中心，保證一定的事務性。這樣保證每個數據中心都有全量的數據(保證最終一致性) 。任意機房出現問題，另兩個機房中的一個可以通過切換後提供讀寫服務。下圖展示了城市1和城市2機房的同步情況。</p><div class=pgc-img><img alt=MongoDB雲上災備：如何快速複製阿里異地災備、多活架構 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1534846421235b94088083e><p class=pgc-img-caption></p></div><p>遇到某個單元不能訪問的問題，Manager通過“MongoDB雲上災備”產品管理接口，可以獲得各個機房的同步偏移量和時間戳，通過判斷採集和寫入值即可判斷異步複製是否在某個時間點已經完成。再配合業務方的DNS切流，切走單元流量並保證原有單元的請求在新單元是可以讀寫的，如下圖所示。</p><div class=pgc-img><img alt=MongoDB雲上災備：如何快速複製阿里異地災備、多活架構 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1534846421292b086787c35><p class=pgc-img-caption></p></div><p>作者：燭昭</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>災備</a></li><li><a>MongoDB</a></li><li><a>雲上</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/e7684666.html alt=從容災備份延展到數據管理，「英方軟件」為客戶提供統一數據管理方案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e7684666.html title=從容災備份延展到數據管理，「英方軟件」為客戶提供統一數據管理方案>從容災備份延展到數據管理，「英方軟件」為客戶提供統一數據管理方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/29ea126b.html alt="從 MongoDB 遷移到 ES 後，我們減少了 80% 的服務器" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/89ca6a3d677846ed9d8dcdd86c766efb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/29ea126b.html title="從 MongoDB 遷移到 ES 後，我們減少了 80% 的服務器">從 MongoDB 遷移到 ES 後，我們減少了 80% 的服務器</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4ae016c3.html alt=為什麼要從MongoDB遷移到ElasticSearch？這篇告訴你原委！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6b631728e9ef44db999639d7b09c1f30 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4ae016c3.html title=為什麼要從MongoDB遷移到ElasticSearch？這篇告訴你原委！>為什麼要從MongoDB遷移到ElasticSearch？這篇告訴你原委！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/24e186e8.html alt=“雲上”一德，開啟軟管盛宴 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e6707050412c423b9f81b4342602bdac style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/24e186e8.html title=“雲上”一德，開啟軟管盛宴>“雲上”一德，開啟軟管盛宴</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/47bfc994.html alt=古言《雲上青梅》：一個青梅竹馬，相攜白頭的故事 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/82d8990960764c239a2370bdba526fb2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/47bfc994.html title=古言《雲上青梅》：一個青梅竹馬，相攜白頭的故事>古言《雲上青梅》：一個青梅竹馬，相攜白頭的故事</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/51f834f3.html alt=新文/《錯撩》《雲上青梅》《痴纏》 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3212557e77b04a868ed2e960c8f960ff style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/51f834f3.html title=新文/《錯撩》《雲上青梅》《痴纏》>新文/《錯撩》《雲上青梅》《痴纏》</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/1529c87f.html alt="走進浙江麗水平田村 感受雲上的靜謐時光" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/baace492958144308c09155282e325e0 style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/1529c87f.html title="走進浙江麗水平田村 感受雲上的靜謐時光">走進浙江麗水平田村 感受雲上的靜謐時光</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/aed5f4c.html alt=北航20餘萬校友“雲上歸航”為母校慶生 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/SELVPsk3lDaag4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/aed5f4c.html title=北航20餘萬校友“雲上歸航”為母校慶生>北航20餘萬校友“雲上歸航”為母校慶生</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/da07b6b.html alt=“1+5”模式開啟“雲上”銀杏節，泰興市委書記用銀杏故事詮釋特色產業發展 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/SEFWi1i9sSWhAZ style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/da07b6b.html title=“1+5”模式開啟“雲上”銀杏節，泰興市委書記用銀杏故事詮釋特色產業發展>“1+5”模式開啟“雲上”銀杏節，泰興市委書記用銀杏故事詮釋特色產業發展</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/20b9be5.html alt=MongoDB的學習，配置文件詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ed9147df6e6d4da59bc0ae7bedb89737 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/20b9be5.html title=MongoDB的學習，配置文件詳解>MongoDB的學習，配置文件詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/3c0ea7a.html alt=疫情陰雲之下，另闢「雲上」蹊徑。 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/pgc-image/a43d88e447b646c89eb095f652d5ac0f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/3c0ea7a.html title=疫情陰雲之下，另闢「雲上」蹊徑。>疫情陰雲之下，另闢「雲上」蹊徑。</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/e74ea92.html alt="認識 MongoDB 4.0 的新特性——事務（Transactions）" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/e74ea92.html title="認識 MongoDB 4.0 的新特性——事務（Transactions）">認識 MongoDB 4.0 的新特性——事務（Transactions）</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>