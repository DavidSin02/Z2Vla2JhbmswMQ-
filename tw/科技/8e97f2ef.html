<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>linux系統編程—深入理解線程安全和可重入函數 | 极客快訊</title><meta property="og:title" content="linux系統編程—深入理解線程安全和可重入函數 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/1ee6cfb4a26146468f84f34dc34ebbdf"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8e97f2ef.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8e97f2ef.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8e97f2ef.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8e97f2ef.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8e97f2ef.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8e97f2ef.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8e97f2ef.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8e97f2ef.html><meta property="article:published_time" content="2020-11-14T20:55:06+08:00"><meta property="article:modified_time" content="2020-11-14T20:55:06+08:00"><meta name=Keywords content><meta name=description content="linux系統編程—深入理解線程安全和可重入函數"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/8e97f2ef.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>linux系統編程—深入理解線程安全和可重入函數</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>線程安全</h1><p><strong>基本定義</strong></p><p>線程安全：簡單來說線程安全就是多個線程併發同一段代碼時，不會出現不同的結果，我們就可以說該線程是安全的；</p><p>線程不安全：說完了線程安全，線程不安全的問題就很好解釋，如果多線程併發執行時會產生不同的結果，則該線程就是不安全的。</p><p>線程安全產生的原因：大多是因為對全局變量和靜態變量的操作</p><p><strong>常見的線程不安全的函數</strong></p><p>(1)不保護共享變量的函數</p><p>(2)函數狀態隨著被調用，狀態發生變化的函數</p><p>(3)返回指向靜態變量指針的函數</p><p>(4)調用線程不安全函數的函數</p><p><strong>常見的線程安全的情況</strong></p><p>(1)每個線程對全局變量或者靜態變量只有讀取的權限，而沒有寫入的權限，一般來說這些線程是安全的；</p><p>(2)類或者接口對於線程來說都是原子操作；</p><p>(3)多個線程之間的切換不會導致該接口的執行結果存在二義性；</p><p><strong>代碼演示</strong></p><pre><code>#include&lt;stdio.h&gt;#include&lt;pthread.h&gt; int value=0; void* func(void* arg){        int i=0;        while(i&lt;10000){                int tmp=value;                value=i;                printf("value is %d\n",value);                value=tmp+1;                i++;        }}int main(){        pthread_t id1,id2;        pthread_create(&amp;id1,NULL,func,NULL);        pthread_create(&amp;id2,NULL,func,NULL);        pthread_join(id1,NULL);        pthread_join(id2,NULL);        printf("value is %d\n",value);        return 0;}</code></pre><p>運行結果（可見在存在線程安全時得到的結果並不是我們所期待的）：</p><div class=pgc-img><img alt=linux系統編程—深入理解線程安全和可重入函數 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1ee6cfb4a26146468f84f34dc34ebbdf><p class=pgc-img-caption></p></div><p><strong>需要C/C++ Linux服務器架構師學習資料私信“資料”（資料包括C/C++，Linux，golang技術，Nginx，ZeroMQ，MySQL，Redis，fastdfs，MongoDB，ZK，流媒體，CDN，P2P，K8S，Docker，TCP/IP，協程，DPDK，ffmpeg等），免費分享</strong></p><div class=pgc-img><img alt=linux系統編程—深入理解線程安全和可重入函數 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ea69518185f64d5cb9f7f00c9a3588ef><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>可重入函數</h1><p><strong>基本定義</strong></p><p>重入：同一個函數被不同的執行流調用，當前一個流程還沒有執行完，就有其他的進程已經再次調用（執行流之間的相互嵌套執行）；</p><p>可重入：多個執行流反覆執行一個代碼，其結果不會發生改變，通常訪問的都是各自的私有棧資源；</p><p>不可重入：多個執行流反覆執行一段代碼時，其結果會發生改變；</p><p>可重入函數：當一個執行流因為異常或者被內核切換而中斷正在執行的函數而轉為另外一個執行流時，當後者的執行流對同一個函數的操作並不影響前一個執行流恢復後執行函數產生的結果；</p><p>不可重入函數：當程序運行到某一個函數的時候，可能因為硬件中斷或者異常而使得在用戶正在執行的代碼暫時終端轉而進入你內核，這個時候如有一個信號需要被處理，而處理的這個信號的時候又會重新調用剛才中斷的函數，如果函數內部有一個全局變量需要被操作，那麼，當信號處理完成之後重新返回用戶態恢復中斷函數的上下文再次繼續執行的時候，對同一個全局變量的操作結果可能就會發生改變而並不如我們預期的那樣，這樣的函數被稱為不可重入函數。例如在進行鏈表的插入時，插入函數訪問一個全局鏈表,有可能因為重入而造成錯亂。</p><p><strong>可重入函數滿足條件</strong></p><p>(1)不使用全局變量或靜態變量；</p><p>(2)不使用用malloc或者new開闢出的空間；</p><p>(3)不調用不可重入函數；</p><p>(4)不返回靜態或全局數據，所有數據都有函數的調用者提供；</p><p>(5)使用本地數據，或者通過製作全局數據的本地拷貝來保護全局數據；</p><p><strong>不可重入函數符合以下條件之一</strong></p><p>(1)調用了malloc/free函數，因為malloc函數是用全局鏈表來管理堆的。</p><p>(2)調用了標準I/O庫函數，標準I/O庫的很多實現都以不可重入的方式使用全局數據結構。</p><p>(3)可重入體內使用了靜態的數據結構。</p><p><strong>可重入函數分類</strong></p><p>(1)顯式可重入函數</p><p>如果所有函數的參數都是傳值傳遞的（沒有指針），並且所有的數據引用都是本地的自動棧變量（也就是說沒有引用靜態或全局變量），那麼函數就是顯示可重入的，也就是說不管如何調用，我們都可斷言它是可重入的。</p><p>(2)隱式可重入函數</p><p>可重入函數中的一些參數是引用傳遞（使用了指針），也就是說，在調用線程小心地傳遞指向非共享數據的指針時，它才是可重入的。</p><p>可重入函數可以有多餘一個任務併發使用，而不必擔心數據錯誤，相反，不可重入函數不能由超過一個任務所共享，除非能確保函數的互斥（或者使用信號量，或者在 代碼的關鍵部分禁用中斷）。可重入函數可以在任意時刻被中斷，稍後再繼續運行，不會丟失數據，可重入函數要麼使用本地變量，要麼在使用全局變量時保護自己 的數據。</p><p><strong>代碼演示：</strong></p><pre><code>#include&lt;stdio.h&gt;#include&lt;signal.h&gt; int value=0; void fun(){        int i=0;        while(i++&lt;5){                value++;                printf("value is %d\n",value);                sleep(1);        }}int main(){        signal(2,fun);        fun();        printf("the value is %d\n",value);        return 0;}</code></pre><p>運行結果對比：</p><div class=pgc-img><img alt=linux系統編程—深入理解線程安全和可重入函數 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/718f05f38b7342d2b3151cd9c95e6caa><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right>可重入函數與線程安全的區別與聯繫</h1><p><strong>聯繫：</strong></p><p>函數可以是可重入的，是線程安全的，或者二者皆是，或者二者皆非。不可重入的函數不能由多個線程使用。另外，或許不可能讓某個不可重入的函數是線程安全的。</p><p><strong>區別：</strong></p><p>(1)可重入函數是線程安全函數的一種，其特點在於它們被多個線程調用時，不會引用任何共享數據。</p><p>(2)線程安全是在多個線程情況下引發的，而可重入函數可以在只有一個線程的情況下來說。</p><p>(3)線程安全不一定是可重入的，而可重入函數則一定是線程安全的。</p><p>(4)如果一個函數中有全局變量，那麼這個函數既不是線程安全也不是可重入的。</p><p>(5)如果將對臨界資源的訪問加上鎖，則這個函數是線程安全的，但如果這個重入函數若鎖還未釋放則會產生死鎖，因此是不可重入的。</p><p>(6)線程安全函數能夠使不同的線程訪問同一塊地址空間，而可重入函數要求不同的執行流對數據的操作互不影響使結果是相同的。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>linux</a></li><li><a>系統</a></li><li><a>編程</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E5%AD%B8/b9996341.html alt=linux系統編程之文件的內核結構file和dup實現重定向 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/2083db3dd90d4239bc06386a79bc693c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/b9996341.html title=linux系統編程之文件的內核結構file和dup實現重定向>linux系統編程之文件的內核結構file和dup實現重定向</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b7ca5569.html alt=linux系統中如何添加路由 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b7ca5569.html title=linux系統中如何添加路由>linux系統中如何添加路由</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/15e31bc6.html alt=linux文件系統詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ca9c61bb58f74db5bb05d2067cd581b4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/15e31bc6.html title=linux文件系統詳解>linux文件系統詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/01ef527c.html alt=詳解linux系統架構--文件系統體系 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/13183b27d114479589173ced128508b4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/01ef527c.html title=詳解linux系統架構--文件系統體系>詳解linux系統架構--文件系統體系</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6d04923f.html alt=「分享」可編程控制器控制系統設計的基本步驟，你還知道哪些？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/49ce3ce367f44139b7385596fc0df095 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6d04923f.html title=「分享」可編程控制器控制系統設計的基本步驟，你還知道哪些？>「分享」可編程控制器控制系統設計的基本步驟，你還知道哪些？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/09027003.html alt="一 linux操作系統複習筆記" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/66b900045bf5657b4d3a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/09027003.html title="一 linux操作系統複習筆記">一 linux操作系統複習筆記</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a96a3a1.html alt=嵌入式linux網絡編程—學TCPIP網絡的看過來，終於有人講清楚了 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a9f8dacb3f5c4b27becd312c01203d69 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a96a3a1.html title=嵌入式linux網絡編程—學TCPIP網絡的看過來，終於有人講清楚了>嵌入式linux網絡編程—學TCPIP網絡的看過來，終於有人講清楚了</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d351083.html alt=linux系統中socket錯誤碼：eintr和eagain的處理方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/f47eacd32fb946aa903e72921d4458a4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d351083.html title=linux系統中socket錯誤碼：eintr和eagain的處理方法>linux系統中socket錯誤碼：eintr和eagain的處理方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6ec57e2.html alt=可編程控制系統設計的七個步驟 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6ec57e2.html title=可編程控制系統設計的七個步驟>可編程控制系統設計的七個步驟</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c1f4dc9.html alt="二 linux操作系統複習筆記" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/66bc00032a43fdf87a92 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c1f4dc9.html title="二 linux操作系統複習筆記">二 linux操作系統複習筆記</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/732d199.html alt=嵌入式Linux系統編程——linux大神深度給你講解進程、調度、信號 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/88364fad7d5246c191ed1444d983d186 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/732d199.html title=嵌入式Linux系統編程——linux大神深度給你講解進程、調度、信號>嵌入式Linux系統編程——linux大神深度給你講解進程、調度、信號</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6049529.html alt=嵌入式linux網絡編程——你所不知道的計算機網絡系統，精品講解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/23be2c97fd8344c9aef5fb19168425ef style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6049529.html title=嵌入式linux網絡編程——你所不知道的計算機網絡系統，精品講解>嵌入式linux網絡編程——你所不知道的計算機網絡系統，精品講解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6d6cb3b.html alt=自動化搭建微型linux系統ftp服務器 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/19488a5f7b8446ab94cedd3303c0f7d4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6d6cb3b.html title=自動化搭建微型linux系統ftp服務器>自動化搭建微型linux系統ftp服務器</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/031eafc4.html alt=電廠直流系統調試方案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/5e8200036f19e04c25bf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/031eafc4.html title=電廠直流系統調試方案>電廠直流系統調試方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fc3b4b2c.html alt=一文讀懂智能客服：發展歷程、系統搭建、市場推廣 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RbYMTZ55OrJUgU style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fc3b4b2c.html title=一文讀懂智能客服：發展歷程、系統搭建、市場推廣>一文讀懂智能客服：發展歷程、系統搭建、市場推廣</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>