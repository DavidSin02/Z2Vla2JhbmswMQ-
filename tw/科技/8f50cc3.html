<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ | 极客快訊</title><meta property="og:title" content="什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/d74ba10746e84e349114035c45f32c13"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8f50cc3.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8f50cc3.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8f50cc3.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8f50cc3.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8f50cc3.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8f50cc3.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8f50cc3.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8f50cc3.html><meta property="article:published_time" content="2020-10-29T20:52:47+08:00"><meta property="article:modified_time" content="2020-10-29T20:52:47+08:00"><meta name=Keywords content><meta name=description content="什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/8f50cc3.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>2017 年年初，我所在的公司開始對整個業務系統進行重構和微服務化，替換掉因業務發展而不堪重負的、運行了 10 年的龐大的單體應用。我有幸作為小組技術負責人，負責部分業務的微服務架構的設計和開發工作。</p><p>隨著微服務遷移工作的深入，服務化過程中遇到的問題越來越多，痛點也越加明顯。當我們的業務被拆分成若干個服務時，不可避免地要進行服務之間的交互，很多時候需要多個服務共同協作才能完成一個完整的業務流程。在這種情況下，服務間的通信問題也暴露得更加明顯。我開始思考如何實現分佈式系統的彈性設計，以及解決容錯、監控等問題。</p><p>我偶然通過閱讀“What's a service mesh? And why do I need one?”這篇文章接觸到服務網格概念，並瞭解到它是解決微服務通信問題的好幫手。與此同時，Istio 也發佈了 1.0 版本。<strong>在仔細瞭解了 Istio 的整體技術架構後，我深深地被這種優雅的設計所折服，各組件職責清晰、鬆散耦合，數據平面可替換，Mixer 的適配器模式又提供了強大的可擴展性。</strong>加之 Google、IBM 和 Lyft 的支持，我預感 Istio 會和 Kubernetes一樣，成為又一個明星級的產品。</p><p>服務網格是一個新穎的概念，Istio 作為它的一個實現產品，誕生也不到兩年的時間，網絡上很難找到相關的學習資源，主要的學習資料就是 Istio 官方提供的文檔。這份文檔雖然十分詳盡地介紹了 Istio 的方方面面，但語言較為晦澀，內容組織也不適合初學者。今天這本《Istio實戰指南》恰好滿足了初學者的需求。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d74ba10746e84e349114035c45f32c13><p class=pgc-img-caption>https://item.jd.com/12682850.html</p></div><p class=ql-align-center><br></p><p class=ql-align-justify><br></p><h1 class=ql-align-justify>01 <strong>什麼是服務網格</strong></h1><p>什麼是服務網格？簡單來說，就是在微服務架構下管理服務間網絡通信的基礎設施。為了讓大家更容易理解，我們用現實中的社交網絡來進行類比。</p><p>把時間退回到現代科技出現之前。那時候人和人之間如果需要溝通和交流，可能就只能親自登門拜訪了，以面對面的方式建立聯繫。後來出現了書信，這是通訊的一大進步，至少為了說幾句話，我不用親自跑一趟了。但書信的時效性還是太低，於是就出現了電話。這下溝通的時效性問題也解決了，只要有電話網絡覆蓋的地方，隨時都可以通過電話進行交流。但是電話仍然有侷限性，就是它只能是點對點的溝通，如果我想和三五個好友一起聊天，就沒法實現了。最終，社交網絡的出現解決了這個問題。</p><p>無論是以前IM工具的群組功能，還是Facebook、人人網這樣的SNS網站，再到現在的朋友圈，都可以認為是不同形態的社交網絡。我們可以隨時隨地不受限制的和聯繫人進行一對一、多對多的溝通。那麼社交網絡和服務網格有哪些相似性呢？</p><p>首先，社交網絡中出現的主體是聯繫人，這就好像服務網格中的主體是一個個的微服務。聯繫人之間是通過註冊在社交網絡的賬號進行交互的，包括消息的發送和接收。這個賬號的載體可以是電腦或者手機。這就好像網格里的Sidecar代理，服務間的通信都由它們完成。它們就像是微服務的賬號和手機一樣，負責與不同的聯繫人（微服務）進行溝通。</p><p>如果說服務網格是Sidecar代理組成的網絡拓撲，那麼人際關係就是社交網絡的拓撲。最後，社交網絡的最終效果是使得人與人之間無阻礙的溝通，使人和地域、時間解耦；類似的，服務網格最終的目的是使得微服務（即業務）和網絡通信功能解耦。</p><p>相信現在你已經大致瞭解了服務網格的基本概念，本質上它將網絡通信下沉到基礎設施層，讓微服務只需要關注業務本身；就好像社交網絡將人際關係的網絡拓撲抽取出來，你只需要關注溝通的內容本身，而不需要關心溝通的方式。</p><p class=ql-align-justify><br></p><h1 class=ql-align-justify>02 <strong>什麼是Istio</strong></h1><p>作為服務網格的實現產品，Istio一經推出就備受矚目，成為各大廠商和開發者爭相追逐的“香饃饃”。我個人認為Istio會成為繼Kubernetes之後的又一個明星級產品。Istio的官方網站這樣定義自己。</p><p>它是一個完全開源的服務網格，以透明層的方式構建在現有分佈式應用中。它也是一個提供了各種API的平臺，可以與任何日誌平臺、監控系統或策略系統集成。Istio的多樣化特性可以讓你高效地運行分佈式微服務架構，並提供一種統一的方式來保護、連接和監控微服務。</p><p>從上面的定義中可以瞭解到，Istio為微服務應用提供了一個完整的解決方案，可以以統一的方式去檢測和管理微服務。同時，它還提供了管理流量、實施訪問策略、收集數據等功能，而所有這些功能都對業務代碼透明，即不需要修改業務代碼就能實現。</p><p>有了Istio，就幾乎可以不需要其他的微服務框架，也不需要自己去實現服務治理等功能，只要把網絡層委託給Istio，它就能幫助完成這一系列的功能。簡單來說，Istio就是一個提供了服務治理能力的服務網格。</p><p class=ql-align-justify><br></p><h1 class=ql-align-justify>03 <strong>Istio的架構</strong></h1><p>對服務網格來講，業務代碼無侵入和網絡層的全權代理是其重要的優勢。我們來了解一下Istio的架構，看一看它是如何做到這兩點的，並瞭解架構中的各個組件是如何協同工作並完成網絡層功能的。</p><p>Istio的架構從邏輯上分成數據平面（Data Plane）和控制平面（Control Plane）。是否覺得似曾相識？沒錯，Kubernetes的架構也具有相似的結構，分為控制節點和計算節點。毫無疑問，這樣的設計可以很好地解耦各個功能組件。</p><ul><li class=ql-align-justify><strong>數據平面：</strong>由一組和業務服務成對出現的Sidecar代理（Envoy）構成，它的主要功能是接管服務的進出流量，傳遞並控制服務和Mixer組件的所有網絡通信（Mixer是一個策略和遙測數據的收集器，稍後會介紹）。</li><li class=ql-align-justify><strong>控制平面：</strong>主要包括了Pilot、Mixer、Citadel和Galley共4個組件，主要功能是通過配置和管理Sidecar代理來進行流量控制，並配置Mixer去執行策略和收集遙測數據（Telemetry）。</li></ul><p>圖1展示了由這些組件組成的Istio架構。</p><p>從Istio的架構中可以看出，Istio追求儘可能的透明，通過各種解耦設計讓系統對內對外都沒有依賴。同時，它還提供了高度的擴展性。Istio認為隨著應用的增長和服務的增多，擴展策略系統是最主要的需求，因此它被設計為以增量的方式進行擴展。可移植也是Istio在設計中充分考慮的因素，它被設計為支持多種平臺，以便服務可以被方便地遷移到不同的雲環境中（在撰寫本書的過程中，Istio仍然深度依賴於Kubernetes平臺）。</p><p>通過數據平面和控制平面的分離，各個組件都成為插件，這種開放和包容的設計思路相當具有前瞻性，我想這也就是其他服務網格產品都放棄了和它競爭而選擇合作的重要原因。</p><p>下面對架構中的各組件做進一步介紹。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/956362294e73480d82209da7edb3fe54><p class=pgc-img-caption>圖1　Istio架構</p></div><p class=ql-align-justify><br></p><h1 class=ql-align-justify>04 <strong>Istio的核心控件</strong></h1><p class=ql-align-justify><br></p><p class=ql-align-justify><strong>4.1 Envoy</strong></p><p>從架構圖可以看出，Istio的數據平面就是指代理。Istio選擇Envoy作為Sidecar代理，Envoy本質上是一個為面向服務的架構而設計的7層代理和通信總線。Envoy基於C++11開發而成，性能出色。除了具有強大的網絡控制能力外，Envoy還可以將流量行為和數據提取出來發送給Mixer組件，用以進行監控。</p><p>Envoy在網絡控制方面的主要功能如下。</p><ul><li class=ql-align-justify>HTTP 7層路由。</li><li class=ql-align-justify>支持gRPC、HTTP/2。</li><li class=ql-align-justify>服務發現和動態配置。</li><li class=ql-align-justify>健康檢查。</li><li class=ql-align-justify>高級負載均衡。</li></ul><p>我們知道，在Kubernetes環境中，同一個Pod內的不同容器間共享網絡棧，這一特性使得Sidecar可以接管進出這些容器的網絡流量，這就是Sidecar模式的實現基礎。Envoy是目前Istio默認的數據平面，實際上因為Istio靈活的架構，完全可以選擇其他兼容的產品作為Sidecar。目前很多服務網格產品都可以作為Istio的數據平面並提供集成。</p><p class=ql-align-justify><strong>4.2 Pilot</strong></p><p>Pilot 是Istio實現流量管理的核心組件，它主要的作用是配置和管理Envoy代理。比如可以為代理之間設置特定的流量規則，或者配置超時、重試、熔斷這樣的彈性能力。Pilot會將控制流量行為的路由規則轉換為Envoy的配置，並在運行時將它們廣播到Envoy。另外，Pilot還能夠把服務發現機制抽象出來並轉換成API分發給Envoy，使得後者具有服務發現的能力。</p><p>簡單來說，Pilot的主要任務有兩個。</p><ul><li class=ql-align-justify>從平臺（如Kubernetes）獲取服務信息，完成服務發現。</li><li class=ql-align-justify>獲取Istio的各項配置，轉換成Envoy代理可讀的格式並分發。</li></ul><p>圖2展示了Pilot架構。Pilot維護了一套獨立於平臺的服務規則，並提供了</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6d2cb26987c14c55a63360f943d38fa1><p class=pgc-img-caption>圖2　Pilot架構</p></div><p>一個平臺適配器，以便接入各種不同的平臺。Rules API對運維人員開放，使得他們可以設置想要的流量規則，Pilot會把這些配置好的規則通過Envoy API分發給Envoy代理，以使其執行指定的規則。</p><p>Pilot還公開了用於服務發現並且可以動態更新負載均衡和路由表的API。</p><p class=ql-align-justify><strong>4.3 Mixer</strong></p><p>Mixer的主要功能是提供策略控制，並從Envoy代理收集遙測數據。每次網絡通信時Envoy代理都會向Mixer發出預檢要求，用來檢測調用者的合法性。調用之後Envoy代理會發送遙測數據供Mixer收集。一般情況下Sidecar代理可以緩存這些數據，不需要頻繁地調用Mixer。</p><p>適配器是Mixer的重要組成部分，它本質上是一個插件模型，每個插件叫作適配器。這項特性使得Mixer可以接入幾乎任意的（只要定義好接口）後端基礎設施。比如可以選擇接入不同的日誌收集器、監控工具和授權工具等；可以在運行時切換不同的適配器或者是打開（關閉）它們；還可以自定義適配器以滿足特定需求。適配器極大地提高了Mixer的擴展性，它讓Istio的功能擁有了更多可能性。圖3展示了Mixer的架構圖並展示了它和Envoy的交互方式。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/54a10bc58a9844ea866d17a555c222b5><p class=pgc-img-caption>圖3　Mixer架構</p></div><p class=ql-align-justify><strong>4.4 Citadel</strong></p><p>Citadel是與安全相關的組件，主要負責密鑰和證書的管理。它可以提供服務間和終端用戶的身份認證，還可以加密服務網格中的流量。在後面介紹安全主題的第8章中，我們會詳細說明它是如何和其他組件協同工作的。</p><p class=ql-align-justify><strong>4.5 Galley</strong></p><p>在2019年3月份發佈的1.1版本中，Galley作為一個獨立的組件被添加到了架構當中（在此之前的版本中Galley並未獨立出現），它現在是Istio主要的配置管理組件，負責配置的獲取、處理和分發。Galley使用了一種叫作MCP（Mesh Configuration Protocol，網格配置協議）的協議與其他組件進行通信。</p><p class=ql-align-justify><br></p><h1 class=ql-align-justify>05 <strong>Istio的主要功能</strong></h1><p>下面詳細地介紹一下Istio的4個主要功能和實現原理。</p><p class=ql-align-justify><strong>5.1 流量管理</strong></p><p>第1章介紹過，微服務應用最大的痛點就是處理服務間的通信，而這一問題的核心其實就是流量管理。首先來看一看傳統的微服務應用在沒有服務網格介入的情況下，如何完成諸如金絲雀發佈這樣的動態路由。假設不借助任何現成的第三方框架，一個簡單的實現方法是，在服務間添加一個負載均衡（如Nginx）做代理，通過修改配置的權重來分配流量。這種方式將對流量的管理和基礎設施（雲服務器、虛擬機、實體機等）綁定在了一起，難以維護。</p><p>而使用Istio就可以輕鬆地實現各種維度的流量控制。圖4展示了兩種不同的金絲雀發佈策略。第一種是根據權重把5%的流量路由給新版本；第二種是根據請求的頭信息User-Agent把使用iPhone的用戶流量路由到新版本。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3b31c08d318e4f6c82fbf6391c2ec321><p class=pgc-img-caption>圖4　Istio的流量管理</p></div><p>Istio的流量管理是通過Pilot和Envoy這兩個組件實現的，將流量和基礎設施進行了解耦。Pilot負責配置規則，並把規則分發到Envoy代理去實施；而Envoy按照規則執行各種流量管理的功能，比如動態請求路由，超時、重試和熔斷，還可以通過故障注入來測試服務之間的容錯能力。下面對這些具體的功能進行逐一介紹。</p><p><strong>1．請求路由</strong></p><p>Istio為了控制服務請求，引入了服務版本（Version）的概念，可以通過版本這一標籤將服務進行區分。版本的設置是非常靈活的，可以根據服務的迭代編號進行定義（如v1、v2版本）；也可以根據部署環境進行定義（如Dev、Staging和Production）；或者是自定義任何用於區分服務的標記。通過版本標籤，Istio就可以定義靈活的路由規則以控制流量，上面提到的金絲雀發佈這類應用場景就很容易實現了。</p><p class=ql-align-center>圖5展示了使用服務版本實現路由分配的例子。服務版本定義了版本號（v1.5、v2.0-alpha）和環境（us-prod、us-staging）兩種信息。服務B包含了4個Pod，其中3個是部署在生產環境的v1.5版本，而Pod4是部署在預生產環境的v2.0-alpha版本。運維人員根據服務版本指定路由規則，通過Pilot同步給Envoy代理，使得99%的流量流向v1.5版本的生產環境，而1%的流量進入v2.0-alpha版本的預生產環境。</p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/16fffce2e7d7452cad7e269c3302a2ec><p class=pgc-img-caption>圖5　服務版本控制</p></div><p class=ql-align-justify><strong>2．入口網關（Ingress）和出口網關（Egress）</strong></p><p class=ql-align-center>服務間通信是通過Envoy代理進行的。同樣，我們也可以在整個系統的入口和出口處部署代理，使得所有流入和流出的流量都由代理進行轉發，而這兩個負責入口和出口的代理就叫作入口網關和出口網關。它們相當於整個微服務應用的邊界代理，把守著進入和流出服務網格的流量。圖6展示了Ingress和Egress在請求流中的位置，通過設置Envoy代理，出入服務網格的流量也得到了控制。</p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7241db7d9579441398e88c89f4770c3e><p class=pgc-img-caption>圖6　請求流中的Ingress和Egress</p></div><p class=ql-align-justify><strong>3．服務發現和負載均衡</strong></p><p class=ql-align-center>服務發現的前提條件是具有服務註冊的能力。目前Kubernetes這類容器編排平臺也提供了服務註冊的能力。Istio基於平臺實現服務發現和負載均衡時，需要通過Pilot和Envoy協作完成，如圖7所示。Pilot組件會從平臺獲取服務的註冊信息，並提供服務發現的接口，Envoy獲得這些信息並更新到自己的負載均衡池。Envoy會定期地對池中的實例進行健康檢查，剔除離線的實例，保證服務信息的實時性。</p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6c91d7d7b2de48be9c95b21d99e65621><p class=pgc-img-caption>圖7　服務發現和負載均衡</p></div><p class=ql-align-justify><strong>4．故障處理</strong></p><p>Istio的故障處理都由Envoy代理完成。Envoy提供了一整套現成的故障處理機制，比如超時、重試、限流和熔斷等。這些功能都能夠以規則的形式進行動態配置，並且執行運行時修改。這使得服務具有更好的容錯能力和彈性，並保證服務的穩定性。</p><p class=ql-align-justify><strong>5．故障注入</strong></p><p>簡單來說，故障注入就是在系統中人為地設置一些故障，來測試系統的穩定性和系統恢復的能力。比如為某服務設置一個延遲，使其長時間無響應，然後檢測調用方是否能處理這種超時問題而自身不受影響（如及時終止對故障發生方的調用，避免自己受到影響且使故障擴展）。</p><p>Isito支持注入兩種類型的故障：延遲和中斷。延遲是模擬網絡延遲或服務過載的情況；中斷是模擬上游服務崩潰的情況，表現為HTTP的錯誤碼和TCP連接失敗。</p><p class=ql-align-justify><strong>5.2 策略和遙測</strong></p><p class=ql-align-justify><strong>1．策略</strong></p><p>在微服務應用中，除了流量管理以外，常常還需要進行一些額外的控制，比如限流（對調用頻率、速率進行限制）、設置白名單和黑名單等。</p><p>Istio中的策略控制是依靠Mixer完成的。Envoy代理在每次網絡請求時，都會調用Mixer進行預先檢查，確定是否滿足對應的策略。同時，Mixer又可以根據這些來自流量的數據，進行指標數據的採集和彙總，這就是遙測功能。</p><p class=ql-align-justify><strong>2．遙測（Telemetry）</strong></p><p>遙測是工業上常用的一種技術，它是指從遠程設備中收集數據，並傳輸到接收設備進行監測。在軟件開發中，遙測的含義引申為對各種指標（metric）數據進行收集，並監控、分析這些指標，比如我們經常聽到的BI數據分析。</p><p>Mixer的一大主要功能就是遙測。前面已經說過，Envoy代理會發送數據給Mixer，這就使得Mixer具有了數據收集的能力。在本章對Mixer的介紹中讀者已經瞭解到Mixer的插件模型，也就是適配器。Mixer可以接入不同的後端設施作為適配器，來處理收集到的指標數據，比如日誌分析系統、監控系統等。</p><p class=ql-align-justify><strong>5.3 可視化</strong></p><p>在微服務應用越來越複雜的情況下，對整個系統的狀態進行監控和追蹤變得尤為重要。試想如果一個包含上百個服務的系統發生了故障卻無法準確定位問題的根源，或者系統壓力已經到了承受的臨界值而運維人員卻渾然不知，這是多麼可怕的事情。沒有完備的、可觀察的監控系統就無法保障系統的穩定性。</p><p>Istio可以很方便地和各種監控、追蹤工具集成，以便我們以可視化的方式（網頁）直觀地查看整個系統的運行狀態。比如可以集成Prometheus來進行指標數據的收集，然後將收集的數據放在Grafana監控工具中展示；還可以集成Jaeger作為追蹤系統，幫助我們對請求的調用鏈進行跟蹤，在故障發生時分析出現問題的根源；或者將請求日誌記錄到Kibana系統，以圖表的方式進行數據分析。</p><p>以上提到的這些可視化工具都會在第7章被集成到Istio，並得到詳細的介紹。</p><p class=ql-align-justify><strong>5.4 安全</strong></p><p class=ql-align-center>Istio 中的安全架構是由多個組件協同完成的。Citadel是負責安全的主要組件，用於密鑰和證書的管理；Pilot會將授權策略等信息分發給Envoy代理；Envoy根據策略實現服務間的安全通信；Mixer負責管理授權等工作。圖8展示了Istio的安全架構和運作流程。</p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/57e34c00df484f10aec01a7e63f4ef76><p class=pgc-img-caption>圖8　Istio安全架構</p></div><p class=ql-align-justify><strong>1．認證</strong></p><p>Istio提供如下兩種類型的身份認證。</p><ul><li class=ql-align-justify><strong>傳輸認證：</strong>也叫作服務到服務認證。這種方式的認證是通過雙向TLS（mTLS）來實現的，即客戶端和服務端（或者是調用者和被調用者）都要驗證彼此的合法性。</li><li class=ql-align-justify><strong>來源認證：</strong>也叫作最終用戶認證，用於驗證終端用戶或設備。Istio使用目前業界流行的JWT（JSON Web Token）作為實現方案（在配置項上Istio提供了擴展性，但在撰寫本書時仍然只支持JWT）。</li></ul><p class=ql-align-center>這兩種認證的工作原理類似，都是將來自平臺的認證策略存儲起來，然後通過Pilot分發給Envoy代理，如圖9所示。</p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/3778e059b7274efca3ddca90d702918b><p class=pgc-img-caption>圖9　認證架構</p></div><p class=ql-align-justify><strong>2．授權</strong></p><p>Istio的授權功能沿用了Kubernetes中的授權方式：RBAC（Role-Based Access Control，基於角色的訪問控制）。它可以為網格中的服務提供不同級別的訪問控制。比如命名空間級別、服務級別和方法級別。</p><p>圖10顯示了授權的工作方式。運維人員編寫授權策略的清單文件並將其部署到平臺（Kubernetes）。Pilot組件會獲取策略信息並將其保存到自己的配置存儲中，同時監聽授權策略的變更情況，以便及時更新。然後Pilot會把授權信息分發給Envoy代理。Envoy在請求到達的時候，評估當前的請求是否合法並作出相應的返回。</p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2cb5556136c94f068eb902af08ffe7c6><p class=pgc-img-caption>圖10　授權架構</p></div><p class=ql-align-justify>與安全相關的配置涉及很多細節，我們會在後面的練習章節有針對性地進行具體介紹，以便讀者可以通過演練加深理解。</p><h1 class=ql-align-justify>06 <strong>小 結</strong></h1><p>本章主要介紹了Istio的理論知識。Istio作為一個開源的服務網格產品，提供了統一的方式去管理流量、設置安全和監控等服務治理的能力。</p><p>Istio的架構分為數據平面和控制平面，這種優雅的設計使得各個組件充分解耦，各司其職，這就是很多人將它稱為第二代服務網格產品的原因。數據平面即Envoy代理，負責流量的接管；控制平面包含了Pilot、Mixer、Citadel和Galley，它們分別負責流量控制、策略控制、安全加固和數據收集。通過這些組件的協同工作，Istio順利地完成了流量管理、策略和遙測、可視化和安全這4大功能。</p><p>第3章將進入實踐階段，搭建Istio的開發環境並完成它的安裝和部署。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=什麼是服務網格？程序員為什麼爭相追逐“香饃饃”Istio？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/420452b354f448018b3da12f7fd6b38c><p class=pgc-img-caption>Istio實戰指南</p></div><p class=ql-align-center><br></p><p><strong>作者：</strong>馬若飛</p><p><strong>推薦理由：</strong></p><ul><li>Service Mesher社區成員，作為Service Mesh的佈道者；</li><li>該社區成員對於Istio的瞭解和認知都具備一定的權威性。 。</li></ul><p>本書是Istio服務網格技術的入門圖書。全書共分為10章，深入淺出地介紹了Istio的相關知識，結合大量的示例，清晰而詳細的闡述了Istio的4大特性：連接、策略、可視化和安全。本書的第1章介紹了服務網格的起源和發展，第2~4章介紹了Istio的基本概念和安裝。從第5章起通過實例練習的方式介紹了Istio的流量管理等內容，並把Istio應用到真實的項目開發中，幫助讀者進一步理解概念。</p><p class=ql-align-justify><br></p><p class=ql-align-center><strong>- END -</strong></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>什麼</a></li><li><a>服務</a></li><li><a>網格</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/220bd37c.html alt=大數據的下一步是什麼？混合服務/分析處理(HSAP) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/220bd37c.html title=大數據的下一步是什麼？混合服務/分析處理(HSAP)>大數據的下一步是什麼？混合服務/分析處理(HSAP)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/68c59cc.html alt=服務網格和API網關在微服務架構中的作用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/e941a0c6bf964f188b892ebfc20d2d5d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/68c59cc.html title=服務網格和API網關在微服務架構中的作用>服務網格和API網關在微服務架構中的作用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a736230.html alt=公務員最低服務年限是什麼？很多人都忽略了這一點！影響晉升 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/439115483b46480ab7e5de8ff9074a6f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a736230.html title=公務員最低服務年限是什麼？很多人都忽略了這一點！影響晉升>公務員最低服務年限是什麼？很多人都忽略了這一點！影響晉升</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bdedb94f.html alt=科普貼！丨你知道港珠澳大橋為什麼是彎的嗎！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d84b472b45474058bfd6bd4b87450f53 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bdedb94f.html title=科普貼！丨你知道港珠澳大橋為什麼是彎的嗎！>科普貼！丨你知道港珠澳大橋為什麼是彎的嗎！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/52ecc739.html alt=科普！看完這篇文章，你就知道港珠澳大橋為什麼是彎的了！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8f0b8a6daf6e4f9bab21e7c06cbc9111 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/52ecc739.html title=科普！看完這篇文章，你就知道港珠澳大橋為什麼是彎的了！>科普！看完這篇文章，你就知道港珠澳大橋為什麼是彎的了！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8bbd5f8a.html alt=長知識！什麼是榫卯結構？為什麼現代建築當中不常見了？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1537941825042b6f495fa56 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8bbd5f8a.html title=長知識！什麼是榫卯結構？為什麼現代建築當中不常見了？>長知識！什麼是榫卯結構？為什麼現代建築當中不常見了？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/83641773.html alt=什麼是懸挑結構？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/faebf061b82546f58e63afab5ede5fa2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/83641773.html title=什麼是懸挑結構？>什麼是懸挑結構？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a27253ff.html alt=港珠澳大橋為什麼是曲線的？關於橋那些你不知道的事 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a3c45dcf4c374ed4be36f55d44847637 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a27253ff.html title=港珠澳大橋為什麼是曲線的？關於橋那些你不知道的事>港珠澳大橋為什麼是曲線的？關於橋那些你不知道的事</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3eed9cb8.html alt=科普！港珠澳大橋為什麼是彎的！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/41bd66f3348b464c89b66628810a1aeb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3eed9cb8.html title=科普！港珠澳大橋為什麼是彎的！>科普！港珠澳大橋為什麼是彎的！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/765025c9.html alt=電纜與光纜有什麼區別 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1c289a44885646ac904fbae012632866 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/765025c9.html title=電纜與光纜有什麼區別>電纜與光纜有什麼區別</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c5053ab7.html alt="網站服務器是什麼 網站服務器怎麼搭建「詳解」" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/f9cfb6ae0c13447eab17646a80117f1b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c5053ab7.html title="網站服務器是什麼 網站服務器怎麼搭建「詳解」">網站服務器是什麼 網站服務器怎麼搭建「詳解」</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3b60dd43.html alt=長壽者的耳朵為什麼比別人長？原來耳朵還有這個大祕密 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/616a0000c4f325f77564 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3b60dd43.html title=長壽者的耳朵為什麼比別人長？原來耳朵還有這個大祕密>長壽者的耳朵為什麼比別人長？原來耳朵還有這個大祕密</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2c33cb41.html alt=為什麼每天都那麼累？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/S2HRVEQ6t1WhxB style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2c33cb41.html title=為什麼每天都那麼累？>為什麼每天都那麼累？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3f7c0fd3.html alt=什麼是場景？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3f7c0fd3.html title=什麼是場景？>什麼是場景？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bd2acf38.html alt=寫場面要注意什麼？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/4e5a000167e332d06355 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bd2acf38.html title=寫場面要注意什麼？>寫場面要注意什麼？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>