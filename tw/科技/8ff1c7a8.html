<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 | 极客快訊</title><meta property="og:title" content="解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/dfic-imagehandler/8f370516-d41a-4803-84ba-2c01e4637c8b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ff1c7a8.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ff1c7a8.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8ff1c7a8.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ff1c7a8.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ff1c7a8.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8ff1c7a8.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/8ff1c7a8.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/8ff1c7a8.html><meta property="article:published_time" content="2020-11-14T21:08:11+08:00"><meta property="article:modified_time" content="2020-11-14T21:08:11+08:00"><meta name=Keywords content><meta name=description content="解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/8ff1c7a8.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>推薦學習</h1><ul><li><a class=pgc-link data-content=mp data-source=innerLink href="https://www.toutiao.com/i6867458116846682638/?group_id=6867458116846682638" rel="noopener noreferrer" target=_blank>真真香！耗時大半個月收整全套「Java架構進階pdf」沒白費</a></li><li><a class=pgc-link data-content=mp data-source=innerLink href="https://www.toutiao.com/i6837463402219045388/?group_id=6837463402219045388" rel="noopener noreferrer" target=_blank>全網獨家的“MySQL高級知識”集合，骨灰級收藏，手慢則無</a></li><li><a class=pgc-link data-content=mp data-source=innerLink href="https://www.toutiao.com/i6827021630116463115/?group_id=6827021630116463115" rel="noopener noreferrer" target=_blank>阿里P8MySQL，基礎/索引/鎖/日誌/調優都不誤，一鍋深扒端給你</a></li></ul><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/dfic-imagehandler/8f370516-d41a-4803-84ba-2c01e4637c8b><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>什麼是事務</h1><p style=text-align:start>事務（Transaction)是由一系列對數據庫中的數據進行訪問與更新的操作所組成的一個程序執行單元。</p><p style=text-align:start>在同一個事務中所進行的操作，要麼都成功，要麼就什麼都不做。理想中的事務必須滿足四大特性，這就是大名鼎鼎的ACID。</p><h1 class=pgc-h-arrow-right>事務的ACID特性</h1><p style=text-align:start>並不是所有的事務都滿足ACID特性，比如：對於Oracle和SQL Server數據庫，其默認隔離級別是Read COMMITTED，就不滿足I(隔離性)的要求；對於MySQL的NDB Cluster引擎來說，不滿足D(持久性)的要求。</p><h1 class=pgc-h-arrow-right>A(Atomicity)-原子性</h1><p style=text-align:start>原子性指的是數據庫事務是不可分割的一部分，只有一個事務中的所有操作都成功，這個事務才算執行成功，一旦有一個操作失敗，那麼其他成功的操作也必須回滾。<br>以轉賬1000元場景為例，一個轉賬過程就是一個事務，這個事務主要包括以下兩步：<br>1、從A賬戶扣除1000元<br>2、將B賬戶中增加1000元<br>試想，如果第一步成功了，那麼第二步失敗了，那就等於A的1000元錢直接消失了，相信這是任何人都不能接受的事項，所以數據庫事務才需要保證原子性。</p><h1 class=pgc-h-arrow-right>C(Consistent)-一致性</h1><p style=text-align:start>指的是在事務開始之前和事務結束之後，數據庫的完整性約束都沒有被破壞，事務執行的前後都是合法的數據狀態。</p><p style=text-align:start>比如我們有一張表中有一個字段name建立了一個唯一約束，那麼當我們進行事務提交或者事務回滾之後，這個name必須依然保證唯一。</p><h1 class=pgc-h-arrow-right>I(Isolation)-隔離性</h1><p style=text-align:start>隔離性就是說每個事務之間的操作應該相互隔離，互不干擾。比如說一個事務提交之前對另一個事務不可見。</p><p style=text-align:start>隔離是一個相對抽象而複雜的概念，比如說事務之間的隔離性我們到底要隔離到哪種程度呢？所以，針對隔離，SQL92標準定義了4種隔離級別，這個放在後面事務的隔離級別中介紹。</p><h1 class=pgc-h-arrow-right>D(Durable)-持久性</h1><p style=text-align:start>持久性這個概念就比較容易理解了，就是說事務一旦提交成功了，那麼就應該是持久的，即使是數據庫重啟，服務器宕機等情況發生，數據都不會丟失(當然這個不能包括因為地震等自然災害導致的存儲數據的硬盤損發生不可逆的損壞)。</p><h1 class=pgc-h-arrow-right>事務的管理</h1><p style=text-align:start>可能很多人會說自己都感知不到MySQL的事務，其實這是因為MySQL事務是默認開啟了自動提交的，因此，如果要感知到事務，我們需要關閉自動提交或者顯示開啟事務。</p><h1 class=pgc-h-arrow-right>事務的自動提交</h1><p style=text-align:start>查看自動提交語句：</p><pre><code>SHOW VARIABLES LIKE 'autocommit';-- ON表示開啟了自動提交SELECT @@autocommit;-- 1表示開啟了自動提交</code></pre><p style=text-align:start>執行如下語句關閉自動提交：</p><pre><code>SET autocommit='OFF';SET @@autocommit = 0;</code></pre><p style=text-align:start>不過需要注意的是，這種修改方式只是在當前會話窗口生效，對其他會話窗口是不生效的，MySQL幾乎所有變量設置都會分成兩個級別，session(會話)和global(全局)級別，默認就是session級別。</p><h1 class=pgc-h-arrow-right>常用的事務控制語句</h1><ul><li>START TRANSACTION或者BEGIN：顯示的開啟事務。需要注意的是在存儲過程中只能用START TRANSACTION開啟事務，因為存儲過程本來有BEGIN…END語法，兩者會衝突。</li><li>COMMIT：提交事務。也可以寫成COMMIT WORK。</li><li>ROLLBACK：回滾事務。也可以寫成ROLLBACK WORK。</li><li>SAVEPOINT identifier：自定義保存點，適用於長事務，可以回滾到我們自定義的位置。</li><li>RELEASE SAVEPOINT identifier：刪除一定保存點，如果沒有保存點的時候，會報錯</li><li>ROLLBACK TO[SAVEPOINT] identifier：回滾到指定保存點。</li></ul><h1 class=pgc-h-arrow-right>COMMIT和COMMIT WORK的區別</h1><p style=text-align:start>這兩個都能提交一個事務，區別就在於提交事務之後的操作，同樣的還有ROLLBACK和ROLLBACK WORK，主要是通過一個變量來控制：completion_type，可以執行下面的sql來查看結果：</p><pre><code>SHOW VARIABLES LIKE '%completion_type%';</code></pre><p style=text-align:start>completion_type有如下三種結果：</p><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/cd28fddfdee743b4b144f7b716662792><p class=pgc-img-caption></p></div><p style=text-align:start>舉個栗子1：</p><pre><code>SET completion_type=1; --1begin;--2INSERT test2 VALUES(1,'張1');--3commit work;--4INSERT test2 VALUES(2,'張1');--5select * from test2;--6rollback;--7select * from test2;--8</code></pre><p style=text-align:start>第4條語句中，我們提交了一個事務，第5條語句中我們又插入了一條數據，此時第六條語句可以查詢出2條數據，接下來我們回滾，語句8再去查詢就會發現只剩一條數據了，因為語句6倍回滾了，我們在語句4之後並沒有顯示的開啟一個事務，這就說明語句4自動開啟了一個新的事務。</p><p style=text-align:start>舉個栗子2：</p><pre><code>SET completion_type=2;begin;INSERT test2 VALUES(3,'張1');commit work;select * from test2;</code></pre><p style=text-align:start>最後一條語句返回如下結果：</p><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/21b08f9d5c774e87bbcf43bbcad06955><p class=pgc-img-caption></p></div><p style=text-align:start>先提示的斷開連接，然後自動重連。測試這個例子的時候用工具比如sqlyog可能會不是很明顯，因為工具會自動幫忙重連，看起來就好像沒斷開一樣，建議用命令窗口的形式測試</p><h1 class=pgc-h-arrow-right>事務的分類</h1><p style=text-align:start>從事務的理論角度來說，我們可以把事務分為以下五大類：</p><h1 class=pgc-h-arrow-right>扁平事務</h1><p style=text-align:start>這種是最簡單也是最常用的一種事務，這種事務中的所有操作都是原子的，要麼全部成功，要麼什麼都不做。</p><h1 class=pgc-h-arrow-right>帶有保存點的扁平事務</h1><p style=text-align:start>這種一般比較適合於長事務，事務處理到後面報錯的時候，我們可以選擇不全部回滾事務，而是回滾到我們自定義好的某一個保存點。如下例子：</p><pre><code>BEGIN;INSERT test VALUES(1,'張1');SAVEPOINT AINSERT test VALUES(2,'張2');ROLLBACK TO ACOMMIT;</code></pre><p style=text-align:start>上面示例語句中，我麼你定義了一個保存點A，然後在後面又回滾到A，這時候提交事務，那麼第二條插入語句是失敗的，而第一條語句是成功的。</p><p style=text-align:start><strong>注意：回滾到指定保存點之後，事務仍然還在活動狀態，我們依然需要執行COMMIT或者ROLLBACK語句才算結束了事務</strong></p><h1 class=pgc-h-arrow-right>鏈事務</h1><p style=text-align:start>在提交一個事務之後，釋放掉我們不需要的數據，將必要的數據隱式的傳給下一個事務。（<strong>注意：提交事務操作和開始下一個事務操作是一個原子操作</strong>）這就意味著下一個事務能看到上一個事務的結果。</p><p style=text-align:start>鏈事務可以看成帶有保存點的特殊事務，他們的區別就是帶有保存點的事務可以回滾到任意保存點，但是回滾之後事務仍然活躍，需要執行COMMIT或者ROLLBACK之後才結束事務，而鏈事務中只能回滾到最近的一個保存點(即開始事務的點)。</p><p style=text-align:start>鏈事務可以通過上面的completion_type參數來實現。上文中有舉例使用方法，這裡就不重複舉例了。</p><h1 class=pgc-h-arrow-right>嵌套事務</h1><p style=text-align:start>嵌套事務就是說一個事務之中嵌套另一個事務，事務之間存在父子關係，子事務的提交之後並不生效，需要等到父事務提交之後才會生效。</p><p style=text-align:start>需要注意的是MySQL原生並不支持嵌套事務，但是可以通過保存點模擬嵌套事務，只是說這麼模擬的話就沒有真正的嵌套事務這麼靈活。</p><h1 class=pgc-h-arrow-right>分佈式事務</h1><p style=text-align:start>分佈式事務通常就是在分佈式環境下，多個數據庫下運行不同的扁平事務。多個數據庫環境下運行的扁平事務就合成了一個分佈式事務。</p><h1 class=pgc-h-arrow-right>事務的隔離級別</h1><h1 class=pgc-h-arrow-right>Read Uncommitted(未提交讀)</h1><p style=text-align:start>簡稱RU。這種是最低的隔離級別，等於沒有隔離，基本上沒有數據庫會使用這個級別。一個事務可以讀取到其他事務未提交的數據，這種也叫做髒讀。</p><p style=text-align:start>什麼是髒讀？請看下面這個例子：</p><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3f07885f4962487f8c4471ae9e9572e3><p class=pgc-img-caption></p></div><p style=text-align:start>左邊是事務1，先查一次，查到id為1的數據name為張三，這時候事務2又來了，把張三改成了李四，然後事務1又進行了一次查詢，查出來了name為李四，那麼假如這時候事務2發生了回滾，也就是name還是張三，但是事務1卻讀到了李四，這就是髒讀。</p><h1 class=pgc-h-arrow-right>Read Committed(已提交讀)</h1><p style=text-align:start>簡稱RC。一個事務只能讀取到其他事務已提交的數據，就是說在一個事務裡面，執行同樣的查詢，會出現兩次不一樣的結果。Oracle和SQL Server數據庫默認的數據庫隔離級別。這種隔離級別解決了髒讀問題，但是會出現不可重複讀的問題。</p><p style=text-align:start>什麼是不可重複讀？還是看上面那個例子，假設事務2更新之後馬上就提交，然後事務1第二次查詢查出來的結果還是李四，只是這次就不算是髒讀了，因為事務2提交了，這種就叫不可重複讀，因為事務1中兩次查詢同一條數據結果不一樣。</p><h1 class=pgc-h-arrow-right>Repeatable Read(可重複讀)</h1><p style=text-align:start>簡稱RR。這種隔離級別解決了不可重複讀問題，就是說在同一個事務中，執行相同的查詢，結果都是一樣的，但是這種級別會出現幻讀問題(InnoDB引擎例外，InnoDB引擎通過間隙鎖解決了幻讀問題)。</p><p style=text-align:start>什麼是幻讀？請看下面這個例子：</p><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3c3f58c90a1e4e9c9e6f7b24541770e4><p class=pgc-img-caption></p></div><p style=text-align:start>上面圖形中，事務1進行了一個範圍查詢，第一次只能查出一條記錄，這時候事務2來插入了一條數據，然後事務1再次執行同一個查詢，這時候就能查出來兩條記錄，也就是多了一條，給人一種幻覺，所以稱之為幻讀。</p><p>說到這裡，可能有人就有疑問了，因為感覺不可重複讀和幻讀都是讀取到已提交事務的結果，好像沒什麼區別？確實如此，<strong class=highlight-text>不可重複讀和幻讀本質上是一樣的，但是不可重複讀針對的是更新和刪除操作，而幻讀僅針對插入操作</strong><strong>。</strong></p><h1 class=pgc-h-arrow-right>Serializable(串行化)</h1><p style=text-align:start>這種是隔離的最高級別，也就是說所有的事務都是串行執行的，也就不存在併發事務，髒讀，可重複讀和幻讀問題自然也就沒有了。</p><h1 class=pgc-h-arrow-right>不同隔離級別對比</h1><p style=text-align:start>不同的隔離級別可以解決不同的問題，大致如下圖：</p><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5b223aa6613e4cfa9af62f15ad071267><p class=pgc-img-caption></p></div><p>對於未提交讀和已提交讀大家可能都很好理解，只要控制一個事務提交之後才能對另一個事務可見，但是對於可重複讀，MySQL到底是如何實現即使一個事務已經提交了，還能對另一個事務不可見呢？這就是接下來我們要講解的MVCC了。</p><h1 class=pgc-h-arrow-right>事務隔離的實現方案</h1><p style=text-align:start>事務隔離的實現方案有兩種，LBCC和MVCC</p><h1 class=pgc-h-arrow-right>LBCC</h1><p style=text-align:start>LBCC，基於鎖的併發控制，英文全稱Based Concurrency Control。這種方案比較簡單粗暴，就是一個事務去讀取一條數據的時候，就上鎖，不允許其他事務來操作(當然這個鎖的實現也比較重要，如果我們只鎖定當前一條數據依然無法解決幻讀問題)。</p><h1 class=pgc-h-arrow-right>當前讀</h1><p style=text-align:start>這個概念其實很好理解，MySQL加鎖之後就是當前讀。假如當前事務只是加共享鎖，那麼其他事務就不能有排他鎖，也就是不能修改數據；而假如當前事務需要加排他鎖，那麼其他事務就不能持有任何鎖。總而言之，能加鎖成功，就確保了除了當前事務之外，其他事務不會對當前數據產生影響，所以自然而然的，當前事務讀取到的數據就只能是最新的，而不會是快照數據(後文MVCC會解釋快照讀概念)。</p><p style=text-align:start>LBCC方案中，如果我們的業務系統是讀多寫少的話，這種方案就會極大影響了效率，所以我們就有了另一種解決方案：MVCC。</p><h1 class=pgc-h-arrow-right>MVCC</h1><p style=text-align:start>MVCC,多版本的併發控制，英文全稱：Multi Version Concurrency Control。就是當我們在修改數據的時候，可以為這條數據創建一個快照，後面就可以直接讀取這個快照。</p><p style=text-align:start>那麼MVCC具體到底是如何實現的呢？</p><p style=text-align:start>為了實現MVCC機制，InnoDB內部為每一行添加了兩個隱藏列：DB_TRX_ID和DB_ROLL_PTR（MySQL另外還有一個隱藏列DB_ROW_ID，這是在InnoDB表沒有主鍵的時候會用來作為主鍵，想詳細瞭解可以點擊這裡）。</p><h1 class=pgc-h-arrow-right>DB_TRX_ID</h1><p style=text-align:start>長度為6字節，存儲了插入或更新語句的最後一個事務的事務ID。</p><h1 class=pgc-h-arrow-right>DB_ROLL_PTR</h1><p style=text-align:start>長度為7字節，稱之為：回滾指針。回滾指針指向寫入回滾段的undo log記錄，讀取記錄的時候會根據指針去讀取undo log中的記錄。</p><p style=text-align:start>正因為MySQL中undo log中會維護一個歷史數據記錄，所以我們應該養成定期提交事務的習慣，否則回滾段會越來越大，甚至佔滿了表空間。</p><h1 class=pgc-h-arrow-right>快照讀</h1><p style=text-align:start>快照讀是針對上文的當前讀而言，指的是在RR隔離級別下，在不加鎖的情況下MySQL會根據回滾指針選擇從undo log記錄中獲取快照數據，而不總是獲取最新的數據，這也就是為什麼另一個事務提交了數據，在當前事務中看到的依然是另一個事務提交之前的數據。</p><h1 class=pgc-h-arrow-right>MySQL什麼時候開始讀取快照</h1><p style=text-align:start>我們先看看MySQL默認隔離級別RR下的一個例子（注意，test和test2兩張表一開始都是空表，均只有id和name兩個字段）。</p><ul><li>場景1(事務1操作數據之後再進行第一次查詢)：</li></ul><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bb52a459f3ff4539ad7a942bd33626c4><p class=pgc-img-caption></p></div><ul><li>場景2(事務1不進行任何操作，事務2先開始第一次查詢)</li></ul><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b26674caea674df9bb4edf4f14429aa1><p class=pgc-img-caption></p></div><p>通過上面兩個場景中我們可以得出結論：<br><strong>RR隔離級別快照並不是在BEGIN就開始產生了，而是要等到事務當中的第一次查詢之後才會產生快照，之後的查詢就只讀取這個快照數據</strong></p><ul><li>場景3(事務2先進行一次t1表查詢之後，事務1再去操作其他表t2)</li></ul><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/88cf0f23a64b43a987ae3e5f2a16ec61><p class=pgc-img-caption></p></div><p>從場景3我們可以得出結論：<strong>RR隔離級別快照並不只是針對當前所查詢的數據，而是針對當前MySQL中的所有數據(跨庫也一樣，只要在同一個MySQL)</strong></p><h1 class=pgc-h-arrow-right>MVCC查詢機制</h1><p style=text-align:start>MVCC機制到底如何查詢的呢？假設由很多個事務同時進行，那麼就會產生很多快照，查詢的時候又到底是怎麼做的呢？</p><p style=text-align:start>接下來我們把抽象的概念具體化，假定DB_TRX_ID和DB_ROLL_PTR均為整型，接下來我們進行查詢演示：</p><p style=text-align:start>1、清空原先的test表，事務A插入兩條數據，此時DB_TRX_ID(事務id)為1,DB_ROLL_PTR(回滾指針為null)</p><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/932f62afab754d59ac3aca470b8c0cba><p class=pgc-img-caption></p></div><p style=text-align:start>2、這時候事務B進行了一次查詢，會得到上面的結果，事務2還沒提交的時候又來了事務C，事務C插入了id=3的數據，此時表中的數據如下：</p><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8b79919b047a49f2861d9ab845d272e6><p class=pgc-img-caption></p></div><p style=text-align:start><strong>注意，這時候第3條數據的事務id為3，因為事務2也會產生一個事務id</strong><br>3、這時候事務B再次進行查詢，根據上面瞭解的，我們知道，這時候應該是查詢不出王五的，所以實際上二次查詢可能是這麼查的：</p><pre><code>select * from test where 事務id&lt;=2-- 因為當前的事務id為2</code></pre><p style=text-align:start>4、假如這時候事務D又來了，把id=1的數據給刪除了，這時候會把原數據的回滾指針記錄為當前的事務id：4，所以此時數據如下：</p><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/032a5c045eeb43b3a4fa4ba9752b6730><p class=pgc-img-caption></p></div><p style=text-align:start>5、回到事務B，繼續查詢，應該還是隻有1和2兩條數據，那麼他可能是這麼查詢的：</p><pre><code>select * from test where 事務id&lt;=2 and (回滾指針 is null or 回滾指針 &gt;2)</code></pre><p style=text-align:start>6、假如這時候又來了事務E，對第2條數據進行了更新，這時候會生產一條事務id為5的數據，並把原數據的回滾指針也同時標記為當前的事務id：5，那麼會得到如下數據：</p><div class=pgc-img><img alt=解讀數據庫：深入分析MySQL中事務以及MVCC的實現原理 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1ddf47fd40f64201a9166c0ed3076c74><p class=pgc-img-caption></p></div><p style=text-align:start>根據上面猜測，執行下面的查詢：</p><pre><code>select * from test where 事務id&lt;=2 and (回滾指針 is null or 回滾指針 &gt;2)</code></pre><p style=text-align:start>這時候發現，查出來的數據還是隻有1和2兩條。</p><h1 class=pgc-h-arrow-right>MVCC查詢兩大規則</h1><p style=text-align:start>綜上，MVCC大致查詢規則如下：<br>1、<strong>只查詢事務id小於等於當前事務id的數據。</strong>(這裡要等於是因為假如自己的事務插入了一條數據，會生成一條當前事務id的數據，所以必須包含本事務自己插入的數據)<br>2、<strong>只查詢未刪除(回滾指針為空)或者回滾指針大於當前事務id的數據。</strong>(這裡不能等於是因為假如自己的事務刪除了一條數據，會生成數據的回滾指針為當前事務id，所以必須排除掉自己刪除的數據)</p><p style=text-align:start>當然，上面規則只是簡化了，實際查詢遠比這裡複雜，只是希望藉助這種簡單化的概念可以幫助大家更好的理解MVCC工作機制。</p><blockquote class=pgc-blockquote-abstract><p>作者：雙子孤狼</p><p>原文鏈接：https://blog.csdn.net/zwx900102/article/details/106544843</p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>解讀</a></li><li><a>數據庫</a></li><li><a>MySQL</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html alt=MySQL數據庫的事務管理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/152203544367254a708f807 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html title=MySQL數據庫的事務管理>MySQL數據庫的事務管理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ad3f3a1e.html alt="數據庫技術：MySQL 基礎和 SQL 入門，單表、約束和事務" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/107897c16ae7461caa62dd375b631afe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ad3f3a1e.html title="數據庫技術：MySQL 基礎和 SQL 入門，單表、約束和事務">數據庫技術：MySQL 基礎和 SQL 入門，單表、約束和事務</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9bbdeed9.html alt="MySQL 數據庫、表、字段的命名建議規範" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ed974f814051426eb120a107abc94df7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9bbdeed9.html title="MySQL 數據庫、表、字段的命名建議規範">MySQL 數據庫、表、字段的命名建議規範</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ae0a02c6.html alt=MySQL數據庫+命令大全，人手一份的實操攻略來啦 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RTDWEx38S8Abbo style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ae0a02c6.html title=MySQL數據庫+命令大全，人手一份的實操攻略來啦>MySQL數據庫+命令大全，人手一份的實操攻略來啦</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ee5b3ede.html alt="源碼解讀：MySQL 8.0 InnoDB無鎖化設計的日誌系統" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15254882999416c80866253 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ee5b3ede.html title="源碼解讀：MySQL 8.0 InnoDB無鎖化設計的日誌系統">源碼解讀：MySQL 8.0 InnoDB無鎖化設計的日誌系統</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3c25334.html alt=MySQL數據庫字符串類型常用操作 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4ebac77cb4234d3f85cf2ee58b785b47 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3c25334.html title=MySQL數據庫字符串類型常用操作>MySQL數據庫字符串類型常用操作</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dacc263.html alt=MySQL數據庫中的事務以及創建表的注意事項 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dacc263.html title=MySQL數據庫中的事務以及創建表的注意事項>MySQL數據庫中的事務以及創建表的注意事項</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/e6b01ca.html alt=數據庫事務系列－MySQL跨行事務模型 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/dfic-imagehandler/64c5efca-90a2-44e0-99ff-f3cfd727679e style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/e6b01ca.html title=數據庫事務系列－MySQL跨行事務模型>數據庫事務系列－MySQL跨行事務模型</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bcc3f9eb.html alt=解讀新規範——構建精細化橋樑之路 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/9317d74f6fd541a6b6e1e5269a0a549c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bcc3f9eb.html title=解讀新規範——構建精細化橋樑之路>解讀新規範——構建精細化橋樑之路</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/37ac5476.html alt=解讀：層絞式室外光纜 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7243ce84f5524f66b2fefb7a7e34ac7a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/37ac5476.html title=解讀：層絞式室外光纜>解讀：層絞式室外光纜</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9104cf19.html alt=招商銀行掌上生活十元風暴解讀，輕鬆薅羊毛 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/92f29b3e14f7430889422d37a042e429 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9104cf19.html title=招商銀行掌上生活十元風暴解讀，輕鬆薅羊毛>招商銀行掌上生活十元風暴解讀，輕鬆薅羊毛</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/deb995ba.html alt=技術解讀GKN、BOSCH和ZF三合一集成電驅動橋 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d0e167b08bf94dbfa698d5f87c552239 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/deb995ba.html title=技術解讀GKN、BOSCH和ZF三合一集成電驅動橋>技術解讀GKN、BOSCH和ZF三合一集成電驅動橋</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html alt="MySQL 事務處理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html title="MySQL 事務處理">MySQL 事務處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c9091681.html alt="MySQL 學習筆記" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c9091681.html title="MySQL 學習筆記">MySQL 學習筆記</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html alt=MySQL——事務(Transaction)詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/29d4c92c9c2344838eb72ef948cf08fa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html title=MySQL——事務(Transaction)詳解>MySQL——事務(Transaction)詳解</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>