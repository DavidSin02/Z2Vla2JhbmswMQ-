<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Linux kernelä¸­å¸¸è¦‹çš„å®æ•´ç† | æå®¢å¿«è¨Š</title><meta property="og:title" content="Linux kernelä¸­å¸¸è¦‹çš„å®æ•´ç† - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/907ac78.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/907ac78.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/907ac78.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/907ac78.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/907ac78.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/907ac78.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/907ac78.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/907ac78.html><meta property="article:published_time" content="2020-10-29T21:04:55+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:55+08:00"><meta name=Keywords content><meta name=description content="Linux kernelä¸­å¸¸è¦‹çš„å®æ•´ç†"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/907ac78.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Linux kernelä¸­å¸¸è¦‹çš„å®æ•´ç†</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>0x00 å®çš„åŸºæœ¬çŸ¥è­˜</h1><pre>// object-like#define å®å æ›¿æ›åˆ—è¡¨ æ›è¡Œç¬¦//function-like#define å®å ([æ¨™è­˜ç¬¦åˆ—è¡¨]) æ›¿æ›åˆ—è¡¨ æ›è¡Œç¬¦</pre><p>æ›¿æ›åˆ—è¡¨å’Œæ¨™è­˜ç¬¦åˆ—è¡¨éƒ½æ˜¯å°‡å­—ç¬¦ä¸² token åŒ–ä»¥å¾Œçš„åˆ—è¡¨ã€‚å€åˆ¥åœ¨æ–¼æ¨™è­˜ç¬¦åˆ—è¡¨ä½¿ç”¨,ä½œç‚ºä¸åŒåƒæ•¸ä¹‹é–“çš„åˆ†å‰²ç¬¦ã€‚æ¯ä¸€å€‹åƒæ•¸éƒ½æ˜¯ä¸€å€‹ token åŒ–çš„åˆ—è¡¨ã€‚åœ¨å®ä¸­ç©ºç™½ç¬¦åªèµ·åˆ°åˆ†å‰² token çš„ä½œç”¨ï¼Œç©ºç™½ç¬¦çš„å¤šå°‘å°æ–¼é è™•ç†å™¨æ˜¯æ²’æœ‰æ„ç¾©çš„ã€‚</p><p>å®çš„ä¸€äº›å¥‡æŠ€æ·«å·§ï¼š</p><p>https://gaomf.cn/2017/10/06/C_Macro/</p><p>ä»¥ä¸‹æ˜¯æ•´ç†çš„ä¸€äº›linux kernelä¸­çš„å¸¸è¦‹å®ï¼Œç”±æ–¼ä¸åŒé«”ç³»æ¶æ§‹ï¼Œæˆ–è€…ä¸åŒæ¨¡å¡Šçš„å®å®šç¾©ä¸åŒï¼ŒåªæŒ‘é¸äº†å…¶ä¸­å®¹æ˜“çœ‹æ‡‚çš„å®ä½œç‚ºè¨˜éŒ„ï¼Œå¯¦ç¾çš„åŠŸèƒ½å¤§é«”ä¸€æ¨£ã€‚</p><h1 class=pgc-h-arrow-right>Linuxå…§æ ¸ä¸­do{...}while(0)æ„ç¾©ï¼š</h1><ul><li>è¼”åŠ©å®šç¾©è¤‡é›œçš„å®ï¼Œé¿å…å¼•ç”¨çš„æ™‚å€™å‡ºéŒ¯ï¼Œå¦‚æœä¸ç”¨{}ï¼Œifå¾Œé¢çš„èªå¥åªæœ‰ç¬¬ä¸€æ¢é€²è¡Œäº†åˆ¤æ–·ã€‚åŒæ™‚é¿å…å®å±•é–‹å¾Œâ€œ;â€é€ æˆç·¨è­¯ä¸é€šé.</li><li>é¿å…ä½¿ç”¨gotoï¼Œå°ç¨‹åºæµé€²è¡Œçµ±ä¸€çš„æ§åˆ¶ï¼Œä½¿ç”¨breakè·³å‡º</li><li>é¿å…ç©ºå®å¼•èµ·çš„warning</li><li>å®šç¾©ä¸€å€‹å–®ç¨çš„å‡½æ•¸å¡Šä¾†å¯¦ç¾è¤‡é›œçš„æ“ä½œ</li></ul><h1 class=pgc-h-arrow-right>0x01 å¸¸è¦‹å®æ•´ç†</h1><h1 class=pgc-h-arrow-right>__CONCATå®</h1><p>"##"ç”¨æ–¼ç²˜è²¼å…©å€‹åƒæ•¸ï¼Œ"#"ç”¨æ–¼æ›¿æ›åƒæ•¸ï¼š</p><pre>#define __CONCAT(a, b) a ## b</pre><h1 class=pgc-h-arrow-right>BUG_ON(condition)</h1><p>æ¢ä»¶ç‚ºçœŸï¼Œç”¢ç”Ÿå´©æ½°ï¼Œ åŸç†ï¼šæœªå®šç¾©çš„ç•°å¸¸ã€‚</p><p>ç›¸å°æ‡‰çš„æœ‰ WARN_ONï¼š</p><pre>#define BUG() assert(0)#define BUG_ON(x) assert(!(x)) /* Does it make sense to treat warnings as errors? */#define WARN() BUG()#define WARN_ON(x) (BUG_ON(x), false)</pre><h1 class=pgc-h-arrow-right>BUILD_BUG_ONå®</h1><pre>#define BUILD_BUG_ON(condition) ((void)sizeof(char[1 - 2*!!(condition)]))</pre><ol start=1><li>conditionç‚ºçœŸæ™‚ï¼Œsizeof(char[-1])ï¼Œç”¢ç”ŸéŒ¯èª¤ï¼Œç·¨è­¯ä¸é€šé</li><li>conditionç‚ºå‡æ™‚ï¼Œsizeof(char[1])ï¼Œç·¨è­¯é€šé</li></ol><p>æª¢æŸ¥è¡¨é”å¼eæ˜¯å¦ç‚º0ï¼Œç‚º0ç·¨è­¯é€šéä¸”è¿”å›0ï¼›å¦‚æœä¸ç‚º0ï¼Œå‰‡ç·¨è­¯ä¸é€šéã€‚</p><pre>struct { int : â€“!!(0); } -=&gt; struct { int : 0; }</pre><p>å¦‚æœeç‚º0ï¼Œå‰‡è©²çµæ§‹é«”æ“æœ‰ä¸€å€‹intå‹çš„æ•¸æ“šåŸŸï¼Œä¸¦ä¸”è¦å®šå®ƒæ‰€ä½”çš„ä½çš„å€‹æ•¸ç‚º0ã€‚</p><pre>struct { int : â€“!!(1); } -=&gt; struct { int : â€“1; }</pre><p>å¦‚æœeé0ï¼Œçµæ§‹é«”çš„intå‹æ•¸æ“šåŸŸçš„ä½åŸŸå°‡è®Šç‚ºä¸€å€‹è² æ•¸ï¼Œç”¢ç”Ÿèªæ³•çš„éŒ¯èª¤ã€‚</p><p>typeofç²å¾—xçš„è®Šé‡é¡å‹ï¼Œæ ¹æ“šå‚³å…¥åƒæ•¸é¡å‹çš„ä¸åŒï¼Œç”¢ç”Ÿä¸åŒçš„è¡Œç‚ºï¼Œå¯¦ç¾â€œç·¨è­¯æ™‚å¤šæ…‹â€ã€‚å¯¦éš›typeofæ˜¯åœ¨é ç·¨è­¯æ™‚è™•ç†ï¼Œæœ€å¾Œå¯¦éš›è½‰åŒ–ç‚ºæ•¸æ“šé¡å‹è¢«ç·¨è­¯å™¨è™•ç†ã€‚</p><p>æ‰€ä»¥å…¶ä¸­çš„è¡¨é”å¼åœ¨é‹è¡Œæ™‚æ˜¯ä¸æœƒè¢«åŸ·è¡Œçš„ï¼Œæ¯”å¦‚typeof(fun())ï¼Œfun()å‡½æ•¸æ˜¯ä¸æœƒè¢«åŸ·è¡Œçš„ï¼Œtypeofåªæ˜¯åœ¨ç·¨è­¯æ™‚åˆ†æå¾—åˆ°äº†fun()çš„è¿”å›å€¼è€Œå·²ã€‚</p><p>typeofé‚„æœ‰ä¸€äº›ä¾·é™æ€§ï¼Œå…¶ä¸­çš„è®Šé‡æ˜¯ä¸èƒ½åŒ…å«å­˜å„²é¡èªªæ˜ç¬¦çš„ï¼Œå¦‚staticã€externé€™é¡éƒ½æ˜¯ä¸è¡Œçš„ã€‚</p><h1 class=pgc-h-arrow-right>typecheckå®</h1><p>å®typecheckç”¨æ–¼æª¢æŸ¥xæ˜¯å¦ç‚ºtypeé¡å‹ï¼Œå¦‚æœä¸æ˜¯æœƒæ‹‹å‡ºï¼ˆwarning: comparison of distinct pointer types lacks a castï¼‰ï¼Œtypecheck_fnç”¨æ–¼æª¢æŸ¥å‡½æ•¸functionæ˜¯å¦ç‚ºtypeé¡å‹ï¼Œä¸ä¸€è‡´è·‘å‡ºï¼ˆwarning: initialization from incompatible pointer typeï¼‰ã€‚</p><pre>/* * Check at compile time that something is of a particular type. * Always evaluates to 1 so you may use it easily in comparisons. */#define typecheck(type,x) \({ type __dummy; \    typeof(x) __dummy2; \    (void)(&amp;__dummy == &amp;__dummy2); \    1; \})/*GCCçš„ä¸€å€‹æ“´å±•ç‰¹æ€§ï¼Œå½¢å¦‚({ ... })é€™æ¨£çš„ä»£ç¢¼å¡Šæœƒè¢«è¦–ç‚ºä¸€æ¢èªå¥ï¼Œ* å…¶è¨ˆç®—çµæœæ˜¯{ ... }ä¸­æœ€å¾Œä¸€æ¢èªå¥çš„è¨ˆç®—çµæœã€‚* æ‰€ä»¥ä¸Šè¿°æœƒè¿”å›1*//* * Check at compile time that &#39;function&#39; is a certain type, or is a pointer * to that type (needs to use typedef for the function type.) */#define typecheck_fn(type,function) \({ typeof(type) __tmp = function; \    (void)__tmp; \})</pre><h1 class=pgc-h-arrow-right>minå®</h1><p>é€šétypeé€²è¡Œéš±å¼è½‰æ›å®‰å…¨é€šéç·¨è­¯ï¼Œå¦å‰‡æœƒè·‘å‡ºwarningï¼š</p><pre>#define min(x, y) __careful_cmp(x, y, &lt;)#define __cmp(x, y, op) ((x) op (y) ? (x) : (y))#define __safe_cmp(x, y) \        (__typecheck(x, y) &amp;&amp; __no_side_effects(x, y))#define __no_side_effects(x, y) \        (__is_constexpr(x) &amp;&amp; __is_constexpr(y)) #define __cmp_once(x, y, unique_x, unique_y, op) ({ \        typeof(x) unique_x = (x); \        typeof(y) unique_y = (y); \        __cmp(unique_x, unique_y, op); })/*é‡æ–°è³¦å€¼ç‚ºäº†é˜²æ­¢x++é€™ç¨®é‡è¤‡+1 */#define __careful_cmp(x, y, op) \    __builtin_choose_expr(__safe_cmp(x, y), \ //æ¯”è¼ƒx, yçš„é¡å‹        __cmp(x, y, op), \ //x,yé¡å‹ä¸€æ¨£æ™‚        __cmp_once(x, y, __UNIQUE_ID(__x), __UNIQUE_ID(__y), op))          //x, yé¡å‹ä¸åŒæ™‚</pre><p>__UNIQUE_IDä¿è­‰è®Šé‡å”¯ä¸€ã€‚</p><h1 class=pgc-h-arrow-right>__is_constexprå®</h1><p>åˆ¤æ–·xæ˜¯å¦ç‚ºæ•´æ•¸å¸¸é‡è¡¨é”å¼ï¼š</p><pre>/* * This returns a constant expression while determining if an argument is * a constant expression, most importantly without evaluating the argument. * Glory to Martin Uecker &lt;Martin.Uecker@med.uni-goettingen.de&gt; */#define __is_constexpr(x) \    (sizeof(int) == sizeof(*(8 ? ((void *)((long)(x) * 0l)) : (int *)8)))</pre><p>å¦‚æœxæ˜¯å¸¸é‡è¡¨é”å¼ï¼Œå‰‡(void )((long)(x) 0l)æ˜¯ä¸€å€‹ç©ºæŒ‡é‡å¸¸é‡ï¼Œå°±æœƒä½¿ç”¨ç¬¬ä¸‰å€‹æ“ä½œæ•¸å³((int *)8)çš„é¡å‹ã€‚å¦‚æœä¸æ˜¯å¸¸é‡è¡¨é”å¼ï¼Œå‰‡æœƒä½¿ç”¨ç¬¬äºŒå€‹æ“ä½œæ•¸voidé¡å‹ã€‚</p><p>æ‰€ä»¥æœƒå‡ºç¾ä»¥ä¸‹å…©ç¨®æƒ…æ³ï¼š</p><pre>sizeof(int) == sizeof(*((int *) (NULL))) // if `x` was an integer constant expressionsizeof(int) == sizeof(*((void *)(....))) // otherwise</pre><p>å› ç‚ºsizeof(void) = 1ï¼Œæ‰€ä»¥å¦‚æœxæ˜¯æ•´æ•¸å¸¸é‡è¡¨é”å¼ï¼Œå‰‡å®çš„çµæœç‚º1ï¼Œå¦å‰‡ç‚º0ã€‚</p><p>https://stackoverflow.com/questions/49481217/linux-kernels-is-constexpr-macro</p><p>æè¿°ï¼šæ­¤å‡½æ•¸ç‚ºGNUæ“´å±•ï¼Œç”¨ä¾†åˆ¤æ–·å…©å€‹é¡å‹æ˜¯å¦ç›¸åŒï¼Œå¦‚æœtype_aèˆ‡ type_bç›¸åŒçš„è©±ï¼Œå°±æœƒè¿”å›1ï¼Œå¦å‰‡çš„è©±ï¼Œè¿”å›0ã€‚</p><pre>int __builtin_choose_expr(exp, e1, e2);</pre><h1 class=pgc-h-arrow-right>maxå®</h1><p>åŒmin å®ã€‚</p><h1 class=pgc-h-arrow-right>roundupå®</h1><p>è¿”å›ä¸€å€‹èƒ½å¤ æ•´é™¤yä¸¦ä¸”å¤§æ–¼xï¼Œæœ€æ¥è¿‘xçš„å€¼ï¼Œå‘ä¸Šå–æ•´ï¼Œå¯ç”¨æ–¼åœ°å€çš„å…§å­˜å°é½Šï¼š</p><pre>#define roundup(x, y) ( \{ \    const typeof(y) __y = y; \    (((x) + (__y - 1)) / __y) * __y; \} \)</pre><h1 class=pgc-h-arrow-right>clamp å®</h1><p>åˆ¤æ–·valæ˜¯å¦åœ¨loå’Œhiçš„ç¯„åœå…§ï¼Œå¦‚æœå°æ–¼loï¼Œè¿”å›loï¼Œå¦‚æœå¤§æ–¼hiå‰‡è¿”å›hiï¼Œå¦‚æœåœ¨loå’Œhiä¹‹é–“å°±è¿”å›valï¼š</p><pre>/** * clamp - return a value clamped to a given range with strict typechecking * @val: current value * @lo: lowest allowable value * @hi: highest allowable value * * This macro does strict typechecking of @lo/@hi to make sure they are of the * same type as @val. See the unnecessary pointer comparisons. */#define clamp(val, lo, hi) min((typeof(val))max(val, lo), hi)</pre><h1 class=pgc-h-arrow-right>abså®</h1><p>å–çµ•å°å€¼ï¼š</p><pre>/** * abs - return absolute value of an argument * @x: the value. If it is unsigned type, it is converted to signed type first. * char is treated as if it was signed (regardless of whether it really is) * but the macro&#39;s return type is preserved as char. * * Return: an absolute value of x. */#define abs(x) __abs_choose_expr(x, long long, \        __abs_choose_expr(x, long, \        __abs_choose_expr(x, int, \        __abs_choose_expr(x, short, \        __abs_choose_expr(x, char, \        __builtin_choose_expr( \            __builtin_types_compatible_p(typeof(x), char), \            (char)({ signed char __x = (x); __x&lt;0?-__x:__x; }), \            ((void)0))))))) #define __abs_choose_expr(x, type, other) __builtin_choose_expr( \    __builtin_types_compatible_p(typeof(x), signed type) || \    __builtin_types_compatible_p(typeof(x), unsigned type), \    ({ signed type __x = (x); __x &lt; 0 ? -__x : __x; }), other)</pre><h1 class=pgc-h-arrow-right>swap å®</h1><p>åˆ©ç”¨typeofç²å–è¦äº¤æ›è®Šé‡çš„é¡å‹ï¼š</p><pre>/* * swap - swap value of @a and @b */#define swap(a, b) \    do { typeof(a) __tmp = (a); (a) = (b); (b) = __tmp; } while (0)</pre><h1 class=pgc-h-arrow-right>container_ofå®</h1><p>æ ¹æ“šä¸€å€‹çµæ§‹é«”è®Šé‡ä¸­çš„æˆå“¡è®Šé‡ä¾†ç²å–æ•´å€‹çµæ§‹é«”è®Šé‡çš„æŒ‡é‡ã€‚</p><pre>#define offsetof(TYPE, MEMBER) ((size_t) &amp;((TYPE *)0)-&gt;MEMBER)/*çµæ§‹é«”åœ°å€ç‚º0ï¼Œå°‡memberåœ°å€è½‰æˆsize_té¡å‹ä½œç‚ºåç§»/** * container_of - cast a member of a structure out to the containing structure * @ptr: the pointer to the member. * @type: the type of the container struct this is embedded in. * @member: the name of the member within the struct. * */#define container_of(ptr, type, member) ({ \    const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr); \ //*__mpträ¿å­˜è©²memberè®Šé‡çš„æŒ‡é‡    (type *)( (char *)__mptr - offsetof(type,member) );}) //è®Šé‡æŒ‡é‡æ¸›å»è‡ªèº«åç§»å¾—åˆ°æŒ‡å‘çµæ§‹é«”çš„æŒ‡é‡</pre><h3 class=pgc-h-arrow-right>likelyå’Œunlikelyå®</h3><p>æŠŠåˆ†æ”¯é æ¸¬çš„ä¿¡æ¯æä¾›çµ¦ç·¨è­¯å™¨ï¼Œä»¥é™ä½å› ç‚ºæŒ‡ä»¤è·³è½‰å¸¶ä¾†çš„åˆ†æ”¯ä¸‹é™ï¼š</p><pre>#define likely(x) __builtin_exp ect(!!(x), 1)#define unlikely(x) __builtin_exp ect(!!(x), 0)</pre><p>GCCçš„å…§å»ºæ–¹æ³•æœƒåˆ¤æ–· EXP == C æ˜¯å¦æˆç«‹ï¼Œæˆç«‹å‰‡å°‡ifåˆ†æ”¯ä¸­çš„åŸ·è¡Œèªå¥ç·Šè·Ÿæ”¾åœ¨å½™ç·¨è·³è½‰æŒ‡ä»¤ä¹‹å¾Œï¼Œå¦å‰‡å°‡elseåˆ†æ”¯ä¸­çš„åŸ·è¡Œèªå¥ç·Šè·Ÿå½™ç·¨è·³è½‰æŒ‡ä»¤ä¹‹å¾Œã€‚</p><p>é€™æ¨£cacheåœ¨é å–æ•¸æ“šæ™‚å°±å¯ä»¥å°‡åˆ†æ”¯å¾Œçš„åŸ·è¡Œèªå¥æ”¾åœ¨cacheä¸­ï¼Œæé«˜cacheçš„å‘½ä¸­ç‡ã€‚</p><h1 class=pgc-h-arrow-right>ALIGNå°é½Šå®</h1><p>å°é½Šæ˜¯æ¡ç”¨ä¸Šå°é½Šçš„æ–¹å¼ï¼Œä¾‹å¦‚0x123ä»¥16å°é½Šï¼Œçµæœæ˜¯0x130ï¼Œå› ç‚ºå°é½Šå¸¸åœ¨åˆ†é…å…§å­˜æ™‚ä½¿ç”¨ï¼Œæ‰€ä»¥åˆ†é…çš„è¦æ¯”éœ€è¦çš„å¤§ã€‚</p><pre>#define ALIGN(x, a) __ALIGN_KERNEL((x), (a))#define __ALIGN_KERNEL(x, a) __ALIGN_KERNEL_MASK(x, (typeof(x))(a) - 1)#define __ALIGN_KERNEL_MASK(x, mask) (((x) + (mask)) &amp; ~(mask))#define __ALIGN_MASK(x, mask) __ALIGN_KERNEL_MASK((x), (mask))</pre><h1 class=pgc-h-arrow-right>__get_unaligned_le(ptr)å®</h1><p>ç²å–æœªå°é½Šçš„æ•¸æ“šï¼Œä¸»è¦æ˜¯è­˜åˆ¥æ•¸æ“šå¤§å°ï¼š</p><pre>#define __get_unaligned_le(ptr) ((__force typeof(*(ptr)))({ \    __builtin_choose_expr(sizeof(*(ptr)) == 1, *(ptr), \    __builtin_choose_expr(sizeof(*(ptr)) == 2, get_unaligned_le16((ptr)), \    __builtin_choose_expr(sizeof(*(ptr)) == 4, get_unaligned_le32((ptr)), \    __builtin_choose_expr(sizeof(*(ptr)) == 8, get_unaligned_le64((ptr)), \    __bad_unaligned_access_size())))); \ }))  static inline u32 get_unaligned_be32(const void *p){    return __get_unaligned_cpu32((const u8 *)p);} static inline u32 __get_unaligned_cpu32(const void *p){    const struct __una_u32 *ptr = (const struct __una_u32 *)p;    return ptr-&gt;x;} struct __una_u16 { u16 x; } __packed;struct __una_u32 { u32 x; } __packed;struct __una_u64 { u64 x; } __packed;</pre><p>ç·¨è­¯å™¨é»˜èªæœƒå°çµæ§‹é«”æ¡ç”¨å­—ç¯€å°é½Šçš„æ–¹å¼ï¼Œ__packedé—œéµå­—å¯ä»¥å–æ¶ˆå­—ç¯€å°é½Šï¼Œæ¡ç”¨1å­—ç¯€å°é½Šã€‚</p><h1 class=pgc-h-arrow-right>__put_unaligned_leå®</h1><p>å¯«å…¥æœªå°é½Šçš„æ•¸æ“šã€‚</p><pre>#define __put_unaligned_le(val, ptr) ({ \    void *__gu_p = (ptr); \    switch (sizeof(*(ptr))) { \    case 1: \        *(u8 *)__gu_p = (__force u8)(val); \        break; \    case 2: \        put_unaligned_le16((__force u16)(val), __gu_p); \        break; \    case 4: \        put_unaligned_le32((__force u32)(val), __gu_p); \        break; \    case 8: \        put_unaligned_le64((__force u64)(val), __gu_p); \        break; \    default: \        __bad_unaligned_access_size(); \        break; \    } \    (void)0; })  static inline void put_unaligned_be32(u32 val, void *p){    __put_unaligned_cpu32(val, p);} static inline void __put_unaligned_cpu32(u32 val, void *p){    struct __una_u32 *ptr = (struct __una_u32 *)p;    ptr-&gt;x = val;}</pre><h1 class=pgc-h-arrow-right>ACCESS_ONCE å®</h1><p>è¨ªå•ç›®æ¨™åœ°å€ä¸€æ¬¡ï¼Œå…ˆå–å¾—xçš„åœ°å€ï¼Œç„¶å¾ŒæŠŠé€™å€‹åœ°å€è½‰æ›æˆä¸€å€‹æŒ‡å‘é€™å€‹åœ°å€é¡å‹çš„æŒ‡é‡ï¼Œç„¶å¾Œå†å–å¾—é€™å€‹æŒ‡é‡æ‰€æŒ‡å‘çš„å…§å®¹ï¼Œé”åˆ°äº†è¨ªå•ä¸€æ¬¡çš„ç›®çš„ã€‚volatileè¡¨ç¤ºä¸é€²è¡Œå„ªåŒ–ï¼Œå¼·åˆ¶è¨ªå•ä¸€æ¬¡ã€‚</p><p>åœ¨ä¸€äº›ä½µç™¼çš„å ´æ™¯ä¸­å°è®Šé‡é€²è¡Œå„ªåŒ–æœ‰å¯èƒ½å°è‡´éŒ¯èª¤ï¼Œéœ€è¦æ™‚åˆ»å¾—åˆ°è®Šé‡çš„æœ€æ–°å€¼ï¼Œæ‰€ä»¥ç”¨volatileå¼·åˆ¶è¨ªå•ä¸€æ¬¡é€²è¡Œæ›´æ–°ã€‚</p><p>ä½¿ç”¨ ACCESS_ONCE() çš„å…©å€‹æ¢ä»¶æ˜¯ï¼š</p><ul><li>åœ¨ç„¡é–çš„æƒ…æ³ä¸‹è¨ªå•å…¨å±€è®Šé‡</li><li>å°è©²è®Šé‡çš„è¨ªå•å¯èƒ½è¢«ç·¨è­¯å™¨å„ªåŒ–æˆåˆä½µæˆä¸€æ¬¡æˆ–è€…æ‹†åˆ†æˆå¤šæ¬¡</li></ul><pre>#define ACCESS_ONCE(x) (*(volatile typeof(x) *)&amp;(x))</pre><p>https://blog.csdn.net/ganggexiongqi/article/details/24603363</p><h1 class=pgc-h-arrow-right>ACCESS_OKå®</h1><p>CVE-2017-5123ï¼ˆwaitidç³»çµ±èª¿ç”¨ï¼‰,æª¢æŸ¥æŒ‡é‡æ˜¯ä¸æ˜¯å±¬æ–¼ç”¨æˆ¶ç©ºé–“çš„ï¼Œx86æ¶æ§‹ä¸‹ACCESS_OKå®çš„å¯¦ç¾ï¼š</p><pre>/** * access_ok: - Checks if a user space pointer is valid * @addr: User space pointer to start of block to check * @size: Size of block to check * * Context: User context only. This function may sleep if pagefaults are * enabled. * * Checks if a pointer to a block of memory in user space is valid. * * Returns true (nonzero) if the memory block may be valid, false (zero) * if it is definitely invalid. * * Note that, depending on architecture, this function probably just * checks that the pointer is in the user space range - after calling * this function, memory access functions may still return -EFAULT. */#define access_ok(addr, size) \({ \    WARN_ON_IN_IRQ(); \    likely(!__range_not_ok(addr, size, user_addr_max())); \})/*__range_not_okè¿”å›0æ‰èƒ½é©—è­‰é€šé #define __range_not_ok(addr, size, limit) \({ \    __chk_user_ptr(addr); \    __chk_range_not_ok((unsigned long __force)(addr), size, limit); \}) /* * Test whether a block of memory is a valid user space address. * Returns 0 if the range is valid, nonzero otherwise. */static inline bool __chk_range_not_ok(unsigned long addr, unsigned long size, unsigned long limit){    /*     * If we have used &#34;sizeof()&#34; for the size,     * we know it won&#39;t overflow the limit (but     * it might overflow the &#39;addr&#39;, so it&#39;s     * important to subtract the size from the     * limit, not add it to the address).     */    if (__builtin_constant_p(size))        return unlikely(addr &gt; limit - size);    /*__builtin_constant_påˆ¤æ–·ç·¨è­¯æ™‚æ˜¯å¦ç‚ºå¸¸æ•¸ï¼Œå¦‚æœæ˜¯å‰‡è¿”å›1 */    /* Arbitrary sizes? Be careful about overflow */    addr += size;    if (unlikely(addr &lt; size))        return true;    return unlikely(addr &gt; limit);}</pre><h1 class=pgc-h-arrow-right>mdelayå®</h1><p>å¿™ç­‰å¾…å‡½æ•¸ï¼Œåœ¨å»¶é²éç¨‹ä¸­ç„¡æ³•é‹è¡Œå…¶ä»–ä»»å‹™ï¼Œæœƒä½”ç”¨CPUæ™‚é–“ï¼Œå»¶é²æ™‚é–“æ˜¯æº–ç¢ºçš„ã€‚</p><p>msleepæ˜¯ä¼‘çœ å‡½æ•¸ï¼Œå®ƒä¸æ¶‰åŠå¿™ç­‰å¾…ï¼ç”¨msleepï¼ˆ200ï¼‰çš„æ™‚å€™å¯¦éš›ä¸Šå»¶é²çš„æ™‚é–“ï¼Œå¤§éƒ¨åˆ†æ™‚å€™æ˜¯è¦å¤šæ–¼200msï¼Œæ˜¯å€‹ä¸å®šçš„æ™‚é–“å€¼ã€‚</p><pre>#define MAX_UDELAY_MS 5#define mdelay(n) (\ /*å»¶é²æ¯«ç§’ç´š*/    (__builtin_constant_p(n) &amp;&amp; (n)&lt;=MAX_UDELAY_MS) ? udelay((n)*1000) : \    ({unsigned long __ms=(n); while (__ms--) udelay(1000);})) static void udelay(int loops) /*å»¶é²å¾®ç§’ç´š */{    while (loops--)        io_delay(); /* Approximately 1 us */} static inline void io_delay(void){    const u16 DELAY_PORT = 0x80;    asm volatile(&#34;outb %%al,%0&#34; : : &#34;dN&#34; (DELAY_PORT));}/*å° I/O ç«¯å£ 0x80 å¯«å…¥ä»»ä½•çš„å­—ç¯€éƒ½å°‡å¾—åˆ° 1 us çš„å»¶æ™‚*/</pre><h3 class=pgc-h-arrow-right>ç³»çµ±èª¿ç”¨å®</h3><p>linux å…§æ ¸ä¸­æœ€å¸¸è¦‹çš„å®ä½¿ç”¨ä¹‹ä¸€ï¼Œç³»çµ±èª¿ç”¨ï¼š</p><pre>#define SYSCALL_DEFINE1(name, ...) SYSCALL_DEFINEx(1, _##name, __VA_ARGS__)#define SYSCALL_DEFINE2(name, ...) SYSCALL_DEFINEx(2, _##name, __VA_ARGS__)#define SYSCALL_DEFINE3(name, ...) SYSCALL_DEFINEx(3, _##name, __VA_ARGS__)#define SYSCALL_DEFINE4(name, ...) SYSCALL_DEFINEx(4, _##name, __VA_ARGS__)#define SYSCALL_DEFINE5(name, ...) SYSCALL_DEFINEx(5, _##name, __VA_ARGS__)#define SYSCALL_DEFINE6(name, ...) SYSCALL_DEFINEx(6, _##name, __VA_ARGS__)/*â€¦ï¼šçœç•¥è™Ÿä»£è¡¨å¯è®Šçš„éƒ¨åˆ†ï¼Œç”¨__VA_AEGS__ ä»£è¡¨çœç•¥çš„è®Šé•·éƒ¨åˆ†*/#define SYSCALL_DEFINE_MAXARGS    6  /*ç³»çµ±èª¿ç”¨æœ€å¤šå¯ä»¥å¸¶6å€‹åƒæ•¸*/</pre><p>ä»¥openç³»çµ±èª¿ç”¨ç‚ºä¾‹ï¼š</p><p>SYSCALL_DEFINE</p><p>å¾Œé¢è·Ÿç³»çµ±èª¿ç”¨æ‰€å¸¶çš„åƒæ•¸å€‹æ•¸nï¼Œç¬¬ä¸€å€‹åƒæ•¸ç‚ºç³»çµ±èª¿ç”¨çš„åå­—ï¼Œç„¶å¾Œæ¥2*nå€‹åƒæ•¸ï¼Œæ¯ä¸€å°æŒ‡æ˜ç³»çµ±èª¿ç”¨çš„åƒæ•¸é¡å‹åŠåå­—ã€‚</p><pre>SYSCALL_DEFINE3(open, const char __user *, filename, int, flags, umode_t, mode){    if (force_o_largefile())        flags |= O_LARGEFILE;     return do_sys_open(AT_FDCWD, filename, flags, mode);}SYSCALL_DEFINE3(open, const char __user *, filename, int, flags, umode_t, mode)å±•é–‹ä¹‹å¾Œæ˜¯ï¼šSYSCALL_DEFINEx(3, _open, __VA_ARGS__)</pre><p>å†æ¬¡å±•é–‹ç‚ºï¼š</p><pre>__SYSCALL_DEFINEx(3, _open, __VA_ARGS__)#define __SYSCALL_DEFINEx(x, name, ...) \    asmlinkage long sys##name(__MAP(x,__SC_DECL,__VA_ARGS__)) \</pre><p>æœ€å¾Œå±•é–‹ç‚ºï¼š</p><pre>asmlinkage long sys_open(__MAP(3,__SC_DECL,__VA_ARGS__)) #define __MAP0(m,...)#define __MAP1(m,t,a) m(t,a)#define __MAP2(m,t,a,...) m(t,a), __MAP1(m,__VA_ARGS__)#define __MAP3(m,t,a,...) m(t,a), __MAP2(m,__VA_ARGS__)#define __MAP4(m,t,a,...) m(t,a), __MAP3(m,__VA_ARGS__)#define __MAP5(m,t,a,...) m(t,a), __MAP4(m,__VA_ARGS__)#define __MAP6(m,t,a,...) m(t,a), __MAP5(m,__VA_ARGS__)#define __MAP(n,...) __MAP##n(__VA_ARGS__) #define __SC_DECL(t, a) t a __MAP(3,__SC_DECL,__VA_ARGS__)--&gt;__MAP3(__SC_DECL,const char __user *, filename, int, flags, umode_t, mode)--&gt;__SC_DECL(const char __user *, filename), __MAP2(__SC_DECL,__VA_ARGS__)--&gt;const char __user * filename,__SC_DECL(int, flags),__MAP1(__SC_DECL,__VA_ARGS__)--&gt;const char __user * filename, int flags, __SC_DECL(umode_t, mode)--&gt;const char __user * filename, int flags, umode_t mode</pre><p>æœ€å¾Œèª¿ç”¨asmlinkage long sys_open(const char __user *filename,int flags, umode_t mode);</p><p>ç‚ºä»€éº¼è¦å°‡ç³»çµ±èª¿ç”¨å®šç¾©æˆå®ï¼ŸCVE-2009-0029ï¼ŒCVE-2010-3301ï¼ŒLinux 2.6.28åŠä»¥å‰ç‰ˆæœ¬çš„å…§æ ¸ä¸­ï¼Œå°‡ç³»çµ±èª¿ç”¨ä¸­32ä½åƒæ•¸å‚³å…¥64ä½çš„å¯„å­˜å™¨æ™‚ç„¡æ³•ä½œç¬¦è™Ÿæ“´å±•ï¼Œå¯èƒ½å°è‡´ç³»çµ±å´©æ½°æˆ–ææ¬Šæ¼æ´ã€‚</p><p>å…§æ ¸é–‹ç™¼è€…é€šéå°‡ç³»çµ±èª¿ç”¨çš„æ‰€æœ‰è¼¸å…¥åƒæ•¸éƒ½å…ˆè½‰åŒ–æˆlongé¡å‹ï¼ˆ64ä½ï¼‰ï¼Œå†å¼·åˆ¶è½‰åŒ–åˆ°ç›¸æ‡‰çš„é¡å‹ä¾†è¦é¿é€™å€‹æ¼æ´ã€‚</p><pre>asmlinkage long __se_sys##name(__MAP(x,__SC_LONG,__VA_ARGS__)) \{ \        long ret = __do_sys##name(__MAP(x,__SC_CAST,__VA_ARGS__));\        __MAP(x,__SC_TEST,__VA_ARGS__); \        __PROTECT(x, ret,__MAP(x,__SC_ARGS,__VA_ARGS__)); \        return ret; \} \  #define __TYPE_AS(t, v) __same_type((__force t)0, v) /*åˆ¤æ–·tå’Œvæ˜¯å¦æ˜¯åŒä¸€å€‹é¡å‹*/#define __TYPE_IS_L(t) (__TYPE_AS(t, 0L)) /*åˆ¤æ–·tæ˜¯å¦æ˜¯long é¡å‹,æ˜¯è¿”å›1*/#define __TYPE_IS_UL(t) (__TYPE_AS(t, 0UL)) /*åˆ¤æ–·tæ˜¯å¦æ˜¯unsigned long é¡å‹,æ˜¯è¿”å›1*/#define __TYPE_IS_LL(t) (__TYPE_AS(t, 0LL) || __TYPE_AS(t, 0ULL))/*æ˜¯longé¡å‹å°±è¿”å›1*/#define __SC_LONG(t, a) __typeof(__builtin_choose_expr(__TYPE_IS_LL(t), 0LL, 0L)) a/*å°‡åƒæ•¸è½‰æ›æˆlongé¡å‹*/#define __SC_CAST(t, a) (__force t) a /*è½‰æˆæˆåŸä¾†çš„é¡å‹*/# define __force __attribute__((force))</pre><p>è¡¨ç¤ºæ‰€å®šç¾©çš„è®Šé‡é¡å‹å¯ä»¥åšå¼·åˆ¶é¡å‹è½‰æ›</p><h1 class=pgc-h-arrow-right>barrier()å®</h1><p>å…§å­˜å±éšœï¼Œè©²èªå¥ä¸ç”¢ç”Ÿä»»ä½•ä»£ç¢¼ï¼Œä½†æ˜¯åŸ·è¡Œå¾Œåˆ·æ–°å¯„å­˜å™¨å°è®Šé‡çš„åˆ†é…ã€‚</p><pre>/* Optimization barrier *//* The &#34;volatile&#34; is due to gcc bugs */#define barrier() __asm__ __volatile__(&#34;&#34;: : :&#34;memory&#34;)</pre><p>åŸ·è¡Œè©²èªå¥å¾Œcpuä¸­çš„å¯„å­˜å™¨å’Œcacheä¸­å·²ç·©å­˜çš„æ•¸æ“šå°‡ä½œå»¢ï¼Œé‡æ–°è®€å–å…§å­˜ä¸­çš„æ•¸æ“šã€‚é€™å°±é˜»æ­¢äº†cpuå°‡å¯„å­˜å™¨å’Œcacheä¸­çš„æ•¸æ“šç”¨æ–¼å»å„ªåŒ–æŒ‡ä»¤ï¼Œè€Œé¿å…å»è¨ªå•å…§å­˜ã€‚ä¾‹å¦‚ï¼š</p><pre>int a = 5, b = 6;barrier();a = b;</pre><p>ç¬¬ä¸‰è¡Œä¸­ï¼ŒGCCä¸æœƒç”¨å­˜æ”¾bçš„å¯„å­˜å™¨çµ¦aè³¦å€¼ï¼Œè€Œæ˜¯invalidate b çš„cache lineï¼Œé‡æ–°è®€å–å…§å­˜ä¸­çš„bå€¼çµ¦aè³¦å€¼ã€‚</p><p>å¦å¤–çš„å…§å­˜å±éšœå®å®šç¾©ï¼š</p><ul><li>mfenceï¼šåœ¨mfenceæŒ‡ä»¤å‰çš„è®€å¯«æ“ä½œç•¶å¿…é ˆåœ¨mfenceæŒ‡ä»¤å¾Œçš„è®€å¯«æ“ä½œå‰å®Œæˆã€‚</li><li>lfenceï¼šåœ¨lfenceæŒ‡ä»¤å‰çš„è®€æ“ä½œç•¶å¿…é ˆåœ¨lfenceæŒ‡ä»¤å¾Œçš„è®€æ“ä½œå‰å®Œæˆï¼Œä¸å½±éŸ¿å¯«æ“ä½œ</li><li>sfenceï¼šåœ¨sfenceæŒ‡ä»¤å‰çš„å¯«æ“ä½œç•¶å¿…é ˆåœ¨sfenceæŒ‡ä»¤å¾Œçš„å¯«æ“ä½œå‰å®Œæˆï¼Œä¸å½±éŸ¿è®€æ“ä½œ</li><li>lock å‰ç¶´ï¼ˆæˆ–cpuidã€xchgç­‰æŒ‡ä»¤ï¼‰ä½¿å¾—æœ¬CPUçš„Cacheå¯«å…¥å…§å­˜ï¼Œè©²å¯«å…¥å‹•ä½œä¹Ÿæœƒå¼•èµ·åˆ¥çš„CPU invalidateå…¶Cacheã€‚ç”¨ä¾†ä¿®é£¾ç•¶å‰æŒ‡ä»¤æ“ä½œçš„å…§å­˜åªèƒ½ç”±ç•¶å‰CPUä½¿ç”¨</li></ul><p>å…§å­˜å°æ–¼ç·©å­˜æ›´æ–°ç­–ç•¥ï¼Œè¦å€åˆ†Write-Throughå’ŒWrite-Backå…©ç¨®ç­–ç•¥ã€‚å‰è€…æ›´æ–°å…§å®¹ç›´æ¥å¯«å…§å­˜ä¸¦ä¸åŒæ™‚æ›´æ–°Cacheï¼Œä½†è¦ç½®Cacheå¤±æ•ˆï¼Œå¾Œè€…å…ˆæ›´æ–°Cacheï¼Œéš¨å¾Œç•°æ­¥æ›´æ–°å…§å­˜ã€‚é€šå¸¸X86 CPUæ›´æ–°å…§å­˜éƒ½ä½¿ç”¨Write-Backç­–ç•¥ã€‚</p><h1 class=pgc-h-arrow-right>#ifdef ASSEMBLYå®</h1><p>ä¸€äº›å¸¸é‡å®åŒæ™‚åœ¨å½™ç·¨å’ŒCä¸­ä½¿ç”¨ï¼Œç„¶è€Œï¼Œæˆ‘å€‘ä¸èƒ½åƒè¨»é‡‹Cçš„å¸¸é‡å®é‚£æ¨£åŠ ä¸€å€‹â€œULâ€æˆ–å…¶ä»–å¾Œç¶´ã€‚æ‰€ä»¥æˆ‘å€‘éœ€è¦ä½¿ç”¨ä»¥ä¸‹çš„å®è§£æ±ºé€™å€‹å•é¡Œã€‚</p><p>ä¾‹å¦‚èª¿ç”¨ï¼š#define DEMO_MACRO _AT(1ï¼Œ UL)ï¼šåœ¨Cä¸­æœƒè¢«è§£é‡‹ç‚º #define DEMO_MACRO 1ULï¼› è€Œåœ¨å½™ç·¨ä¸­ä»€éº¼éƒ½ä¸åšï¼Œå°±æ˜¯ï¼š#define DEMO_MACRO 1</p><pre>#ifdef __ASSEMBLY__#define _AC(X,Y) X#define _AT(T,X) X#else#define __AC(X,Y) (X##Y)#define _AC(X,Y) __AC(X,Y)#define _AT(T,X) ((T)(X))#endif #define _UL(x) (_AC(x, UL))#define _ULL(x) (_AC(x, ULL))</pre><h1 class=pgc-h-arrow-right>force_o_largefileå®</h1><p>åˆ¤æ–·æ˜¯å¦æ”¯æŒå¤§æ–‡ä»¶ã€‚</p><p>#define force_o_largefile()<br>(personality(current->personality) != PER_LINUX32)</p><p>PER_LINUX32 = 0x0008, PER_MASK = 0x00ff, /*ï¼Œ</p><ul><li>Return the base personality without flags. */ #define personality(pers) (pers & PER_MASK)</li></ul><p>é‚è¼¯åœ°å€å’Œç‰©ç†åœ°å€äº’ç›¸è½‰æ›</p><pre>#define __pa(x) __virt_to_phys((unsigned long)(x))#define __va(x) ((void *)__phys_to_virt((unsigned long)(x)))</pre><h1 class=pgc-h-arrow-right>éŒ¯èª¤ç¢¼ç›¸é—œçš„å®</h1><p>linux å…§æ ¸çš„ä¸€äº›éŒ¯èª¤ç¢¼ï¼Œä»¥å®ƒå€‘çš„è² æ•¸ä¾†ä½œç‚ºå‡½æ•¸è¿”å›å€¼ï¼Œç°¡å–®åœ°ä½¿ç”¨å¤§æ–¼ç­‰æ–¼-4095çš„è™›æ“¬åœ°å€ä¾†åˆ†åˆ¥è¡¨ç¤ºç›¸æ‡‰çš„éŒ¯èª¤ç¢¼ã€‚</p><p>åœ¨32ä½ç³»çµ±ä¸Šï¼Œ-4095è½‰æ›æˆunsigned longé¡å‹çš„å€¼ç‚º0xFFFFF001ï¼Œä¹Ÿå°±æ˜¯èªªåœ°å€å€é–“[0xFFFFF001, 0xFFFFFFFF]è¢«åˆ†åˆ¥ç”¨ä¾†è¡¨ç¤ºéŒ¯èª¤ç¢¼å¾-4095åˆ°-1ã€‚</p><p>åˆ¤æ–·ä¸€å€‹å‡½æ•¸è¿”å›çš„æŒ‡é‡åˆ°åº•æ˜¯æœ‰æ•ˆåœ°å€é‚„æ˜¯éŒ¯èª¤ç¢¼ï¼š</p><pre>#define MAX_ERRNO 4095 #define IS_ERR_VALUE(x) unlikely((x) &gt;= (unsigned long)-MAX_ERRNO) static inline long __must_check IS_ERR(const void *ptr){    return IS_ERR_VALUE((unsigned long)ptr);}</pre><p>éŒ¯èª¤ç¢¼èˆ‡ç›¸æ‡‰åœ°å€çš„äº’æ›ï¼š</p><pre>static inline void * __must_check ERR_PTR(long error){    return (void *) error;}</pre><p>é•·æ•´å‹è½‰åŒ–ç‚ºæŒ‡é‡</p><pre>static inline long __must_check PTR_ERR(const void *ptr){    return (long) ptr;}</pre><p>æŒ‡é‡è½‰åŒ–ç‚ºé•·æ•´å‹</p><h1 class=pgc-h-arrow-right>é¡å¤–æœ‰æ„æ€çš„å®</h1><p>éæ­¸å®ï¼Œé¡›å€’å­—ç¯€ï¼š</p><pre>#define BSWAP_8(x) ((x) &amp; 0xff)#define BSWAP_16(x) ((BSWAP_8(x) &lt;&lt; 8) | BSWAP_8((x) &gt;&gt; 8))#define BSWAP_32(x) ((BSWAP_16(x) &lt;&lt; 16) | BSWAP_16((x) &gt;&gt; 16))#define BSWAP_64(x) ((BSWAP_32(x) &lt;&lt; 32) | BSWAP_32((x) &gt;&gt; 32))</pre><p>äº¤æ›å®ï¼Œä¸éœ€è¦é¡å¤–å®šç¾©è®Šé‡</p><pre>#define swap(a, b) \(((a) ^= (b)), ((b) ^= (a)), ((a) ^= (b)))</pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Linux</a></li><li><a>kernel</a></li><li><a>ä¸­å¸¸</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/c59c4d5.html alt="Linux kernelçš„ä¸­æ–·å­ç³»çµ±ä¹‹ï¼ˆä¸€ï¼‰ï¼šç¶œè¿°" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/02dc0d76247f44929c552cb097f9e3a0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c59c4d5.html title="Linux kernelçš„ä¸­æ–·å­ç³»çµ±ä¹‹ï¼ˆä¸€ï¼‰ï¼šç¶œè¿°">Linux kernelçš„ä¸­æ–·å­ç³»çµ±ä¹‹ï¼ˆä¸€ï¼‰ï¼šç¶œè¿°</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/95bc1c3b.html alt=æ–½å·¥ä¸­å¸¸è¦‹8ç¨®é‹¼ç­‹åˆ†é¡ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ee33c2f5893849fbb7ed9dd98f7cba72 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/95bc1c3b.html title=æ–½å·¥ä¸­å¸¸è¦‹8ç¨®é‹¼ç­‹åˆ†é¡>æ–½å·¥ä¸­å¸¸è¦‹8ç¨®é‹¼ç­‹åˆ†é¡</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b15bfb03.html alt=æ–½å·¥ä¸­å¸¸è¦‹çš„é‹¼ç­‹ä½ éœ€è¦çŸ¥é“çš„çŸ¥è­˜ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e912e61511874e9db8e79597811ebabd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b15bfb03.html title=æ–½å·¥ä¸­å¸¸è¦‹çš„é‹¼ç­‹ä½ éœ€è¦çŸ¥é“çš„çŸ¥è­˜>æ–½å·¥ä¸­å¸¸è¦‹çš„é‹¼ç­‹ä½ éœ€è¦çŸ¥é“çš„çŸ¥è­˜</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/286d1d05.html alt=Linuxæ€éº¼æ¨£ç·¨è­¯cç¨‹åºæ–‡ä»¶(ç·¨è­¯æœ€æ–°ç‰ˆffmpegç‚ºä¾‹) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/67e5890abdc3408c9e6e28c61ce6c847 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/286d1d05.html title=Linuxæ€éº¼æ¨£ç·¨è­¯cç¨‹åºæ–‡ä»¶(ç·¨è­¯æœ€æ–°ç‰ˆffmpegç‚ºä¾‹)>Linuxæ€éº¼æ¨£ç·¨è­¯cç¨‹åºæ–‡ä»¶(ç·¨è­¯æœ€æ–°ç‰ˆffmpegç‚ºä¾‹)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/61d128bc.html alt=å²©åœŸå·¥ç¨‹ä¸­å¸¸è¦‹çš„â€œå•é¡ŒåœŸâ€ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8803daf3aacd493fb1c4c99d8aebda28 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/61d128bc.html title=å²©åœŸå·¥ç¨‹ä¸­å¸¸è¦‹çš„â€œå•é¡ŒåœŸâ€>å²©åœŸå·¥ç¨‹ä¸­å¸¸è¦‹çš„â€œå•é¡ŒåœŸâ€</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7e4b1039.html alt=Linuxç”¨æˆ¶ã€ç”¨æˆ¶çµ„èˆ‡æ–‡æª”å±¬æ€§ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/54f39d7a23d64846b3fee43d438f13bb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7e4b1039.html title=Linuxç”¨æˆ¶ã€ç”¨æˆ¶çµ„èˆ‡æ–‡æª”å±¬æ€§>Linuxç”¨æˆ¶ã€ç”¨æˆ¶çµ„èˆ‡æ–‡æª”å±¬æ€§</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bcacd8fd.html alt=Linuxç³»çµ±â€”â€”ç”¨æˆ¶ã€ç”¨æˆ¶çµ„ã€æ¬Šé™å’Œæ–‡ä»¶å±¬æ€§ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bcacd8fd.html title=Linuxç³»çµ±â€”â€”ç”¨æˆ¶ã€ç”¨æˆ¶çµ„ã€æ¬Šé™å’Œæ–‡ä»¶å±¬æ€§>Linuxç³»çµ±â€”â€”ç”¨æˆ¶ã€ç”¨æˆ¶çµ„ã€æ¬Šé™å’Œæ–‡ä»¶å±¬æ€§</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dad48786.html alt=Linuxä½µç™¼æœå‹™å™¨æ¨¡å‹ä¸€ã€å¤šé€²ç¨‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dad48786.html title=Linuxä½µç™¼æœå‹™å™¨æ¨¡å‹ä¸€ã€å¤šé€²ç¨‹>Linuxä½µç™¼æœå‹™å™¨æ¨¡å‹ä¸€ã€å¤šé€²ç¨‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e1360dd4.html alt=ã€ŒLinuxã€é«˜ä½µç™¼æœå‹™å™¨æ¨¡å‹ï¼ˆå¤šé€²ç¨‹å’Œå¤šç·šç¨‹å¯¦ä¾‹æ¨¡å‹ï¼‰ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/170e1596c32348f39d6ace1f327e45d5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e1360dd4.html title=ã€ŒLinuxã€é«˜ä½µç™¼æœå‹™å™¨æ¨¡å‹ï¼ˆå¤šé€²ç¨‹å’Œå¤šç·šç¨‹å¯¦ä¾‹æ¨¡å‹ï¼‰>ã€ŒLinuxã€é«˜ä½µç™¼æœå‹™å™¨æ¨¡å‹ï¼ˆå¤šé€²ç¨‹å’Œå¤šç·šç¨‹å¯¦ä¾‹æ¨¡å‹ï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2806cf4d.html alt=åµŒå…¥å¼Linuxç·¨ç¨‹â€”â€”ç¨‹åºå“¡å°ç™½ä¸æ‡‚çš„é€²ç¨‹ã€ä¿¡è™Ÿé‡ã€ä½µç™¼ã€äº’æ–¥ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6fea5f2744614de3884ab26fa09e5a40 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2806cf4d.html title=åµŒå…¥å¼Linuxç·¨ç¨‹â€”â€”ç¨‹åºå“¡å°ç™½ä¸æ‡‚çš„é€²ç¨‹ã€ä¿¡è™Ÿé‡ã€ä½µç™¼ã€äº’æ–¥>åµŒå…¥å¼Linuxç·¨ç¨‹â€”â€”ç¨‹åºå“¡å°ç™½ä¸æ‡‚çš„é€²ç¨‹ã€ä¿¡è™Ÿé‡ã€ä½µç™¼ã€äº’æ–¥</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d3d9f3d8.html alt=ææ‡‚Linuxå…§å­˜ç®¡ç†ï¼Œåƒ…æ­¤ä¸€ç¯‡ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/0ae3e7cee0234c4cb9cdef0039d2c4d0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d3d9f3d8.html title=ææ‡‚Linuxå…§å­˜ç®¡ç†ï¼Œåƒ…æ­¤ä¸€ç¯‡>ææ‡‚Linuxå…§å­˜ç®¡ç†ï¼Œåƒ…æ­¤ä¸€ç¯‡</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/838d476c.html alt=Linuxå…§æ ¸çš„æ•´é«”æ¶æ§‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a7aaf296a7c14809b8c0ce535a02205d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/838d476c.html title=Linuxå…§æ ¸çš„æ•´é«”æ¶æ§‹>Linuxå…§æ ¸çš„æ•´é«”æ¶æ§‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7102c077.html alt=ä»€éº¼Linuxï¼ŒLinuxå…§æ ¸åŠLinuxæ“ä½œç³»çµ±ï¼Œæ•´é«”æ¶æ§‹ä»‹ç´¹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/af09f220163b49399261735b49fe1790 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7102c077.html title=ä»€éº¼Linuxï¼ŒLinuxå…§æ ¸åŠLinuxæ“ä½œç³»çµ±ï¼Œæ•´é«”æ¶æ§‹ä»‹ç´¹>ä»€éº¼Linuxï¼ŒLinuxå…§æ ¸åŠLinuxæ“ä½œç³»çµ±ï¼Œæ•´é«”æ¶æ§‹ä»‹ç´¹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7e66a0e7.html alt=Linuxç¶²çµ¡ç·¨ç¨‹â€”â€”UDPå»£æ’­è©³è§£ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a2667182b3d34b2e98e8503a00af90fd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7e66a0e7.html title=Linuxç¶²çµ¡ç·¨ç¨‹â€”â€”UDPå»£æ’­è©³è§£>Linuxç¶²çµ¡ç·¨ç¨‹â€”â€”UDPå»£æ’­è©³è§£</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6b48b90b.html alt=Linuxç³»çµ±å¸¸ç”¨å‘½ä»¤å¤§å…¨ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6b48b90b.html title=Linuxç³»çµ±å¸¸ç”¨å‘½ä»¤å¤§å…¨>Linuxç³»çµ±å¸¸ç”¨å‘½ä»¤å¤§å…¨</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>