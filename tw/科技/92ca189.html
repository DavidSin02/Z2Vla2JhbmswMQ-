<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>HTML5實時語音通話聊天，MP3壓縮傳輸3KB每秒 | 极客快訊</title><meta property="og:title" content="HTML5實時語音通話聊天，MP3壓縮傳輸3KB每秒 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/25a0ddd4db484af5b2d832decfc18d4e"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/92ca189.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/92ca189.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/92ca189.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/92ca189.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/92ca189.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/92ca189.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/92ca189.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/92ca189.html><meta property="article:published_time" content="2020-10-29T21:04:30+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:30+08:00"><meta name=Keywords content><meta name=description content="HTML5實時語音通話聊天，MP3壓縮傳輸3KB每秒"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/92ca189.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>HTML5實時語音通話聊天，MP3壓縮傳輸3KB每秒</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><blockquote><p>自從Recorder H5 GitHub開源庫優化後，對邊錄邊轉碼成小語音片段文件實時上傳服務器這種操作支持非常良好，因此以前不太好支持的H5語音通話已經有了更好的突破空間。因此花了兩晚時間打造了一個H5語音通話聊天的demo。</p><p>歡迎在線把玩：https://xiangyuecn.github.io/Recorder/</p></blockquote><div class=pgc-img><img alt=HTML5實時語音通話聊天，MP3壓縮傳輸3KB每秒 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/25a0ddd4db484af5b2d832decfc18d4e><p class=pgc-img-caption></p></div><h1><strong>一、把玩方法</strong></h1><ol><li>準備局域網內兩臺設備(Peer A、Peer B)用最新版本瀏覽器(demo未適配低版本)分別打開demo頁面（也可以是同一瀏覽器打開兩個標籤）</li><li>勾選頁面中的H5版語音通話聊天，在Peer A中點擊新建連接</li><li>把Peer A的本機信手動複製傳輸給Peer B，粘貼到遠程信息中，並點擊確定連接</li><li>把Peer B自動生成的本機信息手動複製傳輸給Peer A，粘貼到遠程信息中，並點擊確定連接</li><li>雙方P2P連接已建立，使用頁面上方的錄音功能，隨時開啟錄音，音頻數據會實時發送給對方</li></ol><blockquote><p>局域網H5版對講機</p></blockquote><h1><strong>二、技術特性</strong></h1><p><strong>（1）數據傳輸</strong></p><p>github demo中考慮到減少對服務器的依賴，因此採用了WebRTC P2P傳輸功能，無需任何服務器支持即可實現局域網內的兩個設備之間互相連接，連接代碼也算簡單。有服務器支持可能就要逆天了，不過代碼也會更復雜。</p><p>如果正式使用，可能不太會考慮使用WebRTC，用WebSocket通過服務器進行轉發可能是最佳的選擇。</p><p>WebRTC局域網P2P連接要點（實際代碼其實差不多，只不過多做了點兼容）：</p><pre>/******Peer A(本機)******/var peerA=new RTCPeerConnection(null,null)//開啟會話，等待遠程連接peerA.createOffer().then(function(offer){ peerA.setLocalDescription(offer); peerAOffer=offer;});var peerAICEList=[......] //通過peerA.onicecandidate監聽獲得所有的ICE連接信息候選項，如果有多個網絡適配器，就會有多個候選//創建連接通道對象，A端通過這個來進行數據發送var peerAChannel=peerA.createDataChannel("RTC Test");/******Peer B(遠程)******/var peerB=new RTCPeerConnection(null,null)//連接到Peer ApeerB.setRemoteDescription(peerAOffer);//開啟應答會話，等待Peer A確認連接peerB.createAnswer().then(function(answer){ peerB.setLocalDescription(answer); peerBAnswer=answer;});//把Peer A的連接點都添加進去peerB.addIceCandidate(......peerAICEList)var peerBICEList=[......] //通過peerB.onicecandidate監聽獲得所有的ICE連接信息候選項，如果有多個網絡適配器，就會有多個候選var peerBChannel=... //通過peerB.ondatachannel得到連接通道對象，B端通過這個來進行數據發送/*******最終完成連接********///連接到Peer BpeerA.setRemoteDescription(peerBAnswer);//把Peer B的連接點都添加進去peerA.addIceCandidate(......peerBICEList)/*peerA peerB分別等待peerA/BChannel.onopen回調即完成P2P連接，然後通過監聽peerA/BChannel.onmessage獲得對方發送的信息，通過peerA/BChannel.send(data) 發送數據。*/</pre><p><strong>（2）音頻採集和編碼</strong></p><p>由於是在我的Recorder庫中新加的demo，因此音頻採集和編碼都是現成的，Recorder庫有好的兼容性和穩定性，因此節省了最大頭的工作量。</p><p>編碼最佳使用MP3格式，因為此格式已優化了實時編碼性能，可做到邊錄邊轉碼，16kbps 16khz的情況下可做到2kb每秒的文件大小，音質還可以，實時傳輸時為3kb每秒，15分鐘大概3M的流量。</p><p>用wav格式也可以，不過此格式編碼出來的數據量太大，16位 16khz接近50kb每秒的實時傳輸數據，15分鐘要37M多流量。其他格式由於暫未對實時編碼進行優化，使用中會導致明顯卡頓。</p><p>降噪、靜音檢測等高級功能是沒有的，畢竟是非專業人員 要求高點可以，但不要超出範圍太多啦。</p><p><strong>（3）音頻實時接收和播放</strong></p><p>接收到一個音頻片段後，本應該是立即播放的，但由於編碼、網絡傳輸導致的延遲，可能上個片段還未播放完（甚至未開始播放），因此需要緩衝處理。</p><p>因為存在緩衝，就需要進行實時同步處理，如果緩衝內積壓了過多的音頻片段，會導致語音播放滯後太多，因此需要適當進行對數據進行丟棄，實測發現網絡正常、設備性能靠譜的情況下基本沒有丟棄的數據。</p><p>然後就是播放了，本應是播完一個就播下一個，測試發現這是不靠譜的。因為結束一個片段後再開始播放下一個發出聲音，這個過程會中斷比較長時間，明顯感覺得出來中間存在短暫停頓。因此必須在片段未播完時準備好下一個片段的播放，並且提前開始播放，達到抹掉中間的停頓。</p><p>我寫了兩個播放方式：</p><ol><li>實時解碼播放</li><li>雙Audio輪換播放</li></ol><p>最開始用一個Audio停頓感太明顯，因此用兩個Audio輪換抹掉中間的停頓，但發現不同格式Auido播放差異巨大，播放wav非常流暢，但播放mp3還是存在停頓（後面用解碼的發現是得到的PCM時長變長了，導致事件觸發會出現誤差，為什麼會變長？怪異）。</p><p>因此後面寫了一個解碼然後再播放，mp3這次終於能正常連續播放了，wav格式和雙Audio的播放差異不大。實時解碼裡面也用到了雙Audio中的技巧，其實也是用到了兩個BufferSource進行類似的輪換操作，以抹掉兩個片段間的停頓。</p><p>不過最終播放效果還是不夠好，音質變差了點，並且多了點噪音。如果有現成的播放代碼拿過來用就就好了。</p><h1><strong>三、應用場景</strong></h1><ol><li>數據傳輸改成WebSocket，做個仿微信語音通話H5版還是可以的（受限於Recorder瀏覽器支持）</li><li>局域網H5版對講機（前端玩具）</li><li>......沒有想到</li></ol><p><strong>完。</strong></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>HTML5</a></li><li><a>實時</a></li><li><a>語音</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/93ce7858.html alt=實時更新！關閉口岸、封鎖邊境、暫停所有商業航班、禁止入境、強制隔離、近50國進入緊急狀態 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/Rk9jaw1CGxVnCU style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/93ce7858.html title=實時更新！關閉口岸、封鎖邊境、暫停所有商業航班、禁止入境、強制隔離、近50國進入緊急狀態>實時更新！關閉口岸、封鎖邊境、暫停所有商業航班、禁止入境、強制隔離、近50國進入緊急狀態</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a9aae7f8.html alt=超車防剮蹭，高速上如何實時判斷車距？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/S9stoIbFwWKzle style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a9aae7f8.html title=超車防剮蹭，高速上如何實時判斷車距？>超車防剮蹭，高速上如何實時判斷車距？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d5b06822.html alt=基於合成數據的實時三維車輛姿態估計 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e19205cdd518461bbf3e95ca3c3197fe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d5b06822.html title=基於合成數據的實時三維車輛姿態估計>基於合成數據的實時三維車輛姿態估計</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/12a8383c.html alt=實時分析頁面指標，把握轉化「黃金一頁」 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/c968363cd3bd4c3fbe82449dbc96de3c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/12a8383c.html title=實時分析頁面指標，把握轉化「黃金一頁」>實時分析頁面指標，把握轉化「黃金一頁」</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ded90648.html alt=好書推薦：《實時熒光定量PCR（第二版）》 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/5e3c001b4b83ca30fe89 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ded90648.html title=好書推薦：《實時熒光定量PCR（第二版）》>好書推薦：《實時熒光定量PCR（第二版）》</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f6111cec.html alt=實時熒光PCR核酸檢測技術 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f6111cec.html title=實時熒光PCR核酸檢測技術>實時熒光PCR核酸檢測技術</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/73e13b38.html alt="實時熒光定量PCR檢測儀 檢測非洲豬瘟" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4231fc50827647da9693448852e46e16 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/73e13b38.html title="實時熒光定量PCR檢測儀 檢測非洲豬瘟">實時熒光定量PCR檢測儀 檢測非洲豬瘟</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/eeb1da89.html alt=批量提取工作表的名稱，實時動態更新超級簡單！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4f0e611ffd5f4f279f550f0924c5efc3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/eeb1da89.html title=批量提取工作表的名稱，實時動態更新超級簡單！>批量提取工作表的名稱，實時動態更新超級簡單！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7e803abd.html alt=基於FPGA的多通道同步實時高速數據採集系統設計 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RT9ec7T8clHaQI style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7e803abd.html title=基於FPGA的多通道同步實時高速數據採集系統設計>基於FPGA的多通道同步實時高速數據採集系統設計</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ba3e7b82.html alt=口音歧視？語音AI技術的尷尬，卻暗藏社會經濟地位偏見｜深度 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15331723076609bb628c1fc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ba3e7b82.html title=口音歧視？語音AI技術的尷尬，卻暗藏社會經濟地位偏見｜深度>口音歧視？語音AI技術的尷尬，卻暗藏社會經濟地位偏見｜深度</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/39f0548a.html alt=端智能系列文章｜端側複雜事件實時處理框架 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/Rn8ZWA8GHj1SnA style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/39f0548a.html title=端智能系列文章｜端側複雜事件實時處理框架>端智能系列文章｜端側複雜事件實時處理框架</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6447fb0d.html alt="實時媒體制作的智能存儲-Avid NEXIS" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/f355b06382c94693b6fa556fbae9e496 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6447fb0d.html title="實時媒體制作的智能存儲-Avid NEXIS">實時媒體制作的智能存儲-Avid NEXIS</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c50738dc.html alt=劍飛語音寫作，一場自我突破的英雄之旅，編寫自己的人生劇本 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3fc6cb43b003431a864125b06741b7be style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c50738dc.html title=劍飛語音寫作，一場自我突破的英雄之旅，編寫自己的人生劇本>劍飛語音寫作，一場自我突破的英雄之旅，編寫自己的人生劇本</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/60647310.html alt=高速軋機潤滑油品含水率實時檢測系統設計與應用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1529996075380627c34cac2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/60647310.html title=高速軋機潤滑油品含水率實時檢測系統設計與應用>高速軋機潤滑油品含水率實時檢測系統設計與應用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/43d055ac.html alt=實時掌握隧道車流量、停車位數量，還能自動報警！浦東這套交通研判系統不簡單 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c3bba3238e424d338033b5beaa02018b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/43d055ac.html title=實時掌握隧道車流量、停車位數量，還能自動報警！浦東這套交通研判系統不簡單>實時掌握隧道車流量、停車位數量，還能自動報警！浦東這套交通研判系統不簡單</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>