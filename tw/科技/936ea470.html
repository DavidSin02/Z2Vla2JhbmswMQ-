<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>這個單機 1 萬個併發連接問題，程序員做架構設計都避免不了 | 极客快訊</title><meta property="og:title" content="這個單機 1 萬個併發連接問題，程序員做架構設計都避免不了 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/dfic-imagehandler/aa16b3c3-2d99-4de8-b796-650b9366a0cc"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/936ea470.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/936ea470.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/936ea470.html><meta property="article:published_time" content="2020-11-14T21:06:37+08:00"><meta property="article:modified_time" content="2020-11-14T21:06:37+08:00"><meta name=Keywords content><meta name=description content="這個單機 1 萬個併發連接問題，程序員做架構設計都避免不了"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/936ea470.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>這個單機 1 萬個併發連接問題，程序員做架構設計都避免不了</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>來源｜極客時間《賣桃者說》</p><p>編輯｜夏天</p><p>你好，這裡是賣桃者說，今天和你聊一點併發相關的知識。</p><p>在現代互聯網上，大數據和海量用戶應用場景越來越多。你看著街邊的停車位越來越少，車越來越多，開始抱怨社會膨脹了。但這些是肉眼可見的，互聯網數據的發展可比車增加的快多了，而且指數級的。比如新浪微博，整體 HTTP 接口調用量 2018 年到了百萬 QPS 這個量級，視頻吞吐是 TBPS 級別的，與之對應高併發技術也一年年更新換代，層出不窮，涉及到的領域包括編程語言、技術框架和軟硬件性能優化等。</p><p>但是，就像汽車一樣，這些技術也不是憑空出現的，究其根源，我們可以從一個技術名詞 C10K 聊起。</p><div class=pgc-img><img alt="這個單機 1 萬個併發連接問題，程序員做架構設計都避免不了" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/dfic-imagehandler/aa16b3c3-2d99-4de8-b796-650b9366a0cc><p class=pgc-img-caption></p></div><p>在做技術規劃和架構設計的時候，我常常告誡技術人員，不要做過度設計，如果咱們只有 1 萬用戶，先別去操百萬用戶在線的心。淘寶那麼大，也是從 Apache、PHP、MySql 發展起來的，沒人能預見到淘寶會發展到這樣一個規模，一旦發展起來，業務的爆發性增長會驅動技術的迅速發展，在業務規模還不及格的時候，不用為技術的未來擔心。</p><p>這個思路在業務領域不會有太大的問題，因為需求的變化實在是太快了，需要時時去應對。但在底層技術的發展上，我們就有可能遭到“短視”的報復，比如：這個數據長度不會超過 16 位吧，這個程序不可能使用到 2000 年吧。於是就有了千年蟲的問題，也有了 C10K 的問題。</p><p>C10K 就是 Client 10000 問題，即“在同時連接到服務器的客戶端數量超過 10000 個的環境中，即便硬件性能足夠， 依然無法正常提供服務”，簡而言之，就是單機 1 萬個併發連接問題。這個概念最早由 Dan Kegel 提出併發佈於其個人站點。</p><p>為什麼會這樣呢？因為計算機的上古時代，比如沒有網絡的 PC 時代，不會有程序員高瞻遠矚，預測到互聯網時代的來臨，也不會想到一臺服務器會創建那麼多的進程，即使在互聯網初期，一臺服務器能有 100 個在線用戶已經是不得了的事情了。甚至，他們在設計 Unix 的 PID 的時候，採用了有符號的 16 位整數，這就導致一臺計算機上能夠創建出來的進程無法超過 32767 個。而計算機自己也得運行一些後臺進程，這樣應用軟件能夠創建的進程數就更少了。</p><div class=pgc-img><img alt="這個單機 1 萬個併發連接問題，程序員做架構設計都避免不了" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/7ab7767a-24d5-4d62-8066-6f2b368dfbf2><p class=pgc-img-caption></p></div><p>當然，這個問題隨著技術的發展很快就解決了，現在大部分的個人電腦操作系統可以創建 64 位的進程，由於數據類型所帶來的進程數上限消失了，但是我們依然不能無限制的創建進程，因為隨著併發連接數的上升會佔用系統大量的內存，同樣會造成系統的不可用。</p><p>操作系統裡內存管理的主要作用是，進程請求內存的時候為其分配可用內存，進程釋放後回收內存，並監控內存的使用狀況。為了提高內存的使用率，現代操作系統需要程序能夠共享內存，並且內存的限制對開發者透明，有些程序佔用了內存空間，但不一定是一直使用的，這樣可以把這部分內存數據序列化到磁盤上，需要的時候再加載到內存裡，這樣內存資源永遠會給最需要的程序使用。於是程序員們發明了虛擬內存（Virtual Memory）。</p><p>虛擬內存技術支持程序訪問比物理內存大得多的內存空間，也使得多個程序共享內存更加高效。物理內存由 RAM 芯片提供，虛擬內存則依靠透明的使用磁盤空間，使程序運行起來好像有了更大的內存空間。</p><p>但是問題依然存在，進程和線程的創建都需要消耗一定的內存，每創建一個棧空間，都會產生內存開銷，當內存使用超過物理內存的時候，一部分數據就會持久化到磁盤上，隨之而來的就是性能的大幅度下降。</p><div class=pgc-img><img alt="這個單機 1 萬個併發連接問題，程序員做架構設計都避免不了" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/f2f2fd1a-7617-4970-8444-0cbb6ef57434><p class=pgc-img-caption></p></div><p>這就像銀行擠兌，人們把現金存入銀行，收取一定的利息，平時只有少數人去銀行取現，銀行會拿人們存的錢去做更有價值的投資。但是，如果大部分人都去銀行取現，銀行是沒有那麼多現金的。取不到錢的用戶，被門擋在外面的用戶，一定會去拉橫幅喊口號“最喜歡雙截棍柔中帶剛，不喜歡銀行就上少林武當”云云，於是銀行就處於不可用狀態了。現在的互聯網金融也是一個道理，投資者都去變現退出，無論是多麼良性的資產，一樣玩完。</p><p>為什麼現在會有這麼大的連接需求呢？因為業務驅動和技術發展嘛。除了普通的網頁瀏覽和表單提交，即時通信和實時互動交流越來越成為主流需求，keep-alive 技術也能讓瀏覽器產生長連接，實時在線的客戶端越來越多，如果不能解決 C10K 問題，將導致服務商需要購買大量的服務器，而每一臺服務器都不能做到物盡其用，即使你配置了更好的 CPU 和更大的內存。</p><p>當然，現在我們早已經突破了 C10K 這個瓶頸，具體的思路就是通過單個進程或線程服務於多個客戶端請求，通過異步編程和事件觸發機制替換輪詢，IO 採用非阻塞的方式，減少不必要的性能損耗，等等。</p><p><br></p><div class=pgc-img><img alt="這個單機 1 萬個併發連接問題，程序員做架構設計都避免不了" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/e0c2d1bd-6cc3-4ed6-b2b1-78bcab90a40c><p class=pgc-img-caption></p></div><p>底層的相關技術包括 epoll、kqueue、libevent 等，應用層面的解決方案包括 OpenResty、Golang、Node.js 等，比如 OpenResty 的介紹中是這麼說的：</p><blockquote class=ql-long-26092344><p>OpenResty 通過匯聚各種設計精良的 Nginx 模塊，從而將 Nginx 有效地變成一個強大的通用 Web 應用平臺。這樣，Web 開發人員和系統工程師可以使用 Lua 腳本語言調動 Nginx 支持的各種 C 以及 Lua 模塊，快速構造出足以勝任 C10K 乃至 C1000K 以上單機併發連接的高性能 Web 應用系統。</p></blockquote><p>現在人們都去搞 C10M 了，你們怕不怕？</p><p>實際操作中，每個解決方案都不是那麼容易實現的，很多技術領域油光水滑的東西，放到線上，往往會出現各種各樣的問題和毛病。松本行弘先生介紹了一個“最弱連接”的概念：</p><blockquote class=ql-long-26092344><p>如果往兩端用力拉一條由很多環 （連接）組成的鎖鏈，其中最脆弱的一個連接會先斷掉。因此，鎖鏈整體的強度取決於其中最脆弱的一環。</p></blockquote><blockquote class=ql-long-26092344><p>C10K 問題的情況也很相似。一臺服務器同時應付超過一萬個（或者更多）併發連接的情況，哪怕只有一個要素沒有考慮到超過一萬個客戶端的情況，這個要素就會成為“最弱連接”，從而導致問題的發生。</p></blockquote><p>每個做架構設計和技術實現的程序員，都應當考慮這個最弱連接問題。</p><p>今天關於 C10K 這個問題，就和大家聊到這裡，你在實際工作中，用過哪些高併發技術呢？應對過多大的 QPS 呢？歡迎在留言區給出你的解決方案。</p><p>賣桃者說，明天見。</p><p><strong>福利時間～</strong></p><p>價值<strong>199</strong>元的學習加油包，可<strong>免費暢看</strong>價值萬元線下大會實錄視頻，425位國內外大廠資深專家特邀分享面對面向BAT等一線大廠取經。</p><p>小夥伴們<strong>關注+評論+轉發+點贊</strong>後，私信小編回覆“<strong>學習禮包</strong>”即可領取～每人僅限一份哦！</p><div class=pgc-img><img alt="這個單機 1 萬個併發連接問題，程序員做架構設計都避免不了" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1c0e330016d74518afa78c360d5ba9fc><p class=pgc-img-caption></p></div><p>點擊鏈接，閱讀更多“賣桃者說”精彩文章！</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>這個</a></li><li><a>單機</a></li><li><a>萬個</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/d5da73b6.html alt=這個公司產品市佔率九成，市場空間3倍增速，今年淨利潤將翻倍 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/40949c99ee0e4221b4d4875c00def5a4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d5da73b6.html title=這個公司產品市佔率九成，市場空間3倍增速，今年淨利潤將翻倍>這個公司產品市佔率九成，市場空間3倍增速，今年淨利潤將翻倍</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/603069e5.html alt=這個汽車不光能在公路上開，還能拉著火車在鋼軌上跑！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/04f4307e-7e97-4e10-9f95-a3c00221151d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/603069e5.html title=這個汽車不光能在公路上開，還能拉著火車在鋼軌上跑！>這個汽車不光能在公路上開，還能拉著火車在鋼軌上跑！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f3070f16.html alt=買這個編碼格式的藍牙設備，又便宜又好用！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/8d5cc4a5-5d5b-4a34-adbd-cb74f8d4db2b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f3070f16.html title=買這個編碼格式的藍牙設備，又便宜又好用！>買這個編碼格式的藍牙設備，又便宜又好用！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/455de12a.html alt=多喝水就能讓大便變軟？便祕吃這個才有效 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b846b2b184614e2599cc9b4900c9a30b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/455de12a.html title=多喝水就能讓大便變軟？便祕吃這個才有效>多喝水就能讓大便變軟？便祕吃這個才有效</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3cc75c16.html alt=新疆這個地方平臥著一個神奇的大湖！總面積有260平方公里 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a21703c8647641d5a77af54510346969 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3cc75c16.html title=新疆這個地方平臥著一個神奇的大湖！總面積有260平方公里>新疆這個地方平臥著一個神奇的大湖！總面積有260平方公里</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/54f6b885.html alt=成都東郊新動態，這個文創公園你去過沒？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/95f2a244159a4751aee4672cbcc04f93 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/54f6b885.html title=成都東郊新動態，這個文創公園你去過沒？>成都東郊新動態，這個文創公園你去過沒？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1be03739.html alt=這個穴位，中醫為什麼稱它為身之“糧倉”？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/S6E0LfQ8hqNrud style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1be03739.html title=這個穴位，中醫為什麼稱它為身之“糧倉”？>這個穴位，中醫為什麼稱它為身之“糧倉”？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/05e8fcdd.html alt=這個地方，去過一次，將成為一生永久的愛戀 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/43850002ba6e8929bebc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/05e8fcdd.html title=這個地方，去過一次，將成為一生永久的愛戀>這個地方，去過一次，將成為一生永久的愛戀</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/521e944c.html alt=廣西這個縣是北部灣重鎮，被譽為“南珠之鄉”，海陸空交通發達！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/861ebdfd098a4da1a9c763dad2381556 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/521e944c.html title=廣西這個縣是北部灣重鎮，被譽為“南珠之鄉”，海陸空交通發達！>廣西這個縣是北部灣重鎮，被譽為“南珠之鄉”，海陸空交通發達！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a8114090.html alt=高顏值低消費！這個歐洲國家超低調，風景卻美得無需濾鏡 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RZtayab8Tt32qX style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a8114090.html title=高顏值低消費！這個歐洲國家超低調，風景卻美得無需濾鏡>高顏值低消費！這個歐洲國家超低調，風景卻美得無需濾鏡</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/401d7e61.html alt=大家都熟知日出時間，那麼你們知道這個時間是怎麼算出來的嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e240bd51910c4924b88d747cff22c8e8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/401d7e61.html title=大家都熟知日出時間，那麼你們知道這個時間是怎麼算出來的嗎？>大家都熟知日出時間，那麼你們知道這個時間是怎麼算出來的嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d0bd3fc2.html alt=這個12月為何一直陰沉沉溼嗒嗒？寧波日照時數創歷史新低 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/REEcIKg8OmJwbp style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d0bd3fc2.html title=這個12月為何一直陰沉沉溼嗒嗒？寧波日照時數創歷史新低>這個12月為何一直陰沉沉溼嗒嗒？寧波日照時數創歷史新低</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fbf63e7b.html alt=這個城市年平均日照時數為3056.4小時，人雖少但景色迷人 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/658f45c9891243f69b147f90a3efb088 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fbf63e7b.html title=這個城市年平均日照時數為3056.4小時，人雖少但景色迷人>這個城市年平均日照時數為3056.4小時，人雖少但景色迷人</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/64fa6511.html alt=猝不及防！無錫這個地方，快38000元/平了！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/946be7615d6441be9aaad47b08880025 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/64fa6511.html title=猝不及防！無錫這個地方，快38000元/平了！>猝不及防！無錫這個地方，快38000元/平了！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0d41b97f.html alt=常州這個小區消防虛設，環境雜亂，竟然1個月還能賣7套 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/87984fbfe74c4ad2ac0b22bdfefd05db style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0d41b97f.html title=常州這個小區消防虛設，環境雜亂，竟然1個月還能賣7套>常州這個小區消防虛設，環境雜亂，竟然1個月還能賣7套</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>