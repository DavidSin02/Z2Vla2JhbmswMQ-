<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>一步步編寫操作系統 13 棧 | 极客快訊</title><meta property="og:title" content="一步步編寫操作系統 13  棧 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/941f16c5036c46999917c9755f5714c8"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/99f1e00.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/99f1e00.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/99f1e00.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/99f1e00.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/99f1e00.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/99f1e00.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/99f1e00.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/99f1e00.html><meta property="article:published_time" content="2020-10-29T21:05:31+08:00"><meta property="article:modified_time" content="2020-10-29T21:05:31+08:00"><meta name=Keywords content><meta name=description content="一步步編寫操作系統 13  棧"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/99f1e00.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>一步步編寫操作系統 13 棧</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><div class=pgc-img><img alt="一步步編寫操作系統 13  棧" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/941f16c5036c46999917c9755f5714c8><p class=pgc-img-caption></p></div><h1><strong>棧到底是什麼玩意</strong></h1><p>cpu中有棧段SS寄存器和棧指針SP寄存器，它們是用來指定當前使用的棧的物理地址。換句話說，要想讓cpu運行，必須得有棧。棧是什麼?幹嗎用的？本節將給大家一個交待。</p><p>還記得數據結構中的棧嗎？那是邏輯上的數據存取結構，是種如何用這種數據結構來存取數據的描述。在用戶進程空間中，堆是堆，棧是棧，但堆棧卻是人們常說的棧，和堆沒關係，所以，咱們後面為避免混淆，只說棧。</p><p>棧是線性表的一種，什麼是線性表？如果提出這樣的問題，我想您可能不清楚什麼是線性。線性就是具有線的性質，就像一條線一樣，連續性強，從一個方向到另一個方向。線上沒有面積的概念，不管是直線還是曲線，在線上任意位置只能容納一個數據對象。線性表簡而言之就是一個線性存儲單元，結構中每個元素都有一個前驅和一個後繼元素，且僅各有一個。這就是線性的體現：連續，且任意位置只有一個元素。棧也是這樣，不過不同的是，數據的存取都在一端進行，這一端稱為棧頂，另一端做為存儲單元的基址永遠不動，稱為棧底。這就是上學時，老師們常常說的後進先出，先放進去的數據要在最後才能取出，後放進去的數據最先被取出。</p><p>這裡我就不用舉漢諾塔這樣經典的例子了，畢竟上學時都聽得太多了。我說個大家都認同的事實：大家肯定擠過公交車吧（坐過公交車的同學繼續看，土豪隨意^_^），尤其是早班車和末班車，車廂里人擠人，站都站不穩。先擠上車的乘客其實很倒黴的（有座兒不算^_^），因為他要在最後下車，在擁擠的車廂中折磨的時間最長。後擠上車的乘客在下車的時候還是蠻爽的，因為他會是第一個下車，是率先逃出惡劣環境的人。所以，擠公交車就是典型的後進先出。車廂就相當於棧，乘客就相當於棧中存取的元素，這個例子其實還算生動。</p><p>舉的例子雖然很常見，但這對於已經理解棧的同學來說，我像是在說廢話一樣沒新意。對於不理解棧的同學來說，可能是依然像說廢話一樣，說了也意會不到棧是什麼。我非常理解這種心情，記得當初我在學網絡時，老師說只要在路由器上把三層（網絡層）IP協議（不是指令指針寄存器IP）禁用，四層（傳輸層）上的tcp或udp協議自然就不可用了。老師為了讓我們明白這種依賴關係，甚至不惜舉出這樣的例子：如果不想讓某人說話 ，最簡單的辦法就是給讓其睡著，而不是勸他保護安靜。這個例子非常淺顯易懂，但用例子來理解理論知識，依然讓我有點摸不著頭腦，這可不是比喻恰不恰當的事，知識是嚴謹的，不是比喻出來的。如果您現在也有這樣的體會，沒關係，以後會不斷接觸棧的，熟了自然就理解了，這只是時間問題。</p><p>初次學習數據結構時，不容易理解其本質，我當初在學習這門課時，感覺雲裡霧裡的，似乎明白似乎又不懂，老師讓不懂的同學提問，我又不知道該怎樣描述問題，不知道哪裡不懂。同樣的定義，同樣的文字描述，每個人理解的都不一樣。就像魚和小鳥，魚認為自己離開水就會死，水就是生命，小鳥也認為沒水會渴死，水也是生命。但魚和小鳥對水的理解能一樣嗎?趕緊回來，還是說咱們的正事。棧只是一種抽象概念，是一種虛擬出來的數據存取方法。其實現形式是不限的，只要滿足棧的定義就可以：</p><ul><li>λ 首先得是線性結構，並且數據的存取在線性結構的一端進行。如果您願意，可以用鏈表來實現，也可以用數組來實現，它們都是線性數據結構。</li><li>λ 其次需要維護一個指針，用它來指向線性結構的一端，數據存取都通過此指針。</li></ul><p>前面又比喻又回憶的，說了這麼多，棧能夠幹什麼呢？棧是一種很偉大的發明，可以解決很多難題：</p><ul><li>λ 表達式計算，如中綴表達式和後綴表達式的轉換</li><li>λ 函數調用，無論是嵌套調用或遞歸調用，用來維護返回地址。</li><li>λ 深度優先搜索算法</li></ul><p>到現在為止，我們說的只是數據結構中的棧，這是邏輯上的，最終我想表達的是內存中的棧，這是物理上的。把數據結構中的棧的概念用物理硬件來實現，這就是我們要說的棧。它同數據段、代碼段一樣，是個內存中的區域。也就是棧段寄存器SS和棧指針SP所指向的內存區域。我們常聽說的棧溢出，指的就是這個內存區域無法容納數據了。</p><p>硬件是如何實現這個棧的呢?還是那句話，首先得滿足棧的概念，具備棧的特性，即使是硬件也不能例外，必須滿足上面提到的這兩個條件：一個是線性結構，一個是在棧頂對數據存取。因為它畢竟造的是棧，不具備這些就不叫棧了。</p><p>線性結構這個簡單，內存就是，直接用物理內存存取最方便了，咱們要做的，就是給棧指定一片內存區域就成了，區域的起始地址做為棧基址，存入棧基址寄存器SS中，另一端是動態變化的，用棧指針寄存器SP來指定。棧在使用過程中是向下擴展的，所以棧頂地址肯定是小於棧底地址。</p><p>棧既然是一片內存區域，訪問內存就要用“段基址：段內偏移地址”的形式，所以棧中的內存地址也是用“段基址SS的值*16+棧指針SP（段內偏移地址）形成的20位地址”訪問到的。由於是硬件實現的棧，故硬件提供了相應的方法來存取棧，即push和pop指令。push指令負責把數據壓入棧，pop指令功能相反，將其從棧中取出。不過我剛才說的不全面，棧的出口和入口都是棧頂，push把數據壓向哪裡，它得知道棧頂在哪裡才行。pop指令也一樣，它得知道哪裡是棧頂才能從棧中取出正確的數據。這正是棧指針寄存器SP的作用，此寄存器中的值是段內偏移地址，是棧頂相對於棧底的偏移量。</p><p>棧頂（SP指針）是棧的出口和入口，它指向的內存中存儲的始終是最新的數據。push和pop就是操作這個指針所指向的內存。由於棧是從高地址向低地址發展，所以棧頂、棧指針指向的地址會越來越低。push壓入數據的過程是：先將SP減去字長，目的是避免將棧頂的數據破壞，所得的差再存入SP，棧頂在此被更新，這樣棧頂就指向了棧中下一個存儲單元的位置。再將數據壓入SP（新的棧頂）指向的新的內存地址。pop指令相反，既然是在棧中彈出數據，棧指針寄存器SP的值應該是增大一個數據單位。由於要彈出的數據就在當前棧頂，所以在彈出數據後，才將SP加上字長，所得的和再存入SP，從而更新了棧頂。這樣SP就指向了上一個存儲單元的位置。</p><p>上面提到的字長，是指cpu的字長，即一次可處理的數據的長度。在實模式下的字長是16。</p><p>物理內存中的棧如圖:</p><div class=pgc-img><img alt="一步步編寫操作系統 13  棧" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/04e57f6de60d4684aaa2df82e1c1cf7a><p class=pgc-img-caption></p></div><p>注意啦，如圖所示，雖然棧是向下發展，但棧也是內存，訪問內存依然是從低地址往高地址，假如當前棧頂是0x1233E，棧頂數據佔2字節的話，其範圍是0x1233E~0x1233F。個人覺得，這個硬件中的棧讓人感到神祕，主要有兩方面原因：</p><p>一方面是棧指針不是自己維護，這不像咱們在高級語言中自己創建的棧那樣，指針的一舉一動都是自己在操作。不直接受控的東西往往讓人心存憂慮和有點小恐慌。其實即使是這裡的硬件棧，咱們也可以自己維護指針，如push ax可以這樣代替：</p><pre>mov bp,spsub bp, 2mov [bp],ax</pre><p>bp默認的段寄存器就是SS，用bp的時候直接操作的便是棧。bp就相當於棧指針啦，自己維護畢竟太麻煩，有直接省事的幹嗎不用呢^_^。</p><p>另一方面，棧就是一片內存區域，只不過“經常”操作這片內存的指令不是mov，而是push、pop，這兩條指令無非是自動維護存取數據的位置（SP寄存器的值）而已，大家用mov來操作這片內存，不是也得要給出存取地址嗎。這樣看來，它和普通的數據段沒什麼不同，不要覺得它比金字塔還神祕啦。</p><p>一定要注意，push和pop操作是要成對出現的，這樣才能維護棧平衡。否則，光push，不pop，有進沒出，這棧很快就溢出啦。切記，一個push要對應一個pop，每鍵入一個pop指令，一定要清楚它對應的是哪個push。</p><p>棧就先說這麼多，不摸索實際東西的話還是不能真正掌握和理解，本書強調實踐，紙上談兵可來不了真知識。</p><p>好啦，官人常來玩哦</p><p>【再續】</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>編寫</a></li><li><a>系統</a></li><li><a>13</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/994c1ef.html alt="一步步編寫操作系統 22 硬盤操作方法" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/b3cb3cfe699249b98bd93bb290e13b28 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/994c1ef.html title="一步步編寫操作系統 22 硬盤操作方法">一步步編寫操作系統 22 硬盤操作方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4a0c0c3.html alt="一步步編寫操作系統  10  cpu的實模式" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3d3c6b53b70c4f1eae3980452d8acbe2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4a0c0c3.html title="一步步編寫操作系統  10  cpu的實模式">一步步編寫操作系統 10 cpu的實模式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/031eafc4.html alt=電廠直流系統調試方案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/5e8200036f19e04c25bf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/031eafc4.html title=電廠直流系統調試方案>電廠直流系統調試方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fc3b4b2c.html alt=一文讀懂智能客服：發展歷程、系統搭建、市場推廣 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RbYMTZ55OrJUgU style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fc3b4b2c.html title=一文讀懂智能客服：發展歷程、系統搭建、市場推廣>一文讀懂智能客服：發展歷程、系統搭建、市場推廣</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/51410370.html alt=生活垃圾焚燒發電及蒸汽系統優化改造項目公告 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RcblrbTDBokV23 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/51410370.html title=生活垃圾焚燒發電及蒸汽系統優化改造項目公告>生活垃圾焚燒發電及蒸汽系統優化改造項目公告</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b4913b56.html alt=電驅動橋系統或加快電氣化進程，多個案例共同說明問題 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1539571595921bc5b27eff6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b4913b56.html title=電驅動橋系統或加快電氣化進程，多個案例共同說明問題>電驅動橋系統或加快電氣化進程，多個案例共同說明問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9a7b7719.html alt=基於混沌系統的偽隨機數發生器設計 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9a7b7719.html title=基於混沌系統的偽隨機數發生器設計>基於混沌系統的偽隨機數發生器設計</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f44ab8f6.html alt=詳解13項鋼筋安裝質量標準及通病防治 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/fd3ff534941a487884c7a67361337cfb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f44ab8f6.html title=詳解13項鋼筋安裝質量標準及通病防治>詳解13項鋼筋安裝質量標準及通病防治</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/168e1143.html alt=13條跨市公交暫停運營！包括中山到珠海、順德、江門公交 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RoNS9itD0dzfEc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/168e1143.html title=13條跨市公交暫停運營！包括中山到珠海、順德、江門公交>13條跨市公交暫停運營！包括中山到珠海、順德、江門公交</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/99558abe.html alt=win10系統打印機打印不了顯示已暫停的解決方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/10d0de369d4746c7a0c220ff59bd2470 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/99558abe.html title=win10系統打印機打印不了顯示已暫停的解決方法>win10系統打印機打印不了顯示已暫停的解決方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2ec9413d.html alt="意大利暫停與13個國家的航班往來 或延長國家緊急狀態時間" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2ec9413d.html title="意大利暫停與13個國家的航班往來 或延長國家緊急狀態時間">意大利暫停與13個國家的航班往來 或延長國家緊急狀態時間</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2564328d.html alt=虛設投資交易系統吸引投資 成都破獲一特大團夥詐騙案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2564328d.html title=虛設投資交易系統吸引投資 成都破獲一特大團夥詐騙案>虛設投資交易系統吸引投資 成都破獲一特大團夥詐騙案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e4b6c065.html alt=全球定位系統（GPS），不只是導航 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/S7sY2h8G8GOmul style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e4b6c065.html title=全球定位系統（GPS），不只是導航>全球定位系統（GPS），不只是導航</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f75e014c.html alt=謹記！短線王者交易系統，學會極大概率提高買入與賣出的時機！掌握終身獲益無窮！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RL8KN4P57T39Db style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f75e014c.html title=謹記！短線王者交易系統，學會極大概率提高買入與賣出的時機！掌握終身獲益無窮！>謹記！短線王者交易系統，學會極大概率提高買入與賣出的時機！掌握終身獲益無窮！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0ad4f2c9.html alt="焦爐系統停電 —— 應急操作" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8ca2e135770644bfb97620aad1b362c0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0ad4f2c9.html title="焦爐系統停電 —— 應急操作">焦爐系統停電 —— 應急操作</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>