<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>P4語言編程詳解 | 极客快訊</title><meta property="og:title" content="P4語言編程詳解 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/b0509dc83f844c6e9e133d81e9855e4b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9f9a0ab8.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9f9a0ab8.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9f9a0ab8.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9f9a0ab8.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9f9a0ab8.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9f9a0ab8.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9f9a0ab8.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9f9a0ab8.html><meta property="article:published_time" content="2020-11-14T21:03:54+08:00"><meta property="article:modified_time" content="2020-11-14T21:03:54+08:00"><meta name=Keywords content><meta name=description content="P4語言編程詳解"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/9f9a0ab8.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>P4語言編程詳解</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>在文章《P4:開創數據平面可編程時代》中介紹了P4的架構特性、交換機結構以及P4程序的工作原理，本篇為大家介紹P4語言編碼及規範，從編碼角度去理解P4程序的工作流程。</p><h1>1.源碼目錄結構</h1><p>P4項目源碼可以在github上直接獲取（https://github.com/p4lang）。P4項目由很多個單獨的模塊組成，每個模塊就是一個子項目，下面分別簡單介紹一下各模塊的功能。</p><p><strong>（1）behavioral-model</strong></p><p>模擬P4數據平面的用戶態軟件交換機，使用C++語言編寫，簡稱bmv2。P4程序首先經過p4c-bm模塊編譯成JSON格式的配置文件，然後將配置文件載入到bmv2，轉化成能實現交換機功能的數據結構。</p><p>behavioral-model模塊是架構無關的，可以實現各種P4編程目標。該模塊主要實現三個目標，其中最重要的是simple_switch,即實現P4語言標準中抽象交換機模型。另外兩個目標是（simple_router,l2_switch），這兩個目標是作為教學示例。</p><p><strong>（2）p4-hlir</strong></p><p>將P4代碼轉換成高級中間表示的前端編譯器，目前的高級中間表示的展示形式與python對象的層次結構相同。該編譯器的目的是使得後端編譯器開發者從語法分析和目標無關的語義檢查的負擔中解放出來。</p><p><strong>（3）p4c-bm</strong></p><p>behavioral modal的後端編譯器，建立在p4-hilr的頂部，該模塊以P4程序作為輸入，輸出一個可以載入到behavioral model的JSON配置文件。</p><p><strong>（4）p4-build</strong></p><p>需要手動生成的基礎設施庫，為執行P4程序編譯、安裝PD庫。</p><p><strong>（5）switch</strong></p><p>內含switch.p4程序樣例以及通過SAI、SwitchAPI和Switchlink操作交換機所需的所有庫，可獨立於p4factory運行 。</p><p><strong>（6）ntf（Network Test Framework）</strong></p><p>網絡測試框架，內含用以執行bmv2上應用的網絡測試樣例。該框架中集成了mininet和docker，方便用戶進行測試。</p><p><strong>（7）p4factory</strong></p><p>內含整套用以運行和開發基於behavioral model的P4程序環境的代碼，幫助用戶快速開發P4程序。</p><p><strong>（8）ptf</strong></p><p>數據平面測試框架，基於unittest框架實現，內含標準Python版本。該框架中的大部分代碼從floodlight項目中的OFTest框架移植而來，框架的實現和開發可參考OFTest框架文檔。</p><p><strong>（9）scapy-vxlan</strong></p><p>基於Scapy項目，barefoot對其進行了定製，支持更多協議的數據包包頭的偽造和解析，目前支持 VXLAN和ERSPAN-like（Scapy本身並不支持）。</p><p><strong>（10）tutorials</strong></p><p>P4語言教程，內含8個教程,覆蓋了P4語言中的解析器、動作、狀態存儲、匹配-動作表、等基礎組件。</p><p>1）cpoy_to_cpu：基本動作clone_ingress_to_egress教程</p><p>2）meter：計量表教程</p><p>3）TLV_parsing：IPv4數據包解析教程</p><p>4）register：寄存器讀寫狀態教程</p><p>5）counter：計數器教程</p><p>6）action_profile：ECMP動作摘要教程</p><p>7）resubmit：數據包衝提交到入端口流水線教程</p><p>8）simple_nat：TCP流量的完全圓錐形NAT網絡教程</p><p>注：P4語言項目庫中的SAI、mininet及thrift是從其他開源項目完全fork而來，這裡不展開討論。</p><h1>2.P4語言標準</h1><p>當前P4語言標準的最新版本為《The P4 Language Specification Version1.1》（以下簡稱V1.1），目前版本的P4語言編譯器已經基本實現了P4語言標準中的絕大部分特性 ，部分特性尚在開發之中。</p><p>2.1 基礎數據類型及操作</p><p>P4語言中定義了5種基礎數據類型，分別是：bool、bit、int、varbit、int。（注：此處W代表長度，通常使用十進制數字表示，如bit）通常情況下，不同的數據類型之間可以相互轉換，並且所有的二目運算符都要求數據類型保持一致，除了位移操作符（shifts）。</p><p><strong>（1）布爾型（bool）</strong></p><p>布爾型（Boolean），值為true或false，非整數型。布爾類型數據可進行如表1所示運算。</p><p class=ql-align-center>運算符</p><p class=ql-align-center>描述</p><p class=ql-align-center>and</p><p class=ql-align-center>二目運算符，操作數必須都為布爾型，運算結果為布爾型。</p><p class=ql-align-center>or</p><p class=ql-align-center>二目運算符，操作數必須都為布爾型，運算結果為布爾型。</p><p class=ql-align-center>not</p><p class=ql-align-center>單目運算符，操作數必須為布爾型，運算結果為布爾型。</p><p class=ql-align-center>＝＝，！＝</p><p class=ql-align-center>測試是否相等或不等，運算結果為布爾型。</p><p class=ql-align-center>表1 布爾型支持的運算</p><p><strong>（2）無符號整型（bit）</strong></p><p>無符號整型（unsigned integers）也叫位串（bit-string）。位串是以比特位形式表示的任意長度的數（如：bit，表示長度為127比特的位串），但如果需要對位串進行某些數學運算時，位串長度必須是8的整數倍（如：16、32、64bit）。無符號整型支持如表2所示運算。</p><p class=ql-align-center>運算符</p><p class=ql-align-center>描述</p><p class=ql-align-center>＝＝，！＝</p><p class=ql-align-center>測試是否相等或不等，運算結果為布爾型。&lt;，>，&lt;=，>=</p><p class=ql-align-center>無符號數比較，操作數的長度（W）要求相同，運算結果為布爾型。&，｜，^</p><p class=ql-align-center>按位運算符，操作數的長度（W）要求相同，運算結果為無符號整型。～</p><p class=ql-align-center>運算結果為操作數的補碼。&lt;&lt;，>></p><p class=ql-align-center>左移運算符操作數為無符號整型，右移運算符操作數必須是無符號數或非負整數。此運算符為邏輯位移。+（單目）</p><p class=ql-align-center>單目加運算，效果同no-op。-（單目）</p><p class=ql-align-center>單目減運算，計算結果為2W減去操作數，W為操作數長度。+（雙目）</p><p class=ql-align-center>二目加運算，操作數的長度（W）要求相同。計算結果為操作數的算術和，且運算結果長度也必須為W，超過則截斷。-（雙目）</p><p class=ql-align-center>二目減運算，操作數的長度（W）要求相同。計算結果為操作數的算術差。*</p><p>無符號乘法運算，操作數的長度（W）要求相同，計算結果為無符號數且長度與操作數相等。</p><p class=ql-align-center>表2 無符號整型支持的運算</p><p><strong>（3）有符號整型（int（W））</strong></p><p>有符號整型（signed integers）支持如表3所示運算。</p><p class=ql-align-center>運算符</p><p class=ql-align-center>描述</p><p class=ql-align-center>＝＝，！＝</p><p class=ql-align-center>測試是否相等或不等，運算結果為布爾型。&lt;，>，&lt;=，>=</p><p class=ql-align-center>有符號數比較，操作數的長度（W）要求相同，運算結果為布爾型。&，｜，^</p><p class=ql-align-center>按位運算符，操作數的長度（W）要求相同，運算結果為無符號整型。～</p><p class=ql-align-center>運算結果為操作數的補碼。&lt;&lt;，>></p><p class=ql-align-center>左移運算符操作數為有符號整型，右移運算符操作數必須是無符號數或非負整數。此運算符為邏輯位移。+（單目）</p><p class=ql-align-center>單目加運算，效果同no-op。-（單目）</p><p class=ql-align-center>單目減運算，運算結果有符號整型，且長度與操作數相等。+（雙目）</p><p class=ql-align-center>二目加運算，操作數數據類型必須相同，運算結果也為同類型。-（雙目）</p><p class=ql-align-center>二目減運算，操作數數據類型必須相同，運算結果也為同類型。*</p><p>有符號乘法運算，操作數的長度（W）要求相同，計算結果為有符號數且長度與操作數相等。</p><p class=ql-align-center>表3 有符號整型支持的運算</p><p><strong>（4）變長位串（varbit）</strong></p><p>變長位串（dynamically-sized bit-strings）不支持算術、比較、按位運算，甚至不支持類型轉換。該數據類型在定義時會指定一個靜態的最大寬度值，解析器會提取變長位串數據並設置一個值作為長度。</p><p><strong>（5）無限精度整型（int）</strong></p><p>無限精度整數（infinite-precision integers）支持如表4所示運算。</p><p class=ql-align-center>運算符</p><p class=ql-align-center>描述</p><p class=ql-align-center>＝＝，！＝</p><p class=ql-align-center>測試是否相等或不等，操作數必須都是整型（int）運算結果為布爾型。&lt;，>，&lt;=，>=</p><p class=ql-align-center>有符號數比較，操作數類型都必須是整形，運算結果為布爾型。&lt;&lt;，>></p><p class=ql-align-center>右移運算符操作數必須為正整數；左移運算結果和操作數相同。a&lt;&lt;b等價於ax2b，a>>b等價於a/2b。+（單目）</p><p class=ql-align-center>單目加運算，效果同no-op。-（單目）</p><p class=ql-align-center>單目減運算，運算結果為整型，且該運算不會導致溢出。+（雙目）</p><p class=ql-align-center>二目加運算，操作數類型都必須是整型，運算結果為整型，且該運算不會導致溢出。-（雙目）</p><p class=ql-align-center>二目減運算，操作數類型都必須是整型，計算結果為整型，且該運算不會導致溢出。*</p><p class=ql-align-center>無符號乘法運算，操作數必須都是整形，計算結果為整形，該運算不會導致溢出。／，％</p><p>二目有符號除法和取模運算，操作數必須是正整數，運算結果為正整數。</p><p class=ql-align-center>表4無限精度整型支持的運算</p><p>2.2 數據類型轉換</p><p>再P4預研中，對數據進行運算時大多時候都要保證操作數數據類型的一致性，P4也提供了基礎的數據類型轉換功能，表5中列出了所有合法的數據類型轉換。</p><p class=ql-align-center>From</p><p class=ql-align-center>To</p><p class=ql-align-center>描述</p><p class=ql-align-center>bit&lt;1></p><p class=ql-align-center>bool</p><p class=ql-align-center>0代表fasle，1代表true。bool</p><p class=ql-align-center>bit&lt;1></p><p class=ql-align-center>0代表fasle，1代表true。bit&lt;W></p><p class=ql-align-center>int&lt;W></p><p class=ql-align-center>保留所有比特位不變。int&lt;W></p><p class=ql-align-center>bit&lt;W></p><p class=ql-align-center>保留所有比特位不變。bit&lt;W></p><p class=ql-align-center>bit&lt;W1></p><p class=ql-align-center>當W>W1時，保留低位W1位長度的數據，當W&lt;W1時新增位補0.int&lt;W></p><p class=ql-align-center>int&lt;W1></p><p class=ql-align-center>當W>W1時，保留低位W1長度的數字，當W&lt;W1時新增位補符號位.int</p><p class=ql-align-center>bit&lt;W></p><p class=ql-align-center>將整型轉化為位串，保留地位W位長度數據，溢出需要發出警告並轉化為負數。int</p><p class=ql-align-center>int&lt;W></p><p>將整型轉化為位串，保留地位W位長度數據，溢出需要發出警告。</p><p class=ql-align-center>表5 合法數據類型轉換</p><p>在P4程序中對數據進行運算時，除了用戶在編寫程序是手動轉換數據類型，P4編譯器在某些情況下也會自動將數據進行類型轉換，這種轉換是強制的、自動的的隱式類型轉換。如表6所示，例舉了P4程序中常見的幾種隱式類型轉換的情況。</p><p>bit&lt;8> x;</p><p>bit&lt;6> y;</p><p class=ql-align-center>bit&lt;8> z;表達式</p><p class=ql-align-center>實際實現</p><p class=ql-align-center>x＋1</p><p class=ql-align-center>x+(bit&lt;8>)1</p><p class=ql-align-center>z&lt;0</p><p class=ql-align-center>z&lt;(int&lt;8>)0</p><p class=ql-align-center>x&lt;&lt;13</p><p class=ql-align-center>0;//溢出時發出警告</p><p class=ql-align-center>x|0xFFF</p><p class=ql-align-center>x|(bit&lt;8>)0xFF;//溢出警告</p><p class=ql-align-center>表6 隱式類型轉換</p><p>2.3 基礎語言組件</p><p>P4程序中有5個語言組件：首部（Headers）、解析器（parsers）、表（Tables）、動作（Action）、流控制程序。</p><p><strong>（1）首部</strong></p><p>首部類型是由成員字段組成的有序列表，每個字段都有其名稱和長度，每一種首部類型都有對應的首部實例來存儲具體的數據。首部分為兩種，一種是包頭（Packet Headers），另一種是元數據（Metadata）。</p><p>包頭用以描述數據包結構，以IPv4協議為例，圖1為 IPv4報文頭部結構，IPv4報頭有20字節固定長度部分和可選字段、填充字段的可變部分，每個字段的作用這裡不再贅述。</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b0509dc83f844c6e9e133d81e9855e4b><p class=pgc-img-caption></p></div><p class=ql-align-center>圖1 IPv4協議報頭結構</p><p>使用P4語言定義IPv4的包頭類型示例如圖2所示：</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3c6135eff4d44807ae9dbeecd47b459b><p class=pgc-img-caption></p></div><p class=ql-align-center>圖2 IPv4 包頭定義</p><p>對照圖1中IPv4報頭結構可以比較容易理解上述P4語言代碼——按照IPv4報頭格式，定義了一個包頭並實例化。</p><p>這裡需要區分“包頭”，“報頭”的關係。如果沒有特殊指出，本文中的“包頭（Packet Header）”指的是P4語言中的術語，而“報頭”指的是數據包的報文頭部。</p><p>元數據用來攜帶數據和配置信息，元數據的申明與包頭類似，但在實例化時不同，而且包頭和元數據在字段值的約束上存在一定的差別。元數據分為兩種，一種是用來攜帶P4程序運行過程中產生的數據的用戶自定義元數據（User-Defined Metadata），如首部字段的運算結果等。另一種是固有元數據（Intrinsic Metadata），用於攜帶交換機自身的配置信息，如數據包進入交換機時的端口號等。</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f33dba3778e3413ab85e34c5993a27fd><p class=pgc-img-caption></p></div><p class=ql-align-center>圖3 元數據定義</p><p>用戶可以使用自定義的元數據來攜帶任意數據，但固有元數據在編譯器中具有特定的意義。V1.1中定義了8種固有元數據，這些元數據攜帶了數據包相關的狀態信息，表7中展示8種標準固有元數據及其作用。</p><p class=ql-align-center>字段</p><p class=ql-align-center>描述</p><p class=ql-align-center>ingress_port</p><p class=ql-align-center>數據包的入端口，解析之前設置。只讀。packet_length</p><p class=ql-align-center>數據包的字節數，當交換機在快速轉發模式下，該元數據不能在動作（action）中匹配或引用。只讀。egress_spec</p><p class=ql-align-center>在入端口流水線的匹配-動作過程之後設置，指定數據包出端口，可以是物理端口、邏輯端口或者多播組。egress_port</p><p class=ql-align-center>指定數據包的物理出端口，區別於egress_spec，只能應用於物理端口。只讀。egress_instance</p><p class=ql-align-center>用於區分複製後數據包實例的標識符。只讀。instance_type</p><p class=ql-align-center>數據包實例類型：正常（Normal）、入端口複製（ingress clone）、出端口複製（egress clone）、再循環（recirculated）。parser_status</p><p class=ql-align-center>解析器解析結果，0表示無錯誤，其實數字代表了對應的錯誤類型。parser_error_loaction</p><p>指向P4程序錯誤發生處。</p><p class=ql-align-center>表7 固有元數據</p><p>在P4語言中定義首部類型有以下幾點需要注意：</p><p>1)包頭類型的長度需要字節對齊，即長度必須是8bit的整數倍。</p><p>2)包頭中字段長度可以是可變值（該特性在P4語言規範中規定，但當前編譯器版本併為實現，後續版本會支持）也可以是首部中其他字段值計算後的值。而元數據中的字段長度只能是定值。</p><p>3)只有包頭能夠實例化成數組，元數據則不行。</p><p>4)實例化時，首部中已定義名稱的字段的值會被初始化成程序中的指定值，如果首部中只定義字段名稱而未指定值，字段的值將會被初始化成0。</p><p><strong>（3）解析器</strong></p><p>一個P4程序中往往定義了大量的首部和首部實例，但並不是所有的首部實例都會對數據包進行操作。解析器工作時會生成描述數據包進行哪些匹配+動作操作的中間表示（ Intermediate Representation），在P4中稱之為解析後表示（Parsed Representation），這些解析後表示規定了對數據包生效的實例，是一組對數據包生效的實例的集合。</p><p>P4語言中解析器採用有限狀態機的設計思路，每個解析器方法視為一種狀態。當解析器工作時，會將當前處理的數據包頭字節的偏移量記錄在首部實例中，並在狀態遷移（調用另一個解析器）時指向包頭中下一個待處理的有效字節。以以太網幀的解析器為例，用數據包類型代對應解析器，將每個解析器作為一種狀態，用箭頭表示狀態遷移，則可以構建出如圖2 所示的以太網幀的解析器的狀態遷移圖。</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b066736eb1da4398a42505d5972d4c48><p class=pgc-img-caption></p></div><p class=ql-align-center>圖4 以太網幀解析器狀態遷移圖</p><p>圖5展示了以太網幀和IPv4數據包解析器定義示例。</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5863e938d6f34cefb9efecd817b9c22f><p class=pgc-img-caption></p></div><p class=ql-align-center>圖5 解析器定義</p><p>一個解析方法/狀態可以以下四種方式結束：</p><p>1）return 一個流控制程序名</p><p>2）return一個解析器名</p><p>3）發生顯式錯誤</p><p>4）發生隱式錯誤</p><p>P4語言中流控制程序和解析器的命名空間是共用的，所以在定義解析器和流控制程序的時候需要注意不能重名，否則會導致P4程序錯誤。</p><p><strong>（3）動作</strong></p><p>P4語言中的動作主要分為兩種，基本動作（Primitive Actions）和複合動作（Compound Actions）。基本動作包括：數據包處理運算符（如添加、刪除或修改包頭）、基本的算術運算符、哈希運算符和統計跟蹤運算符（如計量、測量）。複合動作由基本動作組合而成，由用戶自行定義。表8中展示了P4中定義的基本動作。</p><p class=ql-align-center>動作</p><p class=ql-align-center>描述</p><p>no_op佔位符動作，不做任何操作。drop在入口流水線中將數據包丟棄。modify_field修改解析後表示中的包頭字段值。modify_field_with_hash_based_index使用字段列表索引計算一個值並使用該值生成偏移量。add_header為數據包的解析後表示添加包頭。remove_header為數據包的解析後表示刪除包頭。copy_header複製首部實例。push將所有首部實例壓入一個數組，並在頂部添加一個新首部。pop將實例數組頂部的元素彈出，後續元素向頂部移位。count更新計數器。meter執行計量操作。generate_digest生成一個報文摘要併發送到接收機。truncate在出口處截斷數據包。resubmit將原始數據包和元數據重新發送到解析器。Recirculate在數據包完成出口修改操作後重新發送。clone_ingress_pkt_to_ingress複製原始數據包併發送到解析器。clone_egress_pkt_to_ingress複製出口數據包併發送到解析器。clone_ingress_pkt_to_egress複製原始數據包併發送到緩存區。clone_egress_pkt_to_egress複製出口數據包併發送的緩存區。</p><p class=ql-align-center>表8 基本動作</p><p>這些動作高度抽象且與協議無關，以實現P4語言處理數據的協議無關性。同時，複雜的操作及流程可以通過組合不同基本操作（即複合操作）完成，從而保障了P4語言對各種協議的支持以及擴展性。圖6展示了P4中複合動作定義的示例。</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cb41d36ffd4e4e4383913d6956e1ec88><p class=pgc-img-caption></p></div><p class=ql-align-center>圖6 複合動作定義</p><p><strong>（4）匹配-動作表</strong></p><p>P4語言中的匹配-動作表定義了匹配字段、動作及一些相關屬性（如表容量），當匹配-動作表中定義的字段與數據包匹配成功時，則執行對應的動作；若匹配不成功則標記為“失配（miss）”，並執行默認操作。匹配動作表的定義如圖7所示。</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/be81048399fd4f62b280db0c32f18f74><p class=pgc-img-caption></p></div><p class=ql-align-center>圖7定義動作-匹配表</p><p>P4語言的匹配-動作表支持多種匹配類型，如精確匹配、最長前綴匹配、範圍匹配等。如表9所示，展示了動作-匹配表支持的匹配類型。</p><p class=ql-align-center>匹配類型</p><p class=ql-align-center>描述</p><p class=ql-align-center>excat</p><p class=ql-align-center>精確匹配。ternary</p><p class=ql-align-center>三重匹配，動作-匹配表的每個表項都有一個掩碼，將掩碼和字段值進行邏輯與運算，再執行匹配。為了避免導致多條表項匹配成功，每條表項都需要設定一個優先級。lpm</p><p class=ql-align-center>這是三重匹配的一種特殊情況，當多個表項匹配成功時，選擇掩碼最長的最為最高優先級進行匹配。index</p><p class=ql-align-center>字段值作為表項索引。range</p><p class=ql-align-center>表項中確定一個範圍，字段值在此範圍內皆能成功匹配。valid</p><p>僅用於包頭字段匹配，表項值只能為true/false。</p><p class=ql-align-center>表9 匹配類型表</p><p><strong>（4）流控制程序</strong></p><p>P4語言中匹配-動作表中規定需要匹配的字段和需要執行的操作，流控制程序則用來規定匹配-動作表的執行順序。</p><p>以P4語言定義二層轉發流程為例，數據包首先進行L2轉發表（l2_fwd）匹配，然後根據數據包的以太網目的地址是否匹配路由器自身的MAC地址（通過查找所屬的router_mac表）決定是否經過l3路由表（ipv4_fib_lpm和upv6_fib_lpm），再根據IP包頭類型（IPv4或IPv6），數據包匹配不同的L3路由表，最後通過訪問控制列表來控制數據包是否通過。</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/be76174eb4da4e78b2541db43ac71931><p class=pgc-img-caption></p></div><p class=ql-align-center>圖8 流控制程序定義</p><p>2.4 狀態存儲</p><p>包頭和元數據實例中的數據只能存在對某個數據包解析的過程中，解析下一個數據包時，這些實例會重新初始化。而計數器、計量器和寄存器中的數據在整個流水線中長期存在，所以稱之為狀態存儲。</p><p><strong>（1） 計數器</strong></p><p>計數器附加在每個表項之後，並在完成一次匹配並執行對應操作後自增1。計數器中定義了7種屬性，下圖展示了V1.1中計數器的定義方式。</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3b448cb7e3af4d34b760eab6c9c8a997><p class=pgc-img-caption></p></div><p class=ql-align-center>圖9 計數器定義</p><p>1）Name</p><p>計數器名稱，指向該計數器，P4編譯器中通過名稱+索引的方式確定一個計數器實例。</p><p>2）min_width</p><p>編譯P4程序時，編譯器分配給計數器的大小並不是完全固定的，該屬性指定了分配給計數器的最小長度。</p><p>3）saturating</p><p>如果計數器中設定了該屬性，則當計數器到達上限時停止計數，否則計數器將清零並重新開始計數。</p><p>4）direct</p><p>如果計數器中設定了該屬性，則計數器綁定的匹配-動作表中無需指定count動作來更新計數器，計數器會自動更新。若在匹配動作表調用count動作更新計數器，則編譯器報錯。</p><p>5）static</p><p>如果計數器中設定了該屬性，則必須在匹配-動作表中調用count動作更新計數器。</p><p>6）instance_count</p><p>該屬性用以記錄計數器實例數，如果計數器設定了direct屬性，則無法在計數器中設定該屬性；如果計數器中未設定direct屬性，則該屬性必須設定。</p><p>7）type</p><p>V1.1中的計數器類型有3種： bytes、packets、bytes_and_packets。</p><p><strong>（2） 計量器</strong></p><p>計量器的定義與計數器類似，計量器中定義了6種屬性，下圖展示了V1.1中計數器的定義方式。</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9e2c3301ef6f4c32b1e1602d7a3e0d17><p class=pgc-img-caption></p></div><p class=ql-align-center>圖10 計量器定義</p><p>1）name</p><p>計量器名稱，指向該計量器。</p><p>2）direct</p><p>如果計量器中設定了該屬性，則計量器綁定的匹配-動作表中無需指定execute_meter動作來更新計量器，計數器會自動更新。若在匹配動作表調用execute_meter動作更新計量器，則編譯器報錯。</p><p>3）static</p><p>如果計數器中設定了該屬性，則必須在匹配-動作表中調用execute_meter動作更新計數器。</p><p>4）instance_count</p><p>該屬性用以記錄計量器實例數，如果計量器設定了direct屬性，則無法在計量器中設定該屬性；如果計量器中未設定direct屬性，則該屬性必須設定。</p><p>5）type</p><p>V1.1中的計量器類型有2種： bytes、packets。</p><p>6）result</p><p>V1.1中的計量器的輸出結果有3種，分別用三種顏色標記：紅色（P4_METER_COLOR_RED）、黃色（P4_METER_COLOR_YELLO）和綠色（P4_METER_COLOR_GREEN），輸出結果存在一個2bit長度的字段中。</p><p><strong>（3） 寄存器</strong></p><p>寄存器定義了5種屬性，下圖展示了V1.1中寄存器的定義方式。</p><div class=pgc-img><img alt=P4語言編程詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/3f4ced6acd39430d9ade0e5cb57fe3e1><p class=pgc-img-caption></p></div><p class=ql-align-center>圖11 寄存器的定義</p><p>1）name</p><p>寄存器名稱，指向該寄存器，P4編譯器中通過名稱+索引的方式確定一個計量器實例。</p><p>2）width_or_layout</p><p>width和layout屬性二選一，width為指定一個確定的長度，而 layout是直接通過名稱引用已定義的包頭結構。</p><p>3）direct_or_static</p><p>與計數器和計量器中的定義類似，雖然寄存器不能直接在匹配過程中使用，但是作為modify_field動作的數據源，將當前寄存器中的數據複製到數據包的元數據中，並在後續的匹配中使用。</p><p>4）instance_count</p><p>該屬性用以記錄寄存器實例數，如果寄存器設定了direct屬性，則無法在寄存器中設定該屬性；如果寄存器中未設定direct屬性，則該屬性必須設定。</p><h1>3 結語</h1><p>以上是參考P4語言規範標準並結合個人的理解所寫，希望能讓不瞭解P4的人能有個基本的認識，同時起到拋磚引玉的作用。對P4感興趣的同學可以加入到P4微信交流群中與大牛們一起討論。郵箱：lengzhiyuan@fnii.com 微信號：cool_leng</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>P4</a></li><li><a>語言</a></li><li><a>編程</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/8ba54309.html alt=C語言編程第19講——斷言的使用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/92ee4886-fdd7-4a4a-b45a-d647ef966836 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8ba54309.html title=C語言編程第19講——斷言的使用>C語言編程第19講——斷言的使用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dd5b00b1.html alt=嵌入式C語言基礎編程—5年程序員給你講函數，你真的懂函數嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/40851dc497a8409bbff6a6aae1e42e8b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dd5b00b1.html title=嵌入式C語言基礎編程—5年程序員給你講函數，你真的懂函數嗎？>嵌入式C語言基礎編程—5年程序員給你講函數，你真的懂函數嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e2c14705.html alt=C語言編程知識總結，思維導圖版本，事半功倍！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/721353b3b68a41059d980e19083d03e7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e2c14705.html title=C語言編程知識總結，思維導圖版本，事半功倍！>C語言編程知識總結，思維導圖版本，事半功倍！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/293e60e3.html alt=Rust編程語言初探 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/b47797c4e0b5476e86050d174aea893c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/293e60e3.html title=Rust編程語言初探>Rust編程語言初探</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/34838dce.html alt=C精品編程之——指針，C語言的精髓，每個編程初學者的噩夢 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a0b5a50b90804963b14ab394517ae294 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/34838dce.html title=C精品編程之——指針，C語言的精髓，每個編程初學者的噩夢>C精品編程之——指針，C語言的精髓，每個編程初學者的噩夢</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8f9d60af.html alt=自然語言與編程語言的不同之處 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/2212e09b2dac4c80a8c3e8b80da92bb1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8f9d60af.html title=自然語言與編程語言的不同之處>自然語言與編程語言的不同之處</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/82646fb0.html alt=C/C++編程筆記：C語言編程知識要點總結！大一C語言知識點（全） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d208ccdc7f074f67a257d52df74e4f48 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/82646fb0.html title=C/C++編程筆記：C語言編程知識要點總結！大一C語言知識點（全）>C/C++編程筆記：C語言編程知識要點總結！大一C語言知識點（全）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1d74ece6.html alt=C語言編程入門必做的76題（加速你的學習效率） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/76e1f716eb894036a029992b044b5036 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1d74ece6.html title=C語言編程入門必做的76題（加速你的學習效率）>C語言編程入門必做的76題（加速你的學習效率）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/de0da135.html alt=C語言編程實例3 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/870917da8c744479b2ec65ee0173974e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/de0da135.html title=C語言編程實例3>C語言編程實例3</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9e4e4f6f.html alt=C語言編程實例4 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/870917da8c744479b2ec65ee0173974e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9e4e4f6f.html title=C語言編程實例4>C語言編程實例4</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/daee4c3b.html alt=C語言編程筆記丨利用C語言寫一個小程序——胖胖的愛心桃 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/df26c625ad3d44d4b515522c28f5462c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/daee4c3b.html title=C語言編程筆記丨利用C語言寫一個小程序——胖胖的愛心桃>C語言編程筆記丨利用C語言寫一個小程序——胖胖的愛心桃</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7b754ba6.html alt="C語言編程筆記丨編寫第一個C語言程序'hello world'，我教你哇" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/ad42f4fc-8976-4d2d-81e8-c62c3808e213 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7b754ba6.html title="C語言編程筆記丨編寫第一個C語言程序'hello world'，我教你哇">C語言編程筆記丨編寫第一個C語言程序'hello world'，我教你哇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/462f5440.html alt=實用C語言編程（第三版）高清PDF class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/dfic-imagehandler/31d1bba3-4fda-47c1-8435-00e90b1c2930 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/462f5440.html title=實用C語言編程（第三版）高清PDF>實用C語言編程（第三版）高清PDF</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0aa68fb2.html alt=那些主流編程語言的知識，C語言 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ea2299c59ca0407b8cf1263f5a4c42f0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0aa68fb2.html title=那些主流編程語言的知識，C語言>那些主流編程語言的知識，C語言</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b9591576.html alt="C 語言簡單編程速成" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/314ac7c9291d4dd99b90139ea102b5c3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b9591576.html title="C 語言簡單編程速成">C 語言簡單編程速成</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>