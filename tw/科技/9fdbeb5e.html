<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>探究HashMap線性不安全（二）——鏈表成環的詳細過程 | 极客快訊</title><meta property="og:title" content="探究HashMap線性不安全（二）——鏈表成環的詳細過程 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/28a6f8f609e24e679faf365e1b4ebf57"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9fdbeb5e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9fdbeb5e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9fdbeb5e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9fdbeb5e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9fdbeb5e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9fdbeb5e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/9fdbeb5e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/9fdbeb5e.html><meta property="article:published_time" content="2020-10-29T21:09:58+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:58+08:00"><meta name=Keywords content><meta name=description content="探究HashMap線性不安全（二）——鏈表成環的詳細過程"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/9fdbeb5e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>探究HashMap線性不安全（二）——鏈表成環的詳細過程</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>網上很多資料都詳細地講解了HashMap底層的實現，但是講到HashMap的併發操作不是線性安全時，往往一筆帶過：<strong>在多個線程併發擴容時，會在執行transfer()方法轉移鍵值對時，造成鏈表成環，導致程序在執行get操作時形成死循環</strong>。</p><p>​ 對於沒有研究過該過程的童鞋，很難費解這句話的含義。下面筆者分四個小節帶著大家共同研究一下JDK1.7和JDK1.8版本下HashMap的線性不安全是怎麼造成的，詳細探究鏈表成環的形成過程。如果對於HashMap底層的put、get操作不清楚。</p><p>本節將詳細探究HashMap擴容的鍵值對遷移過程，多線程併發執行transfer()方法是如何產生環形鏈表的。transfer()方法的代碼為：</p><p>如果想學習Java工程化、高性能及分佈式、深入淺出。微服務、Spring，MyBatis，Netty源碼分析的朋友可以加我的Java高級交流：854630135，群裡有阿里大牛直播講解技術，以及Java大型互聯網技術的視頻免費分享給大家。</p><pre> 1 void transfer(Entry[] newTable, boolean rehash) { 2 int newCapacity = newTable.length; 3 //遍歷table數組中鍵值對鏈 4 for (Entry&lt;K,V&gt; e : table) { 5 //遍歷鍵值對e鏈上的所有鍵值對，當e指向null時結束 6 while(null != e) { 7 Entry&lt;K,V&gt; next = e.next;//斷點一 8 //通常rehash為false，不會重新計算鍵值對key的hash值 9 if (rehash) {10 e.hash = null == e.key ? 0 : hash(e.key);11 }12 //根據擴容後的table數組長度計算鍵值對的index13 int i = indexFor(e.hash, newCapacity);14 //頭插法，將後遍歷的鍵值對存到鏈條的頭部15 e.next = newTable[i];16 newTable[i] = e;17 //鏈條中的下一個鍵值對繼續執行while循環。18 e = next;19 }20 }21 }</pre><p>情景：</p><p>​ 兩個線程A、B同時向HashMap中寫入鍵值對，某個時刻HashMap已經到了Resize的臨界點。由於多線程的執行沒有必然的先後順序，存在線程A未完成擴容，而線程B又進行擴容的情況，即兩個線程都可能會執行擴容方法transfer()。此時兩個線程都會遍歷table數組中的鍵值對鏈，對於每個鏈執行while循環，遷移所有鍵值對。</p><div class=pgc-img><img alt=探究HashMap線性不安全（二）——鏈表成環的詳細過程 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/28a6f8f609e24e679faf365e1b4ebf57><p class=pgc-img-caption></p></div><p><em>假定HashMap中table數組的初始長度為4</em></p><p>​ 假如線程A和線程B都遍歷到index為2的鍵值鏈（即Entry3->Entry2->null這條鏈）。由於CPU時間片分配的不確定性，線程B執行到代碼中斷點一的位置後暫停，<strong>此時線程B中的e指向Entry3，e.next指向Entry2。</strong>而線程A繼續執行，完成了擴容操作。HashMap的數據結構為下圖所示。</p><div class=pgc-img><img alt=探究HashMap線性不安全（二）——鏈表成環的詳細過程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1cea362cdb1c4b98aedfa1617c274425><p class=pgc-img-caption></p></div><p>​ <strong>重點！！</strong>：e和e.next為線程B中的引用變量，分別指向hashMap中的Entry3和Entry2。由於Entry3和Entry2是線程共享的，因此受線程A執行的影響，<strong>Entry3將指向null，Entry2指向Entry3</strong>。</p><p>​ 此時線程B中局部變量newTable的結構：</p><div class=pgc-img><img alt=探究HashMap線性不安全（二）——鏈表成環的詳細過程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0e1f714dd4f940b7bd5f1f258da2e489><p class=pgc-img-caption></p></div><p><strong>執行第一次循環：</strong>e為Entry3，e.next為Entry2（線程B暫停前e和e.next引用變量的指向）</p><pre> 1 //遍歷e所在鏈上的所有鍵值對 2 while(null != e) { 3 //斷點1，此時線程B中的e為Entry3，e.next為Entry2 4 Entry&lt;K,V&gt; next = e.next; 5 //通常rehash為false，不會重新計算鍵值對key的hash值 6 if (rehash) { 7 e.hash = null == e.key ? 0 : hash(e.key); 8 } 9 //根據擴容後的table數組長度計算鍵值對的index10 int i = indexFor(e.hash, newCapacity);11 //頭插法12 e.next = newTable[i];//將Entry3的next設置為null13 newTable[i] = e;//將Entry3放置到線程B newTable下標為3的位置14 //繼續處理Entry215 e = next;16 }</pre><p>如果想學習Java工程化、高性能及分佈式、深入淺出。微服務、Spring，MyBatis，Netty源碼分析的朋友可以加我的Java高級交流：854630135，群裡有阿里大牛直播講解技術，以及Java大型互聯網技術的視頻免費分享給大家。</p><p>執行完第一次循環後線程B中局部變量newTable的結構：</p><div class=pgc-img><img alt=探究HashMap線性不安全（二）——鏈表成環的詳細過程 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fc0c399f6be54fb3bf7244a4a0d3d48e><p class=pgc-img-caption></p></div><p>執行完第一次循環後hashMap對象的結構：</p><div class=pgc-img><img alt=探究HashMap線性不安全（二）——鏈表成環的詳細過程 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9bc6311d91a94b838c7e35f420e162d1><p class=pgc-img-caption></p></div><p><strong>執行第二次循環：</strong>e為Entry2，e.next為Entry3（受線程A影響，e和e.next引用變量的指向發生改變）</p><pre> 1 //遍歷鍵值對e鏈上的所有鍵值對 2 while(null != e) { 3 //斷點1，e為Entry2，e.next為Entry3 4 Entry&lt;K,V&gt; next = e.next; 5 //通常rehash為false，不會重新計算鍵值對key的hash值 6 if (rehash) { 7 e.hash = null == e.key ? 0 : hash(e.key); 8 } 9 //由線程A的執行結果可知，Entry2的index也為310 int i = indexFor(e.hash, newCapacity);11 //頭插法，12 e.next = newTable[i];//將Entry2的next設置為Entry313 newTable[i] = e; //newTable[3]設置為Entry214 //另e等於Entry3，繼續執行while循環。15 e = next;16 }</pre><p>執行完第二次循環後線程B中局部變量newTable的結構：</p><div class=pgc-img><img alt=探究HashMap線性不安全（二）——鏈表成環的詳細過程 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e6d7751bd5bb4f0991a28a6cd405b674><p class=pgc-img-caption></p></div><p>執行完第二次循環後hashMap對象的結構：</p><div class=pgc-img><img alt=探究HashMap線性不安全（二）——鏈表成環的詳細過程 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15a1197066444c87bb0de2f3e822480f><p class=pgc-img-caption></p></div><p><strong>執行第三次循環：</strong>e變為Entry3，e.next為null</p><pre> 1 //遍歷鍵值對e鏈上的所有鍵值對 2 while(null != e) { 3 //斷點1，此時線程B中的e變為Entry3，e.next為null 4 Entry&lt;K,V&gt; next = e.next; 5 //通常rehash為false，不會重新計算鍵值對key的hash值 6 if (rehash) { 7 e.hash = null == e.key ? 0 : hash(e.key); 8 } 9 //由線程A的執行結果可知，Entry3的index為310 int i = indexFor(e.hash, newCapacity);11 //頭插法12 e.next = newTable[i];//將Entry3的next設置為當前鏈條的首個鍵值對Entry213 newTable[i] = e;//newTable[3]設置為Entry314 //另e=next=null，結束while循環。15 e = next;16 }</pre><p>執行完第三次循環後線程B中局部變量newTable的結構：</p><div class=pgc-img><img alt=探究HashMap線性不安全（二）——鏈表成環的詳細過程 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0ee04445a05541b091392035b09163cc><p class=pgc-img-caption></p></div><p>執行完第三次循環後hashMap對象的結構：</p><div class=pgc-img><img alt=探究HashMap線性不安全（二）——鏈表成環的詳細過程 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a4703070129f4f39a502c19b9b22da4a><p class=pgc-img-caption></p></div><p>​ 至此，線程B因為改變了Entry3的next屬性，在hashMap對象中產生了環形鏈表。下一節，將探究環形鏈表是如何在hashMap查詢時產生死循環的。</p><p>歡迎工作一到八年的Java工程師朋友們加入Java高級交流：854630135</p><p>本群提供免費的學習指導 架構資料 以及免費的解答</p><p>不懂得問題都可以在本群提出來 之後還會有直播平臺和講師直接交流噢</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>HashMap</a></li><li><a>線性</a></li><li><a>鏈表成環</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/2ab3719e.html alt=終於有人把梯度下降、線性迴歸、邏輯迴歸講明白了 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3553afe761fd4eea86e31ba84eb1ffeb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2ab3719e.html title=終於有人把梯度下降、線性迴歸、邏輯迴歸講明白了>終於有人把梯度下降、線性迴歸、邏輯迴歸講明白了</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2cb59e3c.html alt=瞭解HashMap底層設計思想，教你手寫一個迷你版的HashMap class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d7714f65761648ee9b73a6bd5cca2fcb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2cb59e3c.html title=瞭解HashMap底層設計思想，教你手寫一個迷你版的HashMap>瞭解HashMap底層設計思想，教你手寫一個迷你版的HashMap</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3a5fae7e.html alt=HashMap源碼分析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4852d5083ec340be9f50ded10636e4b0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3a5fae7e.html title=HashMap源碼分析>HashMap源碼分析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c78a6fe2.html alt=HashMap的底層實現 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/0f9ffe95e10e4ff5804a8fd9cf591cfc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c78a6fe2.html title=HashMap的底層實現>HashMap的底層實現</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b10623ce.html alt=你不得不知道的HashMap面試連環炮 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/278ed0687f4d436f9cb8389a38b1603e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b10623ce.html title=你不得不知道的HashMap面試連環炮>你不得不知道的HashMap面試連環炮</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ae15b401.html alt="有關 HashMap 面試會問的一切" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/25263d0d73a143bab5e44096efdd931d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ae15b401.html title="有關 HashMap 面試會問的一切">有關 HashMap 面試會問的一切</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/84501417.html alt="為什麼 HashMap 的加載因子是0.75？" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6cbd09e4427c44c082e15ec40e24b6f5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/84501417.html title="為什麼 HashMap 的加載因子是0.75？">為什麼 HashMap 的加載因子是0.75？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3e2c89d5.html alt="面試官：為什麼 HashMap 的加載因子是0.75？" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/15a700f4ff6a4082a566db903915ea1b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3e2c89d5.html title="面試官：為什麼 HashMap 的加載因子是0.75？">面試官：為什麼 HashMap 的加載因子是0.75？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a0cd0159.html alt="「基底 / 線性組合 / 線性無關（相關）」-圖解線性代數 02" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/46f2000254161c118e69 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a0cd0159.html title="「基底 / 線性組合 / 線性無關（相關）」-圖解線性代數 02">「基底 / 線性組合 / 線性無關（相關）」-圖解線性代數 02</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8d93e49d.html alt=教程：採用梯度下降算法實現線性迴歸！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1537162000876f4501fb1c4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8d93e49d.html title=教程：採用梯度下降算法實現線性迴歸！>教程：採用梯度下降算法實現線性迴歸！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/68e43757.html alt=各種元器件主要物質的線性熱膨脹係數總彙 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/152974163166004c9f2ef5b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/68e43757.html title=各種元器件主要物質的線性熱膨脹係數總彙>各種元器件主要物質的線性熱膨脹係數總彙</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e3a19efd.html alt=線性膨脹係數在注塑產品中的應用（附常用塑料線型膨脹係數） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d26c39925f264665bd3f98663b4e253e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e3a19efd.html title=線性膨脹係數在注塑產品中的應用（附常用塑料線型膨脹係數）>線性膨脹係數在注塑產品中的應用（附常用塑料線型膨脹係數）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3f0b36db.html alt=線性代數精華——從正交向量到正交矩陣 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3b3ba2948df841a4b0390e47943645f6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3f0b36db.html title=線性代數精華——從正交向量到正交矩陣>線性代數精華——從正交向量到正交矩陣</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/af891b6b.html alt=線性降壓電源電路，講解與分析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e29c11d3fbea4bcaaf7823dbe2a04169 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/af891b6b.html title=線性降壓電源電路，講解與分析>線性降壓電源電路，講解與分析</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/148c5870.html alt=2020考研數學知識點：線性代數重點（齊不齊線性方程組） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/879e80be-ff43-494c-a308-b71e8652e763 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/148c5870.html title=2020考研數學知識點：線性代數重點（齊不齊線性方程組）>2020考研數學知識點：線性代數重點（齊不齊線性方程組）</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>