<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>2019 SDC 議題回顧 | Android容器和虛擬化 | 极客快訊</title><meta property="og:title" content="2019 SDC 議題回顧 | Android容器和虛擬化 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/bf1f7be229784a7685be853b047de0d3"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a89f3e98.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a89f3e98.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a89f3e98.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a89f3e98.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a89f3e98.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a89f3e98.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a89f3e98.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a89f3e98.html><meta property="article:published_time" content="2020-11-14T21:02:38+08:00"><meta property="article:modified_time" content="2020-11-14T21:02:38+08:00"><meta name=Keywords content><meta name=description content="2019 SDC 議題回顧 | Android容器和虛擬化"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/a89f3e98.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>2019 SDC 議題回顧 | Android容器和虛擬化</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>自Android誕生以來，憑藉其<strong>系統開源且免費</strong>的特性，受到了不少用戶和手機玩家的喜愛。</p><p>由於用戶的應用場景和需求也在時刻變化，只安裝了一個操作系統的智能手機愈來愈無法滿足用戶日益複雜的<strong>個性化需求</strong>，同時也缺乏對用戶隱私數據的保護。</p><p>原生 Android 系統的市佔率不斷下滑，越來越多的<strong>定製 Android 系統</strong>佔領了手機市場。各種<strong>新功能層出不窮</strong>。那麼Android 容器有哪些新玩法呢？</p><p>下面就讓我們來回顧看雪2019安全開發者峰會上<strong>《Android容器和虛擬化》</strong>的精彩內容。</p><p><strong>編輯按</strong></p><p><strong>crownless：</strong>目前，通過容器技術和虛擬化技術，可以實現安卓APP多開、定製、代碼注入、進行各種控制，這給DIY甚至是灰產、黑產開闢了新的可能性，而且可以躲避一些殺毒軟件對惡意代碼的查殺。為了實現容器，需要對底層的技術有著深刻的理解，而且要考慮到易用程度。<strong>容器技術不僅是一門技術，也是一門藝術！</strong></p><p><strong>嘉賓介紹</strong></p><p class=ql-align-center><br></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bf1f7be229784a7685be853b047de0d3><p class=pgc-img-caption></p></div><p><strong>鄧維佳（ID：virjar）</strong>，畢業於四川大學軟件工程專業。目前致力於Android安全相關技術研究，包括App加固脫殼、Android群控技術、Android多開容器等。</p><p>講師圍繞Android容器，介紹了<strong>目前開源的容器方案和實現</strong> ，展現了多種思路，通過他的演講，觀眾深入理解了多開機制，以及如何通過容器的方式，繞過安全軟件的檢測等等。</p><p><strong>演講具體內容</strong></p><p>以下為速記全文：</p><p>最近幾年有挺多<strong>多開</strong>的實現，很多廠商都實現了，比如一些APP的多開或者多環境的功能，它們能實現我們對安卓手機裡同一個APP能夠存在登陸兩個帳號，在營銷等有很多應用。這裡比較流行的一個東西就是<strong>VA</strong>。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4f5b6ae368b44507ac684d0b01d79ada><p class=pgc-img-caption></p></div><p>這張圖是2016年開源的框架，這個框架裡能夠對同樣一個APP實現無限的分身，我們如果用來做灰產，或者通過這個模式對APP裡面的邏輯進行挾持、控制，是非常方便的。</p><p>我覺得<strong>VA是非常優秀的框架</strong>，在這裡它<strong>實現對安卓系統很多功能的類似於系統層面的包裝</strong>，作者安卓的瞭解已經出神入化了。</p><p>最近在安卓的hook等各種方面的發展，可能有其他思路可以<strong>把VA功能做更多擴展</strong>。做安全的都瞭解VA裡有兩個功能，就像多開跟簡單的控制。</p><p>我們做什麼？先看看<strong>VA架構圖</strong>，有同學把VA流程圖、架構圖做了一個梳理，但是因為我這裡想對VA有其他功能的變種，所以我這個圖跟大家認可的圖不一樣，主要是<strong>三個技術點</strong>，是VA本身的機理理念有三個最重要的模塊：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e05cbb03ca814c9ea06b27d8b79e76fe><p class=pgc-img-caption></p></div><p>一個是<strong>IO重定向</strong>。IO重定向能實現多種空間隔離的最基本原理，就是能通過對應文件系統的訪問，實現Relocation。</p><p>第二個模塊是<strong>插樁子系統</strong>。對於安卓原生來說，所有組件必須在Android清單文件裡配置，所以如果是在安卓基本組件不去註冊的話，那麼它是沒辦法去執行的。</p><p>但是在VA裡面我們實現免安裝去打開一個APP，它是怎麼實現的？主要是通過插樁，在裡面配置各種沒有實際意義的、但就是去系統裡佔位的一些配置項。</p><p>然後在VA裡面，它是以這種插裝的形式去系統申請資源，當資源申請到之後，它需要去對插裝裡的各種配置進行還原，比如把一個StubActivity還原成一個真實的Activity。</p><p>另外一塊是<strong>系統服務模擬</strong>，基本把SystemServer這一層做一次模擬，包括安卓系統的各種Manager，所以它有一個進程，這個進程代替了安卓的SystemServer的角色，這個進程非常複雜。所以，<strong>在VA裡面我們能夠通過這個工具、這個APP、這樣一個用戶操作的APP界面，實現分身、多開。</strong></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae5e1e33ef4443399be2a01ea3229746><p class=pgc-img-caption></p></div><p>畢竟VA是在一個虛擬的環境裡，我們能不能把這個VA模擬成單層的像一個APP一樣？比如我某個APP，然後通過VA，把它的圖標等等看起來跟跟原始APP一樣，就能夠<strong>實現我對這個APP進行定製、進行代碼注入、進行各種控制化</strong>，比如把廣告去掉，或者我們加自己的廣告，或者加自己的密碼攔截，壞事好事等等。</p><p>這個APP如果變成一個普通APP、普通APP，對於C端用戶來說，做轉化之後他看不出跟原始APP有區別。</p><p>所以VA本身看起來是有一個用戶界面需要去點擊、安裝、做各種配置，如果<strong>我把VA去進行一個包裝之後，讓VA的容器環境跟VA的內嵌的APK打包成一個的話，就變成現在這個樣子。</strong></p><p>來看這張圖，這個圖是拿著line做實驗，能看到上一張圖是在VA本身環境裡，在APP裡面進行的各種APP的打開、安裝等等。看這張圖，它其實是在安卓的VA的外面，我們看到這個圖裡有多個line的圖標。</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/376251d428744180bce8fc05fe26e1d4><p class=pgc-img-caption></p></div><p>所以對VA的分身，可以看<strong>這個VA本身一個APK裡面進行分身</strong>，除此之外，還有一種方式實現<strong>在APP層面的分身</strong>。做成這個樣子之後，它跟APP本身的痕跡可能就有些不一樣了，當然了，有其它的好處，我是哪一個APP，把APP處理、把APP分身，那麼就是它的漏洞。</p><p>所以如果我對現在流行那些的APP進行這樣的操作，然後實現一些代碼，最後實現各種控制，其實對於普通用戶來說，他是分辨不了的。</p><p>比如我們公司寫了一個APP，有些功能限制，我做一些插件、做一些什麼東西之後，我能夠把這個發放給一些普通人，這個時候它是不是做灰產、做黑產，或者做些DIY，這種大家都瞭解的東西。</p><p>另外可以進行<strong>有害的、有病毒的APP的隱藏</strong>，因為這個在VA裡面我們的APP可以實現免安裝的運行。在免安裝運行之後，所有APK的一些，比如有害的痕跡在VA裡是一個文件，這個文件可以進行轉儲、進行加密、進行壓縮等等。</p><p>這種情況下通過殺毒軟件、通過代碼痕跡的掃描，因為它只是一個資源，這時候常規的黃、賭、毒那些大家沒想到的有害的APP都可以經過這種方式包裝，包裝之後基本上有害殺毒軟件平臺對它進行痕跡檢測、特徵檢測也是檢測不出來的。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/827edcd909824d4fa68c3d1ad97b09fe><p class=pgc-img-caption></p></div><p>在VA層面上，對剛才的那張圖做了兩個改造，它要實現同樣一個APP進行分身，所以IO層面這個模塊依然是需要存在的。這不是這個圖裡面的，第一個APP應該是在進程外實現的單個APP單純的轉發。</p><p>除此之外，是我們<strong>把Stub系統的插裝模塊給去掉</strong>了，為什麼？因為在VA裡面它是需要免安裝一些運行APK，但是我如果拿已知的APK跟VA融合的，那麼這個APK本身的配置文件我們是知曉的，所以這時根本不需要做插裝。</p><p>為什麼這麼做？因為這個時候我們是已知的，本身對VA來說，它對插裝模塊有一些對原生系統的兼容性問題不是很好處理，我們<strong>把這個模塊去掉</strong>以後，那一塊<strong>兼容性基本不需要考慮</strong>了。</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae5e1e33ef4443399be2a01ea3229746><p class=pgc-img-caption></p></div><p>還一個是<strong>對於VA裡的SystemServer的模擬的服務層</strong>，服務層在我們這也不需要了，為什麼？我們現在對一個APP包裝就是VA的引擎加上我們自己的，VA引擎包括單個APP，我們說分身是在那個，APP是在外面分身的，這時我不需要再託管系統的各種功能、activity棧等，全都不需要了，這都可以抹掉了，抹掉之後我也不需要去考慮。</p><p>對於VA原生來說，它的開源版本從8.0之後基本就不怎麼支持了，主要是它需要一直去跟隨安卓本身框架源碼的變化，然後做些自己的patch、做自己的功能實現。如果我把這個模塊也拿掉的話，我也不需要考慮這一層兼容性的處理了。</p><p>但是這一層也還需要一點點，需要什麼？VA宿主apk的package和運行內部的apk所見的Package是不一樣的，package是安卓裡面唯一定位的一個APP的標誌。也就是說<strong>VA對於系統來說，它是VA的package，但是對於它內部運行的APP來說，它是自己的package。</strong></p><p>所以如果它想調用系統功能，比如想查看系統某個包的信息、調用其他APP的API，要經過SystemServer的調用，這時對於應用來說，他自己的包名發送給SystemServer時，SystemServer肯定認為這是一個不合法的包名。</p><p>所以我們還<strong>需要有一個簡單的模塊，這個模塊是package的Transefer。</strong>比如我這是io.m.app，然後我內部一個APP是com.a.b，com.a.b去調用API時，它肯定傳遞到自己的package，就是com.a.b，然後對於安卓系統來說，它能見到的是io.m.app。</p><p>所以我們需要這樣一個<strong>包的轉換的模塊功能</strong>。基於這個改造以後，上面那張圖就能實現了，相對來說它的痕跡，至少未來插裝系統是不需要了，SystemServer兼容性也不需要了。相對應的這兩層，我們做反VA、反容器的痕跡也會發生變化，在這種情況下，除了開始的io重定向的痕跡現在還沒抹掉。</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae5e1e33ef4443399be2a01ea3229746><p class=pgc-img-caption></p></div><p>還有一點是<strong>簽過簽名</strong>，因為對於安卓系統來說，它看到的簽名是宿主的簽名，但是對於內部APP來說，它的簽名是它自己的。所以我我們在服務這一層還是要<strong>保留簽名模擬功能</strong>。</p><p>當然，這個服務已經不是個進程了，而單純是個模塊了，它需要把原生的、把內部的簽名讀到，給它解析出來。當APP去獲取自己簽名時，要返回apk自己真實的簽名。</p><p>這是我現在研究的對VA的一種變形，但是這種改造方式是有問題的，就是它一定會存在兩個package的問題，為什麼兩個package？比如在外圍、在控制層面它是.io.virtual.app，但是對於它是com.a.b。com.a.b它到APP上自己去讀的時候，它所見到的文件路徑應該是” /data/data/自己的包名”，而不是”/data/data/.io.virtual.app”，但實際上這個文件夾在安卓系統是不存在的，也沒有權限讀寫的，它能讀寫的只是” /data/data/.io.virtual.app”。</p><p>那怎麼辦？所以文件的這個模塊是不存在的。我們想，能不能讓它存在？就是宿主的包名跟內部運行APP的包名完全一致的話，是不是可以？我是不是能把這個做得更像一點？</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae5e1e33ef4443399be2a01ea3229746><p class=pgc-img-caption></p></div><p>這是我後來發現的<strong>第二種思路</strong>，<strong>我們用加殼的思路去做這個容器</strong>。什麼叫加殼？<strong>加殼其實就是把原來別人的APP變成一些資源，然後做些加密，把APP的一些入口的信息替換成自己的，先運行殼代碼，殼代碼運行了之後把資源解密出來，解密出來之後把相關的數據還原、相關的流程還原，然後開始正常APK的流程。</strong></p><p>如果我讓這個殼APK在我的這個容器環境內運行的話，我是不是也能在有殼APP運行入口之前先運行我的代碼,然後我在把我的壞事做完之後，然後再把運行的控制權交給殼程序，讓它脫殼，殼脫完之後再進行業務邏輯的運行。所以我在殼的外面如果再套一層殼，是不是也能實現這些注入控制？</p><p>所以在存在加殼的情況下，如果對他進行<strong>重打包、功能改造、代碼修改</strong>是基本不現實的，但是如果我讓這個APP運行在我的環境裡，然後我用動態注入的方式，當這個APP運行在內存裡，我在進行一部分劫持，其實也是另一種重打包的思路，這就是第二種思路。</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1a49d63772c44f3bbff6e9c1212aeab1><p class=pgc-img-caption></p></div><p>這個時候看這張圖，黃色的地方是原生APK的資源，我會把我們的框架，就是我們自己殼外部的資源，跟原生我想處理的合併的這個APK資源進行融合，它們融合的方式就是把清單文件裡的入口修改成我們自己的入口，classes.dex是安卓的代碼資源文件，我把這個classes.dex所有的代碼文件全部替換成我自己的，再把這個Manifest的文件入口修正到我自己這裡。</p><p>這樣APP運行時肯定會先運行我外面這個入口代碼，外層這個APP運行之後，<strong>我去把資源文件裡面原生APK數據都進來，加載之後進行對象替換，以及各種模擬加殼加固的思路，把所有切換完之後，再把這個控制權交給APK。</strong>那麼它是有殼，它自己脫殼，它自己運行正常業務邏輯。</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae5e1e33ef4443399be2a01ea3229746><p class=pgc-img-caption></p></div><p>但是這個地方有一個問題。<strong>為什麼我們能夠去修改這個AndroidManifest.xml文件？</strong>現在很多APK是修改不了AndroidManifest.xml文件的，因為大部分有反資源重打包，有資源混淆對抗等等。</p><p>而且這個AndroidManifest.xml跟這個resource.arsc文件，它們是同時出現的，它們都是通過安卓aapt進行打包輸出的。通過apktool解存在資源混淆對抗的包的資源文件的話，一般都會失敗的。</p><p>但我這為什麼能改？其實<strong>原理很簡單</strong>，就是我<strong>並不需要把AndroidManifest.xml解成文本格式，以及把這個resource.arsc資源解成對應的資源文件，都不需要解。</strong>在安卓Manifest文件裡，它其實就是一個安卓ARSC的格式，在二進制層面我們可以往它的字符串常量池裡加一些常量，在二進制層面去修改它的數據內容。</p><p>我們現在不考慮簽名問題的話，其實在二進制層面修改，能夠把我們自己入口的classes配置修正到這個AndroidManifest裡面去。<strong>AndroidManifest.xml文件一定是需要被安卓系統解析的</strong>，所以它一定是不會存在這個層面的對抗，再怎麼混淆也不可能混淆到安卓系統無法識別，所以安卓系統能讀，那麼我這也就能讀、能改。</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae5e1e33ef4443399be2a01ea3229746><p class=pgc-img-caption></p></div><p>但是這種方式也是有<strong>一些弊端</strong>的，我們看看這張圖的最終效果，這是我們用套個殼的方式去運行APK，它有<strong>幾秒等待時間</strong>。這跟VA本身的運行機理一樣的，VA如果去打開一個沒有安裝的APP，它也是會有幾分鐘時間的等待。為什麼？在安卓5之後，所有的APK在安裝的時候需要有一個過程，需要把這個DEX轉成OAT的格式，這個過程在安裝過程中需要等待，小APP可能就很快，稍微大點的APP可能需要等5分鐘以上。</p><p>在這種套殼容器方案裡面，如果我們同步去等待這個資源的加載過程，大APP會有<strong>5、6分鐘的卡屏</strong>，這個卡屏對我們用戶來說不是很友好的，所以我們需要做一個跳轉的頁面。像剛才咱們需要做一個跳轉，這其實跟VA本身其實是一樣的，VA本身也是有一個安裝過程，只是大家在VA裡去安裝看apk，可以方便的現實進度條，看起來足夠友好。</p><p>能明顯的看到，用這個方案實現容器的話，一定需要做<strong>首頁的跳轉</strong>。所以在剛才那個AndroidManifest.xml裡面，我們第一個是把入口代碼修正到我們的入口去，第二是我們需要插入一個頁面，當頁面運行時我們需要一步的去進行dex2oat，當它執行完成之後回調，我們才把原生APP的入口打開。</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae5e1e33ef4443399be2a01ea3229746><p class=pgc-img-caption></p></div><p>這樣<strong>有一個好處</strong>，第一個，<strong>APK體積會小很多</strong>，相對代碼入口重編譯來說，它只需要存在外面殼的自己的幾個dex，很多資源是不需要的，所以說不會存在APK膨脹的問題，原來的這種方式打包的APP基本上也還是那麼大，但剛才說的是資源的對抗是不需要的，因為我們是在二進制層面直接修改Manifest的入口，我根本沒有對它進行資源的解包。</p><p>但是它有一個contentprovider的問題，我們都知道當appication初始化之後、啟動之後，它會安裝contentprovider，但是因為我們的contentprovider配置到Manifest裡面面，那麼它一定會進行contentprovider的安裝過程。</p><p>因為當我們的代碼沒有run起來之前，沒有把內部資源APK運行起來之前，我們是沒辦法拿到的classLoader。這是如果強行去安裝contentprovider的話，它是會報ClassNotFoundException的。</p><p>當然，很多時候contentprovider可能會需要<strong>同步調用</strong>，我們這個只能做成異步，因為它有延時，做成異步的話，對於調用方可能看到在報錯。但是如果我只是單純對這一個APP放到我們容器裡進行分析、進行插件的定製的話，其實對我們來說也是無所謂的。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/bc176e968a5846f3b974282eecf0f3d3><p class=pgc-img-caption></p></div><p><strong>基本的流程</strong>就是這個樣子，首先，APK啟用的時候會跑到我們這裡來，我們<strong>第一步</strong>需要把contentprovider安裝給hook掉，就是我們不能讓它在這時進行contentprovider安裝。contentprovider安裝時，先把contentprovider信息收集起來，但是我們現在先拒絕掉，<strong>第二步</strong>是判斷dex是不是需要同步加載，如果打開一個頁面時就同步加載內部容器內資源的話，它會卡屏幾分鐘，這時用戶肯定無法等待的。</p><p>這時如果不能同步加載，我們需要先打開activity，在activity裡面啟動異步線程，然後在進行APK的load，load之後如果是同步的話，比如後臺線程以及一些service，這些其他的在後臺的組件的話，那我們同步進行安裝處理。以及如果我之前曾經打開過這個，它其實已經進行了安裝，這時我不需要再進行異步的。<strong>完成之後</strong>，我們把classLoader替換掉。</p><p>classLoader替換掉之後，把資源也重置一下，指向我們自己媒資裡面另一個原生APK的地址，它會把資源也替換成原生APK的東西。然後我們再正常流程，模擬安卓啟動的過程，把appication創造起來，去模擬它的生命週期，再把contentprovider啟動。這時候ClassLoader已經出現了，那麼contentprovider可以安裝了，流程到這時，對原生APK來說，它看到的可能就以為是正常的流程。</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae5e1e33ef4443399be2a01ea3229746><p class=pgc-img-caption></p></div><p><strong>這是第二種思路</strong>，這個類似於VA的環境，然後在內部它是一個沒有安裝的APK的資源。所以本身跟VA很將近，但是跟VA相比來說，大家可以想象一下，如果你在VA裡在安裝一個VA是會有問題的，因為底層安卓的各種service底層有大量對象以package作為ID。然後我們這種方式實現了只有一個pacakge，就是容器外面的package跟我所運行apk資源的package是完全一樣的。</p><p><strong>第三種思路就是multiDex</strong>。在4.4以前一個APK文件一般只有一個Dex，但是我們業務會比較大，比如我們代碼越來越多，就會超過65535以上的限制，APK足夠大時需要進行dex分包，就需要存在multidex，但這個功能在4.4以前是需要單獨寫邏輯去兼容的，但是在5.0以後這個multidex被安卓原生控制了。</p><p>如果我能夠<strong>修改Manifest入口</strong>的話，那我往這個APK裡去附加一個我自己的dex文件，然後再把Manifest裡那個入口指向我自己、指向我的代碼。先運行我們的代碼，代碼運行之後，再把控制權交回原生的一些邏輯，<strong>通過這種思路也是能實現注入的。</strong></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/94078311c8184bd7b425fa599d7f0c73><p class=pgc-img-caption></p></div><p>但這種注入相對於我們重打包來說，我是沒有去修改dex的內容，所以對原生APK來說，它如果存在對抗邏輯的話，如果它去檢查dex的簽名或者dex文件指紋，也是檢查不出來什麼東西的，因為我根本沒對它進行任何修改。當然基於這個思路做的，是不會有啟動加載延時。</p><p>大家看到這個地方我用了XposedAPI，大家做安卓安全的都瞭解這個框架，我通過這個實現java代碼的hook。能看到我這個是能跳出來的，就是右邊代碼，左邊能看出來它這個。</p><p><strong>不管通過哪個手段，能夠把Xposed的一些功能實現引進來，這時至少在java層能夠hook所有java邏輯。</strong>所以我基於重打包的方式，通過寫java代碼，進行一些鉤子函數的代碼注入。其實動態hook實現重打包和源碼級別重打包相比，第一種更加方便。</p><p>然後我們把插件代碼跟原生想要攻擊apk合成一個APK，它就是單獨的另一個產品，比如廣告去掉之後做DIY。</p><p>大概的思路就是下面這張圖，這張圖裡所有資源都是我想要攻擊的APP的資源，除開在classes裡面新增了一個dex文件，這個dex文件是沒自己入口的邏輯。我修改改的只有AndroidManifest文件裡那個&lt;applicationname=”entry”>，只能從二進制層面去修改它的入口。和剛剛一樣，二進制層面修改AndroidManifest文件一定能夠成功，不存在所謂的資源對抗。</p><p><strong>最後一種思路是入口修改</strong>，為什麼我把這個放在最後講？因為現在已經有比較成熟的方案，我把dex入口層面的代碼進行重編譯，比如在殼代碼之前插入bootstrap指令，然後把這個代碼流程轉到我們定製的邏輯裡面去，進行我們的邏輯代碼執行之後再返回控制流。這個其實有幾個已經實現了。比如太極，xpatch。</p><p><strong>通過對AndroidManifest的解析，我們找到入口是那個dex，找到dex以後找到它的代碼文件</strong>，如果它是appication的話，在attachBaseContext的時候，加入我們的smali指令，或者如果它是MainActivity，在MainActivity的attachBaseContext加入插入smali指令。</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae5e1e33ef4443399be2a01ea3229746><p class=pgc-img-caption></p></div><p>但這有一個問題，<strong>有一個6535的問題</strong>，就是如果我進行dex文件的重新編譯的話，我們是增加了新的代碼到入口dex裡面，我們說的是dex文件本身裡面各種編碼都是兩個字節，各種字符串的數量全是在兩個字節，如果這個dex的某個數量已經是快接近於6萬多，如果我再新增一坨東西放到那個dex裡，它一旦超過了6535就會失敗了。</p><p>所以這個地方需要插入的東西，只能是一個淺層的，<strong>加入一個啟動代碼</strong>，這個啟動代碼僅僅是為了加載媒資裡我們自己的dex或者我們自己的APK資源。這樣我可能只需要加1個類，然後2、3個方法，實現媒資裡apk自動解碼，classesLoader的創建。這個APK加的東西很少，這種情況下不太有可能出現6535的限制問題。</p><p>如果說我把dex文件進行修改的話，它dex文件的特徵一定會有些變化，所以如果我進行dex文件檢測的話就能檢測出來，但實際也是不對的，為什麼？因為在安全的世界裡，你hook我也能hook，如果我把這個io重定向做了，讓她讀到了真實的apk資源就可以。</p><p>所以是這個流程，我們<strong>在入口進行重編譯</strong>，因為我們重打包，簽名是在所有容器裡、所有沙箱裡都需要去做的，所以<strong>其中一個重要功能就是對packageManager進行hook，實現簽名攔截，以及所有他們可能檢測的點、資源需要進行重定向，甚至把我們增加特徵抹除掉，然後再加載我們自己的插件，然後再到正常的啟動流程。</strong>這個針對於大部分APK來說也是能做到成功的。</p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ae5e1e33ef4443399be2a01ea3229746><p class=pgc-img-caption></p></div><p>整理一下，左邊是怎麼攻，右邊是怎麼防，因為我們進行重打包，PackageManager是需要我們hook的，它有<strong>兩種思路，一種是用代理的方式實現，一種是通過hook的方式，</strong>我其實是能夠去hook ART的一些東西。</p><p>如果它存在一些文件簽名，我通過重定向的方式讓它讀到真的，然後各種攔截，maps等各種都能偽造。最主要的就是兩個，就是第6條，我通過二進制層面去修改入口，能夠對抗資源混淆，但是代理痕跡是classLoader，classLoader不是指向/data/app的，而是指向/data/宿主裡面的。</p><p>還有就是針對於dex重編譯的話，dex特徵發生變化，可以在oat文件中找到特徵，<strong>這個最主要是在maps裡OAT文件，通過maps的內存描述能夠讀取到。然後可以檢查oat特徵的。</strong></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/be7f061a4623493db794e8309a6db1de><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>注意：點擊文末原文鏈接，即可查看本議題完整演講PPT。其他議題演講PPT，經過講師同意後會陸續放出，請大家持續關注看雪論壇及看雪學院公眾號！</p><p class=ql-align-center><br></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d61f8c950f1b45ca83f9169dff7886fb><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/aae4018e788a4666aa925cc120e5120e><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center><br></p><div class=pgc-img><img alt="2019 SDC 議題回顧 | Android容器和虛擬化" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1d0daf6c3351491796852c93157129aa><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-center>公眾號ID：ikanxue</p><p class=ql-align-center>官方微博：看雪安全</p><p class=ql-align-center>商務合作：wsc@kanxue.com</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>2019</a></li><li><a>SDC</a></li><li><a>議題</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/21d2ba3e.html alt=2019年土木畢業生要知道的那些事 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/21d2ba3e.html title=2019年土木畢業生要知道的那些事>2019年土木畢業生要知道的那些事</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/171b22b4.html alt=2019年度《特種鑄造及有色合金》優秀論文結果公佈 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/137c70000b816835d80bf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/171b22b4.html title=2019年度《特種鑄造及有色合金》優秀論文結果公佈>2019年度《特種鑄造及有色合金》優秀論文結果公佈</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/817e1015.html alt=2019年度《特種鑄造及有色合金》網絡評選結果出爐 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/66c26cbe459a4361b1d501e4bbac6c88 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/817e1015.html title=2019年度《特種鑄造及有色合金》網絡評選結果出爐>2019年度《特種鑄造及有色合金》網絡評選結果出爐</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/df18bcc1.html alt=金川集團公司2019年全國合金鑄造行業商洽會舉行 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/df18bcc1.html title=金川集團公司2019年全國合金鑄造行業商洽會舉行>金川集團公司2019年全國合金鑄造行業商洽會舉行</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3c5292d6.html alt="2019年度數字孿生城市之無人機 航攝應用及真三維建模技術培訓班" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3c5292d6.html title="2019年度數字孿生城市之無人機 航攝應用及真三維建模技術培訓班">2019年度數字孿生城市之無人機 航攝應用及真三維建模技術培訓班</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fcd2a59f.html alt=2019年最爆笑的120個名場面合集 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/dc6fcd05f35e499a9ef7a2d19ff9c66b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fcd2a59f.html title=2019年最爆笑的120個名場面合集>2019年最爆笑的120個名場面合集</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/715eacc1.html alt=《獅子王》2019：引入VR虛擬製作技術，顛覆動畫電影拍攝 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9a08cc2f25cb41c5be515de0d79879a9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/715eacc1.html title=《獅子王》2019：引入VR虛擬製作技術，顛覆動畫電影拍攝>《獅子王》2019：引入VR虛擬製作技術，顛覆動畫電影拍攝</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e342e11c.html alt="2019掌上生活10元風暴怎麼玩攻略 快速獲取小招喵方法" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/Rk8ZSn39iz0Be8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e342e11c.html title="2019掌上生活10元風暴怎麼玩攻略 快速獲取小招喵方法">2019掌上生活10元風暴怎麼玩攻略 快速獲取小招喵方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/67fef4c6.html alt=2019年高考，怎樣設置院校梯度才合理？衝、穩、保、墊，很關鍵！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/f8d17716-f3b8-4c6d-8eb7-f482334ad491 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/67fef4c6.html title=2019年高考，怎樣設置院校梯度才合理？衝、穩、保、墊，很關鍵！>2019年高考，怎樣設置院校梯度才合理？衝、穩、保、墊，很關鍵！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e18c5b5e.html alt=2019年正在流行的16個網頁設計趨勢 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RPgQdSQEjBTN6Z style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e18c5b5e.html title=2019年正在流行的16個網頁設計趨勢>2019年正在流行的16個網頁設計趨勢</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d72ed228.html alt=2019年中式烹調師（技師）安全生產模擬考試題庫及答案（一） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/fbcf9bc4d8224c309106305ad34adf9a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d72ed228.html title=2019年中式烹調師（技師）安全生產模擬考試題庫及答案（一）>2019年中式烹調師（技師）安全生產模擬考試題庫及答案（一）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d4044e1f.html alt=2019年中式烹調師（高級）安全生產模擬考試題庫及答案（一） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d4044e1f.html title=2019年中式烹調師（高級）安全生產模擬考試題庫及答案（一）>2019年中式烹調師（高級）安全生產模擬考試題庫及答案（一）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f855d5ae.html alt=2019年中式烹調師（高級）安全生產模擬考試題庫及答案（二） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9796cfd44f754f9ab22310d91088423e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f855d5ae.html title=2019年中式烹調師（高級）安全生產模擬考試題庫及答案（二）>2019年中式烹調師（高級）安全生產模擬考試題庫及答案（二）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9adee5f1.html alt=2019中式烹調師（技師）在線免費模擬考試系統及模擬題庫2 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d6a75905fb9346ccb6e4c8a304a79e63 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9adee5f1.html title=2019中式烹調師（技師）在線免費模擬考試系統及模擬題庫2>2019中式烹調師（技師）在線免費模擬考試系統及模擬題庫2</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/01e18262.html alt="2019級軍訓 | 蛻變中的成長，在西京學院我們一起經歷的軍訓" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/5e6d48b6fc5a49f480f9de7e22ab7958 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/01e18262.html title="2019級軍訓 | 蛻變中的成長，在西京學院我們一起經歷的軍訓">2019級軍訓 | 蛻變中的成長，在西京學院我們一起經歷的軍訓</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>