<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>多線程之ThreadLocal的那些事 | 极客快訊</title><meta property="og:title" content="多線程之ThreadLocal的那些事 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/58bb67505b204eef816b6e3b75935246"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a915e749.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a915e749.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a915e749.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a915e749.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a915e749.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a915e749.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/a915e749.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/a915e749.html><meta property="article:published_time" content="2020-11-14T21:07:43+08:00"><meta property="article:modified_time" content="2020-11-14T21:07:43+08:00"><meta name=Keywords content><meta name=description content="多線程之ThreadLocal的那些事"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/a915e749.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>多線程之ThreadLocal的那些事</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>ThreadLocal我確實從來沒用過，前段時間面試官曰：“知道ThreadLocal嗎？講講你對ThreadLocal的理解”</p><p>懵了，故今天總結一下。</p><p>在多線程環境下，如何防止自己的變量被其它線程篡改？ThreadLocal解決的就是這個問題。</p><p><strong>一、什麼是ThreadLocal?</strong></p><p>ThreadLocal實現線程封閉，是Java裡一種特殊的變量。</p><p>它是一個線程級別變量，每個線程都有一個ThreadLocal就是每個線程都擁有了自己獨立的一個變量，競爭條件被徹底消除了，在併發模式下是絕對安全的變量。</p><p>ThreadLocal提供了線程的局部變量，每個線程都可以通過set()和get()來對這個局部變量進行操作，但不會和其他線程的局部變量進行衝突，實現了線程的數據隔離。</p><p>一個ThreadLocal在一個線程中是共享的，在不同線程之間又是隔離的（每個線程都只能看到自己線程的值）</p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/58bb67505b204eef816b6e3b75935246><p class=pgc-img-caption>ThreadLocal是什麼</p></div><p><strong>二、深入解析ThreadLocal類</strong></p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8f62cf64de174ff985df0bb7541401ec><p class=pgc-img-caption>ThreadLocal內部結構</p></div><p>1.從上面的結構圖，我們可以看到ThreadLocal的核心機制：</p><p>每個Thread線程內部都有一個Map。</p><p>Map裡面存儲線程本地對象（key）和線程的變量副本（value）</p><p>但是，Thread內部的Map是由ThreadLocal維護的，由ThreadLocal負責向map獲取和設置線程的變量值。</p><p>所以對於不同的線程，每次獲取副本值時，別的線程並不能獲取到當前線程的副本值，形成了副本的隔離，互不干擾</p><p>2.瞭解一下ThreadLocal類提供的幾個方法：</p><pre>	public T get() {}	public void set(T value) {}	public void remove() {}	protected T initialValue() {}</pre><p>get()方法用於獲取當前線程的副本變量值。</p><p>set()方法用於保存當前線程的副本變量值。</p><p>initialValue()為當前線程初始副本變量值。</p><p>remove()方法移除當前前程的副本變量值。</p><p><strong>get()方法</strong></p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d9a12af04e364f52b02d7c2c829df150><p class=pgc-img-caption>get()方法</p></div><p>步驟：</p><p>1>獲取當前線程的ThreadLocalMap對象threadLocals</p><p>2>從map中獲取線程存儲的K-V Entry節點。</p><p>3>從Entry節點獲取存儲的Value副本值返回。</p><p>4>map為空的話返回初始值null，即線程變量副本為null，在使用時需要注意判斷NullPointerException。</p><p><strong>set()方法</strong></p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/45b2aa032b214d1b924a6fdf826a3006><p class=pgc-img-caption>set()方法</p></div><p>步驟：</p><p>1>獲取當前線程的成員變量map</p><p>2>map非空，則重新將ThreadLocal和新的value副本放入到map中。</p><p>3>map空，則對線程的成員變量ThreadLocalMap進行初始化創建，並將ThreadLocal和value副本放入map中。</p><p><strong>remove()方法</strong></p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f71d562563fa49c69b2282d60b36db7f><p class=pgc-img-caption>remove()方法</p></div><p>步驟：</p><p>1>獲取當前線程的ThreadLocalMap對象threadLocals</p><p>2>不為空，直接移除掉</p><p><strong>initialValue()方法</strong></p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c2e2921f9c644af8854894529bf2db29><p class=pgc-img-caption>initialValue()方法</p></div><p>1>實際就是get()初始化值</p><p>3.ThreadLocalMap</p><p>ThreadLocalMap是ThreadLocal的內部類，沒有實現Map接口，用獨立的方式實現了Map的功能，其內部的Entry也獨立實現。</p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d362ee3fef5642928fa6f12292edddf3><p class=pgc-img-caption>ThreadLocalMap類圖</p></div><p>在ThreadLocalMap中，也是用Entry來保存K-V結構數據的。但是Entry中key只能是ThreadLocal對象，這點被Entry的構造方法已經限定死了。</p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a45d3472483346e9b7db3645624c79bd><p class=pgc-img-caption>ThreadLocal對象</p></div><p>Entry繼承自WeakReference（弱引用，生命週期只能存活到下次GC前），但只有Key是弱引用類型的，Value並非弱引用。</p><p>ThreadLocalMap的成員變量：</p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5e13ffbf962b4c03a8d9589f197fd555><p class=pgc-img-caption>ThreadLocalMap的成員變量</p></div><p>Hash衝突怎麼解決</p><p>和HashMap的最大的不同在於，ThreadLocalMap結構非常簡單，沒有next引用，也就是說ThreadLocalMap中解決Hash衝突的方式並非鏈表的方式，而是採用線性探測的方式，所謂線性探測，就是根據初始key的hashcode值確定元素在table數組中的位置，如果發現這個位置上已經有其他key值的元素被佔用，則利用固定的算法尋找一定步長的下個位置，依次判斷，直至找到能夠存放的位置。</p><p>ThreadLocalMap解決Hash衝突的方式就是簡單的步長加1或減1，尋找下一個相鄰的位置。</p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/71402fe9aeee4a4e802e9b8244c5db7a><p class=pgc-img-caption>Hash衝突</p></div><p>顯然ThreadLocalMap採用線性探測的方式解決Hash衝突的效率很低，如果有大量不同的ThreadLocal對象放入map中時發送衝突，或者發生二次衝突，則效率很低。</p><p><strong>所以這裡引出的良好建議是：每個線程只存一個變量，這樣的話所有的線程存放到map中的Key都是相同的ThreadLocal，如果一個線程要保存多個變量，就需要創建多個ThreadLocal，多個ThreadLocal放入Map中時會極大的增加Hash衝突的可能。</strong></p><p>ThreadLocalMap的問題</p><p>由於ThreadLocalMap的key是弱引用，而Value是強引用。這就導致了一個問題，ThreadLocal在沒有外部對象強引用時，發生GC時弱引用Key會被回收，而Value不會回收，如果創建ThreadLocal的線程一直持續運行，那麼這個Entry對象中的value就有可能一直得不到回收，發生內存洩露。</p><p><strong>如何避免洩漏</strong></p><p>既然Key是弱引用，那麼我們要做的事，就是在調用ThreadLocal的get()、set()方法時完成後再調用remove方法，將Entry節點和Map的引用關係移除，這樣整個Entry對象在GC Roots分析後就變成不可達了，下次GC的時候就可以被回收。</p><p>如果使用ThreadLocal的set方法之後，沒有顯示的調用remove方法，就有可能發生內存洩露，所以養成良好的編程習慣十分重要，使用完ThreadLocal之後，記得調用remove方法。</p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fed54ee3b97b4784917f9ddc3b8dcfde><p class=pgc-img-caption>remove</p></div><p><strong>三、ThreadLocal原理總結</strong></p><p>每個Thread維護著一個ThreadLocalMap的引用;</p><p>ThreadLocalMap是ThreadLocal的內部類，用Entry來進行存儲;</p><p>調用ThreadLocal的set()方法時，實際上就是往ThreadLocalMap設置值，key是ThreadLocal對象，值是傳遞進來的對象;</p><p>調用ThreadLocal的get()方法時，實際上就是往ThreadLocalMap獲取值，key是ThreadLocal對象;</p><p>ThreadLocal本身並不存儲值，它只是作為一個key來讓線程從ThreadLocalMap獲取value。</p><p>實在難以理解的，可以理解為，JVM維護了一個Map&lt;Thread, T>，每個線程要用這個T的時候，用當前的線程去Map裡面取。</p><p><strong>四、ThreadLocal的應用場景</strong></p><p>最常見的ThreadLocal使用場景為 用來解決 數據庫連接、Session管理等。(我自己真的沒用過)</p><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e6d3a89f7f0b40169bc022bae3b84f92><p class=pgc-img-caption>數據庫連接</p></div><div class=pgc-img><img alt=多線程之ThreadLocal的那些事 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/10603ff3085f4894aabb5f780205e817><p class=pgc-img-caption>Session管理</p></div><p>自己也沒用過，本文大部分來源網絡。</p><p>歡迎指正留言</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>多線程</a></li><li><a>ThreadLocal</a></li><li><a>那些</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/1682b802.html alt=那些被美國放棄了的領土 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/c63001da9ddf42f79b1748701c08462e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1682b802.html title=那些被美國放棄了的領土>那些被美國放棄了的領土</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1c9afde0.html alt="一起來談談ThreadLocal 原理吧！你需要了解！" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/499a403f2b63464db8e3e12298c1a3e5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1c9afde0.html title="一起來談談ThreadLocal 原理吧！你需要了解！">一起來談談ThreadLocal 原理吧！你需要了解！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ef5bd4a5.html alt=從源碼角度來剖析ThreadLocal到底有沒有內存洩漏？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/67412c6e1bba450b9581452ab0e56e4c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ef5bd4a5.html title=從源碼角度來剖析ThreadLocal到底有沒有內存洩漏？>從源碼角度來剖析ThreadLocal到底有沒有內存洩漏？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4bac2fc4.html alt=這4種ThreadLocal你都知道嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/02621283c0574fd79fbb6ff5ea971384 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4bac2fc4.html title=這4種ThreadLocal你都知道嗎？>這4種ThreadLocal你都知道嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2eecc1b9.html alt=面試再問ThreadLocal，別說你不會 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3a95ff3cd79a456d9221f66851f8c2f9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2eecc1b9.html title=面試再問ThreadLocal，別說你不會>面試再問ThreadLocal，別說你不會</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cd56e2f3.html alt=PHP進階教程-PHP還能玩多線程？看我怎麼用多線程實現CC攻擊器。 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/cce9b3fb23ce41b88311823510e419da style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cd56e2f3.html title=PHP進階教程-PHP還能玩多線程？看我怎麼用多線程實現CC攻擊器。>PHP進階教程-PHP還能玩多線程？看我怎麼用多線程實現CC攻擊器。</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ee2728c4.html alt="Java核心知識 多線程併發 進程調度算法 （三十二）" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ee53d84c407e492494d103a3f7a9481c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ee2728c4.html title="Java核心知識 多線程併發 進程調度算法 （三十二）">Java核心知識 多線程併發 進程調度算法 （三十二）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d0d960f5.html alt=當我們在說“併發、多線程”，說的是什麼 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d0d960f5.html title=當我們在說“併發、多線程”，說的是什麼>當我們在說“併發、多線程”，說的是什麼</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/24e8bf5d.html alt=那些年讓你迷惑的並行、併發、多線程、多進程、協程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a92ab724f71b4c36a8fdefd01f9e087a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/24e8bf5d.html title=那些年讓你迷惑的並行、併發、多線程、多進程、協程>那些年讓你迷惑的並行、併發、多線程、多進程、協程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/48c90bcc.html alt=熬了兩個通宵寫的！終於把多線程和多進程徹底講明白了！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8e306d12189741e4a3b8a74c64dec558 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/48c90bcc.html title=熬了兩個通宵寫的！終於把多線程和多進程徹底講明白了！>熬了兩個通宵寫的！終於把多線程和多進程徹底講明白了！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1ad88931.html alt=帶你搞定多線程，併發編程關鍵字Java多線程之volatile class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/79e01a43526949a3b1ce35f41d4f0d5e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1ad88931.html title=帶你搞定多線程，併發編程關鍵字Java多線程之volatile>帶你搞定多線程，併發編程關鍵字Java多線程之volatile</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4036c1ac.html alt=你想知道的，編制那些事兒 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/44bcc4f47c474752b4bb864f7230fde1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4036c1ac.html title=你想知道的，編制那些事兒>你想知道的，編制那些事兒</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e16da24f.html alt=建築業資質那些事 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/06d79307-9cd9-4316-82b1-5d3d7ee20a47 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e16da24f.html title=建築業資質那些事>建築業資質那些事</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3497065f.html alt=煤質活性炭的那些事 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/48a35dd8e5e0472fae8034eb99b891c7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3497065f.html title=煤質活性炭的那些事>煤質活性炭的那些事</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6a388fab.html alt="主板上的那些接口 你會用嗎？" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1a80fd9ad51548888323112d9dd16395 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6a388fab.html title="主板上的那些接口 你會用嗎？">主板上的那些接口 你會用嗎？</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>