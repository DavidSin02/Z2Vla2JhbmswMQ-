<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>技術分享：四個全新維度，高效優化你的HTTP性能 | 极客快訊</title><meta property="og:title" content="技術分享：四個全新維度，高效優化你的HTTP性能 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/dfic-imagehandler/8d0df2bf-ac95-4f50-afa6-e2494069d42f"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ac5faa21.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ac5faa21.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ac5faa21.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ac5faa21.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ac5faa21.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ac5faa21.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ac5faa21.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ac5faa21.html><meta property="article:published_time" content="2020-11-14T21:01:37+08:00"><meta property="article:modified_time" content="2020-11-14T21:01:37+08:00"><meta name=Keywords content><meta name=description content="技術分享：四個全新維度，高效優化你的HTTP性能"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/ac5faa21.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>技術分享：四個全新維度，高效優化你的HTTP性能</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><blockquote class=pgc-blockquote-abstract><p>無論你在做前端、後端還是運維，HTTP都是不得不打交道的網絡協議。它是最常用的應用層協議，對它的優化，既能通過降低時延帶來更好的體驗性，也能通過降低資源消耗帶來更高的併發性。作者：陶輝；來源：高效運維</p></blockquote><p><br></p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/dfic-imagehandler/8d0df2bf-ac95-4f50-afa6-e2494069d42f><p class=pgc-img-caption></p></div><p><br></p><p>可是，學習HTTP不久的同學，很難全面說出HTTP的所有優化點。這既有可能是你沒好好準備過大廠的面試，也有可能你沒有加入一個快速發展的項目，當產品的用戶量不斷翻番時，需求會倒逼著你優化HTTP協議。</p><p>這篇文章是根據我在2019年GOPS全球運維大會上海站的演講PPT，重新提煉文字後的總結。我希望能從四個全新的維度，帶你覆蓋絕大部分的HTTP優化技巧。這樣，即使還不需要極致方法去解決當前的性能瓶頸，也會知道優化方向在哪，當需求來臨時，能夠到Google上定向查閱資料。</p><p>第一個維度，是從編碼效率上，更快速地把消息轉換成更短的字符流。這是最直接的性能優化點。</p><h2 class=pgc-h-arrow-right>一、編碼效率優化</h2><p>如果你對HTTP/1.1協議做過抓包分析，就會發現它是用“whitespace-delimited”方式編碼的。用空格、回車來編碼，是因為HTTP在誕生之初追求可讀性，這樣更有利於它的推廣。</p><p>然而在當下，這種低效的編碼方式已經嚴重影響性能了，所以2009年Google推出了基於二進制的SPDY協議，大幅提升了編碼效率。2015年，稍做改進後它被確定為HTTP/2協議，現在50%以上的站點都在使用它。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/803668c937794ed8a8b2b4a18f9cf512><p class=pgc-img-caption></p></div><p>這是編碼優化的大方向，包括即將推出的HTTP/3。</p><p>然而這些新技術到底是怎樣提升性能的呢？那還得拆開了看，先從數據的壓縮談起。你抓包看到的是數據，它並不等於信息。數據其實是信息和冗餘數據之和，而壓縮技術，就是儘量地去除冗餘數據。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6950341d70d342ddb5a56dc79055159d><p class=pgc-img-caption></p></div><p>壓縮分為無損壓縮和有損壓縮。針對圖片、音視頻，我們每天都在與有損壓縮打交道。比如，當瀏覽器只需要縮略圖時，就沒有必要浪費帶寬傳輸高清圖片。而高清視頻做過有損壓縮後，在肉眼無法分清時，已經被壓縮了上千倍。</p><p>這是因為，聲音、視頻都可以做增量壓縮。還記得曾經的VCD嗎？當光盤有劃痕時，整張盤都無法播放，就是因為那時的視頻做了增量壓縮，而且關鍵幀太少，導致關鍵幀損壞時，後面的增量幀全部無法播放了。</p><p>再來看無損壓縮，你肯定用過gzip，它讓http body實現了無損壓縮。肉眼閱讀壓縮後的報文全是亂碼，但接收端解壓後，可以看到發送端的原文。然而，gzip的效率其實並不高，以Google推出的brotli做對比，你就知道它的缺陷了：</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/db87ba1b1ebd4ddba4f8d1e415907d6a><p class=pgc-img-caption></p></div><p>評價壓縮算法時，我們重點看兩個指標：壓縮率和壓縮速度。上圖中可以看到，無論用gzip 9個壓縮級別中的哪一個，它的壓縮率都低於brotli（相比gzip，壓縮級別它還可以配置為10），壓縮速度也更慢。所以，如果可以，應該儘快更新你的gzip壓縮算法了。</p><p>說完對body的壓縮，再來看HTTP header的壓縮。對於HTTP/1.x來說，header就是性能殺手。特別是當下cookie氾濫的時代，每次請求都要攜帶幾個KB的頭部，很浪費帶寬、CPU、內存！HTTP2通過 HPACK 技術大幅度降低了header編碼後的體積，這也是HTTP3的演進方向。HPACK 到底是怎樣實現 header 壓縮的呢？</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8d7b4be245584378bd42f469f032e11d><p class=pgc-img-caption></p></div><p>HPACK通過Huffman算法、靜態表、動態表對三種header都做了壓縮。比如上圖中，method GET存在於靜態表，用1個字節表示的整數2表達即可；user-agent Mozilla這行頭部非常長，當它第2次出現時，用2個字節的整數62表示即可；即使它第1次出現時，也可以用Huffman算法壓縮Mozilla這段很長的瀏覽器標識符，可以獲得最多5/8的壓縮率。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0fa796fdaf9142938ba7b7e7c53f9420><p class=pgc-img-caption></p></div><p>靜態表中只存放最常見的header，有的只有name，有的同時包括name和value。靜態表的大小很有限，目前只有61個元素。</p><p>動態表應用了增量編碼的思想，即，第1次出現時加入動態表，第2次出現的時候，傳輸它在動態表中的序號即可。</p><p>Huffman編碼在winrar等壓縮軟件中廣為使用，但HPACK中的Huffman有所不同，它使用的是靜態huffman編碼。即，它統計了互聯網上幾年內的HTTP頭部，按照每個字符出現的概率，重建huffman樹，這樣，根據規則，出現次數最多的a、c、e或者1、2、3這些字符就只用5個bit位表示，而很少出現的字符則用幾十個bit位表示。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/895bb2ff1cad43ebbaf8e330f0e411e2><p class=pgc-img-caption></p></div><p>說完header，再來看http body的編碼。這裡只舉3個例子：1、只有幾十字節的小圖標，沒有必要用獨立的HTTP請求傳輸，根據RFC2397的規則，可以把它直接嵌入到HTML或者CSS文件中，而瀏覽器在解析時會識別出它們，就像下圖中的頭像：</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2cfc6a02d9344a31aaab849096512be8><p class=pgc-img-caption></p></div><p>2、JS源碼文件中，可能有許多小文件，這些文件中也有許多空行、註釋，通過WebPack工具，先在服務器端打包為一個文件，並去除冗餘的字符，編碼效果也很好。</p><p>3、在表單中，可以一次傳輸多個元素，比如既有複選框，也可以有文件。這就減少了HTTP請求的個數。</p><p>可見，http協議從header到 body，都有許多編碼手段，可以讓傳輸的報文更短小，既節省了帶寬，也降低了時延。</p><p>編碼效率優化完後，再來看“信道”，這雖然是通訊領域的詞彙，但用來概括HTTP的優化點非常合適，這裡就借用下了。</p><h2 class=pgc-h-arrow-right>二、信道利用率優化</h2><p>信道利用率包括3個優化點，第一個優化點是多路複用！高速的低層信道上，可以跑許多低速的高層信道。比如，主機上只有一塊網卡，卻能同時讓瀏覽器、微信、釘釘收發消息；一個進程可以同時服務幾萬個TCP連接；一個TCP連接上可以同時傳遞多個HTTP2 STREAM消息。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/85fafa3734f642febe87a3cbf4b35aab><p class=pgc-img-caption></p></div><p>其次，為了讓信道有更高的利用率，還得及時恢復錯誤。所以，TCP工作的很大一部分，都是在及時的發現丟包、亂序報文，並快速的處理它們。</p><p>最後，就像經濟學裡說的，資源總是稀缺的。有限的帶寬下，如何公平的對待不同的連接、用戶和對象呢？比如下載頁面時，如果把CSS和圖片以同等優先級下載就有問題，圖片晚點顯示沒關係，但CSS沒獲取到頁面就無法顯示。另外，傳輸消息時，報文頭報並不承載目標信息，但它又是必不可少的，如何降低這些控制信息的佔比呢？</p><p>我們先從多路複用談起。廣義上來說，多線程、協程都屬於多路複用，但這裡我主要指http2的stream。因為http協議被設計為client先發request，server才能回覆response，這樣收發消息，是沒辦法跑滿帶寬的。最有效率的方式是，發送端源源不斷地發請求、接收端源源不斷地發響應，這對於長肥網絡尤為有效：</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ae8b211c3c2d4400a8bf08f8063e732f><p class=pgc-img-caption></p></div><p>HTTP2的stream就是這樣複用連接的。我們知道，chrome對一個站點最多同時建立6個連接，而有了HTTP2後，只需要一個連接就能高效的傳輸頁面上的數百個對象。我特意讓我的個人站點www.taohui.pub同時支持HTTP1和HTTP2，下圖是連接視角上HTTP2和HTTP1的區別。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a0d25cb6837842fd8e3a75349bf9aa5c><p class=pgc-img-caption></p></div><p>熟悉chrome Network網絡面板的同學，肯定很熟悉waterfall，它可以幫助你分析HTTP請求到底慢在哪裡，是請求發出的慢，還是響應接收的慢，又或者是解析得太慢了。下圖還是我的站點在waterfall視角下的對比。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/58e5980cd5ed4d43a3ab334ead33df0c><p class=pgc-img-caption></p></div><p>從這兩張圖可以看出，HTTP2全面優於HTTP1。</p><p>再來看網絡錯誤的恢復。在應用層，lingering_time通過延遲關閉連接來避免瀏覽器因RST錯誤收不到http response，而timeout則是用定時器及時發現錯誤並釋放資源。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/67d78aa78b534a8e8f5eae9396ac96f6><p class=pgc-img-caption></p></div><p>在傳輸層，通過timestamp=1可以讓TCP更精準的測量出定時器的超時時間RTO。當然，timestamp還有一個用途，就是防止長肥網絡中的序列號迴繞。</p><p>什麼是序列號迴繞呢？我們知道，TCP每個報文都有序列號，它不是指報文的次序，而是已經發送的字節數。由於它是32位整數，所以最多可以處理232也就是4.2GB的飛行中報文。像上圖中，當1G-2G這些報文在網絡中飛行時間過長時，就會與5G-6G報文重疊，引發錯誤。</p><p>網絡錯誤還有很多種，比如報文的次序也是無法保證的。打開tcp_sack可以減少亂序時的重發報文量，降低帶寬消耗。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9d9041d80d9d443797308c8a904757bf><p class=pgc-img-caption></p></div><p>用Chrome瀏覽器直接下載大文件時，網絡不好時，一出錯就得全部重傳，體驗很差。改用迅雷下載就快了很多。這是因為迅雷把大文件拆成很多小塊，可以多線程下載，而且每個小塊出錯後，重新下載這一個塊即可，效率很高。這個斷點續傳、多線程下載技術，就是HTTP的Range協議。如果你的服務是緩存，也可以使用Range協議，比如Nginx的Slice模塊就做了這件事。</p><p>實際上對於網絡錯誤恢復，最精妙的算法是擁塞控制，它可以全面提升網絡性能。有同學會問，TCP不是有流量控制，為什麼還會發生網絡擁塞呢？這是因為，TCP鏈路中的各個路由器，處理能力並不互相匹配。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/944c7dba3a594692b32dcd4298ff2cc7><p class=pgc-img-caption></p></div><p>就像上圖，R1的峰值網絡是700M/s，R2的峰值網絡是600M/s，它們都需要通過R3才能到達R4。然而，R3的最大帶寬只有1000M/s！當R1、R2中的TCP全速使用各自帶寬時，就會引發R3丟包。擁塞控制就是解決丟包問題的。</p><p>自1982年TCP誕生起，就在使用傳統的擁塞控制算法，它是發現丟包後再剎車減速，效果很不好。為什麼呢？你可以觀察下圖，路由器中會有緩衝隊列，當隊列為空時，ping的時延最短；當隊列將滿時，ping的時延很大，但還未發生丟包；當隊列已滿時，丟包才會發生。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8b2db422cb2e40feb968b13c855e092c><p class=pgc-img-caption></p></div><p>所以，當隊列出現積壓時，丟包沒有發生。雖然此時峰值帶寬不會減少，但網絡時延變大了，這是要避免的。而測量驅動的擁塞控制算法，就在隊列剛出現積壓這個點上開始剎車減速。在當今內存越來越便宜，隊列越來越大的年代，新算法尤為有效。</p><p>當Linux內核更新到4.9版本時，原先的CUBIC擁塞控制算法就被替換為Google的BBR算法了。從下圖中可以看到，當丟包率達到0.01%時，CUBIC就沒法用了，而BBR並沒有問題，直到丟包率達到5%時BBR的帶寬才劇烈下降。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/977940b5d543450b9a82f71a64a9d1f2><p class=pgc-img-caption></p></div><p>再來看資源的平衡分配。為了公平的對待連接、用戶，服務器會做限速。比如下圖中的Leacky Bucket算法，它能夠平滑突增的流量，更公平的分配帶寬。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d6269dbb1252470184ef22310fe380ed><p class=pgc-img-caption></p></div><p>再比如HTTP2中的優先級功能。一個頁面上有幾百個對象，這些對象的重要性不同，有些之間還互相依賴。比如，有些JS文件會包含jQuery.js，如果同等對待的話，即使先下載完前者，也無法使用。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c40c32440dd24d4fb980731968f6d0e7><p class=pgc-img-caption></p></div><p>HTTP2允許瀏覽器下載對象時，根據解析規則，在stream中設置每一個對象的weight優先級（255最大，0最小）。而各代理、資源服務器都會根據優先級，分配內存和帶寬，提升網絡效率。</p><p>最後看下TCP的報文效率，它也會影響之上的HTTP性能。比如開啟Nagle算法後，網絡中的小報文數量大幅減少，考慮到40字節的報文頭部，信息佔比更高。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ad738f3ef5ca4353b79d766daa06d568><p class=pgc-img-caption></p></div><p>Cork算法與Nagle算法相似，但會更激進的控制小報文。Cork與Nagle是從發送端控制小報文，quickack則從接收端控制純ack小報文的數量，提高信息佔比。</p><p>說完相對微觀一些的信道，我們再來從宏觀上看第三個優化點：傳輸路徑的優化。</p><h2 class=pgc-h-arrow-right>三、傳輸路徑優化</h2><p>傳輸路徑的第一個優化點是緩存，瀏覽器、CDN、負載均衡等組件中，緩存無處不在。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5cebb1b1037a4514876ebd7e35fb09ef><p class=pgc-img-caption></p></div><p>緩存的基本用法你大概很熟悉了，這裡我只講過期緩存的用法。把過期緩存直接丟掉是很浪費的，因為“過期”是客戶端的定時器決定的，並不代表資源真正失效。所以，可以把它的標識符帶給源服務器，服務器會判斷緩存是否仍然有效，如果有效，直接返回304和空body就可以了，非常節省帶寬。</p><p>對於負載均衡而言，過期緩存還能夠保護源服務器，限制回源請求。當源服務器掛掉後，還能以過期緩存給用戶帶來降級後的服務體驗，這比返回503要好得多。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/de98a5b1dce6402497619639a9eeddd2><p class=pgc-img-caption></p></div><p>傳輸路徑的第二個優化點是慢啟動。系統自帶的TCP協議棧，為了避免瓶頸路由器丟包，會緩緩加大傳輸速度。它的起始速度就叫做初始擁塞窗口。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/0f1537b55421446290e707b98f1fb111><p class=pgc-img-caption></p></div><p>早期的初始擁塞窗口是1個MSS（通常是576字節），後來改到3個MSS（Linux 2.5.32），在Google的建議下又改到10個MSS（Linux 3.0）。之所以要不斷提升起始窗口，是因為隨著互聯網的發展，網頁越來越豐富，體積也越來越大。起始窗口太小，就需要更長的時間下載第一個網頁，體驗很差。</p><p>當然，修改起始窗口很簡單，下圖中是Linux下調整窗口的方法。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/95bd75ad58f546c4a8bc17d1b6641a3b><p class=pgc-img-caption></p></div><p>修改起始窗口是常見的性能優化手段，比如CDN廠商都改過起始窗口，下圖是主流CDN廠商2014和2017年的起始窗口大小。</p><p>可見，有些窗口14年調得太大了，17年又縮回去了。所以，起始窗口並不是越大越好，它會增加瓶頸路由器的壓力。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/aa95d405dec847f98a87fb7ad2da8f71><p class=pgc-img-caption></p></div><p>再來看傳輸路徑上，如何從拉模式升級到推模式。比如index.html文件中包含，在HTTP/1中，必須先下載完index.html，才能去下載some.css，這是兩個RTT的時間。但在HTTP/2中，服務器可以通過2個stream，同時並行傳送index.html和some.css，節約了一半的時間。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/74e17282c3934d34a329c37945711b83><p class=pgc-img-caption></p></div><p>其實當出現丟包時，HTTP2的stream並行發送會嚴重退化，因為TCP的隊頭阻塞問題沒有解決。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e2d5657764e54800b9e54c2d799b0649><p class=pgc-img-caption></p></div><p>上圖中的SPDY與HTTP2是等價的。在紅綠色這3個stream併發傳輸時，TCP層仍然會串行化，假設紅色的stream在最先發送的，如果紅色報文丟失，那麼即使接收端已經收到了完整的藍、綠stream，TCP也不會把它交給HTTP2，因為TCP自身必須保證報文有序。這樣併發就沒有保證了，這就是隊頭阻塞問題。</p><p>解決隊頭阻塞的辦法就是繞開TCP，使用UDP協議實現HTTP，比如Google的GQUIC協議就是這麼做的，B站在幾年前就使用它提供服務了。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/38dfd0d08f4b478995930fdd4c63abf8><p class=pgc-img-caption></p></div><p>UDP協議自身是不能保證可靠傳輸的，所以GQUIC需要重新在UDP之上實現TCP曾經做過的事。這是HTTP的發展方向，所以目前HTTP3就基於GQUIC在制定標準。</p><p>最後，再從網絡信息安全的角度，談談如何做優化。它實際上與編碼、信道、傳輸路徑都有關聯，但其實又是獨立的環節，所以放在最後討論。</p><p><strong>四、信息安全優化</strong></p><p>互聯網世界的信息安全，始於1995年的SSL3.0。到現在，許多大型網站都更新到2018年推出的TLS1.3了。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/f6ce44efc4f14004a215c526662e4fa4><p class=pgc-img-caption></p></div><p>TLS1.2有什麼問題呢？最大問題就是，它支持古老的密鑰協商協議，這些協議現在已經不安全了。比如2015年出現的FREAK中間人攻擊，就可以用Amazon上的虛擬機，分分鐘攻陷支持老算法的服務器。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/980ebc6e98fd419497bb94459ae7a9a8><p class=pgc-img-caption></p></div><p>TLS1.3針對這一情況，取消了在當前的計算力下，數學上已經不再安全的非對稱密鑰協商算法。在Openssl的最新實現中，僅支持5種安全套件：</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9311e3eff3084871a86744c50d541893><p class=pgc-img-caption></p></div><p>TLS1.3的另一個優勢是握手速度。在TLS1.2中，由於需要2個RTT才能協商完密鑰，才誕生了session cache和session ticket這兩個工具，它們都把協商密鑰的握手降低為1個RTT。但是，這兩種方式都無法應對重放攻擊。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/554a60da878a4e64ab0e21e62e0348de><p class=pgc-img-caption></p></div><p>而TLS1.2中的安全套件協商、ECDHE公鑰交換這兩步，在TLS1.3中被合併成一步，這大大提升了握手速度。</p><div class=pgc-img><img alt=技術分享：四個全新維度，高效優化你的HTTP性能 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a9a21a805685444e98ec6ae205bdc53c><p class=pgc-img-caption></p></div><p>如果你還在使用TLS1.2，儘快升級到1.3吧，除了安全性，還有性能上的收益。</p><h2 class=pgc-h-arrow-right>小結</h2><p>HTTP的性能優化手段眾多，從這四個維度出發，可以建立起樹狀的知識體系，囊括絕大部分的HTTP優化點。</p><p>編碼效率優化包括http header和body ，它可以使傳輸的數據更短小緊湊，從而獲得更低的時延和更高的併發。同時，好的編碼算法也可以減少編解碼時的CPU消耗。</p><p>信道利用率的優化，可以從多路複用、錯誤發現及恢復、資源分配這3個角度出發，讓快速的底層信道，有效的承載慢速的應用層信道。</p><p>傳輸路徑的優化，包括各級緩存、慢啟動、消息傳送模式等，它能夠讓消息更及時的發給瀏覽器，提升用戶體驗。</p><p>當下互聯網中的信息安全，主要還是建立在TLS協議之上的。TLS1.3從安全性、性能上都有很大的提升，我們應當及時的升級。</p><p>希望這些知識能夠幫助你全面、高效地優化HTTP協議！</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>技術</a></li><li><a>四個</a></li><li><a>維度</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E5%AD%B8/3866234.html alt=四個維度，讓廚房操作檯更加實用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/50ae0001e55cae3f753e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/3866234.html title=四個維度，讓廚房操作檯更加實用>四個維度，讓廚房操作檯更加實用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/93727dba.html alt="技術帖 | 3分鐘搞定各種測試分析技術" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/f055e0a4477240088de2abb7cd696cfa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/93727dba.html title="技術帖 | 3分鐘搞定各種測試分析技術">技術帖 | 3分鐘搞定各種測試分析技術</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2d0ddee5.html alt=建築房屋結構平衡技術要求，你都會知道嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/5e7d0001715d878ed66c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2d0ddee5.html title=建築房屋結構平衡技術要求，你都會知道嗎？>建築房屋結構平衡技術要求，你都會知道嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/47c8cac0.html alt=新《裝配式混凝土建築技術標準》有哪些改變？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1540524372015dc56ec3fb9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/47c8cac0.html title=新《裝配式混凝土建築技術標準》有哪些改變？>新《裝配式混凝土建築技術標準》有哪些改變？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b6c2fc2b.html alt=鈦合金精密鑄造技術發展現狀 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/SCynkUUBbHN8CF style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b6c2fc2b.html title=鈦合金精密鑄造技術發展現狀>鈦合金精密鑄造技術發展現狀</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d2e8af08.html alt=傾斜航攝技術小知識——航線設計篇 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RS1ucOiDvLRlVt style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d2e8af08.html title=傾斜航攝技術小知識——航線設計篇>傾斜航攝技術小知識——航線設計篇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d597da51.html alt=黃河電力技術公司在龍羊峽進行無人機傾斜攝影測量 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1528429551298e033646798 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d597da51.html title=黃河電力技術公司在龍羊峽進行無人機傾斜攝影測量>黃河電力技術公司在龍羊峽進行無人機傾斜攝影測量</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cdb604f6.html alt=《雷神4：愛與雷》將採用“虛擬製作”技術 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/83a320a69b0f44e3baf7db07faac3c65 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cdb604f6.html title=《雷神4：愛與雷》將採用“虛擬製作”技術>《雷神4：愛與雷》將採用“虛擬製作”技術</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1cd5b6b6.html alt=虛擬現實技術在智能製造領域具有重要的應用價值 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3ed327880d3b4c5384619f21d6c81823 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1cd5b6b6.html title=虛擬現實技術在智能製造領域具有重要的應用價值>虛擬現實技術在智能製造領域具有重要的應用價值</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3a2b0c81.html alt="虛擬製造的基石：數值模擬技術 | 加快實現工業數字化" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/2f2c32f4bd734f9face045546d45a665 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3a2b0c81.html title="虛擬製造的基石：數值模擬技術 | 加快實現工業數字化">虛擬製造的基石：數值模擬技術 | 加快實現工業數字化</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/12134f67.html alt=不愧是大品牌，四個字完美詮釋秋天，Respect class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/fe4caf06d29843aab68482e955dfdbc2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/12134f67.html title=不愧是大品牌，四個字完美詮釋秋天，Respect>不愧是大品牌，四個字完美詮釋秋天，Respect</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ee69f5ac.html alt=基於機器視覺技術快速準確地確定收穫後幹大豆種子的品質 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/519b968bf69146fda9bf55f89779d373 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ee69f5ac.html title=基於機器視覺技術快速準確地確定收穫後幹大豆種子的品質>基於機器視覺技術快速準確地確定收穫後幹大豆種子的品質</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e203d547.html alt=和你一起的軍訓，下雨也甜蜜｜四川託普信息技術職業學院軍訓記 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4cd61c2a490f48ebb0aa74d30ec8766b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e203d547.html title=和你一起的軍訓，下雨也甜蜜｜四川託普信息技術職業學院軍訓記>和你一起的軍訓，下雨也甜蜜｜四川託普信息技術職業學院軍訓記</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/916c8d26.html alt=鍋爐專業技術問答100條 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/916c8d26.html title=鍋爐專業技術問答100條>鍋爐專業技術問答100條</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0efa050d.html alt=「技術」差速器總成結構與性能參數分析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/fa9c698160c045c8a64c08dac6018a30 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0efa050d.html title=「技術」差速器總成結構與性能參數分析>「技術」差速器總成結構與性能參數分析</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>