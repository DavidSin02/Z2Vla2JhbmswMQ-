<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>「原創」OSPF鄰居狀態機詳解 | 极客快訊</title><meta property="og:title" content="「原創」OSPF鄰居狀態機詳解 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/e82d49b858b841f8b71020d20474fe77"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ae9d119.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ae9d119.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ae9d119.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ae9d119.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ae9d119.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ae9d119.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ae9d119.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ae9d119.html><meta property="article:published_time" content="2020-10-29T20:59:15+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:15+08:00"><meta name=Keywords content><meta name=description content="「原創」OSPF鄰居狀態機詳解"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/ae9d119.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>「原創」OSPF鄰居狀態機詳解</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><strong>1、背景</strong></p><p>我們都知道，任何新技術的誕生，都是有它一定的自然規律的。絕逼不是憑白無故的產生。所以，龍哥希望大家學習一個技術時，學會多關聯相關協議，聯想他們各自的特點，學會把知識串聯起來，這樣你就不會覺得學技術好難啊，就不會總是跟龍哥抱怨:總是記不住怎麼辦呢？</p><p><br></p><p>會有鏈路狀態協議的OSPF產生，是因為前面距離矢量路由協議存在兩個非常嚴重的問題：</p><p>1、收斂速度緩慢，就是太磨嘰了；2、容易產生路由環路。</p><p>OSPF，全稱Open Shortest Path First，即開發最短路徑優先，是由IETF的OSPF工作組在1989年10月開發的，發表的RFC為1131, OSPFv1從此誕生，該協議是基於著名的DijKstra算法。不過版本1一直都是在實驗室中使用，未推廣成功。版本2才開始被廣泛使用，在RFC2328說明。</p><p>注：IETF：國際互聯網工程任務組（The Internet Engineering Task Force，簡稱 IETF。1985年年底成立。</p><p><br></p><p><strong>2、LSDB</strong></p><p><br></p><p>LSDB，全稱是Link State DataBase,鏈路狀態數據庫。為啥會有它呢？還不是因為距離矢量路由協議RIP，是個“傳言”路由協議，在距離矢量路由協議中，鄰居說有啥路由，你就信啥，你心中自己都沒有一張地圖，就很容易經常被騙，所以會導致環路。所以OSPF乾脆就給區域內每臺路由器都搞一張地圖，這樣就不會上當受騙了，這個地圖就是LSDB，這樣就使得OSPF可以保證區域內無環，區域間無環，通過一些規則來限制，這樣區域內外都能保證無環。下面，簡單介紹一下：</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e82d49b858b841f8b71020d20474fe77><p class=pgc-img-caption></p></div><p><br></p><p>簡單說明一些，區域內路由器一旦配置了OSPF,每臺路由器就會開始泛洪LSA（包含IP地址、掩碼、開銷、網絡類型等信息），每臺都能收到LSA，會構建一張數據庫，即LSDB。然後每臺路由器都會以自己為根節點，構建一顆最短路徑樹，然後從這棵樹中計算路由，將最優的放進路由表，用於指導業務數據轉發。</p><p>可能上圖小白看著會覺得有點抽象，很難受。行吧，那龍哥動手搭個環境，聯繫實際場景，可能就會更好理解了。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/98ac3a11325b4adfb8fff48391b9629f><p class=pgc-img-caption></p></div><p><br></p><p>現在我登錄到每臺設備給大家演示一下如何查看LSDB（鏈路狀態數據庫）：</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8385ee8e3543421c90e0e8171d6ac09d><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5cca67e10eb54eaeb62b024f23a02f54><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/87470196b20e4a59bbf9842b1595297e><p class=pgc-img-caption></p></div><p><br></p><p>從以上截圖來看，相信大家應該發現一個現象了，那就是每臺路由器的LSDB是一樣的，說明區域內每臺路由器的“地圖”都是長一個樣的。</p><p><br></p><p>然後我再每臺路由器都創建loopback 0，都宣告到OSPF，目的是驗證計算路由。不然上述環境，直連路由優先OSPF路由，所以查看路由表是不會看到OSPF路由的。</p><p>創建後隨便登錄一臺路由器就可以了（因為每臺路由器LSB都是一樣的），去查看1類LSA（1類LSA每臺路由器都會產生的）</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/39db0f6633784f98b79fd79c9cc48276><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/29eeefce58fa470f8e385abeb3d0254d><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/cdc2a9dbe6474e04b81941d604e262df><p class=pgc-img-caption></p></div><p><br></p><p>然後我們在R1查看路由表中的OSPF路由：</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d940fddca2a64423b556cf2895972bb3><p class=pgc-img-caption></p></div><p><br></p><p>我們可以看到只有2條OSPF路由，10.10.10.10沒有在裡面，是因為它不是最優的，因為它是直連路由，直連路由（優先級0）比OSPF（優先級10）優。</p><p><br></p><p><strong>3、報文類型</strong></p><p>不管你學什麼協議，都繞不開學習報文。報文，就是協議之間互相交付的數據內容。</p><p>OSPF在層次模型中，是基於IP層之上的，協議號是89。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/47598eca4a0a42e6835d1d7f51740a10><p class=pgc-img-caption></p></div><p><br></p><p>上圖看完，我們是不是就可以定位出OSPF其實也是跟TCP、UDP同一傳輸層級別的協議了。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1cd9c98fbd0047c5a1fe09eb436cdf96><p class=pgc-img-caption></p></div><p><br></p><p>現在，是不是明白了，為啥OSPF報文需要LSAck了吧？ 因為OSPF不是基於TCP，TCP有確認機制，所以OSPF如果要確認機制，就需要開發一個報文類型，用來做確認，即LSAck。</p><p><br></p><p>現在，我們來總結一下OSPF的報文類型有：</p><p><br></p><ol start=1><li><strong>Hello報文：</strong>用於發現、建立、維護鄰居關係。</li><li><strong>DBD報文：</strong>鏈路狀態數據庫的目錄，即摘要信息。</li><li><strong>LSR報文：</strong>發現自己缺少哪些摘要信息的，就去請求缺少的LSA。</li><li><strong>LSU報文：</strong>完整的LSA信息。</li><li><strong>LSAck報文：</strong>確認收到LSA。</li></ol><p><br></p><p>本期主題龍哥於大家分享的是OSPF鄰居狀態機，所以重點介紹一下OSPF的Hello報文。</p><p>有些人遇到OSPF鄰居不能建立成功，總是不知所措；或者有些考試應付考試，來問龍哥，影響OSPF鄰居建立因素好幾條，總是記不住怎麼辦呀？其實，這個問題很簡單，就是你沒有把Hello報文格式內容給瞭解透徹。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/645cadecb7884e1d8460bca90458e90a><p class=pgc-img-caption></p></div><p><br></p><p>你細品Hello報文，再去看影響OSPF鄰居建立的因素，就清晰多了：（1）router id（2）area id（虛鏈路的area id可以不一致，什麼意思）（3）認證（4）hello/dead（5）區域類型（option位，e=1、n=0為普通/骨幹區域，e=0、n=0為stub區域，e=0、n=1為nssa區域）（6）接口的地址掩碼（ma網絡，LSA2的掩碼描述接口的掩碼，如果掩碼不一致會認為有兩臺DR，p2p沒有問題）不在hello包（7）接口mtu（鄰接關係出問題）（8）ospf進程下靜默</p><p>現在我們來解釋Hello裡的幾個字段：（1）router id：建立鄰居的OSPF，兩邊路由器router id不能相同，否則即使建立成功了，也會有問題。</p><p><br></p><p>① 兩臺路由器直連，Router ID 一樣，鄰居無法建立。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/bf39e21bddc240329a506d8d3c358c25><p class=pgc-img-caption></p></div><p><br></p><p>兩臺路由器Router ID配一樣，路由會提示你衝突了：</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/66e34d1a022c4e98b5efc82dcb97c8ed><p class=pgc-img-caption></p></div><p><br></p><p>抓包看到他們確實已發Hello包，但是呢，就是建立不起來。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7f696778018c4ef1a7638d052467691d><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4df8bae00c614bf7a0193315f7f5c1be><p class=pgc-img-caption></p></div><p><br></p><p>可能有人就會問，協議程序都是人為控制的，router id一樣，你允許它們建立鄰居不就好了。</p><p><br></p><p>我們來假設一下，如果兩臺直連router id一樣能建立鄰居關係，那到了exstar狀態時需要選舉DD報文的主從關係，主從關係是根據router id 最大來確定為主路由器的。如果都一樣，就無法選舉，從而就無法進行LSDB信息交換了。 既然到了exstart狀態會有問題，那專家們設計協議時就認為在一開始的建立鄰居的時候就扼殺掉不就好了，沒必要浪費時間。</p><p><br></p><p>②兩臺路由器非直連，Router ID 一樣，鄰居可以正常建立，但路由會振盪。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/df68c2b3ee834232beea532307dcc83a><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/48eb9c649e984207a518b35cb796b877><p class=pgc-img-caption></p></div><p><br></p><p>現在，龍哥打算在R4起個loopback口，配置10.10.10.10/24，然後宣告到OSPF。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/df4bc098aa4248ed9da21da9ade75f0d><p class=pgc-img-caption></p></div><p><br></p><p>假設R4宣告一條路由10.10.10.0/24，R4會把這條LSA（adv=4.4.4.4，type=1，LS ID=4.4.4.4，seq=8001）發送給R5，R5收到後會發給他的鄰居R6，R6收到發現通告者是4.4.4.4，但是自己又沒有這個網段，於是會給R5發送一個自己的LSA1（age=1s，seq=8002），R5收到後會與之前adv=4.4.4.4的LSA1進行比較，選擇這條seq更大的LSA1，然後也會轉發給R4，R4收到後發現自己有這個網段，又會發送一條新的LSA1（seq=8003），會一直出現這樣重複的情況，而導致路由動盪</p><p>路由動盪具體表現什麼樣的？我們可以長ping一下，就知道了，會發現偶爾不通。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/da6ae323584b457080125822a1aa611e><p class=pgc-img-caption></p></div><p><br></p><p>現在，我們繼續在R4採用引入的方式，引入外部路由20.20.20.20，再看看。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1ddd3d1de24547dba09f1b03dec3e1c6><p class=pgc-img-caption></p></div><p><br></p><p>R4引入一條路由20.20.20.0/24，R4會把這條LSA（adv=4.4.4.4，type=5，LS ID=20.20.20.0，seq=8001）發送給R5，R5收到後會發給他的鄰居R6，R6收到發現通告者是4.4.4.4，但是自己又沒有這個網段，於是會給R5發送一個（age=3600s，seq=8001）的LSA5，R5收到後，會與之前收到的LSA5進行比較，因為seq和check sum與之前的一樣，所以會優選age=3600s的，然後也會轉發給R4，R4收到後發現自己有這個網段，又會發送一條新的LSA5（seq=8002），會一直出現這樣重複的情況，而導致路由動盪。</p><p><br></p><p>抓包可以看到，R4和R5一直在更新LSA：</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/791c73eb5c7b4ef78cf19e09382c2422><p class=pgc-img-caption></p></div><p><br></p><p>抓包可以看到，R6和R5一直在更新LSA：</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d7b4850488ba49ccb446e230e0745855><p class=pgc-img-caption></p></div><p><br></p><p>③不同區域的兩臺路由器，Router id一樣，鄰居可以建立，路由會振盪。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3981aa6a209d47c984b0c3e0aabc8042><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/763801befe9741149ee897a0eaea39e6><p class=pgc-img-caption></p></div><p><br></p><p>可以上次，鄰居是可以建立的。</p><p><br></p><p>如果R4和R6不引入外部路由的話，是不會出現問題的。因為ospf在區域間使用LSA3，LSA3是由區域的ABR根據LSA1、LSA2產生的，adv是ABR的router-id，區域間路由只是被當成葉子掛在ABR上，本區域內的spt樹上不會出現在有相同router-id的節點，也就不會出現問題。但是如果在相同router-id的設備上做引入的時候就會出現問題了，因為asbr的router-id是需要被ospf域內的所有路由器所知道的，如果發現asbr的router-id與本設備的router-id一樣時，會出現問題.</p><p>現在我們也在R4引入一條路由20.20.20.0/24，R4會把這條LSA（adv=4.4.4.4，type=5，LS ID=20.20.20.0，seq=8001）發送給R5，R5收到後會發給他的鄰居R6，R6收到發現通告者是4.4.4.4，但是自己又沒有這個網段，於是會給R2發送一個（age=3600s，seq=8001）的LSA5，R5收到後，會與之前收到的LSA5進行比較，因為seq和check sum與之前的一樣，所以會優選age=3600s的，然後也會轉發給R4，R4收到後發現自己有這個網段，又會發送一條新的LSA5（seq=8002），會一直出現這樣重複的情況，而導致路由振盪。</p><p>路由動盪具體表現什麼樣的？我們可以長ping一下，就知道了，會發現偶爾不通。</p><p>（這裡我加了-t 25 是為了更明顯看出丟包，路由振盪，修改了超時時間。）</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/32fa2287ecf64b6db19742390317b2b2><p class=pgc-img-caption></p></div><p><br></p><p>（2） Area-id：OSPF是基於接口劃分區域的，所以建立鄰居關係的路由器必須在同一區域，即 區域id需要一直。</p><p>（3）認證：建立鄰居關係的兩端必須保證認證類型和認證數據要一致。</p><p>（4） 掩碼：在MA/NBMA掩碼要一致，P2P沒限制。</p><p>（5）Hello/Dead時間：時間參數要一致</p><p>（6）Option：其中重點參考Option中的N和E bit位，N/E必須置為相同（N/E主要表示兩端路由器在什麼樣的區域）</p><p>N=1 E=0 ：NSSA</p><p>N=0 E=1 ：普通區域</p><p>N=0 E=0 ：STUB區域</p><p>（7）DD報文中的有個MTU字段，兩端需要一致（只會影響LSDB的同步，從2-way到full；華為設備默認不比較該參數，但不一致，後面可能會卡在exchange或loading，可以通過在接口下配置ospf mtu-enable命令使能檢查鄰居DD報文所攜帶的MTU是否超過本端的MTU值）</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/20d9e763251e4757af9bfff86281705f><p class=pgc-img-caption></p></div><p><br></p><p><strong>4、狀態機</strong></p><p><br></p><p>接下來，就是本期要介紹的OSPF狀態機，介紹之前，我覺得有必要先理解一下：鄰居關係和鄰接關係。</p><p><br></p><p>鄰居關係：OSPF設備啟動後，會通過OSPF接口向外發送Hello報文，收到Hello報文的OSPF設備會檢查報文中所定義的參數，如果雙方一致就會形成鄰居關係，兩端設備互為鄰居。</p><p><br></p><p>鄰接關係：形成鄰居關係後，如果兩端設備成功交換DD報文和LSA，才建立鄰接關係</p><p><br></p><p>鄰居關係，就是好比你家附近，最近搬了一個新鄰居，你們彼此經常路上都會遇到，你也知道她住哪的，她也知道你住哪的，只是你們沒有彼此深入瞭解，交流。</p><p><br></p><p>鄰接關係，也是好比你家附近，最近搬了一個新鄰居，你們不僅彼此知道對方住哪的，你們因為又一次小區活動，得以認識，於是互相交流，瞭解對方喜好，哪裡人等等，那這個時候你們就是鄰接關係。</p><p><br></p><p>簡單說，就是 互相眼熟，互不打招呼的就是鄰居關係；互相眼熟，還經常互相打招呼，深入聊天，就是鄰接關係。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/01d788d9f33b4270be81f77004edf9fc><p class=pgc-img-caption></p></div><p><br></p><p>OSPF共有8種狀態機，分別是：Down、Attempt、Init、2-way、Exstart、Exchange、Loading、Full。</p><p>Down：鄰居會話的初始階段，表明沒有在鄰居失效時間間隔內收到來自鄰居路由器的Hello數據包。</p><p>Attempt：該狀態僅發生在NBMA網絡中，表明對端在鄰居失效時間間隔（dead interval）超時前仍然沒有回覆Hello報文。此時路由器依然每發送輪詢Hello報文的時間間隔（poll interval）向對端發送Hello報文。</p><p>Init：收到Hello報文後狀態為Init。</p><p>2-way：收到的Hello報文中包含有自己的Router ID，則狀態為2-way；如果不需要形成鄰接關係則鄰居狀態機就停留在此狀態，否則進入Exstart狀態。</p><p>Exstart：開始協商主從關係，並確定DD的序列號，此時狀態為Exstart。</p><p>Exchange：主從關係協商完畢後開始交換DD報文，此時狀態為Exchange。</p><p>Loading：DD報文交換完成即Exchange done，此時狀態為Loading。</p><p>Full：LSR重傳列表為空，此時狀態為Full。</p><p><br></p><p>接下來，我們來聊聊幾個主要的狀態：</p><p>1、Init</p><p>每臺路由器只與啟用了OSPF，接口宣告到OSPF進程，就會開始發OSPF報文。</p><p>當收到別人發過來的Hello報文，</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a64fee7f74984775ab56e058c47d65c7><p class=pgc-img-caption></p></div><p><br></p><p>一開始，R5收到R4發過來的Hello包，查看，只看到R4的router id 4.4.4.4 ，沒有看到自己，所以狀態置為init狀態，並且R5已發現自己有個鄰居是R4。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4af5a8e154cd4587b052cd8f280059f9><p class=pgc-img-caption></p></div><p><br></p><p>R4收到R5發過來的Hello包，查看，只看到R5的router id 5.5.5.5 ，沒有看到自己，所以狀態置為init狀態，並且R4已發現自己有個鄰居是R5。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/bed7f18a643c42548300db766a08eb5f><p class=pgc-img-caption></p></div><p><br></p><p>R5再次收到R4發過來的Hello包，查看，看到R4的router id 4.4.4.4，還看到自己R5的router id 5.5.5.5 ，認為雙向通信沒問題，所以狀態置為2-way。</p><p><br></p><p>同理，R4再次收到R5發過來的Hello包，查看，看到R5的router id 5.5.5.5，還看到自己R5的router id 4.4.4.4，認為雙向通信沒問題，所以狀態置為2-way。</p><p>到這裡，OSPF的鄰居狀態就算建立完成。如果要交付LSA信息，還得繼續建立鄰接關係，才能交付，然後再去計算路由。</p><p><br></p><p>當鏈路兩端的設備都進入2-way狀態後，如果是MA或NBMA網絡，會進行DR/BDR的選舉。該選舉是為了減少廣播型網絡和NBMA網絡中建立鄰接關係的數量。</p><p><br></p><p>如果存在DR的情況下，其他DR-Other只會和DR建立鄰接關係，DR-Other之間建立鄰居關係，但是不會建立鄰接關係，狀態一直處於2-way狀態。</p><p><br></p><p><strong>DR/BDR的選舉規則：</strong></p><p>1、比較路由器優先級，大的優先；</p><p>2、比較router id。大的優先；</p><p><br></p><p>當選舉出DR後，網絡內的DR-Other和DR開始建立鄰接關係，進入下一個狀態Exstart。</p><p>這個階段，兩端設備通過交互DD報文，來選舉主從關係，主從的目的，就是選舉誰是老大，後續的DD報文序列號以他為準，作為參考點進行更新。</p><p><br></p><p>龍哥要畫重點了，注意了，第一個DD報文，是沒有攜帶LSA頭部信息的。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c3227985108248e287e804fa01158ad6><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2352ee8c24cc47f1a50096aaf26462bb><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6893c042fb47415eb3e5d11d9284f43e><p class=pgc-img-caption></p></div><p><br></p><p>現在我們來了解一下，主從關係是通過什麼選舉出來的呢？</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d551225447b14365b49efb7f08598f62><p class=pgc-img-caption></p></div><p><br></p><p>DD報文有個三位很重要，I,M,MS位。</p><p>I 是表示該報文是初始報文，第一個DD報文。</p><p>M 表示後面還有DD報文，如果是0，表示沒有DD報文了。</p><p>MS 置1表示該報文為主，0表示為從。</p><p><br></p><p>所以第一個DD報文，都各自認為自己是主，所以MS都置1。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/87a1e8b1c79645909698b60a53d2f292><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5dfe64ec67c544f7a1f2e3515403e56d><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1896dc070bfb49d181fe207f0d17f031><p class=pgc-img-caption></p></div><p><br></p><p>R4：發現自己的router id比R5小，所以認慫了，為從，置為0：</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0c0592c286d34768a3bebde159f3b087><p class=pgc-img-caption></p></div><p><br></p><p>R5：發現自己的router id比R4大，所以嘚瑟了，為主，置為1，序列號+1</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0893bbc4569841cda1229649d62878f8><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b1df58ce3d3b491b936525143d9f9544><p class=pgc-img-caption></p></div><p><br></p><p>主從設備選舉完後，設備的狀態從Exstart狀態變為Exchange狀態，從設備（R4）會使用主設備（R5）的序列號，發送攜帶摘要信息的DD報文。</p><p>如果R5從R4發送的摘要信息中發現存在本身沒有的LSA信息，則會向AR1發送LSR報文請求該LSA，此時狀態由exchange變為loading狀態。R4收到AR5的LSR請求報文，便會回覆一個LSU報文攜帶AR2要請求的LSA明細信息。R5收到LSU報文同步完成後進入FULL狀態，並且向R5發送LSAck報文表示確定收到了LSU報文且同步完成，R4也會進入FULL狀態。該LSAck報文，就是因為OSPF是基於IP的，IP沒有確認機制，所以OSPF需要設置自身的確認機制。</p><p>以上就是OSPF的鄰居狀態機。</p><p><br></p><div class=pgc-img><img alt=「原創」OSPF鄰居狀態機詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/6063b2c215394e0090bdcd43b0333d49><p class=pgc-img-caption></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>原創</a></li><li><a>OSPF</a></li><li><a>鄰居狀</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/5f798649.html alt=「原創」什麼叫束裝尾纖？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/65d80c15bb5f447384bf8b734846eadc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5f798649.html title=「原創」什麼叫束裝尾纖？>「原創」什麼叫束裝尾纖？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2320005a.html alt=「原創」為什麼使用LC光纖耦合器能夠多熔接一倍尾纖 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/88417f7f2c2647bab12e4e97f431d060 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2320005a.html title=「原創」為什麼使用LC光纖耦合器能夠多熔接一倍尾纖>「原創」為什麼使用LC光纖耦合器能夠多熔接一倍尾纖</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/caf5b2c6.html alt=「原創」腫瘤放療：放射治療患者體位固定圖例 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/b9f89fac13ed423f9f63a48872ad9487 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/caf5b2c6.html title=「原創」腫瘤放療：放射治療患者體位固定圖例>「原創」腫瘤放療：放射治療患者體位固定圖例</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/22fc0b3b.html alt=【原創文學】李清文:暗傷 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c7f2049553c24e148011200919fe7917 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/22fc0b3b.html title=【原創文學】李清文:暗傷>【原創文學】李清文:暗傷</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a87504d6.html alt=「原創」PHP7.X安裝及配置教程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/1e34aa66-9562-4e41-8b8e-9b8f54359223 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a87504d6.html title=「原創」PHP7.X安裝及配置教程>「原創」PHP7.X安裝及配置教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7821bb6c.html alt=【原創首發】汽車減震器的結構及問題解決思路 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5fe35906709b47cb9fbed25a548e7795 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7821bb6c.html title=【原創首發】汽車減震器的結構及問題解決思路>【原創首發】汽車減震器的結構及問題解決思路</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a565df8e.html alt=（艾濂原創）風華 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/bccf5898b4c640e482f3a727181fe4f7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a565df8e.html title=（艾濂原創）風華>（艾濂原創）風華</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/855b44d4.html alt=關於風乾雞的製作方法[原創] class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/855b44d4.html title=關於風乾雞的製作方法[原創]>關於風乾雞的製作方法[原創]</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5168c642.html alt=（原創）獨家精闢總結樓梯分類，好懂易記憶！！！接上篇 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/55146c87f2604183a4db1b9d8fa52b3d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5168c642.html title=（原創）獨家精闢總結樓梯分類，好懂易記憶！！！接上篇>（原創）獨家精闢總結樓梯分類，好懂易記憶！！！接上篇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8d5c66ca.html alt=「原創資料」澆口的類型分享（二） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/5b540001fe83c5e88c66 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8d5c66ca.html title=「原創資料」澆口的類型分享（二）>「原創資料」澆口的類型分享（二）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dc2d31db.html alt=「原創資料」澆注系統設計標準-澆口的形式和應用02 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/5b4600018f2d956a843b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dc2d31db.html title=「原創資料」澆注系統設計標準-澆口的形式和應用02>「原創資料」澆注系統設計標準-澆口的形式和應用02</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/558bd6e6.html alt=（原創）夏至節，還原中國最古老的節日習俗 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8cbbbc13df1c4a4794d949cc04ce0557 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/558bd6e6.html title=（原創）夏至節，還原中國最古老的節日習俗>（原創）夏至節，還原中國最古老的節日習俗</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0e5e677d.html alt=「原創」真空鍛造複合軋輥製備工藝研究 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8c7748be286d4180a932887c632a9ae9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0e5e677d.html title=「原創」真空鍛造複合軋輥製備工藝研究>「原創」真空鍛造複合軋輥製備工藝研究</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1bdd8160.html alt=原創｜《聲臨其境》邊大大來了，邊江夜華君隨時切換引觀眾尖叫 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/5e73000261aaa6fd905f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1bdd8160.html title=原創｜《聲臨其境》邊大大來了，邊江夜華君隨時切換引觀眾尖叫>原創｜《聲臨其境》邊大大來了，邊江夜華君隨時切換引觀眾尖叫</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/07043846.html alt=「原創」公安河東分局人口服務管理中心妥善應對業務量增多 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9bc8ca0758964e9fb30a5aa83dad8449 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/07043846.html title=「原創」公安河東分局人口服務管理中心妥善應對業務量增多>「原創」公安河東分局人口服務管理中心妥善應對業務量增多</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>