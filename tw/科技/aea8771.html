<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 | 极客快訊</title><meta property="og:title" content="微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/219edecf54ca4de99091889a662325aa"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/aea8771.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/aea8771.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/aea8771.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/aea8771.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/aea8771.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/aea8771.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/aea8771.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/aea8771.html><meta property="article:published_time" content="2020-10-29T20:59:27+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:27+08:00"><meta name=Keywords content><meta name=description content="微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/aea8771.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><span style="color:#a5a5a5;--tt-darkmode-color: #A3A3A3">作者：ypaapyyang，騰訊 WXG 後臺開發工程師，個人公眾號：碼農課代表。</span></p><blockquote><p>本文旨在分析分佈式配置系統的必要性、可行性，及其關鍵要素，並介紹一款基於該系列分析，在微信研發體系下的實踐嘗試。</p></blockquote><h1 class=pgc-h-arrow-right><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">前言</span></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">對很多的業務開發同學而言，對運營素材的處理不是一件輕鬆的事，通常需要定製化的進行數據的清理、格式的轉換、工具的開發。筆者就曾過這樣一段不愉快的回憶，為了導入一次性的近十種類型的配置數據，就耗去了兩天的時間。如果說這段經歷有何價值的話，那就是促使我思考分佈式配置系統，並且在工作中實踐，使自己避免再次陷入如此糟糕的過程中。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">本文正是旨在分析分佈式配置系統的必要性、可行性，及其關鍵約束，並介紹一款基於該系列分析，在微信研發體系下的實踐嘗試。</span></p><h1 class=pgc-h-arrow-right><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置的定義</span></strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">我們清楚軟件建模的本質是對現實世界（人、事、物及規則）的映射，映射的產出物即包括編程系統和配置。配置為我們提供了</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">動態修改程序運行時行為的能力</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，即常說的“系統運行時飛行姿態的動態調整”，究其根源則是“我們人類無法掌控和預知一切，映射到軟件領域上，我們總是需要對系統的某些功能特性預留出一些控制的線頭，以便我們在未來需要的時候，可以人為的撥弄這些線頭從而控制系統的行為特徵。”</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">因此，本文所指的配置特指內部運營人員產生的數據（廣義的系統運營人員，包括產品、運營、研發等），並且作為輸入參數而作用於編程系統（包括實時系統、批跑程序以及數據任務等）。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">歸納而言，配置通常包含如下三種：</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">a. 環境配置，定義了應用程序運行的環境相關參數，如 IP、Port 等；</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">b. 應用配置，定義了應用程序自身相關的參數或者信息安全控制等，如初始內存分配大小、數據庫連接池大小、日誌級別、賬號密碼等；</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">（密碼、證書這類東西肯定不要放在配置系統中，而應當走統一加解密服務）</span></strong></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">c. 業務配置，定義了應用程序所執行的業務行為數據，比如最常見的</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">功能開關</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，參與活動的商戶名單等。</span></p><h1 class=pgc-h-arrow-right><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">系統約束</span></strong></h1><h1 class=pgc-h-arrow-right><strong>數據模型</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置最基本的數據單元是</span>key=value<span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">（即配置項），比如功能開關通常就是最簡單的類型，用 boolean 型值來影響程序執行鏈路（不考慮灰度的情況）。然而只有 key-value 類型是不足的，比如 DB 的連接配置就包含了 ip、port、username、password 等字段，在 ini 文件的實現中即是不同配置項來組成，它們在邏輯上是屬於同一個配置對象，因此基於面向對象的設計思路，</span>key=object<span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">才是更通用的配置模型，在物理實現中可以為 json 或者 xml，或者 protobuf message。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">object 類型的數據即可以是</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">平坦的</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，也可以是</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">多層次（嵌套）的</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">。在實際的業務應用中，</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">平坦</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">類型的數據有其特殊性，即其通常條目較多，最典型的數據是</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">白名單</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，可能多達上萬條。線下，內部運營人員通過</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">excel</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">進行這類數據的管理，如果我們只是粗暴的將其打包成一個對象，那麼過大的數據可能會導致系統效率的下降（不是配置的寫入效率下降，就是配置讀出效率下降），因此我們會使用</span>array of plain object<span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">來表達，即</span>key=table<span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">類型的數據。</span></p><h1 class=pgc-h-arrow-right><strong>訪問模型</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">相別於產品用戶產生的數據，</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置系統的數據流是單向的，離線系統與實時系統結合而讀寫分離（異步寫、實時讀）的</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">。最終我們要搭建的分佈式配置系統，它的系統設計，也必然是建立在這類訪問模型上的。</span></p><div class=pgc-img><img alt=微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/219edecf54ca4de99091889a662325aa><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>系統約束</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">顯然，內部運營人員作為生產者，所有的</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置肯定都是文本類型的（Readable）</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，並且</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">數據量少</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">(相對於用戶、系統等生產數據而言），對存儲空間需求少，</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">更新頻次低</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">。可以這麼理解，在整個配置系統架構中，輸入方就如同鍵盤相對於 CPU 而言是超慢速設備，他們對系統的</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">易用性、易操作性、安全性</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">要求更高。</span></p><blockquote><p><em><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">我們思考下用戶畫像系統，它部分滿足配置系統的訪問模型，即數據流是單向的，離線系統負責寫入畫像數據，而實時系統讀數據。但是首先它的數據生產者通常是離線任務，而非運營人員；再次，它涉及到的數據量是巨大的，通常需要定製的存儲引擎。配置系統與之相比，不可同日而語。</span></em></p></blockquote><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">相較而言，配置系統的消費者則是</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">高頻</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">的讀訪問，對系統的</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">吞吐量</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">、</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">延時</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">、</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">網絡流量</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">、</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">可用性、一致性、請求單調性</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">都有更高的要求。後續我們逐一展開深入的思考。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置系統的設計應當充分考慮到上述的數據模型、訪問模型以及系統約束。（比較奇怪的是，筆者在查閱相關配置系統實現時，鮮少看到有針對一致性、請求單調性的討論。這也是促使筆者撰寫本文的原因）</span></p><h1 class=pgc-h-arrow-right><strong>安全約束</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">正因為配置可以輕易的調整系統運行期行為，因此配置的安全性至關重要。實現安全的必要條件是：</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">讓正確的人，以正確的方式，在正確的時機，發佈正確的配置</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">。因此，配置系統不但要</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">支持灰度發佈</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">的基本能力，還要在</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">權限管理、權限粒度管理、配置變更審核、審計、歷史版本</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">等方面都要加強建設。</span></p><h1 class=pgc-h-arrow-right><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">系統的演進</span></strong></h1><h1 class=pgc-h-arrow-right><strong>單機配置文件</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">在單機系統時代，我們基本上都是使用配置文件來存儲配置數據（比如 ini 文件、xml 文件等）。配置文件易於理解、便於實現、可用性高，因此進入分佈式集群時代，仍在廣泛使用。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">然而配置文件存在諸多的缺點，包括：</span></p><ul><li><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">易用性差</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，主要體現為表達的數據類型單一，比如 ini 智能管理配置項，即 key=value 類型數據；而如果使用 xml 文件來管理 key=table 類型數據，那麼文件內容的初始化效率低下，容易出錯，難以維護；</span></li><li><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">可操作性差</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，配置文件基本只能由開發來進行修改並且發佈，產品、運營的常規業務素材變更工作就不得不捲入開發執行，對業務的流程效率有嚴重的影響；</span></li><li><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">正確性、安全性難以保障</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，正因為配置文件的易於實現，導致很多團隊疏忽了運營系統的建設，研發人員隨意修改、惡意修改配置文件的情況無法杜絕，細粒度的權限管理、操作的審核、審計無從談起；</span></li><li><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">發佈效率低下</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，配置文件是單機部署的，在集群規模較大的情況下，配置文件的任意變更都需要經過漫長的灰度發佈過程發佈到全網，如果配置文件是靜態加載的，還需要重啟二進制，需要消耗研發、運維人員較多的精力；</span></li><li><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">文件一致性難以保障</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，在發佈配置變更的過程中，如果集群中出現宕機情況，會導致不同機器間的配置出現差異，而沒有自動校正的能力，依賴於人員或者運維繫統的支持，從而導致業務進入未定義的行為。</span></li></ul><div class=pgc-img><img alt=微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/897f2970070e456f8c5a5d6f17c9c398><p class=pgc-img-caption></p></div><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">如果說易用性、可操作性、正確性、安全性可以通過搭建運營系統來進行改進，而發佈效率低下、文件一致性難以保障則是單機配置文件的致命弱點，究其本質，是因為單機配置文件系統是被動的、離散的接受外界的變更，而沒有主動的能力。</span></p><h1 class=pgc-h-arrow-right><strong>集中式配置文件中心</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">由此，出現了集中式的配置文件系統，針對性的解決了上述的問題，開發人員將配置文件存儲到獨立的第三方服務（典型的由 ZooKeeper 進行管理，也有部分團隊自行實現微服務管理），然後由 agent 週期性的將配置拉取到本地進行緩存（</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">拉</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">），或者通過事件的訂閱通知能力來將變更發佈到相應集群（</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">推</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">）。</span></p><div class=pgc-img><img alt=微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a42b4935c135421fbb756875a76ee407><p class=pgc-img-caption></p></div><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">集中式配置文件系統針對性的解決了發佈變更效率問題以及配置文件一致性保障問題。然而在筆者所知的應用案例中，仍然存在如下的問題亟需解決：</span></p><ul><li><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">一致性粒度粗</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，集中式配置文件只能確保分佈式集群達到最終一致（時間取決於拉、推的頻率及速率），卻無法保證任一時刻，對任一配置，所有進程、線程、協程看到相同的數據，而這通常會導致出現不預期的業務失敗；</span></li><li><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">無法保證請求單調性</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，在一次業務請求中，我們希望用戶看到的配置內容是靜態的，如果中間發生變更，可能帶來業務失敗，嚴重的導致用戶數據狀態錯亂；而基於集中式配置文件系統的配置通常是動態加載的，配置的變更可能隨時的反應到實時系統中，導致一次業務請求先後看到不同的數據狀態；</span></li><li><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">安全性仍無法徹底保障</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，雖然集中式配置文件的修改可以控制權限，但是在消費者機器上，開發者仍然可以手動的修改本地配置文件 cache 來影響程序的運行行為；</span></li><li><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">無法支持灰度能力</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，配置文件變更的下發是全量的，如果要支持灰度發佈的能力，就需要捲入業務方自行實現；</span></li></ul><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置文件系統，無論是單機配置文件，還是集中式配置文件，存在的問題，歸根結底，是由於配置文件這個載體以及集中式配置文件系統的管道定位決定的，從而導致進行精細化管理的成本高：</span></p><ul><li><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置文件的可視可讀能力對生產者而言是重要的，但對消費者卻是無關緊要的，因此全鏈路都由配置文件作為載體反而可能導致</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">加載效率低下</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">（比如應對千萬級黑白名單，或者業務方實時請求鏈路動態加載）；</span></li><li><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置文件難以安全、便利管理元信息，為了實現一致性、單調性、安全性，配置需要一些元數據信息管理（下文展開詳述），但是配置文件系統沒有這種能力，除非業務方使用高成本自行實現；</span></li><li><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置文件的數目與配置的數量息息相關，隨著時間的發展，</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置文件數目膨脹</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，帶來新的運營問題；</span></li><li><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">集中式配置文件系統通常只把自己定位成</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">管道</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">（據筆者所知），即不理解也不維護配置文件的內容，agent 功能單一，業務消費方不與系統直接交互，而是只看到配置文件，雖然鬆耦合可以提高可用性，但也讓業務方仍然投入不少的開發成本來處理配置文件。</span></li></ul><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置文件只是配置的物理載體，上述缺點並非無法克服，只是在基於配置文件的配置系統下，實現上述能力的成本高，需要更多的使用約束，以及外圍配套。</span></p><h1 class=pgc-h-arrow-right><strong>數據庫配置存儲</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">對結構複雜、類型較多的配置，業務研發同學通常也不會直接使用配置文件來承載，而是使用數據庫（關係型或非關係型）庫表來存儲配置，然後再編寫工具進行數據的導入。這種存儲方案克服了配置文件的部分問題，對配置有更精細化的管理。但是也存在明顯的不足，即高度的定製化，不可複用，重複開發高。因此，我們需要對此進行完善，將配置的存儲、讀、寫、管理等過程提煉共性，通用化、平臺化。</span></p><h1 class=pgc-h-arrow-right><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">方案思考</span></strong></h1><h1 class=pgc-h-arrow-right><strong>物理模型</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">既然配置文件難以精細化管理，且具備易侵入的物理實體（本地文件），我們需要新的數據結構來承載配置。前文我們討論過，配置有兩種數據模型，分別是</span>key=object<span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">以及</span>key=table<span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">。對使用者而言，配置必須是可視、可讀、易管理的。為了達成這目的，我們只需在內部運營人員與配置系統核心之間搭一套設計良好的</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">運營系統</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">即可。那麼在後端呢？對消費者而言，最注重傳輸、計算的效率，同時為了與微服務框架的對齊，</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">protobuf message</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">無疑是最佳的形式。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">然而 protobuf 無法自解釋，在沒有 message 定義的情況下，我們即沒辦法將文本性的配置轉換成 pb 二進制流，也沒辦法反序列化。因此必須將業務的 message 定義上提到運營系統，然而 protobuf 卻對可視化編輯不太友好。因此一個可行的思路是基於</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">JSON 數據</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">進行配置的定義、可視化操作、傳輸及存儲。只有到達業務側才進行數據類型的轉換。</span></p><div class=pgc-img><img alt=微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b61c16ccaf094d83add6a948d7b841c3><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>安全管理</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">搭建一套配置運營系統，讓之成為運營人員管理配置的唯一入口，輕鬆就可以得到很高的回報。我們可以基於運營系統進行各種配置安全加固，如配置的變更必須具備相應的權限，而且只有通過審核才能應用到系統，所有的操作都要有審計的能力，配置的歷史版本快速可查等。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">同時灰度、回退等能力也需要基於運營系統進行操作。</span></p><div class=pgc-img><img alt=微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/47aa827f8e604ddbab51f984520cac95><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>配置系統 SDK</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">上文提及，集中式配置文件系統的管道定位，agent 只負責定期的拉取配置然後緩存到本地的文件系統。業務系統與配置系統鬆耦合。我們認為配置文件仍然具有較高的開發成本，對業務方而言，最佳的開發形式應當是：</span></p><pre><code>int GetConfig&lt;Message&gt;(const std::string&amp; key, ::google::protobuf::Message&amp; msg);</code></pre><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">而不需要再去理解文件內容、形式。那麼我們就有必要為業務方提供一套配置系統的 SDK，將配置系統的細節、數據結構等信息都屏蔽起來，讓業務只看到配置的 Protobuf Message 對象。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">在 SDK 的基礎上，消費者只需輕度介入（業務插件，見下），我們就可以完成協議轉換、配置緩存、進程，線程，協程快速最終一致、請求單調、灰度發佈的能力。</span></p><p><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置系統 SDK 是精細化管理的基礎</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，我們可以通過維護配置本身內容之外的</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置元數據信息</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">來完成上述能力。</span></p><div class=pgc-img><img alt=微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/521f4e7521e3452abfebdc3e0af262ab><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>異步化</strong></h1><p><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">異步化是配置 SDK 的關鍵</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">。很多本地緩存的更新是週期性的由實時鏈路請求負責，易於實現，但效率上存在問題，尤其考慮到我們還需要對配置進行配置業務邏輯的處理。因此，最佳方案應當是通過異步過程來進行配置的加載、初始化及其它邏輯處理。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">異步帶來的問題是異步過程與實時請求的併發問題，即異步過程在進行配置變更過程中，應如何處理實時鏈路的讀請求，這是一個工程問題，我們會另文討論，一個可行的思路是</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">多版本及引用計數技術</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">。</span></p><div class=pgc-img><img alt=微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/ecd048c4a67744c2ae58c05a4b69d276><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>業務插件</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">異步為我們提供的另外一個好處是，業務可以在配置生效的時候進行一些初始化動作，比如進行進行</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">配置正確性校驗</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">，以及</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">搭建業務適合的數據結構</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">。比如業務白名單在 pb 中只是一個數組，如果業務進行命中查找，代價比較高。業務最期望的方式肯定還是使用 map 來存儲。因此配置 SDK 異步化，就為業務插件能力提供了基礎。</span></p><div class=pgc-img><img alt=微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/09c9c93d9e6c491785d1afaf5bea147a><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>推與拉</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">我們更傾向於配置 SDK 主動拉取配置的更新。推與拉的辯證在於效率和可用性。推比較高效，不存在無用的網絡消耗。但是推又引入了新的系統依賴（即事件中心）。如無必要，勿增實體，基於這樣的思想，我們傾向於由</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">SDK 週期性主動拉取</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">。至於效率，完全可以通過各種工程的手段加以優化，達到可以接受的程度。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">當然這也取決於系統規模，如果我們要討論的是公司機的配置系統，而不是部分中心級，那麼我們也會認真的思考推或者推拉結合的模式。</span></p><h1 class=pgc-h-arrow-right><strong>快速最終一致</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">無論是單機配置文件系統，還是集中配置文件系統，都存在嚴重的不一致問題。對一次配置變更，基本上都需要很長的時間才能達到最終一致（即所有併發看到相同的數據狀態）。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">一個可行的思路是</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">多版本以及定時生效</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">。配置只有在未來的某個時間（該時間內 SDK 已經拉到了最新數據）才對外可見。至於如何確保所有 SDK 都拉到了數據，這涉及到可用性的問題，我們另文討論。</span></p><div class=pgc-img><img alt=微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bb8c87b558774beeb132f789d0e9e927><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>請求單調</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">定時生效沒辦法解決請求單調性的問題。</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">請求單調性</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">是指，實時服務處理一次請求，在請求的調用棧過程中，讀到的配置內容必須是靜態、沒有變動的，即使中間有待生效數據變成了生效數據。一個思路是我們可以通過</span><strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">線程私有變量</span></strong><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">（協程私有變量）緩存配置版本即可。</span></p><h1 class=pgc-h-arrow-right><strong>灰度發佈</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">在配置 SDK 多版本能力的基礎上，實現灰度發佈的能力也是輕而易舉的。灰度發佈的能力，不過就是選擇生效配置版本的能力，如果本機、本角色、本請求業務 key（如用戶、商戶、訂單）等命中灰度範圍，則使用新版本，否則使用原版本。</span></p><div class=pgc-img><img alt=微信後臺開發工程師：微信研發體系下的分佈式配置系統設計概要 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fbdfb501f10b410298d3708b6288dd4f><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>效率提升</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">效率提升包括降低網絡傳輸數據量、降低配置存儲服務的壓力，這些都是具體的工程手段，我們不在本理論篇內討論。</span></p><h1 class=pgc-h-arrow-right><strong>可用性提升</strong></h1><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">分佈式系統的可用性提升是老生常談的話題，為了聚焦於配置系統獨特的能力，我們本篇不專門進行討論。</span></p><p><span style="color:#3e4753;--tt-darkmode-color: #8F9BAB">（However，儘量減少系統中的單點，是一個重要的原則。在前節”推與拉“中也有涉及。同時為了業務的可用性，第三方配置系統的運營能力、故障主動發現能力、故障通知能力、再現及定位能力也非常重要。也這是重複造輪子的一個不得已的重要原因，很多團隊軟件可能做的不錯，但服務能力（主要指運營能力）卻有點差強人意。）</span></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>微信</a></li><li><a>開發</a></li><li><a>研發體</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/b340789b.html alt=開發微信小程序，就是這麼簡單！可自動生成微信小程序源代碼 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/668ba3ef8fa84d668bac722c8d412596 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b340789b.html title=開發微信小程序，就是這麼簡單！可自動生成微信小程序源代碼>開發微信小程序，就是這麼簡單！可自動生成微信小程序源代碼</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bbee85dc.html alt=掌上生活App還信用卡秒殺微信 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bbee85dc.html title=掌上生活App還信用卡秒殺微信>掌上生活App還信用卡秒殺微信</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a980c6f3.html alt=教你從頭學前端開發——第一個網頁（一） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1c44113d83f24f5db93c8353aff0c670 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a980c6f3.html title=教你從頭學前端開發——第一個網頁（一）>教你從頭學前端開發——第一個網頁（一）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e1f5a66a.html alt=網頁開發網頁的相關概念你知道嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8ca7902bdcb14bc5a25a88be4953edd6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e1f5a66a.html title=網頁開發網頁的相關概念你知道嗎？>網頁開發網頁的相關概念你知道嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9552c1b8.html alt="軟件開發中數據庫必備基礎01 - 圖解事務基礎" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e4e00ac778db451792b955bde23add02 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9552c1b8.html title="軟件開發中數據庫必備基礎01 - 圖解事務基礎">軟件開發中數據庫必備基礎01 - 圖解事務基礎</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f8c3b92d.html alt=python安全開發軍規之四：使用安全的隨機數生成器 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/bbda123b84db44148aca9d3e26ddf119 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f8c3b92d.html title=python安全開發軍規之四：使用安全的隨機數生成器>python安全開發軍規之四：使用安全的隨機數生成器</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/234d55fa.html alt=Java開發課程（十）——面向對象5、多態 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/df3621e51e4242fd90731dd013472f12 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/234d55fa.html title=Java開發課程（十）——面向對象5、多態>Java開發課程（十）——面向對象5、多態</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8dd83b90.html alt=常用最全正則表達式整理(開發必備) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/5127ac984657471b853b307afe52b2fe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8dd83b90.html title=常用最全正則表達式整理(開發必備)>常用最全正則表達式整理(開發必備)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e2ad303f.html alt=給JAVA開發人員的正則表達式入門課 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/5d620d422d0a4855924c5bcbf8ba483a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e2ad303f.html title=給JAVA開發人員的正則表達式入門課>給JAVA開發人員的正則表達式入門課</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a278a157.html alt=中國尚未被開發的海島，遊客甚少景色美爆，距江浙滬超近 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6150f65415b047acad00ca52441a93ec style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a278a157.html title=中國尚未被開發的海島，遊客甚少景色美爆，距江浙滬超近>中國尚未被開發的海島，遊客甚少景色美爆，距江浙滬超近</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d260a748.html alt=測試開發專題：spring-boot統一異常捕獲 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/135918e30e2f4a2ea248b539eb383688 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d260a748.html title=測試開發專題：spring-boot統一異常捕獲>測試開發專題：spring-boot統一異常捕獲</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d7062663.html alt="道韻筋骨開發 解讀普及體系中大家所熟悉的“開胯”（撥胯）練法" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/f09cbcf088974d11b128e0446ea00ccb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d7062663.html title="道韻筋骨開發 解讀普及體系中大家所熟悉的“開胯”（撥胯）練法">道韻筋骨開發 解讀普及體系中大家所熟悉的“開胯”（撥胯）練法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/aa93bfe3.html alt=服務器開發專題1-程序，進程的區別和併發概念 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/1534549004517ed1429f6ce style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/aa93bfe3.html title=服務器開發專題1-程序，進程的區別和併發概念>服務器開發專題1-程序，進程的區別和併發概念</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/63619dc0.html alt=匯川六宗肥地上架，開發商們都不淡定了 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/5fb5a9d4ae93444e8660c99914c3e7ad style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/63619dc0.html title=匯川六宗肥地上架，開發商們都不淡定了>匯川六宗肥地上架，開發商們都不淡定了</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d068068a.html alt=柬埔寨知名開發公司指定雷邦仕為防水材料合作品牌 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/3331dc1b6b1d4754acf196f00164ed8c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d068068a.html title=柬埔寨知名開發公司指定雷邦仕為防水材料合作品牌>柬埔寨知名開發公司指定雷邦仕為防水材料合作品牌</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>