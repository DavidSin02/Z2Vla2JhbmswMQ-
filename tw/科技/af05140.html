<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Isito從懵圈到熟練 - 半夜兩點Ca證書過期問題處理慘況總結 | 极客快訊</title><meta property="og:title" content="Isito從懵圈到熟練 - 半夜兩點Ca證書過期問題處理慘況總結 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/8667e87a120542839ef61c53baad35e9"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/af05140.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/af05140.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/af05140.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/af05140.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/af05140.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/af05140.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/af05140.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/af05140.html><meta property="article:published_time" content="2020-10-29T21:04:13+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:13+08:00"><meta name=Keywords content><meta name=description content="Isito從懵圈到熟練 - 半夜兩點Ca證書過期問題處理慘況總結"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/af05140.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Isito從懵圈到熟練 - 半夜兩點Ca證書過期問題處理慘況總結</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>11月22號半夜2點，被值班同學的電話打醒。瞭解下來，大概情況是，客戶某一臺K8s集群節點重啟之後，他再也無法創建Istio虛擬服務和Pod了。</p><p>一來對Istio還不是那麼熟悉，二來時間可能有點晚，腦子還在懵圈中，本來一個應該比較輕鬆解決掉的問題，花了幾十分鐘看代碼，處理的慘不忍睹。最終還是在某位大神幫助下，解決了問題。</p><p>鑑於此問題，以及相關報錯，在網上找不到對應的文章，所以這裡分享下這個問題，避免後來的同學，在同樣的地方踩坑。另外謹以此篇致敬工作中遇到過的大神！</p><h1>不斷重啟的Citadel</h1><p>Citadel是istio的證書分發中心。證書即某個實體的身份證明，直接代表著實體本身參與信息交流活動。Citadel作為證書分發中心，負責替服務網格中每個服務創建身份證書，方便服務之間安全交流。</p><p>這個問題的現象是，Citadel再也無法啟動了，導致無法創建新的虛擬服務和Pod實例。觀察Citadel，發現其不斷重啟，並輸出以下報錯信息。</p><blockquote><p>2019-11-22T02:40:34.814547Z warn Neither --kubeconfig nor --master was specified. Using the inClusterConfig. This might not work.<br>2019-11-22T02:40:34.815408Z info Use self-signed certificate as the CA certificate<br>2019-11-22T02:40:34.840128Z error Failed to create a self-signed Citadel (error: [failed to create CA KeyCertBundle (cannot verify the cert with the provided root chain and cert pool)])</p></blockquote><p>通過代碼分析，以及最後一行報錯，可以理解問題背後的邏輯：</p><ol start=1><li>Citadel不能啟動，是因為其無法創建自簽名的證書（Failed to create a self-signed Citadel）</li><li>Citadel無法創建自簽名證書的原因，又是由於它不能創建祕鑰和證書（failed to create CA KeyCertBundle）</li><li>而前兩條的根本的原因，是因為在驗證創建的自簽名證書的時候，驗證失敗（cannot verify the cert with the provided root chain and cert pool）</li></ol><h1>一般意義上的證書驗證</h1><p>證書的簽發關係，會把證書連接成一棵證書籤發關係樹。頂部是根證書，一般由可信第三方持有，根證書都是自簽名的，即其不需要其他機構來對其身份提供證明。其他層級的CA證書，都是由上一層CA證書籤發。最底層的證書，是給具體應用使用的證書。</p><div class=pgc-img><img alt="Isito從懵圈到熟練 - 半夜兩點Ca證書過期問題處理慘況總結" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8667e87a120542839ef61c53baad35e9><p class=pgc-img-caption></p></div><p>驗證這棵樹上的證書，分兩種情況：</p><p>根證書驗證。因為即是簽發者，又是被簽發者，所以根證書驗證，只需要提供根證書本身，一般肯定驗證成功。<br>其他證書驗證。需要提供證書本身，以及其上層所有CA證書，包括根證書。</p><p>自簽名證書驗證失敗Citadel啟動失敗的根本原因，是其創建的自簽名的證書，無法驗證通過。而這一點，也是我處理問題時，卡殼的原因。左思右想，不明白為什麼剛剛新建的自簽名證書，都驗證不通過。</p><h1>大神定理</h1><p>有一條定理，就是我們絞盡腦汁，耗費大量時間無法解決的問題，在大神眼裡，可能就是幾秒鐘的事情。11月22號半夜，這條真理再次被驗證。<br>因為實在想不通，但是用戶又非常著急，所以最終還是打擾了一位大神，他只大概看了一下報錯，就判斷是CA證書過期問題。使用istio提供的證書驗證腳本，很快證實了他的判斷。相關文章見最後參考部分。</p><h1>Citadel證書體系</h1><p>問題解決了，這裡總結下Citadel證書體系。大多數用戶使用Isito的時候，都會選擇使用自簽名的根證書。自簽名根證書，證書，以及證書使用者sidecar三種之間有三種關係：</p><div class=pgc-img><img alt="Isito從懵圈到熟練 - 半夜兩點Ca證書過期問題處理慘況總結" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4e38bf0dbe744208a7653abe10d9f5ac><p class=pgc-img-caption></p></div><ol start=1><li>根證書和證書之間的簽發關係。這種關係，保證了信任的傳遞性質。</li><li>證書和sidecar之間的持有和被持有關係。某種意義上，這是給pod/sidecar和證書畫上了等號。</li><li>根證書和sidecar之間的信任關係。這與前兩條加起來，sidecar就信任所有根證書籤發的證書。</li></ol><p>以上三條，即可保證，在互相通信的時候，pod/sidecar之間可以完成tls雙向認證成功。</p><h1>犯的錯</h1><p>這個問題排查中，實際上犯了兩個錯誤。一個是代碼閱讀不仔細，一直盯著自簽名證書新建的邏輯看。因為有了這個前提，即新建證書驗證失敗，所以沒有辦法理解，為什麼新建的自簽名證書也會驗證失敗，所以傾向於認為是底層安全庫出了問題；另外一個是，只盯著Citadel不能啟動的報錯做，忽略了另外一條線索，就是Pod和虛擬服務創建失敗。實際上後來發現，pod和虛擬服務創建失敗的報錯，有更明顯的證書過期錯誤信息。</p><blockquote><p>virtualservices.networking.istio.io "xxxx" could not be patched: Internal error occurred: failed calling admission webhook "pilot.validation.istio.io": Post https://istio-galley.istio-system.svc:443/admitpilot?timeout=30s: x509: certificate has expired or is not yet valid.</p></blockquote><h1>後記</h1><p>在Istio比較早期的版本中，自簽名Ca證書有效期只有一年時間，如果使用老版本Istio超過一年，就會遇到這個問題。當證書過期之後，我們創建新的虛擬服務或者pod，都會因為CA證書過期而失敗。而這時如果Citadel重啟，它會讀取過期證書並驗證其有效性，就會出現以上Cidatel不能啟動的問題。</p><p>這個Ca證書在K8s集群中，是以istio-ca-secret命名的secret，我們可以使用openssl解碼證書來查看有效期。這個問題比較簡單的處理方法，就是刪除這個Secret，並重啟Citadel，這時Citadel會走向新建和驗證自簽名Ca證書的邏輯並刷新Ca證書。或者參考以下官網處理方式。</p><p>作者：shengdong</p><p>本文為雲棲社區內容，未經允許不得轉載。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Isito</a></li><li><a>從懵圈</a></li><li><a>熟練</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/57006b32.html alt=怎麼熟練使用和麵機 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/97a725207ce34f49b654aafbe165015e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/57006b32.html title=怎麼熟練使用和麵機>怎麼熟練使用和麵機</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2bc1b645.html alt=CAD快速入門：我有熟練掌握命令的好方法，你需要嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/f288fcdb64fb47f28ee347c20f078cc6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2bc1b645.html title=CAD快速入門：我有熟練掌握命令的好方法，你需要嗎？>CAD快速入門：我有熟練掌握命令的好方法，你需要嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/91d0759b.html alt=熟練掌握這些快捷鍵，我們在做報表時工作效率一定會大幅度提高 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3ae84bf5b46b49a4af475f402d7a11eb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/91d0759b.html title=熟練掌握這些快捷鍵，我們在做報表時工作效率一定會大幅度提高>熟練掌握這些快捷鍵，我們在做報表時工作效率一定會大幅度提高</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/318bfbe4.html alt=神奇的數學技巧，熟練了，加減法原來這麼簡單 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/59fab5c96d804fedac84b7ed5ec6257c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/318bfbe4.html title=神奇的數學技巧，熟練了，加減法原來這麼簡單>神奇的數學技巧，熟練了，加減法原來這麼簡單</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/f0e0ae66.html alt=小學量詞彙總，全部熟練，拿下量詞分數不在話下 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1526710487151158cece0c1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/f0e0ae66.html title=小學量詞彙總，全部熟練，拿下量詞分數不在話下>小學量詞彙總，全部熟練，拿下量詞分數不在話下</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/b38c841f.html alt=熟練掌握獼猴桃的栽培技術才能有好的收穫！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RJ4Pu591fm3YJK style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/b38c841f.html title=熟練掌握獼猴桃的栽培技術才能有好的收穫！>熟練掌握獼猴桃的栽培技術才能有好的收穫！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a61bdd8c.html alt=6個Excel表格製作技巧，熟練掌握工作效率加倍，再也不用加班 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8503ee5016024e6e8a9ae82df1754814 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a61bdd8c.html title=6個Excel表格製作技巧，熟練掌握工作效率加倍，再也不用加班>6個Excel表格製作技巧，熟練掌握工作效率加倍，再也不用加班</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/9fe210c.html alt="對於他們，人人都是“特種兵”, 熟練掌握上百種武器，幾十種技能" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e5969b14a6ca407a8c493b5f65ed7fbb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/9fe210c.html title="對於他們，人人都是“特種兵”, 熟練掌握上百種武器，幾十種技能">對於他們，人人都是“特種兵”, 熟練掌握上百種武器，幾十種技能</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ea0d9c5.html alt=收藏的魅力！從懵圈到了解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/9080b1a783cd450abc2cbfbaade231e2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ea0d9c5.html title=收藏的魅力！從懵圈到了解>收藏的魅力！從懵圈到了解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cb18f5b.html alt=學會這些就是可以熟練的使用電腦了 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/370ba931428d482bb19e27984d932b1e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cb18f5b.html title=學會這些就是可以熟練的使用電腦了>學會這些就是可以熟練的使用電腦了</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/ca36f32.html alt=鉑金段位最怕碰到的滿熟練英雄，韓信上榜，第4才是真尷尬！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/pgc-image/96a2f28e99e840739bb08caebf5adadb style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/ca36f32.html title=鉑金段位最怕碰到的滿熟練英雄，韓信上榜，第4才是真尷尬！>鉑金段位最怕碰到的滿熟練英雄，韓信上榜，第4才是真尷尬！</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>