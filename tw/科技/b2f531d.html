<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上） | 极客快訊</title><meta property="og:title" content="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/6f801326ed99441f9ed7cd31640478ea"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b2f531d.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b2f531d.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b2f531d.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b2f531d.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b2f531d.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b2f531d.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b2f531d.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b2f531d.html><meta property="article:published_time" content="2020-10-29T21:04:24+08:00"><meta property="article:modified_time" content="2020-10-29T21:04:24+08:00"><meta name=Keywords content><meta name=description content="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/b2f531d.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6f801326ed99441f9ed7cd31640478ea><p class=pgc-img-caption></p></div><p>Intel近日在內部發表一篇告員工的內參文章，全文在Reddit上洩露了出來，表示歷經50餘年的Intel與AMD的競爭進入了新的階段。AMD和Intel創立時間都在68-69年，兩個公司的位置也十分接近，兩個公司的業務重疊領域也很多，可以說是歷經50年的對手。但在2018年，AMD的銷售額為64.8億美元，員工數10100人，而Intel卻有超過了700億美元的銷售額和超過10萬員工，這兩者之間有著超過10倍的差距。</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e9a9b04adfa14d438b332f0b19f562a0><p class=pgc-img-caption></p></div><p>Lisa Su在擔任AMD CEO的五年就是AMD股價飛昇的五年，在這段時間裡,AMD股價上升了681%，遠遠跑過Intel和標準普爾的水平。AMD在最近兩個財年增長速度都超過20%，Intel認為AMD作為個強大的競爭對手在重新崛起。之前Intel的Roadmap是一個季度更新一次，但最近一次更新已經過去了快半年，很明顯Intel正在準備從內部重新調整自己的產品策略來應對Zen 2的挑戰。</p><p>而作為消費者，我們更為樂於見到AMD的強大，旗鼓相當的相互競爭才能觸動行業的發展。在Zen發佈之後，Intel就很明顯的加快了產品規格提升的速度，僅僅兩三年的時間，處理器規模就從7700K的4核心，提升到了9900K的8核心，這在幾年之前是很難想象的。要知道4核心8線程作為非HEDT的旗艦，從2600K到7700K都未曾動搖過，但Zen卻改變了這一切。短短兩年Intel桌面平臺核心數就實現了翻番，現在千元已下的i5就已經有之前i7級別才有的性能和規格。</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7a69b6597f844fcd9f2b5a9db7fe2cd3><p class=pgc-img-caption></p></div><p>而在7月7日發售的全新一代Zen 2，也被給予很高的期望。在京東平臺預售3700X的預定量高達4465件，而相同價格定位同期預定的i7 9700F預定量只有36件(截至2019年7月7日8點)，其之間有124倍的差距，這作為一顆高端處理器而言實屬不易，看來Zen 2大成功。</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/fd324524d2414957aee0aeefeaa2bf02><p class=pgc-img-caption></p></div><p>Zen的成功是有目共睹，Zen 2的期待情緒也是尤其高漲，但伴隨高漲的情緒奇怪的氛圍也滋長起來，就是對於Zen 2的各種抬高。AFAN群體似乎認為3700X就可以拳打9900K一樣。這樣情況是多種原因導致的，既有錯誤信息引導，也有人蓄意帶節奏。</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3a946e7cea43415c9b40457fae9694ee><p class=pgc-img-caption></p></div><p>早些時候晚上有個不明出處的圖，上面寫著3800X頻率可以有4.7GHz,GPU-Z單線程得分可以有635分（但實際上3800X超頻只能有4.3GHz，得分也就520分水平)。</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/4c8f81ed51aa4e74b87b2dca462b24a5><p class=pgc-img-caption></p></div><p>稍後有個Passmark得分上傳洩露，媒體就編撰出《三代銳龍最弱的一顆U：單核滅門9代酷睿》這樣的標題。</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/dd116977580e49839b931bae2a7ab62d><p class=pgc-img-caption></p></div><p>到7月7日發佈前夕，又有了3600遊戲全滅8700K的測試，真是喜聞樂見。</p><p>社交媒體和傳統媒體都不自覺的，或者蓄意的抬高對Zen 2的評價，這樣的結果就是導致大眾對於Zen 2存在過高的期待。但這樣的過高的期待，在Zen 2 NDA解除之後同真實性能對比就會形成巨大的落差，期望越大失望也就越大，大眾對Zen 2的認知也會由徹底肯定轉換成對立的徹底否定。這樣的抬高心理預期的信息傳播大多人雖然僅僅是出於娛樂精神，但也不能排除少數人有著不可告知的目的。</p><p>而本篇評測的主要目的，就是去偽存真，在本源、應用和市場層次上告訴你Zen 2到底怎麼樣，到底值不值得買。</p><h1><strong>AMD Zen 2 微架構概述</strong></h1><p>在當年 Ryzen 發佈會的時候，AMD 已經向媒體公佈了 Zen 的接替者 Zen+、Zen2 等後續微架構，和初代的 Zen 或者說 Zen 1 相比，Zen+ 在微架構上的改動非常小。</p><p>目前所知的，Zen + 的改進主要是 CPU 的二級高速緩存時延從 17 個週期縮短為 12 個週期以及提升了預拾取，其他的就是靠製程提升頻率以及在內存控制器上改進實現更快內存的支持，IPC（每週期指令性能）的提升只有大約 3%。</p><p>相當於 Zen+ 而言，Zen 2 是 Zen 的真正微架構改版，在流水線的前後端都有大幅度的修改，涵蓋了高速緩存、分支預測、新指令支持、執行端口和內部總線的擴充以及外部總線的升級。</p><p>按照 AMD 的說法，相對第一代的 Zen 而言，Zen 2 IPC 提升可以達到 15%，作為一個改進型的微架構，這樣的幅度在摩爾定律日益失效的今天而言，是非常可觀的。</p><p>接下來的內容可能會有些枯燥、晦澀，但是如果你能靜下心來看的話，還是會比較有趣的，因為我們將探究 Zen 2 這個微架構到底在哪些地方做了改進，而它們又將對哪方面產生影響。</p><p>說到這，我覺得需要說明一下，所謂的微架構，是指指令集的邏輯實現，例如功能組織、邏輯設計，一般由架構師來進行這個工作，架構師將研發人員提供各種功能模塊擺在面前，然後考慮到各種（成本、功耗、可用性）妥協的情況下，將它們依據合理的規格組織在一起。</p><p>對於我們這些局外人來說，微架構就是一張張的微架構圖，而 Zen1 和 Zen 2 的微架構是長這樣的：</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/a3b4689ebe044620a667d6040de2e166><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/81adba4cf7b241e39291dd65478c6aef><p class=pgc-img-caption></p></div><p>我們都知道，Zen 採用了 CCX 內核複合體的多層次多核技術，每個 CCX 內有 4 個上圖中的 Zen 內核，四個 Zen 內核之間透過一塊 CCX 內的三級高速緩衝實現數據同步、共享，而 CCX 之間的數據同步和共享必須透過名為 IF 的系統總線跑到主內存上進行。</p><p>因此，程序和操作系統必須確保相儘可能都在一個 CCX 內進行數據交換才能達到性能最佳化，當然，這個問題其實在 Intel 的一些 Xeno MP 上也是存在的。</p><p>我們下面討論的主要集中在 CCX 內部或者說 Zen 2 內核的微架構情況，因為這才是 Zen 2 真正實現更高 IPC 的所在。</p><p><strong>Zen 2 微架構改進概覽</strong></p><p>Zen 2 微內核和 Zen/Zen+ 都同屬一個家族，但是在細節上有很多不一樣的地方：</p><p>1、製程：Zen 2 採用了 CPU 內核和北橋片上分離的設計，CPU 內核採用臺積電 7 納米制程（Zen+ 是 12 納米），服務器版(EPYC Rome)的北橋採用格羅方德 14 納米，桌面版（Ryzen 3000）的北橋是臺積電 12 納米。</p><p>2、內核：</p><blockquote><p>前端：</p><p>改進了分支預測器；</p><p>改進了預取器；</p><p>改進了微操作標籤；</p><p>改進了微操作高速緩衝；</p><p>更大的微操作高速緩存（從 2K ops 到 4K ops）；</p><p>增大了派發帶寬；</p><p>後端：</p><p>更大的回退（retire）帶寬；</p><p>浮點單元：</p><p>數據通道提升至兩倍寬（從 128 位增加到 256位）；</p><p>兩倍執行單元（FMA 指令寬度從之前 128 位增加到 256 位）；</p><p>位寬加倍的 Load/Store（加載/存儲）單元（從之前的兩個 128 位 L/S 兩個 256 位）；</p><p>整數單元：</p><p>寄存器堆從 168 個增加到 180 個；</p><p>增加了一個 AGU（地址生成單元），使 AGU 數量增加到 3 個；</p><p>更大的調度器（從 4 個 14 ALU 條目 + 兩個 14 AGU 條目增加到 4 個16 ALU 條目 + 1 個28 AGU 條目）；</p><p>更大的指令重排序緩存（I-ROB，從 192 個提升到 224 個）；</p><p>內存子系統：</p><p>一級高速指令緩存從 64KiB 縮小到 32 KiB；</p><p>一級高速指令緩存從 4 路組關聯提升到 8 路組關聯；</p><p>二級數據地址轉譯緩存（DTLB）容量提升到 1.33 倍，達到 2048 個條目（Zen/Zen+ 是 1536 個條目）；</p><p>存儲隊列從 44 個增加到 48 個；</p></blockquote><p>3、CCX：</p><blockquote><p>三級高速緩存從 8MiB 提升到 16MiB；</p><p>三級高速緩存時延性能下降，從 35 週期增加到 40 個週期；</p></blockquote><p>4、安全性：</p><blockquote><p>硬件級抵禦幽靈攻擊；</p><p>密鑰/虛擬機的支持數量增加；</p></blockquote><p>5、I/O：</p><blockquote><p>PCIE 4.0；</p><p>Infinity Fabric 二代：</p><p>每通道傳輸率提升到 2.3 倍（10.6 GT/s -> 25.6 GT/s）；</p><p>內存時鐘 MCLK 與 IF 時鐘 FCLK脫耦，可以實現 2:1 和 1:1 的倍頻率；</p><p>支持 DDR4-3200（之前是 DDR4-2933）。</p></blockquote><p>7、指令集：</p><blockquote><p>CLWB：對修改過的高速緩存塊（Cache Block 或者說 Cache Line）進行回寫操作，同時可以將該高速緩存塊保留在高速緩存層次結構中。</p><p>WBNOINVD：將內部高速緩存所有修改過的存儲塊寫回到主內存中，但是不將高速緩存標記為無效（也就是不刷新）。</p><p>RDPID：讀取處理器 ID。</p></blockquote><p>從列表來看，Zen 2 的變化是幾乎全方位的，前後端、內存子系統、總線系統以及指令集，都為這個微架構注入了新的魔法，其中的三條新增指令對性能的影響不會很大，FMA4 指令也未被重啟，所以我們更多的是關注 Zen 2 微架構的前後端部分。</p><p><strong>Zen 2 前端——高速緩存以及分支預測器</strong></p><p>微操作高速緩存</p><p>Zen 的微架構在很多方面都和 Intel 的 Core 系列 CPU 非常類似，例如微操作高速緩衝（μops-Cache，Intel 也稱之為 Decoed Stream Buffer 或者 DSB，AMD 對微操作的簡稱是 OC，而 Intel 對其簡稱是 UC）。</p><p>Zen1/Zen+ 的微操作高速緩存大小都是最高 2K 指令，如果按照 AMD 的軟件指南，提到微操作高速緩存的大小是 2KiB（第 2.1 節，p18）。</p><p>這個 2KiB 的說法似乎是有點讓人感到疑惑的，因為解碼後的指令或者說微操作都是固定長度的，而微操作的長度不可能只有 1 個字節（8 位）。</p><p>相比之下，Intel 的 Coffee Lake（CFL，2017 年第三季發佈，就是現在的 9000/8000 系列）微操作高速緩存大小是最高 1.5K 指令，一般認為 Intel 的微操作長度大約是 3 個字節左右。</p><p>微操作高速緩存裡放的都是循環程序中已經解碼過的指令，這些已經解碼過的指令稱作微操作。</p><p>採用微操作高速緩存這樣的好處是在可以簡化解碼器設計的同時維持儘可能高的指令並行度。</p><p>要知道 x86 作為一種複雜指令集，其指令長度不是固定的（1 到 17 個字節），所以像 Intel 的多路 x86 解碼器都是採取一個複雜解碼器搭配幾個簡單解碼器的方式。</p><p>在微操作高速緩存發揮作用的時候，標準的指令拾取和解碼處理會被繞過。按照當年 Intel 提供的數字，微操作高速緩存的平均命中率可以達到 80%，這意味著在 80% 的時間裡，x86 解碼器的耗電都可以節省掉。</p><p>Zen 的微操作高速緩存帶寬最高可以做到每個週期 8 條指令，相比之下，Zen 的傳統取指和解碼器只能做到每週期 4 指令。</p><p>Zen 2 的微操作高速緩存大小增加到了 4K 指令，兩倍於上一代，這意味著可以提高微操作高速緩存的命中率，改善循環的性能。</p><p>不過作為代價，Zen 2 的一級指令高速緩存被減半位 32KiB，作為補償，一級指令高速緩存的組相聯從之前的 4 路或者說 4 組提升到了 8 路，作用是提高一級指令高速緩存的命中率。</p><p><strong>TAGE 分支預測器</strong></p><p>相對於微操作高速緩存，Zen 2 在分支預測上的改進帶來的性能提升可能更大。</p><p>現在的處理器都採用了超流水線和超標量設計，流水線上有多個工位負責不同的工作，例如取指、解碼、執行、寫回以及為了提升頻率而加進去的驅動工位，每個內核內都有多條這樣的流水線。</p><p>以 Zen 1 為例，它的整數流水線長度大約是 17~19 級工位（17 是微操作高速緩存命中後的情況），如果放在以前的話，這算是很深的流水線了（當年被詬病流水線深度太長的 Pentium 4 大約是 22 級或者 31 級工位）。</p><p>更長的流水線好處是縮短每個指令的處理時間，便於實現更高的頻率，但是為了讓流水線保持滿載，必須找出可以在流水線中重疊的不相依指令流，只有這樣才能實現指令並行。</p><p>例如流水線中存在條件跳轉指令的時候，由於相依性不確定的緣故，處理器必須等待其通過執行工位後，才能讓下一條指令進入取指工位。</p><p>下圖所示的，就是經典的四級工位流水線（取指、解碼、執行、寫回）在遇到分支時遭遇到的流水線工位停擺動畫示例（垂直方向是流水線工位狀態，水平方向是時間週期）：</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/cf1c83e91ced4aa3abcd52c38e83b2bd><p class=pgc-img-caption></p></div><p class=ql-align-center>動圖來源：https://github.com/Eugene-Mark/BranchPredictorDemo</p><p>如上圖所示，這是一條可以每個週期執行一條指令（1 IPC）的四級工位流水線，當出現條件分支指令的時候，第一條指令和第二條指令之間的流水線停擺週期會達到兩個週期，相當於損耗了 50% 的性能，流水線中出現停擺工位的情況，有時候被稱作“氣泡”，這裡就是有兩個氣泡。</p><p>為了降低分支導致的性能損失問題，人們提出了預測分支行為的技術，而在處理器中實現這個功能的單元就是分支預測器（Branch Predictor）。</p><p>依然以上面的四級工位流水線為例，看看有了分支預測器後，條件分支不被選中的情況：</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f9267ff11e0941d3937eeeee4f1635be><p class=pgc-img-caption></p></div><p>可以看到，流水線保持著充盈運作狀態，3 條指令用了七個週期來完成，而之前是需要 9 個週期，第一條指令和後續指令是緊挨著運行的。</p><p>不過分支預測也不是每次都準的，像靜態分支預測也就是 80% 的命中率，即使如此 20% 的預測失敗率對性能也是有巨大影響的，因此人們又提供了動態分支預測，例如 2-bit 狀態機，就是使用單個分支的最近行為來預測該分支的未來行為。</p><p>由於流水線工位越來越多（越來越長），分支預測失敗造成的性能影響與日俱增，因此動態分支預測器的開發一直是微架構比較重大的研發課題，但是這方面進展其實比較慢。</p><p>時至今日，人們還在為最後的 3% 成功率拼盡全力，因為現在想要提高 1% 的命中率往往意味得在前人的基礎上再減少 30% 的誤預測率，這是一個巨大的挑戰。</p><p>Intel 公司最近發表了一篇名為《Branch Prediction Is Not A Solved Problem: Measurements, Opportunities, and Future Directions》的論文，開篇就提到：</p><p>“For example, we show that correcting the mispredictions made by the state-ofthe-art TAGE-SC-L branch predictor on SPECint 2017 would improve IPC by margins similar to an advance in process technology node.”</p><p>大意就是，在 SPECint 2017 這個業界認可的基準測試中，採用最新式的 TAGE-SC-L 分支預測器達成的誤預測糾正能力，可以達到的每週期性能提升幅度相當於提前使用了下一代節點製程。</p><p>Intel 就是這麼認為的，並且很可能已經在其處理器中採用了類似於 TAGE 的概念，相關的論文也表明，Intel 在 TAGE 有一定的參與度。</p><p>TAGE 預測器的全稱是 <strong>TA</strong>gged <strong>GE</strong>ometric history length branch predictor，直譯過來就是標記幾何歷史長度分支預測器，由兩級分支預測器組成。一個是常見的基本預測器，用於提供默認的預測，另一個其實一組標記預測器，提供一個只符合一個標記的預測結果。</p><p>TAGE 分支預測器及其衍生的設計自從 2006 年的 CBP-2（第二屆分支預測冠軍賽）以來，一直都位居冠軍榜單上，從未丟過桂冠，其優勢就是成本效益比，在 06 年推出的時候，就憑藉同樣的芯片面積預算，以顯著的優勢擊敗了 04 年 CBP-1 裡出現的所有分支預測器。</p><p>分支預測器很重要，而 TAGE 分支預測器是目前最好的分支預測器，如今 Zen 2 也引入了這個最好的分支預測器。</p><p>Zen 1 的分支預測器沿用自針對低功耗處理器 Jaguar 的分支預測器，AMD 對其命名為神經網絡感知分支預測器，不過 Jaguar 的流水線深度只有 14 級，Zen 是 17-19 級流水線深度。按理說流水線越深，分支預測失敗的懲罰就越高，因此對分支預測器的性能就越高，事實上除了流水線深度外，Zen 2 的超標量能力也是遠高於 Jaguar 的，這會進一步增大分子懲罰的幅度，故此神經網絡感知分支預測器對 Zen 來說是有點拖後腿的。</p><p>為此，AMD 在 Zen 2 上採用了兩級分支預測機制，原來的神經網絡感知預測器依然保留作為一級分支預測器，而 TAGE 則被引入作為二級分支預測器。</p><p>我們在上面囉嗦了一大堆東西，到底在實際應用中會有多少的性能變化呢？我們在這裡使用 Fritz Chess benchmark 也就是大家眾所熟知的國際象棋來做一個對比。</p><p>國際象棋是一個有密集分支指令的應用，當初我使用這個測試軟件的，目的是為了對比流水線 31 級的 Pentium 4 和流水線 12 級的 AMD Athlon X2 5000+（K8 系列 Windsor 微架構，90 納米制程）的，下面這個圖表可以讓大家回憶一下當初這兩個產品的性能對比：</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/25f8ebe4346d43f880a3787908ede4cf><p class=pgc-img-caption></p></div><p>Pentium 4 家族使用的甚深流水線設計使其分支預測失敗導致的性能損耗遠高於 K8，在 Fritz Chess Benchmark 中，這個問題會被顯著放大，上面的測試結果表明這是一個比較適合用於測試分支預測損失的測試。</p><p>為了確定流水線深度的影響，我覺得有必要看看 Zen 2 的流水線深度到底是多少級的。</p><p>AMD 和 Intel 沒有公佈過新近處理器的流水線深度，不過我們可以透過測試分支預測失敗的懲罰來獲知。</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/bde18c0416004134be54d98c800a76b4><p class=pgc-img-caption></p></div><p>上表中的左側是以偽代碼方式提供分支程序測試片段，以第 7 個測試（Test 6）為例：</p><p>Test 6, N= 1, 8 br, MOVZX XOR ; if (c & mask) { REP-N(c^=v[c-256]) } REP-2(c^=v[c-260])</p><p>這段內容包含了一個 MOVZX 內存載入操作指令，它需要額外的 5 到 6 個週期來執行，在支持亂序執行、亂序 L/S 的處理器中，這個動作通常會被掩蓋掉。</p><p>從上圖中可以看到，這個 Test 6 的 Zen 2/Zen 1 測試結果分別是 12.22/12.30 個週期，加上 MOVZX 的 5 個週期，那這個測試的 Zen 2/Zen 1 有效結果就是 17 個週期。</p><p>從測試結果來看，Zen 2 的分支預測懲罰都在 17-19 個週期左右，Zen 1 則是 17-21 個週期左右，Coffee Lake 和 Kaby Lake 都是 16-20 個週期左右。我們認為 Zen 2 在流水線長度上和 Zen 1 都是類似的，即 19 級工位（stage），由於微操作高速緩存的原因，有時候可以視作等效 17 級工位。</p><p>Zen 2 和 Coffee Lake 的流水線深度也非常接近，也就是一個工位的差別，因此，只要我們測試的時候，兩者的頻率儘量設置到一致（鎖定 4GHz，減少頻率波動干擾，內核數設定為一個，關閉硬件多線程），運行 Fritz Chess 的結果就可以高度反應兩者的動態分支預測性能差別。</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9caba270391a490fb9b447c5951989cd><p class=pgc-img-caption></p></div><p>高速緩存正如你所看到的，採用了 TAGE 分支預測器的 Zen 2 在同頻下的 Fritz Chess 性能快了 20% 以上，和 Core i7 9900K 相比，也快了 5% 左右，回想上一次 AMD 在這個測試中領先 Intel，一晃已經過去了 12 年。</p><p>TAGE 分支預測器對 Zen 2 的性能提升毋容置疑，但是另一方面，所有的處理器都非常依賴高速緩存。</p><p>所有的處理器都採用了多層次內存子系統，而靠近內核的則是高速緩存，Zen 2 和 Zen 1 一樣採用了三級高速緩存設計（微操作高速緩存如果算是零級的話，那可以算是有四級高速緩存），每個 Zen 內核都有自己獨立的 L1/L2 高速緩存，CCX 內的四個內核透過 L3 高速緩存共享、交換數據。</p><p>首先讓我們來看看帶寬部分：</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9500c95b8299496386236fb8343c1873><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/61b76e69f32344e4b960a971a53fb8b3><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1b3244fccd824a8dafb467bbe6dfac4c><p class=pgc-img-caption></p></div><p>我們的內核微架構測試，都是在 BIOS 內設置單內核、關閉多線程，關閉電源管理，強制 4GHz，內存設置為 DDR4-3200 的情況下測試，目的儘量直接探究每個內核的微架構細節。</p><p>說明一下的是，由於受到 Excel 的限制，橫座標的數字格式不支持二進制（如果你有辦法實現的話不妨留言告知），你在圖表看到的橫座標值都是十進制值，所以單位標註都是 KB、MB 這類十進制單位，而非二進制的 KiB、MiB，圖中的 33KB 標註，相當於 32KiB，34MB 相當於 32MiB，如此類推不一而足。</p><p>從測試結果來看，Zen+/Zen 2 這邊的 L1/L2/L3 高速緩存讀取帶寬可以一直保持在每週期 32 字節的水平，而 Coffee Lake 雖然紙面上說 L2 Cache 的 Load 帶寬是每週期 64 字節，但是我們並未從測試中看到這樣的情況出現。</p><p>數據高速緩存時延測試</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/97300c2e13024a6ab1e053c0c237028e><p class=pgc-img-caption></p></div><p>Zen 2 和 Zen+ 數據高速緩存的時延曲線非常類似，不過 Zen 2 由於更大的三級高速高速緩存而在 8-16MiB 的位置有更好的表現。</p><p>Coffee Lake 在 32KiB 以內都能保持 4 週期的時延，但是在之後到時延表現都不如 Zen 2。</p><p>Zen 系列的 L2 Cache 的時延無法維持在一個穩定的平臺，但是可以在 256 KiB 前都維持比對手更低的時延曲線。</p><p>指令解碼/緩存/執行能力</p><p>眾所周知，x86 是複雜指令集架構，但是和精簡指令集相比，區別並非什麼指令數量的多寡，而是其指令長度格式不一。</p><p>以最簡單的 NOP 空指令為例，它的 x86 編碼長度是一個字節，加法指令 ADD、乘法指令 MUL 等則是兩個字節，最長的 x86 指令有 17 個字節。</p><p>我們採用了部分有代表性的 x86 指令進行指令解碼測試，測算出解碼帶寬信息（結果受微操作高速緩存、指令高速緩存、解碼器、執行單元、回退等工位影響）：</p><p>正如你所看到的測試結果，Zen2/Zen + 都具備每週執行 5 個單字節指令的能力，而 Coffee 則是隻有每週期 4 單字節指令的能力。</p><p>Prefixed CMP 其實是針對 x86-64 指令的測試，可以看到，在微操作高速緩存範圍內的指令流能夠為處理器維持每週期 4 條 8 字節指令的執行能力。</p><p>如果單純從表格來看的話，Zen2 似乎和 Zen+ 一樣，但是我們將收集的數據整理為圖表後，看到了更多的細節：</p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9ac9cd4355204e9c9e9062af9ae0a029><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/52485865b6d04c82878c2f0dd27a26e5><p class=pgc-img-caption></p></div><p>我們選取了 NOP 指令（x86 指令長度 1 個字節）以及 Prefixed 的 CMP 4（x86 指令長度 8 個字節）的測試結果做了上面的兩個圖表。</p><p>可以看到 Zen 2 在 NOP 的時候，每週期 5 指令的峰值數據可以維持到 3KiB 以上，而Zen+ 只能維持到大約 0.2KiB 左右。</p><p>在長度為 8 字節的指令時，Zen2 每週期兩指令的峰值數據可以維持到 16KiB，而 Zen + 只能維持到 8KiB。</p><p>從目前的測試結果來看，我們估計 Zen2 的微操作高速緩存容量按照字節衡量的話，應該不低於 16KiB。</p><p><strong>微架構實現細節對比</strong></p><div class=pgc-img><img alt="AMD銳龍第三代處理器+ROG C8H首測：尋根Zen 2性能本源（上）" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9689a63967364554bee74a271ff463d9><p class=pgc-img-caption></p></div><p>我們使用 AIDA64 v6.00.5122 Beta抓去了 Zen 和 Zen2 的指令時延、吞吐率，其中 Matisse 就是 Zen2 的桌面版內核微架構版本代號。</p><p>上表中的 MOV r32 到 VPCLMUL 等指令就是從其中 4000 多條指令測試項目中提取出來的有代表性的測試結果，豎線的兩側分別是時延和吞吐率，單位是週期，因此吞吐率其實是 CPI 值，即週期/指令，是 IPC 的逆向表示方式。</p><p>其中涉及到 ymm 寄存器的測試都是 AVX2 256-bit 指令。</p><p>從測試結果來看，Zen 2 的 AVX2 ADD/MUL/FMA 等指令的吞吐性能較 Zen 提升了一倍，證明 Zen 2 的確在 AVX2 實現上有做改進。</p><p><strong>Zen 2 內核微架構總結</strong></p><p>從微架構角度看，Zen 2 的最大改進是對前端單元的加強，包括引入了目前幾乎最強大的動態分支預測器 TAGE 分支預測器作為第二級分支預測，使得 Zen2 可以在分支密集型的應用中比上一代的 Zen+ 快 20%。</p><p>即使和 Coffee Lake 相比，同頻下的 Zen 2 在分支密集應用中也能快 5%，這是多年未曾出現過的現象，上一次在這類測試中出現 AMD 比 Intel 快的時候是因為比對手短 50% 流水線深實現的。</p><p>而這次是雙方流水線深度相當的情況下，憑藉動態分支預測器實現，對於未來數年 AMD 的競爭前景意義更大，現在的情況就好像兩個槍手對決，拔槍速度相當，但是 Zen2 的槍法很可能更準。</p><p>Zen 2 的微操作高速緩存達到 4K（微操作），從上面的解碼帶寬測試來看，我們認為這個改進對於有大量循環的應用會有一定的改進。</p><p>由於兩個向量單元引入了 256 位 AVX2 指令單週期執行能力，Zen2 在計算吞吐能力比上一代微架構提升了一倍，達到了和 Coffee Lake 相當的水平，x265 這類引入了 AVX2 優化的應用將會受益。</p><p>Zen 為 AMD 從頹勢中重新找回與對手競爭的信心，Zen+ 為 AMD 取得了市場，而 Zen 2 則是 AMD 讓我看到了真正翻身的希望。</p><p>這次應該可以至少堅持到 Intel 的 Comet Lake，嗯，時間窗口有半年，能爽半年還是不錯的。</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>AMD</a></li><li><a>銳龍</a></li><li><a>理器</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/6fc2c9b.html alt="AMD銳龍4000御用X670芯片組明年底問世 祥碩代工" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/R6F7jfNDp0Ab22 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6fc2c9b.html title="AMD銳龍4000御用X670芯片組明年底問世 祥碩代工">AMD銳龍4000御用X670芯片組明年底問世 祥碩代工</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/07b2088.html alt="Zen3處理器御用 AMD 600系芯片組下半年問世：全面支持PCIe 4.0" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RmmDfjk26K9DF2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/07b2088.html title="Zen3處理器御用 AMD 600系芯片組下半年問世：全面支持PCIe 4.0">Zen3處理器御用 AMD 600系芯片組下半年問世：全面支持PCIe 4.0</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/08f51ae.html alt=AMD銳龍嵌入式系統小如3.5寸硬盤：四路獨立4K輸出 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/RdkEm4qG0O79wa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/08f51ae.html title=AMD銳龍嵌入式系統小如3.5寸硬盤：四路獨立4K輸出>AMD銳龍嵌入式系統小如3.5寸硬盤：四路獨立4K輸出</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5a7db5c7.html alt=小米CC10曝光，除全新1億像素外，處理器成核心看點 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/683e673df11a44a0a368c73cfa78150a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5a7db5c7.html title=小米CC10曝光，除全新1億像素外，處理器成核心看點>小米CC10曝光，除全新1億像素外，處理器成核心看點</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b4c7a094.html alt=AMD系列CPU和主板參數對照表20200524 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4e358b60ba0b47538a09117a67bfab03 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b4c7a094.html title=AMD系列CPU和主板參數對照表20200524>AMD系列CPU和主板參數對照表20200524</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c3a27e7c.html alt=英特爾10代處理器和11代處理器全面型號參數大全 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7a0f5b829a8b44cbb3a8aa152fc06feb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c3a27e7c.html title=英特爾10代處理器和11代處理器全面型號參數大全>英特爾10代處理器和11代處理器全面型號參數大全</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4166eed0.html alt=AMD發佈新的物理特效計算庫FEMFX：為多核CPU進行良好優化 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RlGsAR2HwRn28k style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4166eed0.html title=AMD發佈新的物理特效計算庫FEMFX：為多核CPU進行良好優化>AMD發佈新的物理特效計算庫FEMFX：為多核CPU進行良好優化</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6a4d85c9.html alt="具有AMD RDNA圖形引擎的三星最新SoC性能比990或提近高三倍" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9201feaed69a44099b0b5ff93a126a6a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6a4d85c9.html title="具有AMD RDNA圖形引擎的三星最新SoC性能比990或提近高三倍">具有AMD RDNA圖形引擎的三星最新SoC性能比990或提近高三倍</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/620a5ca5.html alt=Mate40或效仿三星的雙處理器方案！芯片困境會對華為有哪些影響？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d773423c2e20441f8b6a8361f89d03ee style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/620a5ca5.html title=Mate40或效仿三星的雙處理器方案！芯片困境會對華為有哪些影響？>Mate40或效仿三星的雙處理器方案！芯片困境會對華為有哪些影響？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/933a5295.html alt="或將推出雙處理器版本？華為Mate40 Pro開啟全球認證" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9a14ba038e844e4583d33599d406fd95 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/933a5295.html title="或將推出雙處理器版本？華為Mate40 Pro開啟全球認證">或將推出雙處理器版本？華為Mate40 Pro開啟全球認證</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4c05ccc1.html alt="華為“雙處理器”佈局新機，Mate 40國行版才有麒麟1020" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e2fa5c49e18e49d59649ee89ceb3395a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4c05ccc1.html title="華為“雙處理器”佈局新機，Mate 40國行版才有麒麟1020">華為“雙處理器”佈局新機，Mate 40國行版才有麒麟1020</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a1200a58.html alt=華為雙處理器方案：麒麟9000、9000E，差距究竟在哪？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/78fe2846dd3f4c758befc20628e2b90d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a1200a58.html title=華為雙處理器方案：麒麟9000、9000E，差距究竟在哪？>華為雙處理器方案：麒麟9000、9000E，差距究竟在哪？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/07b93c79.html alt="雙卡槽+雙處理器 尼康Z6 II全畫幅相機評測" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/SDP0QoQ8vozV12 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/07b93c79.html title="雙卡槽+雙處理器 尼康Z6 II全畫幅相機評測">雙卡槽+雙處理器 尼康Z6 II全畫幅相機評測</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/364786a0.html alt="雙處理器平臺 YOGA 14s 2021全面預售" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/02e351bb8e5349c889af648594371a9e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/364786a0.html title="雙處理器平臺 YOGA 14s 2021全面預售">雙處理器平臺 YOGA 14s 2021全面預售</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/66dc14c7.html alt=雙處理器方案或上線，華為Mate40配置真豪橫，超過預期 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a25d740d3ef3457797c415fa69068c66 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/66dc14c7.html title=雙處理器方案或上線，華為Mate40配置真豪橫，超過預期>雙處理器方案或上線，華為Mate40配置真豪橫，超過預期</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>