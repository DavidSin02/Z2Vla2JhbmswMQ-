<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>é€™ä¸€æ¬¡ææ‡‚Springä»£ç†å‰µå»º+AOPéˆå¼èª¿ç”¨éç¨‹ | æå®¢å¿«è¨Š</title><meta property="og:title" content="é€™ä¸€æ¬¡ææ‡‚Springä»£ç†å‰µå»º+AOPéˆå¼èª¿ç”¨éç¨‹ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/e1c7c82fff674a01b49573f34eb5dc1b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b6fc620f.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b6fc620f.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b6fc620f.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b6fc620f.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b6fc620f.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b6fc620f.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b6fc620f.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b6fc620f.html><meta property="article:published_time" content="2020-11-14T21:04:30+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:30+08:00"><meta name=Keywords content><meta name=description content="é€™ä¸€æ¬¡ææ‡‚Springä»£ç†å‰µå»º+AOPéˆå¼èª¿ç”¨éç¨‹"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/b6fc620f.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>é€™ä¸€æ¬¡ææ‡‚Springä»£ç†å‰µå»º+AOPéˆå¼èª¿ç”¨éç¨‹</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=line>å‰è¨€</h1><p>AOPï¼Œä¹Ÿå°±æ˜¯é¢å‘åˆ‡é¢ç·¨ç¨‹ï¼Œå®ƒå¯ä»¥å°‡å…¬å…±çš„ä»£ç¢¼æŠ½é›¢å‡ºä¾†ï¼Œå‹•æ…‹çš„æ¤å…¥åˆ°ç›®æ¨™é¡ã€ç›®æ¨™æ–¹æ³•ä¸­ï¼Œå¤§å¤§æé«˜æˆ‘å€‘ç·¨ç¨‹çš„æ•ˆç‡ï¼Œä¹Ÿä½¿ç¨‹åºè®Šå¾—æ›´åŠ å„ªé›…ã€‚å¦‚äº‹å‹™ã€æ“ä½œæ—¥èªŒç­‰éƒ½å¯ä»¥ä½¿ç”¨AOPå¯¦ç¾ã€‚é€™ç¨®ç¹”å…¥å¯ä»¥æ˜¯<strong>åœ¨é‹è¡ŒæœŸå‹•æ…‹ç”Ÿæˆä»£ç†å°è±¡</strong>å¯¦ç¾ï¼Œä¹Ÿå¯ä»¥åœ¨<strong>ç·¨è­¯æœŸ</strong>ã€<strong>é¡åŠ è¼‰æ™‚æœŸ</strong>éœæ…‹ç¹”å…¥åˆ°ä»£ç¢¼ä¸­ã€‚è€ŒSpringæ­£æ˜¯é€šéç¬¬ä¸€ç¨®æ–¹æ³•å¯¦ç¾ï¼Œä¸”åœ¨ä»£ç†é¡çš„ç”Ÿæˆä¸Šä¹Ÿæœ‰å…©ç¨®æ–¹å¼ï¼šJDK Proxyå’ŒCGLIBï¼Œé»˜èªç•¶é¡å¯¦ç¾äº†æ¥å£æ™‚ä½¿ç”¨å‰è€…ï¼Œå¦å‰‡ä½¿ç”¨å¾Œè€…ï¼›å¦å¤–Spring AOPåªèƒ½å¯¦ç¾å°æ–¹æ³•çš„å¢å¼·ã€‚</p><h1 class=line>æ­£æ–‡</h1><h2 class=line>åŸºæœ¬æ¦‚å¿µ</h2><p>AOPçš„è¡“èªå¾ˆå¤šï¼Œé›–ç„¶ä¸æ¸…æ¥šè¡“èªæˆ‘å€‘ä¹Ÿèƒ½å¾ˆç†Ÿç·´åœ°ä½¿ç”¨AOPï¼Œä½†æ˜¯è¦ç†è§£åˆ†ææºç¢¼ï¼Œè¡“èªå°±éœ€è¦æ·±åˆ»é«”æœƒå…¶å«ç¾©ã€‚</p><ul><li>å¢å¼·ï¼ˆAdviceï¼‰ï¼šå°±æ˜¯æˆ‘å€‘æƒ³è¦é¡å¤–å¢åŠ çš„åŠŸèƒ½</li><li>ç›®æ¨™å°è±¡ï¼ˆTargetï¼‰ï¼šå°±æ˜¯æˆ‘å€‘æƒ³è¦å¢å¼·çš„ç›®æ¨™é¡ï¼Œå¦‚æœæ²’æœ‰AOPï¼Œæˆ‘å€‘éœ€è¦åœ¨æ¯å€‹ç›®æ¨™å°è±¡ä¸­å¯¦ç¾æ—¥èªŒã€äº‹å‹™ç®¡ç†ç­‰éæ¥­å‹™é‚è¼¯</li><li>é€£æ¥é»ï¼ˆJoinPointï¼‰ï¼šç¨‹åºåŸ·è¡Œæ™‚çš„ç‰¹å®šæ™‚æ©Ÿï¼Œå¦‚æ–¹æ³•åŸ·è¡Œå‰ã€å¾Œä»¥åŠæ‹‹å‡ºç•°å¸¸å¾Œç­‰ç­‰ã€‚</li><li>åˆ‡é»ï¼ˆPointcutï¼‰ï¼šé€£æ¥é»çš„å°èˆªï¼Œæˆ‘å€‘å¦‚ä½•æ‰¾åˆ°ç›®æ¨™å°è±¡å‘¢ï¼Ÿåˆ‡é»çš„ä½œç”¨å°±åœ¨æ–¼æ­¤ï¼Œåœ¨Springä¸­å°±æ˜¯åŒ¹é…è¡¨é”å¼ã€‚</li><li>å¼•ä»‹ï¼ˆIntroductionï¼‰ï¼šå¼•ä»‹æ˜¯ä¸€ç¨®ç‰¹æ®Šçš„å¢å¼·ï¼Œå®ƒç‚ºé¡æ·»åŠ ä¸€äº›å±¬æ€§å’Œæ–¹æ³•ã€‚é€™æ¨£ï¼Œå³ä½¿ä¸€å€‹æ¥­å‹™é¡åŸæœ¬æ²’æœ‰å¯¦ç¾æŸå€‹æ¥å£ï¼Œé€šéAOPçš„å¼•ä»‹åŠŸèƒ½ï¼Œæˆ‘å€‘å¯ä»¥å‹•æ…‹åœ°ç‚ºè©²æ¥­å‹™é¡æ·»åŠ æ¥å£çš„å¯¦ç¾é‚è¼¯ï¼Œè®“æ¥­å‹™é¡æˆç‚ºé€™å€‹æ¥å£çš„å¯¦ç¾é¡ã€‚</li><li>ç¹”å…¥ï¼ˆWeavingï¼‰ï¼šå³å¦‚ä½•å°‡å¢å¼·æ·»åŠ åˆ°ç›®æ¨™å°è±¡çš„é€£æ¥é»ä¸Šï¼Œæœ‰å‹•æ…‹ï¼ˆé‹è¡ŒæœŸç”Ÿæˆä»£ç†ï¼‰ã€éœæ…‹ï¼ˆç·¨è­¯æœŸã€é¡åŠ è¼‰æ™‚æœŸï¼‰å…©ç¨®æ–¹å¼ã€‚</li><li>ä»£ç†ï¼ˆProxyï¼‰ï¼šç›®æ¨™å°è±¡è¢«æ¤å…¥å¢å¼·å¾Œï¼Œå°±æœƒç”¢ç”Ÿä¸€å€‹ä»£ç†å°è±¡ï¼Œè©²å°è±¡å¯èƒ½æ˜¯å’ŒåŸå°è±¡å¯¦ç¾äº†åŒæ¨£çš„ä¸€å€‹æ¥å£ï¼ˆJDKï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯åŸå°è±¡çš„å­é¡ï¼ˆCGLIBï¼‰ã€‚</li><li>åˆ‡é¢ï¼ˆAspectã€Advisorï¼‰ï¼šåˆ‡é¢ç”±åˆ‡é»å’Œå¢å¼·çµ„æˆï¼ŒåŒ…å«äº†é€™å…©è€…çš„å®šç¾©ã€‚</li></ul><h2 class=line>ä»£ç†å°è±¡çš„å‰µå»º</h2><p>åœ¨ç†Ÿæ‚‰äº†AOPè¡“èªå¾Œï¼Œä¸‹é¢å°±ä¾†çœ‹çœ‹Springæ˜¯å¦‚ä½•å‰µå»ºä»£ç†å°è±¡çš„ï¼Œæ˜¯å¦é‚„è¨˜å¾—ä¸Šä¸€ç¯‡æåˆ°çš„AOPçš„å…¥å£å‘¢ï¼Ÿåœ¨<strong>AbstractAutowireCapableBeanFactory</strong>é¡çš„<strong>applyBeanPostProcessorsAfterInitialization</strong>æ–¹æ³•ä¸­å¾ªç’°èª¿ç”¨äº†<strong>BeanPostProcessor</strong>çš„<strong>postProcessAfterInitialization</strong>æ–¹æ³•ï¼Œå…¶ä¸­ä¸€å€‹å°±æ˜¯æˆ‘å€‘å‰µå»ºä»£ç†å°è±¡çš„å…¥å£ã€‚é€™è£¡æ˜¯Beanå¯¦ä¾‹åŒ–å®Œæˆå»å‰µå»ºä»£ç†å°è±¡ï¼Œç†æ‰€ç•¶ç„¶æ‡‰è©²é€™æ¨£ï¼Œä½†å¯¦éš›ä¸Šåœ¨Beanå¯¦ä¾‹åŒ–ä¹‹å‰èª¿ç”¨äº†ä¸€å€‹<strong>resolveBeforeInstantiation</strong>æ–¹æ³•ï¼Œé€™è£¡å¯¦éš›ä¸Šæˆ‘å€‘ä¹Ÿæ˜¯æœ‰æ©Ÿæœƒå¯ä»¥æå‰å‰µå»ºä»£ç†å°è±¡çš„ï¼Œé€™è£¡æ”¾åˆ°æœ€å¾Œä¾†åˆ†æï¼Œå…ˆä¾†çœ‹ä¸»å…¥å£ï¼Œé€²å…¥åˆ°<strong>AbstractAutoProxyCreator</strong>é¡ä¸­ï¼š</p><pre><code>    public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {        if (bean != null) {            Object cacheKey = getCacheKey(bean.getClass(), beanName);            if (!this.earlyProxyReferences.contains(cacheKey)) {                return wrapIfNecessary(bean, beanName, cacheKey);            }        }        return bean;    }    protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {        //å‰µå»ºç•¶å‰beançš„ä»£ç†ï¼Œå¦‚æœé€™å€‹beanæœ‰adviceçš„è©±ï¼Œé‡é»çœ‹        // Create proxy if we have advice.        Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);        //å¦‚æœæœ‰åˆ‡é¢ï¼Œå‰‡ç”Ÿæˆè©²beançš„ä»£ç†        if (specificInterceptors != DO_NOT_PROXY) {            this.advisedBeans.put(cacheKey, Boolean.TRUE);            //æŠŠè¢«ä»£ç†å°è±¡beanå¯¦ä¾‹å°è£åˆ°SingletonTargetSourceå°è±¡ä¸­            Object proxy = createProxy(                    bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));            this.proxyTypes.put(cacheKey, proxy.getClass());            return proxy;        }        this.advisedBeans.put(cacheKey, Boolean.FALSE);        return bean;    }</code></pre><p>å…ˆå¾ç·©å­˜ä¸­æ‹¿ï¼Œæ²’æœ‰å‰‡èª¿ç”¨<strong>wrapIfNecessary</strong>æ–¹æ³•å‰µå»ºã€‚åœ¨é€™å€‹æ–¹æ³•è£¡é¢ä¸»è¦çœ‹å…©å€‹åœ°æ–¹ï¼š<strong>getAdvicesAndAdvisorsForBean</strong>å’Œ<strong>createProxy</strong>ã€‚ç°¡å–®ä¸€å¥è©±æ¦‚æ‹¬å°±æ˜¯å…ˆæƒæå¾Œå‰µå»ºï¼Œå•é¡Œæ˜¯æƒæä»€éº¼å‘¢ï¼Ÿä½ å¯ä»¥å…ˆçµåˆä¸Šé¢çš„æ¦‚å¿µæ€è€ƒä¸‹ï¼Œæ›ä½ æœƒæ€éº¼åšã€‚é€²å…¥åˆ°å­é¡<strong>AbstractAdvisorAutoProxyCreator</strong>çš„<strong>getAdvicesAndAdvisorsForBean</strong>æ–¹æ³•ä¸­ï¼š</p><pre><code>    protected Object[] getAdvicesAndAdvisorsForBean(            Class&lt;?&gt; beanClass, String beanName, @Nullable TargetSource targetSource) {        //æ‰¾åˆ°åˆæ ¼çš„åˆ‡é¢        List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName);        if (advisors.isEmpty()) {            return DO_NOT_PROXY;        }        return advisors.toArray();    }    protected List&lt;Advisor&gt; findEligibleAdvisors(Class&lt;?&gt; beanClass, String beanName) {        //æ‰¾åˆ°å€™é¸çš„åˆ‡é¢,å…¶å¯¦å°±æ˜¯ä¸€å€‹å°‹æ‰¾æœ‰@Aspectjè¨»è§£çš„éç¨‹ï¼ŒæŠŠå·¥ç¨‹ä¸­æ‰€æœ‰æœ‰é€™å€‹è¨»è§£çš„é¡å°è£æˆAdvisorè¿”å›        List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();        //åˆ¤æ–·å€™é¸çš„åˆ‡é¢æ˜¯å¦ä½œç”¨åœ¨ç•¶å‰beanClassä¸Šé¢ï¼Œå°±æ˜¯ä¸€å€‹åŒ¹é…éç¨‹ã€‚ç¾åœ¨å°±æ˜¯ä¸€å€‹åŒ¹é…        List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);        extendAdvisors(eligibleAdvisors);        if (!eligibleAdvisors.isEmpty()) {            //å°æœ‰@Order@Priorityé€²è¡Œæ’åº            eligibleAdvisors = sortAdvisors(eligibleAdvisors);        }        return eligibleAdvisors;    }</code></pre><p>åœ¨<strong>findEligibleAdvisors</strong>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°æœ‰å…©å€‹æ­¥é©Ÿï¼Œç¬¬ä¸€å…ˆæ‰¾åˆ°æ‰€æœ‰çš„åˆ‡é¢ï¼Œå³æƒææ‰€æœ‰å¸¶æœ‰@Aspectè¨»è§£çš„é¡ï¼Œä¸¦å°‡å…¶ä¸­çš„<strong>åˆ‡é»ï¼ˆè¡¨é”å¼ï¼‰</strong>å’Œ<strong>å¢å¼·</strong>å°è£ç‚º<strong>åˆ‡é¢</strong>ï¼Œæƒæå®Œæˆå¾Œï¼Œè‡ªç„¶æ˜¯è¦åˆ¤æ–·å“ªäº›<strong>åˆ‡é¢</strong>èƒ½å¤ é€£æ¥åˆ°ç•¶å‰Beanå¯¦ä¾‹ä¸Šã€‚ä¸‹é¢ä¸€æ­¥æ­¥ä¾†åˆ†æï¼Œé¦–å…ˆæ˜¯æƒæéç¨‹ï¼Œé€²å…¥åˆ°<strong>AnnotationAwareAspectJAutoProxyCreator</strong>é¡ä¸­ï¼š</p><pre><code>    protected List&lt;Advisor&gt; findCandidateAdvisors() {        // å…ˆé€šéçˆ¶é¡AbstractAdvisorAutoProxyCreatoræƒæï¼Œé€™è£¡ä¸é‡è¦        List&lt;Advisor&gt; advisors = super.findCandidateAdvisors();        // ä¸»è¦çœ‹é€™è£¡        if (this.aspectJAdvisorsBuilder != null) {            advisors.addAll(this.aspectJAdvisorsBuilder.buildAspectJAdvisors());        }        return advisors;    }</code></pre><p>é€™è£¡å§”è¨—çµ¦äº†<strong>BeanFactoryAspectJAdvisorsBuilderAdapter</strong>é¡ï¼Œä¸¦èª¿ç”¨å…¶çˆ¶é¡çš„<strong>buildAspectJAdvisors</strong>æ–¹æ³•å‰µå»ºåˆ‡é¢å°è±¡ï¼š</p><pre><code>    public List&lt;Advisor&gt; buildAspectJAdvisors() {        List&lt;String&gt; aspectNames = this.aspectBeanNames;        if (aspectNames == null) {            synchronized (this) {                aspectNames = this.aspectBeanNames;                if (aspectNames == null) {                    List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();                    aspectNames = new ArrayList&lt;&gt;();                    //ç²å–springå®¹å™¨ä¸­çš„æ‰€æœ‰beançš„åç¨±BeanName                    String[] beanNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(                            this.beanFactory, Object.class, true, false);                    for (String beanName : beanNames) {                        if (!isEligibleBean(beanName)) {                            continue;                        }                        Class&lt;?&gt; beanType = this.beanFactory.getType(beanName);                        if (beanType == null) {                            continue;                        }                        //åˆ¤æ–·é¡ä¸Šæ˜¯å¦æœ‰@Aspectè¨»è§£                        if (this.advisorFactory.isAspect(beanType)) {                            aspectNames.add(beanName);                            AspectMetadata amd = new AspectMetadata(beanType, beanName);                            if (amd.getAjType().getPerClause().getKind() == PerClauseKind.SINGLETON) {                                // ç•¶@Aspectçš„valueå±¬æ€§ç‚º""æ™‚æ‰æœƒé€²å…¥åˆ°é€™è£¡                                // å‰µå»ºç²å–æœ‰@Aspectè¨»è§£é¡çš„å¯¦ä¾‹å·¥å» ï¼Œè² è²¬ç²å–æœ‰@Aspectè¨»è§£é¡çš„å¯¦ä¾‹                                MetadataAwareAspectInstanceFactory factory =                                        new BeanFactoryAspectInstanceFactory(this.beanFactory, beanName);                                //å‰µå»ºåˆ‡é¢advisorå°è±¡                                List&lt;Advisor&gt; classAdvisors = this.advisorFactory.getAdvisors(factory);                                if (this.beanFactory.isSingleton(beanName)) {                                    this.advisorsCache.put(beanName, classAdvisors);                                }                                else {                                    this.aspectFactoryCache.put(beanName, factory);                                }                                advisors.addAll(classAdvisors);                            }                            else {                                MetadataAwareAspectInstanceFactory factory =                                        new PrototypeAspectInstanceFactory(this.beanFactory, beanName);                                this.aspectFactoryCache.put(beanName, factory);                                advisors.addAll(this.advisorFactory.getAdvisors(factory));                            }                        }                    }                    this.aspectBeanNames = aspectNames;                    return advisors;                }            }        }        return advisors;    }</code></pre><p>é€™å€‹æ–¹æ³•è£¡é¢é¦–å…ˆå¾IOCä¸­æ‹¿åˆ°æ‰€æœ‰Beançš„åç¨±ï¼Œä¸¦å¾ªç’°åˆ¤æ–·è©²é¡ä¸Šæ˜¯å¦å¸¶æœ‰@Aspectè¨»è§£ï¼Œå¦‚æœæœ‰å‰‡å°‡BeanNameå’ŒBeançš„Classé¡å‹å°è£åˆ°<strong>BeanFactoryAspectInstanceFactory</strong>ä¸­ï¼Œä¸¦èª¿ç”¨<strong>ReflectiveAspectJAdvisorFactory.getAdvisors</strong>å‰µå»ºåˆ‡é¢å°è±¡ï¼š</p><pre><code>    public List&lt;Advisor&gt; getAdvisors(MetadataAwareAspectInstanceFactory aspectInstanceFactory) {        //å¾å·¥å» ä¸­ç²å–æœ‰@Aspectè¨»è§£çš„é¡Class        Class&lt;?&gt; aspectClass = aspectInstanceFactory.getAspectMetadata().getAspectClass();        //å¾å·¥å» ä¸­ç²å–æœ‰@Aspectè¨»è§£çš„é¡çš„åç¨±        String aspectName = aspectInstanceFactory.getAspectMetadata().getAspectName();        validate(aspectClass);        // å‰µå»ºå·¥å» çš„è£é£¾é¡ï¼Œç²å–å¯¦ä¾‹åªæœƒç²å–ä¸€æ¬¡        MetadataAwareAspectInstanceFactory lazySingletonAspectInstanceFactory =                new LazySingletonAspectInstanceFactoryDecorator(aspectInstanceFactory);        List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();        //é€™è£¡å¾ªç’°æ²’æœ‰@Pointcutè¨»è§£çš„æ–¹æ³•        for (Method method : getAdvisorMethods(aspectClass)) {            //éå¸¸é‡è¦é‡é»çœ‹çœ‹            Advisor advisor = getAdvisor(method, lazySingletonAspectInstanceFactory, advisors.size(), aspectName);            if (advisor != null) {                advisors.add(advisor);            }        }        if (!advisors.isEmpty() &amp;&amp; lazySingletonAspectInstanceFactory.getAspectMetadata().isLazilyInstantiated()) {            Advisor instantiationAdvisor = new SyntheticInstantiationAdvisor(lazySingletonAspectInstanceFactory);            advisors.add(0, instantiationAdvisor);        }        //åˆ¤æ–·å±¬æ€§ä¸Šæ˜¯å¦æœ‰å¼•ä»‹è¨»è§£ï¼Œé€™è£¡å¯ä»¥ä¸çœ‹        for (Field field : aspectClass.getDeclaredFields()) {            //åˆ¤æ–·å±¬æ€§ä¸Šæ˜¯å¦æœ‰DeclareParentsè¨»è§£ï¼Œå¦‚æœæœ‰è¿”å›åˆ‡é¢            Advisor advisor = getDeclareParentsAdvisor(field);            if (advisor != null) {                advisors.add(advisor);            }        }        return advisors;    }    private List&lt;Method&gt; getAdvisorMethods(Class&lt;?&gt; aspectClass) {        final List&lt;Method&gt; methods = new ArrayList&lt;&gt;();        ReflectionUtils.doWithMethods(aspectClass, method -&gt; {            // Exclude pointcuts            if (AnnotationUtils.getAnnotation(method, Pointcut.class) == null) {                methods.add(method);            }        });        methods.sort(METHOD_COMPARATOR);        return methods;    }</code></pre><p>æ ¹æ“šAspectçš„Classæ‹¿åˆ°æ‰€æœ‰ä¸å¸¶@Pointcutè¨»è§£çš„æ–¹æ³•å°è±¡ï¼ˆç‚ºä»€éº¼æ˜¯ä¸å¸¶@Pointcutè¨»è§£çš„æ–¹æ³•ï¼Ÿä»”ç´°æƒ³æƒ³ä¸é›£ç†è§£ï¼‰ï¼Œå¦å¤–è¦æ³¨æ„é€™è£¡å°methodé€²è¡Œäº†æ’åºï¼Œçœ‹çœ‹é€™å€‹<strong>METHOD_COMPARATOR</strong>æ¯”è¼ƒå™¨ï¼š</p><pre><code>    private static final Comparator&lt;Method&gt; METHOD_COMPARATOR;    static {        Comparator&lt;Method&gt; adviceKindComparator = new ConvertingComparator&lt;&gt;(                new InstanceComparator&lt;&gt;(                        Around.class, Before.class, After.class, AfterReturning.class, AfterThrowing.class),                (Converter&lt;Method, Annotation&gt;) method -&gt; {                    AspectJAnnotation&lt;?&gt; annotation =                        AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(method);                    return (annotation != null ? annotation.getAnnotation() : null);                });        Comparator&lt;Method&gt; methodNameComparator = new ConvertingComparator&lt;&gt;(Method::getName);        METHOD_COMPARATOR = adviceKindComparator.thenComparing(methodNameComparator);    }</code></pre><p>é—œæ³¨<strong>InstanceComparator</strong>æ§‹é€ å‡½æ•¸åƒæ•¸ï¼Œè¨˜ä½å®ƒå€‘çš„é †åºï¼Œé€™å°±æ˜¯AOPéˆå¼èª¿ç”¨ä¸­åŒä¸€å€‹@Aspecté¡ä¸­Adviceçš„<strong>åŸ·è¡Œé †åº</strong>ã€‚æ¥è‘—å¾€ä¸‹çœ‹ï¼Œåœ¨<strong>getAdvisors</strong>æ–¹æ³•ä¸­å¾ªç’°ç²å–åˆ°çš„methodsï¼Œåˆ†åˆ¥èª¿ç”¨<strong>getAdvisor</strong>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ ¹æ“šæ–¹æ³•é€å€‹å»å‰µå»ºåˆ‡é¢ï¼š</p><pre><code>    public Advisor getAdvisor(Method candidateAdviceMethod, MetadataAwareAspectInstanceFactory aspectInstanceFactory,            int declarationOrderInAspect, String aspectName) {        validate(aspectInstanceFactory.getAspectMetadata().getAspectClass());        //ç²å–pointCutå°è±¡ï¼Œæœ€é‡è¦çš„æ˜¯å¾è¨»è§£ä¸­ç²å–è¡¨é”å¼        AspectJExpressionPointcut expressionPointcut = getPointcut(                candidateAdviceMethod, aspectInstanceFactory.getAspectMetadata().getAspectClass());        if (expressionPointcut == null) {            return null;        }        //å‰µå»ºAdvisoråˆ‡é¢é¡ï¼Œé€™æ‰æ˜¯çœŸæ­£çš„åˆ‡é¢é¡ï¼Œä¸€å€‹åˆ‡é¢é¡è£¡é¢è‚¯å®šè¦æœ‰1ã€pointCut 2ã€advice        //é€™è£¡pointCutæ˜¯expressionPointcutï¼Œ advice å¢å¼·æ–¹æ³•æ˜¯ candidateAdviceMethod        return new InstantiationModelAwarePointcutAdvisorImpl(expressionPointcut, candidateAdviceMethod,                this, aspectInstanceFactory, declarationOrderInAspect, aspectName);    }    private static final Class&lt;?&gt;[] ASPECTJ_ANNOTATION_CLASSES = new Class&lt;?&gt;[] {            Pointcut.class, Around.class, Before.class, After.class, AfterReturning.class, AfterThrowing.class};    private AspectJExpressionPointcut getPointcut(Method candidateAdviceMethod, Class&lt;?&gt; candidateAspectClass) {        //å¾å€™é¸çš„å¢å¼·æ–¹æ³•è£¡é¢ candidateAdviceMethod  æ‰¾æœ‰æœ‰è¨»è§£        //Pointcut.class, Around.class, Before.class, After.class, AfterReturning.class, AfterThrowing.class        //ä¸¦æŠŠè¨»è§£ä¿¡æ¯å°è£æˆAspectJAnnotationå°è±¡        AspectJAnnotation&lt;?&gt; aspectJAnnotation =                AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);        if (aspectJAnnotation == null) {            return null;        }        //å‰µå»ºä¸€å€‹PointCuté¡ï¼Œä¸¦ä¸”æŠŠå‰é¢å¾è¨»è§£è£¡é¢è§£æçš„è¡¨é”å¼è¨­ç½®é€²å»        AspectJExpressionPointcut ajexp =                new AspectJExpressionPointcut(candidateAspectClass, new String[0], new Class&lt;?&gt;[0]);        ajexp.setExpression(aspectJAnnotation.getPointcutExpression());        if (this.beanFactory != null) {            ajexp.setBeanFactory(this.beanFactory);        }        return ajexp;    }</code></pre><p>ä¹‹å‰å°±èªªé<strong>åˆ‡é¢</strong>çš„å®šç¾©ï¼Œæ˜¯åˆ‡é»å’Œå¢å¼·çš„çµ„åˆï¼Œæ‰€ä»¥é€™è£¡é¦–å…ˆé€šé<strong>getPointcut</strong>ç²å–åˆ°è¨»è§£å°è±¡ï¼Œç„¶å¾Œnewäº†ä¸€å€‹Pointcutå°è±¡ï¼Œä¸¦å°‡è¡¨é”å¼è¨­ç½®é€²å»ã€‚ç„¶å¾Œåœ¨<strong>getAdvisor</strong>æ–¹æ³•ä¸­æœ€å¾Œnewäº†ä¸€å€‹<strong>InstantiationModelAwarePointcutAdvisorImpl</strong>å°è±¡ï¼š</p><pre><code>    public InstantiationModelAwarePointcutAdvisorImpl(AspectJExpressionPointcut declaredPointcut,            Method aspectJAdviceMethod, AspectJAdvisorFactory aspectJAdvisorFactory,            MetadataAwareAspectInstanceFactory aspectInstanceFactory, int declarationOrder, String aspectName) {        this.declaredPointcut = declaredPointcut;        this.declaringClass = aspectJAdviceMethod.getDeclaringClass();        this.methodName = aspectJAdviceMethod.getName();        this.parameterTypes = aspectJAdviceMethod.getParameterTypes();        this.aspectJAdviceMethod = aspectJAdviceMethod;        this.aspectJAdvisorFactory = aspectJAdvisorFactory;        this.aspectInstanceFactory = aspectInstanceFactory;        this.declarationOrder = declarationOrder;        this.aspectName = aspectName;        if (aspectInstanceFactory.getAspectMetadata().isLazilyInstantiated()) {            // Static part of the pointcut is a lazy type.            Pointcut preInstantiationPointcut = Pointcuts.union(                    aspectInstanceFactory.getAspectMetadata().getPerClausePointcut(), this.declaredPointcut);            // Make it dynamic: must mutate from pre-instantiation to post-instantiation state.            // If it's not a dynamic pointcut, it may be optimized out            // by the Spring AOP infrastructure after the first evaluation.            this.pointcut = new PerTargetInstantiationModelPointcut(                    this.declaredPointcut, preInstantiationPointcut, aspectInstanceFactory);            this.lazy = true;        }        else {            // A singleton aspect.            this.pointcut = this.declaredPointcut;            this.lazy = false;            //é€™å€‹æ–¹æ³•é‡é»çœ‹çœ‹ï¼Œå‰µå»ºadviceå°è±¡            this.instantiatedAdvice = instantiateAdvice(this.declaredPointcut);        }    }</code></pre><p>é€™å€‹å°±æ˜¯æˆ‘å€‘çš„åˆ‡é¢é¡ï¼Œåœ¨å…¶æ§‹é€ æ–¹æ³•çš„æœ€å¾Œé€šé<strong>instantiateAdvice</strong>å‰µå»ºäº†<strong>Advice</strong>å°è±¡ã€‚æ³¨æ„é€™è£¡å‚³é€²ä¾†çš„<strong>declarationOrder</strong>åƒæ•¸ï¼Œå®ƒå°±æ˜¯å¾ªç’°methodæ™‚çš„åºè™Ÿï¼Œå…¶ä½œç”¨å°±æ˜¯è³¦å€¼çµ¦é€™è£¡çš„<strong>declarationOrder</strong>å±¬æ€§ä»¥åŠAdviceçš„<strong>declarationOrder</strong>å±¬æ€§ï¼Œåœ¨å¾Œé¢æ’åºæ™‚å°±æœƒé€šéé€™å€‹åºè™Ÿä¾†æ¯”è¼ƒï¼Œå› æ­¤Adviceçš„åŸ·è¡Œé †åºæ˜¯<strong>å›ºå®š</strong>çš„ï¼Œè‡³æ–¼ç‚ºä»€éº¼è¦å›ºå®šï¼Œå¾Œé¢åˆ†æå®ŒAOPéˆå¼èª¿ç”¨éç¨‹è‡ªç„¶å°±æ˜ç™½äº†ã€‚</p><pre><code>    public Advice getAdvice(Method candidateAdviceMethod, AspectJExpressionPointcut expressionPointcut,            MetadataAwareAspectInstanceFactory aspectInstanceFactory, int declarationOrder, String aspectName) {        //ç²å–æœ‰@Aspectè¨»è§£çš„é¡        Class&lt;?&gt; candidateAspectClass = aspectInstanceFactory.getAspectMetadata().getAspectClass();        validate(candidateAspectClass);        //æ‰¾åˆ°candidateAdviceMethodæ–¹æ³•ä¸Šé¢çš„è¨»è§£ï¼Œä¸¦ä¸”åŒ…è£æˆAspectJAnnotationå°è±¡ï¼Œé€™å€‹å°è±¡ä¸­å°±æœ‰è¨»è§£é¡å‹        AspectJAnnotation&lt;?&gt; aspectJAnnotation =                AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);        if (aspectJAnnotation == null) {            return null;        }        AbstractAspectJAdvice springAdvice;        //æ ¹æ“šä¸åŒçš„è¨»è§£é¡å‹å‰µå»ºä¸åŒçš„adviceé¡å¯¦ä¾‹        switch (aspectJAnnotation.getAnnotationType()) {            case AtPointcut:                if (logger.isDebugEnabled()) {                    logger.debug("Processing pointcut '" + candidateAdviceMethod.getName() + "'");                }                return null;            case AtAround:                //å¯¦ç¾äº†MethodInterceptoræ¥å£                springAdvice = new AspectJAroundAdvice(                        candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);                break;            case AtBefore:                //å¯¦ç¾äº†MethodBeforeAdviceæ¥å£ï¼Œæ²’æœ‰å¯¦ç¾MethodInterceptoræ¥å£                springAdvice = new AspectJMethodBeforeAdvice(                        candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);                break;            case AtAfter:                //å¯¦ç¾äº†MethodInterceptoræ¥å£                springAdvice = new AspectJAfterAdvice(                        candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);                break;            case AtAfterReturning:                //å¯¦ç¾äº†AfterReturningAdviceæ¥å£ï¼Œæ²’æœ‰å¯¦ç¾MethodInterceptoræ¥å£                springAdvice = new AspectJAfterReturningAdvice(                        candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);                AfterReturning afterReturningAnnotation = (AfterReturning) aspectJAnnotation.getAnnotation();                if (StringUtils.hasText(afterReturningAnnotation.returning())) {                    springAdvice.setReturningName(afterReturningAnnotation.returning());                }                break;            case AtAfterThrowing:                //å¯¦ç¾äº†MethodInterceptoræ¥å£                springAdvice = new AspectJAfterThrowingAdvice(                        candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);                AfterThrowing afterThrowingAnnotation = (AfterThrowing) aspectJAnnotation.getAnnotation();                if (StringUtils.hasText(afterThrowingAnnotation.throwing())) {                    springAdvice.setThrowingName(afterThrowingAnnotation.throwing());                }                break;            default:                throw new UnsupportedOperationException(                        "Unsupported advice type on method: " + candidateAdviceMethod);        }        // Now to configure the advice...        springAdvice.setAspectName(aspectName);        springAdvice.setDeclarationOrder(declarationOrder);        String[] argNames = this.parameterNameDiscoverer.getParameterNames(candidateAdviceMethod);        if (argNames != null) {            springAdvice.setArgumentNamesFromStringArray(argNames);        }        //è¨ˆç®—argNameså’Œé¡å‹çš„å°æ‡‰é—œä¿‚        springAdvice.calculateArgumentBindings();        return springAdvice;    }</code></pre><p>é€™è£¡é‚è¼¯å¾ˆæ¸…æ™°ï¼Œå°±æ˜¯æ‹¿åˆ°æ–¹æ³•ä¸Šçš„è¨»è§£é¡å‹ï¼Œæ ¹æ“šé¡å‹å‰µå»ºä¸åŒçš„å¢å¼·Adviceå°è±¡ï¼šAspectJAroundAdviceã€AspectJMethodBeforeAdviceã€AspectJAfterAdviceã€AspectJAfterReturningAdviceã€AspectJAfterThrowingAdviceã€‚å®Œæˆä¹‹å¾Œé€šé<strong>calculateArgumentBindings</strong>æ–¹æ³•é€²è¡Œåƒæ•¸ç¶å®šï¼Œæ„Ÿèˆˆè¶£çš„å¯è‡ªè¡Œç ”ç©¶ã€‚é€™è£¡ä¸»è¦çœ‹çœ‹å¹¾å€‹Adviceçš„ç¹¼æ‰¿é«”ç³»ï¼š</p><div class=pgc-img><img alt=é€™ä¸€æ¬¡ææ‡‚Springä»£ç†å‰µå»º+AOPéˆå¼èª¿ç”¨éç¨‹ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e1c7c82fff674a01b49573f34eb5dc1b><p class=pgc-img-caption></p></div><p>å¯ä»¥çœ‹åˆ°æœ‰å…©å€‹Adviceæ˜¯æ²’æœ‰å¯¦ç¾<strong>MethodInterceptor</strong>æ¥å£çš„ï¼šAspectJMethodBeforeAdviceå’ŒAspectJAfterReturningAdviceã€‚è€Œ<strong>MethodInterceptor</strong>æœ‰ä¸€å€‹<strong>invoke</strong>æ–¹æ³•ï¼Œé€™å€‹æ–¹æ³•å°±æ˜¯<strong>éˆå¼èª¿ç”¨</strong>çš„æ ¸å¿ƒæ–¹æ³•ï¼Œä½†é‚£å…©å€‹æ²’æœ‰å¯¦ç¾è©²æ–¹æ³•çš„Adviceæ€éº¼è™•ç†å‘¢ï¼Ÿç¨å¾Œæœƒåˆ†æã€‚åˆ°é€™è£¡åˆ‡é¢å°è±¡å°±å‰µå»ºå®Œæˆäº†ï¼Œæ¥ä¸‹ä¾†å°±æ˜¯åˆ¤æ–·ç•¶å‰å‰µå»ºçš„Beanå¯¦ä¾‹æ˜¯å¦å’Œé€™äº›åˆ‡é¢åŒ¹é…ä»¥åŠå°<strong>åˆ‡é¢</strong>æ’åºã€‚åŒ¹é…éç¨‹æ¯”è¼ƒè¤‡é›œï¼Œå°ç†è§£ä¸»æµç¨‹ä¹Ÿæ²’ä»€éº¼å¹«åŠ©ï¼Œæ‰€ä»¥é€™è£¡å°±ä¸å±•é–‹åˆ†æï¼Œæ„Ÿèˆˆè¶£çš„è‡ªè¡Œåˆ†æï¼ˆAbstractAdvisorAutoProxyCreator.findAdvisorsThatCanApply()ï¼‰ã€‚ä¸‹é¢çœ‹çœ‹æ’åºçš„éç¨‹ï¼Œå›åˆ°AbstractAdvisorAutoProxyCreator.findEligibleAdvisorsæ–¹æ³•ï¼š</p><pre><code>    protected List&lt;Advisor&gt; findEligibleAdvisors(Class&lt;?&gt; beanClass, String beanName) {        //æ‰¾åˆ°å€™é¸çš„åˆ‡é¢,å…¶å¯¦å°±æ˜¯ä¸€å€‹å°‹æ‰¾æœ‰@Aspectjè¨»è§£çš„éç¨‹ï¼ŒæŠŠå·¥ç¨‹ä¸­æ‰€æœ‰æœ‰é€™å€‹è¨»è§£çš„é¡å°è£æˆAdvisorè¿”å›        List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();        //åˆ¤æ–·å€™é¸çš„åˆ‡é¢æ˜¯å¦ä½œç”¨åœ¨ç•¶å‰beanClassä¸Šé¢ï¼Œå°±æ˜¯ä¸€å€‹åŒ¹é…éç¨‹ã€‚ã€‚ç¾åœ¨å°±æ˜¯ä¸€å€‹åŒ¹é…        List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);        extendAdvisors(eligibleAdvisors);        if (!eligibleAdvisors.isEmpty()) {            //å°æœ‰@Order@Priorityé€²è¡Œæ’åº            eligibleAdvisors = sortAdvisors(eligibleAdvisors);        }        return eligibleAdvisors;    }</code></pre><p><strong>sortAdvisors</strong>æ–¹æ³•å°±æ˜¯æ’åºï¼Œä½†é€™å€‹æ–¹æ³•æœ‰å…©å€‹å¯¦ç¾ï¼šç•¶å‰é¡<strong>AbstractAdvisorAutoProxyCreator</strong>å’Œå­é¡<strong>AspectJAwareAdvisorAutoProxyCreator</strong>ï¼Œæ‡‰è©²èµ°å“ªå€‹å‘¢ï¼Ÿ</p><div class=pgc-img><img alt=é€™ä¸€æ¬¡ææ‡‚Springä»£ç†å‰µå»º+AOPéˆå¼èª¿ç”¨éç¨‹ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/419537d02465492990aed14903ddda42><p class=pgc-img-caption></p></div><p>é€šéé¡åœ–æˆ‘å€‘å¯ä»¥è‚¯å®šæ˜¯é€²å…¥çš„<strong>AspectJAwareAdvisorAutoProxyCreator</strong>é¡ï¼Œå› ç‚º<strong>AnnotationAwareAspectJAutoProxyCreator</strong>çš„çˆ¶é¡æ˜¯å®ƒã€‚</p><pre><code>    protected List&lt;Advisor&gt; sortAdvisors(List&lt;Advisor&gt; advisors) {        List&lt;PartiallyComparableAdvisorHolder&gt; partiallyComparableAdvisors = new ArrayList&lt;&gt;(advisors.size());        for (Advisor element : advisors) {            partiallyComparableAdvisors.add(                    new PartiallyComparableAdvisorHolder(element, DEFAULT_PRECEDENCE_COMPARATOR));        }        List&lt;PartiallyComparableAdvisorHolder&gt; sorted = PartialOrder.sort(partiallyComparableAdvisors);        if (sorted != null) {            List&lt;Advisor&gt; result = new ArrayList&lt;&gt;(advisors.size());            for (PartiallyComparableAdvisorHolder pcAdvisor : sorted) {                result.add(pcAdvisor.getAdvisor());            }            return result;        }        else {            return super.sortAdvisors(advisors);        }    }</code></pre><p>é€™è£¡æ’åºä¸»è¦æ˜¯å§”è¨—çµ¦<strong>PartialOrder</strong>é€²è¡Œçš„ï¼Œè€Œåœ¨æ­¤ä¹‹å‰å°‡æ‰€æœ‰çš„åˆ‡é¢éƒ½å°è£æˆäº†<strong>PartiallyComparableAdvisorHolder</strong>å°è±¡ï¼Œæ³¨æ„å‚³å…¥çš„<strong>DEFAULT_PRECEDENCE_COMPARATOR</strong>åƒæ•¸ï¼Œé€™å€‹å°±æ˜¯æ¯”è¼ƒå™¨å°è±¡ï¼š</p><pre><code>    private static final Comparator&lt;Advisor&gt; DEFAULT_PRECEDENCE_COMPARATOR = new AspectJPrecedenceComparator();</code></pre><p>æ‰€ä»¥æˆ‘å€‘ç›´æ¥çœ‹é€™å€‹æ¯”è¼ƒå™¨çš„<strong>compare</strong>æ–¹æ³•ï¼š</p><pre><code>    public int compare(Advisor o1, Advisor o2) {        int advisorPrecedence = this.advisorComparator.compare(o1, o2);        if (advisorPrecedence == SAME_PRECEDENCE &amp;&amp; declaredInSameAspect(o1, o2)) {            advisorPrecedence = comparePrecedenceWithinAspect(o1, o2);        }        return advisorPrecedence;    }    private final Comparator&lt;? super Advisor&gt; advisorComparator;    public AspectJPrecedenceComparator() {        this.advisorComparator = AnnotationAwareOrderComparator.INSTANCE;    }</code></pre><p>ç¬¬ä¸€æ­¥å…ˆé€šé<strong>AnnotationAwareOrderComparator</strong>å»æ¯”è¼ƒï¼Œé»é€²å»çœ‹å¯ä»¥ç™¼ç¾æ˜¯å°å¯¦ç¾äº†<strong>PriorityOrdered</strong>å’Œ<strong>Ordered</strong>æ¥å£ä»¥åŠæ¨™è¨˜äº†<strong>Priority</strong>å’Œ<strong>Order</strong>è¨»è§£çš„<strong>éåŒä¸€å€‹@Aspecté¡ä¸­çš„åˆ‡é¢</strong>é€²è¡Œæ’åºã€‚é€™å€‹å’Œä¹‹å‰åˆ†æ<strong>BeanFacotryPostProcessor</strong>é¡æ˜¯ä¸€æ¨£çš„åŸç†ã€‚è€Œå°<strong>åŒä¸€å€‹@Aspecté¡ä¸­çš„åˆ‡é¢</strong>æ’åºä¸»è¦æ˜¯<strong>comparePrecedenceWithinAspect</strong>æ–¹æ³•ï¼š</p><pre><code>    private int comparePrecedenceWithinAspect(Advisor advisor1, Advisor advisor2) {        boolean oneOrOtherIsAfterAdvice =                (AspectJAopUtils.isAfterAdvice(advisor1) || AspectJAopUtils.isAfterAdvice(advisor2));        int adviceDeclarationOrderDelta = getAspectDeclarationOrder(advisor1) - getAspectDeclarationOrder(advisor2);        if (oneOrOtherIsAfterAdvice) {            // the advice declared last has higher precedence            if (adviceDeclarationOrderDelta &lt; 0) {                // advice1 was declared before advice2                // so advice1 has lower precedence                return LOWER_PRECEDENCE;            }            else if (adviceDeclarationOrderDelta == 0) {                return SAME_PRECEDENCE;            }            else {                return HIGHER_PRECEDENCE;            }        }        else {            // the advice declared first has higher precedence            if (adviceDeclarationOrderDelta &lt; 0) {                // advice1 was declared before advice2                // so advice1 has higher precedence                return HIGHER_PRECEDENCE;            }            else if (adviceDeclarationOrderDelta == 0) {                return SAME_PRECEDENCE;            }            else {                return LOWER_PRECEDENCE;            }        }    }    private int getAspectDeclarationOrder(Advisor anAdvisor) {        AspectJPrecedenceInformation precedenceInfo =            AspectJAopUtils.getAspectJPrecedenceInformationFor(anAdvisor);        if (precedenceInfo != null) {            return precedenceInfo.getDeclarationOrder();        }        else {            return 0;        }    }</code></pre><p>é€™è£¡å°±æ˜¯é€šé<strong>precedenceInfo.getDeclarationOrder</strong>æ‹¿åˆ°åœ¨å‰µå»º<strong>InstantiationModelAwarePointcutAdvisorImpl</strong>å°è±¡æ™‚è¨­ç½®çš„<strong>declarationOrder</strong>å±¬æ€§ï¼Œé€™å°±é©—è­‰äº†ä¹‹å‰çš„èªªæ³•ï¼ˆå¯¦éš›ä¸Šé€™è£¡æ’åºéç¨‹éå¸¸è¤‡é›œï¼Œä¸æ˜¯ç°¡å–®çš„æŒ‰ç…§é€™å€‹å±¬æ€§é€²è¡Œæ’åºï¼‰ã€‚ç•¶ä¸Šé¢çš„ä¸€åˆ‡éƒ½é€²è¡Œå®Œæˆå¾Œï¼Œå°±è©²å‰µå»ºä»£ç†å°è±¡äº†ï¼Œå›åˆ°<strong>AbstractAutoProxyCreator.wrapIfNecessary</strong>ï¼Œçœ‹é—œéµéƒ¨åˆ†ä»£ç¢¼ï¼š</p><pre><code>    //å¦‚æœæœ‰åˆ‡é¢ï¼Œå‰‡ç”Ÿæˆè©²beançš„ä»£ç†    if (specificInterceptors != DO_NOT_PROXY) {        this.advisedBeans.put(cacheKey, Boolean.TRUE);        //æŠŠè¢«ä»£ç†å°è±¡beanå¯¦ä¾‹å°è£åˆ°SingletonTargetSourceå°è±¡ä¸­        Object proxy = createProxy(                bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));        this.proxyTypes.put(cacheKey, proxy.getClass());        return proxy;    }</code></pre><p>æ³¨æ„é€™è£¡å°‡è¢«ä»£ç†å°è±¡å°è£æˆäº†ä¸€å€‹<strong>SingletonTargetSource</strong>å°è±¡ï¼Œå®ƒæ˜¯<strong>TargetSource</strong>çš„å¯¦ç¾é¡ã€‚</p><pre><code>    protected Object createProxy(Class&lt;?&gt; beanClass, @Nullable String beanName,            @Nullable Object[] specificInterceptors, TargetSource targetSource) {        if (this.beanFactory instanceof ConfigurableListableBeanFactory) {            AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) this.beanFactory, beanName, beanClass);        }        //å‰µå»ºä»£ç†å·¥å»         ProxyFactory proxyFactory = new ProxyFactory();        proxyFactory.copyFrom(this);        if (!proxyFactory.isProxyTargetClass()) {            if (shouldProxyTargetClass(beanClass, beanName)) {                //proxyTargetClass æ˜¯å¦å°é¡é€²è¡Œä»£ç†ï¼Œè€Œä¸æ˜¯å°æ¥å£é€²è¡Œä»£ç†ï¼Œè¨­ç½®ç‚ºtrueæ™‚ï¼Œä½¿ç”¨CGLibä»£ç†ã€‚                proxyFactory.setProxyTargetClass(true);            }            else {                evaluateProxyInterfaces(beanClass, proxyFactory);            }        }        //æŠŠadviceé¡å‹çš„å¢å¼·åŒ…è£æˆadvisoråˆ‡é¢        Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);        proxyFactory.addAdvisors(advisors);        proxyFactory.setTargetSource(targetSource);        customizeProxyFactory(proxyFactory);        ////ç”¨ä¾†æ§åˆ¶ä»£ç†å·¥å» è¢«é…ç½®å¾Œï¼Œæ˜¯å¦é‚„å…è¨±ä¿®æ”¹ä»£ç†çš„é…ç½®,é»˜èªç‚ºfalse        proxyFactory.setFrozen(this.freezeProxy);        if (advisorsPreFiltered()) {            proxyFactory.setPreFiltered(true);        }        //ç²å–ä»£ç†å¯¦ä¾‹        return proxyFactory.getProxy(getProxyClassLoader());    }</code></pre><p>é€™è£¡é€šé<strong>ProxyFactory</strong>å°è±¡å»å‰µå»ºä»£ç†å¯¦ä¾‹ï¼Œé€™æ˜¯<strong>å·¥å» æ¨¡å¼</strong>çš„é«”ç¾ï¼Œä½†åœ¨å‰µå»ºä»£ç†å°è±¡ä¹‹å‰é‚„æœ‰å¹¾å€‹æº–å‚™å‹•ä½œï¼šéœ€è¦åˆ¤æ–·æ˜¯JDKä»£ç†é‚„æ˜¯CGLIBä»£ç†ä»¥åŠé€šé<strong>buildAdvisors</strong>æ–¹æ³•å°‡æ“´å±•çš„<strong>Advice</strong>å°è£æˆ<strong>Advisor</strong>åˆ‡é¢ã€‚æº–å‚™å®Œæˆå‰‡é€šé<strong>getProxy</strong>å‰µå»ºä»£ç†å°è±¡ï¼š</p><pre><code>    public Object getProxy(@Nullable ClassLoader classLoader) {        //æ ¹æ“šç›®æ¨™å°è±¡æ˜¯å¦æœ‰æ¥å£ä¾†åˆ¤æ–·æ¡ç”¨ä»€éº¼ä»£ç†æ–¹å¼ï¼Œcglibä»£ç†é‚„æ˜¯jdkå‹•æ…‹ä»£ç†        return createAopProxy().getProxy(classLoader);    }    protected final synchronized AopProxy createAopProxy() {        if (!this.active) {            activate();        }        return getAopProxyFactory().createAopProxy(this);    }    public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException {        if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) {            Class&lt;?&gt; targetClass = config.getTargetClass();            if (targetClass == null) {                throw new AopConfigException("TargetSource cannot determine target class: " +                        "Either an interface or a target is required for proxy creation.");            }            if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) {                return new JdkDynamicAopProxy(config);            }            return new ObjenesisCglibAopProxy(config);        }        else {            return new JdkDynamicAopProxy(config);        }    }</code></pre><p>é¦–å…ˆé€šéé…ç½®æ‹¿åˆ°å°æ‡‰çš„ä»£ç†é¡ï¼šObjenesisCglibAopProxyå’ŒJdkDynamicAopProxyï¼Œç„¶å¾Œå†é€šé<strong>getProxy</strong>å‰µå»ºBeançš„ä»£ç†ï¼Œé€™è£¡ä»¥<strong>JdkDynamicAopProxy</strong>ç‚ºä¾‹ï¼š</p><pre><code>    public Object getProxy(@Nullable ClassLoader classLoader) {        //advisedæ˜¯ä»£ç†å·¥å» å°è±¡        Class&lt;?&gt;[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(this.advised, true);        findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);        return Proxy.newProxyInstance(classLoader, proxiedInterfaces, this);    }</code></pre><p>é€™è£¡çš„ä»£ç¢¼ä½ æ‡‰è©²ä¸é™Œç”Ÿäº†ï¼Œå°±æ˜¯JDKçš„åŸç”ŸAPIï¼Œ<strong>newProxyInstance</strong>æ–¹æ³•å‚³å…¥çš„<strong>InvocationHandler</strong>å°è±¡æ˜¯<strong>this</strong>ï¼Œå› æ­¤ï¼Œæœ€çµ‚AOPä»£ç†çš„èª¿ç”¨å°±æ˜¯å¾è©²é¡ä¸­çš„<strong>invoke</strong>æ–¹æ³•é–‹å§‹ã€‚è‡³æ­¤ï¼Œä»£ç†å°è±¡çš„å‰µå»ºå°±å®Œæˆäº†ï¼Œä¸‹é¢ä¾†çœ‹ä¸‹æ•´å€‹éç¨‹çš„æ™‚åºåœ–ï¼š</p><div class=pgc-img><img alt=é€™ä¸€æ¬¡ææ‡‚Springä»£ç†å‰µå»º+AOPéˆå¼èª¿ç”¨éç¨‹ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/692f7c1d1455426a8f4b2c6d119f7d0c><p class=pgc-img-caption></p></div><h2 class=line>å°çµ</h2><p>ä»£ç†å°è±¡çš„å‰µå»ºéç¨‹æ•´é«”ä¾†èªªä¸¦ä¸è¤‡é›œï¼Œé¦–å…ˆæ‰¾åˆ°æ‰€æœ‰å¸¶æœ‰@Aspectè¨»è§£çš„é¡ï¼Œä¸¦ç²å–å…¶ä¸­æ²’æœ‰@Pointcutè¨»è§£çš„æ–¹æ³•ï¼Œå¾ªç’°å‰µå»ºåˆ‡é¢ï¼Œè€Œå‰µå»ºåˆ‡é¢éœ€è¦<strong>åˆ‡é»</strong>å’Œ<strong>å¢å¼·</strong>å…©å€‹å…ƒç´ ï¼Œå…¶ä¸­åˆ‡é»å¯ç°¡å–®ç†è§£ç‚ºæˆ‘å€‘å¯«çš„è¡¨é”å¼ï¼Œå¢å¼·å‰‡æ˜¯æ ¹æ“š@Beforeã€@Aroundã€@Afterç­‰è¨»è§£å‰µå»ºçš„å°æ‡‰çš„Adviceé¡ã€‚åˆ‡é¢å‰µå»ºå¥½å¾Œå‰‡éœ€è¦å¾ªç’°åˆ¤æ–·å“ªäº›åˆ‡é¢èƒ½å°ç•¶å‰çš„Beanå¯¦ä¾‹çš„æ–¹æ³•é€²è¡Œå¢å¼·ä¸¦æ’åºï¼Œæœ€å¾Œé€šéProxyFactoryå‰µå»ºä»£ç†å°è±¡ã€‚</p><h2 class=line>AOPéˆå¼èª¿ç”¨</h2><p>ç†Ÿæ‚‰JDKå‹•æ…‹ä»£ç†çš„éƒ½çŸ¥é“é€šéä»£ç†å°è±¡èª¿ç”¨æ–¹æ³•æ™‚ï¼Œæœƒé€²å…¥åˆ°<strong>InvocationHandler</strong>å°è±¡çš„<strong>invoke</strong>æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘å€‘ç›´æ¥å¾<strong>JdkDynamicAopProxy</strong>çš„é€™å€‹æ–¹æ³•é–‹å§‹ï¼š</p><pre><code>    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {        MethodInvocation invocation;        Object oldProxy = null;        boolean setProxyContext = false;        //å¾ä»£ç†å·¥å» ä¸­æ‹¿åˆ°TargetSourceå°è±¡ï¼Œè©²å°è±¡åŒ…è£äº†è¢«ä»£ç†å¯¦ä¾‹bean        TargetSource targetSource = this.advised.targetSource;        Object target = null;        try {            //è¢«ä»£ç†å°è±¡çš„equalsæ–¹æ³•å’ŒhashCodeæ–¹æ³•æ˜¯ä¸èƒ½è¢«ä»£ç†çš„ï¼Œä¸æœƒèµ°åˆ‡é¢            .......            Object retVal;            // å¯ä»¥å¾ç•¶å‰ç·šç¨‹ä¸­æ‹¿åˆ°ä»£ç†å°è±¡            if (this.advised.exposeProxy) {                // Make invocation available if necessary.                oldProxy = AopContext.setCurrentProxy(proxy);                setProxyContext = true;            }            //é€™å€‹targetå°±æ˜¯è¢«ä»£ç†å¯¦ä¾‹            target = targetSource.getTarget();            Class&lt;?&gt; targetClass = (target != null ? target.getClass() : null);            //å¾ä»£ç†å·¥å» ä¸­æ‹¿éæ¿¾å™¨éˆ Objectæ˜¯ä¸€å€‹MethodInterceptoré¡å‹çš„å°è±¡ï¼Œå…¶å¯¦å°±æ˜¯ä¸€å€‹adviceå°è±¡            List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);            //å¦‚æœè©²æ–¹æ³•æ²’æœ‰åŸ·è¡Œéˆï¼Œå‰‡èªªæ˜é€™å€‹æ–¹æ³•ä¸éœ€è¦è¢«æ””æˆªï¼Œå‰‡ç›´æ¥åå°„èª¿ç”¨            if (chain.isEmpty()) {                Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);                retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);            }            else {                invocation = new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);                retVal = invocation.proceed();            }            // Massage return value if necessary.            Class&lt;?&gt; returnType = method.getReturnType();            if (retVal != null &amp;&amp; retVal == target &amp;&amp;                    returnType != Object.class &amp;&amp; returnType.isInstance(proxy) &amp;&amp;                    !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) {                retVal = proxy;            }            return retVal;        }        finally {            if (target != null &amp;&amp; !targetSource.isStatic()) {                // Must have come from TargetSource.                targetSource.releaseTarget(target);            }            if (setProxyContext) {                // Restore old proxy.                AopContext.setCurrentProxy(oldProxy);            }        }    }</code></pre><p>é€™æ®µä»£ç¢¼æ¯”è¼ƒé•·ï¼Œæˆ‘åˆªæ‰äº†ä¸é—œéµçš„åœ°æ–¹ã€‚é¦–å…ˆä¾†çœ‹<strong>this.advised.exposeProxy</strong>é€™å€‹å±¬æ€§ï¼Œé€™åœ¨@EnableAspectJAutoProxyè¨»è§£ä¸­å¯ä»¥é…ç½®ï¼Œç•¶ç‚ºtrueæ™‚ï¼Œæœƒå°‡è©²ä»£ç†å°è±¡è¨­ç½®åˆ°<strong>ç•¶å‰ç·šç¨‹çš„ThreadLocalå°è±¡</strong>ä¸­ï¼Œé€™æ¨£å°±å¯ä»¥é€šé<strong>AopContext.currentProxy</strong>æ‹¿åˆ°ä»£ç†å°è±¡ã€‚é€™å€‹æœ‰ä»€éº¼ç”¨å‘¢ï¼Ÿæˆ‘ç›¸ä¿¡æœ‰ç¶“é©—çš„Javaé–‹ç™¼éƒ½é‡åˆ°éé€™æ¨£ä¸€å€‹BUGï¼Œåœ¨Serviceå¯¦ç¾é¡ä¸­èª¿ç”¨æœ¬é¡ä¸­çš„å¦ä¸€å€‹æ–¹æ³•æ™‚ï¼Œäº‹å‹™ä¸æœƒç”Ÿæ•ˆï¼Œé€™æ˜¯å› ç‚ºç›´æ¥é€šéthisèª¿ç”¨å°±ä¸æœƒèª¿ç”¨åˆ°ä»£ç†å°è±¡çš„æ–¹æ³•ï¼Œè€Œæ˜¯åŸå°è±¡çš„ï¼Œæ‰€ä»¥äº‹å‹™åˆ‡é¢å°±æ²’æœ‰ç”Ÿæ•ˆã€‚å› æ­¤é€™ç¨®æƒ…æ³ä¸‹å°±å¯ä»¥å¾<strong>ç•¶å‰ç·šç¨‹çš„ThreadLocalå°è±¡</strong>æ‹¿åˆ°ä»£ç†å°è±¡ï¼Œä¸éå¯¦éš›ä¸Šç›´æ¥ä½¿ç”¨@Autowiredæ³¨å…¥è‡ªå·±æœ¬èº«ä¹Ÿå¯ä»¥æ‹¿åˆ°ä»£ç†å°è±¡ã€‚æ¥ä¸‹ä¾†å°±æ˜¯é€šé<strong>getInterceptorsAndDynamicInterceptionAdvice</strong>æ‹¿åˆ°åŸ·è¡Œéˆï¼Œçœ‹çœ‹å…·é«”åšäº†å“ªäº›äº‹æƒ…ï¼š</p><pre><code>    public List&lt;Object&gt; getInterceptorsAndDynamicInterceptionAdvice(            Advised config, Method method, @Nullable Class&lt;?&gt; targetClass) {        AdvisorAdapterRegistry registry = GlobalAdvisorAdapterRegistry.getInstance();        //å¾ä»£ç†å·¥å» ä¸­ç²å¾—è©²è¢«ä»£ç†é¡çš„æ‰€æœ‰åˆ‡é¢advisorï¼Œconfigå°±æ˜¯ä»£ç†å·¥å» å°è±¡        Advisor[] advisors = config.getAdvisors();        List&lt;Object&gt; interceptorList = new ArrayList&lt;&gt;(advisors.length);        Class&lt;?&gt; actualClass = (targetClass != null ? targetClass : method.getDeclaringClass());        Boolean hasIntroductions = null;        for (Advisor advisor : advisors) {            //å¤§éƒ¨åˆ†èµ°é€™è£¡            if (advisor instanceof PointcutAdvisor) {                // Add it conditionally.                PointcutAdvisor pointcutAdvisor = (PointcutAdvisor) advisor;                //å¦‚æœåˆ‡é¢çš„pointCutå’Œè¢«ä»£ç†å°è±¡æ˜¯åŒ¹é…çš„ï¼Œèªªæ˜æ˜¯åˆ‡é¢è¦æ””æˆªçš„å°è±¡                if (config.isPreFiltered() || pointcutAdvisor.getPointcut().getClassFilter().matches(actualClass)) {                    MethodMatcher mm = pointcutAdvisor.getPointcut().getMethodMatcher();                    boolean match;                    if (mm instanceof IntroductionAwareMethodMatcher) {                        if (hasIntroductions == null) {                            hasIntroductions = hasMatchingIntroductions(advisors, actualClass);                        }                        match = ((IntroductionAwareMethodMatcher) mm).matches(method, actualClass, hasIntroductions);                    }                    else {                        //æ¥ä¸‹ä¾†åˆ¤æ–·æ–¹æ³•æ˜¯å¦æ˜¯åˆ‡é¢pointcutéœ€è¦æ””æˆªçš„æ–¹æ³•                        match = mm.matches(method, actualClass);                    }                    //å¦‚æœé¡å’Œæ–¹æ³•éƒ½åŒ¹é…                    if (match) {                        //ç²å–åˆ°åˆ‡é¢advisorä¸­çš„adviceï¼Œä¸¦ä¸”åŒ…è£æˆMethodInterceptoré¡å‹çš„å°è±¡                        MethodInterceptor[] interceptors = registry.getInterceptors(advisor);                        if (mm.isRuntime()) {                            for (MethodInterceptor interceptor : interceptors) {                                interceptorList.add(new InterceptorAndDynamicMethodMatcher(interceptor, mm));                            }                        }                        else {                            interceptorList.addAll(Arrays.asList(interceptors));                        }                    }                }            }            //å¦‚æœæ˜¯å¼•ä»‹åˆ‡é¢            else if (advisor instanceof IntroductionAdvisor) {                IntroductionAdvisor ia = (IntroductionAdvisor) advisor;                if (config.isPreFiltered() || ia.getClassFilter().matches(actualClass)) {                    Interceptor[] interceptors = registry.getInterceptors(advisor);                    interceptorList.addAll(Arrays.asList(interceptors));                }            }            else {                Interceptor[] interceptors = registry.getInterceptors(advisor);                interceptorList.addAll(Arrays.asList(interceptors));            }        }        return interceptorList;    }</code></pre><p>é€™ä¹Ÿæ˜¯å€‹é•·æ–¹æ³•ï¼Œçœ‹é—œéµçš„éƒ¨åˆ†ï¼Œå› ç‚ºä¹‹å‰æˆ‘å€‘å‰µå»ºçš„åŸºæœ¬ä¸Šéƒ½æ˜¯<strong>InstantiationModelAwarePointcutAdvisorImpl</strong>å°è±¡ï¼Œè©²é¡æ˜¯<strong>PointcutAdvisor</strong>çš„å¯¦ç¾é¡ï¼Œæ‰€ä»¥æœƒé€²å…¥ç¬¬ä¸€å€‹ifåˆ¤æ–·è£¡ï¼Œé€™è£¡é¦–å…ˆé€²è¡ŒåŒ¹é…ï¼Œçœ‹<strong>åˆ‡é»</strong>å’Œ<strong>ç•¶å‰å°è±¡</strong>ä»¥åŠè©²å°è±¡çš„å“ªäº›<strong>æ–¹æ³•</strong>åŒ¹é…ï¼Œå¦‚æœèƒ½åŒ¹é…ä¸Šï¼Œå‰‡èª¿ç”¨<strong>getInterceptors</strong>ç²å–åŸ·è¡Œéˆï¼š</p><pre><code>    private final List&lt;AdvisorAdapter&gt; adapters = new ArrayList&lt;&gt;(3);    public DefaultAdvisorAdapterRegistry() {        registerAdvisorAdapter(new MethodBeforeAdviceAdapter());        registerAdvisorAdapter(new AfterReturningAdviceAdapter());        registerAdvisorAdapter(new ThrowsAdviceAdapter());    }    public MethodInterceptor[] getInterceptors(Advisor advisor) throws UnknownAdviceTypeException {        List&lt;MethodInterceptor&gt; interceptors = new ArrayList&lt;&gt;(3);        Advice advice = advisor.getAdvice();        //å¦‚æœæ˜¯MethodInterceptoré¡å‹çš„ï¼Œå¦‚ï¼šAspectJAroundAdvice        //AspectJAfterAdvice        //AspectJAfterThrowingAdvice        if (advice instanceof MethodInterceptor) {            interceptors.add((MethodInterceptor) advice);        }        //è™•ç† AspectJMethodBeforeAdvice  AspectJAfterReturningAdvice        for (AdvisorAdapter adapter : this.adapters) {            if (adapter.supportsAdvice(advice)) {                interceptors.add(adapter.getInterceptor(advisor));            }        }        if (interceptors.isEmpty()) {            throw new UnknownAdviceTypeException(advisor.getAdvice());        }        return interceptors.toArray(new MethodInterceptor[0]);    }</code></pre><p>é€™è£¡æˆ‘å€‘å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯<strong>MethodInterceptor</strong>çš„å¯¦ç¾é¡ï¼Œå‰‡ç›´æ¥æ·»åŠ åˆ°éˆä¸­ï¼Œå¦‚æœä¸æ˜¯ï¼Œå‰‡éœ€è¦é€šé<strong>é©é…å™¨</strong>å»åŒ…è£å¾Œæ·»åŠ ï¼Œå‰›å¥½é€™è£¡æœ‰<strong>MethodBeforeAdviceAdapter</strong>å’Œ<strong>AfterReturningAdviceAdapter</strong>å…©å€‹é©é…å™¨å°æ‡‰ä¸Šæ–‡å…©å€‹æ²’æœ‰å¯¦ç¾<strong>MethodInterceptor</strong>æ¥å£çš„é¡ã€‚æœ€å¾Œå°‡<strong>Interceptors</strong>è¿”å›ã€‚</p><pre><code>if (chain.isEmpty()) {    Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);    retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);}else {    // We need to create a method invocation...    invocation = new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);    // Proceed to the joinpoint through the interceptor chain.    retVal = invocation.proceed();}</code></pre><p>è¿”å›åˆ°<strong>invoke</strong>æ–¹æ³•å¾Œï¼Œå¦‚æœåŸ·è¡Œéˆç‚ºç©ºï¼Œèªªæ˜è©²æ–¹æ³•ä¸éœ€è¦è¢«å¢å¼·ï¼Œæ‰€ä»¥ç›´æ¥åå°„èª¿ç”¨åŸå°è±¡çš„æ–¹æ³•ï¼ˆæ³¨æ„å‚³å…¥çš„æ˜¯TargetSourceå°è£çš„è¢«ä»£ç†å°è±¡ï¼‰ï¼›åä¹‹ï¼Œå‰‡é€šé<strong>ReflectiveMethodInvocation</strong>é¡é€²è¡Œéˆå¼èª¿ç”¨ï¼Œé—œéµæ–¹æ³•å°±æ˜¯<strong>proceed</strong>ï¼š</p><pre><code>    private int currentInterceptorIndex = -1;    public Object proceed() throws Throwable {        //å¦‚æœåŸ·è¡Œéˆä¸­çš„adviceå…¨éƒ¨åŸ·è¡Œå®Œï¼Œå‰‡ç›´æ¥èª¿ç”¨joinPointæ–¹æ³•ï¼Œå°±æ˜¯è¢«ä»£ç†æ–¹æ³•        if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) {            return invokeJoinpoint();        }        Object interceptorOrInterceptionAdvice =                this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);        if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) {            InterceptorAndDynamicMethodMatcher dm =                    (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;            Class&lt;?&gt; targetClass = (this.targetClass != null ? this.targetClass : this.method.getDeclaringClass());            if (dm.methodMatcher.matches(this.method, targetClass, this.arguments)) {                return dm.interceptor.invoke(this);            }            else {                return proceed();            }        }        else {            //èª¿ç”¨MethodInterceptorä¸­çš„invokeæ–¹æ³•            return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this);        }    }</code></pre><p>é€™å€‹æ–¹æ³•çš„æ ¸å¿ƒå°±åœ¨å…©å€‹åœ°æ–¹ï¼š<strong>invokeJoinpoint</strong>å’Œ<strong>interceptorOrInterceptionAdvice.invoke(this)</strong>ã€‚ç•¶å¢å¼·æ–¹æ³•èª¿ç”¨å®Œå¾Œå°±æœƒé€šéå‰è€…èª¿ç”¨åˆ°è¢«ä»£ç†çš„æ–¹æ³•ï¼Œå¦å‰‡å‰‡æ˜¯ä¾æ¬¡èª¿ç”¨<strong>Interceptor</strong>çš„<strong>invoke</strong>æ–¹æ³•ã€‚ä¸‹é¢å°±åˆ†åˆ¥çœ‹çœ‹æ¯å€‹<strong>Interceptor</strong>æ˜¯æ€éº¼å¯¦ç¾çš„ã€‚</p><ul><li>AspectJAroundAdvice</li></ul><pre><code>    public Object invoke(MethodInvocation mi) throws Throwable {        if (!(mi instanceof ProxyMethodInvocation)) {            throw new IllegalStateException("MethodInvocation is not a Spring ProxyMethodInvocation: " + mi);        }        ProxyMethodInvocation pmi = (ProxyMethodInvocation) mi;        ProceedingJoinPoint pjp = lazyGetProceedingJoinPoint(pmi);        JoinPointMatch jpm = getJoinPointMatch(pmi);        return invokeAdviceMethod(pjp, jpm, null, null);    }</code></pre><ul><li>MethodBeforeAdviceInterceptor -> AspectJMethodBeforeAdvice</li></ul><pre><code>    public Object invoke(MethodInvocation mi) throws Throwable {        this.advice.before(mi.getMethod(), mi.getArguments(), mi.getThis());        return mi.proceed();    }    public void before(Method method, Object[] args, @Nullable Object target) throws Throwable {        invokeAdviceMethod(getJoinPointMatch(), null, null);    }</code></pre><ul><li>AspectJAfterAdvice</li></ul><pre><code>    public Object invoke(MethodInvocation mi) throws Throwable {        try {            return mi.proceed();        }        finally {            invokeAdviceMethod(getJoinPointMatch(), null, null);        }    }</code></pre><ul><li>AfterReturningAdviceInterceptor -> AspectJAfterReturningAdvice</li></ul><pre><code>    public Object invoke(MethodInvocation mi) throws Throwable {        Object retVal = mi.proceed();        this.advice.afterReturning(retVal, mi.getMethod(), mi.getArguments(), mi.getThis());        return retVal;    }    public void afterReturning(@Nullable Object returnValue, Method method, Object[] args, @Nullable Object target) throws Throwable {        if (shouldInvokeOnReturnValueOf(method, returnValue)) {            invokeAdviceMethod(getJoinPointMatch(), returnValue, null);        }    }</code></pre><ul><li>AspectJAfterThrowingAdvice</li></ul><pre><code>    public Object invoke(MethodInvocation mi) throws Throwable {        try {            return mi.proceed();        }        catch (Throwable ex) {            if (shouldInvokeOnThrowing(ex)) {                invokeAdviceMethod(getJoinPointMatch(), null, ex);            }            throw ex;        }    }</code></pre><p>é€™è£¡çš„èª¿ç”¨é †åºæ˜¯æ€æ¨£çš„å‘¢ï¼Ÿå…¶æ ¸å¿ƒå°±æ˜¯é€šé<strong>proceed</strong>æ–¹æ³•æ§åˆ¶æµç¨‹ï¼Œæ¯åŸ·è¡Œå®Œä¸€å€‹Adviceå°±æœƒå›åˆ°<strong>proceed</strong>æ–¹æ³•ä¸­èª¿ç”¨ä¸‹ä¸€å€‹Adviceã€‚å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œæ€éº¼æ‰èƒ½è®“èª¿ç”¨çµæœæ»¿è¶³å¦‚ä¸‹åœ–çš„<strong>åŸ·è¡Œé †åº</strong>ã€‚</p><div class=pgc-img><img alt=é€™ä¸€æ¬¡ææ‡‚Springä»£ç†å‰µå»º+AOPéˆå¼èª¿ç”¨éç¨‹ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b56c9dee30924620b3ed4175efd82096><p class=pgc-img-caption></p></div><p><br></p><p>ä»¥ä¸Šå°±æ˜¯AOPçš„éˆå¼èª¿ç”¨éç¨‹ï¼Œä½†æ˜¯é€™åªæ˜¯åªæœ‰ä¸€å€‹åˆ‡é¢é¡çš„æƒ…æ³ï¼Œå¦‚æœæœ‰å¤šå€‹@Aspecté¡å‘¢ï¼Œé€™å€‹èª¿ç”¨éç¨‹åˆæ˜¯æ€æ¨£çš„ï¼Ÿå…¶æ ¸å¿ƒæ€æƒ³å’Œâ€œæ£§â€ä¸€æ¨£ï¼Œå°±æ˜¯â€œ<strong>å…ˆé€²å¾Œå‡ºï¼Œå¾Œé€²å…ˆå‡º</strong>â€ã€‚</p><h2 class=line>AOPæ“´å±•çŸ¥è­˜</h2><h3 class=line>ä¸€ã€è‡ªå®šç¾©å…¨å±€æ””æˆªå™¨Interceptor</h3><p>åœ¨ä¸Šæ–‡å‰µå»ºä»£ç†å°è±¡çš„æ™‚å€™æœ‰é€™æ¨£ä¸€å€‹æ–¹æ³•ï¼š</p><pre><code>    protected Advisor[] buildAdvisors(@Nullable String beanName, @Nullable Object[] specificInterceptors) {        //è‡ªå®šç¾©MethodInterceptor.æ‹¿åˆ°setInterceptorNamesæ–¹æ³•æ³¨å…¥çš„Interceptorå°è±¡        Advisor[] commonInterceptors = resolveInterceptorNames();        List&lt;Object&gt; allInterceptors = new ArrayList&lt;&gt;();        if (specificInterceptors != null) {            allInterceptors.addAll(Arrays.asList(specificInterceptors));            if (commonInterceptors.length &gt; 0) {                if (this.applyCommonInterceptorsFirst) {                    allInterceptors.addAll(0, Arrays.asList(commonInterceptors));                }                else {                    allInterceptors.addAll(Arrays.asList(commonInterceptors));                }            }        }        Advisor[] advisors = new Advisor[allInterceptors.size()];        for (int i = 0; i &lt; allInterceptors.size(); i++) {            //å°è‡ªå®šç¾©çš„adviceè¦é€²è¡ŒåŒ…è£ï¼ŒæŠŠadviceåŒ…è£æˆadvisorå°è±¡ï¼Œåˆ‡é¢å°è±¡            advisors[i] = this.advisorAdapterRegistry.wrap(allInterceptors.get(i));        }        return advisors;    }</code></pre><p>é€™å€‹æ–¹æ³•çš„ä½œç”¨å°±åœ¨æ–¼æˆ‘å€‘å¯ä»¥æ“´å±•æˆ‘å€‘è‡ªå·±çš„Interceptorï¼Œé¦–å…ˆé€šé<strong>resolveInterceptorNames</strong>æ–¹æ³•ç²å–åˆ°é€šé<strong>setInterceptorNames</strong>æ–¹æ³•è¨­ç½®çš„Interceptorï¼Œç„¶å¾Œèª¿ç”¨<strong>DefaultAdvisorAdapterRegistry.wrap</strong>æ–¹æ³•å°‡å…¶åŒ…è£ç‚º<strong>DefaultPointcutAdvisor</strong>å°è±¡ä¸¦è¿”å›ï¼š</p><pre><code>    public Advisor wrap(Object adviceObject) throws UnknownAdviceTypeException {        if (adviceObject instanceof Advisor) {            return (Advisor) adviceObject;        }        if (!(adviceObject instanceof Advice)) {            throw new UnknownAdviceTypeException(adviceObject);        }        Advice advice = (Advice) adviceObject;        if (advice instanceof MethodInterceptor) {            return new DefaultPointcutAdvisor(advice);        }        for (AdvisorAdapter adapter : this.adapters) {            if (adapter.supportsAdvice(advice)) {                return new DefaultPointcutAdvisor(advice);            }        }        throw new UnknownAdviceTypeException(advice);    }    public DefaultPointcutAdvisor(Advice advice) {        this(Pointcut.TRUE, advice);    }</code></pre><p>éœ€è¦æ³¨æ„<strong>DefaultPointcutAdvisor</strong>æ§‹é€ å™¨è£¡é¢å‚³å…¥äº†ä¸€å€‹<strong>Pointcut.TRUE</strong>ï¼Œè¡¨ç¤ºé€™ç¨®æ“´å±•çš„Interceptoræ˜¯å…¨å±€çš„æ””æˆªå™¨ã€‚ä¸‹é¢ä¾†çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ï¼š</p><pre><code>public class MyMethodInterceptor implements MethodInterceptor {    @Override    public Object invoke(MethodInvocation invocation) throws Throwable {        System.out.println("è‡ªå®šç¾©æ””æˆªå™¨");        return invocation.proceed();    }}</code></pre><p>é¦–å…ˆå¯«ä¸€å€‹é¡å¯¦ç¾<strong>MethodInterceptor æ¥å£ï¼Œåœ¨invoke</strong>æ–¹æ³•ä¸­å¯¦ç¾æˆ‘å€‘çš„æ””æˆªé‚è¼¯ï¼Œç„¶å¾Œé€šéä¸‹é¢çš„æ–¹å¼æ¸¬è©¦ï¼Œåªè¦<strong>UserService æœ‰AOPæ””æˆªå°±æœƒç™¼ç¾è‡ªå®šç¾©çš„MyMethodInterceptor</strong>ä¹Ÿç”Ÿæ•ˆäº†ã€‚</p><pre><code>    public void costomInterceptorTest() {        AnnotationAwareAspectJAutoProxyCreator bean = applicationContext.getBean(AnnotationAwareAspectJAutoProxyCreator.class);        bean.setInterceptorNames("myMethodInterceptor ");        UserService userService = applicationContext.getBean(UserService.class);        userService.queryUser("dark");    }</code></pre><p>ä½†æ˜¯å¦‚æœæ›å€‹é †åºï¼Œåƒä¸‹é¢é€™æ¨£ï¼š</p><pre><code>    public void costomInterceptorTest() {        UserService userService = applicationContext.getBean(UserService.class);        AnnotationAwareAspectJAutoProxyCreator bean = applicationContext.getBean(AnnotationAwareAspectJAutoProxyCreator.class);        bean.setInterceptorNames("myMethodInterceptor ");        userService.queryUser("dark");    }</code></pre><p>é€™æ™‚è‡ªå®šç¾©çš„å…¨å±€æ””æˆªå™¨å°±æ²’æœ‰ä½œç”¨äº†ï¼Œé€™æ˜¯ç‚ºä»€éº¼å‘¢ï¼Ÿå› ç‚ºç•¶åŸ·è¡Œ<strong>getBean</strong>çš„æ™‚å€™ï¼Œå¦‚æœæœ‰åˆ‡é¢åŒ¹é…å°±æœƒé€šé<strong>ProxyFactory</strong>å»å‰µå»ºä»£ç†å°è±¡ï¼Œæ³¨æ„<strong>Interceptor</strong>æ˜¯å­˜åˆ°é€™å€‹Factoryå°è±¡ä¸­çš„ï¼Œè€Œé€™å€‹å°è±¡å’Œä»£ç†å°è±¡æ˜¯<strong>ä¸€ä¸€å°æ‡‰</strong>çš„ï¼Œå› æ­¤èª¿ç”¨<strong>getBean</strong>æ™‚ï¼Œé‚„æ²’æœ‰<strong>myMethodInterceptor</strong>é€™å€‹å°è±¡ï¼Œè‡ªå®šç¾©æ””æˆªå™¨å°±æ²’æœ‰æ•ˆæœäº†ï¼Œä¹Ÿå°±æ˜¯èªªè¦æƒ³è‡ªå®šç¾©æ””æˆªå™¨ç”Ÿæ•ˆï¼Œå°±å¿…é ˆåœ¨ä»£ç†å°è±¡ç”Ÿæˆä¹‹å‰è¨»å†Šé€²å»ã€‚</p><h3 class=line>äºŒã€å¾ªç’°ä¾è³´ä¸‰ç´šç·©å­˜å­˜åœ¨çš„å¿…è¦æ€§</h3><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘åˆ†æäº†Springæ˜¯å¦‚ä½•é€šéä¸‰ç´šç·©å­˜ä¾†è§£æ±ºå¾ªç’°ä¾è³´çš„å•é¡Œçš„ï¼Œä½†ä½ æ˜¯å¦è€ƒæ…®é<strong>ç¬¬ä¸‰ç´šç·©å­˜</strong>ç‚ºä»€éº¼è¦å­˜åœ¨ï¼Ÿæˆ‘ç›´æ¥å°‡beanå­˜åˆ°äºŒç´šä¸å°±è¡Œäº†éº¼ï¼Œç‚ºä»€éº¼é‚„è¦å­˜ä¸€å€‹<strong>ObjectFactory</strong>å°è±¡åˆ°<strong>ç¬¬ä¸‰ç´šç·©å­˜</strong>ä¸­ï¼Ÿé€™å€‹åœ¨å­¸ç¿’äº†AOPä¹‹å¾Œå°±å¾ˆæ¸…æ¥šäº†ï¼Œå› ç‚ºæˆ‘å€‘åœ¨@Autowiredå°è±¡æ™‚ï¼Œæƒ³è¦æ³¨å…¥çš„ä¸ä¸€å®šæ˜¯Beanæœ¬èº«ï¼Œè€Œæ˜¯æƒ³è¦æ³¨å…¥ä¸€å€‹<strong>ä¿®æ”¹</strong>éå¾Œçš„å°è±¡ï¼Œå¦‚<strong>ä»£ç†å°è±¡</strong>ã€‚åœ¨<strong>AbstractAutowireCapableBeanFactory.getEarlyBeanReference</strong>æ–¹æ³•ä¸­å¾ªç’°èª¿ç”¨äº†<strong>SmartInstantiationAwareBeanPostProcessor.getEarlyBeanReference</strong>æ–¹æ³•ï¼Œ<strong>AbstractAutoProxyCreator</strong>å°è±¡å°±å¯¦ç¾äº†è©²æ–¹æ³•ï¼š</p><pre><code>    public Object getEarlyBeanReference(Object bean, String beanName) {        Object cacheKey = getCacheKey(bean.getClass(), beanName);        if (!this.earlyProxyReferences.contains(cacheKey)) {            this.earlyProxyReferences.add(cacheKey);        }        // å‰µå»ºä»£ç†å°è±¡        return wrapIfNecessary(bean, beanName, cacheKey);    }</code></pre><p>å› æ­¤ï¼Œç•¶æˆ‘å€‘æƒ³è¦å°å¾ªå£ä¾è³´çš„Beanåšå‡º<strong>ä¿®æ”¹</strong>æ™‚ï¼Œå°±å¯ä»¥åƒAOPé€™æ¨£åšã€‚</p><h3 class=line>ä¸‰ã€å¦‚ä½•åœ¨Beanå‰µå»ºä¹‹å‰æå‰å‰µå»ºä»£ç†å°è±¡</h3><p>Springçš„ä»£ç†å°è±¡åŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨Beanå¯¦ä¾‹åŒ–å®Œæˆä¹‹å¾Œå‰µå»ºçš„ï¼Œä½†åœ¨æ–‡ç« é–‹å§‹æˆ‘å°±èªªéï¼ŒSpringä¹Ÿæä¾›äº†ä¸€å€‹æ©Ÿæœƒåœ¨å‰µå»ºBeanå°è±¡ä¹‹å‰å°±å‰µå»ºä»£ç†å°è±¡ï¼Œåœ¨<strong>AbstractAutowireCapableBeanFactory.resolveBeforeInstantiation</strong>æ–¹æ³•ä¸­ï¼š</p><pre><code>    protected Object resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd) {        Object bean = null;        if (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) {            // Make sure bean class is actually resolved at this point.            if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) {                Class&lt;?&gt; targetType = determineTargetType(beanName, mbd);                if (targetType != null) {                    bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName);                    if (bean != null) {                        bean = applyBeanPostProcessorsAfterInitialization(bean, beanName);                    }                }            }            mbd.beforeInstantiationResolved = (bean != null);        }        return bean;    }    protected Object applyBeanPostProcessorsBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) {        for (BeanPostProcessor bp : getBeanPostProcessors()) {            if (bp instanceof InstantiationAwareBeanPostProcessor) {                InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;                Object result = ibp.postProcessBeforeInstantiation(beanClass, beanName);                if (result != null) {                    return result;                }            }        }        return null;    }</code></pre><p>ä¸»è¦æ˜¯<strong>InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation</strong>æ–¹æ³•ä¸­ï¼Œé€™è£¡åˆæœƒé€²å…¥åˆ°<strong>AbstractAutoProxyCreator</strong>é¡ä¸­ï¼š</p><pre><code>    public Object postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) {        TargetSource targetSource = getCustomTargetSource(beanClass, beanName);        if (targetSource != null) {            if (StringUtils.hasLength(beanName)) {                this.targetSourcedBeans.add(beanName);            }            Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);            Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource);            this.proxyTypes.put(cacheKey, proxy.getClass());            return proxy;        }        return null;    }    protected TargetSource getCustomTargetSource(Class&lt;?&gt; beanClass, String beanName) {        // We can't create fancy target sources for directly registered singletons.        if (this.customTargetSourceCreators != null &amp;&amp;                this.beanFactory != null &amp;&amp; this.beanFactory.containsBean(beanName)) {            for (TargetSourceCreator tsc : this.customTargetSourceCreators) {                TargetSource ts = tsc.getTargetSource(beanClass, beanName);                if (ts != null) {                    return ts;                }            }        }        // No custom TargetSource found.        return null;    }</code></pre><p>çœ‹åˆ°é€™è£¡å¤§è‡´æ‡‰è©²æ˜ç™½äº†ï¼Œå…ˆæ˜¯ç²å–åˆ°ä¸€å€‹<strong>è‡ªå®šç¾©çš„TargetSource</strong>å°è±¡ï¼Œç„¶å¾Œå‰µå»ºä»£ç†å°è±¡ï¼Œæ‰€ä»¥æˆ‘å€‘é¦–å…ˆéœ€è¦è‡ªå·±å¯¦ç¾ä¸€å€‹<strong>TargetSource</strong>é¡ï¼Œé€™è£¡ç›´æ¥ç¹¼æ‰¿ä¸€å€‹æŠ½è±¡é¡ï¼Œ<strong>getTarget</strong>æ–¹æ³•å‰‡è¿”å›åŸå§‹å°è±¡ï¼š</p><pre><code>public class MyTargetSource extends AbstractBeanFactoryBasedTargetSource {    @Override    public Object getTarget() throws Exception {        return getBeanFactory().getBean(getTargetBeanName());    }}</code></pre><p>ä½†é€™é‚„ä¸å¤ ï¼Œä¸Šé¢é¦–å…ˆåˆ¤æ–·äº†<strong>customTargetSourceCreators!=null</strong>ï¼Œè€Œé€™å€‹å±¬æ€§æ˜¯å€‹æ•¸çµ„ï¼Œå¯ä»¥é€šéä¸‹é¢é€™å€‹æ–¹æ³•è¨­ç½®é€²ä¾†ï¼š</p><pre><code>    public void setCustomTargetSourceCreators(TargetSourceCreator... targetSourceCreators) {        this.customTargetSourceCreators = targetSourceCreators;    }</code></pre><p>æ‰€ä»¥æˆ‘å€‘é‚„è¦å¯¦ç¾ä¸€å€‹<strong>TargetSourceCreator</strong>é¡ï¼ŒåŒæ¨£ç¹¼æ‰¿ä¸€å€‹æŠ½è±¡é¡å¯¦ç¾ï¼Œä¸¦åªå°<strong>userServiceImpl</strong>å°è±¡é€²è¡Œæ””æˆªï¼š</p><pre><code>public class MyTargetSourceCreator extends AbstractBeanFactoryBasedTargetSourceCreator {    @Override    protected AbstractBeanFactoryBasedTargetSource createBeanFactoryBasedTargetSource(Class&lt;?&gt; beanClass, String beanName) {        if (getBeanFactory() instanceof ConfigurableListableBeanFactory) {            if(beanName.equalsIgnoreCase("userServiceImpl")) {                return new MyTargetSource();            }        }        return null;    }}</code></pre><p><strong>createBeanFactoryBasedTargetSource</strong>æ–¹æ³•æ˜¯åœ¨<strong>AbstractBeanFactoryBasedTargetSourceCreator.getTargetSource</strong>ä¸­èª¿ç”¨çš„ï¼Œè€Œ<strong>getTargetSource</strong>å°±æ˜¯åœ¨ä¸Šé¢<strong>getCustomTargetSource</strong>ä¸­èª¿ç”¨çš„ã€‚ä»¥ä¸Šå·¥ä½œåšå®Œå¾Œï¼Œé‚„éœ€è¦å°‡å…¶è¨­ç½®åˆ°<strong>AnnotationAwareAspectJAutoProxyCreator</strong>å°è±¡ä¸­ï¼Œå› æ­¤éœ€è¦æˆ‘å€‘æ³¨å…¥é€™å€‹å°è±¡ï¼š</p><pre><code>@Configurationpublic class TargetSourceCreatorBean {    @Autowired    private BeanFactory beanFactory;   @Bean    public AnnotationAwareAspectJAutoProxyCreator annotationAwareAspectJAutoProxyCreator() {        AnnotationAwareAspectJAutoProxyCreator creator = new AnnotationAwareAspectJAutoProxyCreator();        MyTargetSourceCreator myTargetSourceCreator = new MyTargetSourceCreator();        myTargetSourceCreator.setBeanFactory(beanFactory);        creator.setCustomTargetSourceCreators(myTargetSourceCreator);        return creator;    }}</code></pre><p>é€™æ¨£ï¼Œç•¶æˆ‘å€‘é€šégetBeanç²å–<strong>userServiceImpl</strong>çš„å°è±¡æ™‚ï¼Œå°±æœƒå„ªå…ˆç”Ÿæˆä»£ç†å°è±¡ï¼Œç„¶å¾Œåœ¨èª¿ç”¨åŸ·è¡Œéˆçš„éç¨‹ä¸­å†é€šé<strong>TargetSource.getTarget</strong>ç²å–åˆ°è¢«ä»£ç†å°è±¡ã€‚ä½†æ˜¯ï¼Œç‚ºä»€éº¼æˆ‘å€‘åœ¨<strong>getTarget</strong>æ–¹æ³•ä¸­èª¿ç”¨<strong>getBean</strong>å°±èƒ½æ‹¿åˆ°è¢«ä»£ç†å°è±¡å‘¢ï¼Ÿç¹¼çºŒæ¢ç©¶ï¼Œé€šéæ–·é»æˆ‘ç™¼ç¾å¾<strong>getTarget</strong>é€²å…¥æ™‚ï¼Œåœ¨<strong>resolveBeforeInstantiation</strong>æ–¹æ³•ä¸­è¿”å›çš„beanå°±æ˜¯nulläº†ï¼Œè€Œ<strong>getBeanPostProcessors</strong>æ–¹æ³•è¿”å›çš„<strong>Processors</strong>ä¸­ä¹Ÿæ²’æœ‰äº†<strong>AnnotationAwareAspectJAutoProxyCreator</strong>å°è±¡ï¼Œä¹Ÿå°±æ˜¯æ²’æœ‰é€²å…¥åˆ°<strong>AbstractAutoProxyCreator.postProcessBeforeInstantiation</strong>æ–¹æ³•ä¸­ï¼Œæ‰€ä»¥ä¸æœƒå†æ¬¡ç²å–åˆ°ä»£ç†å°è±¡ï¼Œé‚£<strong>AnnotationAwareAspectJAutoProxyCreator</strong>å°è±¡æ˜¯åœ¨ä»€éº¼æ™‚å€™ç§»é™¤çš„å‘¢ï¼Ÿå¸¶è‘—å•é¡Œï¼Œæˆ‘é–‹å§‹åæ¨ï¼Œç™¼ç¾åœ¨<strong>AbstractBeanFactoryBasedTargetSourceCreator</strong>é¡ä¸­æœ‰é€™æ¨£ä¸€å€‹æ–¹æ³•<strong>buildInternalBeanFactory</strong>ï¼š</p><pre><code>    protected DefaultListableBeanFactory buildInternalBeanFactory(ConfigurableBeanFactory containingFactory) {        DefaultListableBeanFactory internalBeanFactory = new DefaultListableBeanFactory(containingFactory);        // Required so that all BeanPostProcessors, Scopes, etc become available.        internalBeanFactory.copyConfigurationFrom(containingFactory);        // Filter out BeanPostProcessors that are part of the AOP infrastructure,        // since those are only meant to apply to beans defined in the original factory.        internalBeanFactory.getBeanPostProcessors().removeIf(beanPostProcessor -&gt;                beanPostProcessor instanceof AopInfrastructureBean);        return internalBeanFactory;    }</code></pre><p>åœ¨é€™è£¡ç§»é™¤æ‰äº†æ‰€æœ‰<strong>AopInfrastructureBean</strong>çš„å­é¡ï¼Œè€Œ<strong>AnnotationAwareAspectJAutoProxyCreator</strong>å°±æ˜¯å…¶å­é¡ï¼Œé‚£é€™å€‹æ–¹æ³•æ˜¯åœ¨å“ªè£¡èª¿ç”¨çš„å‘¢ï¼Ÿç¹¼çºŒåæ¨ï¼š</p><pre><code>    protected DefaultListableBeanFactory getInternalBeanFactoryForBean(String beanName) {        synchronized (this.internalBeanFactories) {            DefaultListableBeanFactory internalBeanFactory = this.internalBeanFactories.get(beanName);            if (internalBeanFactory == null) {                internalBeanFactory = buildInternalBeanFactory(this.beanFactory);                this.internalBeanFactories.put(beanName, internalBeanFactory);            }            return internalBeanFactory;        }    }    public final TargetSource getTargetSource(Class&lt;?&gt; beanClass, String beanName) {        AbstractBeanFactoryBasedTargetSource targetSource =                createBeanFactoryBasedTargetSource(beanClass, beanName);        // å‰µå»ºå®ŒtargetSourceå¾Œå°±ç§»é™¤æ‰AopInfrastructureBeané¡å‹çš„BeanPostProcessorå°è±¡ï¼Œå¦‚AnnotationAwareAspectJAutoProxyCreator        DefaultListableBeanFactory internalBeanFactory = getInternalBeanFactoryForBean(beanName);        ......        return targetSource;    }</code></pre><p>è‡³æ­¤ï¼Œé—œæ–¼<strong>TargetSource</strong>æ¥å£æ“´å±•çš„åŸç†å°±ææ˜ç™½äº†ã€‚</p><h1 class=line>ç¸½çµ</h1><p>æœ¬ç¯‡ç¯‡å¹…æ¯”è¼ƒé•·ï¼Œä¸»è¦ææ˜ç™½Springä»£ç†å°è±¡æ˜¯å¦‚ä½•å‰µå»ºçš„ä»¥åŠAOPéˆå¼èª¿ç”¨éç¨‹ï¼Œè€Œå¾Œé¢çš„æ“´å±•å‰‡æ˜¯å°AOPä»¥åŠBeanå‰µå»ºéç¨‹ä¸­ä¸€äº›ç–‘æƒ‘çš„è£œå……ï¼Œå¯æ ¹æ“šå¯¦éš›æƒ…æ³å­¸ç¿’æŒæ¡ã€‚</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>ææ‡‚</a></li><li><a>Spring</a></li><li><a>å‰µå»º</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/b49977fa.html alt=20å€‹æ©Ÿæ¢°è¨­è¨ˆçŸ¥è­˜é»ç¸½çµï¼Œææ‡‚ä¹Ÿæ˜¯åŠå€‹è¡Œå®¶ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b49977fa.html title=20å€‹æ©Ÿæ¢°è¨­è¨ˆçŸ¥è­˜é»ç¸½çµï¼Œææ‡‚ä¹Ÿæ˜¯åŠå€‹è¡Œå®¶>20å€‹æ©Ÿæ¢°è¨­è¨ˆçŸ¥è­˜é»ç¸½çµï¼Œææ‡‚ä¹Ÿæ˜¯åŠå€‹è¡Œå®¶</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/000afa08.html alt="Spring Boot 2.xåŸºç¤æ•™ç¨‹ï¼šSwaggeræ¥å£åˆ†é¡èˆ‡å„å…ƒç´ æ’åºå•é¡Œè©³è§£" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/daa2cfd29ec34306a4be6f3f257b824b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/000afa08.html title="Spring Boot 2.xåŸºç¤æ•™ç¨‹ï¼šSwaggeræ¥å£åˆ†é¡èˆ‡å„å…ƒç´ æ’åºå•é¡Œè©³è§£">Spring Boot 2.xåŸºç¤æ•™ç¨‹ï¼šSwaggeræ¥å£åˆ†é¡èˆ‡å„å…ƒç´ æ’åºå•é¡Œè©³è§£</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6cfd4e0e.html alt="Spring æ ¸å¿ƒçŸ¥è­˜è¬›è§£ï¼Œå¤ªç°¡å–®å•¦" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6cfd4e0e.html title="Spring æ ¸å¿ƒçŸ¥è­˜è¬›è§£ï¼Œå¤ªç°¡å–®å•¦">Spring æ ¸å¿ƒçŸ¥è­˜è¬›è§£ï¼Œå¤ªç°¡å–®å•¦</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/090306a0.html alt="[Spring] æ·±å…¥ç­è§£äº‹å‹™åŸç†" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/a8c6dbd7c51741f5a76262e8e2c7a670 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/090306a0.html title="[Spring] æ·±å…¥ç­è§£äº‹å‹™åŸç†">[Spring] æ·±å…¥ç­è§£äº‹å‹™åŸç†</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html alt="ã€Œè­¯ã€ Spring çš„åˆ†ä½ˆå¼äº‹å‹™å¯¦ç¾â€”ä½¿ç”¨å’Œä¸ä½¿ç”¨ XAâ€”ç¬¬äºŒéƒ¨åˆ†" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html title="ã€Œè­¯ã€ Spring çš„åˆ†ä½ˆå¼äº‹å‹™å¯¦ç¾â€”ä½¿ç”¨å’Œä¸ä½¿ç”¨ XAâ€”ç¬¬äºŒéƒ¨åˆ†">ã€Œè­¯ã€ Spring çš„åˆ†ä½ˆå¼äº‹å‹™å¯¦ç¾â€”ä½¿ç”¨å’Œä¸ä½¿ç”¨ XAâ€”ç¬¬äºŒéƒ¨åˆ†</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1678b1c4.html alt=ï¼ˆæ”¶è—ï¼‰Springäº‹å‹™å°ˆé¡Œï¼šäº‹å‹™çš„åŸºæœ¬æ¦‚å¿µï¼ŒMysqläº‹å‹™è™•ç†åŸç† class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/433259b5-1936-4cee-ab74-70aef36536ee style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1678b1c4.html title=ï¼ˆæ”¶è—ï¼‰Springäº‹å‹™å°ˆé¡Œï¼šäº‹å‹™çš„åŸºæœ¬æ¦‚å¿µï¼ŒMysqläº‹å‹™è™•ç†åŸç†>ï¼ˆæ”¶è—ï¼‰Springäº‹å‹™å°ˆé¡Œï¼šäº‹å‹™çš„åŸºæœ¬æ¦‚å¿µï¼ŒMysqläº‹å‹™è™•ç†åŸç†</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d3c48fcc.html alt=Springè²æ˜å¼äº‹å‹™è™•ç†çš„å¯¦ç¾åŸç†ï¼Œä¾†è‡ªé¢è©¦å®˜çš„çª®è¿½æ‹·å• class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d3c48fcc.html title=Springè²æ˜å¼äº‹å‹™è™•ç†çš„å¯¦ç¾åŸç†ï¼Œä¾†è‡ªé¢è©¦å®˜çš„çª®è¿½æ‹·å•>Springè²æ˜å¼äº‹å‹™è™•ç†çš„å¯¦ç¾åŸç†ï¼Œä¾†è‡ªé¢è©¦å®˜çš„çª®è¿½æ‹·å•</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/319bc575.html alt=é›»å·¥æœ€å¸¸è¦‹çš„å¹¾å€‹é›»è·¯åœ–ï¼Œå…¨éƒ½ææ‡‚çš„æ‰æ˜¯è€å¸«å‚…ï¼Œä½ ææ‡‚äº†å¹¾å€‹ï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/47783c95e3a34185be9ff00f54b4fe7e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/319bc575.html title=é›»å·¥æœ€å¸¸è¦‹çš„å¹¾å€‹é›»è·¯åœ–ï¼Œå…¨éƒ½ææ‡‚çš„æ‰æ˜¯è€å¸«å‚…ï¼Œä½ ææ‡‚äº†å¹¾å€‹ï¼Ÿ>é›»å·¥æœ€å¸¸è¦‹çš„å¹¾å€‹é›»è·¯åœ–ï¼Œå…¨éƒ½ææ‡‚çš„æ‰æ˜¯è€å¸«å‚…ï¼Œä½ ææ‡‚äº†å¹¾å€‹ï¼Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ac62942e.html alt=ç¦ªåŸå‰µå»ºæ”¾å¿ƒæ¶ˆè²»åŸå¸‚ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/152116341963423636ee2f3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ac62942e.html title=ç¦ªåŸå‰µå»ºæ”¾å¿ƒæ¶ˆè²»åŸå¸‚>ç¦ªåŸå‰µå»ºæ”¾å¿ƒæ¶ˆè²»åŸå¸‚</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4c45fc11.html alt=è»¸æ‰¿ä¿æŒæ¶æ–·è£‚åŸå› ï¼Œçµ‚æ–¼ææ‡‚äº†ï¼ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/926568ad42794eac8db9ccfc13716933 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4c45fc11.html title=è»¸æ‰¿ä¿æŒæ¶æ–·è£‚åŸå› ï¼Œçµ‚æ–¼ææ‡‚äº†ï¼>è»¸æ‰¿ä¿æŒæ¶æ–·è£‚åŸå› ï¼Œçµ‚æ–¼ææ‡‚äº†ï¼</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/edb28816.html alt=ã€Œå·¥ç¨‹é€ åƒ¹ã€ææ‡‚é€™41å€‹å•é¡Œï¼Œä½ å°±æ˜¯é€ åƒ¹å¤§ç¥ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/61e6d766-6c64-42b0-8adc-44437be425ee style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/edb28816.html title=ã€Œå·¥ç¨‹é€ åƒ¹ã€ææ‡‚é€™41å€‹å•é¡Œï¼Œä½ å°±æ˜¯é€ åƒ¹å¤§ç¥>ã€Œå·¥ç¨‹é€ åƒ¹ã€ææ‡‚é€™41å€‹å•é¡Œï¼Œä½ å°±æ˜¯é€ åƒ¹å¤§ç¥</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dccc27aa.html alt=ææ‡‚é‹°é›»æ± é˜»æŠ—è­œ(EIS)ä¸å®¹æ˜“ï¼Œé€™ç¯‡æ–‡ç« å€¼å¾—æ”¶è— class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/45dfe66dfe2b42088ca53ab0c5d316b2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dccc27aa.html title=ææ‡‚é‹°é›»æ± é˜»æŠ—è­œ(EIS)ä¸å®¹æ˜“ï¼Œé€™ç¯‡æ–‡ç« å€¼å¾—æ”¶è—>ææ‡‚é‹°é›»æ± é˜»æŠ—è­œ(EIS)ä¸å®¹æ˜“ï¼Œé€™ç¯‡æ–‡ç« å€¼å¾—æ”¶è—</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/142b983a.html alt=ä¸€æ–‡ææ‡‚å¸¸ç”¨é‹¼æå‹è™Ÿã€æ€§èƒ½ç‰¹æ€§ï¼Œæ”¶è—éš¨æ™‚æŸ¥çœ‹ï¼ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1533653259067c6eef0dcc2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/142b983a.html title=ä¸€æ–‡ææ‡‚å¸¸ç”¨é‹¼æå‹è™Ÿã€æ€§èƒ½ç‰¹æ€§ï¼Œæ”¶è—éš¨æ™‚æŸ¥çœ‹ï¼>ä¸€æ–‡ææ‡‚å¸¸ç”¨é‹¼æå‹è™Ÿã€æ€§èƒ½ç‰¹æ€§ï¼Œæ”¶è—éš¨æ™‚æŸ¥çœ‹ï¼</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/00a88a85.html alt="æ²’ææ‡‚æ‰¿é‡ç‰†oréæ‰¿é‡ç‰†ï¼Œä½ å°±æ•¢èƒ¡äº‚æ‹†ï¼Ÿ| æœ€å®¶è¨ˆåŠƒ" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/Rd1uElWC8gP2we style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/00a88a85.html title="æ²’ææ‡‚æ‰¿é‡ç‰†oréæ‰¿é‡ç‰†ï¼Œä½ å°±æ•¢èƒ¡äº‚æ‹†ï¼Ÿ| æœ€å®¶è¨ˆåŠƒ">æ²’ææ‡‚æ‰¿é‡ç‰†oréæ‰¿é‡ç‰†ï¼Œä½ å°±æ•¢èƒ¡äº‚æ‹†ï¼Ÿ| æœ€å®¶è¨ˆåŠƒ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/187187bc.html alt="æŠ€è¡“è¶£è¬› | 60 åˆ†é˜ææ‡‚ã€Œæ­£å‰‡è¡¨é”å¼ã€" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/eaee8d2e512c44168627b8f244fb5e43 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/187187bc.html title="æŠ€è¡“è¶£è¬› | 60 åˆ†é˜ææ‡‚ã€Œæ­£å‰‡è¡¨é”å¼ã€">æŠ€è¡“è¶£è¬› | 60 åˆ†é˜ææ‡‚ã€Œæ­£å‰‡è¡¨é”å¼ã€</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>