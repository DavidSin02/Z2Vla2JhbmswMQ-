<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>磁盤、分區及Linux文件系統 | 极客快訊</title><meta property="og:title" content="磁盤、分區及Linux文件系統 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/15396100783017b2b1eb966"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b90f2ab.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b90f2ab.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b90f2ab.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b90f2ab.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b90f2ab.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b90f2ab.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/b90f2ab.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/b90f2ab.html><meta property="article:published_time" content="2020-10-29T21:07:20+08:00"><meta property="article:modified_time" content="2020-10-29T21:07:20+08:00"><meta name=Keywords content><meta name=description content="磁盤、分區及Linux文件系統"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/b90f2ab.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>磁盤、分區及Linux文件系統</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>1、磁盤基礎知識</strong></p><p><strong>1.1 物理結構</strong></p><p>硬盤的物理結構一般由磁頭與碟片、電動機、主控芯片與排線等部件組成；當主電動機帶動碟片旋轉時，副電動機帶動一組（<strong>磁頭</strong>）到相對應的碟片上並確定讀取正面還是反面的碟面，磁頭懸浮在碟面上畫出一個與碟片同心的圓形軌道（<strong>磁軌</strong>或稱<strong>柱面</strong>），這時由磁頭的磁感線圈感應碟面上的磁性與使用硬盤廠商指定的讀取時間或數據間隔定位<strong>扇區</strong>，從而得到該扇區的數據內容。所有的盤片都固定在一個旋轉軸上，這個軸即盤片主軸。而所有盤片之間是絕對平行的，在每個盤片的存儲面上都有一個磁頭，磁頭與盤片之間的距離比頭髮 絲的直徑還小。所有的磁頭連在一個磁頭控制器上，由磁頭控制器負責各個磁頭的運動。磁頭可沿盤片的半徑方向動作，而盤片以每分鐘數千轉到上萬轉的速度在高 速旋轉，這樣磁頭就能對盤片上的指定位置進行數據的讀寫操作。</p><ul><li>磁道（Track）</li></ul><p>當磁盤旋轉時，磁頭若保持在一個位置上，則每個磁頭都會在磁盤表面劃出一個圓形軌跡，這些圓形軌跡就叫做磁道（Track）。信息以脈衝串的形式記錄在這些軌跡中，這些同心圓不是連續記錄數據，而是被劃分成一段段的圓弧（扇區），這些圓弧 的角速度一樣。</p><ul><li>柱面 （Cylinder）</li></ul><p>在有多個盤片構成的盤組中，由不同盤片的面，但處於同一半徑圓的多個磁道組成的一個圓柱面（Cylinder）。所有盤面上的同一磁道構成一個圓柱，通常稱做柱面（Cylinder），每個圓柱上的磁頭由上而下從“0”開始編號。數據的讀/寫按柱面進行，即磁 頭讀/寫數據時首先在同一柱面內從“0”磁頭開始進行操作，依次向下在同一柱面的不同盤面即磁頭上進行操作，只在同一柱面所有的磁頭全部讀/寫完畢後磁頭 才轉移到下一柱面，因為選取磁頭只需通過電子切換即可，而選取柱面則必須通過機械切換。電子切換相當快，比在機械上磁頭向鄰近磁道移動快得多，所以，數據 的讀/寫按柱面進行，而不按盤面進行。也就是說，一個磁道寫滿數據後，就在同一柱面的下一個盤面來寫，一個柱面寫滿後，才移到下一個扇區開始寫數據。讀數 據也按照這種方式進行，這樣就提高了硬盤的讀/寫效率。</p><ul><li>扇區（Sector）</li></ul><p>磁盤上的每個磁道被等分為若干個弧段，這些弧段便是硬盤的扇區（Sector）。硬盤的第一個扇區，叫做引導扇區。操作系統以扇區（Sector）形式將信息存儲在硬盤上，每個扇區包括512個字節的數據和一些其他信息。</p><ul><li>磁頭（Head）</li></ul><p>在硬盤系 統中，硬盤的每一個盤片都有兩個盤面（Side），即上、下盤面，一般每個盤面都會利 用，都可以存儲數據。盤面號又叫磁頭號，因為每一個有效盤面都有一個對應的讀寫磁頭。</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15396100783017b2b1eb966><p class=pgc-img-caption></p></div><p>在 linux 中可以使用 fdisk -l 查看一個磁盤的物理結構：</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/153961007822443027a86c5><p class=pgc-img-caption></p></div><p>該磁盤有255個heads，也就是說共有255個盤面。3263個柱面（cylinders），也就是說每個盤面上都有3263個磁道， 63 sectors/track說的是每個磁道上共有63個扇區。命令結果也給出了Sector size的值是512bytes。那我們動筆算一下該磁盤的大小吧。</p><p>255盤面 * 3263柱面 * 63扇區 * 每個扇區512bytes = 26839088640byte。</p><p>結果是26.8G,和磁盤的總大小相符。</p><p><strong>1.2 磁盤的讀寫原理</strong></p><p>系統將文件存儲到磁盤上時，按柱面、磁頭、扇區的方式進行，即最先是第1磁道的第一磁頭下（也就是第1盤面的第一磁道）的所有扇區，然後，是同一柱面的下一磁頭，……，一個柱面存儲滿後就推進到下一個柱面，直到把文件內容全部寫入磁盤。</p><p>系統也以相同的順序讀出數據。讀出數據時通過告訴磁盤控制器要讀出扇區所在的柱面號、磁頭號和扇區號（物理地址的三個組成部分）進行。磁盤控制器則直接使磁頭部件步進到相應的柱面，選通相應的磁頭，等待要求的扇區移動到磁頭下。在扇區到來時，磁盤控制器讀出每個扇區的頭標，把這些頭標中的地址信息與 期待檢出的磁頭和柱面號做比較（即尋道），然後，尋找要求的扇區號。待磁盤控制器找到該扇區頭標時，根據其任務是寫扇區還是讀扇區，來決定是轉換寫電路， 還是讀出數據和尾部記錄。找到扇區後，磁盤控制器必須在繼續尋找下一個扇區之前對該扇區的信息進行後處理。如果是讀數據，控制器計算此數據的ECC碼，然 後，把ECC碼與已記錄的ECC碼相比較。如果是寫數據，控制器計算出此數據的ECC碼，與數據一起存儲。在控制器對此扇區中的數據進行必要處理期間，磁 盤繼續旋轉。其實我們的文件大多數的時候都是破碎的，在文件沒有破碎的時候,搖臂只需要尋找1次磁道並由磁頭進行讀取,只需要1次就可以成功讀取;但是如果文件破碎成11處,那麼搖臂要來回尋找11次磁道磁頭進行11次讀取才能完整的讀取這個文件,讀取時間相對沒有破碎的時候就變得冗長。</p><p>因此，磁盤IO時的過程包括：</p><ul><li>第一步，首先是磁頭徑向移動來尋找數據所在的磁道。這部分時間叫尋道時間。</li><li>第二步，找到目標磁道後通過盤面旋轉，將目標扇區移動到磁頭的正下方。</li><li>第三步，向目標扇區讀取或者寫入數據。到此為止，一次磁盤IO完成，故：</li></ul><p>所以，單次磁盤IO時間 = 尋道時間 + 旋轉延遲 + 存取時間。</p><ul><li>對於旋轉延時，現在主流服務器上經常使用的是1W轉/分鐘的磁盤，每旋轉一週所需的時間為60*1000/10000=6ms，故其旋轉延遲為（0-6ms）。</li><li>對於存取時間，一般耗時較短，為零點幾ms。</li><li>對於尋道時間，現代磁盤大概在3-15ms，其中尋道時間大小主要受磁頭當前所在位置和目標磁道所在位置相對距離的影響。</li></ul><p>候選的磁盤分區方案：</p><ul><li>方案一： 255個盤面，C盤是0-100盤面， D盤是101-200個盤面,……</li><li>方案二：3263個柱面，C盤0-1000個柱面，D盤1001-20001個柱面,……</li></ul><p>其實採用哪一種，最主要看的是那種方式性能更快。因為同一分區下的數據經常會一起讀取，假如採用第一種，那麼這樣磁頭就需要在3000多個track間不停地跳來跳去，這樣磁盤的尋道時間就會翻倍，磁盤性能就會下降。而對於方案二，假如對於磁盤C，只需要在磁頭在1-1000個磁道間移動就可以了，大大降低了尋道時間。（實際上分區並不是從0開始的，磁盤的第一個磁道對應的柱面會被用來安裝引導加載程序以及磁盤分區表）。所以，方案二的分區方式可以降低磁盤IO時間中的尋道時間部分，所以所有的操作系統採用的都是方案二，沒有用方案一的。</p><p><strong>2. Linux 下磁盤命名和分區</strong></p><p>在為主機添加硬盤前，首先要了解Linux系統下對硬盤和分區的命名方法。</p><p><strong>2.1 磁盤命名</strong></p><p>在Linux下對 SCSI 和 SATA 設備是以 sd 命名的，第一個 scsi 設備是 sda，第二個是 sdb，依此類推。一般主板上有兩個SCSI接口，因此一共可以安裝四個SCSI設備。主 SCSI 上的兩個設備分別對應 sda 和 sdb，第二個 SCSI 口上的兩個設備對應 sdc 和 sdd。一般硬盤安裝在主 SCSI 的主接口上，所以是 sda 或者 sdb，而光驅一般安裝在第二個SCSI的主接口上，所以是 sdc。(IDE接口設備是用 hd 命名的，第一個設備是hda，第二個是hdb，依此類推。)</p><p><strong>IDE 磁盤</strong>描述配置/dev/hda1st (Primary) IDE controllerMaster/dev/hdb1st (Primary) IDE controllerSlave/dev/hdc2nd (Secondary) IDE controllerMaster/dev/hdd2nd (Secondary) IDE controllerSlave</p><p><strong>2.2 分區命名</strong></p><p>所謂的磁盤分區指的是告訴操作系統『我這顆磁盤在此分割槽可以存取的區域是由 A 磁柱到 B 磁柱之間的區塊』， 如此一來操作系統就能夠知道他可以在所指定的區塊內進行文件數據的讀/寫/搜尋等動作了。 也就是說，磁盤分區意即指定分割槽的啟始與結束磁柱就是了。</p><p>分區是用設備名稱加數字命名的。例如 hda1 代表hda這個硬盤設備上的第一個分區。 每個硬盤可以最多有四個主分區，作用是 1-4 命名硬盤的主分區。多個主分區中只能有一個active 主分區作為啟動分區。邏輯分區是從5開始的，每多一個分區，每個磁盤上最多可以有 24個擴展分區。</p><p><strong>2.3 分區步驟</strong></p><p>1. 運行 fdisk 來分區：</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/153961007783077032176d0><p class=pgc-img-caption></p></div><p>其中第一個框和第二個框，是已經分好區的磁盤，第三個硬盤沒有分區。</p><pre>[root]# fdisk /dev/sdbCommand (m for help): m (Enter the letter "m" to get list of commands)Command action a toggle a bootable flag b edit bsd disklabel c toggle the dos compatibility flag d delete a partition l list known partition types m print this menu n add a new partition o create a new empty DOS partition table p print the partition table q quit without saving changes s create a new empty Sun disklabel t change a partition's system id u change display/entry units v verify the partition table w write table to disk and exit x extra functionality (experts only)Command (m for help): nCommand action e extended p primary partition (1-4)pPartition number (1-4): 1First cylinder (1-9729, default 1):Using default value 1Last cylinder, +cylinders or +size{K,M,G} (1-9729, default 9729):Using default value 9729Command (m for help): w (Write and save partition table)[root]# mkfs.ext4 -L disk2 /dev/sdb</pre><p>分多個區有以下幾個目的：</p><ul><li>在不損失數據的情況下重裝系統，比如獨立設置 /home 掛載點，重裝系統的時候直接標記回 /home，數據不會有任何損失。</li><li>針對不同的掛載點的特性分配合適的文件系統以合理發揮性能，比如對 /var 使用reiserfs，對 /home 使用xfs，對 / 使用ext4。</li><li>針對不同的掛載點開啟不同的掛載選項，如是否需要即時同步，是否開啟日誌，是否啟用壓縮。</li><li>大硬盤搜索範圍大，效率低</li><li>磁盤配額只能對分區做設定</li><li>/home、/var、/usr/local 經常是單獨分區，因為經常會操作，容易產生碎片</li></ul><p>2. 格式化分區：mkfs -t ext3 /dev/sda1</p><p>每塊硬盤都分為若干個分區，每個分區都有自己的文件系統。Windows為這些文件系統各自指定了一個字母。不過 GNU/Linux 使用唯一的樹形結構來管理文件，而每個文件系統都掛載於樹形結構的某個位置。</p><p>正如 Windows 需要有 C: 驅動器一樣，GNU/Linux 必須能夠將根文件系統掛載於文件樹的根(/)上。當根掛載完成之後，您就可以將其它文件系統掛載於樹形結構各種掛載點上。根結構下的任何目錄都可以作為掛載點，而您也可以將同一文件系統同時掛載於不同的掛載點上。掛載點實際上就是linux中的磁盤文件系統的入口目錄：</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/153961007839228a8654c3e><p class=pgc-img-caption></p></div><p>關於文件系統的三個易混淆的概念：</p><ul><li><strong>創建：</strong>以某種方式格式化磁盤的過程就是在其之上建立一個文件系統的過程。創建文件系統時，會在磁盤的特定位置寫入關於該文件系統的控制信息。</li><li><strong>註冊：</strong>向內核報到，聲明自己能被內核支持。一般在編譯內核的時侯註冊；也可以加載模塊的方式手動註冊。註冊過程實 際上是將表示各實際文件系統的數據結構struct file_system_type 實例化。</li><li><strong>安裝：</strong>也就是我們熟悉的mount操作，將文件系統加入到 Linux 的根文件系統的目錄樹結構上；這樣文件系統才能被訪問。</li></ul><p>linux 下一切皆文件！換言之就是linux操作系統將系統中的一切都作為文件來管理。在windows中我們常見的硬件設備（打印機、網卡、聲卡...）、磁盤分區等，在linux中統統都被視作文件，對設備、分區的訪問就是讀寫對應的文件。</p><p>格式化命令：</p><p>mkfs.ext3 /dev/sdb1 //格式化分區成 ext3</p><p>mkfs.ext2 /dev/sdb1 //格式化分區成 ext2</p><p>3. 掛載 mount /dev/sda1 /test</p><p>df 命令用於查看已掛載磁盤的總容量、使用容量、剩餘容量等，可以不加任何參數，默認是按k為單位顯示的。</p><p>du 命令用來查看某個目錄所佔空間大小。</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15396100778855bfa76a2fc><p class=pgc-img-caption></p></div><p>4. 開機直接掛載</p><p>編輯 /etc/fstab 文件，添加：/dev/sda1 /test ext3 defaults 1 1，重啟則發選已經掛載上去。</p><p>5. 總結</p><ul><li>掛載點必須是一個目錄。</li><li>一個分區掛載在一個已存在的目錄上，這個目錄可以不為空，但掛載後這個目錄下以前的內容將不可用。對於其他操作系統建立的文件系統的掛載也是這樣，卸載後，目錄以前的文件都還在，不會有任何丟失。</li><li>目錄只佔磁盤裡的一個inode，存放文件屬性等信息。</li><li>任何一個分區都必須掛載到某個目錄上。</li><li>目錄是邏輯上的區分。分區是物理上的區分。</li><li>磁盤Linux分區都必須掛載到目錄樹中的某個具體的目錄上才能進行讀寫操作。</li><li>根目錄是所有Linux的文件和目錄所在的地方，需要掛載上一個磁盤分區。</li><li>一個分區可以掛在多個目錄，但反過來一個目錄只能是一個分區的掛載點。</li></ul><p><strong>3. Linux 文件系統</strong></p><p>文件系統是對一個存儲設備上的數據和元數據進行組織的機制。它的最終目的是把大量數據有組織的放入持久性(persistant)的存儲設備中，比如硬盤和磁盤。文件系統(file system)是就是文件在邏輯上組織形式，它以一種更加清晰的方式來存放各個文件。數據被存入到某個分區中。一個典型的Linux分區(partition)包含有下面各個部分:</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539610077914c80cade347><p class=pgc-img-caption></p></div><p>文件是文件系統對數據的分割單元。文件系統用目錄來組織文件，賦予文件以上下分級的結構。在硬盤上實現這一分級結構的關鍵，是使用 inode 來虛擬普通文件和目錄文件對象。在Linux系統中，目錄也是一種文件。所以/home/sammy 是指向目錄文件 sammy 的絕對路徑。</p><p>磁盤與文件系統：</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1539610078313f4cebc403f><p class=pgc-img-caption></p></div><p><strong>3.1 inode</strong></p><p>inodes 是實現文件存儲的關鍵。在 Linux 中，文件系統中管理的每個對象（文件或目錄）表示為一個 inode。inode 包含管理文件系統中的對象所需的所有元數據（包括可以在對象上執行的操作）。在 Linux 系統中，一個文件可以分成幾個數據塊存儲在分區內。為了蒐集各數據塊，我們需要該文件對應的inode。每個文件對應一個 inode。這個 inode 中包含多個指針，指向屬於該文件各個數據塊。當操作系統需要讀取文件時，只需要找到對應 inode，收集分散的數據塊，就可以收穫我們的文件了。</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15396100783692bbfcffe37><p class=pgc-img-caption></p></div><p><strong>讀取文件：</strong></p><p><strong></strong></p><p>在Linux中，我們通過解析路徑，根據沿途的目錄文件來找到某個文件。目錄中的條目除了所包含的文件名，還有對應的inode編號。當我們輸入$cat /var/test.txt時，Linux 將在根目錄文件中找到 var 這個目錄文件的inode編號，然後根據 inode 合成 var 的數據。隨後，根據 var 中的記錄，找到 text.txt 的 inode 編號，沿著 inode 中的指針，收集數據塊，合成 text.txt 的數據。整個過程中，會參考三個inode：</p><ul><li>根目錄文件的 inode：2，用於找到 var 的 inode id</li><li>var 目錄文件的 inode：10747905，用於找到 test.txt 的 inode id</li><li>text.txt 文件的 inode： 10749034，用於找到 data blocks</li></ul><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539610078623a87ffa92e4><p class=pgc-img-caption></p></div><p>因此，當我們讀取一個文件時，實際上是在目錄中找到了這個文件的inode編號，然後根據inode的指針，把數據塊組合起來，放入內存供進一步的處理。當我們創建一個文件時，是分配一個空白 inode 給該文件，將其 inode 編號記入該文件所屬的目錄，然後選取空白的數據塊，讓 inode 的指針指向這些數據塊，並放入內存中的數據。</p><p><strong>3.2 循環設備</strong></p><p>在類Unix系統中，<strong>/dev/loop</strong> 是一種偽設備，這種設備使得文件可以如同塊設備一般被訪問。在目錄上掛載包含文件系統的文件一般需要兩步：</p><ol><li>用一個循環設備節點連接文件。</li><li>在目錄上掛載該循環設備</li></ol><p>具體步驟：</p><pre>dd if=/dev/zero of=file.img bs=1k count=10000 //創建一個初始化文件losetup /dev/loop0 file.img //創建一個循環設備mke2fs -c /dev/loop0 10000 //創建文件系統mkdir /mnt/point1 //創建掛載點mount -t ext2 /dev/loop0 /mnt/point1 //掛載 </pre><p><strong>3.3 文件系統的結構</strong></p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539610078746adc7ed2d3a><p class=pgc-img-caption></p></div><p>用戶空間包含一些應用程序（例如，文件系統的使用者）和 GNU C 庫（glibc），它們為文件系統調用（打開、讀取、寫和關閉）提供用戶接口。系統調用接口的作用就像是交換器，它將系統調用從用戶空間發送到內核空間中的適當端點。</p><p>VFS 是底層文件系統的主要接口，它是 Linux 內核中的一個軟件抽象層。。這個組件導出一組接口，然後將它們抽象到各個文件系統，各個文件系統的行為可能差異很大。有兩個針對文件系統對象的緩存（inode 和 dentry）。它們緩存最近使用過的文件系統對象。因為有 VFS 存在，Linux 允許眾多不同的文件系統共存，並支持跨文件系統的文件操作。它通過一些數據結構及其方法向實際的文件系統如 ext2，vfat 提供接口機制。</p><p>每個文件系統實現（比如 ext2、JFS 等等）導出一組通用接口，供 VFS 使用。緩衝區緩存會緩存文件系統和相關塊設備之間的請求。例如，對底層設備驅動程序的讀寫請求會通過緩衝區緩存來傳遞。這就允許在其中緩存請求，減少訪問物理設備的次數，加快訪問速度。可以使用 sync 命令將緩衝區緩存中的請求發送到存儲媒體（迫使所有未寫的數據發送到設備驅動程序，進而發送到存儲設備）。</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539610078789cdd2c3b966><p class=pgc-img-caption></p></div><p><strong>3.4 VFS （虛擬文件系統）</strong></p><p>Linux 中允許眾多不同的文件系統共存，如 ext2, ext3, vfat 等。通過使用同一套文件 I/O 系統調用即可對 Linux 中的任意文件進行操作而無需考慮其所在的具體文件系統格式；更進一步，對文件的 操作可以跨文件系統而執行。如下圖所示，我們可以使用 cp 命令從 vfat 文件系統格式的硬盤拷貝數據到 ext3 文件系統格式的硬盤；而這樣的操作涉及到兩個不同的文件系統。</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1539610079804fdbaaa8bd9><p class=pgc-img-caption></p></div><p>過程：VFS調用 vfat 的讀文件方法將 a.txt 的數據讀入內存；再將 a.txt 在內存中的數據映射到b.txt對應的內存空間後，VFS調用ext3的寫文件方法將b.txt寫入磁盤；從而實現了最終的跨文件系統的複製操作。</p><p>“一切皆是文件”是 Unix/Linux 的基本哲學之一。不僅普通的文件，目錄、字符設備、塊設備、 套接字等在 Unix/Linux 中都是以文件被對待；它們雖然類型不同，但是對其提供的卻是同一套操作界面。操作文件時需先打開；打開文件時，VFS 會知道該文件對應的文件系統格式；當VFS把控制權傳給實際的文件系統時，實際的文件系統再做出具體區分，對不同的文件類型執行不同的操作。這也就是“一切皆是文件”的根本所在。</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15396100814240235e89bcf><p class=pgc-img-caption></p></div><p>從物理介質讀文件的具體過程：</p><div class=pgc-img><img alt=磁盤、分區及Linux文件系統 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1539610172869902b6070ec><p class=pgc-img-caption></p></div><p>當在用戶應用程序調用文件 I/O read()操作時，系統調用 sys_read() 被激發，sys_read() 找到文件所在的具體文件系統，把控制權傳給該文件系統，最後由具體文件系統與物理介質交互，從介質中讀出數據。</p><p><strong>3.5 Linux 文件系統類型</strong></p><p><strong>3.5.1 ReiserFS</strong></p><p>ReiserFS 是一種文件系統格式。Linux內核從2.4.1版本開始支持ReiserFS。ReiserFS原先是Novell公司的SuSE Linux Enterprise採用的默認文件系統，直到2006年10月12日其宣稱將在未來的版本改採 ext3 為默認。和同樣在 Linux Kernel 2.4 版本下的 ext2 及 ext3 相比較，處理 4KB 以下的小文件時（tail packing enable），ReiserFS 的速度快了 10 到 15 倍<sup>[3]</sup>。但是，有些目錄的操作在 ReiserFS 上面並不同步，（包括像 unlink(2)），可能會導致一些重度依賴文件鎖（file-based lock）機制的應用程序上面數據的毀損。ReiserFS 在一個單一複合B+樹中存儲文件的亞數據信息（stat item）、目錄文件信息（directory items）、索引節點中的塊列表（indirect items），這些信息都有唯一的標識號作為B+樹的索引值。</p><p><strong>3.5.2 ext2 文件系統</strong></p><p>ext2 文件系統（也稱為<em>第二擴展文件系統</em>）旨在克服早期 Linux 版本中使用的 Minix 文件系統的缺點。多年來，該文件系統一直廣泛應用於 Linux。但 ext2 中沒有日誌，現在基本上已被 ext3 和最新的 ext4 所取代。</p><p><strong>3.5.3 ext3 文件系統</strong></p><p>ext3 文件系統向標準 ext2 文件系統添加了日誌功能，因此是一個非常穩定的文件系統的一個演化發展。它在大多數情況下提供合理的性能並且仍舊在改進。由於它在可靠的 ext2 文件系統上添加了日誌功能，因此可以將現有 ext2 文件系統轉換為 ext3 文件系統，並且在必要時還可以轉換回來。</p><p><strong>3.5.4 ext4 文件系統</strong></p><p>ext4 是作為 ext3 的擴展來啟動的，它通過增加存儲限制和提高性能來滿足更大文件系統的需求。為了保留 ext3 的穩定性，在2006 年 6 月，該擴展被拆分成一個新的文件系統，即 ext4。ext4 文件系統在 2008 年 12 月正式發佈，包含在 2.6.28 內核中。</p><p><strong>3.5.5 vfat 文件系統</strong></p><p>vfat 文件系統（也稱為 <em>FAT32</em>）沒有日誌功能，且缺乏完整的 Linux 文件系統實現所需的許多特性。它可用於在 Windows 和 Linux 系統之間交換數據，因為 Windows 和 Linux 都能讀取它。<strong>不要</strong>將這個文件系統用於 Linux，除非要在 Windows 和 Linux 之間共享數據。</p><p><strong>3.5.6 XFS 文件系統</strong></p><p>XFS 文件系統擁有日誌功能，包含一些健壯的特性，並針對可伸縮性進行了優化。XFS 通常是相當快的。在大文件操作方面，XFS 在所有測試中一直處於領先地位。XFS 的性能非常接近 ReiserFS，並在大多數測試指標上都超過了 ext3。</p><p><strong>3.5.7 IBM JFS 文件系統</strong></p><p>IBM 的 <em>Journaled File System (JFS)</em>，目前用於 IBM 企業服務器，專為高吞吐量服務器環境而設計。它可用於 Linux，包含在幾個發行版中。要創建 JFS 文件系統，使用 mkfs.jfs 命令。</p><p><strong>3.6 選擇文件系統</strong></p><p>選擇合適的下一代 Linux 文件系統一直很簡單。那些只尋求原始性能的人通常傾向於使用 ReiserFS，而那些更關心數據完整性特性的人則首選 ext3/4。然而，隨著 XFS 的 Linux 版的發佈，事情突然變得令人困惑。尤其是，對於 ReiserFS 是否依然是下一代文件系統性能方面的佼佼者，人們開始感到疑惑。</p><ul><li>XFS 的性能非常接近 ReiserFS，並在大多數測試指標上都超過了 ext3。</li><li>目前，ReiserFS 和 ext3 刪除文件要比 XFS 快得多。</li></ul><p><strong>3.7 創建文件系統</strong></p><p>Linux 使用 mkfs 命令來創建文件系統，使用 mkswap 命令創建交換空間。mkfs 命令實際上是幾個特定文件系統的命令的前端，比如面向 ext3 的 mkfs.ext3，面向 ext4 的 mkfs.ext4 以及面向 ReiserFS 的 mkfs.reiserfs。你的文件系統上安裝的是什麼文件系統支持？使用 ls /sbin/mk* 命令即可得到答案。</p><p>參考文檔：</p><p>http://djt.qq.com/article/view/620</p><p>http://my.oschina.net/leejun2005/blog/290073</p><p>http://vbird.dic.ksu.edu.tw/linux_basic/0230filesystem.php</p><p>http://www.cnblogs.com/vamei/p/3506566.html</p><p>http://www.ibm.com/developerworks/cn/linux/l-linux-kernel/</p><p>http://www.ibm.com/developerworks/cn/linux/l-cn-vfs/</p><p>http://www.ibm.com/developerworks/cn/linux/filesystem/l-fs9/</p><p>http://zh.wikipedia.org/wiki/ReiserFS</p><pre>來源：https://www.cnblogs.com/sammyliu/p/4521315.html</pre></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>磁盤</a></li><li><a>分區</a></li><li><a>Linux</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/789611b.html alt="Linux 的磁盤系統，和你瞭解的Windows差別很大" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/9529da833a0a4f1c891cd9fc6187e6ef style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/789611b.html title="Linux 的磁盤系統，和你瞭解的Windows差別很大">Linux 的磁盤系統，和你瞭解的Windows差別很大</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/41696f9.html alt="Linux系統 磁盤的基本介紹" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/565977bd-6a76-49e8-a8ca-3d4b08d14539 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/41696f9.html title="Linux系統 磁盤的基本介紹">Linux系統 磁盤的基本介紹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/538d36c.html alt=在Windows和Linux中找出磁盤分區使用的文件系統，就是這麼簡單 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/d5739d381c584297b1708b9f4ccf6c6e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/538d36c.html title=在Windows和Linux中找出磁盤分區使用的文件系統，就是這麼簡單>在Windows和Linux中找出磁盤分區使用的文件系統，就是這麼簡單</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3fdb565.html alt=深入理解Linux磁盤文件系統之inode詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c6b8a86418a147d1a9606329d980b535 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3fdb565.html title=深入理解Linux磁盤文件系統之inode詳解>深入理解Linux磁盤文件系統之inode詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/286d1d05.html alt=Linux怎麼樣編譯c程序文件(編譯最新版ffmpeg為例) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/67e5890abdc3408c9e6e28c61ce6c847 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/286d1d05.html title=Linux怎麼樣編譯c程序文件(編譯最新版ffmpeg為例)>Linux怎麼樣編譯c程序文件(編譯最新版ffmpeg為例)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7e4b1039.html alt=Linux用戶、用戶組與文檔屬性 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/54f39d7a23d64846b3fee43d438f13bb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7e4b1039.html title=Linux用戶、用戶組與文檔屬性>Linux用戶、用戶組與文檔屬性</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bcacd8fd.html alt=Linux系統——用戶、用戶組、權限和文件屬性 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bcacd8fd.html title=Linux系統——用戶、用戶組、權限和文件屬性>Linux系統——用戶、用戶組、權限和文件屬性</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dad48786.html alt=Linux併發服務器模型一、多進程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dad48786.html title=Linux併發服務器模型一、多進程>Linux併發服務器模型一、多進程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e1360dd4.html alt=「Linux」高併發服務器模型（多進程和多線程實例模型） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/170e1596c32348f39d6ace1f327e45d5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e1360dd4.html title=「Linux」高併發服務器模型（多進程和多線程實例模型）>「Linux」高併發服務器模型（多進程和多線程實例模型）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2806cf4d.html alt=嵌入式Linux編程——程序員小白不懂的進程、信號量、併發、互斥 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6fea5f2744614de3884ab26fa09e5a40 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2806cf4d.html title=嵌入式Linux編程——程序員小白不懂的進程、信號量、併發、互斥>嵌入式Linux編程——程序員小白不懂的進程、信號量、併發、互斥</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d3d9f3d8.html alt=搞懂Linux內存管理，僅此一篇 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/0ae3e7cee0234c4cb9cdef0039d2c4d0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d3d9f3d8.html title=搞懂Linux內存管理，僅此一篇>搞懂Linux內存管理，僅此一篇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/838d476c.html alt=Linux內核的整體架構 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a7aaf296a7c14809b8c0ce535a02205d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/838d476c.html title=Linux內核的整體架構>Linux內核的整體架構</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7102c077.html alt=什麼Linux，Linux內核及Linux操作系統，整體架構介紹 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/af09f220163b49399261735b49fe1790 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7102c077.html title=什麼Linux，Linux內核及Linux操作系統，整體架構介紹>什麼Linux，Linux內核及Linux操作系統，整體架構介紹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7e66a0e7.html alt=Linux網絡編程——UDP廣播詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a2667182b3d34b2e98e8503a00af90fd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7e66a0e7.html title=Linux網絡編程——UDP廣播詳解>Linux網絡編程——UDP廣播詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/50fde517.html alt=空調分區系統中幾種空調方式的探討 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3f9887496f8a4a11916bcef355d027f8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/50fde517.html title=空調分區系統中幾種空調方式的探討>空調分區系統中幾種空調方式的探討</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>