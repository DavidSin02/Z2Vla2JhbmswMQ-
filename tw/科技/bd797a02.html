<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>360技術團隊：300行Go代碼玩轉RPC | 极客快訊</title><meta property="og:title" content="360技術團隊：300行Go代碼玩轉RPC - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bd797a02.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bd797a02.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/bd797a02.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bd797a02.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bd797a02.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/bd797a02.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/bd797a02.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/bd797a02.html><meta property="article:published_time" content="2020-10-29T21:09:08+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:08+08:00"><meta name=Keywords content><meta name=description content="360技術團隊：300行Go代碼玩轉RPC"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/bd797a02.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>360技術團隊：300行Go代碼玩轉RPC</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><blockquote><p>在本篇文章中將通過用300行純Golang編寫簡單的RPC框架來解釋RPC。希望能幫助大家梳理RPC相關知識點。</p></blockquote><p>我們通過從頭開始在Golang中構建一個簡單的RPC框架來學習RPC基礎構成。</p><h1><strong>什麼是RPC</strong></h1><p>簡單地說，服務A想調用服務B的函數。但是這兩個服務不在同一個內存空間中。所以不能直接調用它。</p><p>因此，為了實現這個調用，我們需要表達如何調用以及如何通過網絡傳遞通信的語義。</p><p>讓我們考慮一下，當我們可以在相同的內存空間（本地調用）中運行時，我們要怎麼做。</p><pre>type User struct {	Name string	Age int}var userDB = map[int]User{	1: User{"Ankur", 85},	9: User{"Anand", 25},	8: User{"Ankur Anand", 27},}func QueryUser(id int) (User, error) {	if u, ok := userDB[id]; ok {		return u, nil	}	return User{}, fmt.Errorf("id %d not in user db", id)}func main() {	u , err := QueryUser(8)	if err != nil {		fmt.Println(err)		return	}	fmt.Printf("name: %s, age: %d \n", u.Name, u.Age)}</pre><p>現在我們如何在網絡上進行相同的函數調用</p><p>客戶端將通過網絡調用 QueryUser(id int) 函數，並且將有一個服務端提供對該函數的調用，並返回響應 User{"Name", id}, nil。</p><h1><strong>網絡傳輸數據格式</strong></h1><p>我們將採用TLV（定長報頭+變長消息體）編碼方案來規範 tcp 上的數據傳輸。稍後會詳細介紹</p><p>在通過網絡發送數據之前，我們需要定義如何通過網絡發送數據的結構。</p><p>這有助於我們定義一個通用協議，客戶端和服務端都可以理解這個協議。（protobuf IDL定義了服務端和客戶端都能理解的內容）。</p><p>因此，服務端接收到的數據、要調用的函數名和參數列表，或者來自客戶端的數據都需要傳遞這些參數。</p><p>另外，讓我們約定第二個返回值的類型為 error，表示RPC調用結果。</p><pre>// RPC數據傳輸格式type RPCdata struct {	Name string // name of the function	Args []interface{} // request's or response's body expect error.	Err string // Error any executing remote server}</pre><p>現在我們有了一個格式，我們需要序列化它以便我們可以通過網絡發送它。在本例中，我們將使用 go 默認的二進制序列化協議進行編碼和解碼。</p><pre>// be sent over the network.func Encode(data RPCdata) ([]byte, error) {	var buf bytes.Buffer	encoder := gob.NewEncoder(&amp;buf)	if err := encoder.Encode(data); err != nil {		return nil, err	}	return buf.Bytes(), nil}// Decode the binary data into the Go structfunc Decode(b []byte) (RPCdata, error) {	buf := bytes.NewBuffer(b)	decoder := gob.NewDecoder(buf)	var data RPCdata	if err := decoder.Decode(&amp;data); err != nil {		return Data{}, err	}	return data, nil}</pre><h1>網絡傳輸</h1><p>選擇 TLV 協議的原因是由於其非常容易實現，同時也完成了我們需要識別的數據讀取的長度，因為我們需要確定這個請求讀取的字節數的傳入請求流。發送和接收都執行相同的操作。</p><pre>// Transport will use TLV protocoltype Transport struct {	conn net.Conn // Conn is a generic stream-oriented network connection.}// NewTransport creates a Transportfunc NewTransport(conn net.Conn) *Transport {	return &amp;Transport{conn}}// Send TLV data over the networkfunc (t *Transport) Send(data []byte) error {	// we will need 4 more byte then the len of data	// as TLV header is 4bytes and in this header	// we will encode how much byte of data	// we are sending for this request.	buf := make([]byte, 4+len(data))	binary.BigEndian.PutUint32(buf[:4], uint32(len(data)))	copy(buf[4:], data)	_, err := t.conn.Write(buf)	if err != nil {		return err	}	return nil}// Read TLV sent over the wirefunc (t *Transport) Read() ([]byte, error) {	header := make([]byte, 4)	_, err := io.ReadFull(t.conn, header)	if err != nil {		return nil, err	}	dataLen := binary.BigEndian.Uint32(header)	data := make([]byte, dataLen)	_, err = io.ReadFull(t.conn, data)	if err != nil {		return nil, err	}	return data, nil}</pre><p>現在我們已經定義了數據格式和傳輸協議。下面我們還需要RPC服務器和RPC客戶端的實現。</p><h1>RPC函數</h1><p>RPC服務器將接收具有函數名的 RPCData。因此，我們需要維護和映射包含函數名到實際函數映射的函數</p><pre>// RPCServer ...type RPCServer struct {	addr string	funcs map[string] reflect.Value}// Register the name of the function and its entriesfunc (s *RPCServer) Register(fnName string, fFunc interface{}) {	if _,ok := s.funcs[fnName]; ok {		return	}	s.funcs[fnName] = reflect.ValueOf(fFunc)}</pre><p>現在我們已經註冊了 func，當我們收到請求時，我們將檢查函數執行期間傳遞的func的名稱是否存在。然後執行相應的操作</p><pre>// Execute the given function if presentfunc (s *RPCServer) Execute(req RPCdata) RPCdata {	// get method by name	f, ok := s.funcs[req.Name]	if !ok {		// since method is not present		e := fmt.Sprintf("func %s not Registered", req.Name)		log.Println(e)		return RPCdata{Name: req.Name, Args: nil, Err: e}	}	log.Printf("func %s is called\n", req.Name)	// unpackage request arguments	inArgs := make([]reflect.Value, len(req.Args))	for i := range req.Args {		inArgs[i] = reflect.ValueOf(req.Args[i])	}	// invoke requested method	out := f.Call(inArgs)	// now since we have followed the function signature style where last argument will be an error	// so we will pack the response arguments expect error.	resArgs := make([]interface{}, len(out) - 1)	for i := 0; i &lt; len(out) - 1; i ++ {		// Interface returns the constant value stored in v as an interface{}.		resArgs[i] = out[i].Interface()	}	// pack error argument	var er string	if e, ok := out[len(out) - 1].Interface().(error); ok {		// convert the error into error string value		er = e.Error()	}	return RPCdata{Name: req.Name, Args: resArgs, Err: er}}</pre><h1>RPC客戶端</h1><p>由於函數的具體實現在服務器端，客戶端只有函數的原型，所以我們需要調用函數的完整原型，這樣我們才能調用它。</p><pre>func (c *Client) callRPC(rpcName string, fPtr interface{}) {	container := reflect.ValueOf(fPtr).Elem()	f := func(req []reflect.Value) []reflect.Value {		cReqTransport := NewTransport(c.conn)		errorHandler := func(err error) []reflect.Value {			outArgs := make([]reflect.Value, container.Type().NumOut())			for i := 0; i &lt; len(outArgs)-1; i++ {				outArgs[i] = reflect.Zero(container.Type().Out(i))			}			outArgs[len(outArgs)-1] = reflect.ValueOf(&amp;err).Elem()			return outArgs		}		// Process input parameters		inArgs := make([]interface{}, 0, len(req))		for _, arg := range req {			inArgs = append(inArgs, arg.Interface())		}		// ReqRPC		reqRPC := RPCdata{Name: rpcName, Args: inArgs}		b, err := Encode(reqRPC)		if err != nil {			panic(err)		}		err = cReqTransport.Send(b)		if err != nil {			return errorHandler(err)		}		// receive response from server		rsp, err := cReqTransport.Read()		if err != nil { // local network error or decode error			return errorHandler(err)		}		rspDecode, _ := Decode(rsp)		if rspDecode.Err != "" { // remote server error			return errorHandler(errors.New(rspDecode.Err))		}		if len(rspDecode.Args) == 0 {			rspDecode.Args = make([]interface{}, container.Type().NumOut())		}		// unpackage response arguments		numOut := container.Type().NumOut()		outArgs := make([]reflect.Value, numOut)		for i := 0; i &lt; numOut; i++ {			if i != numOut-1 { // unpackage arguments (except error)				if rspDecode.Args[i] == nil { // if argument is nil (gob will ignore "Zero" in transmission), set "Zero" value					outArgs[i] = reflect.Zero(container.Type().Out(i))				} else {					outArgs[i] = reflect.ValueOf(rspDecode.Args[i])				}			} else { // unpackage error argument				outArgs[i] = reflect.Zero(container.Type().Out(i))			}		}		return outArgs	}	container.Set(reflect.MakeFunc(container.Type(), f))}</pre><h1>測試一下我們的框架</h1><pre>package mainimport (	"encoding/gob"	"fmt"	"net")type User struct {	Name string	Age int}var userDB = map[int]User{	1: User{"Ankur", 85},	9: User{"Anand", 25},	8: User{"Ankur Anand", 27},}func QueryUser(id int) (User, error) {	if u, ok := userDB[id]; ok {		return u, nil	}	return User{}, fmt.Errorf("id %d not in user db", id)}func main() {	// new Type needs to be registered	gob.Register(User{})	addr := "localhost:3212"	srv := NewServer(addr)	// start server	srv.Register("QueryUser", QueryUser)	go srv.Run()	// wait for server to start.	time.Sleep(1 * time.Second)	// start client	conn, err := net.Dial("tcp", addr)	if err != nil {		panic(err)	}	cli := NewClient(conn)	var Query func(int) (User, error)	cli.callRPC("QueryUser", &amp;Query)	u, err := Query(1)	if err != nil {		panic(err)	}	fmt.Println(u)	u2, err := Query(8)	if err != nil {		panic(err)	}	fmt.Println(u2)}</pre><p>執行：go run main.go</p><p>輸出內容</p><pre>2019/07/23 20:26:18 func QueryUser is called{Ankur 85}2019/07/23 20:26:18 func QueryUser is called{Ankur Anand 27}</pre><h1>總結</h1><p>致此我們簡單的RPC框架就實現完成了，旨在幫大家理解RPC的原理及上手簡單實踐。</p><blockquote><p><strong>原文來自：</strong>360技術團隊</p><p><strong>關注TechTree，關注互聯網一線大廠技術乾貨。</strong></p></blockquote></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>360</a></li><li><a>技術</a></li><li><a>團隊</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E5%AD%B8/1839a969.html alt=榆社縣人民政府、杭州和百倡公司、科研技術團隊“引進發展食用型植物澱粉空心膠囊合作簽約儀式”舉行 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1538192742063bd63854438 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/1839a969.html title=榆社縣人民政府、杭州和百倡公司、科研技術團隊“引進發展食用型植物澱粉空心膠囊合作簽約儀式”舉行>榆社縣人民政府、杭州和百倡公司、科研技術團隊“引進發展食用型植物澱粉空心膠囊合作簽約儀式”舉行</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/93727dba.html alt="技術帖 | 3分鐘搞定各種測試分析技術" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/f055e0a4477240088de2abb7cd696cfa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/93727dba.html title="技術帖 | 3分鐘搞定各種測試分析技術">技術帖 | 3分鐘搞定各種測試分析技術</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2d0ddee5.html alt=建築房屋結構平衡技術要求，你都會知道嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/5e7d0001715d878ed66c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2d0ddee5.html title=建築房屋結構平衡技術要求，你都會知道嗎？>建築房屋結構平衡技術要求，你都會知道嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/47c8cac0.html alt=新《裝配式混凝土建築技術標準》有哪些改變？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1540524372015dc56ec3fb9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/47c8cac0.html title=新《裝配式混凝土建築技術標準》有哪些改變？>新《裝配式混凝土建築技術標準》有哪些改變？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b6c2fc2b.html alt=鈦合金精密鑄造技術發展現狀 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/SCynkUUBbHN8CF style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b6c2fc2b.html title=鈦合金精密鑄造技術發展現狀>鈦合金精密鑄造技術發展現狀</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/62d46b38.html alt=素描祕籍｜一個耳朵！9大知識點，360度全方位深度剖析講解示範！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/5e7b0005767168b2b87d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/62d46b38.html title=素描祕籍｜一個耳朵！9大知識點，360度全方位深度剖析講解示範！>素描祕籍｜一個耳朵！9大知識點，360度全方位深度剖析講解示範！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d2e8af08.html alt=傾斜航攝技術小知識——航線設計篇 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RS1ucOiDvLRlVt style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d2e8af08.html title=傾斜航攝技術小知識——航線設計篇>傾斜航攝技術小知識——航線設計篇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d597da51.html alt=黃河電力技術公司在龍羊峽進行無人機傾斜攝影測量 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1528429551298e033646798 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d597da51.html title=黃河電力技術公司在龍羊峽進行無人機傾斜攝影測量>黃河電力技術公司在龍羊峽進行無人機傾斜攝影測量</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cdb604f6.html alt=《雷神4：愛與雷》將採用“虛擬製作”技術 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/83a320a69b0f44e3baf7db07faac3c65 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cdb604f6.html title=《雷神4：愛與雷》將採用“虛擬製作”技術>《雷神4：愛與雷》將採用“虛擬製作”技術</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1cd5b6b6.html alt=虛擬現實技術在智能製造領域具有重要的應用價值 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3ed327880d3b4c5384619f21d6c81823 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1cd5b6b6.html title=虛擬現實技術在智能製造領域具有重要的應用價值>虛擬現實技術在智能製造領域具有重要的應用價值</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3a2b0c81.html alt="虛擬製造的基石：數值模擬技術 | 加快實現工業數字化" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/2f2c32f4bd734f9face045546d45a665 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3a2b0c81.html title="虛擬製造的基石：數值模擬技術 | 加快實現工業數字化">虛擬製造的基石：數值模擬技術 | 加快實現工業數字化</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ee69f5ac.html alt=基於機器視覺技術快速準確地確定收穫後幹大豆種子的品質 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/519b968bf69146fda9bf55f89779d373 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ee69f5ac.html title=基於機器視覺技術快速準確地確定收穫後幹大豆種子的品質>基於機器視覺技術快速準確地確定收穫後幹大豆種子的品質</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/17eee2b1.html alt="小蜜團隊萬字長文 | 講透對話管理模型最新研究進展" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/249d781057744bdcb94e007250ac41bc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/17eee2b1.html title="小蜜團隊萬字長文 | 講透對話管理模型最新研究進展">小蜜團隊萬字長文 | 講透對話管理模型最新研究進展</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e203d547.html alt=和你一起的軍訓，下雨也甜蜜｜四川託普信息技術職業學院軍訓記 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4cd61c2a490f48ebb0aa74d30ec8766b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e203d547.html title=和你一起的軍訓，下雨也甜蜜｜四川託普信息技術職業學院軍訓記>和你一起的軍訓，下雨也甜蜜｜四川託普信息技術職業學院軍訓記</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/916c8d26.html alt=鍋爐專業技術問答100條 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/916c8d26.html title=鍋爐專業技術問答100條>鍋爐專業技術問答100條</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>