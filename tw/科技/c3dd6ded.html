<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>深入解析HashMap實現原理 | 极客快訊</title><meta property="og:title" content="深入解析HashMap實現原理 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/49faff220ef84a3787f9b9e0836f857c"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3dd6ded.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3dd6ded.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c3dd6ded.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3dd6ded.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3dd6ded.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c3dd6ded.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c3dd6ded.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3dd6ded.html><meta property="article:published_time" content="2020-10-29T21:09:19+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:19+08:00"><meta name=Keywords content><meta name=description content="深入解析HashMap實現原理"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/c3dd6ded.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>深入解析HashMap實現原理</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p><strong>概述</strong></p><p>HashMap是在JDK1.2中引入的一種K/V對形式的集合類.</p><p>在底層,HashMap通過<strong>數組和單鏈表</strong>組合的結構形式來存儲數據,數組在這作為一個外部結構,數組中的每個節點被稱做Bucket(桶),而<strong>桶是由在單鏈表構成</strong>,JDK1.8之後<strong>為了解決長鏈表下,查詢和插入效率低下的情況,又引入了紅黑樹的作為桶的實現方式</strong>,</p><p>桶中的各節點是由HashMap定義的Node內部類生成的,是普通的鏈表節點類.</p><div class=pgc-img><img alt=深入解析HashMap實現原理 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/49faff220ef84a3787f9b9e0836f857c><p class=pgc-img-caption></p></div><p>注意:<strong>HashMap是線程不安全的,在JDK1.8之前多線程情況下甚至可能會出現環路(後面會講)</strong>,所以多線程狀態下還是要使用ConcurrentHashMap的.</p><p><strong>重點參數</strong></p><p>HashMap的參數不多,除去當做默認屬性的靜態常量和底層數組對象,就只有以下五個</p><pre>transient Node&lt;K,V&gt;[] table;transient int sizetransient int modCount; int threshold;final float loadFactor;</pre><p>table就是整個HashMap的底層數組,<strong>table的初始化並不在構造函數中完成,而是在resize()方法中完成.</strong></p><p>table的初始化可能有點繞,構造函數中最多指定了閾值threshold和負載因子loadFactor並沒有容量相關,但是在resize()方法中<strong>會根據舊容量和舊閾值判斷新容量是等於默認容量,舊閾值或者兩倍舊容量</strong>,最後根據新容量創建新數組</p><p>loadFactor就是所謂的負載因子,默認為0.75,是控制擴容時機的關鍵屬性,因為擴容發生在當前元素個數超過閾值時,而閾值等於當前容量乘以負載因子.</p><p>modCount為修改計數,是fast-fail機制的關鍵參數.在對Map中的元素做新增/刪除操作時會自增,但修改不會(putVal()方法中覆蓋原值)</p><p><strong>新增邏輯</strong></p><ol><li>HashMap的新增過程重點主要還是定位,<strong>如何確定元素在數組中的位置</strong>,HashMap採用的就是<strong>Hash算法</strong>首先HashMap會根據Key的hash值,按照表達式(n - 1) & hash計算出桶的下標</li><li>如果此時桶為空,會創建一個新的Node,作為鏈表的第一個元素,直接存放在數組中.(以前還聽說過什麼鏈表首節點為空的情況,是假的.)</li><li>如果節點存在又會區分樹節點(TreeNode)和普通節點(Node)兩種情況.</li></ol><p>普通節點會直接從首節點往下遍歷找到尾節點,並將帶插入節點添加到末尾</p><p>樹節點會調用,TreeNode的方法插入到樹中.</p><p>另外<strong>新增前會判斷底層數組table是否初始化,新增後會判斷該桶大小是否超過的8,超過則轉化為紅黑樹,再判斷整個數組是否需要擴容.</strong></p><p>Hash同時也叫散列,可以把任意長度的輸入通過算法,換算成固定長度的輸出,不同元素通過Hash算法獲得的下標一致可以被稱之為衝突或者碰撞,Hash算法的要求就是使元素儘量少的發生碰撞,從而均勻的散佈在數組中.而發生碰撞時,像HashMap這種以一個列表下掛的方式可以被稱為拉鍊法.</p><p><strong>查找邏輯</strong></p><p>此處的查找邏輯是指調用get()方法,通過key值查找的情況,如果自己遍歷的另說.</p><ol><li>同樣是根據表達式(n - 1) & hash計算出桶的下標(可以說是相當重要了),若得到的桶為空,直接返回null</li><li>不為空時則會遍歷整個桶,並根據key.equals(k)判斷是否相等</li><li>遍歷的方法也會根據節點類型的不同而不同,但是區分節點前直接存放在數組中的頭結點是要先進行判斷的.感覺上性能影響不大吧</li></ol><p>從查找的過程可以看出,確定桶下標的計算不存在隨機性,時間複雜度就為O(1),具體的性能體現在遍歷這一塊,鏈表查詢的時間複雜度為O(n),所以鏈表越長遍歷時間也就越長,插入和查找的效率也就越低.所以在JDK1.8之後引入的紅黑樹作為桶的另一種實現方法.當鏈表長度大於8時,桶的實現會轉化為紅黑樹.</p><p><strong>HashMap的性能很大一部分取決於Hash算法.</strong>.</p><p><strong>RESIZE邏輯</strong></p><p>通過插入和查找我們可以知道,在數組大小不變的情況下,<strong>鏈表越長或者說樹的高度越高都會導致操作性能降低</strong>,所以此時很有必要通過擴容數組的方式,重新排列桶中元素,降低鏈表長度,減少樹的高度.</p><p>首先,觸發擴容的情況是size > threshold即元素個數大於閾值.整個擴容過程可以簡單的拆分為以下幾步:</p><ol><li>對數組進行擴充,一般情況下是<strong>數組容量和閾值都變為原來的兩倍</strong>,此間會有上限判斷,容量最大為1 &lt;&lt; 30也就是2^30.</li><li>遍歷舊數組,重新判斷元素的位置並散佈到新數組.</li></ol><p>resize()方法中重新散佈元素的方法還是很有意思的(除去單元素鏈表和紅黑樹(桶的容量在1~7之間)</p><p>首先將新數組分為兩部分lo和hi(源碼是loHead和hiHead,我猜是low和high,怎麼縮寫這麼隨意),lo表示0到舊容量大小部分,hi表示餘下算是新加入的部分,並以此創建兩個鏈表的節點</p><p>根據表達式e.hash & oldCap判斷元素是否分佈在lo部分,是就掛到lo鏈表下面,否就掛到hi鏈表下面.</p><p>lo鏈表掛到和舊數組相同位置的桶,而hi則掛到下標為原下標 + 舊數組容量的桶.</p><p>此處的依據就是e.hash & (oldCap - 1) + oldCap == e.hash & (oldCap &lt;&lt; 1) -1</p><p>可以看出resize()方法會調整全部的元素散列情況,因此過於頻繁的resize會降低HashMap的性能,<strong>因此如果一開始可以大概知道所需要存放的元素個數時,儘量直接指定容量大小.</strong></p><p>JDK1.7之前的resize()方法在併發條件下可能會發生閉環問題,但在JDK1.8之後不會在出現,但並不代表HashMap可以在併發條件下使用了,小部分情況還是會出現數據丟失等問題.</p><p><strong>HashMap的懶加載問題</strong></p><p>查看HashMap的源碼，你會發現底層數組table的創建其實並不是在構造函數中完成的，而是resize()方法中,這就是所謂的懶加載,<strong>數組對象並非是在一開始就創建的，而是在第一次插入操作之前完成的。</strong></p><p><strong>關於HashMap一些問題</strong></p><p>擾動函數</p><p>static final int hash(Object key) {</p><p>int h;</p><p>return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);</p><p>}</p><p>擾動函數的邏輯很簡單就是<strong>將hashCode的高16位和低16位異或</strong>.</p><p>擾動函數的作用就是<strong>增加散列的隨機性,使元素能夠更均勻的分佈在數組中,減少衝突從而捎帶提高性能.</strong></p><p>至於為什麼,可以看hash(*)用到的地方,hash(*)被用來計算元素的下標.而下標的計算公式如下</p><pre>tab[i = (n - 1) &amp; hash] // n表示數組的長度</pre><p>因為HashMap的容量一定會是2的次冪,所以減1之後轉化為二進制會變為一串0加一串1的,例如長度為4時,減去1,就會變為000…00011(前面30個0),再結合&可以發現他只使用了hashCode的末尾幾位,高位是全部沒用.</p><p>而經過擾動函數,將高16位和低16位異或之後相當於高低位都用到了,其散列的隨機性也就增加了.</p><p>HashMap的容量為什麼一定要是2的次冪</p><p>容量為2次冪有兩個優點</p><ol><li>在下標運算的時候使用(length - 1) & hash)代替hash % length，相對來說位運算性能更佳，速度更快。</li><li>而在採用(length - 1) & hash的方式計算下標之後，如果不是二次冪的容量，出現碰撞的機率將會大大增加，例如我們取17作為容量((17 -1) => 0001000)，經過&與運算，可以想象會有一大批的元素直接掛在0號桶。</li></ol><p>可以說這是一整套的策略，如果使用hash & length的話，也不用要求容量一定是二次冪，但各方面的性能總是會差一點的。</p><p><strong>HashMap和HashTable的區別</strong></p><ol><li>最大的區別就是HashTable是線程安全的,暴力的加方法級synchronized.而HashMap是線程不安全的,併發情況下可能會出現數據丟失等情況.</li><li>HashTable不允許null值,而HashMap允許null值.(包括key和value)</li><li>HashCode的使用不同,HashTable是直接調用hashCode,而HashMap會經過擾動函數.而且HashMap中用&代替了%</li><li>HashTable數組默認是11,且增長為2n+1,而HashMap默認為16,增長為2n,且硬性要求長度為2的次冪.</li><li>HashTable並不是和HashMap一樣繼承自AbstractMap的,它繼承自一個獨立的父類AbstractDictionary</li><li>還有就是遍歷方法的不同.瞭解不深先不說話.</li></ol><p>作者：孤酒</p><p>鏈接：https://juejin.im/post/5c0cd04de51d451dac076cc9</p><p>來源：掘金</p><p><strong>感謝您的觀看，喜歡的小夥伴可以點個贊！！！專注Java、大數據知識乾貨及相關領域動態分享，請多多關注哦！</strong></p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>HashMap</a></li><li><a>實現</a></li><li><a>解析</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/c78a6fe2.html alt=HashMap的底層實現 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/0f9ffe95e10e4ff5804a8fd9cf591cfc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c78a6fe2.html title=HashMap的底層實現>HashMap的底層實現</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fd0540fa.html alt=解析橋樑設計計算 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/fa4d0bcf2a204a2fac9b37978b1b0713 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fd0540fa.html title=解析橋樑設計計算>解析橋樑設計計算</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f09ac34c.html alt=彩色電子書在廣州率先實現量產 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RkPMb9G6tipobr style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f09ac34c.html title=彩色電子書在廣州率先實現量產>彩色電子書在廣州率先實現量產</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b0fcc3c2.html alt=來看看，什麼是高解析數字音頻！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/153562218779909d30fcdab style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b0fcc3c2.html title=來看看，什麼是高解析數字音頻！>來看看，什麼是高解析數字音頻！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1a2e8d15.html alt=常見數字音頻格式解析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/6c2f000314f485982daf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1a2e8d15.html title=常見數字音頻格式解析>常見數字音頻格式解析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2d12804e.html alt=[玩轉MySQL之九]MySQL實現ACID之原子性 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/bdb044d821f74107a3fd9119fc34c642 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2d12804e.html title=[玩轉MySQL之九]MySQL實現ACID之原子性>[玩轉MySQL之九]MySQL實現ACID之原子性</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html alt="「譯」 Spring 的分佈式事務實現—使用和不使用 XA—第二部分" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fb2bc471.html title="「譯」 Spring 的分佈式事務實現—使用和不使用 XA—第二部分">「譯」 Spring 的分佈式事務實現—使用和不使用 XA—第二部分</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e41fd8de.html alt="撫順各項防汛工作實現“六到位” 確保全市安全度汛" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e41fd8de.html title="撫順各項防汛工作實現“六到位” 確保全市安全度汛">撫順各項防汛工作實現“六到位” 確保全市安全度汛</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f22ee5ad.html alt="Redis 設計與實現 : Lua 腳本" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f22ee5ad.html title="Redis 設計與實現 : Lua 腳本">Redis 設計與實現 : Lua 腳本</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/56e2a065.html alt=這位大叔在隨機的彩票上實現了90%的中獎率 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/50ab0003166decded7e4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/56e2a065.html title=這位大叔在隨機的彩票上實現了90%的中獎率>這位大叔在隨機的彩票上實現了90%的中獎率</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cf633068.html alt="Java 多態的實現機制，看了都說好" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9d3b0e55813d46b4982ae7d9b81d1802 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cf633068.html title="Java 多態的實現機制，看了都說好">Java 多態的實現機制，看了都說好</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d0662f03.html alt="廣西鐵路出海大通道 全面實現電氣化運營" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d0662f03.html title="廣西鐵路出海大通道 全面實現電氣化運營">廣西鐵路出海大通道 全面實現電氣化運營</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2cb59e3c.html alt=瞭解HashMap底層設計思想，教你手寫一個迷你版的HashMap class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d7714f65761648ee9b73a6bd5cca2fcb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2cb59e3c.html title=瞭解HashMap底層設計思想，教你手寫一個迷你版的HashMap>瞭解HashMap底層設計思想，教你手寫一個迷你版的HashMap</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3a5fae7e.html alt=HashMap源碼分析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4852d5083ec340be9f50ded10636e4b0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3a5fae7e.html title=HashMap源碼分析>HashMap源碼分析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b10623ce.html alt=你不得不知道的HashMap面試連環炮 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/278ed0687f4d436f9cb8389a38b1603e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b10623ce.html title=你不得不知道的HashMap面試連環炮>你不得不知道的HashMap面試連環炮</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>