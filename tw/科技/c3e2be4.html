<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Vue created 中的異步請求的影響分析 | 极客快訊</title><meta property="og:title" content="Vue  created 中的異步請求的影響分析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/e6f8e8d25f2146e5a36832b2f195ae61"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c3e2be4.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c3e2be4.html><meta property="article:published_time" content="2020-10-29T20:59:17+08:00"><meta property="article:modified_time" content="2020-10-29T20:59:17+08:00"><meta name=Keywords content><meta name=description content="Vue  created 中的異步請求的影響分析"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/c3e2be4.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Vue created 中的異步請求的影響分析</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h3 class=pgc-h-arrow-right>背景</h3><p>最近接手了別人寫的前端代碼，填了兩個星期的坑了。週四填的這個坑比較有意思，是關於 created 鉤子和異步請求的問題，反覆驗證了一個小時，終於弄清楚了同步請求和異步請求對鉤子執行順序的影響。</p><p>常規思路寫出的代碼，還真看不出問題，但是一運行就有問題，還是值得細究的。</p><h3 class=pgc-h-arrow-right>功能描述</h3><p>有一個管理功能的主頁面，它被拆解成四個子組件：</p><ol start=1><li>ChartsComp：頂部一些統計圖</li><li>SearchComp： 中間條件區域</li><li>BtnComp：中間操作按鈕區域</li><li>DataTableComp：底部數據列表，有一列會根據國家名稱顯示國旗圖片</li></ol><p>主界面 XXXHome 的 created 鉤子裡，會初始化其他組件需要的數據：</p><div class=pgc-img><img alt="Vue  created 中的異步請求的影響分析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e6f8e8d25f2146e5a36832b2f195ae61><p class=pgc-img-caption>主界面 created 定義</p></div><h3 class=pgc-h-arrow-right>子組件中 watch 不到數據變化</h3><p>代碼的前任想把所有的數據都在 Home 頁面獲取到，然後由子組件使用 watch 監聽並使用。第一個問題發生在 getChartData 上，子組件的引用和數據使用如下：</p><div class=pgc-img><img alt="Vue  created 中的異步請求的影響分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/01a8932a5c5949dbba38c52da7d6135d><p class=pgc-img-caption>子組件數據引用</p></div><p>因為數據是在父組件中通過異步請求獲取的，子組件渲染時可能沒有數據，就把繪圖方法放在 watch 中，監聽數據變化後再觸發。</p><h3 class=pgc-h-arrow-right>父子組件的 created 執行順序</h3><p>父子組件的 created 中添加打印信息，執行順序如下：</p><div class=pgc-img><img alt="Vue  created 中的異步請求的影響分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/154fa43e9f22487782059ea15aff4a75><p class=pgc-img-caption>父子組件的 created 執行順序</p></div><p>從測試表現來看，父組件的所有異步請求返回後，子組件的 created 才執行。<strong>即從父到子，順次執行</strong>。此時子組件的那幾個 watch 大多數時候根本監控不到數據變化，因為傳入的時候，異步響應已經返回了，數據非空，所以監聽不到變化。</p><p>但是，如果直接在子組件的 created 調用繪圖方法，又會出現數據不完整的問題，且具有偶發性，這一點由於時間有限、沒有細探。</p><p>最保險的解決方法：在 Home 中添加一個 flag ，所有<strong>依賴異步請求數據的子組件都加一個 v-if 標識</strong>，等待數據回來後修正為真，再渲染子組件 charts v-if="isDataOk"。</p><p>組件拆解，如果僅僅是為了減少主頁面的代碼量，而無其他複用時，比如本文這個 ChartsCmop，就可以將數據請求放在自己的 created 中，不需要依賴父組件傳入，也就不會有這個問題了。</p><h3 class=pgc-h-arrow-right>beforeCreated 和 created 的順序</h3><p>昨天碰到一個問題，測試後發現：如果把 beforeCreated 定義為 async ，它的 await 後的代碼會在 created 執行完成後才執行。感覺有些顛覆官方的介紹，所以著重研究了一下。</p><p>官方說的是先執行 beforeCreate 再執行 created ，那麼 beforeCreate 中的 await 會對這個順序產生什麼影響呢？</p><p>首先，還是這個功能，它的底部數據列表，需要根據國家名稱顯示國旗圖片。前任是在 beforeCreate 中使用 await 操作先獲取到國家和圖片的 base64 信息，再在 created 中獲取 table 數據，代碼是這樣寫的：</p><div class=pgc-img><img alt="Vue  created 中的異步請求的影響分析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1395f8d0537546369292309705fcfe7e><p class=pgc-img-caption>beforeCreate 和 created 定義</p></div><p>其次，這段代碼看起來沒問題，筆者也感覺 beforeCreate 裡面用了 await 同步，應該會先執行完成，再繼續執行 created 方法。結果，運行後的日誌信息卻是這樣：</p><div class=pgc-img><img alt="Vue  created 中的異步請求的影響分析" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e02f2eddf0fa44fd91161eb3958426e4><p class=pgc-img-caption>執行結果</p></div><p>第三，從執行結果來看， beforeCreated 中的 “beforeCreate finished” 是在 created 的代碼執行完成後才打印的。這說明，<strong>在它等待請求響應結果期間，created 方法已經被執行了</strong>。</p><p>這種情況下 this.areas 還是默認的空數組，此時 created 的 getDataTable 方法會獲取 DataTableComp 需要的數據，並完成子組件的渲染：</p><pre><code>&lt;span  :title="scope.row.countryName"&gt;       &lt;el-image :src="getCountryImg(scope.row.countryName)"  class="flagImg"/&gt;       {{ scope.row.countryName}} &lt;/span&gt;</code></pre><p>第四，getCountryImg 使用 countries 時，會引發錯誤。因為它渲染時，會獲取國旗圖片，查找 countryName 對應的信息，如果不存在，就展示第一個元素 contries[0] 的圖片：</p><pre><code>getCountryImg(country) {      for (let i = 0; i &lt; this.contries.length; i += 1) {        const item = this.contries[i];        if (item.nameZh === country) {          return `data:image/jpeg;base64,${item.img64}`;        }      }      return `data:image/jpeg;base64,${this.contries[0].img64}`;    },</code></pre><p>最後，由於 DataTableComp 繪製的時候 beforeCreate 方法還沒有結束，父組件傳遞來的 countries 是空數組，this.contries[0] 為 undefined 而引發異常：</p><div class=pgc-img><img alt="Vue  created 中的異步請求的影響分析" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/54e04b3f15724105b14f1abe753680c8><p class=pgc-img-caption>表面同步引起的異常</p></div><p><strong>解決辦法：添加 isAreaOk 標識</strong>。初始為否，當異步請求回來後設置為真，列表組件依賴該標識 data-table-comp v-if="isAreasOk" ，子組件推遲到依賴解決後再渲染。</p><h3 class=pgc-h-arrow-right>啟示錄</h3><p>本文介紹 Vue 的 created 和 beforeCreate 鉤子執行的兩個知識點：</p><ol start=1><li>父子組件的 created 是順次執行的，<strong>先父後子</strong>，即使父組件的 created 方法中有異步請求，也會等待所有的異步請求結束，才會執行子組件的 created 方法；</li><li>相同組件的 beforeCreate 方法先於 created 方法執行，如果 beforeCreate 中使用await 返回一個 Promise 對象，主流程不會處理，而是繼續執行 created 方法。</li></ol><p>關於第二點，就是說，雖然將 beforeCreate 定義為 async ，但是 Vue 調用時應該沒有 await beforeCreate() ，本質上還是異步邏輯。所以不會等待它真正執行完成，後面的 created 就會繼續執行，它的 await 進入回調函數等待隊列中。</p><p>關於 Vue 開發的一些知識，筆者有一篇萬字文中有詳細介紹，感興趣的朋友可以看看。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Vue</a></li><li><a>created</a></li><li><a>異步</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/a03e8d8.html alt=Vue異步獲取數據之前，模版語法裡的會報錯 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/6a69348a-1928-4d2c-9361-d422d160ca66 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a03e8d8.html title=Vue異步獲取數據之前，模版語法裡的會報錯>Vue異步獲取數據之前，模版語法裡的會報錯</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/365303e.html alt="管理 Vue 應用中的異步調用  vue-asyn-manager" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/7837421e-5bde-40e0-bcc4-4bd94bb40374 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/365303e.html title="管理 Vue 應用中的異步調用  vue-asyn-manager">管理 Vue 應用中的異步調用 vue-asyn-manager</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f9db061d.html alt=三相異步電動機絕緣處理的目的及方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/3c439a15bdf64f1f975914c96a2c66e7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f9db061d.html title=三相異步電動機絕緣處理的目的及方法>三相異步電動機絕緣處理的目的及方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b44410f0.html alt=異步電機典型結構簡述 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/15349080656472f5dd62512 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b44410f0.html title=異步電機典型結構簡述>異步電機典型結構簡述</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c2cb8d92.html alt=繞組5大基本名詞解析與三相異步電動機繞組及其聯接方法介紹 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/56930005e593537411b9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c2cb8d92.html title=繞組5大基本名詞解析與三相異步電動機繞組及其聯接方法介紹>繞組5大基本名詞解析與三相異步電動機繞組及其聯接方法介紹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b3e098cc.html alt=單相異步電機如何轉起來？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/66c6000099c8d7f13f98 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b3e098cc.html title=單相異步電機如何轉起來？>單相異步電機如何轉起來？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/51fefa66.html alt=迄今為止把同步/異步/阻塞/非阻塞講的這麼清楚的好文章 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/28ca13300b9f4d55bd5af3f9156f8874 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/51fefa66.html title=迄今為止把同步/異步/阻塞/非阻塞講的這麼清楚的好文章>迄今為止把同步/異步/阻塞/非阻塞講的這麼清楚的好文章</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/aceede85.html alt="為什麼 Vue 更符合這個時代的大勢所趨？" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/499cce5447e94ce6b81ef7d9cd2179fd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/aceede85.html title="為什麼 Vue 更符合這個時代的大勢所趨？">為什麼 Vue 更符合這個時代的大勢所趨？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/53471e9b.html alt=mysql異步複製與半同步複製的架構原理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/4e7b00019c175cf0ab61 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/53471e9b.html title=mysql異步複製與半同步複製的架構原理>mysql異步複製與半同步複製的架構原理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/48620c40.html alt=三相異步電動機是什麼樣的，來看看分解圖 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/754c280526be4ac3924cb14ab78a9583 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/48620c40.html title=三相異步電動機是什麼樣的，來看看分解圖>三相異步電動機是什麼樣的，來看看分解圖</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/639037be.html alt=如何選擇合適的三相異步電動機 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c221d4d29d8c40bc9afbad0800693a88 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/639037be.html title=如何選擇合適的三相異步電動機>如何選擇合適的三相異步電動機</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b7542fc7.html alt=手把手教你深入Vue3.0(Vue-cli4)項目打包性能優化實踐 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/74bc0f6c-b499-4760-b2fa-fed55f35f7f5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b7542fc7.html title=手把手教你深入Vue3.0(Vue-cli4)項目打包性能優化實踐>手把手教你深入Vue3.0(Vue-cli4)項目打包性能優化實踐</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9c58ef01.html alt=國產星憶高速異步X型隨機存儲芯片XM8A01M16V33A class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c6b2510a37aa4c4bb22ee155cf8e62dd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9c58ef01.html title=國產星憶高速異步X型隨機存儲芯片XM8A01M16V33A>國產星憶高速異步X型隨機存儲芯片XM8A01M16V33A</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5ea91cfd.html alt=手把手教你三相異步電動機啟停控制電路設計 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/6a8a502aeb7347819b6a2aa90538e3a1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5ea91cfd.html title=手把手教你三相異步電動機啟停控制電路設計>手把手教你三相異步電動機啟停控制電路設計</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/cb1a98cc.html alt=異步感應和永磁同步電機對比 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/Ri7APrY8Qzl72r style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/cb1a98cc.html title=異步感應和永磁同步電機對比>異步感應和永磁同步電機對比</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>