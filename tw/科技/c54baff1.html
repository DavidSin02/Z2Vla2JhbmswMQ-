<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Windows訪問令牌竊取攻防技術研究 | 极客快訊</title><meta property="og:title" content="Windows訪問令牌竊取攻防技術研究 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/21e6fbbee849410aaee7391add369084"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c54baff1.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c54baff1.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c54baff1.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c54baff1.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c54baff1.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c54baff1.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c54baff1.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c54baff1.html><meta property="article:published_time" content="2020-11-14T21:00:28+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:28+08:00"><meta name=Keywords content><meta name=description content="Windows訪問令牌竊取攻防技術研究"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/c54baff1.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Windows訪問令牌竊取攻防技術研究</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>（本文轉自安全客）</p><p>在本文中，我們介紹了訪問令牌竊取的相關概念，以及如何在winlogon.exe上利用該技術從管理員上下文中模擬SYSTEM訪問令牌。MITRE ATT&CK將該技術歸為<strong>Access Token Manipulation</strong>（訪問令牌操控）類別。</p><p>如果本地管理員賬戶因為某些組策略（Group Policy）設置無法獲取某些權限，此時模仿SYSTEM訪問令牌是非常有用的一種技術。比如，本地管理員組可能不具備SeDebugPrivilege權限，這樣就能加大攻擊者轉儲憑據或者與其他進程內存交互的難度。然而，管理人員無法從SYSTEM賬戶中撤銷相關權限，因為這是操作系統正常運行的基礎。因此，在加固環境中，SYSTEM訪問令牌對攻擊者而言具有非常高的價值。</p><p>瞭解操控訪問令牌的概念後，我將介紹如何使用系統訪問控制列表（SACL）來審計進程對象，以便檢測惡意操控訪問令牌的攻擊行為。這種檢測技術有一個缺點：防禦方必須清楚哪些進程是攻擊者的目標。</p><p>最後，本文探索了還有哪些SYSTEM進程可以替代winlogon.exe，用來實施訪問令牌模擬攻擊，我也介紹了尋找這些進程的方法以及相關知識點。</p><p>0x01 竊取訪問令牌</p><p><strong>備註：</strong>如果大家對訪問令牌控制技術比較瞭解，想深入瞭解如何尋找其他可用的SYSTEM進程，那麼可以直接跳過這一節。</p><p>我們可以使用如下Windows API來竊取並濫用訪問令牌：OpenProcess()、OpenProcessToken()、ImpersonateLoggedOnUser()、DuplicateTokenEx()以及CreateProcessWithTokenW()。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/21e6fbbee849410aaee7391add369084><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. 使用Windows API竊取訪問令牌</p><p>OpenProcess()以進程標識符（PID）為參數，返回一個進程句柄，打開句柄時必須使用PROCESS_QUERY_INFORMATION、PROCESS_QUERY_LIMITED_INFORMATION或者PROCESS_ALL_ACCESS訪問權限，這樣OpenProcessToken()才能使用返回的進程句柄。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/83617bd7e9254a2d8ca75be9c4d61be8><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. OpenProcess文檔</p><p>OpenProcessToken()以進程句柄及訪問權限標誌作為參數，用來打開訪問令牌所關聯進程的句柄。我們必須使用TOKEN_QUERY以及TOKEN_DUPLICATE訪問權限打開令牌句柄，才能與ImpersonateLoggedOnUser()配合使用。我們也可以只使用TOKEN_DUPLICATE訪問權限打開令牌句柄，與DuplicateTokenEx()配合使用。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/96d3419ea8b449fda8e1f3e286b16d40><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. OpenProcessToken文檔</p><p>利用OpenProcessToken()獲取令牌句柄後，我們可以使用ImpersonatedLoggedOnUser()，使當前進程可以模擬已登錄的另一個用戶。該進程會繼續模擬已登錄的該用戶，直到線程退出或者我們顯示調用RevertToSelf()。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/871cc122d7c444ae997bc94f022caa7d><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. ImpersonateLoggedOnUser文檔</p><p>如果想以另一個用戶身份運行進程，我們必須在OpenProcessToken()返回的令牌句柄上使用DuplicateTokenEx()，創建新的訪問令牌。我們必須使用TOKEN_ADJUST_DEFAULT、TOKEN_ADJUST_SESSIONID、TOKEN_QUERY、TOKEN_DUPLICATE以及TOKEN_ASSIGN_PRIMARY訪問權限來調用DuplicateTokenEx()，才能與CreateProcessWithTokenW()配合使用。DuplicateTokenEx()創建的訪問令牌可以傳入CreateProcessWithTokenW()，通過複製的令牌運行目標進程。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/46449f45896a45b0abc7f8d07b4cb510><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. DuplicateTokenEx文檔</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e8484d1d6f90498e8f0392a0617899ce><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. CreateProcessWithTokenW文檔</p><p>我整理了一些代碼演示令牌操作過程，大部分代碼借鑑了@kondencuotas發表過的一篇文章。</p><p>大家可以訪問此處下載我的測試代碼。</p><p>0x02 利用winlogon.exe提升至SYSTEM權限</p><p>在今年早些時候，Nick Landers介紹了從本地管理員提升到NT AUTHORITY\SYSTEM的一種簡單方法。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f70a4b0ecb4045d88b40cc758a5957c4><p class=pgc-img-caption></p></div><p>在本地管理員（高完整性，high-integrity）上下文中，我們可以從winlogon.exe中竊取訪問令牌，在當前線程中模擬SYSTEM，或者以SYSTEM運行新的進程。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/98097f2410b24ce7a7ce1a55cb904728><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. 從winlogon.exe中竊取SYSTEM令牌</p><p>0x03 檢測技術</p><p>根據官方描述：</p><blockquote>訪問控制列表（ACL）是包含訪問控制項（ACE）的一個列表。ACL中的每個ACE都標識了一個trustee結構，指定與trustee對應的訪問權限（允許、拒絕或者審核）。可保護對象的安全描述符可以包含兩種類型的ACL：DACL以及SACL。</blockquote><p>我們的檢測技術基於SACL（系統訪問控制列表）構建。我們可以在進程對象上設置SACL，在Windows Security Log中記錄成功/失敗的訪問操作。</p><p>我們可以使用James Forshaw開發的NtObjectManager來輕鬆完成這個任務。在下文中，我們大量借鑑了James Forshaw的研究成果，文中提到了如何繞過對LSASS的SACL審計。在這篇文章的幫助下，我深入理解了SACL，也瞭解瞭如何使用NtObjectManager來控制SACL。</p><pre>auditpol /set /category:"Object Access" /success:enable /failure:enable$p = Get-NtProcess -name winlogon.exe -Access GenericAll,AccessSystemSecuritySet-NtSecurityDescriptor $p “S:(AU;SAFA;0x1400;;;WD)” Sacl</pre><p>來逐行分析上述代碼。第一行啟用系統審核功能，記錄成功以及失敗的對象訪問操作。第二行以GenericAll及AccessSystemSecurity訪問權限獲得winlogon.exe進程的句柄。我們需要AccessSystemSecurity權限才能訪問SACL。</p><p>第三行應用ACE類型（AU）審核策略，為來自Everyone（WD）組的成功/失敗（SAFA）訪問生成安全事件。這裡需要注意0x1400，這是對0x400（PROCESS_QUERY_INFORMATION）以及0x1000（PROCESS_QUERY_LIMITED_INFORMATION）進行按位取或（OR）後的結果。這些訪問權限（以及PROCESS_ALL_ACCESS）可以用來從指定進程對象中獲取訪問令牌。</p><p>部署完SACL後，當使用特定訪問權限訪問winlogon.exe時我們應該能看到一些警告信息。</p><p>場景1：PROCESS_QUERY_INFORMATION</p><p>運行測試程序後，可以看到系統會生成EID（Event ID）4656，其中包括所請求的進程對象、發起訪問請求的進程以及所請求的權限。“Access Mask”之所以為0x1400，是因為具備PROCESS_QUERY_INFORMATION訪問權限的句柄也會被自動授予PROCESS_QUERY_LIMITED_INFORMATION訪問權限。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8209d9a2bf0947b6b6850216136084ce><p class=pgc-img-caption></p></div><p>場景2：PROCESS_QUERY_LIMITED_INFORMATION</p><p>我重新編譯了測試程序，只請求PROCESS_QUERY_LIMITED_INFORMATION權限，然後重新運行程序。這次我們可以看到EID 4656事件，其中訪問權限為0x1000，代表PROCESS_QUERY_LIMITED_INFORMATION訪問權限。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c0616867011745369cb13fa01a7d0eb0><p class=pgc-img-caption></p></div><p>此外，我們還可以看到EID 4663，表示我們的測試程序在請求句柄後，會嘗試訪問進程對象。因此，我們能通過搜索EID 4656以及EID 4663，以較高的準確率檢測利用訪問令牌的操作。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6b1557417d46489692e8eab5965a9bdb><p class=pgc-img-caption></p></div><p>場景3：PROCESS_ALL_ACCESS</p><p>重新編譯測試程序，使用PROCESS_ALL_ACCESS訪問權限後，我們能看到與場景2相同的EID，其中在EID 4656中，可以看到有程序在請求其他訪問權限。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/95ce353b141546bd9a8b40308097e8f2><p class=pgc-img-caption></p></div><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/beeaca2f25904998af12885ae2415002><p class=pgc-img-caption></p></div><p>這裡值得注意的是，EID 4663中的“Access Mask”為0x1000，這代表PROCESS_QUERY_LIMITED_INFORMATION訪問權限。此外，當我們使用PROCESS_QUERY_INFORMATION訪問權限運行測試程序時，系統會生成EID 4656，但不會生成EID 4663.</p><p>0x04 尋找其他進程</p><p>除了winlogon.exe之外，我比較好奇是否有其他SYSTEM進程能夠作為令牌竊取的目標。如果存在這種進程，那它們與無法被竊取令牌的其他SYSTEM進程相比有什麼不同？</p><p>驗證猜想</p><p>首先，我想看一下是否有其他進程可以用來竊取SYSTEM令牌。我以運行在高完整性上下文的本地管理員身份暴力枚舉了所有SYSTEM進程（包括svchost.exe），找到了能夠竊取SYSTEM令牌的其他一些進程。這些進程為lsass.exe、OfficeClickToRun.exe、dllhost.exe以及unsecapp.exe。我將這些進程標識為“友好型”進程。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a1dd22638dc64ecfb0119a8884f25aa6><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. 從unsecapp.exe中竊取SYSTEM令牌</p><p>在遍歷SYSTEM進程的過程中，我注意到對有些進程執行OpenProcess()操作時會返回拒絕訪問錯誤（“System Error – Code 5”），導致後續執行失敗。</p><p>對於某些SYSTEM進程，OpenProcess()會執行成功，但執行OpenProcessToken()時會出現拒絕訪問錯誤。後面我將研究一下為什麼會出現這種問題。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/89756abe7fa34255a4e56e0d5cc2198b><p class=pgc-img-caption></p></div><p>澄清原因</p><p>我的目標是找到允許令牌操作的SYSTEM進程在安全設置上存在哪些不同，我決定比較一下winlogon.exe以及spoolsv.exe。這兩個進程都是SYSTEM進程，但我只能從winlogon.exe中竊取SYSTEM訪問令牌。</p><p><strong>Session ID</strong></p><p>我使用Process Explorer打開這兩個進程，嘗試手動探索這兩者之間的不同點。我記得Nick在推特中提到過winlogon.exe的“Session ID”為1，這是最大的不同。</p><p>我將該進程與其他“友好型”進程作比較，發現其他進程的Session ID都為0。不幸的是，這並不是我想尋找的不同點。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6ba467f471bd4e57a6ec0cf3a22f1b76><p class=pgc-img-caption></p></div><p>圖. 比較兩個“友好型”進程的Session ID</p><p><strong>Process Explorer中的高級安全設置</strong></p><p>我決定深入分析winlogon.exe以及spoolsv.exe在高級安全設置（Advanced Security Settings）上的區別。我注意到這兩者在管理員組的高級權限上有所不同。對於winlogon.exe，管理員組具備“Terminate”、“Read Memory”以及“Read Permissions”權限，而spoolsv.exe上的管理員組並不具備這些權限。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d2101e66fa0d425ab854bc0d84d35a35><p class=pgc-img-caption></p></div><p>我試著在spoolsv.exe上應用所有權限，然後嘗試竊取訪問令牌。不幸的是，這種方法並不能彈出SYSTEM命令行窗口。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/85b2ca73cb59460bbd01c43f3c5ae419><p class=pgc-img-caption></p></div><p>我試著再次啟動/停止進程，想看一下進程啟動時能否應用這些權限，同樣以失敗告終。</p><p><strong>Get-ACL</strong></p><p>我決定在PowerShell中使用Get-ACL來觀察winlogon.exe以及spoolsv.exe所對應的安全描述符。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/6dea42065295460c8affb09f5ad33f03><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. winlogon.exe及spoolsv.exe對應的Get-ACL結果</p><p>這兩個進程對應的Owner、Group以及Access似乎完全相同。接下來我決定使用ConvertFrom-SddlString來解析SDDL（Security Descriptor Definition Language，安全描述符定義語言），來分析其中的不同點。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3c6ac7f250b4416e922894fb6f25f673><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. winlogon.exe及spoolsv.exe對應的SDDL</p><p>BUILTIN\Administrators組對應的DiscretionaryAcl似乎相同。這裡我有點無計可施，但還是想最後看一下Process Explorer。</p><p><strong>TokenUser以及TokenOwner</strong></p><p>再次在Process Explorer中觀察高級安全設置，我發現所有“友好型”進程的Owner字段對應的都是本地管理員組。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/989ed61a66ad4376b48e729f97796d4b><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. winlogon.exe及unsecapp.exe對應的TokenOwner字段</p><p>我將這個字段與無法竊取訪問令牌的其他SYSTEM進程作比較，我發現Owner的確是一個不同的因素。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/73d2cc7963d044cdbb86600740866b76><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. spoolsv.exe及svchost.exe的TokenOwner字段</p><p>我的小夥伴（@jaredcatkinson）還提到一點，Process Explorer中的Owner字段實際上對應的是TokenOwner，並且我們可以使用GetTokenInformation()來提取該信息。</p><p>我還在GitHub上找到一個非常方便的PowerShell腳本（Get-Token.ps1），可以用來枚舉所有進程以及線程令牌。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5aa002f3cf5440f3a535f93a369eed5c><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. 利用Get-Token.ps1解析出來的winlogon.exe所對應的令牌對象</p><p>觀察winlogon.exe，我們可以看到UserName以及OwnerName字段的值有所不同。分析該腳本的具體實現，我發現這些字段對應的是TOKEN_USER 以及 TOKEN_OWNER 結構。</p><p>TOKEN_USER結構標識與訪問令牌相關的用戶，TOKEN_OWNER標識利用該訪問令牌創建的進程的所有者。這似乎是允許我們從某些SYSTEM進程中竊取訪問令牌的主要不同點。</p><p>前面提到過，對於某些SYSTEM進程，OpenProcess()可以執行成功，但OpenProcessToken()會返回拒絕訪問錯誤。現在我可以回答這個問題，這是因為我並不是這些進程的TOKEN_OWNER。</p><p>如下一行代碼可以用來解析Get-Token的輸出，尋找UserName為SYSTEM，但OwnerName不為SYSTEM的對象。然後抓取每個對象的ProcessName及ProcessID信息。</p><pre>Get-Token | Where-Object {$_.UserName -eq ‘NT AUTHORITYSYSTEM’ -and $_.OwnerName -ne ‘NT AUTHORITY\SYSTEM’} | Select-Object ProcessName,ProcessID | Format-Table</pre><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1ec095faffdf493e87ce174775a27a13><p class=pgc-img-caption></p></div><p>非常棒，我們應該能夠從這些SYSTEM進程中竊取訪問令牌，模擬SYSTEM訪問令牌。接下來讓我們驗證一下這個猜想。</p><p>我手動遍歷了這個PID列表，發現大多數進程的確能夠用於控制訪問令牌，然而還是存在一些例外進程。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f205460bb8ca4c86825ac81c4407384b><p class=pgc-img-caption></p></div><p class=ql-align-center>圖. 對wininit.exe和csrss.exe執行OpenProcess()時會返回拒絕訪問錯誤</p><p><strong>Protected Process Light</strong></p><p>前面提到過，某些SYSTEM進程在我調用OpenProcess()時，會返回拒絕訪問錯誤，無法竊取令牌。我使用Process Explorer觀察這些進程，發現了可能解釋該行為的一個共同屬性：PsProtectedSignerWinTcb-Light。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/51ee177158fd463cbe0356a768b99128><p class=pgc-img-caption></p></div><p>仔細閱讀Alex Ionescu發表的一篇研究文章以及StackOverflow上的一篇文章，我瞭解到這個Protected屬性與PPL（Protected Process Light）有關。</p><p>如果指定的訪問權限為PROCESS_QUERY_LIMITED_INFORMATION，那麼PPL只允許我們在該進程上調用OpenProcess()。我們的測試程序需要以PROCESS_QUERY_INFORMATION訪問權限來調用OpenProcess()，以便返回的句柄能夠與OpenProcessToken()配合使用，因此這樣就會出現“System Error — Code 5”（拒絕訪問）錯誤。</p><p>在測試檢測機制時，我瞭解到OpenProcessToken()所需的最小訪問權限為PROCESS_QUERY_LIMITED_INFORMATION，這與微軟提供的官方描述有所不同。我修改了調用OpenProcess()期間所需的訪問權限，最終成功拿到了SYSTEM級別的命令提示符。</p><div class=pgc-img><img alt=Windows訪問令牌竊取攻防技術研究 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f450c881e6404175816d9f8fe305f840><p class=pgc-img-caption></p></div><p>0x05 測試結果</p><p>當我們使用PROCESS_QUERY_INFORMATION訪問權限對某些SYSTEM進程調用OpenProcess()時，我們可以成功竊取這些進程的訪問令牌。這些進程包括：</p><pre>dllhost.exelsass.exeOfficeClickToRun.exesvchost.exe（只適用於某些PID）Sysmon64.exeunsecapp.exeVGAuthService.exevmacthlp.exevmtoolsd.exewinlogon.exe</pre><p>對於受PPL保護的某些SYSTEM進程，如果我們以PROCESS_QUERY_LIMITED_INFORMATION訪問權限調用OpenProcess()，還是能夠竊取訪問令牌，這些進程包括：</p><pre>csrss.exeMemory Compression.exeservices.exesmss.exewininit.exe</pre><p>其中有些進程可能與我的Windows開發環境有關，我建議大家在自己的環境中進行測試。</p><p>0x06 總結</p><p>稍微總結一下，我們可以從winlogon.exe中竊取訪問令牌，模擬SYSTEM上下文。在本文中，我深入介紹瞭如何利用SACL以及Windows安全日誌來檢測對訪問令牌的操作行為。</p><p>我也嘗試尋找與winlogon.exe包含相似屬性的其他SYSTEM進程，本文重點介紹了尋找這些進程的方法，最終找到了能夠竊取訪問令牌的其他SYSTEM進程。此外，我還深入研究了為什麼某些進程能夠用於操控訪問令牌，而有些令牌無法完成該任務的具體原因。</p><p>為了從SYSTEM進程中竊取訪問令牌，該進程必須滿足如下條件：</p><ul><li>如果想在某個進程上調用OpenProcessToken()，那麼BUILTIN\Administrator必須為TokenOwner；</li><li>如果SYSTEM進程受PPL（Protected Process Light）保護，那麼我們必須使用PROCESS_QUERY_LIMITED_INFORMATION訪問權限來調用OpenProcess()。</li></ul></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Windows</a></li><li><a>訪問</a></li><li><a>竊取</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/5f1de35c.html alt=使用Windows服務器IIS搭建個人網站 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/94b8a85895c04c9b83d5d35b6b24df9c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5f1de35c.html title=使用Windows服務器IIS搭建個人網站>使用Windows服務器IIS搭建個人網站</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a435b80f.html alt=從操作系統（Windows）的角度討論中斷和異常機制 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/95371ea9a81e4e32b3cf7591d4dbbc83 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a435b80f.html title=從操作系統（Windows）的角度討論中斷和異常機制>從操作系統（Windows）的角度討論中斷和異常機制</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2d4007c7.html alt=“黑客”入門學習之“Windows組策略” class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ea21244d5f5c420ebef29650f3fafd1c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2d4007c7.html title=“黑客”入門學習之“Windows組策略”>“黑客”入門學習之“Windows組策略”</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2f7811ad.html alt=Windows系統下PHP環境手動搭建教程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7647644fbbcc454faf228227806249d0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2f7811ad.html title=Windows系統下PHP環境手動搭建教程>Windows系統下PHP環境手動搭建教程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e46b4ccb.html alt=Npm程序漏洞曝光，允許黑客訪問用戶文件 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/07a4bc313620451d9ca8d505a893206f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e46b4ccb.html title=Npm程序漏洞曝光，允許黑客訪問用戶文件>Npm程序漏洞曝光，允許黑客訪問用戶文件</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/950f36fe.html alt="微軟停止推送Windows 10最新版本，系統自動刪除用戶文件！" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1538963648125e748a59217 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/950f36fe.html title="微軟停止推送Windows 10最新版本，系統自動刪除用戶文件！">微軟停止推送Windows 10最新版本，系統自動刪除用戶文件！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b54ce2e1.html alt="Windows 10 KB4549951補丁讓用戶配置文件缺失故障再次發生" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/Ry0yIZwBOBWLcl style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b54ce2e1.html title="Windows 10 KB4549951補丁讓用戶配置文件缺失故障再次發生">Windows 10 KB4549951補丁讓用戶配置文件缺失故障再次發生</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/72f243aa.html alt="Windows 10用戶再遇問題更新：桌面文件被隱藏 賬戶文件丟失" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RqN4glJ5BHeU8M style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/72f243aa.html title="Windows 10用戶再遇問題更新：桌面文件被隱藏 賬戶文件丟失">Windows 10用戶再遇問題更新：桌面文件被隱藏 賬戶文件丟失</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fc4fc25b.html alt=乾貨分享：Windows目錄結構剖析，C盤目錄常見文件夾都有什麼用？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/7bdef5282c5b416a807d86306d38e184 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fc4fc25b.html title=乾貨分享：Windows目錄結構剖析，C盤目錄常見文件夾都有什麼用？>乾貨分享：Windows目錄結構剖析，C盤目錄常見文件夾都有什麼用？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b3774669.html alt="聯想預裝Windows 8改裝Windows 7的操作步驟及常見問題" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/a6c548d9-0b76-4078-a995-c9ba7887c68a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b3774669.html title="聯想預裝Windows 8改裝Windows 7的操作步驟及常見問題">聯想預裝Windows 8改裝Windows 7的操作步驟及常見問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3c562e25.html alt=SolidWorks只讀與Windows只讀，誰真誰假 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a7dd0e26e30e42ddbc0a3655341257ff style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3c562e25.html title=SolidWorks只讀與Windows只讀，誰真誰假>SolidWorks只讀與Windows只讀，誰真誰假</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/136284b3.html alt="更炫酷！Windows 10多系統菜單花樣玩" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/561860f9419748be98cf31ce2ca0323f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/136284b3.html title="更炫酷！Windows 10多系統菜單花樣玩">更炫酷！Windows 10多系統菜單花樣玩</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/76de484d.html alt=訪問美國航空材料和鍛件生產公司記實及點滴感想 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ff4f21acbc444e9bbbaf237b2c7dab89 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/76de484d.html title=訪問美國航空材料和鍛件生產公司記實及點滴感想>訪問美國航空材料和鍛件生產公司記實及點滴感想</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d7cdf1c8.html alt="「圖」Windows 10十月更新再爆新BUG：Unicode字符無法正確顯示" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/R7HVD0cFums088 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d7cdf1c8.html title="「圖」Windows 10十月更新再爆新BUG：Unicode字符無法正確顯示">「圖」Windows 10十月更新再爆新BUG：Unicode字符無法正確顯示</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8e6555a5.html alt="微軟發佈Windows 10系統全新“開始”菜單" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/S3fdiedEMNXzhV style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8e6555a5.html title="微軟發佈Windows 10系統全新“開始”菜單">微軟發佈Windows 10系統全新“開始”菜單</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>