<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>解密小程序雲原生數據庫的設計與挑戰 | 极客快訊</title><meta property="og:title" content="解密小程序雲原生數據庫的設計與挑戰 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/c253492a3f1b45f3a694e8ea2ff78d7b"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c6730b92.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c6730b92.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c6730b92.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c6730b92.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c6730b92.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c6730b92.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c6730b92.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c6730b92.html><meta property="article:published_time" content="2020-11-14T20:59:33+08:00"><meta property="article:modified_time" content="2020-11-14T20:59:33+08:00"><meta name=Keywords content><meta name=description content="解密小程序雲原生數據庫的設計與挑戰"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/c6730b92.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>解密小程序雲原生數據庫的設計與挑戰</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><strong>導語</strong></p><p>小程序雲開發（Tencent CloudBase）擁有易接入、高性能、高可用等特性，其中雲數據庫作為核心組件之一，可以有效降低運維成本，幫助開發者實現業務快速上線與迭代。本文將簡要介紹如何通過 TEG 雲架構平臺部的高性能分佈式 NoSQL 數據庫，為近百萬小程序雲開發用戶提供完整的原生雲端數據庫能力支持。</p><p><strong>一、背景</strong></p><p>要理解小程序雲開發，不妨將之從字面上拆解為<strong>小程序</strong>和<strong>雲開發</strong>兩個部分。本節部分我們也將嘗試從這兩個方面帶大家一起簡要梳理下相關的背景知識。</p><p><strong>1.1 雲開發</strong></p><p>從軟件工程的角度來看，軟件開發經歷瞭如下三個階段：傳統開發-->敏捷迭代-->serverless。傳統的開發模式和敏捷開發模式除了需要開發者編寫核心的業務邏輯外，都不可避免地需要對後端的基礎設施進行管控和優化。比如，一個應用的邏輯可以很簡單，可一旦涉及到應用的發佈部署，就需要開發者花費大量精力進行服務器、數據庫、網絡等基礎設施的申請和搭建，還要考慮這些後端基礎設施的穩定性、可用性和監控指標。這一切耗時耗力又與產品的核心功能無關，對於需要快速開發和試錯的產品，傳統的模式開發速度慢、部署和運維成本較高。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c253492a3f1b45f3a694e8ea2ff78d7b></div><p>隨著 serverless 概念的火熱，越來越多的開發開始轉向 serverless 架構發展。**“serverless”**並不是指後端沒有服務器，而是將後端服務器及相關運維操作變得對上層應用開發者不可見和透明。用戶無需關心後端的基礎設施，直接通過雲 API 一鍵接入雲函數、雲數據庫和雲存儲來獲取算力、數據庫、存儲等基礎的後端能力。這種隨用隨取的開發模式，不但可以讓開發者能更專注於自身的業務邏輯，還具有低成本、開發速度快以及免運維等諸多優勢。</p><p><strong>1.2 小程序</strong></p><p>小程序應該不用過多介紹，相信現在每一個使用智能手機的人都已經在日常生活中或多或少地使用到了各種各樣的小程序：點餐、外賣、打車、購物等等。為了嚴謹起見，還是按張小龍朋友圈的介紹給出一個簡單的定義：小程序是一種不需要下載安裝即可使用的應用，它實現了應用“觸手可及”的夢想，用戶掃一掃或者搜一下即可打開應用。也體現了“用完即走”的理念，用戶不用關心是否安裝太多應用的問題。應用將無處不在，隨時可用，但又無需安裝卸載。</p><p>自 2017 年 1 月 9 日微信發佈小程序以來（十年前正好是喬布斯發佈首款 iphone，有媒體解讀，這是張小龍的致敬以及野心的表現），小程序在這幾年的發展中已經形成了完整的生態系統，用戶數和小程序數量也有了非常顯著的進步和發展，其他主流互聯網企業也開始紛紛佈局小程序平臺，如支付寶小程序、百度小程序、抖音小程序、今日頭條小程序等等。據微信提供的數據，在 2019 年微信小程序全球交易額達到了 8000 多億，同比增長 160%，日活躍用戶超過 3 億，截至目前，微信上線的小程序超過 100 萬個，擁有超過 150 萬開發者、8200 多個第三方平臺，小程序在電商，零售行業同比去年有爆發式增長。到 2020 年微信公開課 PRO（同樣是 1 月 9 日），全網的小程序數量已經超過 450 萬。可以說，我們已經進入了一個“全民小程序”的時代。</p><p>受到今年新冠疫情的影響，由於小程序開發相較於 app 開發更加輕量和低門檻，同時也能觸達到更多的人群，各種健康碼、申報、信息核實等大部分都採用小程序的形式上線。類似的，線下實體店客流受阻，越來越多的商家和店鋪將自己的銷售轉移到線上來保證疫情期間的現金流，小程序同樣也是這一場景的不二選擇。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/69c0e3b5bae1426eb696974eba0565a4></div><p>越來越多樣化和越來越火爆的小程序也就意味著會有越來越多的小程序開發者入場，如何服務好這些基於小程序生態的開發者們就成為了一件必須要解決的事情。於是<strong>小程序雲開發</strong>問世，可以說<strong>小程序需求 + serverless 理念 = 小程序雲開發</strong>。小程序雲開發以微信作為小程序前端運行的依託，同時又通過接入雲函數、雲數據庫和雲存儲等雲服務，來達到對後端基礎設施的“開箱即用”。這些特性可以在很大程度上解放小程序開發者的生產力，大大降低開發的成本和難度。</p><p><strong>二、競品分析</strong></p><p>事實上，互聯網巨頭們很早就看上了這一塊市場。以 google 為例，自從 2014 年 10 月收購 filebase，google 將自身已有的雲端服務與工具一併整合進 filebase，使之成為專門為 app 開發者提供一站式的<strong>BaaS(Backend as a service</strong>，後端即服務)產品，涵蓋了開發、質量、分析與發展著四個主要的模塊，提供了認證、數據庫、存儲、雲函數、機器學習等服務以及一系列性能和數據分析工具。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0cee68453e9f4a10b1130a59c11f64bc></div><p>如果重點看它的數據庫產品的話，filebase 提供了兩個選項：Cloud Filestore和實時數據庫。雖然他們都是 NoSQL 數據庫,但官方更推薦使用前者，因為它可以提供高性能、良好的可擴展性以及其他更多的高級功能。參考官網的介紹，cloud filestore的主要功能如下：</p><ul><li>靈活性——支持靈活的分層數據結構，文檔型；</li><li>富有表現力的查詢——支持過濾/排序等功能，自動家索引，查詢性能與結果集的大小（而不是整個數據集的大小）成比例；</li><li>實時更新——支持實時數據同步；</li><li>離線支持——緩存離線狀態的寫入、讀取、查詢，待恢復在線時，同步本地更改；</li><li>可擴展涉及——基礎架構支持自動多區域數據複製，強大一致性保證、原子批量操作以及事務支持；</li></ul><p>另外，filestore是支持按量收費的，可支持按數據存儲量、流量以及文檔的讀(query)，寫(insert/update)，刪除(delete)操作次數來收費。並且對外提供了多個客戶端和開發語言版本的 sdk。</p><p>其他為人熟知的 BaaS 產品還有Parse，最早被 Facebook 收編，但沒多久就停止了運行。目前以開源產品的形態運行在 github 上，需要開發者自行下載源碼並部署和維護，已經失去了 BaaS 的意義。</p><p>類似的，國內也有不少提供**一站式後端服務（BaaS）<strong>的產品，包括：LeanCloud，Bmob，willddog野狗雲服務、知曉雲等。騰訊雲推出的小程序雲開發</strong>（Tencent CloudBase，TCB）**也是屬於同一賽道的產品，即採用 serverless 架構的一體化後端雲服務。</p><p><strong>三、需求和挑戰</strong></p><p>那麼，小程序雲開發對於數據庫提出了哪些基本需求？又有哪些挑戰呢？</p><p>我們認為應該主要有以下五個方面的需求：</p><ul><li><strong>安全性</strong>：對於數據庫而言，數據安全是第一位的；</li><li><strong>易用性</strong>：與小程序的特徵類似，“開箱即用，用完即走”，簡單上手，免運維；</li><li><strong>低成本</strong>：按量收費，精細化成本控制；</li><li><strong>高性能</strong>：Nosql，支持高併發讀寫；</li><li><strong>靈活性</strong>：無固定的數據庫表模式(no-schema)，支持彈性伸縮；</li></ul><p>顯而易見，最大的挑戰就是如何利用已有的技術來同時滿足這五個需求並且能在它們其中達成良好的 trade-off。畢竟大多數情況下我們並不是提出了一種新的架構，而是在多種方案和組件之間進行取捨，正如分佈式系統裡大名鼎鼎的 CAP 理論，一致性/可用性/分區容忍性你只能選擇其中的兩個。</p><p>下面將首先介紹我們所使用的架構，然後闡述在這樣的一個架構下有什麼挑戰以及我們所採取的相應對的方案。（並不一定是最優解，讀者可以帶著自己的思考來看待，我們是如何做取捨的）</p><p><strong>四、架構和方案</strong></p><p>圍繞前面提到的 5 個主要需求，我們從架構設計等方面對雲開發數據庫進行了相應的改造及優化，其架構圖如下：</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c43792767d504e33b49ae94e985bad7d></div><p>最上面是小程序的接入客戶端，中間部分是接入層，底層是數據庫的存儲層。當然，還有周邊的管控、告警、備份、元數據管理等模塊。</p><p>開發者通過雲開發提供的 SDK，可以在微信小程序和 qq 小程序中一鍵獲取雲數據庫的登錄態，然後將數據讀寫請求發送給接入層。接入層收到用戶的讀寫請求後，由 keeper 和 agent 這兩個無狀態的模塊對接入的讀寫請求進行相關處理。其中 keeper 主要負責請求的鑑權、認證緩存，以及讀寫請求數的統計，是雲數據庫權限校驗，負載均衡和計費功能實現的核心模塊。agent 模塊主要有以下幾個功能：1）維護接入層到底層數據庫實例的連接池，通過複用已建立的連接來減少請求鑑權和連接創建的耗時；2）統計請求的併發數，對讀寫請求的 QPS 進行平滑處理，避免短時間的毛刺影響數據庫性能和可用性；3）在熱遷移切換數據庫實例時，將請求掛起，切換後再將請求恢復，來實現熱遷移過程對用戶的全程無感知。</p><p>最後，讀寫請求通過了接入層，再接下來會到達存儲層進行數據庫實例的讀寫。鑑於本文的關注點主要集中在數據庫層面，接下來將嘗試從四個方面對其進行描述。為了避免本文篇幅過長，部分內容並不會給出細節實現，只是淺析，感興趣的讀者可以留言或者找我們討論。</p><p><strong>4.1 訪問控制</strong></p><p><strong>權限控制</strong></p><p>首先，用戶只能訪問自己的數據庫，無法訪問其他用戶的數據庫，不同用戶的數據庫之間是相互隔離的，所有連接也必須認證。默認情況下，用戶是擁有數據庫的讀寫權限的，也支持在數據庫上建立多個不同權限的賬戶（比如一個只讀的賬戶）。在小程序雲開發的場景下，利用微信全鏈路<strong>免鑑權</strong>的特性，用戶完全不需要太關心認證相關的問題。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/170174f3fa4247d08186bfce5f1b5267></div><p><strong>連接數控制</strong></p><p>其次是連接數控制方面，我們會分兩層進行控制： 1）在接入層進行客戶端連接控制，根據初始化時實例類型（免費/付費等）進行不同的初始化限制，如果超過限制則提示相應的用戶； 2）接入層到存儲層也有相應的連接數控制，會池化到後端數據庫所有主從節點的鏈接，避免因過多鏈接而導致的數據庫性能問題。</p><p><strong>流量&QPS 控制</strong></p><p>最後是機器層面的出入流量控制以及資源使用限制，原理與連接數控制類似，用戶所有的請求都會經過接入層，因此可以在接入層控制 QPS 進而實現後續的按量付費功能。QPS 超過閾值後可以提示用戶或者在接入層做排隊處理。</p><blockquote><p>這裡有人可能會質疑了，雲開發數據庫不是彈性伸縮的嘛？為何還有 qps 的限制呢？不應該是我 qps 越來越高，後端的數據庫資源也跟著不斷擴容嘛？</p><p>答：是的，默認的配置下會有一定彈性擴展空間，但是會有一個限制。當然，這裡限制具體多少跟產品策略有關。</p></blockquote><p><strong>4.2 數據安全</strong></p><p>數據安全是數據庫最重要的特性之一，畢竟一個存在數據丟失風險的數據庫並不能夠在激烈的市場競爭中存活下來。那麼雲數據庫是如何保證數據安全的呢？</p><p><strong>數據冗餘</strong></p><p>要解決數據不丟失的問題，首先就是要避免數據庫的單點問題，也就是要有數據冗餘。一般而言，工業界認為比較安全的備份數為三份。因此，雲數據庫默認是三副本分佈式存儲，即一份數據會存儲三份放在不同的機器上，同時機器也要分佈在不同的機房中。節點區分主從狀態，主節點可以接受讀寫請求，從節點只能接受讀請求。副本集內的存儲節點之間採用 raft-like 的副本集協議來實現三副本數據的最終一致性。</p><p><strong>高可用</strong></p><p>當機器發生故障時副本集內的數據節點會自動切換（FailOver），從節點變為主節點繼續提供服務，從而把對業務的影響降到最低。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7f6f9ce130fe47db86f8271f3d71eef0></div><p><strong>備份回檔</strong></p><p>雲數據庫的備份對用戶完全透明，後臺根據數據庫的狀態自動選擇性地進行全量以及增量備份。詳細來說就是用戶的寫入越快，後臺的備份頻率也會相應增高，這樣做的目的是為了減少回檔時需要回放的數據，提升回檔性能。</p><p>支持 7 天內任意時間回檔，可以選擇只回檔單個表，進一步減少回檔所需的時間。</p><p>另外，如果節點故障需要新加一個節點到副本集中，可選擇從備份文件中進行恢復，從而減少對源集群的侵入性。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/31f71292d15e4d4eae3e93ab6078d14b></div><p><strong>多可用區容災</strong></p><p>雲數據庫默認跨三機房（AZ, Availability Zone）部署，也對用戶透明，任意一個機房掛掉也不會對服務產生任何影響；同時也可以支持跨多地域，兩地三中心等模式。比如北京、上海、深圳各有一個節點，業務採取就近接入的方式來降低業務訪問雲數據庫的時延。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2dc2d53c59114586b60125434ddc0f45></div><p>另外，所有到數據庫的連接必須認證以及所有數據均加密壓縮存儲，這兩點保證了數據的鏈路安全以及存儲安全。</p><p><strong>4.3 彈性伸縮</strong></p><p><strong>彈性伸縮</strong></p><p>很多時候，業務的訪問模式會呈現很明顯的週期性或者不均勻的特徵，比如外賣類業務的高峰期出現在用餐時段，其他時段訪問較少；遊戲類業務的高峰期出現在晚上或週末，上班時間較少；還有一些電商類業務的高峰期出現在特殊時間點（雙十一，618 等）。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b3d29e06ac6d4ac695533422edf628e3></div><p>如果按照傳統的數據庫運維模式，需要提前預估量級，然後運維執行擴容，等活動結束後再縮容回來（不然成本是個問題）。那麼在小程序的場景，既然要做到用戶對後端服務無感知，那麼資源的擴縮容也應當不被感受到。</p><p>基於這個出發點，我們實現了雲數據庫的彈性伸縮。依賴管控系統的負載監控模塊，我們可以根據數據庫的實時負載情況動態地調整數據庫的資源，並且自動調整敏感度，從而來有效地應對數據庫負載突增的情況，在負載低的時候也可以將資源釋放提供給其他更需要的實例。其次，為了避免單個大查詢引起的頻繁調整，我們設置了滑動窗口和“去毛刺”機制，保證了彈性伸縮儘可能平滑地進行。</p><p><strong>數據庫熱遷移</strong></p><p>當實例狀態發生變更（比如免費-->付費，冷-->熱）的時候，可能會需要進行數據遷移，比如從性能較差的機器遷移到性能較好的機器。有了接入層的配合，我們實現了用戶無感知的數據庫熱遷移，可以在不停服的情況下將用戶的數據從一個數據庫無損遷移到另一個數據庫。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/744212b9a45047768c26e3b93d3dbc82></div><p>整體來看，數據庫熱遷移主要分為三個部分：</p><ol><li>數據同步（Data Sync）</li><li>割接（Cutover）</li><li>狀態變更（Status Change）</li></ol><p>第一階段，高性能數據同步的能力完全由底層數據庫提供支持，需要先同步全量數據，再同步全量階段新產生的操作記錄（operation log），然後不斷循環這個過程，直到源數據庫和目標數據庫的差距非常小，實現方式非常類似於一個副本集內的主從同步。在這一階段中，源數據庫是可讀可寫的。第二階段，也就是當兩邊數據庫的差距非常小時、進行熱遷移的割接過程，將源數據庫變為不可讀不可寫，接入層臨時 hold 住用戶的請求，並不返回錯誤；數據同步這邊，在目標數據庫補齊了所有的操作記錄並且校驗兩邊數據完全一致之後，進行割接，其中包括用戶的拷貝及一系列元數據變更。第三階段，割接完成後，將目標集群變為可用狀態，之前由接入層 block 住的請求可以釋放並繼續執行。由於割接的過程非常迅速（秒級），這些請求並不會返回類似超時之類的失敗。當然這裡只考慮了最一般的情況，當某個環節出現異常時需要考慮到相應部分的回滾和應對邏輯，涉及狀態機的變化，這相對比較複雜，在此不多贅述。</p><p>我們認為數據熱遷移要做到用戶完全無感知，主要有以下幾個難點：</p><ul><li>強一致性感知集群變更；</li><li>高性能割接；</li><li>割接狀態持久化以及超時控制；</li><li>對於用戶請求的臨時處理；</li></ul><p>在我們的架構中，底層數據庫提供了高性能數據同步的基本能力；由於有接入層 agent 的存在，可以很方便地實現 agent 之間的強一致性感知以及對於用戶請求的臨時處理（比如 block 住）；引入了分佈式 KV 存儲系統 etcd 來實現割接狀態的持久化和超時控制，如下圖所示：</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/bc20383928d64dd3856666e5ab2913da></div><p>經過線上環境測試，當數據庫梳理維持在 3k 左右的 QPS（100% write）時，熱遷移成功，從前端看用戶請求在遷移過程中成功率一直維持 100%，也就是做到了熱遷移對用戶的完全透明。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a184c0e1d58f4868b6f4bd7efd7535a6></div><p>我們不妨舉個例子來說明數據庫熱遷移的應用。<strong>微信讀書</strong>業務就使用了小程序雲開發，微信讀書小程序中的“每日一答”模塊完全使用雲數據庫作為底層支撐。“問答 PK”，“每日一答”以及不同類別的題目都分別存儲存在不同的表中，峰值(夜間 0 點左右)QPS 接近 10k，自業務上線以來一直平穩運行。有一段時間我們發現共享資源池內的一個用戶的訪問量有明顯增大的趨勢，彈性伸縮後仍不能完全滿足其需求，為避免其對微信讀書實例產生影響，決定將其整個數據庫實例通過熱遷移的方式移動到我們的熱資源池中。由於數據量並不大（10G），在短短幾分鐘之內就完成了數據的遷移和割接（<strong>秒級</strong>）工作，整個過程對用戶完全透明，當然也沒有對微信讀書實例產生任何影響。</p><p><strong>4.4 智能 DBA</strong></p><p>智能 DBA 是一個非常大的話題，涉及各個方面，分層級來看主要包含以下三層：應用層，處理層和採集層。採集層負責從多個數據源採集需要的數據和指標；處理層對採集到的數據進行預處理和分析併產生相應的決策和建議；應用層則會根據不同的應用場景進行不同的處理，比如自動化運維模塊需要進行異常處理，而巡檢模塊只需要進行巡檢和告警即可。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6664c7ca61cf43b88064bef73b66b0c2></div><p><strong>自動化運維</strong></p><p>為了進一步減少後臺側的運維操作，我們實現了自動化運維平臺。通過對運行時的存儲節點狀態的監控，對每個節點進行探活及故障判斷，然後在決策中心根據故障的統計結果進行相應的自動化運維操作（比如磁盤只讀了則強制切主）同時也會告警給運維人員，確保自動化運維結果正確。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/efa103023a9c4de1af1bd61a32905cde></div><p>對於一部分自動化運維沒辦法覆蓋的問題，我們有各個層面和維度（機器、實例、節點等）全套的<strong>秒級監控</strong>，各項指標共計**69+**項，後端可以實時感知到數據庫的狀態；發現問題儘早處理。</p><p><strong>索引優化</strong></p><p><strong>索引</strong>是數據庫中非常重要的概念，用於加速數據庫的查找。在小程序的場景下，我們希望將用戶對於後端的數據庫的認知降低到越少越好。於是實現了一系列查詢優化的功能，比如<strong>自動建索引</strong>。當我們的接入層和存儲層發現用戶有很多查詢到後端都是全表掃描時，就會根據用戶的 query 具體字段進行對應索引的添加工作。等到索引建立完成，用戶就可以直接享受優化後的查詢結果。<strong>重要的是，這一過程用戶同樣也是無感知的。</strong></p><p>我們認為自動建索引要做到用戶完全無感知需要考慮以下幾個主要問題：</p><ol><li>同步 VS.異步？建索引過程應該是異步的，否則將會阻塞用戶的正常請求。</li><li>如何控制建索引的風險？主要分為兩個方向：1）首先需要控制自動建索引的頻率。建索引是 cpu 消耗型任務，如果數據庫一直處於建索引的過程中很明顯是不可接受的；2）其次需要控制自動建索引的數量，使之在一個相對合理的範圍。對於一般的表不會有問題，但是如果數據庫中的某個表包含多個字段，且用戶會根據這些字段進行不同的查詢，那麼不加限制的索引會導致索引數量特別多，嚴重影響用戶的更新效率（因為更新時除了會更新數據外還會更新相應的索引）。</li><li>索引該如何實現動態更新？用戶的查詢並不是一成不變的，伴隨的業務的發展或者變換，對於同一個表的查詢很有可能也會發生變化。那麼之前自動建立的索引也需要自動刪除，否則長期下去將成為數據庫的負擔和瓶頸。需要根據用戶查詢條件的變化來動態更新已有的索引。這裡關於索引的<strong>最左匹配原則</strong>也值得考慮進來。</li><li>如何做到對用戶透明？不僅僅是建索引時不影響用戶的正常請求，而且需要讓用戶能直接感受到查詢走索引的速度。當表內數據量比較大時，一次索引的變更操作（比如複合索引字段順序的變化）可能會導致用戶的同樣一條查詢存在顯著的耗時差距，除了向用戶解釋外，我們也可以考慮將索引的變更做得更平滑一些，並提供一系列的查詢優化建議。這樣可以幫助用戶更好地使用數據庫。</li></ol><p>自動建索引功能上線後，數據庫實例的請求平均耗時大幅下降，整個小程序雲開發數據庫的大盤的平均耗時也減少了**50%**以上，如下圖所示。</p><div class=pgc-img><img alt=解密小程序雲原生數據庫的設計與挑戰 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/eba25b61c0414ece8e2f3f9698acb14f></div><p>誠然，自動建索引還有一定的侷限性，比如使用不等於和正則匹配等複雜查詢方式時。此時就需要其他方式來處理，比如前臺提示用戶應該如何優化查詢語句；或者根據雲數據庫提供的慢日誌分析工具來分析慢日誌並針對性地給出解決方案。</p><p><strong>五、總結和展望</strong></p><p>小程序雲開發可以大大解放小程序開發者的生產力，降低開發的成本和難度。其中，雲數據庫扮演了舉足輕重的角色。針對小程序雲開發對雲數據庫提出的 5 大需求：<strong>安全性、易用性、低成本、高性能、靈活性</strong>，我們從數據庫架構設計等方面做了諸多改造和優化，使得雲數據庫可以更加貼合小程序的使用場景。</p><p>面向未來，在雲數據庫的管控層我們也將提供更加細粒度的監控（當然，是給我們自己看的，用戶無需關注），更智能的 DBA 和更高效的彈性伸縮能力（比如基於 k8s 的雲數據庫）；在雲數據庫的內核層，我們將封裝更多的底層存儲引擎能力暴露給 API 層，並深度結合小程序的使用場景來進行定製化開發（比如調研發現很多小程序是答題相關的，那麼我們可以提供更優的中文文本索引能力），進一步提升事務的性能等。</p><p>我們有理由相信，雲開發數據庫將在 serverless 理念的指導下不斷完善自己，和小程序一起發展得越來越好。</p><p><strong>參考資料</strong></p><ul><li><strong>Filebase</strong></li><li><strong>Filebase pricing</strong></li><li><strong>Cloud Filestore</strong></li><li><strong>Introducing Cloud Filestore</strong></li><li><strong>rtdv-vs-filestore</strong></li><li><strong>Parse</strong></li><li><strong>LeanCloud</strong></li><li><strong>Bmob</strong></li><li><strong>知曉雲</strong></li><li>雲開發 CloudBase_TCB_移動應用開發_後端雲服務 - 騰訊雲</li></ul><p>作者：phoenixxliu，騰訊 TEG 後臺開發工程師</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>數據庫</a></li><li><a>設計</a></li><li><a>挑戰</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/bdc37b8.html alt=超高速SerDes在芯片設計中的挑戰 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/RUU4VY1U1L48Q style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bdc37b8.html title=超高速SerDes在芯片設計中的挑戰>超高速SerDes在芯片設計中的挑戰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e23a78f.html alt=ECG設計挑戰的應對策略 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/SBBqTdSC52o5lD style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e23a78f.html title=ECG設計挑戰的應對策略>ECG設計挑戰的應對策略</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3050393.html alt=「數據庫設計」三大範式及反範式冗餘字段(人渣系統詳解) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/0edf9ccb276d4a17ab35bd30ad256b7b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3050393.html title=「數據庫設計」三大範式及反範式冗餘字段(人渣系統詳解)>「數據庫設計」三大範式及反範式冗餘字段(人渣系統詳解)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9bd6b239.html alt=鋼構人福利——鋼結構設計經典問題解讀 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a72bd60ea48d471b8ce03ebf0ce15869 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9bd6b239.html title=鋼構人福利——鋼結構設計經典問題解讀>鋼構人福利——鋼結構設計經典問題解讀</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6bbe6ec4.html alt=鋼管混凝土結構設計原理及在強震區橋樑結構研究成果達國際領先 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/153569494612546362474a9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6bbe6ec4.html title=鋼管混凝土結構設計原理及在強震區橋樑結構研究成果達國際領先>鋼管混凝土結構設計原理及在強震區橋樑結構研究成果達國際領先</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6d006e47.html alt=鋼結構設計基礎知識問答 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/63b48928-d7cd-4346-b80f-4f77015517c1 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6d006e47.html title=鋼結構設計基礎知識問答>鋼結構設計基礎知識問答</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0dc64d99.html alt=38個鋼結構設計問題，都很常見 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/f1181ce8-cf01-4194-b9c2-362f43894ddb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0dc64d99.html title=38個鋼結構設計問題，都很常見>38個鋼結構設計問題，都很常見</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b6fd930e.html alt=步步解析橋樑設計計算，不可錯過的一篇乾貨 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d88dd927b4f2474fbe4ea261c2397ba8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b6fd930e.html title=步步解析橋樑設計計算，不可錯過的一篇乾貨>步步解析橋樑設計計算，不可錯過的一篇乾貨</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/97b90000.html alt=結構設計、校對、審核三字經，速速收藏 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/97b90000.html title=結構設計、校對、審核三字經，速速收藏>結構設計、校對、審核三字經，速速收藏</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fd0540fa.html alt=解析橋樑設計計算 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/fa4d0bcf2a204a2fac9b37978b1b0713 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fd0540fa.html title=解析橋樑設計計算>解析橋樑設計計算</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/83530974.html alt=解析橋樑設計計算，不可錯過的一篇乾貨 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/af9ca7f120da4e23b0ca589375e05dd2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/83530974.html title=解析橋樑設計計算，不可錯過的一篇乾貨>解析橋樑設計計算，不可錯過的一篇乾貨</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e8b9b44c.html alt=設計師解析橋樑設計計算，錯過了就沒有機會 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e01645937bda4ae7a7f148666ff89117 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e8b9b44c.html title=設計師解析橋樑設計計算，錯過了就沒有機會>設計師解析橋樑設計計算，錯過了就沒有機會</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/15d8539d.html alt=經典設計延續至今的烏尼莫克403萬能卡車 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/132ba54553374c7eb2c0a9c155bba041 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/15d8539d.html title=經典設計延續至今的烏尼莫克403萬能卡車>經典設計延續至今的烏尼莫克403萬能卡車</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/69536588.html alt=線纜設計初級課程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1532759411210988051a0cb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/69536588.html title=線纜設計初級課程>線纜設計初級課程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/219919c3.html alt=梯度效果的創意Logo設計案例分享（1） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15226471428904df67cc724 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/219919c3.html title=梯度效果的創意Logo設計案例分享（1）>梯度效果的創意Logo設計案例分享（1）</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>