<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>靜態檢查工具的探索之路 | 极客快訊</title><meta property="og:title" content="靜態檢查工具的探索之路 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/868e0a0566c24b569700e069a3a025ee"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c769ab2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c769ab2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c769ab2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c769ab2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c769ab2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c769ab2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c769ab2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c769ab2.html><meta property="article:published_time" content="2020-10-29T20:52:09+08:00"><meta property="article:modified_time" content="2020-10-29T20:52:09+08:00"><meta name=Keywords content><meta name=description content="靜態檢查工具的探索之路"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/c769ab2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>靜態檢查工具的探索之路</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><blockquote><p>TSLint為TypeScript提供了代碼檢查能力，對使用TypeScript的React Native工程，在規範性、安全性、可靠性、可維護性等方面起到重要作用。本文主要對TSLint相關知識進行分享，並對自定義TSLint規則進行介紹。</p></blockquote><p>建立的代碼規範沒人遵守，項目中遍地風格迥異的代碼，你會不會抓狂？</p><p>通過測試用例的程序還會出現Bug，而原因僅僅是自己犯下的低級錯誤，你會不會抓狂？</p><p>某種代碼寫法存在問題導致崩潰時，只能全工程檢查代碼，這需要人工花費大量時間Review代碼，你會不會抓狂？</p><p>以上這些問題，可以通過靜態檢查有效地緩解！</p><p>靜態檢查（Static Program Analysis）主要是以不運行程序的方式對於程序源代碼進行檢查分析的技術，而與之相反的就是動態檢查（Dynamic Program Analysis），通過實際運行程序輸入測試數據產生預期結果的技術。通過代碼靜態檢查，我們可以快速定位代碼的錯誤與缺陷，可以減少逐行閱讀代碼浪費的時間，可以（根據需要）快速掃描代碼中可能存在的漏洞等。代碼靜態檢查可以在代碼的規範性、安全性、可靠性、可維護性等方面起到重要作用。</p><p>在客戶端中，Android可以使用CheckStyle、Lint、Findbugs、PMD等工具，iOS可以使用Clang Static Analyzer、OCLint等工具。而在React Native的開發過程中，針對於JavaScript的ESLint，與TypeScript的TSLint，則成為了主要代碼靜態檢查的工具。本文將按照使用TSLint的原因、使用TSLint的方法、自定義TSLint的步驟進行探究分析。</p><p><strong>一、使用TSLint的原因</strong></p><p>在客戶端團隊進入React Native項目的開發過程中，面臨著如下問題：</p><ol><li class=ql-align-justify>由於大家從客戶端轉入到React Native開發過程中，容易出現低級語法錯誤；</li><li class=ql-align-justify>開發者之前從事Android、iOS、前端等工作，因此代碼風格不同，導致項目代碼風格不統一；</li><li class=ql-align-justify>客戶端效果不一致，有可能Android端顯示正常、iOS端顯示異常，或者相反的情況出現。</li></ol><p>雖然以上問題可以通過多次不斷將雷點標記出，並不斷地分享經驗與強化代碼Review過程等方式來進行緩解，但是仍面臨著React Native開發者掌握的技術水平千差萬別，知識分享傳播的速度緩慢等問題，既導致了開發成本的不斷增加和開發效率持續低下的問題，還難以避免一個坑被踩了多次的情況出現。這時急需一款可以滿足以下目標的工具：</p><ol><li class=ql-align-justify>可檢測代碼低級語法錯誤；</li><li class=ql-align-justify>規範項目代碼風格；</li><li class=ql-align-justify>根據需要可自定義檢查代碼的邏輯；</li><li class=ql-align-justify>工具使用者可以“傻瓜式”的接入部署到開發IDE環境；</li><li class=ql-align-justify>可以快速高效地將檢查工具最新檢查邏輯同步到開發IDE環境中；</li><li class=ql-align-justify>對於檢查出的問題可以快速定位。</li></ol><p>根據上述要求的描述，靜態檢查工具TSLint可以較為有效地達成目標。</p><p><strong>二、TSLint介紹</strong></p><p>TSLint是硅谷企業Palantir的一個項目，它是一款可以檢查TypeScript代碼可讀性、可維護性以及功能性錯誤的靜態檢查工具，當前許多編輯器（Editors）和構建系統（Build Systems）支持這一工具，同時支持自定義編寫Lint規則、配置、格式化等。</p><p>當前TSLint已經包含了上百條規則，這些規則構築了當前TSLint檢查的基礎。在代碼開發階段中，通過這些配置好的規則可以給工程一個完整的檢查，並隨時可以提示出可能存在的問題。本文內容參考了TSLint官方文檔https://palantir.github.io/tslint/。</p><p><strong>2.1 TSLint常見規則</strong></p><p>以下規則主要來源於TSLint規則，是某些規則的簡單介紹。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/868e0a0566c24b569700e069a3a025ee><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p><strong>2.2 常用TSLint規則包</strong></p><p>上述2.1所列出的規則來源於Palantir官方TSLint規則。實際還有多種，可能會用到的有以下：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f4a5132633844c12ba418e3d548df96c><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>我們在項目的規則配置過程中，一般採用上述規則包其中一種或者若干種同時配置，那如何配置呢？請看下文。</p><p><strong>三、如何進行TSLint規則配置與檢查</strong></p><p>首先，在工程package.json文件中配置TSLint包：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2776d45e6ac54afd9e7a0e8bdc2dd4e5><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>在根目錄中的tslint.json文件中可以根據需要配置已有規則，例如：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/9f743185813147a898496c9faa0b44d1><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>其中extends數組內放置繼承的TSLint規則包，上圖包括了airbnb配置的規則包、tslint-react的規則包，而rules用於配置規則的開關。</p><p>TSLint規則目前只有true和false的選項，這導致了結果要麼正常，要麼報錯ERROR，而不會出現WARNING等警告。</p><p>有些時候，雖然配置某些規則開啟，但是某個文件內可能會關閉某些甚至全部規則檢查，這時候可以通過規則註釋來配置，如：</p><pre>/* tslint:disable */</pre><p>上述註釋表示本文件自此註釋所在行開始，以下的所有區域關閉TSLint規則檢查。</p><pre>/* tslint:enable */</pre><p>上述註釋表示本文件自此註釋所在行開始，以下的所有區域開啟TSLint規則檢查。</p><pre>/* tslint:disable:rule1 rule2 rule3... */</pre><p>上述註釋表示本文件自此註釋所在行開始，以下的所有區域關閉規則rule1 rule2 rule3...的檢查。</p><pre>/* tslint:enable:rule1 rule2 rule3... */</pre><p>上述註釋表示本文件自此註釋所在行開始，以下的所有區域開啟規則rule1 rule2 rule3...的檢查。</p><pre>// tslint:disable-next-line</pre><p>上述註釋表示此註釋所在行的下一行關閉TSLint規則檢查。</p><pre>someCode(); // tslint:disable-line</pre><p>上述註釋表示此註釋所在行關閉TSLint規則檢查。</p><pre>// tslint:disable-next-line:rule1 rule2 rule3...</pre><p>上述註釋表示此註釋所在行的下一行關閉規則rule1 rule2 rule3...的檢查檢查。</p><p>以上配置信息，這裡具體參考了https://palantir.github.io/tslint/usage/rule-flags/。</p><p><strong>3.1 本地檢查</strong></p><p>在完成工程配置後，需要下載所需要依賴包，要在工程所在根目錄使用npm install命令完成下載依賴包。</p><p><strong>IDE環境提示</strong></p><p>在完成下載依賴包後，IDE環境可以根據對應配置文件進行提示，可以實時地提示出存在問題代碼的錯誤信息，以VSCode為例：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/4eecbcc9f2564d0a9c9015fb5134cff3><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p><strong>本地命令檢查</strong></p><p>VSCode目前還有繼續完善的空間，如果部分文件未在窗口打開的情況下，可能存在其中錯誤未提示出的情況，這時候，我們可以通過本地命令進行全工程的檢查，在React Native工程的根目錄下，通過以下命令行執行：</p><pre>tslint --project tsconfig.json --config tslint.json</pre><p>（此命令如果不正確運行，可在之前加入./node_modules/.bin/）即為：</p><pre>./node_modules/.bin/tslint --project tsconfig.json --config tslint.json</pre><p>從而會提示出類似以下錯誤的信息：</p><pre>src/Components/test.ts[1, 7]: Class name must be in pascal case</pre><p><strong>3.2 在線CI檢查</strong></p><p>本地進行代碼檢查的過程也會存在被人遺忘的可能性，通過技術的保障，可以避免人為遺忘，作為代碼提交的標準流程，通過CI檢查後再合併代碼，可以有效避免代碼錯誤的問題。CI系統可以為理解為一個雲端的環境，環境配置與本地一致，在這種情況下，可以生成與本地一致的報告，在美團內部可以使用基於Jenkins的Castle CI系統， 生成結果與本地結果一致：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5b14003c13ac4d67bc39b602a77ac0ca><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p><strong>3.3 其他方式</strong></p><p>代碼檢查不止侷限上述階段，在代碼commit、pull request、打包等階段均可觸發。</p><ul><li class=ql-align-justify>代碼commit階段，通過Hook方式可以觸發代碼檢查，可以有效地將在線CI檢查階段強制提前，基本保證了在線CI檢查的完全正確性。</li><li class=ql-align-justify>代碼pull request階段，通過在線CI檢查可以觸發代碼檢查，可以有效保證合入分支尤其是主分支的正確性。</li><li class=ql-align-justify>代碼打包階段，通過在線CI檢查可以觸發代碼檢查，可以有效保證打包代碼的正確性。</li></ul><p><strong>四、自定義編寫TSLint規則</strong></p><p><strong>4.1 為什麼要自定義TSLint規則</strong></p><p>當前的TSLint規則雖然涵蓋了比較普遍問題的一些代碼檢查，但是實踐中還是存在一些問題的：</p><ol><li class=ql-align-justify>團隊中的個性化需求難以滿足。例如，saga中的異步函數需要在最外層加try-catch，且catch塊中需要加異常上報，這個明顯在官方的TSLint規則無法實現，為此需要自定義的開發。</li><li class=ql-align-justify>官方規則的開啟與配置不符合當前團隊情況。</li></ol><p>基於以上原因其他團隊也有自定義TSLint的先例，例如上文提到的tslint-microsoft-contrib、tslint-eslint-rules等。</p><p><strong>4.2 自定義規則步驟</strong></p><p>那自定義TSLint大概需要什麼步驟呢，首先規則文件根據規範進行按部就班的編寫規則信息，然後根據代碼檢查邏輯對語法樹進行分析並編寫邏輯代碼，這也是自定義規則的核心部分了，最後就是自定義規則的使用了。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/11a79ba842014c01aba23ee8149235f9><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>自定義規則的示例直接參考官方的規則是最直接的，我們能這裡參考一個比較簡單的規則"class-name"。</p><p>"class-name"規則上文已經提到，它的意思是對類命名進行規範，當團隊中類相關的命名不規範，會導致項目代碼風格不統一甚至其他出現的問題，而"class-name"規則可以有效解決這個問題。我們可以看下具體的源碼文件：https://github.com/palantir/tslint/blob/master/src/rules/classNameRule.ts。</p><p>然後將分步對此自定義規則進行講解。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1a99f75559594755972aafbadc359bbc><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p><strong>第一步，文件命名</strong></p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e91b8b32099740b683c584094bb6d990><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>規則命名必須是符合以下2個規則：</p><ol><li class=ql-align-justify>駝峰命名。</li><li class=ql-align-justify>以'Rule'為後綴。</li></ol><p><strong>第二步，類命名</strong></p><p>規則的類名是Rule，並且要繼承Lint.Rules.AbstractRule這個類型，當然也可能有繼承TypedRule這個類的時候，但是我們通過閱讀源碼發現，其實它也是繼承自Lint.Rules.AbstractRule這個類。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/de1ddc0d3f6e458d9d8909e01d4c7b44><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p><strong>第三步，填寫metadata信息</strong></p><p>metadata包含了配置參數，定義了規則的信息以及配置規則的定義。</p><ul><li class=ql-align-justify>ruleName 是規則名，使用烤串命名法，一般是將類名轉為烤串命名格式。</li><li class=ql-align-justify>description 一個簡短的規則說明。</li><li class=ql-align-justify>descriptionDetails 詳細的規則說明。</li><li class=ql-align-justify>rationale 理論基礎。</li><li class=ql-align-justify>options 配置參數形式，如果沒有可以配置為null。</li><li class=ql-align-justify>optionExamples 參數範例 ，如沒有參數無需配置。</li><li class=ql-align-justify>typescriptOnly true/false 是否只適用於TypeScript。</li><li class=ql-align-justify>hasFix true/false 是否帶有修復方式。</li><li class=ql-align-justify>requiresTypeInfo 是否需要類型信息。</li><li class=ql-align-justify>optionsDescrition options的介紹。</li><li class=ql-align-justify>type 規則的類型。</li></ul><p>規則類型有四種，分別為："functionality"、"maintainability"、"style"、"typescript"。</p><ul><li class=ql-align-justify>functionality ： 針對於語句問題以及功能問題。</li><li class=ql-align-justify>maintainability：主要以代碼簡潔、可讀、可維護為目標的規則。</li><li class=ql-align-justify>style：以維護代碼風格基本統一的規則。</li><li class=ql-align-justify>typescript：針對於TypeScript進行提示。</li></ul><p><strong>第四步，定義錯誤提示信息</strong></p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2184280623314a199faac1f254fc081e><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>這個主要是在檢查出問題的時候進行提示的文字，並不侷限於使用一個靜態變量的形式，但是大部分官方規則都是這麼編寫，這裡對此進行介紹，防止引起歧義。</p><p><strong>第五步，實現apply方法</strong></p><p>apply主要是進行靜態檢查的核心方法，通過返回applyWithFunction方法或者返回applyWithWalker來進行代碼檢查，其實applyWithFunction方法與applyWithWalker方法的主要區別在於applyWithWalker可以通過IWalker實現一個自定義的IWalker類，區別如下：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f035fa59a3564e7b8c3aacae62cd5c1b><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>其中實現IWalker的抽象類AbstractWalker裡面也繼承了WalkContext，</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/17bff4e40a534209a736c6fdafee2877><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>而這個WalkContext就是上面提到的applyWithFunction的內部實現類。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/805d974b606c420887674ddb7dd3147f><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p><strong>第六步，語法樹解析</strong></p><p>無論是applyWithFunction方法還是applyWithWalker方法中的IWalker實現都傳入了sourceFile這個參數，這個相當於文件的根節點，然後通過ts.forEachChild方法遍歷整個語法樹節點。</p><p>這裡有兩個查看AST語法樹的工具：</p><ul><li class=ql-align-justify>AST Explorer：</li><li class=ql-align-justify>https://astexplorer.net/</li><li class=ql-align-justify>對應源碼：</li><li class=ql-align-justify>https://github.com/fkling/astexplorer</li><li class=ql-align-justify>TypeScript AST Viewer：</li><li class=ql-align-justify>https://ts-ast-viewer.com/</li><li class=ql-align-justify>對應源碼：</li><li class=ql-align-justify>https://github.com/dsherret/ts-ast-viewer</li></ul><p><strong>AST Explorer</strong></p><p><strong>優點：</strong></p><p>在AST Explorer可以高亮顯示所選中代碼對應的AST語法樹信息。</p><p><strong>缺點：</strong></p><p class=ql-align-justify>1. 不能選擇對應版本的解析器，導致顯示的語法樹代碼版本固定。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4b22e4484a2e46eca72af247e7623fb9><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify>2. 語法樹顯示的信息相對較少。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/fae47e39fa784c58b0341141888c2eb8><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p><strong>TypeScript AST Viewer</strong></p><p><strong>優點：</strong></p><p class=ql-align-justify>1. 解析器對應版本可以動態選擇：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ab33c3a8c3fe40b1bfa643d464e6e1b9><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p class=ql-align-justify>2. 語法樹顯示的信息不僅顯示對應的數字代碼，還可為對應的實際信息：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5b123ac00c594f2d9673f3abcc2906a4><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>每個版本對應對kind信息數值可能會變動，但是對應的枚舉名字是固定的，如下圖：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/358d70744d9a4ad6a98250ad998e041c><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>從而這個工具可以避免頻繁根據其數值查找對應信息。</p><p><strong>缺點：</strong>不能高亮顯示代碼對應的AST語法樹區域，定位效率較低。</p><p>綜上，通過同時使用上述兩個工具定位分析，可以有效地提高分析效率。</p><p><strong>第七步，規則代碼編寫</strong></p><p>通過ts.forEachChild方法對於語法樹所有的節點進行遍歷，在遍歷的方法裡可以實現自己的邏輯，其中節點的類為ts.Node：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/7f6747a8104c4b00bf39d797fda00a5b><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>其中kind為當前節點的類型，當然Node是所有節點的基類，它的實現還包括Statement、Expression、Declaration等，回到開頭這個"class-name"規則，我們的所有聲明類主要是class與interface關鍵字，分別對應ClassExpression、ClassDeclaration、InterfaceDeclaration，</p><p>我們可以通過上步提到的AST語法樹工具，在語法樹中看到其為一一對應的。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c358f6fb9deb427a8edc85c16eb8c245><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>在規則代碼中主要通過isClassLikeDeclaration、isInterfaceDeclaration這兩個方法進行判斷的。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/49a86873961e45b897f7b0e61914dcfa><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>其中isClassLikeDeclaration、isInterfaceDeclaration對應的方法我們可以在node.js文件中找到：</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/66a4da11fe1142ae9a917b0fac33e82d><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/e7d42b091d1e4c8e8c6c3314c79d90e1><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>判斷是對應的類型時，調用addFailureAtNode方法把錯誤信息和節點傳入，當然還可以調用addFailureAt、addFailure方法。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6df7054fb63f4acea403d36b321e8be1><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>最終這個規則編寫結束了，有一點再次強調下，因為每個版本所對應的類型代碼可能不相同，當判斷kind的時候，一定不要直接使用各個類型對應的數字。</p><p><strong>第八步，規則配置使用</strong></p><p>完成規則代碼後，是ts後綴的文件，而ts規則文件實際還是要用js文件，這時候我們需要用命令將ts轉化為js文件：</p><pre>tsc ./src/*.ts --outDir dist</pre><p>將ts規則生成到dist文件夾（這個文件夾命名用戶自定），然後在tslint.json文件中配置生成的規則文件即可。</p><p class=ql-align-center><br></p><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7ee271ad47d149cb9b4f5cc9c98de377><p class=pgc-img-caption></p></div><p class=ql-align-center><br></p><p>之後在項目的根目錄裡面，使用以下命令既可進行檢查：</p><pre>tslint --project tsconfig.json --config tslint.json</pre><p>同時為了未來新增規則以及規則配置的更好的操作性，建議可以封裝到自己的規則包，以便與規則的管理與傳播。</p><p><strong>總結</strong></p><p><strong>TSLint的優點：</strong></p><ol><li class=ql-align-justify>速度快。相對於動態代碼檢查，檢查速度較快，現有項目無論是在本地檢查，還是在CI檢查，對於由十餘個頁面組成的React Native工程，可以在1到2分鐘內完成；</li><li class=ql-align-justify>靈活。通過配置規則，可以有效地避免常見代碼錯誤與潛在的Bug；</li><li class=ql-align-justify>易擴展。通過編寫配置自定義規則，可以及時準確快速查找出代碼中特定風險點。</li></ol><p><strong>TSLint缺點：</strong></p><ol><li class=ql-align-justify>規則的結果只有對與錯兩種等級結果，沒有警告等級的的提示結果；</li><li class=ql-align-justify>無法直接報告規則報錯數量，只能依賴其他手段統計；</li><li class=ql-align-justify>TSLint規則針對於當前單一文件可以有效地通過語法樹進行分析判定，但對於引用到的其他文件中的變量、類、方法等，則難以通過AST語法樹進行判定。</li></ol><p><strong>使用結果及分析</strong></p><p>在美團，有十餘個頁面的單個工程首次接入TSLint後，檢查出的問題有近百條。但是由於開啟的規則不同，配置規則包的差異，檢查後的數量可能為幾十條到幾千條甚至更多。現在已開發十餘條自定義規則，在單個工程內，處理優化了數百處可能存在問題的代碼。最終TSLint接入了相關React Native開發團隊，成為了代碼提交階段的必要步驟。</p><p>通過團隊內部的驗證，文章開頭遇到的問題得到了有效地緩解，目標基本達到預期。TSLint在React Native開發過程中既保證了代碼風格的統一，又保證了React Native開發人員的開發質量，避免了許多低級錯誤，有效地節省了問題排查和人員溝通的成本。</p><p>同時利用自定義規則，能夠將一些兼容性問題在內的個性化問題進行總結與預防，提高了開發效率，不用花費大量時間查找問題代碼，又避免了在一個問題上跌倒多次的情況出現。對於不同經驗的開發者而言，不僅可以進行友好的提示，也可以幫助快速地定位問題，將一個人遇到的經驗教訓，用極低的成本擴散到其他團隊之中，將開發狀態從“亡羊補牢”進化到“防患未然”。</p><p><strong>作者簡介</strong></p><p>家正，美團點評Android高級工程師。2017 年加入美團點評，負責美團大交通的業務開發。</p><blockquote><p>歡迎加入<strong>美團Web前端技術交流群</strong>，跟項目維護者零距離交流。進群方式：請加美美同學微信（<strong>微信號：MTDPtech02</strong>），回覆：<strong>前端</strong>，美美會自動拉你進群。</p></blockquote><div class=pgc-img><img alt=靜態檢查工具的探索之路 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/73632f9f78be4b84a17bc9e358626a5c><p class=pgc-img-caption>微信掃碼關注，閱讀更多技術乾貨</p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>靜態</a></li><li><a>檢查</a></li><li><a>探索</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/941f9ac.html alt=二手車的靜態檢查，有你不知道的細節 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d5e376f452104913b2f24e4d785083ce style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/941f9ac.html title=二手車的靜態檢查，有你不知道的細節>二手車的靜態檢查，有你不知道的細節</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/461b111.html alt="靜態代碼檢查工具 cppcheck 的使用" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1538901071395e87caa8c61 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/461b111.html title="靜態代碼檢查工具 cppcheck 的使用">靜態代碼檢查工具 cppcheck 的使用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e39c08d7.html alt=動態網站和靜態網站有什麼區別 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6a06f21d115b4b93a7934a7075691503 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e39c08d7.html title=動態網站和靜態網站有什麼區別>動態網站和靜態網站有什麼區別</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d4d77858.html alt=動、靜態扭矩在汽車裝配緊固件中的應用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/21327d489e004cc7bcd527476b85fe20 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d4d77858.html title=動、靜態扭矩在汽車裝配緊固件中的應用>動、靜態扭矩在汽車裝配緊固件中的應用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cb1f350d.html alt=【導軌滑塊】如何檢查和判斷ina直線導軌 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ead1f085dd9c44d2a01502b994ceea24 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cb1f350d.html title=【導軌滑塊】如何檢查和判斷ina直線導軌>【導軌滑塊】如何檢查和判斷ina直線導軌</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/11187004.html alt=軸承運轉的檢查項目及故障處理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e23ae493b21a4693b8e7f8d45c62a64a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/11187004.html title=軸承運轉的檢查項目及故障處理>軸承運轉的檢查項目及故障處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7b5beaea.html alt=鋼製文件櫃如何檢查好壞呢 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b57b5acd6b81406d8aefd619a1e8424e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7b5beaea.html title=鋼製文件櫃如何檢查好壞呢>鋼製文件櫃如何檢查好壞呢</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a116f6c4.html alt=如何檢查配電房安全隱患？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/2a90d53bb2eb43d19a3252b9c3f66134 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a116f6c4.html title=如何檢查配電房安全隱患？>如何檢查配電房安全隱患？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/77ca2959.html alt=核磁共振檢查過程中的溫度監控的光纖溫度傳感器 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/5fed372969ee47d4b87523f282d80d7a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/77ca2959.html title=核磁共振檢查過程中的溫度監控的光纖溫度傳感器>核磁共振檢查過程中的溫度監控的光纖溫度傳感器</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a0762932.html alt=液壓油缸日常檢查內容分享 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e8708306de6e47dab31a23c4a38ab2f9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a0762932.html title=液壓油缸日常檢查內容分享>液壓油缸日常檢查內容分享</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cd8731e7.html alt=報警閥組與報警閥檢查總結 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cd8731e7.html title=報警閥組與報警閥檢查總結>報警閥組與報警閥檢查總結</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d2beb44d.html alt=溼式報警閥組件安裝、檢查、檢測、調試及故障分析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a027833f8ae24c738984ebeba3fc5668 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d2beb44d.html title=溼式報警閥組件安裝、檢查、檢測、調試及故障分析>溼式報警閥組件安裝、檢查、檢測、調試及故障分析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/504824bb.html alt=動/靜態測評福特銳界：銷量下滑真因分析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4b668e90219f4f64b68c2340ecec2e96 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/504824bb.html title=動/靜態測評福特銳界：銷量下滑真因分析>動/靜態測評福特銳界：銷量下滑真因分析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dc721d71.html alt=單例模式VS靜態方法：你應該何去何從？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/b3079753ad7344f68a7837c3bdd3e666 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dc721d71.html title=單例模式VS靜態方法：你應該何去何從？>單例模式VS靜態方法：你應該何去何從？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/550e74eb.html alt=精品資源：共點力中的“靜態平衡”問題 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/dcba441875164a9cb4ba9fb600913828 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/550e74eb.html title=精品資源：共點力中的“靜態平衡”問題>精品資源：共點力中的“靜態平衡”問題</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>