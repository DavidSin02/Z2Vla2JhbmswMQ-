<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>ç•°æ­¥ç·¨ç¨‹æå‡æœå‹™æ€§èƒ½ | æå®¢å¿«è¨Š</title><meta property="og:title" content="ç•°æ­¥ç·¨ç¨‹æå‡æœå‹™æ€§èƒ½ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/15260210063976700d35c2d"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/c81ec36.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/c81ec36.html><meta property="article:published_time" content="2020-10-29T20:50:33+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:33+08:00"><meta name=Keywords content><meta name=description content="ç•°æ­¥ç·¨ç¨‹æå‡æœå‹™æ€§èƒ½"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/c81ec36.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>ç•°æ­¥ç·¨ç¨‹æå‡æœå‹™æ€§èƒ½</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p>é¾å¤§è¤‡é›œçš„ç³»çµ±é€šå¸¸æœƒæ¡ç”¨æœå‹™åŒ–çµ„ä»¶ä¾†å¯¦ç¾ã€‚ç³»çµ±è¶Šè¤‡é›œï¼Œçµ„ä»¶ä¹‹é–“çš„ä¾è³´å’Œèª¿ç”¨é—œä¿‚ä¹Ÿæœƒè¶Šè¤‡é›œã€‚å°æ–¼è™•æ–¼åº•å±¤çš„åŸºç¤æœå‹™ï¼Œç›´æ¥å’Œé–“æ¥çš„èª¿ç”¨æ‰€å¸¶ä¾†çš„æµé‡å£“åŠ›éå¸¸å¤§ã€‚è™•æ–¼ä¸­é–“å±¤çš„èšåˆå‹æœå‹™ï¼Œé¢å°çš„æŒ‘æˆ°å‰‡æ˜¯ä¾è³´çš„æœå‹™å¤ªå¤šï¼Œå¾Œç«¯å€‹åˆ¥æœå‹™çš„æ€§èƒ½å»¶é²å°±æœƒå½±éŸ¿å…¶ååé‡ã€‚æ€§èƒ½å„ªåŒ–æ˜¯æˆ‘å€‘ç³»çµ±ç©©å®šæ€§ä¸­çš„é‡è¦ä¸€ç’°ï¼Œé€™å…¶ä¸­ï¼Œèª¿ç”¨æ‰€ä¾è³´çš„RPCæœå‹™æˆ–å¾Œç«¯æ•¸æ“šæ˜¯é‡é»ä¹‹ä¸€ã€‚</p><p>ç›®å‰ï¼Œé™¤äº†å‚³çµ±JDBCé€™æ¨£å¾APIåˆ°ä¸»æµé©…å‹•å¯¦ç¾å°±æ˜¯é˜»å¡å¼çš„é¡åº«ä¹‹å¤–ï¼Œå…¶ä»–å¸¸ç”¨çš„RPC/HTTPæœå‹™ã€MQã€Redisã€Mongodbã€Kafkaç­‰ç³»çµ±éƒ½æä¾›äº†æˆç†Ÿçš„åŸºæ–¼NIOçš„å®¢æˆ¶ç«¯åº«ï¼Œä¹Ÿæœ‰ç›¸æ‡‰çš„ç•°æ­¥APIã€‚</p><p>ä½†æ˜¯ç›®å‰äº¤æ˜“å¹³è‡ºçš„å¤§å¤šæ•¸ä¸­è‡ºæœå‹™ç³»çµ±ï¼Œé‚„åœ¨ç¿’æ…£æ€§ä½¿ç”¨è‘—é€™äº›åº«çš„åŒæ­¥APIï¼Œä¸¦ä¸èƒ½å……åˆ†çš„åˆ©ç”¨CPUï¼Œé€™ä¹Ÿçµ¦æˆ‘å€‘å¸¶ä¾†äº†ä¸€å®šçš„å„ªåŒ–ç©ºé–“ã€‚å¾16å¹´é–‹å§‹æˆ‘å€‘åœ¨ä¸€äº›æ ¸å¿ƒçš„ä½†æ˜¯æœå‹™é‚è¼¯ç›¸å°ç°¡å–®çš„ç³»çµ±ä¸­ä½¿ç”¨ç•°æ­¥æ–¹å¼ä¾†å¯¦ç¾ï¼Œé›–ç„¶æš«æ™‚é‚„åšä¸åˆ°å®Œå…¨çš„ç•°æ­¥åŒ–ï¼Œä½†æ˜¯ä¹Ÿå–å¾—äº†æ¯”è¼ƒå¥½çš„æ•ˆæœã€‚é€™ç¯‡æ–‡ç« é›–ç„¶æ›´å¤šæ˜¯ä¸€å€‹ç°¡ä»‹æ€§è³ªï¼Œä½†æ˜¯ä¹Ÿæ¶µè“‹äº†æˆ‘å€‘åœ¨ç•°æ­¥ç·¨ç¨‹ä¸­éœ€è¦é—œæ³¨çš„è¦é»ã€‚å¸Œæœ›å¤§å®¶èƒ½å¤ ç¿’æ…£å’Œæ“æŠ±ç•°æ­¥ç·¨ç¨‹ã€‚</p><p><strong>ä¸€ã€ç›¸é—œæ¦‚å¿µä»‹ç´¹</strong></p><p>åŒæ­¥(Synchronous)/ç•°æ­¥(Asynchronous)ï¼Œé€šå¸¸æ˜¯æŒ‡å‡½æ•¸èª¿ç”¨ä¸­çš„æ¶ˆæ¯é€šä¿¡çš„å…©ç¨®ä¸åŒæ¨¡å¼ã€‚</p><p><strong>1ã€ç•°æ­¥å’ŒåŒæ­¥çš„å€åˆ¥</strong></p><p>å‡½æ•¸èª¿ç”¨ç™¼ç”Ÿæ™‚ï¼Œæ¶ˆæ¯(åƒæ•¸)å¾callerå‚³éåˆ°calleeï¼Œæ§åˆ¶æ¬Š(æŒ‡ä»¤åŸ·è¡Œ)å¾callerè½‰ç§»åˆ°calleeã€‚èª¿ç”¨è¿”å›æ™‚ï¼Œæ§åˆ¶æ¬Šå¾calleeè½‰ç§»åˆ°callerã€‚å…©è€…çš„å€åˆ¥åœ¨æ–¼ï¼Œcalleeæ˜¯å¦éœ€è¦ç­‰å¾…åŸ·è¡Œå®Œæˆæ‰å°‡æ§åˆ¶æ¬Šè½‰ç§»çµ¦callerã€‚</p><p>åœ¨RPCé€™ç¨®æ›´å¾©é›œçš„å ´æ™¯ä¸‹ï¼Œæœ¬è³ªä¸Šä¸¦æ²’æœ‰ä¸åŒã€‚</p><p>â—† åŒæ­¥</p><p><img alt=ç•°æ­¥ç·¨ç¨‹æå‡æœå‹™æ€§èƒ½ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15260210063976700d35c2d></p><p>1.calleeåŸ·è¡Œå®Œæˆæ‰è¿”å›</p><p>2.è¿”å›å€¼å³çµæœ</p><p>â—† ç•°æ­¥</p><p><img alt=ç•°æ­¥ç·¨ç¨‹æå‡æœå‹™æ€§èƒ½ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1526021006860927b1feca3></p><p>1.calleeä¸éœ€è¦åŸ·è¡Œå®Œæˆå°±å¯è¿”å›</p><p>2.callerè¦ç²å–çµæœï¼Œéœ€è¦é€šéè¼ªè©¢ã€å›èª¿ç­‰æ©Ÿåˆ¶</p><p>â—† åŒæ­¥RPC</p><p><img alt=ç•°æ­¥ç·¨ç¨‹æå‡æœå‹™æ€§èƒ½ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/15260210065070b97e26186></p><p>â—† ç•°æ­¥RPC</p><p><img alt=ç•°æ­¥ç·¨ç¨‹æå‡æœå‹™æ€§èƒ½ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/152602100651271869c2752></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç•°æ­¥RPCçš„å ´æ™¯ä¸‹ï¼Œå®¢æˆ¶ç«¯å’Œæœå‹™ç«¯ç”¨æ–¼è™•ç†IOçš„CPUèƒ½å¾—åˆ°å……åˆ†åˆ©ç”¨ï¼Œé€šå¸¸åªéœ€è¦é ä½æ–¼callerè«‹æ±‚æ•¸é‡çš„ç·šç¨‹å°±å¯ä»¥äº†ï¼Œé€™å°±æ˜¯å¤šè·¯è¤‡ç”¨ã€‚</p><p><strong>2ã€calleeåŸ·è¡Œæ©Ÿåˆ¶</strong></p><p>ä¸Šåœ–ä¸­calleeçš„background executeé€šå¸¸æ˜¯æ¡ç”¨æ± åŒ–ç·šç¨‹ä¾†å®Œæˆçš„ï¼Œæ¯”å¦‚ThreadPoolExecutoræˆ–EventLoop1ã€‚</p><p><strong>3ã€callerç²å–åŸ·è¡Œçµæœ</strong></p><p>callerèª¿ç”¨calleeæ™‚ï¼Œå¦‚æœéœ€è¦ç²å–åŸ·è¡Œçµæœï¼ˆæ¶ˆæ¯é›™å‘å‚³éï¼‰ï¼Œæˆ–è€…ç²çŸ¥åŸ·è¡Œæ˜¯å¦å®Œæˆï¼ˆæ¶ˆæ¯å–®å‘å‚³éç„¡è¿”å›å€¼ï¼‰ï¼Œåœ¨ç•°æ­¥æ¨¡å¼ä¸‹ï¼Œä¸»è¦ä¾é ä¸‹é¢å…©ç¨®æ©Ÿåˆ¶ã€‚</p><p>â—† è¼ªè©¢(Polling)</p><p>æ¯”å¦‚Javaçš„Futureå°±æä¾›äº†isDone()é€™ç¨®è©¢å•æ©Ÿåˆ¶ã€‚</p><pre>1.//Caller.java2.void call() {3. Future&lt;Void&gt; f = callee.asyncCall(param);4. // do some other things5. while(true) {6. if (f.isDone()) break;7. //do some other things or sleep or timeout8. }9.}</pre><p>æˆ–é˜»å¡ç‰ˆæœ¬</p><pre>1.//Caller.java2.void call() {3. Future&lt;Void&gt; f = callee.asyncCall(param);4. // do some other things5. f.get(timeout, TimeUnit.SECONDS);6.}</pre><p>è¼ªè©¢çš„æ§åˆ¶é‚è¼¯åœ¨callerç«¯ã€‚</p><p>â—† å›èª¿(Callback)</p><p>callerè¨­ç½®ä¸€å€‹å›èª¿å‡½æ•¸ï¼Œä¾›calleeåŸ·è¡Œå®Œæˆå¾Œèª¿ç”¨é€™å€‹å‡½æ•¸ã€‚å›èª¿çš„æ§åˆ¶æ˜¯åè½‰çš„ï¼Œé€šå¸¸ç”±calleeç«¯æ§åˆ¶ã€‚</p><pre>1.//Caller.java2.void call() {3. callee.asyncCall(param, new AsyncHandler&lt;Response&lt;Message&gt;&gt;() {4. @Override public void handleResponse(Response&lt;Message&gt; response) {5. msg = response.get();6. // process the msg...7. }8. });9. // do some other things10.}</pre><p><strong>4ã€ç•°æ­¥æ¨¡å¼çš„å ´æ™¯</strong></p><p>â—† é˜»å¡</p><p>é˜»å¡(Blocking)/éé˜»å¡(Non-Blocking)æ˜¯ç”¨ä¾†æè¿°ï¼Œåœ¨ç­‰å¾…èª¿ç”¨çµæœæ™‚callerç·šç¨‹çš„ç‹€æ…‹ã€‚é˜»å¡ï¼Œé€šå¸¸æ„å‘³è‘—callerç·šç¨‹ä¸å†ä½¿ç”¨CPUæ™‚é–“ï¼Œè™•æ–¼å¯è¢«OSèª¿åº¦çš„ç‹€æ…‹(æ³¨æ„èˆ‡Javaç·šç¨‹ç‹€æ…‹2çš„å€åˆ¥)ã€‚ ç£ç›¤IOå’Œç¶²çµ¡IOæ˜¯å¸¸è¦‹çš„æœƒå¼•èµ·ç·šç¨‹é˜»å¡çš„å ´æ™¯3ã€‚å—åˆ¶æ–¼åº•å±¤OSçš„åŒæ­¥é˜»å¡å¼IOç³»çµ±å‡½æ•¸ï¼Œèª¿ç”¨Java OIO(Old blocking IO) APIç„¡ç–‘æ˜¯æœƒé˜»å¡çš„ã€‚å°æ–¼DiskIOï¼ŒJava NIO2æä¾›äº†ç•°æ­¥APIã€‚å°æ–¼SocketIOï¼ŒJava NIO2ä»¥åŠNIOæ¡†æ¶Nettyï¼Œéƒ½æä¾›äº†ç•°æ­¥APIã€‚</p><blockquote><p>â—† Linuxæä¾›äº†ç•°æ­¥IOç³»çµ±å‡½æ•¸ï¼Œåªèƒ½ç”¨æ–¼DiskIOï¼Œé‚„æœ‰ä¸€äº›é™åˆ¶4ï¼ŒJava NIO2 AsynchronousFileChannelå…§éƒ¨ä»ç„¶ä½¿ç”¨ç·šç¨‹æ± +é˜»å¡å¼APIçš„å¯¦ç¾ã€‚</p><p>â—† Linuxç‚ºSocketIOæº–å‚™å°±ç·’éšæ®µæä¾›äº†éé˜»å¡å¼API(select/poll/epoll)ï¼Œä½†æ˜¯IOåŸ·è¡Œéšæ®µä»ç„¶æ˜¯åŒæ­¥é˜»å¡çš„ï¼Œå› æ­¤ä¸»æµçš„Java NIOæ¡†æ¶çš„Reactoræ¨¡å¼å…§éƒ¨å¯¦ç¾ä½¿ç”¨äº†ç·šç¨‹æ± ã€‚</p></blockquote><p>â—† ä¸¦è¡Œ</p><p>æ¯”å¦‚éœ€è¦èª¿ç”¨å¤šå€‹æ²’æœ‰ä¾è³´é—œä¿‚çš„æœå‹™ï¼Œæˆ–è€…è¨ªå•åˆ†æ•£åœ¨å¤šå€‹å­˜å„²åˆ†ç‰‡ä¸­çš„æ•¸æ“šï¼Œå¦‚æœæœå‹™æ¥å£æˆ–æ•¸æ“šè¨ªå•æ¥å£å¯¦ç¾äº†ç•°æ­¥APIï¼Œé‚£éº¼å°±å¾ˆæ–¹ä¾¿å¯¦ç¾ä¸¦è¡Œèª¿ç”¨ï¼Œæ¸›å°‘ç¸½é«”èª¿ç”¨è€—æ™‚ã€‚</p><p>â—† é€Ÿåº¦ä¸åŒ¹é…</p><p>ä½¿ç”¨ä¸­é–“éšŠåˆ—è§£å¶callerå’Œcalleeçš„é€Ÿåº¦ä¸åŒ¹é…å•é¡Œï¼Œå‰Šå³°å¡«è°·ã€‚</p><p>â—† æ‰¹é‡</p><p>ä½¿ç”¨ä¸­é–“éšŠåˆ—è§£å¶callerå’Œcalleeçš„é€Ÿåº¦ä¸åŒ¹é…å•é¡Œï¼Œå‰Šå³°å¡«è°·ã€‚</p><p><strong>äºŒã€ç•°æ­¥APIçš„å¹¾ç¨®é¢¨æ ¼</strong></p><p><strong>1ã€Callback</strong></p><p>é€™å€‹æ¯”è¼ƒå‚³çµ±ï¼Œæ¯”å¦‚zookeeperå®¢æˆ¶ç«¯æä¾›çš„åŸºæ–¼å›èª¿çš„ç•°æ­¥API:</p><pre>1.try {2. zookeeper.create(path, data, acl, createMode, new StringCallback() {3. public void processResult(int rc, String path, Object ctx, String name) {4. if (rc != KeeperException.Code.OK.intValue()) {5. // error handle6. } else {7. // success process8. // å¦‚æœéœ€è¦åœ¨æˆåŠŸå¾Œå†ç™¼èµ·åŸºæ–¼å›èª¿çš„ç•°æ­¥èª¿ç”¨ï¼Œæœƒå½¢æˆcallback hell9. }10. }11. }, ctx);12.} catch( Throwable e) {13. // error handle</pre><blockquote><p>â—† Callbacké€šå¸¸æ˜¯ç„¡ç‹€æ…‹çš„</p><p>â—† è¦ç²å–Callbackçš„è¨ˆç®—çµæœï¼Œé€šå¸¸éœ€è¦closure</p><p>â—† ç•°å¸¸è™•ç†æ¯”è¼ƒåˆ†æ•£</p><p>â—† åœ¨æœ‰å¤šå€‹ç•°æ­¥èª¿ç”¨éˆçš„æ™‚å€™ï¼Œå®¹æ˜“é€ æˆCallback hell</p></blockquote><p><strong>2ã€Future/Promise</strong></p><p>Promiseæ˜¯calleeçµ¦callerçš„æ†‘è­‰ï¼Œä»£è¡¨æœªå®Œæˆä½†æ‰¿è«¾å®Œæˆï¼ˆæˆåŠŸæˆ–å¤±æ•—ï¼‰çš„çµæœã€‚Promiseæœ¬èº«æ˜¯æœ‰ç‹€æ…‹çš„ï¼Œé€šå¸¸ç”±calleeç«¯ç¶­è­·ã€‚å…¶ç‹€æ…‹è½‰ç§»å¦‚ä¸‹ï¼ˆè¡“èªåƒè€ƒPromise/A+å’ŒES6ï¼‰ï¼š</p><blockquote><p>Promiseçš„ç‹€æ…‹åªèƒ½è½‰ç§»ä¸€æ¬¡ï¼Œå› æ­¤å¦‚æœæœ‰callbackï¼Œé‚£éº¼.then(callback)æˆ–.catch(callback)ä¹Ÿåªè¢«åŸ·è¡Œä¸€æ¬¡ã€‚</p></blockquote><p>JDK5çš„Futureåªèƒ½ç”¨è¼ªè©¢æˆ–è€…é˜»å¡çš„æ–¹å¼ç²å–çµæœï¼Œcallerç«¯è™•ç†æ¯”è¼ƒç¹ç‘£ã€‚Guavaçš„ListenableFutureï¼Œç‰¹åˆ¥æ˜¯JDK8çš„CompletableFutureï¼Œå‰‡æ˜¯å®Œæ•´å¯¦ç¾äº†Promiseé¢¨æ ¼çš„ç•°æ­¥APIã€‚ å€‹äººèªç‚ºPromiseæ˜¯æ›´å¥½çš„Callbackï¼ŒListenableFutureæ¥å£åªæ˜¯æ¯”Futureå¤šäº†ä¸€å€‹void addListener(Runnable, Executor)æ–¹æ³•ã€‚ Promiseæä¾›äº†æ¯”Callbackæ›´æ˜“ç”¨æ›´æ¸…æ™°çš„ç·¨ç¨‹æ¨¡å¼ï¼Œå°¤å…¶æ˜¯æ¶‰åŠå¤šå€‹ç•°æ­¥APIçš„ä¸²è¡Œèª¿ç”¨ï¼ˆchainingæˆ–pipelining )ã€çµ„åˆèª¿ç”¨ï¼ˆä¸¦è¡Œã€åˆä½µï¼‰ã€ç•°å¸¸è™•ç†ç­‰æ–¹é¢æœ‰å¾ˆå¤§çš„å„ªå‹¢ã€‚</p><blockquote><p><strong>å¼•ç”³é–±è®€</strong></p><p>â—† é€™ç¯‡æ–‡ç« è«‡åˆ°äº†Futureå’ŒPromiseçš„ç´°å¾®å€åˆ¥ã€ç›¸é—œæ­·å²å’ŒæŠ€è¡“ã€‚</p><p>â—† é€™è£¡æœ‰ä¸€äº›è¨è«–ï¼šArenâ€™t promises just callbacks?,Is there really a fundamental difference between callbacks and Promises?ã€‚</p><p>â—† Promiseå€Ÿé‘‘äº†å‡½æ•¸å¼ä¸­çš„ä¸€äº›æ¦‚å¿µ: å¾å‡½æ•¸å¼ç·¨ç¨‹åˆ°Promiseã€‚</p><p>â—† é€™ç¯‡æ–‡ç« ç°¡è¦å°æ¯”äº†å¹¾ç¨®èªè¨€ä¸­çš„Promiseæ¡†æ¶ã€‚</p></blockquote><p><strong>3ã€ReactiveX</strong></p><p>å…¶å®˜æ–¹ç¶²ç«™çš„ä»‹ç´¹</p><blockquote><p>An API for asynchronous programming with observable streams</p></blockquote><p>å…¶é—œéµçš„æ¦‚å¿µObservableæ¯”è¼ƒPromiseä¾†èªªï¼š</p><p>â—† Promiseä»£è¡¨ä¸€å€‹ç•°æ­¥è¨ˆç®—å€¼ï¼Œè€ŒObservableä»£è¡¨è‘—ä¸€ç³»åˆ—å€¼(stream)ã€‚</p><p>â—† Promiseçš„å€¼åªèƒ½ç”¢ç”Ÿä¸€æ¬¡ï¼Œè€ŒObservableçš„äº‹ä»¶å¯ä»¥ä¸æ–·ç”¢ç”Ÿã€‚å› æ­¤Rxé¦–å…ˆæµè¡Œåœ¨å‰ç«¯UIå ´æ™¯ï¼šäº‹ä»¶ä¾†æºå¤šï¼Œæ•¸æ“šè®ŠåŒ–å½±éŸ¿å¤šå€‹UIçµ„ä»¶çš„è®Šæ›´ã€‚</p><p>Rxçš„å­¸ç¿’æ›²ç·šæ¯”Promiseè¦é«˜å¾—å¤šï¼Œè€Œä¸”ç›®å‰Promiseé¢¨æ ¼çš„ç•°æ­¥ç·¨ç¨‹èƒ½å¤ æ»¿è¶³æˆ‘å€‘å¤§éƒ¨åˆ†çš„æœå‹™ç«¯é–‹ç™¼å ´æ™¯ï¼Œå› æ­¤æˆ‘å€‘é€™è£¡ä¸»è¦é—œæ³¨Promiseã€‚</p><p><strong>ä¸‰ã€Promiseåœ¨æœå‹™ç«¯çš„æ‡‰ç”¨</strong></p><p>ä¸‹é¢ç©¿æ’è‘—ä»¥JDK8çš„CompletableFutureå’ŒGuavaçš„ListenableFutureï¼ˆé©ç”¨JDK6ï¼‰ç‚ºä¾‹ä»‹ç´¹Promiseçš„ç”¨æ³•ã€‚</p><p><strong>1ã€ç¬¦åˆPromiseé¢¨æ ¼çš„æ–¹æ³•ç°½å</strong></p><p>Promiseé¢¨æ ¼çš„æ–¹æ³•ç°½åï¼Œæœ‰å€‹ä¸æˆæ–‡çš„è¦å‰‡æ˜¯ä¸æ‹‹å‡ºç•°å¸¸ï¼Œå› ç‚ºç•°å¸¸æ˜¯Promiseå°è±¡æœ¬èº«å°±èƒ½æ”œå¸¶çš„å…©ç¨®ç‹€æ…‹ä¹‹ä¸€ã€‚æ¯”å¦‚æˆ‘å€‘æƒ³æŠŠä¸€å€‹Callbacké¢¨æ ¼çš„ç•°æ­¥APIåŒ…è£æˆPromiseé¢¨æ ¼çš„ï¼ˆé€šå¸¸åœ¨ä½¿ç”¨ä¸€å€‹è¼ƒè€çš„é¡åº«æ™‚éœ€è¦é€™æ¨£çš„åŒ…è£ï¼‰ï¼Œå¯ä»¥é€™æ¨£ï¼š</p><pre>1.//caller.java2.CompletableFuture&lt;String&gt; asyncCall(final String msg) {3. CompletableFuture&lt;String&gt; promise = new CompletableFuture&lt;&gt;();4. try {5. callee.asyncCall(msg, new Callback&lt;String&gt;() {6. public void onSuccess(String r) { promise.complete(r); }7. public void onFail(Throwable t) { promise.completeExceptionally(t); }8. });9. } catch (Throwable e) {10. promise.completeExceptionally(t);11. }12. return promise;13.}</pre><p>ä¸‹é¢æ˜¯ä½¿ç”¨ListenableFutureçš„å¯¦ç¾ç•°æ­¥ç™¼é€æ¶ˆæ¯çš„APIã€‚</p><pre>1.//LocalMessageEngine.java2.static class WriteTask {3. // SettableFutureæ˜¯Guavaä¸­ä¸€ç¨®å¯è¨­ç½®ç‹€æ…‹çš„Promiseé¡å‹ã€‚4. final SettableFuture&lt;Boolean&gt; promise = SettableFuture.create();5. final byte[] message;6. WriteTask(byte[] message) {7. this.message = message;8. }9.}10.public Producer createProducer() {11. return new Producer() {12. public ListenableFuture&lt;Boolean&gt; asyncProduce(byte[] message) {13. if (!Engine.this.started) {14. // è¿”å›å‰å·²å®Œæˆ15. return Futures.immediateFailedFuture(new IllegalStateException("Message engine was stopped or not started"));16. }17.18. WriteTask task = new WriteTask(message);19. boolean queued = writeTaskQueue.offer(task);20. if (!queued) {21. task.promise.set(Boolean.FALSE);22. }23. return task.promise;24. }25. };26.}</pre><p>ä¸Šé¢å…©å€‹ä¾‹å­ï¼Œæè¿°ç­å¦‚ä½•å‰µå»ºä¸€å€‹Promiseå°è±¡è¿”å›çµ¦callerï¼Œä»¥åŠå¦‚ä½•åœ¨calleeç«¯fulfillæˆ–rejecté€™å€‹Promiseã€‚ä½ å¯èƒ½æœƒç™¼ç¾ï¼Œè¿”å›çµ¦callerä¹‹å‰Promiseæ˜¯å¯ä»¥è™•æ–¼å®Œæˆç‹€æ…‹çš„ã€‚åœ¨ç¹¼çºŒä¸‹é¢çš„ä½¿ç”¨ä»‹ç´¹å‰ï¼Œå…ˆç°¡å–®çš„çœ‹ä¸‹ListenableFutureå’ŒCompletableFutureçš„å¹¾å€‹ä¸»è¦APIã€‚</p><p><img alt=ç•°æ­¥ç·¨ç¨‹æå‡æœå‹™æ€§èƒ½ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/15260210065997b2aa4be68></p><p><strong>2ã€ä¸²è¡Œèª¿ç”¨</strong></p><p>ListenableFutureæ²’æœ‰æä¾›thenæ–¹æ³•ï¼Œè€Œæ˜¯é€šéFuturesçš„ä¸€ç³»åˆ—éœæ…‹æ–¹æ³•ä¾†å¯¦ç¾Promiseé¢¨æ ¼çš„APIã€‚ç”±æ–¼å…©è€…æœ‰å¤§éƒ¨åˆ†çš„APIæ˜¯å¯ä»¥ç›¸äº’è½‰åŒ–çš„ï¼Œé™æ–¼ç¯‡å¹…ä¸‹é¢å°±ä¸å…¨éƒ¨æ¼”ç¤ºäº†ã€‚Promseçš„callbackå°±æ˜¯å…¶thenæˆ–catchæ–¹æ³•çš„å‡½æ•¸å‹åƒæ•¸ï¼Œç•¶Promiseè¢«resolveæ™‚åŸ·è¡Œé€™å€‹callbackå‡½æ•¸ã€‚é€™å€‹callbackå‡½æ•¸çš„è¼¸å…¥ï¼Œå°±æ˜¯Promiseçš„resolvedå€¼ã€‚æ ¹æ“šcallbackå‡½æ•¸çš„è¼¸å‡ºçš„ä¸åŒï¼Œéœ€è¦æ¡å–ä¸åŒçš„thenæ–¹æ³•ã€‚</p><p>â—† callbackç„¡è¼¸å‡º</p><p>Futures.addCallbackå’ŒCompletableFuture.thenAcceptæ¥å—ç„¡è¼¸å‡ºçš„callbackã€‚</p><pre>1.// Guava2.ListenableFuture&lt;QueryResult&gt; promise1 = ...;3.Futures.addCallback(promise1, new FutureCallback&lt;QueryResult&gt;() {4. public void onSuccess(QueryResult result) {5. storeInLocalCache(result);6. }7. public void onFailure(Throwable t) {8. reportError(t);9. }10.});</pre><pre>1.// CompletableFuture2.CompletableFuture&lt;QueryResult&gt; promise1 = ...;3.CompletableFuture&lt;Void&gt; promise2 = promise1.thenAccept(result -&gt; storeInLocalCache(result));4.return promise2;5.//return promise1.thenAccept(result -&gt; storeInLocalCache(result));//thenAcceptè¿”å›å¦ä¸€å€‹Promiseå¯¦ä¾‹</pre><p>å…ˆå¿½ç•¥ç•°å¸¸è™•ç†ã€‚å°æ¯”ä¸‹é€™ç¨®å ´æ™¯ä¸‹çš„ListenableFutureå’ŒCompletableFutureï¼šå‰è€…æ¡å–äº†æ›´å‚³çµ±çš„callbacké¢¨æ ¼ï¼Œå¾Œè€…å‰‡è¿”å›ä¸€å€‹æ–°çš„Promiseå¯¦ä¾‹ï¼Œcallbackè¨ˆç®—å®Œç•¢å‰‡promise2è¢«fulfilledï¼Œå¾ˆå®¹æ˜“é€šépromise2ä¾†ç²å–callbackåŸ·è¡Œå®Œç•¢èˆ‡å¦ï¼Œä¸éœ€è¦closureã€‚</p><p>â—† callbackè¼¸å‡ºä¸€å€‹æ™®é€šè¨ˆç®—å€¼</p><p>é€™ç¨®æƒ…æ³ä¸‹callbackå°±æ˜¯ä¸€å€‹è½‰æ›å‡½æ•¸ï¼Œè¼¸å…¥æ˜¯å‰ä¸€å€‹Promiseçš„fulfilledå€¼ï¼Œè¼¸å‡ºå‰‡ä½œç‚ºæ–°Promiseçš„fulfilledå€¼ã€‚Futures.transformå’ŒCompletableFuture.thenApplyæ¥æ”¶é€™æ¨£çš„callbackå‡½æ•¸ã€‚</p><pre>1.// CompletableFuture2.CompletableFuture&lt;QueryResult&gt; queryFuture = ...;3.CompletableFuture&lt;List&lt;Row&gt;&gt; rowsFuture = queryFuture.thenApply(result -&gt; result.getRows());4.return rowsFuture;</pre><p>â—† callbackè¼¸å‡ºä¸€å€‹ç•°æ­¥è¨ˆç®—å€¼ï¼Œå³ä¸€å€‹Promise</p><p>ä¹ä¸€çœ‹ï¼Œé€™ç¨®æƒ…æ³ä¸‹çš„è¼¸å‡ºè·Ÿä¸Šä¸€ç¨®å¥½åƒæ²’ä»€éº¼å€åˆ¥ã€‚ä½†å¯¦éš›ä¸Šï¼Œè¼¸å‡ºä¸€å€‹Promiseå€¼å’Œè¼¸å‡ºä¸€å€‹æ™®é€šçš„å€¼æœ‰æ ¹æœ¬çš„å€åˆ¥ã€‚é‚„è¨˜å¾—å§ï¼ŒPromiseä»£è¡¨è‘—ä¸€å€‹æœªå®Œæˆçš„ä¸¦ä¸”æ‰¿è«¾å®Œæˆçš„å€¼ã€‚é€šå¸¸é€™ç¨®æƒ…æ³ä¸‹ï¼Œæ„å‘³è‘—callbackè£¡èª¿ç”¨äº†å¦å¤–ä¸€å€‹Promiseé¢¨æ ¼çš„ç•°æ­¥APIã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­indexService.lookUpå’ŒdataService.readæ–¹æ³•ï¼Œç”±æ–¼æ¶‰åŠåˆ°IOï¼Œéƒ½è¨­è¨ˆç‚ºç•°æ­¥APIã€‚</p><pre>1.//Guava2.ListenableFuture&lt;RowKey&gt; rowKeyFuture = indexService.lookUp(query);3.AsyncFunction&lt;RowKey, QueryResult&gt; queryFunction = new AsyncFunction&lt;RowKey, QueryResult&gt;() {4. public ListenableFuture&lt;QueryResult&gt; apply(RowKey rowKey) {5. return dataService.read(rowKey);6. }7.};8.ListenableFuture&lt;QueryResult&gt; queryFuture = Futures.transformAsync(rowKeyFuture, queryFunction);9.return queryFuture;</pre><p>Futures.transformAsyncå’ŒCompletableFuture.thenComposeæ¥æ”¶é€™æ¨£çš„callbackå‡½æ•¸ã€‚</p><p>è¨­æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæŸå€‹é‚è¼¯ä¸­éœ€è¦èª¿ç”¨çš„å¤šå€‹Promiseé¢¨æ ¼çš„ç•°æ­¥æ–¹æ³•ï¼ˆæ¯”å¦‚å¤šå€‹RPCèª¿ç”¨ï¼‰ï¼Œä¸¦ä¸”æœ‰å…ˆå¾Œä¾è³´é—œä¿‚ï¼Œå³ä¸Šä¸€å€‹æ–¹æ³•çš„åŸ·è¡Œçµæœä½œç‚ºä¸‹ä¸€å€‹æ–¹æ³•çš„è¼¸å…¥ã€‚å°±å¯ä»¥ç”¨thenComposeæŠŠä»–å€‘ä¸²èµ·ä¾†ã€‚</p><pre>1.//CompletableFuture2.CompletableFuture&lt;RPC4Result&gt; promise4 = rpc1.call(input) //promise13. .thenCompose(rpc1Result -&gt; rpc2.call(rpc1Result)) //promise24. .thenCompose(rpc2Result -&gt; rpc3.call(rpc2Result)) //promise35. .thenCompose(rpc3Result -&gt; rpc4.call(rpc3Result)) //promise46.return promise4;</pre><p>ä¸è¦è¢«éˆå¼èª¿ç”¨çµ¦å¿½æ‚ äº†ï¼Œä½ é‚„æ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨æ™®é€šçš„é¢¨æ ¼ã€‚</p><p>å–®ç´”çœ‹ä¾†ï¼Œä¸Šè¿°çš„ä¸²è¡Œèª¿ç”¨å ´æ™¯ä¸‹ä½¿ç”¨Promiseé¢¨æ ¼çš„APIå¥½åƒåªæ˜¯æ¶ˆé™¤äº†Callback hellã€‚é‚£éº¼æ¡ç”¨åŒæ­¥APIå°±æ—¢æ²’æœ‰Callback hellçš„å•é¡Œï¼Œåˆç¬¦åˆæ•¸æ“šä¾è³´é—œä¿‚ã€‚å¯æ˜¯ï¼Œä½ æœƒç™¼ç¾ï¼Œä¸Šé¢çš„èˆ‰ä¾‹ä¸­çµå°¾éƒ½è¿”å›äº†Promiseï¼Œå°±æ˜¯èªªï¼ŒåŒ…å«é€™æ®µä»£ç¢¼çš„æ–¹æ³•è¢«è¨­è¨ˆç‚ºç•°æ­¥APIã€‚è€Œä½¿ç”¨åŒæ­¥APIï¼Œå‰‡æœƒå¼·åˆ¶é€™å€‹æ–¹æ³•çš„èª¿ç”¨è€…åªèƒ½ä½¿ç”¨åŒæ­¥æ–¹å¼èª¿ç”¨ã€‚</p><p><strong>3ã€ä¸¦è¡Œèª¿ç”¨</strong></p><p>ç•°æ­¥APIå¾ˆé©åˆä¸¦è¡Œèª¿ç”¨ã€‚calleråœ¨èª¿ç”¨å¤šå€‹æ²’æœ‰ä¾è³´é—œä¿‚çš„ç•°æ­¥APIæ™‚ï¼Œå¯ä»¥å…ˆä¾æ¬¡ç™¼èµ·èª¿ç”¨è€Œä¸ç”¨ç­‰å¾…æ¯å€‹èª¿ç”¨çœŸæ­£åŸ·è¡Œå®Œæˆï¼Œå¾calleeçš„è§’åº¦ä¾†è¬›ï¼ŒåŸ·è¡Œæ˜¯ä¸¦è¡Œçš„ã€‚callerå¯ä»¥å°èª¿ç”¨çµæœé€²è¡Œåˆä½µè™•ç†ï¼Œé—œéµæ˜¯ï¼Œåˆä½µä¹Ÿæ˜¯ç•°æ­¥é¢¨æ ¼çš„ã€‚</p><pre>1.//Guava2.List&lt;ListenableFuture&lt;QueryResult&gt;&gt; partialPromises = new ArrayList&lt;ListenableFuture&lt;QueryResult&gt;&gt;(nodes.size());3.for (Node node : nodes) {4. partialPromises.add(lookupHandler(node).query());5.}6.ListenableFuture&lt;List&lt;Row&gt;&gt; mergedPromise = Futures.transform(Futures.allAsList(partialPromises), new Function&lt;List&lt;List&lt;Row&gt;&gt;, List&lt;Row&gt;&gt;() {7. @Override public Long apply(List&lt;List&lt;Row&gt;&gt; input) {8. return merge(input);9. }10.})11.return mergedPromise;</pre><p>Futures.allAsListæ˜¯ä¸¦è¡ŒåŸ·è¡Œæ‰€æœ‰çš„promisesï¼Œè‹¥æœ‰ä¸€å€‹promiseç•°å¸¸å®Œæˆå‰‡å˜—è©¦rejectå°šæœªresolvedçš„promiseã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨Futures.successfulAsListï¼Œå€åˆ¥åœ¨æ–¼å¾Œè€…ä¸¦ä¸æœƒrejectå°šæœªresolvedçš„promiseã€‚CompletableFutureçš„å°æ‡‰ç‰©æ˜¯allOfå’ŒanyOfã€‚</p><p><strong>4ã€èª¿ç”¨ç·¨æ’</strong></p><p>åˆä½µçµæœè¨­è¨ˆç‚ºç•°æ­¥é¢¨æ ¼çš„å¥½è™•åœ¨æ–¼ï¼Œå¾ˆæ–¹ä¾¿åšåˆä½µã€ä¸²è¡Œæ··åˆèª¿ç”¨ç·¨æ’ï¼Œæ¯”å¦‚æŸå€‹é‚è¼¯ä¸­éœ€è¦èª¿ç”¨å››å€‹å€‹RPCæœå‹™Aã€Bã€Cã€Dï¼Œå…¶ä¸­ï¼šAçš„è¼¸å‡ºä½œç‚ºBã€Cçš„è¼¸å…¥ï¼ŒBã€Cå¯ä¸¦è¡Œï¼ŒBã€Cçš„è¼¸å‡ºåˆä½µå¾Œä½œç‚ºDçš„è¼¸å…¥ã€‚</p><pre>1.//CompletableFuture2.CompletableFuture&lt;AResult&gt; promiseA = rpcA.call(input);3.CompletableFuture&lt;DResult&gt; promiseD = promiseA.thenCompose(aResult -&gt; {4. CompletableFuture&lt;BResult&gt; promiseB = rpcB.call(aResult);5. CompletableFuture&lt;CResult&gt; promiseC = rpcC.call(aResult);6. CompletableFuture&lt;MergedResult&gt; mergedPromise = promiseB.thenCombine(promiseC, (bResult, cResult) -&gt; {7. return merge(bResult, cResult)8. });9. return mergedPromise;10.}).thenCompose(mergedResult -&gt; rpcD.call(mergedResult));11.return promiseD;</pre><p><strong>5ã€ç•°å¸¸è™•ç†</strong></p><p>ä¸Šé¢æåˆ°éCallbacké¢¨æ ¼çš„ç•°æ­¥APIï¼Œç•°å¸¸è™•ç†æ¯”è¼ƒåˆ†æ•£ã€‚è€ŒPromiseé¢¨æ ¼çš„ç•°å¸¸è™•ç†å‰‡å„ªé›…å¾—å¤šã€‚æˆ‘å€‘éœ€è¦è¨˜ä½ï¼Œç•°å¸¸æ˜¯Promiseæ”œå¸¶çš„å…©ç¨®ç‹€æ…‹ä¹‹ä¸€ã€‚é‚£éº¼ç•°å¸¸å¯ä»¥ä½œç‚ºcallbackå‡½æ•¸çš„è¼¸å…¥ã€‚</p><p>â—† é€šç”¨ç•°å¸¸è™•ç†</p><p>Futures.catchingå’ŒCompletableFuture.exceptionallyæ¥æ”¶ç•°å¸¸å€¼ç‚ºåƒæ•¸çš„callbackå‡½æ•¸ã€‚</p><pre>1.//Guava2.ListenableFuture&lt;Integer&gt; fetchCounterPromise = ...;3.// Falling back to a zero counter in case an exception happens when4.// processing the RPC to fetch counters.5.ListenableFuture&lt;Integer&gt; faultTolerantPromise = Futures.catching(6. fetchCounterPromise, FetchException.class,7. new Function&lt;FetchException, Integer&gt;() {8. public Integer apply(FetchException e) {9. return 0;10. }11. });</pre><p>æˆ‘å€‘å†çœ‹ä¸€å€‹æ›´å¾©é›œçš„ä¾‹å­ã€‚</p><pre>1.//CompletableFuture2.CompletableFuture&lt;FaultTolerantResult&gt; faultTolerantPromise = rpc1.call(input) //promise13. .thenCompose(rpc1Result -&gt; rpc2.call(rpc1Result)) //promise24. .thenCompose(rpc2Result -&gt; rpc3.call(rpc2Result)) //promise35. .thenCompose(rpc3Result -&gt; rpc4.call(rpc3Result)) //promise46. .exceptionally(err -&gt; {7. // process err8. return faultTolerantValue;9. }); //faultTolerantPromise10.return faultTolerantPromise;</pre><p>å†æé†’ä¸€éï¼Œä¸è¦è¢«éˆå¼èª¿ç”¨è¿·æƒ‘äº†ã€‚é€™å€‹ä¾‹å­è£¡é¢ï¼Œrpc1/rpc2/rpc3/rpc4éƒ½æœ‰å¯èƒ½ç™¼ç”Ÿç•°å¸¸ï¼Œä½†æˆ‘å€‘åªéœ€è¦åœ¨æœ€å¾Œçµ±ä¸€è™•ç†ï¼ˆè¿”å›ç•°å¸¸å€¼æˆ–è½‰æ›ç‚ºä¸€å€‹é»˜èªæ­£å¸¸å€¼ï¼‰ã€‚æ¯”å¦‚rpc2ç™¼ç”Ÿç•°å¸¸ï¼Œé‚£éº¼rpc3/rpc4çš„é‚è¼¯ï¼ˆæ¥æ”¶æ­£å¸¸å€¼çš„callbackå‡½æ•¸ï¼‰éƒ½ä¸æœƒåŸ·è¡Œï¼Œä½†æ˜¯rpc2çš„ç•°å¸¸æœƒå‚³éçµ¦promise3/promise4ã€‚</p><p>â—† æ¢å¾©</p><p>å‡è¨­åœ¨è®€å–æŸå€‹æ•¸æ“šå­˜å„²ç™¼ç”Ÿç•°å¸¸ï¼Œæˆ‘å€‘éœ€è¦æŸç¨®æ¢å¾©æ©Ÿåˆ¶ï¼Œæ¯”å¦‚è®€å–å¦ä¸€å€‹backupçš„æ•¸æ“šå­˜å„²ï¼ˆæŸç¨®é‡è©¦ï¼‰ï¼Œé‚£éº¼å¯ä»¥ä½¿ç”¨Futures.cachingAsyncå’ŒCompletableFuture.handleã€‚</p><pre>1.//CompletableFuture2.public &lt;V&gt; CompletableFuture&lt;V&gt; dispatch(final Command&lt;V&gt; command) {3. final CompletableFuture&lt;V&gt; dispatched = loadbalance.selectHandler().dispatch(command);4. if (maxTries &gt; 0) {5. final AtomicInteger leftTries = new AtomicInteger(maxTries);6. final BiFunction&lt;CompletableFuture&lt;V&gt;, Throwable, CompletableFuture&lt;V&gt;&gt; fallback = new BiFunction&lt;CompletableFuture&lt;V&gt;, Throwable, CompletableFuture&lt;V&gt;&gt;() {7. @Override8. public CompletableFuture&lt;V&gt; apply(CompletableFuture&lt;V&gt; input, Throwable cause) {9. if (cause == null) return input;10. if (cause instanceof RecoverableException &amp;&amp; leftTries.getAndDecrement() &gt; 0) {11. final CompletableFuture&lt;V&gt; next = loadbalance.selectHandler().dispatch(new Command&lt;V&gt;(command.type, command.args));12. return next.handle((v, err) -&gt; err).thenCompose(err -&gt; apply(next, err));13. }14. CompletableFuture&lt;V&gt; errFuture = new CompletableFuture&lt;&gt;();15. errFuture.completeExceptionally(cause);16. return errFuture;17. }18. };19. return dispatched.handle((v, err) -&gt; err).thenCompose(err -&gt; fallback.apply(dispatched, err));20. }21. return dispatched;22.}</pre><p>â—† è¶…æ™‚</p><p>Promiseæ˜¯ä¸€å€‹æ‰¿è«¾å®Œæˆï¼ˆæˆåŠŸæˆ–å¤±æ•—ï¼‰çš„çµæœï¼Œä½†æ˜¯ä¸¦ä¸æ‰¿è«¾å®Œæˆæ™‚é–“ã€‚æ‰€ä»¥ï¼Œé€šå¸¸éœ€è¦ä¸€ç¨®è¶…æ™‚æ©Ÿåˆ¶ï¼Œå¹¸é‹çš„æ˜¯ListenableFutureå’ŒCompletableFutureéƒ½å¯¦ç¾äº†Futureæ¥å£ã€‚</p><pre>1.CompletableFuture&lt;FaultTolerantResult&gt; faultTolerantPromise = ...;2.try {3. FaultTolerantResult result = faultTolerantPromise.get(1000, TimeUnit.SECONDS);4. // process result5.} catch (TimeoutException e) {6. //å˜—è©¦å–æ¶ˆåŸ·è¡Œå°šæœªé–‹å§‹çš„callbackå‡½æ•¸7. faultTolerantPromise.cancel(false); 8.}</pre><p><strong>å››ã€Promiseç•°æ­¥ç·¨ç¨‹çš„æ³¨æ„é»</strong></p><p>ç•°æ­¥ç·¨ç¨‹æ¯”åŒæ­¥ç·¨ç¨‹å›°é›£ã€‚ç•°æ­¥ç·¨ç¨‹é€šå¸¸ä¸»è¦è§£æ±ºä¸€å°éƒ¨åˆ†å•é¡Œï¼Œæ¯”å¦‚é˜»å¡ã€‚Promiseå€Ÿé‘‘äº†å‡½æ•¸å¼ç·¨ç¨‹çš„é¢¨æ ¼ï¼Œå¤§é‡çš„é‚è¼¯æœƒåˆ†æ•£åœ¨å„ç¨®callbackå‡½æ•¸ä¾†å¯¦ç¾ã€‚å› æ­¤å°æ–¼ç¿’æ…£äº†åŒæ­¥ç·¨ç¨‹çš„OOå¼æˆ–å‘½ä»¤å¼ç·¨ç¨‹é¢¨æ ¼çš„é–‹ç™¼äººå“¡ï¼Œéœ€è¦ä¸€å®šçš„ç¿’æ…£æ™‚é–“ã€‚</p><p>ä¸Šé¢è«‡åˆ°calleeåŸ·è¡Œæ©Ÿåˆ¶çš„æ™‚å€™ï¼Œè«‡åˆ°äº†ç·šç¨‹æ± ï¼Œé‚£éº¼calleeè¨ˆç®—å®Œæˆæ™‚ï¼Œcallbackå‡½æ•¸çš„åŸ·è¡Œé€šå¸¸æ˜¯æ± ä¸­resolve Promiseçš„ç·šç¨‹åŸ·è¡Œã€‚ä½†æ˜¯ï¼Œå¦‚æœcalleråœ¨è¨­ç½®callbackçš„æ™‚å€™ï¼ŒPromiseå·²ç¶“å®Œæˆï¼Œé‚£éº¼callbackçš„åŸ·è¡Œç·šç¨‹å‰‡æ˜¯callerç·šç¨‹ã€‚å› æ­¤ï¼Œè«‹ç‰¹åˆ¥é—œæ³¨callbackå‡½æ•¸çš„åŸ·è¡Œç·šç¨‹çš„å·®åˆ¥ã€‚è«‹éµå¾ªï¼š</p><p>â—† callbackå„˜é‡è¼•é‡</p><p>â—† callbacké¿å…é˜»å¡</p><p>â—† å¦å‰‡è«‹æŒ‡å®šåŸ·è¡Œç·šç¨‹</p><p>å¦‚æœcallbackåŸ·è¡Œäº†å¤§é‡çš„è¨ˆç®—ï¼Œç”šè‡³åŸ·è¡Œäº†é˜»å¡å¼æ“ä½œï¼Œé‚£éº¼å°±å¾ˆæœ‰å¯èƒ½é˜»å¡ä½Promiseçš„resolveç·šç¨‹ï¼Œé€šå¸¸é€™é¡ç·šç¨‹éƒ½æ˜¯æ¥µå°‘çš„ï¼Œæ¯”å¦‚åŸ·è¡ŒIOçš„EventLoopç·šç¨‹ï¼Œæœ‰å¯èƒ½é€ æˆå…¶ä»–Promiseå¾—ä¸åˆ°åŸ·è¡Œã€‚</p><blockquote><p>æ‘˜è‡ªListenableFutureçš„æ–‡æª”ï¼š</p><p>Note: For fast, lightweight listeners that would be safe to execute in any thread, consider MoreExecutors.directExecutor. Otherwise, avoid it. Heavyweight directExecutor listeners can cause problems, and these problems can be difficult to reproduce because they depend on timing. For example:</p><p>â—† The listener may be executed by the caller of addListener. That caller may be a UI thread or other latency-sensitive thread. This can harm UI responsiveness.</p><p>â—† The listener may be executed by the thread that completes this Future. That thread may be an internal system thread such as an RPC network thread. Blocking that thread may stall progress of the whole system. It may even cause a deadlock.</p><p>â—† The listener may delay other listeners, even listeners that are not themselves directExecutor listeners.</p></blockquote><p>æˆ‘å€‘ä¹Ÿçš„ç¢ºç¢°åˆ°éä½¿ç”¨MoreExecutors.directExecutoræ™‚ï¼Œç”±æ–¼ç·¨å¯«äº†å¤ªéè¤‡é›œçš„callbackéˆï¼Œå°è‡´ç·šç¨‹æ­»é–çš„å•é¡Œã€‚</p><p>CompletableFutureå’ŒListenableFutureéƒ½æœ‰æŒ‡å®šcallbackåŸ·è¡Œç·šç¨‹çš„æ–¹æ³•ï¼š</p><pre>1.//ä½¿ç”¨å…§ç½®çš„é€šç”¨ForkJoinç·šç¨‹æ± 2.completableFuture.thenAcceptAsync(callback);3.//ä½¿ç”¨æŒ‡å®šçš„ç·šç¨‹åŸ·è¡Œå™¨4.completableFuture.thenAcceptAsync(callback, executor);5.//ä½¿ç”¨æŒ‡å®šçš„ç·šç¨‹åŸ·è¡Œå™¨6.Futures.transform(input, callback, executor);</pre><p>æ­£å› ç‚ºç•°æ­¥ç·¨ç¨‹çš„è¤‡é›œæ€§ï¼Œå› æ­¤ç›®å‰æˆ‘å€‘ä¹Ÿå„˜é‡åœ¨æ¥­å‹™é‚è¼¯ç›¸å°ç°¡å–®çš„æ‡‰ç”¨ä¸Šé€²è¡Œç•°æ­¥åŒ–æ”¹é€ ã€‚å¾ŒçºŒï¼Œæˆ‘å€‘ä¹Ÿæœƒè©•ä¼°Quasarç­‰å”ç¨‹æ¡†æ¶ã€‚</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>ç•°æ­¥</a></li><li><a>ç·¨ç¨‹</a></li><li><a>æœå‹™</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/fd08b19.html alt=ç•°æ­¥ç·¨ç¨‹ï¼šå”ä½œæ€§å¤šä»»å‹™è™•ç† class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/dbd0ddd7-eda4-430a-8176-da9804319771 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fd08b19.html title=ç•°æ­¥ç·¨ç¨‹ï¼šå”ä½œæ€§å¤šä»»å‹™è™•ç†>ç•°æ­¥ç·¨ç¨‹ï¼šå”ä½œæ€§å¤šä»»å‹™è™•ç†</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f74b39f.html alt="Java ç•°æ­¥ç·¨ç¨‹å°è«–" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3c356b1aa9b4416ca7b35a07f3033e13 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f74b39f.html title="Java ç•°æ­¥ç·¨ç¨‹å°è«–">Java ç•°æ­¥ç·¨ç¨‹å°è«–</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4cb74cd.html alt="Springç•°æ­¥ç·¨ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„ç•°æ­¥å—ï¼Ÿç•°æ­¥æ­·éšªå¥‡é‡è¨˜" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/b9d102263d0f46a0b5b203d7b6cd4a2e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4cb74cd.html title="Springç•°æ­¥ç·¨ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„ç•°æ­¥å—ï¼Ÿç•°æ­¥æ­·éšªå¥‡é‡è¨˜">Springç•°æ­¥ç·¨ç¨‹ | ä½ çš„@Asyncå°±çœŸçš„ç•°æ­¥å—ï¼Ÿç•°æ­¥æ­·éšªå¥‡é‡è¨˜</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/852c87e.html alt="æœ‰äº† CompletableFutureï¼Œä½¿å¾—ç•°æ­¥ç·¨ç¨‹æ²’æœ‰é‚£éº¼é›£äº†" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e66a7bcfded64b34b43ebc1565b3e557 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/852c87e.html title="æœ‰äº† CompletableFutureï¼Œä½¿å¾—ç•°æ­¥ç·¨ç¨‹æ²’æœ‰é‚£éº¼é›£äº†">æœ‰äº† CompletableFutureï¼Œä½¿å¾—ç•°æ­¥ç·¨ç¨‹æ²’æœ‰é‚£éº¼é›£äº†</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3e8c3b8.html alt=è©³è§£ç·¨ç¨‹ä¸­çš„åŒæ­¥å’Œç•°æ­¥ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b292fb03b256422bb94215ce3ec3bbaf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3e8c3b8.html title=è©³è§£ç·¨ç¨‹ä¸­çš„åŒæ­¥å’Œç•°æ­¥>è©³è§£ç·¨ç¨‹ä¸­çš„åŒæ­¥å’Œç•°æ­¥</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3a0dfd7.html alt="ç•°æ­¥ç·¨ç¨‹å¯¦ä¾‹ï¼šJava8 APIçš„ç†è§£å’ŒCompletableFutureé¡çš„å¯¦ç¾" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1522150125651deaa9d51b2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3a0dfd7.html title="ç•°æ­¥ç·¨ç¨‹å¯¦ä¾‹ï¼šJava8 APIçš„ç†è§£å’ŒCompletableFutureé¡çš„å¯¦ç¾">ç•°æ­¥ç·¨ç¨‹å¯¦ä¾‹ï¼šJava8 APIçš„ç†è§£å’ŒCompletableFutureé¡çš„å¯¦ç¾</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/720d6d3b.html alt=åŒ—æµ·äººæ°‘ä¸èƒ½éŒ¯éçš„æŒä¸Šç”Ÿæ´»æœå‹™è¾¦ç†å¹³è‡º class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ad2c0c816b5a4c94982e13f61805144f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/720d6d3b.html title=åŒ—æµ·äººæ°‘ä¸èƒ½éŒ¯éçš„æŒä¸Šç”Ÿæ´»æœå‹™è¾¦ç†å¹³è‡º>åŒ—æµ·äººæ°‘ä¸èƒ½éŒ¯éçš„æŒä¸Šç”Ÿæ´»æœå‹™è¾¦ç†å¹³è‡º</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/03d16469.html alt=é˜¿é‡Œé›²å½ˆæ€§ä¼¸ç¸®æœå‹™ç°¡ä»‹ï¼Œå½ˆæ€§ä¼¸ç¸®æœå‹™å…¥é–€æƒç›² class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1538214769522e3e469ade5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/03d16469.html title=é˜¿é‡Œé›²å½ˆæ€§ä¼¸ç¸®æœå‹™ç°¡ä»‹ï¼Œå½ˆæ€§ä¼¸ç¸®æœå‹™å…¥é–€æƒç›²>é˜¿é‡Œé›²å½ˆæ€§ä¼¸ç¸®æœå‹™ç°¡ä»‹ï¼Œå½ˆæ€§ä¼¸ç¸®æœå‹™å…¥é–€æƒç›²</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9cfcdd6f.html alt=ã€ŠJAVAç·¨ç¨‹æ€æƒ³ã€‹5åˆ†é˜é€Ÿæˆï¼šç¬¬8ç« ï¼ˆå¤šæ…‹ï¼‰ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/399a29d93fde48fca4bae44dffbced07 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9cfcdd6f.html title=ã€ŠJAVAç·¨ç¨‹æ€æƒ³ã€‹5åˆ†é˜é€Ÿæˆï¼šç¬¬8ç« ï¼ˆå¤šæ…‹ï¼‰>ã€ŠJAVAç·¨ç¨‹æ€æƒ³ã€‹5åˆ†é˜é€Ÿæˆï¼šç¬¬8ç« ï¼ˆå¤šæ…‹ï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ede16bf9.html alt=ã€Œç·¨ç¨‹åŸºç¤ã€PHPåŸºç¤æ•™ç¨‹ï¼ˆäºŒï¼‰ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/17685aad04c54d02928724fb99fea026 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ede16bf9.html title=ã€Œç·¨ç¨‹åŸºç¤ã€PHPåŸºç¤æ•™ç¨‹ï¼ˆäºŒï¼‰>ã€Œç·¨ç¨‹åŸºç¤ã€PHPåŸºç¤æ•™ç¨‹ï¼ˆäºŒï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/69e45bf9.html alt=ã€Œç·¨ç¨‹åŸºç¤ã€PHPåŸºç¤æ•™ç¨‹ï¼ˆä¸€ï¼‰ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/355d0f0c0f274bdfaeb90747dbd918fb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/69e45bf9.html title=ã€Œç·¨ç¨‹åŸºç¤ã€PHPåŸºç¤æ•™ç¨‹ï¼ˆä¸€ï¼‰>ã€Œç·¨ç¨‹åŸºç¤ã€PHPåŸºç¤æ•™ç¨‹ï¼ˆä¸€ï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b96f9421.html alt=é›¶åŸºç¤å¦‚ä½•å­¸PHPç·¨ç¨‹èªè¨€ï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b96f9421.html title=é›¶åŸºç¤å¦‚ä½•å­¸PHPç·¨ç¨‹èªè¨€ï¼Ÿ>é›¶åŸºç¤å¦‚ä½•å­¸PHPç·¨ç¨‹èªè¨€ï¼Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6e6dcd03.html alt=ç·¨ç¨‹æ˜¯ä»€éº¼â€”â€”ä¸–ç•Œç¬¬ä¸€è‡ºé›»å­è¨ˆç®—æ©Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/aac93e54a8f84d04b0d01165200ce1a2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6e6dcd03.html title=ç·¨ç¨‹æ˜¯ä»€éº¼â€”â€”ä¸–ç•Œç¬¬ä¸€è‡ºé›»å­è¨ˆç®—æ©Ÿ>ç·¨ç¨‹æ˜¯ä»€éº¼â€”â€”ä¸–ç•Œç¬¬ä¸€è‡ºé›»å­è¨ˆç®—æ©Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7eb8afcd.html alt=éŠæˆ²å¼•æ“ç·¨ç¨‹éœ€è¦å“ªäº›åŸºæœ¬æ•¸å­¸çŸ¥è­˜ï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3f6ca97249fa468db6982c44a024979d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7eb8afcd.html title=éŠæˆ²å¼•æ“ç·¨ç¨‹éœ€è¦å“ªäº›åŸºæœ¬æ•¸å­¸çŸ¥è­˜ï¼Ÿ>éŠæˆ²å¼•æ“ç·¨ç¨‹éœ€è¦å“ªäº›åŸºæœ¬æ•¸å­¸çŸ¥è­˜ï¼Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e4bfe813.html alt=UGç·¨ç¨‹ç¨ç•¶ä¸€é¢ï¼Œå¦‚ä½•æé«˜é‘½å­”ç²¾åº¦æ–¹æ³•ï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1532093430052c29be7656f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e4bfe813.html title=UGç·¨ç¨‹ç¨ç•¶ä¸€é¢ï¼Œå¦‚ä½•æé«˜é‘½å­”ç²¾åº¦æ–¹æ³•ï¼Ÿ>UGç·¨ç¨‹ç¨ç•¶ä¸€é¢ï¼Œå¦‚ä½•æé«˜é‘½å­”ç²¾åº¦æ–¹æ³•ï¼Ÿ</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>