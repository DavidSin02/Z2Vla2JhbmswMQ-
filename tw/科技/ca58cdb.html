<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>åŸºæ–¼ Kotlin å¯¦ç¾ä¸€å€‹ç°¡å–®çš„ TCP è‡ªå®šç¾©å”è­° | æå®¢å¿«è¨Š</title><meta property="og:title" content="åŸºæ–¼ Kotlin å¯¦ç¾ä¸€å€‹ç°¡å–®çš„ TCP è‡ªå®šç¾©å”è­° - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/dfic-imagehandler/f5dcf8ca-8735-4a93-a468-eced248ee3c9"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ca58cdb.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ca58cdb.html><meta property="article:published_time" content="2020-10-29T20:50:28+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:28+08:00"><meta name=Keywords content><meta name=description content="åŸºæ–¼ Kotlin å¯¦ç¾ä¸€å€‹ç°¡å–®çš„ TCP è‡ªå®šç¾©å”è­°"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/ca58cdb.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>åŸºæ–¼ Kotlin å¯¦ç¾ä¸€å€‹ç°¡å–®çš„ TCP è‡ªå®šç¾©å”è­°</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>ä¸€. é–‹ç™¼èƒŒæ™¯</h1><blockquote><p>æƒ³è¦æˆç‚ºä¸€åå„ªç§€çš„Androidé–‹ç™¼ï¼Œä½ éœ€è¦ä¸€ä»½å®Œå‚™çš„ çŸ¥è­˜é«”ç³»ï¼Œåœ¨é€™è£¡ï¼Œè®“æˆ‘å€‘ä¸€èµ·æˆé•·ç‚ºè‡ªå·±æ‰€æƒ³çš„é‚£æ¨£~ã€‚</p></blockquote><div class=pgc-img><img alt="åŸºæ–¼ Kotlin å¯¦ç¾ä¸€å€‹ç°¡å–®çš„ TCP è‡ªå®šç¾©å”è­°" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/dfic-imagehandler/f5dcf8ca-8735-4a93-a468-eced248ee3c9><p class=pgc-img-caption></p></div><p style=text-align:start>æˆ‘å€‘çš„é …ç›®éœ€è¦é–‹ç™¼ä¸€æ¬¾æ™ºèƒ½ç¡¬ä»¶ã€‚å®ƒç”± Web å¾Œè‡ºç™¼é€æŒ‡ä»¤åˆ°ä¸€æ¬¾æ¡Œé¢ç«¯æ‡‰ç”¨ç¨‹åºï¼Œå†ç”±æ¡Œé¢ç¨‹åºä¾†æ§åˆ¶ä¸åŒçš„ç¡¬ä»¶è¨­å‚™å¯¦ç¾æ¥­å‹™ä¸Šçš„æ“ä½œã€‚å¾ Web å¾Œè‡ºåˆ°æ¡Œé¢ç«¯æ˜¯é€šéä¸€å€‹ WebSocket é•·éˆæ¥ä¾†é€²è¡Œç¶­è­·ï¼Œè€Œæ¡Œé¢ç¨‹åºåˆ°å„å€‹ç¡¬ä»¶è¨­å‚™ä¹Ÿæ˜¯ä¸€å€‹ TCP é•·éˆæ¥ä¾†ç¶­è­·çš„ã€‚</p><p style=text-align:start>æœ¬æ–‡è¬›è¿°çš„ï¼Œå…¶å¯¦æ˜¯å¾æ¡Œé¢ç¨‹åºåˆ°å„å€‹ç¡¬ä»¶ä¹‹é–“çš„é€šè¨Šã€‚</p><h1 class=pgc-h-arrow-right>äºŒ. è‡ªå®šç¾©é€šè¨Šå”è­°</h1><p style=text-align:start>é¦–å…ˆï¼Œéœ€è¦è¨­è¨ˆä¸€å€‹é€šç”¨çš„ TCP ç¶²çµ¡å”è­°ã€‚</p><p style=text-align:start>ç¶²çµ¡å”è­°çµæ§‹å¦‚ä¸‹</p><pre><code>     +--------------+---------------+------------+---------------+-----------+----------+     | é­”æ•¸(4)       | version(1)    |åºåˆ—åŒ–æ–¹å¼(1) | command(1)    |æ•¸æ“šé•·åº¦(4) |æ•¸æ“š(n)    |     +--------------+---------------+------------+---------------+-----------+----------+</code></pre><ul><li>é­”æ•¸ï¼š4å­—ç¯€ï¼Œæœ¬é …ç›®ä¸­ä½¿ç”¨ 20200803(é€™ä¸€å¤©ç·¨å¯«çš„æ—¥å­)ï¼Œç‚ºäº†é˜²æ­¢è©²ç«¯å£è¢«æ„å¤–èª¿ç”¨ï¼Œæˆ‘å€‘åœ¨æ”¶åˆ°å ±æ–‡å¾Œå–å‰4å€‹å­—ç¯€èˆ‡é­”æ•¸æ¯”å°ï¼Œå¦‚æœä¸ç›¸åŒå‰‡ç›´æ¥æ‹’çµ•ä¸¦é—œé–‰é€£æ¥ã€‚</li><li>ç‰ˆæœ¬è™Ÿï¼š1å­—ç¯€ï¼Œåƒ…è¡¨ç¤ºå”è­°çš„ç‰ˆæœ¬è™Ÿï¼Œä¾¿æ–¼å”è­°å‡ç´šæ™‚ä½¿ç”¨</li><li>åºåˆ—åŒ–æ–¹å¼ï¼š1å­—ç¯€ï¼Œè¡¨ç¤ºå¦‚ä½•å°‡ Java å°è±¡è½‰åŒ–ç‚ºäºŒé€²åˆ¶æ•¸æ“šï¼Œä»¥åŠå¦‚ä½•ååºåˆ—åŒ–ã€‚</li><li>æŒ‡ä»¤ï¼š1å­—ç¯€ï¼Œè¡¨ç¤ºè©²æ¶ˆæ¯çš„æ„åœ–ï¼ˆå¦‚æ‹ç…§ã€æ‹è¦–é »ã€å¿ƒè·³ã€App å‡ç´šç­‰ï¼‰ã€‚æœ€å¤šæ”¯æŒ 2^8 ç¨®æŒ‡ä»¤ã€‚</li><li>æ•¸æ“šé•·åº¦ï¼š4å­—ç¯€ï¼Œè¡¨ç¤ºè©²å­—æ®µå¾Œæ•¸æ“šéƒ¨åˆ†çš„é•·åº¦ã€‚æœ€å¤šæ”¯æŒ 2^32 ä½ã€‚</li><li>æ•¸æ“šï¼šå…·é«”æ•¸æ“šçš„å…§å®¹ã€‚</li></ul><p style=text-align:start>æ ¹æ“šä¸Šè¿°æ‰€è¨­è¨ˆçš„ç¶²çµ¡å”è­°ï¼Œå®šç¾©ä¸€å€‹æŠ½è±¡é¡ Packetï¼š</p><pre><code>abstract class Packet {    var magic:Int? = MAGIC_NUMBER     // é­”æ•¸    var version:Byte = 1              // ç‰ˆæœ¬è™Ÿï¼Œç•¶å‰å”è­°çš„ç‰ˆæœ¬è™Ÿç‚º 1    abstract val serializeMethod:Byte // åºåˆ—åŒ–æ–¹å¼    abstract val command:Byte         // Watcher è·Ÿ App ç›¸äº’é€šè¨Šçš„æŒ‡ä»¤}</code></pre><p style=text-align:start>æœ‰å¤šå°‘å€‹æŒ‡ä»¤å°±éœ€è¦å®šç¾©å¤šå°‘å€‹ Packetï¼Œä¸‹é¢ä»¥å¿ƒè·³çš„ Packet ç‚ºä¾‹ï¼Œå®šç¾©ä¸€å€‹ HeartBeatPacketï¼š</p><pre><code>data class HeartBeatPacket(var msg:String = "ping",                           override val serializeMethod: Byte = Serialize.JSON,                           override val command: Byte = Commands.HEART_BEAT) : Packet() {}</code></pre><p style=text-align:start>HeartBeatPacket æ˜¯ç”± TCP å®¢æˆ¶ç«¯ç™¼èµ·ï¼Œç”± TCP æœå‹™ç«¯æ¥æ”¶ä¸¦è¿”å›çµ¦å®¢æˆ¶ç«¯ã€‚</p><p style=text-align:start>æ¯å€‹ Packet é¡éƒ½åŒ…å«äº†è©² Packet æ‰€ä½¿ç”¨çš„åºåˆ—åŒ–æ–¹å¼ã€‚</p><pre><code>/** * åºåˆ—åŒ–æ–¹å¼çš„å¸¸é‡åˆ—è¡¨ */interface Serialize {    companion object {        const val JSON: Byte = 0    }}</code></pre><p style=text-align:start>æ¯å€‹ Packet ä¹ŸåŒ…å«äº†å…¶å°æ‡‰çš„ commandã€‚ä¸‹é¢æ˜¯ Commands æ˜¯æŒ‡ä»¤é›†ï¼Œæ”¯æŒ256å€‹æŒ‡ä»¤ã€‚</p><pre><code>/** * æŒ‡ä»¤é›†ï¼Œæ”¯æŒå¾ -128 åˆ° 127 ç¸½å…± 256 å€‹æŒ‡ä»¤ */interface Commands {    companion object {        /**         * å¿ƒè·³åŒ…         */        const val HEART_BEAT: Byte = 0        /**         * ç™»éŒ„ï¼ˆApp éœ€è¦å‘Šè¨´ Watcher ï¼šcameraPosition çš„ä½ç½®ï¼‰         */        const val LOGIN: Byte = 1        ......   }}</code></pre><p style=text-align:start>ç”±æ–¼ä½¿ç”¨è‡ªå®šç¾©çš„å”è­°ï¼Œå¿…é ˆè¦æœ‰å°å ±æ–‡çš„ encodeã€decodeï¼ŒPacketManager è² è²¬é€™äº›äº‹æƒ…ã€‚<br>encode æ™‚æŒ‰ç…§å”è­°çš„çµæ§‹é€²è¡Œçµ„è£å ±æ–‡ï¼ŒåŒç† decode æ˜¯å…¶é€†å‘çš„éç¨‹ã€‚</p><pre><code>/** * å ±æ–‡çš„ç®¡ç†é¡ï¼Œå°å ±æ–‡é€²è¡Œ encodeã€decode */object PacketManager {    fun encode(packet: Packet):ByteBuf = encode(ByteBufAllocator.DEFAULT, packet)    fun encode(alloc:ByteBufAllocator, packet: Packet) = encode(alloc.ioBuffer(), packet)    fun encode(buf: ByteBuf, packet: Packet): ByteBuf {        val serializer = SerializerFactory.getSerializer(packet.serializeMethod)        val bytes: ByteArray = serializer.serialize(packet)        //çµ„è£å ±æ–‡:é­”æ•¸ï¼ˆ4å­—ç¯€ï¼‰+ ç‰ˆæœ¬è™Ÿï¼ˆ1å­—ç¯€ï¼‰+ åºåˆ—åŒ–æ–¹å¼ï¼ˆ1å­—ç¯€ï¼‰+ æŒ‡ä»¤ï¼ˆ1å­—ç¯€ï¼‰+ æ•¸æ“šé•·åº¦ï¼ˆ4å­—ç¯€ï¼‰+ æ•¸æ“šï¼ˆNå­—ç¯€ï¼‰        buf.writeInt(MAGIC_NUMBER)        buf.writeByte(packet.version.toInt())        buf.writeByte(packet.serializeMethod.toInt())        buf.writeByte(packet.command.toInt())        buf.writeInt(bytes.size)        buf.writeBytes(bytes)        return buf    }    fun decode(buf:ByteBuf): Packet {        buf.skipBytes(4) // é­”æ•¸ç”±å–®ç¨çš„ Handler é€²è¡Œæ ¡é©—        buf.skipBytes(1)        val serializationMethod = buf.readByte()        val serializer = SerializerFactory.getSerializer(serializationMethod)        val command = buf.readByte()        val clazz = PacketFactory.getPacket(command)        val length = buf.readInt()  // æ•¸æ“šçš„é•·åº¦        val bytes = ByteArray(length)   // å®šç¾©éœ€è¦è®€å–çš„å­—ç¬¦æ•¸çµ„        buf.readBytes(bytes)        return serializer.deserialize(clazz, bytes)    }}</code></pre><h1 class=pgc-h-arrow-right>ä¸‰. TCP æœå‹™ç«¯</h1><p style=text-align:start>å•Ÿå‹• TCP æœå‹™çš„æ–¹æ³•</p><pre><code>    fun execute() {        boss = NioEventLoopGroup()        worker = NioEventLoopGroup()        val bootstrap = ServerBootstrap()        bootstrap.group(boss, worker).channel(NioServerSocketChannel::class.java)                .option(ChannelOption.SO_BACKLOG, 100)                .childOption(ChannelOption.SO_KEEPALIVE, true)                .childOption(ChannelOption.SO_REUSEADDR, true)                .childOption(ChannelOption.TCP_NODELAY, true)                .childHandler(object : ChannelInitializer&lt;NioSocketChannel&gt;() {                    @Throws(Exception::class)                    override fun initChannel(nioSocketChannel: NioSocketChannel) {                        val pipeline = nioSocketChannel.pipeline()                        pipeline.addLast(ServerIdleHandler())                        pipeline.addLast(MagicNumValidator())                        pipeline.addLast(PacketCodecHandler)                        pipeline.addLast(HeartBeatHandler)                        pipeline.addLast(ResponseHandler)                    }                })        val future: ChannelFuture = bootstrap.bind(TCP_PORT)        future.addListener(object : ChannelFutureListener {            @Throws(Exception::class)            override fun operationComplete(channelFuture: ChannelFuture) {                if (channelFuture.isSuccess) {                    logInfo(logger, "TCP Server is starting...")                } else {                    logError(logger,channelFuture.cause(),"TCP Server failed")                }            }        })    }</code></pre><p style=text-align:start>å…¶ä¸­ï¼ŒServerIdleHandlerï¼š è¡¨ç¤º 5 åˆ†é˜å…§æ²’æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œå‰‡æ–·é–‹é€£æ¥ã€‚</p><pre><code>class ServerIdleHandler : IdleStateHandler(0, 0, HERT_BEAT_TIME) {    private val logger: Logger = LoggerFactory.getLogger(ServerIdleHandler::class.java)    @Throws(Exception::class)    override fun channelIdle(ctx: ChannelHandlerContext, evt: IdleStateEvent) {        logInfo(logger) {            ctx.channel().close()            "$HERT_BEAT_TIME ç§’å…§æ²’æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œå‰‡æ–·é–‹é€£æ¥"        }    }    companion object {        private const val HERT_BEAT_TIME = 300    }}</code></pre><p style=text-align:start>MagicNumValidatorï¼šç”¨æ–¼ TCP å ±æ–‡çš„é­”æ•¸æ ¡é©—ã€‚</p><pre><code>class MagicNumValidator : LengthFieldBasedFrameDecoder(Int.MAX_VALUE, LENGTH_FIELD_OFFSET, LENGTH_FIELD_LENGTH) {    private val logger: Logger = LoggerFactory.getLogger(this.javaClass)    @Throws(Exception::class)    override fun decode(ctx: ChannelHandlerContext, `in`: ByteBuf): Any? {        if (`in`.getInt(`in`.readerIndex()) !== MAGIC_NUMBER) { // é­”æ•¸æ ¡é©—ä¸é€šéï¼Œå‰‡é—œé–‰é€£æ¥            logInfo(logger,"é­”æ•¸æ ¡é©—å¤±æ•—")            ctx.channel().close()            return null        }        return super.decode(ctx, `in`)    }    companion object {        private const val LENGTH_FIELD_OFFSET = 7        private const val LENGTH_FIELD_LENGTH = 4    }}</code></pre><p style=text-align:start>PacketCodecHandler: è§£æå ±æ–‡çš„ Handlerã€‚</p><p style=text-align:start>PacketCodecHandler ç¹¼æ‰¿è‡ª ByteToMessageCodec ï¼Œå®ƒæ˜¯ç”¨ä¾†è™•ç† byte-to-message å’Œmessage-to-byteï¼Œä¾¿æ–¼è§£ç¢¼å­—ç¯€æ¶ˆæ¯æˆ POJO æˆ–ç·¨ç¢¼ POJO æ¶ˆæ¯æˆå­—ç¯€ã€‚</p><pre><code>@ChannelHandler.Sharableobject PacketCodecHandler : MessageToMessageCodec&lt;ByteBuf, Packet&gt;() {    override fun encode(ctx: ChannelHandlerContext, msg: Packet, list: MutableList&lt;Any&gt;) {        val byteBuf = ctx.channel().alloc().ioBuffer()        PacketManager.encode(byteBuf, msg)        list.add(byteBuf)    }    override fun decode(ctx: ChannelHandlerContext, msg: ByteBuf, list: MutableList&lt;Any&gt;) {        list.add(PacketManager.decode(msg));    }}</code></pre><p style=text-align:start>HeartBeatHandlerï¼šå¿ƒè·³çš„ Handlerï¼Œæ¥æ”¶ TCP å®¢æˆ¶ç«¯ç™¼ä¾†çš„"ping"ï¼Œç„¶å¾Œçµ¦å®¢æˆ¶ç«¯è¿”å›"pong"ã€‚</p><pre><code>@ChannelHandler.Sharableobject HeartBeatHandler : SimpleChannelInboundHandler&lt;HeartBeatPacket&gt;(){    private val logger: Logger = LoggerFactory.getLogger(this.javaClass)    override fun channelRead0(ctx: ChannelHandlerContext, msg: HeartBeatPacket) {        logInfo(logger,"æ”¶åˆ°å¿ƒè·³åŒ…ï¼š${GsonUtils.toJson(msg)}")        msg.msg = "pong" // è¿”å› pong çµ¦åˆ°å®¢æˆ¶ç«¯        ctx.writeAndFlush(msg)    }}</code></pre><p style=text-align:start>ResponseHandlerï¼šé€šç”¨çš„è™•ç†æ¥æ”¶ TCP å®¢æˆ¶ç«¯ç™¼ä¾†æŒ‡ä»¤çš„ Handlerï¼Œå¯ä»¥æ ¹æ“šå°æ‡‰çš„æŒ‡ä»¤å»æŸ¥è©¢å°æ‡‰çš„ Handler ä¸¦è™•ç†å…¶å‘½ä»¤ã€‚</p><pre><code>object ResponseHandler: SimpleChannelInboundHandler&lt;Packet&gt;() {    private val logger: Logger = LoggerFactory.getLogger(this.javaClass)    private val handlerMap: ConcurrentHashMap&lt;Byte, SimpleChannelInboundHandler&lt;out Packet&gt;&gt; = ConcurrentHashMap()    init {        handlerMap[LOGIN] = LoginHandler        ......        handlerMap[ERROR] = ErrorHandler    }    override fun channelRead0(ctx: ChannelHandlerContext, msg: Packet) {        logInfo(logger,"æ”¶åˆ°å®¢æˆ¶ç«¯çš„æŒ‡ä»¤: ${msg.command}")        val handler: SimpleChannelInboundHandler&lt;out Packet&gt;? = handlerMap[msg.command]        handler?.let {            logInfo(logger,"æ‰¾åˆ°éŸ¿æ‡‰æŒ‡ä»¤çš„ Handler: ${it.javaClass.simpleName}")            it.channelRead(ctx, msg)        } ?: logInfo(logger,"æœªæ‰¾åˆ°éŸ¿æ‡‰æŒ‡ä»¤çš„ Handler")    }    @Throws(Exception::class)    override fun channelInactive(ctx: ChannelHandlerContext) {        val insocket = ctx.channel().remoteAddress() as InetSocketAddress        val clientIP = insocket.address.hostAddress        val clientPort = insocket.port        logError(logger,"å®¢æˆ¶ç«¯æ‰ç·š: $clientIP : $clientPort")        super.channelInactive(ctx)    }}</code></pre><h1 class=pgc-h-arrow-right>å››. TCP å®¢æˆ¶ç«¯</h1><p style=text-align:start>æ¨¡æ“¬ä¸€å€‹å®¢æˆ¶ç«¯çš„å¯¦ç¾</p><pre><code>val topLevelClass = object : Any() {}.javaClass.enclosingClassval logger: Logger = LoggerFactory.getLogger(topLevelClass)fun main() {    val worker = NioEventLoopGroup()    val bootstrap = Bootstrap()    bootstrap.group(worker).channel(NioSocketChannel::class.java)            .handler(object : ChannelInitializer&lt;SocketChannel&gt;() {                @Throws(Exception::class)                override fun initChannel(channel: SocketChannel) {                    channel.pipeline().addLast(PacketCodecHandler)                    channel.pipeline().addLast(ClientIdleHandler())                    channel.pipeline().addLast(ClientLogin())                }            })    val future: ChannelFuture = bootstrap.connect("127.0.0.1", TCP_PORT).addListener(object : ChannelFutureListener {        @Throws(Exception::class)        override fun operationComplete(channelFuture: ChannelFuture) {            if (channelFuture.isSuccess()) {                logInfo(logger,"connect to server success!")            } else {                logger.info("failed to connect the server! ")                System.exit(0)            }        }    })    try {        future.channel().closeFuture().sync()        logInfo(logger,"èˆ‡æœå‹™ç«¯æ–·é–‹é€£æ¥ï¼")    } catch (e: InterruptedException) {        e.printStackTrace()    }}</code></pre><p style=text-align:start>å…¶ä¸­ï¼ŒPacketCodecHandler è·Ÿæœå‹™ç«¯ä½¿ç”¨çš„è§£æå ±æ–‡çš„ Handler æ˜¯ä¸€æ¨£çš„ã€‚</p><p style=text-align:start>ClientIdleHandlerï¼šå®¢æˆ¶ç«¯å¯¦ç¾å¿ƒè·³ï¼Œæ¯éš” 30 ç§’ç™¼é€ä¸€æ¬¡å¿ƒè·³ã€‚</p><pre><code>class ClientIdleHandler : IdleStateHandler(0, 0, HEART_BEAT_TIME) {    private val logger = LoggerFactory.getLogger(ClientIdleHandler::class.java)    @Throws(Exception::class)    override fun channelIdle(ctx: ChannelHandlerContext, evt: IdleStateEvent?) {        logInfo(logger,"ç™¼é€å¿ƒè·³....")        ctx.writeAndFlush(HeartBeatPacket())    }    companion object {        private const val HEART_BEAT_TIME = 30    }}</code></pre><p style=text-align:start>ClientLoginï¼šç™»éŒ„æœå‹™ç«¯çš„ Handlerã€‚</p><pre><code>@ChannelHandler.Sharableclass ClientLogin: ChannelInboundHandlerAdapter() {    private val logger: Logger = LoggerFactory.getLogger(this.javaClass)    @Throws(Exception::class)    override fun channelActive(ctx: ChannelHandlerContext) {        val packet: LoginPacket = LoginPacket()        logInfo(logger,"packet = ${GsonUtils.toJson(packet)}")        val byteBuf = PacketManager.encode(packet)        ctx.channel().writeAndFlush(byteBuf)    }}</code></pre><h1 class=pgc-h-arrow-right>äº”. ç¸½çµ</h1><p style=text-align:start>é€™æ¬¡ï¼Œæˆ‘é–‹ç™¼çš„æ¡Œé¢ç«¯ç¨‹åºå…¶å¯¦é‚è¼¯ä¸¦ä¸è¤‡é›œï¼Œåªéœ€æ¥æ”¶ Web å¾Œè‡ºçš„æŒ‡ä»¤ï¼Œç„¶å¾Œè·Ÿå„å€‹è¨­å‚™é€²è¡Œäº¤äº’ã€‚</p><p style=text-align:start>æ¥æ”¶åˆ° Web ç«¯çš„æŒ‡ä»¤å¾Œï¼Œé€šé Guava çš„ EventBus å°‡æŒ‡ä»¤é€šé TCP ç™¼é€çµ¦å„å€‹è¨­å‚™ï¼Œç™¼é€æ™‚éœ€è¦è½‰åŒ–æˆå°æ‡‰çš„ Packetã€‚å› æ­¤ï¼Œæ ¸å¿ƒçš„æ¨¡å¡Šå°±æ˜¯é€™å€‹ TCP è‡ªå®šç¾©çš„å”è­°ã€‚</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Kotlin</a></li><li><a>å¯¦ç¾</a></li><li><a>ä¸€å€‹</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/5753325c.html alt=å¦‚ä½•å¯¦ç¾ä¸€å€‹åˆ†ä½ˆå¼çµ±è¨ˆå’Œéæ¿¾çš„éˆè·¯è¿½è¹¤ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3476ff40e4614445b3755a142c79cba8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5753325c.html title=å¦‚ä½•å¯¦ç¾ä¸€å€‹åˆ†ä½ˆå¼çµ±è¨ˆå’Œéæ¿¾çš„éˆè·¯è¿½è¹¤>å¦‚ä½•å¯¦ç¾ä¸€å€‹åˆ†ä½ˆå¼çµ±è¨ˆå’Œéæ¿¾çš„éˆè·¯è¿½è¹¤</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/ad2d2457.html alt=ã€Šå°ç‹—éŒ¢éŒ¢ã€‹ï¼šåœ¨ä¸€éš»ç‹—çš„æŒ‡å°ä¸‹ï¼Œä¸€å€‹å°å¥³å­©å¯¦ç¾é¡˜æœ›å¼•ç™¼çš„æ€è€ƒ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/2de19dfc1cb64d9f8adaec4d06c6a4f9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/ad2d2457.html title=ã€Šå°ç‹—éŒ¢éŒ¢ã€‹ï¼šåœ¨ä¸€éš»ç‹—çš„æŒ‡å°ä¸‹ï¼Œä¸€å€‹å°å¥³å­©å¯¦ç¾é¡˜æœ›å¼•ç™¼çš„æ€è€ƒ>ã€Šå°ç‹—éŒ¢éŒ¢ã€‹ï¼šåœ¨ä¸€éš»ç‹—çš„æŒ‡å°ä¸‹ï¼Œä¸€å€‹å°å¥³å­©å¯¦ç¾é¡˜æœ›å¼•ç™¼çš„æ€è€ƒ</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/8e3d5ce.html alt=é¦¬æ–¯å…‹å¹éçš„ç‰›é€¼åˆå¯¦ç¾äº†ä¸€å€‹ï¼Œä»–æœ€å®³æ€•è‡ªå·±æ˜¯â€œæ¥šé–€â€ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/pgc-image/58c696205d404904901961c90658af75 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/8e3d5ce.html title=é¦¬æ–¯å…‹å¹éçš„ç‰›é€¼åˆå¯¦ç¾äº†ä¸€å€‹ï¼Œä»–æœ€å®³æ€•è‡ªå·±æ˜¯â€œæ¥šé–€â€>é¦¬æ–¯å…‹å¹éçš„ç‰›é€¼åˆå¯¦ç¾äº†ä¸€å€‹ï¼Œä»–æœ€å®³æ€•è‡ªå·±æ˜¯â€œæ¥šé–€â€</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ac25d2d0.html alt=30åˆ†é˜æ•™ä½ æ­å»ºä¸€å€‹ç¶²ç«™ï¼ˆä¸€ï¼‰ï¼šè³¼è²·å’Œé…ç½®æœå‹™å™¨ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/5f26f1582a564e93bde33a7dd9448c3b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ac25d2d0.html title=30åˆ†é˜æ•™ä½ æ­å»ºä¸€å€‹ç¶²ç«™ï¼ˆä¸€ï¼‰ï¼šè³¼è²·å’Œé…ç½®æœå‹™å™¨>30åˆ†é˜æ•™ä½ æ­å»ºä¸€å€‹ç¶²ç«™ï¼ˆä¸€ï¼‰ï¼šè³¼è²·å’Œé…ç½®æœå‹™å™¨</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d8be5e94.html alt=ä¸æœƒè²·æœå‹™å™¨ï¼Ÿä¸€å€‹è¾¦æ³•è®“ä½ è¼•é¬†æ­ç¶²ç«™ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/84d9c54578de46058796824f1bcb6a9b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d8be5e94.html title=ä¸æœƒè²·æœå‹™å™¨ï¼Ÿä¸€å€‹è¾¦æ³•è®“ä½ è¼•é¬†æ­ç¶²ç«™>ä¸æœƒè²·æœå‹™å™¨ï¼Ÿä¸€å€‹è¾¦æ³•è®“ä½ è¼•é¬†æ­ç¶²ç«™</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c811c5f7.html alt=ä½¿ç”¨æœå‹™å™¨æ­å»ºä¸€å€‹ç¶²ç«™ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/63a6cc0eb4d146e0890515500c0040ca style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c811c5f7.html title=ä½¿ç”¨æœå‹™å™¨æ­å»ºä¸€å€‹ç¶²ç«™>ä½¿ç”¨æœå‹™å™¨æ­å»ºä¸€å€‹ç¶²ç«™</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4b69aa7f.html alt=åšä¸€å€‹å°å‹ç¶²ç«™ï¼Œæœå‹™å™¨éœ€è¦ä»€éº¼é…ç½®çš„å‘¢ï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4b69aa7f.html title=åšä¸€å€‹å°å‹ç¶²ç«™ï¼Œæœå‹™å™¨éœ€è¦ä»€éº¼é…ç½®çš„å‘¢ï¼Ÿ>åšä¸€å€‹å°å‹ç¶²ç«™ï¼Œæœå‹™å™¨éœ€è¦ä»€éº¼é…ç½®çš„å‘¢ï¼Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/eee4b8ad.html alt=æ­å»ºä¸€å€‹ç¶²ç«™ï¼Œç§Ÿæœå‹™å™¨å¤§æ¦‚å¤šå°‘éŒ¢ï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/eee4b8ad.html title=æ­å»ºä¸€å€‹ç¶²ç«™ï¼Œç§Ÿæœå‹™å™¨å¤§æ¦‚å¤šå°‘éŒ¢ï¼Ÿ>æ­å»ºä¸€å€‹ç¶²ç«™ï¼Œç§Ÿæœå‹™å™¨å¤§æ¦‚å¤šå°‘éŒ¢ï¼Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/62d46b38.html alt=ç´ æç¥•ç±ï½œä¸€å€‹è€³æœµï¼9å¤§çŸ¥è­˜é»ï¼Œ360åº¦å…¨æ–¹ä½æ·±åº¦å‰–æè¬›è§£ç¤ºç¯„ï¼ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/5e7b0005767168b2b87d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/62d46b38.html title=ç´ æç¥•ç±ï½œä¸€å€‹è€³æœµï¼9å¤§çŸ¥è­˜é»ï¼Œ360åº¦å…¨æ–¹ä½æ·±åº¦å‰–æè¬›è§£ç¤ºç¯„ï¼>ç´ æç¥•ç±ï½œä¸€å€‹è€³æœµï¼9å¤§çŸ¥è­˜é»ï¼Œ360åº¦å…¨æ–¹ä½æ·±åº¦å‰–æè¬›è§£ç¤ºç¯„ï¼</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/647df9c2.html alt=ä¸€å€‹ç”·äººæ¯å¤©24å°æ™‚è·Ÿå¦»å­åœ¨ä¸€èµ·ï¼Œä¹…è€Œä¹…ä¹‹æœƒæ€æ¨£ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8359cc22f03e478a8cdb889dcfea3f99 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/647df9c2.html title=ä¸€å€‹ç”·äººæ¯å¤©24å°æ™‚è·Ÿå¦»å­åœ¨ä¸€èµ·ï¼Œä¹…è€Œä¹…ä¹‹æœƒæ€æ¨£>ä¸€å€‹ç”·äººæ¯å¤©24å°æ™‚è·Ÿå¦»å­åœ¨ä¸€èµ·ï¼Œä¹…è€Œä¹…ä¹‹æœƒæ€æ¨£</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5a86d7d9.html alt=æ¯å¤©ä¸€å€‹å¥½ç¿’æ…£ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RKdGgquJFM6gnc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5a86d7d9.html title=æ¯å¤©ä¸€å€‹å¥½ç¿’æ…£>æ¯å¤©ä¸€å€‹å¥½ç¿’æ…£</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/756b16fb.html alt=å¥¶ç²‰å¯„å‡ºä¸€å€‹æœˆï¼Œå®¶äººé²é²æ”¶ä¸åˆ°ï¼Œç‰©æµä¿¡æ¯ä¹ŸæŸ¥è©¢ä¸åˆ°ï¼Œäº‹ç™¼é˜œé™½æŸéŸ»é”å¿«éç¶²é» class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/3fd8ec4e-64c1-446a-adfa-38088fb06c01 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/756b16fb.html title=å¥¶ç²‰å¯„å‡ºä¸€å€‹æœˆï¼Œå®¶äººé²é²æ”¶ä¸åˆ°ï¼Œç‰©æµä¿¡æ¯ä¹ŸæŸ¥è©¢ä¸åˆ°ï¼Œäº‹ç™¼é˜œé™½æŸéŸ»é”å¿«éç¶²é»>å¥¶ç²‰å¯„å‡ºä¸€å€‹æœˆï¼Œå®¶äººé²é²æ”¶ä¸åˆ°ï¼Œç‰©æµä¿¡æ¯ä¹ŸæŸ¥è©¢ä¸åˆ°ï¼Œäº‹ç™¼é˜œé™½æŸéŸ»é”å¿«éç¶²é»</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b29ee719.html alt=åˆä¸€å€‹èµ°ä¸Šä¸æ­¸è·¯çš„æ¬ç£šäºº class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/bf471da0a06441f88bce49b959234257 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b29ee719.html title=åˆä¸€å€‹èµ°ä¸Šä¸æ­¸è·¯çš„æ¬ç£šäºº>åˆä¸€å€‹èµ°ä¸Šä¸æ­¸è·¯çš„æ¬ç£šäºº</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f09ac34c.html alt=å½©è‰²é›»å­æ›¸åœ¨å»£å·ç‡å…ˆå¯¦ç¾é‡ç”¢ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RkPMb9G6tipobr style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f09ac34c.html title=å½©è‰²é›»å­æ›¸åœ¨å»£å·ç‡å…ˆå¯¦ç¾é‡ç”¢>å½©è‰²é›»å­æ›¸åœ¨å»£å·ç‡å…ˆå¯¦ç¾é‡ç”¢</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3d6d5661.html alt=å¤šæ”¶è—ä¸€å€‹ï¼Œå°±å°‘æ±‚ä¸€æ¬¡äººâ€”å“ªäº›æ—¥å¸¸å¿…å‚™ç¥ç´šç¶²ç«™ï¼ŒçœŸæ­£å€¼å¾—æ”¶è— class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/833949926ebf49b89c5fb4075a9cffdd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3d6d5661.html title=å¤šæ”¶è—ä¸€å€‹ï¼Œå°±å°‘æ±‚ä¸€æ¬¡äººâ€”å“ªäº›æ—¥å¸¸å¿…å‚™ç¥ç´šç¶²ç«™ï¼ŒçœŸæ­£å€¼å¾—æ”¶è—>å¤šæ”¶è—ä¸€å€‹ï¼Œå°±å°‘æ±‚ä¸€æ¬¡äººâ€”å“ªäº›æ—¥å¸¸å¿…å‚™ç¥ç´šç¶²ç«™ï¼ŒçœŸæ­£å€¼å¾—æ”¶è—</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>