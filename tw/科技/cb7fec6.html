<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>NTP時鐘同步原理及誤差簡析 | 极客快訊</title><meta property="og:title" content="NTP時鐘同步原理及誤差簡析 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/47120001f0e1cbb22a29"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cb7fec6.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cb7fec6.html><meta property="article:published_time" content="2020-10-29T20:58:13+08:00"><meta property="article:modified_time" content="2020-10-29T20:58:13+08:00"><meta name=Keywords content><meta name=description content="NTP時鐘同步原理及誤差簡析"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/cb7fec6.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>NTP時鐘同步原理及誤差簡析</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>在我們某試驗系統方案設計中，由於數據同步性的要求，需要將我們WP4000變頻功率分析儀的時鐘與客戶的NI系統的時鐘進行同步，對於WP4000變頻功率測試系統而言，多臺分析儀之間可通過同步光纖接口達到嚴格同步，同步時序達us級。但要求WP4000變頻功率測試系統與其它系統之間保持同步，在同步性要求不是特別高的情況下，可以採用NTP時鐘同步的方式進行多系統間的同步，以下就NTP時鐘同步系統誤差進行簡析。</p><h1>一、NTP協議簡介</h1><p>網絡時間協議NTP(Network Time Protocol)的主要開發者是美國特拉華大學的MILLS David L教授設計實現的，由時間協議、ICMP時間戳消息及IP時間戳選項發展而來。NTP用於將計算機客戶或服務器的時間與另一服務器同步，使用層次式時間分佈模型。在配置時，NTP可以利用冗餘服務器和多條網絡路徑來獲得時間的高準確性和高可靠性。即使客戶機在長時間無法與某一時間服務器相聯繫的情況下,仍可提供高準確度時間。</p><p>實際應用中，還有確保秒級精度的簡單的網絡時間協議SNTP(Simple Network Time Protocol)。SNTP是NTP的一個子集,主要用於那些不需要NTP的精度以較高實現複雜性的網絡時間同步客戶機。SNTP協議已減少了網絡延時對校對準確的影響，但沒有冗餘服務器和校正時鐘頻率誤差功能。</p><p>一般的計算機和嵌入式設備在時鐘度方面沒有明確的指標要求, 時鐘精度只有10-4～10-5，每天可能誤差達十幾秒或更多，如果不及時校正，其累積時間誤差不可忽視。許多工業控制過程需要高準確度時間，如：電力系統內眾多的計算機監控系統、保護裝置、故障錄波器等時間同步要在ms級以內。</p><p>聯網計算機同步時鐘最簡便的方法是網絡授時。網絡授時分為廣域網授時和局域網授時。廣域網授時精度通常能達50ms級，但有時超過500ms，這是因為每次經過的路由器路徑可能不相同。現在還沒有更好的辦法將這種不同路徑延遲的時間誤差完全消除。局域網授時不存在路由器路徑延遲問題，因而授時精度理論上可以提到亞毫秒級。Windows內置NTP服務，在局域網內其最高授時精度也只能達10ms級。因此，提高局域網NTP授時精度成為一個迫切需要解決的問題。</p><h1>二、NTP授時原理</h1><p>NTP最典型的授時方式是Client/Server方式。如下圖1所示，客戶機首先向服務器發送一個NTP 包，其中包含了該包離開客戶機的時間戳T1，當服務器接收到該包時，依次填入包到達的時間戳T2、包離開的時間戳T3，然後立即把包返回給客戶機。客戶機在接收到響應包時，記錄包返回的時間戳T4。客戶機用上述4個時間參數就能夠計算出2個關鍵參數：NTP包的往返延遲d和客戶機與服務器之間的時鐘偏差t。客戶機使用時鐘偏差來調整本地時鐘，以使其時間與服務器時間一致。</p><p><img alt=NTP時鐘同步原理及誤差簡析 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/47120001f0e1cbb22a29></p><p>圖1 Client/Server方式下NTP授時原理</p><p>圖1中：T1為客戶發送NTP請求時間戳(以客戶時間為參照)；T2為服務器收到NTP請求時間戳(以服務器時間為參照)；T3為服務器回覆NTP請求時間戳(以服務器時間為參照)；T4為客戶收到NTP回覆包時間戳(以客戶時間為參照)；d1為NTP請求包傳送延時，d2為NTP回覆包傳送延時；t為服務器和客戶端之間的時間偏差，d為NTP包的往返時間。</p><p>現已經T1、T2、T3、T4，希望求得t以調整客戶方時鐘：</p><p><img alt=NTP時鐘同步原理及誤差簡析 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/470800024e03b1401767></p><p>....................................................式(1)</p><p>假設NPT請求和回覆包傳送延時相等，即d1=d2，則可解得“</p><p><img alt=NTP時鐘同步原理及誤差簡析 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/470800024e05d4db8c07></p><p>.....................................式(2)</p><p>根據式(1)，t也可表示為：t=(T2-T1)+d1=(T2-T1)+d/2.....................式(3)</p><p>可以看出，t、d只與T2、T1差值及T3、T4差值相關，而與T2、T3差值無關，即最終的結果與服務器處理請求所需的時間無關。因此，客戶端即可通過T1、T2、T3、T4計算出時差t去調整本地時鐘。</p><h1>三、NTP授時精度分析</h1><p>NTP授時精度與NTP服務器與用戶間的網絡狀況有關，主要取決於NTP包往返路由的延時對稱程度，往返路由的延時不對稱值最大不超過網絡延時。式(2)是在假設NTP請求和回覆包在網上傳送延時相等，即d1=d2=d/2的情況下得出的，而d1、d2的取值範圍在(0...d)間，由式(3)可以得出最大授時誤差是±d/2。一般廣域網的網絡延時在10 ms～500ms之間;局域網的網絡延時在計時操作系統內核處理延遲的情況下通常小於1ms。</p><p>假定局域網內NTP延時小於1ms，理論上授時誤差小於0.5ms，但對於Windows操作系統內置的NTP客戶和NTP服務，並不能達到此精度。Windows NTP時鐘分辨率因操作系統和硬件不同而有所不同，時鐘分辨率通常為10ms或15ms。基於Windows操作系統內置的NTP授時精度最高不超過10ms。</p><h1>四、基於NTP減少計算機時鐘偏差</h1><p><strong>01、計算機時鐘偏差分析</strong></p><p>通用PC機自帶兩類時鐘源：硬件時鐘和軟件時鐘(或稱為系統時鐘)。不論是硬件時鐘還是軟件時鐘，都是由石英晶體振盪器驅動的，通過累計石英晶體振盪器輸出脈衝數，換算出時間。所以計算機時鐘的準確度取決於晶振頻率準確度。受溫度變化、電壓、芯片老化等因素影響，晶振頻率會發生小幅度波動，其中溫度對晶振頻影響最大。</p><p>由於工藝和材料的原因，同一生產線上標稱頻率相同的石英晶體，其實際頻率是不同的，實際頻率與標稱頻率偏差率從10-4量級到10-9量級不等。以10-4量級為例，時鐘每天至少誤差8.64 s。</p><p><strong>02、基於NTP減少計算機時鐘頻率偏差</strong></p><p>時鐘頻率偏差是時鐘長期計時累積誤差的主要原因，要提高時鐘長期計時精度，必須補償時鐘頻率偏差。聯網的計算機可採用NTP方式,可非常方便地校準時鐘頻率偏差。以NTP服務器時鐘為標準時間，在某一時刻設置NTP客戶機時間為NTP服務器當前時間T0，經過一段時間後，NTP服務器時間為T0+tsn，NTP客戶端時間為T0+tcn。因為存在時鐘頻率偏差，tsn與tcn並不相等。NTP客戶端時間tcn需乘以時鐘頻率偏差係數k才等於tsn，即tsn=k×tcn，所以k=tsn/tcn。</p><p>任何晶振實際工作頻率都是不穩定的，只是程度不同而已。即使溫度補償的晶振，在常溫範圍內(攝氏10℃～35℃)也有大約5×10-7～2×10-6的誤差。晶振實際頻率是受外界多種因素(溫度、電壓、老化等)影響而改變的。因此，時鐘頻率偏差係數k並非恆定不變的。每隔一定時間，NTP客戶機要對時鐘頻率偏差係數k進行校正，才能保證計時精度。</p><h1>五、進一步提高NTP授時精度的方法</h1><p>局域網絡延相對較大的原因在於時間戳一般都是在應用層加蓋。為減少操作系統內核處理延時的影響提高NTP授時精度，發/收NTP包時間戳應儘量接近主機真實發/收包時刻。在不改變硬件的條件下，一個可行的辦法是修改網卡驅動程序，將記錄NTP包發/收時間戳從應用程序移至網卡驅動程序處，可消除操作系統內核處理延時不確定而引入的誤差。這種方法在局域網中可大幅提高NTP授時精度至μs級。</p><p>為了減少溫度引起晶振頻率漂移對時鐘準確度的影響，可以採用數字溫漂補償方法，提高時鐘長期計時準確度。先測出工作溫度範圍內溫度對應的溫漂補償係數，工作時每隔一定時間，根據實際溫度查出對應補償係數動態地修正時間。</p><p>時鐘頻率偏差和時鐘分辨率低是局域網NTP授時精度不高的主要原因。</p><p>【原文：https://www.vfe.cc/NewsDetail-2332.aspx，轉載務必帶鏈接註明出處，未註明必追究責任!】</p><h1>相關文章:</h1><p>新能源汽車電機以及驅動器測試專家 https://www.vfe.cc/ProductShow.aspx?id=59</p><p>如何對電動汽車電源控制器實現精確測試 https://www.vfe.cc/NewsDetail-1403.aspx</p><p>電動汽車電機試驗檯測試系統解決方案 https://www.vfe.cc/NewsDetail-1554.aspx</p><p>如何選擇電動汽車電池監測系統 https://www.vfe.cc/NewsDetail-906.aspx</p><p>新能源電動汽車動力電池測試的基本要求及檢測內容https://www.vfe.cc/NewsDetail-2321.aspx</p><p>超級電容器電池 https://www.vfe.cc/NewsDetail-1556.aspx</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>NTP</a></li><li><a>時鐘</a></li><li><a>及誤</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/3e29dbac.html alt=基站時鐘的信號源詳談 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15389837414220083bb0d29 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3e29dbac.html title=基站時鐘的信號源詳談>基站時鐘的信號源詳談</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9f53edd9.html alt=數字電子時鐘電路圖的設計原理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b245b50ea9c941cb954fba408b66a541 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9f53edd9.html title=數字電子時鐘電路圖的設計原理>數字電子時鐘電路圖的設計原理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7e539424.html alt=時鐘測試儀是如何校準的 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/fadd9ef687ec4d4f9df7047e1c255709 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7e539424.html title=時鐘測試儀是如何校準的>時鐘測試儀是如何校準的</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/33fd7592.html alt=電力系統的時鐘同步 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c3cf1694e8c340499676cc955e1b4478 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/33fd7592.html title=電力系統的時鐘同步>電力系統的時鐘同步</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fd559235.html alt=技術貨：內部時鐘和外部時鐘隔離的-調製器 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RJLlrPvIfzgNLU style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fd559235.html title=技術貨：內部時鐘和外部時鐘隔離的-調製器>技術貨：內部時鐘和外部時鐘隔離的-調製器</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f2f7d5b.html alt=聯想智能時鐘基本評測 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/90717066c3d54fd08011190f89193d51 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f2f7d5b.html title=聯想智能時鐘基本評測>聯想智能時鐘基本評測</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/be29a8d.html alt="原油市場時鐘正由衰轉盛 石油公司的好日子或即將開啟" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/cb14fafd092f4f03b86affa5e0599e72 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/be29a8d.html title="原油市場時鐘正由衰轉盛 石油公司的好日子或即將開啟">原油市場時鐘正由衰轉盛 石油公司的好日子或即將開啟</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/476d340.html alt=海里的時鐘-氟氯烴 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/835700050903b20db228 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/476d340.html title=海里的時鐘-氟氯烴>海里的時鐘-氟氯烴</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/45f2935.html alt=時鐘在量子世界中變得模糊：有東西限制我們去精確測量時間 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/18a90007aa292c2f5614 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/45f2935.html title=時鐘在量子世界中變得模糊：有東西限制我們去精確測量時間>時鐘在量子世界中變得模糊：有東西限制我們去精確測量時間</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/53de12c.html alt=量子邏輯時鐘最高性能：宇宙年齡的2.5倍，330億年誤差不到1秒 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7076b103939547f798fd3a33a97b86c7 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/53de12c.html title=量子邏輯時鐘最高性能：宇宙年齡的2.5倍，330億年誤差不到1秒>量子邏輯時鐘最高性能：宇宙年齡的2.5倍，330億年誤差不到1秒</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>