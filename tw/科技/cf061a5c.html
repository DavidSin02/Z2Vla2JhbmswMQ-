<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>我對 MySQL 鎖、事務、MVCC 的一些認識 | 极客快訊</title><meta property="og:title" content="我對 MySQL 鎖、事務、MVCC 的一些認識 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/5d6e32482c364fe3b5f9436a30671330"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cf061a5c.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cf061a5c.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cf061a5c.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cf061a5c.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cf061a5c.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cf061a5c.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/cf061a5c.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/cf061a5c.html><meta property="article:published_time" content="2020-11-14T21:08:11+08:00"><meta property="article:modified_time" content="2020-11-14T21:08:11+08:00"><meta name=Keywords content><meta name=description content="我對 MySQL 鎖、事務、MVCC 的一些認識"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/cf061a5c.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>我對 MySQL 鎖、事務、MVCC 的一些認識</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>單條SQL語句執行時，會被當成一個事務提交嗎？</h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">以下內容摘自 《高性能MySQL》(第3版)</span></p><blockquote><p><span style="color:#f83929;--tt-darkmode-color: #F83929"><span style="background-color:#f5f5f5;--tt-darkmode-bgcolor: #1C1C1C">“</span></span></p><p><span style="background-color:#f5f5f5;--tt-darkmode-bgcolor: #1C1C1C">MySQL默認採用自動提交（AUTOCOMMIT）模式。也就是說，如果不是顯式地開始一個事務，則每個查詢都被當作一個事務執行提交操作。在當前連接中，可以通過設置AUTOCOMMIT變量來啟用或者禁用自動提交模式</span></p><p><span style="color:#f83929;--tt-darkmode-color: #F83929"><span style="background-color:#f5f5f5;--tt-darkmode-bgcolor: #1C1C1C">”</span></span></p></blockquote><div class=pgc-img><img alt="我對 MySQL 鎖、事務、MVCC 的一些認識" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/5d6e32482c364fe3b5f9436a30671330><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>MySQL 是如何實現事務的 ACID 的？<br></strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">事務具有 ACID 四大特性，那麼 MySQL 是如何實現事務的這四個屬性的呢？</span></p><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">原子性 要麼全部成功，要麼全部失敗。MySQL是通過記錄 undo_log 的方式來實現的原子性。undo_log 即</span><span style="color:#f83929;--tt-darkmode-color: #F83929">回滾日誌</span>，在真正的SQL執行之前先將 undo_log 寫入磁盤，然後再對數據庫的數據進行操作。如果發生異常或回滾，就可以依據 undo_log 進行反向操作，恢復數據在事務執行之前的樣子。</li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">持久性 事務一旦被正常提交，它對數據庫的影響就應該是永久的。此時即使系統崩潰，修改的數據也不會丟失。InnoDB 作為 MySQ L的存儲引擎，數據是存放在磁盤中的，但如果每次讀寫數據都需要磁盤IO，效率會很低。為此，InnoDB 提供了緩存(Buffer Pool)，作為訪問數據庫的緩衝：當從數據庫讀取數據時，會首先從 Buffer Pool 中讀取，如果 Buffer Pool 中沒有，則從磁盤讀取後放入 Buffer Pool ；當向數據庫寫入數據時，會首先寫入 Buffer Pool，Buffer Pool 中修改的數據會定期刷新到磁盤中。這樣的設計也帶來了相應的問題：如果數據提交了，這時數據還在緩衝池裡（還沒刷盤），此時MySQL宕機、斷電了怎麼辦？數據會不會丟失？答案是不會，MySQL 通過 redo_log 的機制，保證了持久性。redo_log 即</span><span style="color:#f83929;--tt-darkmode-color: #F83929">重做日誌</span>，簡單說就是當數據修改時，除了修改 Buffer Pool 中的數據，還會在 redo_log 記錄這次操作；當事務提交時，會調用 fsync 接口對 redo_log 進行刷盤。如果MySQL宕機，重啟時可以讀取 redo_log 中的數據，對數據庫進行恢復。</li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">隔離性隔離性是 ACID 裡面最複雜的一個，這裡面涉及到隔離級別的概念，一共有四個</span><span style="color:#f83929;--tt-darkmode-color: #F83929">簡單說隔離級別就是規定了：一個事務中數據的修改，哪些事務之間可見，哪些不可見。而隔離性就是要管理多個併發讀寫請求的訪問順序。</span>MySQL 對於隔離性的具體實現我們後面會展開說。</li><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Read uncommitted</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Read committed</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Repeatable read</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Serializable</span></li></ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">一致性通過回滾、恢復和在併發環境下的隔離做到一致性。</span></li></ul><h1 class=pgc-h-arrow-right><strong>事務併發可能導致的問題</strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">通過上個問題我知道單條 DDL 執行也會被當成一個事務自動提交，那麼無論是多條SQL併發，還是多個自己手動組織的包含多條SQL的事務併發，都會導致事務併發問題。</span></p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">具體來說有：</span></p><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">髒寫 （一個事務提交的數據覆蓋了另一個事務未提交的數據）</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">髒讀 （一個事務讀取到另一個事務未提交的數據）</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">不可重複讀 （重點在於update和delete 一個事務內多次讀取的數據不一樣）</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">幻讀 （重點在於insert 一個事務內多次讀取的記錄數不一樣）</span></li></ul><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">上面我們提到了事務的隔離級別，MySQL 的所有隔離級別都能保證不產生髒寫，所以就剩下髒讀、不可重複讀和幻讀的問題了。</span></p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">下面具體看下各隔離級別是如何解決或未解決上面這些問題的：</span></p><div class=pgc-img><img alt="我對 MySQL 鎖、事務、MVCC 的一些認識" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c525f4cbf1ad4bfabd6c9b5e42fb0c2f><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong>Read uncommitted<br></strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">未提交讀，這個級別在讀的過程中不會加任何鎖，只在寫請求時加鎖，所以寫操作在讀的過程中修改數據，就會造成髒讀。也自然會產生不可重複讀和幻讀。</span></p><h1 class=pgc-h-arrow-right><strong>Read committed</strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">已提交讀，與未提交讀一樣也是讀不加鎖，寫加鎖。不一樣的是利用了 MVCC 機制避免了髒讀的問題，同樣會有不可重複讀和幻讀的問題。關於 MVCC 我們後面會詳細說。</span></p><h1 class=pgc-h-arrow-right><strong>Repeatable read</strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">MySQL 默認的隔離級別，在這個級別 MySQL利用兩種方式解決問題</span></p><ol start=1><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">讀寫鎖 讀讀並行時加讀鎖，讀讀是共享鎖的。只要有寫請求就加寫鎖，這樣讀寫是串行的。讀取數據時加鎖，其它事務無法修改這些數據。所以不會產生不可重複讀。修改刪除數據時也要加鎖，其它事務無法讀取這些數據，所以不會產生髒讀。第一種方式就是我們常說的 </span><span style="color:#f83929;--tt-darkmode-color: #F83929">“悲觀鎖”</span>，數據在整個事務處理過程中處於鎖定狀態，比較保守，性能開銷比較大。</li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">MVCC （後面講）</span></li></ol><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">此外還利用了Next-Key鎖 在一定程度上解決了幻讀的問題。關於這個我們後面再說。</span></p><h1 class=pgc-h-arrow-right><strong>Serializable</strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">在該隔離級別下事務都是串行順序執行的。如果禁用了自動提交，則 InnoDB 會將所有普通的 SELECT 語句隱式轉換為 SELECT ... LOCK IN SHARE MODE。即給讀操作隱式加一把讀共享鎖，從而避免了髒讀、不可重讀復讀和幻讀問題。</span></p><h1 class=pgc-h-arrow-right><strong>MVCC</strong></h1><blockquote><p><span style="color:#f83929;--tt-darkmode-color: #F83929"><span style="background-color:#f5f5f5;--tt-darkmode-bgcolor: #1C1C1C">“</span></span></p><p><span style="background-color:#f5f5f5;--tt-darkmode-bgcolor: #1C1C1C">Multiversion concurrency control (MCC or MVCC), is a concurrency control method commonly used by database management systems to provide concurrent access to the database and in programming languages to implement transactional memory</span></p><p><span style="color:#f83929;--tt-darkmode-color: #F83929"><span style="background-color:#f5f5f5;--tt-darkmode-bgcolor: #1C1C1C">”</span></span></p></blockquote><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">翻譯過來就是：多版本併發控制（MCC或MVCC）是一種併發控制方法，通常被數據庫管理系統用來提供對數據庫的併發訪問，並以編程語言來實現事務存儲。</span></p><p><span style="color:#f83929;--tt-darkmode-color: #F83929">簡單來說就是數據庫用來控制併發的一種方法。每個數據庫對於 MVCC 的實現可能不一樣。</span></p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">以我們常用的 MySQL 來說，MySQL 的 InnoDB 引擎實現了 MVCC 。</span></p><h1 class=pgc-h-arrow-right><strong>MVCC 能解決什麼問題</strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">從上面的定義我們能看出，MVCC 主要解決事務併發時數據一致性的問題</span></p><h1 class=pgc-h-arrow-right><strong>InnoDB 是如何實現的 MVCC</strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">下面這個圖來自《高性能MySQL》(第3版)</span></p><div class=pgc-img><img alt="我對 MySQL 鎖、事務、MVCC 的一些認識" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/6ba7e479aef044cea8d61379aab1dabf><p class=pgc-img-caption></p></div><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">這本書寫的很好，翻譯的也不錯，我對於 MySQL 最初的系統性認識也是因為讀了這本書，然而在對於 MVCC 是如何實現的講述上，個人認為是有些問題的。</span></p><p><span style="color:#f83929;--tt-darkmode-color: #F83929">來看下哪裡有問題</span></p><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">首先看下 MySQL 的官方文檔，我對比了 5.1、5.6、5.7 三個版本的 </span><span style="color:#f83929;--tt-darkmode-color: #F83929">文檔[1]</span> ，對 MVCC 這部分的描述，幾乎是相同的。</li></ul><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">根據文檔很明顯是在每條數據增加三個隱藏列：</span></p><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">6字節的 DB_TRX_ID 字段，表示最近一次插入或者更新該記錄的事務ID。</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">7字節的 DB_ROLL_PTR 字段，指向該記錄的 rollback segment 的 undo log 記錄。</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">6字節的 DB_ROW_ID，當有新數據插入的時候會自動遞增。當表上沒有用戶主鍵的時候，InnoDB會自動產生聚集索引，包含DB_ROW_ID字段。</span></li></ul><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">這裡我補充一張包含 rollback segment 的 MySQL 內部結構圖</span></p><div class=pgc-img><img alt="我對 MySQL 鎖、事務、MVCC 的一些認識" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/116176c8a3cc4a4ea9f77d3b282860f9><p class=pgc-img-caption></p></div><p><span style="color:#f83929;--tt-darkmode-color: #F83929">版本鏈</span></p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">之前我們講過 undo_log 的概念，每條 undo日誌都有一個 roll_pointer 屬性，那麼所有的版本都會被 roll_pointer 屬性連接成一個鏈表，我們把這個鏈表稱之為版本鏈，版本鏈的頭節點就是當前記錄最新的值。</span></p><p><span style="color:#f83929;--tt-darkmode-color: #F83929">ReadView</span></p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">通過隱藏列和版本鏈，MySQL 可以將數據恢復到指定版本；但是具體要恢復到哪個版本，則需要根據 ReadView 來確定。所謂 ReadView，是指事務（記作事務A）在某一時刻給整個事務系統（trx_sys）打快照，之後再進行讀操作時，會將讀取到的數據中的事務 id 與 trx_sys 快照比較，從而判斷數據對該 ReadView 是否可見，即對事務A是否可見。（</span><span style="color:#f83929;--tt-darkmode-color: #F83929">參考[2]</span>）</p><p><span style="color:#f83929;--tt-darkmode-color: #F83929">至此我們發現 MVCC 就是基於隱藏字段、undo_log 鏈和 ReadView 來實現的。</span></p><h1 class=pgc-h-arrow-right><strong>Read committed 中的 MVCC</strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">前面我們講過 Read committed 隔離級別中使用 MVCC 解決髒讀問題。這裡我參考了兩篇文章：</span></p><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">https://cloud.tencent.com/developer/article/1150633</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">https://cloud.tencent.com/developer/article/1150630</span></li></ul><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">InnoDB只會查找版本早於當前事務版本的數據行（也就是，行的版本號小於或是等於事務的系統版本號），這樣可以確保數據讀取的行，要麼是在事務開始前已經存在的，要麼是事務自身插入或修改過的。</span><span style="color:#f83929;--tt-darkmode-color: #F83929">因此不會產生髒讀</span>。</p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Read committed 隔離級別下出現不可重複讀是由於 read view 的生成機製造成的。在 Read committed 級別下，只要當前語句執行前已經提交的數據都是可見的。在每次語句執行的過程中，都關閉 read view, 重新創建當前的一份 read view。這樣就可以根據當前的全局事務鏈表創建 read view 的事務區間。簡單說就是在 Read committed 隔離級別下，MVCC 在每次 select 時生成一個快照版本，所以每次 select 都會讀到不同的版本數據，</span><span style="color:#f83929;--tt-darkmode-color: #F83929">所以會產生不可重複讀</span>。</p><h1 class=pgc-h-arrow-right><strong>Repeatable read 中的 MVCC</strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Repeatable read 隔離級別解決了不可重複讀的問題，一個事務中多次讀取不會出現不同的結果，保證了可重複讀。前文中我們說 Repeatable read 有兩種實現方式，一種是悲觀鎖的方式，相對的 MVCC 就是樂觀鎖的方式。</span></p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Repeatable read 隔離級別能解決不可重複讀根本原因其實就是 read view 的生成機制和 Read committed 不同。</span></p><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Read committed ：只要是當前語句執行前已經提交的數據都是可見的。</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Repeatable read ：只要是當前事務執行前已經提交的數據都是可見的。</span></li></ul><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">不像 Read committed，在 Repeatable read 的隔離級別下，創建事務的時候，就生成了當前的 global read view,一直維持到事務結束。這樣就能實現可重複讀。</span></p><h1 class=pgc-h-arrow-right><strong>幻讀與 Next-Key 鎖</strong></h1><h1 class=pgc-h-arrow-right><strong>當前讀與快照讀</strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">通過 MVCC 機制，雖然讓數據變得可重複讀，但我們讀到的數據可能是歷史數據，是不及時的數據，不是數據庫當前的數據！對於這種讀取歷史數據的方式，我們叫它</span><span style="color:#f83929;--tt-darkmode-color: #F83929">快照讀</span> (snapshot read)，而讀取數據庫當前版本數據的方式，叫<span style="color:#f83929;--tt-darkmode-color: #F83929">當前讀</span> (current read) <span style="color:#f83929;--tt-darkmode-color: #F83929">參考[3]</span></p><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">快照讀：就是select</span></li><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">select * from table ….;</span></li></ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">當前讀：特殊的讀操作，插入/更新/刪除操作，屬於當前讀，處理的都是當前的數據，需要加鎖。</span></li><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">select * from table where ? lock in share mode;</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">select * from table where ? for update;</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">insert;</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">update ;</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">delete;</span></li></ul></ul><h1 class=pgc-h-arrow-right><strong>解決幻讀</strong></h1><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">為了解決</span><span style="color:#f83929;--tt-darkmode-color: #F83929">當前讀</span>中的幻讀問題，MySQL事務使用了 next-key lock 。</p><div class=pgc-img><img alt="我對 MySQL 鎖、事務、MVCC 的一些認識" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/293f77e55e714ddf86fd0f62d0f2d214><p class=pgc-img-caption></p></div><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Repeatable read 通過 next-key lock 機制避免了幻讀現象。</span></p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">InnoDB存儲引擎有3種行鎖的算法，分別是：</span></p><ul><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Record Lock: 單個記錄上的鎖</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Gap Lock: 間隙鎖，鎖定一個範圍，但不包括記錄本上</span></li><li><span style="color:#353535;--tt-darkmode-color: #A3A3A3">Next-Key Lock: Gap Lock + Record Lock</span></li></ul><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">next-key lock 是行鎖的一種，實現相當於 record lock(記錄鎖) + gap lock(間隙鎖)；其特點是不僅會鎖住記錄本身( record lock 的功能)，還會鎖定一個範圍( gap lock 的功能)。</span></p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">當InnoDB掃描索引記錄的時候，會首先對索引記錄加上行鎖（Record Lock），再對索引記錄兩邊的間隙加上間隙鎖（Gap Lock）。加上間隙鎖之後，其他事務就不能在這個間隙修改或者插入記錄。</span></p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">當查詢的索引含有唯一屬性的時候，Next-Key Lock 會進行優化，將其降級為Record Lock，即僅鎖住索引本身，不是範圍。</span></p><p><span style="color:#353535;--tt-darkmode-color: #A3A3A3">下圖引用自 </span><span style="color:#f83929;--tt-darkmode-color: #F83929">雲棲社區[4]</span></p><div class=pgc-img><img alt="我對 MySQL 鎖、事務、MVCC 的一些認識" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/810815a5ed9040e89361a730c79a3f83><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right><strong><span style="color:#f83929;--tt-darkmode-color: #F83929">參考資料</span></strong></h1><p><span style="color:#f83929;--tt-darkmode-color: #F83929">[1]</span></p><p>mysql 5.7文檔:<em><span style="color:#353535;--tt-darkmode-color: #A3A3A3">https://dev.mysql.com/doc/refman/5.7/en/innodb-multi-versioning.html</span></em></p><p><span style="color:#f83929;--tt-darkmode-color: #F83929">[2]</span></p><p>參考博客:<em><span style="color:#353535;--tt-darkmode-color: #A3A3A3">https://www.cnblogs.com/kismetv/p/10331633.html</span></em></p><p><span style="color:#f83929;--tt-darkmode-color: #F83929">[3]</span></p><p>美團技術博客:<em><span style="color:#353535;--tt-darkmode-color: #A3A3A3">https://tech.meituan.com/2014/08/20/innodb-lock.html</span></em></p><p><span style="color:#f83929;--tt-darkmode-color: #F83929">[4]</span></p><p>雲棲社區:<em><span style="color:#353535;--tt-darkmode-color: #A3A3A3">https://yq.aliyun.com/articles/108095</span></em></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>MySQL</a></li><li><a>事務</a></li><li><a>MVCC</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html alt="MySQL 事務處理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0be408a4.html title="MySQL 事務處理">MySQL 事務處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html alt=MySQL——事務(Transaction)詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/29d4c92c9c2344838eb72ef948cf08fa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8a538d3c.html title=MySQL——事務(Transaction)詳解>MySQL——事務(Transaction)詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html alt=MySQL數據庫的事務管理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/152203544367254a708f807 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3269d080.html title=MySQL數據庫的事務管理>MySQL數據庫的事務管理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7d322f7b.html alt=MySQL系列-第14篇：事務詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/a5b520dd476345e2b3aac97a8fcb77d5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7d322f7b.html title=MySQL系列-第14篇：事務詳解>MySQL系列-第14篇：事務詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/efc2a519.html alt=你知道MySQL的事務處理和隔離級別嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/efc2a519.html title=你知道MySQL的事務處理和隔離級別嗎？>你知道MySQL的事務處理和隔離級別嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4959ed6a.html alt="技術分享 | MySQL 的嵌套事務、自治事務與鏈式事務" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4959ed6a.html title="技術分享 | MySQL 的嵌套事務、自治事務與鏈式事務">技術分享 | MySQL 的嵌套事務、自治事務與鏈式事務</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/175f9730.html alt=深入學習MySQL事務：ACID特性的實現原理「轉」 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/cdc702d66d6943499997d11e931425eb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/175f9730.html title=深入學習MySQL事務：ACID特性的實現原理「轉」>深入學習MySQL事務：ACID特性的實現原理「轉」</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0482a52.html alt="MySQL 事務的四種隔離級別，研讀完了你能吊打面試官" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1a7cb2436dec4249b34a8c79cdb17e9c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0482a52.html title="MySQL 事務的四種隔離級別，研讀完了你能吊打面試官">MySQL 事務的四種隔離級別，研讀完了你能吊打面試官</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dacc263.html alt=MySQL數據庫中的事務以及創建表的注意事項 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dacc263.html title=MySQL數據庫中的事務以及創建表的注意事項>MySQL數據庫中的事務以及創建表的注意事項</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/daee1f6.html alt=MySQL事務提交過程（一） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/61f7b3575cea4b20b5e0400f9ad4d11b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/daee1f6.html title=MySQL事務提交過程（一）>MySQL事務提交過程（一）</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/720ab20.html alt=MySQL事務管理的介紹（附示例） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/720ab20.html title=MySQL事務管理的介紹（附示例）>MySQL事務管理的介紹（附示例）</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/e6b01ca.html alt=數據庫事務系列－MySQL跨行事務模型 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/dfic-imagehandler/64c5efca-90a2-44e0-99ff-f3cfd727679e style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/e6b01ca.html title=數據庫事務系列－MySQL跨行事務模型>數據庫事務系列－MySQL跨行事務模型</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c9091681.html alt="MySQL 學習筆記" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c9091681.html title="MySQL 學習筆記">MySQL 學習筆記</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a79ba4c0.html alt=MySQL事務隔離級別 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/2d4e804a44534da997212c94ea61e90c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a79ba4c0.html title=MySQL事務隔離級別>MySQL事務隔離級別</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8293e598.html alt=MySQl事務最全詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c61163c863114226b14bb3760da19e4d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8293e598.html title=MySQl事務最全詳解>MySQl事務最全詳解</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>