<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>CAN總線協議詳解 | 极客快訊</title><meta property="og:title" content="CAN總線協議詳解 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/72c49427aae34856b73a5f367c1f2c28"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1a9e79e.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1a9e79e.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d1a9e79e.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1a9e79e.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1a9e79e.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d1a9e79e.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d1a9e79e.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d1a9e79e.html><meta property="article:published_time" content="2020-10-29T21:09:31+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:31+08:00"><meta name=Keywords content><meta name=description content="CAN總線協議詳解"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/d1a9e79e.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>CAN總線協議詳解</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p><strong>CAN總線定義：</strong></p><p>CAN(Control Area Network)屬於現場總線的範疇，是一種高性能、高可靠性、易於開發和低成本的串行總線。</p><p>CAN是由德國Bosch公司在1986年為汽車監測和控制而設計的。由於其高性能、高可靠性、實時性等優點，隨後也廣泛用於工業自動化、多種控制設備、交通工具、醫療儀器以及建築、環境控制等多種領域，其在每個領域的廣泛使用促進了標準化的進程。</p><p>1991年9月PHILIPS SEMICONDUCTORS制訂併發布了CAN技術規範V2.0，該技術規範包括A和B兩部分。2.0A曾在CAN技術規範1.2中定義的CAN報文格式，提供11位地址；而2.0B給出了標準和擴展的兩種報文格式，提供29位地址。此後ISO在1993年11月也正式發佈了CAN的國際標準ISO11898。其中ISO11898-1定義了CAN數據鏈路層；ISO11898-2定義了非容錯CAN物理層；ISO11898-3定義了11898-3的容錯物理層。CAN總線協議只定義了物理層和數據鏈路層，要將CAN總線應用於實際的工程項目和產品開發中必須制定上層應用協議。目前汽車上應用的協議有：ISO15675(傳輸層協議)、ISO14229(應用層協議)等。</p><p><strong>CAN總線的特點</strong></p><p>1、 多主控制方式。在總線空閒時，所有單元都可往總線上發送消息（多主控制）。最先訪問總線的單元可獲得發送權（採用CSMA/CA方式）。當多個單元同時發送時，CANID小的節點獲得發送權。</p><p>2、 非破壞性總線仲裁技術。當總線發生衝突時，高優先級報文可以不受影響的進行傳輸，保證高優先級的實時性要求；而低優先級的報文退出傳輸。</p><p>3、 高可靠性。每幀都有位填充，CRC校驗等多種錯誤檢測，保證了極低的錯誤率；發送期間丟失仲裁或者由於錯誤而破壞了的數據幀可自動重發（這一點由CAN控制器自己重發，無需人為重新裝載發送數據）。</p><p>4、 自動關閉總線。CAN控制器可以檢測和判斷總線上的錯誤類型，是短暫的數據錯誤（如外部噪聲），還是持續數據錯誤（如單元內部故障、驅動器故障、短路故障等）。當錯誤為持續性故障時，CAN控制器可自動關閉，脫離總線，以免影響總線上的其他節點正常通信。</p><p><strong>CAN總線拓撲圖</strong></p><p>CAN控制器根據兩根線上的電位差來判斷總線電平。總線電平分為顯性和隱性電平，二者必居其一。發送方通過使總線電平變化，將消息發送給接收方。下圖1是一個CAN總線連接示意圖。</p><p>下圖1由兩個CAN網絡組成，其中一個網絡通信速率為500K，另外一個為125K。每個CAN網絡由CANH和CANL兩根線組成，各個節點（ABS、SAS、ETM、ECM）分別連接在CANH和CAHL上。在每個CAN網絡的頭尾分別連接了兩個終端電阻，終端電阻的大小為120歐姆。</p><p>下圖1左邊陰影部分是某個節點的內部電路模塊，包含CPU、CAN控制器（CAN Controller，一般單片機都集成了CAN控制器模塊）以及CAN收發器(CAN transceiver)。其中CPU負責將需要發送的數據傳遞給CAN控制器，以及接收從CAN控制器中解析的數據；CAN控制器將Rx腳的二進制的0/1轉換為具體的報文，然後將報文傳遞給CPU，以及將CPU需要發送的報文轉換為二進制0/1，然後通過Tx腳傳遞給CAN收發器。CAN控制器的主要功能是電平轉換,將CANH和CANL上的電平轉換為Rx腳上的0/1，將Tx腳上的0/1在CANH和CANL進行轉換。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/72c49427aae34856b73a5f367c1f2c28><p class=pgc-img-caption>圖1</p></div><p><strong>信號電平</strong></p><p>高速CAN，定義 當CANH 和 CANL 電壓相同（CANH = CANL = 2.5V）時為邏輯“1”，CANH和CANL 電壓相差 2V（CANH = 3.5V, CANL = 1.5V） 時為邏輯“0”。高速CAN收發器在共模電壓範圍內（-12V ~ 12V），將CANH和CANL電壓相差大於 0.9V 解釋為顯性狀態（Dominant），而將CANH和CANL電壓相差小於 0.5V 解釋為為隱性狀態（Recessive）。</p><p>CAN總線採用<strong>不歸零碼位填充技術</strong>，也就是說CAN總線上的信號有兩種不同的信號狀態，分別是顯性的(Dominant)邏輯0和隱形的(recessive)邏輯1，信號每一次傳輸完後不需要返回到邏輯0(顯性)的電平。</p><p><strong>CAN信號傳輸</strong></p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/09da632762614eb2b9a76c44cba6612a><p class=pgc-img-caption>圖2 a</p></div><p><strong>發送過程：</strong> CAN控制器將CPU傳來的報文轉換為邏輯電平（即邏輯0-顯性電平或者邏輯1-隱性電平）通過Tx腳傳遞給CAN收發器。CAN收發器接收邏輯電平之後，再將其轉換為差分電平輸出到CAN總線上。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/1e212a9a07e242af93552a6105e2fcec><p class=pgc-img-caption>圖2 b</p></div><p><strong>接收過程：</strong> CAN收發器將CAN_H 和 CAN_L 線上傳來的差分電平轉換為邏輯電平輸出到CAN控制器的Rx腳，CAN控制器再把該邏輯電平轉化為相應報文發送到CPU上。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f5533eda299140a897fce14341a9e14f><p class=pgc-img-caption>圖2 c</p></div><p><strong>報文傳輸</strong></p><p><strong>幀類型</strong></p><p>CAN總線在報文傳輸中，可傳輸以下4種不同類型的幀報文：</p><p>數據幀：數據幀裝載的是發送數據，它將數據從發送節點傳輸到接收節點；</p><p>遠程幀：遠程幀請求具有相同標識符（CANID）的數據幀的發送，實際很少使用；</p><p>錯誤幀：任何節點檢測到總線錯誤時都可以發送錯誤幀。由於總線錯誤幀沒有CANID，所以當檢測到錯誤幀時，只知道有錯誤，但無法定位該錯誤幀是哪個模塊發送的；</p><p>過載幀：過載幀用於在先行的和後續的數據幀之間提供附加的延時。</p><p><strong>幀格式</strong></p><p>在CAN2.0B規範中，數據幀和遠程幀有兩種幀格式，其區別主要在於標識符（即CANID）的長度：具有11位標識符的稱為標準幀，而具有29位的幀稱為擴展幀，如下圖3所示。數據幀和遠程幀都可以使用標準幀或遠程幀格式。幀與幀之間是通過幀間隔進行分開。</p><p><strong>數據幀格式</strong></p><p><strong></strong>數據幀由7部分組成：幀起始、仲裁段、控制段、數據段、CRC段、ACK段、幀結束。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/c9e0dbe6d83d4902b1e2366c452071cd><p class=pgc-img-caption>圖3</p></div><p><strong>幀起始</strong></p><p>長度為1位，幀起始（SOF）表示數據幀的起始，由一個單獨的顯性位組成。CAN節點發送數據的原則是先監聽後發送，即如果CAN節點需要發送數據，先監聽總線是否空閒，如果總線空閒，則往總線發送幀起始（SOF），獲得發送權，否則一直等待直到總線空閒才發送幀起始（SOF）。</p><p><strong>仲裁段</strong></p><p>標準幀和擴展幀的仲裁段不同，長度分別是12bit和32bit。如上圖3所示，在標準幀格式中，仲裁段由11位標識符（CANID）和遠程發送請求位(RTR)組成。在擴展幀中，仲裁段由29位標識符（CANID）、代替遠程請求位（SRR）、擴展位（IDE）、遠程發送請求位（RTR）組成。擴展幀標識符由11位基本ID和18位擴展ID組成。在標準幀中，遠程發送請求位（RTR）和IDE固定位0。而擴展幀中，代替遠程請求位（SRR）和IDE固定為1, 遠程發送請求位（RTR）固定位0。</p><p>標識符（CANID）：用於區分發送數據內容，比如我們定義ID 234發送某傳感器採集到的溫度值，ID 235發送某傳感器採集到的電流值。對於發送節點來講，當它需要發送溫度數據值，只需要將溫度值裝入ID為234的報文，需要發送電流數據時，只需要將採集到的電流數據裝入ID為235的報文。對報文接收節點來講，一旦收到ID為234時，就知道里面裝載的是溫度值，一收到ID為235時，就知道里面裝載的是電流值。</p><p>代替遠程請求位（SRR）：SRR是一個隱性位。在擴展幀中11位標識符的下一位是SRR位，而在標準幀中11位標識符的下一位是RTR位，因此SRR稱作代替遠程請求位。當標準幀和擴展幀衝突時，並且擴展幀的基本標識符與標準幀的標識符相同時，標準幀優先級高於擴展幀。</p><p>標識符擴展位（IDE）：表示該報文為標準格式或擴展格式。為顯性時，表示為標準幀，為隱性時，表示為擴展幀。</p><p>注：如前所述，CAN模塊採用先監聽後發送的原則，即如果CAN模塊需要發送數據時，先監聽總線，如果發現總線空閒，則開始發送報文。如果網絡上兩個CAN模塊剛好同時需要發送報文，他們同時檢測到總線空閒。且同時發送幀起始（SOF）。那麼CANID小的模塊發送優先級高，搶佔發送權。</p><p><strong>控制段</strong></p><p>控制段表示數據段的數據段的長度，由保留位和數據長度碼共6bit組成，如下圖3所示。發送數據段的長度是可變的，具體長度由控制段決定。長度位0-8字節。DLC編碼和數據段長度對應關係如下表所示。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/4ce2f90925d745f89be4bca4a5d5b3e3><p class=pgc-img-caption>表1</p></div><p>保留位：在標準格式由R1(顯性)和R0（隱形）組成。</p><p><strong>CRC段</strong></p><p>包括CRC序列(15bit)和CRC界定符（1位,固定為隱性），圖下圖3所示。</p><p>CRC序列：該序列是對幀起始、幀仲裁段、控制段、數據段的進行CRC計算。</p><p>CRC界定符：CRC界定符是一個位隱性位。</p><p><strong>ACK段</strong></p><p>ACK段包含2bit，包括應答位和應答界定符。</p><p>在ACK段，發送節點發送兩個隱性位。當接收節點正確接收到有效報文後，接收模塊就會在ACK段的第一位發送隱性位來告知發送模塊數據被正常接收了。應答界定符固定為高電平。</p><p><strong>幀結束（EOF）</strong>：</p><p>幀結束由7個隱性位組成，每個數據幀和遠程幀都必須包含完整的幀結束分。</p><p><strong>標準數據幀的長度</strong></p><p>因此一幀報文最大長度為：1(SOF)+11(ID)+1（RTR）+6(控制段)+64（數據段）+15（CRC）+1(CRC界定符)+2(ACK)+7(EOF)+3（幀間隔）=111位。在不考慮位填充的情況下，一幀8個字節的標準幀，需要佔用111位。</p><p>當考慮位填充時，通過示波器測量數據和ID全位0和全位1的數據幀佔用總線時間。</p><p>當ID和Data全為1時，波特率位500K，報文佔用總線時間為254us。</p><p>當ID和Data全為0時，波特率位500K，報文佔用總線時間為252us。</p><p>通過以上測試，可以看出當我們需要以最快速度在CAN總線上傳輸報文時，最快速度大概是250us每幀報文，也就說最快1s能夠傳輸不到4000條報文。</p><p><strong>遠程幀格式</strong></p><p>包含幀起始、仲裁段、控制段、CRC段、ACK段、幀結束。與數據幀相比，RTR位為1，且缺少數據段。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/e7742325cd5643e38c75fba19ff7d2db><p class=pgc-img-caption>圖4</p></div><p><strong>錯誤幀格式</strong></p><p>錯誤幀由兩部分組成：錯誤標誌，錯誤界定符。錯誤標誌長度為6個位，由於總線網絡中有多個節點，每個檢測到錯誤的節點都會發送錯誤幀，考慮到錯誤疊加，錯誤標誌長度位6-12位。根據錯誤節點所處的狀態不同，錯誤標誌也是不一樣的。當節點處於主動錯誤時，發送的錯誤標誌為顯性，當節點處於被動錯誤時，發送的錯誤標識為隱性。錯誤界定符由8個隱性位組成。</p><p>注：當某個節點因為本身原因，持續檢測到錯誤，為了防止該節點一直髮送錯誤幀而對其他正常工作的節點正常工作產生影響，所以該節點進入被動錯誤後，節點發送的錯誤幀為隱性，這樣就不會影響其他節點正常工作。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/2d7874eac7cf44e3af4a933f03a679b8><p class=pgc-img-caption>圖5</p></div><p><strong>過載幀格式</strong></p><p>過載幀由兩部分組成：過載標誌和過載界定符。</p><p>以下3中情況，都會引發過載幀的發送。</p><p>1、 CAN控制器要求延遲下一個數據幀或遠程幀的發送。</p><p>2、 在幀間隔段的第1和第2位檢測到顯性（數據幀或者遠程幀的發送需要等到3位長度的幀間隔發送完後才可以嘗試發送）；</p><p>3、 如果一個CAN節點在出錯界定符或者過載界定符的第8位（最後1位）採樣到1個顯性位，節點就會發送一個過載幀（而非錯誤幀），此時錯誤計數器不會增加（數據幀或者遠程幀的發送需要等錯誤界定符或者過載界定符發送完畢後，再等3個位長都的幀間隔才能發送數據）。</p><p>注：由上述1-3可以看出，為了阻止後續數據幀、遠程幀的發送可以插入過載幀。</p><p>過載標誌由6個顯性位組成。過載標誌和主動錯誤標誌一樣。過載標誌的形式破壞了幀間隔，因此，所有其他節點檢測到上述過載條件將發出過載標誌。如果在幀間隔段的第3位檢測到一個顯性位，則該位將解釋為幀起始。</p><p>過載界定符由8位隱性位組成。過載界定符的形式和錯誤界定符的形式一樣。在過載標誌位被髮送後，節點一直檢測總線，直到檢測到一個從顯性到隱性位的跳變。此時，總線上的每個節點都完成了過載標誌的發送，並開始同時發送剩餘的隱性位。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/892ddc52bbbd40288c8522e4707b185a><p class=pgc-img-caption>圖6</p></div><p><strong>幀間隔的格式</strong></p><p>數據幀和遠程幀通過幀間隔與總線上的其他幀（數據幀、遠程幀、錯誤幀和過載幀）分隔開。過載幀和錯誤幀與他們之前的幀之間沒有幀間隔，多個超載幀之間也沒有幀間隔。</p><p>幀間隔包含間隔和總線空閒。對於處於被動錯誤狀態的節點來說，其間隔幀除了包含間歇、總線空閒外，還包含延時發送。間歇包含3個隱性位。間歇期間，所有節點均不允許發送數據幀和遠程幀，其唯一的作用是標示一個過載條件（第三位除外）。</p><p>總線空間的時長可以是任意長度。在此期間，總線被認為是空閒的，任何需要發送報文的節點在此期間都可以發送報文。一條因為其他報文正在發送而被掛起的報文，將在其延時結束後的第1位（如果此時總線還是空閒的情況下）開始發送，此時檢測到總線的一個顯性位將認為一個幀起始</p><p>延時傳送是指節點發送一個報文後，在開始發送下一報文或者認可總線處於空閒前，在間隔後發出8個隱性位。如果在此期間由其他節點開始發送報文。延時傳送降低了被動錯誤節點向總線發送報文的優先級，這樣做是為了降低被動錯誤狀態節點因自生故障干擾總線的可能性。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/00812d8dbb664f679d871c558d805b4a><p class=pgc-img-caption>圖7</p></div><p><strong>數據發送優先級</strong></p><p>在總線空閒時，最先開始發送的節點獲得發送權。</p><p>當多個節點同時開始發送時，各發送節點從仲裁段的第一位開始進行仲裁。連續輸出顯性電平最多的單元可繼續發送。仲裁過程如下圖所示，節點1仲裁失敗。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2d3694972edf4aaf80b267c3345644d0><p class=pgc-img-caption>圖8</p></div><p><strong>位填充</strong></p><p>由於CAN總線傳輸時，沒有類似其他串行通信的CLK線，所以如果連續傳輸多個相同位時會有時鐘誤差的累加。為了解決此問題，引入位填充的概念。當同樣的電平持續5位時添加一個位的反型數據，當電平發生跳變時，進行再同步，以解決時鐘誤差累加問題。位填充的構成如下圖所示。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c4468fa0ae36498f8d977b0b65cdfb12><p class=pgc-img-caption>圖9</p></div><p><strong>錯誤種類</strong></p><p><strong>位錯誤</strong></p><p>CAN節點在發送位的同時也會對總線進行監測，如果所發送的位值與所檢測到的位值不相符，則認為檢測到一個位錯誤。位錯誤是由總線上發出數據幀、遠程幀、錯誤幀、過載幀的節點和發出ACK的節點檢測到的。但以下情況除外：在仲裁段發出隱性電平，但是實際檢測到顯性電平，將被認為仲裁失敗而非位錯誤；在仲裁段作為位填充發出隱性電平，但實際檢測到顯性電平，將被認為填充錯誤，而非位錯誤。發送節點在發送ACK段發送隱性電平，但檢測到顯性電平是，將判定位其他接收單元發送的ACK應答，而非位錯誤。發送被動錯誤（6個隱性位）但檢測出顯性電平，間不被認為位錯誤。</p><p>檢測節點：發送節點和接收節點</p><p><strong>填充錯誤</strong></p><p>如果在報文發送期間，檢測出6個連續顯性或者隱性位，則將認為是一個填充錯誤。</p><p>檢測節點：發送節點和接收節點</p><p><strong>CRC錯誤</strong></p><p>如果接收節點在接收數據過程中計算的CRC值與發節點發送的CRC不一致，則接收節點會發送一個錯誤幀。</p><p>檢測節點：接收節點</p><p><strong>格式錯誤</strong></p><p>當一個固定形式的位檢測出1個或多個非法位，則被認為是格式錯誤。具體包括數據幀和遠程幀的CRC界定符、ACK界定符、EOF界定符以及錯誤界定符、超載界定符。</p><p>檢測節點：接收節點</p><p><strong>ACK錯誤</strong></p><p>只要在應答間隙檢測到顯性，則發送節點認為這是一個ACK錯誤。</p><p>檢測節點：發送節點</p><p><strong>錯誤幀發送時間點</strong></p><p>當任意節點檢測到錯誤時，將會輸出錯誤幀。處於主動錯誤的節點輸出主動錯誤，處於被動錯誤的節點輸出被動錯誤。</p><p>當節點檢測到位錯誤、填充錯誤、格式錯誤、ACK錯誤，從檢測出錯誤的下1位開始發送錯誤標誌。</p><p>當節點檢測到CRC錯誤時，在ACK界定符後的下1位發送錯誤標誌。</p><p>注意：對於數據幀和遠程幀來講，需要在各種幀（數據幀、遠程幀、錯誤幀、過載幀）發送結束後的再插入一個間隔幀，才可以數據幀。所以我們可以大致計算出當一幀數據發送失敗後，大概多長時間CAN控制器才會才重發這幀報文（即錯誤幀長度再加上一個幀間隔，根據發送節點所處的是主動錯誤還是被動錯誤狀態，幀間隔長度會不一樣，所以計算時需要注意）。</p><p><strong>錯誤計數器的加減規則</strong></p><p>具體如下表。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b4fb8a6f090446538e8fbf57b1a1d2c8><p class=pgc-img-caption>表2</p></div><p>注：第3點當發送節點發送一個錯誤標誌時，發送錯誤計數器值加8。這裡有兩個例外情況：一是當發送節點處於被動錯誤時，並檢測到一個應答錯誤或者發送被動錯誤標誌期間沒有檢測到顯性位（這種情況是因為整個網絡中只有發送節點一個節點存在，所以不能因為只有發送節點存在而一直將發送錯誤計數器往上加，直至發送節點進入bus off狀態）二是發送節點因為仲裁期間發生填充錯誤而發送錯誤標誌。以上兩種情況，發送錯誤計數器值不變。</p><p><strong>錯誤狀態變化</strong></p><p>當節點的發送錯誤計數器值在0-127之間且接收錯誤計算器值在0-127之間時，節點處於主動錯誤狀態；</p><p>當節點的發送錯誤計數器值在128-255之接或者接收錯誤計數器值在128-255之間，節點處於被動錯誤。</p><p>當發送錯誤計數器值大於255時候，節點進入總線關閉（bus off），接收錯誤用於不會大於255，即接收錯誤不會使節點進入bus off。</p><p>注：只有發送錯誤才能讓節點進入總線關閉。另外需要注意，當總線關閉可以設置CAN控制器時自動恢復（即檢測到128次11個連續隱性位自動恢復到主動錯誤狀態）還是不自動恢復。在汽車行業，一般都是不讓CAN控制器自動恢復，而是人為控制進入快慢恢復過程。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/0d8e98c59a79437284f0fea17652edd9><p class=pgc-img-caption>圖10</p></div><p><strong>位時間要求</strong></p><p><strong>標稱位時間</strong></p><p>標稱位時間，是指理想情況下發送1位所需要的時間，例如對於速率為500k的CAN總線，標稱為時間=1/500k=2us</p><p>一個標稱位時間可以劃分為4個不重疊的段，分別為同步段(SS)、傳播時間段(PTS)、相位緩衝段1(PBS1)、相位緩衝段2(PBS2)。</p><p>同步段(SS)：多個連接在總線上的節點通過此段實現位時序調整，同步每個位的發送和接收工作。由隱性到顯性或者顯性到隱性電平變換最好發生在這個段中。</p><p>傳播時間段(PTS)：用於吸收網絡上的物理延遲的段。所謂網絡上的物理延時指發送節點的輸出延遲、總線上信號的傳播延遲、接收單元的輸入延遲。這個段的時間為以上各延時時間的和的兩倍。</p><p>相位緩衝段1(PBS1)和相位緩衝段2(PBS2)：當信號邊沿不能包含於SS段中時，可在此段進行補償。由於各發送節點、接收節點以各自獨立的內部時鐘工作，細微的時鐘誤差會累計起來，PBS段可用於吸收此誤差。通過對相位緩衝段加減SJW。</p><p>如下圖所示，假設1個位由10個Tq組成，可以通過改變PTS和PBS1以及PBS2段的大小來實現不同的採樣點。一般情況下傳輸速率越高採樣點越低。對於500K傳輸速率來講，採樣點一般選擇在75%-81.25%之間。採樣點分為單點採樣和多點採樣，一般情況下，單點採樣就可以滿足要求。</p><p>注：一般直接選擇單片機的外部晶振作為CAN總線的時鐘源，而非PLL倍頻再分頻的時鐘作為時鐘源。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/83e9d5fefd0443658feb9d921b776188><p class=pgc-img-caption>圖11</p></div><p>採樣點：所謂採樣點是讀取總線電平，並將讀取到的電平作為位值的點。位置在PBS1結束處。</p><p><strong>硬件同步</strong></p><p>接收單元在空閒狀態檢測出幀起始時進行的同步調整。在檢測出邊沿時不考慮SJW的值而認為是SS段。硬同步如下圖所示。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/8ab63482b85744cfa8607dd0516bca22><p class=pgc-img-caption>圖12</p></div><p><strong>再同步</strong></p><p>在接收過程中檢測出總線上的電平變化時進行的同步調整。每當檢測出邊沿時，根據邊沿出現的位置加長PBS1段或者縮短PBS2段，以調整同步。調整的幅度大小為SJW。</p><p>如下圖所示，當邊沿出現在SS段後時，說明接收節點的SS段早於發送節點的SS段，接收節點為了在儘可能靠近發送節點的採樣點處進行採樣，在PBS1插入一個SJW。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/e53b6350ee664ff6af727f269c9a5121><p class=pgc-img-caption>圖13</p></div><p>如下圖所示，當邊沿出現在SS段前時，說明接收節點的SS段晚於發送節點的SS段，接收節點為了在儘可能靠近發送節點的採樣點處進行採樣，再將上1位的PBS2減少一個SJW。</p><div class=pgc-img><img alt=CAN總線協議詳解 onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/99bf51c2a4d041cfb3a322563894cac6><p class=pgc-img-caption>圖14</p></div><p><strong>硬同步和再同步的規則</strong></p><p>1、1個位中只進行一次同步調整</p><p>2、只有當上次採樣點的總線值和邊沿後的總線值不同時，該邊沿才能用於調整同步（即電平發生變化）</p><p>3、在總線空閒且存在隱性電平到顯性電平邊沿，則一定要進行硬件同步。</p><p>4、在總線非空閒檢測到的隱性電平到顯性電平的邊沿如果滿足條件1和2，將進行再同步。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>總線</a></li><li><a>協議</a></li><li><a>詳解</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/5d5a515e.html alt=理解HTTP協議－HTTP協議詳解總結 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/1f9dd54a51c344d9be602aa94f72056e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5d5a515e.html title=理解HTTP協議－HTTP協議詳解總結>理解HTTP協議－HTTP協議詳解總結</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2ef9ee79.html alt="OAuth2 協議詳解" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/bf91cb3c7e7c411e9910d22a6df2cf4f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2ef9ee79.html title="OAuth2 協議詳解">OAuth2 協議詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5065d0bc.html alt=CAN總線技術詳解與測試 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a5c496f06463480aa1158cb8440879b9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5065d0bc.html title=CAN總線技術詳解與測試>CAN總線技術詳解與測試</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d65f394c.html alt=CAN總線協議，CAN總線案例 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/bcd5f6bcf7a943d79c5ff1d03287bf6b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d65f394c.html title=CAN總線協議，CAN總線案例>CAN總線協議，CAN總線案例</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/60596793.html alt=CAN總線詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/87bb4d2e10de4ce68eb8fd03a2b3becb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/60596793.html title=CAN總線詳解>CAN總線詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d611ad93.html alt=DNS協議詳解及報文格式分析「轉」 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e50900c300af44348cbcd47341825485 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d611ad93.html title=DNS協議詳解及報文格式分析「轉」>DNS協議詳解及報文格式分析「轉」</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/248e9f6.html alt="CAN總線通信之詳解數據幀(Data Frame)" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a64a5a5730104240a07d32f0d25bb334 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/248e9f6.html title="CAN總線通信之詳解數據幀(Data Frame)">CAN總線通信之詳解數據幀(Data Frame)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/049e5b0.html alt="TCP協議詳解 - TCP狀態轉移" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/11f74803a5c140f48e7d9c1a6aa0ae30 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/049e5b0.html title="TCP協議詳解 - TCP狀態轉移">TCP協議詳解 - TCP狀態轉移</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5eef641.html alt=SPI協議詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/30e622a233f8489798892e001006ea4a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5eef641.html title=SPI協議詳解>SPI協議詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a506966.html alt=TCP協議詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/23a1b33d10ec4885a1e3606c1aca021c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a506966.html title=TCP協議詳解>TCP協議詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c3b2329.html alt=詳解TCP協議 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/fd966a2fb304494dae57421d89b70389 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c3b2329.html title=詳解TCP協議>詳解TCP協議</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f8b2a960.html alt="思路方法詳解 高三數學複習難點突破 圓錐曲線中的定點、定值問題" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/afd28158b4384f5eaa05c44c3104e24f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f8b2a960.html title="思路方法詳解 高三數學複習難點突破 圓錐曲線中的定點、定值問題">思路方法詳解 高三數學複習難點突破 圓錐曲線中的定點、定值問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/17054f8d.html alt=詳解CD編碼格式（16bit/44.1kHz）合理性之量化篇 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/6f23d12bac3843e2b09628221846ce0f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/17054f8d.html title=詳解CD編碼格式（16bit/44.1kHz）合理性之量化篇>詳解CD編碼格式（16bit/44.1kHz）合理性之量化篇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c84544ec.html alt=詳解CD編碼格式（16bit/44.1kHz）合理性之採樣篇 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5dc880024dac477f8aed432054712f82 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c84544ec.html title=詳解CD編碼格式（16bit/44.1kHz）合理性之採樣篇>詳解CD編碼格式（16bit/44.1kHz）合理性之採樣篇</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/feaa3a52.html alt=詳解音頻編解碼的原理、演進和應用選型等 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c0abba2ccef04296b442c6457cc98f49 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/feaa3a52.html title=詳解音頻編解碼的原理、演進和應用選型等>詳解音頻編解碼的原理、演進和應用選型等</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>