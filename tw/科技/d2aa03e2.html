<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>HashMap哲學中的數學原理，你發現了沒有？ | 极客快訊</title><meta property="og:title" content="HashMap哲學中的數學原理，你發現了沒有？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/c6e5680fb8e7487da90a1fadc685bf64"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d2aa03e2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d2aa03e2.html><meta property="article:published_time" content="2020-10-29T21:09:19+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:19+08:00"><meta name=Keywords content><meta name=description content="HashMap哲學中的數學原理，你發現了沒有？"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/d2aa03e2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>HashMap哲學中的數學原理，你發現了沒有？</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><ul><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6796209954379268620/?group_id=6796209954379268620" rel="noopener noreferrer" target=_blank>2020復工跳槽季，ZooKeeper靈魂27連問，這誰頂得住？</a></strong><br></li><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6793297693910237700/?group_id=6793297693910237700" rel="noopener noreferrer" target=_blank>2020“閉關”跳槽季，啃透分佈式三大技術：限流、緩存、通訊</a></strong><br></li><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6792573246827921924/?group_id=6792573246827921924" rel="noopener noreferrer" target=_blank>疫情期間“閉關修煉”，吃透這本Java核心知識，跳槽面試不心慌</a></strong><br></li><li><strong><a class=pgc-link data-content=mp href="https://www.toutiao.com/i6797030379376083464/?group_id=6797030379376083464" rel="noopener noreferrer" target=_blank>字節三面遠程，Java+Redis+網絡+數據庫+算法，輕鬆反殺面試官？</a></strong><br></li></ul><h1 class=pgc-h-arrow-right>tableSizeFor</h1><p>一般遇到的第一個問題就是tableSizeFor()。</p><div class=pgc-img><img alt=HashMap哲學中的數學原理，你發現了沒有？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/c6e5680fb8e7487da90a1fadc685bf64><p class=pgc-img-caption></p></div><p>我來解釋一下這部分代碼的作用：計算出大於或等於cap的第一個2的n次冪。 注意：</p><ul><li>cap參與計算之前要先-1</li><li>瞭解>>>、|的運算規則</li></ul><p>他這個算法大概的意思就是先無符號右移m位，再將獲得的結果與原值進行 | 運算。 比如我們令cap=19,則n=18，二進制表示為10010，無符號右移1位之後是1001。 如果將其對其為16位則表示為：0000 0000 0001 0010然後與原值0000 0000 0000 1001與運算結果為：0000 0000 0001 1011後面的幾輪我們以此類推即可。 詳細的演算過程如下：</p><div class=pgc-img><img alt=HashMap哲學中的數學原理，你發現了沒有？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3074e3237f7a4e7b9257deef19557059><p class=pgc-img-caption></p></div><p>上面的演算結果是11111，翻譯為10進制就是31。</p><pre><code>return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;</code></pre><p>n &lt; MAXIMUM_CAPACITY，所以返回：31 + 1 = 32。 使用 移位 和 或 運算，巧妙的化簡了問題。注意這裡有一個細節就是cap-1，為什麼這麼做呢。假設 x = 2^n，如果我們不處理得到的結果是2 * 2^n，這裡就不符合要求。大於等於 x 的第一個值應該是 x 本身。不信的話，可以動手驗證一下。</p><h1 class=pgc-h-arrow-right>hash</h1><p>這裡我們不討論hashCode產生的過程，我們只關心後部分。也就是大家所謂的擾動函數。</p><pre><code>static final int hash(Object key) {    int h;    return (key == null) ? 0 :     // 我們看最後一行作用    (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);}</code></pre><p>Jdk對此做出了相應解釋。</p><blockquote><p>Computes key.hashCode() and spreads (XORs) higher bits of hash</p></blockquote><p>直譯就是：<strong>計算key.hashCode()並擴展哈希的更高位</strong> 有必要思考一下：為什麼已經得出key的hashCode之後還要大費周章進行 移位 異或的運算呢。假設我們不進行擾動呢，能有什麼影響呢。我們知道HashMap中確定元素所在數組中的位置是通過 & 運算來實現的。</p><pre><code>if ((p = tab[i = (n - 1) &amp; hash]) == null)</code></pre><p>一個key的hashCode足夠大，而當前HashMap的容量不是足夠大的時候，你發現了嗎對該key進行定位的重大決定其實只是交給了最後幾位。 假設當前容量是16，然後(n - 1) = 15，其實就是二進制的1111。無論hash有多少位，不足的我1111只管補足0即可。這時候一個非常尷尬的情況出現了。我管你hashCode多少位只要跟我1111進行 & 運算，除了最後四位前面的一律為0。也就是說hash看著位數足夠多其實發揮作用的只有最後面的一部分。<strong>這樣一來，兩個hash只需要低位一致，高位就算多大差異他們最後一定定位再同一處</strong>。 這顯然是源碼作者不願意看到的結果。其實這裡高位參與運算就是為了打亂低位。這樣高位不同，低位相同，定位就一定相同的僵局直接就會被打破。</p><h1 class=pgc-h-arrow-right>容量的祕密</h1><p>我們知道HshMap擴容至原來的2倍，初始容量是16，這麼一來ta的容量其實永遠都是2^n。在二進制中2^n的數字是極具特點的。轉化成二進制之後首位為1，餘位為0。<strong>那麼2^n - 1之後呢，得到的結果更加有規律，一定得到全部為 1 的排列。</strong> 請你一定要記得任何數 -1 得到全部是 1 的排列那麼這個數字一定是2^n</p><pre><code>final V putVal(int hash, K key, V value, boolean onlyIfAbsent,  boolean evict)    n = (tab = resize()).length;    (n - 1) &amp; hash複製代碼</code></pre><p>在put()方法中想要定位，其實就是獲取到Key的hash之後對當前容量求餘。但是求餘在計算機的世界裡比較消耗性能。我們可以將hash % n轉化為(n - 1) & hash。 <strong>& 的運算規則是全部為 1 結果為 1，其餘結果為 0。</strong> 我們令hash的值為a b c d，(n - 1)的值為m n x y，且上述變量取值範圍為[0, 1]。 & 運算結果為t x y z，最完美的情況是： 四位數值每一位都可能是 0 或者 1，那麼得到的排列有2 * 2 * 2 * 2 = 16 種。我們繼續假設如果m n x y其中有一個數字等於 0 呢？結果的排列就只剩下2 * 2 * 2 = 8種。出現兩位為 0 的話排列就只剩下2 * 2 = 4種。 這麼理論不免有些枯燥。因為我們是明確知道當前容量的。如果 n = 1110，n - 1 = 1101，相當於你數組長度為 14 時，只會出現 8 種排列，那麼對應成HashMap的定位問題，就是說數組長度是 14 時，足足有 6 個位置是永遠浪費的。如果存在這種大量浪費的情況，勢必會導致HashMap頻頻擴容，損耗性能。 那怎麼解決呢？怎麼讓所有的位置都有可能被定位，對應成上述數學模型解決方案其實就是(n - 1)所有位必須全為 1。 那如果(n - 1)所有位必須全為 1。則 n = 2^x 成立。</p><h1 class=pgc-h-arrow-right>擴容的祕密</h1><pre><code>if ((e.hash &amp; oldCap) == 0)newTab[j] = loHead;newTab[j + oldCap] = hiHead;</code></pre><p>這裡我當時看的時候百思不得其解，直到我發現這裡(e.hash & oldCap)不是(e.hash & (oldCap - 1))這兩者天壤之別。這句代碼這裡的意思就是其實就是判斷oldCap最高位對應e.hash相對應位置上的值是否為 1。 這個很重要因為如果對應的位置為 1，直接表示ta需要搬家，而搬到哪裡去呢？數組原來位置對應的數字加上原容量即可。如果是 0，那就待在原地即可。其實這裡只要二進制和數學學的好的，應該是瞬間就可以反應的過來。 擴容之後(e.hash & (newCap - 1))其實只有newCap的最高位對應的e.hash的那一位可以發揮作用，newCap最高位前面的全是0不影響結果，後面呢跟(e.hash & (oldCap - 1))的結果又一摸一樣也不影響結果。還不明白，那我就偷一張圖：</p><div class=pgc-img><img alt=HashMap哲學中的數學原理，你發現了沒有？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2dde49bd4acf49b68641e01372fb67f9><p class=pgc-img-caption></p></div><p>要是還不明白咱就代數演示一下:<br>假設原容量n=10000，n - 1 = 1111<br>假設key.hash = 10001<br>那麼ta所在的位置是 1<br><strong>然後擴容一下</strong><br>現在n=100000，n - 1 = 11111<br>那麼ta所在的位置是10001</p><blockquote><p><br>作者：顏如玉<br>原文鏈接：https://juejin.im/post/5e5251fc6fb9a07c7d005b7c<br></p></blockquote></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>HashMap</a></li><li><a>哲學</a></li><li><a>數學</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/9a817e92.html alt=數學的哲學形象：在哲學與真理之間 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RTedUu82WzbDHp style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9a817e92.html title=數學的哲學形象：在哲學與真理之間>數學的哲學形象：在哲學與真理之間</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a6be0c00.html alt=數學老師讀哲學之康德對認識論的發展 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/cda29c50-d8c2-4193-89e8-e5751dc71973 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a6be0c00.html title=數學老師讀哲學之康德對認識論的發展>數學老師讀哲學之康德對認識論的發展</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9abc425.html alt=邏輯哲學、數學哲學和科學哲學的關係 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/466e000090f3c3e50806 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9abc425.html title=邏輯哲學、數學哲學和科學哲學的關係>邏輯哲學、數學哲學和科學哲學的關係</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f8b2a960.html alt="思路方法詳解 高三數學複習難點突破 圓錐曲線中的定點、定值問題" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/afd28158b4384f5eaa05c44c3104e24f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f8b2a960.html title="思路方法詳解 高三數學複習難點突破 圓錐曲線中的定點、定值問題">思路方法詳解 高三數學複習難點突破 圓錐曲線中的定點、定值問題</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8c6e4912.html alt=高考數學解題技巧，定點、定值問題的求解攻略，對重點題型反覆練 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1520911080324fd12e55929 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8c6e4912.html title=高考數學解題技巧，定點、定值問題的求解攻略，對重點題型反覆練>高考數學解題技巧，定點、定值問題的求解攻略，對重點題型反覆練</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fe688958.html alt=「考研數學」梯度和方向導數的關聯實例（日誌記錄四） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/9b48e5bdd41847c88328d334fef13683 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fe688958.html title=「考研數學」梯度和方向導數的關聯實例（日誌記錄四）>「考研數學」梯度和方向導數的關聯實例（日誌記錄四）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0fa6c201.html alt=人教版三年級數學上冊6.3《數字編碼》講解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15409875272446fd2290e51 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0fa6c201.html title=人教版三年級數學上冊6.3《數字編碼》講解>人教版三年級數學上冊6.3《數字編碼》講解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/08743ff4.html alt=講講高頻彩票的數學邏輯吧 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d5895bf13c71468a883ec03133404d4c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/08743ff4.html title=講講高頻彩票的數學邏輯吧>講講高頻彩票的數學邏輯吧</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1ea6641b.html alt=中考數學丨幾何題常用的模型變換！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d00a9d306da54157960e657861b7afae style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1ea6641b.html title=中考數學丨幾何題常用的模型變換！>中考數學丨幾何題常用的模型變換！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9f220780.html alt=當科學和哲學遇到隨機性，確定性和混亂時 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/9e3b0b83044245e887f1fa23093c56a6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9f220780.html title=當科學和哲學遇到隨機性，確定性和混亂時>當科學和哲學遇到隨機性，確定性和混亂時</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a2250a41.html alt=【亮子數學】：常用三角公式大全 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e5b9e7811b0449a1bb61e34ae0a7523d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a2250a41.html title=【亮子數學】：常用三角公式大全>【亮子數學】：常用三角公式大全</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/889c075b.html alt=論小學數學教學生活化的誤區及對策 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/889c075b.html title=論小學數學教學生活化的誤區及對策>論小學數學教學生活化的誤區及對策</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d1c7184b.html alt=高中數學：正、餘二倍角公式的變式及其應用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/R6f5aXZEqbpi9N style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d1c7184b.html title=高中數學：正、餘二倍角公式的變式及其應用>高中數學：正、餘二倍角公式的變式及其應用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/09bdf3b9.html alt=高考數學基礎知識鞏固專題：同角三角函數的基本關係和誘導公式 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/4ad700017a27db3c428d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/09bdf3b9.html title=高考數學基礎知識鞏固專題：同角三角函數的基本關係和誘導公式>高考數學基礎知識鞏固專題：同角三角函數的基本關係和誘導公式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c3e505a4.html alt=轉化思想：解決數學問題 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/59e6f1ce51984cb8961d6c6343f300fd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c3e505a4.html title=轉化思想：解決數學問題>轉化思想：解決數學問題</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>