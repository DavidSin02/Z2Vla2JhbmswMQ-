<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Linux操作系統存儲子系統核心技術之硬盤與RAID | 极客快訊</title><meta property="og:title" content="Linux操作系統存儲子系統核心技術之硬盤與RAID - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/12a0a3d09fd54be3b2087a5d45b798b6"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d39b51ac.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d39b51ac.html><meta property="article:published_time" content="2020-11-14T21:04:33+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:33+08:00"><meta name=Keywords content><meta name=description content="Linux操作系統存儲子系統核心技術之硬盤與RAID"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/d39b51ac.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Linux操作系統存儲子系統核心技術之硬盤與RAID</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>Linux操作系統的存儲子系統應該是Linux中最為複雜的子系統了。其實很多子系統都認為自己是最複雜的子系統，比如內存子系統和網絡子系統也這麼說。無論如何，存儲子系統在Linux中是比較複雜的。今天我們就介紹一下Linux的存儲子系統中的硬盤與RAID的相關內容，後面再寫一篇關於LVM與文件系統的內容。</p><h1 class=pgc-h-arrow-right>硬盤</h1><p>在Linux的存儲子系統中，最底層的就是硬盤了。這裡的硬盤並不是指我們看到的硬盤硬件，而是指在Linux內部看到的硬盤設備，或者說是塊設備。如果我們在/dev目錄執行以下ls命令，就可以看到很多設備。在這些設備中以sd開頭的就是基於SCSI協議的硬盤。</p><div class=pgc-img><img alt=Linux操作系統存儲子系統核心技術之硬盤與RAID onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/12a0a3d09fd54be3b2087a5d45b798b6><p class=pgc-img-caption>圖1 Linux中的塊設備</p></div><p>無論是基於SAS、iSCSI還是FC的磁盤設備，大概都是這個樣子。形似dm-X的是Device Map塊設備，也就是通過LVM進行管理的設備，這種設備是一種邏輯設備。</p><p>在Linux操作系統中塊設備的種類很多，有本地磁盤設備、有SAN設備還有基於網絡的塊設備。在虛擬機中塊設備又呈現為另外一種文件名，比如在Xen虛擬機中為xvdX。</p><p>雖然名稱差異很大，但是在Linux操作系統內核中的實現卻非常簡單。在內核中任何磁盤塊設備都是通過調用add_disk函數完成的。在<strong>《Linux設備驅動程序》這本書</strong>對塊設備進行了詳細的介紹，並且可以通過非常簡單的代碼實現一個自己的塊設備。</p><div class=pgc-img><img alt=Linux操作系統存儲子系統核心技術之硬盤與RAID onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a582c9c13da9451dac3f0eb0c8b81853><p class=pgc-img-caption>圖2 最簡單的塊設備驅動</p></div><p>這裡面有2個函數，也就是alloc_disk和add_disk。前一個函數是分配一個通用塊的結構體，後者則是將該塊設備添加到內核，也就是在/dev目錄下生成一個“文件”。以上述代碼為例，執行後會生成如下塊設備。</p><blockquote><p>brw-rw---- 1 root disk 251, 0 Jun 16 09:13 /dev/sbulla</p></blockquote><p>這裡我們自定義了一個設備名稱sbulla。其實我們看到的SCSI設備也是這樣定義的，只不過其定義名稱的時候是通過sd字符。</p><p>以上述代碼為例，在塊設備中比較重要的地方是初始化了一個隊列處理函數(sbull_full_request)。所有從上層訪問該塊設備的請求都會轉發到該處理函數進行處理。</p><p>所有塊設備都要初始化這個隊列，並且提供一個請求處理函數。不同的塊設備的請求處理函數略有不同。比如常見的SCSI塊設備，其處理函數初始化過程如下：</p><blockquote><p>q = __scsi_alloc_queue(sdev->host, scsi_request_fn);</p></blockquote><p>而nbd（網絡塊設備，通過網絡的方式將服務端的文件映射為客戶端的塊設備）設備的初始化隊列的代碼如下所示：</p><blockquote><p>disk->queue = blk_init_queue(do_nbd_request, &nbd_lock);</p></blockquote><p>類似的例子還很多，本文不再一一介紹。<strong>這裡我們需要理解一點，核心問題在於註冊處理請求的回調函數，以及通過add_disk就可以在/dev目錄下面創建一個塊設備。</strong></p><p><strong>另外一點，對於任何類型的塊設備，無論是本地硬盤，還是經過網絡的NBD和iSCSI，還是FC設備，最後都是/dev目錄下的一個文件，而這個文件其實就是塊設備。我們可以通過對該文件的讀寫實現對塊設備的訪問。</strong></p><h1 class=pgc-h-arrow-right>RAID</h1><p>作為普通用戶使用單個硬盤是沒有任何問題的，但是作為企業應用使用單個硬盤存在很大的風險。這時因為硬盤隨時有可能損壞，因此我們需要一種機制來保證即使出現硬盤故障的情況下，數據不會丟失，且業務仍然可以正常工作。</p><p>RAID正是解決上述問題的技術。RAID的全稱為廉價冗餘磁盤陣列（Redundant Array of Inexpensive Disks），從字面可以看出其基本原理就是通過廉價的磁盤組成一組磁盤。RAID不僅僅可以通過冗餘的方式解決數據可靠性的問題，還可以提高性能。其主要原理就是將請求拆分到多個物理硬盤來執行，性能自然比一個硬盤快了。</p><p>在Linux操作系統層面，其實就是<strong>將物理磁盤通過軟件抽象為邏輯磁盤</strong>。以RAID1（兩塊磁盤存儲相同的數據，在出現一塊磁盤故障的情況下，數據不丟失）為例，通過Linux內核中的軟件創建一個虛擬的塊設備，而該塊設備中記錄了底層對應的物理設備及相關參數。</p><div class=pgc-img><img alt=Linux操作系統存儲子系統核心技術之硬盤與RAID onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/60128e4f8d76412587f9f3e6867e6c43><p class=pgc-img-caption>圖3 RAID1 示意圖</p></div><p>因此，從用戶層面來看就是一塊普通的磁盤設備，而在底層卻是2個獨立的物理硬盤。當用戶向邏輯磁盤寫數據的時候，其中的軟件會通過參數進行計算，並將數據重新定向到底層的物理設備。通過這種方法可以保證即使出現某個物理磁盤損壞，用戶的數據仍然完好無損。</p><p>除了上面說的RAID1外，還有很多RAID類型。不同的RAID類型實現不同的功能。比如RAID0實現條帶化，主要是提升性能；RAID1則是實現數據的冗餘，防止磁盤故障導致的數據丟失；由於上述RAID只能解決一方面的問題，因此有人講兩者結合，出現了RAID10和RAID01，這樣既能保證數據的可靠性，又能提升性能。</p><p>由於RAID1是一份數據寫到兩個設備，因此只有50%的有效數據。為了提高有效數據率，於是發明了RAID5和RAID6等類型。其中RAID5通過增加一個校驗數據來保證數據的可靠性，以5塊盤的RAID5為例，其中有效數佔4塊盤的空間，有效數據80%。但是RAID5有個問題，就是一組磁盤中只能壞一塊，如果損壞的磁盤超過1塊就會導致數據丟失。RAID6的算法與RAID5類似，它的特點是可以容忍2塊磁盤故障。</p><p>在實現層面，Linux的RAID實現在用戶態和內核態都有涉及。其中用戶態主要進行RAID的管理，而內核態一方面配合用戶態進行RAID管理，另外一方面則實現對IO的處理，這部分才是RAID最為核心的內容。</p><div class=pgc-img><img alt=Linux操作系統存儲子系統核心技術之硬盤與RAID onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2b520f38e2e44b3e8ee60c2cbd7002ae><p class=pgc-img-caption>圖4 軟件架構</p></div><p>對於基於SCSI物理磁盤的RAID來說，Linux環境下整個軟件架構如圖4所示。其中虛線以上的為用戶態的軟件模塊，虛線以下的為內核態的軟件模塊。<strong>這裡比較核心的是RAID公共層，在這裡主要創建md設備，該設備是一個邏輯設備，也是用戶可以看到的RAID設備</strong>。其下則是具體的RAID模塊，用於實現不同的RAID級別（算法）。</p><p>再往下就是通用SCSI驅動層了，也就是圖中的SCSI磁盤驅動這一層的內容。該層其實是SCSI系統的上層驅動（SCSI子系統分為上中下三層）。RAID模塊通過調用該層的數據訪問接口就可以實現物理磁盤數據讀寫了。</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>系統</a></li><li><a>Linux</a></li><li><a>存儲子</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/bcacd8fd.html alt=Linux系統——用戶、用戶組、權限和文件屬性 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bcacd8fd.html title=Linux系統——用戶、用戶組、權限和文件屬性>Linux系統——用戶、用戶組、權限和文件屬性</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6b48b90b.html alt=Linux系統常用命令大全 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6b48b90b.html title=Linux系統常用命令大全>Linux系統常用命令大全</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/59993286.html alt="Linux 文件系統介紹" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/50a30000b2bb9135b878 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/59993286.html title="Linux 文件系統介紹">Linux 文件系統介紹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8024f20c.html alt="Linux 文件系統剖析" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7ea491ff1de847568632e723367af267 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8024f20c.html title="Linux 文件系統剖析">Linux 文件系統剖析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/13a20156.html alt=Linux文件系統101 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/184733a1b935442eaf00466d218e78af style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/13a20156.html title=Linux文件系統101>Linux文件系統101</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1d5836cb.html alt=Linux文件系統介紹：Ext、XFS、Btrfs等，選擇適合自己的文件系統 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/988b5ddedbeb42e8ae01b11a525ff754 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1d5836cb.html title=Linux文件系統介紹：Ext、XFS、Btrfs等，選擇適合自己的文件系統>Linux文件系統介紹：Ext、XFS、Btrfs等，選擇適合自己的文件系統</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/198ca4e7.html alt=Linux文件系統概念解釋 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153dc1ea3f434fef9762d98d4d308380 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/198ca4e7.html title=Linux文件系統概念解釋>Linux文件系統概念解釋</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/11002b4c.html alt=Linux文件系統目錄標準介紹（FHS） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5fcf0579209e4a4794121746fe9b8ddc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/11002b4c.html title=Linux文件系統目錄標準介紹（FHS）>Linux文件系統目錄標準介紹（FHS）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b2909f2b.html alt=Linux文件系統與目錄結構 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b2909f2b.html title=Linux文件系統與目錄結構>Linux文件系統與目錄結構</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/10be8693.html alt=一篇文章講清Linux操作系統的目錄結構 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/64f85cc0fcc548d99f56bd2567c34511 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/10be8693.html title=一篇文章講清Linux操作系統的目錄結構>一篇文章講清Linux操作系統的目錄結構</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4717b88a.html alt=嵌入式開發之Linux系統中文件和目錄相關命令 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1d8b5c2d75ba4ed5a0cc99267cb18c73 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4717b88a.html title=嵌入式開發之Linux系統中文件和目錄相關命令>嵌入式開發之Linux系統中文件和目錄相關命令</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fd75dea8.html alt="系統瞭解 Linux 文件系統" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/3b15000077fa0e231516 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fd75dea8.html title="系統瞭解 Linux 文件系統">系統瞭解 Linux 文件系統</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1b6548ae.html alt=詳解Linux系統架構--內核（內存、進程、設備、文件系統和網絡） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/69fc12e26bdd4ebf942d997de47a1396 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1b6548ae.html title=詳解Linux系統架構--內核（內存、進程、設備、文件系統和網絡）>詳解Linux系統架構--內核（內存、進程、設備、文件系統和網絡）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b7ea2e49.html alt=Linux文件系統是怎麼工作的？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/dc7369f3a6f547b4a03c383142a7af8c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b7ea2e49.html title=Linux文件系統是怎麼工作的？>Linux文件系統是怎麼工作的？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4c019f63.html alt="文件系統：隱匿在 Linux 背後的機制" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/S85jtorIbdwGbQ style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4c019f63.html title="文件系統：隱匿在 Linux 背後的機制">文件系統：隱匿在 Linux 背後的機制</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>