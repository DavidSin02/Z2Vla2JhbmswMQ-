<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>QQ音樂的動效歌詞是如何實踐的？ | 极客快訊</title><meta property="og:title" content="QQ音樂的動效歌詞是如何實踐的？ - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/e7d6382ce90b48419d14134811417e59"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d53b30b9.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d53b30b9.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d53b30b9.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d53b30b9.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d53b30b9.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d53b30b9.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/d53b30b9.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/d53b30b9.html><meta property="article:published_time" content="2020-11-14T21:04:03+08:00"><meta property="article:modified_time" content="2020-11-14T21:04:03+08:00"><meta name=Keywords content><meta name=description content="QQ音樂的動效歌詞是如何實踐的？"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/d53b30b9.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>QQ音樂的動效歌詞是如何實踐的？</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><h1><strong>一、 背景</strong></h1><p><strong>1. 現狀</strong></p><p>歌詞瀏覽已經成為音樂app的標配，展示和動畫效果也基本上大同小異，主要是單行的逐字染色的卡拉OK效果和多行的滾動效果。當然，我們也不例外。</p><p><strong>2. 目標</strong></p><p>我們的目標十分明確，一是提升歌詞的基礎體驗，二是在此基礎上，能提供差異化的VIP特效，來吸引用戶開通VIP。</p><h1><strong>二、探索技術方案</strong></h1><p>經過多次的需求評審和溝通討論，各方在需求的目標和細節上也達成了初步的統一。 產品的希望 ：效果炫酷，能實現逐字動畫(位移，翻轉，漸隱漸現，模糊，粒子特效等)，可配置等。開發的思考: 技術架構方案，性能挑戰等，接下來我們簡單介紹一下確定技術方案的過程。</p><p><strong>1. 技術方案選型</strong></p><p>這裡最初的思路有兩個方向，升級現有歌詞組件和開發全新歌詞組件。所謂知已知彼，百戰不殆， 通過對移動端面主流競品的技術方案和PC端類似方案的技術調研與分析。最終將技術方案鎖定在以下三種:</p><ul><li>現有歌詞組件升級</li><li>Shader序列幀動畫</li><li>ASS序列幀動畫</li></ul><p><strong>2. 備選技術方案介紹</strong></p><p>下面簡單介紹一下三種方案的原理和特點，如下表所示：</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e7d6382ce90b48419d14134811417e59><p class=pgc-img-caption></p></div><p>總的來說，就是在原生動畫開發和幀動畫方案中進行選擇。</p><p><strong>3. 技術方案對比</strong></p><p>以下主要是從是否實現特效，開發的難度，方案的性能，實現的成本，跨平臺等方面對比三種方案，具體細節如下表所示：</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f4f230f18b5e45e0b5c1d2faa7d0f492><p class=pgc-img-caption></p></div><p><strong>4. 確定方案</strong></p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dea724171e824fe7a7ed615f6ee76b73><p class=pgc-img-caption></p></div><p>通過以上幾個維度的綜合考量：</p><ol><li>現有歌詞組件基本上無法實現逐字動畫。</li><li>Shader幀動畫開發週期長，實現成本高，逐字動畫支持不是很好。</li><li>ASS實現逐字動畫，可通過植入動畫標籤實現複雜的特效，有開源支持，且跨平臺。</li><li>綜上所述，ASS方案性價比最高。</li></ol><p>最終方案也確定採用ASS序列幀動畫方案。</p><h1><strong>三、 技術架構</strong></h1><p><strong>1. ASS技術工作原理介紹</strong></p><p>前面簡單介紹了一下什麼ASS字幕和幀動畫的原理。我們知道ASS是一種字幕文件格式，屬於高級字幕，可以製作出華麗的特效字幕。所以，要想在電影或者視頻上顯示ASS效果，首先要做的是編寫ASS特效文件，然後再將ASS特效文件解析成序列幀動畫的位圖，最後將這些位圖按照特定的順序和一定的幀率進行播放，就能看到各種特效的動畫。如下圖所示:</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/d129cec83bda41af87b906b7e10ac8fe><p class=pgc-img-caption></p></div><p><strong>2. 如何接入ASS方案</strong></p><p><strong>2.1 合成</strong></p><p>如下下圖所示:,首先，需要準備展示內容(字幕或者歌詞內容)，比如一個文本文件，有了最基本的文本文件，怎麼轉換成ASS解析器能解析的ASS文件呢？答案是打K值，打K值是指給字幕文件加上時間軸屬性。而是什麼K值呢，就是ASS中K拉OK的效果標籤代碼，即每行甚至每個字的時間座標。有了打完K值的ASS文件，我們就可以在視頻播放器中瀏覽，也就有了最基本的逐字染色動畫。如果要開發更復雜的特效，就需要加入更多的特效標籤。而這一部分，就可以通過腳本加上動畫模板(動效模板就是具有特定動畫效果的ASS文件)，將動畫標籤注入到打完K值ASS文件中，生成最終的ASS特效文件。至此，一個具有特效的ASS文件就誕生了。</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/79e470df645247d49a81f77f2e36e92b><p class=pgc-img-caption></p></div><p><strong>2.2 解析</strong></p><p>解析的過程相對比較簡單。解析一個ASS文件，不僅需要ASS文件本身，還需要知道ASS文件是用什麼字體合成的。這裡補充一下，前面合成的時候，其中的動畫模板也是需要指定是使用哪種字體來合成的。因為這裡會涉及到字體的大小，間距等，對動畫效果和排版的影響。然後，再回到解析上來，通過ASS文件加上字體庫就可以解析生成特定序列的幀動畫位圖。</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/56c0421ddef140dd86ce25cb8887cee3><p class=pgc-img-caption></p></div><p><strong>3. 技術架構</strong></p><p>最終方案的技術架構：功能上劃分如下，後負責存儲和合成；客戶端負責解析和繪製，呈現用戶最終的動畫效果。</p><p><strong>4. 通用性</strong></p><p>上面提到了這套方案的通用性和易複用的特點。那除了動效歌詞之外，我們還可以做些什麼呢？</p><p>首先，我們脫離業務對架構進行更高一層的抽象，梳理出了更通用的架構方。這裡還需要補充一點，“字體庫”，從字面上理解應該是一堆字體的容器，所以字體庫應該是保存了一大堆的文字信息等。但其實不僅是文字也可以是圖形，所以我們的動畫效果可以不只是針對文字的，還可以設計一些圖形動畫效果。所以，這裡可以有更多的想像空間。前面解析的過程我們提到，解析出一幀幀的圖，就拿去直接播放了，這樣我們就能實時看到動畫效果。那如果把這些圖片保存下來，根據業務需求在需要的時候再播放呢。這裡就可以拆分出實時渲染和離線渲染兩種方案。</p><p>這裡的渲染提供了兩種方案:</p><p><strong>1. 實時渲染</strong></p><p>將解析出來的位圖立即繪製到屏幕上。</p><p>適用場景：實時要求高的場景。</p><p>特點: 對系統性能消耗大，需要注意當前場景的性能開銷。</p><p><strong>2. 離線渲染</strong></p><p>將解析出來的位圖保存到磁盤上,並可以此基礎上建立序列幀動畫的資源管理。</p><p>適用場景：適用於異步化的場景。</p><p>特點: 建議採用異步線程在後臺處理，減少對主線程消耗。</p><p>大家可以根據各自業務場景和特點靈活選擇或者組合使用這兩種方案。</p><p>以上主要是介紹動效歌詞技術方案的實現原理與架構介紹。</p><h1><strong>四、技術難點與挑戰</strong></h1><p>在開發過程中，我們遇到了兩個重要的問題：一個是在運行復雜的效果時，動畫效果出現了肉眼可見的卡頓；另一個則是內存的問題，即使是比較簡單的效果播放以後也會佔用大量的內存。本文後半部分將重點闡述K歌是如何解決這兩個問題的。</p><p><strong>1. 卡頓問題描述</strong></p><p>我們選取了一個較為複雜的效果，包含了大量的煙霧、花瓣等動畫元素 及 位移、形變與模糊等效果，它的每一幀畫面約由1000個元素構成。</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/e34720a217be4d4d87f3f7fc953c0b8b><p class=pgc-img-caption></p></div><p>在三星Note 3（Android 5.0，4核，ARMv7）上運行起來平均只能達到7幀的效果。</p><p><strong>2. 解碼與渲染的過程</strong></p><p>為了解決上述問題，我們需要對ASS由文本文件到渲染至屏幕的整個過程有基本的認識。這裡以Android為例（Ios在渲染的處理上略有不同，而其它是一致的），先看JNI的接口：</p><pre>private native int decodeFrame(long time, int[] pixels);</pre><p>Java層會傳入時間戮time及名為pixels的Int數組，time代表當前需要獲取哪個時間點的動畫效果，libass接著會對與這一時間點有關的每一行文本進行解析，生成一個或多個的小圖，從而得到一系列的圖片，然後合成到一個大圖裡面去，最終通過像素拷貝的方式把合成後的結果輸出到pixels，回到Java以後，再把pixels設置至Bitmap，最後交給Canvas進行渲染。</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/78d85ca1eed1449b915d3afc57ce08fe><p class=pgc-img-caption></p></div><p><strong>3. 過程耗時分析</strong></p><p>通過對各關鍵過程的打點並運行前述複雜效果，我們得到了各過程的耗時佔比：解析46%、合成37%、輸出與渲染各8%，其它1%。分解到每一幀並以毫秒計算則如下表：</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/30f81f73c3844e49bd10a196926ba52a><p class=pgc-img-caption></p></div><p>接下來，我們將會按解析、合成、輸出、渲染這樣的順序來逐步優化。</p><p><strong>4. 卡頓優化實踐</strong></p><p><strong>1）過濾透明小圖</strong></p><p>前面提到，每一行ass文本都會生成一個或多個的小圖，這是因為一個文字會被拆解成文體、邊框及背景三個部分，除此之外，libass並不關心這些構成部分的顏色及透明度。這就導致了這樣的一個問題：</p><pre>Dialogue: 1,0:00:00.00,0:01:00.00,Default,,0,0,0,fx,{\pos(120,100)\1a&amp;HFF&amp;\blur3}全民K歌</pre><p>以上ass文本所實現的是一個文字鏤空效果：</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/64e2e6a14a73478ba3506d3bef3dd1f7><p class=pgc-img-caption></p></div><p>1a&HFF&表示文字主體是完全透明的，而這樣的一個透明的元素，libass依然會生成一個小圖對它進行各種各樣的處理，但這是完全沒有必要的，於是我們對libass進行了第一點改造：不再生成無效的透明小圖，提高ass解析效率的同時也減少了內存的分配，對後續合成的處理也有正向的影響</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/bd002141b4054f6dad64a478a4b195be><p class=pgc-img-caption></p></div><p><strong>2）像素透明度判斷</strong></p><p>在合成的處理中，需要遍歷小圖的每一個像素並拆分為ARGB4個通道進行顏色的運算</p><pre>dstA = (255 * 255 - (255 - k) * (255 - dstA)) / 255; dstB = (k * b + (255 - k) * dstB) / 255; dstG = (k * g + (255 - k) * dstG) / 255; dstR = (k * r + (255 - k) * dstR) / 255;</pre><p>與普通的圖片合成不同，在歌詞動效的場景中，小圖由文字或點線之類的圖形構成，往往存在著大量的透明像素及完全不透明像素，可通過判斷來減少這部分的合成運算:</p><pre>if(k == 0){ // 完全透明，跳過 continue;} if(k == 255){ // 完全不透明，直接使用小圖顏色  dst = color;  continue;}</pre><p>測試了5個在K歌上線的動效，合成時間減少了10%~50%。</p><p><strong>3）簡化計算</strong></p><p>雖然通過透明度的判斷減少了一定計算，但無法完全避免。以Alpha通道的計算為例，包含了2次乘法、1次除法和3次的減法，而除法是特別耗時的。所以，對於這些必要的計算，我們進行了簡化，先進行等式變換：</p><pre>dstA = (255 * 255 - (255 - k) * (255 - dstA)) / 255;  = (255 - (255 - k) * (255 - dstA) / 255);</pre><p>然後利用255 - x = ~x及x / 255 ≈ x >> 8進行替換，得到簡化後的結果：</p><pre>dstA = ~((~k) * (~dstA)) &gt;&gt; 8);</pre><p>可見，一次計算變成了1次乘法與4次位運算，測得合成時間減少了26%。</p><p><strong>4）並行計算</strong></p><p>經過上述幾項優化，合成速度快了許多，但這還不夠。在合成的算法中，像素點與像素點間是沒有任何聯繫的，所以可以通過並行計算的方式來提高合成的效率。我們採用了NEON的解決方案，利用CPU專用模塊的128位寄存器同時對多個像素點進行計算，因32位色彩中ARGB各佔8位，再考慮乘法處理後可能達到的16位，由此，可用128位寄存器同時處理8個像素點的計算，實現約8倍的加速效果，對CPU和幀率可起到明顯的作用。 具體實現如下：</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b7b6407d95d4468686e4d817f4c7fbbb><p class=pgc-img-caption></p></div><p><strong>5）合成優化前後對比</strong></p><p>至此，合成的優化告一段落，每一幀的合成耗時由原來的52ms，降到了3ms以內</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dccd760dfe20466b9a0ba806ce9b0eaa><p class=pgc-img-caption></p></div><p><strong>6）取消像素拷貝</strong></p><p>輸出的過程實際上只是做了一次像素拷貝的操作，把合成後的大圖輸出到JNI傳入的Int數組裡面去，除了耗時以後，還會產生額外的一次Native內存分配，於是，我們優化了這個過程，讓合成直接在Int數組進行，這樣就把原來輸出的11ms完全去掉了</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b1bdc921517844828893df8cc953b96a><p class=pgc-img-caption></p></div><p>前面提到，數據到了Java層，還會調用Bitmap的setPixels方法把像素信息傳給Bitmap，最後才交給Canvas進行繪製，而這裡的setPixels做的事跟剛剛輸出的過程一樣，會把像素點全都拷貝一次。所以，我們希望把這一過程的拷貝也給取消掉，但Java並沒有提供接口給我們去獲取Bitmap的Buffer，也就採用了反射的方案，優化後，渲染耗時降低了65%。</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9a67a8720437423fa9b3d21c2066a879><p class=pgc-img-caption></p></div><p><strong>7）雙緩衝異步渲染</strong></p><p>我們知道，卡頓的原因在於處理一幀的耗時太久，達不到我們想要的幀率要求，那很容易會想到，我們是否可以使用多線程同時處理多幀數據呢？結果是失敗了，因為libass是單例的模式，同時處理多個時間點的解析合成會導致其內部一些狀態的錯亂，並以crash告終。雖然解碼無法使用多線程，但渲染與libass無關，還是可以拿出來放到一個單獨的線程去處理的。這就引入了一個新的問題，解碼與渲染兩個線程都會操作同一塊內存，一邊在寫、一邊在讀，數據容易出錯。於是，我們多申請了一塊內存，一個解碼用，一個渲染用，每次解碼完成時進行交換，我們的雙緩衝異步渲染方案就這樣出現了</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ef0bb18b5b7e4c02a0db9abaa1e09eb7><p class=pgc-img-caption></p></div><p>這一實現讓libass不需要等待渲染的完成就可以進行下一幀數據的解碼，有效地提高了動效的幀率</p><p><strong>8）卡頓優化效果彙總</strong></p><p>經歷上述各項優化後，前述複雜動效在低端機Note 3上由原來的7幀達到15幀</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5c94584bb06d4e7fa514ac941615627e><p class=pgc-img-caption></p></div><p><strong>2. 內存問題描述</strong></p><p>在不干預內存的情況下，在一個3分多鐘的作品上播放了K歌線上的一個普通效果，期間內存的變化見下圖：</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3afef395772a4d779c65fdca17be906f><p class=pgc-img-caption></p></div><p>內存增量達到了180M，且主要是Native層的內存，這是我們面臨的一個很嚴重的問題，有OOM的風險，系統也有可能因此產生頻繁的GC而引起卡頓</p><p><strong>1）深入內存分配</strong></p><p>通過對libass源碼的閱讀，我們瞭解到了更為詳細的ASS解析過程</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/657f24152ad3422485b69e360b93e73d><p class=pgc-img-caption></p></div><p>每一行動效文本在libass中被定義一個事件，先是對事件中的動畫標籤及參數進行解析，得到某一瞬間的所有屬性值後創建文字或圖形的輪廓；接著是對它進行柵格化的處理，後續還有拼接、模糊等處理，最終生成小圖並進行重排，就得到了卡頓問題中所說的一系列小圖。</p><p>在這樣的一個過程中，內存分配主要消耗在柵格化和拼接這2個過程中，且libass內部已經實現了一套完整的緩存管理機制，只是其默認緩存較大，分別為128M和64M，總大小達到了192M，再加上些其它的內存分配，最大會佔用超過200M的內存才會趨於平穩。除此之外，libass還提供了接口給我們設置緩存的大小，但只能設置總的緩存大小，不能自定義Bitmap和Composite Bitmap分別是多少，其內部會按2:1進行分配。</p><p>有了對libass的認識，內存問題也就變成了：如何尋找一個合適的緩存總大小 及 內存的2:1分配是否適合我們的場景。</p><p><strong>2）尋找合適的緩存總大小</strong></p><p>統計動效在一次播放的過程中查詢緩存的次數M，查詢後命中的次數為N，從而得到緩存命中率N/M。下圖橫軸表示了我們給libass設置的緩存總大小，縱軸則是2類緩存的命中率</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/7c81b88c83914a9fb2b1e65ce9f66f3c><p class=pgc-img-caption></p></div><p>通過上面的曲線，我們可以得到2個結論：1. 隨著緩存總大小的增加，新增內存所獲得的收益逐漸變小，對於K歌的場景，設置4M~16M比較合理； 2. Bitmap 與 Composite Bitmap 的分配不合理，可將更多的內存用於Composite Bitmap。</p><p><strong>2）尋找合適的緩存比例</strong></p><p>從K歌線上的10幾個動效中，隨機選取了5個，統計各個動效處理1500幀數據對2類緩存的訪求並製成了表格</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/ebbddfee37c14ebb8051f276d84e9b71><p class=pgc-img-caption></p></div><p>通過表格的數據可以看到，Composite Bitmap需要更大的緩存，平均約為Bitmap的1.8倍，於是我們把libass內2:1的分配規則調整為了1:1.8，最終使用8M的內存基本上達到了原來16M的效果</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6ea8da34cf3340d1a8d447633ccbb8bb><p class=pgc-img-caption></p></div><p><strong>3）內存優化效果</strong></p><p>設置緩存大小後，內存增長得到了控制且處於穩定狀態；而調整分配比例提高了緩存命中率，減少了CPU在內存分配與柵格化等處理上的耗時。</p><div class=pgc-img><img alt=QQ音樂的動效歌詞是如何實踐的？ onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/21bc8d0e01fb4bc8aae35fa865c2c2d8><p class=pgc-img-caption></p></div><p><strong>小結</strong></p><p>本文主要介紹了動效歌詞開發的關鍵技術和優化策略。技術方案經歷了數次討論和預研，採用了並行計算大幅減少運算時間，優化了編譯策略解決了跨平臺問題。在架構設計上，也充分考慮性能，跨平臺，可擴展，組件化，複用性等各方面的因素。在該方案的落地實現過程中，團隊的John、Harvey、Wing、 Comic,、Jerry、rey等同學通力合作，付出了不懈的努力！</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>QQ</a></li><li><a>音樂</a></li><li><a>動效</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/1ece884.html alt=播放中途突然插入廣告，QQ音樂“騷操作”引發用戶集體不滿 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=http://p1.pstatp.com/large/pgc-image/6e4551ccc83349a4a8495ea50b9f2243 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1ece884.html title=播放中途突然插入廣告，QQ音樂“騷操作”引發用戶集體不滿>播放中途突然插入廣告，QQ音樂“騷操作”引發用戶集體不滿</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4cf95694.html alt="無需軟件：在線提取 QQ 群成員方法" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/f8c3e5d8-4614-4261-99f2-52f523f48300 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4cf95694.html title="無需軟件：在線提取 QQ 群成員方法">無需軟件：在線提取 QQ 群成員方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cff61157.html alt=音樂小技巧分享：五線譜轉簡譜與MIDI的快速方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/b1a8f1677376470695f697ead184c35a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cff61157.html title=音樂小技巧分享：五線譜轉簡譜與MIDI的快速方法>音樂小技巧分享：五線譜轉簡譜與MIDI的快速方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/56131335.html alt=彈性動效的應用及原理 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/6951317fac52440fb5381037c174d590 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/56131335.html title=彈性動效的應用及原理>彈性動效的應用及原理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/def77882.html alt=小區背景音樂網絡廣播系統方案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/b74a6bbb-74fa-4b4c-85d3-8b91602809e3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/def77882.html title=小區背景音樂網絡廣播系統方案>小區背景音樂網絡廣播系統方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/5cdb2d1a.html alt=小區背景音樂（智能IP廣播）系統解決方案 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/dfic-imagehandler/63822a27-30a5-4e30-ab9e-01ded0f7847f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/5cdb2d1a.html title=小區背景音樂（智能IP廣播）系統解決方案>小區背景音樂（智能IP廣播）系統解決方案</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/10247630.html alt=背景音樂公共廣播系統 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/46d8368b8be24093994ba38d42995972 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/10247630.html title=背景音樂公共廣播系統>背景音樂公共廣播系統</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d07ee7dc.html alt=天天動聽音樂軟件當年那麼火，為什麼後來慢慢消失在大眾視野中 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/04659054f43a49b0ab3576ff0f059593 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d07ee7dc.html title=天天動聽音樂軟件當年那麼火，為什麼後來慢慢消失在大眾視野中>天天動聽音樂軟件當年那麼火，為什麼後來慢慢消失在大眾視野中</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/38c836d6.html alt=蘋果自帶音樂App會導致iPhone費電？官方承認網友直接選擇刪除 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/92c9f113ee2f46acb4595c99124d37ae style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/38c836d6.html title=蘋果自帶音樂App會導致iPhone費電？官方承認網友直接選擇刪除>蘋果自帶音樂App會導致iPhone費電？官方承認網友直接選擇刪除</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e0adfa7a.html alt=秒殺QQ微信，這3個神器傳輸文件快10倍 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/71af594a96c349c4ab1ff1d0a2782c96 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e0adfa7a.html title=秒殺QQ微信，這3個神器傳輸文件快10倍>秒殺QQ微信，這3個神器傳輸文件快10倍</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f6977767.html alt="7個超級酷的音樂婚禮用品 讓音樂在未來歲月裡繼續播放" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/5b130004a34b7ab57c75 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f6977767.html title="7個超級酷的音樂婚禮用品 讓音樂在未來歲月裡繼續播放">7個超級酷的音樂婚禮用品 讓音樂在未來歲月裡繼續播放</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fcc352f3.html alt=QQ自定義通知音教學 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c88b4f0ef9e84d5b83ae5fb04742a25a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fcc352f3.html title=QQ自定義通知音教學>QQ自定義通知音教學</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3ac8742b.html alt=如何將QQ通知音改為鈴聲通道？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/d7ff6092474246988a1bb1d67629610e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3ac8742b.html title=如何將QQ通知音改為鈴聲通道？>如何將QQ通知音改為鈴聲通道？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d6789cf4.html alt=騰訊QQ安卓版v8.1.5更新：消息提示音可指定好友 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ece99fe6af7246bdbd75dc54a0c8a274 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d6789cf4.html title=騰訊QQ安卓版v8.1.5更新：消息提示音可指定好友>騰訊QQ安卓版v8.1.5更新：消息提示音可指定好友</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4d04742b.html alt=原來QQ的對話框還能這樣玩？總算知道為什麼大家喜歡用QQ了，真香 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/7130f16053754d7dac1d8e1e0ba31caa style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4d04742b.html title=原來QQ的對話框還能這樣玩？總算知道為什麼大家喜歡用QQ了，真香>原來QQ的對話框還能這樣玩？總算知道為什麼大家喜歡用QQ了，真香</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>