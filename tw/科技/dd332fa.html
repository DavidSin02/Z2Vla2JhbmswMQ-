<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>codis 高可用集群跳過nginx 代理 | 极客快訊</title><meta property="og:title" content="codis 高可用集群跳過nginx 代理 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/d07cbed4a00b44508640b7c382aadd56"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><meta property="article:published_time" content="2020-10-29T20:50:33+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:33+08:00"><meta name=Keywords content><meta name=description content="codis 高可用集群跳過nginx 代理"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/dd332fa.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>codis 高可用集群跳過nginx 代理</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>Codis 簡介</h1><p>Codis 是一個分佈式 Redis 解決方案, 對於上層的應用來說, 連接到 Codis Proxy 和連接原生的 Redis Server 沒有顯著區別 (有一些命令不支持), 上層應用可以像使用單機的 Redis 一樣使用, Codis 底層會處理請求的轉發, 不停機的數據遷移等工作, 所有後邊的一切事情, 對於前面的客戶端來說是透明的, 可以簡單的認為後邊連接的是一個內存無限大的 Redis 服務。</p><p><strong>Codis的github：https://github.com/CodisLabs/codis</strong></p><p><br></p><h1 class=pgc-h-arrow-right>Codis特性如下</h1><ul><li>最新 release 版本為 codis-3.2，codis-server 基於 redis-3.2.8</li><li>支持 slot 同步遷移、異步遷移和併發遷移，對 key 大小無任何限制，遷移性能大幅度提升</li><li>相比0：重構了整個集群組件通信方式，codis-proxy 與 zookeeper 實現瞭解耦，廢棄了codis-config 等</li><li>元數據存儲支持 etcd/zookeeper/filesystem 等，可自行擴展支持新的存儲，集群正常運行期間，即便元存儲故障也不再影響 codis 集群，大大提升 codis-proxy 穩定性</li><li>對 codis-proxy 進行了大量性能優化,通過控制GC頻率、減少對象創建、內存預分配、引入 cgo、jemalloc 等，使其吞吐還是延遲，都已達到 codis 項目中最佳</li><li>proxy 實現 select 命令，支持多 DB</li><li>proxy 支持讀寫分離、優先讀同 IP/同 DC 下副本功能</li><li>基於 redis-sentinel 實現主備自動切換</li><li>實現動態 pipeline 緩存區（減少內存分配以及所引起的 GC 問題）</li><li>proxy 支持通過 HTTP 請求實時獲取 runtime metrics，便於監控、運維</li><li>支持通過 influxdb 和 statsd 採集 proxy metrics</li><li>slot auto rebalance 算法從0 的基於 max memory policy 變更成基於 group 下 slot 數量</li><li>提供了更加友好的 dashboard 和 fe 界面，新增了很多按鈕、跳轉鏈接、錯誤狀態等，有利於快速發現、處理集群故障</li><li>新增 SLOTSSCAN 指令，便於獲取集群各個 slot 下的所有 key</li><li>codis-proxy 與 codis-dashbaord 支持 docker 部署</li></ul><h1 class=pgc-h-arrow-right>codis架構如下</h1><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d07cbed4a00b44508640b7c382aadd56><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>codis 組件介紹</h1><p><strong>codis server</strong>：基於redis-3.2.8 分支開發。增加了額外的數據結構，以支持slot有關的操作以及數據遷移指令。具體的修改可以參考文檔redis的修改</p><p><strong>codis proxy</strong>：客戶端連接的redis代理服務，實現了redis協議。除部分命令不支持以外（不支持的命令列表），表現的和原生的redis沒有區別。</p><p>對於同一個業務集群而言，可以同時部署多個codis-proxy實例；</p><p>不同codis-proxy之間由codis-dashboard保證狀態同步。</p><p><strong>codis dashboard</strong>：集群管理工具，支持codis-proxy、codis-server的添加、刪除、以及數據遷移操作。在集群狀態發生改變時，codis-dashboard維護集群下所有codis-proxy的狀態一致性。</p><p>對於同一個業務集群而言，同一時刻codis-dashboard只能有0個或者1個</p><p>所有對集群的修改都必須通過codis-dashboard完成。</p><p><strong>codis FE</strong>：集群管理界面</p><p>多個集群實例共享可以共享同一個前端展示頁面；</p><p>通過配置文件管理後端codis-dashboard列表，配置文件可自動更新。</p><p><strong>storage</strong>：</p><p>提供namespace概念，不同集群會按照不同product name進行組織；</p><p>目前僅提供了zookeeper、etcd、fs三種實現，但是提供了抽象的interface可自行擴展。</p><p><br></p><h1 class=pgc-h-arrow-right>codis 是如何分片的</h1><p>Codis 採用 Pre-sharding 的技術來實現數據的分片, 默認分成 1024 個 slots (0-1023), 對於每個key來說, 通過以下公式確定所屬的 Slot Id : SlotId = crc32(key) % 1024。</p><p>每一個 slot 都會有一個且必須有一個特定的 server group id 來表示這個 slot 的數據由哪個 server group 來提供。數據的遷移也是以slot為單位的。</p><p><br></p><h1 class=pgc-h-arrow-right>Codis部署</h1><h1 class=pgc-h-arrow-right>環境說明</h1><p>節點編號IP地址操作系統node1192.168.28.71Centos 7.2node2192.168.28.72Centos 7.2node3192.168.28.73Centos 7.2</p><p>Codis部署架構如下圖</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/990df85e4fa645d19160f5a3b63c9976><p class=pgc-img-caption></p></div><p>codis server主從分佈如下圖</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6f14b9c6313442d6854cb296eecfed58><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>安裝部署</h1><h1 class=pgc-h-arrow-right>zookeeper 安裝</h1><p>codis的元數據存儲依賴zookeeper，所以在安裝codis之前我們需要安裝一個zookeeper環境</p><p>安裝過程略</p><h1 class=pgc-h-arrow-right>go安裝</h1><p>由於codis是go語言寫的，所以需要在每臺codis主機安裝go語言運行環境。</p><p>1、安裝go</p><pre><code>[root@node1 ~]# yum -y install golang</code></pre><p>2、設置go運行環境</p><pre><code>[root@node1 ~]# mkdir /data/go -p[root@node1 ~]# vim /etc/profileexport GOPATH=/data/goexport PATH=$PATH:$GOPATH/bin[root@node1 ~]# source /etc/profile</code></pre><p>3、安裝godep</p><p><br></p><pre><code>[root@node1 ~]# yum -y install git[root@node1 ~]# go get -u github.com/tools/godep &amp;&amp; which godep/data/go/bin/godep</code></pre><h1 class=pgc-h-arrow-right>codis 安裝</h1><p><strong>1、安裝依賴</strong></p><pre><code>yum install autoconf automake libtool -y</code></pre><p><strong>2、編譯安裝</strong></p><p><br></p><pre><code>mkdir -p /data/go/src/github.com/CodisLabscd /data/go/src/github.com/CodisLabsgit clone https://github.com/CodisLabs/codis.git -b release3.2cd codis/make</code></pre><p><strong>3、配置文件修改dashboard 配置修改</strong></p><p><br></p><pre><code># vim config/dashboard.tomlcoordinator_name = "zookeeper"coordinator_addr = "192.168.28.71:2181,192.168.28.72:2181,192.168.28.73:2181"product_name = "xuele-codis"</code></pre><p>複製配置文件到另外兩個節點</p><pre><code>scp config/dashboard.toml 10.1.13.172:/data/go/src/github.com/CodisLabs/codis/config/dashboard.toml</code></pre><pre><code>scp config/dashboard.toml 10.1.13.173:/data/go/src/github.com/CodisLabs/codis/config/dashboard.toml</code></pre><p><strong>4、codis-proxy配置</strong></p><pre><code># vim config/proxy.tomlproduct_name = "xuele-codis"product_auth = ""jodis_name = "zookeeper"jodis_addr = "192.168.28.71:2181,192.168.28.72:2181,192.168.28.73:2181"jodis_auth = ""jodis_timeout = "20s"jodis_compatible = true</code></pre><p>複製配置文件到另外兩個節點</p><pre><code>scp config/proxy.toml 10.1.13.172:/data/go/src/github.com/CodisLabs/codis/config/proxy.tomlscp config/proxy.toml 10.1.13.173:/data/go/src/github.com/CodisLabs/codis/config/proxy.toml</code></pre><p><strong>5、codis-server配置</strong></p><pre><code>[root@c7-node1 redis-3.2.11]# pwd/data/go/src/github.com/CodisLabs/codis/extern/redis-3.2.11[root@c7-node1 redis-3.2.11]# mkdir /data/redis[root@c7-node1 redis-3.2.11]# cp redis.conf /data/redis/redis-6379.conf[root@c7-node1 redis-3.2.11]# cp redis.conf /data/redis/redis-6380.conf[root@c7-node1 redis-3.2.11]# cp redis.conf /data/redis/redis-6381.conf</code></pre><p><strong>6、redis配置文件修改</strong></p><p><br></p><pre><code># vim /data/redis/redis-6379.confport 6379pidfile /tmp/redis_6379.pidlogfile "/tmp/redis_6379.log"dbfilename dump_6379.rdbmaxmemory 1gdir /data/redis/redis_6379修改6379為6380</code></pre><p><br></p><pre><code># vim /data/redis/redis-6380.confport 6380pidfile /tmp/redis_6380.pidlogfile "/tmp/redis_6380.log"dbfilename dump_6380.rdbmaxmemory 1gdir /data/redis/redis_6380</code></pre><p>修改6379為6381</p><pre><code># vim /data/redis/redis-6381.confport 6381pidfile /tmp/redis_6381.pidlogfile "/tmp/redis_6381.log"dbfilename dump_6381.rdbmaxmemory 1gdir /data/redis/redis_6381</code></pre><p>複製配置文件到另外兩個節點</p><pre><code>scp /data/redis/*.conf 10.1.13.172:/data/redis/scp /data/redis/*.conf 10.1.13.173:/data/redis/</code></pre><p>修改完配置文件，還需要創建相關目錄</p><pre><code>mkdir /data/redis/redis_6379 -pmkdir /data/redis/redis_6380 -pmkdir /data/redis/redis_6381 -p</code></pre><p><strong>7、服務啟動及初始化集群啟動dashboard</strong></p><p># nohup ./bin/codis-dashboard --ncpu=1 --config=config/dashboard.toml --log=dashboard.log --log-level=WARN >> /var/log/codis_dashboard.log &</p><p>啟動proxy</p><pre><code>nohup ./bin/codis-proxy --ncpu=1 --config=config/proxy.toml --log=proxy.log --log-level=WARN &gt;&gt; /var/log/codis_proxy.log &amp;</code></pre><p>啟動codis server</p><pre><code>nohup ./bin/codis-server /data/redis/redis-6379.conf &amp;nohup ./bin/codis-server /data/redis/redis-6380.conf &amp;nohup ./bin/codis-server /data/redis/redis-6381.conf &amp;</code></pre><p>啟動codis-fe</p><pre><code>nohup ./bin/codis-fe --ncpu=1 --log=fe.log --log-level=WARN --zookeeper=192.168.28.71:2181,192.168.28.72:2181,192.168.28.73:2181 --listen=192.168.28.71:8090 &amp;</code></pre><p>訪問codis管理界面</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a62eab6581b648d69861b5d6153f778c><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>web界面配置</h1><p><strong>1、添加proxy</strong></p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f9c334ab1ccf49d2ac2e6242916b615f><p class=pgc-img-caption></p></div><p><strong>2、添加group和server</strong></p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f736c7a4cf8f41f8918f8993e1b74b24><p class=pgc-img-caption></p></div><p><strong>3、通過fe初始化solt</strong></p><p>新增的集群 slot 狀態是 offline，因此我們需要對它進行初始化（將 1024 個 slot 分配到各個 group），而初始化最快的方法可通過 fe 提供的 rebalance all slots 按鈕來做，如下圖所示，點擊此按鈕，我們即快速完成了一個集群的搭建。</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/46e2e3fb127a4c0590e51579fd687326><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>測試驗證</h1><p>通過連接codis-proxy進行驗證</p><pre><code># redis-cli -h 192.168.28.71 -p 19000192.168.28.71:19000&gt; INFO# Serverredis_version:3.2.11redis_git_sha1:7191a280redis_git_dirty:0redis_build_id:a9271caacf948e7redis_mode:standaloneos:Linux 3.10.0-514.el7.x86_64 x86_64arch_bits:64multiplexing_api:epollgcc_version:4.8.5process_id:48993run_id:2f8dff0622b212a2838f232abf8a166c0f0efb25tcp_port:6379uptime_in_seconds:1369uptime_in_days:0hz:10lru_clock:7144691executable:/data/go/src/github.com/CodisLabs/codis/./bin/codis-serverconfig_file:/data/redis/redis-6379.conf # Clientsconnected_clients:49client_longest_output_list:0client_biggest_input_buf:0blocked_clients:0 # Memoryused_memory:5338840used_memory_human:5.09Mused_memory_rss:13819904used_memory_rss_human:13.18Mused_memory_peak:6361912used_memory_peak_human:6.07Mtotal_system_memory:1912107008total_system_memory_human:1.78Gused_memory_lua:37888used_memory_lua_human:37.00Kmaxmemory:1000000000maxmemory_human:953.67Mmaxmemory_policy:noevictionmem_fragmentation_ratio:2.59mem_allocator:jemalloc-4.0.3 # Persistenceloading:0rdb_changes_since_last_save:0rdb_bgsave_in_progress:0rdb_last_save_time:1533870359rdb_last_bgsave_status:okrdb_last_bgsave_time_sec:1rdb_current_bgsave_time_sec:-1aof_enabled:0aof_rewrite_in_progress:0aof_rewrite_scheduled:0aof_last_rewrite_time_sec:-1aof_current_rewrite_time_sec:-1aof_last_bgrewrite_status:okaof_last_write_status:ok # Statstotal_connections_received:150total_commands_processed:7126instantaneous_ops_per_sec:22total_net_input_bytes:153606total_net_output_bytes:2783917instantaneous_input_kbps:0.36instantaneous_output_kbps:8.56rejected_connections:0sync_full:1sync_partial_ok:0sync_partial_err:0expired_keys:0evicted_keys:0keyspace_hits:0keyspace_misses:0pubsub_channels:0pubsub_patterns:0latest_fork_usec:18123migrate_cached_sockets:0 # Replicationrole:masterconnected_slaves:1slave0:ip=192.168.28.71,port=6380,state=online,offset=1373,lag=1master_repl_offset:1373repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:2repl_backlog_histlen:1372 # CPUused_cpu_sys:1.65used_cpu_user:0.72used_cpu_sys_children:0.31used_cpu_user_children:0.00 # Clustercluster_enabled:0 </code></pre><p># Keyspace</p><p>讀寫數據驗證</p><pre><code>192.168.28.71:19000&gt; SET name heheOK192.168.28.71:19000&gt; GET name"hehe"web界面驗證key已經正常寫入</code></pre><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/32de74e96d4d46c280ad18a8ead61def><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>壓測</h1><pre><code>[root@c7-node1 codis]# ./bin/redis-benchmark -h 192.168.28.71 -p 19000 -c 100 -d 100 -t set -n 10000 -r 10000</code></pre><p>上述命令的意思是，使用redis-benchmark壓力測試命令連接codis集群，同時併發10000個（-c），測試set操作(-t)，每個測試數據集是100字節(-d),請求數是100000（-n），使用使用隨機數插入數值（-r）。</p><p>測試結果為1秒內完成1萬個set操作</p><pre><code>====== SET ======  10000 requests completed in 0.96 seconds  100 parallel clients  100 bytes payload  keep alive: 1壓測後可以看到分到後端group的數據還是比較均衡的</code></pre><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b33742a908b64a0d919ce0ff114c6e12><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>基於redis-sentinel實現主備切換</h1><p>修改sentinel配置文件</p><p><br></p><pre><code>[root@c7-node1 codis]# cat /data/redis/sentinel.conf port 26379bind 0.0.0.0 pidfile "/data/redis/logs/sentinel.pid"logfile "/data/redis/logs/sentinel.log"dir "/data/redis/db" sentinel monitor codis-server-01 192.168.28.71 6379 2sentinel down-after-milliseconds codis-server-01 5000sentinel failover-timeout codis-server-01 60000sentinel parallel-syncs codis-server-01 2 sentinel monitor codis-server-02 192.168.28.72 6380 2sentinel down-after-milliseconds codis-server-02 5000sentinel failover-timeout codis-server-02 60000sentinel parallel-syncs codis-server-02 2 sentinel monitor codis-server-03 192.168.28.73 6381 2sentinel down-after-milliseconds codis-server-03 5000sentinel failover-timeout codis-server-03 60000sentinel parallel-syncs codis-server-03 2</code></pre><p>複製sentinel配置到其他節點</p><pre><code>scp /data/redis/sentinel.conf 192.168.28.72:/data/redis/sentinel.confscp /data/redis/sentinel.conf 192.168.28.73:/data/redis/sentinel.conf</code></pre><p>創建相關目錄</p><p><br></p><pre><code>mkdir /data/redis/logs/mkdir /data/redis/db/</code></pre><p>啟動sentinel</p><pre><code>[root@c7-node1 codis]# pwd/data/go/src/github.com/CodisLabs/codis[root@c7-node1 codis]# nohup ./bin/redis-sentinel /data/redis/sentinel.conf &amp;codis web頁面添加sentinels</code></pre><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c9764a5ad2f64f958b6b27915049682e><p class=pgc-img-caption></p></div><p>配置完成後可以在group中看到明顯的HA標誌</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/538af1dea8324930973caee1fc41f82b><p class=pgc-img-caption></p></div><p>手動kill 掉一個主節點測試可用性</p><p>kill掉192.168.28.72機器上的6380主節點，驗證從節點可以正常轉移</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/08d91bb1ebe4492f89438179fa5a40d2><p class=pgc-img-caption></p></div><p>驗證死一臺機器(手動關閉192.168.28.73節點)，codis集群能否正常提供服務</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dd5b9e90fe5a4fc4a592ac3a018fd68b><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>數據平滑遷移</h1><p>redis 數據 平滑遷移到codis 使用codis官方提供的redis-port工具。</p><p>原理：redis-port本質是以slave的形式掛載到現有redis服務上去的</p><p>1、redis會生成RDB dump文件給做為slave的redis-port</p><p>2、redis-port分析RDB文件，並拆分成key-value對，通過slotsrester指令發給codis</p><p>3、遷移過程中發生的修改，redis會將這些指令在RDB DUMP發送完成後，再發給redis-port，而redis-port收到這些指令後不做處理，而直接轉發給codis</p><p>redis-port github地址： https://github.com/CodisLabs/redis-port</p><p>（1）安裝redis-port</p><pre><code>cd /data/go/src/github.com/CodisLabsgo get -u github.com/CodisLabs/redis-portgo get github.com/cupcake/rdbcd redis-port/make</code></pre><p>數據同步命令</p><pre><code>./bin/redis-sync -m 192.168.201.3:6381 -t 192.168.28.71:19000</code></pre><p>參數說明：</p><p>-m 源集群地址和端口</p><p>-t 目標集群地址和端口</p><h1 class=pgc-h-arrow-right>redis 數據擴容</h1><p>說明：本次擴容添加3組codis-server，數據擴容測試由於不涉及高可用相關內容，所以擴容的codis server均為單點</p><p>（1）按照之前的部署方式，分別在三個節點各自啟動了一個codis server，端口分別為6382，6383，6384，並在web管理界面添加到了集群中</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7165af05e58b4aeba3418e1a6adeb1fe><p class=pgc-img-caption></p></div><p>（2）通過rebalance all slots來實現集群的slots自動均衡</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/522905cec74647d4b5b5572923870ea3><p class=pgc-img-caption></p></div><p>（3）確定每個新加入的group分配的slots。</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/825f8e671a0b474eb1e591445f22c927><p class=pgc-img-caption></p></div><p>（4）分配完成slot顯示如下所示</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/10e20807e8f944f6b806d8c50d5e94d7><p class=pgc-img-caption></p></div><p>從group看，每組分片的memory空間佔用情況也是均衡的</p><div class=pgc-img><img alt="codis 高可用集群跳過nginx 代理" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/acfde37d614c4d73b132ca590949fa8b><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>dashboard 故障異機啟動</h1><p>codis 官方僅允許運行一個dashboard節點，dashboard節點啟動會在zk上註冊自己的節點，同時在程序正常退出的時候刪掉對應的節點，但如果異常退出就會導致zk的節點無法刪除，在下一次啟動的時候會報“zk: node already exists”的錯誤。</p><p>如果dashboard節點出現故障，短時間無法恢復，我們需要在另外一臺節點啟動dashboard的話，需要在zookeeper中刪除節點的註冊信息，方法如下：</p><pre><code># ./zkCli.shdelete /codis3/xuele-codis/topom</code></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>codis</a></li><li><a>跳過</a></li><li><a>nginx</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/a20a97e2.html alt=網傳三星跳過4nm直接進入3nm？是炒冷飯還是炒作？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/6565b4dde10a4ed5a1a886d27570eeab style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a20a97e2.html title=網傳三星跳過4nm直接進入3nm？是炒冷飯還是炒作？>網傳三星跳過4nm直接進入3nm？是炒冷飯還是炒作？</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/d74c5aac.html alt=象山籍運動員胡晨跳過了2.10米寧波新高度 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/SEsvBO72atfqJw style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/d74c5aac.html title=象山籍運動員胡晨跳過了2.10米寧波新高度>象山籍運動員胡晨跳過了2.10米寧波新高度</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/140963f.html alt=跳過5G直接進軍6G！美國技術官員又開始吹了：這次換我們領先 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/43841e348c65443fbbd0e6842f5b0bc8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/140963f.html title=跳過5G直接進軍6G！美國技術官員又開始吹了：這次換我們領先>跳過5G直接進軍6G！美國技術官員又開始吹了：這次換我們領先</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a790603.html alt="16-第二節 nginx配置文件簡述" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d238c5f67e394a75b6a5a2057fe77f8c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a790603.html title="16-第二節 nginx配置文件簡述">16-第二節 nginx配置文件簡述</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>