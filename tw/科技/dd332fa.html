<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç† | æå®¢å¿«è¨Š</title><meta property="og:title" content="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç† - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/d07cbed4a00b44508640b7c382aadd56"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/dd332fa.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/dd332fa.html><meta property="article:published_time" content="2020-10-29T20:50:33+08:00"><meta property="article:modified_time" content="2020-10-29T20:50:33+08:00"><meta name=Keywords content><meta name=description content="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/dd332fa.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><h1 class=pgc-h-arrow-right>Codis ç°¡ä»‹</h1><p>Codis æ˜¯ä¸€å€‹åˆ†ä½ˆå¼ Redis è§£æ±ºæ–¹æ¡ˆ, å°æ–¼ä¸Šå±¤çš„æ‡‰ç”¨ä¾†èªª, é€£æ¥åˆ° Codis Proxy å’Œé€£æ¥åŸç”Ÿçš„ Redis Server æ²’æœ‰é¡¯è‘—å€åˆ¥ (æœ‰ä¸€äº›å‘½ä»¤ä¸æ”¯æŒ), ä¸Šå±¤æ‡‰ç”¨å¯ä»¥åƒä½¿ç”¨å–®æ©Ÿçš„ Redis ä¸€æ¨£ä½¿ç”¨, Codis åº•å±¤æœƒè™•ç†è«‹æ±‚çš„è½‰ç™¼, ä¸åœæ©Ÿçš„æ•¸æ“šé·ç§»ç­‰å·¥ä½œ, æ‰€æœ‰å¾Œé‚Šçš„ä¸€åˆ‡äº‹æƒ…, å°æ–¼å‰é¢çš„å®¢æˆ¶ç«¯ä¾†èªªæ˜¯é€æ˜çš„, å¯ä»¥ç°¡å–®çš„èªç‚ºå¾Œé‚Šé€£æ¥çš„æ˜¯ä¸€å€‹å…§å­˜ç„¡é™å¤§çš„ Redis æœå‹™ã€‚</p><p><strong>Codisçš„githubï¼šhttps://github.com/CodisLabs/codis</strong></p><p><br></p><h1 class=pgc-h-arrow-right>Codisç‰¹æ€§å¦‚ä¸‹</h1><ul><li>æœ€æ–° release ç‰ˆæœ¬ç‚º codis-3.2ï¼Œcodis-server åŸºæ–¼ redis-3.2.8</li><li>æ”¯æŒ slot åŒæ­¥é·ç§»ã€ç•°æ­¥é·ç§»å’Œä½µç™¼é·ç§»ï¼Œå° key å¤§å°ç„¡ä»»ä½•é™åˆ¶ï¼Œé·ç§»æ€§èƒ½å¤§å¹…åº¦æå‡</li><li>ç›¸æ¯”0ï¼šé‡æ§‹äº†æ•´å€‹é›†ç¾¤çµ„ä»¶é€šä¿¡æ–¹å¼ï¼Œcodis-proxy èˆ‡ zookeeper å¯¦ç¾ç­è§£è€¦ï¼Œå»¢æ£„äº†codis-config ç­‰</li><li>å…ƒæ•¸æ“šå­˜å„²æ”¯æŒ etcd/zookeeper/filesystem ç­‰ï¼Œå¯è‡ªè¡Œæ“´å±•æ”¯æŒæ–°çš„å­˜å„²ï¼Œé›†ç¾¤æ­£å¸¸é‹è¡ŒæœŸé–“ï¼Œå³ä¾¿å…ƒå­˜å„²æ•…éšœä¹Ÿä¸å†å½±éŸ¿ codis é›†ç¾¤ï¼Œå¤§å¤§æå‡ codis-proxy ç©©å®šæ€§</li><li>å° codis-proxy é€²è¡Œäº†å¤§é‡æ€§èƒ½å„ªåŒ–,é€šéæ§åˆ¶GCé »ç‡ã€æ¸›å°‘å°è±¡å‰µå»ºã€å…§å­˜é åˆ†é…ã€å¼•å…¥ cgoã€jemalloc ç­‰ï¼Œä½¿å…¶ååé‚„æ˜¯å»¶é²ï¼Œéƒ½å·²é”åˆ° codis é …ç›®ä¸­æœ€ä½³</li><li>proxy å¯¦ç¾ select å‘½ä»¤ï¼Œæ”¯æŒå¤š DB</li><li>proxy æ”¯æŒè®€å¯«åˆ†é›¢ã€å„ªå…ˆè®€åŒ IP/åŒ DC ä¸‹å‰¯æœ¬åŠŸèƒ½</li><li>åŸºæ–¼ redis-sentinel å¯¦ç¾ä¸»å‚™è‡ªå‹•åˆ‡æ›</li><li>å¯¦ç¾å‹•æ…‹ pipeline ç·©å­˜å€ï¼ˆæ¸›å°‘å…§å­˜åˆ†é…ä»¥åŠæ‰€å¼•èµ·çš„ GC å•é¡Œï¼‰</li><li>proxy æ”¯æŒé€šé HTTP è«‹æ±‚å¯¦æ™‚ç²å– runtime metricsï¼Œä¾¿æ–¼ç›£æ§ã€é‹ç¶­</li><li>æ”¯æŒé€šé influxdb å’Œ statsd æ¡é›† proxy metrics</li><li>slot auto rebalance ç®—æ³•å¾0 çš„åŸºæ–¼ max memory policy è®Šæ›´æˆåŸºæ–¼ group ä¸‹ slot æ•¸é‡</li><li>æä¾›äº†æ›´åŠ å‹å¥½çš„ dashboard å’Œ fe ç•Œé¢ï¼Œæ–°å¢äº†å¾ˆå¤šæŒ‰éˆ•ã€è·³è½‰éˆæ¥ã€éŒ¯èª¤ç‹€æ…‹ç­‰ï¼Œæœ‰åˆ©æ–¼å¿«é€Ÿç™¼ç¾ã€è™•ç†é›†ç¾¤æ•…éšœ</li><li>æ–°å¢ SLOTSSCAN æŒ‡ä»¤ï¼Œä¾¿æ–¼ç²å–é›†ç¾¤å„å€‹ slot ä¸‹çš„æ‰€æœ‰ key</li><li>codis-proxy èˆ‡ codis-dashbaord æ”¯æŒ docker éƒ¨ç½²</li></ul><h1 class=pgc-h-arrow-right>codisæ¶æ§‹å¦‚ä¸‹</h1><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d07cbed4a00b44508640b7c382aadd56><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>codis çµ„ä»¶ä»‹ç´¹</h1><p><strong>codis server</strong>ï¼šåŸºæ–¼redis-3.2.8 åˆ†æ”¯é–‹ç™¼ã€‚å¢åŠ äº†é¡å¤–çš„æ•¸æ“šçµæ§‹ï¼Œä»¥æ”¯æŒslotæœ‰é—œçš„æ“ä½œä»¥åŠæ•¸æ“šé·ç§»æŒ‡ä»¤ã€‚å…·é«”çš„ä¿®æ”¹å¯ä»¥åƒè€ƒæ–‡æª”redisçš„ä¿®æ”¹</p><p><strong>codis proxy</strong>ï¼šå®¢æˆ¶ç«¯é€£æ¥çš„redisä»£ç†æœå‹™ï¼Œå¯¦ç¾äº†rediså”è­°ã€‚é™¤éƒ¨åˆ†å‘½ä»¤ä¸æ”¯æŒä»¥å¤–ï¼ˆä¸æ”¯æŒçš„å‘½ä»¤åˆ—è¡¨ï¼‰ï¼Œè¡¨ç¾çš„å’ŒåŸç”Ÿçš„redisæ²’æœ‰å€åˆ¥ã€‚</p><p>å°æ–¼åŒä¸€å€‹æ¥­å‹™é›†ç¾¤è€Œè¨€ï¼Œå¯ä»¥åŒæ™‚éƒ¨ç½²å¤šå€‹codis-proxyå¯¦ä¾‹ï¼›</p><p>ä¸åŒcodis-proxyä¹‹é–“ç”±codis-dashboardä¿è­‰ç‹€æ…‹åŒæ­¥ã€‚</p><p><strong>codis dashboard</strong>ï¼šé›†ç¾¤ç®¡ç†å·¥å…·ï¼Œæ”¯æŒcodis-proxyã€codis-serverçš„æ·»åŠ ã€åˆªé™¤ã€ä»¥åŠæ•¸æ“šé·ç§»æ“ä½œã€‚åœ¨é›†ç¾¤ç‹€æ…‹ç™¼ç”Ÿæ”¹è®Šæ™‚ï¼Œcodis-dashboardç¶­è­·é›†ç¾¤ä¸‹æ‰€æœ‰codis-proxyçš„ç‹€æ…‹ä¸€è‡´æ€§ã€‚</p><p>å°æ–¼åŒä¸€å€‹æ¥­å‹™é›†ç¾¤è€Œè¨€ï¼ŒåŒä¸€æ™‚åˆ»codis-dashboardåªèƒ½æœ‰0å€‹æˆ–è€…1å€‹</p><p>æ‰€æœ‰å°é›†ç¾¤çš„ä¿®æ”¹éƒ½å¿…é ˆé€šécodis-dashboardå®Œæˆã€‚</p><p><strong>codis FE</strong>ï¼šé›†ç¾¤ç®¡ç†ç•Œé¢</p><p>å¤šå€‹é›†ç¾¤å¯¦ä¾‹å…±äº«å¯ä»¥å…±äº«åŒä¸€å€‹å‰ç«¯å±•ç¤ºé é¢ï¼›</p><p>é€šéé…ç½®æ–‡ä»¶ç®¡ç†å¾Œç«¯codis-dashboardåˆ—è¡¨ï¼Œé…ç½®æ–‡ä»¶å¯è‡ªå‹•æ›´æ–°ã€‚</p><p><strong>storage</strong>ï¼š</p><p>æä¾›namespaceæ¦‚å¿µï¼Œä¸åŒé›†ç¾¤æœƒæŒ‰ç…§ä¸åŒproduct nameé€²è¡Œçµ„ç¹”ï¼›</p><p>ç›®å‰åƒ…æä¾›äº†zookeeperã€etcdã€fsä¸‰ç¨®å¯¦ç¾ï¼Œä½†æ˜¯æä¾›äº†æŠ½è±¡çš„interfaceå¯è‡ªè¡Œæ“´å±•ã€‚</p><p><br></p><h1 class=pgc-h-arrow-right>codis æ˜¯å¦‚ä½•åˆ†ç‰‡çš„</h1><p>Codis æ¡ç”¨ Pre-sharding çš„æŠ€è¡“ä¾†å¯¦ç¾æ•¸æ“šçš„åˆ†ç‰‡, é»˜èªåˆ†æˆ 1024 å€‹ slots (0-1023), å°æ–¼æ¯å€‹keyä¾†èªª, é€šéä»¥ä¸‹å…¬å¼ç¢ºå®šæ‰€å±¬çš„ Slot Id : SlotId = crc32(key) % 1024ã€‚</p><p>æ¯ä¸€å€‹ slot éƒ½æœƒæœ‰ä¸€å€‹ä¸”å¿…é ˆæœ‰ä¸€å€‹ç‰¹å®šçš„ server group id ä¾†è¡¨ç¤ºé€™å€‹ slot çš„æ•¸æ“šç”±å“ªå€‹ server group ä¾†æä¾›ã€‚æ•¸æ“šçš„é·ç§»ä¹Ÿæ˜¯ä»¥slotç‚ºå–®ä½çš„ã€‚</p><p><br></p><h1 class=pgc-h-arrow-right>Codiséƒ¨ç½²</h1><h1 class=pgc-h-arrow-right>ç’°å¢ƒèªªæ˜</h1><p>ç¯€é»ç·¨è™ŸIPåœ°å€æ“ä½œç³»çµ±node1192.168.28.71Centos 7.2node2192.168.28.72Centos 7.2node3192.168.28.73Centos 7.2</p><p>Codiséƒ¨ç½²æ¶æ§‹å¦‚ä¸‹åœ–</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/990df85e4fa645d19160f5a3b63c9976><p class=pgc-img-caption></p></div><p>codis serverä¸»å¾åˆ†ä½ˆå¦‚ä¸‹åœ–</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6f14b9c6313442d6854cb296eecfed58><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>å®‰è£éƒ¨ç½²</h1><h1 class=pgc-h-arrow-right>zookeeper å®‰è£</h1><p>codisçš„å…ƒæ•¸æ“šå­˜å„²ä¾è³´zookeeperï¼Œæ‰€ä»¥åœ¨å®‰è£codisä¹‹å‰æˆ‘å€‘éœ€è¦å®‰è£ä¸€å€‹zookeeperç’°å¢ƒ</p><p>å®‰è£éç¨‹ç•¥</p><h1 class=pgc-h-arrow-right>goå®‰è£</h1><p>ç”±æ–¼codisæ˜¯goèªè¨€å¯«çš„ï¼Œæ‰€ä»¥éœ€è¦åœ¨æ¯è‡ºcodisä¸»æ©Ÿå®‰è£goèªè¨€é‹è¡Œç’°å¢ƒã€‚</p><p>1ã€å®‰è£go</p><pre><code>[root@node1 ~]# yum -y install golang</code></pre><p>2ã€è¨­ç½®goé‹è¡Œç’°å¢ƒ</p><pre><code>[root@node1 ~]# mkdir /data/go -p[root@node1 ~]# vim /etc/profileexport GOPATH=/data/goexport PATH=$PATH:$GOPATH/bin[root@node1 ~]# source /etc/profile</code></pre><p>3ã€å®‰è£godep</p><p><br></p><pre><code>[root@node1 ~]# yum -y install git[root@node1 ~]# go get -u github.com/tools/godep &amp;&amp; which godep/data/go/bin/godep</code></pre><h1 class=pgc-h-arrow-right>codis å®‰è£</h1><p><strong>1ã€å®‰è£ä¾è³´</strong></p><pre><code>yumÂ installÂ autoconfÂ automakeÂ libtoolÂ -y</code></pre><p><strong>2ã€ç·¨è­¯å®‰è£</strong></p><p><br></p><pre><code>mkdir -pÂ /data/go/src/github.com/CodisLabscd /data/go/src/github.com/CodisLabsgit clone https://github.com/CodisLabs/codis.git -b release3.2cd codis/make</code></pre><p><strong>3ã€é…ç½®æ–‡ä»¶ä¿®æ”¹dashboard é…ç½®ä¿®æ”¹</strong></p><p><br></p><pre><code># vim config/dashboard.tomlcoordinator_name =Â "zookeeper"coordinator_addr =Â "192.168.28.71:2181,192.168.28.72:2181,192.168.28.73:2181"product_name =Â "xuele-codis"</code></pre><p>è¤‡è£½é…ç½®æ–‡ä»¶åˆ°å¦å¤–å…©å€‹ç¯€é»</p><pre><code>scp config/dashboard.toml 10.1.13.172:/data/go/src/github.com/CodisLabs/codis/config/dashboard.toml</code></pre><pre><code>scp config/dashboard.toml 10.1.13.173:/data/go/src/github.com/CodisLabs/codis/config/dashboard.toml</code></pre><p><strong>4ã€codis-proxyé…ç½®</strong></p><pre><code># vim config/proxy.tomlproduct_name =Â "xuele-codis"product_auth =Â ""jodis_name =Â "zookeeper"jodis_addr =Â "192.168.28.71:2181,192.168.28.72:2181,192.168.28.73:2181"jodis_auth =Â ""jodis_timeout =Â "20s"jodis_compatible =Â true</code></pre><p>è¤‡è£½é…ç½®æ–‡ä»¶åˆ°å¦å¤–å…©å€‹ç¯€é»</p><pre><code>scp config/proxy.toml 10.1.13.172:/data/go/src/github.com/CodisLabs/codis/config/proxy.tomlscp config/proxy.toml 10.1.13.173:/data/go/src/github.com/CodisLabs/codis/config/proxy.toml</code></pre><p><strong>5ã€codis-serveré…ç½®</strong></p><pre><code>[root@c7-node1 redis-3.2.11]# pwd/data/go/src/github.com/CodisLabs/codis/extern/redis-3.2.11[root@c7-node1 redis-3.2.11]# mkdir /data/redis[root@c7-node1 redis-3.2.11]# cp redis.conf /data/redis/redis-6379.conf[root@c7-node1 redis-3.2.11]# cp redis.conf /data/redis/redis-6380.conf[root@c7-node1 redis-3.2.11]# cp redis.conf /data/redis/redis-6381.conf</code></pre><p><strong>6ã€redisé…ç½®æ–‡ä»¶ä¿®æ”¹</strong></p><p><br></p><pre><code># vim /data/redis/redis-6379.confport 6379pidfileÂ /tmp/redis_6379.pidlogfileÂ "/tmp/redis_6379.log"dbfilename dump_6379.rdbmaxmemory 1gdir /data/redis/redis_6379ä¿®æ”¹6379ç‚º6380</code></pre><p><br></p><pre><code># vim /data/redis/redis-6380.confport 6380pidfileÂ /tmp/redis_6380.pidlogfileÂ "/tmp/redis_6380.log"dbfilename dump_6380.rdbmaxmemory 1gdir /data/redis/redis_6380</code></pre><p>ä¿®æ”¹6379ç‚º6381</p><pre><code># vim /data/redis/redis-6381.confport 6381pidfileÂ /tmp/redis_6381.pidlogfileÂ "/tmp/redis_6381.log"dbfilename dump_6381.rdbmaxmemory 1gdir /data/redis/redis_6381</code></pre><p>è¤‡è£½é…ç½®æ–‡ä»¶åˆ°å¦å¤–å…©å€‹ç¯€é»</p><pre><code>scp /data/redis/*.conf 10.1.13.172:/data/redis/scp /data/redis/*.conf 10.1.13.173:/data/redis/</code></pre><p>ä¿®æ”¹å®Œé…ç½®æ–‡ä»¶ï¼Œé‚„éœ€è¦å‰µå»ºç›¸é—œç›®éŒ„</p><pre><code>mkdir /data/redis/redis_6379 -pmkdir /data/redis/redis_6380 -pmkdir /data/redis/redis_6381 -p</code></pre><p><strong>7ã€æœå‹™å•Ÿå‹•åŠåˆå§‹åŒ–é›†ç¾¤å•Ÿå‹•dashboard</strong></p><p># nohup ./bin/codis-dashboard --ncpu=1 --config=config/dashboard.toml --log=dashboard.log --log-level=WARN >> /var/log/codis_dashboard.log &</p><p>å•Ÿå‹•proxy</p><pre><code>nohup ./bin/codis-proxy --ncpu=1 --config=config/proxy.toml --log=proxy.log --log-level=WARN &gt;&gt;Â /var/log/codis_proxy.log &amp;</code></pre><p>å•Ÿå‹•codis server</p><pre><code>nohup ./bin/codis-server /data/redis/redis-6379.conf &amp;nohup ./bin/codis-server /data/redis/redis-6380.conf &amp;nohup ./bin/codis-server /data/redis/redis-6381.conf &amp;</code></pre><p>å•Ÿå‹•codis-fe</p><pre><code>nohup ./bin/codis-fe --ncpu=1 --log=fe.log --log-level=WARN --zookeeper=192.168.28.71:2181,192.168.28.72:2181,192.168.28.73:2181 --listen=192.168.28.71:8090 &amp;</code></pre><p>è¨ªå•codisç®¡ç†ç•Œé¢</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a62eab6581b648d69861b5d6153f778c><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>webç•Œé¢é…ç½®</h1><p><strong>1ã€æ·»åŠ proxy</strong></p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f9c334ab1ccf49d2ac2e6242916b615f><p class=pgc-img-caption></p></div><p><strong>2ã€æ·»åŠ groupå’Œserver</strong></p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/f736c7a4cf8f41f8918f8993e1b74b24><p class=pgc-img-caption></p></div><p><strong>3ã€é€šéfeåˆå§‹åŒ–solt</strong></p><p>æ–°å¢çš„é›†ç¾¤ slot ç‹€æ…‹æ˜¯ offlineï¼Œå› æ­¤æˆ‘å€‘éœ€è¦å°å®ƒé€²è¡Œåˆå§‹åŒ–ï¼ˆå°‡ 1024 å€‹ slot åˆ†é…åˆ°å„å€‹ groupï¼‰ï¼Œè€Œåˆå§‹åŒ–æœ€å¿«çš„æ–¹æ³•å¯é€šé fe æä¾›çš„ rebalance all slots æŒ‰éˆ•ä¾†åšï¼Œå¦‚ä¸‹åœ–æ‰€ç¤ºï¼Œé»æ“Šæ­¤æŒ‰éˆ•ï¼Œæˆ‘å€‘å³å¿«é€Ÿå®Œæˆäº†ä¸€å€‹é›†ç¾¤çš„æ­å»ºã€‚</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/46e2e3fb127a4c0590e51579fd687326><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>æ¸¬è©¦é©—è­‰</h1><p>é€šéé€£æ¥codis-proxyé€²è¡Œé©—è­‰</p><pre><code># redis-cli -h 192.168.28.71 -p 19000192.168.28.71:19000&gt; INFO# Serverredis_version:3.2.11redis_git_sha1:7191a280redis_git_dirty:0redis_build_id:a9271caacf948e7redis_mode:standaloneos:Linux 3.10.0-514.el7.x86_64 x86_64arch_bits:64multiplexing_api:epollgcc_version:4.8.5process_id:48993run_id:2f8dff0622b212a2838f232abf8a166c0f0efb25tcp_port:6379uptime_in_seconds:1369uptime_in_days:0hz:10lru_clock:7144691executable:/data/go/src/github.com/CodisLabs/codis/./bin/codis-serverconfig_file:/data/redis/redis-6379.confÂ # Clientsconnected_clients:49client_longest_output_list:0client_biggest_input_buf:0blocked_clients:0Â # Memoryused_memory:5338840used_memory_human:5.09Mused_memory_rss:13819904used_memory_rss_human:13.18Mused_memory_peak:6361912used_memory_peak_human:6.07Mtotal_system_memory:1912107008total_system_memory_human:1.78Gused_memory_lua:37888used_memory_lua_human:37.00Kmaxmemory:1000000000maxmemory_human:953.67Mmaxmemory_policy:noevictionmem_fragmentation_ratio:2.59mem_allocator:jemalloc-4.0.3Â # Persistenceloading:0rdb_changes_since_last_save:0rdb_bgsave_in_progress:0rdb_last_save_time:1533870359rdb_last_bgsave_status:okrdb_last_bgsave_time_sec:1rdb_current_bgsave_time_sec:-1aof_enabled:0aof_rewrite_in_progress:0aof_rewrite_scheduled:0aof_last_rewrite_time_sec:-1aof_current_rewrite_time_sec:-1aof_last_bgrewrite_status:okaof_last_write_status:okÂ # Statstotal_connections_received:150total_commands_processed:7126instantaneous_ops_per_sec:22total_net_input_bytes:153606total_net_output_bytes:2783917instantaneous_input_kbps:0.36instantaneous_output_kbps:8.56rejected_connections:0sync_full:1sync_partial_ok:0sync_partial_err:0expired_keys:0evicted_keys:0keyspace_hits:0keyspace_misses:0pubsub_channels:0pubsub_patterns:0latest_fork_usec:18123migrate_cached_sockets:0Â # Replicationrole:masterconnected_slaves:1slave0:ip=192.168.28.71,port=6380,state=online,offset=1373,lag=1master_repl_offset:1373repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:2repl_backlog_histlen:1372Â # CPUused_cpu_sys:1.65used_cpu_user:0.72used_cpu_sys_children:0.31used_cpu_user_children:0.00Â # Clustercluster_enabled:0Â </code></pre><p># Keyspace</p><p>è®€å¯«æ•¸æ“šé©—è­‰</p><pre><code>192.168.28.71:19000&gt; SET name heheOK192.168.28.71:19000&gt; GET name"hehe"webç•Œé¢é©—è­‰keyå·²ç¶“æ­£å¸¸å¯«å…¥</code></pre><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/32de74e96d4d46c280ad18a8ead61def><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>å£“æ¸¬</h1><pre><code>[root@c7-node1 codis]# ./bin/redis-benchmark -h 192.168.28.71 -p 19000 -c 100 -d 100 -t set -n 10000 -r 10000</code></pre><p>ä¸Šè¿°å‘½ä»¤çš„æ„æ€æ˜¯ï¼Œä½¿ç”¨redis-benchmarkå£“åŠ›æ¸¬è©¦å‘½ä»¤é€£æ¥codisé›†ç¾¤ï¼ŒåŒæ™‚ä½µç™¼10000å€‹ï¼ˆ-cï¼‰ï¼Œæ¸¬è©¦setæ“ä½œ(-t)ï¼Œæ¯å€‹æ¸¬è©¦æ•¸æ“šé›†æ˜¯100å­—ç¯€(-d),è«‹æ±‚æ•¸æ˜¯100000ï¼ˆ-nï¼‰ï¼Œä½¿ç”¨ä½¿ç”¨éš¨æ©Ÿæ•¸æ’å…¥æ•¸å€¼ï¼ˆ-rï¼‰ã€‚</p><p>æ¸¬è©¦çµæœç‚º1ç§’å…§å®Œæˆ1è¬å€‹setæ“ä½œ</p><pre><code>====== SET ======Â Â 10000 requests completedÂ in 0.96 secondsÂ Â 100 parallel clientsÂ Â 100 bytes payloadÂ Â keep alive: 1å£“æ¸¬å¾Œå¯ä»¥çœ‹åˆ°åˆ†åˆ°å¾Œç«¯groupçš„æ•¸æ“šé‚„æ˜¯æ¯”è¼ƒå‡è¡¡çš„</code></pre><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b33742a908b64a0d919ce0ff114c6e12><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>åŸºæ–¼redis-sentinelå¯¦ç¾ä¸»å‚™åˆ‡æ›</h1><p>ä¿®æ”¹sentinelé…ç½®æ–‡ä»¶</p><p><br></p><pre><code>[root@c7-node1 codis]# cat /data/redis/sentinel.confÂ port 26379bind 0.0.0.0Â pidfileÂ "/data/redis/logs/sentinel.pid"logfileÂ "/data/redis/logs/sentinel.log"dir "/data/redis/db"Â sentinel monitor codis-server-01 192.168.28.71 6379 2sentinel down-after-milliseconds codis-server-01 5000sentinel failover-timeout codis-server-01 60000sentinel parallel-syncs codis-server-01 2Â sentinel monitor codis-server-02 192.168.28.72 6380 2sentinel down-after-milliseconds codis-server-02 5000sentinel failover-timeout codis-server-02 60000sentinel parallel-syncs codis-server-02 2Â sentinel monitor codis-server-03 192.168.28.73 6381 2sentinel down-after-milliseconds codis-server-03 5000sentinel failover-timeout codis-server-03 60000sentinel parallel-syncs codis-server-03 2</code></pre><p>è¤‡è£½sentinelé…ç½®åˆ°å…¶ä»–ç¯€é»</p><pre><code>scp /data/redis/sentinel.conf 192.168.28.72:/data/redis/sentinel.confscp /data/redis/sentinel.conf 192.168.28.73:/data/redis/sentinel.conf</code></pre><p>å‰µå»ºç›¸é—œç›®éŒ„</p><p><br></p><pre><code>mkdir /data/redis/logs/mkdir /data/redis/db/</code></pre><p>å•Ÿå‹•sentinel</p><pre><code>[root@c7-node1 codis]# pwd/data/go/src/github.com/CodisLabs/codis[root@c7-node1 codis]# nohup ./bin/redis-sentinel /data/redis/sentinel.conf &amp;codis webé é¢æ·»åŠ sentinels</code></pre><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c9764a5ad2f64f958b6b27915049682e><p class=pgc-img-caption></p></div><p>é…ç½®å®Œæˆå¾Œå¯ä»¥åœ¨groupä¸­çœ‹åˆ°æ˜é¡¯çš„HAæ¨™èªŒ</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/538af1dea8324930973caee1fc41f82b><p class=pgc-img-caption></p></div><p>æ‰‹å‹•kill æ‰ä¸€å€‹ä¸»ç¯€é»æ¸¬è©¦å¯ç”¨æ€§</p><p>killæ‰192.168.28.72æ©Ÿå™¨ä¸Šçš„6380ä¸»ç¯€é»ï¼Œé©—è­‰å¾ç¯€é»å¯ä»¥æ­£å¸¸è½‰ç§»</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/08d91bb1ebe4492f89438179fa5a40d2><p class=pgc-img-caption></p></div><p>é©—è­‰æ­»ä¸€è‡ºæ©Ÿå™¨(æ‰‹å‹•é—œé–‰192.168.28.73ç¯€é»)ï¼Œcodisé›†ç¾¤èƒ½å¦æ­£å¸¸æä¾›æœå‹™</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/dd5b9e90fe5a4fc4a592ac3a018fd68b><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>æ•¸æ“šå¹³æ»‘é·ç§»</h1><p>redis æ•¸æ“š å¹³æ»‘é·ç§»åˆ°codis ä½¿ç”¨codiså®˜æ–¹æä¾›çš„redis-portå·¥å…·ã€‚</p><p>åŸç†ï¼šredis-portæœ¬è³ªæ˜¯ä»¥slaveçš„å½¢å¼æ›è¼‰åˆ°ç¾æœ‰redisæœå‹™ä¸Šå»çš„</p><p>1ã€redisæœƒç”ŸæˆRDB dumpæ–‡ä»¶çµ¦åšç‚ºslaveçš„redis-port</p><p>2ã€redis-portåˆ†æRDBæ–‡ä»¶ï¼Œä¸¦æ‹†åˆ†æˆkey-valueå°ï¼Œé€šéslotsresteræŒ‡ä»¤ç™¼çµ¦codis</p><p>3ã€é·ç§»éç¨‹ä¸­ç™¼ç”Ÿçš„ä¿®æ”¹ï¼Œredisæœƒå°‡é€™äº›æŒ‡ä»¤åœ¨RDB DUMPç™¼é€å®Œæˆå¾Œï¼Œå†ç™¼çµ¦redis-portï¼Œè€Œredis-portæ”¶åˆ°é€™äº›æŒ‡ä»¤å¾Œä¸åšè™•ç†ï¼Œè€Œç›´æ¥è½‰ç™¼çµ¦codis</p><p>redis-port githubåœ°å€ï¼š https://github.com/CodisLabs/redis-port</p><p>ï¼ˆ1ï¼‰å®‰è£redis-port</p><pre><code>cd /data/go/src/github.com/CodisLabsgo get -u github.com/CodisLabs/redis-portgo get github.com/cupcake/rdbcd redis-port/make</code></pre><p>æ•¸æ“šåŒæ­¥å‘½ä»¤</p><pre><code>./bin/redis-sync -m 192.168.201.3:6381 -t 192.168.28.71:19000</code></pre><p>åƒæ•¸èªªæ˜ï¼š</p><p>-m æºé›†ç¾¤åœ°å€å’Œç«¯å£</p><p>-t ç›®æ¨™é›†ç¾¤åœ°å€å’Œç«¯å£</p><h1 class=pgc-h-arrow-right>redis æ•¸æ“šæ“´å®¹</h1><p>èªªæ˜ï¼šæœ¬æ¬¡æ“´å®¹æ·»åŠ 3çµ„codis-serverï¼Œæ•¸æ“šæ“´å®¹æ¸¬è©¦ç”±æ–¼ä¸æ¶‰åŠé«˜å¯ç”¨ç›¸é—œå…§å®¹ï¼Œæ‰€ä»¥æ“´å®¹çš„codis serverå‡ç‚ºå–®é»</p><p>ï¼ˆ1ï¼‰æŒ‰ç…§ä¹‹å‰çš„éƒ¨ç½²æ–¹å¼ï¼Œåˆ†åˆ¥åœ¨ä¸‰å€‹ç¯€é»å„è‡ªå•Ÿå‹•äº†ä¸€å€‹codis serverï¼Œç«¯å£åˆ†åˆ¥ç‚º6382ï¼Œ6383ï¼Œ6384ï¼Œä¸¦åœ¨webç®¡ç†ç•Œé¢æ·»åŠ åˆ°äº†é›†ç¾¤ä¸­</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7165af05e58b4aeba3418e1a6adeb1fe><p class=pgc-img-caption></p></div><p>ï¼ˆ2ï¼‰é€šérebalance all slotsä¾†å¯¦ç¾é›†ç¾¤çš„slotsè‡ªå‹•å‡è¡¡</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/522905cec74647d4b5b5572923870ea3><p class=pgc-img-caption></p></div><p>ï¼ˆ3ï¼‰ç¢ºå®šæ¯å€‹æ–°åŠ å…¥çš„groupåˆ†é…çš„slotsã€‚</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/825f8e671a0b474eb1e591445f22c927><p class=pgc-img-caption></p></div><p>ï¼ˆ4ï¼‰åˆ†é…å®Œæˆsloté¡¯ç¤ºå¦‚ä¸‹æ‰€ç¤º</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/10e20807e8f944f6b806d8c50d5e94d7><p class=pgc-img-caption></p></div><p>å¾groupçœ‹ï¼Œæ¯çµ„åˆ†ç‰‡çš„memoryç©ºé–“ä½”ç”¨æƒ…æ³ä¹Ÿæ˜¯å‡è¡¡çš„</p><div class=pgc-img><img alt="codis é«˜å¯ç”¨é›†ç¾¤è·³énginx ä»£ç†" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/acfde37d614c4d73b132ca590949fa8b><p class=pgc-img-caption></p></div><h1 class=pgc-h-arrow-right>dashboard æ•…éšœç•°æ©Ÿå•Ÿå‹•</h1><p>codis å®˜æ–¹åƒ…å…è¨±é‹è¡Œä¸€å€‹dashboardç¯€é»ï¼Œdashboardç¯€é»å•Ÿå‹•æœƒåœ¨zkä¸Šè¨»å†Šè‡ªå·±çš„ç¯€é»ï¼ŒåŒæ™‚åœ¨ç¨‹åºæ­£å¸¸é€€å‡ºçš„æ™‚å€™åˆªæ‰å°æ‡‰çš„ç¯€é»ï¼Œä½†å¦‚æœç•°å¸¸é€€å‡ºå°±æœƒå°è‡´zkçš„ç¯€é»ç„¡æ³•åˆªé™¤ï¼Œåœ¨ä¸‹ä¸€æ¬¡å•Ÿå‹•çš„æ™‚å€™æœƒå ±â€œzk: node already existsâ€çš„éŒ¯èª¤ã€‚</p><p>å¦‚æœdashboardç¯€é»å‡ºç¾æ•…éšœï¼ŒçŸ­æ™‚é–“ç„¡æ³•æ¢å¾©ï¼Œæˆ‘å€‘éœ€è¦åœ¨å¦å¤–ä¸€è‡ºç¯€é»å•Ÿå‹•dashboardçš„è©±ï¼Œéœ€è¦åœ¨zookeeperä¸­åˆªé™¤ç¯€é»çš„è¨»å†Šä¿¡æ¯ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><pre><code># ./zkCli.shdeleteÂ /codis3/xuele-codis/topom</code></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>codis</a></li><li><a>è·³é</a></li><li><a>nginx</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/a20a97e2.html alt=ç¶²å‚³ä¸‰æ˜Ÿè·³é4nmç›´æ¥é€²å…¥3nmï¼Ÿæ˜¯ç‚’å†·é£¯é‚„æ˜¯ç‚’ä½œï¼Ÿ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/6565b4dde10a4ed5a1a886d27570eeab style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a20a97e2.html title=ç¶²å‚³ä¸‰æ˜Ÿè·³é4nmç›´æ¥é€²å…¥3nmï¼Ÿæ˜¯ç‚’å†·é£¯é‚„æ˜¯ç‚’ä½œï¼Ÿ>ç¶²å‚³ä¸‰æ˜Ÿè·³é4nmç›´æ¥é€²å…¥3nmï¼Ÿæ˜¯ç‚’å†·é£¯é‚„æ˜¯ç‚’ä½œï¼Ÿ</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/d74c5aac.html alt=è±¡å±±ç±é‹å‹•å“¡èƒ¡æ™¨è·³éäº†2.10ç±³å¯§æ³¢æ–°é«˜åº¦ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/SEsvBO72atfqJw style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/d74c5aac.html title=è±¡å±±ç±é‹å‹•å“¡èƒ¡æ™¨è·³éäº†2.10ç±³å¯§æ³¢æ–°é«˜åº¦>è±¡å±±ç±é‹å‹•å“¡èƒ¡æ™¨è·³éäº†2.10ç±³å¯§æ³¢æ–°é«˜åº¦</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/140963f.html alt=è·³é5Gç›´æ¥é€²è»6Gï¼ç¾åœ‹æŠ€è¡“å®˜å“¡åˆé–‹å§‹å¹äº†ï¼šé€™æ¬¡æ›æˆ‘å€‘é ˜å…ˆ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/43841e348c65443fbbd0e6842f5b0bc8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/140963f.html title=è·³é5Gç›´æ¥é€²è»6Gï¼ç¾åœ‹æŠ€è¡“å®˜å“¡åˆé–‹å§‹å¹äº†ï¼šé€™æ¬¡æ›æˆ‘å€‘é ˜å…ˆ>è·³é5Gç›´æ¥é€²è»6Gï¼ç¾åœ‹æŠ€è¡“å®˜å“¡åˆé–‹å§‹å¹äº†ï¼šé€™æ¬¡æ›æˆ‘å€‘é ˜å…ˆ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a790603.html alt="16-ç¬¬äºŒç¯€ nginxé…ç½®æ–‡ä»¶ç°¡è¿°" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d238c5f67e394a75b6a5a2057fe77f8c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a790603.html title="16-ç¬¬äºŒç¯€ nginxé…ç½®æ–‡ä»¶ç°¡è¿°">16-ç¬¬äºŒç¯€ nginxé…ç½®æ–‡ä»¶ç°¡è¿°</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>