<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€ | æå®¢å¿«è¨Š</title><meta property="og:title" content="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/S4RDmAJA74o9GY"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e39543b2.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e39543b2.html><meta property="article:published_time" content="2020-11-14T20:59:53+08:00"><meta property="article:modified_time" content="2020-11-14T20:59:53+08:00"><meta name=Keywords content><meta name=description content="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/e39543b2.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><p>Flink å¾å…¥é–€åˆ°ç²¾é€š ç³»åˆ—æ–‡ç« </p><p>ä½œè€…ï¼š<strong class=highlight-text toutiao-origin=span>é€å‡±</strong>ï¼Œé˜¿é‡Œé›²æ•¸æ“šåº«å¯¦ç¿’é–‹ç™¼å·¥ç¨‹å¸«</p><p>æ³¨ï¼šä»¥ä¸‹åˆ†æåŸºæ–¼é–‹æº v19.15.2.2-stable ç‰ˆæœ¬é€²è¡Œï¼Œç¤¾å€æœ€æ–°ç‰ˆæœ¬ä»£ç¢¼æ”¹å‹•è¼ƒå¤§ï¼Œä½†æ˜¯ç¸½é«”æ€è·¯æ˜¯ä¸è®Šçš„ã€‚</p><p>01</p><p></p><h1 toutiao-origin=h2>ç”¨æˆ¶æäº¤ä¸€æ¢æŸ¥è©¢SQLèƒŒå¾Œç™¼ç”Ÿäº†ä»€éº¼</h1><p>åœ¨å‚³çµ±é—œä¿‚å‹æ•¸æ“šåº«ä¸­ï¼ŒSQLè™•ç†å™¨çš„çµ„ä»¶ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å¹¾ç¨®ï¼š</p><p><strong>â€¢ Query Parsing</strong></p><p>è² è²¬é€²è¡Œè©æ³•å’Œèªæ³•åˆ†æ,æŠŠç¨‹åºå¾äººé¡é«˜å¯è®€çš„æ ¼å¼(å³SQL)è½‰åŒ–æˆæ©Ÿå™¨é«˜å¯è®€çš„æ ¼å¼(AST,æŠ½è±¡èªæ³•æ¨¹)ã€‚</p><p>è©æ³•åˆ†ææŒ‡çš„æ˜¯æŠŠSQLä¸­çš„å­—ç¬¦åºåˆ—åˆ†è§£æˆä¸€å€‹å€‹ç¨ç«‹çš„è©æ³•å–®å…ƒâ€”â€”Token(&lt;é¡å‹ï¼Œå€¼>)ã€‚</p><p>èªæ³•åˆ†ææŒ‡çš„æ˜¯å¾è©æ³•åˆ†æå™¨è¼¸å‡ºçš„tokenä¸­è­˜åˆ¥å„é¡çŸ­èªï¼Œä¸¦æ§‹é€ å‡ºä¸€é¡†æŠ½è±¡èªæ³•æ¨¹ã€‚è€ŒæŒ‰ç…§æ§‹é€ æŠ½è±¡èªæ³•æ¨¹çš„æ–¹å‘ï¼Œåˆå¯ä»¥æŠŠèªæ³•åˆ†æåˆ†æˆè‡ªé ‚å‘ä¸‹å’Œè‡ªåº•å‘ä¸Šåˆ†æå…©ç¨®ã€‚è€ŒClickHouseæ¡ç”¨çš„å‰‡æ˜¯æ‰‹å¯«ä¸€å€‹éæ­¸ä¸‹é™çš„èªæ³•åˆ†æå™¨ã€‚</p><p><strong>â€¢ Query Rewrite</strong></p><p>å³é€šå¸¸æˆ‘å€‘èªªçš„"Logical Optimizer"æˆ–åŸºæ–¼è¦å‰‡çš„å„ªåŒ–å™¨(Rule-Based Optimizer,å³RBO)ã€‚</p><p>å…¶è² è²¬æ‡‰ç”¨ä¸€äº›å•Ÿç™¼å¼è¦å‰‡ï¼Œè² è²¬ç°¡åŒ–å’Œæ¨™æº–åŒ–æŸ¥è©¢ï¼Œç„¡éœ€æ”¹è®ŠæŸ¥è©¢çš„èªç¾©ã€‚</p><p>å¸¸è¦‹æ“ä½œæœ‰:è¬‚è©å’Œç®—å­ä¸‹æ¨ï¼Œè¦–åœ–å±•é–‹ï¼Œç°¡åŒ–å¸¸é‡é‹ç®—è¡¨é”å¼ï¼Œè¬‚è©é‚è¼¯çš„é‡å¯«ï¼Œèªç¾©çš„å„ªåŒ–ç­‰ã€‚</p><p><strong>â€¢ Query Optimizer</strong></p><p>å³é€šå¸¸æˆ‘å€‘æ‰€èªªçš„"Physical Optimizer"ï¼Œè² è²¬æŠŠå…§éƒ¨æŸ¥è©¢è¡¨é”è½‰åŒ–æˆä¸€å€‹é«˜æ•ˆçš„æŸ¥è©¢è¨ˆåŠƒï¼ŒæŒ‡å°DBMSå¦‚ä½•å»å–è¡¨ï¼Œå¦‚ä½•é€²è¡Œæ’åºï¼Œå¦‚ä½•Joinã€‚å¦‚ä¸‹åœ–æ‰€ç¤ºï¼Œä¸€å€‹æŸ¥è©¢è¨ˆåŠƒå¯ä»¥è¢«èªç‚ºæ˜¯ä¸€å€‹æ•¸æ“šæµåœ–ï¼Œåœ¨é€™å€‹æ•¸æ“šæµåœ–ä¸­ï¼Œè¡¨æ•¸æ“šæœƒåƒåœ¨ç®¡é“ä¸­å‚³è¼¸ä¸€æ¨£ï¼Œå¾ä¸€å€‹æŸ¥è©¢æ“ä½œç¬¦(operator)å‚³éåˆ°å¦ä¸€å€‹æŸ¥è©¢æ“ä½œç¬¦ã€‚</p><img alt="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/S4RDmAJA74o9GY><p>ä¸€å€‹æŸ¥è©¢è¨ˆåŠƒ</p><p><strong>â€¢ Query Executor</strong></p><p>æŸ¥è©¢åŸ·è¡Œå™¨ï¼Œè² è²¬åŸ·è¡Œå…·é«”çš„æŸ¥è©¢è¨ˆåŠƒï¼Œå¾å­˜å„²å¼•æ“ä¸­ç²å–æ•¸æ“šä¸¦ä¸”å°æ•¸æ“šæ‡‰ç”¨æŸ¥è©¢è¨ˆåŠƒå¾—åˆ°çµæœã€‚</p><p>åŸ·è¡Œå¼•æ“ä¹Ÿåˆ†ç‚ºå¾ˆå¤šç¨®ï¼Œå¦‚ç¶“å…¸çš„ç«å±±æ¨¡å‹(Volcano Model)ï¼Œé‚„æœ‰ClickHouseæ¡ç”¨çš„å‘é‡åŒ–åŸ·è¡Œæ¨¡å‹(Vectorization Model)ã€‚</p><img alt="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/S4RDmBB8AKErrl><p>(åœ–ä¾†è‡ªç¶“å…¸è«–æ–‡ Architecture Of Database System)</p><p>ä½†ä¸ç®¡æ˜¯å‚³çµ±çš„é—œä¿‚å‹æ•¸æ“šåº«ï¼Œé‚„æ˜¯éé—œä¿‚å‹æ•¸æ“šåº«ï¼ŒSQLçš„è§£æå’Œç”ŸæˆåŸ·è¡Œè¨ˆåŠƒéç¨‹éƒ½æ˜¯å¤§åŒå°ç•°çš„ï¼Œè€Œç¸±è¦½ClickHouseçš„æºä»£ç¢¼ï¼Œå¯ä»¥æŠŠç”¨æˆ¶æäº¤ä¸€æ¢æŸ¥è©¢SQLèƒŒå¾Œçš„éç¨‹ç¸½çµå¦‚ä¸‹ï¼š</p><p>1.æœå‹™ç«¯æ¥æ”¶å®¢æˆ¶ç«¯ç™¼ä¾†çš„SQLè«‹æ±‚ï¼Œå…·é«”å½¢å¼æ˜¯ä¸€å€‹ç¶²çµ¡åŒ…ï¼ŒServerçš„å”è­°å±¤éœ€è¦æ‹†åŒ…æŠŠSQLè§£æå‡ºä¾†</p><p>2.Serverè² è²¬åˆå§‹åŒ–ä¸Šä¸‹æ–‡èˆ‡Network Handlerï¼Œç„¶å¾Œ Parser å°Queryåšè©æ³•å’Œèªæ³•åˆ†æï¼Œè§£ææˆAST</p><p>3.Interpreterçš„ SyntaxAnalyzer æœƒæ‡‰ç”¨ä¸€äº›å•Ÿç™¼å¼è¦å‰‡å°ASTé€²è¡Œå„ªåŒ–é‡å¯«</p><p>4.Interpreterçš„<strong toutiao-origin=span> ExpressionAnalyzer </strong>æ ¹æ“šä¸Šä¸‹æ–‡ä¿¡æ¯ä»¥åŠå„ªåŒ–é‡å¯«å¾Œçš„ASTç”Ÿæˆç‰©ç†åŸ·è¡Œè¨ˆåŠƒ</p><p>5.ç‰©ç†åŸ·è¡Œè¨ˆåŠƒåˆ†ç™¼åˆ°æœ¬åœ°æˆ–è€…åˆ†ä½ˆå¼çš„executor,å„è‡ªå¾å­˜å„²å¼•æ“ä¸­ç²å–æ•¸æ“š,æ‡‰ç”¨åŸ·è¡Œè¨ˆåŠƒ</p><p>6.ServeræŠŠåŸ·è¡Œå¾Œçš„çµæœä»¥Blockæµçš„å½¢å¼è¼¸å‡ºåˆ°Socketç·©è¡å€,Clientå¾Socketä¸­è®€å–å³å¯å¾—åˆ°çµæœ</p><img alt="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/S4RDmCJBLj2cxQ><p></p><h2 toutiao-origin=h3><strong class=highlight-text toutiao-origin=span>01 æ¥æ”¶å®¢æˆ¶ç«¯è«‹æ±‚</strong></h2><p>æˆ‘å€‘è¦ä»¥æœå‹™ç«¯çš„è¦–è§’ä¾†å‡ºç™¼ï¼Œé¦–å…ˆä¾†çœ‹server.cppå¤§æ¦‚åšä»€éº¼äº‹æƒ…:</p><p>ä¸‹é¢åªæŒ‘é¸é‡è¦çš„é‚è¼¯:</p><p>â€¢ åˆå§‹åŒ–ä¸Šä¸‹æ–‡</p><p>â€¢ åˆå§‹åŒ–Zookeeper(ClickHouseçš„å‰¯æœ¬è¤‡è£½æ©Ÿåˆ¶éœ€è¦ä¾è³´ZooKeeper)</p><p>â€¢ å¸¸è¦é…ç½®åˆå§‹åŒ–</p><p>â€¢ ç¶å®šæœå‹™ç«¯çš„ç«¯å£ï¼Œæ ¹æ“šç¶²çµ¡å”è­°åˆå§‹åŒ–Handlerï¼Œå°å®¢æˆ¶ç«¯æä¾›æœå‹™</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>int Server::main<br>{<br>// åˆå§‹åŒ–ä¸Šä¸‹æ–‡<br>global_context = std::make_unique&lt;Context&gt;(Context::createGlobal);<br>global_context-&gt;setApplicationType(Context::ApplicationType::SERVER);<br><br>// zkåˆå§‹åŒ–<br>zkutil::ZooKeeperNodeCache main_config_zk_node_cache([&amp;] { return global_context-&gt;getZooKeeper; });<br><br>//å…¶ä»–configçš„åˆå§‹åŒ–<br>//...<br><br>//ç¶å®šç«¯å£,å°å¤–æä¾›æœå‹™<br>auto address = make_socket_address(host, port);<br>socket.bind(address, /* reuseAddress = */ true);<br><br>//æ ¹æ“šç¶²çµ¡å”è­°å»ºç«‹ä¸åŒçš„serveré¡å‹<br>//ç¾åœ¨æ”¯æŒçš„serveré¡å‹æœ‰ï¼šHTTP,HTTPS,TCP,Interserver,mysql<br>//ä»¥TCPç‰ˆæœ¬ç‚ºä¾‹:<br>create_server("tcp_port", [&amp;](UInt16 port)<br>{<br>Poco::Net::ServerSocket socket;<br>auto address = socket_bind_listen(socket, listen_host, port);<br>servers.emplace_back(std::make_unique&lt;Poco::Net::TCPServer&gt;(<br>new TCPHandlerFactory(*this),<br>server_pool,<br>socket,<br>new Poco::Net::TCPServerParams));<br>});<br><br>//å•Ÿå‹•server<br>for (auto &amp; server : servers)<br>server-&gt;start;<br><br>}</code></p></pre><p>å®¢æˆ¶ç«¯ç™¼ä¾†çš„è«‹æ±‚æ˜¯ç”±å„è‡ªç¶²çµ¡å”è­°æ‰€å°æ‡‰çš„ Handler ä¾†é€²è¡Œçš„ï¼Œserveråœ¨å•Ÿå‹•çš„æ™‚å€™ Handler æœƒè¢«åˆå§‹åŒ–ä¸¦ç¶å®šåœ¨æŒ‡å®šç«¯å£ä¸­ã€‚æˆ‘å€‘ä»¥TCPHandlerç‚ºä¾‹ï¼Œçœ‹çœ‹æœå‹™ç«¯æ˜¯å¦‚ä½•è™•ç†å®¢æˆ¶ç«¯ç™¼ä¾†çš„è«‹æ±‚çš„ï¼Œé‡é»é—œæ³¨ <strong toutiao-origin=span>TCPHandler::runImpl</strong>çš„å‡½æ•¸å¯¦ç¾:</p><p>â€¢ åˆå§‹åŒ–è¼¸å…¥å’Œè¼¸å‡ºæµçš„ç·©è¡å€</p><p>â€¢ æ¥å—è«‹æ±‚å ±æ–‡ï¼Œæ‹†åŒ…</p><p>â€¢ åŸ·è¡ŒQuery(åŒ…æ‹¬æ•´å€‹è©æ³•èªæ³•åˆ†æï¼ŒQueryé‡å¯«ï¼Œç‰©ç†è¨ˆåŠƒç”Ÿæˆå’Œç”Ÿæˆçµæœ)</p><p>â€¢ æŠŠQueryçµæœä¿å­˜åˆ°è¼¸å‡ºæµï¼Œç„¶å¾Œç™¼é€åˆ°Socketçš„ç·©è¡å€ï¼Œç­‰å¾…ç™¼é€å›å®¢æˆ¶ç«¯</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>void TCPHandler::runImpl<br>{<br>//å¯¦ä¾‹åŒ–å¥—æ¥å­—å°æ‡‰çš„è¼¸å…¥å’Œè¼¸å‡ºæµç·©è¡å€<br>in = std::make_shared&lt;ReadBufferFromPocoSocket&gt;(socket);<br>out = std::make_shared&lt;WriteBufferFromPocoSocket&gt;(socket);<br><br>while (1){<br>// æ¥æ”¶è«‹æ±‚å ±æ–‡<br>receivePacket;<br><br>// åŸ·è¡ŒQuery<br>state.io = executeQuery(state.query, *query_context, false, state.stage, may_have_embedded_data);<br><br>//æ ¹æ“šQueryç¨®é¡ä¾†è™•ç†ä¸åŒçš„Query<br>//è™•ç†insert Query<br>processInsertQuery;<br>//ä½µç™¼è™•ç†æ™®é€šQuery<br>processOrdinaryQueryWithProcessors;<br>//å–®ç·šç¨‹è™•ç†æ™®é€šQuery<br>processOrdinaryQuery;<br>}<br><br>}</code></p></pre><p>é‚£CKè™•ç†å®¢æˆ¶ç«¯ç™¼é€éä¾†çš„Queryçš„å…·é«”é‚è¼¯æ˜¯æ€æ¨£çš„å‘¢?</p><p>æˆ‘å€‘å¯ä»¥åœ¨</p><blockquote toutiao-origin=span>dbms/src/Interpreters/executeQuery.cpp</blockquote><p>ä¸­ä¸€æ¢ç©¶ç«Ÿ:</p><p>å…·é«”é‚è¼¯åœ¨ executeQueryImpl å‡½æ•¸ä¸­,æŒ‘é¸æ ¸å¿ƒçš„é‚è¼¯é€²è¡Œè¬›è§£:</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>static std::tuple&lt;ASTPtr, BlockIO&gt; executeQueryImpl<br>{<br>//æ§‹é€ Parser<br>ParserQuery parser(end, settings.enable_debug_queries);<br>ASTPtr ast;<br><br>//æŠŠQueryè½‰åŒ–ç‚ºæŠ½è±¡èªæ³•æ¨¹<br>ast = parseQuery(parser, begin, end, "", max_query_size);<br><br>//ç”Ÿæˆinterpreterå¯¦ä¾‹<br>auto interpreter = InterpreterFactory::get(ast, context, stage);<br><br>// interpreterè§£æAST,çµæœæ˜¯BlockIO<br>res = interpreter-&gt;execute;<br><br>//è¿”å›çµæœæ˜¯æŠ½è±¡èªæ³•æ¨¹å’Œè§£æå¾Œçš„çµæœçµ„æˆçš„äºŒå…ƒçµ„<br>return std::make_tuple(ast, res);<br>}</code></p></pre><p>è©²å‡½æ•¸æ‰€åšçš„äº‹æƒ…ï¼š</p><p>â€¢ æ§‹å»ºParser,æŠŠQueryè§£ææˆAST(æŠ½è±¡èªæ³•æ¨¹)</p><p>â€¢ InterpreterFactoryæ ¹æ“šASTç”Ÿæˆå°æ‡‰çš„Interpreterå¯¦ä¾‹</p><p>â€¢ ASTæ˜¯ç”±Interpreterä¾†è§£æçš„ï¼ŒåŸ·è¡Œçµæœæ˜¯ä¸€å€‹BlockIO,BlockIOæ˜¯å° BlockInputStream å’Œ BlockOutputStream çš„ä¸€å€‹å°è£ã€‚</p><p>ç¸½çµ:</p><p>â€¢ æœå‹™ç«¯èª¿ç”¨ executeQuery ä¾†è™•ç†clientç™¼é€çš„Queryï¼ŒåŸ·è¡Œå¾Œçš„çµæœä¿å­˜åœ¨stateé€™å€‹çµæ§‹é«”çš„ioæˆå“¡ä¸­ã€‚</p><p>æ¯ä¸€æ¢Queryéƒ½æœƒå°æ‡‰ä¸€å€‹stateçµæ§‹é«”ï¼Œè¨˜éŒ„äº†é€™æ¢Queryçš„idï¼Œè™•ç†ç‹€æ…‹ï¼Œå£“ç¸®ç®—æ³•ï¼ŒQueryçš„æ–‡æœ¬å’ŒQueryæ‰€è™•ç†æ•¸æ“šå°æ‡‰çš„IOæµç­‰å…ƒä¿¡æ¯ã€‚</p><p>â€¢ ç„¶å¾Œæœå‹™ç«¯èª¿ç”¨ <strong toutiao-origin=span>processOrdinaryQuery </strong>ç­‰æ–¹æ³•æŠŠè¼¸å‡ºæµçµæœå°è£æˆç•°æ­¥çš„IOæµï¼Œç™¼é€åˆ°å›clientã€‚</p><img alt="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/S4RDmCtDHj5504><p></p><h2 toutiao-origin=h3><strong class=highlight-text toutiao-origin=span>02 è§£æè«‹æ±‚(Parser)</strong></h2><p>CKé¸æ“‡æ¡ç”¨æ‰‹å¯«ä¸€å€‹éæ­¸ä¸‹é™çš„Parserä¾†å°SQLé€²è¡Œè§£æï¼Œç”Ÿæˆçš„çµæœæ˜¯é€™å€‹SQLå°æ‡‰çš„æŠ½è±¡èªæ³•æ¨¹(AST),æŠ½è±¡èªæ³•æ¨¹ç”±è¡¨ç¤ºå„å€‹æ“ä½œçš„ç¯€é»(IAST)è¡¨ç¤ºã€‚è€Œæœ¬ç¯€ä¸»è¦ä»‹ç´¹ParserèƒŒå¾Œçš„æ ¸å¿ƒé‚è¼¯:</p><p>è©æ³•åˆ†æå’Œèªæ³•åˆ†æçš„æ ¸å¿ƒé‚è¼¯å¯ä»¥åœ¨parseQuery.cppçš„ tryParseQuery ä¸­ä¸€è¦½ç„¡é¤˜ã€‚</p><p>è©²å‡½æ•¸åˆ©ç”¨lexerå°‡æƒæQueryå­—ç¬¦æµï¼Œå°‡å…¶åˆ†å‰²ç‚ºä¸€å€‹å€‹çš„Tokenï¼Œ token_iterator å³ä¸€å€‹Tokenæµè¿­ä»£å™¨ï¼Œç„¶å¾Œparserå†å°Tokenæµé€²è¡Œè§£æç”ŸæˆASTæŠ½è±¡èªæ³•æ¨¹ã€‚</p><pre><p><code>ASTPtr tryParseQuery<br>{<br>//Tokenç‚ºlexerè©æ³•åˆ†æå¾Œçš„åŸºæœ¬å–®ä½,è©æ³•åˆ†æå¾Œç”Ÿæˆçš„æ˜¯Tokenæµ<br>Tokens tokens(pos, end, max_query_size);<br>IParser::Pos token_iterator(tokens);<br>ASTPtr res;<br>//Tokenæµç¶“éèªæ³•åˆ†æç”ŸæˆASTæŠ½è±¡èªæ³•æ¨¹<br>bool parse_res = parser.parse(token_iterator, res, expected);<br>return res;<br><br>}</code></p></pre><p>æˆ‘å€‘å¯ä»¥çœ‹åˆ°,èªæ³•åˆ†æçš„æ ¸å¿ƒå°±åœ¨æ–¼parseråŸ·è¡Œçš„parseæ–¹æ³•ã€‚parse æ–¹æ³•å…·é«”çš„å¯¦ç¾åœ¨ ParserQuery.cpp çš„ parseImpl ä¸­ã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>bool ParserQuery::parseImpl(Pos &amp; pos, ASTPtr &amp; node, Expected &amp; expected)<br>{<br>ParserQueryWithOutput query_with_output_p(enable_explain);<br>ParserInsertQuery insert_p(end);<br>ParserUseQuery use_p;<br>ParserSetQuery set_p;<br>ParserSystemQuery system_p;<br><br>bool res = query_with_output_p.parse(pos, node, expected)<br>|| insert_p.parse(pos, node, expected)<br>|| use_p.parse(pos, node, expected)<br>|| set_p.parse(pos, node, expected)<br>|| system_p.parse(pos, node, expected);<br><br>return res;<br>}</code></p></pre><p>æˆ‘å€‘å¯ä»¥çœ‹åˆ°,é€™å€‹æ–¹æ³•ç²—ç•¥åœ°æŠŠQueryåˆ†ç‚ºäº†äº”ç¨®,ä½†æ˜¯æœ¬è³ªä¸Šå¯ä»¥æ­¸ç´ç‚ºå…©ç¨®(ç¬¬ä¸€ç¨®ç‚ºæœ‰çµæœè¼¸å‡º,å°æ‡‰show,select,createç­‰èªå¥;ç¬¬äºŒç¨®ç‚ºç„¡çµæœè¼¸å‡º,å°æ‡‰insert,use,setå’Œèˆ‡ç³»çµ±ç›¸é—œçš„èªå¥(å¦‚exit))</p><p>â€¢ QueryWithOutput</p><p>â€¢ InsertQuery</p><p>â€¢ UseQuery</p><p>â€¢ SetQuery</p><p>â€¢ SystemQuery</p><p>æ¯ä¸€ç¨®Queryéƒ½è‡ªå®šç¾©äº†å…¶å°ˆå±¬çš„Parser,æ‰€ä»¥ä»£ç¢¼é‚è¼¯æ˜¯ç•¶æ¥æ”¶åˆ°ä¸€å€‹Queryè¼¸å…¥çš„æ™‚å€™ï¼Œæœƒå˜—è©¦å„ç¨®Queryçš„Parserï¼Œç›´åˆ°æˆåŠŸç‚ºæ­¢ã€‚</p><p>æˆ‘å€‘å¯ä»¥selectèªå¥å°æ‡‰çš„parseré€²è¡Œåˆ†æ:</p><p>æ ¸å¿ƒé‚è¼¯å¯ä»¥ç¸½çµç‚ºï¼š</p><p>1.å…ˆçµ¦å‡ºselectèªå¥ä¸­å¯èƒ½å‡ºç¾çš„é—œéµè©</p><p>2.åœ¨è©æ³•åˆ†æç”Ÿæˆçš„Tokenæµä¸­çˆ¬å–é€™äº›é—œéµè©</p><p>3.å¦‚æœæˆåŠŸçˆ¬å–ï¼Œå‰‡ setExpression å‡½æ•¸æœƒçµ„è£è©²é—œéµå­—å°æ‡‰çš„ASTç¯€é»</p><p>æ¯ä¸€ç¨®SQLèªå¥(å¦‚select,drop,insert,create)éƒ½æœ‰å°æ‡‰çš„ASTé¡ï¼Œä¸¦ä¸”åˆ†åˆ¥åŒ…å«äº†é€™äº›èªå¥ä¸­ç‰¹æœ‰çš„é—œéµå­—ã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>bool ParserSelectQuery::parseImpl(Pos &amp; pos, ASTPtr &amp; node, Expected &amp; expected)<br>{<br>//å‰µå»ºASTæ¨¹ç¯€é»<br>auto select_query = std::make_shared&lt;ASTSelectQuery&gt;;<br>node = select_query;<br><br>//selectèªå¥ä¸­æœƒå‡ºç¾çš„é—œéµè©<br>ParserKeyword s_select("SELECT");<br>ParserKeyword s_distinct("DISTINCT");<br>ParserKeyword s_from("FROM");<br>ParserKeyword s_prewhere("PREWHERE");<br>ParserKeyword s_where("WHERE");<br>ParserKeyword s_group_by("GROUP BY");<br>ParserKeyword s_with("WITH");<br>ParserKeyword s_totals("TOTALS");<br>ParserKeyword s_having("HAVING");<br>ParserKeyword s_order_by("ORDER BY");<br>ParserKeyword s_limit("LIMIT");<br>ParserKeyword s_settings("SETTINGS");<br>ParserKeyword s_by("BY");<br>ParserKeyword s_rollup("ROLLUP");<br>ParserKeyword s_cube("CUBE");<br>ParserKeyword s_top("TOP");<br>ParserKeyword s_with_ties("WITH TIES");<br>ParserKeyword s_offset("OFFSET");<br><br>//...<br>//ä¾æ¬¡å°Tokenæµçˆ¬å–ä¸Šè¿°é—œéµå­—<br>ParserTablesInSelectQuery.parse(pos, tables, expected)<br><br>//æ ¹æ“šèªæ³•åˆ†æçµæœè¨­ç½®ASTçš„Expressionå±¬æ€§,å¯ä»¥ç†è§£ç‚ºå¦‚æœSQLå­˜åœ¨è©²é—œéµå­—,é€™å€‹é—œéµå­—éƒ½æœƒè½‰åŒ–ç‚ºASTä¸Šçš„ä¸€å€‹ç¯€é»<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::WITH, std::move(with_expression_list));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::SELECT, std::move(select_expression_list));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::TABLES, std::move(tables));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::PREWHERE, std::move(prewhere_expression));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::WHERE, std::move(where_expression));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::GROUP_BY, std::move(group_expression_list));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::HAVING, std::move(having_expression));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::ORDER_BY, std::move(order_expression_list));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::LIMIT_BY_OFFSET, std::move(limit_by_offset));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::LIMIT_BY_LENGTH, std::move(limit_by_length));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::LIMIT_BY, std::move(limit_by_expression_list));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::LIMIT_OFFSET, std::move(limit_offset));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::LIMIT_LENGTH, std::move(limit_length));<br>select_query-&gt;setExpression(ASTSelectQuery::Expression::SETTINGS, std::move(settings));<br><br>}</code></p></pre><p>æ•´å€‹Parserçš„æµç¨‹åœ–ï¼š</p><img alt="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/S4RDmDP1wXvGlS><p></p><h2 toutiao-origin=h3><strong class=highlight-text toutiao-origin=strong>03 åŸ·è¡Œè«‹æ±‚(Interpreter)</strong></h2><p>è§£é‡‹å™¨(Interpreter)è² è²¬å¾æŠ½è±¡èªæ³•æ¨¹ä¸­å‰µå»ºæŸ¥è©¢åŸ·è¡Œçš„æµæ°´ç·šï¼Œæ•´æ¢æµæ°´ç·šä»¥ BlockInputStream å’Œ BlockOutputStream é€²è¡Œçµ„ç¹”ã€‚æ¯”æ–¹èªª"select"æ˜¯åŸºæ–¼"from"çš„Blockè¼¸å‡ºæµä¾†é€²è¡Œé¸æ“‡çš„ï¼Œé¸æ“‡å¾Œçš„çµæœä¹Ÿæœƒä»¥Blockè¼¸å‡ºæµçš„å½¢å¼è¼¸å‡ºåˆ°çµæœã€‚é¦–å…ˆæˆ‘å€‘ä¾†çœ‹:</p><blockquote toutiao-origin=span>dbms/src/Interpreters/InterpreterFactory.cpp</blockquote><p>æ¯ä¸€ç¨®Queryéƒ½æœƒæœ‰å°æ‡‰çš„Interpreterï¼Œé€™å€‹å·¥å» æ–¹æ³•å°±æ˜¯æ ¹æ“šASTçš„ç¨®é¡ä¾†å¯¦ä¾‹åŒ–å…¶å°æ‡‰çš„Interpreter,ç”±å…¶ä¾†å…·é«”åŸ·è¡Œå°æ‡‰ASTçš„åŸ·è¡Œè¨ˆåŠƒ:</p><pre><p><code>std::unique_ptr&lt;IInterpreter&gt; InterpreterFactory::get(ASTPtr &amp; query, Context &amp; context, QueryProcessingStage::Enum stage)<br>{<br>//èˆ‰å€‹ä¾‹å­,å¦‚æœè©²ASTæ˜¯ç”±selectèªå¥è½‰åŒ–éä¾†,<br>if (query-&gt;as&lt;ASTSelectQuery&gt;)<br>{<br>/// This is internal part of ASTSelectWithUnionQuery.<br>/// Even if there is SELECT without union, it is represented by ASTSelectWithUnionQuery with single ASTSelectQuery as a child.<br>return std::make_unique&lt;InterpreterSelectQuery&gt;(query, context, SelectQueryOptions(stage));<br>}<br>}</code></p></pre><p>æˆ‘å€‘å°±ä»¥ <strong toutiao-origin=span>InterpreterSelectQuery</strong>ç‚ºä¾‹ï¼Œç­è§£å…¶å¯¦ä¾‹åŒ–çš„æ ¸å¿ƒé‚è¼¯:</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>InterpreterSelectQuery::InterpreterSelectQuery<br>{<br>//ç²å–AST<br>auto &amp; query = getSelectQuery;<br><br>//å°ASTåšé€²ä¸€æ­¥èªæ³•åˆ†æï¼Œå°èªæ³•æ¨¹åšå„ªåŒ–é‡å¯«<br>syntax_analyzer_result = SyntaxAnalyzer(context, options).analyze(<br>query_ptr, source_header.getNamesAndTypesList, required_result_column_names, storage, NamesAndTypesList);<br><br>//æ¯ä¸€ç¨®Queryéƒ½æœƒå°æ‡‰ä¸€å€‹ç‰¹æœ‰çš„è¡¨é”å¼åˆ†æå™¨,ç”¨æ–¼çˆ¬å–ASTç”ŸæˆåŸ·è¡Œè¨ˆåŠƒ(æ“ä½œéˆ)<br>query_analyzer = std::make_unique&lt;SelectQueryExpressionAnalyzer&gt;(<br>query_ptr, syntax_analyzer_result, context,<br>NameSet(required_result_column_names.begin, required_result_column_names.end),<br>options.subquery_depth, !options.only_analyze);<br>}</code></p></pre><p>èªæ³•åˆ†æç›´æ¥ç”Ÿæˆçš„ASTè½‰åŒ–æˆåŸ·è¡Œè¨ˆåŠƒå¯èƒ½æ€§èƒ½ä¸Šä¸¦ä¸æ˜¯æœ€å„ªçš„ï¼Œå› æ­¤éœ€è¦SyntaxAnalyzer å°å…¶é€²è¡Œå„ªåŒ–é‡å¯«ï¼Œåœ¨å…¶æºç¢¼ä¸­å¯ä»¥çœ‹åˆ°å…¶æ¶‰åŠåˆ°éå¸¸å¤š <strong>åŸºè¦å‰‡</strong><strong>å„ªåŒ–(rule based optimization)</strong>çš„trickã€‚</p><p>SyntaxAnalyzer æœƒé€å€‹é‡å°é€™äº›è¦å‰‡å°æŸ¥è©¢é€²è¡Œæª¢æŸ¥ï¼Œç¢ºå®šå…¶æ˜¯å¦æ»¿è¶³è½‰æ›è¦å‰‡ï¼Œä¸€æ—¦æ»¿è¶³å°±æœƒå°å…¶é€²è¡Œè½‰æ›ã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>SyntaxAnalyzerResultPtr SyntaxAnalyzer::analyze<br>{<br>// å‰”é™¤å†—é¤˜åˆ—<br>removeDuplicateColumns(result.source_columns);<br><br>// æ ¹æ“šsettingsä¸­enable_optimize_predicate_expressioné…ç½®åˆ¤æ–·æ˜¯å¦é€²è¡Œè¬‚è©ä¸‹ç§»<br>replaceJoinedTable(node);<br><br>// æ ¹æ“šsettingsä¸­distributed_product_modeé…ç½®é‡å¯«IN èˆ‡ JOIN è¡¨é”å¼<br>InJoinSubqueriesPreprocessor(context).visit(query);<br><br>// å„ªåŒ–Queryå…§éƒ¨çš„å¸ƒçˆ¾è¡¨é”å¼<br>LogicalExpressionsOptimizer.perform;<br><br>// å‰µå»ºä¸€å€‹å¾åˆ¥ååˆ°ASTç¯€é»çš„æ˜ å°„å­—å…¸<br>QueryAliasesVisitor(query_aliases_data, log.stream).visit(query);<br><br>// å…¬å…±å­è¡¨é”å¼çš„æ¶ˆé™¤<br>QueryNormalizer(normalizer_data).visit(query);<br><br>// æ¶ˆé™¤selectå¾å¥å¾Œçš„å†—é¤˜åˆ—<br>removeUnneededColumnsFromSelectClause(select_query, required_result_columns, remove_duplicates);<br><br>// åŸ·è¡Œæ¨™é‡å­æŸ¥è©¢ï¼Œä¸¦ä¸”ç”¨å¸¸é‡æ›¿ä»£æ¨™é‡å­æŸ¥è©¢çµæœ<br>executeScalarSubqueries(query, context, subquery_depth);<br><br>// å¦‚æœæ˜¯selectèªå¥é‚„æœƒåšä¸‹åˆ—å„ªåŒ–:<br><br>// è¬‚è©ä¸‹ç§»å„ªåŒ–<br>PredicateExpressionsOptimizer(select_query, settings, context).optimize;<br><br>/// GROUP BY å¾å¥çš„å„ªåŒ–<br>optimizeGroupBy(select_query, source_columns_set, context);<br><br>/// ORDER BY å¾å¥çš„å†—é¤˜é …å‰”é™¤<br>optimizeOrderBy(select_query);<br><br>/// LIMIT BY å¾å¥çš„å†—é¤˜åˆ—å‰”é™¤<br>optimizeLimitBy(select_query);<br><br>/// USINGèªå¥çš„å†—é¤˜åˆ—å‰”é™¤<br>optimizeUsing(select_query);<br><br>}</code></p></pre><p>é€™è£¡æŒ‘é¸å¹¾å€‹ç°¡å–®ä»‹ç´¹ä¸€ä¸‹:</p><p>â€¢ å…¬å…±å­è¡¨é”å¼æ¶ˆé™¤(Common Subexpression Elimination)</p><p>å¦‚æœè¡¨é”å¼ x op y å…ˆå‰è¢«è¨ˆç®—éï¼Œä¸¦ä¸”å¾å…ˆå‰çš„è¨ˆç®—åˆ°ç¾åœ¨å…¶è¨ˆç®—è¡¨é”å¼å°æ‡‰çš„å€¼æ²’æœ‰æ”¹è®Šï¼Œé‚£éº¼ x op y å°±ç¨±ç‚ºå…¬å…±å­è¡¨é”å¼ã€‚å…¬å…±å­è¡¨é”å¼æ¶ˆé™¤æœƒæœç´¢æ‰€æœ‰ç›¸åŒè¨ˆç®—è¡¨é”å¼çš„å¯¦ä¾‹ï¼Œä¸¦åˆ†ææ˜¯å¦å€¼å¾—ç”¨ä¿å­˜è¨ˆç®—å€¼çš„å–®å€‹è®Šé‡ä¾†æ›¿æ›å®ƒå€‘ï¼Œä»¥æ¸›å°‘è¨ˆç®—çš„é–‹éŠ·ã€‚</p><p>â€¢ æ¨™é‡å­æŸ¥è©¢(Scala Subquery)çš„å¸¸é‡æ›¿æ›</p><p>æ¨™é‡å­æŸ¥è©¢å°±æ˜¯è¿”å›å–®ä¸€å€¼çš„å­æŸ¥è©¢ï¼Œå’Œå…¬å…±å­è¡¨é”å¼æ¶ˆé™¤ç›¸ä¼¼ï¼Œå¯ä»¥ç”¨å¸¸é‡ä¾†æ›¿æ›SQLä¸­æ‰€æœ‰çš„æ¨™é‡å­æŸ¥è©¢çµæœä»¥æ¸›å°‘è¨ˆç®—é–‹éŠ·ã€‚</p><p>â€¢ è¬‚è©ä¸‹ç§»(Predicate Pushdown)</p><p>æŠŠå¤–å±¤æŸ¥è©¢å¡Šä¸­çš„WHEREå­å¥çš„è¬‚è©ä¸‹ç§»åˆ°è¼ƒä½å±¤æŸ¥è©¢å¡Šå¦‚è¦–åœ–ï¼Œä»¥å„˜å¯èƒ½æŠŠéæ¿¾æ•¸æ“šçš„æ“ä½œç§»å‹•åˆ°é è¿‘æ•¸æ“šæºçš„ä½ç½®ã€‚æå‰é€²è¡Œæ•¸æ“šéæ¿¾èƒ½å¤ å¤§å¹…æ¸›å°‘ç¶²çµ¡å‚³è¼¸æˆ–è€…å…§å­˜è®€å–è¨ªå•çš„æ•¸æ“šé‡ï¼Œä»¥æé«˜æŸ¥è©¢æ•ˆç‡ã€‚</p><p>è€Œ query_analyzer çš„ä½œç”¨å¯ä»¥ç†è§£ç‚ºè§£æå„ªåŒ–é‡å¯«å¾Œçš„ASTï¼Œç„¶å¾Œå°æ‰€è¦é€²è¡Œçš„æ“ä½œçµ„æˆä¸€æ¢æ“ä½œéˆï¼Œå³ç‰©ç†åŸ·è¡Œè¨ˆåŠƒï¼Œå¦‚:</p><pre><p><code>ExpressionActionsChain chain;<br>analyzer.appendWhere(chain);<br>chain.addStep;<br>analyzer.appendSelect(chain);<br>analyzer.appendOrderBy(chain);<br>chain.finalize;</code></p></pre><p>ä¸Šè¿°ä»£ç¢¼æŠŠwhere,select,orderbyæ“ä½œéƒ½åŠ å…¥åˆ°æ“ä½œéˆä¸­ï¼Œæ¥ä¸‹ä¾†å°±å¯ä»¥å¾Storageå±¤è®€å–Blockï¼Œå°Blockæ•¸æ“šæ‡‰ç”¨ä¸Šè¿°æ“ä½œéˆçš„æ“ä½œã€‚è€ŒåŸ·è¡Œçš„æ ¸å¿ƒé‚è¼¯ï¼Œå°±åœ¨å°æ‡‰Interpreterçš„ executeImpl æ–¹æ³•å¯¦ç¾ä¸­,é€™è£¡ä»¥selectèªå¥çš„Interpreterä¾†äº†è§£ä¸‹è®€å–Blockæ•¸æ“šä¸¦ä¸”å°blockæ•¸æ“šé€²è¡Œç›¸æ‡‰æ“ä½œçš„æµç¨‹ã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>void InterpreterSelectQuery::executeImpl(TPipeline &amp; pipeline, const BlockInputStreamPtr &amp; prepared_input)<br>{<br>// å°æ‡‰Queryçš„AST<br>auto &amp; query = getSelectQuery;<br><br>AnalysisResult expressions;<br>// ç‰©ç†è¨ˆåŠƒï¼Œåˆ¤æ–·è¡¨é”å¼æ˜¯å¦æœ‰where,aggregate,having,order_by,litmit_byç­‰å­—æ®µ<br>expressions = analyzeExpressions(<br>getSelectQuery,<br>*query_analyzer,<br>QueryProcessingStage::FetchColumns,<br>options.to_stage,<br>context,<br>storage,<br>true,<br>filter_info);<br><br>// å¾Storageè®€å–æ•¸æ“š<br>executeFetchColumns(from_stage, pipeline, sorting_info, expressions.prewhere_info, expressions.columns_to_remove_after_prewhere);<br><br>// eg:æ ¹æ“šSQLçš„é—œéµå­—åœ¨BlockStreamæµæ°´ç·šä¸­åŸ·è¡Œç›¸æ‡‰çš„æ“ä½œ, å¦‚where,aggregate,distinctéƒ½åˆ†åˆ¥ç”±ä¸€å€‹å‡½æ•¸è² è²¬åŸ·è¡Œ<br>executeWhere(pipeline, expressions.before_where, expressions.remove_where_filter);<br><br>executeAggregation(pipeline, expressions.before_aggregation, aggregate_overflow_row, aggregate_final);<br><br>executeDistinct(pipeline, true, expressions.selected_columns);<br><br>}</code></p></pre><p>æ—¢ç„¶æˆ‘å€‘çŸ¥é“äº†åŸ·è¡Œè¨ˆåŠƒAnalysisResult(å³ç‰©ç†åŸ·è¡Œè¨ˆåŠƒ)ï¼Œæ¥ä¸‹ä¾†å°±éœ€è¦å¾storageå±¤ä¸­è®€å–æ•¸æ“šä¾†åŸ·è¡Œå°æ‡‰çš„æ“ä½œï¼Œæ ¸å¿ƒé‚è¼¯åœ¨<strong toutiao-origin=span> executeFetchColumns </strong>ä¸­: æ ¸å¿ƒæ“ä½œå°±æ˜¯å¾storageå±¤è®€å–æ‰€è¦è™•ç†åˆ—çš„Blockï¼Œä¸¦çµ„ç¹”æˆBlockStreamã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>void InterpreterSelectQuery::executeFetchColumns(<br>QueryProcessingStage::Enum processing_stage, TPipeline &amp; pipeline,<br>const SortingInfoPtr &amp; sorting_info, const PrewhereInfoPtr &amp; prewhere_info, const Names &amp; columns_to_remove_after_prewhere)<br>{<br>// å¯¦ä¾‹åŒ–Block Stream<br>auto streams = storage-&gt;read(required_columns, query_info, context, processing_stage, max_block_size, max_streams)<br>// è®€å–åˆ—å°æ‡‰çš„Block,ä¸¦ä¸”çµ„ç¹”æˆBlock Stream<br>streams = {std::make_shared&lt;BlockInputStream&gt;(storage-&gt;getSampleBlockForColumns(required_columns))};<br>streams.back = std::make_shared&lt;ExpressionBlockInputStream&gt;(streams.back, query_info.prewhere_info-&gt;remove_columns_actions);<br>}</code></p></pre><p>è®€å–å®ŒBlock Streamä¹‹å¾Œå°±æ˜¯å°å…¶åŸ·è¡Œå„ç¨®executeæ“ä½œå¦‚ executeAggregation , executeWhere æ“ä½œï¼Œè©³è¦‹</p><blockquote toutiao-origin=span>InterpreterSelectQuery::executeImpl</blockquote><p>çš„ä»£ç¢¼ã€‚</p><p>å› æ­¤Interpreterçš„è™•ç†éç¨‹å¯ä»¥ç¸½çµç‚º:</p><p>â€¢ å°ASTé€²è¡Œå„ªåŒ–é‡å¯«</p><p>â€¢ è§£æé‡å¯«å¾Œçš„ASTä¸¦ç”Ÿæˆæ“ä½œéˆ(åŸ·è¡Œè¨ˆåŠƒ)</p><p>â€¢ å¾å­˜å„²å¼•æ“ä¸­è®€å–è¦è™•ç†çš„Blockæ•¸æ“š</p><p>â€¢ å°è®€å–çš„Blockæ•¸æ“šæ‡‰ç”¨æ“ä½œéˆä¸Šçš„æ“ä½œ</p><p>é‚£æˆ‘å€‘è®€å–Block Streamä¸¦é€²è¡Œè™•ç†å¾Œï¼Œç”Ÿæˆçš„çµæœå¦‚ä½•å¯«å›åˆ°storageå±¤å‘¢? æˆ‘å€‘é€™è£¡ä»¥insertèªå¥çš„Interpreterä¾†äº†è§£ä¸‹:</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>BlockIO InterpreterInsertQuery::execute<br>{<br>// tableç‚ºå­˜å„²å¼•æ“æ¥å£<br>StoragePtr table = getTable(query);<br>BlockOutputStreamPtr out;<br><br>// å¾å­˜å„²å¼•æ“è®€å–Block Stream<br>auto query_sample_block = getSampleBlock(query, table);<br>out = std::make_shared&lt;AddingDefaultBlockOutputStream&gt;(<br>out, query_sample_block, out-&gt;getHeader, table-&gt;getColumns.getDefaults, context);<br><br>//åŸ·è¡Œçµæœå°è£æˆBlockIO<br>BlockIO res;<br>res.out = std::move(out);<br>}</code></p></pre><p>ä¸Šé¢ä»£ç¢¼ä¸­çš„StoragePtrå¯¦éš›ä¸Šå°±æ˜¯IStorageé€™å€‹å­˜å„²å¼•æ“çš„æ¥å£</p><pre><p><code>using StoragePtr = std::shared_ptr&lt;IStorage&gt;;</code></p></pre><p>ç„¡è«–æ˜¯å¯«å…¥é‚„æ˜¯è®€å–æ“ä½œéƒ½æ˜¯ä¾é åº•å±¤å­˜å„²å¼•æ“(å¦‚MergeTree)çš„writeå’Œreadæ¥å£ä¾†å¯¦ç¾çš„ï¼Œé—œæ–¼å­˜å„²å¼•æ“çš„ç´°ç¯€å¯¦ç¾é€™è£¡æš«æ™‚ä¸è´…è¿°ï¼Œé€™è£¡æˆ‘å€‘åªéœ€è¦çŸ¥é“æˆ‘å€‘å¾å­˜å„²å¼•æ“æ¥å£ä¸­ä»¥æµæ–¹å¼è®€å–Blockæ•¸æ“šï¼Œè€Œçµæœçµ„ç¹”æˆBlockIOæµè¼¸å‡ºã€‚Interpreterçš„æµç¨‹ç¸½çµå¦‚ä¸‹:</p><img alt="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/S4RDmlD5SJPGhe><p></p><h2 toutiao-origin=h3><strong class=highlight-text toutiao-origin=span>04 è¿”å›è«‹æ±‚çµæœ</strong></h2><p><strong toutiao-origin=span>TCPHandler::runImpl</strong>ä¸­ï¼ŒåŸ·è¡Œå®Œ executeQuery ä¹‹å¾Œéœ€è¦èª¿ç”¨å„ç¨®processQueryçš„æ–¹æ³•ä¾†çµ¦clientè¿”å›åŸ·è¡ŒSQLå¾Œçš„çµæœã€‚</p><p>æˆ‘å€‘ä»¥ <strong toutiao-origin=span>TCPHandler::processOrdinaryQuery</strong>ç‚ºä¾‹åšç°¡å–®åˆ†æ:</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>void TCPHandler::processOrdinaryQuery<br>{<br>//æŠŠBlockStreamå°è£æˆç•°æ­¥çš„Stream,é‚£éº¼å¾æµä¸­è®€å–æ•¸æ“šå°‡æœƒæ˜¯ç•°æ­¥æ“ä½œ<br>AsynchronousBlockInputStream async_in(state.io.in);<br><br>while(true){<br>Block block;<br>//å¾IOæµè®€å–blockæ•¸æ“š<br>block = async_in.read;<br>//ç™¼é€blockæ•¸æ“š<br>sendData(block);<br>}<br>}</code></p></pre><p>Serverè² è²¬åœ¨ sendData å‡½æ•¸ä¸­æŠŠè¼¸å‡ºçµæœå¯«å…¥åˆ°å¥—æ¥å­—è¼¸å‡ºç·©è¡å€ä¸­,clientåªè¦å¾é€™å€‹è¼¸å‡ºç·©è¡å€è®€å–å°±èƒ½å¤ å¾—åˆ°çµæœã€‚</p><p><strong class=highlight-text toutiao-origin=span>å·¦å³æ»‘å‹•é–±è¦½</strong></p><pre><p><code>void TCPHandler::sendData(const Block &amp; block)<br>{<br>//åˆå§‹åŒ–OutputStreamçš„åƒæ•¸<br>initBlockOutput(block);<br><br>// èª¿ç”¨BlockOutputStreamçš„writeå‡½æ•¸,æŠŠBlockå¯«åˆ°è¼¸å‡ºæµ<br>state.block_out-&gt;write(block);<br>state.maybe_compressed_out-&gt;next;<br>out-&gt;next;<br>}</code></p></pre><p>02</p><p></p><h1 toutiao-origin=h2>çµèª</h1><p>ç­è§£ClickHouseèƒŒå¾ŒSQLçš„æŸ¥è©¢æ•´å€‹æµç¨‹ï¼Œä¸åƒ…èƒ½è®“æ•¸æ“šåº«ä½¿ç”¨è€…æ›´æ¸…æ™°åœ°èªè­˜åˆ°å¦‚ä½•ç·¨å¯«æœ€å„ªåŒ–çš„SQLï¼Œä¹Ÿèƒ½å¤ è®“æ•¸æ“šåº«å…§æ ¸é–‹ç™¼è€…åŠ æ·±å°æ•¸æ“šåº«é«”ç³»çµæ§‹çš„ç†è§£ï¼Œæé«˜é–‹ç™¼æ•ˆç‡ã€‚</p><p>æœ¬æ–‡ä¸¦æ²’æœ‰æ¶‰åŠåˆ°å¤ªæ·±å…¥çš„æŠ€è¡“ç´°ç¯€ï¼Œè«¸å¦‚å‘é‡åŒ–åŸ·è¡Œå¼•æ“ï¼ŒSIMDï¼ŒåŸºæ–¼llvmçš„å‹•æ…‹ä»£ç¢¼ç”Ÿæˆï¼Œé¡MergeTreeå­˜å„²å¼•æ“ç­‰CKçš„æŠ€è¡“ç´°ç¯€ä¹Ÿæ²’æœ‰æåŠï¼Œåªæ˜¯å¾å®è§€è§’åº¦çµ¦è®€è€…ä»‹ç´¹äº†åŸ·è¡ŒSQLèƒŒå¾Œå…§æ ¸åˆ°åº•ç™¼ç”Ÿäº†ä»€éº¼ã€‚å¾ŒçºŒæˆ‘å€‘æœƒæ¨å‡ºæ›´å¤šå…§æ ¸æºç¢¼è§£è®€æ–‡ç« ï¼Œæ•¬è«‹é—œæ³¨ã€‚</p><p><strong toutiao-origin=span>END</strong></p><pre><div><img alt="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/RdIEj9hARSR1DD></div><br><div><ul><li><p>åŸºæ–¼ Apache Flink çš„å¯¦æ™‚ç›£æ§å‘Šè­¦ç³»çµ±</p></li><li><p>é—œæ–¼æ•¸æ“šä¸­è‡ºçš„æ·±åº¦æ€è€ƒèˆ‡ç¸½çµï¼ˆä¹¾ä¹¾è²¨ï¼‰</p></li><li><p>æ—¥èªŒæ”¶é›†Agentï¼Œé™°æš—æ½®æº¼çš„åœ°åº•ä¸–ç•Œ</p></li><li><p>2020 ç¹¼çºŒè¸è¸å¯¦å¯¦çš„åšå¥½è‡ªå·±</p></li></ul></div></pre><img alt="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/S0FUMtl41NrEMK><img alt="æ·±åº¦ | ä¸€æ¢æŸ¥è©¢SQLçš„å‰ä¸–ä»Šç”Ÿâ€”â€”ClickHouse æºç¢¼é–±è®€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/S0FUNTDJBxRdKz><pre><div><div><div><div><div><div><div><div><div><div><div><div><div><div><p>ä½ é»çš„æ¯å€‹è´Šï¼Œæˆ‘éƒ½ç•¶æˆäº†å–œæ­¡</p></div></div></div></div></div></div></div></div></div></div></div></div></div></div></pre></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>ä¸€æ¢</a></li><li><a>æŸ¥è©¢</a></li><li><a>SQL</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/756b16fb.html alt=å¥¶ç²‰å¯„å‡ºä¸€å€‹æœˆï¼Œå®¶äººé²é²æ”¶ä¸åˆ°ï¼Œç‰©æµä¿¡æ¯ä¹ŸæŸ¥è©¢ä¸åˆ°ï¼Œäº‹ç™¼é˜œé™½æŸéŸ»é”å¿«éç¶²é» class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/3fd8ec4e-64c1-446a-adfa-38088fb06c01 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/756b16fb.html title=å¥¶ç²‰å¯„å‡ºä¸€å€‹æœˆï¼Œå®¶äººé²é²æ”¶ä¸åˆ°ï¼Œç‰©æµä¿¡æ¯ä¹ŸæŸ¥è©¢ä¸åˆ°ï¼Œäº‹ç™¼é˜œé™½æŸéŸ»é”å¿«éç¶²é»>å¥¶ç²‰å¯„å‡ºä¸€å€‹æœˆï¼Œå®¶äººé²é²æ”¶ä¸åˆ°ï¼Œç‰©æµä¿¡æ¯ä¹ŸæŸ¥è©¢ä¸åˆ°ï¼Œäº‹ç™¼é˜œé™½æŸéŸ»é”å¿«éç¶²é»</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7d9c446c.html alt=åŸºæ–¼èªç¾©é—œè¯çš„ä¸­æ–‡æŸ¥è©¢ç³¾éŒ¯æ¡†æ¶ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/fa7ec24a3f3245009b0462435b47db27 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7d9c446c.html title=åŸºæ–¼èªç¾©é—œè¯çš„ä¸­æ–‡æŸ¥è©¢ç³¾éŒ¯æ¡†æ¶>åŸºæ–¼èªç¾©é—œè¯çš„ä¸­æ–‡æŸ¥è©¢ç³¾éŒ¯æ¡†æ¶</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/15476a7c.html alt=ä¸Šæµ·é»ƒé‡‘æ°´é“å‚³åˆ©å¥½ï¼Œé•·æ±Ÿå£èˆªé“ä¸€æ¢è®Šå…©æ¢ï¼Œå—æ§½ç”Ÿæ…‹èˆªé“æ²»ç†ä¸€æœŸå·¥ç¨‹å°‡å®Œå·¥ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/S05e8nSGv9DC2d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/15476a7c.html title=ä¸Šæµ·é»ƒé‡‘æ°´é“å‚³åˆ©å¥½ï¼Œé•·æ±Ÿå£èˆªé“ä¸€æ¢è®Šå…©æ¢ï¼Œå—æ§½ç”Ÿæ…‹èˆªé“æ²»ç†ä¸€æœŸå·¥ç¨‹å°‡å®Œå·¥>ä¸Šæµ·é»ƒé‡‘æ°´é“å‚³åˆ©å¥½ï¼Œé•·æ±Ÿå£èˆªé“ä¸€æ¢è®Šå…©æ¢ï¼Œå—æ§½ç”Ÿæ…‹èˆªé“æ²»ç†ä¸€æœŸå·¥ç¨‹å°‡å®Œå·¥</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/125dee29.html alt="SQL Serverä¸­çš„äº‹å‹™èˆ‡é–" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1533794121802a9afbb22f9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/125dee29.html title="SQL Serverä¸­çš„äº‹å‹™èˆ‡é–">SQL Serverä¸­çš„äº‹å‹™èˆ‡é–</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e9d6f488.html alt="SQL Serverä¸­çš„äº‹å‹™ï¼ˆé™„æœ‰å¯¦ä¾‹ï¼‰" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/21e047bd6e3c41fba0beac7ef3f1ce4e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e9d6f488.html title="SQL Serverä¸­çš„äº‹å‹™ï¼ˆé™„æœ‰å¯¦ä¾‹ï¼‰">SQL Serverä¸­çš„äº‹å‹™ï¼ˆé™„æœ‰å¯¦ä¾‹ï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bb071e7e.html alt="SQL äº‹å‹™æ©Ÿåˆ¶-transaction" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/3231427d97bf4a04b148360fea032241 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bb071e7e.html title="SQL äº‹å‹™æ©Ÿåˆ¶-transaction">SQL äº‹å‹™æ©Ÿåˆ¶-transaction</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c6e14bc6.html alt=SQLåŸºç¤çŸ¥è­˜â€”â€”äº‹å‹™ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/773e21df09dc4e3e8403a0a62994039d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c6e14bc6.html title=SQLåŸºç¤çŸ¥è­˜â€”â€”äº‹å‹™>SQLåŸºç¤çŸ¥è­˜â€”â€”äº‹å‹™</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cc5655f8.html alt=é€™æ˜¯ä¸€æ¢å¾ˆå¥½çš„ç„Šæ¥è®Šå½¢æ§åˆ¶æªæ–½ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1537168573260313799969b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cc5655f8.html title=é€™æ˜¯ä¸€æ¢å¾ˆå¥½çš„ç„Šæ¥è®Šå½¢æ§åˆ¶æªæ–½>é€™æ˜¯ä¸€æ¢å¾ˆå¥½çš„ç„Šæ¥è®Šå½¢æ§åˆ¶æªæ–½</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/67e44193.html alt=æ¬½å·åˆä¸€æ¢é«˜é€Ÿå°‡é–‹å»ºï¼Œé‚„æ˜¯å‡ºæµ·å¤§é€šé“ï¼Œå¿«çœ‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/9ef055165a7b4c7d811672236d869c77 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/67e44193.html title=æ¬½å·åˆä¸€æ¢é«˜é€Ÿå°‡é–‹å»ºï¼Œé‚„æ˜¯å‡ºæµ·å¤§é€šé“ï¼Œå¿«çœ‹>æ¬½å·åˆä¸€æ¢é«˜é€Ÿå°‡é–‹å»ºï¼Œé‚„æ˜¯å‡ºæµ·å¤§é€šé“ï¼Œå¿«çœ‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/10814bda.html alt=å»£æ±ä¸€æ¢åœ¨å»ºé«˜é€Ÿï¼Œé›™å‘6è»Šé“ç¸½é•·åº¦ç´„62å…¬é‡Œï¼Œé è¨ˆ2022å¹´åº•é€šè»Š class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1893ab71a3024143b32da97f286ca3ca style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/10814bda.html title=å»£æ±ä¸€æ¢åœ¨å»ºé«˜é€Ÿï¼Œé›™å‘6è»Šé“ç¸½é•·åº¦ç´„62å…¬é‡Œï¼Œé è¨ˆ2022å¹´åº•é€šè»Š>å»£æ±ä¸€æ¢åœ¨å»ºé«˜é€Ÿï¼Œé›™å‘6è»Šé“ç¸½é•·åº¦ç´„62å…¬é‡Œï¼Œé è¨ˆ2022å¹´åº•é€šè»Š</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4ddebd12.html alt="SQL é›£é»è§£æ±ºï¼šè¨˜éŒ„çš„å¼•ç”¨" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/3a1b904121564aa389aba6a046772870 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4ddebd12.html title="SQL é›£é»è§£æ±ºï¼šè¨˜éŒ„çš„å¼•ç”¨">SQL é›£é»è§£æ±ºï¼šè¨˜éŒ„çš„å¼•ç”¨</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e88a3a39.html alt=å£“åŠ›å–®ä½æ¦‚è¿°ï¼ˆå£“åŠ›å–®ä½å¿«é€ŸæŸ¥è©¢ï¼‰ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/458d052864cf4e30b7372dac21d825ad style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e88a3a39.html title=å£“åŠ›å–®ä½æ¦‚è¿°ï¼ˆå£“åŠ›å–®ä½å¿«é€ŸæŸ¥è©¢ï¼‰>å£“åŠ›å–®ä½æ¦‚è¿°ï¼ˆå£“åŠ›å–®ä½å¿«é€ŸæŸ¥è©¢ï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/328f1349.html alt=ä¸€æ¢å¥‘ç¨…ç·šç´¢ï¼Œç¨…å‹™æ©Ÿé—œæœƒé †è—¤æ’æŸ¥ä¼æ¥­å…«ç¨®ç¨… class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/328f1349.html title=ä¸€æ¢å¥‘ç¨…ç·šç´¢ï¼Œç¨…å‹™æ©Ÿé—œæœƒé †è—¤æ’æŸ¥ä¼æ¥­å…«ç¨®ç¨…>ä¸€æ¢å¥‘ç¨…ç·šç´¢ï¼Œç¨…å‹™æ©Ÿé—œæœƒé †è—¤æ’æŸ¥ä¼æ¥­å…«ç¨®ç¨…</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/00ace6e2.html alt=åŒ—äº¬è¥¿åŸè¿´æ‡‰å…¥å­¸æ´¾ä½æŸ¥è©¢ç³»çµ±ç•°å¸¸ï¼šä»£ç¢¼éŒ¯èª¤å°è‡´ï¼Œæœªç™¼ç¾äººç‚ºå› ç´ å’Œå¤–éƒ¨å…¥ä¾µ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/70aaebe5d7424441a84356f3ff357715 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/00ace6e2.html title=åŒ—äº¬è¥¿åŸè¿´æ‡‰å…¥å­¸æ´¾ä½æŸ¥è©¢ç³»çµ±ç•°å¸¸ï¼šä»£ç¢¼éŒ¯èª¤å°è‡´ï¼Œæœªç™¼ç¾äººç‚ºå› ç´ å’Œå¤–éƒ¨å…¥ä¾µ>åŒ—äº¬è¥¿åŸè¿´æ‡‰å…¥å­¸æ´¾ä½æŸ¥è©¢ç³»çµ±ç•°å¸¸ï¼šä»£ç¢¼éŒ¯èª¤å°è‡´ï¼Œæœªç™¼ç¾äººç‚ºå› ç´ å’Œå¤–éƒ¨å…¥ä¾µ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/78f96068.html alt="è¥¿åŸå€æ•™è‚²è€ƒè©¦ä¸­å¿ƒï¼šæŸ¥è©¢ç³»çµ±ç•°å¸¸ èˆ‡æ´¾ä½çµæœç„¡é—œè¯" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/78f96068.html title="è¥¿åŸå€æ•™è‚²è€ƒè©¦ä¸­å¿ƒï¼šæŸ¥è©¢ç³»çµ±ç•°å¸¸ èˆ‡æ´¾ä½çµæœç„¡é—œè¯">è¥¿åŸå€æ•™è‚²è€ƒè©¦ä¸­å¿ƒï¼šæŸ¥è©¢ç³»çµ±ç•°å¸¸ èˆ‡æ´¾ä½çµæœç„¡é—œè¯</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>