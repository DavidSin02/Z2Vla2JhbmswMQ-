<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程 | 极客快訊</title><meta property="og:title" content="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/d461ac1d9dd04929a05f9cb90e471df2"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e5f21328.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e5f21328.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e5f21328.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e5f21328.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e5f21328.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e5f21328.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/e5f21328.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/e5f21328.html><meta property="article:published_time" content="2020-11-14T20:59:17+08:00"><meta property="article:modified_time" content="2020-11-14T20:59:17+08:00"><meta name=Keywords content><meta name=description content="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/e5f21328.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>這是Jerry 2020年的第<strong>44</strong>篇文章，也是汪子熙公眾號總共第<strong>227</strong>篇原創文章。</p><p><br></p><p><strong>文章目錄</strong></p><p><br></p><ul><li><strong>Java的靜態代理</strong></li><li><strong>靜態代理的優缺點</strong></li><li><strong>ABAP的靜態代理</strong></li><li><strong>Spring AOP的動態代理</strong></li><li><strong>JDK動態代理的優缺點</strong></li><li><strong>CGLIB動態代理的優缺點</strong></li><li><strong>ABAP CGLIB的模擬實現</strong></li><li><strong>ABAP Pre和Post Exit</strong></li></ul><p><br></p><p>Jerry之前一篇文章 <strong><u>SAP產品增強技術回顧</u></strong>，提到基於Java編程語言實現的SAP Commerce，藉助Spring框架的支持，能使用面向切面編程的理念(<strong>A</strong>spect <strong>O</strong>rient <strong>P</strong>rogramming，以下簡稱<strong>AOP</strong>)，將業務代碼和非業務代碼(比如權限檢查，日誌記錄，性能統計等)徹底分離開。</p><p><br></p><p>下圖是某應用裡方法的常規實現：權限檢查，日誌記錄和性能檢測的代碼一次又一次地侵入到本應只包含業務代碼的三個方法中：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d461ac1d9dd04929a05f9cb90e471df2><p class=pgc-img-caption></p></div><p><br></p><p>下圖是應用AOP之後的方法實現：三個方法體內只包含純粹的業務代碼，看起來清爽了很多。權限檢查，日誌記錄和性能檢測的代碼，作為仍需關注的三個方面，以切面的方式編織到三個方法中。<strong>Weave</strong>，AOP裡的術語，中文材料裡經常譯成“<strong>編織</strong>”，描述了被代理類的方法，通過非源代碼修改層面被增添以新邏輯的動作。</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/caacf250d5f1407c9127b085ec2f876c><p class=pgc-img-caption></p></div><p><br></p><p>我們說面向對象編程(Object Oriented Programming，簡稱OOP)是一種理念，不同的編程語言可以有不同的實現。同理，AOP這種理念，不同的編程語言也存在不同的實現。</p><p><br></p><p>Java AOP的實現可以分為靜態代理和動態代理兩種。無論哪種代理方式，一言以蔽之，AOP的核心為，業務邏輯位於原始類中始終保持不變，而編織的非業務邏輯位於代理類中。運行時執行的代碼，實際上被調用的是代理類，原始類的業務邏輯通過代理類被間接地調用。</p><p><br></p><p>代理模式的UML圖：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a02ff2db68604504a7318342e54a4fbc><p class=pgc-img-caption></p></div><p><br></p><p>業務邏輯在<strong>編譯期間</strong>被編織進入代理類的方式，稱為靜態代理；業務邏輯在<strong>運行期間</strong>才進行編織的方式，稱為動態代理。準確地說，編譯期編織還可細分為編譯時和編譯後編織，而運行期間編織又可細分為載入時編織和運行時編織，但這種細分方式不影響本文接下來的闡述，所以Jerry後續仍只按照編譯期和運行期兩大類來介紹。</p><p><br></p><p>看一些具體的例子。</p><p><br></p><p><strong>Java靜態代理</strong></p><p><br></p><p>定義一個IDeveloper的接口，裡面包含一個writeCode的方法。創建一個Developer類，實現該方法。</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6894f434a2814f8bb630ff6649931cf0><p class=pgc-img-caption></p></div><p><br></p><p>測試：創建一個名為Jerry的Developer實例，調用writeCode方法。</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/418d050e5fbd4e2691f7c79679be4d69><p class=pgc-img-caption></p></div><p><br></p><p>假設我想讓Developer在寫代碼之前，先編寫對應的文檔，但我不想把寫文檔這個邏輯，侵入到writeCode方法裡。這裡“編寫文檔”，就相當於待編織的<strong>非業務邏輯</strong>，或者叫做<strong>待編織的切面邏輯</strong>。</p><p><br></p><p>使用靜態代理的思路，另外新建一個代理類DeveloperProxy：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/06e54ee36ec94d90b783f0e4dc02ddbc><p class=pgc-img-caption></p></div><p><br></p><p>注意上圖的writeCode方法，首先第8行完成文檔編寫的任務，然後代理類在第9行調用被代理類Developer的writeCode方法，完成寫代碼的實際業務邏輯。</p><p><br></p><p>測試代碼：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/a1749267b6bb4eb7a2795933ce30a6c0><p class=pgc-img-caption></p></div><p><br></p><p>Developer和DeveloperProxy都實現了同一個接口IDeveloper，對於消費者代碼來說，它完全感知不到也不必要去感知這兩個接口實現類的內部差異——這一切對消費者代碼來說完全透明。消費者拿到的引入，指向的是類型為IDeveloper接口的變量，然後調用定義在接口上的writeCode方法即可。</p><p><br></p><p><strong>靜態代理的優缺點</strong></p><p><br></p><p>從以上例子可以看出，靜態代理工作的基石是<strong>接口</strong>，如果原始類由於某種原因，無法改造成為某個接口的實現類(比如原始類來自系統遺留代碼，無法重構)，則靜態代理這條路行不通。</p><p><br></p><p>針對每個原始類，採用靜態代理，都需要創建一個具有<strong>持久存儲</strong>的代理類。這種方式便於理解，並且非業務邏輯(前例中的“寫文檔”行為)在編譯期間植入靜態代理類，實際運行時性能優於即將介紹的動態代理。</p><p><br></p><p>在Java裡如果不想手動創建靜態代理類，可以使用工具AspectJ來自動完成。由於本文的讀者主要是ABAP開發人員，這裡略過其使用方式。</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/984bf08672b64202800938c648fc7f8e><p class=pgc-img-caption></p></div><p><br></p><p><strong>ABAP靜態代理類的自動創建</strong></p><p><br></p><p>我仿照Java AspectJ的思路，用ABAP寫了一個類似的原型。下面是使用方法。</p><p><br></p><p>首先我創建一個類CL_HELLOWORLD:</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/3420beb9441c430a98280ce16fbb592e><p class=pgc-img-caption></p></div><p><br></p><p>我想自動為該類創建一個靜態代理，在代理類的PRINT方法裡，除了調用這個原始類的PRINT方法外，再做一些額外的邏輯，比如打印一些輸出。</p><p><br></p><p>調用下圖的GET_PROXY方法，將自動為CL_HELLOWORLD創建一個靜態代理類，將第7行和第8行指定的額外邏輯編織到靜態代理類的PRINT方法裡：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/682cf2ccf2dc421e8e4c7a3795f71c61><p class=pgc-img-caption></p></div><p><br></p><p>測試：調用靜態代理類的PRINT方法，得到下圖的輸出，能觀察到編織到靜態代理類的兩行WRITE語句，分別在原始類PRINT方法之前和之後被調用了：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3e669089d5ed479d866f4cd3aabe4204><p class=pgc-img-caption></p></div><p><br></p><p>SE24可以觀察到，通過我寫的工具自動創建的ABAP靜態類，及編織到代理類方法PRINT裡的額外邏輯：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/f030b5da9263470ba5f05f73c3f15804><p class=pgc-img-caption></p></div><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/13b75045f87c405fb3c3876f342f9654><p class=pgc-img-caption></p></div><p><br></p><p>這個工具的核心是調用ABAP Class API生成新的ABAP類，源代碼可以在文末Jerry提供的鏈接裡獲得：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b783884309be401b8311f419a09503fe><p class=pgc-img-caption></p></div><p><br></p><p><strong>Spring AOP的動態代理</strong></p><p><br></p><p>所謂動態代理，即AOP框架在編譯期不會對原始類做任何處理，而是直到應用運行期間，在內存中臨時為需要被代理的類生成一個AOP對象，該對象包含了原始類的全部方法，並且在被代理的方法處做了增強處理，編織入新的邏輯，並回調原始類的方法。</p><p><br></p><p>Spring AOP動態代理有兩種實現方式：JDK動態代理和CGLIB動態代理。</p><p><br></p><p><strong>JDK動態代理</strong></p><p><br></p><p>JDK動態代理的原理是基於Java反射機制實現的方法攔截器機制。</p><p><br></p><p>我們在第一個例子的基礎上，增添一個新的ITester接口，代表測試人員這個崗位：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b97ac36a55ee4f258a53a67fa3e985d4><p class=pgc-img-caption></p></div><p><br></p><p>現在的需求是給測試人員的doTesting方法內也植入編寫文檔的邏輯。如果採用靜態代理的方式，我們得又創建一個TesterProxy的靜態代理類。隨著開發小組裡人員崗位類型的增加，這些靜態代理類的個數也隨之增加。</p><p><br></p><p>那麼用動態代理如何優雅地避免這個問題呢？</p><p><br></p><p>創建一個新的代理類，取名為EnginnerProxy，名字暗示了這個實現了JDK標準接口InnovationHandler的類，在運行時能<strong>統一</strong>代理一個軟件開發團隊裡所有角色的工程師類的方法。</p><p><br></p><p>第七行的bind方法，接收一個被代理類的實例，在運行時動態為該實例創建一個臨時的代理類實例。所謂臨時，指該代理實例的生命週期只存在於當前會話中，應用運行結束後即銷燬，不會像靜態代理類那樣會持久化存儲。</p><p><br></p><p>運行時代理類的方法一旦執行，無論是Developer的writeCode, 還是Tester的doTesting方法，均會被EnginnerProxy的invoke方法攔截，在invoke方法內統一執行第17行的文檔撰寫邏輯，然後再調用18行包含了業務邏輯的原始類方法。</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/32adf592f811440ca8163cd18479720f><p class=pgc-img-caption></p></div><p><br></p><p>下圖是測試代碼及運行結果，現在無論是Developer還是Tester，在寫代碼和做測試之前，都會自動執行文檔撰寫的任務了：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/17ffd2a2bcec457c8b3b31f48d1e1444><p class=pgc-img-caption></p></div><p><br></p><p><strong>基於JDK動態代理的優缺點</strong></p><p><br></p><p>顯而易見，在需要代理多個類時，動態代理只需創建一個統一的代理類，而不必像靜態代理那樣，需要為每個包含業務邏輯的類單獨創建代理類。而代理類“用後即焚”，也避免了在工程文件夾裡生成太多代理類。</p><p><br></p><p>另一方面，因為動態代理在運行時通過Java反射機制實現，運行時的性能劣於在編譯期間進行代理邏輯編織的靜態代理。此外，JDK動態代理工作的前提條件同靜態代理一樣，也需要被代理的類實現某個接口。</p><p><br></p><p>看個反例，假設產品經理類ProductOwner未實現任何接口：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/5ded958a50fc43cbba0de8d8a0355535><p class=pgc-img-caption></p></div><p><br></p><p>使用JDK動態代理，在運行時會拋<strong>ClassCastException</strong>異常：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/d0bb972555a74f9695a15e9dbe08428d><p class=pgc-img-caption></p></div><p><br></p><p>正因為JDK動態代理的這種侷限性，存在另一種動態代理的實現方式：基於CGLIB的動態代理。</p><p><br></p><p><strong>CGLIB(Code Generation Library)</strong>是一個Java字節碼生成庫，可以在運行時對Java類的字節碼進行處理和增強，底層基於字節碼處理框架<strong>ASM</strong>實現。</p><p><br></p><p>基於CGLIB的動態代理可以繞過JDK動態代理的限制，即使一個需要被代理的類沒有實現任何接口，也能使用CGLIB動態代理。</p><p><br></p><p>注意這次使用CGLIB創建的統一代理類，導入的開發包來自<strong>net.sf.cglib.proxy</strong>, 而非JDK動態代理解決方案中的<strong>java.lang.reflect</strong>:</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/0719c69d546e40fe9da0b6e36f2e314c><p class=pgc-img-caption></p></div><p><br></p><p>消費代碼的風格同JDK動態代理類似：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/c945c51397d141209f567242fcfb1621><p class=pgc-img-caption></p></div><p><br></p><p><strong>CGLIB動態代理的優缺點</strong></p><p><br></p><p>CGLIB克服了JDK動態代理需要被代理類必須實現某個接口才能工作的限制，然而其本身也有侷限性。CGLIB本質上是運行時用API操作Java類的字節碼的方式，直接創建一個繼承自被代理類的子類，然後將切面邏輯編織到這個子類方法中去。顯而易見，如果被代理類被定義成無法繼承，比如被Java和ABAP裡的final關鍵字修飾，則CGLIB動態代理這種方式也無法工作。</p><p><br></p><p>做一個測試，我將ProductOwner類標誌為final，即無法被繼承，這時在運行之前的測試代碼，會遇到異常和錯誤消息：<strong>Cannot subclass final class</strong></p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/6700920745f245c18f3bf40dfe06c3a0><p class=pgc-img-caption></p></div><p><br></p><p><strong>ABAP動態代理</strong></p><p><br></p><p>因為ABAP無法在語言層面精確做到像Java JDK InnovationHandler那樣能夠用一個代理類統一攔截多個被代理類方法執行的效果，因此Jerry選擇對另一種動態代理，即CGLIB代理方式，用ABAP進行模擬。</p><p><br></p><p>首先創建一個需要被代理的類，業務邏輯寫在GREET方法裡。</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5257e653aa5d406d9d877a6df8cce00f><p class=pgc-img-caption></p></div><p><br></p><p>接著使用Jerry自己實現的ABAP CGLIB工具類，通過其方法GET_PPROXY得到這個類的代理類，並調用代理類的GREET方法：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/10f709dee01b482fafa691fba1f029e9><p class=pgc-img-caption></p></div><p><br></p><p>上圖第8行和第9行是包含了兩個切面邏輯的類，我期望其方法分別在被代理類的GREET調用之前和調用之後被執行。</p><p><br></p><p>ABAP CGLIB的核心在GET_PROXY方法裡的generate_proxy方法內：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/92fce85fe11747769145f0392fdd6a60><p class=pgc-img-caption></p></div><p><br></p><p>這裡使用了ABAP動態生成類的關鍵字<strong>GENERATE SUBROUTINE POOL</strong>, 根據內表mt_source裡包含的預先拼湊好的源代碼，生成新的臨時類。這個類不會在SE24或者SE80裡存儲，僅僅存活在當前應用的會話裡。</p><p><br></p><p>第17行動態生成新的代理類之後，第21行生成一個該代理類的實例，然後在第23和26行分別植入切面邏輯。</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/49ffaebecb724b7fade732a5ca22b23a><p class=pgc-img-caption></p></div><p><br></p><p>最後調用這個代理類實例的GREET方法，打印輸出如下：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/873a0905f80e4f5998a555f55c8bda4b><p class=pgc-img-caption></p></div><p><br></p><p>其中Hello World是原始被代理類即ZCL_JAVA_CGLIB的GREET方法的輸出，而它的前後兩行為調用ABAP CGLIB生成代理類時傳入的切面邏輯。</p><p><br></p><p>到目前為止，儘管我們意識到靜態代理和動態代理都各自存在一些缺陷，但從這些缺陷出現的原因，也再次提醒我們，在編寫新的代碼時，要<strong>儘量面向接口編程，儘量避免直接面向實現編程</strong>，從而降低程序的耦合性，提高應用的可維護性，可複用性和可擴展性。</p><p><br></p><p>以上介紹的ABAP CGLIB工具只是Jerry開發的一個原型，在ABAP裡如果僅僅想將切面邏輯(比如權限檢查，日誌記錄，性能分析)徹底地同業務邏輯隔離開，可以使用ABAP Netweaver提供的對類方法增強的標準方式：Pre-Exit和Post-Exit.</p><p><br></p><p>選中要增強的類，點擊Enhance菜單：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/87ad1f8930f446b59f6b796d981cbbe3><p class=pgc-img-caption></p></div><p><br></p><p>這種增強和被代理的類是分開存儲的：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/189cf8265ccf49db862da8172f0a7344><p class=pgc-img-caption></p></div><p><br></p><p>創建新的Pre-Exit：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/54d1cc972cd54d97b7f250d019079812><p class=pgc-img-caption></p></div><p><br></p><p>點擊Pre-Exit的面板，就可以進去編寫代碼了：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/1d087d15ed044965b37485ecee28eaea><p class=pgc-img-caption></p></div><p><br></p><p>在運行時，被代理類ZCL_JAVA_CGLIB的GREET方法執行之前，Pre-Exit裡的代碼會自動觸發：</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/31d01b38b71446f28b48010031ae3c87><p class=pgc-img-caption></p></div><p><br></p><p>Jerry之前在SAP Business By Design這個產品工作的時候，在不修改產品標準代碼的前提下，用這種Exit技術實現了很多的客戶需求。典型的客戶需求是，在SAP標準UI增添擴展字段，其值通過後臺複雜的邏輯計算出來。於是我們首先把後臺API的Response結構體做增強，新建一個擴展字段；然後給後臺API取數方法創建一個Post-Exit，將擴展字段的填充邏輯實現在Exit裡。</p><p><br></p><p>採用Pre和Post-Exit，雖然使用方式上和Java Spring AOP基於註解(Annotation)的工作方式相比有所差異，但從效果上看，也能實現Spring AOP將業務邏輯和非業務邏輯嚴格分開的需求。</p><p><br></p><p>本文介紹的Java和ABAP的靜態和動態代理，以及ABAP模擬Java CGLIB的實現，在Jerry發佈的SAP社區博客上有詳細敘述：</p><p><br></p><ul><li>Implement CGLIB in ABAP<u>https://blogs.sap.com/2017/01/27/implement-cglib-in-abap/</u></li><li>Create dynamic proxy persistently in Java and ABAP<u>https://blogs.sap.com/2017/01/28/create-dynamic-proxy-persistently-in-java-and-abap/</u></li><li>Various Proxy Design Pattern implementation variants in Java, ABAP and JavaScript<u>https://blogs.sap.com/2017/04/17/various-proxy-design-pattern-implementation-variants-in-java-and-abap</u></li></ul><p><br></p><p>本文提到的Jerry開發的所有ABAP原型和工具，在這個鏈接裡有源代碼：</p><p><br></p><p><u>https://jerry.blog.csdn.net/article/details/105615294</u></p><p><br></p><p>今後如果有人聊到關於ABAP能否進行面向切面編程的話題，您或許可以提到Jerry這篇文章。感謝閱讀。</p><p><br></p><div class=pgc-img><img alt="淺談Java和SAP ABAP的靜態代理和動態代理，以及ABAP面向切面編程" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2017580306964f368020a62f4e322a1a><p class=pgc-img-caption></p></div><p><br></p><p><strong>ABAP專題</strong></p><p><br></p><ul><li>Jerry的ABAP, Java和JavaScript亂燉</li><li>ABAP開發人員未來應該學些什麼</li><li>Jerry 2017年的五一小長假：8種經典排序算法的ABAP實現</li><li>Jerry的ABAP原創技術文章合集</li><li>300行ABAP代碼實現一個最簡單的區塊鏈原型</li><li>使用Java+SAP雲平臺+SAP Cloud Connector調用ABAP On-Premise系統裡的函數</li><li>在SAP雲平臺的CloudFoundry環境下消費ABAP On-Premise OData服務</li><li>ABAP vs Java， 蛙泳 vs 自由泳</li><li>聊聊C語言和ABAP</li><li>動手使用ABAP Channel開發一些小工具，提升日常工作效率</li><li>我用ABAP做過的那些無聊的事情</li><li>不喜歡SAP GUI？那試試用Eclipse進行ABAP開發吧</li><li>使用Visual Studio Code編寫和激活ABAP代碼</li><li>你的ABAP程序給佛祖開過光麼？來試試Jerry這個小技巧</li><li>在SAP雲平臺ABAP編程環境上編寫第一段ABAP程序</li><li>SAP官方發佈的ABAP編程規範</li><li>ABAP Code Inspector那些隱藏的功能，您都知道嗎？</li><li>還在用ABAP進行SAP產品的二次開發？來了解下這種全新的二次開發理念吧</li><li>ABAP Netweaver體內的那些寄生式編程語言</li><li>從SAP社區上的一篇博客開始，聊聊SAP產品命名背後的那份情懷</li><li>雲端的ABAP Restful服務開發</li><li>如何在SAP雲平臺ABAP編程環境裡把CDS view暴露成OData服務</li><li>使用abapGit在ABAP On-Premises系統和SAP雲平臺ABAP環境之間進行代碼傳輸</li><li>30分鐘用Restful ABAP Programming模型開發一個支持增刪改查的Fiori應用</li><li>Jerry帶您瞭解Restful ABAP Programming模型系列之二：Action和Validation的實現</li><li>Jerry帶您瞭解Restful ABAP Programming模型系列之三：雲端ABAP應用調試</li><li>SAP雲平臺上的ABAP編程環境裡如何消費第三方服務</li><li>ABAP開發者上雲的時候到了 - 現在大家可以免費使用SAP雲平臺ABAP環境的試用版了</li><li>學而不思則罔 - SAP雲平臺ABAP編程環境的由來和適用場景</li><li>SAP雲平臺裡的三叉戟應用</li><li>如何基於Restful ABAP Programming模型開發並部署一個支持增刪改查的Fiori應用</li><li>SAP 2019 TechEd Key Note解讀：雲時代下SAP從業人員如何做二次開發？</li><li>有哪些ABAP關鍵字和語法，到了ABAP雲環境上就沒辦法用了？</li><li>ABAP開發環境終於支持以駝峰命名法自動格式化ABAP變量名了</li><li>利用ABAP 740的新關鍵字REDUCE完成一個實際工作任務</li><li>一段讓人瑟瑟發抖的ABAP代碼</li><li>昨日萬聖節ABAP怪獸級代碼謎團，公佈答案啦</li><li>介紹一種在ABAP內核態進行內表高效拷貝的方法</li><li>使用SAP Cloud Application Programming模型開發OData的一個實際例子</li><li>當ABAP遇見普羅米修斯</li><li>使用ABAP繪製可伸縮矢量圖</li><li>ABAP開發環境語法高亮的那些事兒</li><li>SAP錯誤消息調試之七種武器：讓所有的錯誤消息都能被定位</li><li>使用ABAP操作Excel的幾種方法</li><li>SAP GUI裡的收藏夾事務碼管理工具</li><li>SAP GUI和Windows註冊表</li><li>有了Debug權限就能幹壞事？小心了，你的一舉一動盡在系統監控中</li><li>ABAP CCDEF, CCIMP, CCMAC, CCAU, CMXXX這些東東是什麼鬼</li><li>實現ABAP條件斷點的三種方式</li><li>使用SAT跟蹤監控從瀏覽器打開的SAP應用的性能和調用棧</li><li>一個13年ABAP老兵的建議：瞭解這些基礎知識，對ABAP開發有百利而無一害</li><li>SAP ABAP Netweaver容器化, 不可能完成的任務嗎？</li><li>SAP產品增強技術回顧</li><li>SAP API開發方法大全</li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>ABAP</a></li><li><a>代理</a></li><li><a>淺談</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/8c705a95.html alt=淺談無人機傾斜攝影測量技術標準 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/433b0001f1761786a418 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8c705a95.html title=淺談無人機傾斜攝影測量技術標準>淺談無人機傾斜攝影測量技術標準</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/32b07cdf.html alt=淺談虛擬現實技術在實際中的應用是什麼？你的看法是？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/320e000488d3da066723 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/32b07cdf.html title=淺談虛擬現實技術在實際中的應用是什麼？你的看法是？>淺談虛擬現實技術在實際中的應用是什麼？你的看法是？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/218a90a9.html alt=淺談廣西沿海鐵路公司，到底寧局好還是沿海好？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153102100759992f2d934f2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/218a90a9.html title=淺談廣西沿海鐵路公司，到底寧局好還是沿海好？>淺談廣西沿海鐵路公司，到底寧局好還是沿海好？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0bbe5cba.html alt=淺談廣西高鐵里程，曾經以1700多公里奪冠，創下了輝煌史！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/dbb04b7e14834fdda0eedea1205e664a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0bbe5cba.html title=淺談廣西高鐵里程，曾經以1700多公里奪冠，創下了輝煌史！>淺談廣西高鐵里程，曾經以1700多公里奪冠，創下了輝煌史！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b96594f0.html alt=淺談通信基本概念，收藏了 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/e1bea466fcaa45bbbe91877c2c083ebe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b96594f0.html title=淺談通信基本概念，收藏了>淺談通信基本概念，收藏了</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b8e8a950.html alt=實車事故車案例——淺談事故車 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4ac90de03c0549cb85a7d0a5c997753b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b8e8a950.html title=實車事故車案例——淺談事故車>實車事故車案例——淺談事故車</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f93af1ed.html alt=持股拿不住怎麼辦？淺談交易中的“回撤賣出法” class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4a9d04a4312547a1bec87c3a946a63de style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f93af1ed.html title=持股拿不住怎麼辦？淺談交易中的“回撤賣出法”>持股拿不住怎麼辦？淺談交易中的“回撤賣出法”</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bbb27f52.html alt=淺談帶表類量具的檢定方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ce7d33502b15424b9861682b1e5575fe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bbb27f52.html title=淺談帶表類量具的檢定方法>淺談帶表類量具的檢定方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/346037ff.html alt=淺談機器學習時代的哈希算法（一） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1525788510275af3193bcdc style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/346037ff.html title=淺談機器學習時代的哈希算法（一）>淺談機器學習時代的哈希算法（一）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f833cb1e.html alt="技術 | 淺談循環流化床鍋爐大修時的防磨處理" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f833cb1e.html title="技術 | 淺談循環流化床鍋爐大修時的防磨處理">技術 | 淺談循環流化床鍋爐大修時的防磨處理</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bcdb58c0.html alt=淺談中低壓母線槽在數據中心機房的應用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1829c8703276438abba01cf0c354aad9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bcdb58c0.html title=淺談中低壓母線槽在數據中心機房的應用>淺談中低壓母線槽在數據中心機房的應用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4a2828ed.html alt=淺談液壓油缸設計 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d2f6eddf1d514763920166f86164716b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4a2828ed.html title=淺談液壓油缸設計>淺談液壓油缸設計</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7f0c9f07.html alt=淺談燃氣輪機的分佈式能源應用 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/fd5787057ba441acb640a34cf28509af style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7f0c9f07.html title=淺談燃氣輪機的分佈式能源應用>淺談燃氣輪機的分佈式能源應用</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e62042cb.html alt="差異竟如此之大 淺談網線裡的那點學問" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/e6ba4510-9169-448e-b485-e587d97e91f4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e62042cb.html title="差異竟如此之大 淺談網線裡的那點學問">差異竟如此之大 淺談網線裡的那點學問</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8ffe357d.html alt=淺談一下失效分析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/972d6fdfb275405c971857e37d1ba999 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8ffe357d.html title=淺談一下失效分析>淺談一下失效分析</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>