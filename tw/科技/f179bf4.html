<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>技術分享 | MySQL 網絡延時參數設置建議 | 极客快訊</title><meta property="og:title" content="技術分享 | MySQL 網絡延時參數設置建議 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p3.pstatp.com/large/pgc-image/80785e9fd972414ca6f4154d85ac8162"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f179bf4.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f179bf4.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f179bf4.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f179bf4.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f179bf4.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f179bf4.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f179bf4.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f179bf4.html><meta property="article:published_time" content="2020-10-29T21:07:16+08:00"><meta property="article:modified_time" content="2020-10-29T21:07:16+08:00"><meta name=Keywords content><meta name=description content="技術分享 | MySQL 網絡延時參數設置建議"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/f179bf4.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>技術分享 | MySQL 網絡延時參數設置建議</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><blockquote class=pgc-blockquote-abstract><p><span style="color:#888;--tt-darkmode-color: #888888">作者：毛思平</span></p><p><span style="color:#888;--tt-darkmode-color: #888888">工作11年，從事數據庫工作7年，主要在金融行業。主要是做oracle,mysql。現在在農行軟開中心主要做數據庫應用方面的研究。</span></p><p><span style="color:#888;--tt-darkmode-color: #888888">本文來源：原創投稿</span></p><p><span style="color:#888;--tt-darkmode-color: #888888">*愛可生開源社區出品，原創內容未經授權不得隨意使用，轉載請聯繫小編並註明來源。</span></p></blockquote><hr><p>近期投產生產 MySQL組複製集群偶爾出現節點被逐出集群的情況，懷疑是網絡抖動導致。查詢官方文檔發現，MySQL 8.0.13 版本引入集群網絡延遲容錯參數group_replication_member_expel_timeout。</p><p><br></p><h1 class=pgc-h-arrow-right><span style="color:#407600;--tt-darkmode-color: #407600">該參數的官方解釋：</span></h1><p><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/80785e9fd972414ca6f4154d85ac8162><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><span style="color:#407600;--tt-darkmode-color: #407600">翻譯：</span></h1><p>group_replication_member_expel_timeout 指定組複製組成員在產生懷疑之後，從組中排除懷疑失敗的成員之前等待的時間（以秒為單位）。在產生懷疑之前的最初 5 秒檢測時間不計入該時間。直到幷包括 MySQL 8.0.20 在內，group_replication_member_expel_timeout 默認值均為 0，這意味著沒有等待時間，並且在 5 秒鐘的檢測時間結束後，可疑成員應立即被驅逐。從 MySQL 8.0.21 開始，該值默認為 5，這意味著在 5 秒鐘的檢測時間後如果該節點還是不正常，那會在等 5 秒鐘，如果可疑成員還是不正常，超過這個時間將被驅逐。</p><p>為驗證該參數對集群影響，我們通過實驗模擬不同時長的網絡延遲，然後調整group_replication_member_expel_timeout 值觀察該參數值對集群驅逐故障節點的影響。</p><p><br></p><h1 class=pgc-h-arrow-right><span style="color:#407600;--tt-darkmode-color: #407600">測試環境如下：</span></h1><p><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/000c7bb31609479cb6ef2603b5add6b7><p class=pgc-img-caption></p></div><p><br></p><h1 class=pgc-h-arrow-right><span style="color:#407600;--tt-darkmode-color: #407600">測試方法：</span></h1><p>1、設置各節點 group_replication_member_expel_timeout 值Y。</p><p>2、在節點模擬網絡斷開並設置斷開時長X。</p><p>3、待網絡恢復後查看各節點數據庫日誌,記錄數據庫狀態變化及變化時間。</p><p>4、登陸數據庫查看集群狀態。</p><p>5、記錄測試結果。</p><p>6、分別調整Y值或X值循環1-5步，循環測試。</p><p><br></p><h1 class=pgc-h-arrow-right><span style="color:#407600;--tt-darkmode-color: #407600">測試命令：</span></h1><pre><code>-- 模擬網絡延時# tc qdisc add dev eth0 root netem delay 10s-- 查看集群狀態mysql&gt; select * from performance_schema.replication_group_member_stats;-- 查看數據庫日誌# tail -f mysqld.log</code></pre><p><span style="color:#4d4d4d;--tt-darkmode-color: #999999"><br></span></p><h1 class=pgc-h-arrow-right><span style="color:#407600;--tt-darkmode-color: #407600">測試過程：</span></h1><p>1.首先設置各節點 group_replication_member_expel_timeout 值5；</p><p><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c20e21cd0bed4dc186f2e82b366478dc><p class=pgc-img-caption></p></div><p><br></p><p>2.設置網絡延遲前檢查集群狀態</p><p><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/2eb32551fcc341bcbefbc7681048dabc><p class=pgc-img-caption></p></div><p><br></p><p>3.在 mgr2 節點通過tc模擬網絡延遲為 10 秒，並記錄開始時間；</p><p><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/c957300c65694e36b7579286b80d3956><p class=pgc-img-caption></p></div><p><br></p><p>4.通過 mgr1 節點查看集群狀態，先開始集群狀態是 UNREACHABLE（故障檢測過程懷疑無法聯繫該成員，因為組消息已超時。)，後面節點超時後被踢出集群；</p><p><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6a693bc316ec4ddbbb75eed1ac0f0872><p class=pgc-img-caption></p></div><p><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e775f21c443844589cd7397242d5ee14><p class=pgc-img-caption></p></div><p><br></p><p>5.通過觀察 mgr2 節點的錯誤日誌，在 14:08:50，也就是設置延遲 6 秒鐘後，mgr2 節點無法訪問 mgr1、mgr3 兩個節點；在 14:08:54，與 mgr3 節點雙向連接出現問題，說明在檢測期 + group_replication_member_expel_timeout 這個 10 秒的週期內，mgr2 與其他節點無法聯繫，被踢出集群；</p><p><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/1f613c6aed4d453f866fd8ea0560e6d2><p class=pgc-img-caption></p></div><p><br></p><p>6.在 mgr2 節點取消 tc 模擬網絡延遲 tc qdisc del dev eth0 root<br></p><p><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2e7371c49ccf4b27921e50bcf774067f><p class=pgc-img-caption></p></div><p><br></p><p>7.在網絡恢復後，mgr2 節點由於 auto-rejoin 機制，嘗試重新加入集群，並通過 binlog 恢復數據，數據和其他節點一致後，恢復正常；</p><p><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/000240072ada4ebe9996e719e9dab891><p class=pgc-img-caption></p></div><p><br></p><p><strong><span style="color:#ff4c00;--tt-darkmode-color: #FF4C00">注意：如果網絡延遲長時間未恢復，故障節點會出現 ERROR 狀態，這時需要通過重啟組複製，進行恢復；</span></strong></p><p><strong><span style="color:#ff4c00;--tt-darkmode-color: #FF4C00"><br></span></strong></p><h1 class=pgc-h-arrow-right><span style="color:#407600;--tt-darkmode-color: #407600">測試結果：</span></h1><p style=text-align:justify><br></p><div class=pgc-img><img alt="技術分享 | MySQL 網絡延時參數設置建議" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/59b44c28e642480bb1c10e12528e8f50><p class=pgc-img-caption></p></div><p style=text-align:justify><br></p><h1 class=pgc-h-arrow-right><span style="color:#407600;--tt-darkmode-color: #407600">參數設置建議：</span></h1><p>從目前測試結果來看，參數 group_replication_member_expel_timeout 的設置能避免數據庫集群間出現網絡延遲時，延遲節點被立即逐出集群。考慮到數據庫繁忙期間無法及時響應其他節點探測的情況或者數據庫變更關閉節點情況，該值建議初始設置為5，正常網絡延遲都在1秒以內，如果出現故障要設置這個超時退出的時間，建議先ping一下ip，確定網絡延遲情況，在進行設置。</p><p style=text-align:justify><br></p><h1 class=pgc-h-arrow-right><span style="color:#407600;--tt-darkmode-color: #407600">需要注意：</span></h1><p>1.如果退出超時時間設置過長，要確保 XCom 的消息緩存足夠大，可以容納指定時間段以及初始5秒檢測時間段內的預期消息量，否則成員將無法重新連接；可以使用group_replication_message_cache_size 系統變量來調整緩存大小限制。</p><p>2.如果網絡恢復後，故障節點會嘗試自動加入集群，從 MySQL 8.0.21 開始，默認是3次，這意味著該成員自動進行3次嘗試重新加入集群，每次間隔5分鐘；可以通過group_replication_autorejoin_tries 這個參數調整嘗試自動加入集群的次數。</p><p><br></p><h1 class=pgc-h-arrow-right><span style="color:#407600;--tt-darkmode-color: #407600">參考資料</span></h1><ul><li>https://dev.mysql.com/doc/refman/8.0/en/group-replication-responses-failure-expel.html</li><li>https://dev.mysql.com/doc/refman/8.0/en/group-replication-options.html</li><li>https://mp.weixin.qq.com/s/DPFmCGmEfubRWpoikbY-XQ</li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>技術</a></li><li><a>MySQL</a></li><li><a>網絡</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/4959ed6a.html alt="技術分享 | MySQL 的嵌套事務、自治事務與鏈式事務" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4959ed6a.html title="技術分享 | MySQL 的嵌套事務、自治事務與鏈式事務">技術分享 | MySQL 的嵌套事務、自治事務與鏈式事務</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ad3f3a1e.html alt="數據庫技術：MySQL 基礎和 SQL 入門，單表、約束和事務" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/107897c16ae7461caa62dd375b631afe style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ad3f3a1e.html title="數據庫技術：MySQL 基礎和 SQL 入門，單表、約束和事務">數據庫技術：MySQL 基礎和 SQL 入門，單表、約束和事務</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1df9534f.html alt=網絡技術中最基礎的7層模型原來是這麼回事，一分鐘瞭解下 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/f8f4d17d4d9444259fad7aa287b03f0f style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1df9534f.html title=網絡技術中最基礎的7層模型原來是這麼回事，一分鐘瞭解下>網絡技術中最基礎的7層模型原來是這麼回事，一分鐘瞭解下</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/598f7dc3.html alt=網絡技術入門，必須瞭解的七層模型，原來這麼回事，一分鐘瞭解下 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/598f7dc3.html title=網絡技術入門，必須瞭解的七層模型，原來這麼回事，一分鐘瞭解下>網絡技術入門，必須瞭解的七層模型，原來這麼回事，一分鐘瞭解下</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2485921f.html alt=零基礎也能看懂的五大網絡安全技術，學網絡真的可以很簡單 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3f38d7c7039f42e0a9f729d97c1d5b14 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2485921f.html title=零基礎也能看懂的五大網絡安全技術，學網絡真的可以很簡單>零基礎也能看懂的五大網絡安全技術，學網絡真的可以很簡單</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/51b4b9eb.html alt=矢量網絡分析儀的關鍵技術指標解讀 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/9b8a77255b824eee9dde9e036114cb2b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/51b4b9eb.html title=矢量網絡分析儀的關鍵技術指標解讀>矢量網絡分析儀的關鍵技術指標解讀</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/73e5fb1c.html alt=網絡基礎：局域網原理與技術之局域網的技術特性 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153538154658480add5be6d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/73e5fb1c.html title=網絡基礎：局域網原理與技術之局域網的技術特性>網絡基礎：局域網原理與技術之局域網的技術特性</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/6f0d2014.html alt=IT技術科普—計算機網絡的性能指標 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/66ad000078dc4cf5a557 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6f0d2014.html title=IT技術科普—計算機網絡的性能指標>IT技術科普—計算機網絡的性能指標</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dfaee6e.html alt=軟考網絡工程師之網絡技術(網絡體系結構，數據通信，傳輸技術) class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/596f451058754a229eae1dfb2b354781 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dfaee6e.html title=軟考網絡工程師之網絡技術(網絡體系結構，數據通信，傳輸技術)>軟考網絡工程師之網絡技術(網絡體系結構，數據通信，傳輸技術)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/467cace.html alt=網絡基礎：通信技術之傳輸介質 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/1534362154627a8a1e912f4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/467cace.html title=網絡基礎：通信技術之傳輸介質>網絡基礎：通信技術之傳輸介質</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/4b921db.html alt=廈門吉比特網絡技術股份有限公司第四屆監事會第六次會議決議公告 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/RUWvo405ia707N style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/4b921db.html title=廈門吉比特網絡技術股份有限公司第四屆監事會第六次會議決議公告>廈門吉比特網絡技術股份有限公司第四屆監事會第六次會議決議公告</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/c485472.html alt="廈門吉比特網絡技術股份有限公司 關於使用閒置自有資金進行現金管理的實施公告" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/c485472.html title="廈門吉比特網絡技術股份有限公司 關於使用閒置自有資金進行現金管理的實施公告">廈門吉比特網絡技術股份有限公司 關於使用閒置自有資金進行現金管理的實施公告</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/f678a71.html alt="廈門吉比特網絡技術股份有限公司 關於參與發起設立投資基金的進展公告" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/f678a71.html title="廈門吉比特網絡技術股份有限公司 關於參與發起設立投資基金的進展公告">廈門吉比特網絡技術股份有限公司 關於參與發起設立投資基金的進展公告</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/f547529.html alt="廈門吉比特網絡技術股份有限公司 關於控股子公司認購投資基金份額暨關聯交易的進展公告" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/f547529.html title="廈門吉比特網絡技術股份有限公司 關於控股子公司認購投資基金份額暨關聯交易的進展公告">廈門吉比特網絡技術股份有限公司 關於控股子公司認購投資基金份額暨關聯交易的進展公告</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/1f150c7.html alt=廈門吉比特網絡技術股份有限公司2018年半年度報告摘要 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/1f150c7.html title=廈門吉比特網絡技術股份有限公司2018年半年度報告摘要>廈門吉比特網絡技術股份有限公司2018年半年度報告摘要</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>