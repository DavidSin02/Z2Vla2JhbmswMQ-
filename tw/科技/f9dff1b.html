<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>大型分佈式電商系統核心訂單業務架構實踐 | 极客快訊</title><meta property="og:title" content="大型分佈式電商系統核心訂單業務架構實踐 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/f9dff1b.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/f9dff1b.html><meta property="article:published_time" content="2020-10-29T21:05:04+08:00"><meta property="article:modified_time" content="2020-10-29T21:05:04+08:00"><meta name=Keywords content><meta name=description content="大型分佈式電商系統核心訂單業務架構實踐"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/f9dff1b.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>大型分佈式電商系統核心訂單業務架構實踐</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>背景</p><p>某某在一家在線購物商城工作，最近來了一個新需求，需要他負責開發一個商品秒殺模塊，而且需求很緊急，老闆要求必須儘快上線。</p><p>方案</p><p>某某一開始是這麼做的，直接用數據庫鎖進行控制，獲取秒殺商品數量並加鎖，如果數量大於零則成功，否則秒殺失敗。</p><pre><code>@Override@Transactionalpublic Result startSeckilDBPCC_ONE(long seckillId, long userId) {    //獲取秒殺商品數量並加鎖    String nativeSql = &#34;SELECT number FROM seckill WHERE seckill_id=? FOR UPDATE&#34;;    Object object =  dynamicQuery.nativeQueryObject(nativeSql, new Object[]{seckillId});    Long number =  ((Number) object).longValue();    if(number&gt;0){        nativeSql = &#34;UPDATE seckill  SET number=number-1 WHERE seckill_id=?&#34;;        dynamicQuery.nativeExecuteUpdate(nativeSql, new Object[]{seckillId});        SuccessKilled killed = new SuccessKilled();        killed.setSeckillId(seckillId);        killed.setUserId(userId);        killed.setState((short)0);        killed.setCreateTime(new Timestamp(new Date().getTime()));        dynamicQuery.save(killed);        return Result.ok(SeckillStatEnum.SUCCESS);    }else{        return Result.error(SeckillStatEnum.END);    }}</code></pre><p>寫了併發線程，跑了一下，沒問題，搞定！但是，某某轉頭一想，老闆曾經說過，這次活動宣傳力度很大，有可能會有很多用戶參與活動。恰好項目中使用了 Redis 作為緩存，何不借用一下 Redis 的發佈訂閱功能，實現秒殺隊列，從而減輕後端數據庫的訪問壓力，提升服務性能！這可是個升職加薪，當上總經理，出任CTO，迎娶白富美的好機會。說幹就幹，複製、黏貼一把擼，很快某某就把消息隊列方案搞定了。</p><p>image</p><p>事故</p><p>開發、測試、上線一條龍，活動開始了，秒殺商品是 100 部蘋果手機，活動結束以後，居然產生了 106 個訂單！老闆很生氣，後果很嚴重，這個鍋必須有人得背，嚇得某某趕緊仔細複查複製粘貼的代碼。</p><p>監聽配置 RedisSubListenerConfig ：</p><pre><code>@Configurationpublic class RedisSubListenerConfig {    //初始化監聽器    @Bean    RedisMessageListenerContainer container(RedisConnectionFactory connectionFactory,            MessageListenerAdapter listenerAdapter) {        RedisMessageListenerContainer container = new RedisMessageListenerContainer();        container.setConnectionFactory(connectionFactory);        container.addMessageListener(listenerAdapter, new PatternTopic(&#34;seckill&#34;));        return container;    }    //利用反射來創建監聽到消息之後的執行方法    @Bean    MessageListenerAdapter listenerAdapter(RedisConsumer redisReceiver) {        return new MessageListenerAdapter(redisReceiver, &#34;receiveMessage&#34;);    }   //使用默認的工廠初始化redis操作模板    @Bean    StringRedisTemplate template(RedisConnectionFactory connectionFactory) {        return new StringRedisTemplate(connectionFactory);    }}</code></pre><pre><code>生產者 RedisSender：/** * 生產者 */@Servicepublic class RedisSender {    @Autowired    private StringRedisTemplate stringRedisTemplate;    public void sendChannelMess(String channel, String message) {        stringRedisTemplate.convertAndSend(channel, message);    }}消費者 RedisConsumer：/** * 消費者 */@Servicepublic class RedisConsumer {        @Autowired    private ISeckillService seckillService;    @Autowired    private RedisUtil redisUtil;        public void receiveMessage(String message) {        //收到通道的消息之後執行秒殺操作        String[] array = message.split(&#34;;&#34;);        if(redisUtil.getValue(array[0])==null){//control層已經判斷了，其實這裡不需要再判斷了            Result result = seckillService.startSeckilDBPCC_TWO(Long.parseLong(array[0]), Long.parseLong(array[1]));            if(result.equals(Result.ok(SeckillStatEnum.SUCCESS))){                WebSocketServer.sendInfo(array[0], &#34;秒殺成功&#34;);//推送給前臺            }else{                WebSocketServer.sendInfo(array[0], &#34;秒殺失敗&#34;);//推送給前臺                redisUtil.cacheValue(array[0], &#34;ok&#34;);//秒殺結束            }        }else{            WebSocketServer.sendInfo(array[0], &#34;秒殺失敗&#34;);//推送給前臺        }    }}數據層代碼：@Override@Transactionalpublic Result startSeckil(long seckillId,long userId) {        //由於使用了隊列，某某這裡沒用數據庫鎖        String nativeSql = &#34;SELECT number FROM seckill WHERE seckill_id=?&#34;;        Object object =  dynamicQuery.nativeQueryObject(nativeSql, new Object[]{seckillId});        Long number =  ((Number) object).longValue();        if(number&gt;0){            //扣庫存            nativeSql = &#34;UPDATE seckill  SET number=number-1 WHERE seckill_id=?&#34;;            dynamicQuery.nativeExecuteUpdate(nativeSql, new Object[]{seckillId});            //創建訂單            SuccessKilled killed = new SuccessKilled();            killed.setSeckillId(seckillId);            killed.setUserId(userId);            killed.setState((short)0);            Timestamp createTime = new Timestamp(new Date().getTime());            killed.setCreateTime(createTime);            dynamicQuery.save(killed);            //支付            return Result.ok(SeckillStatEnum.SUCCESS);        }else{            return Result.error(SeckillStatEnum.END);        }}</code></pre><p>某某重新審讀了代碼，一開始某某覺得既然使用了隊列，數據庫層面就沒必要用數據庫鎖了，然後去掉了 for update，很顯然問題就出在這裡。導致超賣的因素只有一個，那就是多線程併發搶佔資源，如果業務邏輯沒有做相應的措施，很有可能導致超賣。</p><p>回到代碼來看，雖然秒殺用戶進入了隊列，但是 RedisConsumer 端有可能是多線程處理隊列數據，某某為了驗證想法，在消費端加入了以下代碼來打印線程名稱。</p><p>Thread th=Thread.currentThread(); System.out.println("Tread name:"+th.getName()); 再次運行任務，果不其然，每個秒殺用戶都開啟了一個線程處理任務：</p><p>Tread name:container-1 Tread name:container-2 Tread name:container-3 Tread name:container-4 Tread name:container-5 Tread name:container-6 ...... 各位看官到這裡，線索已經很明確了，我們只需要把消費端改造成單線程處理，問題就迎刃而解了。</p><p>解決方案</p><p>使用 Redis 消息隊列，出現超賣問題是因為RedisMessageListenerContainer 的默認使用線程池是SimpleAsyncTaskExecutor，每次消費都會創建一個線程來處理，這樣就會有大量的新線程被創建。有興趣的小夥伴可以跟進源碼，瞭解更多詳細內容。</p><p>監聽配置 RedisSubListenerConfig 改造為 ：</p><pre><code>@BeanRedisMessageListenerContainer container(RedisConnectionFactory connectionFactory,            MessageListenerAdapter listenerAdapter) {        RedisMessageListenerContainer container = new RedisMessageListenerContainer();        container.setConnectionFactory(connectionFactory);        container.addMessageListener(listenerAdapter, new PatternTopic(&#34;seckill&#34;));        /**         * 如果不定義線程池，每一次消費都會創建一個線程，如果業務層面不做限制，就會導致秒殺超賣。         * 此處感謝網友 DIscord         */        ThreadFactory factory = new ThreadFactoryBuilder()                .setNameFormat(&#34;redis-listener-pool-%d&#34;).build();        Executor executor = new ThreadPoolExecutor(                1,                1,                5L,                TimeUnit.SECONDS,                new LinkedBlockingQueue&lt;&gt;(1000),                factory);        container.setTaskExecutor(executor);        return container;}然後測試改造效果：Tread name:redis-listener-pool-0Tread name:redis-listener-pool-0Tread name:redis-listener-pool-0......</code></pre><p><br></p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>電商系統</a></li><li><a>單業務架構</a></li><li><a>實踐</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/b6acbddb.html alt=「壓鑄實踐」大截面ZA27鋅合金蝸輪的雙重擠壓鑄造應用案例 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/972374c8b24644389e188cb290249f17 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b6acbddb.html title=「壓鑄實踐」大截面ZA27鋅合金蝸輪的雙重擠壓鑄造應用案例>「壓鑄實踐」大截面ZA27鋅合金蝸輪的雙重擠壓鑄造應用案例</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b096e432.html alt=餐飲業的共益實踐案例：是什麼留住了海底撈的員工？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3253c0fd3b54497282e5ebfb67cc350c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b096e432.html title=餐飲業的共益實踐案例：是什麼留住了海底撈的員工？>餐飲業的共益實踐案例：是什麼留住了海底撈的員工？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8ece3d8b.html alt=溼法鋅冶煉氟、氯現在走向及生產實踐 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/c6ec0692-63fe-42f8-8df3-b0a6226ca1a5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8ece3d8b.html title=溼法鋅冶煉氟、氯現在走向及生產實踐>溼法鋅冶煉氟、氯現在走向及生產實踐</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/130bed32.html alt=「理論實踐」地方人大常委會研究室工作的實踐與思考 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/R9AiF6fHzZIbrG style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/130bed32.html title=「理論實踐」地方人大常委會研究室工作的實踐與思考>「理論實踐」地方人大常委會研究室工作的實踐與思考</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3998ae89.html alt=服務治理最佳實踐：如何依據參數值進行服務路由、鑑權、限流？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/3f6fb254f0cc4ba390695e1d561d4a5c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3998ae89.html title=服務治理最佳實踐：如何依據參數值進行服務路由、鑑權、限流？>服務治理最佳實踐：如何依據參數值進行服務路由、鑑權、限流？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8654883c.html alt=項目實踐中的一些性能優化指南 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/8c9ad977831f4b6bbaaf2e1b4651b667 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8654883c.html title=項目實踐中的一些性能優化指南>項目實踐中的一些性能優化指南</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/231d1667.html alt=數據倉庫實踐之如何設計可執行表命名規範 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/43bcbccdb0084c158129e23d3bce3b31 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/231d1667.html title=數據倉庫實踐之如何設計可執行表命名規範>數據倉庫實踐之如何設計可執行表命名規範</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c6860eb9.html alt=疫情期間做好職工思想政治工作的探索與實踐 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/SAiPd9B1uasVed style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c6860eb9.html title=疫情期間做好職工思想政治工作的探索與實踐>疫情期間做好職工思想政治工作的探索與實踐</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/80ae7e84.html alt=數據治理分析項目最佳實踐 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/67ed2ac0609b4877ae82c58a9507432d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/80ae7e84.html title=數據治理分析項目最佳實踐>數據治理分析項目最佳實踐</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d323acd6.html alt="一文搞定 REST Assured 實踐(二)：斷言實現" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/2d017d59689b467b93d6e1a4bcb3a13c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d323acd6.html title="一文搞定 REST Assured 實踐(二)：斷言實現">一文搞定 REST Assured 實踐(二)：斷言實現</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c70cc169.html alt=數據標準管理實踐白皮書 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/f9700cf0c5d846deba0644a21ed93f80 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c70cc169.html title=數據標準管理實踐白皮書>數據標準管理實踐白皮書</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a775bff0.html alt="「文明實踐 情滿沂水」蒙陰縣婦聯黨組成員、婦兒工委服務中心主任類秀雲一行到四十里堡鎮調研督導美在農家工作" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/SEvz4Jw8VTojqM style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a775bff0.html title="「文明實踐 情滿沂水」蒙陰縣婦聯黨組成員、婦兒工委服務中心主任類秀雲一行到四十里堡鎮調研督導美在農家工作">「文明實踐 情滿沂水」蒙陰縣婦聯黨組成員、婦兒工委服務中心主任類秀雲一行到四十里堡鎮調研督導美在農家工作</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/682e2d04.html alt=技術實踐——Python圖像處理進階：多種圖像變換算法實踐！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/153594655429837077dd27a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/682e2d04.html title=技術實踐——Python圖像處理進階：多種圖像變換算法實踐！>技術實踐——Python圖像處理進階：多種圖像變換算法實踐！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/923f27c8.html alt="學習經典著作 提升實踐能力" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/923f27c8.html title="學習經典著作 提升實踐能力">學習經典著作 提升實踐能力</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7c89ca21.html alt=中山東鳳文明實踐丨垃圾分類又有新玩法！一起去這個趣味遊園會逛逛↓ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RyxoCkN7Ut954e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7c89ca21.html title=中山東鳳文明實踐丨垃圾分類又有新玩法！一起去這個趣味遊園會逛逛↓>中山東鳳文明實踐丨垃圾分類又有新玩法！一起去這個趣味遊園會逛逛↓</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>