<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB | 极客快訊</title><meta property="og:title" content="VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/77d093a6f57d49568b897968afa981c0"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/facb1b75.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/facb1b75.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/facb1b75.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/facb1b75.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/facb1b75.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/facb1b75.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/facb1b75.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/facb1b75.html><meta property="article:published_time" content="2020-10-29T21:09:08+08:00"><meta property="article:modified_time" content="2020-10-29T21:09:08+08:00"><meta name=Keywords content><meta name=description content="VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/facb1b75.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><div><p>前言</p><blockquote><p>一年一度的數據庫領域頂級會議VLDB 2019於美國當地時間8月26日-8月30日在洛杉磯召開。在本屆大會上，阿里雲數據庫產品團隊多篇論文入選Research Track和Industrial Track。</p><p>本文將對入圍Industrial Track的論文《AnalyticDB: Realtime OLAP Database System at Alibaba</p><p>Cloud》進行深度解讀。</p></blockquote><p>1、背景</p><p>隨著數據量的快速增長，越來越多的企業迎來業務數據化時代，數據成為了最重要的生產資料和業務升級依據。伴隨著業務對海量數據實時分析的需求越來越多，數據分析技術這兩年也迎來了一些新的挑戰和變革：</p><blockquote><p>1) 在線化和高可用、離線和在線的邊界越來越模糊，一切數據皆服務化、一切分析皆在線化；</p><p>2) 高併發低延時，越來越多的數據系統直接服務終端客戶，對系統的併發和處理延時提出了新的交互性挑戰；</p><p>3) 混合負載，一套實時分析系統既要支持數據加工處理，又要支持高併發低延時的交互式查詢；</p><p>4) 融合分析，隨著對數據新的使用方式探索，需要解決結構化與非結構化數據融合場景下的數據檢索和分析問題。</p></blockquote><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/77d093a6f57d49568b897968afa981c0><p class=pgc-img-caption></p></div><p>圖1 阿里巴巴分析型數據庫發展歷史</p><p>阿里巴巴最初通過單節點Oracle進行準實時分析, 後來轉到Oracle RAC。隨著業務的飛速發展, 集中式的Shared Storage架構需要快速轉向分佈式，遷移到了Greenplum，但不到一年時間便遇到擴展性和併發的嚴重瓶頸。為了迎接更大數據集、更高併發、更高可用、更實時的數據應用發展趨勢，從2011年開始，在線分析這個技術領域，阿里實時數據庫堅定的走上了自研之路。大規模、海量數據實時分析型數據庫系統——AnalyticDB，也是在這個時候誕生。</p><p>AnalyticDB是阿里巴巴自主研發、唯一經過超大規模、高併發以及核心業務驗證的PB級實時分析型數據庫。自2012年第一次在集團發佈上線以來，至今已累計迭代發佈近百個版本，支撐起集團內的電商、廣告、菜鳥、文娛、飛豬等眾多在線分析業務。AnalyticDB於2014年在阿里雲開始正式對外輸出，支撐行業既包括傳統的大中型企業和政府機構，也包括眾多的互聯網公司，覆蓋外部十幾個行業。AnalyticDB承接著阿里巴巴廣告營銷、商家數據服務、菜鳥物流、盒馬新零售等眾多核心業務的高併發分析處理，每年雙十一上述眾多實時分析業務高峰驅動著AnalyticDB不斷的架構演進和技術創新。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/d86afb931d3643268638df0467283999><p class=pgc-img-caption></p></div><p>圖2 AnalyticDB設計挑戰</p><p>2、挑戰</p><p>已有的分析型數據庫（以下簡稱OLAP）諸如Impala、Pinot、Druid等，總結了OLAP系統在設計的過程中應該解決的問題：低延遲、數據新鮮度、多樣性、低成本、高擴展性、高可靠性。和這些已有的OLAP系統相比，AnalyticDB承載著更大的規模：2000+臺物理機器、10PB+規模數據、百萬張數據表以及萬億條數據行。因此，AnalyticDB在設計與實現的時候，不僅要解決已有OLAP系統要解決的問題，還要面臨與解決三個更大的挑戰：</p><blockquote><p>1） 隨著用戶分析需求的急劇增加，用戶的查詢變得複雜且多樣化：這些查詢涵蓋點查詢、全表掃描、多表關聯等，還會包含對任意列組合的篩選條件。如何在這種複雜分析場景下依然保證大部分甚至所有查詢的低延遲，是一個非常大的挑戰；</p><p>2） 如何在保證低延遲查詢的情況下，仍然能處理每秒千萬級別的寫吞吐。傳統的設計理念在同一條鏈路上同時處理讀寫請求，這會造成讀寫性能的互相嚴重影響。</p><p>3） 複雜分析場景下，會對行存、列存、關係型存儲、複雜數據類型（JSON、vector、text）都有著強烈需求。如何設計一個對這些存儲格式都很友好的存儲層，也是一個業界難題。</p></blockquote><p>接下來我們會介紹AnalyticDB的設計與實現關鍵點，探究AnanlyticDB是如何解決這些挑戰的。</p><p>3、 AnalyticDB架構</p><p>AnalyticDB的整體架構如下圖：</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/52a975ab7b2441efa25b3a92e0235d36><p class=pgc-img-caption></p></div><p>圖3 AnalyticDB架構圖</p><p>每個模塊的具體描述如下：</p><ul><li>Coordinator（協調節點）：協調節點負責接收JDBC/ODBC連接發過來的請求，並將請求分發給讀節點或者寫節點。</li><li>Write Node（寫節點）：只處理寫請求（如INSERT、DELETE、UPDATE）的節點。</li><li>Read Node（讀節點）：只處理讀請求（如SELECT）的節點。</li><li>Pangu（盤古）：高可靠分佈式存儲系統，是AnalyticDB依賴的基礎模塊。寫節點會將寫請求的數據刷到盤古上進行持久化。</li><li>Fuxi（伏羲）：資源管理與任務調度系統，是AnalyticDB依賴的基礎模塊。伏羲合理使用集群機器的空閒資源，以進行相關計算任務的異步調度執行。</li></ul><p>3.1、表分區</p><p>為便於大規模分析處理，AnalyticDB對數據表進行分區。AnalyticDB數據表有兩個分區級別：一級分區和二級分區。圖4展示了創建帶有一級分區、二級分區表的DDL語句：一級分區有50個分區，分區鍵為id列；二級分區有12個分區，分區鍵為dob列。數據行依據其包含的一級分區鍵的hash值，對應到不同的一級分區。通常，選擇具有較高基數（cardinality）的列作為一級分區鍵，以保證數據行能均勻地分佈到每個一級分區，最大化並行。用戶還可以根據需要定義二級分區，以便進行數據的自動管理。二級分區擁有最大分區數，當二級分區的實際數目超過了這個最大分區數後，最老的二級分區會被自動刪除。通常，選擇時間列（天、周或月）作為二級分區列，這樣，包含相同時間序列的數據行，會被劃分到同一個二級分區中。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7f6b68d28a4a42edbe2d00628b8b0b2e><p class=pgc-img-caption></p></div><p>圖4 創建帶有分區的數據表的DDL</p><p>3.2、讀寫分離</p><p>傳統OLAP系統在同一個鏈路上同時處理讀寫請求，因此，所有的併發讀寫請求都共享同一個資源池，也會互相影響。但是當讀寫併發同時非常大時，這種設計會由於過度的資源競爭而導致不好的性能。如圖5所示，為了解決這個問題，同時確保讀和寫的高性能，AnalyticDB採用的架構為讀寫分離架構，即AnalyticDB有獨立的讀寫節點各自處理讀寫請求，且寫節點和讀節點完全互相隔離。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/6cfd680683904ed9922cddd568ef84f1><p class=pgc-img-caption></p></div><p>圖5 AnalyticDB讀寫分離</p><p>寫節點：某個寫節點會被選為主節點，其他寫節點選為從節點，主節點和從節點之間通過ZooKeeper來進行通信。每個節點會獨立負責某些一級分區的數據，主節點的任務就是決定每個節點負責哪些一級分區。協調節點會將寫請求分發到對應的寫節點上，寫節點收到請求後，會將寫SQL語句放到內存buffer中，這些buffer中的SQL語句稱為log數據。寫節點會將buffer中的log數據刷到盤古上，當刷盤古成功後，寫節點會返回一個版本號（即LSN）給協調節點，表示寫完成了。每個一級分區在其對應的寫節點上，都會獨立地對應一個版本號，每次寫節點將某個一級分區的log數據刷到盤古後，都會增大這個版本號，並將最新版本號返回給協調節點。</p><p>當盤古上的log數據達到一定規模時，AnalyticDB會在伏羲上啟動MapReduce任務，以將log數據轉換成真實存儲數據+索引。</p><p>讀節點：每個讀節點也獨立負責某些一級分區的數據。在每個讀節點初始化時，它會從盤古上讀取最新版本數據（包括索引）。之後，基於這份數據，讀節點會從寫節點的內存buffer中將寫請求log週期性地拉取過來，並在本地進行replay，replay之後的數據不會再存儲到盤古中。讀節點根據replay之後的數據，服務到來的讀請求。</p><p>由於讀節點需要去從寫節點上拉取寫請求數據，因此讀節點為用戶提供了兩種可見性級別：實時（real-time）可見和延時（bounded-staleness）可見。實時可見允許讀節點立即讀到寫節點寫入的數據，延時可見允許讀節點在一段時間後才讀到寫節點上寫入的數據。AnalyticDB默認使用的可見性級別為延時可見。</p><p>當可見性級別選擇為實時可見時，AnalyticDB採用了版本校驗（version verification）機制來確保讀寫節點的同步。當用戶執行完寫請求後，他/她再發送一個查詢請求到協調節點。協調節點會從對應寫節點上獲取最新的版本號（記為V1），連同查詢請求一起下發給對應的讀節點。讀節點上在進行本地replay的時候，也會存有目前已經replay的版本號（記為V2）。讀節點會比較V1和V2的大小：如果V1小於等於V2，那麼讀節點直接基於本地replay的數據執行查詢；如果V1大於V2，那麼讀節點會從對應寫節點上拉取直到V1的log數據，replay後再執行查詢。需要強調的是，當可見性級別為延時可見時，協調節點在下發查詢請求之前，不會實時地從對應寫節點上獲取最新版本號，而是使用緩存的之前寫節點返回給自己的版本號（由於存在很多協調節點，所以某個協調節點上緩存的版本可能不是最新版本）。</p><p>3.3、可靠性與擴展性</p><ul><li>可靠性。</li><li>AnalyticDB的讀節點和寫節點均具有高可靠性。對於寫節點來說，當某個從節點失效的時候，主節點會將其負責的一級分區均勻地分配給其他正常的從節點。當主節點失效的時候，新的主節點會被重新選出來進行替代。對於讀節點來說，用戶可以指定讀節點的副本個數（默認為2），不同副本會被放到不同的物理機上，以提供高可靠性。當某個讀節點失效時，協調節點會將讀請求自動下發到其他副本上。需要強調的是，某個寫節點的失效，也不會影響讀節點正常地拉取log數據和replay數據。因為log數據是持久化在盤古上的，在寫節點失效地時候，讀節點可以直接去盤古上拉取log數據。</li><li>擴展性。</li><li>AnalyticDB的讀節點和寫節點也具有高可擴展性。當一個新的寫節點加入時，主節點會自動調整一級分區的分配，保證負載均衡。讀節點的可擴展性也是由相同的機制保證的，只不過對於讀節點，調整一級分區分配的是協調節點。</li></ul><p>3.4、集群管理</p><p>AnalyticDB集群管理模式為多租戶模式，即同一個集群上可以運行多個AnalyticDB實例。我們設計並實現了一個稱為Gallardo的集群管理組件，Gallardo採用CGroup技術對不同AnalyticDB實例進行資源隔離（CPU核、內存、網絡帶寬），並負責實例的穩定性。當新的AnalyticDB實例創建的時候，Gallardo會為其分配相應的資源，在分配資源的時候，Gallardo會將協調節點、寫節點、讀節點以及讀節點的不同副本放置在不同物理機上，以保證可靠性要求。</p><p>4、 AnalyticDB存儲層設計</p><p>AnalyticDB存儲圍繞為“計算而生” 這一設計目標，主要解決海量數據的極速查詢問題。本章將詳細剖析存儲和索引原理，並闡述設計背後的思考。</p><p>4.1、存儲層架構</p><p>AnalyticDB存儲層採用Lambda架構，讀節點上的數據包括基線數據和增量數據兩部分。如圖6左邊所示，基線數據是增量寫入前的所有歷史數據，包括索引和明細數據；增量數據沒有索引，只有明細數據。明細數據來自於寫入節點的日誌數據，並按照行列混存的結構（見4.2節）保存在讀節點的SSD磁盤上。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/43c3d4cbf139445ea635cfc0ecb790b2><p class=pgc-img-caption></p></div><p>圖6 Lamda架構和數據查詢過程</p><p>4.1.1、寫入和查詢過程</p><p>AnalyticDB不僅支持實時INSERT，同時還支持UPDATE和DELETE。執行DELTE時，AnalyticDB沒有采用立即物理刪除，而是使用bitset來標記被刪除的數據行，這些被標記刪除的數據會在數據合併（4.1.2）時被真正物理刪除。執行UPDATE時，UPDATE操作會被轉換為DELETE + INSERT。COPY-ON-WRITE技術被用來支持MVCC多版本控制。當數據發生刪除或更新時，AnalyticDB會產生一個新版本的bitset，並將被刪除後更新的行的位設置1。此時正在運行的查詢可以繼續使用老版本的delete bitset，不會被寫入阻塞。</p><p>算法1、2、3分別詳細解釋了INSERT、DELETE和QUERY執行的詳細過程。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b69f6ba226574f2cabd85f249f7b2818><p class=pgc-img-caption></p></div><p>4.1.2、數據合併</p><p>由於沒有全局索引，隨著數據的不斷實時寫入，增量數據的查詢性能會越來越慢。因此我們會在後臺通過伏羲啟動一個MapReduce 任務來合併基線數據和增量數據（同時去掉標記為刪除的數據）形成一個新的基線數據，並基於新的基線數據構建全量索引。如圖7所示，當數據合併任務開始時，首先會將增量數據引擎標記為immutable，並創建一個新的活躍增量數據引擎，該活躍增量數據引擎接受實時寫入的數據。在合併任務執行過程中，所有查詢和INSERT/DELETE都會執行在基線數據、immutable增量數據和活躍增量數據這三個數據引擎上。當合並任務完成後，老的基線數據和immutable增量數據會被替換為新的基線數據，新的查詢將執行在新基線數據和活躍增量數據這兩個數據引擎上。等所有老的查詢都結束後，老基線數據和immutable增量數據會被刪除。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/e46ce696cd6e41d0ae89af68acdf1019><p class=pgc-img-caption></p></div><p>圖7 數據合併過程</p><p>4.2、存儲數據結構</p><p>4.2.1、行列混存</p><p>在海量數據分析場景下，數據分析業務主要有以下三類workload：</p><blockquote><p>1） OLAP場景下的大規模多維分析：海量數據的統計分析和多表關聯，比較適合列存格式；</p><p>2） 高併發的點查：通常需要撈取出一整行的明細數據，比較適合行存。</p><p>3） 高寫入吞吐：每秒千萬的高吞吐實時寫入，比較適合行存。</p></blockquote><p>無論是行存和列存都無法同時滿足以上需求，如何在一個系統中同時解決以上問題？如圖8所示，AnalyticDB提出使用行列混存 結構，使用一套存儲格式，兼具行存和列存之所長，同時滿足以上三類workload。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/631bd134c3354f89a228a7efedb6150c><p class=pgc-img-caption></p></div><p>圖8 行列混存數據格式</p><p>對於一張表，每k行數據組成一個Row Group。在每個Row Group中，每列數據連續的存放在單獨的block中，Row Group在磁盤上連續存放。每個block由於數據類型相同，可以支持高效的壓縮。同時為了保證點查詢的性能，我們會將所有的數據按照按指定列(聚集列)排序存放，好處是在按該列查詢時顯著減少磁盤隨機IO次數。最後，與列存寫入相比，行列混存可以把多個文件的寫入被轉化成單個文件的順序寫入，降低了IO的開銷。</p><p>4.2.2、元數據</p><p>為了加速查詢，AnalyticDB對每列構建一份元數據，並保存在一個叫detail_meta的單獨文件中。detail_meta文件通常較小（小於1MB），首次查詢時被加載在內存中。如圖8左邊所示，元數據主要包括4部分：</p><ul><li>Header。包括版本號，文件長度以及一些統計信息。</li><li>列統計信息。包括行數，NULL值數，cardinality，SUM，MAX和MIN 值。優化器根據這些信息來生成最佳執行計劃。</li><li>字典。對於cardinality較少（小於1024）的列，AnalyticDB採用字典編碼，數據文件裡保存字典號碼。字典保存在該字段中。</li><li>塊地址信息。保存塊號到數據文件起始地址和長度的映射關係。</li></ul><p>4.2.3、非結構化數據存儲</p><p>AnalyticDB不僅支持基本數據類型，也支持長文本、JSON和向量數組等非結構化數據類型。但是單行文本、JSON、向量數據的長度通常比基本數據類型的數據要長，單行長達數十KB甚至MB級別。基於固定行數的block設計會導致單個block過大，IO效率降低。因此針對非結構化數據類型，AnalyticDB採用了定長數據塊技術，每個塊大小相同。</p><p>如圖9所示，每個Block由多個定長數據塊（稱作FBlock）組成，每個FBlock大小為32KB，單獨存儲為一個文件中。Block中保存的不再是原始數據內容，而是數據所在FBlock的塊號和FBlock內的偏移位置。查詢時，首先讀取Block中的內容，得到FBlock的塊號和塊內偏移，然後再讀取FBlock內容，得到非結構化數據內容。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/36ce498ca73a44a288f47265402d7295><p class=pgc-img-caption></p></div><p>圖9 定長數據塊格式</p><p>4.3、索引管理</p><p>索引是數據庫系統裡影響性能最關鍵組件，但是傳統的索引並不能很好滿足OLAP場景下任意ad-hoc查詢的需求。例如B+Tree索引，在海量數據下存在中間節點過多，容易產生大量隨機IO等問題；Druid可以對多列數據構建倒排索引，但是隻能支持特定數據類型（字符串類型，不支持數值類型）； 傳統數據庫構建索引佔用大量資源，影響寫入性能；現有的索引也不支持非結構化數據類型，例如JSON，長文本和向量。</p><p>因此，AnalyticDB設計和實現了一個新的索引引擎，在不影響寫入性能的情況下，支持結構化和非結構化數據類型索引。它將構建過程從寫入鏈路中移除，採用後臺異步構建模式，支持對所有列構建索引，從而解決了OLAP任意查詢的性能問題。</p><p>4.3.1、索引查詢</p><p>AnalyticDB默認對所有列構建索引，並保存在一個單獨的文件中。與傳統的數據庫不同，AnalyticDB索引中的key是列的值，value是該值出現的所有行號集合，並支持所有的條件同時走索引查詢。如圖10所示，該SQL是一個複雜查詢包括結構化列條件和非結構化列條件。索引引擎會首先對每個條件走索引掃描，得到多個行號集合，然後將AND/OR 條件轉換為行號集合的UNION/INTESECT操作。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/ee516cb5983f45f4a3e452aa1cc9e9dd><p class=pgc-img-caption></p></div><p>圖10 索引查詢示例</p><p>AnalyticDB在索引引擎是實現上也做了大量的優化，包括：多路流式歸併、索引選擇CBO和索引結果緩存。</p><p>多路流式歸併：傳統數據庫大多采用2路歸併策略，在條件數特別多的場景下，會導致大量中間結果，計算效率很低。AanlyticDB採用K路流式歸併算法，可以支持多個集合並行歸併，避免產生大量中間結果集合，提升了整個歸併的速度。</p><p>索引選擇CBO：當where條件中包括多個條件，並不是所有的條件走索引掃描能取得最佳的性能。利用索引中的統計信息，提前估算出各個條件可能的選擇率，對於選擇率很高的條件走索引查詢，其他條件直接在上層進行過濾操作。例如對於where id = 1 and 0 &lt; x &lt; 1000000的情況下，d = 1這個條件的選擇率已經很高，則0索引結果緩存：在OLAP分析場景中，多個查詢條件中，可能會出現部分條件固定不變或重複多次出現。針對這種場景AnalyticDB 實現了一個高效的無鎖緩存，緩存的的key為等值或range條件，value為行號集合。這樣在出現重複查詢情況下，可以直接讀取緩存，避免索引IO掃描開銷。</p><p>4.3.2、索引構建</p><p>為了支持每秒千萬的實時數據寫入，避免同步構建索引影響實時寫入的性能，AnalyticDB並沒有採用同步構建索引的策略，而是採用異步後臺進程構建索引的方式。索引引擎會根據時間或增量數據的大小來決定是否啟動後臺進程來構建索引。該後臺進程讀取Pangu上的歷史全量數據和新寫入的增量日誌數據，完成數據合併形成新的全量數據，並對該全量數據重新構建索引。該過程通過伏羲的MapReduce任務執行，選擇負載較低的機器執行，對用戶完全透明。</p><p>5、 AnalyticDB計算層設計</p><p>5.1、優化器</p><p>AnalyticDB綜合了CBO（基於代價估算）和RBO（基於規則）的優化模型來為實時在線分析提供最優的計劃。優化規則的豐富程度是能否產生最優計劃的一個重要指標。因為只有可選方案足夠多時，才有可能選到最優的執行計劃。AnalyticDB提供了豐富的關係代數轉換規則，用來確保不會遺漏最優計劃。</p><ul><li>基礎優化規則</li><li>1） 裁剪規則：列裁剪、分區裁剪、子查詢裁剪</li></ul><p>2） 下推／合併規則：謂詞下推、函數下推、聚合下推、Limit下推</p><p>3） 去重規則：Project去重、Exchange去重、Sort去重</p><p>4） 常量摺疊／謂詞推導</p><ul><li>探測優化規則</li><li>1） Joins：BroadcastHashJoin、RedistributedHashJoin、NestLoopIndexJoin</li></ul><p>2） Aggregate：HashAggregate、SingleAggregate</p><p>3） JoinReorder</p><p>4） GroupBy下推、Exchange下推、Sort下推</p><ul><li>高級優化規則</li><li>1） CTE</li></ul><p>除了這些，我們創新性引入了兩個關鍵功能：存儲感知的優化和高效實時採樣。</p><p>5.1.1、存儲感知的優化</p><p>執行下推。執行下推是將SQL中可以依賴存儲能力的關係代數計算進行提取，將查詢計劃等價轉換為兩部分，一部分在計算層執行，一部分下推給存儲層執行。由於原有查詢計劃中並沒有明確的界限來分隔兩部分，因此需要依賴存儲層本身的計算能力，通過關係代數的等價轉換規則，將其分離。執行下推在很多分佈式數據庫中都有類似的實現，但下推算子的極致基本都是以單列條件的AND操作為主，其他算子如函數、JOIN等都在計算層實現。這主要是由於其並未實現存儲層向上註冊計算能力的邏輯，默認認為存儲層最多隻能做單列或者組合條件的過濾。</p><p>AnalyticDB引入了一種STARs模型作為執行下推的框架，通過將異構數據源的執行能力按照關係代數的維度進行抽象，將存儲的能力特徵化為其所能處理的關係代數的能力。在優化器完成初步的分佈式執行計劃後，利用動態規劃的方式針對不同的數據源將適合下推給存儲執行的關係代數算子進行封裝，轉化為對應的存儲的API調用。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/e8f4c7090cbc40e9ae3f35981035fde6><p class=pgc-img-caption></p></div><p>圖11 STARs模型</p><p>於此同時，STARs框架還加入了代價的計算，也就是說並非簡單的依賴存儲的能力進行執行下推，而是在對其進行關係代數能力抽象的同時，對其執行的代價進行數值化。在進行動態規劃時，將代價和執行能力同時作為參考因素，避免盲目的下推導致性能變差。</p><p>Join下推。數據重分佈是分佈式數據庫執行計劃區別於傳統數據庫執行計劃的一個重要方面，主要是由於數據的物理分佈特性與關係代數的邏輯語義不匹配導致的。比如SQL：SELECT t.tid, count(*) FROM t JOIN s in t.sid = s.sid GROUP BY t.tid。其中t表按照tid進行Hash分區，s表按照sid進行Hash分區。其邏輯執行計劃如下：</p><p>基於規則的優化器。在生成Aggregation/Join的執行計劃時，會發現其下游節點並不符合當前算子對數據物理分佈特性的要求，因此會強制增加一個數據數據重分佈的算子來保證其執行語義的正確，數據重分佈帶來的物理開銷非常大，涉及到數據的序列化、反序列化、網絡開銷等等，因此避免多次數據重分佈是對於分佈式計算是一個非常重要的優化。AnalyticDB的優化器可以通過將所有可能的執行計劃進行展開，並對其進行代價計算。正是使用了這種方式，AnalyticDB實現了在不同的數據規模時，生成對應其數據特徵最優的執行計劃。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/8c8f5b5946014bfeab76954bfd29ffe5><p class=pgc-img-caption></p></div><p>圖12 Aggregation/Join執行計劃產生</p><p>基於索引的Join和聚合 。將Join變為查找現有索引，全索引的設計進一步消除了構建哈希開銷。當調整Join的順序時，如果大多數Join列是分區列且具有索引，優化器會避免使用BushyTree，而更傾向選擇LeftDeepTree。採用LeftDeepTree，AnalyticDB能更好地利用現有索引。優化器更近一步下推了謂詞和聚合。聚合函數，比如count和查詢過濾可以直接基於索引計算。所有這些組合降低了查詢延遲，同時提高集群利用率，從而使得AnalyticDB能輕鬆支持高併發。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/44733936768448698e3647a203f9b2de><p class=pgc-img-caption></p></div><p>圖13 基於索引的Join優化</p><p>5.1.2、高效實時採樣</p><p>統計信息是優化器在做基於代價查詢優化所需的基本信息，通常包括有關表、列和索引等的統計信息。傳統數據倉庫僅收集有限的統計信息，例如列上典型的最常值（MFV）。商業數據庫為用戶提供了收集統計信息的工具，但這通常取決於DBA的經驗，依賴DBA來決定收集哪些統計數據，並依賴於服務或工具供應商。</p><p>上述方法收集的統計數據通常都是靜態的，它可能需要在一段時間後，或者當數據更改達到一定程度，來重新收集。但是，隨著業務應用程序變得越來越複雜和動態，預定義的統計信息收集可能無法以更有針對性的方式幫助查詢。例如，用戶可以選擇不同的聚合列和列數，其組合可能會有很大差異。但是，在查詢生成之前很難預測這樣的組合。因此，很難在統計收集時決定正確統計方案。但是，此類統計信息可幫助優化器做出正確決定。</p><p>我們設計了一個查詢驅動的動態統計信息收集機制來解決此問題。守護程序動態監視傳入的查詢工作負載和特點以提取其查詢模式，並基於查詢模式，分析缺失和有益的統計數據。在此分析和預測之上，異步統計信息收集任務在後臺執行。這項工作旨在減少收集不必要的統計數據，同時使大多數即將到來的查詢受益。對於前面提到的聚合示例，收集多列統計信息通常很昂貴，尤其是當用戶表有大量列的時候。根據我們的動態工作負載分析和預測，可以做到僅收集必要的多列統計信息，同時，優化器能夠利用這些統計數據來估計聚合中不同選項的成本並做出正確的決策。</p><p>5.2、執行引擎</p><p>在優化器之下，AnalyticDB在MPP架構基礎上，採用流水線執行的DAG架構，構建了一個適用於低延遲和高吞吐量工作負載的執行器。AnalyticDB的列式執行引擎能夠充分利用底層的行列混合存儲。與行式執行引擎相比，當前的向量化執行引擎更加緩存友好，能避免將不必要的數據加載到內存中。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/3df209cb056f4a1c903c6523c773102c><p class=pgc-img-caption></p></div><p>圖14 流水線模式執行引擎</p><p>與許多 OLAP 系統一樣，AnalyticDB在運行時利用代碼生成器（CodeGen） 來提高 CPU 密集型計算的性能。AnalyticDB的CodeGen基於 ANTLR ASM來動態生成表達式的代碼樹。同時此 CodeGen 引擎還將運行時因素納入考慮，讓AnalyticDB能在Task級別利用異構新硬件的能力。例如，如果集群中CPU支持 AVX-512指令集，我們通過生成字節碼使用SIMD來提高性能。在此之外，通過整合內部數據表示形式，在存儲層和執行引擎之間，AnalyticDB是能夠直接對序列化二進制數據進行操作，而不是Java 對象。這有助於消除序列化和去序列化的開銷，這在大數據量shuffle時可能會節約20%以上的時間。</p><p>6、 實驗數據展示</p><p>6.1、實驗準備</p><ol><li>實驗環境。實驗運行在一個擁有八臺機器的集群環境上，每天機器配置為Intel Xeon Platinum 8163 CPU (@2.50GHz)、300GB內存、3TB SSD和萬兆網卡。集群上分配了一個擁有4個協調節點、4個寫節點、32個讀節點的AnalyticDB實例。</li><li>實驗測試集。實驗選擇了兩種測試集：一個是阿里巴巴集團內部產生的真實數據集，分別為1TB和10TB大小；一個是標準TPC-H測試集。</li><li>查詢語句。針對真實數據集，選擇了三種類型的查詢語句，如表1所示，它們分別為全表掃描、點查詢、多表關聯查詢。</li></ol><p class=ql-align-center>表1 真實數據集上的三種類型查詢</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/86923578167e4c29950134af960b871f><p class=pgc-img-caption></p></div><p>6.2、實驗數據</p><p>真實數據集。圖14展示了AnalyticDB在真實數據集上運行三種查詢語句的性能。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/04fbab34001744218d82b53320823c0e><p class=pgc-img-caption></p></div><p>圖15 1TB和10TB數據量的查詢延遲</p><p>如圖所示，得益於全索引設計和行列混存存儲模式，AnalyticDB均可以在秒級甚至更短的時間內完成三種類型的查詢語句。對於任意一種查詢，AnalyticDB均可以精準定位到對應的一級分區或二級分區，並進行索引篩選，從而避免無效、大量的全表數據掃描。也正是因為AnalyticDB能快速定位、掃描有效數據，1TB和10TB數據量的查詢性能差別不大，也即AnalyticDB的性能受數據表大小影響有限。</p><div class=pgc-img><img alt=VLDB論文解讀：阿里雲超大規模實時分析型數據庫AnalyticDB onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/31350b85fd6e4826a7d11d63e435edbf><p class=pgc-img-caption></p></div><p>圖16 TPC-H性能</p><p>TPC-H數據集。圖15展示了AnalyticDB在1TB TPC-H數據集下的性能，同時還和PrestoDB、Spark-SQL、Greenplum進行了對比。得益於流水線處理、全列索引、行列混存、運行時索引路徑選擇、K路歸併、向量化執行引擎、CodeGen等優化機制，AnalyticDB獲得了最優的TCP-H測試運行時間，並比第二好的Greenplum快了近2倍。</p><p>作者：Roin</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>文解</a></li><li><a>VLDB</a></li><li><a>規模</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/b0644a5e.html alt=新手上路：圖文解讀助你理解和使用正則表達式 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/f4e1b0398aad491a805f4ddee72c8744 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b0644a5e.html title=新手上路：圖文解讀助你理解和使用正則表達式>新手上路：圖文解讀助你理解和使用正則表達式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/1f8aadde.html alt=明初長沙城池空前規模的修整 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/36eb5e0a-4bac-4be5-9c3c-f186817eee72 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/1f8aadde.html title=明初長沙城池空前規模的修整>明初長沙城池空前規模的修整</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3852da1f.html alt=說文解字：“梟”和“嫋”你能分清嗎？含義區別大了 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e02c4a45e46d40f2b805fb23f2555b34 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3852da1f.html title=說文解字：“梟”和“嫋”你能分清嗎？含義區別大了>說文解字：“梟”和“嫋”你能分清嗎？含義區別大了</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/16163877.html alt=2019年阿壩州規模以上工業生產能力年報綜述 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RqALLGVINNInKI style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/16163877.html title=2019年阿壩州規模以上工業生產能力年報綜述>2019年阿壩州規模以上工業生產能力年報綜述</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fbe7473f.html alt=中石油最大規模加氫催化劑項目啟動年生產能力5000噸 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/RcbjNH9DzBcP3V style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fbe7473f.html title=中石油最大規模加氫催化劑項目啟動年生產能力5000噸>中石油最大規模加氫催化劑項目啟動年生產能力5000噸</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3a2da24f.html alt=《說文解字》第285課：細說“邊（邊）”字 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/c7838199220a40da8e8b989c8f7158fb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3a2da24f.html title=《說文解字》第285課：細說“邊（邊）”字>《說文解字》第285課：細說“邊（邊）”字</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d2a5d93f.html alt=華為雲首次突發大規模“宕機”故障！雲服務安全再引發行業關注 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RvlHgQfCFzSEC5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d2a5d93f.html title=華為雲首次突發大規模“宕機”故障！雲服務安全再引發行業關注>華為雲首次突發大規模“宕機”故障！雲服務安全再引發行業關注</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/43ca517e.html alt=炭黑市場規模超過172億美元 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/43ca517e.html title=炭黑市場規模超過172億美元>炭黑市場規模超過172億美元</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e4a7cc1b.html alt=香港政務司司長張建宗發文解讀“香港維護國家安全立法”：國安立法確保香港長治久安 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e4a7cc1b.html title=香港政務司司長張建宗發文解讀“香港維護國家安全立法”：國安立法確保香港長治久安>香港政務司司長張建宗發文解讀“香港維護國家安全立法”：國安立法確保香港長治久安</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/77ec8e7c.html alt=“人造原子”工藝攻克難關，超大規模光子學芯片誕生 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/S4hGVaHERNKZSw style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/77ec8e7c.html title=“人造原子”工藝攻克難關，超大規模光子學芯片誕生>“人造原子”工藝攻克難關，超大規模光子學芯片誕生</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9420a2ea.html alt=鑽孔灌注樁正反循環基礎施工工藝及要點，圖文解說 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/7e55c09b56f44f31b28339057e7569c2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9420a2ea.html title=鑽孔灌注樁正反循環基礎施工工藝及要點，圖文解說>鑽孔灌注樁正反循環基礎施工工藝及要點，圖文解說</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fafac76b.html alt=手把手教你把脈：7字歌訣+白話文解釋！（中篇） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/f6b011d8-c76c-4a67-9b62-9f5937465105 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fafac76b.html title=手把手教你把脈：7字歌訣+白話文解釋！（中篇）>手把手教你把脈：7字歌訣+白話文解釋！（中篇）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/90e5b04b.html alt=滾筒篩常見故障及改進：堵塞、聯接軸斷裂、篩圈磨損等，一文解決 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/153432008077426bde2a75e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/90e5b04b.html title=滾筒篩常見故障及改進：堵塞、聯接軸斷裂、篩圈磨損等，一文解決>滾筒篩常見故障及改進：堵塞、聯接軸斷裂、篩圈磨損等，一文解決</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ef3b57ec.html alt=中國港口正處於由規模速度型向質量效益型轉變的關鍵階段 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/SAYgb69BFd6MPp style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ef3b57ec.html title=中國港口正處於由規模速度型向質量效益型轉變的關鍵階段>中國港口正處於由規模速度型向質量效益型轉變的關鍵階段</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/14662f58.html alt=2025年，全球有源微波器件市場規模將達到636.81億元 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/da2cc5364c6341b497a675cd258187bb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/14662f58.html title=2025年，全球有源微波器件市場規模將達到636.81億元>2025年，全球有源微波器件市場規模將達到636.81億元</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>