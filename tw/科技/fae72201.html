<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>.Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€ | æå®¢å¿«è¨Š</title><meta property="og:title" content=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€ - æå®¢å¿«è¨Š"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p1.pstatp.com/large/pgc-image/f15647f0f33b4702bceef5e2365bb375"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fae72201.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fae72201.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fae72201.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fae72201.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fae72201.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fae72201.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/fae72201.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/fae72201.html><meta property="article:published_time" content="2020-11-14T21:00:28+08:00"><meta property="article:modified_time" content="2020-11-14T21:00:28+08:00"><meta name=Keywords content><meta name=description content=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€"><meta name=author content="æå®¢å¿«è¨Š"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/fae72201.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>ğŸ¤“ æå®¢å¿«è¨Š Geek Bank</a></h1><p class=description>ç‚ºä½ å¸¶ä¾†æœ€å…¨çš„ç§‘æŠ€çŸ¥è­˜ ğŸ§¡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>çŒœä½ å–œæ­¡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=ç§‘æŠ€>ç§‘æŠ€</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=éŠæˆ²>éŠæˆ²</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=ç§‘å­¸>ç§‘å­¸</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>.Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>ç§‘æŠ€</a></span></div><div class=post-content><div><p><strong>ä¸€ã€ç°¡ä»‹</strong></p><p>IdentityServer4æ˜¯ç”¨æ–¼ASP.NET Coreçš„OpenID Connectå’ŒOAuth 2.0æ¡†æ¶ã€‚</p><p>å°‡IdentityServer4éƒ¨ç½²åˆ°æ‚¨çš„æ‡‰ç”¨ä¸­å…·å‚™å¦‚ä¸‹ç‰¹é»ï¼š</p><p>1ï¼‰ã€èªè­‰æœå‹™</p><p>2ï¼‰ã€å–®é»ç™»é™¸</p><p>3ï¼‰ã€APIè¨ªå•æ§åˆ¶</p><p>4ï¼‰ã€è¯åˆç¶²é—œ</p><p>5ï¼‰ã€å°ˆæ³¨æ–¼å®šè£½</p><p>6ï¼‰ã€æˆç†Ÿçš„é–‹æºç³»çµ±</p><p>7ï¼‰ã€å…è²»å’Œå•†æ¥­æ”¯æŒ</p><p><strong>äºŒã€æ•´é«”éƒ¨ç½²</strong></p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/f15647f0f33b4702bceef5e2365bb375><p class=pgc-img-caption></p></div><p>ç›®å‰å¤§å¤šæ•¸çš„æ‡‰ç”¨ç¨‹åºæˆ–å¤šæˆ–å°‘çœ‹èµ·ä¾†æ˜¯ä¸Šåœ–æ‰€ç¤ºé€™æ¨£çš„ï¼Œæœ€å¸¸è¦‹çš„äº¤äº’å ´æ™¯æœ‰ï¼ˆç€è¦½å™¨èˆ‡Webæ‡‰ç”¨ç¨‹åºã€Webæ‡‰ç”¨ç¨‹åºèˆ‡WebApié€šè¨Šã€æœ¬åœ°æ‡‰ç”¨ç¨‹åºç„WebApié€šè¨Šã€åŸºæ–¼ç€è¦½å™¨çš„æ‡‰ç”¨ç¨‹åºèˆ‡WebApi é€šè¨Šã€åŸºæœ¬æœå‹™å™¨çš„æ‡‰ç”¨ç¨‹åºèˆ‡WebApié€šè¨Šã€WebApièˆ‡WebApié€šè¨Šï¼‰</p><p>å‰ç«¯ã€ä¸­é–“å±¤ã€å¾Œç«¯å„å€‹å±¤ç´šç‚ºäº†ä¿è­·è³‡æºç¶“å¸¸è¦é‡å°ç›¸åŒçš„ç”¨æˆ¶å€‰å„²å€å¯¦ç¾èº«ä»½èªè­‰å’Œæˆæ¬Šï¼Œä½†æ˜¯å¦‚æœæˆ‘å€‘æŠŠé€™äº›åŸºæœ¬çš„å®‰å…¨åŠŸèƒ½çµ±ä¸€é ’ç™¼çµ¦ä¸€å€‹å®‰å…¨ä»¤ç‰Œæœå‹™ï¼Œå°±å¯ä»¥ä¸å¿…å†è®“é€™äº›æ‡‰ç”¨å’Œç«¯é»ä¹‹é–“é‡è¤‡å¯¦ç¾é€™äº›åŸºç¤å®‰å…¨åŠŸèƒ½ï¼Œé‡çµ„æ‡‰ç”¨ç¨‹åºä»¥æ”¯æŒå®‰å…¨ä»¤ç‰Œæœå‹™å°‡æœƒå¼•å°å‡ºä»¥ä¸‹é«”ç³»çµæ§‹å’Œå”è­°</p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/b0c99c135f4a47dabaf17935c66d61e9><p class=pgc-img-caption></p></div><p>é€™æ¨£çš„è¨­è¨ˆå°‡æœƒæŠŠå®‰å…¨å•é¡Œåˆ†ç‚ºå…©å€‹éƒ¨åˆ†ï¼šï¼ˆèº«ä»½é©—è­‰å’ŒAPIè¨ªå•ï¼‰</p><p><strong>ä¸‰ã€IdentityServer4å¦‚ä½•æä¾›å¹«åŠ©</strong></p><p>IdentityServeræ˜¯å°‡è¦ç¯„å…¼å®¹çš„OpenID Connectå’ŒOAuth 2.0ç«¯é»æ·»åŠ åˆ°ä»»æ„ASP.NET Coreæ‡‰ç”¨ç¨‹åºçš„ä¸­é–“ä»¶ã€‚é€šå¸¸ï¼Œæ‚¨æ§‹å»ºï¼ˆæˆ–é‡æ–°ä½¿ç”¨ï¼‰åŒ…å«ç™»éŒ„å’Œè¨»éŠ·é é¢çš„æ‡‰ç”¨ç¨‹åºï¼ŒIdentityServerä¸­é–“ä»¶æœƒå‘å…¶æ·»åŠ å¿…è¦çš„å”è­°é ­ï¼Œä»¥ä¾¿å®¢æˆ¶ç«¯æ‡‰ç”¨ç¨‹åºå¯ä»¥èˆ‡å…¶å°è©± ä½¿ç”¨é€™äº›æ¨™æº–å”è­°ã€‚</p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/49bf8c84d6f848b1aa2ea1bb8a8a8f88><p class=pgc-img-caption></p></div><p><strong>å››ã€è¡“èª</strong></p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/7dd95e2245584dc7a9ddfdab1472dbde><p class=pgc-img-caption></p></div><p>1ï¼‰ã€Usersï¼ˆç”¨æˆ¶ï¼‰ï¼šç”¨æˆ¶æ˜¯ä½¿ç”¨å·²è¨»å†Šçš„å®¢æˆ¶ç«¯è¨ªå•è³‡æºçš„äºº</p><p>2ï¼‰ã€Clientsï¼ˆå®¢æˆ¶ç«¯ï¼‰ï¼šå®¢æˆ¶ç«¯å°±æ˜¯å¾identityserverè«‹æ±‚ä»¤ç‰Œçš„è»Ÿä»¶ï¼ˆä½ å¯ä»¥ç†è§£ç‚ºä¸€å€‹appå³å¯ï¼‰ï¼Œæ—¢å¯ä»¥é€šéèº«ä»½èªè­‰ä»¤ç‰Œä¾†é©—è­‰è­˜åˆ¥ç”¨æˆ¶èº«ä»½ï¼Œåˆå¯ä»¥é€šéæˆæ¬Šä»¤ç‰Œä¾†è¨ªå•æœå‹™ç«¯çš„è³‡æºã€‚ä½†æ˜¯å®¢æˆ¶ç«¯é¦–å…ˆå¿…é ˆåœ¨ç”³è«‹ä»¤ç‰Œå‰å·²ç¶“åœ¨identityserveræœå‹™ä¸­è¨»å†Šéã€‚å¯¦éš›å®¢æˆ¶ç«¯ä¸åƒ…å¯ä»¥æ˜¯Webæ‡‰ç”¨ç¨‹åºï¼Œappæˆ–æ¡Œé¢æ‡‰ç”¨ç¨‹åºï¼ˆä½ å°±ç†è§£ç‚ºpcç«¯çš„è»Ÿä»¶å³å¯ï¼‰ï¼ŒSPAï¼Œæœå‹™å™¨é€²ç¨‹ç­‰</p><p>3)ã€Resourcesï¼ˆè³‡æºï¼‰ï¼š</p><p>è³‡æºå°±æ˜¯ä½ æƒ³ç”¨identityserverä¿è­·çš„æ±æ±ï¼Œå¯ä»¥æ˜¯ç”¨æˆ¶çš„èº«ä»½æ•¸æ“šæˆ–è€…apiè³‡æºã€‚</p><p>æ¯ä¸€å€‹è³‡æºéƒ½æœ‰ä¸€å€‹å”¯ä¸€çš„åç¨±ï¼Œå®¢æˆ¶ç«¯ä½¿ç”¨é€™å€‹å”¯ä¸€çš„åç¨±ä¾†ç¢ºå®šæƒ³è¨ªå•å“ªä¸€å€‹è³‡æºï¼ˆåœ¨è¨ªå•ä¹‹å‰ï¼Œå¯¦éš›identityserveræœå‹™ç«¯å·²ç¶“é…ç½®å¥½äº†å“ªå€‹å®¢æˆ¶ç«¯å¯ä»¥è¨ªå•å“ªå€‹è³‡æºï¼Œæ‰€ä»¥ä½ ä¸å¿…ç†è§£ç‚ºå®¢æˆ¶ç«¯åªè¦æŒ‡å®šåç¨±ä»–å€‘å°±å¯ä»¥éš¨ä¾¿è¨ªå•ä»»ä½•ä¸€å€‹è³‡æºï¼‰ã€‚</p><p>ç”¨æˆ¶çš„èº«ä»½ä¿¡æ¯å¯¦éš›ç”±ä¸€çµ„claimçµ„æˆï¼Œä¾‹å¦‚å§“åæˆ–è€…éƒµä»¶éƒ½æœƒåŒ…å«åœ¨èº«ä»½ä¿¡æ¯ä¸­ï¼ˆå°‡ä¾†é€šéidentityserveræ ¡é©—å¾Œéƒ½æœƒè¿”å›çµ¦è¢«èª¿ç”¨çš„å®¢æˆ¶ç«¯ï¼‰ã€‚</p><p>APIè³‡æºå°±æ˜¯å®¢æˆ¶ç«¯æƒ³è¦èª¿ç”¨çš„åŠŸèƒ½ï¼ˆé€šå¸¸ä»¥jsonæˆ–xmlçš„æ ¼å¼è¿”å›çµ¦å®¢æˆ¶ç«¯ï¼Œä¾‹å¦‚webapiï¼Œwcf,webserviceï¼‰ï¼Œé€šå¸¸é€šéwebapiä¾†å»ºç«‹æ¨¡å‹ï¼Œä½†æ˜¯ä¸ä¸€å®šæ˜¯webapiï¼Œæˆ‘å‰›æ‰å·²ç¶“å¼·èª¿å¯ä»¥ä½¿å…¶ä»–é¡å‹çš„æ ¼å¼ï¼Œé€™å€‹è¦çœ‹å…·é«”çš„ä½¿ç”¨å ´æ™¯äº†ã€‚</p><p>4ï¼‰ã€Identity Tokenï¼ˆèº«ä»½ä»¤ç‰Œï¼‰ï¼š</p><p>ä¸€å€‹èº«ä»½ä»¤ç‰ŒæŒ‡çš„å°±æ˜¯å°èªè­‰éç¨‹çš„æè¿°ã€‚å®ƒè‡³å°‘è¦æ¨™è­˜æŸå€‹ç”¨æˆ¶ï¼ˆCalled the sub aka subject claimï¼‰çš„ä¸»èº«ä»½ä¿¡æ¯ï¼Œå’Œè©²ç”¨æˆ¶çš„èªè­‰æ™‚é–“å’Œèªè­‰æ–¹å¼ã€‚ä½†æ˜¯èº«ä»½ä»¤ç‰Œå¯ä»¥åŒ…å«é¡å¤–çš„èº«ä»½æ•¸æ“šï¼Œå…·é«”é–‹ç™¼è€…å¯ä»¥è‡ªè¡Œè¨­å®šï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…æ³ç‚ºäº†ç¢ºä¿æ•¸æ“šå‚³è¼¸çš„æ•ˆç‡ï¼Œé–‹ç™¼è€…ä¸€èˆ¬ä¸åšéå¤šé¡å¤–çš„è¨­ç½®ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥æ ¹æ“šä½¿ç”¨å ´æ™¯è‡ªè¡Œæ±ºå®šã€‚</p><p>5ï¼‰ã€Access Tokenï¼ˆè¨ªå•ä»¤ç‰Œï¼‰ï¼š</p><p>è¨ªå•ä»¤ç‰Œå…è¨±å®¢æˆ¶ç«¯è¨ªå•æŸå€‹ API è³‡æºã€‚å®¢æˆ¶ç«¯è«‹æ±‚åˆ°è¨ªå•ä»¤ç‰Œï¼Œç„¶å¾Œä½¿ç”¨é€™å€‹ä»¤ç‰Œä¾†è¨ªå• APIè³‡æºã€‚è¨ªå•ä»¤ç‰ŒåŒ…å«äº†å®¢æˆ¶ç«¯å’Œç”¨æˆ¶ï¼ˆå¦‚æœæœ‰çš„è©±ï¼Œé€™å–æ±ºæ–¼æ¥­å‹™æ˜¯å¦éœ€è¦ï¼Œä½†é€šå¸¸ä¸å¿…è¦ï¼‰çš„ç›¸é—œä¿¡æ¯ï¼ŒAPIé€šéé€™äº›ä»¤ç‰Œä¿¡æ¯ä¾†æˆäºˆå®¢æˆ¶ç«¯çš„æ•¸æ“šè¨ªå•æ¬Šé™ã€‚</p><p><strong>äº”ã€ä»£ç¢¼å¿«é€Ÿå…¥é–€ (ä½¿ç”¨å®¢æˆ¶ç«¯æ†‘æ“šä¿è­·)</strong></p><p>1ï¼‰ã€IdentityServer</p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/5537ac3b1544489ba67f35922fdfc56f><p class=pgc-img-caption></p></div><p>a)ã€å®šç¾©Apiè³‡æºå’Œå®¢æˆ¶ç«¯</p><p>Api æ˜¯æ‚¨ç³»çµ±ä¸­è¦ä¿è­·çš„è³‡æºï¼Œè³‡æºçš„å®šç¾©å¯ä»¥é€šéå¤šç¨®æ–¹å¼</p><p>å®¢æˆ¶ç«¯ä»£ç¢¼ä¸­çš„ClientIdå’ŒClientSecretä½ å¯ä»¥è¦–ç‚ºæ‡‰ç”¨ç¨‹åºæœ¬èº«çš„ç™»éŒ„åå’Œå¯†ç¢¼ï¼Œå®ƒå°‡æ‚¨çš„æ‡‰ç”¨ç¨‹åºæ¨™è­˜åˆ°IdentityServer æœå‹™å™¨ï¼Œä»¥ä¾¿å®ƒçŸ¥é“å“ªå€‹æ‡‰ç”¨ç¨‹åºæ­£åœ¨å˜—è©¦èˆ‡å…¶é€£æ¥</p><pre>using IdentityServer4.Models;using System.Collections.Generic;namespace IdentityServer{ public static class Config { public static IEnumerable&lt;ApiResource&gt; Apis =&gt; new List&lt;ApiResource&gt; { new ApiResource("api1","My API") }; public static IEnumerable&lt;Client&gt; Clients =&gt; new List&lt;Client&gt; { new Client { ClientId="client", AllowedGrantTypes =GrantTypes.ClientCredentials, ClientSecrets={ new Secret("aju".Sha256()) }, AllowedScopes={ "api1"} } }; }}</pre><p>b)ã€é…ç½®IdentityServer</p><pre>using Microsoft.AspNetCore.Builder;using Microsoft.AspNetCore.Hosting;using Microsoft.Extensions.DependencyInjection;using Microsoft.Extensions.Hosting;namespace IdentityServer{ public class Startup { // This method gets called by the runtime. Use this method to add services to the container. // For more information on how to configure your application, visit https://go.microsoft.com/fwlink/?LinkID=398940 public void ConfigureServices(IServiceCollection services) { var builder = services.AddIdentityServer() .AddInMemoryApiResources(Config.Apis) .AddInMemoryClients(Config.Clients); builder.AddDeveloperSigningCredential(); } // This method gets called by the runtime. Use this method to configure the HTTP request pipeline. public void Configure(IApplicationBuilder app, IWebHostEnvironment env) { if (env.IsDevelopment()) { app.UseDeveloperExceptionPage(); } app.UseIdentityServer(); //app.UseRouting(); //app.UseEndpoints(endpoints =&gt; //{ // endpoints.MapGet("/", async context =&gt; // { // await context.Response.WriteAsync("Hello World!"); // }); //}); } }}</pre><p>c)ã€æ¸¬è©¦ï¼ˆå¦‚æœé…ç½®åˆé©ï¼Œåœ¨ç€è¦½å™¨è¨ªå• http://localhost:5000/.well-known/openid-configuration å‡ºç¾å¦‚ä¸‹è¡¨ç¤ºé…ç½®OKï¼‰</p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/654f51698e53427b9962f8b7f11d241a><p class=pgc-img-caption></p></div><p>é¦–æ¬¡å•Ÿå‹•æ™‚ï¼ŒIdentityServerå°‡ç‚ºæ‚¨å‰µå»ºä¸€å€‹é–‹ç™¼äººå“¡ç°½åå¯†é‘°ï¼Œè©²æ–‡ä»¶åç‚ºtempkey.rsaã€‚æ‚¨ç„¡éœ€å°‡è©²æ–‡ä»¶ç°½å…¥æºä»£ç¢¼ç®¡ç†ä¸­ï¼Œå¦‚æœä¸å­˜åœ¨è©²æ–‡ä»¶å°‡è¢«é‡æ–°å‰µå»ºã€‚</p><p>d)ã€æ‰€éœ€çš„åŒ…</p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/2b7a11dbed904ff6a0dbbc588f47076c><p class=pgc-img-caption></p></div><p>2ï¼‰ã€æ·»åŠ Apiè³‡æº</p><p>a)ã€æ·»åŠ ä¸€å€‹åç‚ºIdentityControllerçš„æ§åˆ¶å™¨</p><pre>using Microsoft.AspNetCore.Authorization;using Microsoft.AspNetCore.Mvc;using System.Linq;namespace Api.Controllers{ [Route("identity")] [Authorize] public class IdentityController : ControllerBase { public IActionResult Get() { return new JsonResult(from c in User.Claims select new { c.Type, c.Value }); } }}</pre><p>b)ã€é…ç½®ï¼ˆå°‡èº«ä»½èªè­‰æœå‹™æ·»åŠ åˆ°DIï¼Œä¸¦å°‡èº«ä»½é©—è­‰ä¸­é–“ä»¶æ·»åŠ åˆ°ç®¡é“ï¼‰</p><pre>using Microsoft.AspNetCore.Builder;using Microsoft.AspNetCore.Hosting;using Microsoft.Extensions.Configuration;using Microsoft.Extensions.DependencyInjection;using Microsoft.Extensions.Hosting;namespace Api{ public class Startup { public Startup(IConfiguration configuration) { Configuration = configuration; } public IConfiguration Configuration { get; } // This method gets called by the runtime. Use this method to add services to the container. public void ConfigureServices(IServiceCollection services) { services.AddControllers(); services.AddAuthentication("Bearer").AddJwtBearer("Bearer", options =&gt; { options.Authority = "http://localhost:5000"; options.RequireHttpsMetadata = false; options.Audience = "api1"; }); } // This method gets called by the runtime. Use this method to configure the HTTP request pipeline. public void Configure(IApplicationBuilder app, IWebHostEnvironment env) { if (env.IsDevelopment()) { app.UseDeveloperExceptionPage(); } app.UseRouting(); app.UseAuthentication();//èªè­‰ app.UseAuthorization();//æˆæ¬Š app.UseEndpoints(endpoints =&gt; { endpoints.MapControllers(); }); } }}</pre><p>AddAuthenticationï¼šå°‡èº«ä»½èªè­‰æœå‹™æ·»åŠ åˆ°DIæ¯”é…ç½®Bearerç‚ºé»˜èª</p><p>AddAuthenticationï¼šå°‡èº«ä»½èªè­‰æœå‹™æ·»åŠ åˆ°ç®¡é“ä¸­ï¼Œä»¥ä¾¿å°ä¸»æ©Ÿçš„æ¯æ¬¡èª¿ç”¨éƒ½å°‡è‡ªå‹•åŸ·è¡Œèº«ä»½é©—è­‰</p><p>AddAuthenticationï¼šæ·»åŠ æˆæ¬Šä¸­é–“ä»¶ï¼Œä»¥ç¢ºä¿åŒ¿åå®¢æˆ¶ç«¯ç„¡æ³•è¨ªå•æˆ‘å€‘çš„APIè³‡æº</p><p>http://localhost:5001/identity åœ¨ç€è¦½å™¨ä¸Šè¨ªå•æ‡‰è¿”å›401ç‹€æ…‹ä»£ç¢¼ã€‚é€™æ„å‘³è‘—æ‚¨çš„APIéœ€è¦æ†‘æ“šï¼Œä¸¦ä¸”ç¾åœ¨å—IdentityServerä¿è­·ã€‚</p><p>c)ã€æ‰€éœ€çš„åŒ…</p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/b496992835a9461aad4a9cbc76af211d><p class=pgc-img-caption></p></div><p>3ï¼‰ã€å‰µå»ºå®¢æˆ¶ç«¯ï¼ˆå·²æ§åˆ¶æª¯çš„å½¢å¼ï¼‰</p><pre>using IdentityModel.Client;using Newtonsoft.Json.Linq;using System;using System.Net.Http;using System.Threading.Tasks;namespace Client{ class Program { static async Task Main(string[] args) { // Console.WriteLine("Hello World!"); var client = new HttpClient(); var disco = await client.GetDiscoveryDocumentAsync("http://localhost:5000"); if (disco.IsError) { Console.WriteLine(disco.Error); return; } var tokenResponse = await client.RequestClientCredentialsTokenAsync(new ClientCredentialsTokenRequest { Address = disco.TokenEndpoint, ClientId = "client", ClientSecret = "aju", Scope = "api1" }); if (tokenResponse.IsError) { Console.WriteLine(tokenResponse.Error); return; } Console.WriteLine(tokenResponse.Json); Console.WriteLine("\n\n"); //call api var apiClient = new HttpClient(); apiClient.SetBearerToken(tokenResponse.AccessToken); var response = await apiClient.GetAsync("http://localhost:5001/identity"); if (!response.IsSuccessStatusCode) { Console.WriteLine(response.StatusCode); } else { var content = await response.Content.ReadAsStringAsync(); Console.WriteLine(JArray.Parse(content)); } Console.ReadLine(); } }}</pre><p>a)ã€æ‰€éœ€çš„åŒ…</p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/a87a8f2025e44cf0bf9c04a523d84089><p class=pgc-img-caption></p></div><p>4ï¼‰ã€ä½¿ç”¨å®¢æˆ¶ç«¯è¨ªå•Apiè³‡æº</p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/37483e42f8db4eff814ace3d3e96645c><p class=pgc-img-caption></p></div><p><strong>å…­ã€åƒè€ƒæ–‡ç»</strong></p><p>http://docs.identityserver.io/en/latest/index.html</p><div class=pgc-img><img alt=".Net Core 3.0 IdentityServer4 å¿«é€Ÿå…¥é–€" onerror=errorimg.call(this); src=https://p1.pstatp.com/large/pgc-image/bdb5d5e3a4fe4c71bf6367bee2e1e4bf><p class=pgc-img-caption></p></div></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Net</a></li><li><a>Core</a></li><li><a>3.0</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=æœç´¢>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>ğŸ”</button></form></section><section class=widget><h3 class=widget-title>æœ€æ–°æ–‡ç«  âš¡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/ba1e8a9d.html alt=2009æ¬¾3.0Tå¥§è¿ªA6Lï¼Œæ‰é–‹9è¬å…¬é‡Œè²¶å€¼60è¬ï¼Œè²·ä¸»ï¼šè‘—æ€¥ç”¨å…ˆæ¹Šæ´»é–‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/296a3656f23a476a8e442f77312ededb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ba1e8a9d.html title=2009æ¬¾3.0Tå¥§è¿ªA6Lï¼Œæ‰é–‹9è¬å…¬é‡Œè²¶å€¼60è¬ï¼Œè²·ä¸»ï¼šè‘—æ€¥ç”¨å…ˆæ¹Šæ´»é–‹>2009æ¬¾3.0Tå¥§è¿ªA6Lï¼Œæ‰é–‹9è¬å…¬é‡Œè²¶å€¼60è¬ï¼Œè²·ä¸»ï¼šè‘—æ€¥ç”¨å…ˆæ¹Šæ´»é–‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e364be22.html alt=iCouncilæ”¶è—åœ¨ç·šæ–°ç‰ˆ3.0ä¸Šç·šï¼Œå…¨å¹³è‡ºå‡ç´šé«”é©— class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/dd07ad2600d34ce5a5f64c164cf2ebe9 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e364be22.html title=iCouncilæ”¶è—åœ¨ç·šæ–°ç‰ˆ3.0ä¸Šç·šï¼Œå…¨å¹³è‡ºå‡ç´šé«”é©—>iCouncilæ”¶è—åœ¨ç·šæ–°ç‰ˆ3.0ä¸Šç·šï¼Œå…¨å¹³è‡ºå‡ç´šé«”é©—</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7a43b296.html alt=3.0V6ç¸±ç½®ç™¼å‹•æ©Ÿæ›´æ›æ­£æ™‚çš®å¸¶ï¼Œå·¥ç¨‹é‡å¯ä¸å°è€—æ™‚ä¸€å¤©å®Œæˆ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/1530193512391164b32177e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7a43b296.html title=3.0V6ç¸±ç½®ç™¼å‹•æ©Ÿæ›´æ›æ­£æ™‚çš®å¸¶ï¼Œå·¥ç¨‹é‡å¯ä¸å°è€—æ™‚ä¸€å¤©å®Œæˆ>3.0V6ç¸±ç½®ç™¼å‹•æ©Ÿæ›´æ›æ­£æ™‚çš®å¸¶ï¼Œå·¥ç¨‹é‡å¯ä¸å°è€—æ™‚ä¸€å¤©å®Œæˆ</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/bf86ceae.html alt="å¦‚ä½•åœ¨ASP.NET Coreä¸­å¯¦ç¾é¢å‘åˆ‡é¢ç·¨ç¨‹(AOP)" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/287c0bf906ec4fd88f87bd726019bf06 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/bf86ceae.html title="å¦‚ä½•åœ¨ASP.NET Coreä¸­å¯¦ç¾é¢å‘åˆ‡é¢ç·¨ç¨‹(AOP)">å¦‚ä½•åœ¨ASP.NET Coreä¸­å¯¦ç¾é¢å‘åˆ‡é¢ç·¨ç¨‹(AOP)</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4675ad02.html alt="USB 3.0ç§’è®Š5GbEç¶²å¡â€”â€”å¨è¯é€šQNA-UC5G1Tç¶²çµ¡è½‰æ›å™¨é«”é©—" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/4c2cb6e7e43f43f5a7241a0d85fc6ab8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4675ad02.html title="USB 3.0ç§’è®Š5GbEç¶²å¡â€”â€”å¨è¯é€šQNA-UC5G1Tç¶²çµ¡è½‰æ›å™¨é«”é©—">USB 3.0ç§’è®Š5GbEç¶²å¡â€”â€”å¨è¯é€šQNA-UC5G1Tç¶²çµ¡è½‰æ›å™¨é«”é©—</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/02865ba7.html alt=åŒ—äº¬â€œå¥åº·å¯¶â€3.0ä¸Šç·šç™¼ä½ˆï¼é€™ç¨®æƒ…æ³ä¸‹å°‡æç¤ºâ€œæ•‘è­·è»Šå‘¼å«éŸ³â€ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/407891cf660b486da05d93463507dc72 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/02865ba7.html title=åŒ—äº¬â€œå¥åº·å¯¶â€3.0ä¸Šç·šç™¼ä½ˆï¼é€™ç¨®æƒ…æ³ä¸‹å°‡æç¤ºâ€œæ•‘è­·è»Šå‘¼å«éŸ³â€>åŒ—äº¬â€œå¥åº·å¯¶â€3.0ä¸Šç·šç™¼ä½ˆï¼é€™ç¨®æƒ…æ³ä¸‹å°‡æç¤ºâ€œæ•‘è­·è»Šå‘¼å«éŸ³â€</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2c1045a1.html alt="ASP.NET Coreä¸­æˆ‘å€‘å¯ä»¥ä½¿ç”¨éå¸¸ç°¡å–®çš„æ–¹å¼ï¼Œä¾†ä½¿ç”¨éŸ¿æ‡‰å£“ç¸®" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/7b9fcf79-6ed6-4933-8e57-61f4fa936d65 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2c1045a1.html title="ASP.NET Coreä¸­æˆ‘å€‘å¯ä»¥ä½¿ç”¨éå¸¸ç°¡å–®çš„æ–¹å¼ï¼Œä¾†ä½¿ç”¨éŸ¿æ‡‰å£“ç¸®">ASP.NET Coreä¸­æˆ‘å€‘å¯ä»¥ä½¿ç”¨éå¸¸ç°¡å–®çš„æ–¹å¼ï¼Œä¾†ä½¿ç”¨éŸ¿æ‡‰å£“ç¸®</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/23b34058.html alt="ç‚ºASP.NET Coreé–‹ç™¼ä¸­é–“ä»¶å£“ç¸®åŠŸèƒ½æé«˜ç³»çµ±æ€§èƒ½" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/0e59ba59d6244b84844608d188600738 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/23b34058.html title="ç‚ºASP.NET Coreé–‹ç™¼ä¸­é–“ä»¶å£“ç¸®åŠŸèƒ½æé«˜ç³»çµ±æ€§èƒ½">ç‚ºASP.NET Coreé–‹ç™¼ä¸­é–“ä»¶å£“ç¸®åŠŸèƒ½æé«˜ç³»çµ±æ€§èƒ½</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2eafc565.html alt="ASP.NET Coreå¦‚ä½•ä½¿ç”¨å£“ç¸®ä¸­é–“ä»¶æé«˜Webæ‡‰ç”¨ç¨‹åºæ€§èƒ½" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/2f7e2ee9a1f141b48f2b020e9b49f33a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2eafc565.html title="ASP.NET Coreå¦‚ä½•ä½¿ç”¨å£“ç¸®ä¸­é–“ä»¶æé«˜Webæ‡‰ç”¨ç¨‹åºæ€§èƒ½">ASP.NET Coreå¦‚ä½•ä½¿ç”¨å£“ç¸®ä¸­é–“ä»¶æé«˜Webæ‡‰ç”¨ç¨‹åºæ€§èƒ½</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7d0087b8.html alt=ç™¾åº¦é¢¶é¢¨ç®—æ³•3.0ç®—æ³•è§£è®€ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/cdb9204c952743648d6f1aeea02b0c62 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7d0087b8.html title=ç™¾åº¦é¢¶é¢¨ç®—æ³•3.0ç®—æ³•è§£è®€>ç™¾åº¦é¢¶é¢¨ç®—æ³•3.0ç®—æ³•è§£è®€</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/3cf89115.html alt=HDBaseTè¦æ ¼3.0ï¼šæœªå£“ç¸®4K/60/4:4:4æ•¸å­—é€£æ¥æŠ€è¡“æ¨å‹•å°ˆæ¥­è¦–è½ç™¼å±• class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/RWjhJA69KcuNVH style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/3cf89115.html title=HDBaseTè¦æ ¼3.0ï¼šæœªå£“ç¸®4K/60/4:4:4æ•¸å­—é€£æ¥æŠ€è¡“æ¨å‹•å°ˆæ¥­è¦–è½ç™¼å±•>HDBaseTè¦æ ¼3.0ï¼šæœªå£“ç¸®4K/60/4:4:4æ•¸å­—é€£æ¥æŠ€è¡“æ¨å‹•å°ˆæ¥­è¦–è½ç™¼å±•</a></li><hr><li><a href=../../tw/%E9%81%8A%E6%88%B2/4af8e2e3.html alt=é«˜èƒ½åŠ‡é€æ…å…¥ã€Šé¨å£«3.0ã€‹æ–°ç‰ˆå…§å®¹æ¶å…ˆçœ‹ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/65c3000ec48c86f6b08c style=border-radius:25px></a>
<a href=../../tw/%E9%81%8A%E6%88%B2/4af8e2e3.html title=é«˜èƒ½åŠ‡é€æ…å…¥ã€Šé¨å£«3.0ã€‹æ–°ç‰ˆå…§å®¹æ¶å…ˆçœ‹>é«˜èƒ½åŠ‡é€æ…å…¥ã€Šé¨å£«3.0ã€‹æ–°ç‰ˆå…§å®¹æ¶å…ˆçœ‹</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4baa49fe.html alt="Rasa å…¥é–€æ•™ç¨‹ Core ç³»åˆ—ï¼ˆäº”ï¼‰" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/4a7ff1c942e5461c96528277a1df87d8 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4baa49fe.html title="Rasa å…¥é–€æ•™ç¨‹ Core ç³»åˆ—ï¼ˆäº”ï¼‰">Rasa å…¥é–€æ•™ç¨‹ Core ç³»åˆ—ï¼ˆäº”ï¼‰</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d7a16af3.html alt="ä¸‰æ˜Ÿ One UI 3.0 ç¾å·²æ¨é€ï¼Œé¦–æ‰¹ 3000 åé¡å·²ç„¡" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/f17b08620c7b4feeaf0bf7a65f6cc2eb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d7a16af3.html title="ä¸‰æ˜Ÿ One UI 3.0 ç¾å·²æ¨é€ï¼Œé¦–æ‰¹ 3000 åé¡å·²ç„¡">ä¸‰æ˜Ÿ One UI 3.0 ç¾å·²æ¨é€ï¼Œé¦–æ‰¹ 3000 åé¡å·²ç„¡</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/23830dc1.html alt=".Neté›¶åŸºç¤ç ´è§£æ•™ç¨‹ â€”â€” ç¬¬äºŒèª²ï¼ˆç²å¾—è¨»å†Šç¢¼ï¼‰" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/32ef6e163f064d13806698d45a73b14c style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/23830dc1.html title=".Neté›¶åŸºç¤ç ´è§£æ•™ç¨‹ â€”â€” ç¬¬äºŒèª²ï¼ˆç²å¾—è¨»å†Šç¢¼ï¼‰">.Neté›¶åŸºç¤ç ´è§£æ•™ç¨‹ â€”â€” ç¬¬äºŒèª²ï¼ˆç²å¾—è¨»å†Šç¢¼ï¼‰</a></li><hr></ul></section><section class=widget><h3 class=widget-title>å…¶ä»–</h3><ul class=widget-list><li><a href=TOS.html>ä½¿ç”¨æ¢æ¬¾</a></li><li><a href=CommentPolicy.html>ç•™è¨€æ”¿ç­–</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>è¯çµ¡æˆ‘å€‘</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>æå®¢å¿«è¨Š</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>