<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>分佈式文件系統FastDFS安裝部署(高可用) | 极客快訊</title><meta property="og:title" content="分佈式文件系統FastDFS安裝部署(高可用) - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="https://p9.pstatp.com/large/pgc-image/cb2346c189b7453fa0d3b98ad3c71cee"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ff3705fd.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ff3705fd.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ff3705fd.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ff3705fd.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ff3705fd.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ff3705fd.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e7%a7%91%e6%8a%80/ff3705fd.html><link rel=canonical href=https://geekbank.cf/tw/%e7%a7%91%e6%8a%80/ff3705fd.html><meta property="article:published_time" content="2020-11-14T21:03:23+08:00"><meta property="article:modified_time" content="2020-11-14T21:03:23+08:00"><meta name=Keywords content><meta name=description content="分佈式文件系統FastDFS安裝部署(高可用)"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E7%A7%91%E6%8A%80/ff3705fd.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>分佈式文件系統FastDFS安裝部署(高可用)</h1></header><date class="post-meta meta-date">2020-11-14</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E7%A7%91%E6%8A%80.html>科技</a></span></div><div class=post-content><p>本文會搭建一個適合低業務訪問業務量的高可用的FastDFS集群環境：兩個Tracker服務，一個storage group中兩個storage服務節點；該方案僅適用於業務訪問量較低的環境下。對於大量業務系統的高併發訪問，為了保證存儲系統正常工作一般的架構思路：安裝多個Tracker服務(至少兩個，根據業務量調整)，搭建多個storage group(至少兩個，根據業務量調整)，每個storage group中多個storage node(至少兩個，做數據的冗餘備份，進行容災機制，而且node必須在不同的機器上)</p><p><strong>一、FastDFS簡介</strong></p><p>FastDFS是一個開源的輕量級分佈式文件系統，它對文件進行管理，功能包括：文件存儲、文件同步、文件訪問（文件上傳、文件下載）等，解決了大容量存儲和負載均衡的問題。特別適合以文件為載體的在線服務，如相冊網站、視頻網站等等。</p><p>FastDFS為互聯網量身定製，充分考慮了冗餘備份、負載均衡、線性擴容等機制，並注重高可用、高性能等指標，使用FastDFS很容易搭建一套高性能的文件服務器集群提供文件上傳、下載等服務。</p><p>FastDFS服務端有兩個角色：跟蹤器（tracker）和存儲節點（storage）。跟蹤器主要做調度工作，在訪問上起負載均衡的作用。</p><p>存儲節點存儲文件，完成文件管理的所有功能：就是這樣的存儲、同步和提供存取接口，FastDFS同時對文件的metadata進行管理。所謂文件的meta data就是文件的相關屬性，以鍵值對（key value）方式表示，如：width=1024，其中的key為width，value為1024。文件metadata是文件屬性列表，可以包含多個鍵值對。</p><p>跟蹤器和存儲節點都可以由一臺或多臺服務器構成。跟蹤器和存儲節點中的服務器均可以隨時增加或下線而不會影響線上服務。其中跟蹤器中的所有服務器都是對等的，可以根據服務器的壓力情況隨時增加或減少。</p><p>為了支持大容量，存儲節點（服務器）採用了分卷（或分組）的組織方式。存儲系統由一個或多個卷組成，卷與卷之間的文件是相互獨立的，所有卷的文件容量累加就是整個存儲系統中的文件容量。一個卷可以由一臺或多臺存儲服務器組成，一個卷下的存儲服務器中的文件都是相同的，卷中的多臺存儲服務器起到了冗餘備份和負載均衡的作用。</p><p>在卷中增加服務器時，同步已有的文件由系統自動完成，同步完成後，系統自動將新增服務器切換到線上提供服務。</p><p>當存儲空間不足或即將耗盡時，可以動態添加捲。只需要增加一臺或多臺服務器，並將它們配置為一個新的卷，這樣就擴大了存儲系統的容量。</p><p>FastDFS中的文件標識分為兩個部分：卷名和文件名，二者缺一不可。</p><p>———簡介摘自百度百科</p><p><strong>二、FastDFS原理介紹</strong></p><p>1.文件上傳</p><p>FastDFS以客戶端庫的方式提供基本的文件訪問接口如upload、download、append、delete等，Storage 服務會定時的向Tracker服務發送自己的存儲信息。當Tracker 服務集群中的Tracker 服務是多個時，各個Tracker服務之間的關係是對等的，因此客戶端上傳時會任意選擇一個Trackre服務。當Tracker服務收到客戶端上傳文件請求時，會為該文件分配一個可以存儲文件的group，當選定了group後就要決定給客戶端分配group中的哪一個storage服務。當分配好storage 服務後，客戶端向storage發送寫文件請求，storage將會為文件分配一個數據存儲目錄。然後為文件分配一個文件ID標示，然後根據以上的信息生成文件名存儲文件。</p><p>2.文件同步</p><p>上傳文件後，客戶端將文件寫到group內的一個storage 服務即為上傳文件成功，storage服務寫完文件後，會由後臺線程將文件同步至同group內的其他的storage 服務節點上。 每個storage服務寫文件後，會同時寫一份binlog，binlog裡不包含文件數據，只包含文件名等元信息，這份binlog用於後臺同步，storage會記錄向group內其他storage同步的進度，以便重啟後能接上次的進度繼續同步；進度以時間戳的方式進行記錄，所以最好能保證集群內的所有server的始終保持同步。最後Storage服務的同步進度會作為元數據的一部分彙報到tracker服務上，tracker服務在選擇讀storage的時候會以同步進度作為參考指標。</p><p>3.下載文件</p><p>當下載文件時，客戶端先詢問tracker服務下載文件的storage，參數為文件標識（卷名和文件名）；然後tracker向客戶端返回一臺可用的storage；最後客戶端直接和storage通訊完成文件下載。</p><p><strong>三、部署環境準備</strong></p><p>1.環境說明</p><p>操作系統CentOS7.6</p><p>fastdfs版本：6.01</p><p>nginx版本：1.16.1</p><p>keepalived版本：2.0.19</p><p>2.系統依賴</p><p>gcc gcc-c++ perl pcre pcre-devel zlib zlib-devel openssl openssl-devel</p><p>3.軟件環境</p><p>libevent下載地址：http://libevent.org/</p><p>nginx下載地址：http://nginx.org/en/download.html</p><p>keepalived下載地址：https://www.keepalived.org/software/</p><p>fastdfs下載地址：https://github.com/happyfish100/fastdfs/releases</p><p>libfasttcommon下載地址：https://github.com/happyfish100/libfastcommon/releases</p><p>fastdfs-nginx-module下載地址：https://github.com/happyfish100/fastdfs-nginx-module/releases</p><p>4.機器及網絡環境規劃</p><pre>Fdfs Server VIP： 192.168.100.110Tracker Server1： 192.168.100.111Tracker Server2： 192.168.100.112Storage Group1 Node1： 192.168.100.111Storage Group1 Node2： 192.168.100.112</pre><p>5.防火牆設置</p><p>關閉系統防火牆：sudo systemctl stop firewalld && systemctl disable firewalld</p><p><strong>四、Keepalived服務安裝配置</strong></p><p>1.下載Keepalived源碼包</p><p>官網地址：https://www.keepalived.org/</p><p>下載地址：https://www.keepalived.org/software/keepalived-2.0.19.tar.gz</p><p>2.上傳並解壓Keepalived源碼包</p><p>tar -zxvf keepalived-2.0.19.tar.gz</p><p>3.編譯Keepalived準備</p><p>進入解壓目錄：cd keepalived-2.0.19</p><p>執行編譯準備：./configure --prefix=/work/keepalived</p><p>注意：一定要有gcc和openssl編譯相關的依賴</p><p>4.編譯安裝Keepalived</p><p>make && make install</p><p>5.安裝配置Keepalived</p><p>keepalived啟動時會從/etc/keepalived/中相關的目錄下查找keepalived.conf配置文件，因此將keepalived安裝錄/usr/local/keepalived/etc/keepalived.conf 拷貝到/etc/keepalived/中。</p><p>mkdir /etc/keepalived/</p><p>cp /work/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf</p><p>cp /work/keepalived/etc/sysconfig/keepalived /etc/sysconfig/keepalived</p><p>6.設置Keepalived開機啟動項</p><p>systemctl enable keepalived</p><p>然後就能使用systemctl start/stop/status keepalived管理keepalived了</p><p>7.配置Keepalived服務</p><p>192.168.100.111機器上配置：vi /etc/keepalived/keepalived.conf</p><pre>vrrp_script check_nginx { interval 3 script "/work/script/check_nginx.sh"} vrrp_instance fdfs_server { state MASTER interface enp0s3 virtual_router_id 110 priority 100 advert_int 3 authentication { auth_type PASS auth_pass password } virtual_ipaddress { 192.168.100.110 } track_script { check_nginx }}</pre><p>192.168.100.112機器上配置：vi /etc/keepalived/keepalived.conf</p><pre>vrrp_script check_nginx { interval 3 script "/work/script/check_nginx.sh"} vrrp_instance fdfs_server { state BACKUP interface enp0s3 virtual_router_id 110 priority 90 advert_int 3 authentication { auth_type PASS auth_pass password } virtual_ipaddress { 192.168.100.110 } track_script { check_nginx }}</pre><p>8.編寫nginx服務檢測腳本</p><p>vi /work/script/check_nginx.sh</p><pre>#!/bin/bashactive_status=`netstat -lntp|grep nginx|wc -l`if [ $active_status -gt 0 ]; then exit 0else exit 1fi</pre><p>然後給腳本賦予執行權限：chmod +x /work/script/check_nginx.sh</p><p>9.修改內核參數</p><p>vi /etc/sysctl.conf</p><p>增加如下內容：</p><pre>net.ipv4.ip_nonlocal_bind = 1 #允許忽視VIP的存在net.ipv4.ip_forward = 1 #允許轉發</pre><p>sysctl --system 使配置生效</p><p><strong>五、安裝FastDFS依賴庫</strong></p><p>1.安裝libevent依賴</p><p>解壓libevent源碼包：tar -zxvf libevent-2.1.11-stable.tar.gz</p><p>進入源碼目錄：cd libevent-2.1.11-stable</p><p>編譯安裝前配置：./configure</p><p>編譯安裝：make && make install</p><p>默認安裝位置：/usr/local/lib</p><p>2.安裝libfasttcommon依賴</p><p>解壓libfasttcommon源碼包：tar -zxvf libfastcommon-1.0.41.tar.gz</p><p>進入源碼目錄：cd libfastcommon-1.0.41</p><p>編譯安裝：./make.sh && ./make.sh install</p><p>默認安裝位置：/usr/lib64</p><p><strong>六、安裝部署Tracker服務和Storage服務</strong></p><p>1.安裝fastdfs服務</p><p>解壓fastdfs源碼包：tar -zxvf fastdfs-6.01.tar.gz</p><p>進入fastdfs源碼包：cd fastdfs-6.01</p><p>編譯安裝：./make.sh && ./make.sh install</p><p>2.fastdfs服務目錄信息</p><p>安裝完成後服務及腳本拷貝到/usr/bin 目錄，配置文件拷貝到/etc/fdfs目錄，啟動腳本拷貝到/etc/init.d/目錄</p><p>3.註冊開機啟動</p><p>chkconfig --add fdfs_trackerd</p><p>chkconfig fdfs_trackerd on</p><p>chkconfig --add fdfs_storaged</p><p>chkconfig fdfs_storaged on</p><p>4.數據目錄規劃</p><p>創建fdfs數據主目錄：mkdir /work/fdfs</p><p>創建tracker數據目錄：mkdir /work/fdfs/tracker</p><p>創建storage數據目錄：mkdir /work/fdfs/storage</p><p>5.配置tracker服務</p><p>將/etc/fdfs目錄下的tracker.conf.sample改為tracker.conf：mv tracker.conf.sample tracker.conf修改內容如下：</p><p>將base_path=/home/yuqing/fastdfs 改為：/work/fdfs/tracker(該目錄為上面定義創建)</p><p>啟動Tracker服務：systemctl start fdfs_trackerd</p><p>6.配置storage服務</p><p>將/etc/fdfs目錄下的storage.conf.sample改為storage.conf：mv storage.conf.sample storage.conf修改內容如下：</p><p>base_path=/home/yuqing/fastdfs 改為：base_path=/work/fdfs/storage(該目錄為上面定義創建)</p><p>store_path0=/home/yuqing/fastdfs 改為：store_path0=/work/fdfs/storage(該目錄為上面定義創建)</p><p>tracker_server=192.168.209.121:22122 改為：tracker_server=192.168.100.111:22122和tracker_server=192.168.100.112:22122</p><p>將/etc/fdfs/torage_ids.conf.sample 為storage_ids.conf，內容修改為當前group的storage節點信息：</p><p>100001 group1 192.168.100.111</p><p>100002 group1 192.168.100.112</p><p>啟動Storage服務：systemctl start fdfs_storaged</p><p><strong>七、Nginx服務安裝配置</strong></p><p>1.下載Nginx源碼包</p><p>官網地址：http://nginx.org/</p><p>下載地址：http://nginx.org/en/download.html</p><p>2.上傳並解壓Nginx源碼包及fastdfs插件包</p><p>tar -zxvf nginx-1.16.1.tar.gz</p><p>tar -zxvf fastdfs-nginx-module-1.21.tar.gz</p><p>3.編譯Nginx準備</p><p>進入解壓目錄：cd nginx-1.16.1</p><p>拷貝fastdfs插件包到nginx源碼目錄：mv ../fastdfs-nginx-module-1.21 .</p><p>執行編譯準備：./configure --prefix=/work/nginx \--with-stream \--add-module=fastdfs-nginx-module-1.21/src</p><p>注意：一定要有gcc和openssl編譯相關的依賴</p><p>4.編譯安裝Nginx</p><p>make && make install</p><p>5.註冊到系統服務</p><p>vi /usr/lib/systemd/system/nginx.service</p><pre>[Unit]Description=nginxDocumentation=http://nginx.org/en/docs/After=network.target[Service]Type=forkingPIDFile=/work/nginx/logs/nginx.pidExecStartPre=/work/nginx/sbin/nginx -t -c /work/nginx/conf/nginx.confExecStart=/work/nginx/sbin/nginx -c /work/nginx/conf/nginx.confExecReload=/bin/kill -s HUP $MAINPIDExecStop=/bin/kill -s QUIT $MAINPIDPrivateTmp=true[Install]WantedBy=multi-user.target</pre><p>6.設置Nginx開機啟動項</p><p>systemctl enable nginx</p><p>然後就能使用systemctl start/stop/status nginx管理nginx了</p><p>7.修改Nginx配置</p><p>vi /work/nginx/conf/nginx.conf</p><pre>#user nobody;worker_processes 1;#error_log logs/error.log;#error_log logs/error.log notice;#error_log logs/error.log info;#pid logs/nginx.pid;events { worker_connections 1024;}stream { upstream tracker { server 192.168.100.111:22122 weight=1 max_fails=2 fail_timeout=10s; server 192.168.100.112:22122 weight=1 max_fails=2 fail_timeout=10s; } server { listen 7777; proxy_timeout 5m; proxy_pass tracker; proxy_connect_timeout 10s; }}http { include mime.types; default_type application/octet-stream; sendfile on; keepalive_timeout 65; upstream storage { server 192.168.100.111:8888 weight=1 max_fails=2 fail_timeout=10s; server 192.168.100.112:8888 weight=1 max_fails=2 fail_timeout=10s; } server { listen 80; server_name localhost;  location /group1 { proxy_pass http://storage; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; }  error_page 500 502 503 504 /50x.html; location = /50x.html { root html; } } server { listen 8888; server_name localhost; location / { alias /work/fdfs/storage/data/; ngx_fastdfs_module; } }}</pre><p>8.配置nginx的fdfs插件</p><p>將/etc/fdfs下的http.conf.sample和mime.types.sample重命名為：http.conf和mime.types</p><p>將fastdfs-nginx-module-1.21/src下的mod_fastdfs.conf拷貝到/etc/fdfs下</p><p>修改mod_fastdfs.conf如下：</p><p>連接超時時間： connect_timeout=5</p><p>Tracker服務地址：tracker_server=192.168.100.111:22122 和tracker_server=192.168.100.112:22122</p><p>Storage服務端口：storage_server_port=23000</p><p>如果文件ID的uri中包含/group**，則要設置為true：url_have_group_name = true</p><p>Storage配置的store_path0路徑，必須和storage.conf中的一致：store_path0=/work/fdfs/storage</p><p>其他詳細配置如下：</p><pre># connect timeout in seconds# default value is 30sconnect_timeout=5# network recv and send timeout in seconds# default value is 30snetwork_timeout=10# the base path to store log filesbase_path=/work/fdfs/storage# if load FastDFS parameters from tracker server# since V1.12# default value is falseload_fdfs_parameters_from_tracker=true# storage sync file max delay seconds# same as tracker.conf# valid only when load_fdfs_parameters_from_tracker is false# since V1.12# default value is 86400 seconds (one day)storage_sync_file_max_delay = 86400# if use storage ID instead of IP address# same as tracker.conf# valid only when load_fdfs_parameters_from_tracker is false# default value is false# since V1.13use_storage_id = false# specify storage ids filename, can use relative or absolute path# same as tracker.conf# valid only when load_fdfs_parameters_from_tracker is false# since V1.13storage_ids_filename = storage_ids.conf# FastDFS tracker_server can ocur more than once, and tracker_server format is# "host:port", host can be hostname or ip address# valid only when load_fdfs_parameters_from_tracker is truetracker_server=192.168.100.111:22122tracker_server=192.168.100.112:22122# the port of the local storage server# the default value is 23000storage_server_port=23000# the group name of the local storage servergroup_name=group1# if the url / uri including the group name# set to false when uri like /M00/00/00/xxx# set to true when uri like ${group_name}/M00/00/00/xxx, such as group1/M00/xxx# default value is falseurl_have_group_name = true# path(disk or mount point) count, default value is 1# must same as storage.confstore_path_count=1# store_path#, based 0, if store_path0 not exists, it's value is base_path# the paths must be exist# must same as storage.confstore_path0=/work/fdfs/storage# standard log level as syslog, case insensitive, value list:### emerg for emergency### alert### crit for critical### error### warn for warning### notice### info### debuglog_level=info# set the log filename, such as /usr/local/apache2/logs/mod_fastdfs.log# empty for output to stderr (apache and nginx error_log file)log_filename=# response mode when the file not exist in the local file system## proxy: get the content from other storage server, then send to client## redirect: redirect to the original storage server (HTTP Header is Location)response_mode=proxy# the NIC alias prefix, such as eth in Linux, you can see it by ifconfig -a# multi aliases split by comma. empty value means auto set by OS type# this paramter used to get all ip address of the local host# default values is emptyif_alias_prefix=# use "#include" directive to include HTTP config file# NOTE: #include is an include directive, do NOT remove the # before include#include http.conf# if support flv# default value is false# since v1.15flv_support = true# flv file extension name# default value is flv# since v1.15flv_extension = flv# set the group count# set to none zero to support multi-group on this storage server# set to 0 for single group only# groups settings section as [group1], [group2], ..., [groupN]# default value is 0# since v1.14group_count = 1# group settings for group #1# since v1.14# when support multi-group on this storage server, uncomment following section[group1]group_name=group1storage_server_port=23000store_path_count=1store_path0=/work/fdfs/storage# group settings for group #2# since v1.14# when support multi-group, uncomment following section as neccessary#[group2]#group_name=group2#storage_server_port=23000#store_path_count=1#store_path0=/home/yuqing/fastdfs</pre><p><strong>八、服務啟動及驗證</strong></p><p>分別啟動keepalive、nginx、tracker、storage服務</p><p>查看服務是否正常服務：</p><div class=pgc-img><img alt=分佈式文件系統FastDFS安裝部署(高可用) onerror=errorimg.call(this); src=https://p9.pstatp.com/large/pgc-image/cb2346c189b7453fa0d3b98ad3c71cee><p class=pgc-img-caption></p></div><p>在任意Storage機器上查看集群狀態：fdfs_monitor /etc/fdfs/storage.conf</p><div class=pgc-img><img alt=分佈式文件系統FastDFS安裝部署(高可用) onerror=errorimg.call(this); src=https://p3.pstatp.com/large/pgc-image/9158363a50154d49b8f9d41648645e25><p class=pgc-img-caption></p></div><p><strong>九、Java客戶端測試</strong></p><p>1.java項目Maven依賴</p><pre>項目地址：https://github.com/tobato/FastDFS_Client目前客戶端主要依賴於SpringBoot，因此必須引入:&lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.0.0.RELEASE&lt;/version&gt; &lt;relativePath/&gt;&lt;/parent&gt;FastDFS 依賴包：&lt;dependency&gt; &lt;groupId&gt;com.github.tobato&lt;/groupId&gt; &lt;artifactId&gt;fastdfs-client&lt;/artifactId&gt; &lt;version&gt;1.26.7&lt;/version&gt;&lt;/dependency&gt;將FastDFS引入項目：@Import(FdfsClientConfig.class)在application.yml當中配置Fdfs相關參數：fdfs: pool: #連接池最大數量 max-total: 200 #每個tracker地址的最大連接數 max-total-per-key: 50 #連接耗盡時等待獲取連接的最大毫秒數 max-wait-millis: 5000 so-timeout: 1500 connect-timeout: 600 thumb-image: width: 150 height: 150 tracker-list: - 192.168.100.110:7777或者fdfs: pool: #連接池最大數量 max-total: 200 #每個tracker地址的最大連接數 max-total-per-key: 50 #連接耗盡時等待獲取連接的最大毫秒數 max-wait-millis: 5000 so-timeout: 1500 connect-timeout: 600 thumb-image: width: 150 height: 150 tracker-list: - 192.168.100.111:22122 - 192.168.100.112:22122使用接口服務對Fdfs服務端進行操作，主要接口包括：TrackerClient - TrackerServer接口GenerateStorageClient - 一般文件存儲接口 (StorageServer接口)FastFileStorageClient - 為方便項目開發集成的簡單接口(StorageServer接口)AppendFileStorageClient - 支持文件續傳操作的接口 (StorageServer接口)</pre><p>2.代碼測試</p><pre>package com.maxbill;import com.github.tobato.fastdfs.FdfsClientConfig;import com.github.tobato.fastdfs.domain.fdfs.MetaData;import com.github.tobato.fastdfs.domain.fdfs.StorePath;import com.github.tobato.fastdfs.domain.proto.storage.DownloadByteArray;import com.github.tobato.fastdfs.service.FastFileStorageClient;import lombok.extern.log4j.Log4j2;import org.apache.commons.lang3.StringUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Import;import org.springframework.stereotype.Component;import javax.annotation.PostConstruct;import java.io.File;import java.io.FileInputStream;import java.text.DateFormat;import java.text.SimpleDateFormat;import java.util.*;@Log4j2@Component@Import(FdfsClientConfig.class)public class FdfsClientUtil { private static final String BASE_URL = "http://192.168.100.110:8888/"; @Autowired private FastFileStorageClient storageClient; private static FdfsClientUtil fdfsClientUtil; @PostConstruct public void init() { fdfsClientUtil = this; } /** * 文件上傳 * * @param file 文件信息 * @param infoMap 文件擴展信息 * @return 上傳路徑 */ public static Map&lt;String, Object&gt; uploadFile(File file, Map&lt;String, String&gt; infoMap) { try { String fileName = file.getName(); String fileType = fileName.substring(fileName.lastIndexOf("\\") + 1); //String fileType = FilenameUtils.getExtension(file.getName()) log.info("[fdfs-upload]-start upload file ... "); log.info("[fdfs-upload]-request upload file name: {}", fileName); log.info("[fdfs-upload]-request upload file info: {}", infoMap); StorePath path = fdfsClientUtil.storageClient.uploadFile(new FileInputStream(file), file.length(), fileType, getMetaData(infoMap)); log.info("[fdfs-upload]-upload success path: {}", path.getFullPath()); return getResultMap(BASE_URL.concat(path.getFullPath()), null); } catch (Exception e) { log.error("[fdfs-upload]-upload file exception info: {}", e.getMessage()); return getResultMap(null, e.getMessage()); } } /** * 下載文件 * * @param filePath 文件路徑標識 * @return 文件字節 */ public static Map&lt;String, Object&gt; downloadFile(String filePath) { try { filePath = filePath.replace(BASE_URL, ""); StorePath storePath = StorePath.parseFromUrl(filePath); String group = storePath.getGroup(); String path = storePath.getPath(); log.info("[fdfs-download]-start download file ... "); log.info("[fdfs-download]-request download file group: {}", group); log.info("[fdfs-download]-request download file path: {}", path); byte[] data = fdfsClientUtil.storageClient.downloadFile(group, path, new DownloadByteArray()); log.info("[fdfs-download]-request download file success ... "); return getResultMap(data, null); } catch (Exception e) { log.error("[fdfs-download]-download file exception info: {}", e.getMessage()); return getResultMap(null, e.getMessage()); } } /** * 刪除文件 * * @param filePath 文件路徑標識 * @return 操作結果 */ public static boolean deleteFile(String filePath) { try { filePath = filePath.replace(BASE_URL, ""); StorePath storePath = StorePath.parseFromUrl(filePath); String group = storePath.getGroup(); String path = storePath.getPath(); log.info("[fdfs-delete]-start delete file ... "); log.info("[fdfs-delete]-request delete file group: {}", group); log.info("[fdfs-delete]-request delete file path: {}", path); fdfsClientUtil.storageClient.deleteFile(storePath.getGroup(), storePath.getPath()); log.info("[fdfs-delete]-request delete file success ... "); return true; } catch (Exception e) { log.error("[fdfs-delete]-delete file exception info: {}", e.getMessage()); return false; } } /** * 查看文件元信息 * * @param filePath 文件路徑標識 * @return 文件信息 */ public static Map&lt;String, Object&gt; getFileInfo(String filePath) { try { filePath = filePath.replace(BASE_URL, ""); StorePath storePath = StorePath.parseFromUrl(filePath); String group = storePath.getGroup(); String path = storePath.getPath(); log.info("[fdfs-meta]-start meta file ... "); log.info("[fdfs-meta]-request meta file group: {}", group); log.info("[fdfs-meta]-request meta file path: {}", path); Map&lt;String, String&gt; infoMap = new HashMap&lt;&gt;(); infoMap.put("createPath", filePath); Set&lt;MetaData&gt; metaData = fdfsClientUtil.storageClient.getMetadata(storePath.getGroup(), storePath.getPath()); log.info("[fdfs-meta]-request meta file success ... "); if (null != metaData &amp;&amp; !metaData.isEmpty()) { metaData.forEach(meta -&gt; { infoMap.put(meta.getName(), meta.getValue()); }); } return getResultMap(infoMap, null); } catch (Exception e) { log.error("[fdfs-meta]-meta file exception info: {}", e.getMessage()); return getResultMap(null, e.getMessage()); } } /** * 封裝附件元信息 * * @param infoMap 自定義數據 * @return 附件元信息 */ private static Set&lt;MetaData&gt; getMetaData(Map&lt;String, String&gt; infoMap) { if (null != infoMap &amp;&amp; !infoMap.isEmpty()) { Set&lt;MetaData&gt; metaDataSet = new HashSet&lt;&gt;(); for (String key : infoMap.keySet()) { metaDataSet.add(new MetaData(key, infoMap.get(key))); } return metaDataSet; } else { DateFormat df = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"); Set&lt;MetaData&gt; metaDataSet = new HashSet&lt;&gt;(); metaDataSet.add(new MetaData("createUser", "MaxBill")); metaDataSet.add(new MetaData("createDate", df.format(new Date()))); return metaDataSet; } } /** * 封裝結果信息 * * @param data 數據 * @param info 信息 * @return 操作結果 */ private static Map&lt;String, Object&gt; getResultMap(Object data, String info) { Map&lt;String, Object&gt; resultMap = new HashMap&lt;&gt;(); if (StringUtils.isEmpty(info)) { resultMap.put("flag", true); resultMap.put("data", data); resultMap.put("info", "success"); } else { resultMap.put("flag", false); resultMap.put("info", info); resultMap.put("data", null); } return resultMap; }}</pre><p><br></p><p>來源：開源中國</p><p>原文：https://my.oschina.net/zss1993/blog/3131684</p></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>系統</a></li><li><a>FastDFS</a></li><li><a>安裝</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/6a888def.html alt="推薦分佈式文件系統 FastDFS" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ec0369a50bef43748d07ab58f99b6056 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/6a888def.html title="推薦分佈式文件系統 FastDFS">推薦分佈式文件系統 FastDFS</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/89d62274.html alt="FastDFS 分佈式文件系統詳解" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/f75efb8752b74ea384109115f7d8c4f6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/89d62274.html title="FastDFS 分佈式文件系統詳解">FastDFS 分佈式文件系統詳解</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/f9a6017f.html alt=一文搞定分佈式文件系統FastDFS class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/c4fc524877574c51905170a1f43effdb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f9a6017f.html title=一文搞定分佈式文件系統FastDFS>一文搞定分佈式文件系統FastDFS</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0bc3d310.html alt="最近都說像“復活”了一般，FastDFS 6.05 發佈，分佈式文件系統" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0bc3d310.html title="最近都說像“復活”了一般，FastDFS 6.05 發佈，分佈式文件系統">最近都說像“復活”了一般，FastDFS 6.05 發佈，分佈式文件系統</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/11f7a1e.html alt=如何用U盤自己安裝計算機操作系統（最詳細的新手DIY操作手冊） class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/703d742a-d309-4fe5-b886-2548c5fbee85 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/11f7a1e.html title=如何用U盤自己安裝計算機操作系統（最詳細的新手DIY操作手冊）>如何用U盤自己安裝計算機操作系統（最詳細的新手DIY操作手冊）</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e151d2c.html alt=如何硬盤安裝系統 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/b6cb8f7cd99c4927874577bdd60fe5e3 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e151d2c.html title=如何硬盤安裝系統>如何硬盤安裝系統</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/832e28e.html alt=新手必須知道的操作系統的安裝方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/68f0ed227a2a482580c78d2a24e3cb7b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/832e28e.html title=新手必須知道的操作系統的安裝方法>新手必須知道的操作系統的安裝方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/08feb79.html alt=安裝操作系統必須的硬盤分區知識，你瞭解多少 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/d7ac9f5df37b45af956dd0f9a830d277 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/08feb79.html title=安裝操作系統必須的硬盤分區知識，你瞭解多少>安裝操作系統必須的硬盤分區知識，你瞭解多少</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d3bdf8e.html alt=戶用光伏系統安裝過程中的關鍵點彙總 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d3bdf8e.html title=戶用光伏系統安裝過程中的關鍵點彙總>戶用光伏系統安裝過程中的關鍵點彙總</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4d24040.html alt=液壓系統回油管的安裝 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/9ec10809204347a0b835e43f0fed4f35 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4d24040.html title=液壓系統回油管的安裝>液壓系統回油管的安裝</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/98b788e.html alt=Linux系統安裝多個桌面環境有幫助嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/ffd1b067fd4f4d45bc9c2bf098a7ed4b style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/98b788e.html title=Linux系統安裝多個桌面環境有幫助嗎？>Linux系統安裝多個桌面環境有幫助嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E5%AD%B8/d67e059.html alt=電子系統的安裝、調試方法 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/206a1353-8c17-4799-ba5b-adcdabc7aff5 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E5%AD%B8/d67e059.html title=電子系統的安裝、調試方法>電子系統的安裝、調試方法</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ea18613.html alt=我被安裝了貧窮版“操作系統”，難怪越努力、越貧窮！ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/8d9f5303-2ba0-478e-9525-01eb09914e16 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ea18613.html title=我被安裝了貧窮版“操作系統”，難怪越努力、越貧窮！>我被安裝了貧窮版“操作系統”，難怪越努力、越貧窮！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/9b12202.html alt=中央除塵系統的安裝注意事項大詳解，中央除塵系統知識要知道 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/154031713807410963a6e06 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/9b12202.html title=中央除塵系統的安裝注意事項大詳解，中央除塵系統知識要知道>中央除塵系統的安裝注意事項大詳解，中央除塵系統知識要知道</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/041eb04f.html alt=阿里雲服務器快速建網站_安裝BT寶塔面板和wordpress class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/f2aaf81828344428b39b2102e2a62c2a style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/041eb04f.html title=阿里雲服務器快速建網站_安裝BT寶塔面板和wordpress>阿里雲服務器快速建網站_安裝BT寶塔面板和wordpress</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>