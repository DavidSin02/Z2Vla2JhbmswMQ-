<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>Redis進階：Redis+Lua腳本實現複雜操作 | 极客快訊</title><meta property="og:title" content="Redis進階：Redis+Lua腳本實現複雜操作 - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content="http://p1.pstatp.com/large/pgc-image/1ce66414910c4b3c819d72783f88b8a6"><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e9%81%8a%e6%88%b2/aac2f97.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e9%81%8a%e6%88%b2/aac2f97.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e9%81%8a%e6%88%b2/aac2f97.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e9%81%8a%e6%88%b2/aac2f97.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e9%81%8a%e6%88%b2/aac2f97.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e9%81%8a%e6%88%b2/aac2f97.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e9%81%8a%e6%88%b2/aac2f97.html><link rel=canonical href=https://geekbank.cf/tw/%e9%81%8a%e6%88%b2/aac2f97.html><meta property="article:published_time" content="2020-10-29T20:46:28+08:00"><meta property="article:modified_time" content="2020-10-29T20:46:28+08:00"><meta name=Keywords content><meta name=description content="Redis進階：Redis+Lua腳本實現複雜操作"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E9%81%8A%E6%88%B2/aac2f97.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Redis進階：Redis+Lua腳本實現複雜操作</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E9%81%8A%E6%88%B2.html>遊戲</a></span></div><div class=post-content><div><h1>一、引言</h1><p>Redis是高性能的key-value數據庫，在很大程度克服了memcached這類key/value存儲的不足，在部分場景下，是對關係數據庫的良好補充。得益於超高性能和豐富的數據結構，Redis已成為當前架構設計中的首選key-value存儲系統。</p><p>雖然Redis官網上提供了200多個命令，但做程序設計時還是避免不了為了實現一小步業務邏輯而多次調用Redis的情況。</p><p>以compare and set場景為例。如果使用Redis原生命令，需要從Redis中獲取這個key，然後提取其中的值進行比對：如果相等就不做處理；如果不相等或者key不存在則將key設置成目標值。僅僅一個單點的compare and set操作就需要與Redis通訊兩次。</p><p>此外，這種分散操作無法利用Redis的原子特性，佔用多次網絡IO。</p><p>今天我們就來探討一下如何優雅地應對上述場景。</p><h1>二、Redis與Lua</h1><p>在介紹Lua之前，我們需要先對這個語言有個初步瞭解。Lua 是一個小巧的腳本語言，幾乎可以運行在所有操作系統和平臺上。我們一般不會用Lua處理特別複雜的事務，因此只需瞭解一些lua的基本語法即可。</p><p>Redis問世之後，其開發者也意識到了開篇提到的問題，因此Redis從2.6版本開始支持Lua腳本。新版本的Redis還支持Lua Script debug，感興趣的小夥伴可以去官網的Documentation中找到對應介紹和QuickStart。</p><p>有了Lua腳本之後，使用Redis程序時便能夠在以下方面實現顯著提升：</p><ul><li>減少網絡開銷：本來N次網絡請求的操作，可以用一個請求完成。原先N次請求的邏輯放在Redis服務器上完成，減少了網絡往返時延；</li><li>原子操作：Redis會將整個腳本作為一個整體執行，中間不會被其他命令插入。這是一個重要特性，一定要拿小本本記好。至於為什麼是一個原子操作，我們以後再分析；</li><li>複用：客戶端發送的腳本會永久存儲在Redis中。這樣其他客戶端就可以複用這一腳本，而不需要使用代碼完成同樣的邏輯。</li></ul><p>所以現在流傳一句話：要想學好Redis，必會Lua Script。</p><h1>三、通過Lua腳本實現compare and set</h1><p>接下來我們就實現一個簡單的compare and set，並通過這個例子感受一下Lua腳本給Redis使用帶來的全新體驗。</p><p>首先看一下如何讓Redis執行Lua腳本。</p><p><strong>3.1 Redis的EVAL</strong></p><pre>Redis 127.0.0.1:6379&gt; EVAL script numkeys key [key ...] arg [arg ...]</pre><ul><li>script： 參數是一段 Lua 5.1 腳本程序。腳本不必(也不應該)定義為一個Lua函數。</li><li>numkeys： 用於指定鍵名參數的個數。</li><li>key [key ...]： 從 EVAL 的第三個參數開始算起，表示在腳本中所用到的Redis鍵(key)。在Lua中，這些鍵名參數可以通過全局變量 KEYS 數組，用1為基址的形式訪問( KEYS[1] ，KEYS[2]，依次類推)。</li><li>arg [arg ...]： 附加參數，在Lua中通過全局變量ARGV數組訪問，訪問的形式和KEYS變量類似( ARGV[1] 、 ARGV[2] ，諸如此類)。</li></ul><p>這裡借用一下官網的例子。</p><div class=pgc-img><img alt=Redis進階：Redis+Lua腳本實現複雜操作 onerror=errorimg.call(this); src=http://p1.pstatp.com/large/pgc-image/1ce66414910c4b3c819d72783f88b8a6><p class=pgc-img-caption></p></div><p>上述腳本直接返回了入參。</p><ul><li>eval為Redis關鍵字；</li><li>第一個引號中的內容就是Lua腳本；</li><li>2為參數個數；</li><li>key1和key2是KEYS[1]、KEYS[2]的入參；</li><li>first和second是ARGV[1],ARGV[2]的入參。</li></ul><p>大家可以簡單地將KEYS[1],KEYS[2], ARGV[1],ARGV[2]理解為佔位符。</p><p><strong>3.2 執行腳本文件和緩存腳本</strong></p><p>如果只能在命令行中寫腳本執行，遇到複雜的腳本程序豈不是會抓狂？</p><p>下面我們來看一下，如何讓Redis執行Lua腳本文件，同時也驗證一下lua腳本的複用特性（以後我們再也不需要定期批量刪除某些符合特定規則的key了）。</p><pre>Redis 127.0.0.1:6379&gt; SCRIPT LOAD scriptRedis 127.0.0.1:6379&gt; EVALSHA sha1 numkeys key [key ...] arg [arg ...]</pre><p>Redis提供了一個SCRIPTLOAD命令，命令後面的script即為Lua腳本。命令將腳本script添加到腳本緩存中，但並不立即執行這個腳本。執行命令後，Redis會返回一個SHA1串，第二個EVALSHA命令即可執行。</p><p>需要注意的是，腳本可以在緩存中保留無限長的時間，直到執行完SCRIPT FLUSH。我們來看一下效果。</p><div class=pgc-img><img alt=Redis進階：Redis+Lua腳本實現複雜操作 onerror=errorimg.call(this); src=http://p1.pstatp.com/large/pgc-image/5572cd1784864b4196724ae50e018279><p class=pgc-img-caption></p></div><p>Redis還支持直接執行Lua腳本文件。首先編寫並存儲一個Lua腳本。</p><div class=pgc-img><img alt=Redis進階：Redis+Lua腳本實現複雜操作 onerror=errorimg.call(this); src=http://p1.pstatp.com/large/pgc-image/820e61f36034416a9616510839a5cab8><p class=pgc-img-caption></p></div><p>然後調用Redis-cli –eval命令</p><div class=pgc-img><img alt=Redis進階：Redis+Lua腳本實現複雜操作 onerror=errorimg.call(this); src=http://p1.pstatp.com/large/pgc-image/76a16a53b63341169b5987338c861ab7><p class=pgc-img-caption></p></div><p>Redis-cli –eval命令語法基本與原eval語法相同。</p><p><strong>3.3 使用Lua腳本實現compare and set</strong></p><p>compareand set的實現邏輯是這樣的：首先獲取Redis中指定key的value，然後與給定值進行比較：如果相等，則將key設定為目標值並返回一個標識符；如果不相等，則不作任何操作並返回一個標識符。</p><pre>if Redis.call('get', KEYS[1]) == ARGV[1] then Redis.call('set', KEYS[1], ARGV[2]); return 1else return 0 end</pre><p>下面我們來測試一下這個腳本。</p><p>首先向Redis的指定key compareAndSet:key寫入一個值value</p><div class=pgc-img><img alt=Redis進階：Redis+Lua腳本實現複雜操作 onerror=errorimg.call(this); src=http://p3.pstatp.com/large/pgc-image/48e7687937224425b5a3b2685e793e9e><p class=pgc-img-caption></p></div><p>在Redis中執行lua腳本</p><div class=pgc-img><img alt=Redis進階：Redis+Lua腳本實現複雜操作 onerror=errorimg.call(this); src=http://p3.pstatp.com/large/pgc-image/9637920d1c1b4806acfdcc8a7a6f5f85><p class=pgc-img-caption></p></div><p>可以看到第一次執行返回1，說明修改成功了；再使用原參數執行時返回0，說明沒有做任何修改。我們再查詢一下compareAndSet:key這個key</p><div class=pgc-img><img alt=Redis進階：Redis+Lua腳本實現複雜操作 onerror=errorimg.call(this); src=http://p1.pstatp.com/large/pgc-image/3cc787e1b7414bba805b23284e6a2b65><p class=pgc-img-caption></p></div><p>可以看到compareAndSet:key這個key已經被修改為new_value了。</p><h1>四、總結</h1><p>我們通過lua腳本實現了一個簡單的compareAndSet操作。</p><p>下面我們通過這個例子來驗證一下開篇提到的特性。</p><ul><li>減少網絡開銷：不使用腳本的情況下，我們實現一個compareAndSet至少需要與Redis交互兩次，而現在只需要執行一次操作即可完成；</li><li>原子操作：得益於Redis的設計，Redis會將整個腳本作為一個整體執行，中間不會被其他命令插入。因此在編寫腳本的過程中無需擔心出現競態條件，無需使用事務，感興趣的可以百度或等待以後後續文章更新；</li><li>複用：可以將一系列操作封裝成一個Lua腳本，存儲在文件或Redis上，下次使用時直接調用即可。</li></ul><p>讀到這裡，希望你已經對Redis+Lua有了一定的瞭解，並能使用腳本完成一些簡單的複合操作。後續還會繼續更新一些基於Lua腳本+java程序實現的分佈式數據結構，如延遲隊列、可重入鎖等，感興趣的小夥伴可以持續關注。</p><div class=pgc-img><img alt=Redis進階：Redis+Lua腳本實現複雜操作 onerror=errorimg.call(this); src=http://p1.pstatp.com/large/dfic-imagehandler/26dced71-d81b-4468-b687-58910c3cbb53><p class=pgc-img-caption></p></div><blockquote><p>作者：李崇</p><p>轉自：https://segmentfault.com/a/1190000019994815</p></blockquote></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>Redis</a></li><li><a>進階</a></li><li><a>Lua</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/f22ee5ad.html alt="Redis 設計與實現 : Lua 腳本" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/f22ee5ad.html title="Redis 設計與實現 : Lua 腳本">Redis 設計與實現 : Lua 腳本</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/4e632b6e.html alt=PHP進階教程-PHP的協程怎麼玩？這一篇帶你搞定swoole協程 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/a646cf102cf74b4a953855ebedbc7d29 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/4e632b6e.html title=PHP進階教程-PHP的協程怎麼玩？這一篇帶你搞定swoole協程>PHP進階教程-PHP的協程怎麼玩？這一篇帶你搞定swoole協程</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/cd56e2f3.html alt=PHP進階教程-PHP還能玩多線程？看我怎麼用多線程實現CC攻擊器。 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/cce9b3fb23ce41b88311823510e419da style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/cd56e2f3.html title=PHP進階教程-PHP還能玩多線程？看我怎麼用多線程實現CC攻擊器。>PHP進階教程-PHP還能玩多線程？看我怎麼用多線程實現CC攻擊器。</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/637cf111.html alt=PHP進階教程-phper需要知道常駐內存中的上下文是什麼東西 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/bc66832213514f2996f2e48c9e9cc747 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/637cf111.html title=PHP進階教程-phper需要知道常駐內存中的上下文是什麼東西>PHP進階教程-phper需要知道常駐內存中的上下文是什麼東西</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/e3b6719c.html alt=PHP進階教程-一文理解和實現現代PHP框架裡的IOC容器 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/423ce7eefc5d433f86a14589b1ba0043 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/e3b6719c.html title=PHP進階教程-一文理解和實現現代PHP框架裡的IOC容器>PHP進階教程-一文理解和實現現代PHP框架裡的IOC容器</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/fe9184d7.html alt=PHP進階教程-實現一個簡單的MySQL連接池 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/pgc-image/aa2df096a4274ba1b5c8540bcb5b5c73 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/fe9184d7.html title=PHP進階教程-實現一個簡單的MySQL連接池>PHP進階教程-實現一個簡單的MySQL連接池</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/45c31c17.html alt=PHP進階教程-設計模式之建造者模式 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/ef25f91086df41eca76e35ff3434b003 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/45c31c17.html title=PHP進階教程-設計模式之建造者模式>PHP進階教程-設計模式之建造者模式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b034084e.html alt=PHP進階教程-設計模式之橋接模式 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/3719c139b93342fe9e5526fa59ca1c89 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b034084e.html title=PHP進階教程-設計模式之橋接模式>PHP進階教程-設計模式之橋接模式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/a89954da.html alt=PHP進階教程-設計模式之組合模式 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/6f2acee37d624649ac7a592bfe5b29af style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/a89954da.html title=PHP進階教程-設計模式之組合模式>PHP進階教程-設計模式之組合模式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/baec5ab6.html alt=PHP進階教程-設計模式之裝飾器模式 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8cbbfcfedd544572a62adc6df84d2e60 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/baec5ab6.html title=PHP進階教程-設計模式之裝飾器模式>PHP進階教程-設計模式之裝飾器模式</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/0ef4a8fd.html alt=「網工進階」路由交換：鏈路聚合的配置，你都會嗎 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/f5b7228828484a249973d030a8ae92a6 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/0ef4a8fd.html title=「網工進階」路由交換：鏈路聚合的配置，你都會嗎>「網工進階」路由交換：鏈路聚合的配置，你都會嗎</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c8c89331.html alt=描述統計學上的一些基本概念（二）——投資技能進階 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/dfic-imagehandler/6586a65a-a953-4eae-a29b-ea386ca13f79 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c8c89331.html title=描述統計學上的一些基本概念（二）——投資技能進階>描述統計學上的一些基本概念（二）——投資技能進階</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3d0c5523.html alt=Redis的5種數據類型與編碼結構分析 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/b51e65c8c7cf429aa2911bb775b98cc4 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3d0c5523.html title=Redis的5種數據類型與編碼結構分析>Redis的5種數據類型與編碼結構分析</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/adf558e7.html alt="查看 Golang、Lua、JS、Rust、Python等語言生成的彙編代碼" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/60bc9160b4bd4c319ed419be29146606 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/adf558e7.html title="查看 Golang、Lua、JS、Rust、Python等語言生成的彙編代碼">查看 Golang、Lua、JS、Rust、Python等語言生成的彙編代碼</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/dcba474b.html alt=高併發架構系列：Redis緩存和MySQL數據一致性方案詳解 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/c71c1aad-32fd-4370-a372-8d2231bde9ea style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/dcba474b.html title=高併發架構系列：Redis緩存和MySQL數據一致性方案詳解>高併發架構系列：Redis緩存和MySQL數據一致性方案詳解</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>