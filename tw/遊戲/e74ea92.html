<!doctype html><html lang=tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=dns-prefetch href=https://i.geekbank.cf/><title>認識 MongoDB 4.0 的新特性——事務（Transactions） | 极客快訊</title><meta property="og:title" content="認識 MongoDB 4.0 的新特性——事務（Transactions） - 极客快訊"><meta property="og:type" content="article"><meta property="og:locale" content="tw"><meta property="og:image" content><link rel=alternate hreflang=x-default href=https://geekbank.cf/tw/%e9%81%8a%e6%88%b2/e74ea92.html><link rel=alternate hreflang=zh-tw href=https://geekbank.cf/tw/%e9%81%8a%e6%88%b2/e74ea92.html><link rel=alternate hreflang=zh-cn href=https://geekbank.cf/cn/%e9%81%8a%e6%88%b2/e74ea92.html><link rel=alternate hreflang=zh-hk href=https://geekbank.cf/tw/%e9%81%8a%e6%88%b2/e74ea92.html><link rel=alternate hreflang=zh-mo href=https://geekbank.cf/tw/%e9%81%8a%e6%88%b2/e74ea92.html><link rel=alternate hreflang=zh-my href=https://geekbank.cf/cn/%e9%81%8a%e6%88%b2/e74ea92.html><link rel=alternate hreflang=zh-sg href=https://geekbank.cf/cn/%e9%81%8a%e6%88%b2/e74ea92.html><link rel=canonical href=https://geekbank.cf/tw/%e9%81%8a%e6%88%b2/e74ea92.html><meta property="article:published_time" content="2020-10-29T20:46:29+08:00"><meta property="article:modified_time" content="2020-10-29T20:46:29+08:00"><meta name=Keywords content><meta name=description content="認識 MongoDB 4.0 的新特性——事務（Transactions）"><meta name=author content="极客快訊"><meta property="og:url" content="/tw/%E9%81%8A%E6%88%B2/e74ea92.html"><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffc40d"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://geekbank.cf/css/normalize.css><link rel=stylesheet href=https://geekbank.cf/css/style.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script type=text/javascript src=https://geekbank.cf/js/jqthumb.min.js></script><script data-ad-client=ca-pub-3525055026201463 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><h1><a id=logo href>🤓 极客快訊 Geek Bank</a></h1><p class=description>為你帶來最全的科技知識 🧡</p></div><div><nav id=nav-menu class=clearfix><a class=current href>猜你喜歡</a>
<a href=../../tw/categories/%E7%A7%91%E6%8A%80.html title=科技>科技</a>
<a href=../../tw/categories/%E9%81%8A%E6%88%B2.html title=遊戲>遊戲</a>
<a href=../../tw/categories/%E7%A7%91%E5%AD%B8.html title=科學>科學</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>認識 MongoDB 4.0 的新特性——事務（Transactions）</h1></header><date class="post-meta meta-date">2020-10-29</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=tw/categories/%E9%81%8A%E6%88%B2.html>遊戲</a></span></div><div class=post-content><div><h1><strong>前言</strong></h1><p>相信使用過主流的關係型數據庫的朋友對“事務（Transactions）”不會太陌生，它可以讓我們把對多張表的多次數據庫操作整合為一次原子操作，這在高併發場景下可以保證多個數據操作之間的互不干擾；並且一旦在這些操作過程任一環節中出現了錯誤，事務會中止並且讓數據回滾，這使得同時在多張表中修改數據的時候保證了數據的一致性。</p><p>以前 MongoDB 是不支持事務的，因此開發者在需要用到事務的時候，不得不借用其他工具，在業務代碼層面去彌補數據庫的不足。隨著 4.0 版本的發佈，MongoDB 也為我們帶來了原生的事務操作，下面就讓我們一起來認識它，並通過簡單的例子瞭解如何去使用。</p><h1><strong>介紹</strong></h1><p>事務和副本集（Replica Sets）</p><p>副本集是 MongoDB 的一種主副節點架構，它使數據得到最大的可用性，避免單點故障引起的整個服務不能訪問的情況的發生。目前 MongoDB 的多表事務操作僅支持在副本集上運行，想要在本地環境安裝運行副本集可以藉助一個工具包——run-rs，以下的文章中有詳細的使用說明：</p><blockquote><p>https://thecodebarbarian.com/introducing-run-rs-zero-config-mongodb-runner.html</p></blockquote><p>事務和會話（Sessions）</p><p>事務和會話（Sessions）關聯，一個會話同一時刻只能開啟一個事務操作，當一個會話斷開，這個會話中的事務也會結束。</p><p>事務中的函數</p><ul><li><strong>Session.startTransaction()</strong></li></ul><p>在當前會話中開始一次事務，事務開啟後就可以開始進行數據操作。在事務中執行的數據操作是對外隔離的，也就是說事務中的操作是原子性的。</p><ul><li><strong>Session.commitTransaction()</strong></li></ul><p>提交事務，將事務中對數據的修改進行保存，然後結束當前事務，一次事務在提交之前的數據操作對外都是不可見的。</p><ul><li><strong>Session.abortTransaction()</strong></li></ul><p>中止當前的事務，並將事務中執行過的數據修改回滾。</p><p>重試</p><p>當事務運行中報錯，catch 到的錯誤對象中會包含一個屬性名為 <strong>errorLabels</strong> 的數組，當這個數組中包含以下2個元素的時候，代表我們可以重新發起相應的事務操作。</p><ul><li><strong>TransientTransactionError</strong>：出現在事務開啟以及隨後的數據操作階段</li><li><strong>UnknownTransactionCommitResult</strong>：出現在提交事務階段</li></ul><h1><strong>示例</strong></h1><p>經過上面的鋪墊，你是不是已經迫不及待想知道究竟應該怎麼寫代碼去完成一次完整的事務操作？下面我們就簡單寫一個例子：</p><p><strong>場景描述：</strong>假設一個交易系統中有2張表——記錄商品的名稱、庫存數量等信息的表 commodities，和記錄訂單的表 orders。當用戶下單的時候，首先要找到 commodities 表中對應的商品，判斷庫存數量是否滿足該筆訂單的需求，是的話則減去相應的值，然後在 orders 表中插入一條訂單數據。在高併發場景下，可能在查詢庫存數量和減少庫存的過程中，又收到了一次新的創建訂單請求，這個時候可能就會出問題，因為新的請求在查詢庫存的時候，上一次操作還未完成減少庫存的操作，這個時候查詢到的庫存數量可能是充足的，於是開始執行後續的操作，實際上可能上一次操作減少了庫存後，庫存的數量就已經不足了，於是新的下單請求可能就會導致實際創建的訂單數量超過庫存數量。</p><p>以往要解決這個問題，我們可以用給商品數據“加鎖”的方式，比如基於 Redis 的各種鎖，同一時刻只允許一個訂單操作一個商品數據，這種方案能解決問題，缺點就是代碼更復雜了，並且性能會比較低。如果用數據庫事務的方式就可以簡潔很多：</p><p>commodities 表數據（stock 為庫存）：</p><pre>{ "_id" : ObjectId("5af0776263426f87dd69319a"), "name" : "滅霸原味手套", "stock" : 5 }{ "_id" : ObjectId("5af0776263426f87dd693198"), "name" : "雷神專用鐵錘", "stock" : 2 }</pre><p>orders 表數據：</p><pre>{ "_id" : ObjectId("5af07daa051d92f02462644c"), "commodity": ObjectId("5af0776263426f87dd69319a"), "amount": 2 }{ "_id" : ObjectId("5af07daa051d92f02462644b"), "commodity": ObjectId("5af0776263426f87dd693198"), "amount": 3 }</pre><p>通過一次事務完成創建訂單操作（mongo Shell）：</p><pre>// 執行 txnFunc 並且在遇到 TransientTransactionError 的時候重試function runTransactionWithRetry(txnFunc, session) { while (true) { try { txnFunc(session); // 執行事務 break; } catch (error) { if ( error.hasOwnProperty('errorLabels') &amp;&amp; error.errorLabels.includes('TransientTransactionError') ) { print('TransientTransactionError, retrying transaction ...'); continue; } else { throw error; } } }}// 提交事務並且在遇到 UnknownTransactionCommitResult 的時候重試function commitWithRetry(session) { while (true) { try { session.commitTransaction(); print('Transaction committed.'); break; } catch (error) { if ( error.hasOwnProperty('errorLabels') &amp;&amp; error.errorLabels.includes('UnknownTransactionCommitResult') ) { print('UnknownTransactionCommitResult, retrying commit operation ...'); continue; } else { print('Error during commit ...'); throw error; } } }}// 在一次事務中完成創建訂單操作function createOrder(session) { var commoditiesCollection = session.getDatabase('mall').commodities; var ordersCollection = session.getDatabase('mall').orders; // 假設該筆訂單中商品的數量 var orderAmount = 3; // 假設商品的ID var commodityID = ObjectId('5af0776263426f87dd69319a'); session.startTransaction({ readConcern: { level: 'snapshot' }, writeConcern: { w: 'majority' }, }); try { var { stock } = commoditiesCollection.findOne({ _id: commodityID }); if (stock &lt; orderAmount) { print('Stock is not enough'); session.abortTransaction(); throw new Error('Stock is not enough'); } commoditiesCollection.updateOne( { _id: commodityID }, { $inc: { stock: -orderAmount } } ); ordersCollection.insertOne({ commodity: commodityID, amount: orderAmount, }); } catch (error) { print('Caught exception during transaction, aborting.'); session.abortTransaction(); throw error; } commitWithRetry(session);}// 發起一次會話var session = db.getMongo().startSession({ readPreference: { mode: 'primary' } });try { runTransactionWithRetry(createOrder, session);} catch (error) { // 錯誤處理} finally { session.endSession();}</pre><p>上面的代碼看著感覺很多，其實 runTransactionWithRetry 和 commitWithRetry 這兩個函數都是可以抽離出來成為公共函數的，不需要每次操作都重複書寫。用上了事務之後，因為事務中的數據操作都是一次原子操作，所以我們就不需要考慮分佈併發導致的數據一致性的問題，是不是感覺簡單了許多？</p><p>你可能注意到了，代碼中在執行 startTransaction 的時候設置了兩個參數——readConcern 和 writeConcern，這是 MongoDB 讀寫操作的確認級別，在這裡用於在副本集中平衡數據讀寫操作的可靠性和性能，如果在這裡展開就太多了，所以感興趣的朋友建議去閱讀官方文檔瞭解一下：</p><p><strong>readConcern：</strong></p><p>https://docs.mongodb.com/master/reference/read-concern/</p><p><strong>writeConcern：</strong></p><p>https://docs.mongodb.com/master/reference/write-concern/</p><p>創宇前端/文</p></div></div><div class="post-meta meta-tags"><ul class=clearfix><li><a>認識</a></li><li><a>MongoDB</a></li><li><a>4.0</a></li></ul></div></article></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=搜索>
<input type=hidden name=sitesearch value=geekbank.cf>
<button type=submit>🔍</button></form></section><section class=widget><h3 class=widget-title>最新文章 ⚡</h3><ul class=widget-list><li><a href=../../tw/%E7%A7%91%E6%8A%80/3a2e003a.html alt=你是怎麼認識曼恩的？在老路說車互動平臺感受曼恩魅力 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/cc30aa4b32114cb7aa98314ba1519473 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3a2e003a.html title=你是怎麼認識曼恩的？在老路說車互動平臺感受曼恩魅力>你是怎麼認識曼恩的？在老路說車互動平臺感受曼恩魅力</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/429ef3cd.html alt=認識七天在一起一天，離別時卻是一輩子 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/98e368bb546b47699c3f48c661fa0076 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/429ef3cd.html title=認識七天在一起一天，離別時卻是一輩子>認識七天在一起一天，離別時卻是一輩子</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/aa09bc26.html alt=帶您認識防靜電滾輪的基礎知識！-山西天罡 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/2b8a90d785874d838aa0057c8a5a4ecf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/aa09bc26.html title=帶您認識防靜電滾輪的基礎知識！-山西天罡>帶您認識防靜電滾輪的基礎知識！-山西天罡</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/62f3704c.html alt="哈密 最美的季節重新認識你！" class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/15399338780300ff4260a66 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/62f3704c.html title="哈密 最美的季節重新認識你！">哈密 最美的季節重新認識你！</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b96b5bf9.html alt=如何正確認識Java多態 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/d2896b2f39694d39957b901a62cfe7fb style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b96b5bf9.html title=如何正確認識Java多態>如何正確認識Java多態</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/50001b01.html alt=科普：認識丙烯顏料的前世今生 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/86020cf2d31d4868b5e9da32cd6b374e style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/50001b01.html title=科普：認識丙烯顏料的前世今生>科普：認識丙烯顏料的前世今生</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/ec613168.html alt=十大世界足球先生，認識四位以上的人都不簡單 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/8bf0e55d0e30483abc88ce0fa1ac279d style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/ec613168.html title=十大世界足球先生，認識四位以上的人都不簡單>十大世界足球先生，認識四位以上的人都不簡單</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/b54cfddb.html alt=帶你認識汽車車身的各個部件 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/dd62852f37b54b068145a7daedbb8bd0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/b54cfddb.html title=帶你認識汽車車身的各個部件>帶你認識汽車車身的各個部件</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/8927e5b6.html alt=你真認識這八種鋼筋嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/dfic-imagehandler/bbc22aec-36ea-4ed2-ba17-6a2f4c96fa59 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/8927e5b6.html title=你真認識這八種鋼筋嗎？>你真認識這八種鋼筋嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/c4596424.html alt=你認識這八種鋼筋嗎？ class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/e33ef302ace34b04bb35700d0fef1bcf style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/c4596424.html title=你認識這八種鋼筋嗎？>你認識這八種鋼筋嗎？</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/63ca886b.html alt=教你認識受力筋、架立筋、貫通筋、拉結筋 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p1.pstatp.com/large/pgc-image/5d214c012f0942b1a772f2c66692bdf2 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/63ca886b.html title=教你認識受力筋、架立筋、貫通筋、拉結筋>教你認識受力筋、架立筋、貫通筋、拉結筋</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/7cf452ba.html alt=鋼筋你認識嗎，它有8種 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/10a8ce0c962e446f9bbe5b73a99cd839 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/7cf452ba.html title=鋼筋你認識嗎，它有8種>鋼筋你認識嗎，它有8種</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/d9c513dd.html alt=鋼筋你認識嗎，它竟然有8種。。。 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/2499f3b784a9497ca74a1ef0072dcc24 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/d9c513dd.html title=鋼筋你認識嗎，它竟然有8種。。。>鋼筋你認識嗎，它竟然有8種。。。</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/3de88fa3.html alt=生活中對PE管的五大錯誤認識 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p3.pstatp.com/large/pgc-image/497f548c985641f7a612506bd54283bd style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/3de88fa3.html title=生活中對PE管的五大錯誤認識>生活中對PE管的五大錯誤認識</a></li><hr><li><a href=../../tw/%E7%A7%91%E6%8A%80/2c4288ca.html alt=帶你認識10千伏高壓配電房設備 class="image featured" style=display:block;margin-left:auto;margin-right:auto;width:100%><img src=https://p9.pstatp.com/large/5e7d0001efd171f18ac0 style=border-radius:25px></a>
<a href=../../tw/%E7%A7%91%E6%8A%80/2c4288ca.html title=帶你認識10千伏高壓配電房設備>帶你認識10千伏高壓配電房設備</a></li><hr></ul></section><section class=widget><h3 class=widget-title>其他</h3><ul class=widget-list><li><a href=TOS.html>使用條款</a></li><li><a href=CommentPolicy.html>留言政策</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>DMCA</a></li><li><a href=mailto:gdnews@tuta.io rel=nofollow>聯絡我們</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2020 <a href>极客快訊</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src=https://kknews.cf/js/totop.js async></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e508ed9e4e698bb"></script></body></html>